begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* BFD back end for NetBSD style core files    Copyright 1988, 1989, 1991, 1992, 1993, 1996, 1998, 1999, 2000, 2001,    2002, 2003, 2004, 2005, 2006, 2007    Free Software Foundation, Inc.    Written by Paul Kranenburg, EUR     This file is part of BFD, the Binary File Descriptor library.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"libaout.h"
end_include

begin_comment
comment|/* BFD a.out internal data structures.  */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/core.h>
end_include

begin_comment
comment|/* The machine ID for OpenBSD/sparc64 and older versions of    NetBSD/sparc64 overlaps with M_MIPS1.  */
end_comment

begin_define
define|#
directive|define
name|M_SPARC64_OPENBSD
value|M_MIPS1
end_define

begin_comment
comment|/* Offset of StackGhost cookie within `struct md_coredump' on    OpenBSD/sparc.  */
end_comment

begin_define
define|#
directive|define
name|SPARC_WCOOKIE_OFFSET
value|344
end_define

begin_comment
comment|/* Offset of StackGhost cookie within `struct md_coredump' on    OpenBSD/sparc64.  */
end_comment

begin_define
define|#
directive|define
name|SPARC64_WCOOKIE_OFFSET
value|832
end_define

begin_define
define|#
directive|define
name|netbsd_core_file_matches_executable_p
value|generic_core_file_matches_executable_p
end_define

begin_struct
struct|struct
name|netbsd_core_struct
block|{
name|struct
name|core
name|core
decl_stmt|;
block|}
modifier|*
name|rawptr
struct|;
end_struct

begin_comment
comment|/* Handle NetBSD-style core dump file.  */
end_comment

begin_function
specifier|static
specifier|const
name|bfd_target
modifier|*
name|netbsd_core_file_p
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|int
name|val
decl_stmt|;
name|unsigned
name|i
decl_stmt|;
name|file_ptr
name|offset
decl_stmt|;
name|asection
modifier|*
name|asect
decl_stmt|;
name|struct
name|core
name|core
decl_stmt|;
name|struct
name|coreseg
name|coreseg
decl_stmt|;
name|bfd_size_type
name|amt
init|=
sizeof|sizeof
name|core
decl_stmt|;
name|val
operator|=
name|bfd_bread
argument_list|(
operator|&
name|core
argument_list|,
name|amt
argument_list|,
name|abfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
sizeof|sizeof
name|core
condition|)
block|{
comment|/* Too small to be a core file.  */
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|CORE_GETMAGIC
argument_list|(
name|core
argument_list|)
operator|!=
name|COREMAGIC
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|amt
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|netbsd_core_struct
argument_list|)
expr_stmt|;
name|rawptr
operator|=
operator|(
expr|struct
name|netbsd_core_struct
operator|*
operator|)
name|bfd_zalloc
argument_list|(
name|abfd
argument_list|,
name|amt
argument_list|)
expr_stmt|;
if|if
condition|(
name|rawptr
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|rawptr
operator|->
name|core
operator|=
name|core
expr_stmt|;
name|abfd
operator|->
name|tdata
operator|.
name|netbsd_core_data
operator|=
name|rawptr
expr_stmt|;
name|offset
operator|=
name|core
operator|.
name|c_hdrsize
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|core
operator|.
name|c_nseg
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|sname
decl_stmt|;
name|flagword
name|flags
decl_stmt|;
if|if
condition|(
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|punt
goto|;
name|val
operator|=
name|bfd_bread
argument_list|(
operator|&
name|coreseg
argument_list|,
sizeof|sizeof
name|coreseg
argument_list|,
name|abfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
sizeof|sizeof
name|coreseg
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_file_truncated
argument_list|)
expr_stmt|;
goto|goto
name|punt
goto|;
block|}
if|if
condition|(
name|CORE_GETMAGIC
argument_list|(
name|coreseg
argument_list|)
operator|!=
name|CORESEGMAGIC
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
goto|goto
name|punt
goto|;
block|}
name|offset
operator|+=
name|core
operator|.
name|c_seghdrsize
expr_stmt|;
switch|switch
condition|(
name|CORE_GETFLAG
argument_list|(
name|coreseg
argument_list|)
condition|)
block|{
case|case
name|CORE_CPU
case|:
name|sname
operator|=
literal|".reg"
expr_stmt|;
name|flags
operator|=
name|SEC_ALLOC
operator|+
name|SEC_HAS_CONTENTS
expr_stmt|;
break|break;
case|case
name|CORE_DATA
case|:
name|sname
operator|=
literal|".data"
expr_stmt|;
name|flags
operator|=
name|SEC_ALLOC
operator|+
name|SEC_LOAD
operator|+
name|SEC_HAS_CONTENTS
expr_stmt|;
break|break;
case|case
name|CORE_STACK
case|:
name|sname
operator|=
literal|".stack"
expr_stmt|;
name|flags
operator|=
name|SEC_ALLOC
operator|+
name|SEC_LOAD
operator|+
name|SEC_HAS_CONTENTS
expr_stmt|;
break|break;
default|default:
name|sname
operator|=
literal|".unknown"
expr_stmt|;
name|flags
operator|=
name|SEC_ALLOC
operator|+
name|SEC_HAS_CONTENTS
expr_stmt|;
break|break;
block|}
name|asect
operator|=
name|bfd_make_section_anyway_with_flags
argument_list|(
name|abfd
argument_list|,
name|sname
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|asect
operator|==
name|NULL
condition|)
goto|goto
name|punt
goto|;
name|asect
operator|->
name|size
operator|=
name|coreseg
operator|.
name|c_size
expr_stmt|;
name|asect
operator|->
name|vma
operator|=
name|coreseg
operator|.
name|c_addr
expr_stmt|;
name|asect
operator|->
name|filepos
operator|=
name|offset
expr_stmt|;
name|asect
operator|->
name|alignment_power
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|CORE_GETFLAG
argument_list|(
name|coreseg
argument_list|)
operator|==
name|CORE_CPU
condition|)
block|{
name|bfd_size_type
name|wcookie_offset
decl_stmt|;
switch|switch
condition|(
name|CORE_GETMID
argument_list|(
name|core
argument_list|)
condition|)
block|{
case|case
name|M_SPARC_NETBSD
case|:
name|wcookie_offset
operator|=
name|SPARC_WCOOKIE_OFFSET
expr_stmt|;
break|break;
case|case
name|M_SPARC64_OPENBSD
case|:
name|wcookie_offset
operator|=
name|SPARC64_WCOOKIE_OFFSET
expr_stmt|;
break|break;
default|default:
name|wcookie_offset
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wcookie_offset
operator|>
literal|0
operator|&&
name|coreseg
operator|.
name|c_size
operator|>
name|wcookie_offset
condition|)
block|{
comment|/* Truncate the .reg section.  */
name|asect
operator|->
name|size
operator|=
name|wcookie_offset
expr_stmt|;
comment|/* And create the .wcookie section.  */
name|flags
operator|=
name|SEC_ALLOC
operator|+
name|SEC_HAS_CONTENTS
expr_stmt|;
name|asect
operator|=
name|bfd_make_section_anyway_with_flags
argument_list|(
name|abfd
argument_list|,
literal|".wcookie"
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|asect
operator|==
name|NULL
condition|)
goto|goto
name|punt
goto|;
name|asect
operator|->
name|size
operator|=
name|coreseg
operator|.
name|c_size
operator|-
name|wcookie_offset
expr_stmt|;
name|asect
operator|->
name|vma
operator|=
literal|0
expr_stmt|;
name|asect
operator|->
name|filepos
operator|=
name|offset
operator|+
name|wcookie_offset
expr_stmt|;
name|asect
operator|->
name|alignment_power
operator|=
literal|2
expr_stmt|;
block|}
block|}
name|offset
operator|+=
name|coreseg
operator|.
name|c_size
expr_stmt|;
block|}
comment|/* Set architecture from machine ID.  */
switch|switch
condition|(
name|CORE_GETMID
argument_list|(
name|core
argument_list|)
condition|)
block|{
case|case
name|M_ALPHA_NETBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_alpha
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_ARM6_NETBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_arm
argument_list|,
name|bfd_mach_arm_3
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_X86_64_NETBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_i386
argument_list|,
name|bfd_mach_x86_64
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_386_NETBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_i386
argument_list|,
name|bfd_mach_i386_i386
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_68K_NETBSD
case|:
case|case
name|M_68K4K_NETBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_m68k
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_88K_OPENBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_m88k
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_HPPA_OPENBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_hppa
argument_list|,
name|bfd_mach_hppa11
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_POWERPC_NETBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_powerpc
argument_list|,
name|bfd_mach_ppc
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_SPARC_NETBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_sparc
argument_list|,
name|bfd_mach_sparc
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_SPARC64_NETBSD
case|:
case|case
name|M_SPARC64_OPENBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_sparc
argument_list|,
name|bfd_mach_sparc_v9
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_VAX_NETBSD
case|:
case|case
name|M_VAX4K_NETBSD
case|:
name|bfd_default_set_arch_mach
argument_list|(
name|abfd
argument_list|,
name|bfd_arch_vax
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* OK, we believe you.  You're a core file (sure, sure).  */
return|return
name|abfd
operator|->
name|xvec
return|;
name|punt
label|:
name|bfd_release
argument_list|(
name|abfd
argument_list|,
name|abfd
operator|->
name|tdata
operator|.
name|any
argument_list|)
expr_stmt|;
name|abfd
operator|->
name|tdata
operator|.
name|any
operator|=
name|NULL
expr_stmt|;
name|bfd_section_list_clear
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|netbsd_core_file_failing_command
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
comment|/*return core_command (abfd);*/
return|return
name|abfd
operator|->
name|tdata
operator|.
name|netbsd_core_data
operator|->
name|core
operator|.
name|c_name
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|netbsd_core_file_failing_signal
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
comment|/*return core_signal (abfd);*/
return|return
name|abfd
operator|->
name|tdata
operator|.
name|netbsd_core_data
operator|->
name|core
operator|.
name|c_signo
return|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* If somebody calls any byte-swapping routines, shoot them.  */
end_comment

begin_function
specifier|static
name|void
name|swap_abort
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* This way doesn't require any declaration for ANSI to fuck up.  */
name|abort
argument_list|()
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|NO_GET
value|((bfd_vma (*) (const void *)) swap_abort)
end_define

begin_define
define|#
directive|define
name|NO_PUT
value|((void (*) (bfd_vma, void *)) swap_abort)
end_define

begin_define
define|#
directive|define
name|NO_GETS
value|((bfd_signed_vma (*) (const void *)) swap_abort)
end_define

begin_define
define|#
directive|define
name|NO_GET64
value|((bfd_uint64_t (*) (const void *)) swap_abort)
end_define

begin_define
define|#
directive|define
name|NO_PUT64
value|((void (*) (bfd_uint64_t, void *)) swap_abort)
end_define

begin_define
define|#
directive|define
name|NO_GETS64
value|((bfd_int64_t (*) (const void *)) swap_abort)
end_define

begin_decl_stmt
specifier|const
name|bfd_target
name|netbsd_core_vec
init|=
block|{
literal|"netbsd-core"
block|,
name|bfd_target_unknown_flavour
block|,
name|BFD_ENDIAN_UNKNOWN
block|,
comment|/* Target byte order.  */
name|BFD_ENDIAN_UNKNOWN
block|,
comment|/* Target headers byte order.  */
operator|(
name|HAS_RELOC
operator||
name|EXEC_P
operator||
comment|/* Object flags.  */
name|HAS_LINENO
operator||
name|HAS_DEBUG
operator||
name|HAS_SYMS
operator||
name|HAS_LOCALS
operator||
name|WP_TEXT
operator||
name|D_PAGED
operator|)
block|,
operator|(
name|SEC_HAS_CONTENTS
operator||
comment|/* Section flags.  */
name|SEC_ALLOC
operator||
name|SEC_LOAD
operator||
name|SEC_RELOC
operator|)
block|,
literal|0
block|,
comment|/* Symbol prefix.  */
literal|' '
block|,
comment|/* ar_pad_char.  */
literal|16
block|,
comment|/* ar_max_namelen.  */
name|NO_GET64
block|,
name|NO_GETS64
block|,
name|NO_PUT64
block|,
comment|/* 64 bit data.  */
name|NO_GET
block|,
name|NO_GETS
block|,
name|NO_PUT
block|,
comment|/* 32 bit data.  */
name|NO_GET
block|,
name|NO_GETS
block|,
name|NO_PUT
block|,
comment|/* 16 bit data.  */
name|NO_GET64
block|,
name|NO_GETS64
block|,
name|NO_PUT64
block|,
comment|/* 64 bit hdrs.  */
name|NO_GET
block|,
name|NO_GETS
block|,
name|NO_PUT
block|,
comment|/* 32 bit hdrs.  */
name|NO_GET
block|,
name|NO_GETS
block|,
name|NO_PUT
block|,
comment|/* 16 bit hdrs.  */
block|{
comment|/* bfd_check_format.  */
name|_bfd_dummy_target
block|,
comment|/* Unknown format.  */
name|_bfd_dummy_target
block|,
comment|/* Object file.  */
name|_bfd_dummy_target
block|,
comment|/* Archive.  */
name|netbsd_core_file_p
comment|/* A core file.  */
block|}
block|,
block|{
comment|/* bfd_set_format.  */
name|bfd_false
block|,
name|bfd_false
block|,
name|bfd_false
block|,
name|bfd_false
block|}
block|,
block|{
comment|/* bfd_write_contents.  */
name|bfd_false
block|,
name|bfd_false
block|,
name|bfd_false
block|,
name|bfd_false
block|}
block|,
name|BFD_JUMP_TABLE_GENERIC
argument_list|(
name|_bfd_generic
argument_list|)
block|,
name|BFD_JUMP_TABLE_COPY
argument_list|(
name|_bfd_generic
argument_list|)
block|,
name|BFD_JUMP_TABLE_CORE
argument_list|(
name|netbsd
argument_list|)
block|,
name|BFD_JUMP_TABLE_ARCHIVE
argument_list|(
name|_bfd_noarchive
argument_list|)
block|,
name|BFD_JUMP_TABLE_SYMBOLS
argument_list|(
name|_bfd_nosymbols
argument_list|)
block|,
name|BFD_JUMP_TABLE_RELOCS
argument_list|(
name|_bfd_norelocs
argument_list|)
block|,
name|BFD_JUMP_TABLE_WRITE
argument_list|(
name|_bfd_generic
argument_list|)
block|,
name|BFD_JUMP_TABLE_LINK
argument_list|(
name|_bfd_nolink
argument_list|)
block|,
name|BFD_JUMP_TABLE_DYNAMIC
argument_list|(
name|_bfd_nodynamic
argument_list|)
block|,
name|NULL
block|,
operator|(
name|PTR
operator|)
literal|0
comment|/* Backend_data.  */
block|}
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* BFD back end for NetBSD style core files    Copyright 1988, 1989, 1991, 1992, 1993, 1996, 1998, 1999, 2000    Free Software Foundation, Inc.    Written by Paul Kranenburg, EUR  This file is part of BFD, the Binary File Descriptor library.  This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"libaout.h"
end_include

begin_comment
comment|/* BFD a.out internal data structures */
end_comment

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/dir.h>
end_include

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/core.h>
end_include

begin_comment
comment|/*  * FIXME: On NetBSD/sparc CORE_FPU_OFFSET should be (sizeof (struct trapframe))  */
end_comment

begin_struct
struct|struct
name|netbsd_core_struct
block|{
name|struct
name|core
name|core
decl_stmt|;
block|}
modifier|*
name|rawptr
struct|;
end_struct

begin_comment
comment|/* forward declarations */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|bfd_target
modifier|*
name|netbsd_core_file_p
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
name|abfd
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|netbsd_core_file_failing_command
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
name|abfd
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|netbsd_core_file_failing_signal
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
name|abfd
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|boolean
name|netbsd_core_file_matches_executable_p
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
name|core_bfd
operator|,
name|bfd
operator|*
name|exec_bfd
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|swap_abort
name|PARAMS
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Handle NetBSD-style core dump file.  */
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
specifier|const
name|bfd_target
modifier|*
name|netbsd_core_file_p
parameter_list|(
name|abfd
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|val
decl_stmt|,
name|offset
decl_stmt|;
name|asection
modifier|*
name|asect
decl_stmt|,
modifier|*
name|asect2
decl_stmt|;
name|struct
name|core
name|core
decl_stmt|;
name|struct
name|coreseg
name|coreseg
decl_stmt|;
name|val
operator|=
name|bfd_read
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|core
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
name|core
argument_list|,
name|abfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
sizeof|sizeof
name|core
condition|)
block|{
comment|/* Too small to be a core file */
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|CORE_GETMAGIC
argument_list|(
name|core
argument_list|)
operator|!=
name|COREMAGIC
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|rawptr
operator|=
operator|(
expr|struct
name|netbsd_core_struct
operator|*
operator|)
name|bfd_zalloc
argument_list|(
name|abfd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|netbsd_core_struct
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rawptr
operator|==
name|NULL
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_no_memory
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|rawptr
operator|->
name|core
operator|=
name|core
expr_stmt|;
name|abfd
operator|->
name|tdata
operator|.
name|netbsd_core_data
operator|=
name|rawptr
expr_stmt|;
name|offset
operator|=
name|core
operator|.
name|c_hdrsize
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|core
operator|.
name|c_nseg
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|offset
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|punt
goto|;
name|val
operator|=
name|bfd_read
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|coreseg
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
name|coreseg
argument_list|,
name|abfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
sizeof|sizeof
name|coreseg
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_file_truncated
argument_list|)
expr_stmt|;
goto|goto
name|punt
goto|;
block|}
if|if
condition|(
name|CORE_GETMAGIC
argument_list|(
name|coreseg
argument_list|)
operator|!=
name|CORESEGMAGIC
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
goto|goto
name|punt
goto|;
block|}
name|offset
operator|+=
name|core
operator|.
name|c_seghdrsize
expr_stmt|;
name|asect
operator|=
operator|(
name|asection
operator|*
operator|)
name|bfd_zalloc
argument_list|(
name|abfd
argument_list|,
sizeof|sizeof
argument_list|(
name|asection
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|asect
operator|==
name|NULL
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_no_memory
argument_list|)
expr_stmt|;
goto|goto
name|punt
goto|;
block|}
name|asect
operator|->
name|_raw_size
operator|=
name|coreseg
operator|.
name|c_size
expr_stmt|;
name|asect
operator|->
name|vma
operator|=
name|coreseg
operator|.
name|c_addr
expr_stmt|;
name|asect
operator|->
name|filepos
operator|=
name|offset
expr_stmt|;
name|asect
operator|->
name|alignment_power
operator|=
literal|2
expr_stmt|;
name|asect
operator|->
name|next
operator|=
name|abfd
operator|->
name|sections
expr_stmt|;
name|abfd
operator|->
name|sections
operator|=
name|asect
expr_stmt|;
name|abfd
operator|->
name|section_count
operator|++
expr_stmt|;
name|offset
operator|+=
name|coreseg
operator|.
name|c_size
expr_stmt|;
switch|switch
condition|(
name|CORE_GETFLAG
argument_list|(
name|coreseg
argument_list|)
condition|)
block|{
case|case
name|CORE_CPU
case|:
name|asect
operator|->
name|name
operator|=
literal|".reg"
expr_stmt|;
name|asect
operator|->
name|flags
operator|=
name|SEC_ALLOC
operator|+
name|SEC_HAS_CONTENTS
expr_stmt|;
ifdef|#
directive|ifdef
name|CORE_FPU_OFFSET
comment|/* Hackish...  */
name|asect
operator|->
name|_raw_size
operator|=
name|CORE_FPU_OFFSET
expr_stmt|;
name|asect2
operator|=
operator|(
name|asection
operator|*
operator|)
name|bfd_zalloc
argument_list|(
name|abfd
argument_list|,
sizeof|sizeof
argument_list|(
name|asection
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|asect2
operator|==
name|NULL
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_no_memory
argument_list|)
expr_stmt|;
goto|goto
name|punt
goto|;
block|}
name|asect2
operator|->
name|_raw_size
operator|=
name|coreseg
operator|.
name|c_size
operator|-
name|CORE_FPU_OFFSET
expr_stmt|;
name|asect2
operator|->
name|vma
operator|=
literal|0
expr_stmt|;
name|asect2
operator|->
name|filepos
operator|=
name|asect
operator|->
name|filepos
operator|+
name|CORE_FPU_OFFSET
expr_stmt|;
name|asect2
operator|->
name|alignment_power
operator|=
literal|2
expr_stmt|;
name|asect2
operator|->
name|next
operator|=
name|abfd
operator|->
name|sections
expr_stmt|;
name|asect2
operator|->
name|name
operator|=
literal|".reg2"
expr_stmt|;
name|asect2
operator|->
name|flags
operator|=
name|SEC_ALLOC
operator|+
name|SEC_HAS_CONTENTS
expr_stmt|;
name|abfd
operator|->
name|sections
operator|=
name|asect2
expr_stmt|;
name|abfd
operator|->
name|section_count
operator|++
expr_stmt|;
endif|#
directive|endif
break|break;
case|case
name|CORE_DATA
case|:
name|asect
operator|->
name|name
operator|=
literal|".data"
expr_stmt|;
name|asect
operator|->
name|flags
operator|=
name|SEC_ALLOC
operator|+
name|SEC_LOAD
operator|+
name|SEC_HAS_CONTENTS
expr_stmt|;
break|break;
case|case
name|CORE_STACK
case|:
name|asect
operator|->
name|name
operator|=
literal|".stack"
expr_stmt|;
name|asect
operator|->
name|flags
operator|=
name|SEC_ALLOC
operator|+
name|SEC_LOAD
operator|+
name|SEC_HAS_CONTENTS
expr_stmt|;
break|break;
block|}
block|}
comment|/* OK, we believe you.  You're a core file (sure, sure).  */
return|return
name|abfd
operator|->
name|xvec
return|;
name|punt
label|:
block|{
name|asection
modifier|*
name|anext
decl_stmt|;
for|for
control|(
name|asect
operator|=
name|abfd
operator|->
name|sections
init|;
name|asect
condition|;
name|asect
operator|=
name|anext
control|)
block|{
name|anext
operator|=
name|asect
operator|->
name|next
expr_stmt|;
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|asect
argument_list|)
expr_stmt|;
block|}
block|}
name|free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|rawptr
argument_list|)
expr_stmt|;
name|abfd
operator|->
name|tdata
operator|.
name|netbsd_core_data
operator|=
name|NULL
expr_stmt|;
name|abfd
operator|->
name|sections
operator|=
name|NULL
expr_stmt|;
name|abfd
operator|->
name|section_count
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|netbsd_core_file_failing_command
parameter_list|(
name|abfd
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
block|{
comment|/*return core_command (abfd);*/
return|return
name|abfd
operator|->
name|tdata
operator|.
name|netbsd_core_data
operator|->
name|core
operator|.
name|c_name
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|int
name|netbsd_core_file_failing_signal
parameter_list|(
name|abfd
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
block|{
comment|/*return core_signal (abfd);*/
return|return
name|abfd
operator|->
name|tdata
operator|.
name|netbsd_core_data
operator|->
name|core
operator|.
name|c_signo
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|static
name|boolean
name|netbsd_core_file_matches_executable_p
parameter_list|(
name|core_bfd
parameter_list|,
name|exec_bfd
parameter_list|)
name|bfd
modifier|*
name|core_bfd
decl_stmt|,
decl|*
name|exec_bfd
decl_stmt|;
end_function

begin_block
block|{
return|return
name|true
return|;
comment|/* FIXME, We have no way of telling at this point */
block|}
end_block

begin_escape
end_escape

begin_comment
comment|/* If somebody calls any byte-swapping routines, shoot them.  */
end_comment

begin_function
specifier|static
name|void
name|swap_abort
parameter_list|()
block|{
name|abort
argument_list|()
expr_stmt|;
comment|/* This way doesn't require any declaration for ANSI to fuck up */
block|}
end_function

begin_define
define|#
directive|define
name|NO_GET
value|((bfd_vma (*) PARAMS ((   const bfd_byte *))) swap_abort )
end_define

begin_define
define|#
directive|define
name|NO_PUT
value|((void    (*) PARAMS ((bfd_vma, bfd_byte *))) swap_abort )
end_define

begin_define
define|#
directive|define
name|NO_SIGNED_GET
define|\
value|((bfd_signed_vma (*) PARAMS ((const bfd_byte *))) swap_abort )
end_define

begin_decl_stmt
specifier|const
name|bfd_target
name|netbsd_core_vec
init|=
block|{
literal|"netbsd-core"
block|,
name|bfd_target_unknown_flavour
block|,
name|BFD_ENDIAN_UNKNOWN
block|,
comment|/* target byte order */
name|BFD_ENDIAN_UNKNOWN
block|,
comment|/* target headers byte order */
operator|(
name|HAS_RELOC
operator||
name|EXEC_P
operator||
comment|/* object flags */
name|HAS_LINENO
operator||
name|HAS_DEBUG
operator||
name|HAS_SYMS
operator||
name|HAS_LOCALS
operator||
name|WP_TEXT
operator||
name|D_PAGED
operator|)
block|,
operator|(
name|SEC_HAS_CONTENTS
operator||
name|SEC_ALLOC
operator||
name|SEC_LOAD
operator||
name|SEC_RELOC
operator|)
block|,
comment|/* section flags */
literal|0
block|,
comment|/* symbol prefix */
literal|' '
block|,
comment|/* ar_pad_char */
literal|16
block|,
comment|/* ar_max_namelen */
name|NO_GET
block|,
name|NO_SIGNED_GET
block|,
name|NO_PUT
block|,
comment|/* 64 bit data */
name|NO_GET
block|,
name|NO_SIGNED_GET
block|,
name|NO_PUT
block|,
comment|/* 32 bit data */
name|NO_GET
block|,
name|NO_SIGNED_GET
block|,
name|NO_PUT
block|,
comment|/* 16 bit data */
name|NO_GET
block|,
name|NO_SIGNED_GET
block|,
name|NO_PUT
block|,
comment|/* 64 bit hdrs */
name|NO_GET
block|,
name|NO_SIGNED_GET
block|,
name|NO_PUT
block|,
comment|/* 32 bit hdrs */
name|NO_GET
block|,
name|NO_SIGNED_GET
block|,
name|NO_PUT
block|,
comment|/* 16 bit hdrs */
block|{
comment|/* bfd_check_format */
name|_bfd_dummy_target
block|,
comment|/* unknown format */
name|_bfd_dummy_target
block|,
comment|/* object file */
name|_bfd_dummy_target
block|,
comment|/* archive */
name|netbsd_core_file_p
comment|/* a core file */
block|}
block|,
block|{
comment|/* bfd_set_format */
name|bfd_false
block|,
name|bfd_false
block|,
name|bfd_false
block|,
name|bfd_false
block|}
block|,
block|{
comment|/* bfd_write_contents */
name|bfd_false
block|,
name|bfd_false
block|,
name|bfd_false
block|,
name|bfd_false
block|}
block|,
name|BFD_JUMP_TABLE_GENERIC
argument_list|(
name|_bfd_generic
argument_list|)
block|,
name|BFD_JUMP_TABLE_COPY
argument_list|(
name|_bfd_generic
argument_list|)
block|,
name|BFD_JUMP_TABLE_CORE
argument_list|(
name|netbsd
argument_list|)
block|,
name|BFD_JUMP_TABLE_ARCHIVE
argument_list|(
name|_bfd_noarchive
argument_list|)
block|,
name|BFD_JUMP_TABLE_SYMBOLS
argument_list|(
name|_bfd_nosymbols
argument_list|)
block|,
name|BFD_JUMP_TABLE_RELOCS
argument_list|(
name|_bfd_norelocs
argument_list|)
block|,
name|BFD_JUMP_TABLE_WRITE
argument_list|(
name|_bfd_generic
argument_list|)
block|,
name|BFD_JUMP_TABLE_LINK
argument_list|(
name|_bfd_nolink
argument_list|)
block|,
name|BFD_JUMP_TABLE_DYNAMIC
argument_list|(
name|_bfd_nodynamic
argument_list|)
block|,
name|NULL
block|,
operator|(
name|PTR
operator|)
literal|0
comment|/* backend_data */
block|}
decl_stmt|;
end_decl_stmt

end_unit


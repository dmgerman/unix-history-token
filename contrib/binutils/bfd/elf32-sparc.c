begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* SPARC-specific support for 32-bit ELF    Copyright 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,    2003, 2004, 2005, 2007 Free Software Foundation, Inc.     This file is part of BFD, the Binary File Descriptor library.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA 02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"bfdlink.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"elf-bfd.h"
end_include

begin_include
include|#
directive|include
file|"elf/sparc.h"
end_include

begin_include
include|#
directive|include
file|"opcode/sparc.h"
end_include

begin_include
include|#
directive|include
file|"elfxx-sparc.h"
end_include

begin_include
include|#
directive|include
file|"elf-vxworks.h"
end_include

begin_comment
comment|/* Support for core dump NOTE sections.  */
end_comment

begin_function
specifier|static
name|bfd_boolean
name|elf32_sparc_grok_psinfo
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|Elf_Internal_Note
modifier|*
name|note
parameter_list|)
block|{
switch|switch
condition|(
name|note
operator|->
name|descsz
condition|)
block|{
default|default:
return|return
name|FALSE
return|;
case|case
literal|260
case|:
comment|/* Solaris prpsinfo_t.  */
name|elf_tdata
argument_list|(
name|abfd
argument_list|)
operator|->
name|core_program
operator|=
name|_bfd_elfcore_strndup
argument_list|(
name|abfd
argument_list|,
name|note
operator|->
name|descdata
operator|+
literal|84
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|elf_tdata
argument_list|(
name|abfd
argument_list|)
operator|->
name|core_command
operator|=
name|_bfd_elfcore_strndup
argument_list|(
name|abfd
argument_list|,
name|note
operator|->
name|descdata
operator|+
literal|100
argument_list|,
literal|80
argument_list|)
expr_stmt|;
break|break;
case|case
literal|336
case|:
comment|/* Solaris psinfo_t.  */
name|elf_tdata
argument_list|(
name|abfd
argument_list|)
operator|->
name|core_program
operator|=
name|_bfd_elfcore_strndup
argument_list|(
name|abfd
argument_list|,
name|note
operator|->
name|descdata
operator|+
literal|88
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|elf_tdata
argument_list|(
name|abfd
argument_list|)
operator|->
name|core_command
operator|=
name|_bfd_elfcore_strndup
argument_list|(
name|abfd
argument_list|,
name|note
operator|->
name|descdata
operator|+
literal|104
argument_list|,
literal|80
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* Functions for dealing with the e_flags field.     We don't define set_private_flags or copy_private_bfd_data because    the only currently defined values are based on the bfd mach number,    so we use the latter instead and defer setting e_flags until the    file is written out.  */
end_comment

begin_comment
comment|/* Merge backend specific data from an object file to the output    object file when linking.  */
end_comment

begin_function
specifier|static
name|bfd_boolean
name|elf32_sparc_merge_private_bfd_data
parameter_list|(
name|bfd
modifier|*
name|ibfd
parameter_list|,
name|bfd
modifier|*
name|obfd
parameter_list|)
block|{
name|bfd_boolean
name|error
decl_stmt|;
name|unsigned
name|long
name|ibfd_mach
decl_stmt|;
comment|/* FIXME: This should not be static.  */
specifier|static
name|unsigned
name|long
name|previous_ibfd_e_flags
init|=
operator|(
name|unsigned
name|long
operator|)
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|bfd_get_flavour
argument_list|(
name|ibfd
argument_list|)
operator|!=
name|bfd_target_elf_flavour
operator|||
name|bfd_get_flavour
argument_list|(
name|obfd
argument_list|)
operator|!=
name|bfd_target_elf_flavour
condition|)
return|return
name|TRUE
return|;
name|error
operator|=
name|FALSE
expr_stmt|;
name|ibfd_mach
operator|=
name|bfd_get_mach
argument_list|(
name|ibfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_mach_sparc_64bit_p
argument_list|(
name|ibfd_mach
argument_list|)
condition|)
block|{
name|error
operator|=
name|TRUE
expr_stmt|;
call|(
modifier|*
name|_bfd_error_handler
call|)
argument_list|(
name|_
argument_list|(
literal|"%B: compiled for a 64 bit system and target is 32 bit"
argument_list|)
argument_list|,
name|ibfd
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ibfd
operator|->
name|flags
operator|&
name|DYNAMIC
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|bfd_get_mach
argument_list|(
name|obfd
argument_list|)
operator|<
name|ibfd_mach
condition|)
name|bfd_set_arch_mach
argument_list|(
name|obfd
argument_list|,
name|bfd_arch_sparc
argument_list|,
name|ibfd_mach
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
operator|(
name|elf_elfheader
argument_list|(
name|ibfd
argument_list|)
operator|->
name|e_flags
operator|&
name|EF_SPARC_LEDATA
operator|)
operator|!=
name|previous_ibfd_e_flags
operator|)
operator|&&
name|previous_ibfd_e_flags
operator|!=
operator|(
name|unsigned
name|long
operator|)
operator|-
literal|1
condition|)
block|{
call|(
modifier|*
name|_bfd_error_handler
call|)
argument_list|(
name|_
argument_list|(
literal|"%B: linking little endian files with big endian files"
argument_list|)
argument_list|,
name|ibfd
argument_list|)
expr_stmt|;
name|error
operator|=
name|TRUE
expr_stmt|;
block|}
name|previous_ibfd_e_flags
operator|=
name|elf_elfheader
argument_list|(
name|ibfd
argument_list|)
operator|->
name|e_flags
operator|&
name|EF_SPARC_LEDATA
expr_stmt|;
if|if
condition|(
name|error
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_bad_value
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/* The final processing done just before writing out the object file.    We need to set the e_machine field appropriately.  */
end_comment

begin_function
specifier|static
name|void
name|elf32_sparc_final_write_processing
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_boolean
name|linker
name|ATTRIBUTE_UNUSED
parameter_list|)
block|{
switch|switch
condition|(
name|bfd_get_mach
argument_list|(
name|abfd
argument_list|)
condition|)
block|{
case|case
name|bfd_mach_sparc
case|:
case|case
name|bfd_mach_sparc_sparclet
case|:
case|case
name|bfd_mach_sparc_sparclite
case|:
break|break;
comment|/* nothing to do */
case|case
name|bfd_mach_sparc_v8plus
case|:
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_machine
operator|=
name|EM_SPARC32PLUS
expr_stmt|;
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_flags
operator|&=
operator|~
name|EF_SPARC_32PLUS_MASK
expr_stmt|;
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_flags
operator||=
name|EF_SPARC_32PLUS
expr_stmt|;
break|break;
case|case
name|bfd_mach_sparc_v8plusa
case|:
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_machine
operator|=
name|EM_SPARC32PLUS
expr_stmt|;
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_flags
operator|&=
operator|~
name|EF_SPARC_32PLUS_MASK
expr_stmt|;
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_flags
operator||=
name|EF_SPARC_32PLUS
operator||
name|EF_SPARC_SUN_US1
expr_stmt|;
break|break;
case|case
name|bfd_mach_sparc_v8plusb
case|:
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_machine
operator|=
name|EM_SPARC32PLUS
expr_stmt|;
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_flags
operator|&=
operator|~
name|EF_SPARC_32PLUS_MASK
expr_stmt|;
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_flags
operator||=
name|EF_SPARC_32PLUS
operator||
name|EF_SPARC_SUN_US1
operator||
name|EF_SPARC_SUN_US3
expr_stmt|;
break|break;
case|case
name|bfd_mach_sparc_sparclite_le
case|:
name|elf_elfheader
argument_list|(
name|abfd
argument_list|)
operator|->
name|e_flags
operator||=
name|EF_SPARC_LEDATA
expr_stmt|;
break|break;
default|default :
name|abort
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|enum
name|elf_reloc_type_class
name|elf32_sparc_reloc_type_class
parameter_list|(
specifier|const
name|Elf_Internal_Rela
modifier|*
name|rela
parameter_list|)
block|{
switch|switch
condition|(
operator|(
name|int
operator|)
name|ELF32_R_TYPE
argument_list|(
name|rela
operator|->
name|r_info
argument_list|)
condition|)
block|{
case|case
name|R_SPARC_RELATIVE
case|:
return|return
name|reloc_class_relative
return|;
case|case
name|R_SPARC_JMP_SLOT
case|:
return|return
name|reloc_class_plt
return|;
case|case
name|R_SPARC_COPY
case|:
return|return
name|reloc_class_copy
return|;
default|default:
return|return
name|reloc_class_normal
return|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|TARGET_BIG_SYM
value|bfd_elf32_sparc_vec
end_define

begin_define
define|#
directive|define
name|TARGET_BIG_NAME
value|"elf32-sparc"
end_define

begin_define
define|#
directive|define
name|ELF_ARCH
value|bfd_arch_sparc
end_define

begin_define
define|#
directive|define
name|ELF_MACHINE_CODE
value|EM_SPARC
end_define

begin_define
define|#
directive|define
name|ELF_MACHINE_ALT1
value|EM_SPARC32PLUS
end_define

begin_define
define|#
directive|define
name|ELF_MAXPAGESIZE
value|0x10000
end_define

begin_define
define|#
directive|define
name|ELF_COMMONPAGESIZE
value|0x2000
end_define

begin_define
define|#
directive|define
name|bfd_elf32_bfd_merge_private_bfd_data
define|\
value|elf32_sparc_merge_private_bfd_data
end_define

begin_define
define|#
directive|define
name|elf_backend_final_write_processing
define|\
value|elf32_sparc_final_write_processing
end_define

begin_define
define|#
directive|define
name|elf_backend_grok_psinfo
value|elf32_sparc_grok_psinfo
end_define

begin_define
define|#
directive|define
name|elf_backend_reloc_type_class
value|elf32_sparc_reloc_type_class
end_define

begin_define
define|#
directive|define
name|elf_info_to_howto
value|_bfd_sparc_elf_info_to_howto
end_define

begin_define
define|#
directive|define
name|bfd_elf32_bfd_reloc_type_lookup
value|_bfd_sparc_elf_reloc_type_lookup
end_define

begin_define
define|#
directive|define
name|bfd_elf32_bfd_reloc_name_lookup
define|\
value|_bfd_sparc_elf_reloc_name_lookup
end_define

begin_define
define|#
directive|define
name|bfd_elf32_bfd_link_hash_table_create
define|\
value|_bfd_sparc_elf_link_hash_table_create
end_define

begin_define
define|#
directive|define
name|bfd_elf32_bfd_relax_section
value|_bfd_sparc_elf_relax_section
end_define

begin_define
define|#
directive|define
name|bfd_elf32_new_section_hook
value|_bfd_sparc_elf_new_section_hook
end_define

begin_define
define|#
directive|define
name|elf_backend_copy_indirect_symbol
define|\
value|_bfd_sparc_elf_copy_indirect_symbol
end_define

begin_define
define|#
directive|define
name|elf_backend_create_dynamic_sections
define|\
value|_bfd_sparc_elf_create_dynamic_sections
end_define

begin_define
define|#
directive|define
name|elf_backend_check_relocs
value|_bfd_sparc_elf_check_relocs
end_define

begin_define
define|#
directive|define
name|elf_backend_adjust_dynamic_symbol
define|\
value|_bfd_sparc_elf_adjust_dynamic_symbol
end_define

begin_define
define|#
directive|define
name|elf_backend_omit_section_dynsym
value|_bfd_sparc_elf_omit_section_dynsym
end_define

begin_define
define|#
directive|define
name|elf_backend_size_dynamic_sections
define|\
value|_bfd_sparc_elf_size_dynamic_sections
end_define

begin_define
define|#
directive|define
name|elf_backend_relocate_section
value|_bfd_sparc_elf_relocate_section
end_define

begin_define
define|#
directive|define
name|elf_backend_finish_dynamic_symbol
define|\
value|_bfd_sparc_elf_finish_dynamic_symbol
end_define

begin_define
define|#
directive|define
name|elf_backend_finish_dynamic_sections
define|\
value|_bfd_sparc_elf_finish_dynamic_sections
end_define

begin_define
define|#
directive|define
name|bfd_elf32_mkobject
value|_bfd_sparc_elf_mkobject
end_define

begin_define
define|#
directive|define
name|elf_backend_object_p
value|_bfd_sparc_elf_object_p
end_define

begin_define
define|#
directive|define
name|elf_backend_gc_mark_hook
value|_bfd_sparc_elf_gc_mark_hook
end_define

begin_define
define|#
directive|define
name|elf_backend_gc_sweep_hook
value|_bfd_sparc_elf_gc_sweep_hook
end_define

begin_define
define|#
directive|define
name|elf_backend_plt_sym_val
value|_bfd_sparc_elf_plt_sym_val
end_define

begin_define
define|#
directive|define
name|elf_backend_init_index_section
value|_bfd_elf_init_1_index_section
end_define

begin_define
define|#
directive|define
name|elf_backend_can_gc_sections
value|1
end_define

begin_define
define|#
directive|define
name|elf_backend_can_refcount
value|1
end_define

begin_define
define|#
directive|define
name|elf_backend_want_got_plt
value|0
end_define

begin_define
define|#
directive|define
name|elf_backend_plt_readonly
value|0
end_define

begin_define
define|#
directive|define
name|elf_backend_want_plt_sym
value|1
end_define

begin_define
define|#
directive|define
name|elf_backend_got_header_size
value|4
end_define

begin_define
define|#
directive|define
name|elf_backend_rela_normal
value|1
end_define

begin_include
include|#
directive|include
file|"elf32-target.h"
end_include

begin_comment
comment|/* A wrapper around _bfd_sparc_elf_link_hash_table_create that identifies    the target system as VxWorks.  */
end_comment

begin_function
specifier|static
name|struct
name|bfd_link_hash_table
modifier|*
name|elf32_sparc_vxworks_link_hash_table_create
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|struct
name|bfd_link_hash_table
modifier|*
name|ret
decl_stmt|;
name|ret
operator|=
name|_bfd_sparc_elf_link_hash_table_create
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|struct
name|_bfd_sparc_elf_link_hash_table
modifier|*
name|htab
decl_stmt|;
name|htab
operator|=
operator|(
expr|struct
name|_bfd_sparc_elf_link_hash_table
operator|*
operator|)
name|ret
expr_stmt|;
name|htab
operator|->
name|is_vxworks
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* A final_write_processing hook that does both the SPARC- and VxWorks-    specific handling.  */
end_comment

begin_function
specifier|static
name|void
name|elf32_sparc_vxworks_final_write_processing
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|bfd_boolean
name|linker
parameter_list|)
block|{
name|elf32_sparc_final_write_processing
argument_list|(
name|abfd
argument_list|,
name|linker
argument_list|)
expr_stmt|;
name|elf_vxworks_final_write_processing
argument_list|(
name|abfd
argument_list|,
name|linker
argument_list|)
expr_stmt|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|TARGET_BIG_SYM
end_undef

begin_define
define|#
directive|define
name|TARGET_BIG_SYM
value|bfd_elf32_sparc_vxworks_vec
end_define

begin_undef
undef|#
directive|undef
name|TARGET_BIG_NAME
end_undef

begin_define
define|#
directive|define
name|TARGET_BIG_NAME
value|"elf32-sparc-vxworks"
end_define

begin_undef
undef|#
directive|undef
name|ELF_MINPAGESIZE
end_undef

begin_define
define|#
directive|define
name|ELF_MINPAGESIZE
value|0x1000
end_define

begin_undef
undef|#
directive|undef
name|bfd_elf32_bfd_link_hash_table_create
end_undef

begin_define
define|#
directive|define
name|bfd_elf32_bfd_link_hash_table_create
define|\
value|elf32_sparc_vxworks_link_hash_table_create
end_define

begin_undef
undef|#
directive|undef
name|elf_backend_want_got_plt
end_undef

begin_define
define|#
directive|define
name|elf_backend_want_got_plt
value|1
end_define

begin_undef
undef|#
directive|undef
name|elf_backend_plt_readonly
end_undef

begin_define
define|#
directive|define
name|elf_backend_plt_readonly
value|1
end_define

begin_undef
undef|#
directive|undef
name|elf_backend_got_header_size
end_undef

begin_define
define|#
directive|define
name|elf_backend_got_header_size
value|12
end_define

begin_undef
undef|#
directive|undef
name|elf_backend_add_symbol_hook
end_undef

begin_define
define|#
directive|define
name|elf_backend_add_symbol_hook
define|\
value|elf_vxworks_add_symbol_hook
end_define

begin_undef
undef|#
directive|undef
name|elf_backend_link_output_symbol_hook
end_undef

begin_define
define|#
directive|define
name|elf_backend_link_output_symbol_hook
define|\
value|elf_vxworks_link_output_symbol_hook
end_define

begin_undef
undef|#
directive|undef
name|elf_backend_emit_relocs
end_undef

begin_define
define|#
directive|define
name|elf_backend_emit_relocs
define|\
value|elf_vxworks_emit_relocs
end_define

begin_undef
undef|#
directive|undef
name|elf_backend_final_write_processing
end_undef

begin_define
define|#
directive|define
name|elf_backend_final_write_processing
define|\
value|elf32_sparc_vxworks_final_write_processing
end_define

begin_undef
undef|#
directive|undef
name|elf32_bed
end_undef

begin_define
define|#
directive|define
name|elf32_bed
value|sparc_elf_vxworks_bed
end_define

begin_include
include|#
directive|include
file|"elf32-target.h"
end_include

end_unit


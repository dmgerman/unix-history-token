begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Generate parameters for an a.out system.    Copyright 1990, 1991, 1992, 1993, 1994, 1995    Free Software Foundation, Inc.  This file is part of BFD, the Binary File Descriptor library.  This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"/usr/include/a.out.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|struct
name|exec
name|my_exec
decl_stmt|;
name|int
name|page_size
decl_stmt|;
name|char
modifier|*
name|target
init|=
literal|"unknown"
decl_stmt|,
modifier|*
name|arch
init|=
literal|"unknown"
decl_stmt|;
name|FILE
modifier|*
name|file
init|=
name|fopen
argument_list|(
literal|"gen-aout"
argument_list|,
literal|"r"
argument_list|)
decl_stmt|;
if|if
condition|(
name|file
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot open gen-aout!\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|fread
argument_list|(
operator|&
name|my_exec
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|exec
argument_list|)
argument_list|,
literal|1
argument_list|,
name|file
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot read gen-aout!\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|target
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|target
operator|==
name|NULL
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: gen-aout target_name\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|N_TXTOFF
name|page_size
operator|=
name|N_TXTOFF
argument_list|(
name|my_exec
argument_list|)
expr_stmt|;
if|if
condition|(
name|page_size
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"#define N_HEADER_IN_TEXT(x) 1\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"#define N_HEADER_IN_TEXT(x) 0\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|printf
argument_list|(
literal|"#define BYTES_IN_WORD %d\n"
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_exec
operator|.
name|a_entry
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"#define ENTRY_CAN_BE_ZERO\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#define N_SHARED_LIB(x) 0 /* Avoids warning */\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"/*#define ENTRY_CAN_BE_ZERO*/\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"/*#define N_SHARED_LIB(x) 0*/\n"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"#define TEXT_START_ADDR %d\n"
argument_list|,
name|my_exec
operator|.
name|a_entry
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PAGSIZ
if|if
condition|(
name|page_size
operator|==
literal|0
condition|)
name|page_size
operator|=
name|PAGSIZ
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|page_size
operator|!=
literal|0
condition|)
name|printf
argument_list|(
literal|"#define TARGET_PAGE_SIZE %d\n"
argument_list|,
name|page_size
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"/* #define TARGET_PAGE_SIZE ??? */\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#define SEGMENT_SIZE TARGET_PAGE_SIZE\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|vax
name|arch
operator|=
literal|"vax"
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|m68k
name|arch
operator|=
literal|"m68k"
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|arch
index|[
literal|0
index|]
operator|==
literal|'1'
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|_
argument_list|(
literal|"warning: preprocessor substituted architecture name inside string;"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|_
argument_list|(
literal|"         fix DEFAULT_ARCH in the output file yourself\n"
argument_list|)
argument_list|)
expr_stmt|;
name|arch
operator|=
literal|"unknown"
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"#define DEFAULT_ARCH bfd_arch_%s\n"
argument_list|,
name|arch
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n#define MY(OP) CAT(%s_,OP)\n"
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#define TARGETNAME \"a.out-%s\"\n\n"
argument_list|,
name|target
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#include \"bfd.h\"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#include \"sysdep.h\"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#include \"libbfd.h\"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"#include \"libaout.h\"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n#include \"aout-target.h\"\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


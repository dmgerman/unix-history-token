begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* CGEN generic disassembler support code.     Copyright (C) 1996, 1997, 1998, 1999 Free Software Foundation, Inc.     This file is part of the GNU Binutils and GDB, the GNU debugger.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2, or (at your option)    any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License along    with this program; if not, write to the Free Software Foundation, Inc.,    59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"ansidecl.h"
end_include

begin_include
include|#
directive|include
file|"libiberty.h"
end_include

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"symcat.h"
end_include

begin_include
include|#
directive|include
file|"opcode/cgen.h"
end_include

begin_comment
comment|/* Subroutine of build_dis_hash_table to add INSNS to the hash table.     COUNT is the number of elements in INSNS.    ENTSIZE is sizeof (CGEN_IBASE) for the target.    ??? No longer used but leave in for now.    HTABLE points to the hash table.    HENTBUF is a pointer to sufficiently large buffer of hash entries.    The result is a pointer to the next entry to use.     The table is scanned backwards as additions are made to the front of the    list and we want earlier ones to be prefered.  */
end_comment

begin_function
specifier|static
name|CGEN_INSN_LIST
modifier|*
name|hash_insn_array
parameter_list|(
name|cd
parameter_list|,
name|insns
parameter_list|,
name|count
parameter_list|,
name|entsize
parameter_list|,
name|htable
parameter_list|,
name|hentbuf
parameter_list|)
name|CGEN_CPU_DESC
name|cd
decl_stmt|;
specifier|const
name|CGEN_INSN
modifier|*
name|insns
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|entsize
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
modifier|*
name|htable
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
name|hentbuf
decl_stmt|;
block|{
name|int
name|big_p
init|=
name|CGEN_CPU_ENDIAN
argument_list|(
name|cd
argument_list|)
operator|==
name|CGEN_ENDIAN_BIG
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|count
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
operator|--
name|i
operator|,
operator|++
name|hentbuf
control|)
block|{
name|unsigned
name|int
name|hash
decl_stmt|;
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|unsigned
name|long
name|value
decl_stmt|;
specifier|const
name|CGEN_INSN
modifier|*
name|insn
init|=
operator|&
name|insns
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
call|(
modifier|*
name|cd
operator|->
name|dis_hash_p
call|)
argument_list|(
name|insn
argument_list|)
condition|)
continue|continue;
comment|/* We don't know whether the target uses the buffer or the base insn 	 to hash on, so set both up.  */
name|value
operator|=
name|CGEN_INSN_BASE_VALUE
argument_list|(
name|insn
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|CGEN_INSN_MASK_BITSIZE
argument_list|(
name|insn
argument_list|)
condition|)
block|{
case|case
literal|8
case|:
name|buf
index|[
literal|0
index|]
operator|=
name|value
expr_stmt|;
break|break;
case|case
literal|16
case|:
if|if
condition|(
name|big_p
condition|)
name|bfd_putb16
argument_list|(
operator|(
name|bfd_vma
operator|)
name|value
argument_list|,
name|buf
argument_list|)
expr_stmt|;
else|else
name|bfd_putl16
argument_list|(
operator|(
name|bfd_vma
operator|)
name|value
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|32
case|:
if|if
condition|(
name|big_p
condition|)
name|bfd_putb32
argument_list|(
operator|(
name|bfd_vma
operator|)
name|value
argument_list|,
name|buf
argument_list|)
expr_stmt|;
else|else
name|bfd_putl32
argument_list|(
operator|(
name|bfd_vma
operator|)
name|value
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
name|hash
operator|=
call|(
modifier|*
name|cd
operator|->
name|dis_hash
call|)
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|hentbuf
operator|->
name|next
operator|=
name|htable
index|[
name|hash
index|]
expr_stmt|;
name|hentbuf
operator|->
name|insn
operator|=
name|insn
expr_stmt|;
name|htable
index|[
name|hash
index|]
operator|=
name|hentbuf
expr_stmt|;
block|}
return|return
name|hentbuf
return|;
block|}
end_function

begin_comment
comment|/* Subroutine of build_dis_hash_table to add INSNS to the hash table.    This function is identical to hash_insn_array except the insns are    in a list.  */
end_comment

begin_function
specifier|static
name|CGEN_INSN_LIST
modifier|*
name|hash_insn_list
parameter_list|(
name|cd
parameter_list|,
name|insns
parameter_list|,
name|htable
parameter_list|,
name|hentbuf
parameter_list|)
name|CGEN_CPU_DESC
name|cd
decl_stmt|;
specifier|const
name|CGEN_INSN_LIST
modifier|*
name|insns
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
modifier|*
name|htable
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
name|hentbuf
decl_stmt|;
block|{
name|int
name|big_p
init|=
name|CGEN_CPU_ENDIAN
argument_list|(
name|cd
argument_list|)
operator|==
name|CGEN_ENDIAN_BIG
decl_stmt|;
specifier|const
name|CGEN_INSN_LIST
modifier|*
name|ilist
decl_stmt|;
for|for
control|(
name|ilist
operator|=
name|insns
init|;
name|ilist
operator|!=
name|NULL
condition|;
name|ilist
operator|=
name|ilist
operator|->
name|next
operator|,
operator|++
name|hentbuf
control|)
block|{
name|unsigned
name|int
name|hash
decl_stmt|;
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|unsigned
name|long
name|value
decl_stmt|;
if|if
condition|(
operator|!
call|(
modifier|*
name|cd
operator|->
name|dis_hash_p
call|)
argument_list|(
name|ilist
operator|->
name|insn
argument_list|)
condition|)
continue|continue;
comment|/* We don't know whether the target uses the buffer or the base insn 	 to hash on, so set both up.  */
name|value
operator|=
name|CGEN_INSN_BASE_VALUE
argument_list|(
name|ilist
operator|->
name|insn
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|CGEN_INSN_MASK_BITSIZE
argument_list|(
name|ilist
operator|->
name|insn
argument_list|)
condition|)
block|{
case|case
literal|8
case|:
name|buf
index|[
literal|0
index|]
operator|=
name|value
expr_stmt|;
break|break;
case|case
literal|16
case|:
if|if
condition|(
name|big_p
condition|)
name|bfd_putb16
argument_list|(
operator|(
name|bfd_vma
operator|)
name|value
argument_list|,
name|buf
argument_list|)
expr_stmt|;
else|else
name|bfd_putl16
argument_list|(
operator|(
name|bfd_vma
operator|)
name|value
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
literal|32
case|:
if|if
condition|(
name|big_p
condition|)
name|bfd_putb32
argument_list|(
operator|(
name|bfd_vma
operator|)
name|value
argument_list|,
name|buf
argument_list|)
expr_stmt|;
else|else
name|bfd_putl32
argument_list|(
operator|(
name|bfd_vma
operator|)
name|value
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
default|default:
name|abort
argument_list|()
expr_stmt|;
block|}
name|hash
operator|=
call|(
modifier|*
name|cd
operator|->
name|dis_hash
call|)
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|hentbuf
operator|->
name|next
operator|=
name|htable
index|[
name|hash
index|]
expr_stmt|;
name|hentbuf
operator|->
name|insn
operator|=
name|ilist
operator|->
name|insn
expr_stmt|;
name|htable
index|[
name|hash
index|]
operator|=
name|hentbuf
expr_stmt|;
block|}
return|return
name|hentbuf
return|;
block|}
end_function

begin_comment
comment|/* Build the disassembler instruction hash table.  */
end_comment

begin_function
specifier|static
name|void
name|build_dis_hash_table
parameter_list|(
name|cd
parameter_list|)
name|CGEN_CPU_DESC
name|cd
decl_stmt|;
block|{
name|int
name|count
init|=
name|cgen_insn_count
argument_list|(
name|cd
argument_list|)
operator|+
name|cgen_macro_insn_count
argument_list|(
name|cd
argument_list|)
decl_stmt|;
name|CGEN_INSN_TABLE
modifier|*
name|insn_table
init|=
operator|&
name|cd
operator|->
name|insn_table
decl_stmt|;
name|CGEN_INSN_TABLE
modifier|*
name|macro_insn_table
init|=
operator|&
name|cd
operator|->
name|macro_insn_table
decl_stmt|;
name|unsigned
name|int
name|hash_size
init|=
name|cd
operator|->
name|dis_hash_size
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
name|hash_entry_buf
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
modifier|*
name|dis_hash_table
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
name|dis_hash_table_entries
decl_stmt|;
comment|/* The space allocated for the hash table consists of two parts:      the hash table and the hash lists.  */
name|dis_hash_table
operator|=
operator|(
name|CGEN_INSN_LIST
operator|*
operator|*
operator|)
name|xmalloc
argument_list|(
name|hash_size
operator|*
sizeof|sizeof
argument_list|(
name|CGEN_INSN_LIST
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|dis_hash_table
argument_list|,
literal|0
argument_list|,
name|hash_size
operator|*
sizeof|sizeof
argument_list|(
name|CGEN_INSN_LIST
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|dis_hash_table_entries
operator|=
name|hash_entry_buf
operator|=
operator|(
name|CGEN_INSN_LIST
operator|*
operator|)
name|xmalloc
argument_list|(
name|count
operator|*
sizeof|sizeof
argument_list|(
name|CGEN_INSN_LIST
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Add compiled in insns.      Don't include the first one as it is a reserved entry.  */
comment|/* ??? It was the end of all hash chains, and also the special      "invalid insn" marker.  May be able to do it differently now.  */
name|hash_entry_buf
operator|=
name|hash_insn_array
argument_list|(
name|cd
argument_list|,
name|insn_table
operator|->
name|init_entries
operator|+
literal|1
argument_list|,
name|insn_table
operator|->
name|num_init_entries
operator|-
literal|1
argument_list|,
name|insn_table
operator|->
name|entry_size
argument_list|,
name|dis_hash_table
argument_list|,
name|hash_entry_buf
argument_list|)
expr_stmt|;
comment|/* Add compiled in macro-insns.  */
name|hash_entry_buf
operator|=
name|hash_insn_array
argument_list|(
name|cd
argument_list|,
name|macro_insn_table
operator|->
name|init_entries
argument_list|,
name|macro_insn_table
operator|->
name|num_init_entries
argument_list|,
name|macro_insn_table
operator|->
name|entry_size
argument_list|,
name|dis_hash_table
argument_list|,
name|hash_entry_buf
argument_list|)
expr_stmt|;
comment|/* Add runtime added insns.      Later added insns will be prefered over earlier ones.  */
name|hash_entry_buf
operator|=
name|hash_insn_list
argument_list|(
name|cd
argument_list|,
name|insn_table
operator|->
name|new_entries
argument_list|,
name|dis_hash_table
argument_list|,
name|hash_entry_buf
argument_list|)
expr_stmt|;
comment|/* Add runtime added macro-insns.  */
name|hash_insn_list
argument_list|(
name|cd
argument_list|,
name|macro_insn_table
operator|->
name|new_entries
argument_list|,
name|dis_hash_table
argument_list|,
name|hash_entry_buf
argument_list|)
expr_stmt|;
name|cd
operator|->
name|dis_hash_table
operator|=
name|dis_hash_table
expr_stmt|;
name|cd
operator|->
name|dis_hash_table_entries
operator|=
name|dis_hash_table_entries
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Return the first entry in the hash list for INSN.  */
end_comment

begin_function
name|CGEN_INSN_LIST
modifier|*
name|cgen_dis_lookup_insn
parameter_list|(
name|cd
parameter_list|,
name|buf
parameter_list|,
name|value
parameter_list|)
name|CGEN_CPU_DESC
name|cd
decl_stmt|;
specifier|const
name|char
modifier|*
name|buf
decl_stmt|;
name|CGEN_INSN_INT
name|value
decl_stmt|;
block|{
name|unsigned
name|int
name|hash
decl_stmt|;
if|if
condition|(
name|cd
operator|->
name|dis_hash_table
operator|==
name|NULL
condition|)
name|build_dis_hash_table
argument_list|(
name|cd
argument_list|)
expr_stmt|;
name|hash
operator|=
call|(
modifier|*
name|cd
operator|->
name|dis_hash
call|)
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|cd
operator|->
name|dis_hash_table
index|[
name|hash
index|]
return|;
block|}
end_function

end_unit


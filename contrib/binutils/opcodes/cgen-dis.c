begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* CGEN generic disassembler support code.     Copyright 1996, 1997, 1998, 1999, 2000, 2001, 2002    Free Software Foundation, Inc.     This file is part of the GNU Binutils and GDB, the GNU debugger.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2, or (at your option)    any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License along    with this program; if not, write to the Free Software Foundation, Inc.,    59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"ansidecl.h"
end_include

begin_include
include|#
directive|include
file|"libiberty.h"
end_include

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"symcat.h"
end_include

begin_include
include|#
directive|include
file|"opcode/cgen.h"
end_include

begin_decl_stmt
specifier|static
name|CGEN_INSN_LIST
modifier|*
name|hash_insn_array
name|PARAMS
argument_list|(
operator|(
name|CGEN_CPU_DESC
operator|,
specifier|const
name|CGEN_INSN
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|CGEN_INSN_LIST
operator|*
operator|*
operator|,
name|CGEN_INSN_LIST
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|CGEN_INSN_LIST
modifier|*
name|hash_insn_list
name|PARAMS
argument_list|(
operator|(
name|CGEN_CPU_DESC
operator|,
specifier|const
name|CGEN_INSN_LIST
operator|*
operator|,
name|CGEN_INSN_LIST
operator|*
operator|*
operator|,
name|CGEN_INSN_LIST
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|build_dis_hash_table
name|PARAMS
argument_list|(
operator|(
name|CGEN_CPU_DESC
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|count_decodable_bits
name|PARAMS
argument_list|(
operator|(
specifier|const
name|CGEN_INSN
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|add_insn_to_hash_chain
name|PARAMS
argument_list|(
operator|(
name|CGEN_INSN_LIST
operator|*
operator|,
specifier|const
name|CGEN_INSN
operator|*
operator|,
name|CGEN_INSN_LIST
operator|*
operator|*
operator|,
name|unsigned
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Return the number of decodable bits in this insn.  */
end_comment

begin_function
specifier|static
name|int
name|count_decodable_bits
parameter_list|(
name|insn
parameter_list|)
specifier|const
name|CGEN_INSN
modifier|*
name|insn
decl_stmt|;
block|{
name|unsigned
name|mask
init|=
name|CGEN_INSN_BASE_MASK
argument_list|(
name|insn
argument_list|)
decl_stmt|;
name|int
name|bits
init|=
literal|0
decl_stmt|;
name|int
name|m
decl_stmt|;
for|for
control|(
name|m
operator|=
literal|1
init|;
name|m
operator|!=
literal|0
condition|;
name|m
operator|<<=
literal|1
control|)
block|{
if|if
condition|(
name|mask
operator|&
name|m
condition|)
operator|++
name|bits
expr_stmt|;
block|}
return|return
name|bits
return|;
block|}
end_function

begin_comment
comment|/* Add an instruction to the hash chain.  */
end_comment

begin_function
specifier|static
name|void
name|add_insn_to_hash_chain
parameter_list|(
name|hentbuf
parameter_list|,
name|insn
parameter_list|,
name|htable
parameter_list|,
name|hash
parameter_list|)
name|CGEN_INSN_LIST
modifier|*
name|hentbuf
decl_stmt|;
specifier|const
name|CGEN_INSN
modifier|*
name|insn
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
modifier|*
name|htable
decl_stmt|;
name|unsigned
name|int
name|hash
decl_stmt|;
block|{
name|CGEN_INSN_LIST
modifier|*
name|current_buf
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
name|previous_buf
decl_stmt|;
name|int
name|insn_decodable_bits
decl_stmt|;
comment|/* Add insns sorted by the number of decodable bits, in decreasing order.      This ensures that any insn which is a special case of another will be      checked first.  */
name|insn_decodable_bits
operator|=
name|count_decodable_bits
argument_list|(
name|insn
argument_list|)
expr_stmt|;
name|previous_buf
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|current_buf
operator|=
name|htable
index|[
name|hash
index|]
init|;
name|current_buf
operator|!=
name|NULL
condition|;
name|current_buf
operator|=
name|current_buf
operator|->
name|next
control|)
block|{
name|int
name|current_decodable_bits
init|=
name|count_decodable_bits
argument_list|(
name|current_buf
operator|->
name|insn
argument_list|)
decl_stmt|;
if|if
condition|(
name|insn_decodable_bits
operator|>=
name|current_decodable_bits
condition|)
break|break;
name|previous_buf
operator|=
name|current_buf
expr_stmt|;
block|}
comment|/* Now insert the new insn.  */
name|hentbuf
operator|->
name|insn
operator|=
name|insn
expr_stmt|;
name|hentbuf
operator|->
name|next
operator|=
name|current_buf
expr_stmt|;
if|if
condition|(
name|previous_buf
operator|==
name|NULL
condition|)
name|htable
index|[
name|hash
index|]
operator|=
name|hentbuf
expr_stmt|;
else|else
name|previous_buf
operator|->
name|next
operator|=
name|hentbuf
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Subroutine of build_dis_hash_table to add INSNS to the hash table.     COUNT is the number of elements in INSNS.    ENTSIZE is sizeof (CGEN_IBASE) for the target.    ??? No longer used but leave in for now.    HTABLE points to the hash table.    HENTBUF is a pointer to sufficiently large buffer of hash entries.    The result is a pointer to the next entry to use.     The table is scanned backwards as additions are made to the front of the    list and we want earlier ones to be prefered.  */
end_comment

begin_function
specifier|static
name|CGEN_INSN_LIST
modifier|*
name|hash_insn_array
parameter_list|(
name|cd
parameter_list|,
name|insns
parameter_list|,
name|count
parameter_list|,
name|entsize
parameter_list|,
name|htable
parameter_list|,
name|hentbuf
parameter_list|)
name|CGEN_CPU_DESC
name|cd
decl_stmt|;
specifier|const
name|CGEN_INSN
modifier|*
name|insns
decl_stmt|;
name|int
name|count
decl_stmt|;
name|int
name|entsize
name|ATTRIBUTE_UNUSED
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
modifier|*
name|htable
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
name|hentbuf
decl_stmt|;
block|{
name|int
name|big_p
init|=
name|CGEN_CPU_ENDIAN
argument_list|(
name|cd
argument_list|)
operator|==
name|CGEN_ENDIAN_BIG
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|count
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
operator|--
name|i
operator|,
operator|++
name|hentbuf
control|)
block|{
name|unsigned
name|int
name|hash
decl_stmt|;
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|unsigned
name|long
name|value
decl_stmt|;
specifier|const
name|CGEN_INSN
modifier|*
name|insn
init|=
operator|&
name|insns
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
call|(
modifier|*
name|cd
operator|->
name|dis_hash_p
call|)
argument_list|(
name|insn
argument_list|)
condition|)
continue|continue;
comment|/* We don't know whether the target uses the buffer or the base insn 	 to hash on, so set both up.  */
name|value
operator|=
name|CGEN_INSN_BASE_VALUE
argument_list|(
name|insn
argument_list|)
expr_stmt|;
name|bfd_put_bits
argument_list|(
operator|(
name|bfd_vma
operator|)
name|value
argument_list|,
name|buf
argument_list|,
name|CGEN_INSN_MASK_BITSIZE
argument_list|(
name|insn
argument_list|)
argument_list|,
name|big_p
argument_list|)
expr_stmt|;
name|hash
operator|=
call|(
modifier|*
name|cd
operator|->
name|dis_hash
call|)
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|add_insn_to_hash_chain
argument_list|(
name|hentbuf
argument_list|,
name|insn
argument_list|,
name|htable
argument_list|,
name|hash
argument_list|)
expr_stmt|;
block|}
return|return
name|hentbuf
return|;
block|}
end_function

begin_comment
comment|/* Subroutine of build_dis_hash_table to add INSNS to the hash table.    This function is identical to hash_insn_array except the insns are    in a list.  */
end_comment

begin_function
specifier|static
name|CGEN_INSN_LIST
modifier|*
name|hash_insn_list
parameter_list|(
name|cd
parameter_list|,
name|insns
parameter_list|,
name|htable
parameter_list|,
name|hentbuf
parameter_list|)
name|CGEN_CPU_DESC
name|cd
decl_stmt|;
specifier|const
name|CGEN_INSN_LIST
modifier|*
name|insns
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
modifier|*
name|htable
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
name|hentbuf
decl_stmt|;
block|{
name|int
name|big_p
init|=
name|CGEN_CPU_ENDIAN
argument_list|(
name|cd
argument_list|)
operator|==
name|CGEN_ENDIAN_BIG
decl_stmt|;
specifier|const
name|CGEN_INSN_LIST
modifier|*
name|ilist
decl_stmt|;
for|for
control|(
name|ilist
operator|=
name|insns
init|;
name|ilist
operator|!=
name|NULL
condition|;
name|ilist
operator|=
name|ilist
operator|->
name|next
operator|,
operator|++
name|hentbuf
control|)
block|{
name|unsigned
name|int
name|hash
decl_stmt|;
name|char
name|buf
index|[
literal|4
index|]
decl_stmt|;
name|unsigned
name|long
name|value
decl_stmt|;
if|if
condition|(
operator|!
call|(
modifier|*
name|cd
operator|->
name|dis_hash_p
call|)
argument_list|(
name|ilist
operator|->
name|insn
argument_list|)
condition|)
continue|continue;
comment|/* We don't know whether the target uses the buffer or the base insn 	 to hash on, so set both up.  */
name|value
operator|=
name|CGEN_INSN_BASE_VALUE
argument_list|(
name|ilist
operator|->
name|insn
argument_list|)
expr_stmt|;
name|bfd_put_bits
argument_list|(
operator|(
name|bfd_vma
operator|)
name|value
argument_list|,
name|buf
argument_list|,
name|CGEN_INSN_MASK_BITSIZE
argument_list|(
name|ilist
operator|->
name|insn
argument_list|)
argument_list|,
name|big_p
argument_list|)
expr_stmt|;
name|hash
operator|=
call|(
modifier|*
name|cd
operator|->
name|dis_hash
call|)
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|add_insn_to_hash_chain
argument_list|(
name|hentbuf
argument_list|,
name|ilist
operator|->
name|insn
argument_list|,
name|htable
argument_list|,
name|hash
argument_list|)
expr_stmt|;
block|}
return|return
name|hentbuf
return|;
block|}
end_function

begin_comment
comment|/* Build the disassembler instruction hash table.  */
end_comment

begin_function
specifier|static
name|void
name|build_dis_hash_table
parameter_list|(
name|cd
parameter_list|)
name|CGEN_CPU_DESC
name|cd
decl_stmt|;
block|{
name|int
name|count
init|=
name|cgen_insn_count
argument_list|(
name|cd
argument_list|)
operator|+
name|cgen_macro_insn_count
argument_list|(
name|cd
argument_list|)
decl_stmt|;
name|CGEN_INSN_TABLE
modifier|*
name|insn_table
init|=
operator|&
name|cd
operator|->
name|insn_table
decl_stmt|;
name|CGEN_INSN_TABLE
modifier|*
name|macro_insn_table
init|=
operator|&
name|cd
operator|->
name|macro_insn_table
decl_stmt|;
name|unsigned
name|int
name|hash_size
init|=
name|cd
operator|->
name|dis_hash_size
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
name|hash_entry_buf
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
modifier|*
name|dis_hash_table
decl_stmt|;
name|CGEN_INSN_LIST
modifier|*
name|dis_hash_table_entries
decl_stmt|;
comment|/* The space allocated for the hash table consists of two parts:      the hash table and the hash lists.  */
name|dis_hash_table
operator|=
operator|(
name|CGEN_INSN_LIST
operator|*
operator|*
operator|)
name|xmalloc
argument_list|(
name|hash_size
operator|*
sizeof|sizeof
argument_list|(
name|CGEN_INSN_LIST
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|dis_hash_table
argument_list|,
literal|0
argument_list|,
name|hash_size
operator|*
sizeof|sizeof
argument_list|(
name|CGEN_INSN_LIST
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|dis_hash_table_entries
operator|=
name|hash_entry_buf
operator|=
operator|(
name|CGEN_INSN_LIST
operator|*
operator|)
name|xmalloc
argument_list|(
name|count
operator|*
sizeof|sizeof
argument_list|(
name|CGEN_INSN_LIST
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Add compiled in insns.      Don't include the first one as it is a reserved entry.  */
comment|/* ??? It was the end of all hash chains, and also the special      "invalid insn" marker.  May be able to do it differently now.  */
name|hash_entry_buf
operator|=
name|hash_insn_array
argument_list|(
name|cd
argument_list|,
name|insn_table
operator|->
name|init_entries
operator|+
literal|1
argument_list|,
name|insn_table
operator|->
name|num_init_entries
operator|-
literal|1
argument_list|,
name|insn_table
operator|->
name|entry_size
argument_list|,
name|dis_hash_table
argument_list|,
name|hash_entry_buf
argument_list|)
expr_stmt|;
comment|/* Add compiled in macro-insns.  */
name|hash_entry_buf
operator|=
name|hash_insn_array
argument_list|(
name|cd
argument_list|,
name|macro_insn_table
operator|->
name|init_entries
argument_list|,
name|macro_insn_table
operator|->
name|num_init_entries
argument_list|,
name|macro_insn_table
operator|->
name|entry_size
argument_list|,
name|dis_hash_table
argument_list|,
name|hash_entry_buf
argument_list|)
expr_stmt|;
comment|/* Add runtime added insns.      Later added insns will be prefered over earlier ones.  */
name|hash_entry_buf
operator|=
name|hash_insn_list
argument_list|(
name|cd
argument_list|,
name|insn_table
operator|->
name|new_entries
argument_list|,
name|dis_hash_table
argument_list|,
name|hash_entry_buf
argument_list|)
expr_stmt|;
comment|/* Add runtime added macro-insns.  */
name|hash_insn_list
argument_list|(
name|cd
argument_list|,
name|macro_insn_table
operator|->
name|new_entries
argument_list|,
name|dis_hash_table
argument_list|,
name|hash_entry_buf
argument_list|)
expr_stmt|;
name|cd
operator|->
name|dis_hash_table
operator|=
name|dis_hash_table
expr_stmt|;
name|cd
operator|->
name|dis_hash_table_entries
operator|=
name|dis_hash_table_entries
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Return the first entry in the hash list for INSN.  */
end_comment

begin_function
name|CGEN_INSN_LIST
modifier|*
name|cgen_dis_lookup_insn
parameter_list|(
name|cd
parameter_list|,
name|buf
parameter_list|,
name|value
parameter_list|)
name|CGEN_CPU_DESC
name|cd
decl_stmt|;
specifier|const
name|char
modifier|*
name|buf
decl_stmt|;
name|CGEN_INSN_INT
name|value
decl_stmt|;
block|{
name|unsigned
name|int
name|hash
decl_stmt|;
if|if
condition|(
name|cd
operator|->
name|dis_hash_table
operator|==
name|NULL
condition|)
name|build_dis_hash_table
argument_list|(
name|cd
argument_list|)
expr_stmt|;
name|hash
operator|=
call|(
modifier|*
name|cd
operator|->
name|dis_hash
call|)
argument_list|(
name|buf
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|cd
operator|->
name|dis_hash_table
index|[
name|hash
index|]
return|;
block|}
end_function

end_unit


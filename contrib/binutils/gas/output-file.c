begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* output-file.c -  Deal with the output file    Copyright 1987, 1990, 1991, 1992, 1993, 1994, 1996, 1998, 1999, 2001,    2003, 2004, 2005, 2006 Free Software Foundation, Inc.     This file is part of GAS, the GNU Assembler.     GAS is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2, or (at your option)    any later version.     GAS is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with GAS; see the file COPYING.  If not, write to    the Free Software Foundation, 51 Franklin Street - Fifth Floor, Boston, MA    02110-1301, USA.  */
end_comment

begin_include
include|#
directive|include
file|"as.h"
end_include

begin_include
include|#
directive|include
file|"output-file.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|TARGET_MACH
end_ifndef

begin_define
define|#
directive|define
name|TARGET_MACH
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|bfd
modifier|*
name|stdoutput
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|output_file_create
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
if|if
condition|(
name|name
index|[
literal|0
index|]
operator|==
literal|'-'
operator|&&
name|name
index|[
literal|1
index|]
operator|==
literal|'\0'
condition|)
name|as_fatal
argument_list|(
name|_
argument_list|(
literal|"can't open a bfd on stdout %s"
argument_list|)
argument_list|,
name|name
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
operator|(
name|stdoutput
operator|=
name|bfd_openw
argument_list|(
name|name
argument_list|,
name|TARGET_FORMAT
argument_list|)
operator|)
condition|)
block|{
name|bfd_error_type
name|err
init|=
name|bfd_get_error
argument_list|()
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|bfd_error_invalid_target
condition|)
name|as_fatal
argument_list|(
name|_
argument_list|(
literal|"selected target format '%s' unknown"
argument_list|)
argument_list|,
name|TARGET_FORMAT
argument_list|)
expr_stmt|;
else|else
name|as_fatal
argument_list|(
name|_
argument_list|(
literal|"can't create %s: %s"
argument_list|)
argument_list|,
name|name
argument_list|,
name|bfd_errmsg
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|bfd_set_format
argument_list|(
name|stdoutput
argument_list|,
name|bfd_object
argument_list|)
expr_stmt|;
name|bfd_set_arch_mach
argument_list|(
name|stdoutput
argument_list|,
name|TARGET_ARCH
argument_list|,
name|TARGET_MACH
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag_traditional_format
condition|)
name|stdoutput
operator|->
name|flags
operator||=
name|BFD_TRADITIONAL_FORMAT
expr_stmt|;
block|}
end_function

begin_function
name|void
name|output_file_close
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|bfd_boolean
name|res
decl_stmt|;
if|if
condition|(
name|stdoutput
operator|==
name|NULL
condition|)
return|return;
comment|/* Close the bfd.  */
name|res
operator|=
name|bfd_close
argument_list|(
name|stdoutput
argument_list|)
expr_stmt|;
comment|/* Prevent an infinite loop - if the close failed we will call as_fatal      which will call xexit() which may call this function again...  */
name|stdoutput
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
name|as_fatal
argument_list|(
name|_
argument_list|(
literal|"can't close %s: %s"
argument_list|)
argument_list|,
name|filename
argument_list|,
name|bfd_errmsg
argument_list|(
name|bfd_get_error
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


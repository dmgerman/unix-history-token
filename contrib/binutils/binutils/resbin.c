begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* resbin.c -- manipulate the Windows binary resource format.    Copyright 1997, 1998, 1999, 2002, 2003, 2007    Free Software Foundation, Inc.    Written by Ian Lance Taylor, Cygnus Support.    Rewritten by Kai Tietz, Onevision.     This file is part of GNU Binutils.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA    02110-1301, USA.  */
end_comment

begin_comment
comment|/* This file contains functions to convert between the binary resource    format and the internal structures that we want to use.  The same    binary resource format is used in both res and COFF files.  */
end_comment

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"bucomm.h"
end_include

begin_include
include|#
directive|include
file|"libiberty.h"
end_include

begin_include
include|#
directive|include
file|"windres.h"
end_include

begin_comment
comment|/* Local functions.  */
end_comment

begin_function_decl
specifier|static
name|void
name|toosmall
parameter_list|(
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|unichar
modifier|*
name|get_unicode
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
name|rc_uint_type
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|get_resid
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_res_id
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_generic
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|enum
name|rc_res_type
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_cursor
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_menu
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_menuitem
modifier|*
name|bin_to_res_menuitems
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
name|rc_uint_type
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_menuitem
modifier|*
name|bin_to_res_menuexitems
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
name|rc_uint_type
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_dialog
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_string
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_fontdir
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_accelerators
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_rcdata
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_group_cursor
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_group_icon
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_version
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_userdata
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_toolbar
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|get_version_header
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|unichar
modifier|*
modifier|*
parameter_list|,
name|rc_uint_type
modifier|*
parameter_list|,
name|rc_uint_type
modifier|*
parameter_list|,
name|rc_uint_type
modifier|*
parameter_list|,
name|rc_uint_type
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Given a resource type ID, a pointer to data, a length, return a    rc_res_resource structure which represents that resource.  The caller    is responsible for initializing the res_info and coff_info fields    of the returned structure.  */
end_comment

begin_function
name|rc_res_resource
modifier|*
name|bin_to_res
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_res_id
name|type
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
if|if
condition|(
name|type
operator|.
name|named
condition|)
return|return
name|bin_to_res_userdata
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
else|else
block|{
switch|switch
condition|(
name|type
operator|.
name|u
operator|.
name|id
condition|)
block|{
default|default:
return|return
name|bin_to_res_userdata
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_CURSOR
case|:
return|return
name|bin_to_res_cursor
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_BITMAP
case|:
return|return
name|bin_to_res_generic
argument_list|(
name|wrbfd
argument_list|,
name|RES_TYPE_BITMAP
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_ICON
case|:
return|return
name|bin_to_res_generic
argument_list|(
name|wrbfd
argument_list|,
name|RES_TYPE_ICON
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_MENU
case|:
return|return
name|bin_to_res_menu
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_DIALOG
case|:
return|return
name|bin_to_res_dialog
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_STRING
case|:
return|return
name|bin_to_res_string
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_FONTDIR
case|:
return|return
name|bin_to_res_fontdir
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_FONT
case|:
return|return
name|bin_to_res_generic
argument_list|(
name|wrbfd
argument_list|,
name|RES_TYPE_FONT
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_ACCELERATOR
case|:
return|return
name|bin_to_res_accelerators
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_RCDATA
case|:
return|return
name|bin_to_res_rcdata
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
name|RES_TYPE_RCDATA
argument_list|)
return|;
case|case
name|RT_MESSAGETABLE
case|:
return|return
name|bin_to_res_generic
argument_list|(
name|wrbfd
argument_list|,
name|RES_TYPE_MESSAGETABLE
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_GROUP_CURSOR
case|:
return|return
name|bin_to_res_group_cursor
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_GROUP_ICON
case|:
return|return
name|bin_to_res_group_icon
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_VERSION
case|:
return|return
name|bin_to_res_version
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
case|case
name|RT_TOOLBAR
case|:
return|return
name|bin_to_res_toolbar
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|)
return|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* Give an error if the binary data is too small.  */
end_comment

begin_function
specifier|static
name|void
name|toosmall
parameter_list|(
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|fatal
argument_list|(
name|_
argument_list|(
literal|"%s: not enough binary data"
argument_list|)
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Swap in a NULL terminated unicode string.  */
end_comment

begin_function
specifier|static
name|unichar
modifier|*
name|get_unicode
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|,
name|rc_uint_type
modifier|*
name|retlen
parameter_list|)
block|{
name|rc_uint_type
name|c
decl_stmt|,
name|i
decl_stmt|;
name|unichar
modifier|*
name|ret
decl_stmt|;
name|c
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|length
operator|<
name|c
operator|*
literal|2
operator|+
literal|2
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"null terminated unicode string"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|c
operator|*
literal|2
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
break|break;
operator|++
name|c
expr_stmt|;
block|}
name|ret
operator|=
operator|(
name|unichar
operator|*
operator|)
name|res_alloc
argument_list|(
operator|(
name|c
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
condition|;
name|i
operator|++
control|)
name|ret
index|[
name|i
index|]
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|i
operator|*
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ret
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|retlen
operator|!=
name|NULL
condition|)
operator|*
name|retlen
operator|=
name|c
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Get a resource identifier.  This returns the number of bytes used.  */
end_comment

begin_function
specifier|static
name|int
name|get_resid
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_res_id
modifier|*
name|id
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_uint_type
name|first
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|2
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"resource ID"
argument_list|)
argument_list|)
expr_stmt|;
name|first
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
operator|==
literal|0xffff
condition|)
block|{
if|if
condition|(
name|length
operator|<
literal|4
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"resource ID"
argument_list|)
argument_list|)
expr_stmt|;
name|id
operator|->
name|named
operator|=
literal|0
expr_stmt|;
name|id
operator|->
name|u
operator|.
name|id
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
literal|4
return|;
block|}
else|else
block|{
name|id
operator|->
name|named
operator|=
literal|1
expr_stmt|;
name|id
operator|->
name|u
operator|.
name|n
operator|.
name|name
operator|=
name|get_unicode
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
operator|&
name|id
operator|->
name|u
operator|.
name|n
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
name|id
operator|->
name|u
operator|.
name|n
operator|.
name|length
operator|*
literal|2
operator|+
literal|2
return|;
block|}
block|}
end_function

begin_comment
comment|/* Convert a resource which just stores uninterpreted data from    binary.  */
end_comment

begin_function
name|rc_res_resource
modifier|*
name|bin_to_res_generic
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
name|ATTRIBUTE_UNUSED
parameter_list|,
name|enum
name|rc_res_type
name|type
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_res_resource
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|data
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|data
operator|.
name|length
operator|=
name|length
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Convert a cursor resource from binary.  */
end_comment

begin_function
name|rc_res_resource
modifier|*
name|bin_to_res_cursor
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_cursor
modifier|*
name|c
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|4
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"cursor"
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
operator|(
name|rc_cursor
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_cursor
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|->
name|xhotspot
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|c
operator|->
name|yhotspot
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|c
operator|->
name|length
operator|=
name|length
operator|-
literal|4
expr_stmt|;
name|c
operator|->
name|data
operator|=
name|data
operator|+
literal|4
expr_stmt|;
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_CURSOR
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|cursor
operator|=
name|c
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Convert a menu resource from binary.  */
end_comment

begin_function
name|rc_res_resource
modifier|*
name|bin_to_res_menu
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
name|rc_menu
modifier|*
name|m
decl_stmt|;
name|rc_uint_type
name|version
decl_stmt|,
name|read
decl_stmt|;
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_MENU
expr_stmt|;
name|m
operator|=
operator|(
name|rc_menu
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_menu
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|menu
operator|=
name|m
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|2
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"menu header"
argument_list|)
argument_list|)
expr_stmt|;
name|version
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|length
operator|<
literal|4
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"menu header"
argument_list|)
argument_list|)
expr_stmt|;
name|m
operator|->
name|help
operator|=
literal|0
expr_stmt|;
name|m
operator|->
name|items
operator|=
name|bin_to_res_menuitems
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
name|length
operator|-
literal|4
argument_list|,
operator|&
name|read
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|version
operator|==
literal|1
condition|)
block|{
name|rc_uint_type
name|offset
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|8
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"menuex header"
argument_list|)
argument_list|)
expr_stmt|;
name|m
operator|->
name|help
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|offset
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|offset
operator|+
literal|4
operator|>=
name|length
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"menuex offset"
argument_list|)
argument_list|)
expr_stmt|;
name|m
operator|->
name|items
operator|=
name|bin_to_res_menuexitems
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
operator|+
name|offset
argument_list|,
name|length
operator|-
operator|(
literal|4
operator|+
name|offset
operator|)
argument_list|,
operator|&
name|read
argument_list|)
expr_stmt|;
block|}
else|else
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unsupported menu version %d"
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|version
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Convert menu items from binary.  */
end_comment

begin_function
specifier|static
name|rc_menuitem
modifier|*
name|bin_to_res_menuitems
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|,
name|rc_uint_type
modifier|*
name|read
parameter_list|)
block|{
name|rc_menuitem
modifier|*
name|first
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
name|first
operator|=
name|NULL
expr_stmt|;
name|pp
operator|=
operator|&
name|first
expr_stmt|;
operator|*
name|read
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
condition|)
block|{
name|rc_uint_type
name|flags
decl_stmt|,
name|slen
decl_stmt|,
name|itemlen
decl_stmt|;
name|rc_uint_type
name|stroff
decl_stmt|;
name|rc_menuitem
modifier|*
name|mi
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|4
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"menuitem header"
argument_list|)
argument_list|)
expr_stmt|;
name|mi
operator|=
operator|(
name|rc_menuitem
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|mi
argument_list|)
expr_stmt|;
name|mi
operator|->
name|state
operator|=
literal|0
expr_stmt|;
name|mi
operator|->
name|help
operator|=
literal|0
expr_stmt|;
name|flags
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|mi
operator|->
name|type
operator|=
name|flags
operator|&
operator|~
operator|(
name|MENUITEM_POPUP
operator||
name|MENUITEM_ENDMENU
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|MENUITEM_POPUP
operator|)
operator|==
literal|0
condition|)
name|stroff
operator|=
literal|4
expr_stmt|;
else|else
name|stroff
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|length
operator|<
name|stroff
operator|+
literal|2
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"menuitem header"
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|stroff
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|slen
operator|=
literal|0
expr_stmt|;
name|mi
operator|->
name|text
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|mi
operator|->
name|text
operator|=
name|get_unicode
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|stroff
argument_list|,
name|length
operator|-
name|stroff
argument_list|,
operator|&
name|slen
argument_list|)
expr_stmt|;
name|itemlen
operator|=
name|stroff
operator|+
name|slen
operator|*
literal|2
operator|+
literal|2
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|MENUITEM_POPUP
operator|)
operator|==
literal|0
condition|)
block|{
name|mi
operator|->
name|popup
operator|=
name|NULL
expr_stmt|;
name|mi
operator|->
name|id
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc_uint_type
name|subread
decl_stmt|;
name|mi
operator|->
name|id
operator|=
literal|0
expr_stmt|;
name|mi
operator|->
name|popup
operator|=
name|bin_to_res_menuitems
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|itemlen
argument_list|,
name|length
operator|-
name|itemlen
argument_list|,
operator|&
name|subread
argument_list|)
expr_stmt|;
name|itemlen
operator|+=
name|subread
expr_stmt|;
block|}
name|mi
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
operator|*
name|pp
operator|=
name|mi
expr_stmt|;
name|pp
operator|=
operator|&
name|mi
operator|->
name|next
expr_stmt|;
name|data
operator|+=
name|itemlen
expr_stmt|;
name|length
operator|-=
name|itemlen
expr_stmt|;
operator|*
name|read
operator|+=
name|itemlen
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|MENUITEM_ENDMENU
operator|)
operator|!=
literal|0
condition|)
return|return
name|first
return|;
block|}
return|return
name|first
return|;
block|}
end_function

begin_comment
comment|/* Convert menuex items from binary.  */
end_comment

begin_function
specifier|static
name|rc_menuitem
modifier|*
name|bin_to_res_menuexitems
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|,
name|rc_uint_type
modifier|*
name|read
parameter_list|)
block|{
name|rc_menuitem
modifier|*
name|first
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
name|first
operator|=
name|NULL
expr_stmt|;
name|pp
operator|=
operator|&
name|first
expr_stmt|;
operator|*
name|read
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
condition|)
block|{
name|rc_uint_type
name|flags
decl_stmt|,
name|slen
decl_stmt|;
name|rc_uint_type
name|itemlen
decl_stmt|;
name|rc_menuitem
modifier|*
name|mi
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|16
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"menuitem header"
argument_list|)
argument_list|)
expr_stmt|;
name|mi
operator|=
operator|(
name|rc_menuitem
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_menuitem
argument_list|)
argument_list|)
expr_stmt|;
name|mi
operator|->
name|type
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|mi
operator|->
name|state
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|mi
operator|->
name|id
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|flags
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|12
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|14
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|slen
operator|=
literal|0
expr_stmt|;
name|mi
operator|->
name|text
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|mi
operator|->
name|text
operator|=
name|get_unicode
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|14
argument_list|,
name|length
operator|-
literal|14
argument_list|,
operator|&
name|slen
argument_list|)
expr_stmt|;
name|itemlen
operator|=
literal|14
operator|+
name|slen
operator|*
literal|2
operator|+
literal|2
expr_stmt|;
name|itemlen
operator|=
operator|(
name|itemlen
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
literal|1
operator|)
operator|==
literal|0
condition|)
block|{
name|mi
operator|->
name|popup
operator|=
name|NULL
expr_stmt|;
name|mi
operator|->
name|help
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|rc_uint_type
name|subread
decl_stmt|;
if|if
condition|(
name|length
operator|<
name|itemlen
operator|+
literal|4
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"menuitem"
argument_list|)
argument_list|)
expr_stmt|;
name|mi
operator|->
name|help
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|itemlen
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|itemlen
operator|+=
literal|4
expr_stmt|;
name|mi
operator|->
name|popup
operator|=
name|bin_to_res_menuexitems
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|itemlen
argument_list|,
name|length
operator|-
name|itemlen
argument_list|,
operator|&
name|subread
argument_list|)
expr_stmt|;
name|itemlen
operator|+=
name|subread
expr_stmt|;
block|}
name|mi
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
operator|*
name|pp
operator|=
name|mi
expr_stmt|;
name|pp
operator|=
operator|&
name|mi
operator|->
name|next
expr_stmt|;
name|data
operator|+=
name|itemlen
expr_stmt|;
name|length
operator|-=
name|itemlen
expr_stmt|;
operator|*
name|read
operator|+=
name|itemlen
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
literal|0x80
operator|)
operator|!=
literal|0
condition|)
return|return
name|first
return|;
block|}
return|return
name|first
return|;
block|}
end_function

begin_comment
comment|/* Convert a dialog resource from binary.  */
end_comment

begin_function
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_dialog
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_uint_type
name|signature
decl_stmt|;
name|rc_dialog
modifier|*
name|d
decl_stmt|;
name|rc_uint_type
name|c
decl_stmt|,
name|sublen
decl_stmt|,
name|i
decl_stmt|;
name|rc_uint_type
name|off
decl_stmt|;
name|rc_dialog_control
modifier|*
modifier|*
name|pp
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|18
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"dialog header"
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|=
operator|(
name|rc_dialog
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_dialog
argument_list|)
argument_list|)
expr_stmt|;
name|signature
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|signature
operator|!=
literal|0xffff
condition|)
block|{
name|d
operator|->
name|ex
operator|=
name|NULL
expr_stmt|;
name|d
operator|->
name|style
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|d
operator|->
name|exstyle
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|off
operator|=
literal|8
expr_stmt|;
block|}
else|else
block|{
name|int
name|version
decl_stmt|;
name|version
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|version
operator|!=
literal|1
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected DIALOGEX version %d"
argument_list|)
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|d
operator|->
name|ex
operator|=
operator|(
name|rc_dialog_ex
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_dialog_ex
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|->
name|ex
operator|->
name|help
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|d
operator|->
name|exstyle
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|d
operator|->
name|style
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|12
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|off
operator|=
literal|16
expr_stmt|;
block|}
if|if
condition|(
name|length
operator|<
name|off
operator|+
literal|10
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"dialog header"
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|d
operator|->
name|x
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|d
operator|->
name|y
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|d
operator|->
name|width
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|6
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|d
operator|->
name|height
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|8
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|off
operator|+=
literal|10
expr_stmt|;
name|sublen
operator|=
name|get_resid
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|d
operator|->
name|menu
argument_list|,
name|data
operator|+
name|off
argument_list|,
name|length
operator|-
name|off
argument_list|)
expr_stmt|;
name|off
operator|+=
name|sublen
expr_stmt|;
name|sublen
operator|=
name|get_resid
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|d
operator|->
name|class
argument_list|,
name|data
operator|+
name|off
argument_list|,
name|length
operator|-
name|off
argument_list|)
expr_stmt|;
name|off
operator|+=
name|sublen
expr_stmt|;
name|d
operator|->
name|caption
operator|=
name|get_unicode
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
argument_list|,
name|length
operator|-
name|off
argument_list|,
operator|&
name|sublen
argument_list|)
expr_stmt|;
name|off
operator|+=
name|sublen
operator|*
literal|2
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|sublen
operator|==
literal|0
condition|)
name|d
operator|->
name|caption
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|(
name|d
operator|->
name|style
operator|&
name|DS_SETFONT
operator|)
operator|==
literal|0
condition|)
block|{
name|d
operator|->
name|pointsize
operator|=
literal|0
expr_stmt|;
name|d
operator|->
name|font
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|ex
operator|!=
name|NULL
condition|)
block|{
name|d
operator|->
name|ex
operator|->
name|weight
operator|=
literal|0
expr_stmt|;
name|d
operator|->
name|ex
operator|->
name|italic
operator|=
literal|0
expr_stmt|;
name|d
operator|->
name|ex
operator|->
name|charset
operator|=
literal|1
expr_stmt|;
comment|/* Default charset.  */
block|}
block|}
else|else
block|{
if|if
condition|(
name|length
operator|<
name|off
operator|+
literal|2
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"dialog font point size"
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|->
name|pointsize
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|off
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|ex
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|length
operator|<
name|off
operator|+
literal|4
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"dialogex font information"
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|->
name|ex
operator|->
name|weight
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|d
operator|->
name|ex
operator|->
name|italic
operator|=
name|windres_get_8
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|d
operator|->
name|ex
operator|->
name|charset
operator|=
name|windres_get_8
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|3
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|off
operator|+=
literal|4
expr_stmt|;
block|}
name|d
operator|->
name|font
operator|=
name|get_unicode
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
argument_list|,
name|length
operator|-
name|off
argument_list|,
operator|&
name|sublen
argument_list|)
expr_stmt|;
name|off
operator|+=
name|sublen
operator|*
literal|2
operator|+
literal|2
expr_stmt|;
block|}
name|d
operator|->
name|controls
operator|=
name|NULL
expr_stmt|;
name|pp
operator|=
operator|&
name|d
operator|->
name|controls
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
condition|;
name|i
operator|++
control|)
block|{
name|rc_dialog_control
modifier|*
name|dc
decl_stmt|;
name|int
name|datalen
decl_stmt|;
name|off
operator|=
operator|(
name|off
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
name|dc
operator|=
operator|(
name|rc_dialog_control
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_dialog_control
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|ex
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|length
operator|<
name|off
operator|+
literal|8
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"dialog control"
argument_list|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|style
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dc
operator|->
name|exstyle
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dc
operator|->
name|help
operator|=
literal|0
expr_stmt|;
name|off
operator|+=
literal|8
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|length
operator|<
name|off
operator|+
literal|12
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"dialogex control"
argument_list|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|help
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dc
operator|->
name|exstyle
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|dc
operator|->
name|style
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|off
operator|+=
literal|12
expr_stmt|;
block|}
if|if
condition|(
name|length
operator|<
name|off
operator|+
operator|(
name|d
operator|->
name|ex
operator|!=
name|NULL
condition|?
literal|2
else|:
literal|0
operator|)
operator|+
literal|10
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"dialog control"
argument_list|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|x
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|dc
operator|->
name|y
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|dc
operator|->
name|width
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|dc
operator|->
name|height
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|6
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|->
name|ex
operator|!=
name|NULL
condition|)
name|dc
operator|->
name|id
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
else|else
name|dc
operator|->
name|id
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
operator|+
literal|8
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|off
operator|+=
literal|10
operator|+
operator|(
name|d
operator|->
name|ex
operator|!=
name|NULL
condition|?
literal|2
else|:
literal|0
operator|)
expr_stmt|;
name|sublen
operator|=
name|get_resid
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|dc
operator|->
name|class
argument_list|,
name|data
operator|+
name|off
argument_list|,
name|length
operator|-
name|off
argument_list|)
expr_stmt|;
name|off
operator|+=
name|sublen
expr_stmt|;
name|sublen
operator|=
name|get_resid
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|dc
operator|->
name|text
argument_list|,
name|data
operator|+
name|off
argument_list|,
name|length
operator|-
name|off
argument_list|)
expr_stmt|;
name|off
operator|+=
name|sublen
expr_stmt|;
if|if
condition|(
name|length
operator|<
name|off
operator|+
literal|2
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"dialog control end"
argument_list|)
argument_list|)
expr_stmt|;
name|datalen
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
name|off
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|off
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|datalen
operator|==
literal|0
condition|)
name|dc
operator|->
name|data
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|off
operator|=
operator|(
name|off
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
if|if
condition|(
name|length
operator|<
name|off
operator|+
name|datalen
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"dialog control data"
argument_list|)
argument_list|)
expr_stmt|;
name|dc
operator|->
name|data
operator|=
operator|(
operator|(
name|rc_rcdata_item
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_rcdata_item
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|dc
operator|->
name|data
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|dc
operator|->
name|data
operator|->
name|type
operator|=
name|RCDATA_BUFFER
expr_stmt|;
name|dc
operator|->
name|data
operator|->
name|u
operator|.
name|buffer
operator|.
name|length
operator|=
name|datalen
expr_stmt|;
name|dc
operator|->
name|data
operator|->
name|u
operator|.
name|buffer
operator|.
name|data
operator|=
name|data
operator|+
name|off
expr_stmt|;
name|off
operator|+=
name|datalen
expr_stmt|;
block|}
name|dc
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
operator|*
name|pp
operator|=
name|dc
expr_stmt|;
name|pp
operator|=
operator|&
name|dc
operator|->
name|next
expr_stmt|;
block|}
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_DIALOG
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|dialog
operator|=
name|d
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Convert a stringtable resource from binary.  */
end_comment

begin_function
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_string
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_stringtable
modifier|*
name|st
decl_stmt|;
name|int
name|i
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
name|st
operator|=
operator|(
name|rc_stringtable
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_stringtable
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|unsigned
name|int
name|slen
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|2
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"stringtable string length"
argument_list|)
argument_list|)
expr_stmt|;
name|slen
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|st
operator|->
name|strings
index|[
name|i
index|]
operator|.
name|length
operator|=
name|slen
expr_stmt|;
if|if
condition|(
name|slen
operator|>
literal|0
condition|)
block|{
name|unichar
modifier|*
name|s
decl_stmt|;
name|unsigned
name|int
name|j
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|2
operator|+
literal|2
operator|*
name|slen
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"stringtable string"
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|=
operator|(
name|unichar
operator|*
operator|)
name|res_alloc
argument_list|(
name|slen
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
name|st
operator|->
name|strings
index|[
name|i
index|]
operator|.
name|string
operator|=
name|s
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|slen
condition|;
name|j
operator|++
control|)
name|s
index|[
name|j
index|]
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
operator|+
name|j
operator|*
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
name|data
operator|+=
literal|2
operator|+
literal|2
operator|*
name|slen
expr_stmt|;
name|length
operator|-=
literal|2
operator|+
literal|2
operator|*
name|slen
expr_stmt|;
block|}
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_STRINGTABLE
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|stringtable
operator|=
name|st
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Convert a fontdir resource from binary.  */
end_comment

begin_function
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_fontdir
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_uint_type
name|c
decl_stmt|,
name|i
decl_stmt|;
name|rc_fontdir
modifier|*
name|first
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|2
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"fontdir header"
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|first
operator|=
name|NULL
expr_stmt|;
name|pp
operator|=
operator|&
name|first
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|struct
name|bin_fontdir_item
modifier|*
name|bfi
decl_stmt|;
name|rc_fontdir
modifier|*
name|fd
decl_stmt|;
name|unsigned
name|int
name|off
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|56
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"fontdir"
argument_list|)
argument_list|)
expr_stmt|;
name|bfi
operator|=
operator|(
specifier|const
expr|struct
name|bin_fontdir_item
operator|*
operator|)
name|data
expr_stmt|;
name|fd
operator|=
operator|(
name|rc_fontdir
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|fd
argument_list|)
expr_stmt|;
name|fd
operator|->
name|index
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|bfi
operator|->
name|index
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* To work out the length of the fontdir data, we must get the          length of the device name and face name strings, even though          we don't store them in the rc_fontdir.  The          documentation says that these are NULL terminated char          strings, not Unicode strings.  */
name|off
operator|=
literal|56
expr_stmt|;
while|while
condition|(
name|off
operator|<
name|length
operator|&&
name|data
index|[
name|off
index|]
operator|!=
literal|'\0'
condition|)
operator|++
name|off
expr_stmt|;
if|if
condition|(
name|off
operator|>=
name|length
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"fontdir device name"
argument_list|)
argument_list|)
expr_stmt|;
operator|++
name|off
expr_stmt|;
while|while
condition|(
name|off
operator|<
name|length
operator|&&
name|data
index|[
name|off
index|]
operator|!=
literal|'\0'
condition|)
operator|++
name|off
expr_stmt|;
if|if
condition|(
name|off
operator|>=
name|length
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"fontdir face name"
argument_list|)
argument_list|)
expr_stmt|;
operator|++
name|off
expr_stmt|;
name|fd
operator|->
name|length
operator|=
name|off
expr_stmt|;
name|fd
operator|->
name|data
operator|=
name|data
expr_stmt|;
name|fd
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
operator|*
name|pp
operator|=
name|fd
expr_stmt|;
name|pp
operator|=
operator|&
name|fd
operator|->
name|next
expr_stmt|;
comment|/* The documentation does not indicate that any rounding is          required.  */
name|data
operator|+=
name|off
expr_stmt|;
name|length
operator|-=
name|off
expr_stmt|;
block|}
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_FONTDIR
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|fontdir
operator|=
name|first
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Convert an accelerators resource from binary.  */
end_comment

begin_function
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_accelerators
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_accelerator
modifier|*
name|first
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
name|first
operator|=
name|NULL
expr_stmt|;
name|pp
operator|=
operator|&
name|first
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|rc_accelerator
modifier|*
name|a
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|8
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"accelerator"
argument_list|)
argument_list|)
expr_stmt|;
name|a
operator|=
operator|(
name|rc_accelerator
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_accelerator
argument_list|)
argument_list|)
expr_stmt|;
name|a
operator|->
name|flags
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|a
operator|->
name|key
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|a
operator|->
name|id
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|a
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
operator|*
name|pp
operator|=
name|a
expr_stmt|;
name|pp
operator|=
operator|&
name|a
operator|->
name|next
expr_stmt|;
if|if
condition|(
operator|(
name|a
operator|->
name|flags
operator|&
name|ACC_LAST
operator|)
operator|!=
literal|0
condition|)
break|break;
name|data
operator|+=
literal|8
expr_stmt|;
name|length
operator|-=
literal|8
expr_stmt|;
block|}
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_res_resource
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_ACCELERATOR
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|acc
operator|=
name|first
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Convert an rcdata resource from binary.  */
end_comment

begin_function
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_rcdata
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|,
name|int
name|rctyp
parameter_list|)
block|{
name|rc_rcdata_item
modifier|*
name|ri
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
name|ri
operator|=
operator|(
name|rc_rcdata_item
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_rcdata_item
argument_list|)
argument_list|)
expr_stmt|;
name|ri
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|ri
operator|->
name|type
operator|=
name|RCDATA_BUFFER
expr_stmt|;
name|ri
operator|->
name|u
operator|.
name|buffer
operator|.
name|length
operator|=
name|length
expr_stmt|;
name|ri
operator|->
name|u
operator|.
name|buffer
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|rctyp
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|rcdata
operator|=
name|ri
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Convert a group cursor resource from binary.  */
end_comment

begin_function
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_group_cursor
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|int
name|type
decl_stmt|,
name|c
decl_stmt|,
name|i
decl_stmt|;
name|rc_group_cursor
modifier|*
name|first
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|6
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"group cursor header"
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
literal|2
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected group cursor type %d"
argument_list|)
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|c
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|6
expr_stmt|;
name|length
operator|-=
literal|6
expr_stmt|;
name|first
operator|=
name|NULL
expr_stmt|;
name|pp
operator|=
operator|&
name|first
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
condition|;
name|i
operator|++
control|)
block|{
name|rc_group_cursor
modifier|*
name|gc
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|14
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"group cursor"
argument_list|)
argument_list|)
expr_stmt|;
name|gc
operator|=
operator|(
name|rc_group_cursor
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|gc
argument_list|)
expr_stmt|;
name|gc
operator|->
name|width
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gc
operator|->
name|height
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gc
operator|->
name|planes
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gc
operator|->
name|bits
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|6
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gc
operator|->
name|bytes
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gc
operator|->
name|index
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|12
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gc
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
operator|*
name|pp
operator|=
name|gc
expr_stmt|;
name|pp
operator|=
operator|&
name|gc
operator|->
name|next
expr_stmt|;
name|data
operator|+=
literal|14
expr_stmt|;
name|length
operator|-=
literal|14
expr_stmt|;
block|}
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_res_resource
argument_list|)
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_GROUP_CURSOR
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|group_cursor
operator|=
name|first
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Convert a group icon resource from binary.  */
end_comment

begin_function
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_group_icon
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|int
name|type
decl_stmt|,
name|c
decl_stmt|,
name|i
decl_stmt|;
name|rc_group_icon
modifier|*
name|first
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|6
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"group icon header"
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
literal|1
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected group icon type %d"
argument_list|)
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|c
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|6
expr_stmt|;
name|length
operator|-=
literal|6
expr_stmt|;
name|first
operator|=
name|NULL
expr_stmt|;
name|pp
operator|=
operator|&
name|first
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|c
condition|;
name|i
operator|++
control|)
block|{
name|rc_group_icon
modifier|*
name|gi
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|14
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"group icon"
argument_list|)
argument_list|)
expr_stmt|;
name|gi
operator|=
operator|(
name|rc_group_icon
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_group_icon
argument_list|)
argument_list|)
expr_stmt|;
name|gi
operator|->
name|width
operator|=
name|windres_get_8
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gi
operator|->
name|height
operator|=
name|windres_get_8
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gi
operator|->
name|colors
operator|=
name|windres_get_8
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|gi
operator|->
name|planes
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gi
operator|->
name|bits
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|6
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gi
operator|->
name|bytes
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|gi
operator|->
name|index
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|12
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|gi
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
operator|*
name|pp
operator|=
name|gi
expr_stmt|;
name|pp
operator|=
operator|&
name|gi
operator|->
name|next
expr_stmt|;
name|data
operator|+=
literal|14
expr_stmt|;
name|length
operator|-=
literal|14
expr_stmt|;
block|}
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_GROUP_ICON
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|group_icon
operator|=
name|first
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Extract data from a version header.  If KEY is not NULL, then the    key must be KEY; otherwise, the key is returned in *PKEY.  This    sets *LEN to the total length, *VALLEN to the value length, *TYPE    to the type, and *OFF to the offset to the children.  */
end_comment

begin_function
specifier|static
name|void
name|get_version_header
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|,
name|unichar
modifier|*
modifier|*
name|pkey
parameter_list|,
name|rc_uint_type
modifier|*
name|len
parameter_list|,
name|rc_uint_type
modifier|*
name|vallen
parameter_list|,
name|rc_uint_type
modifier|*
name|type
parameter_list|,
name|rc_uint_type
modifier|*
name|off
parameter_list|)
block|{
if|if
condition|(
name|length
operator|<
literal|8
condition|)
name|toosmall
argument_list|(
name|key
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|*
name|vallen
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|*
name|type
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|*
name|off
operator|=
literal|6
expr_stmt|;
name|length
operator|-=
literal|6
expr_stmt|;
name|data
operator|+=
literal|6
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
block|{
name|rc_uint_type
name|sublen
decl_stmt|;
operator|*
name|pkey
operator|=
name|get_unicode
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
operator|&
name|sublen
argument_list|)
expr_stmt|;
operator|*
name|off
operator|+=
operator|(
name|sublen
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
expr_stmt|;
block|}
else|else
block|{
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|length
operator|<
literal|2
condition|)
name|toosmall
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
operator|!=
operator|(
name|bfd_byte
operator|)
operator|*
name|key
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected version string"
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|off
operator|+=
literal|2
expr_stmt|;
name|length
operator|-=
literal|2
expr_stmt|;
name|data
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|*
name|key
operator|==
literal|'\0'
condition|)
break|break;
operator|++
name|key
expr_stmt|;
block|}
block|}
operator|*
name|off
operator|=
operator|(
operator|*
name|off
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Convert a version resource from binary.  */
end_comment

begin_function
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_version
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_uint_type
name|verlen
decl_stmt|,
name|vallen
decl_stmt|,
name|type
decl_stmt|,
name|off
decl_stmt|;
name|rc_fixed_versioninfo
modifier|*
name|fi
decl_stmt|;
name|rc_ver_info
modifier|*
name|first
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
name|rc_versioninfo
modifier|*
name|v
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
name|get_version_header
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
literal|"VS_VERSION_INFO"
argument_list|,
operator|(
name|unichar
operator|*
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|verlen
argument_list|,
operator|&
name|vallen
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|off
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|unsigned
name|int
operator|)
name|verlen
operator|!=
name|length
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"version length %d does not match resource length %lu"
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|verlen
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected version type %d"
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|type
argument_list|)
expr_stmt|;
name|data
operator|+=
name|off
expr_stmt|;
name|length
operator|-=
name|off
expr_stmt|;
if|if
condition|(
name|vallen
operator|==
literal|0
condition|)
name|fi
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|unsigned
name|long
name|signature
decl_stmt|,
name|fiv
decl_stmt|;
if|if
condition|(
name|vallen
operator|!=
literal|52
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected fixed version information length %ld"
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|vallen
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|52
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"fixed version info"
argument_list|)
argument_list|)
expr_stmt|;
name|signature
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|signature
operator|!=
literal|0xfeef04bd
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected fixed version signature %lu"
argument_list|)
argument_list|,
name|signature
argument_list|)
expr_stmt|;
name|fiv
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|fiv
operator|!=
literal|0
operator|&&
name|fiv
operator|!=
literal|0x10000
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected fixed version info version %lu"
argument_list|)
argument_list|,
name|fiv
argument_list|)
expr_stmt|;
name|fi
operator|=
operator|(
name|rc_fixed_versioninfo
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_fixed_versioninfo
argument_list|)
argument_list|)
expr_stmt|;
name|fi
operator|->
name|file_version_ms
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fi
operator|->
name|file_version_ls
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|12
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fi
operator|->
name|product_version_ms
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|16
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fi
operator|->
name|product_version_ls
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|20
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fi
operator|->
name|file_flags_mask
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|24
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fi
operator|->
name|file_flags
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|28
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fi
operator|->
name|file_os
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|32
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fi
operator|->
name|file_type
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|36
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fi
operator|->
name|file_subtype
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|40
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fi
operator|->
name|file_date_ms
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|44
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|fi
operator|->
name|file_date_ls
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|48
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|data
operator|+=
literal|52
expr_stmt|;
name|length
operator|-=
literal|52
expr_stmt|;
block|}
name|first
operator|=
name|NULL
expr_stmt|;
name|pp
operator|=
operator|&
name|first
expr_stmt|;
while|while
condition|(
name|length
operator|>
literal|0
condition|)
block|{
name|rc_ver_info
modifier|*
name|vi
decl_stmt|;
name|int
name|ch
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|8
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"version var info"
argument_list|)
argument_list|)
expr_stmt|;
name|vi
operator|=
operator|(
name|rc_ver_info
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_ver_info
argument_list|)
argument_list|)
expr_stmt|;
name|ch
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|6
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|'S'
condition|)
block|{
name|rc_ver_stringinfo
modifier|*
modifier|*
name|ppvs
decl_stmt|;
name|vi
operator|->
name|type
operator|=
name|VERINFO_STRING
expr_stmt|;
name|get_version_header
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
literal|"StringFileInfo"
argument_list|,
operator|(
name|unichar
operator|*
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|verlen
argument_list|,
operator|&
name|vallen
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|off
argument_list|)
expr_stmt|;
if|if
condition|(
name|vallen
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected stringfileinfo value length %ld"
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|vallen
argument_list|)
expr_stmt|;
name|data
operator|+=
name|off
expr_stmt|;
name|length
operator|-=
name|off
expr_stmt|;
name|get_version_header
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|vi
operator|->
name|u
operator|.
name|string
operator|.
name|language
argument_list|,
operator|&
name|verlen
argument_list|,
operator|&
name|vallen
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|off
argument_list|)
expr_stmt|;
if|if
condition|(
name|vallen
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected version stringtable value length %ld"
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|vallen
argument_list|)
expr_stmt|;
name|data
operator|+=
name|off
expr_stmt|;
name|length
operator|-=
name|off
expr_stmt|;
name|verlen
operator|-=
name|off
expr_stmt|;
name|vi
operator|->
name|u
operator|.
name|string
operator|.
name|strings
operator|=
name|NULL
expr_stmt|;
name|ppvs
operator|=
operator|&
name|vi
operator|->
name|u
operator|.
name|string
operator|.
name|strings
expr_stmt|;
comment|/* It's convenient to round verlen to a 4 byte alignment,              since we round the subvariables in the loop.  */
name|verlen
operator|=
operator|(
name|verlen
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
while|while
condition|(
name|verlen
operator|>
literal|0
condition|)
block|{
name|rc_ver_stringinfo
modifier|*
name|vs
decl_stmt|;
name|rc_uint_type
name|subverlen
decl_stmt|,
name|vslen
decl_stmt|,
name|valoff
decl_stmt|;
name|vs
operator|=
operator|(
name|rc_ver_stringinfo
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|vs
argument_list|)
expr_stmt|;
name|get_version_header
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|vs
operator|->
name|key
argument_list|,
operator|&
name|subverlen
argument_list|,
operator|&
name|vallen
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|off
argument_list|)
expr_stmt|;
name|subverlen
operator|=
operator|(
name|subverlen
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
name|data
operator|+=
name|off
expr_stmt|;
name|length
operator|-=
name|off
expr_stmt|;
name|vs
operator|->
name|value
operator|=
name|get_unicode
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
operator|&
name|vslen
argument_list|)
expr_stmt|;
name|valoff
operator|=
name|vslen
operator|*
literal|2
operator|+
literal|2
expr_stmt|;
name|valoff
operator|=
operator|(
name|valoff
operator|+
literal|3
operator|)
operator|&
operator|~
literal|3
expr_stmt|;
if|if
condition|(
name|off
operator|+
name|valoff
operator|!=
name|subverlen
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected version string length %ld != %ld + %ld"
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|subverlen
argument_list|,
operator|(
name|long
operator|)
name|off
argument_list|,
operator|(
name|long
operator|)
name|valoff
argument_list|)
expr_stmt|;
name|vs
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
operator|*
name|ppvs
operator|=
name|vs
expr_stmt|;
name|ppvs
operator|=
operator|&
name|vs
operator|->
name|next
expr_stmt|;
name|data
operator|+=
name|valoff
expr_stmt|;
name|length
operator|-=
name|valoff
expr_stmt|;
if|if
condition|(
name|verlen
operator|<
name|subverlen
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected version string length %ld< %ld"
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|verlen
argument_list|,
operator|(
name|long
operator|)
name|subverlen
argument_list|)
expr_stmt|;
name|verlen
operator|-=
name|subverlen
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'V'
condition|)
block|{
name|rc_ver_varinfo
modifier|*
modifier|*
name|ppvv
decl_stmt|;
name|vi
operator|->
name|type
operator|=
name|VERINFO_VAR
expr_stmt|;
name|get_version_header
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
literal|"VarFileInfo"
argument_list|,
operator|(
name|unichar
operator|*
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|verlen
argument_list|,
operator|&
name|vallen
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|off
argument_list|)
expr_stmt|;
if|if
condition|(
name|vallen
operator|!=
literal|0
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected varfileinfo value length %ld"
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|vallen
argument_list|)
expr_stmt|;
name|data
operator|+=
name|off
expr_stmt|;
name|length
operator|-=
name|off
expr_stmt|;
name|get_version_header
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|length
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|&
name|vi
operator|->
name|u
operator|.
name|var
operator|.
name|key
argument_list|,
operator|&
name|verlen
argument_list|,
operator|&
name|vallen
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|off
argument_list|)
expr_stmt|;
name|data
operator|+=
name|off
expr_stmt|;
name|length
operator|-=
name|off
expr_stmt|;
name|vi
operator|->
name|u
operator|.
name|var
operator|.
name|var
operator|=
name|NULL
expr_stmt|;
name|ppvv
operator|=
operator|&
name|vi
operator|->
name|u
operator|.
name|var
operator|.
name|var
expr_stmt|;
while|while
condition|(
name|vallen
operator|>
literal|0
condition|)
block|{
name|rc_ver_varinfo
modifier|*
name|vv
decl_stmt|;
if|if
condition|(
name|length
operator|<
literal|4
condition|)
name|toosmall
argument_list|(
name|_
argument_list|(
literal|"version varfileinfo"
argument_list|)
argument_list|)
expr_stmt|;
name|vv
operator|=
operator|(
name|rc_ver_varinfo
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_ver_varinfo
argument_list|)
argument_list|)
expr_stmt|;
name|vv
operator|->
name|language
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|vv
operator|->
name|charset
operator|=
name|windres_get_16
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|vv
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
operator|*
name|ppvv
operator|=
name|vv
expr_stmt|;
name|ppvv
operator|=
operator|&
name|vv
operator|->
name|next
expr_stmt|;
name|data
operator|+=
literal|4
expr_stmt|;
name|length
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|vallen
operator|<
literal|4
condition|)
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected version value length %ld"
argument_list|)
argument_list|,
operator|(
name|long
operator|)
name|vallen
argument_list|)
expr_stmt|;
name|vallen
operator|-=
literal|4
expr_stmt|;
block|}
block|}
else|else
name|fatal
argument_list|(
name|_
argument_list|(
literal|"unexpected version string"
argument_list|)
argument_list|)
expr_stmt|;
name|vi
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
operator|*
name|pp
operator|=
name|vi
expr_stmt|;
name|pp
operator|=
operator|&
name|vi
operator|->
name|next
expr_stmt|;
block|}
name|v
operator|=
operator|(
name|rc_versioninfo
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_versioninfo
argument_list|)
argument_list|)
expr_stmt|;
name|v
operator|->
name|fixed
operator|=
name|fi
expr_stmt|;
name|v
operator|->
name|var
operator|=
name|first
expr_stmt|;
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_VERSIONINFO
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|versioninfo
operator|=
name|v
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Convert an arbitrary user defined resource from binary.  */
end_comment

begin_function
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_userdata
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
name|ATTRIBUTE_UNUSED
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_rcdata_item
modifier|*
name|ri
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
name|ri
operator|=
operator|(
name|rc_rcdata_item
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_rcdata_item
argument_list|)
argument_list|)
expr_stmt|;
name|ri
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|ri
operator|->
name|type
operator|=
name|RCDATA_BUFFER
expr_stmt|;
name|ri
operator|->
name|u
operator|.
name|buffer
operator|.
name|length
operator|=
name|length
expr_stmt|;
name|ri
operator|->
name|u
operator|.
name|buffer
operator|.
name|data
operator|=
name|data
expr_stmt|;
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_USERDATA
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|rcdata
operator|=
name|ri
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_escape
end_escape

begin_function
specifier|static
name|rc_res_resource
modifier|*
name|bin_to_res_toolbar
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
name|rc_toolbar
modifier|*
name|ri
decl_stmt|;
name|rc_res_resource
modifier|*
name|r
decl_stmt|;
name|rc_uint_type
name|i
decl_stmt|;
name|ri
operator|=
operator|(
name|rc_toolbar
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_toolbar
argument_list|)
argument_list|)
expr_stmt|;
name|ri
operator|->
name|button_width
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ri
operator|->
name|button_height
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ri
operator|->
name|nitems
operator|=
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
operator|+
literal|8
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ri
operator|->
name|items
operator|=
name|NULL
expr_stmt|;
name|data
operator|+=
literal|12
expr_stmt|;
name|length
operator|-=
literal|12
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ri
operator|->
name|nitems
condition|;
name|i
operator|++
control|)
block|{
name|rc_toolbar_item
modifier|*
name|it
decl_stmt|;
name|it
operator|=
operator|(
name|rc_toolbar_item
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
argument_list|(
name|rc_toolbar_item
argument_list|)
argument_list|)
expr_stmt|;
name|it
operator|->
name|id
operator|.
name|named
operator|=
literal|0
expr_stmt|;
name|it
operator|->
name|id
operator|.
name|u
operator|.
name|id
operator|=
operator|(
name|int
operator|)
name|windres_get_32
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|it
operator|->
name|prev
operator|=
name|it
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|data
operator|+=
literal|4
expr_stmt|;
name|length
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|ri
operator|->
name|items
condition|)
block|{
name|rc_toolbar_item
modifier|*
name|ii
init|=
name|ri
operator|->
name|items
decl_stmt|;
while|while
condition|(
name|ii
operator|->
name|next
operator|!=
name|NULL
condition|)
name|ii
operator|=
name|ii
operator|->
name|next
expr_stmt|;
name|it
operator|->
name|prev
operator|=
name|ii
expr_stmt|;
name|ii
operator|->
name|next
operator|=
name|it
expr_stmt|;
block|}
else|else
name|ri
operator|->
name|items
operator|=
name|it
expr_stmt|;
block|}
name|r
operator|=
operator|(
name|rc_res_resource
operator|*
operator|)
name|res_alloc
argument_list|(
sizeof|sizeof
expr|*
name|r
argument_list|)
expr_stmt|;
name|r
operator|->
name|type
operator|=
name|RES_TYPE_TOOLBAR
expr_stmt|;
name|r
operator|->
name|u
operator|.
name|toolbar
operator|=
name|ri
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_comment
comment|/* Local functions used to convert resources to binary format.  */
end_comment

begin_function_decl
specifier|static
name|rc_uint_type
name|resid_to_bin
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
name|rc_res_id
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|unicode_to_bin
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|unichar
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_accelerator
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_accelerator
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_cursor
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_cursor
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_group_cursor
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_group_cursor
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_dialog
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_dialog
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_fontdir
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_fontdir
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_group_icon
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_group_icon
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_menu
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_menu
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_menuitems
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_menuitem
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_menuexitems
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_menuitem
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_rcdata
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_rcdata_item
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_stringtable
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_stringtable
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|string_to_unicode_bin
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_toolbar
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
name|rc_toolbar
modifier|*
name|tb
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_versioninfo
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|rc_versioninfo
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|res_to_bin_generic
parameter_list|(
name|windres_bfd
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|,
name|rc_uint_type
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Convert a resource to binary.  */
end_comment

begin_function
name|rc_uint_type
name|res_to_bin
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_res_resource
modifier|*
name|res
parameter_list|)
block|{
switch|switch
condition|(
name|res
operator|->
name|type
condition|)
block|{
case|case
name|RES_TYPE_BITMAP
case|:
case|case
name|RES_TYPE_FONT
case|:
case|case
name|RES_TYPE_ICON
case|:
case|case
name|RES_TYPE_MESSAGETABLE
case|:
return|return
name|res_to_bin_generic
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|data
operator|.
name|length
argument_list|,
name|res
operator|->
name|u
operator|.
name|data
operator|.
name|data
argument_list|)
return|;
case|case
name|RES_TYPE_ACCELERATOR
case|:
return|return
name|res_to_bin_accelerator
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|acc
argument_list|)
return|;
case|case
name|RES_TYPE_CURSOR
case|:
return|return
name|res_to_bin_cursor
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|cursor
argument_list|)
return|;
case|case
name|RES_TYPE_GROUP_CURSOR
case|:
return|return
name|res_to_bin_group_cursor
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|group_cursor
argument_list|)
return|;
case|case
name|RES_TYPE_DIALOG
case|:
return|return
name|res_to_bin_dialog
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|dialog
argument_list|)
return|;
case|case
name|RES_TYPE_FONTDIR
case|:
return|return
name|res_to_bin_fontdir
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|fontdir
argument_list|)
return|;
case|case
name|RES_TYPE_GROUP_ICON
case|:
return|return
name|res_to_bin_group_icon
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|group_icon
argument_list|)
return|;
case|case
name|RES_TYPE_MENU
case|:
return|return
name|res_to_bin_menu
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|menu
argument_list|)
return|;
case|case
name|RES_TYPE_STRINGTABLE
case|:
return|return
name|res_to_bin_stringtable
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|stringtable
argument_list|)
return|;
case|case
name|RES_TYPE_VERSIONINFO
case|:
return|return
name|res_to_bin_versioninfo
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|versioninfo
argument_list|)
return|;
case|case
name|RES_TYPE_TOOLBAR
case|:
return|return
name|res_to_bin_toolbar
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|toolbar
argument_list|)
return|;
case|case
name|RES_TYPE_USERDATA
case|:
case|case
name|RES_TYPE_RCDATA
case|:
default|default:
return|return
name|res_to_bin_rcdata
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|res
operator|->
name|u
operator|.
name|rcdata
argument_list|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* Convert a resource ID to binary.  This always returns exactly one    bindata structure.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|resid_to_bin
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
name|rc_res_id
name|id
parameter_list|)
block|{
if|if
condition|(
operator|!
name|id
operator|.
name|named
condition|)
block|{
if|if
condition|(
name|wrbfd
condition|)
block|{
name|struct
name|bin_res_id
name|bri
decl_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bri
operator|.
name|sig
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bri
operator|.
name|id
argument_list|,
name|id
operator|.
name|u
operator|.
name|id
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bri
argument_list|,
name|off
argument_list|,
name|BIN_RES_ID
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
name|BIN_RES_ID
expr_stmt|;
block|}
else|else
block|{
name|rc_uint_type
name|len
init|=
operator|(
name|id
operator|.
name|u
operator|.
name|n
operator|.
name|name
condition|?
name|unichar_len
argument_list|(
name|id
operator|.
name|u
operator|.
name|n
operator|.
name|name
argument_list|)
else|:
literal|0
operator|)
decl_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
name|bfd_byte
modifier|*
name|d
init|=
operator|(
name|bfd_byte
operator|*
operator|)
name|reswr_alloc
argument_list|(
operator|(
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
decl_stmt|;
name|rc_uint_type
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|d
operator|+
operator|(
name|i
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
operator|)
argument_list|,
name|id
operator|.
name|u
operator|.
name|n
operator|.
name|name
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|d
operator|+
operator|(
name|len
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|d
argument_list|,
name|off
argument_list|,
operator|(
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
call|(
name|rc_uint_type
call|)
argument_list|(
operator|(
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert a null terminated unicode string to binary.  This always    returns exactly one bindata structure.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|unicode_to_bin
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|unichar
modifier|*
name|str
parameter_list|)
block|{
name|rc_uint_type
name|len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|str
operator|!=
name|NULL
condition|)
name|len
operator|=
name|unichar_len
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
name|bfd_byte
modifier|*
name|d
decl_stmt|;
name|rc_uint_type
name|i
decl_stmt|;
name|d
operator|=
operator|(
name|bfd_byte
operator|*
operator|)
name|reswr_alloc
argument_list|(
operator|(
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|d
operator|+
operator|(
name|i
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
operator|)
argument_list|,
name|str
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|d
operator|+
operator|(
name|len
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
operator|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|d
argument_list|,
name|off
argument_list|,
operator|(
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
call|(
name|rc_uint_type
call|)
argument_list|(
operator|(
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert an accelerator resource to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_accelerator
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_accelerator
modifier|*
name|accelerators
parameter_list|)
block|{
name|bindata
modifier|*
name|first
decl_stmt|,
modifier|*
modifier|*
name|pp
decl_stmt|;
specifier|const
name|rc_accelerator
modifier|*
name|a
decl_stmt|;
name|first
operator|=
name|NULL
expr_stmt|;
name|pp
operator|=
operator|&
name|first
expr_stmt|;
for|for
control|(
name|a
operator|=
name|accelerators
init|;
name|a
operator|!=
name|NULL
condition|;
name|a
operator|=
name|a
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wrbfd
condition|)
block|{
name|struct
name|bin_accelerator
name|ba
decl_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|ba
operator|.
name|flags
argument_list|,
name|a
operator|->
name|flags
operator||
operator|(
name|a
operator|->
name|next
operator|!=
name|NULL
condition|?
literal|0
else|:
name|ACC_LAST
operator|)
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|ba
operator|.
name|key
argument_list|,
name|a
operator|->
name|key
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|ba
operator|.
name|id
argument_list|,
name|a
operator|->
name|id
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|ba
operator|.
name|pad
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|ba
argument_list|,
name|off
argument_list|,
name|BIN_ACCELERATOR_SIZE
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
name|BIN_ACCELERATOR_SIZE
expr_stmt|;
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert a cursor resource to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_cursor
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_cursor
modifier|*
name|c
parameter_list|)
block|{
if|if
condition|(
name|wrbfd
condition|)
block|{
name|struct
name|bin_cursor
name|bc
decl_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bc
operator|.
name|xhotspot
argument_list|,
name|c
operator|->
name|xhotspot
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bc
operator|.
name|yhotspot
argument_list|,
name|c
operator|->
name|yhotspot
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bc
argument_list|,
name|off
argument_list|,
name|BIN_CURSOR_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|length
condition|)
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|c
operator|->
name|data
argument_list|,
name|off
operator|+
name|BIN_CURSOR_SIZE
argument_list|,
name|c
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|off
operator|=
operator|(
name|off
operator|+
name|BIN_CURSOR_SIZE
operator|+
operator|(
name|rc_uint_type
operator|)
name|c
operator|->
name|length
operator|)
expr_stmt|;
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert a group cursor resource to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_group_cursor
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_group_cursor
modifier|*
name|group_cursors
parameter_list|)
block|{
name|int
name|c
init|=
literal|0
decl_stmt|;
specifier|const
name|rc_group_cursor
modifier|*
name|gc
decl_stmt|;
name|struct
name|bin_group_cursor
name|bgc
decl_stmt|;
name|struct
name|bin_group_cursor_item
name|bgci
decl_stmt|;
name|rc_uint_type
name|start
init|=
name|off
decl_stmt|;
name|off
operator|+=
name|BIN_GROUP_CURSOR_SIZE
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
operator|,
name|gc
operator|=
name|group_cursors
init|;
name|gc
operator|!=
name|NULL
condition|;
name|gc
operator|=
name|gc
operator|->
name|next
operator|,
name|c
operator|++
control|)
block|{
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgci
operator|.
name|width
argument_list|,
name|gc
operator|->
name|width
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgci
operator|.
name|height
argument_list|,
name|gc
operator|->
name|height
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgci
operator|.
name|planes
argument_list|,
name|gc
operator|->
name|planes
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgci
operator|.
name|bits
argument_list|,
name|gc
operator|->
name|bits
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bgci
operator|.
name|bytes
argument_list|,
name|gc
operator|->
name|bytes
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgci
operator|.
name|index
argument_list|,
name|gc
operator|->
name|index
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bgci
argument_list|,
name|off
argument_list|,
name|BIN_GROUP_CURSOR_ITEM_SIZE
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
name|BIN_GROUP_CURSOR_ITEM_SIZE
expr_stmt|;
block|}
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgc
operator|.
name|sig1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgc
operator|.
name|sig2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgc
operator|.
name|nitems
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bgc
argument_list|,
name|start
argument_list|,
name|BIN_GROUP_CURSOR_SIZE
argument_list|)
expr_stmt|;
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert a dialog resource to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_dialog
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_dialog
modifier|*
name|dialog
parameter_list|)
block|{
name|rc_uint_type
name|off_delta
decl_stmt|;
name|rc_uint_type
name|start
decl_stmt|,
name|marker
decl_stmt|;
name|int
name|dialogex
decl_stmt|;
name|int
name|c
decl_stmt|;
name|rc_dialog_control
modifier|*
name|dc
decl_stmt|;
name|struct
name|bin_dialogex
name|bdx
decl_stmt|;
name|struct
name|bin_dialog
name|bd
decl_stmt|;
name|off_delta
operator|=
name|off
expr_stmt|;
name|start
operator|=
name|off
expr_stmt|;
name|dialogex
operator|=
name|extended_dialog
argument_list|(
name|dialog
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
if|if
condition|(
operator|!
name|dialogex
condition|)
block|{
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bd
operator|.
name|style
argument_list|,
name|dialog
operator|->
name|style
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bd
operator|.
name|exstyle
argument_list|,
name|dialog
operator|->
name|exstyle
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bd
operator|.
name|x
argument_list|,
name|dialog
operator|->
name|x
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bd
operator|.
name|y
argument_list|,
name|dialog
operator|->
name|y
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bd
operator|.
name|width
argument_list|,
name|dialog
operator|->
name|width
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bd
operator|.
name|height
argument_list|,
name|dialog
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdx
operator|.
name|sig1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdx
operator|.
name|sig2
argument_list|,
literal|0xffff
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bdx
operator|.
name|help
argument_list|,
operator|(
name|dialog
operator|->
name|ex
condition|?
name|dialog
operator|->
name|ex
operator|->
name|help
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bdx
operator|.
name|exstyle
argument_list|,
name|dialog
operator|->
name|exstyle
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bdx
operator|.
name|style
argument_list|,
name|dialog
operator|->
name|style
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdx
operator|.
name|x
argument_list|,
name|dialog
operator|->
name|x
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdx
operator|.
name|y
argument_list|,
name|dialog
operator|->
name|y
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdx
operator|.
name|width
argument_list|,
name|dialog
operator|->
name|width
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdx
operator|.
name|height
argument_list|,
name|dialog
operator|->
name|height
argument_list|)
expr_stmt|;
block|}
block|}
name|off
operator|+=
operator|(
name|dialogex
operator|!=
literal|0
condition|?
name|BIN_DIALOGEX_SIZE
else|:
name|BIN_DIALOG_SIZE
operator|)
expr_stmt|;
name|off
operator|=
name|resid_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|dialog
operator|->
name|menu
argument_list|)
expr_stmt|;
name|off
operator|=
name|resid_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|dialog
operator|->
name|class
argument_list|)
expr_stmt|;
name|off
operator|=
name|unicode_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|dialog
operator|->
name|caption
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dialog
operator|->
name|style
operator|&
name|DS_SETFONT
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|wrbfd
condition|)
block|{
if|if
condition|(
operator|!
name|dialogex
condition|)
block|{
name|struct
name|bin_dialogfont
name|bdf
decl_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdf
operator|.
name|pointsize
argument_list|,
name|dialog
operator|->
name|pointsize
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bdf
argument_list|,
name|off
argument_list|,
name|BIN_DIALOGFONT_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|bin_dialogexfont
name|bdxf
decl_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdxf
operator|.
name|pointsize
argument_list|,
name|dialog
operator|->
name|pointsize
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdxf
operator|.
name|weight
argument_list|,
operator|(
name|dialog
operator|->
name|ex
operator|==
name|NULL
condition|?
literal|0
else|:
name|dialog
operator|->
name|ex
operator|->
name|weight
operator|)
argument_list|)
expr_stmt|;
name|windres_put_8
argument_list|(
name|wrbfd
argument_list|,
name|bdxf
operator|.
name|italic
argument_list|,
operator|(
name|dialog
operator|->
name|ex
operator|==
name|NULL
condition|?
literal|0
else|:
name|dialog
operator|->
name|ex
operator|->
name|italic
operator|)
argument_list|)
expr_stmt|;
name|windres_put_8
argument_list|(
name|wrbfd
argument_list|,
name|bdxf
operator|.
name|charset
argument_list|,
operator|(
name|dialog
operator|->
name|ex
operator|==
name|NULL
condition|?
literal|1
else|:
name|dialog
operator|->
name|ex
operator|->
name|charset
operator|)
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bdxf
argument_list|,
name|off
argument_list|,
name|BIN_DIALOGEXFONT_SIZE
argument_list|)
expr_stmt|;
block|}
block|}
name|off
operator|+=
operator|(
name|dialogex
condition|?
name|BIN_DIALOGEXFONT_SIZE
else|:
name|BIN_DIALOGFONT_SIZE
operator|)
expr_stmt|;
name|off
operator|=
name|unicode_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|dialog
operator|->
name|font
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|c
operator|=
literal|0
operator|,
name|dc
operator|=
name|dialog
operator|->
name|controls
init|;
name|dc
operator|!=
name|NULL
condition|;
name|dc
operator|=
name|dc
operator|->
name|next
operator|,
name|c
operator|++
control|)
block|{
name|bfd_byte
name|dc_rclen
index|[
literal|2
index|]
decl_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
if|if
condition|(
operator|!
name|dialogex
condition|)
block|{
name|struct
name|bin_dialog_control
name|bdc
decl_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|style
argument_list|,
name|dc
operator|->
name|style
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|exstyle
argument_list|,
name|dc
operator|->
name|exstyle
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|x
argument_list|,
name|dc
operator|->
name|x
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|y
argument_list|,
name|dc
operator|->
name|y
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|width
argument_list|,
name|dc
operator|->
name|width
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|height
argument_list|,
name|dc
operator|->
name|height
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|id
argument_list|,
name|dc
operator|->
name|id
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bdc
argument_list|,
name|off
argument_list|,
name|BIN_DIALOG_CONTROL_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|bin_dialogex_control
name|bdc
decl_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|help
argument_list|,
name|dc
operator|->
name|help
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|exstyle
argument_list|,
name|dc
operator|->
name|exstyle
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|style
argument_list|,
name|dc
operator|->
name|style
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|x
argument_list|,
name|dc
operator|->
name|x
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|y
argument_list|,
name|dc
operator|->
name|y
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|width
argument_list|,
name|dc
operator|->
name|width
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|height
argument_list|,
name|dc
operator|->
name|height
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bdc
operator|.
name|id
argument_list|,
name|dc
operator|->
name|id
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bdc
argument_list|,
name|off
argument_list|,
name|BIN_DIALOGEX_CONTROL_SIZE
argument_list|)
expr_stmt|;
block|}
block|}
name|off
operator|+=
operator|(
name|dialogex
operator|!=
literal|0
condition|?
name|BIN_DIALOGEX_CONTROL_SIZE
else|:
name|BIN_DIALOG_CONTROL_SIZE
operator|)
expr_stmt|;
name|off
operator|=
name|resid_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|dc
operator|->
name|class
argument_list|)
expr_stmt|;
name|off
operator|=
name|resid_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|dc
operator|->
name|text
argument_list|)
expr_stmt|;
name|marker
operator|=
name|off
expr_stmt|;
comment|/* Save two bytes for size of optional data.  */
name|off
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|dc
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|wrbfd
condition|)
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|dc_rclen
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rc_uint_type
name|saved_off
init|=
name|off
decl_stmt|;
name|rc_uint_type
name|old_off
decl_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
name|old_off
operator|=
name|off
expr_stmt|;
name|off
operator|=
name|res_to_bin_rcdata
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|dc
operator|->
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|off
operator|-
name|old_off
operator|)
operator|==
literal|0
condition|)
name|old_off
operator|=
name|off
operator|=
name|saved_off
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|dc_rclen
argument_list|,
name|off
operator|-
name|old_off
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wrbfd
condition|)
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|dc_rclen
argument_list|,
name|marker
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
operator|(
name|dialogex
operator|!=
literal|0
condition|?
name|bdx
operator|.
name|off
else|:
name|bd
operator|.
name|off
operator|)
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dialogex
condition|)
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bd
argument_list|,
name|start
argument_list|,
name|BIN_DIALOG_SIZE
argument_list|)
expr_stmt|;
else|else
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bdx
argument_list|,
name|start
argument_list|,
name|BIN_DIALOGEX_SIZE
argument_list|)
expr_stmt|;
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert a fontdir resource to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_fontdir
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_fontdir
modifier|*
name|fontdirs
parameter_list|)
block|{
name|rc_uint_type
name|start
decl_stmt|;
name|int
name|c
decl_stmt|;
specifier|const
name|rc_fontdir
modifier|*
name|fd
decl_stmt|;
name|start
operator|=
name|off
expr_stmt|;
name|off
operator|+=
literal|2
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
operator|,
name|fd
operator|=
name|fontdirs
init|;
name|fd
operator|!=
name|NULL
condition|;
name|fd
operator|=
name|fd
operator|->
name|next
operator|,
name|c
operator|++
control|)
block|{
if|if
condition|(
name|wrbfd
condition|)
block|{
name|bfd_byte
name|d
index|[
literal|2
index|]
decl_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|d
argument_list|,
name|fd
operator|->
name|index
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|d
argument_list|,
name|off
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|->
name|length
condition|)
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|fd
operator|->
name|data
argument_list|,
name|off
operator|+
literal|2
argument_list|,
name|fd
operator|->
name|length
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
operator|(
name|rc_uint_type
operator|)
name|fd
operator|->
name|length
operator|+
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|wrbfd
condition|)
block|{
name|bfd_byte
name|d
index|[
literal|2
index|]
decl_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|d
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|d
argument_list|,
name|start
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert a group icon resource to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_group_icon
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_group_icon
modifier|*
name|group_icons
parameter_list|)
block|{
name|rc_uint_type
name|start
decl_stmt|;
name|struct
name|bin_group_icon
name|bgi
decl_stmt|;
name|int
name|c
decl_stmt|;
specifier|const
name|rc_group_icon
modifier|*
name|gi
decl_stmt|;
name|start
operator|=
name|off
expr_stmt|;
name|off
operator|+=
name|BIN_GROUP_ICON_SIZE
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
operator|,
name|gi
operator|=
name|group_icons
init|;
name|gi
operator|!=
name|NULL
condition|;
name|gi
operator|=
name|gi
operator|->
name|next
operator|,
name|c
operator|++
control|)
block|{
name|struct
name|bin_group_icon_item
name|bgii
decl_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_8
argument_list|(
name|wrbfd
argument_list|,
name|bgii
operator|.
name|width
argument_list|,
name|gi
operator|->
name|width
argument_list|)
expr_stmt|;
name|windres_put_8
argument_list|(
name|wrbfd
argument_list|,
name|bgii
operator|.
name|height
argument_list|,
name|gi
operator|->
name|height
argument_list|)
expr_stmt|;
name|windres_put_8
argument_list|(
name|wrbfd
argument_list|,
name|bgii
operator|.
name|colors
argument_list|,
name|gi
operator|->
name|colors
argument_list|)
expr_stmt|;
name|windres_put_8
argument_list|(
name|wrbfd
argument_list|,
name|bgii
operator|.
name|pad
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgii
operator|.
name|planes
argument_list|,
name|gi
operator|->
name|planes
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgii
operator|.
name|bits
argument_list|,
name|gi
operator|->
name|bits
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bgii
operator|.
name|bytes
argument_list|,
name|gi
operator|->
name|bytes
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgii
operator|.
name|index
argument_list|,
name|gi
operator|->
name|index
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bgii
argument_list|,
name|off
argument_list|,
name|BIN_GROUP_ICON_ITEM_SIZE
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
name|BIN_GROUP_ICON_ITEM_SIZE
expr_stmt|;
block|}
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgi
operator|.
name|sig1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgi
operator|.
name|sig2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bgi
operator|.
name|count
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bgi
argument_list|,
name|start
argument_list|,
name|BIN_GROUP_ICON_SIZE
argument_list|)
expr_stmt|;
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert a menu resource to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_menu
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_menu
modifier|*
name|menu
parameter_list|)
block|{
name|int
name|menuex
decl_stmt|;
name|menuex
operator|=
name|extended_menu
argument_list|(
name|menu
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
if|if
condition|(
operator|!
name|menuex
condition|)
block|{
name|struct
name|bin_menu
name|bm
decl_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bm
operator|.
name|sig1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bm
operator|.
name|sig2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bm
argument_list|,
name|off
argument_list|,
name|BIN_MENU_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|bin_menuex
name|bm
decl_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bm
operator|.
name|sig1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bm
operator|.
name|sig2
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bm
operator|.
name|help
argument_list|,
name|menu
operator|->
name|help
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bm
argument_list|,
name|off
argument_list|,
name|BIN_MENUEX_SIZE
argument_list|)
expr_stmt|;
block|}
block|}
name|off
operator|+=
operator|(
name|menuex
operator|!=
literal|0
condition|?
name|BIN_MENUEX_SIZE
else|:
name|BIN_MENU_SIZE
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|menuex
condition|)
block|{
name|off
operator|=
name|res_to_bin_menuitems
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|menu
operator|->
name|items
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|off
operator|=
name|res_to_bin_menuexitems
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|menu
operator|->
name|items
argument_list|)
expr_stmt|;
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert menu items to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_menuitems
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_menuitem
modifier|*
name|items
parameter_list|)
block|{
specifier|const
name|rc_menuitem
modifier|*
name|mi
decl_stmt|;
for|for
control|(
name|mi
operator|=
name|items
init|;
name|mi
operator|!=
name|NULL
condition|;
name|mi
operator|=
name|mi
operator|->
name|next
control|)
block|{
name|struct
name|bin_menuitem
name|bmi
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|flags
operator|=
name|mi
operator|->
name|type
expr_stmt|;
if|if
condition|(
name|mi
operator|->
name|next
operator|==
name|NULL
condition|)
name|flags
operator||=
name|MENUITEM_ENDMENU
expr_stmt|;
if|if
condition|(
name|mi
operator|->
name|popup
operator|!=
name|NULL
condition|)
name|flags
operator||=
name|MENUITEM_POPUP
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bmi
operator|.
name|flags
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|mi
operator|->
name|popup
operator|==
name|NULL
condition|)
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bmi
operator|.
name|id
argument_list|,
name|mi
operator|->
name|id
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bmi
argument_list|,
name|off
argument_list|,
name|mi
operator|->
name|popup
operator|==
name|NULL
condition|?
name|BIN_MENUITEM_SIZE
else|:
name|BIN_MENUITEM_POPUP_SIZE
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
operator|(
name|mi
operator|->
name|popup
operator|==
name|NULL
condition|?
name|BIN_MENUITEM_SIZE
else|:
name|BIN_MENUITEM_POPUP_SIZE
operator|)
expr_stmt|;
name|off
operator|=
name|unicode_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|mi
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
name|mi
operator|->
name|popup
operator|!=
name|NULL
condition|)
block|{
name|off
operator|=
name|res_to_bin_menuitems
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|mi
operator|->
name|popup
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert menuex items to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_menuexitems
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_menuitem
modifier|*
name|items
parameter_list|)
block|{
name|rc_uint_type
name|off_delta
init|=
name|off
decl_stmt|;
specifier|const
name|rc_menuitem
modifier|*
name|mi
decl_stmt|;
for|for
control|(
name|mi
operator|=
name|items
init|;
name|mi
operator|!=
name|NULL
condition|;
name|mi
operator|=
name|mi
operator|->
name|next
control|)
block|{
name|struct
name|bin_menuitemex
name|bmi
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
name|flags
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|mi
operator|->
name|next
operator|==
name|NULL
condition|)
name|flags
operator||=
literal|0x80
expr_stmt|;
if|if
condition|(
name|mi
operator|->
name|popup
operator|!=
name|NULL
condition|)
name|flags
operator||=
literal|1
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bmi
operator|.
name|type
argument_list|,
name|mi
operator|->
name|type
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bmi
operator|.
name|state
argument_list|,
name|mi
operator|->
name|state
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bmi
operator|.
name|id
argument_list|,
name|mi
operator|->
name|id
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bmi
operator|.
name|flags
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bmi
argument_list|,
name|off
argument_list|,
name|BIN_MENUITEMEX_SIZE
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
name|BIN_MENUITEMEX_SIZE
expr_stmt|;
name|off
operator|=
name|unicode_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|mi
operator|->
name|text
argument_list|)
expr_stmt|;
if|if
condition|(
name|mi
operator|->
name|popup
operator|!=
name|NULL
condition|)
block|{
name|bfd_byte
name|help
index|[
literal|4
index|]
decl_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|help
argument_list|,
name|mi
operator|->
name|help
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|help
argument_list|,
name|off
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
literal|4
expr_stmt|;
name|off
operator|=
name|res_to_bin_menuexitems
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|mi
operator|->
name|popup
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert an rcdata resource to binary.  This is also used to convert    other information which happens to be stored in rc_rcdata_item lists    to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_rcdata
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_rcdata_item
modifier|*
name|items
parameter_list|)
block|{
specifier|const
name|rc_rcdata_item
modifier|*
name|ri
decl_stmt|;
for|for
control|(
name|ri
operator|=
name|items
init|;
name|ri
operator|!=
name|NULL
condition|;
name|ri
operator|=
name|ri
operator|->
name|next
control|)
block|{
name|rc_uint_type
name|len
decl_stmt|;
switch|switch
condition|(
name|ri
operator|->
name|type
condition|)
block|{
default|default:
name|abort
argument_list|()
expr_stmt|;
case|case
name|RCDATA_WORD
case|:
name|len
operator|=
literal|2
expr_stmt|;
break|break;
case|case
name|RCDATA_DWORD
case|:
name|len
operator|=
literal|4
expr_stmt|;
break|break;
case|case
name|RCDATA_STRING
case|:
name|len
operator|=
name|ri
operator|->
name|u
operator|.
name|string
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|RCDATA_WSTRING
case|:
name|len
operator|=
name|ri
operator|->
name|u
operator|.
name|wstring
operator|.
name|length
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
expr_stmt|;
break|break;
case|case
name|RCDATA_BUFFER
case|:
name|len
operator|=
name|ri
operator|->
name|u
operator|.
name|buffer
operator|.
name|length
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wrbfd
condition|)
block|{
name|bfd_byte
name|h
index|[
literal|4
index|]
decl_stmt|;
name|bfd_byte
modifier|*
name|hp
init|=
operator|&
name|h
index|[
literal|0
index|]
decl_stmt|;
switch|switch
condition|(
name|ri
operator|->
name|type
condition|)
block|{
case|case
name|RCDATA_WORD
case|:
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|hp
argument_list|,
name|ri
operator|->
name|u
operator|.
name|word
argument_list|)
expr_stmt|;
break|break;
case|case
name|RCDATA_DWORD
case|:
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|hp
argument_list|,
name|ri
operator|->
name|u
operator|.
name|dword
argument_list|)
expr_stmt|;
break|break;
case|case
name|RCDATA_STRING
case|:
name|hp
operator|=
operator|(
name|bfd_byte
operator|*
operator|)
name|ri
operator|->
name|u
operator|.
name|string
operator|.
name|s
expr_stmt|;
break|break;
case|case
name|RCDATA_WSTRING
case|:
block|{
name|rc_uint_type
name|i
decl_stmt|;
name|hp
operator|=
operator|(
name|bfd_byte
operator|*
operator|)
name|reswr_alloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ri
operator|->
name|u
operator|.
name|wstring
operator|.
name|length
condition|;
name|i
operator|++
control|)
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|hp
operator|+
name|i
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|,
name|ri
operator|->
name|u
operator|.
name|wstring
operator|.
name|w
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|RCDATA_BUFFER
case|:
name|hp
operator|=
operator|(
name|bfd_byte
operator|*
operator|)
name|ri
operator|->
name|u
operator|.
name|buffer
operator|.
name|data
expr_stmt|;
break|break;
block|}
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|hp
argument_list|,
name|off
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
name|len
expr_stmt|;
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert a stringtable resource to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_stringtable
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_stringtable
modifier|*
name|st
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
name|rc_uint_type
name|slen
decl_stmt|,
name|length
decl_stmt|;
name|unichar
modifier|*
name|s
decl_stmt|;
name|slen
operator|=
operator|(
name|rc_uint_type
operator|)
name|st
operator|->
name|strings
index|[
name|i
index|]
operator|.
name|length
expr_stmt|;
name|s
operator|=
name|st
operator|->
name|strings
index|[
name|i
index|]
operator|.
name|string
expr_stmt|;
name|length
operator|=
literal|2
operator|+
name|slen
operator|*
literal|2
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
name|bfd_byte
modifier|*
name|hp
decl_stmt|;
name|rc_uint_type
name|j
decl_stmt|;
name|hp
operator|=
operator|(
name|bfd_byte
operator|*
operator|)
name|reswr_alloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|hp
argument_list|,
name|slen
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|slen
condition|;
name|j
operator|++
control|)
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|hp
operator|+
literal|2
operator|+
name|j
operator|*
literal|2
argument_list|,
name|s
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|hp
argument_list|,
name|off
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
name|length
expr_stmt|;
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert an ASCII string to a unicode binary string.  This always    returns exactly one bindata structure.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|string_to_unicode_bin
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|)
block|{
name|rc_uint_type
name|len
decl_stmt|;
name|len
operator|=
operator|(
name|rc_uint_type
operator|)
name|strlen
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
name|rc_uint_type
name|i
decl_stmt|;
name|bfd_byte
modifier|*
name|hp
decl_stmt|;
name|hp
operator|=
operator|(
name|bfd_byte
operator|*
operator|)
name|reswr_alloc
argument_list|(
operator|(
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|hp
operator|+
name|i
operator|*
literal|2
argument_list|,
name|s
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|hp
operator|+
name|i
operator|*
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|hp
argument_list|,
name|off
argument_list|,
operator|(
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
call|(
name|rc_uint_type
call|)
argument_list|(
operator|(
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|off
return|;
block|}
end_function

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_toolbar
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
name|rc_toolbar
modifier|*
name|tb
parameter_list|)
block|{
if|if
condition|(
name|wrbfd
condition|)
block|{
name|struct
name|bin_toolbar
name|bt
decl_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bt
operator|.
name|button_width
argument_list|,
name|tb
operator|->
name|button_width
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bt
operator|.
name|button_height
argument_list|,
name|tb
operator|->
name|button_height
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bt
operator|.
name|nitems
argument_list|,
name|tb
operator|->
name|nitems
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bt
argument_list|,
name|off
argument_list|,
name|BIN_TOOLBAR_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|tb
operator|->
name|nitems
operator|>
literal|0
condition|)
block|{
name|rc_toolbar_item
modifier|*
name|it
decl_stmt|;
name|bfd_byte
modifier|*
name|ids
decl_stmt|;
name|rc_uint_type
name|i
init|=
literal|0
decl_stmt|;
name|ids
operator|=
operator|(
name|bfd_byte
operator|*
operator|)
name|reswr_alloc
argument_list|(
name|tb
operator|->
name|nitems
operator|*
literal|4
argument_list|)
expr_stmt|;
name|it
operator|=
name|tb
operator|->
name|items
expr_stmt|;
while|while
condition|(
name|it
operator|!=
name|NULL
condition|)
block|{
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|ids
operator|+
name|i
argument_list|,
name|it
operator|->
name|id
operator|.
name|u
operator|.
name|id
argument_list|)
expr_stmt|;
name|i
operator|+=
literal|4
expr_stmt|;
name|it
operator|=
name|it
operator|->
name|next
expr_stmt|;
block|}
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|ids
argument_list|,
name|off
operator|+
name|BIN_TOOLBAR_SIZE
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|off
operator|+=
name|BIN_TOOLBAR_SIZE
operator|+
name|tb
operator|->
name|nitems
operator|*
literal|4
expr_stmt|;
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert a versioninfo resource to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_versioninfo
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
specifier|const
name|rc_versioninfo
modifier|*
name|versioninfo
parameter_list|)
block|{
name|rc_uint_type
name|off_delta
init|=
name|off
decl_stmt|;
name|rc_uint_type
name|start
decl_stmt|;
name|struct
name|bin_versioninfo
name|bvi
decl_stmt|;
name|rc_ver_info
modifier|*
name|vi
decl_stmt|;
name|start
operator|=
name|off
expr_stmt|;
name|off
operator|+=
name|BIN_VERSIONINFO_SIZE
expr_stmt|;
name|off
operator|=
name|string_to_unicode_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
literal|"VS_VERSION_INFO"
argument_list|)
expr_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
if|if
condition|(
name|versioninfo
operator|->
name|fixed
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|wrbfd
condition|)
block|{
name|struct
name|bin_fixed_versioninfo
name|bfv
decl_stmt|;
specifier|const
name|rc_fixed_versioninfo
modifier|*
name|fi
decl_stmt|;
name|fi
operator|=
name|versioninfo
operator|->
name|fixed
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|sig1
argument_list|,
literal|0xfeef04bd
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|sig2
argument_list|,
literal|0x10000
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|file_version
argument_list|,
name|fi
operator|->
name|file_version_ms
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|file_version_ls
argument_list|,
name|fi
operator|->
name|file_version_ls
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|product_version_ms
argument_list|,
name|fi
operator|->
name|product_version_ms
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|product_version_ls
argument_list|,
name|fi
operator|->
name|product_version_ls
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|file_flags_mask
argument_list|,
name|fi
operator|->
name|file_flags_mask
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|file_flags
argument_list|,
name|fi
operator|->
name|file_flags
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|file_os
argument_list|,
name|fi
operator|->
name|file_os
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|file_type
argument_list|,
name|fi
operator|->
name|file_type
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|file_subtype
argument_list|,
name|fi
operator|->
name|file_subtype
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|file_date_ms
argument_list|,
name|fi
operator|->
name|file_date_ms
argument_list|)
expr_stmt|;
name|windres_put_32
argument_list|(
name|wrbfd
argument_list|,
name|bfv
operator|.
name|file_date_ls
argument_list|,
name|fi
operator|->
name|file_date_ls
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bfv
argument_list|,
name|off
argument_list|,
name|BIN_FIXED_VERSIONINFO_SIZE
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
name|BIN_FIXED_VERSIONINFO_SIZE
expr_stmt|;
block|}
for|for
control|(
name|vi
operator|=
name|versioninfo
operator|->
name|var
init|;
name|vi
operator|!=
name|NULL
condition|;
name|vi
operator|=
name|vi
operator|->
name|next
control|)
block|{
name|struct
name|bin_ver_info
name|bv
decl_stmt|;
name|rc_uint_type
name|bv_off
decl_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
name|bv_off
operator|=
name|off
expr_stmt|;
name|off
operator|+=
name|BIN_VER_INFO_SIZE
expr_stmt|;
switch|switch
condition|(
name|vi
operator|->
name|type
condition|)
block|{
default|default:
name|abort
argument_list|()
expr_stmt|;
case|case
name|VERINFO_STRING
case|:
block|{
name|struct
name|bin_ver_info
name|bvsd
decl_stmt|;
name|rc_uint_type
name|vs_off
decl_stmt|;
specifier|const
name|rc_ver_stringinfo
modifier|*
name|vs
decl_stmt|;
name|off
operator|=
name|string_to_unicode_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
literal|"StringFileInfo"
argument_list|)
expr_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
name|vs_off
operator|=
name|off
expr_stmt|;
name|off
operator|+=
name|BIN_VER_INFO_SIZE
expr_stmt|;
name|off
operator|=
name|unicode_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|vi
operator|->
name|u
operator|.
name|string
operator|.
name|language
argument_list|)
expr_stmt|;
for|for
control|(
name|vs
operator|=
name|vi
operator|->
name|u
operator|.
name|string
operator|.
name|strings
init|;
name|vs
operator|!=
name|NULL
condition|;
name|vs
operator|=
name|vs
operator|->
name|next
control|)
block|{
name|struct
name|bin_ver_info
name|bvss
decl_stmt|;
name|rc_uint_type
name|vss_off
decl_stmt|,
name|str_off
decl_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
name|vss_off
operator|=
name|off
expr_stmt|;
name|off
operator|+=
name|BIN_VER_INFO_SIZE
expr_stmt|;
name|off
operator|=
name|unicode_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|vs
operator|->
name|key
argument_list|)
expr_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
name|str_off
operator|=
name|off
expr_stmt|;
name|off
operator|=
name|unicode_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|vs
operator|->
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvss
operator|.
name|size
argument_list|,
name|off
operator|-
name|vss_off
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvss
operator|.
name|sig1
argument_list|,
operator|(
name|off
operator|-
name|str_off
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvss
operator|.
name|sig2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bvss
argument_list|,
name|vss_off
argument_list|,
name|BIN_VER_INFO_SIZE
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvsd
operator|.
name|size
argument_list|,
name|off
operator|-
name|vs_off
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvsd
operator|.
name|sig1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvsd
operator|.
name|sig2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bvsd
argument_list|,
name|vs_off
argument_list|,
name|BIN_VER_INFO_SIZE
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
case|case
name|VERINFO_VAR
case|:
block|{
name|rc_uint_type
name|vvd_off
decl_stmt|,
name|vvvd_off
decl_stmt|;
name|struct
name|bin_ver_info
name|bvvd
decl_stmt|;
specifier|const
name|rc_ver_varinfo
modifier|*
name|vv
decl_stmt|;
name|off
operator|=
name|string_to_unicode_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
literal|"VarFileInfo"
argument_list|)
expr_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
name|vvd_off
operator|=
name|off
expr_stmt|;
name|off
operator|+=
name|BIN_VER_INFO_SIZE
expr_stmt|;
name|off
operator|=
name|unicode_to_bin
argument_list|(
name|wrbfd
argument_list|,
name|off
argument_list|,
name|vi
operator|->
name|u
operator|.
name|var
operator|.
name|key
argument_list|)
expr_stmt|;
name|off
operator|+=
operator|(
literal|4
operator|-
operator|(
operator|(
name|off
operator|-
name|off_delta
operator|)
operator|&
literal|3
operator|)
operator|)
operator|&
literal|3
expr_stmt|;
name|vvvd_off
operator|=
name|off
expr_stmt|;
for|for
control|(
name|vv
operator|=
name|vi
operator|->
name|u
operator|.
name|var
operator|.
name|var
init|;
name|vv
operator|!=
name|NULL
condition|;
name|vv
operator|=
name|vv
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wrbfd
condition|)
block|{
name|bfd_byte
name|vvsd
index|[
literal|4
index|]
decl_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|vvsd
index|[
literal|0
index|]
argument_list|,
name|vv
operator|->
name|language
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|vvsd
index|[
literal|2
index|]
argument_list|,
name|vv
operator|->
name|charset
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|vvsd
argument_list|,
name|off
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
name|off
operator|+=
literal|4
expr_stmt|;
block|}
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvvd
operator|.
name|size
argument_list|,
name|off
operator|-
name|vvd_off
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvvd
operator|.
name|sig1
argument_list|,
name|off
operator|-
name|vvvd_off
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvvd
operator|.
name|sig2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bvvd
argument_list|,
name|vvd_off
argument_list|,
name|BIN_VER_INFO_SIZE
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bv
operator|.
name|size
argument_list|,
name|off
operator|-
name|bv_off
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bv
operator|.
name|sig1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bv
operator|.
name|sig2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bv
argument_list|,
name|bv_off
argument_list|,
name|BIN_VER_INFO_SIZE
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wrbfd
condition|)
block|{
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvi
operator|.
name|size
argument_list|,
name|off
operator|-
name|start
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvi
operator|.
name|fixed_size
argument_list|,
name|versioninfo
operator|->
name|fixed
operator|==
name|NULL
condition|?
literal|0
else|:
name|BIN_FIXED_VERSIONINFO_SIZE
argument_list|)
expr_stmt|;
name|windres_put_16
argument_list|(
name|wrbfd
argument_list|,
name|bvi
operator|.
name|sig2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
operator|&
name|bvi
argument_list|,
name|start
argument_list|,
name|BIN_VER_INFO_SIZE
argument_list|)
expr_stmt|;
block|}
return|return
name|off
return|;
block|}
end_function

begin_comment
comment|/* Convert a generic resource to binary.  */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|res_to_bin_generic
parameter_list|(
name|windres_bfd
modifier|*
name|wrbfd
parameter_list|,
name|rc_uint_type
name|off
parameter_list|,
name|rc_uint_type
name|length
parameter_list|,
specifier|const
name|bfd_byte
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|wrbfd
operator|&&
name|length
operator|!=
literal|0
condition|)
name|set_windres_bfd_content
argument_list|(
name|wrbfd
argument_list|,
name|data
argument_list|,
name|off
argument_list|,
name|length
argument_list|)
expr_stmt|;
return|return
name|off
operator|+
operator|(
name|rc_uint_type
operator|)
name|length
return|;
block|}
end_function

end_unit


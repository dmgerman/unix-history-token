begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* dllwrap.c -- wrapper for DLLTOOL and GCC to generate PE style DLLs    Copyright 1998, 1999, 2000 Free Software Foundation, Inc.    Contributed by Mumit Khan (khan@xraylith.wisc.edu).     This file is part of GNU Binutils.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA    02111-1307, USA.  */
end_comment

begin_comment
comment|/* AIX requires this to be the first thing in the file.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__GNUC__
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|_AIX
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|alloca
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"libiberty.h"
end_include

begin_include
include|#
directive|include
file|"bucomm.h"
end_include

begin_include
include|#
directive|include
file|"getopt.h"
end_include

begin_include
include|#
directive|include
file|"dyn-string.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|ANSI_PROTOTYPES
end_ifdef

begin_include
include|#
directive|include
file|<stdarg.h>
end_include

begin_else
else|#
directive|else
end_else

begin_include
include|#
directive|include
file|<varargs.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_WAIT_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/wait.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* ! HAVE_SYS_WAIT_H */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|||
name|defined
argument_list|(
name|__CYGWIN32__
argument_list|)
end_if

begin_ifndef
ifndef|#
directive|ifndef
name|WIFEXITED
end_ifndef

begin_define
define|#
directive|define
name|WIFEXITED
parameter_list|(
name|w
parameter_list|)
value|(((w)&0377) == 0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WIFSIGNALED
end_ifndef

begin_define
define|#
directive|define
name|WIFSIGNALED
parameter_list|(
name|w
parameter_list|)
value|(((w)&0377) != 0177&& ((w)&~0377) == 0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WTERMSIG
end_ifndef

begin_define
define|#
directive|define
name|WTERMSIG
parameter_list|(
name|w
parameter_list|)
value|((w)& 0177)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WEXITSTATUS
end_ifndef

begin_define
define|#
directive|define
name|WEXITSTATUS
parameter_list|(
name|w
parameter_list|)
value|(((w)>> 8)& 0377)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* defined (_WIN32)&& ! defined (__CYGWIN32__) */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|WIFEXITED
end_ifndef

begin_define
define|#
directive|define
name|WIFEXITED
parameter_list|(
name|w
parameter_list|)
value|(((w)& 0xff) == 0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WIFSIGNALED
end_ifndef

begin_define
define|#
directive|define
name|WIFSIGNALED
parameter_list|(
name|w
parameter_list|)
value|(((w)& 0xff) != 0&& ((w)& 0xff) != 0x7f)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WTERMSIG
end_ifndef

begin_define
define|#
directive|define
name|WTERMSIG
parameter_list|(
name|w
parameter_list|)
value|((w)& 0x7f)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|WEXITSTATUS
end_ifndef

begin_define
define|#
directive|define
name|WEXITSTATUS
parameter_list|(
name|w
parameter_list|)
value|(((w)& 0xff00)>> 8)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined (_WIN32)&& ! defined (__CYGWIN32__) */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ! HAVE_SYS_WAIT_H */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|driver_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|cygwin_driver_flags
init|=
literal|"-Wl,--dll -nostartfiles"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|mingw32_driver_flags
init|=
literal|"-mdll"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|generic_driver_flags
init|=
literal|"-Wl,--dll"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|entry_point
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dlltool_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|target
init|=
name|TARGET
decl_stmt|;
end_decl_stmt

begin_typedef
typedef|typedef
enum|enum
block|{
name|UNKNOWN_TARGET
block|,
name|CYGWIN_TARGET
block|,
name|MINGW_TARGET
block|}
name|target_type
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|target_type
name|which_target
init|=
name|UNKNOWN_TARGET
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|dontdeltemps
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|dry_run
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|program_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|verbose
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dll_file_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|dll_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|base_file_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|exp_file_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|def_file_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|delete_base_file
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|delete_exp_file
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|delete_def_file
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|run
name|PARAMS
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|usage
name|PARAMS
argument_list|(
operator|(
name|FILE
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|display
name|PARAMS
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|,
name|va_list
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|inform
name|PARAMS
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|,
operator|...
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|warn
name|PARAMS
argument_list|(
operator|(
specifier|const
name|char
operator|*
name|format
operator|,
operator|...
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|look_for_prog
name|PARAMS
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|,
specifier|const
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|deduce_name
name|PARAMS
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|delete_temp_files
name|PARAMS
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|cleanup_and_exit
name|PARAMS
argument_list|(
operator|(
name|int
name|status
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**********************************************************************/
end_comment

begin_comment
comment|/* Please keep the following 4 routines in sync with dlltool.c:      display ()      inform ()      look_for_prog ()      deduce_name ()    It's not worth the hassle to break these out since dllwrap will    (hopefully) soon be retired in favor of `ld --shared.  */
end_comment

begin_function
specifier|static
name|void
name|display
parameter_list|(
name|message
parameter_list|,
name|args
parameter_list|)
specifier|const
name|char
modifier|*
name|message
decl_stmt|;
name|va_list
name|args
decl_stmt|;
block|{
if|if
condition|(
name|program_name
operator|!=
name|NULL
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: "
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|stderr
argument_list|,
name|message
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
literal|'\n'
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|__STDC__
end_ifdef

begin_function
specifier|static
name|void
name|inform
parameter_list|(
specifier|const
name|char
modifier|*
name|message
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
if|if
condition|(
operator|!
name|verbose
condition|)
return|return;
name|va_start
argument_list|(
name|args
argument_list|,
name|message
argument_list|)
expr_stmt|;
name|display
argument_list|(
name|message
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|warn
parameter_list|(
specifier|const
name|char
modifier|*
name|format
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|,
name|format
argument_list|)
expr_stmt|;
name|display
argument_list|(
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
specifier|static
name|void
name|inform
parameter_list|(
name|message
parameter_list|,
name|va_alist
parameter_list|)
specifier|const
name|char
modifier|*
name|message
decl_stmt|;
function|va_dcl
block|{
name|va_list
name|args
decl_stmt|;
if|if
condition|(
operator|!
name|verbose
condition|)
return|return;
name|va_start
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|display
argument_list|(
name|message
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|warn
parameter_list|(
name|format
parameter_list|,
name|va_alist
parameter_list|)
specifier|const
name|char
modifier|*
name|format
decl_stmt|;
function|va_dcl
block|{
name|va_list
name|args
decl_stmt|;
name|va_start
argument_list|(
name|args
argument_list|)
expr_stmt|;
name|display
argument_list|(
name|format
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Look for the program formed by concatenating PROG_NAME and the    string running from PREFIX to END_PREFIX.  If the concatenated    string contains a '/', try appending EXECUTABLE_SUFFIX if it is    appropriate.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|look_for_prog
parameter_list|(
name|prog_name
parameter_list|,
name|prefix
parameter_list|,
name|end_prefix
parameter_list|)
specifier|const
name|char
modifier|*
name|prog_name
decl_stmt|;
specifier|const
name|char
modifier|*
name|prefix
decl_stmt|;
name|int
name|end_prefix
decl_stmt|;
block|{
name|struct
name|stat
name|s
decl_stmt|;
name|char
modifier|*
name|cmd
decl_stmt|;
name|cmd
operator|=
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|prefix
argument_list|)
operator|+
name|strlen
argument_list|(
name|prog_name
argument_list|)
ifdef|#
directive|ifdef
name|HAVE_EXECUTABLE_SUFFIX
operator|+
name|strlen
argument_list|(
name|EXECUTABLE_SUFFIX
argument_list|)
endif|#
directive|endif
operator|+
literal|10
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|cmd
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|cmd
operator|+
name|end_prefix
argument_list|,
literal|"%s"
argument_list|,
name|prog_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|strchr
argument_list|(
name|cmd
argument_list|,
literal|'/'
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|int
name|found
decl_stmt|;
name|found
operator|=
operator|(
name|stat
argument_list|(
name|cmd
argument_list|,
operator|&
name|s
argument_list|)
operator|==
literal|0
ifdef|#
directive|ifdef
name|HAVE_EXECUTABLE_SUFFIX
operator|||
name|stat
argument_list|(
name|strcat
argument_list|(
name|cmd
argument_list|,
name|EXECUTABLE_SUFFIX
argument_list|)
argument_list|,
operator|&
name|s
argument_list|)
operator|==
literal|0
endif|#
directive|endif
operator|)
expr_stmt|;
if|if
condition|(
operator|!
name|found
condition|)
block|{
comment|/* xgettext:c-format */
name|inform
argument_list|(
name|_
argument_list|(
literal|"Tried file: %s"
argument_list|)
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
comment|/* xgettext:c-format */
name|inform
argument_list|(
name|_
argument_list|(
literal|"Using file: %s"
argument_list|)
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
name|cmd
return|;
block|}
end_function

begin_comment
comment|/* Deduce the name of the program we are want to invoke.    PROG_NAME is the basic name of the program we want to run,    eg "as" or "ld".  The catch is that we might want actually    run "i386-pe-as" or "ppc-pe-ld".       If argv[0] contains the full path, then try to find the program    in the same place, with and then without a target-like prefix.     Given, argv[0] = /usr/local/bin/i586-cygwin32-dlltool,    deduce_name("as") uses the following search order:        /usr/local/bin/i586-cygwin32-as      /usr/local/bin/as      as        If there's an EXECUTABLE_SUFFIX, it'll use that as well; for each    name, it'll try without and then with EXECUTABLE_SUFFIX.     Given, argv[0] = i586-cygwin32-dlltool, it will not even try "as"    as the fallback, but rather return i586-cygwin32-as.          Oh, and given, argv[0] = dlltool, it'll return "as".     Returns a dynamically allocated string.  */
end_comment

begin_function
specifier|static
name|char
modifier|*
name|deduce_name
parameter_list|(
name|prog_name
parameter_list|)
specifier|const
name|char
modifier|*
name|prog_name
decl_stmt|;
block|{
name|char
modifier|*
name|cmd
decl_stmt|;
name|char
modifier|*
name|dash
decl_stmt|,
modifier|*
name|slash
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|dash
operator|=
name|NULL
expr_stmt|;
name|slash
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|cp
operator|=
name|program_name
init|;
operator|*
name|cp
operator|!=
literal|'\0'
condition|;
operator|++
name|cp
control|)
block|{
if|if
condition|(
operator|*
name|cp
operator|==
literal|'-'
condition|)
name|dash
operator|=
name|cp
expr_stmt|;
if|if
condition|(
if|#
directive|if
name|defined
argument_list|(
name|__DJGPP__
argument_list|)
operator|||
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
operator|||
name|defined
argument_list|(
name|__WIN32__
argument_list|)
operator|*
name|cp
operator|==
literal|':'
operator|||
operator|*
name|cp
operator|==
literal|'\\'
operator|||
endif|#
directive|endif
operator|*
name|cp
operator|==
literal|'/'
condition|)
block|{
name|slash
operator|=
name|cp
expr_stmt|;
name|dash
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|cmd
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|dash
operator|!=
name|NULL
condition|)
block|{
comment|/* First, try looking for a prefixed PROG_NAME in the          PROGRAM_NAME directory, with the same prefix as PROGRAM_NAME.  */
name|cmd
operator|=
name|look_for_prog
argument_list|(
name|prog_name
argument_list|,
name|program_name
argument_list|,
name|dash
operator|-
name|program_name
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|slash
operator|!=
name|NULL
operator|&&
name|cmd
operator|==
name|NULL
condition|)
block|{
comment|/* Next, try looking for a PROG_NAME in the same directory as          that of this program.  */
name|cmd
operator|=
name|look_for_prog
argument_list|(
name|prog_name
argument_list|,
name|program_name
argument_list|,
name|slash
operator|-
name|program_name
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
block|{
comment|/* Just return PROG_NAME as is.  */
name|cmd
operator|=
name|xstrdup
argument_list|(
name|prog_name
argument_list|)
expr_stmt|;
block|}
return|return
name|cmd
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|delete_temp_files
parameter_list|()
block|{
if|if
condition|(
name|delete_base_file
operator|&&
name|base_file_name
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
block|{
if|if
condition|(
name|dontdeltemps
condition|)
name|warn
argument_list|(
name|_
argument_list|(
literal|"Keeping temporary base file %s"
argument_list|)
argument_list|,
name|base_file_name
argument_list|)
expr_stmt|;
else|else
name|warn
argument_list|(
name|_
argument_list|(
literal|"Deleting temporary base file %s"
argument_list|)
argument_list|,
name|base_file_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dontdeltemps
condition|)
block|{
name|unlink
argument_list|(
name|base_file_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|base_file_name
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|delete_exp_file
operator|&&
name|exp_file_name
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
block|{
if|if
condition|(
name|dontdeltemps
condition|)
name|warn
argument_list|(
name|_
argument_list|(
literal|"Keeping temporary exp file %s"
argument_list|)
argument_list|,
name|exp_file_name
argument_list|)
expr_stmt|;
else|else
name|warn
argument_list|(
name|_
argument_list|(
literal|"Deleting temporary exp file %s"
argument_list|)
argument_list|,
name|exp_file_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dontdeltemps
condition|)
block|{
name|unlink
argument_list|(
name|exp_file_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|exp_file_name
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|delete_def_file
operator|&&
name|def_file_name
condition|)
block|{
if|if
condition|(
name|verbose
condition|)
block|{
if|if
condition|(
name|dontdeltemps
condition|)
name|warn
argument_list|(
name|_
argument_list|(
literal|"Keeping temporary def file %s"
argument_list|)
argument_list|,
name|def_file_name
argument_list|)
expr_stmt|;
else|else
name|warn
argument_list|(
name|_
argument_list|(
literal|"Deleting temporary def file %s"
argument_list|)
argument_list|,
name|def_file_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dontdeltemps
condition|)
block|{
name|unlink
argument_list|(
name|def_file_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|def_file_name
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|cleanup_and_exit
parameter_list|(
name|int
name|status
parameter_list|)
block|{
name|delete_temp_files
argument_list|()
expr_stmt|;
name|exit
argument_list|(
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|run
parameter_list|(
name|what
parameter_list|,
name|args
parameter_list|)
specifier|const
name|char
modifier|*
name|what
decl_stmt|;
name|char
modifier|*
name|args
decl_stmt|;
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|pid
decl_stmt|,
name|wait_status
decl_stmt|,
name|retcode
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|char
modifier|*
name|errmsg_fmt
decl_stmt|,
modifier|*
name|errmsg_arg
decl_stmt|;
name|char
modifier|*
name|temp_base
init|=
name|choose_temp_base
argument_list|()
decl_stmt|;
name|int
name|in_quote
decl_stmt|;
name|char
name|sep
decl_stmt|;
if|if
condition|(
name|verbose
operator|||
name|dry_run
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s %s\n"
argument_list|,
name|what
argument_list|,
name|args
argument_list|)
expr_stmt|;
comment|/* Count the args */
name|i
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|s
operator|=
name|args
init|;
operator|*
name|s
condition|;
name|s
operator|++
control|)
if|if
condition|(
operator|*
name|s
operator|==
literal|' '
condition|)
name|i
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|argv
operator|=
name|alloca
argument_list|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|*
operator|(
name|i
operator|+
literal|3
operator|)
argument_list|)
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|argv
index|[
name|i
operator|++
index|]
operator|=
name|what
expr_stmt|;
name|s
operator|=
name|args
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
while|while
condition|(
operator|*
name|s
operator|==
literal|' '
operator|&&
operator|*
name|s
operator|!=
literal|0
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|==
literal|0
condition|)
break|break;
name|in_quote
operator|=
operator|(
operator|*
name|s
operator|==
literal|'\''
operator|||
operator|*
name|s
operator|==
literal|'"'
operator|)
expr_stmt|;
name|sep
operator|=
operator|(
name|in_quote
operator|)
condition|?
operator|*
name|s
operator|++
else|:
literal|' '
expr_stmt|;
name|argv
index|[
name|i
operator|++
index|]
operator|=
name|s
expr_stmt|;
while|while
condition|(
operator|*
name|s
operator|!=
name|sep
operator|&&
operator|*
name|s
operator|!=
literal|0
condition|)
name|s
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|==
literal|0
condition|)
break|break;
operator|*
name|s
operator|++
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|in_quote
condition|)
name|s
operator|++
expr_stmt|;
block|}
name|argv
index|[
name|i
operator|++
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|dry_run
condition|)
return|return
literal|0
return|;
name|pid
operator|=
name|pexecute
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
operator|(
name|char
operator|*
specifier|const
operator|*
operator|)
name|argv
argument_list|,
name|program_name
argument_list|,
name|temp_base
argument_list|,
operator|&
name|errmsg_fmt
argument_list|,
operator|&
name|errmsg_arg
argument_list|,
name|PEXECUTE_ONE
operator||
name|PEXECUTE_SEARCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|==
operator|-
literal|1
condition|)
block|{
name|int
name|errno_val
init|=
name|errno
decl_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: "
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|errmsg_fmt
argument_list|,
name|errmsg_arg
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|": %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno_val
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|retcode
operator|=
literal|0
expr_stmt|;
name|pid
operator|=
name|pwait
argument_list|(
name|pid
argument_list|,
operator|&
name|wait_status
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pid
operator|==
operator|-
literal|1
condition|)
block|{
name|warn
argument_list|(
literal|"wait: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|retcode
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|WIFSIGNALED
argument_list|(
name|wait_status
argument_list|)
condition|)
block|{
name|warn
argument_list|(
name|_
argument_list|(
literal|"subprocess got fatal signal %d"
argument_list|)
argument_list|,
name|WTERMSIG
argument_list|(
name|wait_status
argument_list|)
argument_list|)
expr_stmt|;
name|retcode
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|WIFEXITED
argument_list|(
name|wait_status
argument_list|)
condition|)
block|{
if|if
condition|(
name|WEXITSTATUS
argument_list|(
name|wait_status
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|warn
argument_list|(
name|_
argument_list|(
literal|"%s exited with status %d"
argument_list|)
argument_list|,
name|what
argument_list|,
name|WEXITSTATUS
argument_list|(
name|wait_status
argument_list|)
argument_list|)
expr_stmt|;
name|retcode
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|retcode
operator|=
literal|1
expr_stmt|;
return|return
name|retcode
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|mybasename
parameter_list|(
name|name
parameter_list|)
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|{
specifier|const
name|char
modifier|*
name|base
init|=
name|name
decl_stmt|;
while|while
condition|(
operator|*
name|name
condition|)
block|{
if|if
condition|(
operator|*
name|name
operator|==
literal|'/'
operator|||
operator|*
name|name
operator|==
literal|'\\'
condition|)
block|{
name|base
operator|=
name|name
operator|+
literal|1
expr_stmt|;
block|}
operator|++
name|name
expr_stmt|;
block|}
return|return
operator|(
name|char
operator|*
operator|)
name|base
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|strhash
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|)
block|{
specifier|const
name|unsigned
name|char
modifier|*
name|s
decl_stmt|;
name|unsigned
name|long
name|hash
decl_stmt|;
name|unsigned
name|int
name|c
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|;
name|hash
operator|=
literal|0
expr_stmt|;
name|len
operator|=
literal|0
expr_stmt|;
name|s
operator|=
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|str
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|s
operator|++
operator|)
operator|!=
literal|'\0'
condition|)
block|{
name|hash
operator|+=
name|c
operator|+
operator|(
name|c
operator|<<
literal|17
operator|)
expr_stmt|;
name|hash
operator|^=
name|hash
operator|>>
literal|2
expr_stmt|;
operator|++
name|len
expr_stmt|;
block|}
name|hash
operator|+=
name|len
operator|+
operator|(
name|len
operator|<<
literal|17
operator|)
expr_stmt|;
name|hash
operator|^=
name|hash
operator|>>
literal|2
expr_stmt|;
return|return
name|hash
return|;
block|}
end_function

begin_comment
comment|/**********************************************************************/
end_comment

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|file
parameter_list|,
name|status
parameter_list|)
name|FILE
modifier|*
name|file
decl_stmt|;
name|int
name|status
decl_stmt|;
block|{
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"Usage %s<options><object-files>\n"
argument_list|)
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"  Generic options:\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --quiet, -q            Work quietly\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --verbose, -v          Verbose\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --version              Print dllwrap version\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --implib<outname>     Synonym for --output-lib\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"  Options for %s:\n"
argument_list|)
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --driver-name<driver> Defaults to \"gcc\"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --driver-flags<flags> Override default ld flags\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --dlltool-name<dlltool> Defaults to \"dlltool\"\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --entry<entry>        Specify alternate DLL entry point\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --image-base<base>    Specify image base address\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --target<machine>     i386-cygwin32 or i386-mingw32\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --dry-run              Show what needs to be run\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --mno-cygwin           Create Mingw DLL\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"  Options passed to DLLTOOL:\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --machine<machine>\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --output-exp<outname> Generate export file.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --output-lib<outname> Generate input library.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --add-indirect         Add dll indirects to export file.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --dllname<name>       Name of input dll to put into output lib.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --def<deffile>        Name input .def file\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --output-def<deffile> Name output .def file\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --export-all-symbols     Export all symbols to .def\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --no-export-all-symbols  Only export .drectve symbols\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --exclude-symbols<list> Exclude<list> from .def\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --no-default-excludes    Zap default exclude symbols\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --base-file<basefile> Read linker generated base file\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --no-idata4           Don't generate idata$4 section\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --no-idata5           Don't generate idata$5 section\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   -U                     Add underscores to .lib\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   -k                     Kill @<n> from exported names\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --add-stdcall-alias    Add aliases without @<n>\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --as<name>            Use<name> for assembler\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"   --nodelete             Keep temp files.\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
name|_
argument_list|(
literal|"  Rest are passed unmodified to the language driver\n"
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|file
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_define
define|#
directive|define
name|OPTION_START
value|149
end_define

begin_comment
comment|/* GENERIC options. */
end_comment

begin_define
define|#
directive|define
name|OPTION_QUIET
value|(OPTION_START + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_VERBOSE
value|(OPTION_QUIET + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_VERSION
value|(OPTION_VERBOSE + 1)
end_define

begin_comment
comment|/* DLLWRAP options. */
end_comment

begin_define
define|#
directive|define
name|OPTION_DRY_RUN
value|(OPTION_VERSION + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_DRIVER_NAME
value|(OPTION_DRY_RUN + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_DRIVER_FLAGS
value|(OPTION_DRIVER_NAME + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_DLLTOOL_NAME
value|(OPTION_DRIVER_FLAGS + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_ENTRY
value|(OPTION_DLLTOOL_NAME + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_IMAGE_BASE
value|(OPTION_ENTRY + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_TARGET
value|(OPTION_IMAGE_BASE + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_MNO_CYGWIN
value|(OPTION_TARGET + 1)
end_define

begin_comment
comment|/* DLLTOOL options. */
end_comment

begin_define
define|#
directive|define
name|OPTION_NODELETE
value|(OPTION_MNO_CYGWIN + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_DLLNAME
value|(OPTION_NODELETE + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_NO_IDATA4
value|(OPTION_DLLNAME + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_NO_IDATA5
value|(OPTION_NO_IDATA4 + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_OUTPUT_EXP
value|(OPTION_NO_IDATA5 + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_OUTPUT_DEF
value|(OPTION_OUTPUT_EXP + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_EXPORT_ALL_SYMS
value|(OPTION_OUTPUT_DEF + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_NO_EXPORT_ALL_SYMS
value|(OPTION_EXPORT_ALL_SYMS + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_EXCLUDE_SYMS
value|(OPTION_NO_EXPORT_ALL_SYMS + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_NO_DEFAULT_EXCLUDES
value|(OPTION_EXCLUDE_SYMS + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_OUTPUT_LIB
value|(OPTION_NO_DEFAULT_EXCLUDES + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_DEF
value|(OPTION_OUTPUT_LIB + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_ADD_UNDERSCORE
value|(OPTION_DEF + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_KILLAT
value|(OPTION_ADD_UNDERSCORE + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_HELP
value|(OPTION_KILLAT + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_MACHINE
value|(OPTION_HELP + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_ADD_INDIRECT
value|(OPTION_MACHINE + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_BASE_FILE
value|(OPTION_ADD_INDIRECT + 1)
end_define

begin_define
define|#
directive|define
name|OPTION_AS
value|(OPTION_BASE_FILE + 1)
end_define

begin_decl_stmt
specifier|static
specifier|const
name|struct
name|option
name|long_options
index|[]
init|=
block|{
comment|/* generic options. */
block|{
literal|"quiet"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'q'
block|}
block|,
block|{
literal|"verbose"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'v'
block|}
block|,
block|{
literal|"version"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPTION_VERSION
block|}
block|,
block|{
literal|"implib"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_OUTPUT_LIB
block|}
block|,
comment|/* dllwrap options. */
block|{
literal|"dry-run"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPTION_DRY_RUN
block|}
block|,
block|{
literal|"driver-name"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_DRIVER_NAME
block|}
block|,
block|{
literal|"driver-flags"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_DRIVER_FLAGS
block|}
block|,
block|{
literal|"dlltool-name"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_DLLTOOL_NAME
block|}
block|,
block|{
literal|"entry"
block|,
name|required_argument
block|,
name|NULL
block|,
literal|'e'
block|}
block|,
block|{
literal|"image-base"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_IMAGE_BASE
block|}
block|,
block|{
literal|"target"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_TARGET
block|}
block|,
comment|/* dlltool options. */
block|{
literal|"no-delete"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'n'
block|}
block|,
block|{
literal|"dllname"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_DLLNAME
block|}
block|,
block|{
literal|"no-idata4"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPTION_NO_IDATA4
block|}
block|,
block|{
literal|"no-idata5"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPTION_NO_IDATA5
block|}
block|,
block|{
literal|"output-exp"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_OUTPUT_EXP
block|}
block|,
block|{
literal|"output-def"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_OUTPUT_DEF
block|}
block|,
block|{
literal|"export-all-symbols"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPTION_EXPORT_ALL_SYMS
block|}
block|,
block|{
literal|"no-export-all-symbols"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPTION_NO_EXPORT_ALL_SYMS
block|}
block|,
block|{
literal|"exclude-symbols"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_EXCLUDE_SYMS
block|}
block|,
block|{
literal|"no-default-excludes"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPTION_NO_DEFAULT_EXCLUDES
block|}
block|,
block|{
literal|"output-lib"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_OUTPUT_LIB
block|}
block|,
block|{
literal|"def"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_DEF
block|}
block|,
block|{
literal|"add-underscore"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'U'
block|}
block|,
block|{
literal|"killat"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'k'
block|}
block|,
block|{
literal|"add-stdcall-alias"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'A'
block|}
block|,
block|{
literal|"help"
block|,
name|no_argument
block|,
name|NULL
block|,
literal|'h'
block|}
block|,
block|{
literal|"machine"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_MACHINE
block|}
block|,
block|{
literal|"add-indirect"
block|,
name|no_argument
block|,
name|NULL
block|,
name|OPTION_ADD_INDIRECT
block|}
block|,
block|{
literal|"base-file"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_BASE_FILE
block|}
block|,
block|{
literal|"as"
block|,
name|required_argument
block|,
name|NULL
block|,
name|OPTION_AS
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|c
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
modifier|*
name|saved_argv
init|=
literal|0
decl_stmt|;
name|int
name|cmdline_len
init|=
literal|0
decl_stmt|;
name|int
name|export_all
init|=
literal|0
decl_stmt|;
name|int
modifier|*
name|dlltool_arg_indices
decl_stmt|;
name|int
modifier|*
name|driver_arg_indices
decl_stmt|;
name|char
modifier|*
name|driver_flags
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|output_lib_file_name
init|=
literal|0
decl_stmt|;
name|dyn_string_t
name|dlltool_cmdline
decl_stmt|;
name|dyn_string_t
name|driver_cmdline
decl_stmt|;
name|int
name|def_file_seen
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|image_base_str
init|=
literal|0
decl_stmt|;
name|program_name
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|saved_argv
operator|=
operator|(
name|char
operator|*
operator|*
operator|)
name|xmalloc
argument_list|(
name|argc
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|dlltool_arg_indices
operator|=
operator|(
name|int
operator|*
operator|)
name|xmalloc
argument_list|(
name|argc
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|driver_arg_indices
operator|=
operator|(
name|int
operator|*
operator|)
name|xmalloc
argument_list|(
name|argc
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
operator|++
name|i
control|)
block|{
name|size_t
name|len
init|=
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
decl_stmt|;
name|char
modifier|*
name|arg
init|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
decl_stmt|;
name|strcpy
argument_list|(
name|arg
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|cmdline_len
operator|+=
name|len
expr_stmt|;
name|saved_argv
index|[
name|i
index|]
operator|=
name|arg
expr_stmt|;
name|dlltool_arg_indices
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
name|driver_arg_indices
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
block|}
name|cmdline_len
operator|++
expr_stmt|;
comment|/* We recognize dllwrap and dlltool options, and everything else is      passed onto the language driver (eg., to GCC). We collect options      to dlltool and driver in dlltool_args and driver_args. */
name|opterr
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt_long_only
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"nkAqve:Uho:l:L:I:"
argument_list|,
name|long_options
argument_list|,
operator|(
name|int
operator|*
operator|)
literal|0
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
name|int
name|dlltool_arg
decl_stmt|;
name|int
name|driver_arg
decl_stmt|;
name|int
name|single_word_option_value_pair
decl_stmt|;
name|dlltool_arg
operator|=
literal|0
expr_stmt|;
name|driver_arg
operator|=
literal|1
expr_stmt|;
name|single_word_option_value_pair
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|!=
literal|'?'
condition|)
block|{
comment|/* We recognize this option, so it has to be either dllwrap or 	     dlltool option. Do not pass to driver unless it's one of the 	     generic options that are passed to all the tools (such as -v) 	     which are dealt with later. */
name|driver_arg
operator|=
literal|0
expr_stmt|;
block|}
comment|/* deal with generic and dllwrap options first. */
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'h'
case|:
name|usage
argument_list|(
name|stdout
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|verbose
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
name|verbose
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|OPTION_VERSION
case|:
name|print_version
argument_list|(
name|program_name
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'e'
case|:
name|entry_point
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
name|OPTION_IMAGE_BASE
case|:
name|image_base_str
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
name|OPTION_DEF
case|:
name|def_file_name
operator|=
name|optarg
expr_stmt|;
name|def_file_seen
operator|=
literal|1
expr_stmt|;
name|delete_def_file
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|dontdeltemps
operator|=
literal|1
expr_stmt|;
name|dlltool_arg
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
name|dll_file_name
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
case|case
literal|'l'
case|:
case|case
literal|'L'
case|:
name|driver_arg
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|OPTION_DLLNAME
case|:
name|dll_name
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
name|OPTION_DRY_RUN
case|:
name|dry_run
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|OPTION_DRIVER_NAME
case|:
name|driver_name
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
name|OPTION_DRIVER_FLAGS
case|:
name|driver_flags
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
name|OPTION_DLLTOOL_NAME
case|:
name|dlltool_name
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
name|OPTION_TARGET
case|:
name|target
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
name|OPTION_MNO_CYGWIN
case|:
name|target
operator|=
literal|"i386-mingw32"
expr_stmt|;
break|break;
case|case
name|OPTION_BASE_FILE
case|:
name|base_file_name
operator|=
name|optarg
expr_stmt|;
name|delete_base_file
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|OPTION_OUTPUT_EXP
case|:
name|exp_file_name
operator|=
name|optarg
expr_stmt|;
name|delete_exp_file
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|OPTION_EXPORT_ALL_SYMS
case|:
name|export_all
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|OPTION_OUTPUT_LIB
case|:
name|output_lib_file_name
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'?'
case|:
break|break;
default|default:
name|dlltool_arg
operator|=
literal|1
expr_stmt|;
break|break;
block|}
comment|/* Handle passing through --option=value case. */
if|if
condition|(
name|optarg
operator|&&
name|saved_argv
index|[
name|optind
operator|-
literal|1
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
operator|&&
name|saved_argv
index|[
name|optind
operator|-
literal|1
index|]
index|[
literal|1
index|]
operator|==
literal|'-'
operator|&&
name|strchr
argument_list|(
name|saved_argv
index|[
name|optind
operator|-
literal|1
index|]
argument_list|,
literal|'='
argument_list|)
condition|)
name|single_word_option_value_pair
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|dlltool_arg
condition|)
block|{
name|dlltool_arg_indices
index|[
name|optind
operator|-
literal|1
index|]
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|optarg
operator|&&
operator|!
name|single_word_option_value_pair
condition|)
block|{
name|dlltool_arg_indices
index|[
name|optind
operator|-
literal|2
index|]
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|driver_arg
condition|)
block|{
name|driver_arg_indices
index|[
name|optind
operator|-
literal|1
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|optarg
operator|&&
operator|!
name|single_word_option_value_pair
condition|)
block|{
name|driver_arg_indices
index|[
name|optind
operator|-
literal|2
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
comment|/* sanity checks. */
if|if
condition|(
operator|!
name|dll_name
operator|&&
operator|!
name|dll_file_name
condition|)
block|{
name|warn
argument_list|(
name|_
argument_list|(
literal|"Must provide at least one of -o or --dllname options"
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|dll_name
condition|)
block|{
name|dll_name
operator|=
name|xstrdup
argument_list|(
name|mybasename
argument_list|(
name|dll_file_name
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|dll_file_name
condition|)
block|{
name|dll_file_name
operator|=
name|xstrdup
argument_list|(
name|dll_name
argument_list|)
expr_stmt|;
block|}
comment|/* Deduce driver-name and dlltool-name from our own. */
if|if
condition|(
name|driver_name
operator|==
name|NULL
condition|)
name|driver_name
operator|=
name|deduce_name
argument_list|(
literal|"gcc"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlltool_name
operator|==
name|NULL
condition|)
name|dlltool_name
operator|=
name|deduce_name
argument_list|(
literal|"dlltool"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|def_file_seen
condition|)
block|{
name|char
modifier|*
name|fileprefix
init|=
name|choose_temp_base
argument_list|()
decl_stmt|;
name|def_file_name
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|fileprefix
argument_list|)
operator|+
literal|5
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|def_file_name
argument_list|,
literal|"%s.def"
argument_list|,
operator|(
name|dontdeltemps
operator|)
condition|?
name|mybasename
argument_list|(
name|fileprefix
argument_list|)
else|:
name|fileprefix
argument_list|)
expr_stmt|;
name|delete_def_file
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|fileprefix
argument_list|)
expr_stmt|;
name|delete_def_file
operator|=
literal|1
expr_stmt|;
name|warn
argument_list|(
name|_
argument_list|(
literal|"no export definition file provided"
argument_list|)
argument_list|)
expr_stmt|;
name|warn
argument_list|(
name|_
argument_list|(
literal|"creating one, but that may not be what you want"
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* set the target platform. */
if|if
condition|(
name|strstr
argument_list|(
name|target
argument_list|,
literal|"cygwin"
argument_list|)
condition|)
name|which_target
operator|=
name|CYGWIN_TARGET
expr_stmt|;
elseif|else
if|if
condition|(
name|strstr
argument_list|(
name|target
argument_list|,
literal|"mingw"
argument_list|)
condition|)
name|which_target
operator|=
name|MINGW_TARGET
expr_stmt|;
else|else
name|which_target
operator|=
name|UNKNOWN_TARGET
expr_stmt|;
comment|/* re-create the command lines as a string, taking care to quote stuff. */
name|dlltool_cmdline
operator|=
name|dyn_string_new
argument_list|(
name|cmdline_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|dyn_string_append_cstr
argument_list|(
name|dlltool_cmdline
argument_list|,
literal|" -v"
argument_list|)
expr_stmt|;
block|}
name|dyn_string_append_cstr
argument_list|(
name|dlltool_cmdline
argument_list|,
literal|" --dllname "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|dlltool_cmdline
argument_list|,
name|dll_name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|dlltool_arg_indices
index|[
name|i
index|]
condition|)
block|{
name|char
modifier|*
name|arg
init|=
name|saved_argv
index|[
name|i
index|]
decl_stmt|;
name|int
name|quote
init|=
operator|(
name|strchr
argument_list|(
name|arg
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|arg
argument_list|,
literal|'\t'
argument_list|)
operator|)
decl_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|dlltool_cmdline
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|" \""
else|:
literal|" "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|dlltool_cmdline
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|dlltool_cmdline
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
name|driver_cmdline
operator|=
name|dyn_string_new
argument_list|(
name|cmdline_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|driver_flags
operator|||
name|strlen
argument_list|(
name|driver_flags
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|which_target
condition|)
block|{
case|case
name|CYGWIN_TARGET
case|:
name|driver_flags
operator|=
name|cygwin_driver_flags
expr_stmt|;
break|break;
case|case
name|MINGW_TARGET
case|:
name|driver_flags
operator|=
name|mingw32_driver_flags
expr_stmt|;
break|break;
default|default:
name|driver_flags
operator|=
name|generic_driver_flags
expr_stmt|;
break|break;
block|}
block|}
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
name|driver_flags
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
literal|" -o "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
name|dll_file_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|entry_point
operator|||
name|strlen
argument_list|(
name|entry_point
argument_list|)
operator|==
literal|0
condition|)
block|{
switch|switch
condition|(
name|which_target
condition|)
block|{
case|case
name|CYGWIN_TARGET
case|:
name|entry_point
operator|=
literal|"__cygwin_dll_entry@12"
expr_stmt|;
break|break;
case|case
name|MINGW_TARGET
case|:
name|entry_point
operator|=
literal|"_DllMainCRTStartup@12"
expr_stmt|;
break|break;
default|default:
name|entry_point
operator|=
literal|"_DllMain@12"
expr_stmt|;
break|break;
block|}
block|}
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
literal|" -Wl,-e,"
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
name|entry_point
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|dlltool_cmdline
argument_list|,
literal|" --exclude-symbol="
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|dlltool_cmdline
argument_list|,
operator|(
name|entry_point
index|[
literal|0
index|]
operator|==
literal|'_'
operator|)
condition|?
name|entry_point
operator|+
literal|1
else|:
name|entry_point
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|image_base_str
operator|||
name|strlen
argument_list|(
name|image_base_str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|tmpbuf
init|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
literal|"0x12345678"
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
name|unsigned
name|long
name|hash
init|=
name|strhash
argument_list|(
name|dll_file_name
argument_list|)
decl_stmt|;
name|sprintf
argument_list|(
name|tmpbuf
argument_list|,
literal|"0x%.8lX"
argument_list|,
literal|0x60000000
operator||
operator|(
operator|(
name|hash
operator|<<
literal|16
operator|)
operator|&
literal|0xFFC0000
operator|)
argument_list|)
expr_stmt|;
name|image_base_str
operator|=
name|tmpbuf
expr_stmt|;
block|}
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
literal|" -Wl,--image-base,"
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
name|image_base_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
literal|" -v"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|driver_arg_indices
index|[
name|i
index|]
condition|)
block|{
name|char
modifier|*
name|arg
init|=
name|saved_argv
index|[
name|i
index|]
decl_stmt|;
name|int
name|quote
init|=
operator|(
name|strchr
argument_list|(
name|arg
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|arg
argument_list|,
literal|'\t'
argument_list|)
operator|)
decl_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|" \""
else|:
literal|" "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|driver_cmdline
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
comment|/*    * Step pre-1. If no --def<EXPORT_DEF> is specified, then create it    * and then pass it on.    */
if|if
condition|(
operator|!
name|def_file_seen
condition|)
block|{
name|int
name|i
decl_stmt|;
name|dyn_string_t
name|step_pre1
decl_stmt|;
name|step_pre1
operator|=
name|dyn_string_new
argument_list|(
literal|1024
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step_pre1
argument_list|,
name|dlltool_cmdline
operator|->
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|export_all
condition|)
block|{
name|dyn_string_append_cstr
argument_list|(
name|step_pre1
argument_list|,
literal|" --export-all --exclude-symbol="
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step_pre1
argument_list|,
literal|"_cygwin_dll_entry@12,DllMainCRTStartup@12,DllMain@12,DllEntryPoint@12"
argument_list|)
expr_stmt|;
block|}
name|dyn_string_append_cstr
argument_list|(
name|step_pre1
argument_list|,
literal|" --output-def "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step_pre1
argument_list|,
name|def_file_name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|driver_arg_indices
index|[
name|i
index|]
condition|)
block|{
name|char
modifier|*
name|arg
init|=
name|saved_argv
index|[
name|i
index|]
decl_stmt|;
name|size_t
name|len
init|=
name|strlen
argument_list|(
name|arg
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|>=
literal|2
operator|&&
name|arg
index|[
name|len
operator|-
literal|2
index|]
operator|==
literal|'.'
operator|&&
operator|(
name|arg
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'o'
operator|||
name|arg
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'a'
operator|)
condition|)
block|{
name|int
name|quote
init|=
operator|(
name|strchr
argument_list|(
name|arg
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|arg
argument_list|,
literal|'\t'
argument_list|)
operator|)
decl_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step_pre1
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|" \""
else|:
literal|" "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step_pre1
argument_list|,
name|arg
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step_pre1
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|run
argument_list|(
name|dlltool_name
argument_list|,
name|step_pre1
operator|->
name|s
argument_list|)
condition|)
name|cleanup_and_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dyn_string_delete
argument_list|(
name|step_pre1
argument_list|)
expr_stmt|;
block|}
name|dyn_string_append_cstr
argument_list|(
name|dlltool_cmdline
argument_list|,
literal|" --def "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|dlltool_cmdline
argument_list|,
name|def_file_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbose
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|_
argument_list|(
literal|"DLLTOOL name    : %s\n"
argument_list|)
argument_list|,
name|dlltool_name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|_
argument_list|(
literal|"DLLTOOL options : %s\n"
argument_list|)
argument_list|,
name|dlltool_cmdline
operator|->
name|s
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|_
argument_list|(
literal|"DRIVER name     : %s\n"
argument_list|)
argument_list|,
name|driver_name
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
name|_
argument_list|(
literal|"DRIVER options  : %s\n"
argument_list|)
argument_list|,
name|driver_cmdline
operator|->
name|s
argument_list|)
expr_stmt|;
block|}
comment|/*    * Step 1. Call GCC/LD to create base relocation file. If using GCC, the    * driver command line will look like the following:    *        *    % gcc -Wl,--dll --Wl,--base-file,foo.base [rest of command line]    *    * If the user does not specify a base name, create temporary one that    * is deleted at exit.    *    */
if|if
condition|(
operator|!
name|base_file_name
condition|)
block|{
name|char
modifier|*
name|fileprefix
init|=
name|choose_temp_base
argument_list|()
decl_stmt|;
name|base_file_name
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|strlen
argument_list|(
name|fileprefix
argument_list|)
operator|+
literal|6
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|base_file_name
argument_list|,
literal|"%s.base"
argument_list|,
operator|(
name|dontdeltemps
operator|)
condition|?
name|mybasename
argument_list|(
name|fileprefix
argument_list|)
else|:
name|fileprefix
argument_list|)
expr_stmt|;
name|delete_base_file
operator|=
literal|1
expr_stmt|;
name|free
argument_list|(
name|fileprefix
argument_list|)
expr_stmt|;
block|}
block|{
name|int
name|quote
decl_stmt|;
name|dyn_string_t
name|step1
init|=
name|dyn_string_new
argument_list|(
name|driver_cmdline
operator|->
name|length
operator|+
name|strlen
argument_list|(
name|base_file_name
argument_list|)
operator|+
literal|20
argument_list|)
decl_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step1
argument_list|,
literal|"-Wl,--base-file,"
argument_list|)
expr_stmt|;
name|quote
operator|=
operator|(
name|strchr
argument_list|(
name|base_file_name
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|base_file_name
argument_list|,
literal|'\t'
argument_list|)
operator|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step1
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step1
argument_list|,
name|base_file_name
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step1
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|driver_cmdline
operator|->
name|length
condition|)
block|{
name|dyn_string_append_cstr
argument_list|(
name|step1
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step1
argument_list|,
name|driver_cmdline
operator|->
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|run
argument_list|(
name|driver_name
argument_list|,
name|step1
operator|->
name|s
argument_list|)
condition|)
name|cleanup_and_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dyn_string_delete
argument_list|(
name|step1
argument_list|)
expr_stmt|;
block|}
comment|/*    * Step 2. generate the exp file by running dlltool.     * dlltool command line will look like the following:    *        *    % dlltool -Wl,--dll --Wl,--base-file,foo.base [rest of command line]    *    * If the user does not specify a base name, create temporary one that    * is deleted at exit.    *    */
if|if
condition|(
operator|!
name|exp_file_name
condition|)
block|{
name|char
modifier|*
name|p
init|=
name|strrchr
argument_list|(
name|dll_name
argument_list|,
literal|'.'
argument_list|)
decl_stmt|;
name|size_t
name|prefix_len
init|=
operator|(
name|p
operator|)
condition|?
name|p
operator|-
name|dll_name
else|:
name|strlen
argument_list|(
name|dll_name
argument_list|)
decl_stmt|;
name|exp_file_name
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|prefix_len
operator|+
literal|4
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|exp_file_name
argument_list|,
name|dll_name
argument_list|,
name|prefix_len
argument_list|)
expr_stmt|;
name|exp_file_name
index|[
name|prefix_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|strcat
argument_list|(
name|exp_file_name
argument_list|,
literal|".exp"
argument_list|)
expr_stmt|;
name|delete_exp_file
operator|=
literal|1
expr_stmt|;
block|}
block|{
name|int
name|quote
decl_stmt|;
name|dyn_string_t
name|step2
init|=
name|dyn_string_new
argument_list|(
name|dlltool_cmdline
operator|->
name|length
operator|+
name|strlen
argument_list|(
name|base_file_name
argument_list|)
operator|+
name|strlen
argument_list|(
name|exp_file_name
argument_list|)
operator|+
literal|20
argument_list|)
decl_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step2
argument_list|,
literal|"--base-file "
argument_list|)
expr_stmt|;
name|quote
operator|=
operator|(
name|strchr
argument_list|(
name|base_file_name
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|base_file_name
argument_list|,
literal|'\t'
argument_list|)
operator|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step2
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step2
argument_list|,
name|base_file_name
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step2
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\" "
else|:
literal|" "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step2
argument_list|,
literal|"--output-exp "
argument_list|)
expr_stmt|;
name|quote
operator|=
operator|(
name|strchr
argument_list|(
name|exp_file_name
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|exp_file_name
argument_list|,
literal|'\t'
argument_list|)
operator|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step2
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step2
argument_list|,
name|exp_file_name
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step2
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlltool_cmdline
operator|->
name|length
condition|)
block|{
name|dyn_string_append_cstr
argument_list|(
name|step2
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step2
argument_list|,
name|dlltool_cmdline
operator|->
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|run
argument_list|(
name|dlltool_name
argument_list|,
name|step2
operator|->
name|s
argument_list|)
condition|)
name|cleanup_and_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dyn_string_delete
argument_list|(
name|step2
argument_list|)
expr_stmt|;
block|}
comment|/*    * Step 3. Call GCC/LD to again, adding the exp file this time.    * driver command line will look like the following:    *        *    % gcc -Wl,--dll --Wl,--base-file,foo.base foo.exp [rest ...]    */
block|{
name|int
name|quote
decl_stmt|;
name|dyn_string_t
name|step3
init|=
name|dyn_string_new
argument_list|(
name|driver_cmdline
operator|->
name|length
operator|+
name|strlen
argument_list|(
name|exp_file_name
argument_list|)
operator|+
name|strlen
argument_list|(
name|base_file_name
argument_list|)
operator|+
literal|20
argument_list|)
decl_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step3
argument_list|,
literal|"-Wl,--base-file,"
argument_list|)
expr_stmt|;
name|quote
operator|=
operator|(
name|strchr
argument_list|(
name|base_file_name
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|base_file_name
argument_list|,
literal|'\t'
argument_list|)
operator|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step3
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step3
argument_list|,
name|base_file_name
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step3
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\" "
else|:
literal|" "
argument_list|)
expr_stmt|;
name|quote
operator|=
operator|(
name|strchr
argument_list|(
name|exp_file_name
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|exp_file_name
argument_list|,
literal|'\t'
argument_list|)
operator|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step3
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step3
argument_list|,
name|exp_file_name
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step3
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|driver_cmdline
operator|->
name|length
condition|)
block|{
name|dyn_string_append_cstr
argument_list|(
name|step3
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step3
argument_list|,
name|driver_cmdline
operator|->
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|run
argument_list|(
name|driver_name
argument_list|,
name|step3
operator|->
name|s
argument_list|)
condition|)
name|cleanup_and_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dyn_string_delete
argument_list|(
name|step3
argument_list|)
expr_stmt|;
block|}
comment|/*    * Step 4. Run DLLTOOL again using the same command line.    */
block|{
name|int
name|quote
decl_stmt|;
name|dyn_string_t
name|step4
init|=
name|dyn_string_new
argument_list|(
name|dlltool_cmdline
operator|->
name|length
operator|+
name|strlen
argument_list|(
name|base_file_name
argument_list|)
operator|+
name|strlen
argument_list|(
name|exp_file_name
argument_list|)
operator|+
literal|20
argument_list|)
decl_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
literal|"--base-file "
argument_list|)
expr_stmt|;
name|quote
operator|=
operator|(
name|strchr
argument_list|(
name|base_file_name
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|base_file_name
argument_list|,
literal|'\t'
argument_list|)
operator|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
name|base_file_name
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\" "
else|:
literal|" "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
literal|"--output-exp "
argument_list|)
expr_stmt|;
name|quote
operator|=
operator|(
name|strchr
argument_list|(
name|exp_file_name
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|exp_file_name
argument_list|,
literal|'\t'
argument_list|)
operator|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
name|exp_file_name
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|dlltool_cmdline
operator|->
name|length
condition|)
block|{
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
name|dlltool_cmdline
operator|->
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|output_lib_file_name
condition|)
block|{
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
literal|" --output-lib "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step4
argument_list|,
name|output_lib_file_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|run
argument_list|(
name|dlltool_name
argument_list|,
name|step4
operator|->
name|s
argument_list|)
condition|)
name|cleanup_and_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dyn_string_delete
argument_list|(
name|step4
argument_list|)
expr_stmt|;
block|}
comment|/*    * Step 5. Link it all together and be done with it.    * driver command line will look like the following:    *        *    % gcc -Wl,--dll foo.exp [rest ...]    *    */
block|{
name|int
name|quote
decl_stmt|;
name|dyn_string_t
name|step5
init|=
name|dyn_string_new
argument_list|(
name|driver_cmdline
operator|->
name|length
operator|+
name|strlen
argument_list|(
name|exp_file_name
argument_list|)
operator|+
literal|20
argument_list|)
decl_stmt|;
name|quote
operator|=
operator|(
name|strchr
argument_list|(
name|exp_file_name
argument_list|,
literal|' '
argument_list|)
operator|||
name|strchr
argument_list|(
name|exp_file_name
argument_list|,
literal|'\t'
argument_list|)
operator|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step5
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step5
argument_list|,
name|exp_file_name
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step5
argument_list|,
operator|(
name|quote
operator|)
condition|?
literal|"\""
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|driver_cmdline
operator|->
name|length
condition|)
block|{
name|dyn_string_append_cstr
argument_list|(
name|step5
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|dyn_string_append_cstr
argument_list|(
name|step5
argument_list|,
name|driver_cmdline
operator|->
name|s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|run
argument_list|(
name|driver_name
argument_list|,
name|step5
operator|->
name|s
argument_list|)
condition|)
name|cleanup_and_exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dyn_string_delete
argument_list|(
name|step5
argument_list|)
expr_stmt|;
block|}
name|cleanup_and_exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|"testutil.h"
end_include

begin_include
include|#
directive|include
file|"apr_general.h"
end_include

begin_include
include|#
directive|include
file|"apr_strings.h"
end_include

begin_include
include|#
directive|include
file|"apr_uri.h"
end_include

begin_struct
struct|struct
name|aup_test
block|{
specifier|const
name|char
modifier|*
name|uri
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
specifier|const
name|char
modifier|*
name|scheme
decl_stmt|;
specifier|const
name|char
modifier|*
name|hostinfo
decl_stmt|;
specifier|const
name|char
modifier|*
name|user
decl_stmt|;
specifier|const
name|char
modifier|*
name|password
decl_stmt|;
specifier|const
name|char
modifier|*
name|hostname
decl_stmt|;
specifier|const
name|char
modifier|*
name|port_str
decl_stmt|;
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
specifier|const
name|char
modifier|*
name|query
decl_stmt|;
specifier|const
name|char
modifier|*
name|fragment
decl_stmt|;
name|apr_port_t
name|port
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|aup_test
name|aup_tests
index|[]
init|=
block|{
block|{
literal|"http://[/::1]/index.html"
block|,
name|APR_EGENERAL
block|}
block|,
block|{
literal|"http://["
block|,
name|APR_EGENERAL
block|}
block|,
block|{
literal|"http://[?::1]/index.html"
block|,
name|APR_EGENERAL
block|}
block|,
block|{
literal|"http://127.0.0.1:9999/asdf.html"
block|,
literal|0
block|,
literal|"http"
block|,
literal|"127.0.0.1:9999"
block|,
name|NULL
block|,
name|NULL
block|,
literal|"127.0.0.1"
block|,
literal|"9999"
block|,
literal|"/asdf.html"
block|,
name|NULL
block|,
name|NULL
block|,
literal|9999
block|}
block|,
block|{
literal|"http://127.0.0.1:9999a/asdf.html"
block|,
name|APR_EGENERAL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"http://[::127.0.0.1]:9999/asdf.html"
block|,
literal|0
block|,
literal|"http"
block|,
literal|"[::127.0.0.1]:9999"
block|,
name|NULL
block|,
name|NULL
block|,
literal|"::127.0.0.1"
block|,
literal|"9999"
block|,
literal|"/asdf.html"
block|,
name|NULL
block|,
name|NULL
block|,
literal|9999
block|}
block|,
block|{
literal|"http://[::127.0.0.1]:9999a/asdf.html"
block|,
name|APR_EGENERAL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"/error/include/top.html"
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"/error/include/top.html"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"/error/include/../contact.html.var"
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"/error/include/../contact.html.var"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"/"
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"/"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"/manual/"
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"/manual/"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"/cocoon/developing/graphics/Using%20Databases-label_over.jpg"
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"/cocoon/developing/graphics/Using%20Databases-label_over.jpg"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"http://sonyamt:garbage@127.0.0.1/filespace/"
block|,
literal|0
block|,
literal|"http"
block|,
literal|"sonyamt:garbage@127.0.0.1"
block|,
literal|"sonyamt"
block|,
literal|"garbage"
block|,
literal|"127.0.0.1"
block|,
name|NULL
block|,
literal|"/filespace/"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"http://sonyamt:garbage@[fe80::1]/filespace/"
block|,
literal|0
block|,
literal|"http"
block|,
literal|"sonyamt:garbage@[fe80::1]"
block|,
literal|"sonyamt"
block|,
literal|"garbage"
block|,
literal|"fe80::1"
block|,
name|NULL
block|,
literal|"/filespace/"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"http://sonyamt@[fe80::1]/filespace/?arg1=store"
block|,
literal|0
block|,
literal|"http"
block|,
literal|"sonyamt@[fe80::1]"
block|,
literal|"sonyamt"
block|,
name|NULL
block|,
literal|"fe80::1"
block|,
name|NULL
block|,
literal|"/filespace/"
block|,
literal|"arg1=store"
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"http://localhost"
block|,
literal|0
block|,
literal|"http"
block|,
literal|"localhost"
block|,
name|NULL
block|,
name|NULL
block|,
literal|"localhost"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"//www.apache.org/"
block|,
literal|0
block|,
name|NULL
block|,
literal|"www.apache.org"
block|,
name|NULL
block|,
name|NULL
block|,
literal|"www.apache.org"
block|,
name|NULL
block|,
literal|"/"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"file:image.jpg"
block|,
literal|0
block|,
literal|"file"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"image.jpg"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"file:/image.jpg"
block|,
literal|0
block|,
literal|"file"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"/image.jpg"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"file:///image.jpg"
block|,
literal|0
block|,
literal|"file"
block|,
literal|""
block|,
name|NULL
block|,
name|NULL
block|,
literal|""
block|,
name|NULL
block|,
literal|"/image.jpg"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"file:///tmp/photos/image.jpg"
block|,
literal|0
block|,
literal|"file"
block|,
literal|""
block|,
name|NULL
block|,
name|NULL
block|,
literal|""
block|,
name|NULL
block|,
literal|"/tmp/photos/image.jpg"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"file:./image.jpg"
block|,
literal|0
block|,
literal|"file"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"./image.jpg"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"file:../photos/image.jpg"
block|,
literal|0
block|,
literal|"file"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
literal|"../photos/image.jpg"
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|uph_test
block|{
specifier|const
name|char
modifier|*
name|hostinfo
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
specifier|const
name|char
modifier|*
name|hostname
decl_stmt|;
specifier|const
name|char
modifier|*
name|port_str
decl_stmt|;
name|apr_port_t
name|port
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|uph_test
name|uph_tests
index|[]
init|=
block|{
block|{
literal|"www.ibm.com:443"
block|,
literal|0
block|,
literal|"www.ibm.com"
block|,
literal|"443"
block|,
literal|443
block|}
block|,
block|{
literal|"[fe80::1]:443"
block|,
literal|0
block|,
literal|"fe80::1"
block|,
literal|"443"
block|,
literal|443
block|}
block|,
block|{
literal|"127.0.0.1:443"
block|,
literal|0
block|,
literal|"127.0.0.1"
block|,
literal|"443"
block|,
literal|443
block|}
block|,
block|{
literal|"127.0.0.1"
block|,
name|APR_EGENERAL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"[fe80:80"
block|,
name|APR_EGENERAL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|,
block|{
literal|"fe80::80]:443"
block|,
name|APR_EGENERAL
block|,
name|NULL
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
literal|0
end_if

begin_endif
unit|static void show_info(apr_status_t rv, apr_status_t expected, const apr_uri_t *info) {     if (rv != expected) {         fprintf(stderr, "  actual rv: %d    expected rv:  %d\n", rv, expected);     }     else {         fprintf(stderr,                  "  scheme:           %s\n"                 "  hostinfo:         %s\n"                 "  user:             %s\n"                 "  password:         %s\n"                 "  hostname:         %s\n"                 "  port_str:         %s\n"                 "  path:             %s\n"                 "  query:            %s\n"                 "  fragment:         %s\n"                 "  hostent:          %p\n"                 "  port:             %u\n"                 "  is_initialized:   %u\n"                 "  dns_looked_up:    %u\n"                 "  dns_resolved:     %u\n",                 info->scheme, info->hostinfo, info->user, info->password,                 info->hostname, info->port_str, info->path, info->query,                 info->fragment, info->hostent, info->port, info->is_initialized,                 info->dns_looked_up, info->dns_resolved);     } }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|test_aup
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
name|apr_uri_t
name|info
decl_stmt|;
name|struct
name|aup_test
modifier|*
name|t
decl_stmt|;
specifier|const
name|char
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|aup_tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|aup_tests
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|char
name|msg
index|[
literal|256
index|]
decl_stmt|;
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
operator|&
name|aup_tests
index|[
name|i
index|]
expr_stmt|;
name|rv
operator|=
name|apr_uri_parse
argument_list|(
name|p
argument_list|,
name|t
operator|->
name|uri
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
name|apr_snprintf
argument_list|(
name|msg
argument_list|,
sizeof|sizeof
name|msg
argument_list|,
literal|"uri '%s': rv=%d not %d"
argument_list|,
name|t
operator|->
name|uri
argument_list|,
name|rv
argument_list|,
name|t
operator|->
name|rv
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
name|msg
argument_list|,
name|rv
operator|==
name|t
operator|->
name|rv
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|rv
operator|==
name|APR_SUCCESS
condition|)
block|{
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|scheme
argument_list|,
name|info
operator|.
name|scheme
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|hostinfo
argument_list|,
name|info
operator|.
name|hostinfo
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|user
argument_list|,
name|info
operator|.
name|user
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|password
argument_list|,
name|info
operator|.
name|password
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|hostname
argument_list|,
name|info
operator|.
name|hostname
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|port_str
argument_list|,
name|info
operator|.
name|port_str
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|path
argument_list|,
name|info
operator|.
name|path
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|query
argument_list|,
name|info
operator|.
name|query
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|user
argument_list|,
name|info
operator|.
name|user
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|port
argument_list|,
name|info
operator|.
name|port
argument_list|)
expr_stmt|;
name|s
operator|=
name|apr_uri_unparse
argument_list|(
name|p
argument_list|,
operator|&
name|info
argument_list|,
name|APR_URI_UNP_REVEALPASSWORD
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|uri
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
name|apr_uri_unparse
argument_list|(
name|p
argument_list|,
operator|&
name|info
argument_list|,
name|APR_URI_UNP_OMITSITEPART
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_uri_parse
argument_list|(
name|p
argument_list|,
name|s
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|info
operator|.
name|scheme
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|info
operator|.
name|hostinfo
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|info
operator|.
name|user
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|info
operator|.
name|password
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|info
operator|.
name|hostname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|info
operator|.
name|port_str
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|info
operator|.
name|path
argument_list|,
name|t
operator|->
name|path
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|info
operator|.
name|query
argument_list|,
name|t
operator|->
name|query
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|info
operator|.
name|user
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|info
operator|.
name|port
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|test_uph
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
name|apr_uri_t
name|info
decl_stmt|;
name|struct
name|uph_test
modifier|*
name|t
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|uph_tests
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|uph_tests
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|memset
argument_list|(
operator|&
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|info
argument_list|)
argument_list|)
expr_stmt|;
name|t
operator|=
operator|&
name|uph_tests
index|[
name|i
index|]
expr_stmt|;
name|rv
operator|=
name|apr_uri_parse_hostinfo
argument_list|(
name|p
argument_list|,
name|t
operator|->
name|hostinfo
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|rv
argument_list|,
name|rv
argument_list|)
expr_stmt|;
if|if
condition|(
name|t
operator|->
name|rv
operator|==
name|APR_SUCCESS
condition|)
block|{
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|hostname
argument_list|,
name|info
operator|.
name|hostname
argument_list|)
expr_stmt|;
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|port_str
argument_list|,
name|info
operator|.
name|port_str
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
name|t
operator|->
name|port
argument_list|,
name|info
operator|.
name|port
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|abts_suite
modifier|*
name|testuri
parameter_list|(
name|abts_suite
modifier|*
name|suite
parameter_list|)
block|{
name|suite
operator|=
name|ADD_SUITE
argument_list|(
name|suite
argument_list|)
expr_stmt|;
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_aup
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_uph
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|suite
return|;
block|}
end_function

end_unit


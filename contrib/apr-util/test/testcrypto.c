begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|"testutil.h"
end_include

begin_include
include|#
directive|include
file|"apr.h"
end_include

begin_include
include|#
directive|include
file|"apu.h"
end_include

begin_include
include|#
directive|include
file|"apu_errno.h"
end_include

begin_include
include|#
directive|include
file|"apr_pools.h"
end_include

begin_include
include|#
directive|include
file|"apr_dso.h"
end_include

begin_include
include|#
directive|include
file|"apr_crypto.h"
end_include

begin_include
include|#
directive|include
file|"apr_strings.h"
end_include

begin_if
if|#
directive|if
name|APU_HAVE_CRYPTO
end_if

begin_define
define|#
directive|define
name|TEST_STRING
value|"12345"
end_define

begin_define
define|#
directive|define
name|ALIGNED_STRING
value|"123456789012345"
end_define

begin_function
specifier|static
specifier|const
name|apr_crypto_driver_t
modifier|*
name|get_driver
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|)
block|{
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver
init|=
name|NULL
decl_stmt|;
specifier|const
name|apu_err_t
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
name|rv
operator|=
name|apr_crypto_init
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"failed to init apr_crypto"
argument_list|,
name|rv
operator|==
name|APR_SUCCESS
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_crypto_get_driver
argument_list|(
operator|&
name|driver
argument_list|,
name|name
argument_list|,
name|params
argument_list|,
operator|&
name|err
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|APR_SUCCESS
operator|!=
name|rv
operator|&&
name|err
condition|)
block|{
name|ABTS_NOT_IMPL
argument_list|(
name|tc
argument_list|,
name|err
operator|->
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|APR_ENOTIMPL
operator|==
name|rv
condition|)
block|{
name|ABTS_NOT_IMPL
argument_list|(
name|tc
argument_list|,
operator|(
name|char
operator|*
operator|)
name|driver
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"failed to apr_crypto_get_driver"
argument_list|,
name|rv
operator|==
name|APR_SUCCESS
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_get_driver returned NULL"
argument_list|,
name|driver
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|driver
operator|||
name|rv
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|driver
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|apr_crypto_driver_t
modifier|*
name|get_nss_driver
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
comment|/* initialise NSS */
return|return
name|get_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
literal|"nss"
argument_list|,
literal|"dir=data"
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|apr_crypto_driver_t
modifier|*
name|get_openssl_driver
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
return|return
name|get_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
literal|"openssl"
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_crypto_t
modifier|*
name|make
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver
parameter_list|)
block|{
name|apr_crypto_t
modifier|*
name|f
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|driver
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* get the context */
name|apr_crypto_make
argument_list|(
operator|&
name|f
argument_list|,
name|driver
argument_list|,
literal|"engine=openssl"
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_make returned NULL"
argument_list|,
name|f
operator|!=
name|NULL
argument_list|)
expr_stmt|;
return|return
name|f
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|apr_crypto_key_t
modifier|*
name|passphrase
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver
parameter_list|,
specifier|const
name|apr_crypto_t
modifier|*
name|f
parameter_list|,
name|apr_crypto_block_key_type_e
name|type
parameter_list|,
name|apr_crypto_block_key_mode_e
name|mode
parameter_list|,
name|int
name|doPad
parameter_list|,
specifier|const
name|char
modifier|*
name|description
parameter_list|)
block|{
name|apr_crypto_key_t
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
specifier|const
name|apu_err_t
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|pass
init|=
literal|"secret"
decl_stmt|;
specifier|const
name|char
modifier|*
name|salt
init|=
literal|"salt"
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* init the passphrase */
name|rv
operator|=
name|apr_crypto_passphrase
argument_list|(
operator|&
name|key
argument_list|,
name|NULL
argument_list|,
name|pass
argument_list|,
name|strlen
argument_list|(
name|pass
argument_list|)
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|salt
argument_list|,
name|strlen
argument_list|(
name|salt
argument_list|)
argument_list|,
name|type
argument_list|,
name|mode
argument_list|,
name|doPad
argument_list|,
literal|4096
argument_list|,
name|f
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|APR_ENOCIPHER
operator|==
name|rv
condition|)
block|{
name|apr_crypto_error
argument_list|(
operator|&
name|result
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|ABTS_NOT_IMPL
argument_list|(
name|tc
argument_list|,
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"skipped: %s %s passphrase return APR_ENOCIPHER: error %d: %s (%s)\n"
argument_list|,
name|description
argument_list|,
name|apr_crypto_driver_name
argument_list|(
name|driver
argument_list|)
argument_list|,
name|result
operator|->
name|rc
argument_list|,
name|result
operator|->
name|reason
condition|?
name|result
operator|->
name|reason
else|:
literal|""
argument_list|,
name|result
operator|->
name|msg
condition|?
name|result
operator|->
name|msg
else|:
literal|""
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
if|if
condition|(
name|APR_SUCCESS
operator|!=
name|rv
condition|)
block|{
name|apr_crypto_error
argument_list|(
operator|&
name|result
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"passphrase: %s %s native error %d: %s (%s)\n"
argument_list|,
name|description
argument_list|,
name|apr_crypto_driver_name
argument_list|(
name|driver
argument_list|)
argument_list|,
name|result
operator|->
name|rc
argument_list|,
name|result
operator|->
name|reason
condition|?
name|result
operator|->
name|reason
else|:
literal|""
argument_list|,
name|result
operator|->
name|msg
condition|?
name|result
operator|->
name|msg
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_passphrase returned APR_ENOKEY"
argument_list|,
name|rv
operator|!=
name|APR_ENOKEY
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_passphrase returned APR_EPADDING"
argument_list|,
name|rv
operator|!=
name|APR_EPADDING
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_passphrase returned APR_EKEYTYPE"
argument_list|,
name|rv
operator|!=
name|APR_EKEYTYPE
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"failed to apr_crypto_passphrase"
argument_list|,
name|rv
operator|==
name|APR_SUCCESS
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_passphrase returned NULL context"
argument_list|,
name|key
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rv
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|key
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|encrypt_block
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver
parameter_list|,
specifier|const
name|apr_crypto_t
modifier|*
name|f
parameter_list|,
specifier|const
name|apr_crypto_key_t
modifier|*
name|key
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
specifier|const
name|apr_size_t
name|inlen
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|cipherText
parameter_list|,
name|apr_size_t
modifier|*
name|cipherTextLen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
modifier|*
name|iv
parameter_list|,
name|apr_size_t
modifier|*
name|blockSize
parameter_list|,
specifier|const
name|char
modifier|*
name|description
parameter_list|)
block|{
name|apr_crypto_block_t
modifier|*
name|block
init|=
name|NULL
decl_stmt|;
specifier|const
name|apu_err_t
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|apr_size_t
name|len
init|=
literal|0
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
if|if
condition|(
operator|!
name|driver
operator|||
operator|!
name|f
operator|||
operator|!
name|key
operator|||
operator|!
name|in
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* init the encryption */
name|rv
operator|=
name|apr_crypto_block_encrypt_init
argument_list|(
operator|&
name|block
argument_list|,
name|iv
argument_list|,
name|key
argument_list|,
name|blockSize
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|APR_ENOTIMPL
operator|==
name|rv
condition|)
block|{
name|ABTS_NOT_IMPL
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_encrypt_init returned APR_ENOTIMPL"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|APR_SUCCESS
operator|!=
name|rv
condition|)
block|{
name|apr_crypto_error
argument_list|(
operator|&
name|result
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"encrypt_init: %s %s native error %d: %s (%s)\n"
argument_list|,
name|description
argument_list|,
name|apr_crypto_driver_name
argument_list|(
name|driver
argument_list|)
argument_list|,
name|result
operator|->
name|rc
argument_list|,
name|result
operator|->
name|reason
condition|?
name|result
operator|->
name|reason
else|:
literal|""
argument_list|,
name|result
operator|->
name|msg
condition|?
name|result
operator|->
name|msg
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_encrypt_init returned APR_ENOKEY"
argument_list|,
name|rv
operator|!=
name|APR_ENOKEY
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_encrypt_init returned APR_ENOIV"
argument_list|,
name|rv
operator|!=
name|APR_ENOIV
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_encrypt_init returned APR_EKEYTYPE"
argument_list|,
name|rv
operator|!=
name|APR_EKEYTYPE
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_encrypt_init returned APR_EKEYLENGTH"
argument_list|,
name|rv
operator|!=
name|APR_EKEYLENGTH
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"failed to apr_crypto_block_encrypt_init"
argument_list|,
name|rv
operator|==
name|APR_SUCCESS
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_encrypt_init returned NULL context"
argument_list|,
name|block
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|block
operator|||
name|rv
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* encrypt the block */
name|rv
operator|=
name|apr_crypto_block_encrypt
argument_list|(
name|cipherText
argument_list|,
name|cipherTextLen
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
name|block
argument_list|)
expr_stmt|;
if|if
condition|(
name|APR_SUCCESS
operator|!=
name|rv
condition|)
block|{
name|apr_crypto_error
argument_list|(
operator|&
name|result
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"encrypt: %s %s native error %d: %s (%s)\n"
argument_list|,
name|description
argument_list|,
name|apr_crypto_driver_name
argument_list|(
name|driver
argument_list|)
argument_list|,
name|result
operator|->
name|rc
argument_list|,
name|result
operator|->
name|reason
condition|?
name|result
operator|->
name|reason
else|:
literal|""
argument_list|,
name|result
operator|->
name|msg
condition|?
name|result
operator|->
name|msg
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_encrypt returned APR_ECRYPT"
argument_list|,
name|rv
operator|!=
name|APR_ECRYPT
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"failed to apr_crypto_block_encrypt"
argument_list|,
name|rv
operator|==
name|APR_SUCCESS
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_encrypt failed to allocate buffer"
argument_list|,
operator|*
name|cipherText
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* finalise the encryption */
name|rv
operator|=
name|apr_crypto_block_encrypt_finish
argument_list|(
operator|*
name|cipherText
operator|+
operator|*
name|cipherTextLen
argument_list|,
operator|&
name|len
argument_list|,
name|block
argument_list|)
expr_stmt|;
if|if
condition|(
name|APR_SUCCESS
operator|!=
name|rv
condition|)
block|{
name|apr_crypto_error
argument_list|(
operator|&
name|result
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"encrypt_finish: %s %s native error %d: %s (%s)\n"
argument_list|,
name|description
argument_list|,
name|apr_crypto_driver_name
argument_list|(
name|driver
argument_list|)
argument_list|,
name|result
operator|->
name|rc
argument_list|,
name|result
operator|->
name|reason
condition|?
name|result
operator|->
name|reason
else|:
literal|""
argument_list|,
name|result
operator|->
name|msg
condition|?
name|result
operator|->
name|msg
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_encrypt_finish returned APR_ECRYPT"
argument_list|,
name|rv
operator|!=
name|APR_ECRYPT
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_encrypt_finish returned APR_EPADDING"
argument_list|,
name|rv
operator|!=
name|APR_EPADDING
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"failed to apr_crypto_block_encrypt_finish"
argument_list|,
name|rv
operator|==
name|APR_SUCCESS
argument_list|)
expr_stmt|;
operator|*
name|cipherTextLen
operator|+=
name|len
expr_stmt|;
name|apr_crypto_block_cleanup
argument_list|(
name|block
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
operator|*
name|cipherText
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|decrypt_block
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver
parameter_list|,
specifier|const
name|apr_crypto_t
modifier|*
name|f
parameter_list|,
specifier|const
name|apr_crypto_key_t
modifier|*
name|key
parameter_list|,
name|unsigned
name|char
modifier|*
name|cipherText
parameter_list|,
name|apr_size_t
name|cipherTextLen
parameter_list|,
name|unsigned
name|char
modifier|*
modifier|*
name|plainText
parameter_list|,
name|apr_size_t
modifier|*
name|plainTextLen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|iv
parameter_list|,
name|apr_size_t
modifier|*
name|blockSize
parameter_list|,
specifier|const
name|char
modifier|*
name|description
parameter_list|)
block|{
name|apr_crypto_block_t
modifier|*
name|block
init|=
name|NULL
decl_stmt|;
specifier|const
name|apu_err_t
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|apr_size_t
name|len
init|=
literal|0
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
if|if
condition|(
operator|!
name|driver
operator|||
operator|!
name|f
operator|||
operator|!
name|key
operator|||
operator|!
name|cipherText
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* init the decryption */
name|rv
operator|=
name|apr_crypto_block_decrypt_init
argument_list|(
operator|&
name|block
argument_list|,
name|blockSize
argument_list|,
name|iv
argument_list|,
name|key
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|APR_ENOTIMPL
operator|==
name|rv
condition|)
block|{
name|ABTS_NOT_IMPL
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_decrypt_init returned APR_ENOTIMPL"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|APR_SUCCESS
operator|!=
name|rv
condition|)
block|{
name|apr_crypto_error
argument_list|(
operator|&
name|result
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"decrypt_init: %s %s native error %d: %s (%s)\n"
argument_list|,
name|description
argument_list|,
name|apr_crypto_driver_name
argument_list|(
name|driver
argument_list|)
argument_list|,
name|result
operator|->
name|rc
argument_list|,
name|result
operator|->
name|reason
condition|?
name|result
operator|->
name|reason
else|:
literal|""
argument_list|,
name|result
operator|->
name|msg
condition|?
name|result
operator|->
name|msg
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_decrypt_init returned APR_ENOKEY"
argument_list|,
name|rv
operator|!=
name|APR_ENOKEY
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_decrypt_init returned APR_ENOIV"
argument_list|,
name|rv
operator|!=
name|APR_ENOIV
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_decrypt_init returned APR_EKEYTYPE"
argument_list|,
name|rv
operator|!=
name|APR_EKEYTYPE
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_decrypt_init returned APR_EKEYLENGTH"
argument_list|,
name|rv
operator|!=
name|APR_EKEYLENGTH
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"failed to apr_crypto_block_decrypt_init"
argument_list|,
name|rv
operator|==
name|APR_SUCCESS
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_decrypt_init returned NULL context"
argument_list|,
name|block
operator|!=
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|block
operator|||
name|rv
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* decrypt the block */
name|rv
operator|=
name|apr_crypto_block_decrypt
argument_list|(
name|plainText
argument_list|,
name|plainTextLen
argument_list|,
name|cipherText
argument_list|,
name|cipherTextLen
argument_list|,
name|block
argument_list|)
expr_stmt|;
if|if
condition|(
name|APR_SUCCESS
operator|!=
name|rv
condition|)
block|{
name|apr_crypto_error
argument_list|(
operator|&
name|result
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"decrypt: %s %s native error %d: %s (%s)\n"
argument_list|,
name|description
argument_list|,
name|apr_crypto_driver_name
argument_list|(
name|driver
argument_list|)
argument_list|,
name|result
operator|->
name|rc
argument_list|,
name|result
operator|->
name|reason
condition|?
name|result
operator|->
name|reason
else|:
literal|""
argument_list|,
name|result
operator|->
name|msg
condition|?
name|result
operator|->
name|msg
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_decrypt returned APR_ECRYPT"
argument_list|,
name|rv
operator|!=
name|APR_ECRYPT
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"failed to apr_crypto_block_decrypt"
argument_list|,
name|rv
operator|==
name|APR_SUCCESS
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_decrypt failed to allocate buffer"
argument_list|,
operator|*
name|plainText
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
return|return
name|NULL
return|;
block|}
comment|/* finalise the decryption */
name|rv
operator|=
name|apr_crypto_block_decrypt_finish
argument_list|(
operator|*
name|plainText
operator|+
operator|*
name|plainTextLen
argument_list|,
operator|&
name|len
argument_list|,
name|block
argument_list|)
expr_stmt|;
if|if
condition|(
name|APR_SUCCESS
operator|!=
name|rv
condition|)
block|{
name|apr_crypto_error
argument_list|(
operator|&
name|result
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"decrypt_finish: %s %s native error %d: %s (%s)\n"
argument_list|,
name|description
argument_list|,
name|apr_crypto_driver_name
argument_list|(
name|driver
argument_list|)
argument_list|,
name|result
operator|->
name|rc
argument_list|,
name|result
operator|->
name|reason
condition|?
name|result
operator|->
name|reason
else|:
literal|""
argument_list|,
name|result
operator|->
name|msg
condition|?
name|result
operator|->
name|msg
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_decrypt_finish returned APR_ECRYPT"
argument_list|,
name|rv
operator|!=
name|APR_ECRYPT
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"apr_crypto_block_decrypt_finish returned APR_EPADDING"
argument_list|,
name|rv
operator|!=
name|APR_EPADDING
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"failed to apr_crypto_block_decrypt_finish"
argument_list|,
name|rv
operator|==
name|APR_SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
condition|)
block|{
return|return
name|NULL
return|;
block|}
operator|*
name|plainTextLen
operator|+=
name|len
expr_stmt|;
name|apr_crypto_block_cleanup
argument_list|(
name|block
argument_list|)
expr_stmt|;
return|return
operator|*
name|plainText
return|;
block|}
end_function

begin_comment
comment|/**  * Interoperability test.  *  * data must point at an array of two driver structures. Data will be encrypted  * with the first driver, and decrypted with the second.  *  * If the two drivers interoperate, the test passes.  */
end_comment

begin_function
specifier|static
name|void
name|crypto_block_cross
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|apr_crypto_driver_t
modifier|*
modifier|*
name|drivers
parameter_list|,
specifier|const
name|apr_crypto_block_key_type_e
name|type
parameter_list|,
specifier|const
name|apr_crypto_block_key_mode_e
name|mode
parameter_list|,
name|int
name|doPad
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|in
parameter_list|,
name|apr_size_t
name|inlen
parameter_list|,
specifier|const
name|char
modifier|*
name|description
parameter_list|)
block|{
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver1
init|=
name|drivers
index|[
literal|0
index|]
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver2
init|=
name|drivers
index|[
literal|1
index|]
decl_stmt|;
name|apr_crypto_t
modifier|*
name|f1
init|=
name|NULL
decl_stmt|;
name|apr_crypto_t
modifier|*
name|f2
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_key_t
modifier|*
name|key1
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_key_t
modifier|*
name|key2
init|=
name|NULL
decl_stmt|;
name|unsigned
name|char
modifier|*
name|cipherText
init|=
name|NULL
decl_stmt|;
name|apr_size_t
name|cipherTextLen
init|=
literal|0
decl_stmt|;
name|unsigned
name|char
modifier|*
name|plainText
init|=
name|NULL
decl_stmt|;
name|apr_size_t
name|plainTextLen
init|=
literal|0
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|iv
init|=
name|NULL
decl_stmt|;
name|apr_size_t
name|blockSize
init|=
literal|0
decl_stmt|;
name|f1
operator|=
name|make
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|driver1
argument_list|)
expr_stmt|;
name|f2
operator|=
name|make
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|driver2
argument_list|)
expr_stmt|;
name|key1
operator|=
name|passphrase
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|driver1
argument_list|,
name|f1
argument_list|,
name|type
argument_list|,
name|mode
argument_list|,
name|doPad
argument_list|,
name|description
argument_list|)
expr_stmt|;
name|key2
operator|=
name|passphrase
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|driver2
argument_list|,
name|f2
argument_list|,
name|type
argument_list|,
name|mode
argument_list|,
name|doPad
argument_list|,
name|description
argument_list|)
expr_stmt|;
name|cipherText
operator|=
name|encrypt_block
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|driver1
argument_list|,
name|f1
argument_list|,
name|key1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
operator|&
name|cipherText
argument_list|,
operator|&
name|cipherTextLen
argument_list|,
operator|&
name|iv
argument_list|,
operator|&
name|blockSize
argument_list|,
name|description
argument_list|)
expr_stmt|;
name|plainText
operator|=
name|decrypt_block
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|driver2
argument_list|,
name|f2
argument_list|,
name|key2
argument_list|,
name|cipherText
argument_list|,
name|cipherTextLen
argument_list|,
operator|&
name|plainText
argument_list|,
operator|&
name|plainTextLen
argument_list|,
name|iv
argument_list|,
operator|&
name|blockSize
argument_list|,
name|description
argument_list|)
expr_stmt|;
if|if
condition|(
name|cipherText
operator|&&
name|plainText
condition|)
block|{
if|if
condition|(
name|memcmp
argument_list|(
name|in
argument_list|,
name|plainText
argument_list|,
name|inlen
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"cross mismatch: %s %s/%s\n"
argument_list|,
name|description
argument_list|,
name|apr_crypto_driver_name
argument_list|(
name|driver1
argument_list|)
argument_list|,
name|apr_crypto_driver_name
argument_list|(
name|driver2
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ABTS_STR_EQUAL
argument_list|(
name|tc
argument_list|,
operator|(
name|char
operator|*
operator|)
name|in
argument_list|,
operator|(
name|char
operator|*
operator|)
name|plainText
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * Test initialisation.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_init
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
name|apr_status_t
name|rv
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|rv
operator|=
name|apr_crypto_init
argument_list|(
name|pool
argument_list|)
expr_stmt|;
name|ABTS_ASSERT
argument_list|(
name|tc
argument_list|,
literal|"failed to init apr_crypto"
argument_list|,
name|rv
operator|==
name|APR_SUCCESS
argument_list|)
expr_stmt|;
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Simple test of OpenSSL block crypt.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_block_openssl
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|drivers
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|in
init|=
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|ALIGNED_STRING
decl_stmt|;
name|apr_size_t
name|inlen
init|=
sizeof|sizeof
argument_list|(
name|ALIGNED_STRING
argument_list|)
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|0
index|]
operator|=
name|get_openssl_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|1
index|]
operator|=
name|get_openssl_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_3DES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_3DES_192/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_3DES_192
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_3DES_192/MODE_ECB"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_ECB"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_192/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_192
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_192/MODE_ECB"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_128
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_128/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_128
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_128/MODE_ECB"
argument_list|)
expr_stmt|;
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Simple test of NSS block crypt.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_block_nss
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|drivers
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|in
init|=
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|ALIGNED_STRING
decl_stmt|;
name|apr_size_t
name|inlen
init|=
sizeof|sizeof
argument_list|(
name|ALIGNED_STRING
argument_list|)
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|0
index|]
operator|=
name|get_nss_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|1
index|]
operator|=
name|get_nss_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_3DES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_3DES_192/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_3DES_192 / MODE_ECB doesn't work on NSS */
comment|/* crypto_block_cross(tc, pool, drivers, KEY_3DES_192, MODE_ECB, 0, in, inlen, "KEY_3DES_192/MODE_ECB"); */
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_ECB"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_192/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_192
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_192/MODE_ECB"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_128
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_128/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_128
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_128/MODE_ECB"
argument_list|)
expr_stmt|;
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Encrypt NSS, decrypt OpenSSL.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_block_nss_openssl
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|drivers
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|in
init|=
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|ALIGNED_STRING
decl_stmt|;
name|apr_size_t
name|inlen
init|=
sizeof|sizeof
argument_list|(
name|ALIGNED_STRING
argument_list|)
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|0
index|]
operator|=
name|get_nss_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|1
index|]
operator|=
name|get_openssl_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_3DES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_3DES_192/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_3DES_192 / MODE_ECB doesn't work on NSS */
comment|/* crypto_block_cross(tc, pool, drivers, KEY_3DES_192, MODE_ECB, 0, in, inlen, "KEY_3DES_192/MODE_ECB"); */
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_ECB"
argument_list|)
expr_stmt|;
comment|/* all 4 of these tests fail to interoperate - a clue from the xml-security code is that      * NSS cannot distinguish between the 128 and 192 bit versions of AES. Will need to be      * investigated.      */
comment|/*      crypto_block_cross(tc, pool, drivers, KEY_AES_192, MODE_CBC, 0, in, inlen, "KEY_AES_192/MODE_CBC");      crypto_block_cross(tc, pool, drivers, KEY_AES_192, MODE_ECB, 0, in, inlen, "KEY_AES_192/MODE_ECB");      crypto_block_cross(tc, pool, drivers, KEY_AES_128, MODE_CBC, 0, in, inlen, "KEY_AES_128/MODE_CBC");      crypto_block_cross(tc, pool, drivers, KEY_AES_128, MODE_ECB, 0, in, inlen, "KEY_AES_128/MODE_ECB");      */
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Encrypt OpenSSL, decrypt NSS.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_block_openssl_nss
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|drivers
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|in
init|=
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|ALIGNED_STRING
decl_stmt|;
name|apr_size_t
name|inlen
init|=
sizeof|sizeof
argument_list|(
name|ALIGNED_STRING
argument_list|)
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|0
index|]
operator|=
name|get_openssl_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|1
index|]
operator|=
name|get_nss_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_3DES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_3DES_192/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_3DES_192 / MODE_ECB doesn't work on NSS */
comment|/* crypto_block_cross(tc, pool, drivers, KEY_3DES_192, MODE_ECB, 0, in, inlen, "KEY_3DES_192/MODE_ECB"); */
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|0
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_ECB"
argument_list|)
expr_stmt|;
comment|/* all 4 of these tests fail to interoperate - a clue from the xml-security code is that      * NSS cannot distinguish between the 128 and 192 bit versions of AES. Will need to be      * investigated.      */
comment|/*      crypto_block_cross(tc, pool, drivers, KEY_AES_192, MODE_CBC, 0, in, inlen, "KEY_AES_192/MODE_CBC");      crypto_block_cross(tc, pool, drivers, KEY_AES_192, MODE_ECB, 0, in, inlen, "KEY_AES_192/MODE_ECB");      crypto_block_cross(tc, pool, drivers, KEY_AES_128, MODE_CBC, 0, in, inlen, "KEY_AES_128/MODE_CBC");      crypto_block_cross(tc, pool, drivers, KEY_AES_128, MODE_ECB, 0, in, inlen, "KEY_AES_128/MODE_ECB");      */
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Simple test of OpenSSL block crypt.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_block_openssl_pad
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|drivers
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|in
init|=
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|TEST_STRING
decl_stmt|;
name|apr_size_t
name|inlen
init|=
sizeof|sizeof
argument_list|(
name|TEST_STRING
argument_list|)
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|0
index|]
operator|=
name|get_openssl_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|1
index|]
operator|=
name|get_openssl_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_3DES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_3DES_192/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_3DES_192
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_3DES_192/MODE_ECB"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_ECB"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_192/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_192
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_192/MODE_ECB"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_128
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_128/MODE_CBC"
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_128
argument_list|,
name|APR_MODE_ECB
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_128/MODE_ECB"
argument_list|)
expr_stmt|;
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Simple test of NSS block crypt.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_block_nss_pad
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|drivers
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|in
init|=
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|TEST_STRING
decl_stmt|;
name|apr_size_t
name|inlen
init|=
sizeof|sizeof
argument_list|(
name|TEST_STRING
argument_list|)
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|0
index|]
operator|=
name|get_nss_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|1
index|]
operator|=
name|get_nss_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_3DES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_3DES_192/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_3DES_192 / MODE_ECB doesn't work on NSS */
comment|/* crypto_block_cross(tc, pool, drivers, KEY_3DES_192, MODE_ECB, 1, in, inlen, "KEY_3DES_192/MODE_ECB"); */
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_AES_256 / MODE_ECB doesn't support padding on NSS */
comment|/*crypto_block_cross(tc, pool, drivers, KEY_AES_256, MODE_ECB, 1, in, inlen, "KEY_AES_256/MODE_ECB");*/
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_192/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_AES_256 / MODE_ECB doesn't support padding on NSS */
comment|/*crypto_block_cross(tc, pool, drivers, KEY_AES_192, MODE_ECB, 1, in, inlen, "KEY_AES_192/MODE_ECB");*/
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_128
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_128/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_AES_256 / MODE_ECB doesn't support padding on NSS */
comment|/*crypto_block_cross(tc, pool, drivers, KEY_AES_128, MODE_ECB, 1, in, inlen, "KEY_AES_128/MODE_ECB");*/
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Encrypt NSS, decrypt OpenSSL.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_block_nss_openssl_pad
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|drivers
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|in
init|=
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|TEST_STRING
decl_stmt|;
name|apr_size_t
name|inlen
init|=
sizeof|sizeof
argument_list|(
name|TEST_STRING
argument_list|)
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|0
index|]
operator|=
name|get_nss_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|1
index|]
operator|=
name|get_openssl_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_3DES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_3DES_192/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_3DES_192 / MODE_ECB doesn't work on NSS */
comment|/* crypto_block_cross(tc, pool, drivers, KEY_3DES_192, MODE_ECB, 1, in, inlen, "KEY_3DES_192/MODE_ECB"); */
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_AES_256 / MODE_ECB doesn't support padding on NSS */
comment|/*crypto_block_cross(tc, pool, drivers, KEY_AES_256, MODE_ECB, 1, in, inlen, "KEY_AES_256/MODE_ECB");*/
comment|/* all 4 of these tests fail to interoperate - a clue from the xml-security code is that      * NSS cannot distinguish between the 128 and 192 bit versions of AES. Will need to be      * investigated.      */
comment|/*      crypto_block_cross(tc, pool, drivers, KEY_AES_192, MODE_CBC, 1, in, inlen, "KEY_AES_192/MODE_CBC");      crypto_block_cross(tc, pool, drivers, KEY_AES_192, MODE_ECB, 1, in, inlen, "KEY_AES_192/MODE_ECB");      crypto_block_cross(tc, pool, drivers, KEY_AES_128, MODE_CBC, 1, in, inlen, "KEY_AES_128/MODE_CBC");      crypto_block_cross(tc, pool, drivers, KEY_AES_128, MODE_ECB, 1, in, inlen, "KEY_AES_128/MODE_ECB");      */
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Encrypt OpenSSL, decrypt NSS.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_block_openssl_nss_pad
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|drivers
index|[]
init|=
block|{
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|in
init|=
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
name|TEST_STRING
decl_stmt|;
name|apr_size_t
name|inlen
init|=
sizeof|sizeof
argument_list|(
name|TEST_STRING
argument_list|)
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|0
index|]
operator|=
name|get_openssl_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|drivers
index|[
literal|1
index|]
operator|=
name|get_nss_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_3DES_192
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_3DES_192/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_3DES_192 / MODE_ECB doesn't work on NSS */
comment|/* crypto_block_cross(tc, pool, drivers, KEY_3DES_192, MODE_ECB, 1, in, inlen, "KEY_3DES_192/MODE_ECB"); */
name|crypto_block_cross
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|drivers
argument_list|,
name|APR_KEY_AES_256
argument_list|,
name|APR_MODE_CBC
argument_list|,
literal|1
argument_list|,
name|in
argument_list|,
name|inlen
argument_list|,
literal|"KEY_AES_256/MODE_CBC"
argument_list|)
expr_stmt|;
comment|/* KEY_AES_256 / MODE_ECB doesn't support padding on NSS */
comment|/*crypto_block_cross(tc, pool, drivers, KEY_AES_256, MODE_ECB, 1, in, inlen, "KEY_AES_256/MODE_ECB");*/
comment|/* all 4 of these tests fail to interoperate - a clue from the xml-security code is that      * NSS cannot distinguish between the 128 and 192 bit versions of AES. Will need to be      * investigated.      */
comment|/*      crypto_block_cross(tc, pool, drivers, KEY_AES_192, MODE_CBC, 1, in, inlen, "KEY_AES_192/MODE_CBC");      crypto_block_cross(tc, pool, drivers, KEY_AES_192, MODE_ECB, 1, in, inlen, "KEY_AES_192/MODE_ECB");      crypto_block_cross(tc, pool, drivers, KEY_AES_128, MODE_CBC, 1, in, inlen, "KEY_AES_128/MODE_CBC");      crypto_block_cross(tc, pool, drivers, KEY_AES_128, MODE_ECB, 1, in, inlen, "KEY_AES_128/MODE_ECB");      */
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Get Types, OpenSSL.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_get_block_key_types_openssl
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver
decl_stmt|;
name|apr_crypto_t
modifier|*
name|f
decl_stmt|;
name|apr_hash_t
modifier|*
name|types
decl_stmt|;
name|int
modifier|*
name|key_3des_192
decl_stmt|;
name|int
modifier|*
name|key_aes_128
decl_stmt|;
name|int
modifier|*
name|key_aes_192
decl_stmt|;
name|int
modifier|*
name|key_aes_256
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|driver
operator|=
name|get_openssl_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|driver
condition|)
block|{
name|f
operator|=
name|make
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|driver
argument_list|)
expr_stmt|;
name|apr_crypto_get_block_key_types
argument_list|(
operator|&
name|types
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|key_3des_192
operator|=
name|apr_hash_get
argument_list|(
name|types
argument_list|,
literal|"3des192"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|key_3des_192
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|key_3des_192
argument_list|,
name|APR_KEY_3DES_192
argument_list|)
expr_stmt|;
name|key_aes_128
operator|=
name|apr_hash_get
argument_list|(
name|types
argument_list|,
literal|"aes128"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|key_aes_128
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|key_aes_128
argument_list|,
name|APR_KEY_AES_128
argument_list|)
expr_stmt|;
name|key_aes_192
operator|=
name|apr_hash_get
argument_list|(
name|types
argument_list|,
literal|"aes192"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|key_aes_192
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|key_aes_192
argument_list|,
name|APR_KEY_AES_192
argument_list|)
expr_stmt|;
name|key_aes_256
operator|=
name|apr_hash_get
argument_list|(
name|types
argument_list|,
literal|"aes256"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|key_aes_256
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|key_aes_256
argument_list|,
name|APR_KEY_AES_256
argument_list|)
expr_stmt|;
block|}
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Get Types, NSS.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_get_block_key_types_nss
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver
decl_stmt|;
name|apr_crypto_t
modifier|*
name|f
decl_stmt|;
name|apr_hash_t
modifier|*
name|types
decl_stmt|;
name|int
modifier|*
name|key_3des_192
decl_stmt|;
name|int
modifier|*
name|key_aes_128
decl_stmt|;
name|int
modifier|*
name|key_aes_192
decl_stmt|;
name|int
modifier|*
name|key_aes_256
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|driver
operator|=
name|get_nss_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|driver
condition|)
block|{
name|f
operator|=
name|make
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|driver
argument_list|)
expr_stmt|;
name|apr_crypto_get_block_key_types
argument_list|(
operator|&
name|types
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|key_3des_192
operator|=
name|apr_hash_get
argument_list|(
name|types
argument_list|,
literal|"3des192"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|key_3des_192
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|key_3des_192
argument_list|,
name|APR_KEY_3DES_192
argument_list|)
expr_stmt|;
name|key_aes_128
operator|=
name|apr_hash_get
argument_list|(
name|types
argument_list|,
literal|"aes128"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|key_aes_128
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|key_aes_128
argument_list|,
name|APR_KEY_AES_128
argument_list|)
expr_stmt|;
name|key_aes_192
operator|=
name|apr_hash_get
argument_list|(
name|types
argument_list|,
literal|"aes192"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|key_aes_192
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|key_aes_192
argument_list|,
name|APR_KEY_AES_192
argument_list|)
expr_stmt|;
name|key_aes_256
operator|=
name|apr_hash_get
argument_list|(
name|types
argument_list|,
literal|"aes256"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|key_aes_256
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|key_aes_256
argument_list|,
name|APR_KEY_AES_256
argument_list|)
expr_stmt|;
block|}
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Get Modes, OpenSSL.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_get_block_key_modes_openssl
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver
decl_stmt|;
name|apr_crypto_t
modifier|*
name|f
decl_stmt|;
name|apr_hash_t
modifier|*
name|modes
decl_stmt|;
name|int
modifier|*
name|mode_ecb
decl_stmt|;
name|int
modifier|*
name|mode_cbc
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|driver
operator|=
name|get_openssl_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|driver
condition|)
block|{
name|f
operator|=
name|make
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|driver
argument_list|)
expr_stmt|;
name|apr_crypto_get_block_key_modes
argument_list|(
operator|&
name|modes
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|mode_ecb
operator|=
name|apr_hash_get
argument_list|(
name|modes
argument_list|,
literal|"ecb"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|mode_ecb
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|mode_ecb
argument_list|,
name|APR_MODE_ECB
argument_list|)
expr_stmt|;
name|mode_cbc
operator|=
name|apr_hash_get
argument_list|(
name|modes
argument_list|,
literal|"cbc"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|mode_cbc
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|mode_cbc
argument_list|,
name|APR_MODE_CBC
argument_list|)
expr_stmt|;
block|}
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * Get Modes, NSS.  */
end_comment

begin_function
specifier|static
name|void
name|test_crypto_get_block_key_modes_nss
parameter_list|(
name|abts_case
modifier|*
name|tc
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_pool_t
modifier|*
name|pool
init|=
name|NULL
decl_stmt|;
specifier|const
name|apr_crypto_driver_t
modifier|*
name|driver
decl_stmt|;
name|apr_crypto_t
modifier|*
name|f
decl_stmt|;
name|apr_hash_t
modifier|*
name|modes
decl_stmt|;
name|int
modifier|*
name|mode_ecb
decl_stmt|;
name|int
modifier|*
name|mode_cbc
decl_stmt|;
name|apr_pool_create
argument_list|(
operator|&
name|pool
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|driver
operator|=
name|get_nss_driver
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|)
expr_stmt|;
if|if
condition|(
name|driver
condition|)
block|{
name|f
operator|=
name|make
argument_list|(
name|tc
argument_list|,
name|pool
argument_list|,
name|driver
argument_list|)
expr_stmt|;
name|apr_crypto_get_block_key_modes
argument_list|(
operator|&
name|modes
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|mode_ecb
operator|=
name|apr_hash_get
argument_list|(
name|modes
argument_list|,
literal|"ecb"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|mode_ecb
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|mode_ecb
argument_list|,
name|APR_MODE_ECB
argument_list|)
expr_stmt|;
name|mode_cbc
operator|=
name|apr_hash_get
argument_list|(
name|modes
argument_list|,
literal|"cbc"
argument_list|,
name|APR_HASH_KEY_STRING
argument_list|)
expr_stmt|;
name|ABTS_PTR_NOTNULL
argument_list|(
name|tc
argument_list|,
name|mode_cbc
argument_list|)
expr_stmt|;
name|ABTS_INT_EQUAL
argument_list|(
name|tc
argument_list|,
operator|*
name|mode_cbc
argument_list|,
name|APR_MODE_CBC
argument_list|)
expr_stmt|;
block|}
name|apr_pool_destroy
argument_list|(
name|pool
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|abts_suite
modifier|*
name|testcrypto
parameter_list|(
name|abts_suite
modifier|*
name|suite
parameter_list|)
block|{
name|suite
operator|=
name|ADD_SUITE
argument_list|(
name|suite
argument_list|)
expr_stmt|;
comment|/* test simple init and shutdown */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_init
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test a simple encrypt / decrypt operation - openssl */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_block_openssl
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test a padded encrypt / decrypt operation - openssl */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_block_openssl_pad
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test a simple encrypt / decrypt operation - nss */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_block_nss
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test a padded encrypt / decrypt operation - nss */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_block_nss_pad
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test encrypt nss / decrypt openssl */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_block_nss_openssl
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test padded encrypt nss / decrypt openssl */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_block_nss_openssl_pad
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test encrypt openssl / decrypt nss */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_block_openssl_nss
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test padded encrypt openssl / decrypt nss */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_block_openssl_nss_pad
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test block key types openssl */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_get_block_key_types_openssl
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test block key types nss */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_get_block_key_types_nss
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test block key modes openssl */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_get_block_key_modes_openssl
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* test block key modes nss */
name|abts_run_test
argument_list|(
name|suite
argument_list|,
name|test_crypto_get_block_key_modes_nss
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|suite
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/**  * Dummy test suite when crypto is turned off.  */
end_comment

begin_function
name|abts_suite
modifier|*
name|testcrypto
parameter_list|(
name|abts_suite
modifier|*
name|suite
parameter_list|)
block|{
return|return
name|ADD_SUITE
argument_list|(
name|suite
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* APU_HAVE_CRYPTO */
end_comment

end_unit


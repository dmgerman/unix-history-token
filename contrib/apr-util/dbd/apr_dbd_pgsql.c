begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|"apu.h"
end_include

begin_if
if|#
directive|if
name|APU_HAVE_PGSQL
end_if

begin_include
include|#
directive|include
file|"apu_config.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIBPQ_FE_H
end_ifdef

begin_include
include|#
directive|include
file|<libpq-fe.h>
end_include

begin_elif
elif|#
directive|elif
name|defined
argument_list|(
name|HAVE_POSTGRESQL_LIBPQ_FE_H
argument_list|)
end_elif

begin_include
include|#
directive|include
file|<postgresql/libpq-fe.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"apr_strings.h"
end_include

begin_include
include|#
directive|include
file|"apr_time.h"
end_include

begin_include
include|#
directive|include
file|"apr_buckets.h"
end_include

begin_include
include|#
directive|include
file|"apr_dbd_internal.h"
end_include

begin_struct
struct|struct
name|apr_dbd_transaction_t
block|{
name|int
name|mode
decl_stmt|;
name|int
name|errnum
decl_stmt|;
name|apr_dbd_t
modifier|*
name|handle
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_t
block|{
name|PGconn
modifier|*
name|conn
decl_stmt|;
name|apr_dbd_transaction_t
modifier|*
name|trans
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_results_t
block|{
name|int
name|random
decl_stmt|;
name|PGconn
modifier|*
name|handle
decl_stmt|;
name|PGresult
modifier|*
name|res
decl_stmt|;
name|size_t
name|ntuples
decl_stmt|;
name|size_t
name|sz
decl_stmt|;
name|size_t
name|index
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_row_t
block|{
name|int
name|n
decl_stmt|;
name|apr_dbd_results_t
modifier|*
name|res
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_prepared_t
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|prepared
decl_stmt|;
name|int
name|nargs
decl_stmt|;
name|int
name|nvals
decl_stmt|;
name|apr_dbd_type_e
modifier|*
name|types
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|dbd_pgsql_is_success
parameter_list|(
name|x
parameter_list|)
value|(((x) == PGRES_EMPTY_QUERY) \                                  || ((x) == PGRES_COMMAND_OK) \                                  || ((x) == PGRES_TUPLES_OK))
end_define

begin_function
specifier|static
name|apr_status_t
name|clear_result
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|PQclear
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_select
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|,
name|int
name|seek
parameter_list|)
block|{
name|PGresult
modifier|*
name|res
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
if|if
condition|(
name|seek
condition|)
block|{
comment|/* synchronous query */
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
name|res
operator|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|ret
operator|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|PGRES_FATAL_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"ROLLBACK TO SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
else|else
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"RELEASE SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
block|}
if|if
condition|(
operator|!
operator|*
name|results
condition|)
block|{
operator|*
name|results
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_results_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|results
operator|)
operator|->
name|res
operator|=
name|res
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|ntuples
operator|=
name|PQntuples
argument_list|(
name|res
argument_list|)
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|sz
operator|=
name|PQnfields
argument_list|(
name|res
argument_list|)
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|random
operator|=
name|seek
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
name|res
argument_list|,
name|clear_result
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
if|if
condition|(
name|PQsendQuery
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|query
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"ROLLBACK TO SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
literal|1
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"RELEASE SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
block|}
if|if
condition|(
operator|*
name|results
operator|==
name|NULL
condition|)
block|{
operator|*
name|results
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_results_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|results
operator|)
operator|->
name|random
operator|=
name|seek
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|handle
operator|=
name|sql
operator|->
name|conn
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_pgsql_get_name
parameter_list|(
specifier|const
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|,
name|int
name|n
parameter_list|)
block|{
if|if
condition|(
name|res
operator|->
name|res
condition|)
block|{
if|if
condition|(
operator|(
name|n
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|PQnfields
argument_list|(
name|res
operator|->
name|res
argument_list|)
operator|>
name|n
operator|)
condition|)
block|{
return|return
name|PQfname
argument_list|(
name|res
operator|->
name|res
argument_list|,
name|n
argument_list|)
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_get_row
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|,
name|apr_dbd_row_t
modifier|*
modifier|*
name|rowp
parameter_list|,
name|int
name|rownum
parameter_list|)
block|{
name|apr_dbd_row_t
modifier|*
name|row
init|=
operator|*
name|rowp
decl_stmt|;
name|int
name|sequential
init|=
operator|(
operator|(
name|rownum
operator|>=
literal|0
operator|)
operator|&&
name|res
operator|->
name|random
operator|)
condition|?
literal|0
else|:
literal|1
decl_stmt|;
if|if
condition|(
name|row
operator|==
name|NULL
condition|)
block|{
name|row
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_row_t
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|rowp
operator|=
name|row
expr_stmt|;
name|row
operator|->
name|res
operator|=
name|res
expr_stmt|;
if|if
condition|(
name|sequential
condition|)
block|{
name|row
operator|->
name|n
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rownum
operator|>
literal|0
condition|)
block|{
name|row
operator|->
name|n
operator|=
operator|--
name|rownum
expr_stmt|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
comment|/* invalid row */
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|sequential
condition|)
block|{
operator|++
name|row
operator|->
name|n
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rownum
operator|>
literal|0
condition|)
block|{
name|row
operator|->
name|n
operator|=
operator|--
name|rownum
expr_stmt|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
comment|/* invalid row */
block|}
block|}
block|}
if|if
condition|(
name|res
operator|->
name|random
condition|)
block|{
if|if
condition|(
operator|(
name|row
operator|->
name|n
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|size_t
operator|)
name|row
operator|->
name|n
operator|>=
name|res
operator|->
name|ntuples
condition|)
block|{
operator|*
name|rowp
operator|=
name|NULL
expr_stmt|;
name|apr_pool_cleanup_run
argument_list|(
name|res
operator|->
name|pool
argument_list|,
name|res
operator|->
name|res
argument_list|,
name|clear_result
argument_list|)
expr_stmt|;
name|res
operator|->
name|res
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|row
operator|->
name|n
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|size_t
operator|)
name|row
operator|->
name|n
operator|>=
name|res
operator|->
name|ntuples
condition|)
block|{
comment|/* no data; we have to fetch some */
name|row
operator|->
name|n
operator|-=
name|res
operator|->
name|ntuples
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|res
operator|!=
name|NULL
condition|)
block|{
name|PQclear
argument_list|(
name|res
operator|->
name|res
argument_list|)
expr_stmt|;
block|}
name|res
operator|->
name|res
operator|=
name|PQgetResult
argument_list|(
name|res
operator|->
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|res
condition|)
block|{
name|res
operator|->
name|ntuples
operator|=
name|PQntuples
argument_list|(
name|res
operator|->
name|res
argument_list|)
expr_stmt|;
while|while
condition|(
name|res
operator|->
name|ntuples
operator|==
literal|0
condition|)
block|{
comment|/* if we got an empty result, clear it, wait a mo, try                      * again */
name|PQclear
argument_list|(
name|res
operator|->
name|res
argument_list|)
expr_stmt|;
name|apr_sleep
argument_list|(
literal|100000
argument_list|)
expr_stmt|;
comment|/* 0.1 secs */
name|res
operator|->
name|res
operator|=
name|PQgetResult
argument_list|(
name|res
operator|->
name|handle
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|res
condition|)
block|{
name|res
operator|->
name|ntuples
operator|=
name|PQntuples
argument_list|(
name|res
operator|->
name|res
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|res
operator|->
name|sz
operator|==
literal|0
condition|)
block|{
name|res
operator|->
name|sz
operator|=
name|PQnfields
argument_list|(
name|res
operator|->
name|res
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_pgsql_get_entry
parameter_list|(
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|n
parameter_list|)
block|{
return|return
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_pgsql_datum_get
parameter_list|(
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|n
parameter_list|,
name|apr_dbd_type_e
name|type
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|PQgetisnull
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
condition|)
block|{
return|return
name|APR_ENOENT
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|APR_DBD_TYPE_TINY
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UTINY
case|:
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_SHORT
case|:
operator|*
operator|(
name|short
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_USHORT
case|:
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_INT
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UINT
case|:
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONG
case|:
operator|*
operator|(
name|long
operator|*
operator|)
name|data
operator|=
name|atol
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONG
case|:
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|data
operator|=
name|atol
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONGLONG
case|:
operator|*
operator|(
name|apr_int64_t
operator|*
operator|)
name|data
operator|=
name|apr_atoi64
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONGLONG
case|:
operator|*
operator|(
name|apr_uint64_t
operator|*
operator|)
name|data
operator|=
name|apr_atoi64
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_FLOAT
case|:
operator|*
operator|(
name|float
operator|*
operator|)
name|data
operator|=
operator|(
name|float
operator|)
name|atof
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DOUBLE
case|:
operator|*
operator|(
name|double
operator|*
operator|)
name|data
operator|=
name|atof
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_STRING
case|:
case|case
name|APR_DBD_TYPE_TEXT
case|:
case|case
name|APR_DBD_TYPE_TIME
case|:
case|case
name|APR_DBD_TYPE_DATE
case|:
case|case
name|APR_DBD_TYPE_DATETIME
case|:
case|case
name|APR_DBD_TYPE_TIMESTAMP
case|:
case|case
name|APR_DBD_TYPE_ZTIMESTAMP
case|:
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|data
operator|=
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
block|{
name|apr_bucket
modifier|*
name|e
decl_stmt|;
name|apr_bucket_brigade
modifier|*
name|b
init|=
operator|(
name|apr_bucket_brigade
operator|*
operator|)
name|data
decl_stmt|;
name|e
operator|=
name|apr_bucket_pool_create
argument_list|(
name|PQgetvalue
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|,
name|PQgetlength
argument_list|(
name|row
operator|->
name|res
operator|->
name|res
argument_list|,
name|row
operator|->
name|n
argument_list|,
name|n
argument_list|)
argument_list|,
name|row
operator|->
name|res
operator|->
name|pool
argument_list|,
name|b
operator|->
name|bucket_alloc
argument_list|)
expr_stmt|;
name|APR_BRIGADE_INSERT_TAIL
argument_list|(
name|b
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|APR_DBD_TYPE_NULL
case|:
operator|*
operator|(
name|void
operator|*
operator|*
operator|)
name|data
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
return|return
name|APR_EGENERAL
return|;
block|}
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_pgsql_error
parameter_list|(
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
name|n
parameter_list|)
block|{
return|return
name|PQerrorMessage
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_query
parameter_list|(
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|)
block|{
name|PGresult
modifier|*
name|res
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
name|res
operator|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|ret
operator|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
comment|/* ugh, making 0 return-success doesn't fit */
name|ret
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|nrows
operator|=
name|atoi
argument_list|(
name|PQcmdTuples
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|PGRES_FATAL_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"ROLLBACK TO SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"RELEASE SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_pgsql_escape
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|)
block|{
name|size_t
name|len
init|=
name|strlen
argument_list|(
name|arg
argument_list|)
decl_stmt|;
name|char
modifier|*
name|ret
init|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
literal|2
operator|*
name|len
operator|+
literal|2
argument_list|)
decl_stmt|;
name|PQescapeStringConn
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|ret
argument_list|,
name|arg
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_prepare
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|int
name|nargs
parameter_list|,
name|int
name|nvals
parameter_list|,
name|apr_dbd_type_e
modifier|*
name|types
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
modifier|*
name|statement
parameter_list|)
block|{
name|char
modifier|*
name|sqlcmd
decl_stmt|;
name|char
modifier|*
name|sqlptr
decl_stmt|;
name|size_t
name|length
decl_stmt|,
name|qlen
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|args
decl_stmt|;
name|size_t
name|alen
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|PGresult
modifier|*
name|res
decl_stmt|;
if|if
condition|(
operator|!
operator|*
name|statement
condition|)
block|{
operator|*
name|statement
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_prepared_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|statement
operator|)
operator|->
name|nargs
operator|=
name|nargs
expr_stmt|;
operator|(
operator|*
name|statement
operator|)
operator|->
name|nvals
operator|=
name|nvals
expr_stmt|;
operator|(
operator|*
name|statement
operator|)
operator|->
name|types
operator|=
name|types
expr_stmt|;
name|args
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|nargs
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|args
argument_list|)
argument_list|)
expr_stmt|;
name|qlen
operator|=
name|strlen
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|length
operator|=
name|qlen
operator|+
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nargs
condition|;
name|i
operator|++
control|)
block|{
switch|switch
condition|(
name|types
index|[
name|i
index|]
condition|)
block|{
case|case
name|APR_DBD_TYPE_TINY
case|:
case|case
name|APR_DBD_TYPE_UTINY
case|:
case|case
name|APR_DBD_TYPE_SHORT
case|:
case|case
name|APR_DBD_TYPE_USHORT
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"smallint"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_INT
case|:
case|case
name|APR_DBD_TYPE_UINT
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"integer"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONG
case|:
case|case
name|APR_DBD_TYPE_ULONG
case|:
case|case
name|APR_DBD_TYPE_LONGLONG
case|:
case|case
name|APR_DBD_TYPE_ULONGLONG
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"bigint"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_FLOAT
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"real"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DOUBLE
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"double precision"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_TEXT
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"text"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_TIME
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"time"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DATE
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"date"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DATETIME
case|:
case|case
name|APR_DBD_TYPE_TIMESTAMP
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"timestamp"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ZTIMESTAMP
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"timestamp with time zone"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"bytea"
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_NULL
case|:
name|args
index|[
name|i
index|]
operator|=
literal|"varchar"
expr_stmt|;
comment|/* XXX Eh? */
break|break;
default|default:
name|args
index|[
name|i
index|]
operator|=
literal|"varchar"
expr_stmt|;
break|break;
block|}
name|length
operator|+=
literal|1
operator|+
name|strlen
argument_list|(
name|args
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|label
condition|)
block|{
comment|/* don't really prepare; use in execParams instead */
operator|(
operator|*
name|statement
operator|)
operator|->
name|prepared
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|statement
operator|)
operator|->
name|name
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|query
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
operator|(
operator|*
name|statement
operator|)
operator|->
name|name
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|label
argument_list|)
expr_stmt|;
comment|/* length of SQL query that prepares this statement */
name|length
operator|=
literal|8
operator|+
name|strlen
argument_list|(
name|label
argument_list|)
operator|+
literal|2
operator|+
literal|4
operator|+
name|length
operator|+
literal|1
expr_stmt|;
name|sqlcmd
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|sqlptr
operator|=
name|sqlcmd
expr_stmt|;
name|memcpy
argument_list|(
name|sqlptr
argument_list|,
literal|"PREPARE "
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|sqlptr
operator|+=
literal|8
expr_stmt|;
name|length
operator|=
name|strlen
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sqlptr
argument_list|,
name|label
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|sqlptr
operator|+=
name|length
expr_stmt|;
if|if
condition|(
name|nargs
operator|>
literal|0
condition|)
block|{
name|memcpy
argument_list|(
name|sqlptr
argument_list|,
literal|" ("
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|sqlptr
operator|+=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nargs
condition|;
operator|++
name|i
control|)
block|{
name|alen
operator|=
name|strlen
argument_list|(
name|args
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|sqlptr
argument_list|,
name|args
index|[
name|i
index|]
argument_list|,
name|alen
argument_list|)
expr_stmt|;
name|sqlptr
operator|+=
name|alen
expr_stmt|;
operator|*
name|sqlptr
operator|++
operator|=
literal|','
expr_stmt|;
block|}
name|sqlptr
index|[
operator|-
literal|1
index|]
operator|=
literal|')'
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|sqlptr
argument_list|,
literal|" AS "
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|sqlptr
operator|+=
literal|4
expr_stmt|;
name|memcpy
argument_list|(
name|sqlptr
argument_list|,
name|query
argument_list|,
name|qlen
argument_list|)
expr_stmt|;
name|sqlptr
operator|+=
name|qlen
expr_stmt|;
operator|*
name|sqlptr
operator|=
literal|0
expr_stmt|;
name|res
operator|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|sqlcmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|ret
operator|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Hmmm, do we do this here or register it on the pool? */
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|PGRES_FATAL_ERROR
expr_stmt|;
block|}
operator|(
operator|*
name|statement
operator|)
operator|->
name|prepared
operator|=
literal|1
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_pquery_internal
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|,
specifier|const
name|int
modifier|*
name|len
parameter_list|,
specifier|const
name|int
modifier|*
name|fmt
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|PGresult
modifier|*
name|res
decl_stmt|;
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
if|if
condition|(
name|statement
operator|->
name|prepared
condition|)
block|{
name|res
operator|=
name|PQexecPrepared
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|statement
operator|->
name|name
argument_list|,
name|statement
operator|->
name|nargs
argument_list|,
name|values
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|PQexecParams
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|statement
operator|->
name|name
argument_list|,
name|statement
operator|->
name|nargs
argument_list|,
literal|0
argument_list|,
name|values
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
condition|)
block|{
name|ret
operator|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|nrows
operator|=
name|atoi
argument_list|(
name|PQcmdTuples
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|PGRES_FATAL_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"ROLLBACK TO SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"RELEASE SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dbd_pgsql_bind
parameter_list|(
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|val
parameter_list|,
name|int
modifier|*
name|len
parameter_list|,
name|int
modifier|*
name|fmt
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nargs
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
if|if
condition|(
name|values
index|[
name|j
index|]
operator|==
name|NULL
condition|)
block|{
name|val
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|statement
operator|->
name|types
index|[
name|i
index|]
condition|)
block|{
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
name|val
index|[
name|i
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|values
index|[
name|j
index|]
expr_stmt|;
name|len
index|[
name|i
index|]
operator|=
name|atoi
argument_list|(
name|values
index|[
operator|++
name|j
index|]
argument_list|)
expr_stmt|;
name|fmt
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
comment|/* skip table and column */
name|j
operator|+=
literal|2
expr_stmt|;
break|break;
default|default:
name|val
index|[
name|i
index|]
operator|=
name|values
index|[
name|j
index|]
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_pquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|int
modifier|*
name|len
decl_stmt|,
modifier|*
name|fmt
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|val
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|val
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|val
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|len
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|len
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|fmt
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fmt
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|dbd_pgsql_bind
argument_list|(
name|statement
argument_list|,
name|values
argument_list|,
name|val
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
return|return
name|dbd_pgsql_pquery_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|nrows
argument_list|,
name|statement
argument_list|,
name|val
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_pvquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|char
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_pgsql_pquery
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|nrows
argument_list|,
name|statement
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_pselect_internal
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|,
specifier|const
name|int
modifier|*
name|len
parameter_list|,
specifier|const
name|int
modifier|*
name|fmt
parameter_list|)
block|{
name|PGresult
modifier|*
name|res
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|seek
condition|)
block|{
comment|/* synchronous query */
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
if|if
condition|(
name|statement
operator|->
name|prepared
condition|)
block|{
name|res
operator|=
name|PQexecPrepared
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|statement
operator|->
name|name
argument_list|,
name|statement
operator|->
name|nargs
argument_list|,
name|values
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|PQexecParams
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|statement
operator|->
name|name
argument_list|,
name|statement
operator|->
name|nargs
argument_list|,
literal|0
argument_list|,
name|values
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
condition|)
block|{
name|ret
operator|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|PGRES_FATAL_ERROR
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"ROLLBACK TO SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
else|else
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"RELEASE SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
block|}
if|if
condition|(
operator|!
operator|*
name|results
condition|)
block|{
operator|*
name|results
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_results_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|results
operator|)
operator|->
name|res
operator|=
name|res
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|ntuples
operator|=
name|PQntuples
argument_list|(
name|res
argument_list|)
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|sz
operator|=
name|PQnfields
argument_list|(
name|res
argument_list|)
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|random
operator|=
name|seek
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
name|res
argument_list|,
name|clear_result
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
if|if
condition|(
name|statement
operator|->
name|prepared
condition|)
block|{
name|rv
operator|=
name|PQsendQueryPrepared
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|statement
operator|->
name|name
argument_list|,
name|statement
operator|->
name|nargs
argument_list|,
name|values
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rv
operator|=
name|PQsendQueryParams
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|statement
operator|->
name|name
argument_list|,
name|statement
operator|->
name|nargs
argument_list|,
literal|0
argument_list|,
name|values
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rv
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"ROLLBACK TO SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
literal|1
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|TXN_IGNORE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|PGresult
modifier|*
name|res
init|=
name|PQexec
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
literal|"RELEASE SAVEPOINT APR_DBD_TXN_SP"
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|int
name|ret
init|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
decl_stmt|;
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
else|else
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
return|return
name|PGRES_FATAL_ERROR
return|;
block|}
block|}
block|}
if|if
condition|(
operator|!
operator|*
name|results
condition|)
block|{
operator|*
name|results
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_results_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|results
operator|)
operator|->
name|random
operator|=
name|seek
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|handle
operator|=
name|sql
operator|->
name|conn
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_pselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|int
modifier|*
name|len
decl_stmt|,
modifier|*
name|fmt
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|val
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|val
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|val
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|len
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|len
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|fmt
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fmt
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|dbd_pgsql_bind
argument_list|(
name|statement
argument_list|,
name|values
argument_list|,
name|val
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
return|return
name|dbd_pgsql_pselect_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|results
argument_list|,
name|statement
argument_list|,
name|seek
argument_list|,
name|val
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_pvselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|char
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_pgsql_pselect
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|results
argument_list|,
name|statement
argument_list|,
name|seek
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dbd_pgsql_bbind
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|values
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|val
parameter_list|,
name|int
modifier|*
name|len
parameter_list|,
name|int
modifier|*
name|fmt
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|apr_dbd_type_e
name|type
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nargs
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
name|type
operator|=
operator|(
name|values
index|[
name|j
index|]
operator|==
name|NULL
condition|?
name|APR_DBD_TYPE_NULL
else|:
name|statement
operator|->
name|types
index|[
name|i
index|]
operator|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|APR_DBD_TYPE_TINY
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_itoa
argument_list|(
name|pool
argument_list|,
operator|*
operator|(
name|char
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UTINY
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_itoa
argument_list|(
name|pool
argument_list|,
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_SHORT
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_itoa
argument_list|(
name|pool
argument_list|,
operator|*
operator|(
name|short
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_USHORT
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_itoa
argument_list|(
name|pool
argument_list|,
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_INT
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_itoa
argument_list|(
name|pool
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UINT
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_itoa
argument_list|(
name|pool
argument_list|,
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONG
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_ltoa
argument_list|(
name|pool
argument_list|,
operator|*
operator|(
name|long
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONG
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_ltoa
argument_list|(
name|pool
argument_list|,
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONGLONG
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%"
name|APR_INT64_T_FMT
argument_list|,
operator|*
operator|(
name|apr_int64_t
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONGLONG
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%"
name|APR_UINT64_T_FMT
argument_list|,
operator|*
operator|(
name|apr_uint64_t
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_FLOAT
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%f"
argument_list|,
operator|*
operator|(
name|float
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DOUBLE
case|:
name|val
index|[
name|i
index|]
operator|=
name|apr_psprintf
argument_list|(
name|pool
argument_list|,
literal|"%lf"
argument_list|,
operator|*
operator|(
name|double
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_STRING
case|:
case|case
name|APR_DBD_TYPE_TEXT
case|:
case|case
name|APR_DBD_TYPE_TIME
case|:
case|case
name|APR_DBD_TYPE_DATE
case|:
case|case
name|APR_DBD_TYPE_DATETIME
case|:
case|case
name|APR_DBD_TYPE_TIMESTAMP
case|:
case|case
name|APR_DBD_TYPE_ZTIMESTAMP
case|:
name|val
index|[
name|i
index|]
operator|=
name|values
index|[
name|j
index|]
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
name|val
index|[
name|i
index|]
operator|=
operator|(
name|char
operator|*
operator|)
name|values
index|[
name|j
index|]
expr_stmt|;
name|len
index|[
name|i
index|]
operator|=
operator|*
operator|(
name|apr_size_t
operator|*
operator|)
name|values
index|[
operator|++
name|j
index|]
expr_stmt|;
name|fmt
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
comment|/* skip table and column */
name|j
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_NULL
case|:
default|default:
name|val
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_pbquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|int
modifier|*
name|len
decl_stmt|,
modifier|*
name|fmt
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|val
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|val
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|val
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|len
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|len
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|fmt
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fmt
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|dbd_pgsql_bbind
argument_list|(
name|pool
argument_list|,
name|statement
argument_list|,
name|values
argument_list|,
name|val
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
return|return
name|dbd_pgsql_pquery_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|nrows
argument_list|,
name|statement
argument_list|,
name|val
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_pvbquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|void
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_pgsql_pbquery
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|nrows
argument_list|,
name|statement
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_pbselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|int
modifier|*
name|len
decl_stmt|,
modifier|*
name|fmt
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|val
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|val
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|val
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|len
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|len
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|fmt
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|fmt
argument_list|)
operator|*
name|statement
operator|->
name|nargs
argument_list|)
expr_stmt|;
name|dbd_pgsql_bbind
argument_list|(
name|pool
argument_list|,
name|statement
argument_list|,
name|values
argument_list|,
name|val
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
return|return
name|dbd_pgsql_pselect_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|results
argument_list|,
name|statement
argument_list|,
name|seek
argument_list|,
name|val
argument_list|,
name|len
argument_list|,
name|fmt
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_pvbselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|void
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_pgsql_pbselect
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|results
argument_list|,
name|statement
argument_list|,
name|seek
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_start_transaction
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
name|apr_dbd_transaction_t
modifier|*
modifier|*
name|trans
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|PGresult
modifier|*
name|res
decl_stmt|;
comment|/* XXX handle recursive transactions here */
name|res
operator|=
name|PQexec
argument_list|(
name|handle
operator|->
name|conn
argument_list|,
literal|"BEGIN TRANSACTION"
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|ret
operator|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|trans
condition|)
block|{
operator|*
name|trans
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_transaction_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
operator|(
operator|*
name|trans
operator|)
operator|->
name|handle
operator|=
name|handle
expr_stmt|;
name|handle
operator|->
name|trans
operator|=
operator|*
name|trans
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|PGRES_FATAL_ERROR
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_end_transaction
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|)
block|{
name|PGresult
modifier|*
name|res
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
comment|/* no transaction is an error cond */
if|if
condition|(
name|trans
condition|)
block|{
comment|/* rollback on error or explicit rollback request */
if|if
condition|(
name|trans
operator|->
name|errnum
operator|||
name|TXN_DO_ROLLBACK
argument_list|(
name|trans
argument_list|)
condition|)
block|{
name|trans
operator|->
name|errnum
operator|=
literal|0
expr_stmt|;
name|res
operator|=
name|PQexec
argument_list|(
name|trans
operator|->
name|handle
operator|->
name|conn
argument_list|,
literal|"ROLLBACK"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|PQexec
argument_list|(
name|trans
operator|->
name|handle
operator|->
name|conn
argument_list|,
literal|"COMMIT"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
condition|)
block|{
name|ret
operator|=
name|PQresultStatus
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbd_pgsql_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|PQclear
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|PGRES_FATAL_ERROR
expr_stmt|;
block|}
name|trans
operator|->
name|handle
operator|->
name|trans
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_transaction_mode_get
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|)
block|{
if|if
condition|(
operator|!
name|trans
condition|)
return|return
name|APR_DBD_TRANSACTION_COMMIT
return|;
return|return
name|trans
operator|->
name|mode
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_transaction_mode_set
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|!
name|trans
condition|)
return|return
name|APR_DBD_TRANSACTION_COMMIT
return|;
return|return
name|trans
operator|->
name|mode
operator|=
operator|(
name|mode
operator|&
name|TXN_MODE_BITS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|null_notice_receiver
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
specifier|const
name|PGresult
modifier|*
name|res
parameter_list|)
block|{
comment|/* nothing */
block|}
end_function

begin_function
specifier|static
name|void
name|null_notice_processor
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
specifier|const
name|char
modifier|*
name|message
parameter_list|)
block|{
comment|/* nothing */
block|}
end_function

begin_function
specifier|static
name|apr_dbd_t
modifier|*
name|dbd_pgsql_open
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|apr_dbd_t
modifier|*
name|sql
decl_stmt|;
name|PGconn
modifier|*
name|conn
init|=
name|PQconnectdb
argument_list|(
name|params
argument_list|)
decl_stmt|;
comment|/* if there's an error in the connect string or something we get      * back a * bogus connection object, and things like PQreset are      * liable to segfault, so just close it out now.  it would be nice      * if we could give an indication of why we failed to connect... */
if|if
condition|(
name|PQstatus
argument_list|(
name|conn
argument_list|)
operator|!=
name|CONNECTION_OK
condition|)
block|{
if|if
condition|(
name|error
condition|)
block|{
operator|*
name|error
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|PQerrorMessage
argument_list|(
name|conn
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|PQfinish
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|PQsetNoticeReceiver
argument_list|(
name|conn
argument_list|,
name|null_notice_receiver
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|PQsetNoticeProcessor
argument_list|(
name|conn
argument_list|,
name|null_notice_processor
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|sql
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sql
argument_list|)
argument_list|)
expr_stmt|;
name|sql
operator|->
name|conn
operator|=
name|conn
expr_stmt|;
return|return
name|sql
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_pgsql_close
parameter_list|(
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
name|PQfinish
argument_list|(
name|handle
operator|->
name|conn
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_pgsql_check_conn
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
if|if
condition|(
name|PQstatus
argument_list|(
name|handle
operator|->
name|conn
argument_list|)
operator|!=
name|CONNECTION_OK
condition|)
block|{
name|PQreset
argument_list|(
name|handle
operator|->
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|PQstatus
argument_list|(
name|handle
operator|->
name|conn
argument_list|)
operator|!=
name|CONNECTION_OK
condition|)
block|{
return|return
name|APR_EGENERAL
return|;
block|}
block|}
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_select_db
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|dbd_pgsql_native
parameter_list|(
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
return|return
name|handle
operator|->
name|conn
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_num_cols
parameter_list|(
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|)
block|{
return|return
name|res
operator|->
name|sz
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_pgsql_num_tuples
parameter_list|(
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|)
block|{
if|if
condition|(
name|res
operator|->
name|random
condition|)
block|{
return|return
name|res
operator|->
name|ntuples
return|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_decl_stmt
name|APU_MODULE_DECLARE_DATA
specifier|const
name|apr_dbd_driver_t
name|apr_dbd_pgsql_driver
init|=
block|{
literal|"pgsql"
block|,
name|NULL
block|,
name|dbd_pgsql_native
block|,
name|dbd_pgsql_open
block|,
name|dbd_pgsql_check_conn
block|,
name|dbd_pgsql_close
block|,
name|dbd_pgsql_select_db
block|,
name|dbd_pgsql_start_transaction
block|,
name|dbd_pgsql_end_transaction
block|,
name|dbd_pgsql_query
block|,
name|dbd_pgsql_select
block|,
name|dbd_pgsql_num_cols
block|,
name|dbd_pgsql_num_tuples
block|,
name|dbd_pgsql_get_row
block|,
name|dbd_pgsql_get_entry
block|,
name|dbd_pgsql_error
block|,
name|dbd_pgsql_escape
block|,
name|dbd_pgsql_prepare
block|,
name|dbd_pgsql_pvquery
block|,
name|dbd_pgsql_pvselect
block|,
name|dbd_pgsql_pquery
block|,
name|dbd_pgsql_pselect
block|,
name|dbd_pgsql_get_name
block|,
name|dbd_pgsql_transaction_mode_get
block|,
name|dbd_pgsql_transaction_mode_set
block|,
literal|"$%d"
block|,
name|dbd_pgsql_pvbquery
block|,
name|dbd_pgsql_pvbselect
block|,
name|dbd_pgsql_pbquery
block|,
name|dbd_pgsql_pbselect
block|,
name|dbd_pgsql_datum_get
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


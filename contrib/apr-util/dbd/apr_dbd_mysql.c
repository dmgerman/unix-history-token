begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|"apu.h"
end_include

begin_if
if|#
directive|if
name|APU_HAVE_MYSQL
end_if

begin_include
include|#
directive|include
file|"apu_version.h"
end_include

begin_include
include|#
directive|include
file|"apu_config.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_MYSQL_MYSQL_H
argument_list|)
end_if

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_MYSQL_MY_GLOBAL_H
argument_list|)
end_if

begin_include
include|#
directive|include
file|<mysql/my_global.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_MYSQL_MY_SYS_H
argument_list|)
end_if

begin_include
include|#
directive|include
file|<mysql/my_sys.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<mysql/mysql.h>
end_include

begin_include
include|#
directive|include
file|<mysql/errmsg.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* !defined(HAVE_MYSQL_MYSQL_H) */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_MY_GLOBAL_H
argument_list|)
end_if

begin_include
include|#
directive|include
file|<my_global.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_MY_SYS_H
argument_list|)
end_if

begin_include
include|#
directive|include
file|<my_sys.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<mysql.h>
end_include

begin_include
include|#
directive|include
file|<errmsg.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"apr_strings.h"
end_include

begin_include
include|#
directive|include
file|"apr_lib.h"
end_include

begin_include
include|#
directive|include
file|"apr_buckets.h"
end_include

begin_include
include|#
directive|include
file|"apr_dbd_internal.h"
end_include

begin_comment
comment|/* default maximum field size 1 MB */
end_comment

begin_define
define|#
directive|define
name|FIELDSIZE
value|1048575
end_define

begin_struct
struct|struct
name|apr_dbd_prepared_t
block|{
name|MYSQL_STMT
modifier|*
name|stmt
decl_stmt|;
name|int
name|nargs
decl_stmt|;
name|int
name|nvals
decl_stmt|;
name|apr_dbd_type_e
modifier|*
name|types
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_transaction_t
block|{
name|int
name|mode
decl_stmt|;
name|int
name|errnum
decl_stmt|;
name|apr_dbd_t
modifier|*
name|handle
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_t
block|{
name|MYSQL
modifier|*
name|conn
decl_stmt|;
name|apr_dbd_transaction_t
modifier|*
name|trans
decl_stmt|;
name|unsigned
name|long
name|fldsz
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_results_t
block|{
name|int
name|random
decl_stmt|;
name|MYSQL_RES
modifier|*
name|res
decl_stmt|;
name|MYSQL_STMT
modifier|*
name|statement
decl_stmt|;
name|MYSQL_BIND
modifier|*
name|bind
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_row_t
block|{
name|MYSQL_ROW
name|row
decl_stmt|;
name|apr_dbd_results_t
modifier|*
name|res
decl_stmt|;
name|unsigned
name|long
modifier|*
name|len
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* MySQL specific bucket for BLOB types */
end_comment

begin_typedef
typedef|typedef
name|struct
name|apr_bucket_lob
name|apr_bucket_lob
typedef|;
end_typedef

begin_comment
comment|/**  * A bucket referring to a MySQL BLOB  */
end_comment

begin_struct
struct|struct
name|apr_bucket_lob
block|{
comment|/** Number of buckets using this memory */
name|apr_bucket_refcount
name|refcount
decl_stmt|;
comment|/** The row this bucket refers to */
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
decl_stmt|;
comment|/** The column this bucket refers to */
name|int
name|col
decl_stmt|;
comment|/** The pool into which any needed structures should      *  be created while reading from this bucket */
name|apr_pool_t
modifier|*
name|readpool
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|lob_bucket_destroy
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|apr_status_t
name|lob_bucket_read
parameter_list|(
name|apr_bucket
modifier|*
name|e
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|str
parameter_list|,
name|apr_size_t
modifier|*
name|len
parameter_list|,
name|apr_read_type_e
name|block
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|apr_bucket
modifier|*
name|apr_bucket_lob_make
parameter_list|(
name|apr_bucket
modifier|*
name|b
parameter_list|,
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|col
parameter_list|,
name|apr_off_t
name|offset
parameter_list|,
name|apr_size_t
name|len
parameter_list|,
name|apr_pool_t
modifier|*
name|p
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|apr_bucket
modifier|*
name|apr_bucket_lob_create
parameter_list|(
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|col
parameter_list|,
name|apr_off_t
name|offset
parameter_list|,
name|apr_size_t
name|len
parameter_list|,
name|apr_pool_t
modifier|*
name|p
parameter_list|,
name|apr_bucket_alloc_t
modifier|*
name|list
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|dbd_mysql_num_cols
parameter_list|(
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|apr_bucket_type_t
name|apr_bucket_type_lob
init|=
block|{
literal|"LOB"
block|,
literal|5
block|,
name|APR_BUCKET_DATA
block|,
name|lob_bucket_destroy
block|,
name|lob_bucket_read
block|,
name|apr_bucket_setaside_notimpl
block|,
name|apr_bucket_shared_split
block|,
name|apr_bucket_shared_copy
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|lob_bucket_destroy
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|apr_bucket_lob
modifier|*
name|f
init|=
name|data
decl_stmt|;
if|if
condition|(
name|apr_bucket_shared_destroy
argument_list|(
name|f
argument_list|)
condition|)
block|{
comment|/* no need to destroy database objects here; it will get          * done automatically when the pool gets cleaned up */
name|apr_bucket_free
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|lob_bucket_read
parameter_list|(
name|apr_bucket
modifier|*
name|e
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|str
parameter_list|,
name|apr_size_t
modifier|*
name|len
parameter_list|,
name|apr_read_type_e
name|block
parameter_list|)
block|{
name|apr_bucket_lob
modifier|*
name|a
init|=
name|e
operator|->
name|data
decl_stmt|;
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
init|=
name|a
operator|->
name|row
decl_stmt|;
name|apr_dbd_results_t
modifier|*
name|res
init|=
name|row
operator|->
name|res
decl_stmt|;
name|int
name|col
init|=
name|a
operator|->
name|col
decl_stmt|;
name|apr_bucket
modifier|*
name|b
init|=
name|NULL
decl_stmt|;
name|int
name|rv
decl_stmt|;
name|apr_size_t
name|blength
init|=
name|e
operator|->
name|length
decl_stmt|;
comment|/* bytes remaining in file past offset */
name|apr_off_t
name|boffset
init|=
name|e
operator|->
name|start
decl_stmt|;
name|MYSQL_BIND
modifier|*
name|bind
init|=
operator|&
name|res
operator|->
name|bind
index|[
name|col
index|]
decl_stmt|;
operator|*
name|str
operator|=
name|NULL
expr_stmt|;
comment|/* in case we die prematurely */
comment|/* fetch from offset if not at the beginning */
if|if
condition|(
name|boffset
operator|>
literal|0
condition|)
block|{
name|rv
operator|=
name|mysql_stmt_fetch_column
argument_list|(
name|res
operator|->
name|statement
argument_list|,
name|bind
argument_list|,
name|col
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|boffset
argument_list|)
expr_stmt|;
if|if
condition|(
name|rv
operator|!=
literal|0
condition|)
block|{
return|return
name|APR_EGENERAL
return|;
block|}
block|}
name|blength
operator|-=
name|blength
operator|>
name|bind
operator|->
name|buffer_length
condition|?
name|bind
operator|->
name|buffer_length
else|:
name|blength
expr_stmt|;
operator|*
name|len
operator|=
name|e
operator|->
name|length
operator|-
name|blength
expr_stmt|;
operator|*
name|str
operator|=
name|bind
operator|->
name|buffer
expr_stmt|;
comment|/* allocate new buffer, since we used this one for the bucket */
name|bind
operator|->
name|buffer
operator|=
name|apr_palloc
argument_list|(
name|res
operator|->
name|pool
argument_list|,
name|bind
operator|->
name|buffer_length
argument_list|)
expr_stmt|;
comment|/*      * Change the current bucket to refer to what we read,      * even if we read nothing because we hit EOF.      */
name|apr_bucket_pool_make
argument_list|(
name|e
argument_list|,
operator|*
name|str
argument_list|,
operator|*
name|len
argument_list|,
name|res
operator|->
name|pool
argument_list|)
expr_stmt|;
comment|/* If we have more to read from the field, then create another bucket */
if|if
condition|(
name|blength
operator|>
literal|0
condition|)
block|{
comment|/* for efficiency, we can just build a new apr_bucket struct          * to wrap around the existing LOB bucket */
name|b
operator|=
name|apr_bucket_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|b
argument_list|)
argument_list|,
name|e
operator|->
name|list
argument_list|)
expr_stmt|;
name|b
operator|->
name|start
operator|=
name|boffset
operator|+
operator|*
name|len
expr_stmt|;
name|b
operator|->
name|length
operator|=
name|blength
expr_stmt|;
name|b
operator|->
name|data
operator|=
name|a
expr_stmt|;
name|b
operator|->
name|type
operator|=
operator|&
name|apr_bucket_type_lob
expr_stmt|;
name|b
operator|->
name|free
operator|=
name|apr_bucket_free
expr_stmt|;
name|b
operator|->
name|list
operator|=
name|e
operator|->
name|list
expr_stmt|;
name|APR_BUCKET_INSERT_AFTER
argument_list|(
name|e
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|lob_bucket_destroy
argument_list|(
name|a
argument_list|)
expr_stmt|;
block|}
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|apr_bucket
modifier|*
name|apr_bucket_lob_make
parameter_list|(
name|apr_bucket
modifier|*
name|b
parameter_list|,
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|col
parameter_list|,
name|apr_off_t
name|offset
parameter_list|,
name|apr_size_t
name|len
parameter_list|,
name|apr_pool_t
modifier|*
name|p
parameter_list|)
block|{
name|apr_bucket_lob
modifier|*
name|f
decl_stmt|;
name|f
operator|=
name|apr_bucket_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|f
argument_list|)
argument_list|,
name|b
operator|->
name|list
argument_list|)
expr_stmt|;
name|f
operator|->
name|row
operator|=
name|row
expr_stmt|;
name|f
operator|->
name|col
operator|=
name|col
expr_stmt|;
name|f
operator|->
name|readpool
operator|=
name|p
expr_stmt|;
name|b
operator|=
name|apr_bucket_shared_make
argument_list|(
name|b
argument_list|,
name|f
argument_list|,
name|offset
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|b
operator|->
name|type
operator|=
operator|&
name|apr_bucket_type_lob
expr_stmt|;
return|return
name|b
return|;
block|}
end_function

begin_function
specifier|static
name|apr_bucket
modifier|*
name|apr_bucket_lob_create
parameter_list|(
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|col
parameter_list|,
name|apr_off_t
name|offset
parameter_list|,
name|apr_size_t
name|len
parameter_list|,
name|apr_pool_t
modifier|*
name|p
parameter_list|,
name|apr_bucket_alloc_t
modifier|*
name|list
parameter_list|)
block|{
name|apr_bucket
modifier|*
name|b
init|=
name|apr_bucket_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|b
argument_list|)
argument_list|,
name|list
argument_list|)
decl_stmt|;
name|APR_BUCKET_INIT
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|b
operator|->
name|free
operator|=
name|apr_bucket_free
expr_stmt|;
name|b
operator|->
name|list
operator|=
name|list
expr_stmt|;
return|return
name|apr_bucket_lob_make
argument_list|(
name|b
argument_list|,
name|row
argument_list|,
name|col
argument_list|,
name|offset
argument_list|,
name|len
argument_list|,
name|p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|free_result
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|mysql_free_result
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_select
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|,
name|int
name|seek
parameter_list|)
block|{
name|int
name|sz
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|ret
operator|=
name|mysql_query
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
if|if
condition|(
name|sz
operator|=
name|mysql_field_count
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
operator|,
name|sz
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|*
name|results
condition|)
block|{
operator|*
name|results
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_results_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|results
operator|)
operator|->
name|random
operator|=
name|seek
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|statement
operator|=
name|NULL
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
if|if
condition|(
name|seek
condition|)
block|{
operator|(
operator|*
name|results
operator|)
operator|->
name|res
operator|=
name|mysql_store_result
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
name|results
operator|)
operator|->
name|res
operator|=
name|mysql_use_result
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
expr_stmt|;
block|}
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
operator|(
operator|*
name|results
operator|)
operator|->
name|res
argument_list|,
name|free_result
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|mysql_errno
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_mysql_get_name
parameter_list|(
specifier|const
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|,
name|int
name|n
parameter_list|)
block|{
if|if
condition|(
operator|(
name|n
operator|<
literal|0
operator|)
operator|||
operator|(
name|n
operator|>=
operator|(
name|int
operator|)
name|mysql_num_fields
argument_list|(
name|res
operator|->
name|res
argument_list|)
operator|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|mysql_fetch_fields
argument_list|(
name|res
operator|->
name|res
argument_list|)
index|[
name|n
index|]
operator|.
name|name
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_get_row
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|,
name|apr_dbd_row_t
modifier|*
modifier|*
name|row
parameter_list|,
name|int
name|rownum
parameter_list|)
block|{
name|MYSQL_ROW
name|r
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|res
operator|->
name|statement
condition|)
block|{
if|if
condition|(
name|res
operator|->
name|random
condition|)
block|{
if|if
condition|(
name|rownum
operator|>
literal|0
condition|)
block|{
name|mysql_stmt_data_seek
argument_list|(
name|res
operator|->
name|statement
argument_list|,
operator|(
name|my_ulonglong
operator|)
operator|--
name|rownum
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
comment|/* invalid row */
block|}
block|}
name|ret
operator|=
name|mysql_stmt_fetch
argument_list|(
name|res
operator|->
name|statement
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ret
condition|)
block|{
case|case
literal|1
case|:
name|ret
operator|=
name|mysql_stmt_errno
argument_list|(
name|res
operator|->
name|statement
argument_list|)
expr_stmt|;
break|break;
case|case
name|MYSQL_NO_DATA
case|:
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
literal|0
expr_stmt|;
comment|/* bad luck - get_entry will deal with this */
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
name|res
operator|->
name|random
condition|)
block|{
if|if
condition|(
name|rownum
operator|>
literal|0
condition|)
block|{
name|mysql_data_seek
argument_list|(
name|res
operator|->
name|res
argument_list|,
operator|(
name|my_ulonglong
operator|)
operator|--
name|rownum
argument_list|)
expr_stmt|;
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
comment|/* invalid row */
block|}
block|}
name|r
operator|=
name|mysql_fetch_row
argument_list|(
name|res
operator|->
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
operator|*
name|row
condition|)
block|{
operator|*
name|row
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_row_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|row
operator|)
operator|->
name|row
operator|=
name|r
expr_stmt|;
operator|(
operator|*
name|row
operator|)
operator|->
name|res
operator|=
name|res
expr_stmt|;
operator|(
operator|*
name|row
operator|)
operator|->
name|len
operator|=
name|mysql_fetch_lengths
argument_list|(
name|res
operator|->
name|res
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|apr_pool_cleanup_run
argument_list|(
name|res
operator|->
name|pool
argument_list|,
name|res
operator|->
name|res
argument_list|,
name|free_result
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* An improved API that was proposed but not followed up */
end_comment

begin_else
unit|static int dbd_mysql_get_entry(const apr_dbd_row_t *row, int n,                                apr_dbd_datum_t *val) {     MYSQL_BIND *bind;     if (dbd_mysql_num_cols(row->res)<= n) {     	return NULL;     }     if (row->res->statement) {         bind =&row->res->bind[n];         if (mysql_stmt_fetch_column(row->res->statement, bind, n, 0) != 0) {             val->type = APR_DBD_VALUE_NULL;             return -1;         }         if (*bind->is_null) {             val->type = APR_DBD_VALUE_NULL;             return -1;         }         else {             val->type = APR_DBD_VALUE_STRING;             val->value.stringval = bind->buffer;         }     }     else {         val->type = APR_DBD_VALUE_STRING;         val->value.stringval = row->row[n];     }     return 0; }
else|#
directive|else
end_else

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_mysql_get_entry
parameter_list|(
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|MYSQL_BIND
modifier|*
name|bind
decl_stmt|;
if|if
condition|(
name|dbd_mysql_num_cols
argument_list|(
name|row
operator|->
name|res
argument_list|)
operator|<=
name|n
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|row
operator|->
name|res
operator|->
name|statement
condition|)
block|{
name|bind
operator|=
operator|&
name|row
operator|->
name|res
operator|->
name|bind
index|[
name|n
index|]
expr_stmt|;
if|if
condition|(
name|mysql_stmt_fetch_column
argument_list|(
name|row
operator|->
name|res
operator|->
name|statement
argument_list|,
name|bind
argument_list|,
name|n
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|*
name|bind
operator|->
name|is_null
condition|)
block|{
return|return
name|NULL
return|;
block|}
else|else
block|{
return|return
name|bind
operator|->
name|buffer
return|;
block|}
block|}
else|else
block|{
return|return
name|row
operator|->
name|row
index|[
name|n
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|apr_status_t
name|dbd_mysql_datum_get
parameter_list|(
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|n
parameter_list|,
name|apr_dbd_type_e
name|type
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|row
operator|->
name|res
operator|->
name|statement
condition|)
block|{
name|MYSQL_BIND
modifier|*
name|bind
init|=
operator|&
name|row
operator|->
name|res
operator|->
name|bind
index|[
name|n
index|]
decl_stmt|;
name|unsigned
name|long
name|len
init|=
operator|*
name|bind
operator|->
name|length
decl_stmt|;
if|if
condition|(
name|mysql_stmt_fetch_column
argument_list|(
name|row
operator|->
name|res
operator|->
name|statement
argument_list|,
name|bind
argument_list|,
name|n
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
return|return
name|APR_EGENERAL
return|;
block|}
if|if
condition|(
operator|*
name|bind
operator|->
name|is_null
condition|)
block|{
return|return
name|APR_ENOENT
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|APR_DBD_TYPE_TINY
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UTINY
case|:
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_SHORT
case|:
operator|*
operator|(
name|short
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_USHORT
case|:
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_INT
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UINT
case|:
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONG
case|:
operator|*
operator|(
name|long
operator|*
operator|)
name|data
operator|=
name|atol
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONG
case|:
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|data
operator|=
name|atol
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONGLONG
case|:
operator|*
operator|(
name|apr_int64_t
operator|*
operator|)
name|data
operator|=
name|apr_atoi64
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONGLONG
case|:
operator|*
operator|(
name|apr_uint64_t
operator|*
operator|)
name|data
operator|=
name|apr_atoi64
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_FLOAT
case|:
operator|*
operator|(
name|float
operator|*
operator|)
name|data
operator|=
operator|(
name|float
operator|)
name|atof
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DOUBLE
case|:
operator|*
operator|(
name|double
operator|*
operator|)
name|data
operator|=
name|atof
argument_list|(
name|bind
operator|->
name|buffer
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_STRING
case|:
case|case
name|APR_DBD_TYPE_TEXT
case|:
case|case
name|APR_DBD_TYPE_TIME
case|:
case|case
name|APR_DBD_TYPE_DATE
case|:
case|case
name|APR_DBD_TYPE_DATETIME
case|:
case|case
name|APR_DBD_TYPE_TIMESTAMP
case|:
case|case
name|APR_DBD_TYPE_ZTIMESTAMP
case|:
operator|*
operator|(
operator|(
name|char
operator|*
operator|)
name|bind
operator|->
name|buffer
operator|+
name|bind
operator|->
name|buffer_length
operator|-
literal|1
operator|)
operator|=
literal|'\0'
expr_stmt|;
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|data
operator|=
name|bind
operator|->
name|buffer
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
block|{
name|apr_bucket
modifier|*
name|e
decl_stmt|;
name|apr_bucket_brigade
modifier|*
name|b
init|=
operator|(
name|apr_bucket_brigade
operator|*
operator|)
name|data
decl_stmt|;
name|e
operator|=
name|apr_bucket_lob_create
argument_list|(
name|row
argument_list|,
name|n
argument_list|,
literal|0
argument_list|,
name|len
argument_list|,
name|row
operator|->
name|res
operator|->
name|pool
argument_list|,
name|b
operator|->
name|bucket_alloc
argument_list|)
expr_stmt|;
name|APR_BRIGADE_INSERT_TAIL
argument_list|(
name|b
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|APR_DBD_TYPE_NULL
case|:
operator|*
operator|(
name|void
operator|*
operator|*
operator|)
name|data
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
return|return
name|APR_EGENERAL
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|row
operator|->
name|row
index|[
name|n
index|]
operator|==
name|NULL
condition|)
block|{
return|return
name|APR_ENOENT
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|APR_DBD_TYPE_TINY
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UTINY
case|:
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_SHORT
case|:
operator|*
operator|(
name|short
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_USHORT
case|:
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_INT
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UINT
case|:
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONG
case|:
operator|*
operator|(
name|long
operator|*
operator|)
name|data
operator|=
name|atol
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONG
case|:
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|data
operator|=
name|atol
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONGLONG
case|:
operator|*
operator|(
name|apr_int64_t
operator|*
operator|)
name|data
operator|=
name|apr_atoi64
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONGLONG
case|:
operator|*
operator|(
name|apr_uint64_t
operator|*
operator|)
name|data
operator|=
name|apr_atoi64
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_FLOAT
case|:
operator|*
operator|(
name|float
operator|*
operator|)
name|data
operator|=
operator|(
name|float
operator|)
name|atof
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DOUBLE
case|:
operator|*
operator|(
name|double
operator|*
operator|)
name|data
operator|=
name|atof
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_STRING
case|:
case|case
name|APR_DBD_TYPE_TEXT
case|:
case|case
name|APR_DBD_TYPE_TIME
case|:
case|case
name|APR_DBD_TYPE_DATE
case|:
case|case
name|APR_DBD_TYPE_DATETIME
case|:
case|case
name|APR_DBD_TYPE_TIMESTAMP
case|:
case|case
name|APR_DBD_TYPE_ZTIMESTAMP
case|:
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|data
operator|=
name|row
operator|->
name|row
index|[
name|n
index|]
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
block|{
name|apr_bucket
modifier|*
name|e
decl_stmt|;
name|apr_bucket_brigade
modifier|*
name|b
init|=
operator|(
name|apr_bucket_brigade
operator|*
operator|)
name|data
decl_stmt|;
name|e
operator|=
name|apr_bucket_pool_create
argument_list|(
name|row
operator|->
name|row
index|[
name|n
index|]
argument_list|,
name|row
operator|->
name|len
index|[
name|n
index|]
argument_list|,
name|row
operator|->
name|res
operator|->
name|pool
argument_list|,
name|b
operator|->
name|bucket_alloc
argument_list|)
expr_stmt|;
name|APR_BRIGADE_INSERT_TAIL
argument_list|(
name|b
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|APR_DBD_TYPE_NULL
case|:
operator|*
operator|(
name|void
operator|*
operator|*
operator|)
name|data
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
return|return
name|APR_EGENERAL
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_mysql_error
parameter_list|(
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
name|n
parameter_list|)
block|{
return|return
name|mysql_error
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_query
parameter_list|(
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|ret
operator|=
name|mysql_query
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|mysql_errno
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
expr_stmt|;
block|}
operator|*
name|nrows
operator|=
operator|(
name|int
operator|)
name|mysql_affected_rows
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_mysql_escape
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|)
block|{
name|unsigned
name|long
name|len
init|=
name|strlen
argument_list|(
name|arg
argument_list|)
decl_stmt|;
name|char
modifier|*
name|ret
init|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
literal|2
operator|*
name|len
operator|+
literal|1
argument_list|)
decl_stmt|;
name|mysql_real_escape_string
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|ret
argument_list|,
name|arg
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|stmt_close
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|mysql_stmt_close
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_prepare
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|int
name|nargs
parameter_list|,
name|int
name|nvals
parameter_list|,
name|apr_dbd_type_e
modifier|*
name|types
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
modifier|*
name|statement
parameter_list|)
block|{
comment|/* Translate from apr_dbd to native query format */
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
operator|*
name|statement
condition|)
block|{
operator|*
name|statement
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_prepared_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|statement
operator|)
operator|->
name|stmt
operator|=
name|mysql_stmt_init
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|statement
operator|)
operator|->
name|stmt
condition|)
block|{
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
operator|(
operator|*
name|statement
operator|)
operator|->
name|stmt
argument_list|,
name|stmt_close
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
name|ret
operator|=
name|mysql_stmt_prepare
argument_list|(
operator|(
operator|*
name|statement
operator|)
operator|->
name|stmt
argument_list|,
name|query
argument_list|,
name|strlen
argument_list|(
name|query
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|mysql_stmt_errno
argument_list|(
operator|(
operator|*
name|statement
operator|)
operator|->
name|stmt
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|statement
operator|)
operator|->
name|nargs
operator|=
name|nargs
expr_stmt|;
operator|(
operator|*
name|statement
operator|)
operator|->
name|nvals
operator|=
name|nvals
expr_stmt|;
operator|(
operator|*
name|statement
operator|)
operator|->
name|types
operator|=
name|types
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
name|CR_OUT_OF_MEMORY
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dbd_mysql_bind
parameter_list|(
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|,
name|MYSQL_BIND
modifier|*
name|bind
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nargs
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
name|bind
index|[
name|i
index|]
operator|.
name|length
operator|=
operator|&
name|bind
index|[
name|i
index|]
operator|.
name|buffer_length
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|0
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_null
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|values
index|[
name|j
index|]
operator|==
name|NULL
condition|)
block|{
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_NULL
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|statement
operator|->
name|types
index|[
name|i
index|]
condition|)
block|{
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONG_BLOB
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
operator|(
name|void
operator|*
operator|)
name|values
index|[
name|j
index|]
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_length
operator|=
name|atol
argument_list|(
name|values
index|[
operator|++
name|j
index|]
argument_list|)
expr_stmt|;
comment|/* skip table and column */
name|j
operator|+=
literal|2
expr_stmt|;
break|break;
default|default:
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_VAR_STRING
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
operator|(
name|void
operator|*
operator|)
name|values
index|[
name|j
index|]
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_length
operator|=
name|strlen
argument_list|(
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_pquery_internal
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|MYSQL_BIND
modifier|*
name|bind
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|mysql_stmt_bind_param
argument_list|(
name|statement
operator|->
name|stmt
argument_list|,
name|bind
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
operator|*
name|nrows
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|mysql_stmt_errno
argument_list|(
name|statement
operator|->
name|stmt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|mysql_stmt_execute
argument_list|(
name|statement
operator|->
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|mysql_stmt_errno
argument_list|(
name|statement
operator|->
name|stmt
argument_list|)
expr_stmt|;
block|}
operator|*
name|nrows
operator|=
operator|(
name|int
operator|)
name|mysql_stmt_affected_rows
argument_list|(
name|statement
operator|->
name|stmt
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_pquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|MYSQL_BIND
modifier|*
name|bind
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|bind
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|statement
operator|->
name|nargs
operator|*
sizeof|sizeof
argument_list|(
name|MYSQL_BIND
argument_list|)
argument_list|)
expr_stmt|;
name|dbd_mysql_bind
argument_list|(
name|statement
argument_list|,
name|values
argument_list|,
name|bind
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dbd_mysql_pquery_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|nrows
argument_list|,
name|statement
argument_list|,
name|bind
argument_list|)
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_pvquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|char
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_mysql_pquery
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|nrows
argument_list|,
name|statement
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_pselect_internal
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|res
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|random
parameter_list|,
name|MYSQL_BIND
modifier|*
name|bind
parameter_list|)
block|{
name|int
name|nfields
decl_stmt|,
name|i
decl_stmt|;
name|my_bool
modifier|*
name|is_nullr
decl_stmt|;
if|#
directive|if
name|MYSQL_VERSION_ID
operator|>=
literal|50000
name|my_bool
modifier|*
name|error
decl_stmt|;
endif|#
directive|endif
name|int
name|ret
decl_stmt|;
name|unsigned
name|long
modifier|*
name|length
decl_stmt|,
name|maxlen
decl_stmt|;
name|ret
operator|=
name|mysql_stmt_bind_param
argument_list|(
name|statement
operator|->
name|stmt
argument_list|,
name|bind
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|mysql_stmt_execute
argument_list|(
name|statement
operator|->
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
if|if
condition|(
operator|!
operator|*
name|res
condition|)
block|{
operator|*
name|res
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_results_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|res
operator|)
operator|->
name|random
operator|=
name|random
expr_stmt|;
operator|(
operator|*
name|res
operator|)
operator|->
name|statement
operator|=
name|statement
operator|->
name|stmt
expr_stmt|;
operator|(
operator|*
name|res
operator|)
operator|->
name|res
operator|=
name|mysql_stmt_result_metadata
argument_list|(
name|statement
operator|->
name|stmt
argument_list|)
expr_stmt|;
operator|(
operator|*
name|res
operator|)
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
operator|(
operator|*
name|res
operator|)
operator|->
name|res
argument_list|,
name|free_result
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
name|nfields
operator|=
name|mysql_num_fields
argument_list|(
operator|(
operator|*
name|res
operator|)
operator|->
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
operator|*
name|res
operator|)
operator|->
name|bind
condition|)
block|{
operator|(
operator|*
name|res
operator|)
operator|->
name|bind
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|nfields
operator|*
sizeof|sizeof
argument_list|(
name|MYSQL_BIND
argument_list|)
argument_list|)
expr_stmt|;
name|length
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
name|nfields
operator|*
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
argument_list|)
expr_stmt|;
if|#
directive|if
name|MYSQL_VERSION_ID
operator|>=
literal|50000
name|error
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|nfields
operator|*
sizeof|sizeof
argument_list|(
name|my_bool
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|is_nullr
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
name|nfields
operator|*
sizeof|sizeof
argument_list|(
name|my_bool
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nfields
condition|;
operator|++
name|i
control|)
block|{
name|maxlen
operator|=
operator|(
operator|(
operator|*
name|res
operator|)
operator|->
name|res
operator|->
name|fields
index|[
name|i
index|]
operator|.
name|length
operator|<
name|sql
operator|->
name|fldsz
condition|?
operator|(
operator|*
name|res
operator|)
operator|->
name|res
operator|->
name|fields
index|[
name|i
index|]
operator|.
name|length
else|:
name|sql
operator|->
name|fldsz
operator|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|res
operator|)
operator|->
name|res
operator|->
name|fields
index|[
name|i
index|]
operator|.
name|type
operator|==
name|MYSQL_TYPE_BLOB
condition|)
block|{
operator|(
operator|*
name|res
operator|)
operator|->
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONG_BLOB
expr_stmt|;
block|}
else|else
block|{
operator|(
operator|*
name|res
operator|)
operator|->
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_VAR_STRING
expr_stmt|;
block|}
operator|(
operator|*
name|res
operator|)
operator|->
name|bind
index|[
name|i
index|]
operator|.
name|buffer_length
operator|=
name|maxlen
expr_stmt|;
operator|(
operator|*
name|res
operator|)
operator|->
name|bind
index|[
name|i
index|]
operator|.
name|length
operator|=
operator|&
name|length
index|[
name|i
index|]
expr_stmt|;
operator|(
operator|*
name|res
operator|)
operator|->
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|maxlen
argument_list|)
expr_stmt|;
operator|(
operator|*
name|res
operator|)
operator|->
name|bind
index|[
name|i
index|]
operator|.
name|is_null
operator|=
name|is_nullr
operator|+
name|i
expr_stmt|;
if|#
directive|if
name|MYSQL_VERSION_ID
operator|>=
literal|50000
operator|(
operator|*
name|res
operator|)
operator|->
name|bind
index|[
name|i
index|]
operator|.
name|error
operator|=
name|error
operator|+
name|i
expr_stmt|;
endif|#
directive|endif
block|}
block|}
name|ret
operator|=
name|mysql_stmt_bind_result
argument_list|(
name|statement
operator|->
name|stmt
argument_list|,
operator|(
operator|*
name|res
operator|)
operator|->
name|bind
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|ret
operator|=
name|mysql_stmt_store_result
argument_list|(
name|statement
operator|->
name|stmt
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|mysql_stmt_errno
argument_list|(
name|statement
operator|->
name|stmt
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_pselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|res
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|random
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|args
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|MYSQL_BIND
modifier|*
name|bind
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|bind
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|statement
operator|->
name|nargs
operator|*
sizeof|sizeof
argument_list|(
name|MYSQL_BIND
argument_list|)
argument_list|)
expr_stmt|;
name|dbd_mysql_bind
argument_list|(
name|statement
argument_list|,
name|args
argument_list|,
name|bind
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dbd_mysql_pselect_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|res
argument_list|,
name|statement
argument_list|,
name|random
argument_list|,
name|bind
argument_list|)
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_pvselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|res
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|random
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|char
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_mysql_pselect
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|res
argument_list|,
name|statement
argument_list|,
name|random
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dbd_mysql_bbind
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|values
parameter_list|,
name|MYSQL_BIND
modifier|*
name|bind
parameter_list|)
block|{
name|void
modifier|*
name|arg
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|apr_dbd_type_e
name|type
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nargs
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
name|arg
operator|=
operator|(
name|void
operator|*
operator|)
name|values
index|[
name|j
index|]
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|length
operator|=
operator|&
name|bind
index|[
name|i
index|]
operator|.
name|buffer_length
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_null
operator|=
name|NULL
expr_stmt|;
name|type
operator|=
operator|(
name|arg
operator|==
name|NULL
condition|?
name|APR_DBD_TYPE_NULL
else|:
name|statement
operator|->
name|types
index|[
name|i
index|]
operator|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|APR_DBD_TYPE_TINY
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_TINY
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UTINY
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_TINY
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_SHORT
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_SHORT
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_USHORT
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_SHORT
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_INT
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONG
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UINT
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONG
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONG
case|:
if|if
condition|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|long
argument_list|)
condition|)
block|{
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
block|}
else|else
block|{
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|int
operator|*
operator|)
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
operator|*
operator|(
name|long
operator|*
operator|)
name|arg
expr_stmt|;
block|}
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONG
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONG
case|:
if|if
condition|(
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
operator|==
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
condition|)
block|{
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
block|}
else|else
block|{
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|arg
expr_stmt|;
block|}
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONG
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONGLONG
case|:
if|if
condition|(
sizeof|sizeof
argument_list|(
name|my_ulonglong
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|apr_int64_t
argument_list|)
condition|)
block|{
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONGLONG
expr_stmt|;
block|}
else|else
block|{
comment|/* have to downsize, long long is not portable */
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|long
operator|*
operator|)
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
operator|(
name|long
operator|)
operator|*
operator|(
name|apr_int64_t
operator|*
operator|)
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONG
expr_stmt|;
block|}
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONGLONG
case|:
if|if
condition|(
sizeof|sizeof
argument_list|(
name|my_ulonglong
argument_list|)
operator|==
sizeof|sizeof
argument_list|(
name|apr_uint64_t
argument_list|)
condition|)
block|{
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONGLONG
expr_stmt|;
block|}
else|else
block|{
comment|/* have to downsize, long long is not portable */
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
operator|(
name|unsigned
name|long
operator|)
operator|*
operator|(
name|apr_uint64_t
operator|*
operator|)
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONG
expr_stmt|;
block|}
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_FLOAT
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_FLOAT
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DOUBLE
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_DOUBLE
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_STRING
case|:
case|case
name|APR_DBD_TYPE_TEXT
case|:
case|case
name|APR_DBD_TYPE_TIME
case|:
case|case
name|APR_DBD_TYPE_DATE
case|:
case|case
name|APR_DBD_TYPE_DATETIME
case|:
case|case
name|APR_DBD_TYPE_TIMESTAMP
case|:
case|case
name|APR_DBD_TYPE_ZTIMESTAMP
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_VAR_STRING
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|0
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_length
operator|=
name|strlen
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|arg
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
name|bind
index|[
name|i
index|]
operator|.
name|buffer
operator|=
operator|(
name|void
operator|*
operator|)
name|arg
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_LONG_BLOB
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|is_unsigned
operator|=
literal|0
expr_stmt|;
name|bind
index|[
name|i
index|]
operator|.
name|buffer_length
operator|=
operator|*
operator|(
name|apr_size_t
operator|*
operator|)
name|values
index|[
operator|++
name|j
index|]
expr_stmt|;
comment|/* skip table and column */
name|j
operator|+=
literal|2
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_NULL
case|:
default|default:
name|bind
index|[
name|i
index|]
operator|.
name|buffer_type
operator|=
name|MYSQL_TYPE_NULL
expr_stmt|;
break|break;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_pbquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|MYSQL_BIND
modifier|*
name|bind
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|bind
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|statement
operator|->
name|nargs
operator|*
sizeof|sizeof
argument_list|(
name|MYSQL_BIND
argument_list|)
argument_list|)
expr_stmt|;
name|dbd_mysql_bbind
argument_list|(
name|pool
argument_list|,
name|statement
argument_list|,
name|values
argument_list|,
name|bind
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dbd_mysql_pquery_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|nrows
argument_list|,
name|statement
argument_list|,
name|bind
argument_list|)
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_pvbquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|void
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_mysql_pbquery
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|nrows
argument_list|,
name|statement
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_pbselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|res
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|random
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|args
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|MYSQL_BIND
modifier|*
name|bind
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|bind
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|statement
operator|->
name|nargs
operator|*
sizeof|sizeof
argument_list|(
name|MYSQL_BIND
argument_list|)
argument_list|)
expr_stmt|;
name|dbd_mysql_bbind
argument_list|(
name|pool
argument_list|,
name|statement
argument_list|,
name|args
argument_list|,
name|bind
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dbd_mysql_pselect_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|res
argument_list|,
name|statement
argument_list|,
name|random
argument_list|,
name|bind
argument_list|)
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_pvbselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|res
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|random
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|void
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_mysql_pbselect
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|res
argument_list|,
name|statement
argument_list|,
name|random
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_end_transaction
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|)
block|{
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|trans
condition|)
block|{
comment|/* rollback on error or explicit rollback request */
if|if
condition|(
name|trans
operator|->
name|errnum
operator|||
name|TXN_DO_ROLLBACK
argument_list|(
name|trans
argument_list|)
condition|)
block|{
name|trans
operator|->
name|errnum
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|mysql_rollback
argument_list|(
name|trans
operator|->
name|handle
operator|->
name|conn
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|mysql_commit
argument_list|(
name|trans
operator|->
name|handle
operator|->
name|conn
argument_list|)
expr_stmt|;
block|}
name|ret
operator||=
name|mysql_autocommit
argument_list|(
name|trans
operator|->
name|handle
operator|->
name|conn
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|trans
operator|->
name|handle
operator|->
name|trans
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* Whether or not transactions work depends on whether the  * underlying DB supports them within MySQL.  Unfortunately  * it fails silently with the default InnoDB.  */
end_comment

begin_function
specifier|static
name|int
name|dbd_mysql_transaction
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
name|apr_dbd_transaction_t
modifier|*
modifier|*
name|trans
parameter_list|)
block|{
comment|/* Don't try recursive transactions here */
if|if
condition|(
name|handle
operator|->
name|trans
condition|)
block|{
name|dbd_mysql_end_transaction
argument_list|(
name|handle
operator|->
name|trans
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|*
name|trans
condition|)
block|{
operator|*
name|trans
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_transaction_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|trans
operator|)
operator|->
name|errnum
operator|=
name|mysql_autocommit
argument_list|(
name|handle
operator|->
name|conn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
operator|*
name|trans
operator|)
operator|->
name|handle
operator|=
name|handle
expr_stmt|;
name|handle
operator|->
name|trans
operator|=
operator|*
name|trans
expr_stmt|;
return|return
operator|(
operator|*
name|trans
operator|)
operator|->
name|errnum
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_transaction_mode_get
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|)
block|{
if|if
condition|(
operator|!
name|trans
condition|)
return|return
name|APR_DBD_TRANSACTION_COMMIT
return|;
return|return
name|trans
operator|->
name|mode
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_transaction_mode_set
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|!
name|trans
condition|)
return|return
name|APR_DBD_TRANSACTION_COMMIT
return|;
return|return
name|trans
operator|->
name|mode
operator|=
operator|(
name|mode
operator|&
name|TXN_MODE_BITS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_dbd_t
modifier|*
name|dbd_mysql_open
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|error
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|delims
init|=
literal|" \r\n\t;|,"
decl_stmt|;
specifier|const
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|key
decl_stmt|;
name|size_t
name|klen
decl_stmt|;
specifier|const
name|char
modifier|*
name|value
decl_stmt|;
name|size_t
name|vlen
decl_stmt|;
if|#
directive|if
name|MYSQL_VERSION_ID
operator|>=
literal|50013
name|my_bool
name|do_reconnect
init|=
literal|1
decl_stmt|;
endif|#
directive|endif
name|MYSQL
modifier|*
name|real_conn
decl_stmt|;
name|unsigned
name|long
name|flags
init|=
literal|0
decl_stmt|;
struct|struct
block|{
specifier|const
name|char
modifier|*
name|field
decl_stmt|;
specifier|const
name|char
modifier|*
name|value
decl_stmt|;
block|}
name|fields
index|[]
init|=
block|{
block|{
literal|"host"
block|,
name|NULL
block|}
block|,
block|{
literal|"user"
block|,
name|NULL
block|}
block|,
block|{
literal|"pass"
block|,
name|NULL
block|}
block|,
block|{
literal|"dbname"
block|,
name|NULL
block|}
block|,
block|{
literal|"port"
block|,
name|NULL
block|}
block|,
block|{
literal|"sock"
block|,
name|NULL
block|}
block|,
block|{
literal|"flags"
block|,
name|NULL
block|}
block|,
block|{
literal|"fldsz"
block|,
name|NULL
block|}
block|,
block|{
literal|"group"
block|,
name|NULL
block|}
block|,
block|{
literal|"reconnect"
block|,
name|NULL
block|}
block|,
block|{
name|NULL
block|,
name|NULL
block|}
block|}
struct|;
name|unsigned
name|int
name|port
init|=
literal|0
decl_stmt|;
name|apr_dbd_t
modifier|*
name|sql
init|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_t
argument_list|)
argument_list|)
decl_stmt|;
name|sql
operator|->
name|fldsz
operator|=
name|FIELDSIZE
expr_stmt|;
name|sql
operator|->
name|conn
operator|=
name|mysql_init
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|sql
operator|->
name|conn
operator|==
name|NULL
condition|)
block|{
return|return
name|NULL
return|;
block|}
for|for
control|(
name|ptr
operator|=
name|strchr
argument_list|(
name|params
argument_list|,
literal|'='
argument_list|)
init|;
name|ptr
condition|;
name|ptr
operator|=
name|strchr
argument_list|(
name|ptr
argument_list|,
literal|'='
argument_list|)
control|)
block|{
comment|/* don't dereference memory that may not belong to us */
if|if
condition|(
name|ptr
operator|==
name|params
condition|)
block|{
operator|++
name|ptr
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|key
operator|=
name|ptr
operator|-
literal|1
init|;
name|apr_isspace
argument_list|(
operator|*
name|key
argument_list|)
condition|;
operator|--
name|key
control|)
empty_stmt|;
name|klen
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|apr_isalpha
argument_list|(
operator|*
name|key
argument_list|)
condition|)
block|{
comment|/* don't parse backwards off the start of the string */
if|if
condition|(
name|key
operator|==
name|params
condition|)
block|{
operator|--
name|key
expr_stmt|;
operator|++
name|klen
expr_stmt|;
break|break;
block|}
operator|--
name|key
expr_stmt|;
operator|++
name|klen
expr_stmt|;
block|}
operator|++
name|key
expr_stmt|;
for|for
control|(
name|value
operator|=
name|ptr
operator|+
literal|1
init|;
name|apr_isspace
argument_list|(
operator|*
name|value
argument_list|)
condition|;
operator|++
name|value
control|)
empty_stmt|;
name|vlen
operator|=
name|strcspn
argument_list|(
name|value
argument_list|,
name|delims
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|fields
index|[
name|i
index|]
operator|.
name|field
operator|!=
name|NULL
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|strncasecmp
argument_list|(
name|fields
index|[
name|i
index|]
operator|.
name|field
argument_list|,
name|key
argument_list|,
name|klen
argument_list|)
condition|)
block|{
name|fields
index|[
name|i
index|]
operator|.
name|value
operator|=
name|apr_pstrndup
argument_list|(
name|pool
argument_list|,
name|value
argument_list|,
name|vlen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|ptr
operator|=
name|value
operator|+
name|vlen
expr_stmt|;
block|}
if|if
condition|(
name|fields
index|[
literal|4
index|]
operator|.
name|value
operator|!=
name|NULL
condition|)
block|{
name|port
operator|=
name|atoi
argument_list|(
name|fields
index|[
literal|4
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fields
index|[
literal|6
index|]
operator|.
name|value
operator|!=
name|NULL
operator|&&
operator|!
name|strcmp
argument_list|(
name|fields
index|[
literal|6
index|]
operator|.
name|value
argument_list|,
literal|"CLIENT_FOUND_ROWS"
argument_list|)
condition|)
block|{
name|flags
operator||=
name|CLIENT_FOUND_ROWS
expr_stmt|;
comment|/* only option we know */
block|}
if|if
condition|(
name|fields
index|[
literal|7
index|]
operator|.
name|value
operator|!=
name|NULL
condition|)
block|{
name|sql
operator|->
name|fldsz
operator|=
name|atol
argument_list|(
name|fields
index|[
literal|7
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fields
index|[
literal|8
index|]
operator|.
name|value
operator|!=
name|NULL
condition|)
block|{
name|mysql_options
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|MYSQL_READ_DEFAULT_GROUP
argument_list|,
name|fields
index|[
literal|8
index|]
operator|.
name|value
argument_list|)
expr_stmt|;
block|}
if|#
directive|if
name|MYSQL_VERSION_ID
operator|>=
literal|50013
if|if
condition|(
name|fields
index|[
literal|9
index|]
operator|.
name|value
operator|!=
name|NULL
condition|)
block|{
name|do_reconnect
operator|=
name|atoi
argument_list|(
name|fields
index|[
literal|9
index|]
operator|.
name|value
argument_list|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
if|#
directive|if
name|MYSQL_VERSION_ID
operator|>=
literal|50013
comment|/* the MySQL manual says this should be BEFORE mysql_real_connect */
name|mysql_options
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|MYSQL_OPT_RECONNECT
argument_list|,
operator|&
name|do_reconnect
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|real_conn
operator|=
name|mysql_real_connect
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|fields
index|[
literal|0
index|]
operator|.
name|value
argument_list|,
name|fields
index|[
literal|1
index|]
operator|.
name|value
argument_list|,
name|fields
index|[
literal|2
index|]
operator|.
name|value
argument_list|,
name|fields
index|[
literal|3
index|]
operator|.
name|value
argument_list|,
name|port
argument_list|,
name|fields
index|[
literal|5
index|]
operator|.
name|value
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|real_conn
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|error
condition|)
block|{
operator|*
name|error
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|mysql_error
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|mysql_close
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|#
directive|if
name|MYSQL_VERSION_ID
operator|>=
literal|50013
comment|/* Some say this should be AFTER mysql_real_connect */
name|mysql_options
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|MYSQL_OPT_RECONNECT
argument_list|,
operator|&
name|do_reconnect
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|sql
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_mysql_close
parameter_list|(
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
name|mysql_close
argument_list|(
name|handle
operator|->
name|conn
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_mysql_check_conn
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
return|return
name|mysql_ping
argument_list|(
name|handle
operator|->
name|conn
argument_list|)
condition|?
name|APR_EGENERAL
else|:
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_select_db
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|mysql_select_db
argument_list|(
name|handle
operator|->
name|conn
argument_list|,
name|name
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|dbd_mysql_native
parameter_list|(
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
return|return
name|handle
operator|->
name|conn
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_num_cols
parameter_list|(
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|)
block|{
if|if
condition|(
name|res
operator|->
name|statement
condition|)
block|{
return|return
name|mysql_stmt_field_count
argument_list|(
name|res
operator|->
name|statement
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|mysql_num_fields
argument_list|(
name|res
operator|->
name|res
argument_list|)
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_mysql_num_tuples
parameter_list|(
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|)
block|{
if|if
condition|(
name|res
operator|->
name|random
condition|)
block|{
if|if
condition|(
name|res
operator|->
name|statement
condition|)
block|{
return|return
operator|(
name|int
operator|)
name|mysql_stmt_num_rows
argument_list|(
name|res
operator|->
name|statement
argument_list|)
return|;
block|}
else|else
block|{
return|return
operator|(
name|int
operator|)
name|mysql_num_rows
argument_list|(
name|res
operator|->
name|res
argument_list|)
return|;
block|}
block|}
else|else
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|thread_end
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|mysql_thread_end
argument_list|()
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dbd_mysql_init
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|)
block|{
name|my_init
argument_list|()
expr_stmt|;
name|mysql_thread_init
argument_list|()
expr_stmt|;
comment|/* FIXME: this is a guess; find out what it really does */
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
name|NULL
argument_list|,
name|thread_end
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|APU_MODULE_DECLARE_DATA
specifier|const
name|apr_dbd_driver_t
name|apr_dbd_mysql_driver
init|=
block|{
literal|"mysql"
block|,
name|dbd_mysql_init
block|,
name|dbd_mysql_native
block|,
name|dbd_mysql_open
block|,
name|dbd_mysql_check_conn
block|,
name|dbd_mysql_close
block|,
name|dbd_mysql_select_db
block|,
name|dbd_mysql_transaction
block|,
name|dbd_mysql_end_transaction
block|,
name|dbd_mysql_query
block|,
name|dbd_mysql_select
block|,
name|dbd_mysql_num_cols
block|,
name|dbd_mysql_num_tuples
block|,
name|dbd_mysql_get_row
block|,
name|dbd_mysql_get_entry
block|,
name|dbd_mysql_error
block|,
name|dbd_mysql_escape
block|,
name|dbd_mysql_prepare
block|,
name|dbd_mysql_pvquery
block|,
name|dbd_mysql_pvselect
block|,
name|dbd_mysql_pquery
block|,
name|dbd_mysql_pselect
block|,
name|dbd_mysql_get_name
block|,
name|dbd_mysql_transaction_mode_get
block|,
name|dbd_mysql_transaction_mode_set
block|,
literal|"?"
block|,
name|dbd_mysql_pvbquery
block|,
name|dbd_mysql_pvbselect
block|,
name|dbd_mysql_pbquery
block|,
name|dbd_mysql_pbselect
block|,
name|dbd_mysql_datum_get
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


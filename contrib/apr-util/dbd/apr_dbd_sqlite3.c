begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Licensed to the Apache Software Foundation (ASF) under one or more  * contributor license agreements.  See the NOTICE file distributed with  * this work for additional information regarding copyright ownership.  * The ASF licenses this file to You under the Apache License, Version 2.0  * (the "License"); you may not use this file except in compliance with  * the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_include
include|#
directive|include
file|"apu.h"
end_include

begin_if
if|#
directive|if
name|APU_HAVE_SQLITE3
end_if

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<sqlite3.h>
end_include

begin_include
include|#
directive|include
file|"apr_strings.h"
end_include

begin_include
include|#
directive|include
file|"apr_time.h"
end_include

begin_include
include|#
directive|include
file|"apr_buckets.h"
end_include

begin_include
include|#
directive|include
file|"apr_dbd_internal.h"
end_include

begin_define
define|#
directive|define
name|MAX_RETRY_COUNT
value|15
end_define

begin_define
define|#
directive|define
name|MAX_RETRY_SLEEP
value|100000
end_define

begin_struct
struct|struct
name|apr_dbd_transaction_t
block|{
name|int
name|mode
decl_stmt|;
name|int
name|errnum
decl_stmt|;
name|apr_dbd_t
modifier|*
name|handle
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_t
block|{
name|sqlite3
modifier|*
name|conn
decl_stmt|;
name|apr_dbd_transaction_t
modifier|*
name|trans
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
name|apr_dbd_prepared_t
modifier|*
name|prep
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
struct|struct
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
name|int
name|size
decl_stmt|;
name|int
name|type
decl_stmt|;
block|}
name|apr_dbd_column_t
typedef|;
end_typedef

begin_struct
struct|struct
name|apr_dbd_row_t
block|{
name|apr_dbd_results_t
modifier|*
name|res
decl_stmt|;
name|apr_dbd_column_t
modifier|*
modifier|*
name|columns
decl_stmt|;
name|apr_dbd_row_t
modifier|*
name|next_row
decl_stmt|;
name|int
name|columnCount
decl_stmt|;
name|int
name|rownum
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_results_t
block|{
name|int
name|random
decl_stmt|;
name|sqlite3
modifier|*
name|handle
decl_stmt|;
name|sqlite3_stmt
modifier|*
name|stmt
decl_stmt|;
name|apr_dbd_row_t
modifier|*
name|next_row
decl_stmt|;
name|size_t
name|sz
decl_stmt|;
name|int
name|tuples
decl_stmt|;
name|char
modifier|*
modifier|*
name|col_names
decl_stmt|;
name|apr_pool_t
modifier|*
name|pool
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|apr_dbd_prepared_t
block|{
name|sqlite3_stmt
modifier|*
name|stmt
decl_stmt|;
name|apr_dbd_prepared_t
modifier|*
name|next
decl_stmt|;
name|int
name|nargs
decl_stmt|;
name|int
name|nvals
decl_stmt|;
name|apr_dbd_type_e
modifier|*
name|types
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|dbd_sqlite3_is_success
parameter_list|(
name|x
parameter_list|)
value|(((x) == SQLITE_DONE) || ((x) == SQLITE_OK))
end_define

begin_function
specifier|static
name|int
name|dbd_sqlite3_select_internal
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|sqlite3_stmt
modifier|*
name|stmt
parameter_list|,
name|int
name|seek
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|retry_count
init|=
literal|0
decl_stmt|,
name|column_count
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|num_tuples
init|=
literal|0
decl_stmt|;
name|int
name|increment
init|=
literal|0
decl_stmt|;
name|apr_dbd_row_t
modifier|*
name|row
init|=
name|NULL
decl_stmt|;
name|apr_dbd_row_t
modifier|*
name|lastrow
init|=
name|NULL
decl_stmt|;
name|apr_dbd_column_t
modifier|*
name|column
decl_stmt|;
name|char
modifier|*
name|hold
init|=
name|NULL
decl_stmt|;
name|column_count
operator|=
name|sqlite3_column_count
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|results
condition|)
block|{
operator|*
name|results
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_results_t
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
operator|*
name|results
operator|)
operator|->
name|stmt
operator|=
name|stmt
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|sz
operator|=
name|column_count
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|random
operator|=
name|seek
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|next_row
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|tuples
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|col_names
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
name|column_count
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
do|do
block|{
name|ret
operator|=
name|sqlite3_step
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SQLITE_BUSY
condition|)
block|{
if|if
condition|(
name|retry_count
operator|++
operator|>
name|MAX_RETRY_COUNT
condition|)
block|{
name|ret
operator|=
name|SQLITE_ERROR
expr_stmt|;
block|}
else|else
block|{
name|apr_dbd_mutex_unlock
argument_list|()
expr_stmt|;
name|apr_sleep
argument_list|(
name|MAX_RETRY_SLEEP
argument_list|)
expr_stmt|;
name|apr_dbd_mutex_lock
argument_list|()
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ret
operator|==
name|SQLITE_ROW
condition|)
block|{
name|int
name|length
decl_stmt|;
name|row
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_row_t
argument_list|)
argument_list|)
expr_stmt|;
name|row
operator|->
name|res
operator|=
operator|*
name|results
expr_stmt|;
name|increment
operator|=
sizeof|sizeof
argument_list|(
name|apr_dbd_column_t
operator|*
argument_list|)
expr_stmt|;
name|length
operator|=
name|increment
operator|*
operator|(
operator|*
name|results
operator|)
operator|->
name|sz
expr_stmt|;
name|row
operator|->
name|columns
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|row
operator|->
name|columnCount
operator|=
name|column_count
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
operator|*
name|results
operator|)
operator|->
name|sz
condition|;
name|i
operator|++
control|)
block|{
name|column
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_column_t
argument_list|)
argument_list|)
expr_stmt|;
name|row
operator|->
name|columns
index|[
name|i
index|]
operator|=
name|column
expr_stmt|;
comment|/* copy column name once only */
if|if
condition|(
operator|(
operator|*
name|results
operator|)
operator|->
name|col_names
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
operator|(
operator|*
name|results
operator|)
operator|->
name|col_names
index|[
name|i
index|]
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|sqlite3_column_name
argument_list|(
name|stmt
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|column
operator|->
name|name
operator|=
operator|(
operator|*
name|results
operator|)
operator|->
name|col_names
index|[
name|i
index|]
expr_stmt|;
name|column
operator|->
name|size
operator|=
name|sqlite3_column_bytes
argument_list|(
name|stmt
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|column
operator|->
name|type
operator|=
name|sqlite3_column_type
argument_list|(
name|stmt
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|column
operator|->
name|value
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|column
operator|->
name|type
condition|)
block|{
case|case
name|SQLITE_FLOAT
case|:
case|case
name|SQLITE_INTEGER
case|:
case|case
name|SQLITE_TEXT
case|:
name|hold
operator|=
operator|(
name|char
operator|*
operator|)
name|sqlite3_column_text
argument_list|(
name|stmt
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|hold
condition|)
block|{
name|column
operator|->
name|value
operator|=
name|apr_pstrmemdup
argument_list|(
name|pool
argument_list|,
name|hold
argument_list|,
name|column
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SQLITE_BLOB
case|:
name|hold
operator|=
operator|(
name|char
operator|*
operator|)
name|sqlite3_column_blob
argument_list|(
name|stmt
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|hold
condition|)
block|{
name|column
operator|->
name|value
operator|=
name|apr_pstrmemdup
argument_list|(
name|pool
argument_list|,
name|hold
argument_list|,
name|column
operator|->
name|size
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|SQLITE_NULL
case|:
break|break;
block|}
block|}
name|row
operator|->
name|rownum
operator|=
name|num_tuples
operator|++
expr_stmt|;
name|row
operator|->
name|next_row
operator|=
literal|0
expr_stmt|;
operator|(
operator|*
name|results
operator|)
operator|->
name|tuples
operator|=
name|num_tuples
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|results
operator|)
operator|->
name|next_row
operator|==
literal|0
condition|)
block|{
operator|(
operator|*
name|results
operator|)
operator|->
name|next_row
operator|=
name|row
expr_stmt|;
block|}
if|if
condition|(
name|lastrow
operator|!=
literal|0
condition|)
block|{
name|lastrow
operator|->
name|next_row
operator|=
name|row
expr_stmt|;
block|}
name|lastrow
operator|=
name|row
expr_stmt|;
block|}
block|}
do|while
condition|(
name|ret
operator|==
name|SQLITE_ROW
operator|||
name|ret
operator|==
name|SQLITE_BUSY
condition|)
do|;
if|if
condition|(
name|dbd_sqlite3_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_select
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|,
name|int
name|seek
parameter_list|)
block|{
name|sqlite3_stmt
modifier|*
name|stmt
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|tail
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|apr_dbd_mutex_lock
argument_list|()
expr_stmt|;
name|ret
operator|=
name|sqlite3_prepare
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|query
argument_list|,
name|strlen
argument_list|(
name|query
argument_list|)
argument_list|,
operator|&
name|stmt
argument_list|,
operator|&
name|tail
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbd_sqlite3_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ret
operator|=
name|dbd_sqlite3_select_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|results
argument_list|,
name|stmt
argument_list|,
name|seek
argument_list|)
expr_stmt|;
block|}
name|sqlite3_finalize
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
name|apr_dbd_mutex_unlock
argument_list|()
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_sqlite3_get_name
parameter_list|(
specifier|const
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|,
name|int
name|n
parameter_list|)
block|{
if|if
condition|(
operator|(
name|n
operator|<
literal|0
operator|)
operator|||
operator|(
operator|(
name|size_t
operator|)
name|n
operator|>=
name|res
operator|->
name|sz
operator|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|res
operator|->
name|col_names
index|[
name|n
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_get_row
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|,
name|apr_dbd_row_t
modifier|*
modifier|*
name|rowp
parameter_list|,
name|int
name|rownum
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|rownum
operator|==
operator|-
literal|1
condition|)
block|{
operator|*
name|rowp
operator|=
name|res
operator|->
name|next_row
expr_stmt|;
if|if
condition|(
operator|*
name|rowp
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|->
name|next_row
operator|=
operator|(
operator|*
name|rowp
operator|)
operator|->
name|next_row
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|rownum
operator|>
name|res
operator|->
name|tuples
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
name|rownum
operator|--
expr_stmt|;
operator|*
name|rowp
operator|=
name|res
operator|->
name|next_row
expr_stmt|;
for|for
control|(
init|;
operator|*
name|rowp
operator|!=
literal|0
condition|;
name|i
operator|++
operator|,
operator|*
name|rowp
operator|=
operator|(
operator|*
name|rowp
operator|)
operator|->
name|next_row
control|)
block|{
if|if
condition|(
name|i
operator|==
name|rownum
condition|)
block|{
return|return
literal|0
return|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_sqlite3_get_entry
parameter_list|(
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|apr_dbd_column_t
modifier|*
name|column
decl_stmt|;
specifier|const
name|char
modifier|*
name|value
decl_stmt|;
if|if
condition|(
operator|(
name|n
operator|<
literal|0
operator|)
operator|||
operator|(
name|n
operator|>=
name|row
operator|->
name|columnCount
operator|)
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|column
operator|=
name|row
operator|->
name|columns
index|[
name|n
index|]
expr_stmt|;
name|value
operator|=
name|column
operator|->
name|value
expr_stmt|;
return|return
name|value
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_sqlite3_datum_get
parameter_list|(
specifier|const
name|apr_dbd_row_t
modifier|*
name|row
parameter_list|,
name|int
name|n
parameter_list|,
name|apr_dbd_type_e
name|type
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
operator|(
name|n
operator|<
literal|0
operator|)
operator|||
operator|(
operator|(
name|size_t
operator|)
name|n
operator|>=
name|row
operator|->
name|res
operator|->
name|sz
operator|)
condition|)
block|{
return|return
name|APR_EGENERAL
return|;
block|}
if|if
condition|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|type
operator|==
name|SQLITE_NULL
condition|)
block|{
return|return
name|APR_ENOENT
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|APR_DBD_TYPE_TINY
case|:
operator|*
operator|(
name|char
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UTINY
case|:
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_SHORT
case|:
operator|*
operator|(
name|short
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_USHORT
case|:
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_INT
case|:
operator|*
operator|(
name|int
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UINT
case|:
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|data
operator|=
name|atoi
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONG
case|:
operator|*
operator|(
name|long
operator|*
operator|)
name|data
operator|=
name|atol
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONG
case|:
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|data
operator|=
name|atol
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONGLONG
case|:
operator|*
operator|(
name|apr_int64_t
operator|*
operator|)
name|data
operator|=
name|apr_atoi64
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONGLONG
case|:
operator|*
operator|(
name|apr_uint64_t
operator|*
operator|)
name|data
operator|=
name|apr_atoi64
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_FLOAT
case|:
operator|*
operator|(
name|float
operator|*
operator|)
name|data
operator|=
operator|(
name|float
operator|)
name|atof
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DOUBLE
case|:
operator|*
operator|(
name|double
operator|*
operator|)
name|data
operator|=
name|atof
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_STRING
case|:
case|case
name|APR_DBD_TYPE_TEXT
case|:
case|case
name|APR_DBD_TYPE_TIME
case|:
case|case
name|APR_DBD_TYPE_DATE
case|:
case|case
name|APR_DBD_TYPE_DATETIME
case|:
case|case
name|APR_DBD_TYPE_TIMESTAMP
case|:
case|case
name|APR_DBD_TYPE_ZTIMESTAMP
case|:
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|data
operator|=
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
block|{
name|apr_bucket
modifier|*
name|e
decl_stmt|;
name|apr_bucket_brigade
modifier|*
name|b
init|=
operator|(
name|apr_bucket_brigade
operator|*
operator|)
name|data
decl_stmt|;
name|e
operator|=
name|apr_bucket_pool_create
argument_list|(
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|value
argument_list|,
name|row
operator|->
name|columns
index|[
name|n
index|]
operator|->
name|size
argument_list|,
name|row
operator|->
name|res
operator|->
name|pool
argument_list|,
name|b
operator|->
name|bucket_alloc
argument_list|)
expr_stmt|;
name|APR_BRIGADE_INSERT_TAIL
argument_list|(
name|b
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|APR_DBD_TYPE_NULL
case|:
operator|*
operator|(
name|void
operator|*
operator|*
operator|)
name|data
operator|=
name|NULL
expr_stmt|;
break|break;
default|default:
return|return
name|APR_EGENERAL
return|;
block|}
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_sqlite3_error
parameter_list|(
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
name|n
parameter_list|)
block|{
return|return
name|sqlite3_errmsg
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_query_internal
parameter_list|(
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|sqlite3_stmt
modifier|*
name|stmt
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|)
block|{
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|,
name|retry_count
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|retry_count
operator|++
operator|<=
name|MAX_RETRY_COUNT
condition|)
block|{
name|ret
operator|=
name|sqlite3_step
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SQLITE_BUSY
condition|)
break|break;
name|apr_dbd_mutex_unlock
argument_list|()
expr_stmt|;
name|apr_sleep
argument_list|(
name|MAX_RETRY_SLEEP
argument_list|)
expr_stmt|;
name|apr_dbd_mutex_lock
argument_list|()
expr_stmt|;
block|}
operator|*
name|nrows
operator|=
name|sqlite3_changes
argument_list|(
name|sql
operator|->
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbd_sqlite3_is_success
argument_list|(
name|ret
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_query
parameter_list|(
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|)
block|{
name|sqlite3_stmt
modifier|*
name|stmt
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|tail
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|,
name|length
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|length
operator|=
name|strlen
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|apr_dbd_mutex_lock
argument_list|()
expr_stmt|;
do|do
block|{
name|ret
operator|=
name|sqlite3_prepare
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|query
argument_list|,
name|length
argument_list|,
operator|&
name|stmt
argument_list|,
operator|&
name|tail
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|SQLITE_OK
condition|)
block|{
name|sqlite3_finalize
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
break|break;
block|}
name|ret
operator|=
name|dbd_sqlite3_query_internal
argument_list|(
name|sql
argument_list|,
name|stmt
argument_list|,
name|nrows
argument_list|)
expr_stmt|;
name|sqlite3_finalize
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
name|length
operator|-=
operator|(
name|tail
operator|-
name|query
operator|)
expr_stmt|;
name|query
operator|=
name|tail
expr_stmt|;
block|}
do|while
condition|(
name|length
operator|>
literal|0
condition|)
do|;
name|apr_dbd_mutex_unlock
argument_list|()
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|free_mem
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|sqlite3_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dbd_sqlite3_escape
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|arg
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|)
block|{
name|char
modifier|*
name|ret
init|=
name|sqlite3_mprintf
argument_list|(
literal|"%q"
argument_list|,
name|arg
argument_list|)
decl_stmt|;
name|apr_pool_cleanup_register
argument_list|(
name|pool
argument_list|,
name|ret
argument_list|,
name|free_mem
argument_list|,
name|apr_pool_cleanup_null
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_prepare
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|int
name|nargs
parameter_list|,
name|int
name|nvals
parameter_list|,
name|apr_dbd_type_e
modifier|*
name|types
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
modifier|*
name|statement
parameter_list|)
block|{
name|sqlite3_stmt
modifier|*
name|stmt
decl_stmt|;
specifier|const
name|char
modifier|*
name|tail
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|apr_dbd_mutex_lock
argument_list|()
expr_stmt|;
name|ret
operator|=
name|sqlite3_prepare
argument_list|(
name|sql
operator|->
name|conn
argument_list|,
name|query
argument_list|,
name|strlen
argument_list|(
name|query
argument_list|)
argument_list|,
operator|&
name|stmt
argument_list|,
operator|&
name|tail
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SQLITE_OK
condition|)
block|{
name|apr_dbd_prepared_t
modifier|*
name|prep
decl_stmt|;
name|prep
operator|=
name|apr_pcalloc
argument_list|(
name|sql
operator|->
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|prep
argument_list|)
argument_list|)
expr_stmt|;
name|prep
operator|->
name|stmt
operator|=
name|stmt
expr_stmt|;
name|prep
operator|->
name|next
operator|=
name|sql
operator|->
name|prep
expr_stmt|;
name|prep
operator|->
name|nargs
operator|=
name|nargs
expr_stmt|;
name|prep
operator|->
name|nvals
operator|=
name|nvals
expr_stmt|;
name|prep
operator|->
name|types
operator|=
name|types
expr_stmt|;
comment|/* link new statement to the handle */
name|sql
operator|->
name|prep
operator|=
name|prep
expr_stmt|;
operator|*
name|statement
operator|=
name|prep
expr_stmt|;
block|}
else|else
block|{
name|sqlite3_finalize
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
block|}
name|apr_dbd_mutex_unlock
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dbd_sqlite3_bind
parameter_list|(
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|sqlite3_stmt
modifier|*
name|stmt
init|=
name|statement
operator|->
name|stmt
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nargs
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
if|if
condition|(
name|values
index|[
name|j
index|]
operator|==
name|NULL
condition|)
block|{
name|sqlite3_bind_null
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|statement
operator|->
name|types
index|[
name|i
index|]
condition|)
block|{
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
block|{
name|char
modifier|*
name|data
init|=
operator|(
name|char
operator|*
operator|)
name|values
index|[
name|j
index|]
decl_stmt|;
name|int
name|size
init|=
name|atoi
argument_list|(
operator|(
name|char
operator|*
operator|)
name|values
index|[
operator|++
name|j
index|]
argument_list|)
decl_stmt|;
comment|/* skip table and column */
name|j
operator|+=
literal|2
expr_stmt|;
name|sqlite3_bind_blob
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|data
argument_list|,
name|size
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|sqlite3_bind_text
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|values
index|[
name|j
index|]
argument_list|,
name|strlen
argument_list|(
name|values
index|[
name|j
index|]
argument_list|)
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_pquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|sqlite3_stmt
modifier|*
name|stmt
init|=
name|statement
operator|->
name|stmt
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|apr_dbd_mutex_lock
argument_list|()
expr_stmt|;
name|ret
operator|=
name|sqlite3_reset
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SQLITE_OK
condition|)
block|{
name|dbd_sqlite3_bind
argument_list|(
name|statement
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dbd_sqlite3_query_internal
argument_list|(
name|sql
argument_list|,
name|stmt
argument_list|,
name|nrows
argument_list|)
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
block|}
name|apr_dbd_mutex_unlock
argument_list|()
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_pvquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|char
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_sqlite3_pquery
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|nrows
argument_list|,
name|statement
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_pselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|sqlite3_stmt
modifier|*
name|stmt
init|=
name|statement
operator|->
name|stmt
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|apr_dbd_mutex_lock
argument_list|()
expr_stmt|;
name|ret
operator|=
name|sqlite3_reset
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SQLITE_OK
condition|)
block|{
name|dbd_sqlite3_bind
argument_list|(
name|statement
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dbd_sqlite3_select_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|results
argument_list|,
name|stmt
argument_list|,
name|seek
argument_list|)
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
block|}
name|apr_dbd_mutex_unlock
argument_list|()
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_pvselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|char
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|char
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_sqlite3_pselect
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|results
argument_list|,
name|statement
argument_list|,
name|seek
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dbd_sqlite3_bbind
parameter_list|(
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|sqlite3_stmt
modifier|*
name|stmt
init|=
name|statement
operator|->
name|stmt
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|apr_dbd_type_e
name|type
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nargs
condition|;
name|i
operator|++
operator|,
name|j
operator|++
control|)
block|{
name|type
operator|=
operator|(
name|values
index|[
name|j
index|]
operator|==
name|NULL
condition|?
name|APR_DBD_TYPE_NULL
else|:
name|statement
operator|->
name|types
index|[
name|i
index|]
operator|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|APR_DBD_TYPE_TINY
case|:
name|sqlite3_bind_int
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|char
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UTINY
case|:
name|sqlite3_bind_int
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|unsigned
name|char
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_SHORT
case|:
name|sqlite3_bind_int
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|short
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_USHORT
case|:
name|sqlite3_bind_int
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_INT
case|:
name|sqlite3_bind_int
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|int
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_UINT
case|:
name|sqlite3_bind_int
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|unsigned
name|int
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONG
case|:
name|sqlite3_bind_int64
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|long
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONG
case|:
name|sqlite3_bind_int64
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|unsigned
name|long
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_LONGLONG
case|:
name|sqlite3_bind_int64
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|apr_int64_t
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_ULONGLONG
case|:
name|sqlite3_bind_int64
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|apr_uint64_t
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_FLOAT
case|:
name|sqlite3_bind_double
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|float
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_DOUBLE
case|:
name|sqlite3_bind_double
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
operator|*
operator|(
name|double
operator|*
operator|)
name|values
index|[
name|j
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_STRING
case|:
case|case
name|APR_DBD_TYPE_TEXT
case|:
case|case
name|APR_DBD_TYPE_TIME
case|:
case|case
name|APR_DBD_TYPE_DATE
case|:
case|case
name|APR_DBD_TYPE_DATETIME
case|:
case|case
name|APR_DBD_TYPE_TIMESTAMP
case|:
case|case
name|APR_DBD_TYPE_ZTIMESTAMP
case|:
name|sqlite3_bind_text
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|values
index|[
name|j
index|]
argument_list|,
name|strlen
argument_list|(
name|values
index|[
name|j
index|]
argument_list|)
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
break|break;
case|case
name|APR_DBD_TYPE_BLOB
case|:
case|case
name|APR_DBD_TYPE_CLOB
case|:
block|{
name|char
modifier|*
name|data
init|=
operator|(
name|char
operator|*
operator|)
name|values
index|[
name|j
index|]
decl_stmt|;
name|apr_size_t
name|size
init|=
operator|*
operator|(
name|apr_size_t
operator|*
operator|)
name|values
index|[
operator|++
name|j
index|]
decl_stmt|;
name|sqlite3_bind_blob
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|data
argument_list|,
name|size
argument_list|,
name|SQLITE_STATIC
argument_list|)
expr_stmt|;
comment|/* skip table and column */
name|j
operator|+=
literal|2
expr_stmt|;
block|}
break|break;
case|case
name|APR_DBD_TYPE_NULL
case|:
default|default:
name|sqlite3_bind_null
argument_list|(
name|stmt
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_pbquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|sqlite3_stmt
modifier|*
name|stmt
init|=
name|statement
operator|->
name|stmt
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|apr_dbd_mutex_lock
argument_list|()
expr_stmt|;
name|ret
operator|=
name|sqlite3_reset
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SQLITE_OK
condition|)
block|{
name|dbd_sqlite3_bbind
argument_list|(
name|statement
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dbd_sqlite3_query_internal
argument_list|(
name|sql
argument_list|,
name|stmt
argument_list|,
name|nrows
argument_list|)
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
block|}
name|apr_dbd_mutex_unlock
argument_list|()
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_pvbquery
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|int
modifier|*
name|nrows
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|void
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_sqlite3_pbquery
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|nrows
argument_list|,
name|statement
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_pbselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
specifier|const
name|void
modifier|*
modifier|*
name|values
parameter_list|)
block|{
name|sqlite3_stmt
modifier|*
name|stmt
init|=
name|statement
operator|->
name|stmt
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|apr_dbd_mutex_lock
argument_list|()
expr_stmt|;
name|ret
operator|=
name|sqlite3_reset
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|SQLITE_OK
condition|)
block|{
name|dbd_sqlite3_bbind
argument_list|(
name|statement
argument_list|,
name|values
argument_list|)
expr_stmt|;
name|ret
operator|=
name|dbd_sqlite3_select_internal
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|results
argument_list|,
name|stmt
argument_list|,
name|seek
argument_list|)
expr_stmt|;
name|sqlite3_reset
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
block|}
name|apr_dbd_mutex_unlock
argument_list|()
expr_stmt|;
if|if
condition|(
name|TXN_NOTICE_ERRORS
argument_list|(
name|sql
operator|->
name|trans
argument_list|)
condition|)
block|{
name|sql
operator|->
name|trans
operator|->
name|errnum
operator|=
name|ret
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_pvbselect
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|sql
parameter_list|,
name|apr_dbd_results_t
modifier|*
modifier|*
name|results
parameter_list|,
name|apr_dbd_prepared_t
modifier|*
name|statement
parameter_list|,
name|int
name|seek
parameter_list|,
name|va_list
name|args
parameter_list|)
block|{
specifier|const
name|void
modifier|*
modifier|*
name|values
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|sql
operator|->
name|trans
operator|&&
name|sql
operator|->
name|trans
operator|->
name|errnum
condition|)
block|{
return|return
name|sql
operator|->
name|trans
operator|->
name|errnum
return|;
block|}
name|values
operator|=
name|apr_palloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|values
argument_list|)
operator|*
name|statement
operator|->
name|nvals
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|statement
operator|->
name|nvals
condition|;
name|i
operator|++
control|)
block|{
name|values
index|[
name|i
index|]
operator|=
name|va_arg
argument_list|(
name|args
argument_list|,
specifier|const
name|void
operator|*
argument_list|)
expr_stmt|;
block|}
return|return
name|dbd_sqlite3_pbselect
argument_list|(
name|pool
argument_list|,
name|sql
argument_list|,
name|results
argument_list|,
name|statement
argument_list|,
name|seek
argument_list|,
name|values
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_start_transaction
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
name|apr_dbd_transaction_t
modifier|*
modifier|*
name|trans
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|nrows
init|=
literal|0
decl_stmt|;
name|ret
operator|=
name|dbd_sqlite3_query
argument_list|(
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
literal|"BEGIN IMMEDIATE"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|trans
condition|)
block|{
operator|*
name|trans
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
name|apr_dbd_transaction_t
argument_list|)
argument_list|)
expr_stmt|;
operator|(
operator|*
name|trans
operator|)
operator|->
name|handle
operator|=
name|handle
expr_stmt|;
name|handle
operator|->
name|trans
operator|=
operator|*
name|trans
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_end_transaction
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|)
block|{
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
comment|/* ending transaction that was never started is an error */
name|int
name|nrows
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|trans
condition|)
block|{
comment|/* rollback on error or explicit rollback request */
if|if
condition|(
name|trans
operator|->
name|errnum
operator|||
name|TXN_DO_ROLLBACK
argument_list|(
name|trans
argument_list|)
condition|)
block|{
name|trans
operator|->
name|errnum
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|dbd_sqlite3_query
argument_list|(
name|trans
operator|->
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
literal|"ROLLBACK"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|dbd_sqlite3_query
argument_list|(
name|trans
operator|->
name|handle
argument_list|,
operator|&
name|nrows
argument_list|,
literal|"COMMIT"
argument_list|)
expr_stmt|;
block|}
name|trans
operator|->
name|handle
operator|->
name|trans
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_transaction_mode_get
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|)
block|{
if|if
condition|(
operator|!
name|trans
condition|)
return|return
name|APR_DBD_TRANSACTION_COMMIT
return|;
return|return
name|trans
operator|->
name|mode
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_transaction_mode_set
parameter_list|(
name|apr_dbd_transaction_t
modifier|*
name|trans
parameter_list|,
name|int
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|!
name|trans
condition|)
return|return
name|APR_DBD_TRANSACTION_COMMIT
return|;
return|return
name|trans
operator|->
name|mode
operator|=
operator|(
name|mode
operator|&
name|TXN_MODE_BITS
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|apr_dbd_t
modifier|*
name|dbd_sqlite3_open
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|error
parameter_list|)
block|{
name|apr_dbd_t
modifier|*
name|sql
init|=
name|NULL
decl_stmt|;
name|sqlite3
modifier|*
name|conn
init|=
name|NULL
decl_stmt|;
name|int
name|sqlres
decl_stmt|;
if|if
condition|(
operator|!
name|params
condition|)
return|return
name|NULL
return|;
name|sqlres
operator|=
name|sqlite3_open
argument_list|(
name|params
argument_list|,
operator|&
name|conn
argument_list|)
expr_stmt|;
if|if
condition|(
name|sqlres
operator|!=
name|SQLITE_OK
condition|)
block|{
if|if
condition|(
name|error
condition|)
block|{
operator|*
name|error
operator|=
name|apr_pstrdup
argument_list|(
name|pool
argument_list|,
name|sqlite3_errmsg
argument_list|(
name|conn
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|sqlite3_close
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* should we register rand or power functions to the sqlite VM? */
name|sql
operator|=
name|apr_pcalloc
argument_list|(
name|pool
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sql
argument_list|)
argument_list|)
expr_stmt|;
name|sql
operator|->
name|conn
operator|=
name|conn
expr_stmt|;
name|sql
operator|->
name|pool
operator|=
name|pool
expr_stmt|;
name|sql
operator|->
name|trans
operator|=
name|NULL
expr_stmt|;
return|return
name|sql
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_sqlite3_close
parameter_list|(
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
name|apr_dbd_prepared_t
modifier|*
name|prep
init|=
name|handle
operator|->
name|prep
decl_stmt|;
comment|/* finalize all prepared statements, or we'll get SQLITE_BUSY on close */
while|while
condition|(
name|prep
condition|)
block|{
name|sqlite3_finalize
argument_list|(
name|prep
operator|->
name|stmt
argument_list|)
expr_stmt|;
name|prep
operator|=
name|prep
operator|->
name|next
expr_stmt|;
block|}
name|sqlite3_close
argument_list|(
name|handle
operator|->
name|conn
argument_list|)
expr_stmt|;
return|return
name|APR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|apr_status_t
name|dbd_sqlite3_check_conn
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
return|return
operator|(
name|handle
operator|->
name|conn
operator|!=
name|NULL
operator|)
condition|?
name|APR_SUCCESS
else|:
name|APR_EGENERAL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_select_db
parameter_list|(
name|apr_pool_t
modifier|*
name|pool
parameter_list|,
name|apr_dbd_t
modifier|*
name|handle
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
name|APR_ENOTIMPL
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|dbd_sqlite3_native
parameter_list|(
name|apr_dbd_t
modifier|*
name|handle
parameter_list|)
block|{
return|return
name|handle
operator|->
name|conn
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_num_cols
parameter_list|(
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|)
block|{
return|return
name|res
operator|->
name|sz
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|dbd_sqlite3_num_tuples
parameter_list|(
name|apr_dbd_results_t
modifier|*
name|res
parameter_list|)
block|{
return|return
name|res
operator|->
name|tuples
return|;
block|}
end_function

begin_decl_stmt
name|APU_MODULE_DECLARE_DATA
specifier|const
name|apr_dbd_driver_t
name|apr_dbd_sqlite3_driver
init|=
block|{
literal|"sqlite3"
block|,
name|NULL
block|,
name|dbd_sqlite3_native
block|,
name|dbd_sqlite3_open
block|,
name|dbd_sqlite3_check_conn
block|,
name|dbd_sqlite3_close
block|,
name|dbd_sqlite3_select_db
block|,
name|dbd_sqlite3_start_transaction
block|,
name|dbd_sqlite3_end_transaction
block|,
name|dbd_sqlite3_query
block|,
name|dbd_sqlite3_select
block|,
name|dbd_sqlite3_num_cols
block|,
name|dbd_sqlite3_num_tuples
block|,
name|dbd_sqlite3_get_row
block|,
name|dbd_sqlite3_get_entry
block|,
name|dbd_sqlite3_error
block|,
name|dbd_sqlite3_escape
block|,
name|dbd_sqlite3_prepare
block|,
name|dbd_sqlite3_pvquery
block|,
name|dbd_sqlite3_pvselect
block|,
name|dbd_sqlite3_pquery
block|,
name|dbd_sqlite3_pselect
block|,
name|dbd_sqlite3_get_name
block|,
name|dbd_sqlite3_transaction_mode_get
block|,
name|dbd_sqlite3_transaction_mode_set
block|,
literal|"?"
block|,
name|dbd_sqlite3_pvbquery
block|,
name|dbd_sqlite3_pvbselect
block|,
name|dbd_sqlite3_pbquery
block|,
name|dbd_sqlite3_pbselect
block|,
name|dbd_sqlite3_datum_get
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


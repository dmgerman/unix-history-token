begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / UNIX domain socket -based control interface  * Copyright (c) 2004-2015, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
end_ifndef

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
end_ifdef

begin_include
include|#
directive|include
file|<net/ethernet.h>
end_include

begin_include
include|#
directive|include
file|<netinet/ip.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_TESTING_OPTIONS */
end_comment

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|<stddef.h>
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/version.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"crypto/tls.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"eapol_auth/eapol_auth_sm.h"
end_include

begin_include
include|#
directive|include
file|"radius/radius_client.h"
end_include

begin_include
include|#
directive|include
file|"radius/radius_server.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ap/ieee802_1x.h"
end_include

begin_include
include|#
directive|include
file|"ap/wpa_auth.h"
end_include

begin_include
include|#
directive|include
file|"ap/ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"ap/sta_info.h"
end_include

begin_include
include|#
directive|include
file|"ap/wps_hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/ctrl_iface_ap.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_drv_ops.h"
end_include

begin_include
include|#
directive|include
file|"ap/hs20.h"
end_include

begin_include
include|#
directive|include
file|"ap/wnm_ap.h"
end_include

begin_include
include|#
directive|include
file|"ap/wpa_auth.h"
end_include

begin_include
include|#
directive|include
file|"ap/beacon.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_defs.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps.h"
end_include

begin_include
include|#
directive|include
file|"fst/fst_ctrl_iface.h"
end_include

begin_include
include|#
directive|include
file|"config_file.h"
end_include

begin_include
include|#
directive|include
file|"ctrl_iface.h"
end_include

begin_define
define|#
directive|define
name|HOSTAPD_CLI_DUP_VALUE_MAX_LEN
value|256
end_define

begin_struct
struct|struct
name|wpa_ctrl_dst
block|{
name|struct
name|wpa_ctrl_dst
modifier|*
name|next
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|socklen_t
name|addrlen
decl_stmt|;
name|int
name|debug_level
decl_stmt|;
name|int
name|errors
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|hostapd_ctrl_iface_send
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
name|level
parameter_list|,
name|enum
name|wpa_msg_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_attach
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|wpa_ctrl_dst
modifier|*
name|dst
decl_stmt|;
name|dst
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
operator|&
name|dst
operator|->
name|addr
argument_list|,
name|from
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|->
name|addrlen
operator|=
name|fromlen
expr_stmt|;
name|dst
operator|->
name|debug_level
operator|=
name|MSG_INFO
expr_stmt|;
name|dst
operator|->
name|next
operator|=
name|hapd
operator|->
name|ctrl_dst
expr_stmt|;
name|hapd
operator|->
name|ctrl_dst
operator|=
name|dst
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE monitor attached"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|from
operator|->
name|sun_path
argument_list|,
name|fromlen
operator|-
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_detach
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|wpa_ctrl_dst
modifier|*
name|dst
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
name|dst
operator|=
name|hapd
operator|->
name|ctrl_dst
expr_stmt|;
while|while
condition|(
name|dst
condition|)
block|{
if|if
condition|(
name|fromlen
operator|==
name|dst
operator|->
name|addrlen
operator|&&
name|os_memcmp
argument_list|(
name|from
operator|->
name|sun_path
argument_list|,
name|dst
operator|->
name|addr
operator|.
name|sun_path
argument_list|,
name|fromlen
operator|-
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE monitor detached"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|from
operator|->
name|sun_path
argument_list|,
name|fromlen
operator|-
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
name|hapd
operator|->
name|ctrl_dst
operator|=
name|dst
operator|->
name|next
expr_stmt|;
else|else
name|prev
operator|->
name|next
operator|=
name|dst
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|prev
operator|=
name|dst
expr_stmt|;
name|dst
operator|=
name|dst
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_level
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|,
name|char
modifier|*
name|level
parameter_list|)
block|{
name|struct
name|wpa_ctrl_dst
modifier|*
name|dst
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE LEVEL %s"
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|dst
operator|=
name|hapd
operator|->
name|ctrl_dst
expr_stmt|;
while|while
condition|(
name|dst
condition|)
block|{
if|if
condition|(
name|fromlen
operator|==
name|dst
operator|->
name|addrlen
operator|&&
name|os_memcmp
argument_list|(
name|from
operator|->
name|sun_path
argument_list|,
name|dst
operator|->
name|addr
operator|.
name|sun_path
argument_list|,
name|fromlen
operator|-
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE changed monitor "
literal|"level"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|from
operator|->
name|sun_path
argument_list|,
name|fromlen
operator|-
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|->
name|debug_level
operator|=
name|atoi
argument_list|(
name|level
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|dst
operator|=
name|dst
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_new_sta
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|txtaddr
parameter_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE NEW_STA %s"
argument_list|,
name|txtaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|txtaddr
argument_list|,
name|addr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Add new STA "
name|MACSTR
literal|" based on ctrl_iface "
literal|"notification"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_sta_add
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|hostapd_new_assoc_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|NEED_AP_MLME
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_sa_query
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|txtaddr
parameter_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|trans_id
index|[
name|WLAN_SA_QUERY_TR_ID_LEN
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE SA_QUERY %s"
argument_list|,
name|txtaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|txtaddr
argument_list|,
name|addr
argument_list|)
operator|||
name|os_get_random
argument_list|(
name|trans_id
argument_list|,
name|WLAN_SA_QUERY_TR_ID_LEN
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ieee802_11_send_sa_query_req
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|trans_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NEED_AP_MLME */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211W */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_wps_pin
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|txt
parameter_list|)
block|{
name|char
modifier|*
name|pin
init|=
name|os_strchr
argument_list|(
name|txt
argument_list|,
literal|' '
argument_list|)
decl_stmt|;
name|char
modifier|*
name|timeout_txt
decl_stmt|;
name|int
name|timeout
decl_stmt|;
name|u8
name|addr_buf
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|addr
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|pin
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pin
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|timeout_txt
operator|=
name|os_strchr
argument_list|(
name|pin
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout_txt
condition|)
block|{
operator|*
name|timeout_txt
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|timeout
operator|=
name|atoi
argument_list|(
name|timeout_txt
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|timeout_txt
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|pos
argument_list|,
name|addr_buf
argument_list|)
operator|==
literal|0
condition|)
name|addr
operator|=
name|addr_buf
expr_stmt|;
block|}
block|}
else|else
name|timeout
operator|=
literal|0
expr_stmt|;
return|return
name|hostapd_wps_add_pin
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|txt
argument_list|,
name|pin
argument_list|,
name|timeout
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_wps_check_pin
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|char
name|pin
index|[
literal|9
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS_CHECK_PIN"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|cmd
argument_list|,
name|os_strlen
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|pos
operator|=
name|cmd
operator|,
name|len
operator|=
literal|0
init|;
operator|*
name|pos
operator|!=
literal|'\0'
condition|;
name|pos
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|pos
operator|<
literal|'0'
operator|||
operator|*
name|pos
operator|>
literal|'9'
condition|)
continue|continue;
name|pin
index|[
name|len
operator|++
index|]
operator|=
operator|*
name|pos
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|9
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Too long PIN"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|len
operator|!=
literal|4
operator|&&
name|len
operator|!=
literal|8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid PIN length %d"
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pin
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|8
condition|)
block|{
name|unsigned
name|int
name|pin_val
decl_stmt|;
name|pin_val
operator|=
name|atoi
argument_list|(
name|pin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wps_pin_valid
argument_list|(
name|pin_val
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid checksum digit"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"FAIL-CHECKSUM\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|buflen
argument_list|,
name|ret
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ret
return|;
block|}
block|}
name|ret
operator|=
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s"
argument_list|,
name|pin
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|buflen
argument_list|,
name|ret
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_wps_nfc_tag_read
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|pos
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|0x01
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|/=
literal|2
expr_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|hostapd_wps_nfc_tag_read
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_wps_nfc_config_token
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|reply
parameter_list|,
name|size_t
name|max_len
parameter_list|)
block|{
name|int
name|ndef
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"WPS"
argument_list|)
operator|==
literal|0
condition|)
name|ndef
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"NDEF"
argument_list|)
operator|==
literal|0
condition|)
name|ndef
operator|=
literal|1
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
name|buf
operator|=
name|hostapd_wps_nfc_config_token
argument_list|(
name|hapd
argument_list|,
name|ndef
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|wpa_snprintf_hex_uppercase
argument_list|(
name|reply
argument_list|,
name|max_len
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|reply
index|[
name|res
operator|++
index|]
operator|=
literal|'\n'
expr_stmt|;
name|reply
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_wps_nfc_token_gen
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|reply
parameter_list|,
name|size_t
name|max_len
parameter_list|,
name|int
name|ndef
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|int
name|res
decl_stmt|;
name|buf
operator|=
name|hostapd_wps_nfc_token_gen
argument_list|(
name|hapd
argument_list|,
name|ndef
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|wpa_snprintf_hex_uppercase
argument_list|(
name|reply
argument_list|,
name|max_len
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|reply
index|[
name|res
operator|++
index|]
operator|=
literal|'\n'
expr_stmt|;
name|reply
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_wps_nfc_token
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|reply
parameter_list|,
name|size_t
name|max_len
parameter_list|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"WPS"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|hostapd_ctrl_iface_wps_nfc_token_gen
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|max_len
argument_list|,
literal|0
argument_list|)
return|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"NDEF"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|hostapd_ctrl_iface_wps_nfc_token_gen
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|max_len
argument_list|,
literal|1
argument_list|)
return|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"enable"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|hostapd_wps_nfc_token_enable
argument_list|(
name|hapd
argument_list|)
return|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"disable"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|hostapd_wps_nfc_token_disable
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_nfc_get_handover_sel
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|reply
parameter_list|,
name|size_t
name|max_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|int
name|res
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|int
name|ndef
decl_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|cmd
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"WPS"
argument_list|)
operator|==
literal|0
condition|)
name|ndef
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"NDEF"
argument_list|)
operator|==
literal|0
condition|)
name|ndef
operator|=
literal|1
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|pos
argument_list|,
literal|"WPS-CR"
argument_list|)
operator|==
literal|0
condition|)
name|buf
operator|=
name|hostapd_wps_nfc_hs_cr
argument_list|(
name|hapd
argument_list|,
name|ndef
argument_list|)
expr_stmt|;
else|else
name|buf
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|wpa_snprintf_hex_uppercase
argument_list|(
name|reply
argument_list|,
name|max_len
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|reply
index|[
name|res
operator|++
index|]
operator|=
literal|'\n'
expr_stmt|;
name|reply
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_nfc_report_handover
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|req
decl_stmt|,
modifier|*
name|sel
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|role
decl_stmt|,
modifier|*
name|type
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|role
operator|=
name|cmd
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|role
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|type
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|type
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|pos2
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos2
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|0x01
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|/=
literal|2
expr_stmt|;
name|req
operator|=
name|wpabuf_alloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|wpabuf_put
argument_list|(
name|req
argument_list|,
name|len
argument_list|)
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
name|os_strlen
argument_list|(
name|pos2
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|0x01
condition|)
block|{
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|/=
literal|2
expr_stmt|;
name|sel
operator|=
name|wpabuf_alloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sel
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos2
argument_list|,
name|wpabuf_put
argument_list|(
name|sel
argument_list|,
name|len
argument_list|)
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|sel
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|role
argument_list|,
literal|"RESP"
argument_list|)
operator|==
literal|0
operator|&&
name|os_strcmp
argument_list|(
name|type
argument_list|,
literal|"WPS"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|hostapd_wps_nfc_report_handover
argument_list|(
name|hapd
argument_list|,
name|req
argument_list|,
name|sel
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NFC: Unsupported connection handover "
literal|"reported: role=%s type=%s"
argument_list|,
name|role
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|sel
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_NFC */
end_comment

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_wps_ap_pin
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|txt
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|timeout
init|=
literal|300
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
specifier|const
name|char
modifier|*
name|pin_txt
decl_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|txt
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|txt
argument_list|,
literal|"disable"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|hostapd_wps_ap_pin_disable
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
return|return
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"OK\n"
argument_list|)
return|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|txt
argument_list|,
literal|"random"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|pos
condition|)
name|timeout
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pin_txt
operator|=
name|hostapd_wps_ap_pin_random
argument_list|(
name|hapd
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin_txt
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s"
argument_list|,
name|pin_txt
argument_list|)
return|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|txt
argument_list|,
literal|"get"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pin_txt
operator|=
name|hostapd_wps_ap_pin_get
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin_txt
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s"
argument_list|,
name|pin_txt
argument_list|)
return|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|txt
argument_list|,
literal|"set"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|pin
decl_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pin
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|timeout
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|os_strlen
argument_list|(
name|pin
argument_list|)
operator|>
name|buflen
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hostapd_wps_ap_pin_set
argument_list|(
name|hapd
argument_list|,
name|pin
argument_list|,
name|timeout
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s"
argument_list|,
name|pin
argument_list|)
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_wps_config
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|txt
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|char
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|auth
decl_stmt|,
modifier|*
name|encr
init|=
name|NULL
decl_stmt|,
modifier|*
name|key
init|=
name|NULL
decl_stmt|;
name|ssid
operator|=
name|txt
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|txt
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|auth
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|encr
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|key
operator|=
name|pos
expr_stmt|;
block|}
block|}
return|return
name|hostapd_wps_config_ap
argument_list|(
name|hapd
argument_list|,
name|ssid
argument_list|,
name|auth
argument_list|,
name|encr
argument_list|,
name|key
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|pbc_status_str
parameter_list|(
name|enum
name|pbc_status
name|status
parameter_list|)
block|{
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|WPS_PBC_STATUS_DISABLE
case|:
return|return
literal|"Disabled"
return|;
case|case
name|WPS_PBC_STATUS_ACTIVE
case|:
return|return
literal|"Active"
return|;
case|case
name|WPS_PBC_STATUS_TIMEOUT
case|:
return|return
literal|"Timed-out"
return|;
case|case
name|WPS_PBC_STATUS_OVERLAP
case|:
return|return
literal|"Overlap"
return|;
default|default:
return|return
literal|"Unknown"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_wps_get_status
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|buflen
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"PBC Status: %s\n"
argument_list|,
name|pbc_status_str
argument_list|(
name|hapd
operator|->
name|wps_stats
operator|.
name|pbc_status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"Last WPS result: %s\n"
argument_list|,
operator|(
name|hapd
operator|->
name|wps_stats
operator|.
name|status
operator|==
name|WPS_STATUS_SUCCESS
condition|?
literal|"Success"
else|:
operator|(
name|hapd
operator|->
name|wps_stats
operator|.
name|status
operator|==
name|WPS_STATUS_FAILURE
condition|?
literal|"Failed"
else|:
literal|"None"
operator|)
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
comment|/* If status == Failure - Add possible Reasons */
if|if
condition|(
name|hapd
operator|->
name|wps_stats
operator|.
name|status
operator|==
name|WPS_STATUS_FAILURE
operator|&&
name|hapd
operator|->
name|wps_stats
operator|.
name|failure_reason
operator|>
literal|0
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"Failure Reason: %s\n"
argument_list|,
name|wps_ei_str
argument_list|(
name|hapd
operator|->
name|wps_stats
operator|.
name|failure_reason
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|wps_stats
operator|.
name|status
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"Peer Address: "
name|MACSTR
literal|"\n"
argument_list|,
name|MAC2STR
argument_list|(
name|hapd
operator|->
name|wps_stats
operator|.
name|peer_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_HS20
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_hs20_wnm_notif
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|url
decl_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|cmd
argument_list|,
name|addr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|url
operator|=
name|cmd
operator|+
literal|17
expr_stmt|;
if|if
condition|(
operator|*
name|url
operator|==
literal|'\0'
condition|)
block|{
name|url
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|*
name|url
operator|!=
literal|' '
condition|)
return|return
operator|-
literal|1
return|;
name|url
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|url
operator|==
literal|'\0'
condition|)
name|url
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|hs20_send_wnm_notification
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
literal|1
argument_list|,
name|url
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_hs20_deauth_req
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|code
decl_stmt|,
name|reauth_delay
decl_stmt|,
name|ret
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|size_t
name|url_len
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|req
decl_stmt|;
comment|/*<STA MAC Addr><Code(0/1)><Re-auth-Delay(sec)> [URL] */
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|cmd
argument_list|,
name|addr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|cmd
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|++
expr_stmt|;
name|code
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|++
expr_stmt|;
name|reauth_delay
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|url_len
operator|=
literal|0
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|++
expr_stmt|;
name|url_len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
name|req
operator|=
name|wpabuf_alloc
argument_list|(
literal|4
operator|+
name|url_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_u8
argument_list|(
name|req
argument_list|,
name|code
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|req
argument_list|,
name|reauth_delay
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|req
argument_list|,
name|url_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|wpabuf_put_data
argument_list|(
name|req
argument_list|,
name|pos
argument_list|,
name|url_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Send WNM-Notification to "
name|MACSTR
literal|" to indicate imminent deauthentication (code=%d "
literal|"reauth_delay=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|code
argument_list|,
name|reauth_delay
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hs20_send_wnm_notification_deauth_req
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_HS20 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_set_qos_map_set
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|qos_map_set
index|[
literal|16
operator|+
literal|2
operator|*
literal|21
index|]
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
init|=
name|cmd
decl_stmt|;
name|int
name|val
decl_stmt|,
name|ret
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|count
operator|==
sizeof|sizeof
argument_list|(
name|qos_map_set
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Too many qos_map_set parameters"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|val
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|<
literal|0
operator|||
name|val
operator|>
literal|255
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid QoS Map Set"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|qos_map_set
index|[
name|count
operator|++
index|]
operator|=
name|val
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
break|break;
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|<
literal|16
operator|||
name|count
operator|&
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid QoS Map Set"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|hostapd_drv_set_qos_map
argument_list|(
name|hapd
argument_list|,
name|qos_map_set
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set QoS Map Set"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|qos_map_set
argument_list|,
name|qos_map_set
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|conf
operator|->
name|qos_map_set_len
operator|=
name|count
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_send_qos_map_conf
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|qos_map_set
init|=
name|hapd
operator|->
name|conf
operator|->
name|qos_map_set
decl_stmt|;
name|u8
name|qos_map_set_len
init|=
name|hapd
operator|->
name|conf
operator|->
name|qos_map_set_len
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|qos_map_set_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"QoS Map Set is not set"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|cmd
argument_list|,
name|addr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Station "
name|MACSTR
literal|" not found "
literal|"for QoS Map Configuration message"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|sta
operator|->
name|qos_map_enabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Station "
name|MACSTR
literal|" did not indicate "
literal|"support for QoS Map"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|2
operator|+
literal|2
operator|+
name|qos_map_set_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_ACTION_QOS
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|QOS_QOS_MAP_CONFIG
argument_list|)
expr_stmt|;
comment|/* QoS Map Set Element */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_EID_QOS_MAP_SET
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|qos_map_set_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|qos_map_set
argument_list|,
name|qos_map_set_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hostapd_drv_send_action
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|freq
argument_list|,
literal|0
argument_list|,
name|addr
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_INTERWORKING */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WNM
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_disassoc_imminent
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|disassoc_timer
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|cmd
argument_list|,
name|addr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|cmd
index|[
literal|17
index|]
operator|!=
literal|' '
condition|)
return|return
operator|-
literal|1
return|;
name|disassoc_timer
operator|=
name|atoi
argument_list|(
name|cmd
operator|+
literal|17
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Station "
name|MACSTR
literal|" not found for disassociation imminent message"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|wnm_send_disassoc_imminent
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|disassoc_timer
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_ess_disassoc
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|url
decl_stmt|,
modifier|*
name|timerstr
decl_stmt|;
name|int
name|disassoc_timer
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|cmd
argument_list|,
name|addr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Station "
name|MACSTR
literal|" not found for ESS disassociation imminent message"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|timerstr
operator|=
name|cmd
operator|+
literal|17
expr_stmt|;
if|if
condition|(
operator|*
name|timerstr
operator|!=
literal|' '
condition|)
return|return
operator|-
literal|1
return|;
name|timerstr
operator|++
expr_stmt|;
name|disassoc_timer
operator|=
name|atoi
argument_list|(
name|timerstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|disassoc_timer
operator|<
literal|0
operator|||
name|disassoc_timer
operator|>
literal|65535
condition|)
return|return
operator|-
literal|1
return|;
name|url
operator|=
name|os_strchr
argument_list|(
name|timerstr
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|url
operator|++
expr_stmt|;
return|return
name|wnm_send_ess_disassoc_imminent
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|url
argument_list|,
name|disassoc_timer
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_bss_tm_req
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|disassoc_timer
init|=
literal|0
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|u8
name|req_mode
init|=
literal|0
decl_stmt|,
name|valid_int
init|=
literal|0x01
decl_stmt|;
name|u8
name|bss_term_dur
index|[
literal|12
index|]
decl_stmt|;
name|char
modifier|*
name|url
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|u8
name|nei_rep
index|[
literal|1000
index|]
decl_stmt|;
name|u8
modifier|*
name|nei_pos
init|=
name|nei_rep
decl_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|cmd
argument_list|,
name|addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid STA MAC address"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Station "
name|MACSTR
literal|" not found for BSS TM Request message"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|os_strstr
argument_list|(
name|cmd
argument_list|,
literal|" disassoc_timer="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|+=
literal|16
expr_stmt|;
name|disassoc_timer
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|disassoc_timer
operator|<
literal|0
operator|||
name|disassoc_timer
operator|>
literal|65535
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid disassoc_timer"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|pos
operator|=
name|os_strstr
argument_list|(
name|cmd
argument_list|,
literal|" valid_int="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|+=
literal|11
expr_stmt|;
name|valid_int
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
name|os_strstr
argument_list|(
name|cmd
argument_list|,
literal|" bss_term="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|+=
literal|10
expr_stmt|;
name|req_mode
operator||=
name|WNM_BSS_TM_REQ_BSS_TERMINATION_INCLUDED
expr_stmt|;
comment|/* TODO: TSF configurable/learnable */
name|bss_term_dur
index|[
literal|0
index|]
operator|=
literal|4
expr_stmt|;
comment|/* Subelement ID */
name|bss_term_dur
index|[
literal|1
index|]
operator|=
literal|10
expr_stmt|;
comment|/* Length */
name|os_memset
argument_list|(
name|bss_term_dur
argument_list|,
literal|2
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|end
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid bss_term data"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|++
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
operator|&
name|bss_term_dur
index|[
literal|10
index|]
argument_list|,
name|atoi
argument_list|(
name|end
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * BSS Transition Candidate List Entries - Neighbor Report elements 	 * neighbor=<BSSID>,<BSSID Information>,<Operating Class>, 	 *<Channel Number>,<PHY Type>[,<hexdump of Optional Subelements>] 	 */
name|pos
operator|=
name|cmd
expr_stmt|;
while|while
condition|(
name|pos
condition|)
block|{
name|u8
modifier|*
name|nei_start
decl_stmt|;
name|long
name|int
name|val
decl_stmt|;
name|char
modifier|*
name|endptr
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|pos
argument_list|,
literal|" neighbor="
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
break|break;
if|if
condition|(
name|nei_pos
operator|+
literal|15
operator|>
name|nei_rep
operator|+
sizeof|sizeof
argument_list|(
name|nei_rep
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Not enough room for additional neighbor"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|10
expr_stmt|;
name|nei_start
operator|=
name|nei_pos
expr_stmt|;
operator|*
name|nei_pos
operator|++
operator|=
name|WLAN_EID_NEIGHBOR_REPORT
expr_stmt|;
name|nei_pos
operator|++
expr_stmt|;
comment|/* length to be filled in */
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|pos
argument_list|,
name|nei_pos
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid BSSID"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|nei_pos
operator|+=
name|ETH_ALEN
expr_stmt|;
name|pos
operator|+=
literal|17
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
literal|','
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Missing BSSID Information"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|val
operator|=
name|strtol
argument_list|(
name|pos
argument_list|,
operator|&
name|endptr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WPA_PUT_LE32
argument_list|(
name|nei_pos
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|nei_pos
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
operator|*
name|endptr
operator|!=
literal|','
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Missing Operating Class"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|endptr
operator|+
literal|1
expr_stmt|;
operator|*
name|nei_pos
operator|++
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
comment|/* Operating Class */
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Missing Channel Number"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
operator|*
name|nei_pos
operator|++
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
comment|/* Channel Number */
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Missing PHY Type"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
operator|*
name|nei_pos
operator|++
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
comment|/* PHY Type */
name|end
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&&
operator|(
operator|!
name|end
operator|||
name|tmp
operator|<
name|end
operator|)
condition|)
block|{
comment|/* Optional Subelements (hexdump) */
name|size_t
name|len
decl_stmt|;
name|pos
operator|=
name|tmp
operator|+
literal|1
expr_stmt|;
name|end
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
name|len
operator|=
name|end
operator|-
name|pos
expr_stmt|;
else|else
name|len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|nei_pos
operator|+
name|len
operator|/
literal|2
operator|>
name|nei_rep
operator|+
sizeof|sizeof
argument_list|(
name|nei_rep
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Not enough room for neighbor subelements"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|len
operator|&
literal|0x01
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|nei_pos
argument_list|,
name|len
operator|/
literal|2
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid neighbor subelement info"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|nei_pos
operator|+=
name|len
operator|/
literal|2
expr_stmt|;
name|pos
operator|=
name|end
expr_stmt|;
block|}
name|nei_start
index|[
literal|1
index|]
operator|=
name|nei_pos
operator|-
name|nei_start
operator|-
literal|2
expr_stmt|;
block|}
name|pos
operator|=
name|os_strstr
argument_list|(
name|cmd
argument_list|,
literal|" url="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|size_t
name|len
decl_stmt|;
name|pos
operator|+=
literal|5
expr_stmt|;
name|end
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
name|len
operator|=
name|end
operator|-
name|pos
expr_stmt|;
else|else
name|len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|url
operator|=
name|os_malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|url
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|url
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|req_mode
operator||=
name|WNM_BSS_TM_REQ_ESS_DISASSOC_IMMINENT
expr_stmt|;
block|}
if|if
condition|(
name|os_strstr
argument_list|(
name|cmd
argument_list|,
literal|" pref=1"
argument_list|)
condition|)
name|req_mode
operator||=
name|WNM_BSS_TM_REQ_PREF_CAND_LIST_INCLUDED
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|cmd
argument_list|,
literal|" abridged=1"
argument_list|)
condition|)
name|req_mode
operator||=
name|WNM_BSS_TM_REQ_ABRIDGED
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|cmd
argument_list|,
literal|" disassoc_imminent=1"
argument_list|)
condition|)
name|req_mode
operator||=
name|WNM_BSS_TM_REQ_DISASSOC_IMMINENT
expr_stmt|;
name|ret
operator|=
name|wnm_send_bss_tm_req
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|req_mode
argument_list|,
name|disassoc_timer
argument_list|,
name|valid_int
argument_list|,
name|bss_term_dur
argument_list|,
name|url
argument_list|,
name|nei_pos
operator|>
name|nei_rep
condition|?
name|nei_rep
else|:
name|NULL
argument_list|,
name|nei_pos
operator|-
name|nei_rep
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WNM */
end_comment

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_get_key_mgmt
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|buflen
expr_stmt|;
name|WPA_ASSERT
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"WPA-PSK "
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"WPA-EAP "
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_PSK
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"FT-PSK "
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_IEEE8021X
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"FT-EAP "
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SAE
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_SAE
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"FT-SAE "
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_SAE */
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK_SHA256
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"WPA-PSK-SHA256 "
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_SHA256
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"WPA-EAP-SHA256 "
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_SAE
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_SAE
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"SAE "
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_SAE */
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_SUITE_B
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"WPA-EAP-SUITE-B "
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_SUITE_B_192
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"WPA-EAP-SUITE-B-192 "
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|>
name|buf
operator|&&
operator|*
operator|(
name|pos
operator|-
literal|1
operator|)
operator|==
literal|' '
condition|)
block|{
operator|*
operator|(
name|pos
operator|-
literal|1
operator|)
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|--
expr_stmt|;
block|}
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_get_config
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|buflen
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"bssid="
name|MACSTR
literal|"\n"
literal|"ssid=%s\n"
argument_list|,
name|MAC2STR
argument_list|(
name|hapd
operator|->
name|own_addr
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wps_state=%s\n"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|wps_state
operator|==
literal|0
condition|?
literal|"disabled"
else|:
operator|(
name|hapd
operator|->
name|conf
operator|->
name|wps_state
operator|==
literal|1
condition|?
literal|"not configured"
else|:
literal|"configured"
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_state
operator|&&
name|hapd
operator|->
name|conf
operator|->
name|wpa
operator|&&
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"passphrase=%s\n"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_state
operator|&&
name|hapd
operator|->
name|conf
operator|->
name|wpa
operator|&&
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
operator|&&
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
operator|->
name|group
condition|)
block|{
name|char
name|hex
index|[
name|PMK_LEN
operator|*
literal|2
operator|+
literal|1
index|]
decl_stmt|;
name|wpa_snprintf_hex
argument_list|(
name|hex
argument_list|,
sizeof|sizeof
argument_list|(
name|hex
argument_list|)
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"psk=%s\n"
argument_list|,
name|hex
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS */
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wpa=%d\n"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|wpa
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa
operator|&&
name|hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"key_mgmt="
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|hostapd_ctrl_iface_get_key_mgmt
argument_list|(
name|hapd
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"group_cipher=%s\n"
argument_list|,
name|wpa_cipher_txt
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wpa_group
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hapd
operator|->
name|conf
operator|->
name|wpa
operator|&
name|WPA_PROTO_RSN
operator|)
operator|&&
name|hapd
operator|->
name|conf
operator|->
name|rsn_pairwise
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"rsn_pairwise_cipher="
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|ret
operator|=
name|wpa_write_ciphers
argument_list|(
name|pos
argument_list|,
name|end
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|rsn_pairwise
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|hapd
operator|->
name|conf
operator|->
name|wpa
operator|&
name|WPA_PROTO_WPA
operator|)
operator|&&
name|hapd
operator|->
name|conf
operator|->
name|wpa_pairwise
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"wpa_pairwise_cipher="
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|ret
operator|=
name|wpa_write_ciphers
argument_list|(
name|pos
argument_list|,
name|end
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|wpa_pairwise
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_set
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|char
modifier|*
name|value
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|value
operator|=
name|os_strchr
argument_list|(
name|cmd
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|value
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE SET '%s'='%s'"
argument_list|,
name|cmd
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_TESTING
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|cmd
argument_list|,
literal|"wps_version_number"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|long
name|int
name|val
decl_stmt|;
name|val
operator|=
name|strtol
argument_list|(
name|value
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|<
literal|0
operator|||
name|val
operator|>
literal|0xff
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid "
literal|"wps_version_number %ld"
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wps_version_number
operator|=
name|val
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Testing - force WPS "
literal|"version %u.%u"
argument_list|,
operator|(
name|wps_version_number
operator|&
literal|0xf0
operator|)
operator|>>
literal|4
argument_list|,
name|wps_version_number
operator|&
literal|0x0f
argument_list|)
expr_stmt|;
name|hostapd_wps_update_ie
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|cmd
argument_list|,
literal|"wps_testing_dummy_cred"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wps_testing_dummy_cred
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Testing - dummy_cred=%d"
argument_list|,
name|wps_testing_dummy_cred
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|cmd
argument_list|,
literal|"wps_corrupt_pkhash"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wps_corrupt_pkhash
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Testing - wps_corrupt_pkhash=%d"
argument_list|,
name|wps_corrupt_pkhash
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_TESTING */
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|cmd
argument_list|,
literal|"gas_frag_limit"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|val
init|=
name|atoi
argument_list|(
name|value
argument_list|)
decl_stmt|;
if|if
condition|(
name|val
operator|<=
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|hapd
operator|->
name|gas_frag_limit
operator|=
name|val
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|cmd
argument_list|,
literal|"ext_mgmt_frame_handling"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|hapd
operator|->
name|ext_mgmt_frame_handling
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|cmd
argument_list|,
literal|"ext_eapol_frame_io"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|hapd
operator|->
name|ext_eapol_frame_io
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
block|}
else|else
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|vlan_id
decl_stmt|;
name|ret
operator|=
name|hostapd_set_iface
argument_list|(
name|hapd
operator|->
name|iconf
argument_list|,
name|hapd
operator|->
name|conf
argument_list|,
name|cmd
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|cmd
argument_list|,
literal|"deny_mac_file"
argument_list|)
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|sta
operator|=
name|hapd
operator|->
name|sta_list
init|;
name|sta
condition|;
name|sta
operator|=
name|sta
operator|->
name|next
control|)
block|{
if|if
condition|(
name|hostapd_maclist_found
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|deny_mac
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|num_deny_mac
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
operator|&
name|vlan_id
argument_list|)
operator|&&
operator|(
operator|!
name|vlan_id
operator|||
name|vlan_id
operator|==
name|sta
operator|->
name|vlan_id
operator|)
condition|)
name|ap_sta_disconnect
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|WLAN_REASON_UNSPECIFIED
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|macaddr_acl
operator|==
name|DENY_UNLESS_ACCEPTED
operator|&&
name|os_strcasecmp
argument_list|(
name|cmd
argument_list|,
literal|"accept_mac_file"
argument_list|)
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|sta
operator|=
name|hapd
operator|->
name|sta_list
init|;
name|sta
condition|;
name|sta
operator|=
name|sta
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
name|hostapd_maclist_found
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|accept_mac
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|num_accept_mac
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
operator|&
name|vlan_id
argument_list|)
operator|||
operator|(
name|vlan_id
operator|&&
name|vlan_id
operator|!=
name|sta
operator|->
name|vlan_id
operator|)
condition|)
name|ap_sta_disconnect
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|WLAN_REASON_UNSPECIFIED
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_get
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE GET '%s'"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"version"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|res
operator|=
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s"
argument_list|,
name|VERSION_STR
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|buflen
argument_list|,
name|res
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|res
return|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"tls_library"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|res
operator|=
name|tls_get_library_version
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|buflen
argument_list|,
name|res
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|res
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_enable
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|)
block|{
if|if
condition|(
name|hostapd_enable_iface
argument_list|(
name|iface
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Enabling of interface failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_reload
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|)
block|{
if|if
condition|(
name|hostapd_reload_iface
argument_list|(
name|iface
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Reloading of interface failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_disable
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|)
block|{
if|if
condition|(
name|hostapd_disable_iface
argument_list|(
name|iface
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Disabling of interface failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_radar
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|param
decl_stmt|;
name|enum
name|wpa_event_type
name|event
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RADAR TEST: %s"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|param
operator|=
name|os_strchr
argument_list|(
name|cmd
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|param
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|param
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"DETECTED"
argument_list|)
operator|==
literal|0
condition|)
name|event
operator|=
name|EVENT_DFS_RADAR_DETECTED
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"CAC-FINISHED"
argument_list|)
operator|==
literal|0
condition|)
name|event
operator|=
name|EVENT_DFS_CAC_FINISHED
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"CAC-ABORTED"
argument_list|)
operator|==
literal|0
condition|)
name|event
operator|=
name|EVENT_DFS_CAC_ABORTED
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|cmd
argument_list|,
literal|"NOP-FINISHED"
argument_list|)
operator|==
literal|0
condition|)
name|event
operator|=
name|EVENT_DFS_NOP_FINISHED
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unsupported RADAR test command: %s"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"freq="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|freq
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|5
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"ht_enabled=1"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|ht_enabled
operator|=
literal|1
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"chan_offset="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|chan_offset
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|12
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"chan_width="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|chan_width
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|11
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"cf1="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|cf1
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"cf2="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|data
operator|.
name|dfs_event
operator|.
name|cf2
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|4
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|hapd
argument_list|,
name|event
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_mgmt_tx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"External MGMT TX: %s"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|/=
literal|2
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|cmd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res
operator|=
name|hostapd_drv_send_mlme
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_eapol_rx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|u8
name|src
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|int
name|used
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"External EAPOL RX: %s"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|pos
operator|=
name|cmd
expr_stmt|;
name|used
operator|=
name|hwaddr_aton2
argument_list|(
name|pos
argument_list|,
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|used
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|used
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
condition|)
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|/=
literal|2
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ieee802_1x_receive
argument_list|(
name|hapd
argument_list|,
name|src
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u16
name|ipv4_hdr_checksum
parameter_list|(
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|u32
name|sum
init|=
literal|0
decl_stmt|;
specifier|const
name|u16
modifier|*
name|pos
init|=
name|buf
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
operator|/
literal|2
condition|;
name|i
operator|++
control|)
name|sum
operator|+=
operator|*
name|pos
operator|++
expr_stmt|;
while|while
condition|(
name|sum
operator|>>
literal|16
condition|)
name|sum
operator|=
operator|(
name|sum
operator|&
literal|0xffff
operator|)
operator|+
operator|(
name|sum
operator|>>
literal|16
operator|)
expr_stmt|;
return|return
name|sum
operator|^
literal|0xffff
return|;
block|}
end_function

begin_define
define|#
directive|define
name|HWSIM_PACKETLEN
value|1500
end_define

begin_define
define|#
directive|define
name|HWSIM_IP_LEN
value|(HWSIM_PACKETLEN - sizeof(struct ether_header))
end_define

begin_function
name|void
name|hostapd_data_test_rx
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
specifier|const
name|struct
name|ether_header
modifier|*
name|eth
decl_stmt|;
name|struct
name|iphdr
name|ip
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|len
operator|!=
name|HWSIM_PACKETLEN
condition|)
return|return;
name|eth
operator|=
operator|(
specifier|const
expr|struct
name|ether_header
operator|*
operator|)
name|buf
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|ip
argument_list|,
name|eth
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|ip
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|&
name|buf
index|[
sizeof|sizeof
argument_list|(
operator|*
name|eth
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|ip
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|ip
operator|.
name|ihl
operator|!=
literal|5
operator|||
name|ip
operator|.
name|version
operator|!=
literal|4
operator|||
name|ntohs
argument_list|(
name|ip
operator|.
name|tot_len
argument_list|)
operator|!=
name|HWSIM_IP_LEN
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|HWSIM_IP_LEN
operator|-
sizeof|sizeof
argument_list|(
name|ip
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|pos
operator|!=
operator|(
name|u8
operator|)
name|i
condition|)
return|return;
name|pos
operator|++
expr_stmt|;
block|}
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
literal|"DATA-TEST-RX "
name|MACSTR
literal|" "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|eth
operator|->
name|ether_dhost
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|eth
operator|->
name|ether_shost
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_data_test_config
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|int
name|enabled
init|=
name|atoi
argument_list|(
name|cmd
argument_list|)
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
specifier|const
name|char
modifier|*
name|ifname
decl_stmt|;
if|if
condition|(
operator|!
name|enabled
condition|)
block|{
if|if
condition|(
name|hapd
operator|->
name|l2_test
condition|)
block|{
name|l2_packet_deinit
argument_list|(
name|hapd
operator|->
name|l2_test
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|l2_test
operator|=
name|NULL
expr_stmt|;
name|wpa_dbg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"test data: Disabled"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|hapd
operator|->
name|l2_test
condition|)
return|return
literal|0
return|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|cmd
argument_list|,
literal|" ifname="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
name|ifname
operator|=
name|pos
operator|+
literal|8
expr_stmt|;
else|else
name|ifname
operator|=
name|hapd
operator|->
name|conf
operator|->
name|iface
expr_stmt|;
name|hapd
operator|->
name|l2_test
operator|=
name|l2_packet_init
argument_list|(
name|ifname
argument_list|,
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETHERTYPE_IP
argument_list|,
name|hostapd_data_test_rx
argument_list|,
name|hapd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|l2_test
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_dbg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"test data: Enabled"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_data_test_tx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|dst
index|[
name|ETH_ALEN
index|]
decl_stmt|,
name|src
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|int
name|used
decl_stmt|;
name|long
name|int
name|val
decl_stmt|;
name|u8
name|tos
decl_stmt|;
name|u8
name|buf
index|[
literal|2
operator|+
name|HWSIM_PACKETLEN
index|]
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eth
decl_stmt|;
name|struct
name|iphdr
modifier|*
name|ip
decl_stmt|;
name|u8
modifier|*
name|dpos
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|l2_test
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* format:<dst><src><tos> */
name|pos
operator|=
name|cmd
expr_stmt|;
name|used
operator|=
name|hwaddr_aton2
argument_list|(
name|pos
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|used
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|used
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|==
literal|' '
condition|)
name|pos
operator|++
expr_stmt|;
name|used
operator|=
name|hwaddr_aton2
argument_list|(
name|pos
argument_list|,
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|used
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|used
expr_stmt|;
name|val
operator|=
name|strtol
argument_list|(
name|pos
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|<
literal|0
operator|||
name|val
operator|>
literal|0xff
condition|)
return|return
operator|-
literal|1
return|;
name|tos
operator|=
name|val
expr_stmt|;
name|eth
operator|=
operator|(
expr|struct
name|ether_header
operator|*
operator|)
operator|&
name|buf
index|[
literal|2
index|]
expr_stmt|;
name|os_memcpy
argument_list|(
name|eth
operator|->
name|ether_dhost
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|eth
operator|->
name|ether_shost
argument_list|,
name|src
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|eth
operator|->
name|ether_type
operator|=
name|htons
argument_list|(
name|ETHERTYPE_IP
argument_list|)
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|iphdr
operator|*
operator|)
operator|(
name|eth
operator|+
literal|1
operator|)
expr_stmt|;
name|os_memset
argument_list|(
name|ip
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
argument_list|)
expr_stmt|;
name|ip
operator|->
name|ihl
operator|=
literal|5
expr_stmt|;
name|ip
operator|->
name|version
operator|=
literal|4
expr_stmt|;
name|ip
operator|->
name|ttl
operator|=
literal|64
expr_stmt|;
name|ip
operator|->
name|tos
operator|=
name|tos
expr_stmt|;
name|ip
operator|->
name|tot_len
operator|=
name|htons
argument_list|(
name|HWSIM_IP_LEN
argument_list|)
expr_stmt|;
name|ip
operator|->
name|protocol
operator|=
literal|1
expr_stmt|;
name|ip
operator|->
name|saddr
operator|=
name|htonl
argument_list|(
literal|192U
operator|<<
literal|24
operator||
literal|168
operator|<<
literal|16
operator||
literal|1
operator|<<
literal|8
operator||
literal|1
argument_list|)
expr_stmt|;
name|ip
operator|->
name|daddr
operator|=
name|htonl
argument_list|(
literal|192U
operator|<<
literal|24
operator||
literal|168
operator|<<
literal|16
operator||
literal|1
operator|<<
literal|8
operator||
literal|2
argument_list|)
expr_stmt|;
name|ip
operator|->
name|check
operator|=
name|ipv4_hdr_checksum
argument_list|(
name|ip
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
argument_list|)
expr_stmt|;
name|dpos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|ip
operator|+
literal|1
operator|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|HWSIM_IP_LEN
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|ip
argument_list|)
condition|;
name|i
operator|++
control|)
operator|*
name|dpos
operator|++
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|l2_packet_send
argument_list|(
name|hapd
operator|->
name|l2_test
argument_list|,
name|dst
argument_list|,
name|ETHERTYPE_IP
argument_list|,
operator|&
name|buf
index|[
literal|2
index|]
argument_list|,
name|HWSIM_PACKETLEN
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_dbg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"test data: TX dst="
name|MACSTR
literal|" src="
name|MACSTR
literal|" tos=0x%x"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|src
argument_list|)
argument_list|,
name|tos
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_data_test_frame
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|;
name|struct
name|ether_header
modifier|*
name|eth
decl_stmt|;
name|struct
name|l2_packet_data
modifier|*
name|l2
init|=
name|NULL
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u16
name|ethertype
decl_stmt|;
name|int
name|res
init|=
operator|-
literal|1
decl_stmt|;
specifier|const
name|char
modifier|*
name|ifname
init|=
name|hapd
operator|->
name|conf
operator|->
name|iface
decl_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|cmd
argument_list|,
literal|"ifname="
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|cmd
operator|+=
literal|7
expr_stmt|;
name|ifname
operator|=
name|cmd
expr_stmt|;
name|cmd
operator|=
name|os_strchr
argument_list|(
name|cmd
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmd
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|cmd
operator|++
operator|=
literal|'\0'
expr_stmt|;
block|}
name|len
operator|=
name|os_strlen
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|1
operator|||
name|len
operator|<
name|ETH_HLEN
operator|*
literal|2
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|/=
literal|2
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|cmd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|done
goto|;
name|eth
operator|=
operator|(
expr|struct
name|ether_header
operator|*
operator|)
name|buf
expr_stmt|;
name|ethertype
operator|=
name|ntohs
argument_list|(
name|eth
operator|->
name|ether_type
argument_list|)
expr_stmt|;
name|l2
operator|=
name|l2_packet_init
argument_list|(
name|ifname
argument_list|,
name|hapd
operator|->
name|own_addr
argument_list|,
name|ethertype
argument_list|,
name|hostapd_data_test_rx
argument_list|,
name|hapd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|l2
operator|==
name|NULL
condition|)
goto|goto
name|done
goto|;
name|res
operator|=
name|l2_packet_send
argument_list|(
name|l2
argument_list|,
name|eth
operator|->
name|ether_dhost
argument_list|,
name|ethertype
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"test data: TX frame res=%d"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|done
label|:
if|if
condition|(
name|l2
condition|)
name|l2_packet_deinit
argument_list|(
name|l2
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|res
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_test_alloc_fail
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|WPA_TRACE_BFD
specifier|extern
name|char
name|wpa_trace_fail_func
index|[
literal|256
index|]
decl_stmt|;
specifier|extern
name|unsigned
name|int
name|wpa_trace_fail_after
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|wpa_trace_fail_after
operator|=
name|atoi
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|cmd
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|++
expr_stmt|;
name|os_strlcpy
argument_list|(
name|wpa_trace_fail_func
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_trace_fail_func
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_trace_fail_after
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* WPA_TRACE_BFD */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* WPA_TRACE_BFD */
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_get_alloc_fail
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|WPA_TRACE_BFD
specifier|extern
name|char
name|wpa_trace_fail_func
index|[
literal|256
index|]
decl_stmt|;
specifier|extern
name|unsigned
name|int
name|wpa_trace_fail_after
decl_stmt|;
return|return
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%u:%s"
argument_list|,
name|wpa_trace_fail_after
argument_list|,
name|wpa_trace_fail_func
argument_list|)
return|;
else|#
directive|else
comment|/* WPA_TRACE_BFD */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* WPA_TRACE_BFD */
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_test_fail
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|WPA_TRACE_BFD
specifier|extern
name|char
name|wpa_trace_test_fail_func
index|[
literal|256
index|]
decl_stmt|;
specifier|extern
name|unsigned
name|int
name|wpa_trace_test_fail_after
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|wpa_trace_test_fail_after
operator|=
name|atoi
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|cmd
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|++
expr_stmt|;
name|os_strlcpy
argument_list|(
name|wpa_trace_test_fail_func
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_trace_test_fail_func
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_trace_test_fail_after
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* WPA_TRACE_BFD */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* WPA_TRACE_BFD */
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_get_fail
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|WPA_TRACE_BFD
specifier|extern
name|char
name|wpa_trace_test_fail_func
index|[
literal|256
index|]
decl_stmt|;
specifier|extern
name|unsigned
name|int
name|wpa_trace_test_fail_after
decl_stmt|;
return|return
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%u:%s"
argument_list|,
name|wpa_trace_test_fail_after
argument_list|,
name|wpa_trace_test_fail_func
argument_list|)
return|;
else|#
directive|else
comment|/* WPA_TRACE_BFD */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* WPA_TRACE_BFD */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_TESTING_OPTIONS */
end_comment

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_chan_switch
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|char
modifier|*
name|pos
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|NEED_AP_MLME
name|struct
name|csa_settings
name|settings
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|ret
operator|=
name|hostapd_parse_csa_settings
argument_list|(
name|pos
argument_list|,
operator|&
name|settings
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|hostapd_switch_channel
argument_list|(
name|iface
operator|->
name|bss
index|[
name|i
index|]
argument_list|,
operator|&
name|settings
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
comment|/* FIX: What do we do if CSA fails in the middle of 			 * submitting multi-BSS CSA requests? */
return|return
name|ret
return|;
block|}
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* NEED_AP_MLME */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* NEED_AP_MLME */
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_mib
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|reply
parameter_list|,
name|int
name|reply_size
parameter_list|,
specifier|const
name|char
modifier|*
name|param
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|RADIUS_SERVER
if|if
condition|(
name|os_strcmp
argument_list|(
name|param
argument_list|,
literal|"radius_server"
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|radius_server_get_mib
argument_list|(
name|hapd
operator|->
name|radius_srv
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
return|;
block|}
endif|#
directive|endif
comment|/* RADIUS_SERVER */
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_vendor
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|u8
modifier|*
name|data
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|vendor_id
decl_stmt|,
name|subcmd
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|reply
decl_stmt|;
name|size_t
name|data_len
init|=
literal|0
decl_stmt|;
comment|/* cmd:<vendor id><subcommand id> [<hex formatted data>] */
name|vendor_id
operator|=
name|strtoul
argument_list|(
name|cmd
argument_list|,
operator|&
name|pos
argument_list|,
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|isblank
argument_list|(
operator|*
name|pos
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|subcmd
operator|=
name|strtoul
argument_list|(
name|pos
argument_list|,
operator|&
name|pos
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|!
name|isblank
argument_list|(
operator|*
name|pos
operator|++
argument_list|)
condition|)
return|return
operator|-
name|EINVAL
return|;
name|data_len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data_len
condition|)
block|{
name|data_len
operator|/=
literal|2
expr_stmt|;
name|data
operator|=
name|os_malloc
argument_list|(
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
return|return
operator|-
name|ENOBUFS
return|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Vendor command: wrong parameter format"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
block|}
name|reply
operator|=
name|wpabuf_alloc
argument_list|(
operator|(
name|buflen
operator|-
literal|1
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reply
condition|)
block|{
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOBUFS
return|;
block|}
name|ret
operator|=
name|hostapd_drv_vendor_cmd
argument_list|(
name|hapd
argument_list|,
name|vendor_id
argument_list|,
name|subcmd
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|reply
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|ret
operator|=
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
name|wpabuf_head_u8
argument_list|(
name|reply
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_eapol_reauth
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|cmd
argument_list|,
name|addr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
operator|||
operator|!
name|sta
operator|->
name|eapol_sm
condition|)
return|return
operator|-
literal|1
return|;
name|eapol_auth_reauthenticate
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_eapol_set
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|char
modifier|*
name|pos
init|=
name|cmd
decl_stmt|,
modifier|*
name|param
decl_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|pos
argument_list|,
name|addr
argument_list|)
operator|||
name|pos
index|[
literal|17
index|]
operator|!=
literal|' '
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
literal|18
expr_stmt|;
name|param
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
operator|||
operator|!
name|sta
operator|->
name|eapol_sm
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|eapol_auth_set_conf
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
name|param
argument_list|,
name|pos
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_log_level
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|stamp
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* cmd: "LOG_LEVEL [<level>]" */
if|if
condition|(
operator|*
name|cmd
operator|==
literal|'\0'
condition|)
block|{
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|buflen
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"Current level: %s\n"
literal|"Timestamp: %d\n"
argument_list|,
name|debug_level_str
argument_list|(
name|wpa_debug_level
argument_list|)
argument_list|,
name|wpa_debug_timestamp
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
return|return
name|ret
return|;
block|}
while|while
condition|(
operator|*
name|cmd
operator|==
literal|' '
condition|)
name|cmd
operator|++
expr_stmt|;
name|stamp
operator|=
name|os_strchr
argument_list|(
name|cmd
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|stamp
condition|)
block|{
operator|*
name|stamp
operator|++
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
operator|*
name|stamp
operator|==
literal|' '
condition|)
block|{
name|stamp
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|os_strlen
argument_list|(
name|cmd
argument_list|)
condition|)
block|{
name|int
name|level
init|=
name|str_to_debug_level
argument_list|(
name|cmd
argument_list|)
decl_stmt|;
if|if
condition|(
name|level
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_debug_level
operator|=
name|level
expr_stmt|;
block|}
if|if
condition|(
name|stamp
operator|&&
name|os_strlen
argument_list|(
name|stamp
argument_list|)
condition|)
name|wpa_debug_timestamp
operator|=
name|atoi
argument_list|(
name|stamp
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|buf
argument_list|,
literal|"OK\n"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
return|return
literal|3
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|NEED_AP_MLME
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_track_sta_list
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|hapd
operator|->
name|iface
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|struct
name|hostapd_sta_info
modifier|*
name|info
decl_stmt|;
name|struct
name|os_reltime
name|now
decl_stmt|;
name|sta_track_expire
argument_list|(
name|iface
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|buflen
expr_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|dl_list_for_each_reverse
argument_list|(
argument|info
argument_list|,
argument|&iface->sta_seen
argument_list|,
argument|struct hostapd_sta_info
argument_list|,
argument|list
argument_list|)
block|{
name|struct
name|os_reltime
name|age
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|os_reltime_sub
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|info
operator|->
name|last_seen
argument_list|,
operator|&
name|age
argument_list|)
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|MACSTR
literal|" %u\n"
argument_list|,
name|MAC2STR
argument_list|(
name|info
operator|->
name|addr
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|age
operator|.
name|sec
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
break|break;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NEED_AP_MLME */
end_comment

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_receive_process
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
name|reply
parameter_list|,
name|int
name|reply_size
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|int
name|reply_len
decl_stmt|,
name|res
decl_stmt|;
name|os_memcpy
argument_list|(
name|reply
argument_list|,
literal|"OK\n"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|reply_len
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"PING"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|reply
argument_list|,
literal|"PONG\n"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|reply_len
operator|=
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"RELOG"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_debug_reopen_file
argument_list|()
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"STATUS"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_status
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"STATUS-DRIVER"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_drv_status
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"MIB"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|ieee802_11_get_mib
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply_len
operator|>=
literal|0
condition|)
block|{
name|res
operator|=
name|wpa_get_mib
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|reply
operator|+
name|reply_len
argument_list|,
name|reply_size
operator|-
name|reply_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|reply_len
operator|+=
name|res
expr_stmt|;
block|}
if|if
condition|(
name|reply_len
operator|>=
literal|0
condition|)
block|{
name|res
operator|=
name|ieee802_1x_get_mib
argument_list|(
name|hapd
argument_list|,
name|reply
operator|+
name|reply_len
argument_list|,
name|reply_size
operator|-
name|reply_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|reply_len
operator|+=
name|res
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|CONFIG_NO_RADIUS
if|if
condition|(
name|reply_len
operator|>=
literal|0
condition|)
block|{
name|res
operator|=
name|radius_client_get_mib
argument_list|(
name|hapd
operator|->
name|radius
argument_list|,
name|reply
operator|+
name|reply_len
argument_list|,
name|reply_size
operator|-
name|reply_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|reply_len
operator|+=
name|res
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_RADIUS */
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"MIB "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_mib
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"STA-FIRST"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_sta_first
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"STA "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_sta
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|4
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"STA-NEXT "
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_sta_next
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|9
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"ATTACH"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_attach
argument_list|(
name|hapd
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"DETACH"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_detach
argument_list|(
name|hapd
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"LEVEL "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_level
argument_list|(
name|hapd
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|,
name|buf
operator|+
literal|6
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"NEW_STA "
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_new_sta
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"DEAUTHENTICATE "
argument_list|,
literal|15
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_deauthenticate
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|15
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"DISASSOCIATE "
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_disassociate
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|13
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"STOP_AP"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_stop_ap
argument_list|(
name|hapd
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
ifdef|#
directive|ifdef
name|NEED_AP_MLME
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"SA_QUERY "
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_sa_query
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|9
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* NEED_AP_MLME */
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_WPS
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"WPS_PIN "
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_wps_pin
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"WPS_CHECK_PIN "
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_wps_check_pin
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|14
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"WPS_PBC"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_wps_button_pushed
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"WPS_CANCEL"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_wps_cancel
argument_list|(
name|hapd
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"WPS_AP_PIN "
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_wps_ap_pin
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|11
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"WPS_CONFIG "
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_wps_config
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|11
argument_list|)
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"WPS_GET_STATUS"
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_wps_get_status
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"WPS_NFC_TAG_READ "
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_wps_nfc_tag_read
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|17
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"WPS_NFC_CONFIG_TOKEN "
argument_list|,
literal|21
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_wps_nfc_config_token
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|21
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"WPS_NFC_TOKEN "
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_wps_nfc_token
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|14
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"NFC_GET_HANDOVER_SEL "
argument_list|,
literal|21
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_nfc_get_handover_sel
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|21
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"NFC_REPORT_HANDOVER "
argument_list|,
literal|20
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_nfc_report_handover
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|20
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
endif|#
directive|endif
comment|/* CONFIG_WPS */
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"SET_QOS_MAP_SET "
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_set_qos_map_set
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|16
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"SEND_QOS_MAP_CONF "
argument_list|,
literal|18
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_send_qos_map_conf
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|18
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
ifdef|#
directive|ifdef
name|CONFIG_HS20
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"HS20_WNM_NOTIF "
argument_list|,
literal|15
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_hs20_wnm_notif
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|15
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"HS20_DEAUTH_REQ "
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_hs20_deauth_req
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|16
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
ifdef|#
directive|ifdef
name|CONFIG_WNM
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"DISASSOC_IMMINENT "
argument_list|,
literal|18
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_disassoc_imminent
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|18
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"ESS_DISASSOC "
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_ess_disassoc
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|13
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"BSS_TM_REQ "
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_bss_tm_req
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|11
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WNM */
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"GET_CONFIG"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_get_config
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"SET "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_set
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"GET "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_get
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|4
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"ENABLE"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_enable
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"RELOAD"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_reload
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"DISABLE"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_disable
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"UPDATE_BEACON"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ieee802_11_set_beacon
argument_list|(
name|hapd
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"RADAR "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_radar
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|6
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"MGMT_TX "
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_mgmt_tx
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"EAPOL_RX "
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_eapol_rx
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|9
argument_list|)
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"DATA_TEST_CONFIG "
argument_list|,
literal|17
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_data_test_config
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|17
argument_list|)
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"DATA_TEST_TX "
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_data_test_tx
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|13
argument_list|)
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"DATA_TEST_FRAME "
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_data_test_frame
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|16
argument_list|)
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"TEST_ALLOC_FAIL "
argument_list|,
literal|16
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_test_alloc_fail
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|16
argument_list|)
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"GET_ALLOC_FAIL"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_get_alloc_fail
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"TEST_FAIL "
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_test_fail
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|10
argument_list|)
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"GET_FAIL"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_get_fail
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"CHAN_SWITCH "
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_chan_switch
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|buf
operator|+
literal|12
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"VENDOR "
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_vendor
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|7
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"ERP_FLUSH"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ieee802_1x_erp_flush
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RADIUS_SERVER
name|radius_server_erp_flush
argument_list|(
name|hapd
operator|->
name|radius_srv
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* RADIUS_SERVER */
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"EAPOL_REAUTH "
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_eapol_reauth
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|13
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"EAPOL_SET "
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_eapol_set
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|10
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"LOG_LEVEL"
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_log_level
argument_list|(
name|hapd
argument_list|,
name|buf
operator|+
literal|9
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|NEED_AP_MLME
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"TRACK_STA_LIST"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|hostapd_ctrl_iface_track_sta_list
argument_list|(
name|hapd
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* NEED_AP_MLME */
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|reply
argument_list|,
literal|"UNKNOWN COMMAND\n"
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|reply_len
operator|=
literal|16
expr_stmt|;
block|}
if|if
condition|(
name|reply_len
operator|<
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|reply
argument_list|,
literal|"FAIL\n"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|reply_len
operator|=
literal|5
expr_stmt|;
block|}
return|return
name|reply_len
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_ctrl_iface_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|eloop_ctx
decl_stmt|;
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|sockaddr_un
name|from
decl_stmt|;
name|socklen_t
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
decl_stmt|;
name|char
modifier|*
name|reply
decl_stmt|;
specifier|const
name|int
name|reply_size
init|=
literal|4096
decl_stmt|;
name|int
name|reply_len
decl_stmt|;
name|int
name|level
init|=
name|MSG_DEBUG
decl_stmt|;
name|res
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"recvfrom(ctrl_iface): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"PING"
argument_list|)
operator|==
literal|0
condition|)
name|level
operator|=
name|MSG_EXCESSIVE
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|level
argument_list|,
literal|"RX ctrl_iface"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|buf
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|reply
operator|=
name|os_malloc
argument_list|(
name|reply_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|sendto
argument_list|(
name|sock
argument_list|,
literal|"FAIL\n"
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL: sendto failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|reply_len
operator|=
name|hostapd_ctrl_iface_receive_process
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendto
argument_list|(
name|sock
argument_list|,
name|reply
argument_list|,
name|reply_len
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL: sendto failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|hostapd_ctrl_iface_path
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|len
operator|=
name|os_strlen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
operator|+
name|os_strlen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
operator|+
literal|2
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|"%s/%s"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_ctrl_iface_msg_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|level
parameter_list|,
name|enum
name|wpa_msg_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|txt
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
condition|)
return|return;
name|hostapd_ctrl_iface_send
argument_list|(
name|hapd
argument_list|,
name|level
argument_list|,
name|type
argument_list|,
name|txt
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|hostapd_ctrl_iface_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|int
name|s
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|fname
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|ctrl_sock
operator|>
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_iface already exists!"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|mkdir
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|,
name|S_IRWXU
operator||
name|S_IRWXG
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EEXIST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Using existing control "
literal|"interface directory."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"mkdir[ctrl_interface]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface_gid_set
operator|&&
name|chown
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|,
operator|-
literal|1
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface_gid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"chown[ctrl_interface]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface_gid_set
operator|&&
name|hapd
operator|->
name|iface
operator|->
name|interfaces
operator|->
name|ctrl_iface_group
operator|&&
name|chown
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|,
operator|-
literal|1
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|interfaces
operator|->
name|ctrl_iface_group
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"chown[ctrl_interface]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|ANDROID
comment|/* 	 * Android is using umask 0077 which would leave the control interface 	 * directory without group access. This breaks things since Wi-Fi 	 * framework assumes that this directory can be accessed by other 	 * applications in the wifi group. Fix this by adding group access even 	 * if umask value would prevent this. 	 */
if|if
condition|(
name|chmod
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|,
name|S_IRWXU
operator||
name|S_IRWXG
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"CTRL: Could not chmod directory: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Try to continue anyway */
block|}
endif|#
directive|endif
comment|/* ANDROID */
if|if
condition|(
name|os_strlen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|s
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"socket(PF_UNIX): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|addr
operator|.
name|sun_len
operator|=
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __FreeBSD__ */
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|fname
operator|=
name|hostapd_ctrl_iface_path
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
if|if
condition|(
name|fname
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_strlcpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_iface bind(PF_UNIX) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|connect
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_iface exists, but does not"
literal|" allow connections - assuming it was left"
literal|"over from forced program termination"
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlink
argument_list|(
name|fname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not unlink existing ctrl_iface socket '%s': %s"
argument_list|,
name|fname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"hostapd-ctrl-iface: bind(PF_UNIX): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Successfully replaced leftover "
literal|"ctrl_iface socket '%s'"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ctrl_iface exists and seems to "
literal|"be in use - cannot override it"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Delete '%s' manually if it is "
literal|"not used anymore"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|fname
operator|=
name|NULL
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface_gid_set
operator|&&
name|chown
argument_list|(
name|fname
argument_list|,
operator|-
literal|1
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface_gid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"chown[ctrl_interface/ifname]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface_gid_set
operator|&&
name|hapd
operator|->
name|iface
operator|->
name|interfaces
operator|->
name|ctrl_iface_group
operator|&&
name|chown
argument_list|(
name|fname
argument_list|,
operator|-
literal|1
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|interfaces
operator|->
name|ctrl_iface_group
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"chown[ctrl_interface/ifname]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|chmod
argument_list|(
name|fname
argument_list|,
name|S_IRWXU
operator||
name|S_IRWXG
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"chmod[ctrl_interface/ifname]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|ctrl_sock
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|eloop_register_read_sock
argument_list|(
name|s
argument_list|,
name|hostapd_ctrl_iface_receive
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|hostapd_ctrl_iface_deinit
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hapd
operator|->
name|msg_ctx
operator|=
name|hapd
expr_stmt|;
name|wpa_msg_register_cb
argument_list|(
name|hostapd_ctrl_iface_msg_cb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
if|if
condition|(
name|s
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|fname
condition|)
block|{
name|unlink
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|hostapd_ctrl_iface_deinit
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|struct
name|wpa_ctrl_dst
modifier|*
name|dst
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|ctrl_sock
operator|>
operator|-
literal|1
condition|)
block|{
name|char
modifier|*
name|fname
decl_stmt|;
name|eloop_unregister_read_sock
argument_list|(
name|hapd
operator|->
name|ctrl_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|hapd
operator|->
name|ctrl_sock
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|ctrl_sock
operator|=
operator|-
literal|1
expr_stmt|;
name|fname
operator|=
name|hostapd_ctrl_iface_path
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
if|if
condition|(
name|fname
condition|)
name|unlink
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
operator|&&
name|rmdir
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOTEMPTY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Control interface "
literal|"directory not empty - leaving it "
literal|"behind"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"rmdir[ctrl_interface=%s]: %s"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ctrl_interface
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|dst
operator|=
name|hapd
operator|->
name|ctrl_dst
expr_stmt|;
name|hapd
operator|->
name|ctrl_dst
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|dst
condition|)
block|{
name|prev
operator|=
name|dst
expr_stmt|;
name|dst
operator|=
name|dst
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
name|l2_packet_deinit
argument_list|(
name|hapd
operator|->
name|l2_test
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|l2_test
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_add
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hostapd_add_iface
argument_list|(
name|interfaces
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Adding interface %s failed"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_remove
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|hostapd_remove_iface
argument_list|(
name|interfaces
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Removing interface %s failed"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_global_ctrl_iface_attach
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|wpa_ctrl_dst
modifier|*
name|dst
decl_stmt|;
name|dst
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|dst
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
operator|&
name|dst
operator|->
name|addr
argument_list|,
name|from
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|->
name|addrlen
operator|=
name|fromlen
expr_stmt|;
name|dst
operator|->
name|debug_level
operator|=
name|MSG_INFO
expr_stmt|;
name|dst
operator|->
name|next
operator|=
name|interfaces
operator|->
name|global_ctrl_dst
expr_stmt|;
name|interfaces
operator|->
name|global_ctrl_dst
operator|=
name|dst
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE monitor attached (global)"
argument_list|,
name|from
operator|->
name|sun_path
argument_list|,
name|fromlen
operator|-
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_global_ctrl_iface_detach
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|wpa_ctrl_dst
modifier|*
name|dst
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
name|dst
operator|=
name|interfaces
operator|->
name|global_ctrl_dst
expr_stmt|;
while|while
condition|(
name|dst
condition|)
block|{
if|if
condition|(
name|fromlen
operator|==
name|dst
operator|->
name|addrlen
operator|&&
name|os_memcmp
argument_list|(
name|from
operator|->
name|sun_path
argument_list|,
name|dst
operator|->
name|addr
operator|.
name|sun_path
argument_list|,
name|fromlen
operator|-
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE monitor detached (global)"
argument_list|,
name|from
operator|->
name|sun_path
argument_list|,
name|fromlen
operator|-
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
name|interfaces
operator|->
name|global_ctrl_dst
operator|=
name|dst
operator|->
name|next
expr_stmt|;
else|else
name|prev
operator|->
name|next
operator|=
name|dst
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|dst
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|prev
operator|=
name|dst
expr_stmt|;
name|dst
operator|=
name|dst
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_ctrl_iface_flush
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_TESTING
name|wps_version_number
operator|=
literal|0x20
expr_stmt|;
name|wps_testing_dummy_cred
operator|=
literal|0
expr_stmt|;
name|wps_corrupt_pkhash
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_TESTING */
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_FST
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_global_ctrl_iface_fst_attach
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|char
name|ifname
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|fst_iface_cfg
name|cfg
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|struct
name|fst_wpa_obj
name|iface_obj
decl_stmt|;
if|if
condition|(
operator|!
name|fst_parse_attach_command
argument_list|(
name|cmd
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
argument_list|,
operator|&
name|cfg
argument_list|)
condition|)
block|{
name|hapd
operator|=
name|hostapd_get_iface
argument_list|(
name|interfaces
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
condition|)
block|{
if|if
condition|(
name|hapd
operator|->
name|iface
operator|->
name|fst
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"FST: Already attached"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fst_hostapd_fill_iface_obj
argument_list|(
name|hapd
argument_list|,
operator|&
name|iface_obj
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|iface
operator|->
name|fst
operator|=
name|fst_attach
argument_list|(
name|ifname
argument_list|,
name|hapd
operator|->
name|own_addr
argument_list|,
operator|&
name|iface_obj
argument_list|,
operator|&
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|iface
operator|->
name|fst
condition|)
return|return
literal|0
return|;
block|}
block|}
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_global_ctrl_iface_fst_detach
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|char
name|ifname
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
if|if
condition|(
operator|!
name|fst_parse_detach_command
argument_list|(
name|cmd
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
argument_list|)
condition|)
block|{
name|hapd
operator|=
name|hostapd_get_iface
argument_list|(
name|interfaces
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
condition|)
block|{
if|if
condition|(
operator|!
name|fst_iface_detach
argument_list|(
name|ifname
argument_list|)
condition|)
block|{
name|hapd
operator|->
name|iface
operator|->
name|fst
operator|=
name|NULL
expr_stmt|;
name|hapd
operator|->
name|iface
operator|->
name|fst_ies
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
return|return
operator|-
name|EINVAL
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_FST */
end_comment

begin_function
specifier|static
name|struct
name|hostapd_data
modifier|*
name|hostapd_interfaces_get_hapd
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|interfaces
operator|->
name|count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|interfaces
operator|->
name|iface
index|[
name|i
index|]
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|j
operator|++
control|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|hapd
operator|=
name|iface
operator|->
name|bss
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|ifname
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
operator|==
literal|0
condition|)
return|return
name|hapd
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_ctrl_iface_dup_param
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|src_hapd
parameter_list|,
name|struct
name|hostapd_data
modifier|*
name|dst_hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|param
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
name|value
operator|=
name|os_zalloc
argument_list|(
name|HOSTAPD_CLI_DUP_VALUE_MAX_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|value
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"DUP: cannot allocate buffer to stringify %s"
argument_list|,
name|param
argument_list|)
expr_stmt|;
goto|goto
name|error_return
goto|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|param
argument_list|,
literal|"wpa"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_snprintf
argument_list|(
name|value
argument_list|,
name|HOSTAPD_CLI_DUP_VALUE_MAX_LEN
argument_list|,
literal|"%d"
argument_list|,
name|src_hapd
operator|->
name|conf
operator|->
name|wpa
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|param
argument_list|,
literal|"wpa_key_mgmt"
argument_list|)
operator|==
literal|0
operator|&&
name|src_hapd
operator|->
name|conf
operator|->
name|wpa_key_mgmt
condition|)
block|{
name|res
operator|=
name|hostapd_ctrl_iface_get_key_mgmt
argument_list|(
name|src_hapd
argument_list|,
name|value
argument_list|,
name|HOSTAPD_CLI_DUP_VALUE_MAX_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|HOSTAPD_CLI_DUP_VALUE_MAX_LEN
argument_list|,
name|res
argument_list|)
condition|)
goto|goto
name|error_stringify
goto|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|param
argument_list|,
literal|"wpa_pairwise"
argument_list|)
operator|==
literal|0
operator|&&
name|src_hapd
operator|->
name|conf
operator|->
name|wpa_pairwise
condition|)
block|{
name|res
operator|=
name|wpa_write_ciphers
argument_list|(
name|value
argument_list|,
name|value
operator|+
name|HOSTAPD_CLI_DUP_VALUE_MAX_LEN
argument_list|,
name|src_hapd
operator|->
name|conf
operator|->
name|wpa_pairwise
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
goto|goto
name|error_stringify
goto|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|param
argument_list|,
literal|"rsn_pairwise"
argument_list|)
operator|==
literal|0
operator|&&
name|src_hapd
operator|->
name|conf
operator|->
name|rsn_pairwise
condition|)
block|{
name|res
operator|=
name|wpa_write_ciphers
argument_list|(
name|value
argument_list|,
name|value
operator|+
name|HOSTAPD_CLI_DUP_VALUE_MAX_LEN
argument_list|,
name|src_hapd
operator|->
name|conf
operator|->
name|rsn_pairwise
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
goto|goto
name|error_stringify
goto|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|param
argument_list|,
literal|"wpa_passphrase"
argument_list|)
operator|==
literal|0
operator|&&
name|src_hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
condition|)
block|{
name|os_snprintf
argument_list|(
name|value
argument_list|,
name|HOSTAPD_CLI_DUP_VALUE_MAX_LEN
argument_list|,
literal|"%s"
argument_list|,
name|src_hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|param
argument_list|,
literal|"wpa_psk"
argument_list|)
operator|==
literal|0
operator|&&
name|src_hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk_set
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|value
argument_list|,
name|HOSTAPD_CLI_DUP_VALUE_MAX_LEN
argument_list|,
name|src_hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"DUP: %s cannot be duplicated"
argument_list|,
name|param
argument_list|)
expr_stmt|;
goto|goto
name|error_return
goto|;
block|}
name|res
operator|=
name|hostapd_set_iface
argument_list|(
name|dst_hapd
operator|->
name|iconf
argument_list|,
name|dst_hapd
operator|->
name|conf
argument_list|,
name|param
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
return|return
name|res
return|;
name|error_stringify
label|:
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"DUP: cannot stringify %s"
argument_list|,
name|param
argument_list|)
expr_stmt|;
name|error_return
label|:
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_global_ctrl_iface_dup_network
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|char
modifier|*
name|p_start
init|=
name|cmd
decl_stmt|,
modifier|*
name|p_end
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|src_hapd
decl_stmt|,
modifier|*
name|dst_hapd
decl_stmt|;
comment|/* cmd: "<src ifname><dst ifname><variable name> */
name|p_end
operator|=
name|os_strchr
argument_list|(
name|p_start
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"DUP: no src ifname found in cmd: '%s'"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|p_end
operator|=
literal|'\0'
expr_stmt|;
name|src_hapd
operator|=
name|hostapd_interfaces_get_hapd
argument_list|(
name|interfaces
argument_list|,
name|p_start
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|src_hapd
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"DUP: no src ifname found: '%s'"
argument_list|,
name|p_start
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p_start
operator|=
name|p_end
operator|+
literal|1
expr_stmt|;
name|p_end
operator|=
name|os_strchr
argument_list|(
name|p_start
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p_end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"DUP: no dst ifname found in cmd: '%s'"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|p_end
operator|=
literal|'\0'
expr_stmt|;
name|dst_hapd
operator|=
name|hostapd_interfaces_get_hapd
argument_list|(
name|interfaces
argument_list|,
name|p_start
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dst_hapd
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"DUP: no dst ifname found: '%s'"
argument_list|,
name|p_start
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p_start
operator|=
name|p_end
operator|+
literal|1
expr_stmt|;
return|return
name|hostapd_ctrl_iface_dup_param
argument_list|(
name|src_hapd
argument_list|,
name|dst_hapd
argument_list|,
name|p_start
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_global_ctrl_iface_ifname
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
name|reply
parameter_list|,
name|int
name|reply_size
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|socklen_t
name|fromlen
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|hapd
operator|=
name|hostapd_interfaces_get_hapd
argument_list|(
name|interfaces
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
condition|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|os_snprintf
argument_list|(
name|reply
argument_list|,
name|reply_size
argument_list|,
literal|"FAIL-NO-IFNAME-MATCH\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|reply_size
argument_list|,
name|res
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|res
return|;
block|}
return|return
name|hostapd_ctrl_iface_receive_process
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|,
name|from
argument_list|,
name|fromlen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_global_ctrl_iface_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|void
modifier|*
name|interfaces
init|=
name|eloop_ctx
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|sockaddr_un
name|from
decl_stmt|;
name|socklen_t
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
decl_stmt|;
name|char
modifier|*
name|reply
decl_stmt|;
name|int
name|reply_len
decl_stmt|;
specifier|const
name|int
name|reply_size
init|=
literal|4096
decl_stmt|;
name|res
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"recvfrom(ctrl_iface): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Global ctrl_iface command: %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|reply
operator|=
name|os_malloc
argument_list|(
name|reply_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|sendto
argument_list|(
name|sock
argument_list|,
literal|"FAIL\n"
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL: sendto failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|os_memcpy
argument_list|(
name|reply
argument_list|,
literal|"OK\n"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|reply_len
operator|=
literal|3
expr_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"IFNAME="
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|pos
init|=
name|os_strchr
argument_list|(
name|buf
operator|+
literal|7
argument_list|,
literal|' '
argument_list|)
decl_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|reply_len
operator|=
name|hostapd_global_ctrl_iface_ifname
argument_list|(
name|interfaces
argument_list|,
name|buf
operator|+
literal|7
argument_list|,
name|pos
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
goto|goto
name|send_reply
goto|;
block|}
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"PING"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|reply
argument_list|,
literal|"PONG\n"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|reply_len
operator|=
literal|5
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"RELOG"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_debug_reopen_file
argument_list|()
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"FLUSH"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|hostapd_ctrl_iface_flush
argument_list|(
name|interfaces
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"ADD "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_add
argument_list|(
name|interfaces
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"REMOVE "
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_ctrl_iface_remove
argument_list|(
name|interfaces
argument_list|,
name|buf
operator|+
literal|7
argument_list|)
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"ATTACH"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_global_ctrl_iface_attach
argument_list|(
name|interfaces
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"DETACH"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hostapd_global_ctrl_iface_detach
argument_list|(
name|interfaces
argument_list|,
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_MODULE_TESTS
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|buf
argument_list|,
literal|"MODULE_TESTS"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|hapd_module_tests
argument_list|(
name|void
argument_list|)
decl_stmt|;
if|if
condition|(
name|hapd_module_tests
argument_list|()
operator|<
literal|0
condition|)
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_MODULE_TESTS */
ifdef|#
directive|ifdef
name|CONFIG_FST
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"FST-ATTACH "
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|hostapd_global_ctrl_iface_fst_attach
argument_list|(
name|interfaces
argument_list|,
name|buf
operator|+
literal|11
argument_list|)
condition|)
name|reply_len
operator|=
name|os_snprintf
argument_list|(
name|reply
argument_list|,
name|reply_size
argument_list|,
literal|"OK\n"
argument_list|)
expr_stmt|;
else|else
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"FST-DETACH "
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|hostapd_global_ctrl_iface_fst_detach
argument_list|(
name|interfaces
argument_list|,
name|buf
operator|+
literal|11
argument_list|)
condition|)
name|reply_len
operator|=
name|os_snprintf
argument_list|(
name|reply
argument_list|,
name|reply_size
argument_list|,
literal|"OK\n"
argument_list|)
expr_stmt|;
else|else
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"FST-MANAGER "
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
block|{
name|reply_len
operator|=
name|fst_ctrl_iface_receive
argument_list|(
name|buf
operator|+
literal|12
argument_list|,
name|reply
argument_list|,
name|reply_size
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_FST */
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"DUP_NETWORK "
argument_list|,
literal|12
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|hostapd_global_ctrl_iface_dup_network
argument_list|(
name|interfaces
argument_list|,
name|buf
operator|+
literal|12
argument_list|)
condition|)
name|reply_len
operator|=
name|os_snprintf
argument_list|(
name|reply
argument_list|,
name|reply_size
argument_list|,
literal|"OK\n"
argument_list|)
expr_stmt|;
else|else
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unrecognized global ctrl_iface command "
literal|"ignored"
argument_list|)
expr_stmt|;
name|reply_len
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|send_reply
label|:
if|if
condition|(
name|reply_len
operator|<
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|reply
argument_list|,
literal|"FAIL\n"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|reply_len
operator|=
literal|5
expr_stmt|;
block|}
if|if
condition|(
name|sendto
argument_list|(
name|sock
argument_list|,
name|reply
argument_list|,
name|reply_len
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL: sendto failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|hostapd_global_ctrl_iface_path
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interface
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|interface
operator|->
name|global_iface_path
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|len
operator|=
name|os_strlen
argument_list|(
name|interface
operator|->
name|global_iface_path
argument_list|)
operator|+
name|os_strlen
argument_list|(
name|interface
operator|->
name|global_iface_name
argument_list|)
operator|+
literal|2
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|"%s/%s"
argument_list|,
name|interface
operator|->
name|global_iface_path
argument_list|,
name|interface
operator|->
name|global_iface_name
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|int
name|hostapd_global_ctrl_iface_init
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interface
parameter_list|)
block|{
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|int
name|s
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|fname
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|interface
operator|->
name|global_iface_path
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_iface not configured!"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|mkdir
argument_list|(
name|interface
operator|->
name|global_iface_path
argument_list|,
name|S_IRWXU
operator||
name|S_IRWXG
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|EEXIST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Using existing control "
literal|"interface directory."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"mkdir[ctrl_interface]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|interface
operator|->
name|ctrl_iface_group
operator|&&
name|chown
argument_list|(
name|interface
operator|->
name|global_iface_path
argument_list|,
operator|-
literal|1
argument_list|,
name|interface
operator|->
name|ctrl_iface_group
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"chown[ctrl_interface]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|os_strlen
argument_list|(
name|interface
operator|->
name|global_iface_path
argument_list|)
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|interface
operator|->
name|global_iface_name
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|s
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"socket(PF_UNIX): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__FreeBSD__
name|addr
operator|.
name|sun_len
operator|=
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __FreeBSD__ */
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|fname
operator|=
name|hostapd_global_ctrl_iface_path
argument_list|(
name|interface
argument_list|)
expr_stmt|;
if|if
condition|(
name|fname
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_strlcpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_iface bind(PF_UNIX) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|connect
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctrl_iface exists, but does not"
literal|" allow connections - assuming it was left"
literal|"over from forced program termination"
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlink
argument_list|(
name|fname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not unlink existing ctrl_iface socket '%s': %s"
argument_list|,
name|fname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"bind(PF_UNIX): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Successfully replaced leftover "
literal|"ctrl_iface socket '%s'"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ctrl_iface exists and seems to "
literal|"be in use - cannot override it"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Delete '%s' manually if it is "
literal|"not used anymore"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|fname
operator|=
name|NULL
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
name|interface
operator|->
name|ctrl_iface_group
operator|&&
name|chown
argument_list|(
name|fname
argument_list|,
operator|-
literal|1
argument_list|,
name|interface
operator|->
name|ctrl_iface_group
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"chown[ctrl_interface]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|chmod
argument_list|(
name|fname
argument_list|,
name|S_IRWXU
operator||
name|S_IRWXG
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"chmod[ctrl_interface/ifname]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|interface
operator|->
name|global_ctrl_sock
operator|=
name|s
expr_stmt|;
name|eloop_register_read_sock
argument_list|(
name|s
argument_list|,
name|hostapd_global_ctrl_iface_receive
argument_list|,
name|interface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
if|if
condition|(
name|s
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|fname
condition|)
block|{
name|unlink
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|hostapd_global_ctrl_iface_deinit
parameter_list|(
name|struct
name|hapd_interfaces
modifier|*
name|interfaces
parameter_list|)
block|{
name|char
modifier|*
name|fname
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ctrl_dst
modifier|*
name|dst
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|interfaces
operator|->
name|global_ctrl_sock
operator|>
operator|-
literal|1
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|interfaces
operator|->
name|global_ctrl_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|interfaces
operator|->
name|global_ctrl_sock
argument_list|)
expr_stmt|;
name|interfaces
operator|->
name|global_ctrl_sock
operator|=
operator|-
literal|1
expr_stmt|;
name|fname
operator|=
name|hostapd_global_ctrl_iface_path
argument_list|(
name|interfaces
argument_list|)
expr_stmt|;
if|if
condition|(
name|fname
condition|)
block|{
name|unlink
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|fname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|interfaces
operator|->
name|global_iface_path
operator|&&
name|rmdir
argument_list|(
name|interfaces
operator|->
name|global_iface_path
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|==
name|ENOTEMPTY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Control interface "
literal|"directory not empty - leaving it "
literal|"behind"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"rmdir[ctrl_interface=%s]: %s"
argument_list|,
name|interfaces
operator|->
name|global_iface_path
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|os_free
argument_list|(
name|interfaces
operator|->
name|global_iface_path
argument_list|)
expr_stmt|;
name|interfaces
operator|->
name|global_iface_path
operator|=
name|NULL
expr_stmt|;
name|dst
operator|=
name|interfaces
operator|->
name|global_ctrl_dst
expr_stmt|;
name|interfaces
operator|->
name|global_ctrl_dst
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|dst
condition|)
block|{
name|prev
operator|=
name|dst
expr_stmt|;
name|dst
operator|=
name|dst
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_ctrl_iface_send
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
name|level
parameter_list|,
name|enum
name|wpa_msg_type
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_ctrl_dst
modifier|*
name|dst
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|2
index|]
decl_stmt|;
name|char
name|levelstr
index|[
literal|10
index|]
decl_stmt|;
name|int
name|s
decl_stmt|;
if|if
condition|(
name|type
operator|!=
name|WPA_MSG_ONLY_GLOBAL
condition|)
block|{
name|s
operator|=
name|hapd
operator|->
name|ctrl_sock
expr_stmt|;
name|dst
operator|=
name|hapd
operator|->
name|ctrl_dst
expr_stmt|;
block|}
else|else
block|{
name|s
operator|=
name|hapd
operator|->
name|iface
operator|->
name|interfaces
operator|->
name|global_ctrl_sock
expr_stmt|;
name|dst
operator|=
name|hapd
operator|->
name|iface
operator|->
name|interfaces
operator|->
name|global_ctrl_dst
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|<
literal|0
operator|||
name|dst
operator|==
name|NULL
condition|)
return|return;
name|os_snprintf
argument_list|(
name|levelstr
argument_list|,
sizeof|sizeof
argument_list|(
name|levelstr
argument_list|)
argument_list|,
literal|"<%d>"
argument_list|,
name|level
argument_list|)
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
name|levelstr
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|os_strlen
argument_list|(
name|levelstr
argument_list|)
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|char
operator|*
operator|)
name|buf
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|2
expr_stmt|;
name|idx
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|dst
condition|)
block|{
name|next
operator|=
name|dst
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|level
operator|>=
name|dst
operator|->
name|debug_level
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE monitor send"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|dst
operator|->
name|addr
operator|.
name|sun_path
argument_list|,
name|dst
operator|->
name|addrlen
operator|-
name|offsetof
argument_list|(
expr|struct
name|sockaddr_un
argument_list|,
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|dst
operator|->
name|addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
name|dst
operator|->
name|addrlen
expr_stmt|;
if|if
condition|(
name|sendmsg
argument_list|(
name|s
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|int
name|_errno
init|=
name|errno
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CTRL_IFACE monitor[%d]: "
literal|"%d - %s"
argument_list|,
name|idx
argument_list|,
name|errno
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|->
name|errors
operator|++
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|errors
operator|>
literal|10
operator|||
name|_errno
operator|==
name|ENOENT
condition|)
block|{
if|if
condition|(
name|type
operator|!=
name|WPA_MSG_ONLY_GLOBAL
condition|)
name|hostapd_ctrl_iface_detach
argument_list|(
name|hapd
argument_list|,
operator|&
name|dst
operator|->
name|addr
argument_list|,
name|dst
operator|->
name|addrlen
argument_list|)
expr_stmt|;
else|else
name|hostapd_global_ctrl_iface_detach
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|interfaces
argument_list|,
operator|&
name|dst
operator|->
name|addr
argument_list|,
name|dst
operator|->
name|addrlen
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|dst
operator|->
name|errors
operator|=
literal|0
expr_stmt|;
block|}
name|idx
operator|++
expr_stmt|;
name|dst
operator|=
name|next
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

end_unit


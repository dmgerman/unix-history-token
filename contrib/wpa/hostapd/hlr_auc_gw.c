begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * HLR/AuC testing gateway for hostapd EAP-SIM/AKA database/authenticator  * Copyright (c) 2005-2007, 2012-2013, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  *  * This is an example implementation of the EAP-SIM/AKA database/authentication  * gateway interface to HLR/AuC. It is expected to be replaced with an  * implementation of SS7 gateway to GSM/UMTS authentication center (HLR/AuC) or  * a local implementation of SIM triplet and AKA authentication data generator.  *  * hostapd will send SIM/AKA authentication queries over a UNIX domain socket  * to and external program, e.g., this hlr_auc_gw. This interface uses simple  * text-based format:  *  * EAP-SIM / GSM triplet query/response:  * SIM-REQ-AUTH<IMSI><max_chal>  * SIM-RESP-AUTH<IMSI> Kc1:SRES1:RAND1 Kc2:SRES2:RAND2 [Kc3:SRES3:RAND3]  * SIM-RESP-AUTH<IMSI> FAILURE  * GSM-AUTH-REQ<IMSI> RAND1:RAND2[:RAND3]  * GSM-AUTH-RESP<IMSI> Kc1:SRES1:Kc2:SRES2[:Kc3:SRES3]  * GSM-AUTH-RESP<IMSI> FAILURE  *  * EAP-AKA / UMTS query/response:  * AKA-REQ-AUTH<IMSI>  * AKA-RESP-AUTH<IMSI><RAND><AUTN><IK><CK><RES>  * AKA-RESP-AUTH<IMSI> FAILURE  *  * EAP-AKA / UMTS AUTS (re-synchronization):  * AKA-AUTS<IMSI><AUTS><RAND>  *  * IMSI and max_chal are sent as an ASCII string,  * Kc/SRES/RAND/AUTN/IK/CK/RES/AUTS as hex strings.  *  * An example implementation here reads GSM authentication triplets from a  * text file in IMSI:Kc:SRES:RAND format, IMSI in ASCII, other fields as hex  * strings. This is used to simulate an HLR/AuC. As such, it is not very useful  * for real life authentication, but it is useful both as an example  * implementation and for EAP-SIM/AKA/AKA' testing.  *  * For a stronger example design, Milenage and GSM-Milenage algorithms can be  * used to dynamically generate authenticatipn information for EAP-AKA/AKA' and  * EAP-SIM, respectively, if Ki is known.  *  * SQN generation follows the not time-based Profile 2 described in  * 3GPP TS 33.102 Annex C.3.2. The length of IND is 5 bits by default, but this  * can be changed with a command line options if needed.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_SQLITE
end_ifdef

begin_include
include|#
directive|include
file|<sqlite3.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_SQLITE */
end_comment

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/milenage.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|default_socket_path
init|=
literal|"/tmp/hlr_auc_gw.sock"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|socket_path
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|serv_sock
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|milenage_file
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|update_milenage
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|sqn_changes
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|ind_len
init|=
literal|5
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|stdout_debug
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* GSM triplets */
end_comment

begin_struct
struct|struct
name|gsm_triplet
block|{
name|struct
name|gsm_triplet
modifier|*
name|next
decl_stmt|;
name|char
name|imsi
index|[
literal|20
index|]
decl_stmt|;
name|u8
name|kc
index|[
literal|8
index|]
decl_stmt|;
name|u8
name|sres
index|[
literal|4
index|]
decl_stmt|;
name|u8
name|_rand
index|[
literal|16
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|gsm_triplet
modifier|*
name|gsm_db
init|=
name|NULL
decl_stmt|,
modifier|*
name|gsm_db_pos
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* OPc and AMF parameters for Milenage (Example algorithms for AKA). */
end_comment

begin_struct
struct|struct
name|milenage_parameters
block|{
name|struct
name|milenage_parameters
modifier|*
name|next
decl_stmt|;
name|char
name|imsi
index|[
literal|20
index|]
decl_stmt|;
name|u8
name|ki
index|[
literal|16
index|]
decl_stmt|;
name|u8
name|opc
index|[
literal|16
index|]
decl_stmt|;
name|u8
name|amf
index|[
literal|2
index|]
decl_stmt|;
name|u8
name|sqn
index|[
literal|6
index|]
decl_stmt|;
name|int
name|set
decl_stmt|;
name|size_t
name|res_len
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|milenage_parameters
modifier|*
name|milenage_db
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|EAP_SIM_MAX_CHAL
value|3
end_define

begin_define
define|#
directive|define
name|EAP_AKA_RAND_LEN
value|16
end_define

begin_define
define|#
directive|define
name|EAP_AKA_AUTN_LEN
value|16
end_define

begin_define
define|#
directive|define
name|EAP_AKA_AUTS_LEN
value|14
end_define

begin_define
define|#
directive|define
name|EAP_AKA_RES_MIN_LEN
value|4
end_define

begin_define
define|#
directive|define
name|EAP_AKA_RES_MAX_LEN
value|16
end_define

begin_define
define|#
directive|define
name|EAP_AKA_IK_LEN
value|16
end_define

begin_define
define|#
directive|define
name|EAP_AKA_CK_LEN
value|16
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_SQLITE
end_ifdef

begin_decl_stmt
specifier|static
name|sqlite3
modifier|*
name|sqlite_db
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|milenage_parameters
name|db_tmp_milenage
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|db_table_exists
parameter_list|(
name|sqlite3
modifier|*
name|db
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|char
name|cmd
index|[
literal|128
index|]
decl_stmt|;
name|os_snprintf
argument_list|(
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|"SELECT 1 FROM %s;"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|sqlite3_exec
argument_list|(
name|db
argument_list|,
name|cmd
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|==
name|SQLITE_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|db_table_create_milenage
parameter_list|(
name|sqlite3
modifier|*
name|db
parameter_list|)
block|{
name|char
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|sql
init|=
literal|"CREATE TABLE milenage("
literal|"  imsi INTEGER PRIMARY KEY NOT NULL,"
literal|"  ki CHAR(32) NOT NULL,"
literal|"  opc CHAR(32) NOT NULL,"
literal|"  amf CHAR(4) NOT NULL,"
literal|"  sqn CHAR(12) NOT NULL,"
literal|"  res_len INTEGER"
literal|");"
decl_stmt|;
name|printf
argument_list|(
literal|"Adding database table for milenage information\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sqlite3_exec
argument_list|(
name|db
argument_list|,
name|sql
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|err
argument_list|)
operator|!=
name|SQLITE_OK
condition|)
block|{
name|printf
argument_list|(
literal|"SQLite error: %s\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|sqlite3_free
argument_list|(
name|err
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|sqlite3
modifier|*
name|db_open
parameter_list|(
specifier|const
name|char
modifier|*
name|db_file
parameter_list|)
block|{
name|sqlite3
modifier|*
name|db
decl_stmt|;
if|if
condition|(
name|sqlite3_open
argument_list|(
name|db_file
argument_list|,
operator|&
name|db
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to open database %s: %s\n"
argument_list|,
name|db_file
argument_list|,
name|sqlite3_errmsg
argument_list|(
name|db
argument_list|)
argument_list|)
expr_stmt|;
name|sqlite3_close
argument_list|(
name|db
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|db_table_exists
argument_list|(
name|db
argument_list|,
literal|"milenage"
argument_list|)
operator|&&
name|db_table_create_milenage
argument_list|(
name|db
argument_list|)
operator|<
literal|0
condition|)
block|{
name|sqlite3_close
argument_list|(
name|db
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|db
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_milenage_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|,
name|char
modifier|*
name|col
index|[]
parameter_list|)
block|{
name|struct
name|milenage_parameters
modifier|*
name|m
init|=
name|ctx
decl_stmt|;
name|int
name|i
decl_stmt|;
name|m
operator|->
name|set
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|col
index|[
name|i
index|]
argument_list|,
literal|"ki"
argument_list|)
operator|==
literal|0
operator|&&
name|argv
index|[
name|i
index|]
operator|&&
name|hexstr2bin
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|m
operator|->
name|ki
argument_list|,
sizeof|sizeof
argument_list|(
name|m
operator|->
name|ki
argument_list|)
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid ki value in database\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|col
index|[
name|i
index|]
argument_list|,
literal|"opc"
argument_list|)
operator|==
literal|0
operator|&&
name|argv
index|[
name|i
index|]
operator|&&
name|hexstr2bin
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|m
operator|->
name|opc
argument_list|,
sizeof|sizeof
argument_list|(
name|m
operator|->
name|opc
argument_list|)
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid opcvalue in database\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|col
index|[
name|i
index|]
argument_list|,
literal|"amf"
argument_list|)
operator|==
literal|0
operator|&&
name|argv
index|[
name|i
index|]
operator|&&
name|hexstr2bin
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|m
operator|->
name|amf
argument_list|,
sizeof|sizeof
argument_list|(
name|m
operator|->
name|amf
argument_list|)
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid amf value in database\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|col
index|[
name|i
index|]
argument_list|,
literal|"sqn"
argument_list|)
operator|==
literal|0
operator|&&
name|argv
index|[
name|i
index|]
operator|&&
name|hexstr2bin
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
name|m
operator|->
name|sqn
argument_list|,
sizeof|sizeof
argument_list|(
name|m
operator|->
name|sqn
argument_list|)
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid sqn value in database\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|col
index|[
name|i
index|]
argument_list|,
literal|"res_len"
argument_list|)
operator|==
literal|0
operator|&&
name|argv
index|[
name|i
index|]
condition|)
block|{
name|m
operator|->
name|res_len
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|milenage_parameters
modifier|*
name|db_get_milenage
parameter_list|(
specifier|const
name|char
modifier|*
name|imsi_txt
parameter_list|)
block|{
name|char
name|cmd
index|[
literal|128
index|]
decl_stmt|;
name|unsigned
name|long
name|long
name|imsi
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|db_tmp_milenage
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|db_tmp_milenage
argument_list|)
argument_list|)
expr_stmt|;
name|imsi
operator|=
name|atoll
argument_list|(
name|imsi_txt
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|db_tmp_milenage
operator|.
name|imsi
argument_list|,
sizeof|sizeof
argument_list|(
name|db_tmp_milenage
operator|.
name|imsi
argument_list|)
argument_list|,
literal|"%llu"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|"SELECT * FROM milenage WHERE imsi=%llu;"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sqlite3_exec
argument_list|(
name|sqlite_db
argument_list|,
name|cmd
argument_list|,
name|get_milenage_cb
argument_list|,
operator|&
name|db_tmp_milenage
argument_list|,
name|NULL
argument_list|)
operator|!=
name|SQLITE_OK
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|db_tmp_milenage
operator|.
name|set
condition|)
return|return
name|NULL
return|;
return|return
operator|&
name|db_tmp_milenage
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|db_update_milenage_sqn
parameter_list|(
name|struct
name|milenage_parameters
modifier|*
name|m
parameter_list|)
block|{
name|char
name|cmd
index|[
literal|128
index|]
decl_stmt|,
name|val
index|[
literal|13
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|sqlite_db
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|pos
operator|=
name|val
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|,
name|m
operator|->
name|sqn
argument_list|,
literal|6
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|os_snprintf
argument_list|(
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|"UPDATE milenage SET sqn='%s' WHERE imsi=%s;"
argument_list|,
name|val
argument_list|,
name|m
operator|->
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|sqlite3_exec
argument_list|(
name|sqlite_db
argument_list|,
name|cmd
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
name|SQLITE_OK
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to update SQN in database for IMSI %s\n"
argument_list|,
name|m
operator|->
name|imsi
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_SQLITE */
end_comment

begin_function
specifier|static
name|int
name|open_socket
parameter_list|(
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_UNIX)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_strlcpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"hlr-auc-gw: bind(PF_UNIX)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|s
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|read_gsm_triplets
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|struct
name|gsm_triplet
modifier|*
name|g
init|=
name|NULL
decl_stmt|;
name|int
name|line
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|fname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not open GSM tripler data file '%s'\n"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|line
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|line
operator|++
expr_stmt|;
comment|/* Parse IMSI:Kc:SRES:RAND */
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos
operator|!=
literal|'\n'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
continue|continue;
name|g
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|g
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|g
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
comment|/* IMSI */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid IMSI (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|g
operator|->
name|imsi
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Too long IMSI (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|os_strlcpy
argument_list|(
name|g
operator|->
name|imsi
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|g
operator|->
name|imsi
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* Kc */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid Kc (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|16
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|g
operator|->
name|kc
argument_list|,
literal|8
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid Kc (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* SRES */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid SRES (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|8
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|g
operator|->
name|sres
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid SRES (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* RAND */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
condition|)
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|32
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|g
operator|->
name|_rand
argument_list|,
literal|16
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid RAND (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
name|g
operator|->
name|next
operator|=
name|gsm_db
expr_stmt|;
name|gsm_db
operator|=
name|g
expr_stmt|;
name|g
operator|=
name|NULL
expr_stmt|;
block|}
name|os_free
argument_list|(
name|g
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|gsm_triplet
modifier|*
name|get_gsm_triplet
parameter_list|(
specifier|const
name|char
modifier|*
name|imsi
parameter_list|)
block|{
name|struct
name|gsm_triplet
modifier|*
name|g
init|=
name|gsm_db_pos
decl_stmt|;
while|while
condition|(
name|g
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|g
operator|->
name|imsi
argument_list|,
name|imsi
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gsm_db_pos
operator|=
name|g
operator|->
name|next
expr_stmt|;
return|return
name|g
return|;
block|}
name|g
operator|=
name|g
operator|->
name|next
expr_stmt|;
block|}
name|g
operator|=
name|gsm_db
expr_stmt|;
while|while
condition|(
name|g
operator|&&
name|g
operator|!=
name|gsm_db_pos
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|g
operator|->
name|imsi
argument_list|,
name|imsi
argument_list|)
operator|==
literal|0
condition|)
block|{
name|gsm_db_pos
operator|=
name|g
operator|->
name|next
expr_stmt|;
return|return
name|g
return|;
block|}
name|g
operator|=
name|g
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|read_milenage
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
init|=
name|NULL
decl_stmt|;
name|int
name|line
decl_stmt|,
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|fname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not open Milenage data file '%s'\n"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|line
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|line
operator|++
expr_stmt|;
comment|/* Parse IMSI Ki OPc AMF SQN [RES_len] */
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos
operator|!=
literal|'\n'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
condition|)
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
continue|continue;
name|m
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|m
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
comment|/* IMSI */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid IMSI (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|m
operator|->
name|imsi
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Too long IMSI (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|os_strlcpy
argument_list|(
name|m
operator|->
name|imsi
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|m
operator|->
name|imsi
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* Ki */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid Ki (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|32
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|m
operator|->
name|ki
argument_list|,
literal|16
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid Ki (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* OPc */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid OPc (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|32
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|m
operator|->
name|opc
argument_list|,
literal|16
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid OPc (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* AMF */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid AMF (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|4
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|m
operator|->
name|amf
argument_list|,
literal|2
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid AMF (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
comment|/* SQN */
name|pos2
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
condition|)
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|12
operator|||
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|m
operator|->
name|sqn
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid SEQ (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|pos2
condition|)
block|{
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
name|m
operator|->
name|res_len
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|res_len
operator|&&
operator|(
name|m
operator|->
name|res_len
operator|<
name|EAP_AKA_RES_MIN_LEN
operator|||
name|m
operator|->
name|res_len
operator|>
name|EAP_AKA_RES_MAX_LEN
operator|)
condition|)
block|{
name|printf
argument_list|(
literal|"%s:%d - Invalid RES_len (%s)\n"
argument_list|,
name|fname
argument_list|,
name|line
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|m
operator|->
name|next
operator|=
name|milenage_db
expr_stmt|;
name|milenage_db
operator|=
name|m
expr_stmt|;
name|m
operator|=
name|NULL
expr_stmt|;
block|}
name|os_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_milenage_file
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|,
modifier|*
name|f2
decl_stmt|;
name|char
name|name
index|[
literal|500
index|]
decl_stmt|,
name|buf
index|[
literal|500
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|char
modifier|*
name|end
init|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
decl_stmt|;
name|size_t
name|imsi_len
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not open Milenage data file '%s'\n"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return;
block|}
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s.new"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|f2
operator|=
name|fopen
argument_list|(
name|name
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f2
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not write Milenage data file '%s'\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
comment|/* IMSI Ki OPc AMF SQN */
name|buf
index|[
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
operator|||
name|pos
operator|==
name|NULL
operator|||
name|pos
operator|-
name|buf
operator|>=
literal|20
condition|)
goto|goto
name|no_update
goto|;
name|imsi_len
operator|=
name|pos
operator|-
name|buf
expr_stmt|;
for|for
control|(
name|m
operator|=
name|milenage_db
init|;
name|m
condition|;
name|m
operator|=
name|m
operator|->
name|next
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
name|m
operator|->
name|imsi
argument_list|,
name|imsi_len
argument_list|)
operator|==
literal|0
operator|&&
name|m
operator|->
name|imsi
index|[
name|imsi_len
index|]
operator|==
literal|'\0'
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|m
condition|)
goto|goto
name|no_update
goto|;
name|pos
operator|=
name|buf
expr_stmt|;
name|pos
operator|+=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"%s "
argument_list|,
name|m
operator|->
name|imsi
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|m
operator|->
name|ki
argument_list|,
literal|16
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|m
operator|->
name|opc
argument_list|,
literal|16
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|m
operator|->
name|amf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|m
operator|->
name|sqn
argument_list|,
literal|6
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|'\n'
expr_stmt|;
name|no_update
label|:
name|fprintf
argument_list|(
name|f2
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|f2
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s.bak"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
name|fname
argument_list|,
name|name
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"rename"
argument_list|)
expr_stmt|;
return|return;
block|}
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s.new"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
name|name
argument_list|,
name|fname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"rename"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|milenage_parameters
modifier|*
name|get_milenage
parameter_list|(
specifier|const
name|char
modifier|*
name|imsi
parameter_list|)
block|{
name|struct
name|milenage_parameters
modifier|*
name|m
init|=
name|milenage_db
decl_stmt|;
while|while
condition|(
name|m
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|m
operator|->
name|imsi
argument_list|,
name|imsi
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|m
operator|=
name|m
operator|->
name|next
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SQLITE
if|if
condition|(
operator|!
name|m
condition|)
name|m
operator|=
name|db_get_milenage
argument_list|(
name|imsi
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SQLITE */
return|return
name|m
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sim_req_auth
parameter_list|(
name|char
modifier|*
name|imsi
parameter_list|,
name|char
modifier|*
name|resp
parameter_list|,
name|size_t
name|resp_len
parameter_list|)
block|{
name|int
name|count
decl_stmt|,
name|max_chal
decl_stmt|,
name|ret
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|char
modifier|*
name|rpos
decl_stmt|,
modifier|*
name|rend
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
decl_stmt|;
name|struct
name|gsm_triplet
modifier|*
name|g
decl_stmt|;
name|resp
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|strchr
argument_list|(
name|imsi
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|max_chal
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|max_chal
operator|<
literal|1
operator|||
name|max_chal
operator|>
name|EAP_SIM_MAX_CHAL
condition|)
name|max_chal
operator|=
name|EAP_SIM_MAX_CHAL
expr_stmt|;
block|}
else|else
name|max_chal
operator|=
name|EAP_SIM_MAX_CHAL
expr_stmt|;
name|rend
operator|=
name|resp
operator|+
name|resp_len
expr_stmt|;
name|rpos
operator|=
name|resp
expr_stmt|;
name|ret
operator|=
name|snprintf
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
literal|"SIM-RESP-AUTH %s"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|rend
operator|-
name|rpos
condition|)
return|return
operator|-
literal|1
return|;
name|rpos
operator|+=
name|ret
expr_stmt|;
name|m
operator|=
name|get_milenage
argument_list|(
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
block|{
name|u8
name|_rand
index|[
literal|16
index|]
decl_stmt|,
name|sres
index|[
literal|4
index|]
decl_stmt|,
name|kc
index|[
literal|8
index|]
decl_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
name|max_chal
condition|;
name|count
operator|++
control|)
block|{
if|if
condition|(
name|random_get_bytes
argument_list|(
name|_rand
argument_list|,
literal|16
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|gsm_milenage
argument_list|(
name|m
operator|->
name|opc
argument_list|,
name|m
operator|->
name|ki
argument_list|,
name|_rand
argument_list|,
name|sres
argument_list|,
name|kc
argument_list|)
expr_stmt|;
operator|*
name|rpos
operator|++
operator|=
literal|' '
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|kc
argument_list|,
literal|8
argument_list|)
expr_stmt|;
operator|*
name|rpos
operator|++
operator|=
literal|':'
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|sres
argument_list|,
literal|4
argument_list|)
expr_stmt|;
operator|*
name|rpos
operator|++
operator|=
literal|':'
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|_rand
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
operator|*
name|rpos
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|0
return|;
block|}
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|count
operator|<
name|max_chal
operator|&&
operator|(
name|g
operator|=
name|get_gsm_triplet
argument_list|(
name|imsi
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|g
operator|->
name|imsi
argument_list|,
name|imsi
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|rpos
operator|<
name|rend
condition|)
operator|*
name|rpos
operator|++
operator|=
literal|' '
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|g
operator|->
name|kc
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpos
operator|<
name|rend
condition|)
operator|*
name|rpos
operator|++
operator|=
literal|':'
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|g
operator|->
name|sres
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|rpos
operator|<
name|rend
condition|)
operator|*
name|rpos
operator|++
operator|=
literal|':'
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|g
operator|->
name|_rand
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"No GSM triplets found for %s\n"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
name|ret
operator|=
name|snprintf
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
literal|" FAILURE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|rend
operator|-
name|rpos
condition|)
return|return
operator|-
literal|1
return|;
name|rpos
operator|+=
name|ret
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gsm_auth_req
parameter_list|(
name|char
modifier|*
name|imsi
parameter_list|,
name|char
modifier|*
name|resp
parameter_list|,
name|size_t
name|resp_len
parameter_list|)
block|{
name|int
name|count
decl_stmt|,
name|ret
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|rpos
decl_stmt|,
modifier|*
name|rend
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
decl_stmt|;
name|resp
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|imsi
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|rend
operator|=
name|resp
operator|+
name|resp_len
expr_stmt|;
name|rpos
operator|=
name|resp
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
literal|"GSM-AUTH-RESP %s"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|rend
operator|-
name|rpos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|rpos
operator|+=
name|ret
expr_stmt|;
name|m
operator|=
name|get_milenage
argument_list|(
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
block|{
name|u8
name|_rand
index|[
literal|16
index|]
decl_stmt|,
name|sres
index|[
literal|4
index|]
decl_stmt|,
name|kc
index|[
literal|8
index|]
decl_stmt|;
for|for
control|(
name|count
operator|=
literal|0
init|;
name|count
operator|<
name|EAP_SIM_MAX_CHAL
condition|;
name|count
operator|++
control|)
block|{
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|_rand
argument_list|,
literal|16
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|gsm_milenage
argument_list|(
name|m
operator|->
name|opc
argument_list|,
name|m
operator|->
name|ki
argument_list|,
name|_rand
argument_list|,
name|sres
argument_list|,
name|kc
argument_list|)
expr_stmt|;
operator|*
name|rpos
operator|++
operator|=
name|count
operator|==
literal|0
condition|?
literal|' '
else|:
literal|':'
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|kc
argument_list|,
literal|8
argument_list|)
expr_stmt|;
operator|*
name|rpos
operator|++
operator|=
literal|':'
expr_stmt|;
name|rpos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
name|sres
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|16
operator|*
literal|2
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
literal|':'
condition|)
break|break;
name|pos
operator|++
expr_stmt|;
block|}
operator|*
name|rpos
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|0
return|;
block|}
name|printf
argument_list|(
literal|"No GSM triplets found for %s\n"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|rpos
argument_list|,
name|rend
operator|-
name|rpos
argument_list|,
literal|" FAILURE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|rend
operator|-
name|rpos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|rpos
operator|+=
name|ret
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|inc_sqn
parameter_list|(
name|u8
modifier|*
name|sqn
parameter_list|)
block|{
name|u64
name|val
decl_stmt|,
name|seq
decl_stmt|,
name|ind
decl_stmt|;
comment|/* 	 * SQN = SEQ | IND = SEQ1 | SEQ2 | IND 	 * 	 * The mechanism used here is not time-based, so SEQ2 is void and 	 * SQN = SEQ1 | IND. The length of IND is ind_len bits and the length 	 * of SEQ1 is 48 - ind_len bits. 	 */
comment|/* Increment both SEQ and IND by one */
name|val
operator|=
operator|(
operator|(
name|u64
operator|)
name|WPA_GET_BE32
argument_list|(
name|sqn
argument_list|)
operator|<<
literal|16
operator|)
operator||
operator|(
operator|(
name|u64
operator|)
name|WPA_GET_BE16
argument_list|(
name|sqn
operator|+
literal|4
argument_list|)
operator|)
expr_stmt|;
name|seq
operator|=
operator|(
name|val
operator|>>
name|ind_len
operator|)
operator|+
literal|1
expr_stmt|;
name|ind
operator|=
operator|(
name|val
operator|+
literal|1
operator|)
operator|&
operator|(
operator|(
literal|1
operator|<<
name|ind_len
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|val
operator|=
operator|(
name|seq
operator|<<
name|ind_len
operator|)
operator||
name|ind
expr_stmt|;
name|WPA_PUT_BE32
argument_list|(
name|sqn
argument_list|,
name|val
operator|>>
literal|16
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|sqn
operator|+
literal|4
argument_list|,
name|val
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|aka_req_auth
parameter_list|(
name|char
modifier|*
name|imsi
parameter_list|,
name|char
modifier|*
name|resp
parameter_list|,
name|size_t
name|resp_len
parameter_list|)
block|{
comment|/* AKA-RESP-AUTH<IMSI><RAND><AUTN><IK><CK><RES> */
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|_rand
index|[
name|EAP_AKA_RAND_LEN
index|]
decl_stmt|;
name|u8
name|autn
index|[
name|EAP_AKA_AUTN_LEN
index|]
decl_stmt|;
name|u8
name|ik
index|[
name|EAP_AKA_IK_LEN
index|]
decl_stmt|;
name|u8
name|ck
index|[
name|EAP_AKA_CK_LEN
index|]
decl_stmt|;
name|u8
name|res
index|[
name|EAP_AKA_RES_MAX_LEN
index|]
decl_stmt|;
name|size_t
name|res_len
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
decl_stmt|;
name|int
name|failed
init|=
literal|0
decl_stmt|;
name|m
operator|=
name|get_milenage
argument_list|(
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
condition|)
block|{
if|if
condition|(
name|random_get_bytes
argument_list|(
name|_rand
argument_list|,
name|EAP_AKA_RAND_LEN
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|res_len
operator|=
name|EAP_AKA_RES_MAX_LEN
expr_stmt|;
name|inc_sqn
argument_list|(
name|m
operator|->
name|sqn
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_SQLITE
name|db_update_milenage_sqn
argument_list|(
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SQLITE */
name|sqn_changes
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|stdout_debug
condition|)
block|{
name|printf
argument_list|(
literal|"AKA: Milenage with SQN=%02x%02x%02x%02x%02x%02x\n"
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|0
index|]
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|1
index|]
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|2
index|]
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|3
index|]
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|4
index|]
argument_list|,
name|m
operator|->
name|sqn
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
name|milenage_generate
argument_list|(
name|m
operator|->
name|opc
argument_list|,
name|m
operator|->
name|amf
argument_list|,
name|m
operator|->
name|ki
argument_list|,
name|m
operator|->
name|sqn
argument_list|,
name|_rand
argument_list|,
name|autn
argument_list|,
name|ik
argument_list|,
name|ck
argument_list|,
name|res
argument_list|,
operator|&
name|res_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|res_len
operator|>=
name|EAP_AKA_RES_MIN_LEN
operator|&&
name|m
operator|->
name|res_len
operator|<=
name|EAP_AKA_RES_MAX_LEN
operator|&&
name|m
operator|->
name|res_len
operator|<
name|res_len
condition|)
name|res_len
operator|=
name|m
operator|->
name|res_len
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown IMSI: %s\n"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|AKA_USE_FIXED_TEST_VALUES
name|printf
argument_list|(
literal|"Using fixed test values for AKA\n"
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|_rand
argument_list|,
literal|'0'
argument_list|,
name|EAP_AKA_RAND_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|autn
argument_list|,
literal|'1'
argument_list|,
name|EAP_AKA_AUTN_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ik
argument_list|,
literal|'3'
argument_list|,
name|EAP_AKA_IK_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|ck
argument_list|,
literal|'4'
argument_list|,
name|EAP_AKA_CK_LEN
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|res
argument_list|,
literal|'2'
argument_list|,
name|EAP_AKA_RES_MAX_LEN
argument_list|)
expr_stmt|;
name|res_len
operator|=
name|EAP_AKA_RES_MAX_LEN
expr_stmt|;
else|#
directive|else
comment|/* AKA_USE_FIXED_TEST_VALUES */
name|failed
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* AKA_USE_FIXED_TEST_VALUES */
block|}
name|pos
operator|=
name|resp
expr_stmt|;
name|end
operator|=
name|resp
operator|+
name|resp_len
expr_stmt|;
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"AKA-RESP-AUTH %s "
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
if|if
condition|(
name|failed
condition|)
block|{
name|ret
operator|=
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"FAILURE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|_rand
argument_list|,
name|EAP_AKA_RAND_LEN
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|autn
argument_list|,
name|EAP_AKA_AUTN_LEN
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|ik
argument_list|,
name|EAP_AKA_IK_LEN
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|ck
argument_list|,
name|EAP_AKA_CK_LEN
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|' '
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|,
name|res_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|aka_auts
parameter_list|(
name|char
modifier|*
name|imsi
parameter_list|,
name|char
modifier|*
name|resp
parameter_list|,
name|size_t
name|resp_len
parameter_list|)
block|{
name|char
modifier|*
name|auts
decl_stmt|,
modifier|*
name|__rand
decl_stmt|;
name|u8
name|_auts
index|[
name|EAP_AKA_AUTS_LEN
index|]
decl_stmt|,
name|_rand
index|[
name|EAP_AKA_RAND_LEN
index|]
decl_stmt|,
name|sqn
index|[
literal|6
index|]
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
decl_stmt|;
name|resp
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* AKA-AUTS<IMSI><AUTS><RAND> */
name|auts
operator|=
name|strchr
argument_list|(
name|imsi
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|auts
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|auts
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|__rand
operator|=
name|strchr
argument_list|(
name|auts
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|__rand
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|__rand
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|stdout_debug
condition|)
block|{
name|printf
argument_list|(
literal|"AKA-AUTS: IMSI=%s AUTS=%s RAND=%s\n"
argument_list|,
name|imsi
argument_list|,
name|auts
argument_list|,
name|__rand
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hexstr2bin
argument_list|(
name|auts
argument_list|,
name|_auts
argument_list|,
name|EAP_AKA_AUTS_LEN
argument_list|)
operator|||
name|hexstr2bin
argument_list|(
name|__rand
argument_list|,
name|_rand
argument_list|,
name|EAP_AKA_RAND_LEN
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"Could not parse AUTS/RAND\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|m
operator|=
name|get_milenage
argument_list|(
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Unknown IMSI: %s\n"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|milenage_auts
argument_list|(
name|m
operator|->
name|opc
argument_list|,
name|m
operator|->
name|ki
argument_list|,
name|_rand
argument_list|,
name|_auts
argument_list|,
name|sqn
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"AKA-AUTS: Incorrect MAC-S\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|m
operator|->
name|sqn
argument_list|,
name|sqn
argument_list|,
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|stdout_debug
condition|)
block|{
name|printf
argument_list|(
literal|"AKA-AUTS: Re-synchronized: "
literal|"SQN=%02x%02x%02x%02x%02x%02x\n"
argument_list|,
name|sqn
index|[
literal|0
index|]
argument_list|,
name|sqn
index|[
literal|1
index|]
argument_list|,
name|sqn
index|[
literal|2
index|]
argument_list|,
name|sqn
index|[
literal|3
index|]
argument_list|,
name|sqn
index|[
literal|4
index|]
argument_list|,
name|sqn
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SQLITE
name|db_update_milenage_sqn
argument_list|(
name|m
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SQLITE */
name|sqn_changes
operator|=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_cmd
parameter_list|(
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|resp
parameter_list|,
name|size_t
name|resp_len
parameter_list|)
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|cmd
argument_list|,
literal|"SIM-REQ-AUTH "
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
return|return
name|sim_req_auth
argument_list|(
name|cmd
operator|+
literal|13
argument_list|,
name|resp
argument_list|,
name|resp_len
argument_list|)
return|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|cmd
argument_list|,
literal|"GSM-AUTH-REQ "
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
return|return
name|gsm_auth_req
argument_list|(
name|cmd
operator|+
literal|13
argument_list|,
name|resp
argument_list|,
name|resp_len
argument_list|)
return|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|cmd
argument_list|,
literal|"AKA-REQ-AUTH "
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
return|return
name|aka_req_auth
argument_list|(
name|cmd
operator|+
literal|13
argument_list|,
name|resp
argument_list|,
name|resp_len
argument_list|)
return|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|cmd
argument_list|,
literal|"AKA-AUTS "
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
return|return
name|aka_auts
argument_list|(
name|cmd
operator|+
literal|9
argument_list|,
name|resp
argument_list|,
name|resp_len
argument_list|)
return|;
name|printf
argument_list|(
literal|"Unknown request: %s\n"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|char
name|buf
index|[
literal|1000
index|]
decl_stmt|,
name|resp
index|[
literal|1000
index|]
decl_stmt|;
name|struct
name|sockaddr_un
name|from
decl_stmt|;
name|socklen_t
name|fromlen
decl_stmt|;
name|ssize_t
name|res
decl_stmt|;
name|fromlen
operator|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|res
operator|=
name|recvfrom
argument_list|(
name|s
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|res
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|res
operator|>=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
name|res
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
expr_stmt|;
name|buf
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|printf
argument_list|(
literal|"Received: %s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|process_cmd
argument_list|(
name|buf
argument_list|,
name|resp
argument_list|,
sizeof|sizeof
argument_list|(
name|resp
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Failed to process request\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|resp
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"No response\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|printf
argument_list|(
literal|"Send: %s\n"
argument_list|,
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendto
argument_list|(
name|s
argument_list|,
name|resp
argument_list|,
name|os_strlen
argument_list|(
name|resp
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
name|fromlen
argument_list|)
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"send"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|gsm_triplet
modifier|*
name|g
decl_stmt|,
modifier|*
name|gprev
decl_stmt|;
name|struct
name|milenage_parameters
modifier|*
name|m
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|update_milenage
operator|&&
name|milenage_file
operator|&&
name|sqn_changes
condition|)
name|update_milenage_file
argument_list|(
name|milenage_file
argument_list|)
expr_stmt|;
name|g
operator|=
name|gsm_db
expr_stmt|;
while|while
condition|(
name|g
condition|)
block|{
name|gprev
operator|=
name|g
expr_stmt|;
name|g
operator|=
name|g
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|gprev
argument_list|)
expr_stmt|;
block|}
name|m
operator|=
name|milenage_db
expr_stmt|;
while|while
condition|(
name|m
condition|)
block|{
name|prev
operator|=
name|m
expr_stmt|;
name|m
operator|=
name|m
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|serv_sock
operator|>=
literal|0
condition|)
name|close
argument_list|(
name|serv_sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|socket_path
condition|)
name|unlink
argument_list|(
name|socket_path
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_SQLITE
if|if
condition|(
name|sqlite_db
condition|)
block|{
name|sqlite3_close
argument_list|(
name|sqlite_db
argument_list|)
expr_stmt|;
name|sqlite_db
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_SQLITE */
block|}
end_function

begin_function
specifier|static
name|void
name|handle_term
parameter_list|(
name|int
name|sig
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Signal %d - terminate\n"
argument_list|,
name|sig
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"HLR/AuC testing gateway for hostapd EAP-SIM/AKA "
literal|"database/authenticator\n"
literal|"Copyright (c) 2005-2007, 2012-2013, Jouni Malinen<j@w1.fi>\n"
literal|"\n"
literal|"usage:\n"
literal|"hlr_auc_gw [-hu] [-s<socket path>] [-g<triplet file>] "
literal|"[-m<milenage file>] \\\n"
literal|"        [-D<DB file>] [-i<IND len in bits>] [command]\n"
literal|"\n"
literal|"options:\n"
literal|"  -h = show this usage help\n"
literal|"  -u = update SQN in Milenage file on exit\n"
literal|"  -s<socket path> = path for UNIX domain socket\n"
literal|"                    (default: %s)\n"
literal|"  -g<triplet file> = path for GSM authentication triplets\n"
literal|"  -m<milenage file> = path for Milenage keys\n"
literal|"  -D<DB file> = path to SQLite database\n"
literal|"  -i<IND len in bits> = IND length for SQN (default: 5)\n"
literal|"\n"
literal|"If the optional command argument, like "
literal|"\"AKA-REQ-AUTH<IMSI>\" is used, a single\n"
literal|"command is processed with response sent to stdout. Otherwise, "
literal|"hlr_auc_gw opens\n"
literal|"a control interface and processes commands sent through it "
literal|"(e.g., by EAP server\n"
literal|"in hostapd).\n"
argument_list|,
name|default_socket_path
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|c
decl_stmt|;
name|char
modifier|*
name|gsm_triplet_file
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|sqlite_db_file
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|os_program_init
argument_list|()
condition|)
return|return
operator|-
literal|1
return|;
name|socket_path
operator|=
name|default_socket_path
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"D:g:hi:m:s:u"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|0
condition|)
break|break;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'D'
case|:
ifdef|#
directive|ifdef
name|CONFIG_SQLITE
name|sqlite_db_file
operator|=
name|optarg
expr_stmt|;
break|break;
else|#
directive|else
comment|/* CONFIG_SQLITE */
name|printf
argument_list|(
literal|"No SQLite support included in the build\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_SQLITE */
case|case
literal|'g'
case|:
name|gsm_triplet_file
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|usage
argument_list|()
expr_stmt|;
return|return
literal|0
return|;
case|case
literal|'i'
case|:
name|ind_len
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ind_len
operator|<
literal|0
operator|||
name|ind_len
operator|>
literal|32
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid IND length\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
break|break;
case|case
literal|'m'
case|:
name|milenage_file
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|socket_path
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|update_milenage
operator|=
literal|1
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
operator|!
name|gsm_triplet_file
operator|&&
operator|!
name|milenage_file
operator|&&
operator|!
name|sqlite_db_file
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SQLITE
if|if
condition|(
name|sqlite_db_file
operator|&&
operator|(
name|sqlite_db
operator|=
name|db_open
argument_list|(
name|sqlite_db_file
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_SQLITE */
if|if
condition|(
name|gsm_triplet_file
operator|&&
name|read_gsm_triplets
argument_list|(
name|gsm_triplet_file
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|milenage_file
operator|&&
name|read_milenage
argument_list|(
name|milenage_file
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|optind
operator|==
name|argc
condition|)
block|{
name|serv_sock
operator|=
name|open_socket
argument_list|(
name|socket_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|serv_sock
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|printf
argument_list|(
literal|"Listening for requests on %s\n"
argument_list|,
name|socket_path
argument_list|)
expr_stmt|;
name|atexit
argument_list|(
name|cleanup
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGTERM
argument_list|,
name|handle_term
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|handle_term
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
name|process
argument_list|(
name|serv_sock
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
name|buf
index|[
literal|1000
index|]
decl_stmt|;
name|socket_path
operator|=
name|NULL
expr_stmt|;
name|stdout_debug
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|process_cmd
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"FAIL\n"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|cleanup
argument_list|()
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SQLITE
if|if
condition|(
name|sqlite_db
condition|)
block|{
name|sqlite3_close
argument_list|(
name|sqlite_db
argument_list|)
expr_stmt|;
name|sqlite_db
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_SQLITE */
name|os_program_deinit
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


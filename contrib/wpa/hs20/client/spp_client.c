begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Hotspot 2.0 SPP client  * Copyright (c) 2012-2014, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"browser.h"
end_include

begin_include
include|#
directive|include
file|"wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"wpa_helpers.h"
end_include

begin_include
include|#
directive|include
file|"xml-utils.h"
end_include

begin_include
include|#
directive|include
file|"http-utils.h"
end_include

begin_include
include|#
directive|include
file|"utils/base64.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"osu_client.h"
end_include

begin_decl_stmt
specifier|extern
specifier|const
name|char
modifier|*
name|spp_xsd_fname
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|int
name|hs20_spp_update_response
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|session_id
parameter_list|,
specifier|const
name|char
modifier|*
name|spp_status
parameter_list|,
specifier|const
name|char
modifier|*
name|error_code
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hs20_policy_update_complete
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|char
modifier|*
name|get_spp_attr_value
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|,
name|char
modifier|*
name|attr_name
parameter_list|)
block|{
return|return
name|xml_node_get_attr_value_ns
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|SPP_NS_URI
argument_list|,
name|attr_name
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hs20_spp_validate
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|expected_name
parameter_list|)
block|{
name|struct
name|xml_node_ctx
modifier|*
name|xctx
init|=
name|ctx
operator|->
name|xml
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|err
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|xml_node_is_element
argument_list|(
name|xctx
argument_list|,
name|node
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|xctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|strcmp
argument_list|(
name|expected_name
argument_list|,
name|name
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unexpected SOAP method name '%s' (expected '%s')"
argument_list|,
name|name
argument_list|,
name|expected_name
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Unexpected SOAP method name '%s' (expected '%s')"
argument_list|,
name|name
argument_list|,
name|expected_name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|xml_validate
argument_list|(
name|xctx
argument_list|,
name|node
argument_list|,
name|spp_xsd_fname
argument_list|,
operator|&
name|err
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"XML schema validation error(s)\n%s"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"SPP XML schema validation failed"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|err
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_mo_container
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_namespace_t
modifier|*
name|ns
parameter_list|,
name|xml_node_t
modifier|*
name|parent
parameter_list|,
specifier|const
name|char
modifier|*
name|urn
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|xml_node_t
modifier|*
name|fnode
decl_stmt|,
modifier|*
name|tnds
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|fnode
operator|=
name|node_from_file
argument_list|(
name|ctx
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fnode
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to create XML node from file: %s, possible error: %s"
argument_list|,
name|fname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|tnds
operator|=
name|mo_to_tnds
argument_list|(
name|ctx
argument_list|,
name|fnode
argument_list|,
literal|0
argument_list|,
name|urn
argument_list|,
literal|"syncml:dmddf1.2"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
argument_list|,
name|fnode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tnds
condition|)
return|return;
name|str
operator|=
name|xml_node_to_str
argument_list|(
name|ctx
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|node
operator|=
name|xml_node_create_text
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
name|ns
argument_list|,
literal|"moContainer"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
name|xml_node_add_attr
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|ns
argument_list|,
literal|"moURN"
argument_list|,
name|urn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|build_spp_post_dev_data
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_namespace_t
modifier|*
modifier|*
name|ret_ns
parameter_list|,
specifier|const
name|char
modifier|*
name|session_id
parameter_list|,
specifier|const
name|char
modifier|*
name|reason
parameter_list|)
block|{
name|xml_namespace_t
modifier|*
name|ns
decl_stmt|;
name|xml_node_t
modifier|*
name|spp_node
decl_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Building sppPostDevData requestReason='%s'"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|spp_node
operator|=
name|xml_node_create_root
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|SPP_NS_URI
argument_list|,
literal|"spp"
argument_list|,
operator|&
name|ns
argument_list|,
literal|"sppPostDevData"
argument_list|)
expr_stmt|;
if|if
condition|(
name|spp_node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ret_ns
condition|)
operator|*
name|ret_ns
operator|=
name|ns
expr_stmt|;
name|xml_node_add_attr
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spp_node
argument_list|,
name|ns
argument_list|,
literal|"sppVersion"
argument_list|,
literal|"1.0"
argument_list|)
expr_stmt|;
name|xml_node_add_attr
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spp_node
argument_list|,
name|NULL
argument_list|,
literal|"requestReason"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|session_id
condition|)
name|xml_node_add_attr
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spp_node
argument_list|,
name|ns
argument_list|,
literal|"sessionID"
argument_list|,
name|session_id
argument_list|)
expr_stmt|;
name|xml_node_add_attr
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spp_node
argument_list|,
name|NULL
argument_list|,
literal|"redirectURI"
argument_list|,
literal|"http://localhost:12345/"
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spp_node
argument_list|,
name|ns
argument_list|,
literal|"supportedSPPVersions"
argument_list|,
literal|"1.0"
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spp_node
argument_list|,
name|ns
argument_list|,
literal|"supportedMOList"
argument_list|,
name|URN_HS20_PPS
literal|" "
name|URN_OMA_DM_DEVINFO
literal|" "
name|URN_OMA_DM_DEVDETAIL
literal|" "
name|URN_HS20_DEVDETAIL_EXT
argument_list|)
expr_stmt|;
name|add_mo_container
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ns
argument_list|,
name|spp_node
argument_list|,
name|URN_OMA_DM_DEVINFO
argument_list|,
literal|"devinfo.xml"
argument_list|)
expr_stmt|;
name|add_mo_container
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ns
argument_list|,
name|spp_node
argument_list|,
name|URN_OMA_DM_DEVDETAIL
argument_list|,
literal|"devdetail.xml"
argument_list|)
expr_stmt|;
return|return
name|spp_node
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_update_node
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|,
name|xml_node_t
modifier|*
name|update
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|parent
decl_stmt|,
modifier|*
name|tnds
decl_stmt|,
modifier|*
name|unode
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|uri
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|char
modifier|*
name|cdata
decl_stmt|,
modifier|*
name|cdata_end
decl_stmt|;
name|size_t
name|fqdn_len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Processing updateNode"
argument_list|)
expr_stmt|;
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"updateNode"
argument_list|,
name|update
argument_list|)
expr_stmt|;
name|uri
operator|=
name|get_spp_attr_value
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|update
argument_list|,
literal|"managementTreeURI"
argument_list|)
expr_stmt|;
if|if
condition|(
name|uri
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No managementTreeURI present"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"managementTreeUri: '%s'"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|name
operator|=
name|os_strrchr
argument_list|(
name|uri
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unexpected URI"
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|name
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Update interior node: '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|str
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|update
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not extract MO text"
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"[hs20] nodeContainer text: '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|cdata
operator|=
name|strstr
argument_list|(
name|str
argument_list|,
literal|"<![CDATA["
argument_list|)
expr_stmt|;
name|cdata_end
operator|=
name|strstr
argument_list|(
name|str
argument_list|,
literal|"]]>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdata
operator|&&
name|cdata_end
operator|&&
name|cdata_end
operator|>
name|cdata
operator|&&
name|cdata
operator|<
name|strstr
argument_list|(
name|str
argument_list|,
literal|"MgmtTree"
argument_list|)
operator|&&
name|cdata_end
operator|>
name|strstr
argument_list|(
name|str
argument_list|,
literal|"/MgmtTree"
argument_list|)
condition|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"[hs20] Removing extra CDATA container"
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|strdup
argument_list|(
name|cdata
operator|+
literal|9
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
block|{
name|cdata_end
operator|=
name|strstr
argument_list|(
name|tmp
argument_list|,
literal|"]]>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cdata_end
condition|)
operator|*
name|cdata_end
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"[hs20] nodeContainer text with CDATA container removed: '%s'"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|tnds
operator|=
name|xml_node_from_buf
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
else|else
name|tnds
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|tnds
operator|=
name|xml_node_from_buf
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|tnds
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] Could not parse nodeContainer text"
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|unode
operator|=
name|tnds_to_mo
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
if|if
condition|(
name|unode
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] Could not parse nodeContainer TNDS text"
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"Parsed TNDS"
argument_list|,
name|unode
argument_list|)
expr_stmt|;
if|if
condition|(
name|get_node_uri
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|unode
argument_list|,
name|name
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] %s node not found"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|unode
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|uri
argument_list|,
literal|"./Wi-Fi/"
argument_list|,
literal|8
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow update outside ./Wi-Fi"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|unode
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|uri
operator|+
literal|8
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|fqdn
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"FQDN not known"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|unode
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fqdn_len
operator|=
name|os_strlen
argument_list|(
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|pos
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|,
name|fqdn_len
argument_list|)
operator|!=
literal|0
operator|||
name|pos
index|[
name|fqdn_len
index|]
operator|!=
literal|'/'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow update outside ./Wi-Fi/%s"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|unode
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
name|fqdn_len
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|pos
argument_list|,
literal|"PerProviderSubscription/"
argument_list|,
literal|24
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow update outside ./Wi-Fi/%s/PerProviderSubscription"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|unode
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|24
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Update command for PPS node %s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
name|parent
operator|=
name|xml_node_get_parent
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|xml_node_detach
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Replace '%s' node"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|pos2
decl_stmt|;
name|pos2
operator|=
name|os_strrchr
argument_list|(
name|pos
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
name|parent
operator|=
name|pps
expr_stmt|;
block|}
else|else
block|{
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
name|parent
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|parent
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not find parent %s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|unode
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Add '%s' node"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
name|xml_node_add_child
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|parent
argument_list|,
name|unode
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|update_pps
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|update
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Updating PPS based on updateNode element(s)"
argument_list|)
expr_stmt|;
name|xml_node_for_each_sibling
argument_list|(
argument|ctx->xml
argument_list|,
argument|update
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|update
argument_list|)
expr_stmt|;
if|if
condition|(
name|process_update_node
argument_list|(
name|ctx
argument_list|,
name|pps
argument_list|,
name|update
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
name|update_pps_file
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|,
name|pps
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hs20_sub_rem_complete
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
comment|/* 	 * Update wpa_supplicant credentials and reconnect using updated 	 * information. 	 */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Updating wpa_supplicant credentials"
argument_list|)
expr_stmt|;
name|cmd_set_pps
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|no_reconnect
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Requesting reconnection with updated configuration"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|"INTERWORKING_SELECT auto"
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|hs20_spp_upload_mo
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|cmd
parameter_list|,
specifier|const
name|char
modifier|*
name|session_id
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
name|xml_namespace_t
modifier|*
name|ns
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|ret_node
decl_stmt|;
name|char
modifier|*
name|urn
decl_stmt|;
name|urn
operator|=
name|get_spp_attr_value
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|cmd
argument_list|,
literal|"moURN"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|urn
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No URN included"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Upload MO request - URN=%s"
argument_list|,
name|urn
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|urn
argument_list|,
name|URN_HS20_PPS
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unsupported moURN"
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|urn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|urn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pps_fname
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PPS file name no known"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|node
operator|=
name|build_spp_post_dev_data
argument_list|(
name|ctx
argument_list|,
operator|&
name|ns
argument_list|,
name|session_id
argument_list|,
literal|"MO upload"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|add_mo_container
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ns
argument_list|,
name|node
argument_list|,
name|URN_HS20_PPS
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|ret_node
operator|=
name|soap_send_receive
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"Received response to MO upload"
argument_list|,
name|ret_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|hs20_spp_validate
argument_list|(
name|ctx
argument_list|,
name|ret_node
argument_list|,
literal|"sppPostDevDataResponse"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SPP validation failed"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ret_node
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ret_node
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hs20_add_mo
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|add_mo
parameter_list|,
name|char
modifier|*
name|fname
parameter_list|,
name|size_t
name|fname_len
parameter_list|)
block|{
name|char
modifier|*
name|uri
decl_stmt|,
modifier|*
name|urn
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"Received addMO"
argument_list|,
name|add_mo
argument_list|)
expr_stmt|;
name|urn
operator|=
name|get_spp_attr_value
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|add_mo
argument_list|,
literal|"moURN"
argument_list|)
expr_stmt|;
if|if
condition|(
name|urn
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] No moURN in addMO"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"addMO - moURN: '%s'"
argument_list|,
name|urn
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|urn
argument_list|,
name|URN_HS20_PPS
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] Unsupported MO in addMO"
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|urn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|urn
argument_list|)
expr_stmt|;
name|uri
operator|=
name|get_spp_attr_value
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|add_mo
argument_list|,
literal|"managementTreeURI"
argument_list|)
expr_stmt|;
if|if
condition|(
name|uri
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] No managementTreeURI in addMO"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"addMO - managementTreeURI: '%s'"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hs20_add_pps_mo
argument_list|(
name|ctx
argument_list|,
name|uri
argument_list|,
name|add_mo
argument_list|,
name|fname
argument_list|,
name|fname_len
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_spp_user_input_response
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|session_id
parameter_list|,
name|xml_node_t
modifier|*
name|add_mo
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|char
name|fname
index|[
literal|300
index|]
decl_stmt|;
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"addMO"
argument_list|,
name|add_mo
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Subscription registration completed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hs20_add_mo
argument_list|(
name|ctx
argument_list|,
name|add_mo
argument_list|,
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not add MO"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hs20_spp_update_response
argument_list|(
name|ctx
argument_list|,
name|session_id
argument_list|,
literal|"Error occurred"
argument_list|,
literal|"MO addition or update failed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ret
operator|=
name|hs20_spp_update_response
argument_list|(
name|ctx
argument_list|,
name|session_id
argument_list|,
literal|"OK"
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|hs20_sub_rem_complete
argument_list|(
name|ctx
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|hs20_spp_user_input_completed
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|session_id
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|ret_node
decl_stmt|;
name|node
operator|=
name|build_spp_post_dev_data
argument_list|(
name|ctx
argument_list|,
name|NULL
argument_list|,
name|session_id
argument_list|,
literal|"User input completed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret_node
operator|=
name|soap_send_receive
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret_node
condition|)
block|{
if|if
condition|(
name|soap_reinit_client
argument_list|(
name|ctx
operator|->
name|http
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Try to finish with re-opened connection"
argument_list|)
expr_stmt|;
name|node
operator|=
name|build_spp_post_dev_data
argument_list|(
name|ctx
argument_list|,
name|NULL
argument_list|,
name|session_id
argument_list|,
literal|"User input completed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret_node
operator|=
name|soap_send_receive
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Continue with new connection"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hs20_spp_validate
argument_list|(
name|ctx
argument_list|,
name|ret_node
argument_list|,
literal|"sppPostDevDataResponse"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SPP validation failed"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ret_node
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ret_node
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|hs20_spp_get_certificate
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|cmd
parameter_list|,
specifier|const
name|char
modifier|*
name|session_id
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
name|xml_namespace_t
modifier|*
name|ns
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|ret_node
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Client certificate enrollment"
argument_list|)
expr_stmt|;
name|res
operator|=
name|osu_get_certificate
argument_list|(
name|ctx
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EST simpleEnroll failed"
argument_list|)
expr_stmt|;
name|node
operator|=
name|build_spp_post_dev_data
argument_list|(
name|ctx
argument_list|,
operator|&
name|ns
argument_list|,
name|session_id
argument_list|,
name|res
operator|==
literal|0
condition|?
literal|"Certificate enrollment completed"
else|:
literal|"Certificate enrollment failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret_node
operator|=
name|soap_send_receive
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"Received response to certificate enrollment "
literal|"completed"
argument_list|,
name|ret_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|hs20_spp_validate
argument_list|(
name|ctx
argument_list|,
name|ret_node
argument_list|,
literal|"sppPostDevDataResponse"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SPP validation failed"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ret_node
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ret_node
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hs20_spp_exec
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|exec
parameter_list|,
specifier|const
name|char
modifier|*
name|session_id
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|,
name|xml_node_t
modifier|*
modifier|*
name|ret_node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|cmd
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|uri
decl_stmt|;
name|char
modifier|*
name|id
init|=
name|strdup
argument_list|(
name|session_id
argument_list|)
decl_stmt|;
if|if
condition|(
name|id
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|ret_node
operator|=
name|NULL
expr_stmt|;
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"exec"
argument_list|,
name|exec
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|cmd
argument_list|,
argument|exec
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|cmd
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"exec command element not found (cmd=%p)"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|id
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
literal|"launchBrowserToURI"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|res
decl_stmt|;
name|uri
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|uri
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No URI found"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|id
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Launch browser to URI '%s'"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Launch browser to URI '%s'"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|res
operator|=
name|hs20_web_browser
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"User response in browser completed successfully - sessionid='%s'"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"User response in browser completed successfully"
argument_list|)
expr_stmt|;
operator|*
name|ret_node
operator|=
name|hs20_spp_user_input_completed
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|id
argument_list|)
expr_stmt|;
return|return
operator|*
name|ret_node
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to receive user response"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Failed to receive user response"
argument_list|)
expr_stmt|;
name|hs20_spp_update_response
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
literal|"Error occurred"
argument_list|,
literal|"Other"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|id
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
literal|"uploadMO"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|pps_fname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|ret_node
operator|=
name|hs20_spp_upload_mo
argument_list|(
name|ctx
argument_list|,
name|cmd
argument_list|,
name|id
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|id
argument_list|)
expr_stmt|;
return|return
operator|*
name|ret_node
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
literal|"getCertificate"
argument_list|)
operator|==
literal|0
condition|)
block|{
operator|*
name|ret_node
operator|=
name|hs20_spp_get_certificate
argument_list|(
name|ctx
argument_list|,
name|cmd
argument_list|,
name|id
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|id
argument_list|)
expr_stmt|;
return|return
operator|*
name|ret_node
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unsupported exec command: '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|id
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_enum
enum|enum
name|spp_post_dev_data_use
block|{
name|SPP_SUBSCRIPTION_REMEDIATION
block|,
name|SPP_POLICY_UPDATE
block|,
name|SPP_SUBSCRIPTION_REGISTRATION
block|, }
enum|;
end_enum

begin_function
specifier|static
name|void
name|process_spp_post_dev_data_response
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|enum
name|spp_post_dev_data_use
name|use
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
name|char
modifier|*
name|status
init|=
name|NULL
decl_stmt|;
name|xml_node_t
modifier|*
name|update
init|=
name|NULL
decl_stmt|,
modifier|*
name|exec
init|=
name|NULL
decl_stmt|,
modifier|*
name|add_mo
init|=
name|NULL
decl_stmt|,
modifier|*
name|no_mo
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|session_id
init|=
name|NULL
decl_stmt|;
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"sppPostDevDataResponse node"
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|status
operator|=
name|get_spp_attr_value
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"sppStatus"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No sppStatus attribute"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Received sppPostDevDataResponse sppStatus='%s'"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|session_id
operator|=
name|get_spp_attr_value
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"sessionID"
argument_list|)
expr_stmt|;
if|if
condition|(
name|session_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No sessionID attribute"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] sppPostDevDataResponse - sppStatus: '%s'  sessionID: '%s'"
argument_list|,
name|status
argument_list|,
name|session_id
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"child"
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"localname: '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|update
operator|&&
name|strcasecmp
argument_list|(
name|name
argument_list|,
literal|"updateNode"
argument_list|)
operator|==
literal|0
condition|)
name|update
operator|=
name|child
expr_stmt|;
if|if
condition|(
operator|!
name|exec
operator|&&
name|strcasecmp
argument_list|(
name|name
argument_list|,
literal|"exec"
argument_list|)
operator|==
literal|0
condition|)
name|exec
operator|=
name|child
expr_stmt|;
if|if
condition|(
operator|!
name|add_mo
operator|&&
name|strcasecmp
argument_list|(
name|name
argument_list|,
literal|"addMO"
argument_list|)
operator|==
literal|0
condition|)
name|add_mo
operator|=
name|child
expr_stmt|;
if|if
condition|(
operator|!
name|no_mo
operator|&&
name|strcasecmp
argument_list|(
name|name
argument_list|,
literal|"noMOUpdate"
argument_list|)
operator|==
literal|0
condition|)
name|no_mo
operator|=
name|child
expr_stmt|;
block|}
if|if
condition|(
name|use
operator|==
name|SPP_SUBSCRIPTION_REMEDIATION
operator|&&
name|strcasecmp
argument_list|(
name|status
argument_list|,
literal|"Remediation complete, request sppUpdateResponse"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|res
decl_stmt|,
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|update
operator|&&
operator|!
name|no_mo
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No updateNode or noMOUpdate element"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Subscription remediation completed"
argument_list|)
expr_stmt|;
name|res
operator|=
name|update_pps
argument_list|(
name|ctx
argument_list|,
name|update
argument_list|,
name|pps_fname
argument_list|,
name|pps
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to update PPS MO"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hs20_spp_update_response
argument_list|(
name|ctx
argument_list|,
name|session_id
argument_list|,
name|res
operator|<
literal|0
condition|?
literal|"Error occurred"
else|:
literal|"OK"
argument_list|,
name|res
operator|<
literal|0
condition|?
literal|"MO addition or update failed"
else|:
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
operator|&&
name|ret
operator|==
literal|0
condition|)
name|hs20_sub_rem_complete
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|use
operator|==
name|SPP_SUBSCRIPTION_REMEDIATION
operator|&&
name|strcasecmp
argument_list|(
name|status
argument_list|,
literal|"Exchange complete, release TLS connection"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|no_mo
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No noMOUpdate element"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Subscription remediation completed (no MO update)"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|use
operator|==
name|SPP_POLICY_UPDATE
operator|&&
name|strcasecmp
argument_list|(
name|status
argument_list|,
literal|"Update complete, request sppUpdateResponse"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|res
decl_stmt|,
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Policy update received - update PPS"
argument_list|)
expr_stmt|;
name|res
operator|=
name|update_pps
argument_list|(
name|ctx
argument_list|,
name|update
argument_list|,
name|pps_fname
argument_list|,
name|pps
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hs20_spp_update_response
argument_list|(
name|ctx
argument_list|,
name|session_id
argument_list|,
name|res
operator|<
literal|0
condition|?
literal|"Error occurred"
else|:
literal|"OK"
argument_list|,
name|res
operator|<
literal|0
condition|?
literal|"MO addition or update failed"
else|:
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
operator|&&
name|ret
operator|==
literal|0
condition|)
name|hs20_policy_update_complete
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|use
operator|==
name|SPP_SUBSCRIPTION_REGISTRATION
operator|&&
name|strcasecmp
argument_list|(
name|status
argument_list|,
literal|"Provisioning complete, request "
literal|"sppUpdateResponse"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|add_mo
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No addMO element - not sure what to do next"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|process_spp_user_input_response
argument_list|(
name|ctx
argument_list|,
name|session_id
argument_list|,
name|add_mo
argument_list|)
expr_stmt|;
name|node
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|status
argument_list|,
literal|"No update available at this time"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No update available at this time"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|status
argument_list|,
literal|"OK"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|res
decl_stmt|;
name|xml_node_t
modifier|*
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|exec
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No exec element - not sure what to do next"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|res
operator|=
name|hs20_spp_exec
argument_list|(
name|ctx
argument_list|,
name|exec
argument_list|,
name|session_id
argument_list|,
name|pps_fname
argument_list|,
name|pps
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
comment|/* xml_node_free(ctx->xml, node); */
name|node
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
operator|&&
name|ret
condition|)
name|process_spp_post_dev_data_response
argument_list|(
name|ctx
argument_list|,
name|use
argument_list|,
name|ret
argument_list|,
name|pps_fname
argument_list|,
name|pps
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|strcasecmp
argument_list|(
name|status
argument_list|,
literal|"Error occurred"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|xml_node_t
modifier|*
name|err
decl_stmt|;
name|char
modifier|*
name|code
init|=
name|NULL
decl_stmt|;
name|err
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"sppError"
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
name|code
operator|=
name|xml_node_get_attr_value
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|err
argument_list|,
literal|"errorCode"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Error occurred - errorCode=%s"
argument_list|,
name|code
condition|?
name|code
else|:
literal|"N/A"
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|code
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] Unsupported sppPostDevDataResponse sppStatus '%s'"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|out
label|:
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|session_id
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|spp_post_dev_data
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|enum
name|spp_post_dev_data_use
name|use
parameter_list|,
specifier|const
name|char
modifier|*
name|reason
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|payload
decl_stmt|;
name|xml_node_t
modifier|*
name|ret_node
decl_stmt|;
name|payload
operator|=
name|build_spp_post_dev_data
argument_list|(
name|ctx
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|payload
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ret_node
operator|=
name|soap_send_receive
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|payload
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret_node
condition|)
block|{
specifier|const
name|char
modifier|*
name|err
init|=
name|http_get_err
argument_list|(
name|ctx
operator|->
name|http
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"HTTP error: %s"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"HTTP error: %s"
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Failed to send SOAP message"
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hs20_spp_validate
argument_list|(
name|ctx
argument_list|,
name|ret_node
argument_list|,
literal|"sppPostDevDataResponse"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SPP validation failed"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ret_node
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|process_spp_post_dev_data_response
argument_list|(
name|ctx
argument_list|,
name|use
argument_list|,
name|ret_node
argument_list|,
name|pps_fname
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|spp_sub_rem
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|address
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|char
modifier|*
name|client_key
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_username
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_password
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SPP subscription remediation"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"SPP subscription remediation"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|server_url
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|server_url
operator|=
name|os_strdup
argument_list|(
name|address
argument_list|)
expr_stmt|;
if|if
condition|(
name|soap_init_client
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|address
argument_list|,
name|ctx
operator|->
name|ca_fname
argument_list|,
name|cred_username
argument_list|,
name|cred_password
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|)
operator|==
literal|0
condition|)
block|{
name|spp_post_dev_data
argument_list|(
name|ctx
argument_list|,
name|SPP_SUBSCRIPTION_REMEDIATION
argument_list|,
literal|"Subscription remediation"
argument_list|,
name|pps_fname
argument_list|,
name|pps
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hs20_policy_update_complete
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Policy update completed"
argument_list|)
expr_stmt|;
comment|/* 	 * Update wpa_supplicant credentials and reconnect using updated 	 * information. 	 */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Updating wpa_supplicant credentials"
argument_list|)
expr_stmt|;
name|cmd_set_pps
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Requesting reconnection with updated configuration"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|"INTERWORKING_SELECT auto"
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_spp_exchange_complete
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|status
decl_stmt|,
modifier|*
name|session_id
decl_stmt|;
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"sppExchangeComplete"
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|status
operator|=
name|get_spp_attr_value
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"sppStatus"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No sppStatus attribute"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Received sppExchangeComplete sppStatus='%s'"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|session_id
operator|=
name|get_spp_attr_value
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"sessionID"
argument_list|)
expr_stmt|;
if|if
condition|(
name|session_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No sessionID attribute"
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] sppStatus: '%s'  sessionID: '%s'"
argument_list|,
name|status
argument_list|,
name|session_id
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|session_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|status
argument_list|,
literal|"Exchange complete, release TLS connection"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unexpected sppStatus '%s'"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Unexpected sppStatus '%s'"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|build_spp_update_response
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|session_id
parameter_list|,
specifier|const
name|char
modifier|*
name|spp_status
parameter_list|,
specifier|const
name|char
modifier|*
name|error_code
parameter_list|)
block|{
name|xml_namespace_t
modifier|*
name|ns
decl_stmt|;
name|xml_node_t
modifier|*
name|spp_node
decl_stmt|,
modifier|*
name|node
decl_stmt|;
name|spp_node
operator|=
name|xml_node_create_root
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|SPP_NS_URI
argument_list|,
literal|"spp"
argument_list|,
operator|&
name|ns
argument_list|,
literal|"sppUpdateResponse"
argument_list|)
expr_stmt|;
if|if
condition|(
name|spp_node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|xml_node_add_attr
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spp_node
argument_list|,
name|ns
argument_list|,
literal|"sppVersion"
argument_list|,
literal|"1.0"
argument_list|)
expr_stmt|;
name|xml_node_add_attr
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spp_node
argument_list|,
name|ns
argument_list|,
literal|"sessionID"
argument_list|,
name|session_id
argument_list|)
expr_stmt|;
name|xml_node_add_attr
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spp_node
argument_list|,
name|ns
argument_list|,
literal|"sppStatus"
argument_list|,
name|spp_status
argument_list|)
expr_stmt|;
if|if
condition|(
name|error_code
condition|)
block|{
name|node
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spp_node
argument_list|,
name|ns
argument_list|,
literal|"sppError"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
name|xml_node_add_attr
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"errorCode"
argument_list|,
name|error_code
argument_list|)
expr_stmt|;
block|}
return|return
name|spp_node
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hs20_spp_update_response
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|session_id
parameter_list|,
specifier|const
name|char
modifier|*
name|spp_status
parameter_list|,
specifier|const
name|char
modifier|*
name|error_code
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|ret_node
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Building sppUpdateResponse sppStatus='%s' error_code='%s'"
argument_list|,
name|spp_status
argument_list|,
name|error_code
argument_list|)
expr_stmt|;
name|node
operator|=
name|build_spp_update_response
argument_list|(
name|ctx
argument_list|,
name|session_id
argument_list|,
name|spp_status
argument_list|,
name|error_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ret_node
operator|=
name|soap_send_receive
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret_node
condition|)
block|{
if|if
condition|(
name|soap_reinit_client
argument_list|(
name|ctx
operator|->
name|http
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Try to finish with re-opened connection"
argument_list|)
expr_stmt|;
name|node
operator|=
name|build_spp_update_response
argument_list|(
name|ctx
argument_list|,
name|session_id
argument_list|,
name|spp_status
argument_list|,
name|error_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ret_node
operator|=
name|soap_send_receive
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret_node
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Continue with new connection"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hs20_spp_validate
argument_list|(
name|ctx
argument_list|,
name|ret_node
argument_list|,
literal|"sppExchangeComplete"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SPP validation failed"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ret_node
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|process_spp_exchange_complete
argument_list|(
name|ctx
argument_list|,
name|ret_node
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ret_node
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|spp_pol_upd
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|address
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|char
modifier|*
name|client_key
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_username
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_password
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SPP policy update"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"SPP policy update"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|server_url
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|server_url
operator|=
name|os_strdup
argument_list|(
name|address
argument_list|)
expr_stmt|;
if|if
condition|(
name|soap_init_client
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|address
argument_list|,
name|ctx
operator|->
name|ca_fname
argument_list|,
name|cred_username
argument_list|,
name|cred_password
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|)
operator|==
literal|0
condition|)
block|{
name|spp_post_dev_data
argument_list|(
name|ctx
argument_list|,
name|SPP_POLICY_UPDATE
argument_list|,
literal|"Policy update"
argument_list|,
name|pps_fname
argument_list|,
name|pps
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|cmd_prov
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|)
block|{
name|unlink
argument_list|(
literal|"Cert/est_cert.der"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
literal|"Cert/est_cert.pem"
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid prov command (missing URL)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Credential provisioning requested - URL: %s ca_fname: %s"
argument_list|,
name|url
argument_list|,
name|ctx
operator|->
name|ca_fname
condition|?
name|ctx
operator|->
name|ca_fname
else|:
literal|"N/A"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|server_url
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|server_url
operator|=
name|os_strdup
argument_list|(
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
name|soap_init_client
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|url
argument_list|,
name|ctx
operator|->
name|ca_fname
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|spp_post_dev_data
argument_list|(
name|ctx
argument_list|,
name|SPP_SUBSCRIPTION_REGISTRATION
argument_list|,
literal|"Subscription registration"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|ctx
operator|->
name|pps_cred_set
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cmd_sim_prov
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|)
block|{
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid prov command (missing URL)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SIM provisioning requested"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|server_url
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|server_url
operator|=
name|os_strdup
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Wait for IP address before starting SIM provisioning"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait_ip_addr
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|15
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get IP address for WLAN - try connection anyway"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|soap_init_client
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|url
argument_list|,
name|ctx
operator|->
name|ca_fname
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|spp_post_dev_data
argument_list|(
name|ctx
argument_list|,
name|SPP_SUBSCRIPTION_REGISTRATION
argument_list|,
literal|"Subscription provisioning"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|ctx
operator|->
name|pps_cred_set
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

end_unit


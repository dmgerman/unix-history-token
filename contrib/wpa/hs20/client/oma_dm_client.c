begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Hotspot 2.0 - OMA DM client  * Copyright (c) 2013-2014, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"wpa_helpers.h"
end_include

begin_include
include|#
directive|include
file|"xml-utils.h"
end_include

begin_include
include|#
directive|include
file|"http-utils.h"
end_include

begin_include
include|#
directive|include
file|"utils/browser.h"
end_include

begin_include
include|#
directive|include
file|"osu_client.h"
end_include

begin_define
define|#
directive|define
name|DM_SERVER_INITIATED_MGMT
value|1200
end_define

begin_define
define|#
directive|define
name|DM_CLIENT_INITIATED_MGMT
value|1201
end_define

begin_define
define|#
directive|define
name|DM_GENERIC_ALERT
value|1226
end_define

begin_comment
comment|/* OMA-TS-SyncML-RepPro-V1_2_2 - 10. Response Status Codes */
end_comment

begin_define
define|#
directive|define
name|DM_RESP_OK
value|200
end_define

begin_define
define|#
directive|define
name|DM_RESP_AUTH_ACCEPTED
value|212
end_define

begin_define
define|#
directive|define
name|DM_RESP_CHUNKED_ITEM_ACCEPTED
value|213
end_define

begin_define
define|#
directive|define
name|DM_RESP_NOT_EXECUTED
value|215
end_define

begin_define
define|#
directive|define
name|DM_RESP_ATOMIC_ROLL_BACK_OK
value|216
end_define

begin_define
define|#
directive|define
name|DM_RESP_NOT_MODIFIED
value|304
end_define

begin_define
define|#
directive|define
name|DM_RESP_BAD_REQUEST
value|400
end_define

begin_define
define|#
directive|define
name|DM_RESP_UNAUTHORIZED
value|401
end_define

begin_define
define|#
directive|define
name|DM_RESP_FORBIDDEN
value|403
end_define

begin_define
define|#
directive|define
name|DM_RESP_NOT_FOUND
value|404
end_define

begin_define
define|#
directive|define
name|DM_RESP_COMMAND_NOT_ALLOWED
value|405
end_define

begin_define
define|#
directive|define
name|DM_RESP_OPTIONAL_FEATURE_NOT_SUPPORTED
value|406
end_define

begin_define
define|#
directive|define
name|DM_RESP_MISSING_CREDENTIALS
value|407
end_define

begin_define
define|#
directive|define
name|DM_RESP_CONFLICT
value|409
end_define

begin_define
define|#
directive|define
name|DM_RESP_GONE
value|410
end_define

begin_define
define|#
directive|define
name|DM_RESP_INCOMPLETE_COMMAND
value|412
end_define

begin_define
define|#
directive|define
name|DM_RESP_REQ_ENTITY_TOO_LARGE
value|413
end_define

begin_define
define|#
directive|define
name|DM_RESP_URI_TOO_LONG
value|414
end_define

begin_define
define|#
directive|define
name|DM_RESP_UNSUPPORTED_MEDIA_TYPE_OR_FORMAT
value|415
end_define

begin_define
define|#
directive|define
name|DM_RESP_REQ_TOO_BIG
value|416
end_define

begin_define
define|#
directive|define
name|DM_RESP_ALREADY_EXISTS
value|418
end_define

begin_define
define|#
directive|define
name|DM_RESP_DEVICE_FULL
value|420
end_define

begin_define
define|#
directive|define
name|DM_RESP_SIZE_MISMATCH
value|424
end_define

begin_define
define|#
directive|define
name|DM_RESP_PERMISSION_DENIED
value|425
end_define

begin_define
define|#
directive|define
name|DM_RESP_COMMAND_FAILED
value|500
end_define

begin_define
define|#
directive|define
name|DM_RESP_COMMAND_NOT_IMPLEMENTED
value|501
end_define

begin_define
define|#
directive|define
name|DM_RESP_ATOMIC_ROLL_BACK_FAILED
value|516
end_define

begin_define
define|#
directive|define
name|DM_HS20_SUBSCRIPTION_CREATION
define|\
value|"org.wi-fi.hotspot2dot0.SubscriptionCreation"
end_define

begin_define
define|#
directive|define
name|DM_HS20_SUBSCRIPTION_PROVISIONING
define|\
value|"org.wi-fi.hotspot2dot0.SubscriptionProvisioning"
end_define

begin_define
define|#
directive|define
name|DM_HS20_SUBSCRIPTION_REMEDIATION
define|\
value|"org.wi-fi.hotspot2dot0.SubscriptionRemediation"
end_define

begin_define
define|#
directive|define
name|DM_HS20_POLICY_UPDATE
define|\
value|"org.wi-fi.hotspot2dot0.PolicyUpdate"
end_define

begin_define
define|#
directive|define
name|DM_URI_PPS
value|"./Wi-Fi/org.wi-fi/PerProviderSubscription"
end_define

begin_define
define|#
directive|define
name|DM_URI_LAUNCH_BROWSER
define|\
value|"./DevDetail/Ext/org.wi-fi/Wi-Fi/Ops/launchBrowserToURI"
end_define

begin_function_decl
specifier|static
name|void
name|add_item
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|parent
parameter_list|,
specifier|const
name|char
modifier|*
name|locuri
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|int2str
parameter_list|(
name|int
name|val
parameter_list|)
block|{
specifier|static
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|oma_dm_get_target_locuri
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|locuri
decl_stmt|;
name|char
modifier|*
name|uri
decl_stmt|,
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|locuri
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"Item/Target/LocURI"
argument_list|)
expr_stmt|;
if|if
condition|(
name|locuri
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|uri
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
if|if
condition|(
name|uri
condition|)
name|ret
operator|=
name|os_strdup
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oma_dm_add_locuri
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|parent
parameter_list|,
specifier|const
name|char
modifier|*
name|element
parameter_list|,
specifier|const
name|char
modifier|*
name|uri
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|node
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|parent
argument_list|,
name|NULL
argument_list|,
name|element
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"LocURI"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|oma_dm_build_hdr
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|int
name|msgid
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|,
modifier|*
name|synchdr
decl_stmt|;
name|xml_namespace_t
modifier|*
name|ns
decl_stmt|;
name|syncml
operator|=
name|xml_node_create_root
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
literal|"SYNCML:SYNCML1.2"
argument_list|,
name|NULL
argument_list|,
operator|&
name|ns
argument_list|,
literal|"SyncML"
argument_list|)
expr_stmt|;
name|synchdr
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncml
argument_list|,
name|NULL
argument_list|,
literal|"SyncHdr"
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|synchdr
argument_list|,
name|NULL
argument_list|,
literal|"VerDTD"
argument_list|,
literal|"1.2"
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|synchdr
argument_list|,
name|NULL
argument_list|,
literal|"VerProto"
argument_list|,
literal|"DM/1.2"
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|synchdr
argument_list|,
name|NULL
argument_list|,
literal|"SessionID"
argument_list|,
literal|"1"
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|synchdr
argument_list|,
name|NULL
argument_list|,
literal|"MsgID"
argument_list|,
name|int2str
argument_list|(
name|msgid
argument_list|)
argument_list|)
expr_stmt|;
name|oma_dm_add_locuri
argument_list|(
name|ctx
argument_list|,
name|synchdr
argument_list|,
literal|"Target"
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|oma_dm_add_locuri
argument_list|(
name|ctx
argument_list|,
name|synchdr
argument_list|,
literal|"Source"
argument_list|,
name|ctx
operator|->
name|devid
argument_list|)
expr_stmt|;
return|return
name|syncml
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|oma_dm_add_cmdid
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|parent
parameter_list|,
name|int
name|cmdid
parameter_list|)
block|{
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|parent
argument_list|,
name|NULL
argument_list|,
literal|"CmdID"
argument_list|,
name|int2str
argument_list|(
name|cmdid
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|add_alert
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|parent
parameter_list|,
name|int
name|cmdid
parameter_list|,
name|int
name|data
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|node
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|parent
argument_list|,
name|NULL
argument_list|,
literal|"Alert"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|oma_dm_add_cmdid
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|cmdid
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"Data"
argument_list|,
name|int2str
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|node
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|add_status
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|parent
parameter_list|,
name|int
name|msgref
parameter_list|,
name|int
name|cmdref
parameter_list|,
name|int
name|cmdid
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|,
name|int
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|targetref
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|node
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|parent
argument_list|,
name|NULL
argument_list|,
literal|"Status"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|oma_dm_add_cmdid
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|cmdid
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"MsgRef"
argument_list|,
name|int2str
argument_list|(
name|msgref
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmdref
condition|)
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"CmdRef"
argument_list|,
name|int2str
argument_list|(
name|cmdref
argument_list|)
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"Cmd"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"Data"
argument_list|,
name|int2str
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|targetref
condition|)
block|{
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"TargetRef"
argument_list|,
name|targetref
argument_list|)
expr_stmt|;
block|}
return|return
name|node
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|add_results
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|parent
parameter_list|,
name|int
name|msgref
parameter_list|,
name|int
name|cmdref
parameter_list|,
name|int
name|cmdid
parameter_list|,
specifier|const
name|char
modifier|*
name|locuri
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|node
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|parent
argument_list|,
name|NULL
argument_list|,
literal|"Results"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|oma_dm_add_cmdid
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|cmdid
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"MsgRef"
argument_list|,
name|int2str
argument_list|(
name|msgref
argument_list|)
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"CmdRef"
argument_list|,
name|int2str
argument_list|(
name|cmdref
argument_list|)
argument_list|)
expr_stmt|;
name|add_item
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|locuri
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|node
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|mo_str
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|urn
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|fnode
decl_stmt|,
modifier|*
name|tnds
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|fnode
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fnode
condition|)
return|return
name|NULL
return|;
name|tnds
operator|=
name|mo_to_tnds
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|fnode
argument_list|,
literal|0
argument_list|,
name|urn
argument_list|,
literal|"syncml:dmddf1.2"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|fnode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tnds
condition|)
return|return
name|NULL
return|;
name|str
operator|=
name|xml_node_to_str
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"MgmtTree: %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
name|str
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_item
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|parent
parameter_list|,
specifier|const
name|char
modifier|*
name|locuri
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|item
decl_stmt|,
modifier|*
name|node
decl_stmt|;
name|item
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|parent
argument_list|,
name|NULL
argument_list|,
literal|"Item"
argument_list|)
expr_stmt|;
name|oma_dm_add_locuri
argument_list|(
name|ctx
argument_list|,
name|item
argument_list|,
literal|"Source"
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
name|node
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|item
argument_list|,
name|NULL
argument_list|,
literal|"Meta"
argument_list|)
expr_stmt|;
name|xml_node_create_text_ns
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"syncml:metinf"
argument_list|,
literal|"Format"
argument_list|,
literal|"Chr"
argument_list|)
expr_stmt|;
name|xml_node_create_text_ns
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"syncml:metinf"
argument_list|,
literal|"Type"
argument_list|,
literal|"text/plain"
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|item
argument_list|,
name|NULL
argument_list|,
literal|"Data"
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_replace_devinfo
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|parent
parameter_list|,
name|int
name|cmdid
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|info
decl_stmt|,
modifier|*
name|child
decl_stmt|,
modifier|*
name|replace
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
name|locuri
index|[
literal|200
index|]
decl_stmt|,
modifier|*
name|txt
decl_stmt|;
name|info
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
literal|"devinfo.xml"
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not read devinfo.xml"
argument_list|)
expr_stmt|;
return|return;
block|}
name|replace
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|parent
argument_list|,
name|NULL
argument_list|,
literal|"Replace"
argument_list|)
expr_stmt|;
if|if
condition|(
name|replace
operator|==
name|NULL
condition|)
block|{
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|info
argument_list|)
expr_stmt|;
return|return;
block|}
name|oma_dm_add_cmdid
argument_list|(
name|ctx
argument_list|,
name|replace
argument_list|,
name|cmdid
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|info
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|locuri
argument_list|,
sizeof|sizeof
argument_list|(
name|locuri
argument_list|)
argument_list|,
literal|"./DevInfo/%s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|txt
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|txt
condition|)
block|{
name|add_item
argument_list|(
name|ctx
argument_list|,
name|replace
argument_list|,
name|locuri
argument_list|,
name|txt
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
block|}
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|oma_dm_add_hs20_generic_alert
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|syncbody
parameter_list|,
name|int
name|cmdid
parameter_list|,
specifier|const
name|char
modifier|*
name|oper
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|item
decl_stmt|;
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|;
name|node
operator|=
name|add_alert
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|cmdid
argument_list|,
name|DM_GENERIC_ALERT
argument_list|)
expr_stmt|;
name|item
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"Item"
argument_list|)
expr_stmt|;
name|oma_dm_add_locuri
argument_list|(
name|ctx
argument_list|,
name|item
argument_list|,
literal|"Source"
argument_list|,
name|DM_URI_PPS
argument_list|)
expr_stmt|;
name|node
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|item
argument_list|,
name|NULL
argument_list|,
literal|"Meta"
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"Reversed-Domain-Name: %s"
argument_list|,
name|oper
argument_list|)
expr_stmt|;
name|xml_node_create_text_ns
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"syncml:metinf"
argument_list|,
literal|"Type"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|xml_node_create_text_ns
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"syncml:metinf"
argument_list|,
literal|"Format"
argument_list|,
literal|"xml"
argument_list|)
expr_stmt|;
name|xml_node_create_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|item
argument_list|,
name|NULL
argument_list|,
literal|"Data"
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|build_oma_dm_1
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|int
name|msgid
parameter_list|,
specifier|const
name|char
modifier|*
name|oper
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|,
modifier|*
name|syncbody
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|cmdid
init|=
literal|0
decl_stmt|;
name|syncml
operator|=
name|oma_dm_build_hdr
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|msgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncml
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|syncbody
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncml
argument_list|,
name|NULL
argument_list|,
literal|"SyncBody"
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncbody
operator|==
name|NULL
condition|)
block|{
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cmdid
operator|++
expr_stmt|;
name|add_alert
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|cmdid
argument_list|,
name|DM_CLIENT_INITIATED_MGMT
argument_list|)
expr_stmt|;
name|str
operator|=
name|mo_str
argument_list|(
name|ctx
argument_list|,
name|NULL
argument_list|,
literal|"devdetail.xml"
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
block|{
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cmdid
operator|++
expr_stmt|;
name|oma_dm_add_hs20_generic_alert
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|cmdid
argument_list|,
name|oper
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|cmdid
operator|++
expr_stmt|;
name|add_replace_devinfo
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|cmdid
argument_list|)
expr_stmt|;
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncbody
argument_list|,
name|NULL
argument_list|,
literal|"Final"
argument_list|)
expr_stmt|;
return|return
name|syncml
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|build_oma_dm_1_sub_reg
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|int
name|msgid
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|;
name|syncml
operator|=
name|build_oma_dm_1
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|msgid
argument_list|,
name|DM_HS20_SUBSCRIPTION_CREATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncml
condition|)
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"OMA-DM Package 1 (sub reg)"
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
return|return
name|syncml
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|build_oma_dm_1_sub_prov
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|int
name|msgid
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|;
name|syncml
operator|=
name|build_oma_dm_1
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|msgid
argument_list|,
name|DM_HS20_SUBSCRIPTION_PROVISIONING
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncml
condition|)
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"OMA-DM Package 1 (sub prov)"
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
return|return
name|syncml
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|build_oma_dm_1_pol_upd
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|int
name|msgid
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|;
name|syncml
operator|=
name|build_oma_dm_1
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|msgid
argument_list|,
name|DM_HS20_POLICY_UPDATE
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncml
condition|)
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"OMA-DM Package 1 (pol upd)"
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
return|return
name|syncml
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|build_oma_dm_1_sub_rem
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|int
name|msgid
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|;
name|syncml
operator|=
name|build_oma_dm_1
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|msgid
argument_list|,
name|DM_HS20_SUBSCRIPTION_REMEDIATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncml
condition|)
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"OMA-DM Package 1 (sub rem)"
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
return|return
name|syncml
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oma_dm_exec_browser
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|exec
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|res
decl_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|exec
argument_list|,
literal|"Item/Data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No Data node found"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|data
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid data"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Data: %s"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Launch browser to URI '%s'"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Launch browser to URI '%s'"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|res
operator|=
name|hs20_web_browser
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"User response in browser completed successfully"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"User response in browser completed successfully"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_OK
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to receive user response"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Failed to receive user response"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_COMMAND_FAILED
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|oma_dm_exec_get_cert
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|exec
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|getcert
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Client certificate enrollment"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Client certificate enrollment"
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|exec
argument_list|,
literal|"Item/Data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No Data node found"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|data
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid data"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Data: %s"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|getcert
operator|=
name|xml_node_from_buf
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|getcert
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not parse Item/Data node contents"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"OMA-DM getCertificate"
argument_list|,
name|getcert
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|getcert
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"getCertificate"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unexpected getCertificate node name '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|res
operator|=
name|osu_get_certificate
argument_list|(
name|ctx
argument_list|,
name|getcert
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|getcert
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
literal|0
condition|?
name|DM_RESP_OK
else|:
name|DM_RESP_COMMAND_FAILED
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oma_dm_exec
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|exec
parameter_list|)
block|{
name|char
modifier|*
name|locuri
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|locuri
operator|=
name|oma_dm_get_target_locuri
argument_list|(
name|ctx
argument_list|,
name|exec
argument_list|)
expr_stmt|;
if|if
condition|(
name|locuri
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No Target LocURI node found"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Target LocURI: %s"
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|locuri
argument_list|,
literal|"./DevDetail/Ext/org.wi-fi/Wi-Fi/Ops/"
literal|"launchBrowserToURI"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|oma_dm_exec_browser
argument_list|(
name|ctx
argument_list|,
name|exec
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|locuri
argument_list|,
literal|"./DevDetail/Ext/org.wi-fi/Wi-Fi/Ops/"
literal|"getCertificate"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|oma_dm_exec_get_cert
argument_list|(
name|ctx
argument_list|,
name|exec
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unsupported exec Target LocURI"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|DM_RESP_NOT_FOUND
expr_stmt|;
block|}
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oma_dm_run_add
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|locuri
parameter_list|,
name|xml_node_t
modifier|*
name|add
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|size_t
name|fqdn_len
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|tnds
decl_stmt|,
modifier|*
name|unode
decl_stmt|,
modifier|*
name|pps_node
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|,
modifier|*
name|uri
decl_stmt|,
modifier|*
name|upos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|use_tnds
init|=
literal|0
decl_stmt|;
name|size_t
name|uri_len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Add command target LocURI: %s"
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|locuri
argument_list|,
literal|"./Wi-Fi/"
argument_list|,
literal|8
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow Add outside ./Wi-Fi"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
name|pos
operator|=
name|locuri
operator|+
literal|8
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|fqdn
operator|==
name|NULL
condition|)
return|return
name|DM_RESP_COMMAND_FAILED
return|;
name|fqdn_len
operator|=
name|os_strlen
argument_list|(
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|pos
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|,
name|fqdn_len
argument_list|)
operator|!=
literal|0
operator|||
name|pos
index|[
name|fqdn_len
index|]
operator|!=
literal|'/'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow Add outside ./Wi-Fi/%s"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
name|pos
operator|+=
name|fqdn_len
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|pos
argument_list|,
literal|"PerProviderSubscription/"
argument_list|,
literal|24
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow Add outside ./Wi-Fi/%s/PerProviderSubscription"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
name|pos
operator|+=
literal|24
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Add command for PPS node %s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pps_node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps_node
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Specified PPS node exists already"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_ALREADY_EXISTS
return|;
block|}
name|uri
operator|=
name|os_strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|uri
operator|==
name|NULL
condition|)
return|return
name|DM_RESP_COMMAND_FAILED
return|;
while|while
condition|(
operator|!
name|pps_node
condition|)
block|{
name|upos
operator|=
name|os_strrchr
argument_list|(
name|uri
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|upos
condition|)
break|break;
name|upos
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pps_node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Node %s %s"
argument_list|,
name|uri
argument_list|,
name|pps_node
condition|?
literal|"exists"
else|:
literal|"does not exist"
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Parent URI: %s"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pps_node
condition|)
block|{
comment|/* Add at root of PPS MO */
name|pps_node
operator|=
name|pps
expr_stmt|;
block|}
name|uri_len
operator|=
name|os_strlen
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|uri
argument_list|,
name|pos
operator|+
name|uri_len
argument_list|,
name|os_strlen
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
name|upos
operator|=
name|uri
expr_stmt|;
while|while
condition|(
operator|*
name|upos
operator|==
literal|'/'
condition|)
name|upos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Nodes to add: %s"
argument_list|,
name|upos
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|end
operator|=
name|os_strchr
argument_list|(
name|upos
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|end
condition|)
break|break;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Adding interim node %s"
argument_list|,
name|upos
argument_list|)
expr_stmt|;
name|pps_node
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_node
argument_list|,
name|NULL
argument_list|,
name|upos
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps_node
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_COMMAND_FAILED
return|;
block|}
name|upos
operator|=
name|end
operator|+
literal|1
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Adding node %s"
argument_list|,
name|upos
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|add
argument_list|,
literal|"Item/Meta/Type"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
name|char
modifier|*
name|type
decl_stmt|;
name|type
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not find type text"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|use_tnds
operator|=
name|node
operator|&&
name|os_strstr
argument_list|(
name|type
argument_list|,
literal|"application/vnd.syncml.dmtnds+xml"
argument_list|)
expr_stmt|;
block|}
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|add
argument_list|,
literal|"Item/Data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No Add/Item/Data found"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|data
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get Add/Item/Data text"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Add/Item/Data: %s"
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_tnds
condition|)
block|{
name|tnds
operator|=
name|xml_node_from_buf
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|tnds
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not parse Add/Item/Data text"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|unode
operator|=
name|tnds_to_mo
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
if|if
condition|(
name|unode
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not parse TNDS text"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"Parsed TNDS"
argument_list|,
name|unode
argument_list|)
expr_stmt|;
name|xml_node_add_child
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_node
argument_list|,
name|unode
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* TODO: What to do here? */
name|os_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|os_free
argument_list|(
name|uri
argument_list|)
expr_stmt|;
if|if
condition|(
name|update_pps_file
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|,
name|pps
argument_list|)
operator|<
literal|0
condition|)
return|return
name|DM_RESP_COMMAND_FAILED
return|;
name|ctx
operator|->
name|pps_updated
operator|=
literal|1
expr_stmt|;
return|return
name|DM_RESP_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oma_dm_add
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|add
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|char
modifier|*
name|locuri
decl_stmt|;
name|char
name|fname
index|[
literal|300
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|add
argument_list|,
literal|"Item/Target/LocURI"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No Target LocURI node found"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|locuri
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|locuri
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"No LocURI node text found"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Target LocURI: %s"
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|locuri
argument_list|,
literal|"./Wi-Fi/"
argument_list|,
literal|8
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unsupported Add Target LocURI"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|add
argument_list|,
literal|"Item/Data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No Data node found"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
if|if
condition|(
name|pps_fname
operator|&&
name|os_file_exists
argument_list|(
name|pps_fname
argument_list|)
condition|)
block|{
name|ret
operator|=
name|oma_dm_run_add
argument_list|(
name|ctx
argument_list|,
name|locuri
argument_list|,
name|add
argument_list|,
name|pps
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|DM_RESP_OK
condition|)
block|{
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|ret
operator|=
literal|0
expr_stmt|;
name|os_strlcpy
argument_list|(
name|fname
argument_list|,
name|pps_fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|hs20_add_pps_mo
argument_list|(
name|ctx
argument_list|,
name|locuri
argument_list|,
name|node
argument_list|,
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
name|ret
operator|==
operator|-
literal|2
condition|?
name|DM_RESP_ALREADY_EXISTS
else|:
name|DM_RESP_COMMAND_FAILED
return|;
if|if
condition|(
name|ctx
operator|->
name|no_reconnect
operator|==
literal|2
condition|)
block|{
name|os_snprintf
argument_list|(
name|ctx
operator|->
name|pps_fname
argument_list|,
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|pps_fname
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|pps_cred_set
operator|=
literal|1
expr_stmt|;
return|return
name|DM_RESP_OK
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Updating wpa_supplicant credentials"
argument_list|)
expr_stmt|;
name|cmd_set_pps
argument_list|(
name|ctx
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|no_reconnect
condition|)
return|return
name|DM_RESP_OK
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Requesting reconnection with updated configuration"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|"INTERWORKING_SELECT auto"
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oma_dm_replace
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|replace
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
name|char
modifier|*
name|locuri
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|fqdn_len
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|,
modifier|*
name|tnds
decl_stmt|,
modifier|*
name|unode
decl_stmt|,
modifier|*
name|pps_node
decl_stmt|,
modifier|*
name|parent
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|use_tnds
init|=
literal|0
decl_stmt|;
name|locuri
operator|=
name|oma_dm_get_target_locuri
argument_list|(
name|ctx
argument_list|,
name|replace
argument_list|)
expr_stmt|;
if|if
condition|(
name|locuri
operator|==
name|NULL
condition|)
return|return
name|DM_RESP_BAD_REQUEST
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Replace command target LocURI: %s"
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|locuri
argument_list|,
literal|"./Wi-Fi/"
argument_list|,
literal|8
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow Replace outside ./Wi-Fi"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
name|pos
operator|=
name|locuri
operator|+
literal|8
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|fqdn
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_COMMAND_FAILED
return|;
block|}
name|fqdn_len
operator|=
name|os_strlen
argument_list|(
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|pos
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|,
name|fqdn_len
argument_list|)
operator|!=
literal|0
operator|||
name|pos
index|[
name|fqdn_len
index|]
operator|!=
literal|'/'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow Replace outside ./Wi-Fi/%s"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
name|pos
operator|+=
name|fqdn_len
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|pos
argument_list|,
literal|"PerProviderSubscription/"
argument_list|,
literal|24
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow Replace outside ./Wi-Fi/%s/PerProviderSubscription"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
name|pos
operator|+=
literal|24
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Replace command for PPS node %s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pps_node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps_node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Specified PPS node not found"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_NOT_FOUND
return|;
block|}
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|replace
argument_list|,
literal|"Item/Meta/Type"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
name|char
modifier|*
name|type
decl_stmt|;
name|type
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not find type text"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|use_tnds
operator|=
name|node
operator|&&
name|os_strstr
argument_list|(
name|type
argument_list|,
literal|"application/vnd.syncml.dmtnds+xml"
argument_list|)
expr_stmt|;
block|}
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|replace
argument_list|,
literal|"Item/Data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No Replace/Item/Data found"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|data
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get Replace/Item/Data text"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Replace/Item/Data: %s"
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_tnds
condition|)
block|{
name|tnds
operator|=
name|xml_node_from_buf
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|tnds
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not parse Replace/Item/Data text"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|unode
operator|=
name|tnds_to_mo
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
if|if
condition|(
name|unode
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not parse TNDS text"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_BAD_REQUEST
return|;
block|}
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"Parsed TNDS"
argument_list|,
name|unode
argument_list|)
expr_stmt|;
name|parent
operator|=
name|xml_node_get_parent
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_node
argument_list|)
expr_stmt|;
name|xml_node_detach
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_node
argument_list|)
expr_stmt|;
name|xml_node_add_child
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|parent
argument_list|,
name|unode
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|xml_node_set_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_node
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
if|if
condition|(
name|update_pps_file
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|,
name|pps
argument_list|)
operator|<
literal|0
condition|)
return|return
name|DM_RESP_COMMAND_FAILED
return|;
name|ctx
operator|->
name|pps_updated
operator|=
literal|1
expr_stmt|;
return|return
name|DM_RESP_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oma_dm_get
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|get
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
name|char
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|char
modifier|*
name|locuri
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|fqdn_len
decl_stmt|;
name|xml_node_t
modifier|*
name|pps_node
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
operator|*
name|value
operator|=
name|NULL
expr_stmt|;
name|locuri
operator|=
name|oma_dm_get_target_locuri
argument_list|(
name|ctx
argument_list|,
name|get
argument_list|)
expr_stmt|;
if|if
condition|(
name|locuri
operator|==
name|NULL
condition|)
return|return
name|DM_RESP_BAD_REQUEST
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Get command target LocURI: %s"
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|locuri
argument_list|,
literal|"./Wi-Fi/"
argument_list|,
literal|8
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow Get outside ./Wi-Fi"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
name|pos
operator|=
name|locuri
operator|+
literal|8
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|fqdn
operator|==
name|NULL
condition|)
return|return
name|DM_RESP_COMMAND_FAILED
return|;
name|fqdn_len
operator|=
name|os_strlen
argument_list|(
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|pos
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|,
name|fqdn_len
argument_list|)
operator|!=
literal|0
operator|||
name|pos
index|[
name|fqdn_len
index|]
operator|!=
literal|'/'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow Get outside ./Wi-Fi/%s"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
name|pos
operator|+=
name|fqdn_len
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|pos
argument_list|,
literal|"PerProviderSubscription/"
argument_list|,
literal|24
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow Get outside ./Wi-Fi/%s/PerProviderSubscription"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
name|pos
operator|+=
literal|24
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Get command for PPS node %s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pps_node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps_node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Specified PPS node not found"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_NOT_FOUND
return|;
block|}
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_node
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Get command returned node with name '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Password"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Do not allow Get for Password node"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
return|return
name|DM_RESP_PERMISSION_DENIED
return|;
block|}
comment|/* 	 * TODO: No support for DMTNDS, so if interior node, reply with a 	 * list of children node names in Results element. The child list type is 	 * defined in [DMTND]. 	 */
operator|*
name|value
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_node
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|value
operator|==
name|NULL
condition|)
return|return
name|DM_RESP_COMMAND_FAILED
return|;
return|return
name|DM_RESP_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|oma_dm_get_cmdid
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|cnode
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|cnode
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"CmdID"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cnode
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|str
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|cnode
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|atoi
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|oma_dm_send_recv
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|xml_node_t
modifier|*
name|syncml
parameter_list|,
specifier|const
name|char
modifier|*
name|ext_hdr
parameter_list|,
specifier|const
name|char
modifier|*
name|username
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|char
modifier|*
name|client_key
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|resp
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|,
modifier|*
name|res
decl_stmt|;
name|char
modifier|*
name|resp_uri
init|=
name|NULL
decl_stmt|;
name|str
operator|=
name|xml_node_to_str
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Send OMA DM Package"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Send OMA DM Package"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|server_url
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|server_url
operator|=
name|os_strdup
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|res
operator|=
name|http_post
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|url
argument_list|,
name|str
argument_list|,
literal|"application/vnd.syncml.dm+xml"
argument_list|,
name|ext_hdr
argument_list|,
name|ctx
operator|->
name|ca_fname
argument_list|,
name|username
argument_list|,
name|password
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|resp_uri
argument_list|)
expr_stmt|;
name|resp_uri
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
specifier|const
name|char
modifier|*
name|err
init|=
name|http_get_err
argument_list|(
name|ctx
operator|->
name|http
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"HTTP error: %s"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"HTTP error: %s"
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Failed to send OMA DM Package"
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Server response: %s"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Process OMA DM Package"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Process received OMA DM Package"
argument_list|)
expr_stmt|;
name|resp
operator|=
name|xml_node_from_buf
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to parse OMA DM response"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"OMA DM Package"
argument_list|,
name|resp
argument_list|)
expr_stmt|;
return|return
name|resp
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|oma_dm_process
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|xml_node_t
modifier|*
name|resp
parameter_list|,
name|int
name|msgid
parameter_list|,
name|char
modifier|*
modifier|*
name|ret_resp_uri
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|,
modifier|*
name|syncbody
decl_stmt|,
modifier|*
name|hdr
decl_stmt|,
modifier|*
name|body
decl_stmt|,
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|resp_uri
init|=
name|NULL
decl_stmt|;
name|int
name|server_msgid
init|=
literal|0
decl_stmt|;
name|int
name|cmdid
init|=
literal|0
decl_stmt|;
name|int
name|server_cmdid
decl_stmt|;
name|int
name|resp_needed
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|tmp
decl_stmt|;
name|int
name|final
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|locuri
decl_stmt|;
operator|*
name|ret_resp_uri
operator|=
name|NULL
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"SyncML"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SyncML node not found"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|hdr
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|resp
argument_list|,
literal|"SyncHdr"
argument_list|)
expr_stmt|;
name|body
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|resp
argument_list|,
literal|"SyncBody"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|==
name|NULL
operator|||
name|body
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not find SyncHdr or SyncBody"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|hdr
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SyncHdr %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"RespURI"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tmp
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
name|resp_uri
operator|=
name|os_strdup
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"MsgID"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tmp
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
name|server_msgid
operator|=
name|atoi
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Server MsgID: %d"
argument_list|,
name|server_msgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp_uri
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RespURI: %s"
argument_list|,
name|resp_uri
argument_list|)
expr_stmt|;
name|syncml
operator|=
name|oma_dm_build_hdr
argument_list|(
name|ctx
argument_list|,
name|resp_uri
condition|?
name|resp_uri
else|:
name|url
argument_list|,
name|msgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncml
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|resp_uri
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|syncbody
operator|=
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncml
argument_list|,
name|NULL
argument_list|,
literal|"SyncBody"
argument_list|)
expr_stmt|;
name|cmdid
operator|++
expr_stmt|;
name|add_status
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|server_msgid
argument_list|,
literal|0
argument_list|,
name|cmdid
argument_list|,
literal|"SyncHdr"
argument_list|,
name|DM_RESP_AUTH_ACCEPTED
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|body
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|server_cmdid
operator|=
name|oma_dm_get_cmdid
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SyncBody CmdID=%d - %s"
argument_list|,
name|server_cmdid
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Exec"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|res
init|=
name|oma_dm_exec
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|)
decl_stmt|;
name|cmdid
operator|++
expr_stmt|;
name|locuri
operator|=
name|oma_dm_get_target_locuri
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|locuri
operator|==
name|NULL
condition|)
name|res
operator|=
name|DM_RESP_BAD_REQUEST
expr_stmt|;
name|add_status
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|server_msgid
argument_list|,
name|server_cmdid
argument_list|,
name|cmdid
argument_list|,
name|name
argument_list|,
name|res
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
name|resp_needed
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Add"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|res
init|=
name|oma_dm_add
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|pps
argument_list|,
name|pps_fname
argument_list|)
decl_stmt|;
name|cmdid
operator|++
expr_stmt|;
name|locuri
operator|=
name|oma_dm_get_target_locuri
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|locuri
operator|==
name|NULL
condition|)
name|res
operator|=
name|DM_RESP_BAD_REQUEST
expr_stmt|;
name|add_status
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|server_msgid
argument_list|,
name|server_cmdid
argument_list|,
name|cmdid
argument_list|,
name|name
argument_list|,
name|res
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
name|resp_needed
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Replace"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|oma_dm_replace
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|pps
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|cmdid
operator|++
expr_stmt|;
name|locuri
operator|=
name|oma_dm_get_target_locuri
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|locuri
operator|==
name|NULL
condition|)
name|res
operator|=
name|DM_RESP_BAD_REQUEST
expr_stmt|;
name|add_status
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|server_msgid
argument_list|,
name|server_cmdid
argument_list|,
name|cmdid
argument_list|,
name|name
argument_list|,
name|res
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
name|resp_needed
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Status"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* TODO: Verify success */
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Get"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|res
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
name|res
operator|=
name|oma_dm_get
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|,
name|pps
argument_list|,
name|pps_fname
argument_list|,
operator|&
name|value
argument_list|)
expr_stmt|;
name|cmdid
operator|++
expr_stmt|;
name|locuri
operator|=
name|oma_dm_get_target_locuri
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|locuri
operator|==
name|NULL
condition|)
name|res
operator|=
name|DM_RESP_BAD_REQUEST
expr_stmt|;
name|add_status
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|server_msgid
argument_list|,
name|server_cmdid
argument_list|,
name|cmdid
argument_list|,
name|name
argument_list|,
name|res
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|DM_RESP_OK
operator|&&
name|value
condition|)
block|{
name|cmdid
operator|++
expr_stmt|;
name|add_results
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|server_msgid
argument_list|,
name|server_cmdid
argument_list|,
name|cmdid
argument_list|,
name|locuri
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|resp_needed
operator|=
literal|1
expr_stmt|;
if|#
directive|if
literal|0
comment|/* TODO: MUST support */
block|} else if (os_strcasecmp(name, "Delete") == 0) {
endif|#
directive|endif
if|#
directive|if
literal|0
comment|/* TODO: MUST support */
block|} else if (os_strcasecmp(name, "Sequence") == 0) {
endif|#
directive|endif
block|}
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Final"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|final
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|else
block|{
name|locuri
operator|=
name|oma_dm_get_target_locuri
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|add_status
argument_list|(
name|ctx
argument_list|,
name|syncbody
argument_list|,
name|server_msgid
argument_list|,
name|server_cmdid
argument_list|,
name|cmdid
argument_list|,
name|name
argument_list|,
name|DM_RESP_COMMAND_NOT_IMPLEMENTED
argument_list|,
name|locuri
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|locuri
argument_list|)
expr_stmt|;
name|resp_needed
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|final
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Final node not found"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|resp_uri
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|resp_needed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Exchange completed - no response needed"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|resp_uri
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|xml_node_create
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|syncbody
argument_list|,
name|NULL
argument_list|,
literal|"Final"
argument_list|)
expr_stmt|;
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"OMA-DM Package 3"
argument_list|,
name|syncml
argument_list|)
expr_stmt|;
operator|*
name|ret_resp_uri
operator|=
name|resp_uri
expr_stmt|;
return|return
name|syncml
return|;
block|}
end_function

begin_function
name|int
name|cmd_oma_dm_prov
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|,
modifier|*
name|resp
decl_stmt|;
name|char
modifier|*
name|resp_uri
init|=
name|NULL
decl_stmt|;
name|int
name|msgid
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid prov command (missing URL)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OMA-DM credential provisioning requested"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"OMA-DM credential provisioning"
argument_list|)
expr_stmt|;
name|msgid
operator|++
expr_stmt|;
name|syncml
operator|=
name|build_oma_dm_1_sub_reg
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|msgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncml
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
while|while
condition|(
name|syncml
condition|)
block|{
name|resp
operator|=
name|oma_dm_send_recv
argument_list|(
name|ctx
argument_list|,
name|resp_uri
condition|?
name|resp_uri
else|:
name|url
argument_list|,
name|syncml
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|msgid
operator|++
expr_stmt|;
name|syncml
operator|=
name|oma_dm_process
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|resp
argument_list|,
name|msgid
argument_list|,
operator|&
name|resp_uri
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|resp
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|resp_uri
argument_list|)
expr_stmt|;
return|return
name|ctx
operator|->
name|pps_cred_set
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|cmd_oma_dm_sim_prov
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|,
modifier|*
name|resp
decl_stmt|;
name|char
modifier|*
name|resp_uri
init|=
name|NULL
decl_stmt|;
name|int
name|msgid
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid prov command (missing URL)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OMA-DM SIM provisioning requested"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|no_reconnect
operator|=
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Wait for IP address before starting SIM provisioning"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Wait for IP address before starting SIM provisioning"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait_ip_addr
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|15
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get IP address for WLAN - try connection anyway"
argument_list|)
expr_stmt|;
block|}
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"OMA-DM SIM provisioning"
argument_list|)
expr_stmt|;
name|msgid
operator|++
expr_stmt|;
name|syncml
operator|=
name|build_oma_dm_1_sub_prov
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|msgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncml
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
while|while
condition|(
name|syncml
condition|)
block|{
name|resp
operator|=
name|oma_dm_send_recv
argument_list|(
name|ctx
argument_list|,
name|resp_uri
condition|?
name|resp_uri
else|:
name|url
argument_list|,
name|syncml
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|msgid
operator|++
expr_stmt|;
name|syncml
operator|=
name|oma_dm_process
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|resp
argument_list|,
name|msgid
argument_list|,
operator|&
name|resp_uri
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|resp
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|resp_uri
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|pps_cred_set
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Updating wpa_supplicant credentials"
argument_list|)
expr_stmt|;
name|cmd_set_pps
argument_list|(
name|ctx
argument_list|,
name|ctx
operator|->
name|pps_fname
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Requesting reconnection with updated configuration"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Requesting reconnection with updated configuration"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|"INTERWORKING_SELECT auto"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
name|ctx
operator|->
name|pps_cred_set
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|oma_dm_pol_upd
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|address
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|char
modifier|*
name|client_key
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_username
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_password
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|,
modifier|*
name|resp
decl_stmt|;
name|char
modifier|*
name|resp_uri
init|=
name|NULL
decl_stmt|;
name|int
name|msgid
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OMA-DM policy update"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"OMA-DM policy update"
argument_list|)
expr_stmt|;
name|msgid
operator|++
expr_stmt|;
name|syncml
operator|=
name|build_oma_dm_1_pol_upd
argument_list|(
name|ctx
argument_list|,
name|address
argument_list|,
name|msgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncml
operator|==
name|NULL
condition|)
return|return;
while|while
condition|(
name|syncml
condition|)
block|{
name|resp
operator|=
name|oma_dm_send_recv
argument_list|(
name|ctx
argument_list|,
name|resp_uri
condition|?
name|resp_uri
else|:
name|address
argument_list|,
name|syncml
argument_list|,
name|NULL
argument_list|,
name|cred_username
argument_list|,
name|cred_password
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
name|msgid
operator|++
expr_stmt|;
name|syncml
operator|=
name|oma_dm_process
argument_list|(
name|ctx
argument_list|,
name|address
argument_list|,
name|resp
argument_list|,
name|msgid
argument_list|,
operator|&
name|resp_uri
argument_list|,
name|pps
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|resp
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|resp_uri
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|pps_updated
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Update wpa_supplicant credential based on updated PPS MO"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Update wpa_supplicant credential based on updated PPS MO and request connection"
argument_list|)
expr_stmt|;
name|cmd_set_pps
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|"INTERWORKING_SELECT auto"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|oma_dm_sub_rem
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|address
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|char
modifier|*
name|client_key
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_username
parameter_list|,
specifier|const
name|char
modifier|*
name|cred_password
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|syncml
decl_stmt|,
modifier|*
name|resp
decl_stmt|;
name|char
modifier|*
name|resp_uri
init|=
name|NULL
decl_stmt|;
name|int
name|msgid
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OMA-DM subscription remediation"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"OMA-DM subscription remediation"
argument_list|)
expr_stmt|;
name|msgid
operator|++
expr_stmt|;
name|syncml
operator|=
name|build_oma_dm_1_sub_rem
argument_list|(
name|ctx
argument_list|,
name|address
argument_list|,
name|msgid
argument_list|)
expr_stmt|;
if|if
condition|(
name|syncml
operator|==
name|NULL
condition|)
return|return;
while|while
condition|(
name|syncml
condition|)
block|{
name|resp
operator|=
name|oma_dm_send_recv
argument_list|(
name|ctx
argument_list|,
name|resp_uri
condition|?
name|resp_uri
else|:
name|address
argument_list|,
name|syncml
argument_list|,
name|NULL
argument_list|,
name|cred_username
argument_list|,
name|cred_password
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
name|msgid
operator|++
expr_stmt|;
name|syncml
operator|=
name|oma_dm_process
argument_list|(
name|ctx
argument_list|,
name|address
argument_list|,
name|resp
argument_list|,
name|msgid
argument_list|,
operator|&
name|resp_uri
argument_list|,
name|pps
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|resp
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|resp_uri
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Update wpa_supplicant credential based on updated PPS MO and request reconnection"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Update wpa_supplicant credential based on updated PPS MO and request reconnection"
argument_list|)
expr_stmt|;
name|cmd_set_pps
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|"INTERWORKING_SELECT auto"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|cmd_oma_dm_add
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|add_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|pps
decl_stmt|,
modifier|*
name|add
decl_stmt|;
name|int
name|res
decl_stmt|;
name|ctx
operator|->
name|fqdn
operator|=
name|os_strdup
argument_list|(
literal|"wi-fi.org"
argument_list|)
expr_stmt|;
name|pps
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PPS file %s could not be parsed"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
return|return;
block|}
name|add
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|add_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|add
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Add file %s could not be parsed"
argument_list|,
name|add_fname
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|oma_dm_add
argument_list|(
name|ctx
argument_list|,
name|add
argument_list|,
name|pps
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"oma_dm_add --> %d"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|add
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cmd_oma_dm_replace
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|replace_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|pps
decl_stmt|,
modifier|*
name|replace
decl_stmt|;
name|int
name|res
decl_stmt|;
name|ctx
operator|->
name|fqdn
operator|=
name|os_strdup
argument_list|(
literal|"wi-fi.org"
argument_list|)
expr_stmt|;
name|pps
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PPS file %s could not be parsed"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
return|return;
block|}
name|replace
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|replace_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|replace
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Replace file %s could not be parsed"
argument_list|,
name|replace_fname
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|oma_dm_replace
argument_list|(
name|ctx
argument_list|,
name|replace
argument_list|,
name|pps
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"oma_dm_replace --> %d"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|replace
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


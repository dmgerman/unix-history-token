begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Hotspot 2.0 OSU client  * Copyright (c) 2012-2014, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|ANDROID
end_ifdef

begin_include
include|#
directive|include
file|"private/android_filesystem_config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ANDROID */
end_comment

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"utils/browser.h"
end_include

begin_include
include|#
directive|include
file|"utils/base64.h"
end_include

begin_include
include|#
directive|include
file|"utils/xml-utils.h"
end_include

begin_include
include|#
directive|include
file|"utils/http-utils.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_helpers.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_defs.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"osu_client.h"
end_include

begin_decl_stmt
specifier|const
name|char
modifier|*
name|spp_xsd_fname
init|=
literal|"spp.xsd"
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|write_result
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|500
index|]
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vsnprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctx
operator|->
name|result_file
condition|)
return|return;
name|f
operator|=
name|fopen
argument_list|(
name|ctx
operator|->
name|result_file
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|f
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|write_summary
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|va_list
name|ap
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
if|if
condition|(
operator|!
name|ctx
operator|->
name|summary_file
condition|)
return|return;
name|f
operator|=
name|fopen
argument_list|(
name|ctx
operator|->
name|summary_file
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vfprintf
argument_list|(
name|f
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|debug_dump_node
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|title
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_to_str
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"[hs20] %s: '%s'"
argument_list|,
name|title
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|valid_fqdn
parameter_list|(
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
comment|/* TODO: could make this more complete.. */
if|if
condition|(
name|strchr
argument_list|(
name|fqdn
argument_list|,
literal|'.'
argument_list|)
operator|==
literal|0
operator|||
name|strlen
argument_list|(
name|fqdn
argument_list|)
operator|>
literal|255
condition|)
return|return
literal|0
return|;
for|for
control|(
name|pos
operator|=
name|fqdn
init|;
operator|*
name|pos
condition|;
name|pos
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|pos
operator|>=
literal|'a'
operator|&&
operator|*
name|pos
operator|<=
literal|'z'
condition|)
continue|continue;
if|if
condition|(
operator|*
name|pos
operator|>=
literal|'A'
operator|&&
operator|*
name|pos
operator|<=
literal|'Z'
condition|)
continue|continue;
if|if
condition|(
operator|*
name|pos
operator|>=
literal|'0'
operator|&&
operator|*
name|pos
operator|<=
literal|'9'
condition|)
continue|continue;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'-'
operator|||
operator|*
name|pos
operator|==
literal|'.'
operator|||
operator|*
name|pos
operator|==
literal|'_'
condition|)
continue|continue;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|osu_get_certificate
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|getcert
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|char
modifier|*
name|url
decl_stmt|,
modifier|*
name|user
init|=
name|NULL
decl_stmt|,
modifier|*
name|pw
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|proto
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|proto
operator|=
name|xml_node_get_attr_value
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|getcert
argument_list|,
literal|"enrollmentProtocol"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|proto
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"getCertificate - enrollmentProtocol=%s"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"getCertificate - enrollmentProtocol=%s"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|proto
argument_list|,
literal|"EST"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unsupported enrollmentProtocol"
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|proto
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|getcert
argument_list|,
literal|"enrollmentServerURI"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not find enrollmentServerURI node"
argument_list|)
expr_stmt|;
name|xml_node_get_attr_value_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|proto
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|url
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get URL text"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"enrollmentServerURI: %s"
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"enrollmentServerURI: %s"
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|getcert
argument_list|,
literal|"estUserID"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
operator|&&
operator|!
name|ctx
operator|->
name|client_cert_present
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not find estUserID node"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|node
condition|)
block|{
name|user
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get estUserID text"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"estUserID: %s"
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"estUserID: %s"
argument_list|,
name|user
argument_list|)
expr_stmt|;
block|}
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|getcert
argument_list|,
literal|"estPassword"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
operator|&&
operator|!
name|ctx
operator|->
name|client_cert_present
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not find estPassword node"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|node
condition|)
block|{
name|pw
operator|=
name|xml_node_get_base64_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pw
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get estPassword text"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"estPassword: %s"
argument_list|,
name|pw
argument_list|)
expr_stmt|;
block|}
name|mkdir
argument_list|(
literal|"Cert"
argument_list|,
name|S_IRWXU
argument_list|)
expr_stmt|;
if|if
condition|(
name|est_load_cacerts
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|)
operator|<
literal|0
operator|||
name|est_build_csr
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|)
operator|<
literal|0
operator|||
name|est_simple_enroll
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|user
argument_list|,
name|pw
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
literal|0
expr_stmt|;
name|fail
label|:
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pw
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|process_est_cert
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|cert
parameter_list|,
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|)
block|{
name|u8
name|digest1
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|,
name|digest2
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|char
modifier|*
name|der
decl_stmt|,
modifier|*
name|pem
decl_stmt|;
name|size_t
name|der_len
decl_stmt|,
name|pem_len
decl_stmt|;
name|char
modifier|*
name|fingerprint
decl_stmt|;
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PPS for certificate credential - fqdn=%s"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
name|fingerprint
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|fingerprint
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|fingerprint
argument_list|,
name|digest1
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid SHA256 hash value"
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"Invalid client certificate SHA256 hash value in PPS"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|fingerprint
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|fingerprint
argument_list|)
expr_stmt|;
name|der
operator|=
name|os_readfile
argument_list|(
literal|"Cert/est_cert.der"
argument_list|,
operator|&
name|der_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|der
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not find client certificate from EST"
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"Could not find client certificate from EST"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|sha256_vector
argument_list|(
literal|1
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|*
operator|)
operator|&
name|der
argument_list|,
operator|&
name|der_len
argument_list|,
name|digest2
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|der
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|der
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|digest1
argument_list|,
name|digest2
argument_list|,
sizeof|sizeof
argument_list|(
name|digest1
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Client certificate from EST does not match fingerprint from PPS MO"
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"Client certificate from EST does not match fingerprint from PPS MO"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Client certificate from EST matches PPS MO"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
literal|"Cert/est_cert.der"
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"SP/%s/client-ca.pem"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
literal|"Cert/est-cacerts.pem"
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not move est-cacerts.pem to client-ca.pem: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pem
operator|=
name|os_readfile
argument_list|(
name|buf
argument_list|,
operator|&
name|pem_len
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"SP/%s/client-cert.pem"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
literal|"Cert/est_cert.pem"
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not move est_cert.pem to client-cert.pem: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pem
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|pem
condition|)
block|{
name|FILE
modifier|*
name|f
init|=
name|fopen
argument_list|(
name|buf
argument_list|,
literal|"a"
argument_list|)
decl_stmt|;
if|if
condition|(
name|f
condition|)
block|{
name|fwrite
argument_list|(
name|pem
argument_list|,
name|pem_len
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|pem
argument_list|)
expr_stmt|;
block|}
name|os_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"SP/%s/client-key.pem"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
literal|"Cert/privkey-plain.pem"
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not move privkey-plain.pem to client-key.pem: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|unlink
argument_list|(
literal|"Cert/est-req.b64"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
literal|"Cert/est-req.pem"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
literal|"Cert/est-resp.raw"
argument_list|)
expr_stmt|;
name|rmdir
argument_list|(
literal|"Cert"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_define
define|#
directive|define
name|TMP_CERT_DL_FILE
value|"tmp-cert-download"
end_define

begin_function
specifier|static
name|int
name|download_cert
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|params
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|url_node
decl_stmt|,
modifier|*
name|hash_node
decl_stmt|;
name|char
modifier|*
name|url
decl_stmt|,
modifier|*
name|hash
decl_stmt|;
name|char
modifier|*
name|cert
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u8
name|digest1
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|,
name|digest2
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|unsigned
name|char
modifier|*
name|b64
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|url_node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|params
argument_list|,
literal|"CertURL"
argument_list|)
expr_stmt|;
name|hash_node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|params
argument_list|,
literal|"CertSHA256Fingerprint"
argument_list|)
expr_stmt|;
if|if
condition|(
name|url_node
operator|==
name|NULL
operator|||
name|hash_node
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|url
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|url_node
argument_list|)
expr_stmt|;
name|hash
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|hash_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
operator|||
name|hash
operator|==
name|NULL
condition|)
block|{
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|hash
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CertURL: %s"
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SHA256 hash: %s"
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|hash
argument_list|,
name|digest1
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid SHA256 hash value"
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"Invalid SHA256 hash value for downloaded certificate"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|hash
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Download certificate from %s"
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|no_osu_cert_validation
operator|=
literal|1
expr_stmt|;
name|http_ocsp_set
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|res
operator|=
name|http_download_file
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|url
argument_list|,
name|TMP_CERT_DL_FILE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|http_ocsp_set
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
operator|(
name|ctx
operator|->
name|workarounds
operator|&
name|WORKAROUND_OCSP_OPTIONAL
operator|)
condition|?
literal|1
else|:
literal|2
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|no_osu_cert_validation
operator|=
literal|0
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|cert
operator|=
name|os_readfile
argument_list|(
name|TMP_CERT_DL_FILE
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
name|remove
argument_list|(
name|TMP_CERT_DL_FILE
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|sha256_vector
argument_list|(
literal|1
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|*
operator|)
operator|&
name|cert
argument_list|,
operator|&
name|len
argument_list|,
name|digest2
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|digest1
argument_list|,
name|digest2
argument_list|,
sizeof|sizeof
argument_list|(
name|digest1
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Downloaded certificate fingerprint did not match"
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"Downloaded certificate fingerprint did not match"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|b64
operator|=
name|base64_encode
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|cert
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|b64
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|b64
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"-----BEGIN CERTIFICATE-----\n"
literal|"%s"
literal|"-----END CERTIFICATE-----\n"
argument_list|,
name|b64
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|b64
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Downloaded certificate into %s and validated fingerprint"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Downloaded certificate into %s and validated fingerprint"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_dl_osu_ca
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|pps
decl_stmt|,
modifier|*
name|node
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|pps
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not read or parse '%s'"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"SubscriptionUpdate/TrustRoot"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No SubscriptionUpdate/TrustRoot/CertURL found from PPS"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|download_cert
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_dl_polupd_ca
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|pps
decl_stmt|,
modifier|*
name|node
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|pps
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not read or parse '%s'"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"Policy/PolicyUpdate/TrustRoot"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No Policy/PolicyUpdate/TrustRoot/CertURL found from PPS"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|download_cert
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_dl_aaa_ca
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|pps
decl_stmt|,
modifier|*
name|node
decl_stmt|,
modifier|*
name|aaa
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|pps
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not read or parse '%s'"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"AAAServerTrustRoot"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No AAAServerTrustRoot/CertURL found from PPS"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|aaa
operator|=
name|xml_node_first_child
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|aaa
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No AAAServerTrustRoot/CertURL found from PPS"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|download_cert
argument_list|(
name|ctx
argument_list|,
name|aaa
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|download_trust_roots
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
name|char
modifier|*
name|dir
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|char
name|fname
index|[
literal|300
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|dir
operator|=
name|os_strdup
argument_list|(
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|os_strrchr
argument_list|(
name|dir
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|dir
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"%s/ca.pem"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cmd_dl_osu_ca
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"%s/polupd-ca.pem"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
name|cmd_dl_polupd_ca
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"%s/aaa-ca.pem"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
name|cmd_dl_aaa_ca
argument_list|(
name|ctx
argument_list|,
name|pps_fname
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|dir
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|server_dnsname_suffix_match
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|)
block|{
name|size_t
name|match_len
decl_stmt|,
name|len
decl_stmt|,
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|val
decl_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctx
operator|->
name|server_dnsname_count
condition|;
name|i
operator|++
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Checking suffix match against server dNSName %s"
argument_list|,
name|ctx
operator|->
name|server_dnsname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|val
operator|=
name|ctx
operator|->
name|server_dnsname
index|[
name|i
index|]
expr_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|match_len
operator|>
name|len
condition|)
continue|continue;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|val
operator|+
name|len
operator|-
name|match_len
argument_list|,
name|fqdn
argument_list|,
name|match_len
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
comment|/* no match */
if|if
condition|(
name|match_len
operator|==
name|len
condition|)
return|return
literal|1
return|;
comment|/* exact match */
if|if
condition|(
name|val
index|[
name|len
operator|-
name|match_len
operator|-
literal|1
index|]
operator|==
literal|'.'
condition|)
return|return
literal|1
return|;
comment|/* full label match completes suffix match */
comment|/* Reject due to incomplete label match */
block|}
comment|/* None of the dNSName(s) matched */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|hs20_add_pps_mo
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|uri
parameter_list|,
name|xml_node_t
modifier|*
name|add_mo
parameter_list|,
name|char
modifier|*
name|fname
parameter_list|,
name|size_t
name|fname_len
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|char
modifier|*
name|fqdn
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|xml_node_t
modifier|*
name|tnds
decl_stmt|,
modifier|*
name|mo
decl_stmt|,
modifier|*
name|cert
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|uri
argument_list|,
literal|"./Wi-Fi/"
argument_list|,
literal|8
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unsupported location for addMO to add PPS MO: '%s'"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"Unsupported location for addMO to add PPS MO: '%s'"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fqdn
operator|=
name|strdup
argument_list|(
name|uri
operator|+
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|fqdn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|strchr
argument_list|(
name|fqdn
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|pos
argument_list|,
literal|"/PerProviderSubscription"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unsupported location for addMO to add PPS MO (extra directory): '%s'"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"Unsupported location for addMO to "
literal|"add PPS MO (extra directory): '%s'"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
comment|/* remove trailing slash and PPS node name */
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SP FQDN: %s"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|server_dnsname_suffix_match
argument_list|(
name|ctx
argument_list|,
name|fqdn
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"FQDN '%s' for new PPS MO did not have suffix match with server's dNSName values, count: %d"
argument_list|,
name|fqdn
argument_list|,
operator|(
name|int
operator|)
name|ctx
operator|->
name|server_dnsname_count
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"FQDN '%s' for new PPS MO did not have suffix match with server's dNSName values"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|valid_fqdn
argument_list|(
name|fqdn
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid FQDN '%s'"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"Invalid FQDN '%s'"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|mkdir
argument_list|(
literal|"SP"
argument_list|,
name|S_IRWXU
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|fname
argument_list|,
name|fname_len
argument_list|,
literal|"SP/%s"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|mkdir
argument_list|(
name|fname
argument_list|,
name|S_IRWXU
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
name|EEXIST
condition|)
block|{
name|int
name|err
init|=
name|errno
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"mkdir(%s) failed: %s"
argument_list|,
name|fname
argument_list|,
name|strerror
argument_list|(
name|err
argument_list|)
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
ifdef|#
directive|ifdef
name|ANDROID
comment|/* Allow processes running with Group ID as AID_WIFI, 	 * to read files from SP/<fqdn> directory */
if|if
condition|(
name|chown
argument_list|(
name|fname
argument_list|,
operator|-
literal|1
argument_list|,
name|AID_WIFI
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CTRL: Could not chown directory: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Try to continue anyway */
block|}
if|if
condition|(
name|chmod
argument_list|(
name|fname
argument_list|,
name|S_IRWXU
operator||
name|S_IRGRP
operator||
name|S_IXGRP
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CTRL: Could not chmod directory: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Try to continue anyway */
block|}
endif|#
directive|endif
comment|/* ANDROID */
name|snprintf
argument_list|(
name|fname
argument_list|,
name|fname_len
argument_list|,
literal|"SP/%s/pps.xml"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_file_exists
argument_list|(
name|fname
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PPS file '%s' exists - reject addMO"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"PPS file '%s' exists - reject addMO"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Using PPS file: %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|str
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|add_mo
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not extract MO text"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"[hs20] addMO text: '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|tnds
operator|=
name|xml_node_from_buf
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|tnds
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] Could not parse addMO text"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|mo
operator|=
name|tnds_to_mo
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
if|if
condition|(
name|mo
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] Could not parse addMO TNDS text"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|debug_dump_node
argument_list|(
name|ctx
argument_list|,
literal|"Parsed TNDS"
argument_list|,
name|mo
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|mo
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"PerProviderSubscription"
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[hs20] Unexpected PPS MO root node name '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cert
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|mo
argument_list|,
literal|"Credential/DigitalCertificate/"
literal|"CertSHA256Fingerprint"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|&&
name|process_est_cert
argument_list|(
name|ctx
argument_list|,
name|cert
argument_list|,
name|fqdn
argument_list|)
operator|<
literal|0
condition|)
block|{
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|mo
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|free
argument_list|(
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|node_to_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|fname
argument_list|,
name|mo
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not write MO to file"
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|mo
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|mo
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"A new PPS MO added as '%s'"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"A new PPS MO added as '%s'"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|ret
operator|=
name|download_trust_roots
argument_list|(
name|ctx
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Remove invalid PPS MO file"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Remove invalid PPS MO file"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|fname
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|update_pps_file
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|backup
index|[
literal|300
index|]
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|client_cert_present
condition|)
block|{
name|xml_node_t
modifier|*
name|cert
decl_stmt|;
name|cert
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"Credential/DigitalCertificate/"
literal|"CertSHA256Fingerprint"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|&&
name|os_file_exists
argument_list|(
literal|"Cert/est_cert.der"
argument_list|)
operator|&&
name|process_est_cert
argument_list|(
name|ctx
argument_list|,
name|cert
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EST certificate update processing failed on PPS MO update"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Updating PPS MO %s"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|str
operator|=
name|xml_node_to_str
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"No node found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"[hs20] Updated PPS: '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|backup
argument_list|,
sizeof|sizeof
argument_list|(
name|backup
argument_list|)
argument_list|,
literal|"%s.bak"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|pps_fname
argument_list|,
name|backup
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|pps_fname
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not write PPS"
argument_list|)
expr_stmt|;
name|rename
argument_list|(
name|backup
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|get_user_pw
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|,
specifier|const
name|char
modifier|*
name|alt_loc
parameter_list|,
name|char
modifier|*
modifier|*
name|user
parameter_list|,
name|char
modifier|*
modifier|*
name|pw
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"Credential/UsernamePassword/Username"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
operator|*
name|user
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"Credential/UsernamePassword/Password"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
operator|*
name|pw
operator|=
name|xml_node_get_base64_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
name|alt_loc
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
name|xml_node_t
modifier|*
name|a
decl_stmt|;
name|a
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"Username"
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
condition|)
block|{
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
operator|*
name|user
argument_list|)
expr_stmt|;
operator|*
name|user
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|a
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Use OSU username '%s'"
argument_list|,
operator|*
name|user
argument_list|)
expr_stmt|;
block|}
name|a
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"Password"
argument_list|)
expr_stmt|;
if|if
condition|(
name|a
condition|)
block|{
name|free
argument_list|(
operator|*
name|pw
argument_list|)
expr_stmt|;
operator|*
name|pw
operator|=
name|xml_node_get_base64_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|a
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Use OSU password"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* Remove old credentials based on HomeSP/FQDN */
end_comment

begin_function
specifier|static
name|void
name|remove_sp_creds
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|)
block|{
name|char
name|cmd
index|[
literal|300
index|]
decl_stmt|;
name|os_snprintf
argument_list|(
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|"REMOVE_CRED provisioning_sp=%s"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|cmd
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to remove old credential(s)"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy_spe
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|spe
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|ssid
decl_stmt|;
name|char
modifier|*
name|txt
decl_stmt|;
name|ssid
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|spe
argument_list|,
literal|"SSID"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return;
name|txt
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|txt
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"- Policy/SPExclusionList/<X+>/SSID = %s"
argument_list|,
name|txt
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"excluded_ssid"
argument_list|,
name|txt
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred excluded_ssid"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy_spel
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|spel
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|spel
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|set_pps_cred_policy_spe
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy_prp
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|prp
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|char
modifier|*
name|txt
init|=
name|NULL
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|char
modifier|*
name|prio
decl_stmt|,
modifier|*
name|country_buf
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|country
decl_stmt|;
name|char
name|val
index|[
literal|200
index|]
decl_stmt|;
name|int
name|priority
decl_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|prp
argument_list|,
literal|"Priority"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return;
name|prio
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|prio
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/PreferredRoamingPartnerList/<X+>/Priority = %s"
argument_list|,
name|prio
argument_list|)
expr_stmt|;
name|priority
operator|=
name|atoi
argument_list|(
name|prio
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|prio
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|prp
argument_list|,
literal|"Country"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
name|country_buf
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|country_buf
operator|==
name|NULL
condition|)
return|return;
name|country
operator|=
name|country_buf
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/PreferredRoamingPartnerList/<X+>/Country = %s"
argument_list|,
name|country
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|country
operator|=
literal|"*"
expr_stmt|;
block|}
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|prp
argument_list|,
literal|"FQDN_Match"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|txt
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|txt
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/PreferredRoamingPartnerList/<X+>/FQDN_Match = %s"
argument_list|,
name|txt
argument_list|)
expr_stmt|;
name|pos
operator|=
name|strrchr
argument_list|(
name|txt
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|snprintf
argument_list|(
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|,
literal|"%s,%d,%d,%s"
argument_list|,
name|txt
argument_list|,
name|strcmp
argument_list|(
name|pos
argument_list|,
literal|"includeSubdomains"
argument_list|)
operator|!=
literal|0
argument_list|,
name|priority
argument_list|,
name|country
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"roaming_partner"
argument_list|,
name|val
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred roaming_partner"
argument_list|)
expr_stmt|;
name|out
label|:
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|country_buf
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy_prpl
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|prpl
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|prpl
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|set_pps_cred_policy_prp
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy_min_backhaul
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|min_backhaul
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|char
modifier|*
name|type
decl_stmt|,
modifier|*
name|dl
init|=
name|NULL
decl_stmt|,
modifier|*
name|ul
init|=
name|NULL
decl_stmt|;
name|int
name|home
decl_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|min_backhaul
argument_list|,
literal|"NetworkType"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Ignore MinBackhaulThreshold without mandatory NetworkType node"
argument_list|)
expr_stmt|;
return|return;
block|}
name|type
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/MinBackhaulThreshold/<X+>/NetworkType = %s"
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|type
argument_list|,
literal|"home"
argument_list|)
operator|==
literal|0
condition|)
name|home
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|type
argument_list|,
literal|"roaming"
argument_list|)
operator|==
literal|0
condition|)
name|home
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Ignore MinBackhaulThreshold with invalid NetworkType"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|min_backhaul
argument_list|,
literal|"DLBandwidth"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
name|dl
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|min_backhaul
argument_list|,
literal|"ULBandwidth"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
name|ul
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl
operator|==
name|NULL
operator|&&
name|ul
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Ignore MinBackhaulThreshold without either DLBandwidth or ULBandwidth nodes"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dl
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/MinBackhaulThreshold/<X+>/DLBandwidth = %s"
argument_list|,
name|dl
argument_list|)
expr_stmt|;
if|if
condition|(
name|ul
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/MinBackhaulThreshold/<X+>/ULBandwidth = %s"
argument_list|,
name|ul
argument_list|)
expr_stmt|;
if|if
condition|(
name|home
condition|)
block|{
if|if
condition|(
name|dl
operator|&&
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"min_dl_bandwidth_home"
argument_list|,
name|dl
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred bandwidth limit"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ul
operator|&&
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"min_ul_bandwidth_home"
argument_list|,
name|ul
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred bandwidth limit"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dl
operator|&&
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"min_dl_bandwidth_roaming"
argument_list|,
name|dl
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred bandwidth limit"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ul
operator|&&
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"min_ul_bandwidth_roaming"
argument_list|,
name|ul
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred bandwidth limit"
argument_list|)
expr_stmt|;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|dl
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ul
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy_min_backhaul_list
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/MinBackhaulThreshold"
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|set_pps_cred_policy_min_backhaul
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy_update
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/PolicyUpdate"
argument_list|)
expr_stmt|;
comment|/* Not used in wpa_supplicant */
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy_required_proto_port
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|tuple
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|char
modifier|*
name|proto
decl_stmt|,
modifier|*
name|port
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|buflen
decl_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tuple
argument_list|,
literal|"IPProtocol"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Ignore RequiredProtoPortTuple without mandatory IPProtocol node"
argument_list|)
expr_stmt|;
return|return;
block|}
name|proto
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/RequiredProtoPortTuple/<X+>/IPProtocol = %s"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tuple
argument_list|,
literal|"PortNumber"
argument_list|)
expr_stmt|;
name|port
operator|=
name|node
condition|?
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
else|:
name|NULL
expr_stmt|;
if|if
condition|(
name|port
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/RequiredProtoPortTuple/<X+>/PortNumber = %s"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|buflen
operator|=
name|os_strlen
argument_list|(
name|proto
argument_list|)
operator|+
name|os_strlen
argument_list|(
name|port
argument_list|)
operator|+
literal|10
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s:%s"
argument_list|,
name|proto
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|buflen
operator|=
name|os_strlen
argument_list|(
name|proto
argument_list|)
operator|+
literal|10
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buflen
argument_list|,
literal|"%s"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"req_conn_capab"
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not set req_conn_capab"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy_required_proto_ports
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/RequiredProtoPortTuple"
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|set_pps_cred_policy_required_proto_port
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy_max_bss_load
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy/MaximumBSSLoadValue - %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"max_bss_load"
argument_list|,
name|str
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred max_bss_load limit"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_policy
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Policy"
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"PreferredRoamingPartnerList"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_policy_prpl
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"MinBackhaulThreshold"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_policy_min_backhaul_list
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"PolicyUpdate"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_policy_update
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"SPExclusionList"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_policy_spel
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"RequiredProtoPortTuple"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_policy_required_proto_ports
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"MaximumBSSLoadValue"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_policy_max_bss_load
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown Policy node '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_priority
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- CredentialPriority = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"sp_priority"
argument_list|,
name|str
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred sp_priority"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_aaa_server_trust_root
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- AAAServerTrustRoot - TODO"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_sub_update
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- SubscriptionUpdate"
argument_list|)
expr_stmt|;
comment|/* not used within wpa_supplicant */
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp_network_id
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|ssid_node
decl_stmt|,
modifier|*
name|hessid_node
decl_stmt|;
name|char
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|hessid
decl_stmt|;
name|ssid_node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"SSID"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid_node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Ignore HomeSP/NetworkID without mandatory SSID node"
argument_list|)
expr_stmt|;
return|return;
block|}
name|hessid_node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"HESSID"
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ssid_node
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return;
name|hessid
operator|=
name|hessid_node
condition|?
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|hessid_node
argument_list|)
else|:
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/NetworkID/<X+>/SSID = %s"
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|hessid
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/NetworkID/<X+>/HESSID = %s"
argument_list|,
name|hessid
argument_list|)
expr_stmt|;
comment|/* TODO: Configure to wpa_supplicant */
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|hessid
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp_network_ids
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/NetworkID"
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|set_pps_cred_home_sp_network_id
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp_friendly_name
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/FriendlyName = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
comment|/* not used within wpa_supplicant(?) */
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp_icon_url
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/IconURL = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
comment|/* not used within wpa_supplicant */
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp_fqdn
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/FQDN = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"domain"
argument_list|,
name|str
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred domain"
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"domain_suffix_match"
argument_list|,
name|str
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred domain_suffix_match"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp_oi
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|homeoi
init|=
name|NULL
decl_stmt|;
name|int
name|required
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
literal|"HomeOI"
argument_list|)
operator|==
literal|0
operator|&&
operator|!
name|homeoi
condition|)
block|{
name|homeoi
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/HomeOIList/<X+>/HomeOI = %s"
argument_list|,
name|homeoi
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
literal|"HomeOIRequired"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|str
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/HomeOIList/<X+>/HomeOIRequired = '%s'"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
continue|continue;
name|required
operator|=
name|strcasecmp
argument_list|(
name|str
argument_list|,
literal|"true"
argument_list|)
operator|==
literal|0
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown HomeOIList node '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|homeoi
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/HomeOIList/<X+> without HomeOI ignored"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/HomeOIList/<X+> '%s' required=%d"
argument_list|,
name|homeoi
argument_list|,
name|required
argument_list|)
expr_stmt|;
if|if
condition|(
name|required
condition|)
block|{
if|if
condition|(
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"required_roaming_consortium"
argument_list|,
name|homeoi
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred required_roaming_consortium"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"roaming_consortium"
argument_list|,
name|homeoi
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred roaming_consortium"
argument_list|)
expr_stmt|;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|homeoi
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp_oi_list
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/HomeOIList"
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|set_pps_cred_home_sp_oi
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp_other_partner
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|fqdn
init|=
name|NULL
decl_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"FQDN"
argument_list|)
operator|==
literal|0
operator|&&
operator|!
name|fqdn
condition|)
block|{
name|fqdn
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/OtherHomePartners/<X+>/FQDN = %s"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown OtherHomePartners node '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fqdn
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/OtherHomePartners/<X+> without FQDN ignored"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"domain"
argument_list|,
name|fqdn
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred domain for OtherHomePartners node"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp_other_partners
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/OtherHomePartners"
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|set_pps_cred_home_sp_other_partner
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp_roaming_consortium_oi
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP/RoamingConsortiumOI = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
comment|/* TODO: Set to wpa_supplicant */
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_home_sp
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- HomeSP"
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"NetworkID"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_home_sp_network_ids
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"FriendlyName"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_home_sp_friendly_name
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"IconURL"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_home_sp_icon_url
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"FQDN"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_home_sp_fqdn
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"HomeOIList"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_home_sp_oi_list
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"OtherHomePartners"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_home_sp_other_partners
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"RoamingConsortiumOI"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_home_sp_roaming_consortium_oi
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown HomeSP node '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_sub_params
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- SubscriptionParameters"
argument_list|)
expr_stmt|;
comment|/* not used within wpa_supplicant */
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_creation_date
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/CreationDate = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
comment|/* not used within wpa_supplicant */
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_expiration_date
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/ExpirationDate = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
comment|/* not used within wpa_supplicant */
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_username
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/UsernamePassword/Username = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"username"
argument_list|,
name|str
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred username"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_password
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|int
name|len
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|pw
decl_stmt|,
modifier|*
name|hex
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|pw
operator|=
name|xml_node_get_base64_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pw
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/UsernamePassword/Password = %s"
argument_list|,
name|pw
argument_list|)
expr_stmt|;
name|hex
operator|=
name|malloc
argument_list|(
name|len
operator|*
literal|2
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|hex
operator|==
name|NULL
condition|)
block|{
name|free
argument_list|(
name|pw
argument_list|)
expr_stmt|;
return|return;
block|}
name|end
operator|=
name|hex
operator|+
name|len
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
name|pos
operator|=
name|hex
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"%02x"
argument_list|,
name|pw
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
block|}
name|free
argument_list|(
name|pw
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"password"
argument_list|,
name|hex
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred password"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|hex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_machine_managed
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/UsernamePassword/MachineManaged = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
comment|/* not used within wpa_supplicant */
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_soft_token_app
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/UsernamePassword/SoftTokenApp = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
comment|/* not used within wpa_supplicant */
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_able_to_share
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/UsernamePassword/AbleToShare = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
comment|/* not used within wpa_supplicant */
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_eap_method
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/UsernamePassword/EAPMethod - TODO"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_username_password
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/UsernamePassword"
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Username"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_username
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Password"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_password
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"MachineManaged"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_machine_managed
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"SoftTokenApp"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_soft_token_app
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"AbleToShare"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_able_to_share
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"EAPMethod"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_eap_method
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown Credential/UsernamePassword node '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_digital_cert
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|)
block|{
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|,
name|dir
index|[
literal|200
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/DigitalCertificate"
argument_list|)
expr_stmt|;
if|if
condition|(
name|getcwd
argument_list|(
name|dir
argument_list|,
sizeof|sizeof
argument_list|(
name|dir
argument_list|)
argument_list|)
operator|==
name|NULL
condition|)
return|return;
comment|/* TODO: could build username from Subject of Subject AltName */
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"username"
argument_list|,
literal|"cert"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set username"
argument_list|)
expr_stmt|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s/SP/%s/client-cert.pem"
argument_list|,
name|dir
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_file_exists
argument_list|(
name|buf
argument_list|)
condition|)
block|{
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"client_cert"
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set client_cert"
argument_list|)
expr_stmt|;
block|}
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s/SP/%s/client-key.pem"
argument_list|,
name|dir
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_file_exists
argument_list|(
name|buf
argument_list|)
condition|)
block|{
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"private_key"
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set private_key"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_realm
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|,
name|int
name|sim
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|,
name|dir
index|[
literal|200
index|]
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/Realm = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"realm"
argument_list|,
name|str
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred realm"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|sim
condition|)
return|return;
if|if
condition|(
name|getcwd
argument_list|(
name|dir
argument_list|,
sizeof|sizeof
argument_list|(
name|dir
argument_list|)
argument_list|)
operator|==
name|NULL
condition|)
return|return;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s/SP/%s/aaa-ca.pem"
argument_list|,
name|dir
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_file_exists
argument_list|(
name|buf
argument_list|)
condition|)
block|{
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"ca_cert"
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set CA cert"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_check_aaa_cert_status
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
decl_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential/CheckAAAServerCertStatus = %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|str
argument_list|,
literal|"true"
argument_list|)
operator|==
literal|0
operator|&&
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"ocsp"
argument_list|,
literal|"2"
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set cred ocsp"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_sim
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|sim
parameter_list|,
name|xml_node_t
modifier|*
name|realm
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|char
modifier|*
name|imsi
decl_stmt|,
modifier|*
name|eaptype
decl_stmt|,
modifier|*
name|str
decl_stmt|,
name|buf
index|[
literal|20
index|]
decl_stmt|;
name|int
name|type
decl_stmt|;
name|int
name|mnc_len
init|=
literal|3
decl_stmt|;
name|size_t
name|imsi_len
decl_stmt|;
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|sim
argument_list|,
literal|"EAPType"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No SIM/EAPType node in credential"
argument_list|)
expr_stmt|;
return|return;
block|}
name|eaptype
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|eaptype
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not extract SIM/EAPType"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|" - Credential/SIM/EAPType = %s"
argument_list|,
name|eaptype
argument_list|)
expr_stmt|;
name|type
operator|=
name|atoi
argument_list|(
name|eaptype
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|eaptype
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|EAP_TYPE_SIM
case|:
if|if
condition|(
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"eap"
argument_list|,
literal|"SIM"
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not set eap=SIM"
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_TYPE_AKA
case|:
if|if
condition|(
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"eap"
argument_list|,
literal|"AKA"
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not set eap=SIM"
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_TYPE_AKA_PRIME
case|:
if|if
condition|(
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"eap"
argument_list|,
literal|"AKA'"
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not set eap=SIM"
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unsupported SIM/EAPType %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return;
block|}
name|node
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|sim
argument_list|,
literal|"IMSI"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No SIM/IMSI node in credential"
argument_list|)
expr_stmt|;
return|return;
block|}
name|imsi
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|imsi
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not extract SIM/IMSI"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|" - Credential/SIM/IMSI = %s"
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
name|imsi_len
operator|=
name|os_strlen
argument_list|(
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|imsi_len
operator|<
literal|7
operator|||
name|imsi_len
operator|+
literal|2
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Invalid IMSI length"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
return|return;
block|}
name|str
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
condition|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|str
argument_list|,
literal|"mnc"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|&&
name|os_strlen
argument_list|(
name|pos
argument_list|)
operator|>=
literal|6
condition|)
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|imsi
operator|+
literal|3
argument_list|,
name|pos
operator|+
literal|3
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
name|mnc_len
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|imsi
operator|+
literal|3
argument_list|,
name|pos
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|mnc_len
operator|=
literal|2
expr_stmt|;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|imsi
argument_list|,
literal|3
operator|+
name|mnc_len
argument_list|)
expr_stmt|;
name|buf
index|[
literal|3
operator|+
name|mnc_len
index|]
operator|=
literal|'-'
expr_stmt|;
name|os_strlcpy
argument_list|(
name|buf
operator|+
literal|3
operator|+
name|mnc_len
operator|+
literal|1
argument_list|,
name|imsi
operator|+
literal|3
operator|+
name|mnc_len
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
literal|3
operator|-
name|mnc_len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"imsi"
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not set IMSI"
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"milenage"
argument_list|,
literal|"90dca4eda45b53cf0f12d7c9c3bc6a89:"
literal|"cb9cccc4b9258e6dca4760379fb82581:000000000123"
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not set Milenage parameters"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_cred_credential
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|,
modifier|*
name|sim
decl_stmt|,
modifier|*
name|realm
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- Credential"
argument_list|)
expr_stmt|;
name|sim
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"SIM"
argument_list|)
expr_stmt|;
name|realm
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|,
literal|"Realm"
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"CreationDate"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_creation_date
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"ExpirationDate"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_expiration_date
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"UsernamePassword"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_username_password
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"DigitalCertificate"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_digital_cert
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Realm"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_realm
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|,
name|fqdn
argument_list|,
name|sim
operator|!=
name|NULL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"CheckAAAServerCertStatus"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_check_aaa_cert_status
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"SIM"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_sim
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|,
name|realm
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown Credential node '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps_credential
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|id
parameter_list|,
name|xml_node_t
modifier|*
name|cred
parameter_list|,
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|cred
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Policy"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_policy
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"CredentialPriority"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_priority
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"AAAServerTrustRoot"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_aaa_server_trust_root
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"SubscriptionUpdate"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_sub_update
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"HomeSP"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_home_sp
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"SubscriptionParameters"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_sub_params
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"Credential"
argument_list|)
operator|==
literal|0
condition|)
name|set_pps_cred_credential
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown credential node '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|set_pps
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|pps
parameter_list|,
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|id
decl_stmt|;
name|char
modifier|*
name|update_identifier
init|=
name|NULL
decl_stmt|;
comment|/* 	 * TODO: Could consider more complex mechanism that would remove 	 * credentials only if there are changes in the information sent to 	 * wpa_supplicant. 	 */
name|remove_sp_creds
argument_list|(
name|ctx
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|pps
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"UpdateIdentifier"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|update_identifier
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|update_identifier
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"- UpdateIdentifier = %s"
argument_list|,
name|update_identifier
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
name|xml_node_for_each_child
argument_list|(
argument|ctx->xml
argument_list|,
argument|child
argument_list|,
argument|pps
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
literal|"UpdateIdentifier"
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|id
operator|=
name|add_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to add credential to wpa_supplicant"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Failed to add credential to wpa_supplicant"
argument_list|)
expr_stmt|;
break|break;
block|}
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Add a credential to wpa_supplicant"
argument_list|)
expr_stmt|;
if|if
condition|(
name|update_identifier
operator|&&
name|set_cred
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"update_identifier"
argument_list|,
name|update_identifier
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set update_identifier"
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_cred_quoted
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
name|id
argument_list|,
literal|"provisioning_sp"
argument_list|,
name|fqdn
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set provisioning_sp"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"credential localname: '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|set_pps_credential
argument_list|(
name|ctx
argument_list|,
name|id
argument_list|,
name|child
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|pps_cred_set
operator|=
literal|1
expr_stmt|;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|update_identifier
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|cmd_set_pps
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|pps
decl_stmt|;
specifier|const
name|char
modifier|*
name|fqdn
decl_stmt|;
name|char
modifier|*
name|fqdn_buf
init|=
name|NULL
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|pps
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not read or parse '%s'"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
return|return;
block|}
name|fqdn
operator|=
name|os_strstr
argument_list|(
name|pps_fname
argument_list|,
literal|"SP/"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fqdn
condition|)
block|{
name|fqdn_buf
operator|=
name|os_strdup
argument_list|(
name|fqdn
operator|+
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|fqdn_buf
operator|==
name|NULL
condition|)
return|return;
name|pos
operator|=
name|os_strchr
argument_list|(
name|fqdn_buf
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|fqdn
operator|=
name|fqdn_buf
expr_stmt|;
block|}
else|else
name|fqdn
operator|=
literal|"wi-fi.org"
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Set PPS MO info to wpa_supplicant - SP FQDN %s"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
name|set_pps
argument_list|(
name|ctx
argument_list|,
name|pps
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|fqdn_buf
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_get_fqdn
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|pps
decl_stmt|,
modifier|*
name|node
decl_stmt|;
name|char
modifier|*
name|fqdn
init|=
name|NULL
decl_stmt|;
name|pps
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not read or parse '%s'"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"HomeSP/FQDN"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
name|fqdn
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
if|if
condition|(
name|fqdn
condition|)
block|{
name|FILE
modifier|*
name|f
init|=
name|fopen
argument_list|(
literal|"pps-fqdn"
argument_list|,
literal|"w"
argument_list|)
decl_stmt|;
if|if
condition|(
name|f
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s"
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|fqdn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cmd_to_tnds
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|in_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|out_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|urn
parameter_list|,
name|int
name|use_path
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|mo
decl_stmt|,
modifier|*
name|node
decl_stmt|;
name|mo
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|in_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|mo
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not read or parse '%s'"
argument_list|,
name|in_fname
argument_list|)
expr_stmt|;
return|return;
block|}
name|node
operator|=
name|mo_to_tnds
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|mo
argument_list|,
name|use_path
argument_list|,
name|urn
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
name|node_to_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|out_fname
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
block|}
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|mo
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|cmd_from_tnds
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|in_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|out_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|tnds
decl_stmt|,
modifier|*
name|mo
decl_stmt|;
name|tnds
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|in_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|tnds
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not read or parse '%s'"
argument_list|,
name|in_fname
argument_list|)
expr_stmt|;
return|return;
block|}
name|mo
operator|=
name|tnds_to_mo
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
if|if
condition|(
name|mo
condition|)
block|{
name|node_to_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|out_fname
argument_list|,
name|mo
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|mo
argument_list|)
expr_stmt|;
block|}
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|osu_icon
block|{
name|int
name|id
decl_stmt|;
name|char
name|lang
index|[
literal|4
index|]
decl_stmt|;
name|char
name|mime_type
index|[
literal|256
index|]
decl_stmt|;
name|char
name|filename
index|[
literal|256
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|osu_data
block|{
name|char
name|bssid
index|[
literal|20
index|]
decl_stmt|;
name|char
name|url
index|[
literal|256
index|]
decl_stmt|;
name|unsigned
name|int
name|methods
decl_stmt|;
name|char
name|osu_ssid
index|[
literal|33
index|]
decl_stmt|;
name|char
name|osu_nai
index|[
literal|256
index|]
decl_stmt|;
name|struct
name|osu_lang_text
name|friendly_name
index|[
name|MAX_OSU_VALS
index|]
decl_stmt|;
name|size_t
name|friendly_name_count
decl_stmt|;
name|struct
name|osu_lang_text
name|serv_desc
index|[
name|MAX_OSU_VALS
index|]
decl_stmt|;
name|size_t
name|serv_desc_count
decl_stmt|;
name|struct
name|osu_icon
name|icon
index|[
name|MAX_OSU_VALS
index|]
decl_stmt|;
name|size_t
name|icon_count
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|struct
name|osu_data
modifier|*
name|parse_osu_providers
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|size_t
modifier|*
name|count
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|1000
index|]
decl_stmt|;
name|struct
name|osu_data
modifier|*
name|osu
init|=
name|NULL
decl_stmt|,
modifier|*
name|last
init|=
name|NULL
decl_stmt|;
name|size_t
name|osu_count
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not open %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
name|pos
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"OSU-PROVIDER "
argument_list|,
literal|13
argument_list|)
operator|==
literal|0
condition|)
block|{
name|last
operator|=
name|realloc
argument_list|(
name|osu
argument_list|,
operator|(
name|osu_count
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
operator|*
name|osu
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|last
operator|==
name|NULL
condition|)
break|break;
name|osu
operator|=
name|last
expr_stmt|;
name|last
operator|=
operator|&
name|osu
index|[
name|osu_count
operator|++
index|]
expr_stmt|;
name|memset
argument_list|(
name|last
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|last
argument_list|)
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|last
operator|->
name|bssid
argument_list|,
sizeof|sizeof
argument_list|(
name|last
operator|->
name|bssid
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|buf
operator|+
literal|13
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|last
condition|)
continue|continue;
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"uri="
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|last
operator|->
name|url
argument_list|,
sizeof|sizeof
argument_list|(
name|last
operator|->
name|url
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|buf
operator|+
literal|4
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"methods="
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|last
operator|->
name|methods
operator|=
name|strtol
argument_list|(
name|buf
operator|+
literal|8
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"osu_ssid="
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|last
operator|->
name|osu_ssid
argument_list|,
sizeof|sizeof
argument_list|(
name|last
operator|->
name|osu_ssid
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|buf
operator|+
literal|9
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"osu_nai="
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_snprintf
argument_list|(
name|last
operator|->
name|osu_nai
argument_list|,
sizeof|sizeof
argument_list|(
name|last
operator|->
name|osu_nai
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|buf
operator|+
literal|8
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"friendly_name="
argument_list|,
literal|14
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|osu_lang_text
modifier|*
name|txt
decl_stmt|;
if|if
condition|(
name|last
operator|->
name|friendly_name_count
operator|==
name|MAX_OSU_VALS
condition|)
continue|continue;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
operator|+
literal|14
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
continue|continue;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|txt
operator|=
operator|&
name|last
operator|->
name|friendly_name
index|[
name|last
operator|->
name|friendly_name_count
operator|++
index|]
expr_stmt|;
name|snprintf
argument_list|(
name|txt
operator|->
name|lang
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
operator|->
name|lang
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|buf
operator|+
literal|14
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|txt
operator|->
name|text
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
operator|->
name|text
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"desc="
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|osu_lang_text
modifier|*
name|txt
decl_stmt|;
if|if
condition|(
name|last
operator|->
name|serv_desc_count
operator|==
name|MAX_OSU_VALS
condition|)
continue|continue;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
operator|+
literal|5
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
continue|continue;
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|txt
operator|=
operator|&
name|last
operator|->
name|serv_desc
index|[
name|last
operator|->
name|serv_desc_count
operator|++
index|]
expr_stmt|;
name|snprintf
argument_list|(
name|txt
operator|->
name|lang
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
operator|->
name|lang
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|buf
operator|+
literal|5
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|txt
operator|->
name|text
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
operator|->
name|text
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"icon="
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|osu_icon
modifier|*
name|icon
decl_stmt|;
if|if
condition|(
name|last
operator|->
name|icon_count
operator|==
name|MAX_OSU_VALS
condition|)
continue|continue;
name|icon
operator|=
operator|&
name|last
operator|->
name|icon
index|[
name|last
operator|->
name|icon_count
operator|++
index|]
expr_stmt|;
name|icon
operator|->
name|id
operator|=
name|atoi
argument_list|(
name|buf
operator|+
literal|5
argument_list|)
expr_stmt|;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
continue|continue;
name|pos
operator|=
name|strchr
argument_list|(
name|pos
operator|+
literal|1
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
continue|continue;
name|pos
operator|=
name|strchr
argument_list|(
name|pos
operator|+
literal|1
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
continue|continue;
name|pos
operator|++
expr_stmt|;
name|end
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|end
condition|)
continue|continue;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|snprintf
argument_list|(
name|icon
operator|->
name|lang
argument_list|,
sizeof|sizeof
argument_list|(
name|icon
operator|->
name|lang
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|=
name|end
operator|+
literal|1
expr_stmt|;
name|end
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|snprintf
argument_list|(
name|icon
operator|->
name|mime_type
argument_list|,
sizeof|sizeof
argument_list|(
name|icon
operator|->
name|mime_type
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
continue|continue;
name|pos
operator|=
name|end
operator|+
literal|1
expr_stmt|;
name|end
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|snprintf
argument_list|(
name|icon
operator|->
name|filename
argument_list|,
sizeof|sizeof
argument_list|(
name|icon
operator|->
name|filename
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
continue|continue;
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
operator|*
name|count
operator|=
name|osu_count
expr_stmt|;
return|return
name|osu
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|osu_connect
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|bssid
parameter_list|,
specifier|const
name|char
modifier|*
name|ssid
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|unsigned
name|int
name|methods
parameter_list|,
name|int
name|no_prod_assoc
parameter_list|,
specifier|const
name|char
modifier|*
name|osu_nai
parameter_list|)
block|{
name|int
name|id
decl_stmt|;
specifier|const
name|char
modifier|*
name|ifname
init|=
name|ctx
operator|->
name|ifname
decl_stmt|;
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|;
name|struct
name|wpa_ctrl
modifier|*
name|mon
decl_stmt|;
name|int
name|res
decl_stmt|;
name|id
operator|=
name|add_network
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|set_network_quoted
argument_list|(
name|ifname
argument_list|,
name|id
argument_list|,
literal|"ssid"
argument_list|,
name|ssid
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|osu_nai
operator|&&
name|os_strlen
argument_list|(
name|osu_nai
argument_list|)
operator|>
literal|0
condition|)
block|{
name|char
name|dir
index|[
literal|255
index|]
decl_stmt|,
name|fname
index|[
literal|300
index|]
decl_stmt|;
if|if
condition|(
name|getcwd
argument_list|(
name|dir
argument_list|,
sizeof|sizeof
argument_list|(
name|dir
argument_list|)
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"%s/osu-ca.pem"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|set_network
argument_list|(
name|ifname
argument_list|,
name|id
argument_list|,
literal|"proto"
argument_list|,
literal|"OSEN"
argument_list|)
operator|<
literal|0
operator|||
name|set_network
argument_list|(
name|ifname
argument_list|,
name|id
argument_list|,
literal|"key_mgmt"
argument_list|,
literal|"OSEN"
argument_list|)
operator|<
literal|0
operator|||
name|set_network
argument_list|(
name|ifname
argument_list|,
name|id
argument_list|,
literal|"pairwise"
argument_list|,
literal|"CCMP"
argument_list|)
operator|<
literal|0
operator|||
name|set_network
argument_list|(
name|ifname
argument_list|,
name|id
argument_list|,
literal|"group"
argument_list|,
literal|"GTK_NOT_USED"
argument_list|)
operator|<
literal|0
operator|||
name|set_network
argument_list|(
name|ifname
argument_list|,
name|id
argument_list|,
literal|"eap"
argument_list|,
literal|"WFA-UNAUTH-TLS"
argument_list|)
operator|<
literal|0
operator|||
name|set_network
argument_list|(
name|ifname
argument_list|,
name|id
argument_list|,
literal|"ocsp"
argument_list|,
literal|"2"
argument_list|)
operator|<
literal|0
operator|||
name|set_network_quoted
argument_list|(
name|ifname
argument_list|,
name|id
argument_list|,
literal|"identity"
argument_list|,
name|osu_nai
argument_list|)
operator|<
literal|0
operator|||
name|set_network_quoted
argument_list|(
name|ifname
argument_list|,
name|id
argument_list|,
literal|"ca_cert"
argument_list|,
name|fname
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|set_network
argument_list|(
name|ifname
argument_list|,
name|id
argument_list|,
literal|"key_mgmt"
argument_list|,
literal|"NONE"
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|mon
operator|=
name|open_wpa_mon
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|mon
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Associate with OSU SSID"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Associate with OSU SSID"
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"SELECT_NETWORK %d"
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ifname
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|get_wpa_cli_event
argument_list|(
name|mon
argument_list|,
literal|"CTRL-EVENT-CONNECTED"
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_ctrl_detach
argument_list|(
name|mon
argument_list|)
expr_stmt|;
name|wpa_ctrl_close
argument_list|(
name|mon
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not connect"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Could not connect to OSU network"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Remove OSU network connection"
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"REMOVE_NETWORK %d"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpa_command
argument_list|(
name|ifname
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Waiting for IP address for subscription registration"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait_ip_addr
argument_list|(
name|ifname
argument_list|,
literal|15
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get IP address for WLAN - try connection anyway"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|no_prod_assoc
condition|)
block|{
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No production connection used for testing purposes"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"No production connection used for testing purposes"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ctx
operator|->
name|no_reconnect
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|methods
operator|&
literal|0x02
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Calling cmd_prov from osu_connect"
argument_list|)
expr_stmt|;
name|res
operator|=
name|cmd_prov
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|methods
operator|&
literal|0x01
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Calling cmd_oma_dm_prov from osu_connect"
argument_list|)
expr_stmt|;
name|res
operator|=
name|cmd_oma_dm_prov
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Remove OSU network connection"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Remove OSU network connection"
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"REMOVE_NETWORK %d"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpa_command
argument_list|(
name|ifname
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Requesting reconnection with updated configuration"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Requesting reconnection with updated configuration"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|"INTERWORKING_SELECT auto"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Failed to request wpa_supplicant to reconnect"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_osu_select
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|dir
parameter_list|,
name|int
name|connect
parameter_list|,
name|int
name|no_prod_assoc
parameter_list|,
specifier|const
name|char
modifier|*
name|friendly_name
parameter_list|)
block|{
name|char
name|fname
index|[
literal|255
index|]
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|osu_data
modifier|*
name|osu
init|=
name|NULL
decl_stmt|,
modifier|*
name|last
init|=
name|NULL
decl_stmt|;
name|size_t
name|osu_count
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"OSU provider selection"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Missing dir parameter to osu_select"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"%s/osu-providers.txt"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
name|osu
operator|=
name|parse_osu_providers
argument_list|(
name|fname
argument_list|,
operator|&
name|osu_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|osu
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not find any OSU providers from %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"No OSU providers available"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|friendly_name
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|osu_count
condition|;
name|i
operator|++
control|)
block|{
name|last
operator|=
operator|&
name|osu
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|last
operator|->
name|friendly_name_count
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|last
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|text
argument_list|,
name|friendly_name
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|j
operator|<
name|last
operator|->
name|friendly_name_count
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|osu_count
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Requested operator friendly name '%s' not found in the list of available providers"
argument_list|,
name|friendly_name
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Requested operator friendly name '%s' not found in the list of available providers"
argument_list|,
name|friendly_name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|osu
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OSU Provider selected based on requested operator friendly name '%s'"
argument_list|,
name|friendly_name
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"OSU Provider selected based on requested operator friendly name '%s'"
argument_list|,
name|friendly_name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|i
operator|+
literal|1
expr_stmt|;
goto|goto
name|selected
goto|;
block|}
name|snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"%s/osu-providers.html"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not open %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|osu
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"<html><head>"
literal|"<meta http-equiv=\"Content-type\" content=\"text/html; "
literal|"charset=utf-8\"<title>Select service operator</title>"
literal|"</head><body><h1>Select service operator</h1>\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|osu_count
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"No online signup available\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|osu_count
condition|;
name|i
operator|++
control|)
block|{
name|last
operator|=
operator|&
name|osu
index|[
name|i
index|]
expr_stmt|;
ifdef|#
directive|ifdef
name|ANDROID
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"<p>\n"
literal|"<a href=\"http://localhost:12345/osu/%d\">"
literal|"<table><tr><td>"
argument_list|,
operator|(
name|int
operator|)
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* ANDROID */
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"<p>\n"
literal|"<a href=\"osu://%d\">"
literal|"<table><tr><td>"
argument_list|,
operator|(
name|int
operator|)
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* ANDROID */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|last
operator|->
name|icon_count
condition|;
name|j
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"<img src=\"osu-icon-%d.%s\">\n"
argument_list|,
name|last
operator|->
name|icon
index|[
name|j
index|]
operator|.
name|id
argument_list|,
name|strcasecmp
argument_list|(
name|last
operator|->
name|icon
index|[
name|j
index|]
operator|.
name|mime_type
argument_list|,
literal|"image/png"
argument_list|)
operator|==
literal|0
condition|?
literal|"png"
else|:
literal|"icon"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"<td>"
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|last
operator|->
name|friendly_name_count
condition|;
name|j
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"<small>[%s]</small> %s<br>\n"
argument_list|,
name|last
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|lang
argument_list|,
name|last
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|text
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"<tr><td colspan=2>"
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|last
operator|->
name|serv_desc_count
condition|;
name|j
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"<small>[%s]</small> %s<br>\n"
argument_list|,
name|last
operator|->
name|serv_desc
index|[
name|j
index|]
operator|.
name|lang
argument_list|,
name|last
operator|->
name|serv_desc
index|[
name|j
index|]
operator|.
name|text
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"</table></a><br><small>BSSID: %s<br>\n"
literal|"SSID: %s<br>\n"
argument_list|,
name|last
operator|->
name|bssid
argument_list|,
name|last
operator|->
name|osu_ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|last
operator|->
name|osu_nai
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"NAI: %s<br>\n"
argument_list|,
name|last
operator|->
name|osu_nai
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"URL: %s<br>\n"
literal|"methods:%s%s<br>\n"
literal|"</small></p>\n"
argument_list|,
name|last
operator|->
name|url
argument_list|,
name|last
operator|->
name|methods
operator|&
literal|0x01
condition|?
literal|" OMA-DM"
else|:
literal|""
argument_list|,
name|last
operator|->
name|methods
operator|&
literal|0x02
condition|?
literal|" SOAP-XML-SPP"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"</body></html>\n"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"file://%s/osu-providers.html"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Start web browser with OSU provider selection page"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hs20_web_browser
argument_list|(
name|fname
argument_list|)
expr_stmt|;
name|selected
label|:
if|if
condition|(
name|ret
operator|>
literal|0
operator|&&
operator|(
name|size_t
operator|)
name|ret
operator|<=
name|osu_count
condition|)
block|{
name|char
modifier|*
name|data
decl_stmt|;
name|size_t
name|data_len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Selected OSU id=%d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|last
operator|=
operator|&
name|osu
index|[
name|ret
operator|-
literal|1
index|]
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"BSSID: %s"
argument_list|,
name|last
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SSID: %s"
argument_list|,
name|last
operator|->
name|osu_ssid
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"URL: %s"
argument_list|,
name|last
operator|->
name|url
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Selected OSU provider id=%d BSSID=%s SSID=%s URL=%s"
argument_list|,
name|ret
argument_list|,
name|last
operator|->
name|bssid
argument_list|,
name|last
operator|->
name|osu_ssid
argument_list|,
name|last
operator|->
name|url
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|friendly_name_count
operator|=
name|last
operator|->
name|friendly_name_count
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|last
operator|->
name|friendly_name_count
condition|;
name|j
operator|++
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"FRIENDLY_NAME: [%s]%s"
argument_list|,
name|last
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|lang
argument_list|,
name|last
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|text
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ctx
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|lang
argument_list|,
name|last
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|lang
argument_list|,
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|lang
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ctx
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|text
argument_list|,
name|last
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|text
argument_list|,
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|text
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|->
name|icon_count
operator|=
name|last
operator|->
name|icon_count
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|last
operator|->
name|icon_count
condition|;
name|j
operator|++
control|)
block|{
name|char
name|fname
index|[
literal|256
index|]
decl_stmt|;
name|os_snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"%s/osu-icon-%d.%s"
argument_list|,
name|dir
argument_list|,
name|last
operator|->
name|icon
index|[
name|j
index|]
operator|.
name|id
argument_list|,
name|strcasecmp
argument_list|(
name|last
operator|->
name|icon
index|[
name|j
index|]
operator|.
name|mime_type
argument_list|,
literal|"image/png"
argument_list|)
operator|==
literal|0
condition|?
literal|"png"
else|:
literal|"icon"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ICON: %s (%s)"
argument_list|,
name|fname
argument_list|,
name|last
operator|->
name|icon
index|[
name|j
index|]
operator|.
name|filename
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ctx
operator|->
name|icon_filename
index|[
name|j
index|]
argument_list|,
name|last
operator|->
name|icon
index|[
name|j
index|]
operator|.
name|filename
argument_list|,
sizeof|sizeof
argument_list|(
name|ctx
operator|->
name|icon_filename
index|[
name|j
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|=
name|os_readfile
argument_list|(
name|fname
argument_list|,
operator|&
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|sha256_vector
argument_list|(
literal|1
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|*
operator|)
operator|&
name|data
argument_list|,
operator|&
name|data_len
argument_list|,
name|ctx
operator|->
name|icon_hash
index|[
name|j
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|connect
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|last
operator|->
name|methods
operator|&
literal|0x02
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Calling cmd_prov from cmd_osu_select"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cmd_prov
argument_list|(
name|ctx
argument_list|,
name|last
operator|->
name|url
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|last
operator|->
name|methods
operator|&
literal|0x01
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Calling cmd_oma_dm_prov from cmd_osu_select"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|cmd_oma_dm_prov
argument_list|(
name|ctx
argument_list|,
name|last
operator|->
name|url
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No supported OSU provisioning method"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|connect
condition|)
name|ret
operator|=
name|osu_connect
argument_list|(
name|ctx
argument_list|,
name|last
operator|->
name|bssid
argument_list|,
name|last
operator|->
name|osu_ssid
argument_list|,
name|last
operator|->
name|url
argument_list|,
name|last
operator|->
name|methods
argument_list|,
name|no_prod_assoc
argument_list|,
name|last
operator|->
name|osu_nai
argument_list|)
expr_stmt|;
block|}
else|else
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|free
argument_list|(
name|osu
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_signup
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
name|int
name|no_prod_assoc
parameter_list|,
specifier|const
name|char
modifier|*
name|friendly_name
parameter_list|)
block|{
name|char
name|dir
index|[
literal|255
index|]
decl_stmt|;
name|char
name|fname
index|[
literal|300
index|]
decl_stmt|,
name|buf
index|[
literal|400
index|]
decl_stmt|;
name|struct
name|wpa_ctrl
modifier|*
name|mon
decl_stmt|;
specifier|const
name|char
modifier|*
name|ifname
decl_stmt|;
name|int
name|res
decl_stmt|;
name|ifname
operator|=
name|ctx
operator|->
name|ifname
expr_stmt|;
if|if
condition|(
name|getcwd
argument_list|(
name|dir
argument_list|,
sizeof|sizeof
argument_list|(
name|dir
argument_list|)
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"%s/osu-info"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|mkdir
argument_list|(
name|fname
argument_list|,
name|S_IRWXU
operator||
name|S_IRWXG
argument_list|)
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|EEXIST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"mkdir(%s) failed: %s"
argument_list|,
name|fname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"SET osu_dir %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ifname
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to configure osu_dir to wpa_supplicant"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|mon
operator|=
name|open_wpa_mon
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|mon
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Starting OSU fetch"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Starting OSU provider information fetch"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_command
argument_list|(
name|ifname
argument_list|,
literal|"FETCH_OSU"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not start OSU fetch"
argument_list|)
expr_stmt|;
name|wpa_ctrl_detach
argument_list|(
name|mon
argument_list|)
expr_stmt|;
name|wpa_ctrl_close
argument_list|(
name|mon
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res
operator|=
name|get_wpa_cli_event
argument_list|(
name|mon
argument_list|,
literal|"OSU provider fetch completed"
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_ctrl_detach
argument_list|(
name|mon
argument_list|)
expr_stmt|;
name|wpa_ctrl_close
argument_list|(
name|mon
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OSU fetch did not complete"
argument_list|)
expr_stmt|;
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"OSU fetch did not complete"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OSU provider fetch completed"
argument_list|)
expr_stmt|;
return|return
name|cmd_osu_select
argument_list|(
name|ctx
argument_list|,
name|fname
argument_list|,
literal|1
argument_list|,
name|no_prod_assoc
argument_list|,
name|friendly_name
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_sub_rem
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|address
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|pps
decl_stmt|,
modifier|*
name|node
decl_stmt|;
name|char
name|pps_fname_buf
index|[
literal|300
index|]
decl_stmt|;
name|char
name|ca_fname_buf
index|[
literal|200
index|]
decl_stmt|;
name|char
modifier|*
name|cred_username
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|cred_password
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|sub_rem_uri
init|=
name|NULL
decl_stmt|;
name|char
name|client_cert_buf
index|[
literal|200
index|]
decl_stmt|;
name|char
modifier|*
name|client_cert
init|=
name|NULL
decl_stmt|;
name|char
name|client_key_buf
index|[
literal|200
index|]
decl_stmt|;
name|char
modifier|*
name|client_key
init|=
name|NULL
decl_stmt|;
name|int
name|spp
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Subscription remediation requested with Server URL: %s"
argument_list|,
name|address
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pps_fname
condition|)
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Determining PPS file based on Home SP information"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|address
argument_list|,
literal|"fqdn="
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Use requested FQDN from command line"
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|address
operator|+
literal|5
argument_list|)
expr_stmt|;
name|address
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|get_wpa_status
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|"provisioning_sp"
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get provisioning Home SP FQDN from wpa_supplicant"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|fqdn
operator|=
name|os_strdup
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|fqdn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Home SP FQDN for current credential: %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|pps_fname_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|pps_fname_buf
argument_list|)
argument_list|,
literal|"SP/%s/pps.xml"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|pps_fname
operator|=
name|pps_fname_buf
expr_stmt|;
name|os_snprintf
argument_list|(
name|ca_fname_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|ca_fname_buf
argument_list|)
argument_list|,
literal|"SP/%s/ca.pem"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|ca_fname
operator|=
name|ca_fname_buf
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|os_file_exists
argument_list|(
name|pps_fname
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PPS file '%s' does not exist or is not accessible"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Using PPS file: %s"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ca_fname
operator|&&
operator|!
name|os_file_exists
argument_list|(
name|ca_fname
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CA file '%s' does not exist or is not accessible"
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Using server trust root: %s"
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ca_fname
operator|=
name|ca_fname
expr_stmt|;
name|pps
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not read PPS MO"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|ctx
operator|->
name|fqdn
condition|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|;
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"HomeSP/FQDN"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No HomeSP/FQDN found from PPS"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tmp
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No HomeSP/FQDN text found from PPS"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ctx
operator|->
name|fqdn
operator|=
name|os_strdup
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctx
operator|->
name|fqdn
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No FQDN known"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"SubscriptionUpdate/UpdateMethod"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&&
name|os_strcasecmp
argument_list|(
name|tmp
argument_list|,
literal|"OMA-DM-ClientInitiated"
argument_list|)
operator|==
literal|0
condition|)
name|spp
operator|=
literal|0
expr_stmt|;
else|else
name|spp
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No UpdateMethod specified - assume SPP"
argument_list|)
expr_stmt|;
name|spp
operator|=
literal|1
expr_stmt|;
block|}
name|get_user_pw
argument_list|(
name|ctx
argument_list|,
name|pps
argument_list|,
literal|"SubscriptionUpdate/UsernamePassword"
argument_list|,
operator|&
name|cred_username
argument_list|,
operator|&
name|cred_password
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred_username
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Using username: %s"
argument_list|,
name|cred_username
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred_password
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Using password: %s"
argument_list|,
name|cred_password
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred_username
operator|==
name|NULL
operator|&&
name|cred_password
operator|==
name|NULL
operator|&&
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"Credential/DigitalCertificate"
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Using client certificate"
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|client_cert_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|client_cert_buf
argument_list|)
argument_list|,
literal|"SP/%s/client-cert.pem"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|client_cert
operator|=
name|client_cert_buf
expr_stmt|;
name|os_snprintf
argument_list|(
name|client_key_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|client_key_buf
argument_list|)
argument_list|,
literal|"SP/%s/client-key.pem"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|client_key
operator|=
name|client_key_buf
expr_stmt|;
name|ctx
operator|->
name|client_cert_present
operator|=
literal|1
expr_stmt|;
block|}
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"SubscriptionUpdate/URI"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
name|sub_rem_uri
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|sub_rem_uri
operator|&&
operator|(
operator|!
name|address
operator|||
name|os_strcmp
argument_list|(
name|address
argument_list|,
name|sub_rem_uri
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Override sub rem URI based on PPS: %s"
argument_list|,
name|sub_rem_uri
argument_list|)
expr_stmt|;
name|address
operator|=
name|sub_rem_uri
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|address
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Server URL not known"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|write_summary
argument_list|(
name|ctx
argument_list|,
literal|"Wait for IP address for subscriptiom remediation"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Wait for IP address before starting subscription remediation"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait_ip_addr
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|15
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get IP address for WLAN - try connection anyway"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|spp
condition|)
name|spp_sub_rem
argument_list|(
name|ctx
argument_list|,
name|address
argument_list|,
name|pps_fname
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|,
name|cred_username
argument_list|,
name|cred_password
argument_list|,
name|pps
argument_list|)
expr_stmt|;
else|else
name|oma_dm_sub_rem
argument_list|(
name|ctx
argument_list|,
name|address
argument_list|,
name|pps_fname
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|,
name|cred_username
argument_list|,
name|cred_password
argument_list|,
name|pps
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|sub_rem_uri
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|cred_username
argument_list|)
expr_stmt|;
name|str_clear_free
argument_list|(
name|cred_password
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmd_pol_upd
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|address
parameter_list|,
specifier|const
name|char
modifier|*
name|pps_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_fname
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|pps
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|char
name|pps_fname_buf
index|[
literal|300
index|]
decl_stmt|;
name|char
name|ca_fname_buf
index|[
literal|200
index|]
decl_stmt|;
name|char
modifier|*
name|uri
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|cred_username
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|cred_password
init|=
name|NULL
decl_stmt|;
name|char
name|client_cert_buf
index|[
literal|200
index|]
decl_stmt|;
name|char
modifier|*
name|client_cert
init|=
name|NULL
decl_stmt|;
name|char
name|client_key_buf
index|[
literal|200
index|]
decl_stmt|;
name|char
modifier|*
name|client_key
init|=
name|NULL
decl_stmt|;
name|int
name|spp
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Policy update requested"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pps_fname
condition|)
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Determining PPS file based on Home SP information"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|address
argument_list|,
literal|"fqdn="
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Use requested FQDN from command line"
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|address
operator|+
literal|5
argument_list|)
expr_stmt|;
name|address
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|get_wpa_status
argument_list|(
name|ctx
operator|->
name|ifname
argument_list|,
literal|"provisioning_sp"
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get provisioning Home SP FQDN from wpa_supplicant"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|fqdn
operator|=
name|os_strdup
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|fqdn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Home SP FQDN for current credential: %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|pps_fname_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|pps_fname_buf
argument_list|)
argument_list|,
literal|"SP/%s/pps.xml"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|pps_fname
operator|=
name|pps_fname_buf
expr_stmt|;
name|os_snprintf
argument_list|(
name|ca_fname_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|ca_fname_buf
argument_list|)
argument_list|,
literal|"SP/%s/ca.pem"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ca_fname
operator|=
name|ca_fname_buf
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|os_file_exists
argument_list|(
name|pps_fname
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PPS file '%s' does not exist or is not accessible"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Using PPS file: %s"
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ca_fname
operator|&&
operator|!
name|os_file_exists
argument_list|(
name|ca_fname
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CA file '%s' does not exist or is not accessible"
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Using server trust root: %s"
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ca_fname
operator|=
name|ca_fname
expr_stmt|;
name|pps
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps_fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not read PPS MO"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|ctx
operator|->
name|fqdn
condition|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|;
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"HomeSP/FQDN"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No HomeSP/FQDN found from PPS"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tmp
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No HomeSP/FQDN text found from PPS"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ctx
operator|->
name|fqdn
operator|=
name|os_strdup
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctx
operator|->
name|fqdn
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No FQDN known"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"Policy/PolicyUpdate/UpdateMethod"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|&&
name|os_strcasecmp
argument_list|(
name|tmp
argument_list|,
literal|"OMA-DM-ClientInitiated"
argument_list|)
operator|==
literal|0
condition|)
name|spp
operator|=
literal|0
expr_stmt|;
else|else
name|spp
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No UpdateMethod specified - assume SPP"
argument_list|)
expr_stmt|;
name|spp
operator|=
literal|1
expr_stmt|;
block|}
name|get_user_pw
argument_list|(
name|ctx
argument_list|,
name|pps
argument_list|,
literal|"Policy/PolicyUpdate/UsernamePassword"
argument_list|,
operator|&
name|cred_username
argument_list|,
operator|&
name|cred_password
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred_username
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Using username: %s"
argument_list|,
name|cred_username
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred_password
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Using password: %s"
argument_list|,
name|cred_password
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred_username
operator|==
name|NULL
operator|&&
name|cred_password
operator|==
name|NULL
operator|&&
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"Credential/DigitalCertificate"
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Using client certificate"
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|client_cert_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|client_cert_buf
argument_list|)
argument_list|,
literal|"SP/%s/client-cert.pem"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|client_cert
operator|=
name|client_cert_buf
expr_stmt|;
name|os_snprintf
argument_list|(
name|client_key_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|client_key_buf
argument_list|)
argument_list|,
literal|"SP/%s/client-key.pem"
argument_list|,
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|client_key
operator|=
name|client_key_buf
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|address
condition|)
block|{
name|node
operator|=
name|get_child_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|,
literal|"Policy/PolicyUpdate/URI"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
condition|)
block|{
name|uri
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"URI based on PPS: %s"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|address
operator|=
name|uri
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|address
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Server URL not known"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|spp
condition|)
name|spp_pol_upd
argument_list|(
name|ctx
argument_list|,
name|address
argument_list|,
name|pps_fname
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|,
name|cred_username
argument_list|,
name|cred_password
argument_list|,
name|pps
argument_list|)
expr_stmt|;
else|else
name|oma_dm_pol_upd
argument_list|(
name|ctx
argument_list|,
name|address
argument_list|,
name|pps_fname
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|,
name|cred_username
argument_list|,
name|cred_password
argument_list|,
name|pps
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|cred_username
argument_list|)
expr_stmt|;
name|str_clear_free
argument_list|(
name|cred_password
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|pps
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|get_hostname
parameter_list|(
specifier|const
name|char
modifier|*
name|url
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|end2
decl_stmt|;
name|char
modifier|*
name|ret
decl_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|url
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
literal|'/'
condition|)
return|return
name|NULL
return|;
name|pos
operator|++
expr_stmt|;
name|end
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
name|end2
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|end
operator|&&
name|end2
operator|&&
name|end2
operator|<
name|end
operator|)
operator|||
operator|(
operator|!
name|end
operator|&&
name|end2
operator|)
condition|)
name|end
operator|=
name|end2
expr_stmt|;
if|if
condition|(
name|end
condition|)
name|end
operator|--
expr_stmt|;
else|else
block|{
name|end
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|end
condition|)
name|end
operator|++
expr_stmt|;
if|if
condition|(
name|end
operator|>
name|pos
condition|)
name|end
operator|--
expr_stmt|;
block|}
name|ret
operator|=
name|os_malloc
argument_list|(
name|end
operator|-
name|pos
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|ret
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ret
index|[
name|end
operator|-
name|pos
operator|+
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|osu_cert_cb
parameter_list|(
name|void
modifier|*
name|_ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|cert
parameter_list|)
block|{
name|struct
name|hs20_osu_client
modifier|*
name|ctx
init|=
name|_ctx
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
name|found
decl_stmt|;
name|char
modifier|*
name|host
init|=
name|NULL
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"osu_cert_cb(osu_cert_validation=%d, url=%s)"
argument_list|,
operator|!
name|ctx
operator|->
name|no_osu_cert_validation
argument_list|,
name|ctx
operator|->
name|server_url
argument_list|)
expr_stmt|;
name|host
operator|=
name|get_hostname
argument_list|(
name|ctx
operator|->
name|server_url
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctx
operator|->
name|server_dnsname_count
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
name|ctx
operator|->
name|server_dnsname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|server_dnsname
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|server_dnsname
operator|=
name|os_calloc
argument_list|(
name|cert
operator|->
name|num_dnsname
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|server_dnsname_count
operator|=
literal|0
expr_stmt|;
name|found
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cert
operator|->
name|num_dnsname
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ctx
operator|->
name|server_dnsname
condition|)
block|{
name|ctx
operator|->
name|server_dnsname
index|[
name|ctx
operator|->
name|server_dnsname_count
index|]
operator|=
name|os_strdup
argument_list|(
name|cert
operator|->
name|dnsname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|server_dnsname
index|[
name|ctx
operator|->
name|server_dnsname_count
index|]
condition|)
name|ctx
operator|->
name|server_dnsname_count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|host
operator|&&
name|os_strcasecmp
argument_list|(
name|host
argument_list|,
name|cert
operator|->
name|dnsname
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
name|found
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"dNSName '%s'"
argument_list|,
name|cert
operator|->
name|dnsname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|host
operator|&&
operator|!
name|found
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Server name from URL (%s) did not match any dNSName - abort connection"
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"Server name from URL (%s) did not match any dNSName - abort connection"
argument_list|,
name|host
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|host
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|host
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cert
operator|->
name|num_othername
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|cert
operator|->
name|othername
index|[
name|i
index|]
operator|.
name|oid
argument_list|,
literal|"1.3.6.1.4.1.40808.1.1.1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_INFO
argument_list|,
literal|"id-wfa-hotspot-friendlyName"
argument_list|,
name|cert
operator|->
name|othername
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|cert
operator|->
name|othername
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
operator|!
name|ctx
operator|->
name|no_osu_cert_validation
operator|&&
name|j
operator|<
name|ctx
operator|->
name|friendly_name_count
condition|;
name|j
operator|++
control|)
block|{
name|int
name|found
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cert
operator|->
name|num_othername
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|cert
operator|->
name|othername
index|[
name|i
index|]
operator|.
name|oid
argument_list|,
literal|"1.3.6.1.4.1.40808.1.1.1"
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|cert
operator|->
name|othername
index|[
name|i
index|]
operator|.
name|len
operator|<
literal|3
condition|)
continue|continue;
if|if
condition|(
name|os_strncasecmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cert
operator|->
name|othername
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|ctx
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|lang
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|os_strncmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|cert
operator|->
name|othername
index|[
name|i
index|]
operator|.
name|data
operator|+
literal|3
argument_list|,
name|ctx
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|text
argument_list|,
name|cert
operator|->
name|othername
index|[
name|i
index|]
operator|.
name|len
operator|-
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No friendly name match found for '[%s]%s'"
argument_list|,
name|ctx
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|lang
argument_list|,
name|ctx
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|text
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"No friendly name match found for '[%s]%s'"
argument_list|,
name|ctx
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|lang
argument_list|,
name|ctx
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|text
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cert
operator|->
name|num_logo
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|http_logo
modifier|*
name|logo
init|=
operator|&
name|cert
operator|->
name|logo
index|[
name|i
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"logo hash alg %s uri '%s'"
argument_list|,
name|logo
operator|->
name|alg_oid
argument_list|,
name|logo
operator|->
name|uri
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_INFO
argument_list|,
literal|"hashValue"
argument_list|,
name|logo
operator|->
name|hash
argument_list|,
name|logo
operator|->
name|hash_len
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
operator|!
name|ctx
operator|->
name|no_osu_cert_validation
operator|&&
name|j
operator|<
name|ctx
operator|->
name|icon_count
condition|;
name|j
operator|++
control|)
block|{
name|int
name|found
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|name
init|=
name|ctx
operator|->
name|icon_filename
index|[
name|j
index|]
decl_stmt|;
name|size_t
name|name_len
init|=
name|os_strlen
argument_list|(
name|name
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[%i] Looking for icon file name '%s' match"
argument_list|,
name|j
argument_list|,
name|name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cert
operator|->
name|num_logo
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|http_logo
modifier|*
name|logo
init|=
operator|&
name|cert
operator|->
name|logo
index|[
name|i
index|]
decl_stmt|;
name|size_t
name|uri_len
init|=
name|os_strlen
argument_list|(
name|logo
operator|->
name|uri
argument_list|)
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[%i] Comparing to '%s' uri_len=%d name_len=%d"
argument_list|,
name|i
argument_list|,
name|logo
operator|->
name|uri
argument_list|,
operator|(
name|int
operator|)
name|uri_len
argument_list|,
operator|(
name|int
operator|)
name|name_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|uri_len
operator|<
literal|1
operator|+
name|name_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"URI Length is too short"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|pos
operator|=
operator|&
name|logo
operator|->
name|uri
index|[
name|uri_len
operator|-
name|name_len
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
literal|'/'
condition|)
continue|continue;
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|pos
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No icon filename match found for '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"No icon filename match found for '%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
operator|!
name|ctx
operator|->
name|no_osu_cert_validation
operator|&&
name|j
operator|<
name|ctx
operator|->
name|icon_count
condition|;
name|j
operator|++
control|)
block|{
name|int
name|found
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cert
operator|->
name|num_logo
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|http_logo
modifier|*
name|logo
init|=
operator|&
name|cert
operator|->
name|logo
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|logo
operator|->
name|hash_len
operator|!=
literal|32
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[%i][%i] Icon hash length invalid (should be 32): %d"
argument_list|,
name|j
argument_list|,
name|i
argument_list|,
operator|(
name|int
operator|)
name|logo
operator|->
name|hash_len
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|logo
operator|->
name|hash
argument_list|,
name|ctx
operator|->
name|icon_hash
index|[
name|j
index|]
argument_list|,
literal|32
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"[%u][%u] Icon hash did not match"
argument_list|,
name|j
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"logo->hash"
argument_list|,
name|logo
operator|->
name|hash
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ctx->icon_hash[j]"
argument_list|,
name|ctx
operator|->
name|icon_hash
index|[
name|j
index|]
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No icon hash match (by hash) found"
argument_list|)
expr_stmt|;
name|write_result
argument_list|(
name|ctx
argument_list|,
literal|"No icon hash match (by hash) found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|init_ctx
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|devinfo
decl_stmt|,
modifier|*
name|devid
decl_stmt|;
name|os_memset
argument_list|(
name|ctx
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|ifname
operator|=
literal|"wlan0"
expr_stmt|;
name|ctx
operator|->
name|xml
operator|=
name|xml_node_init_ctx
argument_list|(
name|ctx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|xml
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|devinfo
operator|=
name|node_from_file
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
literal|"devinfo.xml"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|devinfo
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"devinfo.xml not found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|devid
operator|=
name|get_node
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|devinfo
argument_list|,
literal|"DevId"
argument_list|)
expr_stmt|;
if|if
condition|(
name|devid
condition|)
block|{
name|char
modifier|*
name|tmp
init|=
name|xml_node_get_text
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|devid
argument_list|)
decl_stmt|;
if|if
condition|(
name|tmp
condition|)
block|{
name|ctx
operator|->
name|devid
operator|=
name|os_strdup
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
block|}
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|devinfo
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|devid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not fetch DevId from devinfo.xml"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ctx
operator|->
name|http
operator|=
name|http_init_ctx
argument_list|(
name|ctx
argument_list|,
name|ctx
operator|->
name|xml
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|http
operator|==
name|NULL
condition|)
block|{
name|xml_node_deinit_ctx
argument_list|(
name|ctx
operator|->
name|xml
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|http_ocsp_set
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|http_set_cert_cb
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
name|osu_cert_cb
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|deinit_ctx
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|http_deinit_ctx
argument_list|(
name|ctx
operator|->
name|http
argument_list|)
expr_stmt|;
name|xml_node_deinit_ctx
argument_list|(
name|ctx
operator|->
name|xml
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|fqdn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|server_url
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|devid
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ctx
operator|->
name|server_dnsname_count
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
name|ctx
operator|->
name|server_dnsname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|server_dnsname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|check_workarounds
parameter_list|(
name|struct
name|hs20_osu_client
modifier|*
name|ctx
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|unsigned
name|long
name|int
name|val
init|=
literal|0
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
literal|"hs20-osu-client.workarounds"
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
name|val
operator|=
name|strtoul
argument_list|(
name|buf
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Workarounds enabled: 0x%lx"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|workarounds
operator|=
name|val
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|workarounds
operator|&
name|WORKAROUND_OCSP_OPTIONAL
condition|)
name|http_ocsp_set
argument_list|(
name|ctx
operator|->
name|http
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"usage: hs20-osu-client [-dddqqKt] [-S<station ifname>] \\\n"
literal|"    [-w<wpa_supplicant ctrl_iface dir>] "
literal|"[-r<result file>] [-f<debug file>] \\\n"
literal|"    [-s<summary file>] \\\n"
literal|"    [-x<spp.xsd file name>] \\\n"
literal|"<command> [arguments..]\n"
literal|"commands:\n"
literal|"- to_tnds<XML MO><XML MO in TNDS format> [URN]\n"
literal|"- to_tnds2<XML MO><XML MO in TNDS format (Path) "
literal|"[URN]>\n"
literal|"- from_tnds<XML MO in TNDS format><XML MO>\n"
literal|"- set_pps<PerProviderSubscription XML file name>\n"
literal|"- get_fqdn<PerProviderSubscription XML file name>\n"
literal|"- pol_upd [Server URL] [PPS] [CA cert]\n"
literal|"- sub_rem<Server URL> [PPS] [CA cert]\n"
literal|"- prov<Server URL> [CA cert]\n"
literal|"- oma_dm_prov<Server URL> [CA cert]\n"
literal|"- sim_prov<Server URL> [CA cert]\n"
literal|"- oma_dm_sim_prov<Server URL> [CA cert]\n"
literal|"- signup [CA cert]\n"
literal|"- dl_osu_ca<PPS><CA file>\n"
literal|"- dl_polupd_ca<PPS><CA file>\n"
literal|"- dl_aaa_ca<PPS><CA file>\n"
literal|"- browser<URL>\n"
literal|"- parse_cert<X.509 certificate (DER)>\n"
literal|"- osu_select<OSU info directory> [CA cert]\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|struct
name|hs20_osu_client
name|ctx
decl_stmt|;
name|int
name|c
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|no_prod_assoc
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|friendly_name
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|wpa_debug_file_path
init|=
name|NULL
decl_stmt|;
specifier|extern
name|char
modifier|*
name|wpas_ctrl_path
decl_stmt|;
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
specifier|extern
name|int
name|wpa_debug_show_keys
decl_stmt|;
specifier|extern
name|int
name|wpa_debug_timestamp
decl_stmt|;
if|if
condition|(
name|init_ctx
argument_list|(
operator|&
name|ctx
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"df:hKNO:qr:s:S:tw:x:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|0
condition|)
break|break;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'d'
case|:
if|if
condition|(
name|wpa_debug_level
operator|>
literal|0
condition|)
name|wpa_debug_level
operator|--
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|wpa_debug_file_path
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'K'
case|:
name|wpa_debug_show_keys
operator|++
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
name|no_prod_assoc
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'O'
case|:
name|friendly_name
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'q'
case|:
name|wpa_debug_level
operator|++
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|ctx
operator|.
name|result_file
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|ctx
operator|.
name|summary_file
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|ctx
operator|.
name|ifname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|wpa_debug_timestamp
operator|++
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
name|wpas_ctrl_path
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|spp_xsd_fname
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
default|default:
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|1
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_debug_open_file
argument_list|(
name|wpa_debug_file_path
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__linux__
name|setlinebuf
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __linux__ */
if|if
condition|(
name|ctx
operator|.
name|result_file
condition|)
name|unlink
argument_list|(
name|ctx
operator|.
name|result_file
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"===[hs20-osu-client START - command: %s ]======"
literal|"================"
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|)
expr_stmt|;
name|check_workarounds
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"to_tnds"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|cmd_to_tnds
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|2
index|]
argument_list|,
name|argc
operator|>
name|optind
operator|+
literal|3
condition|?
name|argv
index|[
name|optind
operator|+
literal|3
index|]
else|:
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"to_tnds2"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|cmd_to_tnds
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|2
index|]
argument_list|,
name|argc
operator|>
name|optind
operator|+
literal|3
condition|?
name|argv
index|[
name|optind
operator|+
literal|3
index|]
else|:
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"from_tnds"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|cmd_from_tnds
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"sub_rem"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Server URL missing from command line"
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|cmd_sub_rem
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|argc
operator|>
name|optind
operator|+
literal|2
condition|?
name|argv
index|[
name|optind
operator|+
literal|2
index|]
else|:
name|NULL
argument_list|,
name|argc
operator|>
name|optind
operator|+
literal|3
condition|?
name|argv
index|[
name|optind
operator|+
literal|3
index|]
else|:
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"pol_upd"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|cmd_pol_upd
argument_list|(
operator|&
name|ctx
argument_list|,
name|argc
operator|>
literal|2
condition|?
name|argv
index|[
name|optind
operator|+
literal|1
index|]
else|:
name|NULL
argument_list|,
name|argc
operator|>
name|optind
operator|+
literal|2
condition|?
name|argv
index|[
name|optind
operator|+
literal|2
index|]
else|:
name|NULL
argument_list|,
name|argc
operator|>
name|optind
operator|+
literal|3
condition|?
name|argv
index|[
name|optind
operator|+
literal|3
index|]
else|:
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"prov"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|.
name|ca_fname
operator|=
name|argv
index|[
name|optind
operator|+
literal|2
index|]
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Calling cmd_prov from main"
argument_list|)
expr_stmt|;
name|cmd_prov
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"sim_prov"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|.
name|ca_fname
operator|=
name|argv
index|[
name|optind
operator|+
literal|2
index|]
expr_stmt|;
name|cmd_sim_prov
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"dl_osu_ca"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|cmd_dl_osu_ca
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"dl_polupd_ca"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|cmd_dl_polupd_ca
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"dl_aaa_ca"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|cmd_dl_aaa_ca
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"osu_select"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|.
name|ca_fname
operator|=
name|argc
operator|>
name|optind
operator|+
literal|2
condition|?
name|argv
index|[
name|optind
operator|+
literal|2
index|]
else|:
name|NULL
expr_stmt|;
name|cmd_osu_select
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
literal|2
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"signup"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ctx
operator|.
name|ca_fname
operator|=
name|argc
operator|>
name|optind
operator|+
literal|1
condition|?
name|argv
index|[
name|optind
operator|+
literal|1
index|]
else|:
name|NULL
expr_stmt|;
name|ret
operator|=
name|cmd_signup
argument_list|(
operator|&
name|ctx
argument_list|,
name|no_prod_assoc
argument_list|,
name|friendly_name
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"set_pps"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|cmd_set_pps
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"get_fqdn"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|1
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|cmd_get_fqdn
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"oma_dm_prov"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|.
name|ca_fname
operator|=
name|argv
index|[
name|optind
operator|+
literal|2
index|]
expr_stmt|;
name|cmd_oma_dm_prov
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"oma_dm_sim_prov"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|.
name|ca_fname
operator|=
name|argv
index|[
name|optind
operator|+
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|cmd_oma_dm_sim_prov
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|)
operator|<
literal|0
condition|)
block|{
name|write_summary
argument_list|(
operator|&
name|ctx
argument_list|,
literal|"Failed to complete OMA DM SIM provisioning"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"oma_dm_add"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|cmd_oma_dm_add
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"oma_dm_replace"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|cmd_oma_dm_replace
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"est_csr"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|mkdir
argument_list|(
literal|"Cert"
argument_list|,
name|S_IRWXU
argument_list|)
expr_stmt|;
name|est_build_csr
argument_list|(
operator|&
name|ctx
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"browser"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Launch web browser to URL %s"
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|ret
operator|=
name|hs20_web_browser
argument_list|(
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Web browser result: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"parse_cert"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|argc
operator|-
name|optind
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_debug_level
operator|=
name|MSG_MSGDUMP
expr_stmt|;
name|http_parse_x509_certificate
argument_list|(
name|ctx
operator|.
name|http
argument_list|,
name|argv
index|[
name|optind
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|wpa_debug_level
operator|=
name|MSG_INFO
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown command '%s'"
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|)
expr_stmt|;
block|}
name|deinit_ctx
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"===[hs20-osu-client END ]======================"
argument_list|)
expr_stmt|;
name|wpa_debug_close_file
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


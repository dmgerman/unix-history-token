begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * EAP-TNC - TNCS (IF-IMV, IF-TNCCS, and IF-TNCCS-SOH)  * Copyright (c) 2007-2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"base64.h"
end_include

begin_include
include|#
directive|include
file|"tncs.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_tlv_common.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_defs.h"
end_include

begin_comment
comment|/* TODO: TNCS must be thread-safe; review the code and add locking etc. if  * needed.. */
end_comment

begin_define
define|#
directive|define
name|TNC_CONFIG_FILE
value|"/etc/tnc_config"
end_define

begin_define
define|#
directive|define
name|IF_TNCCS_START
define|\
value|"<?xml version=\"1.0\"?>\n" \ "<TNCCS-Batch BatchId=\"%d\" Recipient=\"TNCS\" " \ "xmlns=\"http://www.trustedcomputinggroup.org/IWG/TNC/1_0/IF_TNCCS#\" " \ "xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" " \ "xsi:schemaLocation=\"http://www.trustedcomputinggroup.org/IWG/TNC/1_0/" \ "IF_TNCCS# https://www.trustedcomputinggroup.org/XML/SCHEMA/TNCCS_1.0.xsd\">\n"
end_define

begin_define
define|#
directive|define
name|IF_TNCCS_END
value|"\n</TNCCS-Batch>"
end_define

begin_comment
comment|/* TNC IF-IMV */
end_comment

begin_typedef
typedef|typedef
name|unsigned
name|long
name|TNC_UInt32
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|unsigned
name|char
modifier|*
name|TNC_BufferReference
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_IMVID
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_ConnectionID
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_ConnectionState
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_RetryReason
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_IMV_Action_Recommendation
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_IMV_Evaluation_Result
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_MessageType
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_MessageType
modifier|*
name|TNC_MessageTypeList
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_VendorID
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_Subtype
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_Version
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_Result
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_AttributeID
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_Result
function_decl|(
modifier|*
name|TNC_TNCS_BindFunctionPointer
function_decl|)
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|char
modifier|*
name|functionName
parameter_list|,
name|void
modifier|*
modifier|*
name|pOutfunctionPointer
parameter_list|)
function_decl|;
end_typedef

begin_define
define|#
directive|define
name|TNC_RESULT_SUCCESS
value|0
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_NOT_INITIALIZED
value|1
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_ALREADY_INITIALIZED
value|2
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_NO_COMMON_VERSION
value|3
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_CANT_RETRY
value|4
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_WONT_RETRY
value|5
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_INVALID_PARAMETER
value|6
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_CANT_RESPOND
value|7
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_ILLEGAL_OPERATION
value|8
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_OTHER
value|9
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_FATAL
value|10
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_CREATE
value|0
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_HANDSHAKE
value|1
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_ACCESS_ALLOWED
value|2
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_ACCESS_ISOLATED
value|3
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_ACCESS_NONE
value|4
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_DELETE
value|5
end_define

begin_define
define|#
directive|define
name|TNC_IFIMV_VERSION_1
value|1
end_define

begin_define
define|#
directive|define
name|TNC_VENDORID_ANY
value|((TNC_VendorID) 0xffffff)
end_define

begin_define
define|#
directive|define
name|TNC_SUBTYPE_ANY
value|((TNC_Subtype) 0xff)
end_define

begin_comment
comment|/* TNCC-TNCS Message Types */
end_comment

begin_define
define|#
directive|define
name|TNC_TNCCS_RECOMMENDATION
value|0x00000001
end_define

begin_define
define|#
directive|define
name|TNC_TNCCS_ERROR
value|0x00000002
end_define

begin_define
define|#
directive|define
name|TNC_TNCCS_PREFERREDLANGUAGE
value|0x00000003
end_define

begin_define
define|#
directive|define
name|TNC_TNCCS_REASONSTRINGS
value|0x00000004
end_define

begin_comment
comment|/* Possible TNC_IMV_Action_Recommendation values: */
end_comment

begin_enum
enum|enum
name|IMV_Action_Recommendation
block|{
name|TNC_IMV_ACTION_RECOMMENDATION_ALLOW
block|,
name|TNC_IMV_ACTION_RECOMMENDATION_NO_ACCESS
block|,
name|TNC_IMV_ACTION_RECOMMENDATION_ISOLATE
block|,
name|TNC_IMV_ACTION_RECOMMENDATION_NO_RECOMMENDATION
block|}
enum|;
end_enum

begin_comment
comment|/* Possible TNC_IMV_Evaluation_Result values: */
end_comment

begin_enum
enum|enum
name|IMV_Evaluation_Result
block|{
name|TNC_IMV_EVALUATION_RESULT_COMPLIANT
block|,
name|TNC_IMV_EVALUATION_RESULT_NONCOMPLIANT_MINOR
block|,
name|TNC_IMV_EVALUATION_RESULT_NONCOMPLIANT_MAJOR
block|,
name|TNC_IMV_EVALUATION_RESULT_ERROR
block|,
name|TNC_IMV_EVALUATION_RESULT_DONT_KNOW
block|}
enum|;
end_enum

begin_struct
struct|struct
name|tnc_if_imv
block|{
name|struct
name|tnc_if_imv
modifier|*
name|next
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|;
name|void
modifier|*
name|dlhandle
decl_stmt|;
comment|/* from dlopen() */
name|TNC_IMVID
name|imvID
decl_stmt|;
name|TNC_MessageTypeList
name|supported_types
decl_stmt|;
name|size_t
name|num_supported_types
decl_stmt|;
comment|/* Functions implemented by IMVs (with TNC_IMV_ prefix) */
name|TNC_Result
function_decl|(
modifier|*
name|Initialize
function_decl|)
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_Version
name|minVersion
parameter_list|,
name|TNC_Version
name|maxVersion
parameter_list|,
name|TNC_Version
modifier|*
name|pOutActualVersion
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|NotifyConnectionChange
function_decl|)
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_ConnectionState
name|newState
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|ReceiveMessage
function_decl|)
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_BufferReference
name|message
parameter_list|,
name|TNC_UInt32
name|messageLength
parameter_list|,
name|TNC_MessageType
name|messageType
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|SolicitRecommendation
function_decl|)
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|BatchEnding
function_decl|)
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|Terminate
function_decl|)
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|ProvideBindFunction
function_decl|)
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_TNCS_BindFunctionPointer
name|bindFunction
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|TNC_MAX_IMV_ID
value|10
end_define

begin_struct
struct|struct
name|tncs_data
block|{
name|struct
name|tncs_data
modifier|*
name|next
decl_stmt|;
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
comment|/* local copy of tncs_global_data->imv */
name|TNC_ConnectionID
name|connectionID
decl_stmt|;
name|unsigned
name|int
name|last_batchid
decl_stmt|;
name|enum
name|IMV_Action_Recommendation
name|recommendation
decl_stmt|;
name|int
name|done
decl_stmt|;
struct|struct
name|conn_imv
block|{
name|u8
modifier|*
name|imv_send
decl_stmt|;
name|size_t
name|imv_send_len
decl_stmt|;
name|enum
name|IMV_Action_Recommendation
name|recommendation
decl_stmt|;
name|int
name|recommendation_set
decl_stmt|;
block|}
name|imv_data
index|[
name|TNC_MAX_IMV_ID
index|]
struct|;
name|char
modifier|*
name|tncs_message
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|tncs_global
block|{
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
name|TNC_ConnectionID
name|next_conn_id
decl_stmt|;
name|struct
name|tncs_data
modifier|*
name|connections
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|tncs_global
modifier|*
name|tncs_global_data
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|tnc_if_imv
modifier|*
name|tncs_get_imv
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|)
block|{
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
if|if
condition|(
name|imvID
operator|>=
name|TNC_MAX_IMV_ID
operator|||
name|tncs_global_data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|imv
operator|=
name|tncs_global_data
operator|->
name|imv
expr_stmt|;
while|while
condition|(
name|imv
condition|)
block|{
if|if
condition|(
name|imv
operator|->
name|imvID
operator|==
name|imvID
condition|)
return|return
name|imv
return|;
name|imv
operator|=
name|imv
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|tncs_data
modifier|*
name|tncs_get_conn
parameter_list|(
name|TNC_ConnectionID
name|connectionID
parameter_list|)
block|{
name|struct
name|tncs_data
modifier|*
name|tncs
decl_stmt|;
if|if
condition|(
name|tncs_global_data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|tncs
operator|=
name|tncs_global_data
operator|->
name|connections
expr_stmt|;
while|while
condition|(
name|tncs
condition|)
block|{
if|if
condition|(
name|tncs
operator|->
name|connectionID
operator|==
name|connectionID
condition|)
return|return
name|tncs
return|;
name|tncs
operator|=
name|tncs
operator|->
name|next
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Connection ID %lu not found"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|connectionID
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* TNCS functions that IMVs can call */
end_comment

begin_function
name|TNC_Result
name|TNC_TNCS_ReportMessageTypes
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_MessageTypeList
name|supportedTypes
parameter_list|,
name|TNC_UInt32
name|typeCount
parameter_list|)
block|{
name|TNC_UInt32
name|i
decl_stmt|;
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCS_ReportMessageTypes(imvID=%lu "
literal|"typeCount=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|imvID
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|typeCount
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|typeCount
condition|;
name|i
operator|++
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: supportedTypes[%lu] = %lu"
argument_list|,
name|i
argument_list|,
name|supportedTypes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|imv
operator|=
name|tncs_get_imv
argument_list|(
name|imvID
argument_list|)
expr_stmt|;
if|if
condition|(
name|imv
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
name|os_free
argument_list|(
name|imv
operator|->
name|supported_types
argument_list|)
expr_stmt|;
name|imv
operator|->
name|supported_types
operator|=
name|os_malloc
argument_list|(
name|typeCount
operator|*
sizeof|sizeof
argument_list|(
name|TNC_MessageTypeList
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|imv
operator|->
name|supported_types
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_FATAL
return|;
name|os_memcpy
argument_list|(
name|imv
operator|->
name|supported_types
argument_list|,
name|supportedTypes
argument_list|,
name|typeCount
operator|*
sizeof|sizeof
argument_list|(
name|TNC_MessageTypeList
argument_list|)
argument_list|)
expr_stmt|;
name|imv
operator|->
name|num_supported_types
operator|=
name|typeCount
expr_stmt|;
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_TNCS_SendMessage
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_BufferReference
name|message
parameter_list|,
name|TNC_UInt32
name|messageLength
parameter_list|,
name|TNC_MessageType
name|messageType
parameter_list|)
block|{
name|struct
name|tncs_data
modifier|*
name|tncs
decl_stmt|;
name|unsigned
name|char
modifier|*
name|b64
decl_stmt|;
name|size_t
name|b64len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCS_SendMessage(imvID=%lu "
literal|"connectionID=%lu messageType=%lu)"
argument_list|,
name|imvID
argument_list|,
name|connectionID
argument_list|,
name|messageType
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCS_SendMessage"
argument_list|,
name|message
argument_list|,
name|messageLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs_get_imv
argument_list|(
name|imvID
argument_list|)
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
name|tncs
operator|=
name|tncs_get_conn
argument_list|(
name|connectionID
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
name|b64
operator|=
name|base64_encode
argument_list|(
name|message
argument_list|,
name|messageLength
argument_list|,
operator|&
name|b64len
argument_list|)
expr_stmt|;
if|if
condition|(
name|b64
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_FATAL
return|;
name|os_free
argument_list|(
name|tncs
operator|->
name|imv_data
index|[
name|imvID
index|]
operator|.
name|imv_send
argument_list|)
expr_stmt|;
name|tncs
operator|->
name|imv_data
index|[
name|imvID
index|]
operator|.
name|imv_send_len
operator|=
literal|0
expr_stmt|;
name|tncs
operator|->
name|imv_data
index|[
name|imvID
index|]
operator|.
name|imv_send
operator|=
name|os_zalloc
argument_list|(
name|b64len
operator|+
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs
operator|->
name|imv_data
index|[
name|imvID
index|]
operator|.
name|imv_send
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|b64
argument_list|)
expr_stmt|;
return|return
name|TNC_RESULT_OTHER
return|;
block|}
name|tncs
operator|->
name|imv_data
index|[
name|imvID
index|]
operator|.
name|imv_send_len
operator|=
name|os_snprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tncs
operator|->
name|imv_data
index|[
name|imvID
index|]
operator|.
name|imv_send
argument_list|,
name|b64len
operator|+
literal|100
argument_list|,
literal|"<IMC-IMV-Message><Type>%08X</Type>"
literal|"<Base64>%s</Base64></IMC-IMV-Message>"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|messageType
argument_list|,
name|b64
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|b64
argument_list|)
expr_stmt|;
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_TNCS_RequestHandshakeRetry
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_RetryReason
name|reason
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCS_RequestHandshakeRetry"
argument_list|)
expr_stmt|;
comment|/* TODO */
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_TNCS_ProvideRecommendation
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_IMV_Action_Recommendation
name|recommendation
parameter_list|,
name|TNC_IMV_Evaluation_Result
name|evaluation
parameter_list|)
block|{
name|struct
name|tncs_data
modifier|*
name|tncs
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCS_ProvideRecommendation(imvID=%lu "
literal|"connectionID=%lu recommendation=%lu evaluation=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|imvID
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|connectionID
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|recommendation
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|evaluation
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs_get_imv
argument_list|(
name|imvID
argument_list|)
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
name|tncs
operator|=
name|tncs_get_conn
argument_list|(
name|connectionID
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
name|tncs
operator|->
name|imv_data
index|[
name|imvID
index|]
operator|.
name|recommendation
operator|=
name|recommendation
expr_stmt|;
name|tncs
operator|->
name|imv_data
index|[
name|imvID
index|]
operator|.
name|recommendation_set
operator|=
literal|1
expr_stmt|;
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_TNCS_GetAttribute
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_AttributeID
name|attribureID
parameter_list|,
name|TNC_UInt32
name|bufferLength
parameter_list|,
name|TNC_BufferReference
name|buffer
parameter_list|,
name|TNC_UInt32
modifier|*
name|pOutValueLength
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCS_GetAttribute"
argument_list|)
expr_stmt|;
comment|/* TODO */
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_TNCS_SetAttribute
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_AttributeID
name|attribureID
parameter_list|,
name|TNC_UInt32
name|bufferLength
parameter_list|,
name|TNC_BufferReference
name|buffer
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCS_SetAttribute"
argument_list|)
expr_stmt|;
comment|/* TODO */
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_TNCS_BindFunction
parameter_list|(
name|TNC_IMVID
name|imvID
parameter_list|,
name|char
modifier|*
name|functionName
parameter_list|,
name|void
modifier|*
modifier|*
name|pOutFunctionPointer
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCS_BindFunction(imcID=%lu, "
literal|"functionName='%s')"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|imvID
argument_list|,
name|functionName
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs_get_imv
argument_list|(
name|imvID
argument_list|)
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
if|if
condition|(
name|pOutFunctionPointer
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_TNCS_ReportMessageTypes"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutFunctionPointer
operator|=
name|TNC_TNCS_ReportMessageTypes
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_TNCS_SendMessage"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutFunctionPointer
operator|=
name|TNC_TNCS_SendMessage
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_TNCS_RequestHandshakeRetry"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutFunctionPointer
operator|=
name|TNC_TNCS_RequestHandshakeRetry
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_TNCS_ProvideRecommendation"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutFunctionPointer
operator|=
name|TNC_TNCS_ProvideRecommendation
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_TNCS_GetAttribute"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutFunctionPointer
operator|=
name|TNC_TNCS_GetAttribute
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_TNCS_SetAttribute"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutFunctionPointer
operator|=
name|TNC_TNCS_SetAttribute
expr_stmt|;
else|else
operator|*
name|pOutFunctionPointer
operator|=
name|NULL
expr_stmt|;
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|tncs_get_sym
parameter_list|(
name|void
modifier|*
name|handle
parameter_list|,
name|char
modifier|*
name|func
parameter_list|)
block|{
name|void
modifier|*
name|fptr
decl_stmt|;
name|fptr
operator|=
name|dlsym
argument_list|(
name|handle
argument_list|,
name|func
argument_list|)
expr_stmt|;
return|return
name|fptr
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncs_imv_resolve_funcs
parameter_list|(
name|struct
name|tnc_if_imv
modifier|*
name|imv
parameter_list|)
block|{
name|void
modifier|*
name|handle
init|=
name|imv
operator|->
name|dlhandle
decl_stmt|;
comment|/* Mandatory IMV functions */
name|imv
operator|->
name|Initialize
operator|=
name|tncs_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMV_Initialize"
argument_list|)
expr_stmt|;
if|if
condition|(
name|imv
operator|->
name|Initialize
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: IMV does not export "
literal|"TNC_IMV_Initialize"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|imv
operator|->
name|SolicitRecommendation
operator|=
name|tncs_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMV_SolicitRecommendation"
argument_list|)
expr_stmt|;
if|if
condition|(
name|imv
operator|->
name|SolicitRecommendation
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: IMV does not export "
literal|"TNC_IMV_SolicitRecommendation"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|imv
operator|->
name|ProvideBindFunction
operator|=
name|tncs_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMV_ProvideBindFunction"
argument_list|)
expr_stmt|;
if|if
condition|(
name|imv
operator|->
name|ProvideBindFunction
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: IMV does not export "
literal|"TNC_IMV_ProvideBindFunction"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Optional IMV functions */
name|imv
operator|->
name|NotifyConnectionChange
operator|=
name|tncs_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMV_NotifyConnectionChange"
argument_list|)
expr_stmt|;
name|imv
operator|->
name|ReceiveMessage
operator|=
name|tncs_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMV_ReceiveMessage"
argument_list|)
expr_stmt|;
name|imv
operator|->
name|BatchEnding
operator|=
name|tncs_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMV_BatchEnding"
argument_list|)
expr_stmt|;
name|imv
operator|->
name|Terminate
operator|=
name|tncs_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMV_Terminate"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncs_imv_initialize
parameter_list|(
name|struct
name|tnc_if_imv
modifier|*
name|imv
parameter_list|)
block|{
name|TNC_Result
name|res
decl_stmt|;
name|TNC_Version
name|imv_ver
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Calling TNC_IMV_Initialize for IMV '%s'"
argument_list|,
name|imv
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imv
operator|->
name|Initialize
argument_list|(
name|imv
operator|->
name|imvID
argument_list|,
name|TNC_IFIMV_VERSION_1
argument_list|,
name|TNC_IFIMV_VERSION_1
argument_list|,
operator|&
name|imv_ver
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_IMV_Initialize: res=%lu imv_ver=%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|imv_ver
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
name|TNC_RESULT_SUCCESS
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncs_imv_terminate
parameter_list|(
name|struct
name|tnc_if_imv
modifier|*
name|imv
parameter_list|)
block|{
name|TNC_Result
name|res
decl_stmt|;
if|if
condition|(
name|imv
operator|->
name|Terminate
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Calling TNC_IMV_Terminate for IMV '%s'"
argument_list|,
name|imv
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imv
operator|->
name|Terminate
argument_list|(
name|imv
operator|->
name|imvID
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_IMV_Terminate: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
name|TNC_RESULT_SUCCESS
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncs_imv_provide_bind_function
parameter_list|(
name|struct
name|tnc_if_imv
modifier|*
name|imv
parameter_list|)
block|{
name|TNC_Result
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Calling TNC_IMV_ProvideBindFunction for "
literal|"IMV '%s'"
argument_list|,
name|imv
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imv
operator|->
name|ProvideBindFunction
argument_list|(
name|imv
operator|->
name|imvID
argument_list|,
name|TNC_TNCS_BindFunction
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_IMV_ProvideBindFunction: res=%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
name|TNC_RESULT_SUCCESS
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncs_imv_notify_connection_change
parameter_list|(
name|struct
name|tnc_if_imv
modifier|*
name|imv
parameter_list|,
name|TNC_ConnectionID
name|conn
parameter_list|,
name|TNC_ConnectionState
name|state
parameter_list|)
block|{
name|TNC_Result
name|res
decl_stmt|;
if|if
condition|(
name|imv
operator|->
name|NotifyConnectionChange
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Calling TNC_IMV_NotifyConnectionChange(%d)"
literal|" for IMV '%s'"
argument_list|,
operator|(
name|int
operator|)
name|state
argument_list|,
name|imv
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imv
operator|->
name|NotifyConnectionChange
argument_list|(
name|imv
operator|->
name|imvID
argument_list|,
name|conn
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_IMC_NotifyConnectionChange: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
name|TNC_RESULT_SUCCESS
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncs_load_imv
parameter_list|(
name|struct
name|tnc_if_imv
modifier|*
name|imv
parameter_list|)
block|{
if|if
condition|(
name|imv
operator|->
name|path
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: No IMV configured"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Opening IMV: %s (%s)"
argument_list|,
name|imv
operator|->
name|name
argument_list|,
name|imv
operator|->
name|path
argument_list|)
expr_stmt|;
name|imv
operator|->
name|dlhandle
operator|=
name|dlopen
argument_list|(
name|imv
operator|->
name|path
argument_list|,
name|RTLD_LAZY
argument_list|)
expr_stmt|;
if|if
condition|(
name|imv
operator|->
name|dlhandle
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to open IMV '%s' (%s): %s"
argument_list|,
name|imv
operator|->
name|name
argument_list|,
name|imv
operator|->
name|path
argument_list|,
name|dlerror
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tncs_imv_resolve_funcs
argument_list|(
name|imv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to resolve IMV functions"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tncs_imv_initialize
argument_list|(
name|imv
argument_list|)
operator|<
literal|0
operator|||
name|tncs_imv_provide_bind_function
argument_list|(
name|imv
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to initialize IMV"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tncs_free_imv
parameter_list|(
name|struct
name|tnc_if_imv
modifier|*
name|imv
parameter_list|)
block|{
name|os_free
argument_list|(
name|imv
operator|->
name|name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imv
operator|->
name|path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imv
operator|->
name|supported_types
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|tncs_unload_imv
parameter_list|(
name|struct
name|tnc_if_imv
modifier|*
name|imv
parameter_list|)
block|{
name|tncs_imv_terminate
argument_list|(
name|imv
argument_list|)
expr_stmt|;
if|if
condition|(
name|imv
operator|->
name|dlhandle
condition|)
name|dlclose
argument_list|(
name|imv
operator|->
name|dlhandle
argument_list|)
expr_stmt|;
name|tncs_free_imv
argument_list|(
name|imv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncs_supported_type
parameter_list|(
name|struct
name|tnc_if_imv
modifier|*
name|imv
parameter_list|,
name|unsigned
name|int
name|type
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|unsigned
name|int
name|vendor
decl_stmt|,
name|subtype
decl_stmt|;
if|if
condition|(
name|imv
operator|==
name|NULL
operator|||
name|imv
operator|->
name|supported_types
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|vendor
operator|=
name|type
operator|>>
literal|8
expr_stmt|;
name|subtype
operator|=
name|type
operator|&
literal|0xff
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|imv
operator|->
name|num_supported_types
condition|;
name|i
operator|++
control|)
block|{
name|unsigned
name|int
name|svendor
decl_stmt|,
name|ssubtype
decl_stmt|;
name|svendor
operator|=
name|imv
operator|->
name|supported_types
index|[
name|i
index|]
operator|>>
literal|8
expr_stmt|;
name|ssubtype
operator|=
name|imv
operator|->
name|supported_types
index|[
name|i
index|]
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
operator|(
name|vendor
operator|==
name|svendor
operator|||
name|svendor
operator|==
name|TNC_VENDORID_ANY
operator|)
operator|&&
operator|(
name|subtype
operator|==
name|ssubtype
operator|||
name|ssubtype
operator|==
name|TNC_SUBTYPE_ANY
operator|)
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tncs_send_to_imvs
parameter_list|(
name|struct
name|tncs_data
modifier|*
name|tncs
parameter_list|,
name|unsigned
name|int
name|type
parameter_list|,
specifier|const
name|u8
modifier|*
name|msg
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
name|TNC_Result
name|res
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TNC: Message to IMV(s)"
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|imv
operator|=
name|tncs
operator|->
name|imv
init|;
name|imv
condition|;
name|imv
operator|=
name|imv
operator|->
name|next
control|)
block|{
if|if
condition|(
name|imv
operator|->
name|ReceiveMessage
operator|==
name|NULL
operator|||
operator|!
name|tncs_supported_type
argument_list|(
name|imv
argument_list|,
name|type
argument_list|)
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Call ReceiveMessage for IMV '%s'"
argument_list|,
name|imv
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imv
operator|->
name|ReceiveMessage
argument_list|(
name|imv
operator|->
name|imvID
argument_list|,
name|tncs
operator|->
name|connectionID
argument_list|,
operator|(
name|TNC_BufferReference
operator|)
name|msg
argument_list|,
name|len
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: ReceiveMessage: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|tncs_batch_ending
parameter_list|(
name|struct
name|tncs_data
modifier|*
name|tncs
parameter_list|)
block|{
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
name|TNC_Result
name|res
decl_stmt|;
for|for
control|(
name|imv
operator|=
name|tncs
operator|->
name|imv
init|;
name|imv
condition|;
name|imv
operator|=
name|imv
operator|->
name|next
control|)
block|{
if|if
condition|(
name|imv
operator|->
name|BatchEnding
operator|==
name|NULL
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Call BatchEnding for IMV '%s'"
argument_list|,
name|imv
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imv
operator|->
name|BatchEnding
argument_list|(
name|imv
operator|->
name|imvID
argument_list|,
name|tncs
operator|->
name|connectionID
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: BatchEnding: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|tncs_solicit_recommendation
parameter_list|(
name|struct
name|tncs_data
modifier|*
name|tncs
parameter_list|)
block|{
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
name|TNC_Result
name|res
decl_stmt|;
for|for
control|(
name|imv
operator|=
name|tncs
operator|->
name|imv
init|;
name|imv
condition|;
name|imv
operator|=
name|imv
operator|->
name|next
control|)
block|{
if|if
condition|(
name|tncs
operator|->
name|imv_data
index|[
name|imv
operator|->
name|imvID
index|]
operator|.
name|recommendation_set
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Call SolicitRecommendation for "
literal|"IMV '%s'"
argument_list|,
name|imv
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imv
operator|->
name|SolicitRecommendation
argument_list|(
name|imv
operator|->
name|imvID
argument_list|,
name|tncs
operator|->
name|connectionID
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: SolicitRecommendation: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|tncs_init_connection
parameter_list|(
name|struct
name|tncs_data
modifier|*
name|tncs
parameter_list|)
block|{
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|imv
operator|=
name|tncs
operator|->
name|imv
init|;
name|imv
condition|;
name|imv
operator|=
name|imv
operator|->
name|next
control|)
block|{
name|tncs_imv_notify_connection_change
argument_list|(
name|imv
argument_list|,
name|tncs
operator|->
name|connectionID
argument_list|,
name|TNC_CONNECTION_STATE_CREATE
argument_list|)
expr_stmt|;
name|tncs_imv_notify_connection_change
argument_list|(
name|imv
argument_list|,
name|tncs
operator|->
name|connectionID
argument_list|,
name|TNC_CONNECTION_STATE_HANDSHAKE
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TNC_MAX_IMV_ID
condition|;
name|i
operator|++
control|)
block|{
name|os_free
argument_list|(
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send
argument_list|)
expr_stmt|;
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send
operator|=
name|NULL
expr_stmt|;
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send_len
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|size_t
name|tncs_total_send_len
parameter_list|(
name|struct
name|tncs_data
modifier|*
name|tncs
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|size_t
name|len
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TNC_MAX_IMV_ID
condition|;
name|i
operator|++
control|)
name|len
operator|+=
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send_len
expr_stmt|;
if|if
condition|(
name|tncs
operator|->
name|tncs_message
condition|)
name|len
operator|+=
name|os_strlen
argument_list|(
name|tncs
operator|->
name|tncs_message
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|tncs_copy_send_buf
parameter_list|(
name|struct
name|tncs_data
modifier|*
name|tncs
parameter_list|,
name|u8
modifier|*
name|pos
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TNC_MAX_IMV_ID
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send
operator|==
name|NULL
condition|)
continue|continue;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send
argument_list|,
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send_len
expr_stmt|;
name|os_free
argument_list|(
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send
argument_list|)
expr_stmt|;
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send
operator|=
name|NULL
expr_stmt|;
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send_len
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|tncs
operator|->
name|tncs_message
condition|)
block|{
name|size_t
name|len
init|=
name|os_strlen
argument_list|(
name|tncs
operator|->
name|tncs_message
argument_list|)
decl_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|tncs
operator|->
name|tncs_message
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|len
expr_stmt|;
name|os_free
argument_list|(
name|tncs
operator|->
name|tncs_message
argument_list|)
expr_stmt|;
name|tncs
operator|->
name|tncs_message
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|pos
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|tncs_if_tnccs_start
parameter_list|(
name|struct
name|tncs_data
modifier|*
name|tncs
parameter_list|)
block|{
name|char
modifier|*
name|buf
init|=
name|os_malloc
argument_list|(
literal|1000
argument_list|)
decl_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|tncs
operator|->
name|last_batchid
operator|++
expr_stmt|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
literal|1000
argument_list|,
name|IF_TNCCS_START
argument_list|,
name|tncs
operator|->
name|last_batchid
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|tncs_if_tnccs_end
parameter_list|(
name|void
parameter_list|)
block|{
name|char
modifier|*
name|buf
init|=
name|os_malloc
argument_list|(
literal|100
argument_list|)
decl_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
literal|100
argument_list|,
name|IF_TNCCS_END
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncs_get_type
parameter_list|(
name|char
modifier|*
name|start
parameter_list|,
name|unsigned
name|int
modifier|*
name|type
parameter_list|)
block|{
name|char
modifier|*
name|pos
init|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<Type>"
argument_list|)
decl_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
literal|6
expr_stmt|;
operator|*
name|type
operator|=
name|strtoul
argument_list|(
name|pos
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|tncs_get_base64
parameter_list|(
name|char
modifier|*
name|start
parameter_list|,
name|size_t
modifier|*
name|decoded_len
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|unsigned
name|char
modifier|*
name|decoded
decl_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<Base64>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|+=
literal|8
expr_stmt|;
name|pos2
operator|=
name|os_strstr
argument_list|(
name|pos
argument_list|,
literal|"</Base64>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
name|decoded
operator|=
name|base64_decode
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|pos
argument_list|,
name|os_strlen
argument_list|(
name|pos
argument_list|)
argument_list|,
name|decoded_len
argument_list|)
expr_stmt|;
operator|*
name|pos2
operator|=
literal|'<'
expr_stmt|;
if|if
condition|(
name|decoded
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Failed to decode Base64 data"
argument_list|)
expr_stmt|;
block|}
return|return
name|decoded
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|tncs_process_res
name|tncs_derive_recommendation
parameter_list|(
name|struct
name|tncs_data
modifier|*
name|tncs
parameter_list|)
block|{
name|enum
name|IMV_Action_Recommendation
name|rec
decl_stmt|;
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
name|TNC_ConnectionState
name|state
decl_stmt|;
name|char
modifier|*
name|txt
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: No more messages from IMVs"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs
operator|->
name|done
condition|)
return|return
name|TNCCS_PROCESS_OK_NO_RECOMMENDATION
return|;
name|tncs_solicit_recommendation
argument_list|(
name|tncs
argument_list|)
expr_stmt|;
comment|/* Select the most restrictive recommendation */
name|rec
operator|=
name|TNC_IMV_ACTION_RECOMMENDATION_NO_RECOMMENDATION
expr_stmt|;
for|for
control|(
name|imv
operator|=
name|tncs
operator|->
name|imv
init|;
name|imv
condition|;
name|imv
operator|=
name|imv
operator|->
name|next
control|)
block|{
name|TNC_IMV_Action_Recommendation
name|irec
decl_stmt|;
name|irec
operator|=
name|tncs
operator|->
name|imv_data
index|[
name|imv
operator|->
name|imvID
index|]
operator|.
name|recommendation
expr_stmt|;
if|if
condition|(
name|irec
operator|==
name|TNC_IMV_ACTION_RECOMMENDATION_NO_ACCESS
condition|)
name|rec
operator|=
name|TNC_IMV_ACTION_RECOMMENDATION_NO_ACCESS
expr_stmt|;
if|if
condition|(
name|irec
operator|==
name|TNC_IMV_ACTION_RECOMMENDATION_ISOLATE
operator|&&
name|rec
operator|!=
name|TNC_IMV_ACTION_RECOMMENDATION_NO_ACCESS
condition|)
name|rec
operator|=
name|TNC_IMV_ACTION_RECOMMENDATION_ISOLATE
expr_stmt|;
if|if
condition|(
name|irec
operator|==
name|TNC_IMV_ACTION_RECOMMENDATION_ALLOW
operator|&&
name|rec
operator|==
name|TNC_IMV_ACTION_RECOMMENDATION_NO_RECOMMENDATION
condition|)
name|rec
operator|=
name|TNC_IMV_ACTION_RECOMMENDATION_ALLOW
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Recommendation: %d"
argument_list|,
name|rec
argument_list|)
expr_stmt|;
name|tncs
operator|->
name|recommendation
operator|=
name|rec
expr_stmt|;
name|tncs
operator|->
name|done
operator|=
literal|1
expr_stmt|;
name|txt
operator|=
name|NULL
expr_stmt|;
switch|switch
condition|(
name|rec
condition|)
block|{
case|case
name|TNC_IMV_ACTION_RECOMMENDATION_ALLOW
case|:
case|case
name|TNC_IMV_ACTION_RECOMMENDATION_NO_RECOMMENDATION
case|:
name|txt
operator|=
literal|"allow"
expr_stmt|;
name|state
operator|=
name|TNC_CONNECTION_STATE_ACCESS_ALLOWED
expr_stmt|;
break|break;
case|case
name|TNC_IMV_ACTION_RECOMMENDATION_ISOLATE
case|:
name|txt
operator|=
literal|"isolate"
expr_stmt|;
name|state
operator|=
name|TNC_CONNECTION_STATE_ACCESS_ISOLATED
expr_stmt|;
break|break;
case|case
name|TNC_IMV_ACTION_RECOMMENDATION_NO_ACCESS
case|:
name|txt
operator|=
literal|"none"
expr_stmt|;
name|state
operator|=
name|TNC_CONNECTION_STATE_ACCESS_NONE
expr_stmt|;
break|break;
default|default:
name|state
operator|=
name|TNC_CONNECTION_STATE_ACCESS_ALLOWED
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|txt
condition|)
block|{
name|os_free
argument_list|(
name|tncs
operator|->
name|tncs_message
argument_list|)
expr_stmt|;
name|tncs
operator|->
name|tncs_message
operator|=
name|os_zalloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs
operator|->
name|tncs_message
condition|)
block|{
name|os_snprintf
argument_list|(
name|tncs
operator|->
name|tncs_message
argument_list|,
literal|199
argument_list|,
literal|"<TNCC-TNCS-Message><Type>%08X</Type>"
literal|"<XML><TNCCS-Recommendation type=\"%s\">"
literal|"</TNCCS-Recommendation></XML>"
literal|"</TNCC-TNCS-Message>"
argument_list|,
name|TNC_TNCCS_RECOMMENDATION
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|imv
operator|=
name|tncs
operator|->
name|imv
init|;
name|imv
condition|;
name|imv
operator|=
name|imv
operator|->
name|next
control|)
block|{
name|tncs_imv_notify_connection_change
argument_list|(
name|imv
argument_list|,
name|tncs
operator|->
name|connectionID
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|rec
condition|)
block|{
case|case
name|TNC_IMV_ACTION_RECOMMENDATION_ALLOW
case|:
return|return
name|TNCCS_RECOMMENDATION_ALLOW
return|;
case|case
name|TNC_IMV_ACTION_RECOMMENDATION_NO_ACCESS
case|:
return|return
name|TNCCS_RECOMMENDATION_NO_ACCESS
return|;
case|case
name|TNC_IMV_ACTION_RECOMMENDATION_ISOLATE
case|:
return|return
name|TNCCS_RECOMMENDATION_ISOLATE
return|;
case|case
name|TNC_IMV_ACTION_RECOMMENDATION_NO_RECOMMENDATION
case|:
return|return
name|TNCCS_RECOMMENDATION_NO_RECOMMENDATION
return|;
default|default:
return|return
name|TNCCS_PROCESS_ERROR
return|;
block|}
block|}
end_function

begin_function
name|enum
name|tncs_process_res
name|tncs_process_if_tnccs
parameter_list|(
name|struct
name|tncs_data
modifier|*
name|tncs
parameter_list|,
specifier|const
name|u8
modifier|*
name|msg
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|start
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|,
modifier|*
name|payload
decl_stmt|;
name|unsigned
name|int
name|batch_id
decl_stmt|;
name|unsigned
name|char
modifier|*
name|decoded
decl_stmt|;
name|size_t
name|decoded_len
decl_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|TNCCS_PROCESS_ERROR
return|;
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|start
operator|=
name|os_strstr
argument_list|(
name|buf
argument_list|,
literal|"<TNCCS-Batch "
argument_list|)
expr_stmt|;
name|end
operator|=
name|os_strstr
argument_list|(
name|buf
argument_list|,
literal|"</TNCCS-Batch>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|==
name|NULL
operator|||
name|end
operator|==
name|NULL
operator|||
name|start
operator|>
name|end
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|TNCCS_PROCESS_ERROR
return|;
block|}
name|start
operator|+=
literal|13
expr_stmt|;
while|while
condition|(
operator|*
name|start
operator|==
literal|' '
condition|)
name|start
operator|++
expr_stmt|;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"BatchId="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|TNCCS_PROCESS_ERROR
return|;
block|}
name|pos
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'"'
condition|)
name|pos
operator|++
expr_stmt|;
name|batch_id
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Received IF-TNCCS BatchId=%u"
argument_list|,
name|batch_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|batch_id
operator|!=
name|tncs
operator|->
name|last_batchid
operator|+
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Unexpected IF-TNCCS BatchId "
literal|"%u (expected %u)"
argument_list|,
name|batch_id
argument_list|,
name|tncs
operator|->
name|last_batchid
operator|+
literal|1
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|TNCCS_PROCESS_ERROR
return|;
block|}
name|tncs
operator|->
name|last_batchid
operator|=
name|batch_id
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos
operator|!=
literal|'>'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|TNCCS_PROCESS_ERROR
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|payload
operator|=
name|start
expr_stmt|;
comment|/* 	 *<IMC-IMV-Message> 	 *<Type>01234567</Type> 	 *<Base64>foo==</Base64> 	 *</IMC-IMV-Message> 	 */
while|while
condition|(
operator|*
name|start
condition|)
block|{
name|char
modifier|*
name|endpos
decl_stmt|;
name|unsigned
name|int
name|type
decl_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<IMC-IMV-Message>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
break|break;
name|start
operator|=
name|pos
operator|+
literal|17
expr_stmt|;
name|end
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"</IMC-IMV-Message>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
break|break;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|endpos
operator|=
name|end
expr_stmt|;
name|end
operator|+=
literal|18
expr_stmt|;
if|if
condition|(
name|tncs_get_type
argument_list|(
name|start
argument_list|,
operator|&
name|type
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|*
name|endpos
operator|=
literal|'<'
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: IMC-IMV-Message Type 0x%x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|decoded
operator|=
name|tncs_get_base64
argument_list|(
name|start
argument_list|,
operator|&
name|decoded_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decoded
operator|==
name|NULL
condition|)
block|{
operator|*
name|endpos
operator|=
literal|'<'
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
continue|continue;
block|}
name|tncs_send_to_imvs
argument_list|(
name|tncs
argument_list|,
name|type
argument_list|,
name|decoded
argument_list|,
name|decoded_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decoded
argument_list|)
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
block|}
comment|/* 	 *<TNCC-TNCS-Message> 	 *<Type>01234567</Type> 	 *<XML><TNCCS-Foo type="foo"></TNCCS-Foo></XML> 	 *<Base64>foo==</Base64> 	 *</TNCC-TNCS-Message> 	 */
name|start
operator|=
name|payload
expr_stmt|;
while|while
condition|(
operator|*
name|start
condition|)
block|{
name|unsigned
name|int
name|type
decl_stmt|;
name|char
modifier|*
name|xml
decl_stmt|,
modifier|*
name|xmlend
decl_stmt|,
modifier|*
name|endpos
decl_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<TNCC-TNCS-Message>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
break|break;
name|start
operator|=
name|pos
operator|+
literal|19
expr_stmt|;
name|end
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"</TNCC-TNCS-Message>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
break|break;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|endpos
operator|=
name|end
expr_stmt|;
name|end
operator|+=
literal|20
expr_stmt|;
if|if
condition|(
name|tncs_get_type
argument_list|(
name|start
argument_list|,
operator|&
name|type
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|*
name|endpos
operator|=
literal|'<'
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNCC-TNCS-Message Type 0x%x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
comment|/* Base64 OR XML */
name|decoded
operator|=
name|NULL
expr_stmt|;
name|xml
operator|=
name|NULL
expr_stmt|;
name|xmlend
operator|=
name|NULL
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<XML>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|+=
literal|5
expr_stmt|;
name|pos2
operator|=
name|os_strstr
argument_list|(
name|pos
argument_list|,
literal|"</XML>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
operator|*
name|endpos
operator|=
literal|'<'
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
continue|continue;
block|}
name|xmlend
operator|=
name|pos2
expr_stmt|;
name|xml
operator|=
name|pos
expr_stmt|;
block|}
else|else
block|{
name|decoded
operator|=
name|tncs_get_base64
argument_list|(
name|start
argument_list|,
operator|&
name|decoded_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decoded
operator|==
name|NULL
condition|)
block|{
operator|*
name|endpos
operator|=
literal|'<'
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|decoded
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TNC: TNCC-TNCS-Message Base64"
argument_list|,
name|decoded
argument_list|,
name|decoded_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decoded
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|xml
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TNC: TNCC-TNCS-Message XML"
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|xml
argument_list|,
name|xmlend
operator|-
name|xml
argument_list|)
expr_stmt|;
block|}
name|start
operator|=
name|end
expr_stmt|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|tncs_batch_ending
argument_list|(
name|tncs
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs_total_send_len
argument_list|(
name|tncs
argument_list|)
operator|==
literal|0
condition|)
return|return
name|tncs_derive_recommendation
argument_list|(
name|tncs
argument_list|)
return|;
return|return
name|TNCCS_PROCESS_OK_NO_RECOMMENDATION
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|tnc_if_imv
modifier|*
name|tncs_parse_imv
parameter_list|(
name|int
name|id
parameter_list|,
name|char
modifier|*
name|start
parameter_list|,
name|char
modifier|*
name|end
parameter_list|,
name|int
modifier|*
name|error
parameter_list|)
block|{
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
if|if
condition|(
name|id
operator|>=
name|TNC_MAX_IMV_ID
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Too many IMVs"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|imv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|imv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|imv
operator|==
name|NULL
condition|)
block|{
operator|*
name|error
operator|=
literal|1
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|imv
operator|->
name|imvID
operator|=
name|id
expr_stmt|;
name|pos
operator|=
name|start
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Configured IMV: %s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>=
name|end
operator|||
operator|*
name|pos
operator|!=
literal|'"'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Ignoring invalid IMV line '%s' "
literal|"(no starting quotation mark)"
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|pos2
operator|=
name|pos
expr_stmt|;
while|while
condition|(
name|pos2
operator|<
name|end
operator|&&
operator|*
name|pos2
operator|!=
literal|'"'
condition|)
name|pos2
operator|++
expr_stmt|;
if|if
condition|(
name|pos2
operator|>=
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Ignoring invalid IMV line '%s' "
literal|"(no ending quotation mark)"
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Name: '%s'"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|imv
operator|->
name|name
operator|=
name|os_strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|pos
operator|>=
name|end
operator|||
operator|*
name|pos
operator|!=
literal|' '
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Ignoring invalid IMV line '%s' "
literal|"(no space after name)"
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: IMV file: '%s'"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|imv
operator|->
name|path
operator|=
name|os_strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
return|return
name|imv
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncs_read_config
parameter_list|(
name|struct
name|tncs_global
modifier|*
name|global
parameter_list|)
block|{
name|char
modifier|*
name|config
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|line_end
decl_stmt|;
name|size_t
name|config_len
decl_stmt|;
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|int
name|id
init|=
literal|0
decl_stmt|;
name|last
operator|=
name|NULL
expr_stmt|;
name|config
operator|=
name|os_readfile
argument_list|(
name|TNC_CONFIG_FILE
argument_list|,
operator|&
name|config_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Could not open TNC configuration "
literal|"file '%s'"
argument_list|,
name|TNC_CONFIG_FILE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|=
name|config
operator|+
name|config_len
expr_stmt|;
for|for
control|(
name|pos
operator|=
name|config
init|;
name|pos
operator|<
name|end
condition|;
name|pos
operator|=
name|line_end
operator|+
literal|1
control|)
block|{
name|line_end
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|line_end
operator|!=
literal|'\n'
operator|&&
operator|*
name|line_end
operator|!=
literal|'\r'
operator|&&
name|line_end
operator|<
name|end
condition|)
name|line_end
operator|++
expr_stmt|;
operator|*
name|line_end
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"IMV "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|imv
operator|=
name|tncs_parse_imv
argument_list|(
name|id
operator|++
argument_list|,
name|pos
operator|+
literal|4
argument_list|,
name|line_end
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|imv
condition|)
block|{
if|if
condition|(
name|last
operator|==
name|NULL
condition|)
name|global
operator|->
name|imv
operator|=
name|imv
expr_stmt|;
else|else
name|last
operator|->
name|next
operator|=
name|imv
expr_stmt|;
name|last
operator|=
name|imv
expr_stmt|;
block|}
block|}
block|}
name|os_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|tncs_data
modifier|*
name|tncs_init
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|tncs_data
modifier|*
name|tncs
decl_stmt|;
if|if
condition|(
name|tncs_global_data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|tncs
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|tncs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|tncs
operator|->
name|imv
operator|=
name|tncs_global_data
operator|->
name|imv
expr_stmt|;
name|tncs
operator|->
name|connectionID
operator|=
name|tncs_global_data
operator|->
name|next_conn_id
operator|++
expr_stmt|;
name|tncs
operator|->
name|next
operator|=
name|tncs_global_data
operator|->
name|connections
expr_stmt|;
name|tncs_global_data
operator|->
name|connections
operator|=
name|tncs
expr_stmt|;
return|return
name|tncs
return|;
block|}
end_function

begin_function
name|void
name|tncs_deinit
parameter_list|(
name|struct
name|tncs_data
modifier|*
name|tncs
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|tncs_data
modifier|*
name|prev
decl_stmt|,
modifier|*
name|conn
decl_stmt|;
if|if
condition|(
name|tncs
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TNC_MAX_IMV_ID
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
name|tncs
operator|->
name|imv_data
index|[
name|i
index|]
operator|.
name|imv_send
argument_list|)
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|conn
operator|=
name|tncs_global_data
operator|->
name|connections
expr_stmt|;
while|while
condition|(
name|conn
condition|)
block|{
if|if
condition|(
name|conn
operator|==
name|tncs
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|tncs
operator|->
name|next
expr_stmt|;
else|else
name|tncs_global_data
operator|->
name|connections
operator|=
name|tncs
operator|->
name|next
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|conn
expr_stmt|;
name|conn
operator|=
name|conn
operator|->
name|next
expr_stmt|;
block|}
name|os_free
argument_list|(
name|tncs
operator|->
name|tncs_message
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tncs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|tncs_global_init
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|;
name|tncs_global_data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|tncs_global_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncs_global_data
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|tncs_read_config
argument_list|(
name|tncs_global_data
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to read TNC configuration"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
for|for
control|(
name|imv
operator|=
name|tncs_global_data
operator|->
name|imv
init|;
name|imv
condition|;
name|imv
operator|=
name|imv
operator|->
name|next
control|)
block|{
if|if
condition|(
name|tncs_load_imv
argument_list|(
name|imv
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to load IMV '%s'"
argument_list|,
name|imv
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
block|}
return|return
literal|0
return|;
name|failed
label|:
name|tncs_global_deinit
argument_list|()
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|tncs_global_deinit
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|tnc_if_imv
modifier|*
name|imv
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|tncs_global_data
operator|==
name|NULL
condition|)
return|return;
name|imv
operator|=
name|tncs_global_data
operator|->
name|imv
expr_stmt|;
while|while
condition|(
name|imv
condition|)
block|{
name|tncs_unload_imv
argument_list|(
name|imv
argument_list|)
expr_stmt|;
name|prev
operator|=
name|imv
expr_stmt|;
name|imv
operator|=
name|imv
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|tncs_global_data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tncs_build_soh_request
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
comment|/* 	 * Build a SoH Request TLV (to be used inside SoH EAP Extensions 	 * Method) 	 */
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|8
operator|+
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* Vendor-Specific TLV (Microsoft) - SoH Request */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|EAP_TLV_VENDOR_SPECIFIC_TLV
argument_list|)
expr_stmt|;
comment|/* TLV Type */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|8
argument_list|)
expr_stmt|;
comment|/* Length */
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|EAP_VENDOR_MICROSOFT
argument_list|)
expr_stmt|;
comment|/* Vendor_Id */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|0x02
argument_list|)
expr_stmt|;
comment|/* TLV Type - SoH Request TLV */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Length */
return|return
name|buf
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tncs_process_soh
parameter_list|(
specifier|const
name|u8
modifier|*
name|soh_tlv
parameter_list|,
name|size_t
name|soh_tlv_len
parameter_list|,
name|int
modifier|*
name|failure
parameter_list|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: SoH TLV"
argument_list|,
name|soh_tlv
argument_list|,
name|soh_tlv_len
argument_list|)
expr_stmt|;
operator|*
name|failure
operator|=
literal|0
expr_stmt|;
comment|/* TODO: return MS-SoH Response TLV */
return|return
name|NULL
return|;
block|}
end_function

end_unit


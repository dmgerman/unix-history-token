begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / EAP-AKA (RFC 4187) and EAP-AKA' (RFC 5448)  * Copyright (c) 2005-2012, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_sim_common.h"
end_include

begin_include
include|#
directive|include
file|"eap_server/eap_i.h"
end_include

begin_include
include|#
directive|include
file|"eap_server/eap_sim_db.h"
end_include

begin_struct
struct|struct
name|eap_aka_data
block|{
name|u8
name|mk
index|[
name|EAP_SIM_MK_LEN
index|]
decl_stmt|;
name|u8
name|nonce_s
index|[
name|EAP_SIM_NONCE_S_LEN
index|]
decl_stmt|;
name|u8
name|k_aut
index|[
name|EAP_AKA_PRIME_K_AUT_LEN
index|]
decl_stmt|;
name|u8
name|k_encr
index|[
name|EAP_SIM_K_ENCR_LEN
index|]
decl_stmt|;
name|u8
name|k_re
index|[
name|EAP_AKA_PRIME_K_RE_LEN
index|]
decl_stmt|;
comment|/* EAP-AKA' only */
name|u8
name|msk
index|[
name|EAP_SIM_KEYING_DATA_LEN
index|]
decl_stmt|;
name|u8
name|emsk
index|[
name|EAP_EMSK_LEN
index|]
decl_stmt|;
name|u8
name|rand
index|[
name|EAP_AKA_RAND_LEN
index|]
decl_stmt|;
name|u8
name|autn
index|[
name|EAP_AKA_AUTN_LEN
index|]
decl_stmt|;
name|u8
name|ck
index|[
name|EAP_AKA_CK_LEN
index|]
decl_stmt|;
name|u8
name|ik
index|[
name|EAP_AKA_IK_LEN
index|]
decl_stmt|;
name|u8
name|res
index|[
name|EAP_AKA_RES_MAX_LEN
index|]
decl_stmt|;
name|size_t
name|res_len
decl_stmt|;
enum|enum
block|{
name|IDENTITY
block|,
name|CHALLENGE
block|,
name|REAUTH
block|,
name|NOTIFICATION
block|,
name|SUCCESS
block|,
name|FAILURE
block|}
name|state
enum|;
name|char
modifier|*
name|next_pseudonym
decl_stmt|;
name|char
modifier|*
name|next_reauth_id
decl_stmt|;
name|u16
name|counter
decl_stmt|;
name|struct
name|eap_sim_reauth
modifier|*
name|reauth
decl_stmt|;
name|int
name|auts_reported
decl_stmt|;
comment|/* whether the current AUTS has been reported to the 			    * eap_sim_db */
name|u16
name|notification
decl_stmt|;
name|int
name|use_result_ind
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|id_msgs
decl_stmt|;
name|int
name|pending_id
decl_stmt|;
name|u8
name|eap_method
decl_stmt|;
name|u8
modifier|*
name|network_name
decl_stmt|;
name|size_t
name|network_name_len
decl_stmt|;
name|u16
name|kdf
decl_stmt|;
name|int
name|identity_round
decl_stmt|;
name|char
name|permanent
index|[
literal|20
index|]
decl_stmt|;
comment|/* Permanent username */
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|eap_aka_fullauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_aka_state_txt
parameter_list|(
name|int
name|state
parameter_list|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|IDENTITY
case|:
return|return
literal|"IDENTITY"
return|;
case|case
name|CHALLENGE
case|:
return|return
literal|"CHALLENGE"
return|;
case|case
name|REAUTH
case|:
return|return
literal|"REAUTH"
return|;
case|case
name|SUCCESS
case|:
return|return
literal|"SUCCESS"
return|;
case|case
name|FAILURE
case|:
return|return
literal|"FAILURE"
return|;
case|case
name|NOTIFICATION
case|:
return|return
literal|"NOTIFICATION"
return|;
default|default:
return|return
literal|"Unknown?!"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_state
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: %s -> %s"
argument_list|,
name|eap_aka_state_txt
argument_list|(
name|data
operator|->
name|state
argument_list|)
argument_list|,
name|eap_aka_state_txt
argument_list|(
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|state
operator|=
name|state
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_check_identity_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|username
parameter_list|)
block|{
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
operator|&&
name|username
index|[
literal|0
index|]
operator|!=
name|EAP_AKA_PRIME_REAUTH_ID_PREFIX
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA
operator|&&
name|username
index|[
literal|0
index|]
operator|!=
name|EAP_AKA_REAUTH_ID_PREFIX
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Reauth username '%s'"
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth
operator|=
name|eap_sim_db_get_reauth_entry
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|username
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Unknown reauth identity - "
literal|"request full auth identity"
argument_list|)
expr_stmt|;
comment|/* Remain in IDENTITY state for another round */
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Using fast re-authentication"
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|data
operator|->
name|permanent
argument_list|,
name|data
operator|->
name|reauth
operator|->
name|permanent
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|permanent
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|counter
operator|=
name|data
operator|->
name|reauth
operator|->
name|counter
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|reauth
operator|->
name|k_encr
argument_list|,
name|EAP_SIM_K_ENCR_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|reauth
operator|->
name|k_aut
argument_list|,
name|EAP_AKA_PRIME_K_AUT_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|k_re
argument_list|,
name|data
operator|->
name|reauth
operator|->
name|k_re
argument_list|,
name|EAP_AKA_PRIME_K_RE_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|reauth
operator|->
name|mk
argument_list|,
name|EAP_SIM_MK_LEN
argument_list|)
expr_stmt|;
block|}
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|REAUTH
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_check_identity
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|)
block|{
name|char
modifier|*
name|username
decl_stmt|;
comment|/* Check if we already know the identity from EAP-Response/Identity */
name|username
operator|=
name|sim_get_username
argument_list|(
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|username
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|eap_aka_check_identity_reauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|username
argument_list|)
operator|>
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|username
argument_list|)
expr_stmt|;
comment|/* 		 * Since re-auth username was recognized, skip AKA/Identity 		 * exchange. 		 */
return|return;
block|}
if|if
condition|(
operator|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
operator|&&
name|username
index|[
literal|0
index|]
operator|==
name|EAP_AKA_PRIME_PSEUDONYM_PREFIX
operator|)
operator|||
operator|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA
operator|&&
name|username
index|[
literal|0
index|]
operator|==
name|EAP_AKA_PSEUDONYM_PREFIX
operator|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|permanent
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Pseudonym username '%s'"
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|permanent
operator|=
name|eap_sim_db_get_permanent
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|username
argument_list|)
expr_stmt|;
if|if
condition|(
name|permanent
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|username
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Unknown pseudonym "
literal|"identity - request permanent identity"
argument_list|)
expr_stmt|;
comment|/* Remain in IDENTITY state for another round */
return|return;
block|}
name|os_strlcpy
argument_list|(
name|data
operator|->
name|permanent
argument_list|,
name|permanent
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|permanent
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * Since pseudonym username was recognized, skip AKA/Identity 		 * exchange. 		 */
name|eap_aka_fullauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|username
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|eap_aka_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|eap_sim_db_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: eap_sim_db not configured"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|->
name|eap_method
operator|=
name|EAP_TYPE_AKA
expr_stmt|;
name|data
operator|->
name|state
operator|=
name|IDENTITY
expr_stmt|;
name|data
operator|->
name|pending_id
operator|=
operator|-
literal|1
expr_stmt|;
name|eap_aka_check_identity
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_SERVER_AKA_PRIME
end_ifdef

begin_function
specifier|static
name|void
modifier|*
name|eap_aka_prime_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
decl_stmt|;
comment|/* TODO: make ANID configurable; see 3GPP TS 24.302 */
name|char
modifier|*
name|network_name
init|=
literal|"WLAN"
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|eap_sim_db_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: eap_sim_db not configured"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|->
name|eap_method
operator|=
name|EAP_TYPE_AKA_PRIME
expr_stmt|;
name|data
operator|->
name|network_name
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_strdup
argument_list|(
name|network_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|network_name
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|network_name_len
operator|=
name|os_strlen
argument_list|(
name|network_name
argument_list|)
expr_stmt|;
name|data
operator|->
name|state
operator|=
name|IDENTITY
expr_stmt|;
name|data
operator|->
name|pending_id
operator|=
operator|-
literal|1
expr_stmt|;
name|eap_aka_check_identity
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_SERVER_AKA_PRIME */
end_comment

begin_function
specifier|static
name|void
name|eap_aka_reset
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|next_pseudonym
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|next_reauth_id
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|network_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_add_id_msg
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|data
operator|->
name|id_msgs
operator|==
name|NULL
condition|)
block|{
name|data
operator|->
name|id_msgs
operator|=
name|wpabuf_dup
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|data
operator|->
name|id_msgs
operator|==
name|NULL
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
if|if
condition|(
name|wpabuf_resize
argument_list|(
operator|&
name|data
operator|->
name|id_msgs
argument_list|,
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_buf
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|,
name|msg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_add_checkcode
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_sim_msg
modifier|*
name|msg
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_CHECKCODE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|id_msgs
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * No EAP-AKA/Identity packets were exchanged - send empty 		 * checkcode. 		 */
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_CHECKCODE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Checkcode is SHA1 hash over all EAP-AKA/Identity packets. */
name|addr
operator|=
name|wpabuf_head
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_len
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-AKA: AT_CHECKCODE data"
argument_list|,
name|addr
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
name|sha256_vector
argument_list|(
literal|1
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
else|else
name|sha1_vector
argument_list|(
literal|1
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_CHECKCODE
argument_list|,
literal|0
argument_list|,
name|hash
argument_list|,
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|?
name|EAP_AKA_PRIME_CHECKCODE_LEN
else|:
name|EAP_AKA_CHECKCODE_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_verify_checkcode
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|checkcode
parameter_list|,
name|size_t
name|checkcode_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|size_t
name|hash_len
decl_stmt|;
if|if
condition|(
name|checkcode
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|data
operator|->
name|id_msgs
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|checkcode_len
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Checkcode from peer "
literal|"indicates that AKA/Identity messages were "
literal|"used, but they were not"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
name|hash_len
operator|=
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|?
name|EAP_AKA_PRIME_CHECKCODE_LEN
else|:
name|EAP_AKA_CHECKCODE_LEN
expr_stmt|;
if|if
condition|(
name|checkcode_len
operator|!=
name|hash_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Checkcode from peer indicates "
literal|"that AKA/Identity message were not used, but they "
literal|"were"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Checkcode is SHA1 hash over all EAP-AKA/Identity packets. */
name|addr
operator|=
name|wpabuf_head
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_len
argument_list|(
name|data
operator|->
name|id_msgs
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
name|sha256_vector
argument_list|(
literal|1
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
else|else
name|sha1_vector
argument_list|(
literal|1
argument_list|,
operator|&
name|addr
argument_list|,
operator|&
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|hash
argument_list|,
name|checkcode
argument_list|,
name|hash_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Mismatch in AT_CHECKCODE"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_build_identity
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Generating Identity"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_REQUEST
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_IDENTITY
argument_list|)
expr_stmt|;
name|data
operator|->
name|identity_round
operator|++
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|identity_round
operator|==
literal|1
condition|)
block|{
comment|/* 		 * RFC 4187, Chap. 4.1.4 recommends that identity from EAP is 		 * ignored and the AKA/Identity is used to request the 		 * identity. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ANY_ID_REQ"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_ANY_ID_REQ
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|identity_round
operator|>
literal|3
condition|)
block|{
comment|/* Cannot use more than three rounds of Identity messages */
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
elseif|else
if|if
condition|(
name|sm
operator|->
name|identity
operator|&&
name|sm
operator|->
name|identity_len
operator|>
literal|0
operator|&&
operator|(
name|sm
operator|->
name|identity
index|[
literal|0
index|]
operator|==
name|EAP_AKA_REAUTH_ID_PREFIX
operator|||
name|sm
operator|->
name|identity
index|[
literal|0
index|]
operator|==
name|EAP_AKA_PRIME_REAUTH_ID_PREFIX
operator|)
condition|)
block|{
comment|/* Reauth id may have expired - try fullauth */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_FULLAUTH_ID_REQ"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_FULLAUTH_ID_REQ
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_PERMANENT_ID_REQ"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_PERMANENT_ID_REQ
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|buf
operator|=
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_aka_add_id_msg
argument_list|(
name|data
argument_list|,
name|buf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|pending_id
operator|=
name|id
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_build_encr
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_sim_msg
modifier|*
name|msg
parameter_list|,
name|u16
name|counter
parameter_list|,
specifier|const
name|u8
modifier|*
name|nonce_s
parameter_list|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|next_pseudonym
argument_list|)
expr_stmt|;
if|if
condition|(
name|nonce_s
operator|==
name|NULL
condition|)
block|{
name|data
operator|->
name|next_pseudonym
operator|=
name|eap_sim_db_get_next_pseudonym
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|?
name|EAP_SIM_DB_AKA_PRIME
else|:
name|EAP_SIM_DB_AKA
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Do not update pseudonym during re-authentication */
name|data
operator|->
name|next_pseudonym
operator|=
name|NULL
expr_stmt|;
block|}
name|os_free
argument_list|(
name|data
operator|->
name|next_reauth_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|counter
operator|<=
name|EAP_AKA_MAX_FAST_REAUTHS
condition|)
block|{
name|data
operator|->
name|next_reauth_id
operator|=
name|eap_sim_db_get_next_reauth_id
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|?
name|EAP_SIM_DB_AKA_PRIME
else|:
name|EAP_SIM_DB_AKA
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Max fast re-authentication "
literal|"count exceeded - force full authentication"
argument_list|)
expr_stmt|;
name|data
operator|->
name|next_reauth_id
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_pseudonym
operator|==
name|NULL
operator|&&
name|data
operator|->
name|next_reauth_id
operator|==
name|NULL
operator|&&
name|counter
operator|==
literal|0
operator|&&
name|nonce_s
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IV"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_encr_start
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IV
argument_list|,
name|EAP_SIM_AT_ENCR_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|counter
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER (%u)"
argument_list|,
name|counter
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER
argument_list|,
name|counter
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nonce_s
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_NONCE_S"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_NONCE_S
argument_list|,
literal|0
argument_list|,
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_pseudonym
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_NEXT_PSEUDONYM (%s)"
argument_list|,
name|data
operator|->
name|next_pseudonym
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_NEXT_PSEUDONYM
argument_list|,
name|os_strlen
argument_list|(
name|data
operator|->
name|next_pseudonym
argument_list|)
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|next_pseudonym
argument_list|,
name|os_strlen
argument_list|(
name|data
operator|->
name|next_pseudonym
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_reauth_id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_NEXT_REAUTH_ID (%s)"
argument_list|,
name|data
operator|->
name|next_reauth_id
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_NEXT_REAUTH_ID
argument_list|,
name|os_strlen
argument_list|(
name|data
operator|->
name|next_reauth_id
argument_list|)
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|next_reauth_id
argument_list|,
name|os_strlen
argument_list|(
name|data
operator|->
name|next_reauth_id
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eap_sim_msg_add_encr_end
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|EAP_SIM_AT_PADDING
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Failed to encrypt "
literal|"AT_ENCR_DATA"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_build_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Generating Challenge"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_REQUEST
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_CHALLENGE
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_RAND"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_RAND
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|rand
argument_list|,
name|EAP_AKA_RAND_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_AUTN"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_AUTN
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|autn
argument_list|,
name|EAP_AKA_AUTN_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|kdf
condition|)
block|{
comment|/* Add the selected KDF into the beginning */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_KDF"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_KDF
argument_list|,
name|data
operator|->
name|kdf
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_KDF"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_KDF
argument_list|,
name|EAP_AKA_PRIME_KDF
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_KDF_INPUT"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_KDF_INPUT
argument_list|,
name|data
operator|->
name|network_name_len
argument_list|,
name|data
operator|->
name|network_name
argument_list|,
name|data
operator|->
name|network_name_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eap_aka_build_encr
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|eap_aka_add_checkcode
argument_list|(
name|data
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eap_sim_aka_result_ind
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_RESULT_IND"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_RESULT_IND
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|EAP_SERVER_AKA_PRIME
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA
condition|)
block|{
name|u16
name|flags
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|aka_prime_preferred
init|=
literal|0
decl_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|sm
operator|->
name|user
operator|&&
name|i
operator|<
name|EAP_MAX_METHODS
operator|&&
operator|(
name|sm
operator|->
name|user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|vendor
operator|!=
name|EAP_VENDOR_IETF
operator|||
name|sm
operator|->
name|user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|method
operator|!=
name|EAP_TYPE_NONE
operator|)
condition|)
block|{
if|if
condition|(
name|sm
operator|->
name|user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|vendor
operator|==
name|EAP_VENDOR_IETF
condition|)
block|{
if|if
condition|(
name|sm
operator|->
name|user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|method
operator|==
name|EAP_TYPE_AKA
condition|)
break|break;
if|if
condition|(
name|sm
operator|->
name|user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
name|aka_prime_preferred
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|aka_prime_preferred
condition|)
name|flags
operator||=
name|EAP_AKA_BIDDING_FLAG_D
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_BIDDING
argument_list|,
name|flags
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* EAP_SERVER_AKA_PRIME */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_build_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Generating Re-authentication"
argument_list|)
expr_stmt|;
if|if
condition|(
name|random_get_bytes
argument_list|(
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
condition|)
return|return
name|NULL
return|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-AKA: NONCE_S"
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
name|eap_aka_prime_derive_keys_reauth
argument_list|(
name|data
operator|->
name|k_re
argument_list|,
name|data
operator|->
name|counter
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|eap_sim_derive_keys
argument_list|(
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys_reauth
argument_list|(
name|data
operator|->
name|counter
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
block|}
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_REQUEST
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_REAUTHENTICATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_aka_build_encr
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|msg
argument_list|,
name|data
operator|->
name|counter
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|)
condition|)
block|{
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|eap_aka_add_checkcode
argument_list|(
name|data
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eap_sim_aka_result_ind
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_RESULT_IND"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_RESULT_IND
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_build_notification
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Generating Notification"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_REQUEST
argument_list|,
name|id
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|EAP_AKA_SUBTYPE_NOTIFICATION
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_NOTIFICATION (%d)"
argument_list|,
name|data
operator|->
name|notification
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_NOTIFICATION
argument_list|,
name|data
operator|->
name|notification
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|use_result_ind
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|reauth
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IV"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_encr_start
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IV
argument_list|,
name|EAP_SIM_AT_ENCR_DATA
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER (%u)"
argument_list|,
name|data
operator|->
name|counter
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER
argument_list|,
name|data
operator|->
name|counter
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_msg_add_encr_end
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|EAP_SIM_AT_PADDING
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Failed to "
literal|"encrypt AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
block|}
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_aka_buildReq
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|u8
name|id
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|data
operator|->
name|auts_reported
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|data
operator|->
name|state
condition|)
block|{
case|case
name|IDENTITY
case|:
return|return
name|eap_aka_build_identity
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|)
return|;
case|case
name|CHALLENGE
case|:
return|return
name|eap_aka_build_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|)
return|;
case|case
name|REAUTH
case|:
return|return
name|eap_aka_build_reauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|)
return|;
case|case
name|NOTIFICATION
case|:
return|return
name|eap_aka_build_notification
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|)
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Unknown state %d in "
literal|"buildReq"
argument_list|,
name|data
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_aka_check
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|respData
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|pos
operator|=
name|eap_hdr_validate
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|respData
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
operator|||
name|len
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: Invalid frame"
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_aka_subtype_ok
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|u8
name|subtype
parameter_list|)
block|{
if|if
condition|(
name|subtype
operator|==
name|EAP_AKA_SUBTYPE_CLIENT_ERROR
operator|||
name|subtype
operator|==
name|EAP_AKA_SUBTYPE_AUTHENTICATION_REJECT
condition|)
return|return
name|FALSE
return|;
switch|switch
condition|(
name|data
operator|->
name|state
condition|)
block|{
case|case
name|IDENTITY
case|:
if|if
condition|(
name|subtype
operator|!=
name|EAP_AKA_SUBTYPE_IDENTITY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: Unexpected response "
literal|"subtype %d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|CHALLENGE
case|:
if|if
condition|(
name|subtype
operator|!=
name|EAP_AKA_SUBTYPE_CHALLENGE
operator|&&
name|subtype
operator|!=
name|EAP_AKA_SUBTYPE_SYNCHRONIZATION_FAILURE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: Unexpected response "
literal|"subtype %d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|REAUTH
case|:
if|if
condition|(
name|subtype
operator|!=
name|EAP_AKA_SUBTYPE_REAUTHENTICATION
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: Unexpected response "
literal|"subtype %d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
case|case
name|NOTIFICATION
case|:
if|if
condition|(
name|subtype
operator|!=
name|EAP_AKA_SUBTYPE_NOTIFICATION
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: Unexpected response "
literal|"subtype %d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: Unexpected state (%d) for "
literal|"processing a response"
argument_list|,
name|data
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_determine_identity
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|)
block|{
name|char
modifier|*
name|username
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Identity"
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|)
expr_stmt|;
name|username
operator|=
name|sim_get_username
argument_list|(
name|sm
operator|->
name|identity
argument_list|,
name|sm
operator|->
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|username
operator|==
name|NULL
condition|)
block|{
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|eap_aka_check_identity_reauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|username
argument_list|)
operator|>
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|username
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
operator|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
operator|&&
name|username
index|[
literal|0
index|]
operator|==
name|EAP_AKA_PRIME_REAUTH_ID_PREFIX
operator|)
operator|||
operator|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA
operator|&&
name|username
index|[
literal|0
index|]
operator|==
name|EAP_AKA_REAUTH_ID_PREFIX
operator|)
operator|)
operator|&&
name|data
operator|->
name|identity_round
operator|==
literal|1
condition|)
block|{
comment|/* Remain in IDENTITY state for another round to request full 		 * auth identity since we did not recognize reauth id */
name|os_free
argument_list|(
name|username
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
operator|&&
name|username
index|[
literal|0
index|]
operator|==
name|EAP_AKA_PRIME_PSEUDONYM_PREFIX
operator|)
operator|||
operator|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA
operator|&&
name|username
index|[
literal|0
index|]
operator|==
name|EAP_AKA_PSEUDONYM_PREFIX
operator|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|permanent
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Pseudonym username '%s'"
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|permanent
operator|=
name|eap_sim_db_get_permanent
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|username
argument_list|)
expr_stmt|;
if|if
condition|(
name|permanent
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Unknown pseudonym "
literal|"identity - request permanent identity"
argument_list|)
expr_stmt|;
comment|/* Remain in IDENTITY state for another round */
return|return;
block|}
name|os_strlcpy
argument_list|(
name|data
operator|->
name|permanent
argument_list|,
name|permanent
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|permanent
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
operator|&&
name|username
index|[
literal|0
index|]
operator|==
name|EAP_AKA_PRIME_PERMANENT_PREFIX
operator|)
operator|||
operator|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA
operator|&&
name|username
index|[
literal|0
index|]
operator|==
name|EAP_AKA_PERMANENT_PREFIX
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Permanent username '%s'"
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|data
operator|->
name|permanent
argument_list|,
name|username
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|permanent
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|username
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Unrecognized username '%s'"
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|username
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
name|eap_aka_fullauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_fullauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|)
block|{
name|size_t
name|identity_len
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|eap_sim_db_get_aka_auth
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|permanent
argument_list|,
name|data
operator|->
name|rand
argument_list|,
name|data
operator|->
name|autn
argument_list|,
name|data
operator|->
name|ik
argument_list|,
name|data
operator|->
name|ck
argument_list|,
name|data
operator|->
name|res
argument_list|,
operator|&
name|data
operator|->
name|res_len
argument_list|,
name|sm
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|EAP_SIM_DB_PENDING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: AKA authentication data "
literal|"not yet available - pending request"
argument_list|)
expr_stmt|;
name|sm
operator|->
name|method_pending
operator|=
name|METHOD_PENDING_WAIT
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|EAP_SERVER_AKA_PRIME
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
comment|/* Note: AUTN = (SQN ^ AK) || AMF || MAC which gives us the 		 * needed 6-octet SQN ^AK for CK',IK' derivation */
name|eap_aka_prime_derive_ck_ik_prime
argument_list|(
name|data
operator|->
name|ck
argument_list|,
name|data
operator|->
name|ik
argument_list|,
name|data
operator|->
name|autn
argument_list|,
name|data
operator|->
name|network_name
argument_list|,
name|data
operator|->
name|network_name_len
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* EAP_SERVER_AKA_PRIME */
name|data
operator|->
name|reauth
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|counter
operator|=
literal|0
expr_stmt|;
comment|/* reset re-auth counter since this is full auth */
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-AKA: Failed to get AKA "
literal|"authentication data for the peer"
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sm
operator|->
name|method_pending
operator|==
name|METHOD_PENDING_WAIT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: AKA authentication data "
literal|"available - abort pending wait"
argument_list|)
expr_stmt|;
name|sm
operator|->
name|method_pending
operator|=
name|METHOD_PENDING_NONE
expr_stmt|;
block|}
name|identity_len
operator|=
name|sm
operator|->
name|identity_len
expr_stmt|;
while|while
condition|(
name|identity_len
operator|>
literal|0
operator|&&
name|sm
operator|->
name|identity
index|[
name|identity_len
operator|-
literal|1
index|]
operator|==
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Workaround - drop last null "
literal|"character from identity"
argument_list|)
expr_stmt|;
name|identity_len
operator|--
expr_stmt|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Identity for MK derivation"
argument_list|,
name|sm
operator|->
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
name|eap_aka_prime_derive_keys
argument_list|(
name|sm
operator|->
name|identity
argument_list|,
name|identity_len
argument_list|,
name|data
operator|->
name|ik
argument_list|,
name|data
operator|->
name|ck
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|k_re
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|eap_aka_derive_mk
argument_list|(
name|sm
operator|->
name|identity
argument_list|,
name|identity_len
argument_list|,
name|data
operator|->
name|ik
argument_list|,
name|data
operator|->
name|ck
argument_list|,
name|data
operator|->
name|mk
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys
argument_list|(
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
block|}
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|CHALLENGE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_process_identity
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|respData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|u8
modifier|*
name|new_identity
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Processing Identity"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|mac
operator|||
name|attr
operator|->
name|iv
operator|||
name|attr
operator|->
name|encr_data
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Unexpected attribute "
literal|"received in EAP-Response/AKA-Identity"
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * We always request identity with AKA/Identity, so the peer is 	 * required to have replied with one. 	 */
if|if
condition|(
operator|!
name|attr
operator|->
name|identity
operator|||
name|attr
operator|->
name|identity_len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Peer did not provide any "
literal|"identity"
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
name|new_identity
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_identity
operator|==
name|NULL
condition|)
block|{
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_free
argument_list|(
name|sm
operator|->
name|identity
argument_list|)
expr_stmt|;
name|sm
operator|->
name|identity
operator|=
name|new_identity
expr_stmt|;
name|os_memcpy
argument_list|(
name|sm
operator|->
name|identity
argument_list|,
name|attr
operator|->
name|identity
argument_list|,
name|attr
operator|->
name|identity_len
argument_list|)
expr_stmt|;
name|sm
operator|->
name|identity_len
operator|=
name|attr
operator|->
name|identity_len
expr_stmt|;
name|eap_aka_determine_identity
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_get_id
argument_list|(
name|respData
argument_list|)
operator|==
name|data
operator|->
name|pending_id
condition|)
block|{
name|data
operator|->
name|pending_id
operator|=
operator|-
literal|1
expr_stmt|;
name|eap_aka_add_id_msg
argument_list|(
name|data
argument_list|,
name|respData
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_aka_verify_mac
parameter_list|(
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|req
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac
parameter_list|,
specifier|const
name|u8
modifier|*
name|extra
parameter_list|,
name|size_t
name|extra_len
parameter_list|)
block|{
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
return|return
name|eap_sim_verify_mac_sha256
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|req
argument_list|,
name|mac
argument_list|,
name|extra
argument_list|,
name|extra_len
argument_list|)
return|;
return|return
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|req
argument_list|,
name|mac
argument_list|,
name|extra
argument_list|,
name|extra_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_process_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|respData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Processing Challenge"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|EAP_SERVER_AKA_PRIME
if|#
directive|if
literal|0
comment|/* KDF negotiation; to be enabled only after more than one KDF is 	 * supported */
block|if (data->eap_method == EAP_TYPE_AKA_PRIME&& 	    attr->kdf_count == 1&& attr->mac == NULL) { 		if (attr->kdf[0] != EAP_AKA_PRIME_KDF) { 			wpa_printf(MSG_WARNING, "EAP-AKA': Peer selected " 				   "unknown KDF"); 			data->notification = 				EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH; 			eap_aka_state(data, NOTIFICATION); 			return; 		}  		data->kdf = attr->kdf[0];
comment|/* Allow negotiation to continue with the selected KDF by 		 * sending another Challenge message */
block|wpa_printf(MSG_DEBUG, "EAP-AKA': KDF %d selected", data->kdf); 		return; 	}
endif|#
directive|endif
endif|#
directive|endif
comment|/* EAP_SERVER_AKA_PRIME */
if|if
condition|(
name|attr
operator|->
name|checkcode
operator|&&
name|eap_aka_verify_checkcode
argument_list|(
name|data
argument_list|,
name|attr
operator|->
name|checkcode
argument_list|,
name|attr
operator|->
name|checkcode_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Invalid AT_CHECKCODE in the "
literal|"message"
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|attr
operator|->
name|mac
operator|==
name|NULL
operator|||
name|eap_aka_verify_mac
argument_list|(
name|data
argument_list|,
name|respData
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Challenge message "
literal|"did not include valid AT_MAC"
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * AT_RES is padded, so verify that there is enough room for RES and 	 * that the RES length in bits matches with the expected RES. 	 */
if|if
condition|(
name|attr
operator|->
name|res
operator|==
name|NULL
operator|||
name|attr
operator|->
name|res_len
operator|<
name|data
operator|->
name|res_len
operator|||
name|attr
operator|->
name|res_len_bits
operator|!=
name|data
operator|->
name|res_len
operator|*
literal|8
operator|||
name|os_memcmp
argument_list|(
name|attr
operator|->
name|res
argument_list|,
name|data
operator|->
name|res
argument_list|,
name|data
operator|->
name|res_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Challenge message did not "
literal|"include valid AT_RES (attr len=%lu, res len=%lu "
literal|"bits, expected %lu bits)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|attr
operator|->
name|res_len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|attr
operator|->
name|res_len_bits
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|data
operator|->
name|res_len
operator|*
literal|8
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Challenge response includes the "
literal|"correct AT_MAC"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|eap_sim_aka_result_ind
operator|&&
name|attr
operator|->
name|result_ind
condition|)
block|{
name|data
operator|->
name|use_result_ind
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_SUCCESS
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
block|}
else|else
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|next_pseudonym
condition|)
block|{
name|eap_sim_db_add_pseudonym
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|permanent
argument_list|,
name|data
operator|->
name|next_pseudonym
argument_list|)
expr_stmt|;
name|data
operator|->
name|next_pseudonym
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|next_reauth_id
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
ifdef|#
directive|ifdef
name|EAP_SERVER_AKA_PRIME
name|eap_sim_db_add_reauth_prime
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|permanent
argument_list|,
name|data
operator|->
name|next_reauth_id
argument_list|,
name|data
operator|->
name|counter
operator|+
literal|1
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|k_re
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* EAP_SERVER_AKA_PRIME */
block|}
else|else
block|{
name|eap_sim_db_add_reauth
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|permanent
argument_list|,
name|data
operator|->
name|next_reauth_id
argument_list|,
name|data
operator|->
name|counter
operator|+
literal|1
argument_list|,
name|data
operator|->
name|mk
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|next_reauth_id
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_process_sync_failure
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|respData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Processing Synchronization-Failure"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|auts
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Synchronization-Failure "
literal|"message did not include valid AT_AUTS"
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Avoid re-reporting AUTS when processing pending EAP packet by 	 * maintaining a local flag stating whether this AUTS has already been 	 * reported. */
if|if
condition|(
operator|!
name|data
operator|->
name|auts_reported
operator|&&
name|eap_sim_db_resynchronize
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|permanent
argument_list|,
name|attr
operator|->
name|auts
argument_list|,
name|data
operator|->
name|rand
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Resynchronization failed"
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
name|data
operator|->
name|auts_reported
operator|=
literal|1
expr_stmt|;
comment|/* Remain in CHALLENGE state to re-try after resynchronization */
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_process_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|respData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|u8
modifier|*
name|decrypted
init|=
name|NULL
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Processing Reauthentication"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|mac
operator|==
name|NULL
operator|||
name|eap_aka_verify_mac
argument_list|(
name|data
argument_list|,
name|respData
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Re-authentication message "
literal|"did not include valid AT_MAC"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|attr
operator|->
name|encr_data
operator|==
name|NULL
operator|||
name|attr
operator|->
name|iv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Reauthentication "
literal|"message did not include encrypted data"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Failed to parse encrypted "
literal|"data from reauthentication message"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|eattr
operator|.
name|counter
operator|!=
name|data
operator|->
name|counter
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-AKA: Re-authentication message "
literal|"used incorrect counter %u, expected %u"
argument_list|,
name|eattr
operator|.
name|counter
argument_list|,
name|data
operator|->
name|counter
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|decrypted
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Re-authentication response includes "
literal|"the correct AT_MAC"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eattr
operator|.
name|counter_too_small
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Re-authentication response "
literal|"included AT_COUNTER_TOO_SMALL - starting full "
literal|"authentication"
argument_list|)
expr_stmt|;
name|eap_aka_fullauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sm
operator|->
name|eap_sim_aka_result_ind
operator|&&
name|attr
operator|->
name|result_ind
condition|)
block|{
name|data
operator|->
name|use_result_ind
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_SUCCESS
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
block|}
else|else
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|next_reauth_id
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
block|{
ifdef|#
directive|ifdef
name|EAP_SERVER_AKA_PRIME
name|eap_sim_db_add_reauth_prime
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|permanent
argument_list|,
name|data
operator|->
name|next_reauth_id
argument_list|,
name|data
operator|->
name|counter
operator|+
literal|1
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|k_re
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* EAP_SERVER_AKA_PRIME */
block|}
else|else
block|{
name|eap_sim_db_add_reauth
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|permanent
argument_list|,
name|data
operator|->
name|next_reauth_id
argument_list|,
name|data
operator|->
name|counter
operator|+
literal|1
argument_list|,
name|data
operator|->
name|mk
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|next_reauth_id
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|eap_sim_db_remove_reauth
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|reauth
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
name|fail
label|:
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
name|eap_sim_db_remove_reauth
argument_list|(
name|sm
operator|->
name|eap_sim_db_priv
argument_list|,
name|data
operator|->
name|reauth
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_process_client_error
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|respData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Client reported error %d"
argument_list|,
name|attr
operator|->
name|client_error_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|notification
operator|==
name|EAP_SIM_SUCCESS
operator|&&
name|data
operator|->
name|use_result_ind
condition|)
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
else|else
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_process_authentication_reject
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|respData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Client rejected authentication"
argument_list|)
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_process_notification
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_aka_data
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|respData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Client replied to notification"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|notification
operator|==
name|EAP_SIM_SUCCESS
operator|&&
name|data
operator|->
name|use_result_ind
condition|)
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
else|else
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_aka_process
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|respData
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|subtype
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|eap_sim_attrs
name|attr
decl_stmt|;
name|pos
operator|=
name|eap_hdr_validate
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|data
operator|->
name|eap_method
argument_list|,
name|respData
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
operator|||
name|len
operator|<
literal|3
condition|)
return|return;
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
name|subtype
operator|=
operator|*
name|pos
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
name|eap_aka_subtype_ok
argument_list|(
name|data
argument_list|,
name|subtype
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Unrecognized or unexpected "
literal|"EAP-AKA Subtype in EAP Response"
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|eap_sim_parse_attr
argument_list|(
name|pos
argument_list|,
name|end
argument_list|,
operator|&
name|attr
argument_list|,
name|data
operator|->
name|eap_method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|?
literal|2
else|:
literal|1
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Failed to parse attributes"
argument_list|)
expr_stmt|;
name|data
operator|->
name|notification
operator|=
name|EAP_SIM_GENERAL_FAILURE_BEFORE_AUTH
expr_stmt|;
name|eap_aka_state
argument_list|(
name|data
argument_list|,
name|NOTIFICATION
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|subtype
operator|==
name|EAP_AKA_SUBTYPE_CLIENT_ERROR
condition|)
block|{
name|eap_aka_process_client_error
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|subtype
operator|==
name|EAP_AKA_SUBTYPE_AUTHENTICATION_REJECT
condition|)
block|{
name|eap_aka_process_authentication_reject
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|data
operator|->
name|state
condition|)
block|{
case|case
name|IDENTITY
case|:
name|eap_aka_process_identity
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|CHALLENGE
case|:
if|if
condition|(
name|subtype
operator|==
name|EAP_AKA_SUBTYPE_SYNCHRONIZATION_FAILURE
condition|)
block|{
name|eap_aka_process_sync_failure
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|eap_aka_process_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|REAUTH
case|:
name|eap_aka_process_reauth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|NOTIFICATION
case|:
name|eap_aka_process_notification
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|respData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-AKA: Unknown state %d in "
literal|"process"
argument_list|,
name|data
operator|->
name|state
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_aka_isDone
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|state
operator|==
name|SUCCESS
operator|||
name|data
operator|->
name|state
operator|==
name|FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_aka_getKey
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|SUCCESS
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|os_malloc
argument_list|(
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|EAP_SIM_KEYING_DATA_LEN
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_aka_get_emsk
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|SUCCESS
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|os_malloc
argument_list|(
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|emsk
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|EAP_EMSK_LEN
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_aka_isSuccess
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_aka_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|state
operator|==
name|SUCCESS
return|;
block|}
end_function

begin_function
name|int
name|eap_server_aka_register
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|eap_method
modifier|*
name|eap
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|eap
operator|=
name|eap_server_method_alloc
argument_list|(
name|EAP_SERVER_METHOD_INTERFACE_VERSION
argument_list|,
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_AKA
argument_list|,
literal|"AKA"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|eap
operator|->
name|init
operator|=
name|eap_aka_init
expr_stmt|;
name|eap
operator|->
name|reset
operator|=
name|eap_aka_reset
expr_stmt|;
name|eap
operator|->
name|buildReq
operator|=
name|eap_aka_buildReq
expr_stmt|;
name|eap
operator|->
name|check
operator|=
name|eap_aka_check
expr_stmt|;
name|eap
operator|->
name|process
operator|=
name|eap_aka_process
expr_stmt|;
name|eap
operator|->
name|isDone
operator|=
name|eap_aka_isDone
expr_stmt|;
name|eap
operator|->
name|getKey
operator|=
name|eap_aka_getKey
expr_stmt|;
name|eap
operator|->
name|isSuccess
operator|=
name|eap_aka_isSuccess
expr_stmt|;
name|eap
operator|->
name|get_emsk
operator|=
name|eap_aka_get_emsk
expr_stmt|;
name|ret
operator|=
name|eap_server_method_register
argument_list|(
name|eap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|eap_server_method_free
argument_list|(
name|eap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_SERVER_AKA_PRIME
end_ifdef

begin_function
name|int
name|eap_server_aka_prime_register
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|eap_method
modifier|*
name|eap
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|eap
operator|=
name|eap_server_method_alloc
argument_list|(
name|EAP_SERVER_METHOD_INTERFACE_VERSION
argument_list|,
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_AKA_PRIME
argument_list|,
literal|"AKA'"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|eap
operator|->
name|init
operator|=
name|eap_aka_prime_init
expr_stmt|;
name|eap
operator|->
name|reset
operator|=
name|eap_aka_reset
expr_stmt|;
name|eap
operator|->
name|buildReq
operator|=
name|eap_aka_buildReq
expr_stmt|;
name|eap
operator|->
name|check
operator|=
name|eap_aka_check
expr_stmt|;
name|eap
operator|->
name|process
operator|=
name|eap_aka_process
expr_stmt|;
name|eap
operator|->
name|isDone
operator|=
name|eap_aka_isDone
expr_stmt|;
name|eap
operator|->
name|getKey
operator|=
name|eap_aka_getKey
expr_stmt|;
name|eap
operator|->
name|isSuccess
operator|=
name|eap_aka_isSuccess
expr_stmt|;
name|eap
operator|->
name|get_emsk
operator|=
name|eap_aka_get_emsk
expr_stmt|;
name|ret
operator|=
name|eap_server_method_register
argument_list|(
name|eap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|eap_server_method_free
argument_list|(
name|eap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_SERVER_AKA_PRIME */
end_comment

end_unit


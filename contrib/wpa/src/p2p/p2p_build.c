begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * P2P - IE builder  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_i.h"
end_include

begin_include
include|#
directive|include
file|"p2p_i.h"
end_include

begin_function
name|void
name|p2p_buf_add_action_hdr
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u8
name|subtype
parameter_list|,
name|u8
name|dialog_token
parameter_list|)
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_ACTION_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
comment|/* OUI Subtype */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Dialog Token: %d"
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_public_action_hdr
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u8
name|subtype
parameter_list|,
name|u8
name|dialog_token
parameter_list|)
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_ACTION_PUBLIC
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_PA_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
comment|/* OUI Subtype */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Dialog Token: %d"
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u8
modifier|*
name|p2p_buf_add_ie_hdr
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
comment|/* P2P IE header */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_EID_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* IE length to be filled */
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * P2P IE header"
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|void
name|p2p_buf_update_ie_hdr
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u8
modifier|*
name|len
parameter_list|)
block|{
comment|/* Update P2P IE Length */
operator|*
name|len
operator|=
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|len
operator|-
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_capability
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u8
name|dev_capab
parameter_list|,
name|u8
name|group_capab
parameter_list|)
block|{
comment|/* P2P Capability */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_CAPABILITY
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|dev_capab
argument_list|)
expr_stmt|;
comment|/* Device Capabilities */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|group_capab
argument_list|)
expr_stmt|;
comment|/* Group Capabilities */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Capability dev=%02x group=%02x"
argument_list|,
name|dev_capab
argument_list|,
name|group_capab
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_go_intent
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u8
name|go_intent
parameter_list|)
block|{
comment|/* Group Owner Intent */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_GROUP_OWNER_INTENT
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|go_intent
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * GO Intent: Intent %u Tie breaker %u"
argument_list|,
name|go_intent
operator|>>
literal|1
argument_list|,
name|go_intent
operator|&
literal|0x01
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_listen_channel
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|country
parameter_list|,
name|u8
name|reg_class
parameter_list|,
name|u8
name|channel
parameter_list|)
block|{
comment|/* Listen Channel */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_LISTEN_CHANNEL
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|country
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|reg_class
argument_list|)
expr_stmt|;
comment|/* Regulatory Class */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|channel
argument_list|)
expr_stmt|;
comment|/* Channel Number */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Listen Channel: Regulatory Class %u "
literal|"Channel %u"
argument_list|,
name|reg_class
argument_list|,
name|channel
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_operating_channel
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|country
parameter_list|,
name|u8
name|reg_class
parameter_list|,
name|u8
name|channel
parameter_list|)
block|{
comment|/* Operating Channel */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_OPERATING_CHANNEL
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|country
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|reg_class
argument_list|)
expr_stmt|;
comment|/* Regulatory Class */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|channel
argument_list|)
expr_stmt|;
comment|/* Channel Number */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Operating Channel: Regulatory Class %u "
literal|"Channel %u"
argument_list|,
name|reg_class
argument_list|,
name|channel
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_channel_list
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|country
parameter_list|,
name|struct
name|p2p_channels
modifier|*
name|chan
parameter_list|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
name|size_t
name|i
decl_stmt|;
comment|/* Channel List */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_CHANNEL_LIST
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* IE length to be filled */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|country
argument_list|,
literal|3
argument_list|)
expr_stmt|;
comment|/* Country String */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|chan
operator|->
name|reg_classes
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|p2p_reg_class
modifier|*
name|c
init|=
operator|&
name|chan
operator|->
name|reg_class
index|[
name|i
index|]
decl_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|c
operator|->
name|reg_class
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|c
operator|->
name|channels
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|c
operator|->
name|channel
argument_list|,
name|c
operator|->
name|channels
argument_list|)
expr_stmt|;
block|}
comment|/* Update attribute length */
name|WPA_PUT_LE16
argument_list|(
name|len
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|len
operator|-
literal|2
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Channel List"
argument_list|,
name|len
operator|+
literal|2
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|len
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_status
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u8
name|status
parameter_list|)
block|{
comment|/* Status */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_STATUS
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Status: %d"
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_device_info
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|peer
parameter_list|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
name|u16
name|methods
decl_stmt|;
name|size_t
name|nlen
decl_stmt|,
name|i
decl_stmt|;
comment|/* P2P Device Info */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_DEVICE_INFO
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* IE length to be filled */
comment|/* P2P Device address */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* Config Methods */
name|methods
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|peer
operator|&&
name|peer
operator|->
name|wps_method
operator|!=
name|WPS_NOT_READY
condition|)
block|{
if|if
condition|(
name|peer
operator|->
name|wps_method
operator|==
name|WPS_PBC
condition|)
name|methods
operator||=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
elseif|else
if|if
condition|(
name|peer
operator|->
name|wps_method
operator|==
name|WPS_PIN_DISPLAY
operator|||
name|peer
operator|->
name|wps_method
operator|==
name|WPS_PIN_KEYPAD
condition|)
block|{
name|methods
operator||=
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_KEYPAD
expr_stmt|;
name|methods
operator||=
name|WPS_CONFIG_P2PS
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|p2p
operator|->
name|cfg
operator|->
name|config_methods
condition|)
block|{
name|methods
operator||=
name|p2p
operator|->
name|cfg
operator|->
name|config_methods
operator|&
operator|(
name|WPS_CONFIG_PUSHBUTTON
operator||
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_KEYPAD
operator||
name|WPS_CONFIG_P2PS
operator|)
expr_stmt|;
block|}
else|else
block|{
name|methods
operator||=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
name|methods
operator||=
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_KEYPAD
expr_stmt|;
name|methods
operator||=
name|WPS_CONFIG_P2PS
expr_stmt|;
block|}
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|methods
argument_list|)
expr_stmt|;
comment|/* Primary Device Type */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|pri_dev_type
argument_list|,
sizeof|sizeof
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|pri_dev_type
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Number of Secondary Device Types */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|num_sec_dev_types
argument_list|)
expr_stmt|;
comment|/* Secondary Device Type List */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|p2p
operator|->
name|cfg
operator|->
name|num_sec_dev_types
condition|;
name|i
operator|++
control|)
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|sec_dev_type
index|[
name|i
index|]
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
comment|/* Device Name */
name|nlen
operator|=
name|p2p
operator|->
name|cfg
operator|->
name|dev_name
condition|?
name|os_strlen
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|dev_name
argument_list|)
else|:
literal|0
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|ATTR_DEV_NAME
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|nlen
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_name
argument_list|,
name|nlen
argument_list|)
expr_stmt|;
comment|/* Update attribute length */
name|WPA_PUT_LE16
argument_list|(
name|len
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|len
operator|-
literal|2
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Device Info"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_device_id
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|)
block|{
comment|/* P2P Device ID */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_DEVICE_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Device ID: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_config_timeout
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u8
name|go_timeout
parameter_list|,
name|u8
name|client_timeout
parameter_list|)
block|{
comment|/* Configuration Timeout */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_CONFIGURATION_TIMEOUT
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|go_timeout
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|client_timeout
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Configuration Timeout: GO %d (*10ms)  "
literal|"client %d (*10ms)"
argument_list|,
name|go_timeout
argument_list|,
name|client_timeout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_intended_addr
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|u8
modifier|*
name|interface_addr
parameter_list|)
block|{
comment|/* Intended P2P Interface Address */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_INTENDED_INTERFACE_ADDR
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|interface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Intended P2P Interface Address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|interface_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_group_bssid
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
comment|/* P2P Group BSSID */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_GROUP_BSSID
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * P2P Group BSSID "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_group_id
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
comment|/* P2P Group ID */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_GROUP_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ETH_ALEN
operator|+
name|ssid_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * P2P Group ID "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: P2P Group ID SSID"
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_invitation_flags
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u8
name|flags
parameter_list|)
block|{
comment|/* Invitation Flags */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_INVITATION_FLAGS
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Invitation Flags: bitmap 0x%x"
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_buf_add_noa_desc
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|p2p_noa_desc
modifier|*
name|desc
parameter_list|)
block|{
if|if
condition|(
name|desc
operator|==
name|NULL
condition|)
return|return;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|desc
operator|->
name|count_type
argument_list|)
expr_stmt|;
name|wpabuf_put_le32
argument_list|(
name|buf
argument_list|,
name|desc
operator|->
name|duration
argument_list|)
expr_stmt|;
name|wpabuf_put_le32
argument_list|(
name|buf
argument_list|,
name|desc
operator|->
name|interval
argument_list|)
expr_stmt|;
name|wpabuf_put_le32
argument_list|(
name|buf
argument_list|,
name|desc
operator|->
name|start_time
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_noa
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u8
name|noa_index
parameter_list|,
name|u8
name|opp_ps
parameter_list|,
name|u8
name|ctwindow
parameter_list|,
name|struct
name|p2p_noa_desc
modifier|*
name|desc1
parameter_list|,
name|struct
name|p2p_noa_desc
modifier|*
name|desc2
parameter_list|)
block|{
comment|/* Notice of Absence */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_NOTICE_OF_ABSENCE
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|2
operator|+
operator|(
name|desc1
condition|?
literal|13
else|:
literal|0
operator|)
operator|+
operator|(
name|desc2
condition|?
literal|13
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|noa_index
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
operator|(
name|opp_ps
condition|?
literal|0x80
else|:
literal|0
operator|)
operator||
operator|(
name|ctwindow
operator|&
literal|0x7f
operator|)
argument_list|)
expr_stmt|;
name|p2p_buf_add_noa_desc
argument_list|(
name|buf
argument_list|,
name|desc1
argument_list|)
expr_stmt|;
name|p2p_buf_add_noa_desc
argument_list|(
name|buf
argument_list|,
name|desc2
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Notice of Absence"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_ext_listen_timing
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u16
name|period
parameter_list|,
name|u16
name|interval
parameter_list|)
block|{
comment|/* Extended Listen Timing */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_EXT_LISTEN_TIMING
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|period
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|interval
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Extended Listen Timing (period %u msec  "
literal|"interval %u msec)"
argument_list|,
name|period
argument_list|,
name|interval
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_p2p_interface
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|)
block|{
comment|/* P2P Interface */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_INTERFACE
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ETH_ALEN
operator|+
literal|1
operator|+
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* P2P Device address */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* 	 * FIX: Fetch interface address list from driver. Do not include 	 * the P2P Device address if it is never used as interface address. 	 */
comment|/* P2P Interface Address Count */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_oob_go_neg_channel
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|country
parameter_list|,
name|u8
name|oper_class
parameter_list|,
name|u8
name|channel
parameter_list|,
name|enum
name|p2p_role_indication
name|role
parameter_list|)
block|{
comment|/* OOB Group Owner Negotiation Channel */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_OOB_GO_NEG_CHANNEL
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|country
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|oper_class
argument_list|)
expr_stmt|;
comment|/* Operating Class */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|channel
argument_list|)
expr_stmt|;
comment|/* Channel Number */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
operator|(
name|u8
operator|)
name|role
argument_list|)
expr_stmt|;
comment|/* Role indication */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * OOB GO Negotiation Channel: Operating "
literal|"Class %u Channel %u Role %d"
argument_list|,
name|oper_class
argument_list|,
name|channel
argument_list|,
name|role
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_service_hash
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|)
block|{
if|if
condition|(
operator|!
name|p2p
condition|)
return|return;
comment|/* Service Hash */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_SERVICE_HASH
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|p2ps_seek_count
operator|*
name|P2PS_HASH_LEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|query_hash
argument_list|,
name|p2p
operator|->
name|p2ps_seek_count
operator|*
name|P2PS_HASH_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Service Hash"
argument_list|,
name|p2p
operator|->
name|query_hash
argument_list|,
name|p2p
operator|->
name|p2ps_seek_count
operator|*
name|P2PS_HASH_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_session_info
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|info
parameter_list|)
block|{
name|size_t
name|info_len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|info
operator|&&
name|info
index|[
literal|0
index|]
condition|)
name|info_len
operator|=
name|os_strlen
argument_list|(
name|info
argument_list|)
expr_stmt|;
comment|/* Session Information Data Info */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_SESSION_INFORMATION_DATA
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
operator|(
name|u16
operator|)
name|info_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
condition|)
block|{
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|info
argument_list|,
name|info_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Session Info Data (%s)"
argument_list|,
name|info
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|p2p_buf_add_connection_capability
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u8
name|connection_cap
parameter_list|)
block|{
comment|/* Connection Capability Info */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_CONNECTION_CAPABILITY
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|connection_cap
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Connection Capability: 0x%x"
argument_list|,
name|connection_cap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_advertisement_id
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u32
name|id
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac
parameter_list|)
block|{
if|if
condition|(
operator|!
name|buf
operator|||
operator|!
name|mac
condition|)
return|return;
comment|/* Advertisement ID Info */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_ADVERTISEMENT_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
call|(
name|u16
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|+
name|ETH_ALEN
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_le32
argument_list|(
name|buf
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|mac
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Advertisement ID (%x) "
name|MACSTR
argument_list|,
name|id
argument_list|,
name|MAC2STR
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_service_instance
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|u8
name|hash_count
parameter_list|,
specifier|const
name|u8
modifier|*
name|hash
parameter_list|,
name|struct
name|p2ps_advertisement
modifier|*
name|adv_list
parameter_list|)
block|{
name|struct
name|p2ps_advertisement
modifier|*
name|adv
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|tmp_buf
decl_stmt|;
name|u8
modifier|*
name|tag_len
init|=
name|NULL
decl_stmt|,
modifier|*
name|ie_len
init|=
name|NULL
decl_stmt|;
name|size_t
name|svc_len
init|=
literal|0
decl_stmt|,
name|remaining
init|=
literal|0
decl_stmt|,
name|total_len
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|adv_list
operator|||
operator|!
name|hash
condition|)
return|return;
comment|/* Allocate temp buffer, allowing for overflow of 1 instance */
name|tmp_buf
operator|=
name|wpabuf_alloc
argument_list|(
name|MAX_SVC_ADV_IE_LEN
operator|+
literal|256
operator|+
name|P2PS_HASH_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp_buf
condition|)
return|return;
for|for
control|(
name|adv
operator|=
name|adv_list
init|;
name|adv
operator|&&
name|total_len
operator|<=
name|MAX_SVC_ADV_LEN
condition|;
name|adv
operator|=
name|adv
operator|->
name|next
control|)
block|{
name|u8
name|count
init|=
name|hash_count
decl_stmt|;
specifier|const
name|u8
modifier|*
name|test
init|=
name|hash
decl_stmt|;
while|while
condition|(
name|count
operator|--
condition|)
block|{
comment|/* Check for wildcard */
if|if
condition|(
name|os_memcmp
argument_list|(
name|test
argument_list|,
name|p2p
operator|->
name|wild_card_hash
argument_list|,
name|P2PS_HASH_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|total_len
operator|=
name|MAX_SVC_ADV_LEN
operator|+
literal|1
expr_stmt|;
goto|goto
name|wild_hash
goto|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|test
argument_list|,
name|adv
operator|->
name|hash
argument_list|,
name|P2PS_HASH_LEN
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|hash_match
goto|;
name|test
operator|+=
name|P2PS_HASH_LEN
expr_stmt|;
block|}
comment|/* No matches found - Skip this Adv Instance */
continue|continue;
name|hash_match
label|:
if|if
condition|(
operator|!
name|tag_len
condition|)
block|{
name|tag_len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|tmp_buf
argument_list|)
expr_stmt|;
name|remaining
operator|=
literal|255
operator|-
literal|4
expr_stmt|;
if|if
condition|(
operator|!
name|ie_len
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
name|tmp_buf
argument_list|,
name|P2P_ATTR_ADVERTISED_SERVICE
argument_list|)
expr_stmt|;
name|ie_len
operator|=
name|wpabuf_put
argument_list|(
name|tmp_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
argument_list|)
expr_stmt|;
name|remaining
operator|-=
operator|(
sizeof|sizeof
argument_list|(
name|u8
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
operator|)
expr_stmt|;
block|}
block|}
name|svc_len
operator|=
name|os_strlen
argument_list|(
name|adv
operator|->
name|svc_name
argument_list|)
expr_stmt|;
if|if
condition|(
literal|7
operator|+
name|svc_len
operator|+
name|total_len
operator|>
name|MAX_SVC_ADV_LEN
condition|)
block|{
comment|/* Can't fit... return wildcard */
name|total_len
operator|=
name|MAX_SVC_ADV_LEN
operator|+
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|remaining
operator|<=
operator|(
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|id
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|config_methods
argument_list|)
operator|)
condition|)
block|{
name|size_t
name|front
init|=
name|remaining
decl_stmt|;
name|size_t
name|back
init|=
operator|(
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|id
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|config_methods
argument_list|)
operator|)
operator|-
name|front
decl_stmt|;
name|u8
name|holder
index|[
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|id
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|config_methods
argument_list|)
index|]
decl_stmt|;
comment|/* This works even if front or back == 0 */
name|WPA_PUT_LE32
argument_list|(
name|holder
argument_list|,
name|adv
operator|->
name|id
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
operator|&
name|holder
index|[
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|id
argument_list|)
index|]
argument_list|,
name|adv
operator|->
name|config_methods
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|tmp_buf
argument_list|,
name|holder
argument_list|,
name|front
argument_list|)
expr_stmt|;
name|p2p_buf_update_ie_hdr
argument_list|(
name|tmp_buf
argument_list|,
name|tag_len
argument_list|)
expr_stmt|;
name|tag_len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|tmp_buf
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|tmp_buf
argument_list|,
operator|&
name|holder
index|[
name|front
index|]
argument_list|,
name|back
argument_list|)
expr_stmt|;
name|remaining
operator|=
literal|255
operator|-
operator|(
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|id
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|config_methods
argument_list|)
operator|)
operator|-
name|back
expr_stmt|;
block|}
else|else
block|{
name|wpabuf_put_le32
argument_list|(
name|tmp_buf
argument_list|,
name|adv
operator|->
name|id
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|tmp_buf
argument_list|,
name|adv
operator|->
name|config_methods
argument_list|)
expr_stmt|;
name|remaining
operator|-=
operator|(
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|id
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|adv
operator|->
name|config_methods
argument_list|)
operator|)
expr_stmt|;
block|}
comment|/* We are guaranteed at least one byte for svc_len */
name|wpabuf_put_u8
argument_list|(
name|tmp_buf
argument_list|,
name|svc_len
argument_list|)
expr_stmt|;
name|remaining
operator|-=
sizeof|sizeof
argument_list|(
name|u8
argument_list|)
expr_stmt|;
if|if
condition|(
name|remaining
operator|<
name|svc_len
condition|)
block|{
name|size_t
name|front
init|=
name|remaining
decl_stmt|;
name|size_t
name|back
init|=
name|svc_len
operator|-
name|front
decl_stmt|;
name|wpabuf_put_data
argument_list|(
name|tmp_buf
argument_list|,
name|adv
operator|->
name|svc_name
argument_list|,
name|front
argument_list|)
expr_stmt|;
name|p2p_buf_update_ie_hdr
argument_list|(
name|tmp_buf
argument_list|,
name|tag_len
argument_list|)
expr_stmt|;
name|tag_len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|tmp_buf
argument_list|)
expr_stmt|;
comment|/* In rare cases, we must split across 3 attributes */
if|if
condition|(
name|back
operator|>
literal|255
operator|-
literal|4
condition|)
block|{
name|wpabuf_put_data
argument_list|(
name|tmp_buf
argument_list|,
operator|&
name|adv
operator|->
name|svc_name
index|[
name|front
index|]
argument_list|,
literal|255
operator|-
literal|4
argument_list|)
expr_stmt|;
name|back
operator|-=
literal|255
operator|-
literal|4
expr_stmt|;
name|front
operator|+=
literal|255
operator|-
literal|4
expr_stmt|;
name|p2p_buf_update_ie_hdr
argument_list|(
name|tmp_buf
argument_list|,
name|tag_len
argument_list|)
expr_stmt|;
name|tag_len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|tmp_buf
argument_list|)
expr_stmt|;
block|}
name|wpabuf_put_data
argument_list|(
name|tmp_buf
argument_list|,
operator|&
name|adv
operator|->
name|svc_name
index|[
name|front
index|]
argument_list|,
name|back
argument_list|)
expr_stmt|;
name|remaining
operator|=
literal|255
operator|-
literal|4
operator|-
name|back
expr_stmt|;
block|}
else|else
block|{
name|wpabuf_put_data
argument_list|(
name|tmp_buf
argument_list|,
name|adv
operator|->
name|svc_name
argument_list|,
name|svc_len
argument_list|)
expr_stmt|;
name|remaining
operator|-=
name|svc_len
expr_stmt|;
block|}
comment|/*           adv_id      config_methods     svc_string */
name|total_len
operator|+=
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u8
argument_list|)
operator|+
name|svc_len
expr_stmt|;
block|}
if|if
condition|(
name|tag_len
condition|)
name|p2p_buf_update_ie_hdr
argument_list|(
name|tmp_buf
argument_list|,
name|tag_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie_len
condition|)
name|WPA_PUT_LE16
argument_list|(
name|ie_len
argument_list|,
operator|(
name|u16
operator|)
name|total_len
argument_list|)
expr_stmt|;
name|wild_hash
label|:
comment|/* If all fit, return matching instances, otherwise the wildcard */
if|if
condition|(
name|total_len
operator|<=
name|MAX_SVC_ADV_LEN
condition|)
block|{
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|tmp_buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|wild_card
init|=
name|P2PS_WILD_HASH_STR
decl_stmt|;
name|u8
name|wild_len
decl_stmt|;
comment|/* Insert wildcard instance */
name|tag_len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_ADVERTISED_SERVICE
argument_list|)
expr_stmt|;
name|ie_len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
argument_list|)
expr_stmt|;
name|wild_len
operator|=
operator|(
name|u8
operator|)
name|os_strlen
argument_list|(
name|wild_card
argument_list|)
expr_stmt|;
name|wpabuf_put_le32
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|wild_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|wild_card
argument_list|,
name|wild_len
argument_list|)
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|ie_len
argument_list|,
literal|4
operator|+
literal|2
operator|+
literal|1
operator|+
name|wild_len
argument_list|)
expr_stmt|;
name|p2p_buf_update_ie_hdr
argument_list|(
name|buf
argument_list|,
name|tag_len
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|tmp_buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_session_id
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u32
name|id
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac
parameter_list|)
block|{
if|if
condition|(
operator|!
name|buf
operator|||
operator|!
name|mac
condition|)
return|return;
comment|/* Session ID Info */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_SESSION_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
call|(
name|u16
call|)
argument_list|(
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|+
name|ETH_ALEN
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_le32
argument_list|(
name|buf
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|mac
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Session ID Info (%x) "
name|MACSTR
argument_list|,
name|id
argument_list|,
name|MAC2STR
argument_list|(
name|mac
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_feature_capability
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|u16
name|len
parameter_list|,
specifier|const
name|u8
modifier|*
name|mask
parameter_list|)
block|{
if|if
condition|(
operator|!
name|buf
operator|||
operator|!
name|len
operator|||
operator|!
name|mask
condition|)
return|return;
comment|/* Feature Capability */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_FEATURE_CAPABILITY
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|mask
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Feature Capability (%d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_buf_add_persistent_group_info
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
comment|/* P2P Group ID */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|P2P_ATTR_PERSISTENT_GROUP
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ETH_ALEN
operator|+
name|ssid_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * P2P Group ID "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|p2p_add_wps_string
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|enum
name|wps_attribute
name|attr
parameter_list|,
specifier|const
name|char
modifier|*
name|val
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|len
operator|=
name|val
condition|?
name|os_strlen
argument_list|(
name|val
argument_list|)
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
operator|<
literal|4
operator|+
name|len
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|attr
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_WPS_STRICT
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Some deployed WPS implementations fail to parse zeor-length 		 * attributes. As a workaround, send a space character if the 		 * device attribute string is empty. 		 */
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
operator|<
literal|3
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|val
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|p2p_build_wps_ie
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|int
name|pw_id
parameter_list|,
name|int
name|all_attr
parameter_list|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
operator|<
literal|6
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_EID_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|WPS_DEV_OUI_WFA
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|buf
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|all_attr
condition|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
operator|<
literal|5
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|ATTR_WPS_STATE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WPS_STATE_NOT_CONFIGURED
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pw_id
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
operator|<
literal|6
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Device Password ID */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|ATTR_DEV_PASSWORD_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: WPS IE Device Password ID: %d"
argument_list|,
name|pw_id
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|pw_id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|all_attr
condition|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
operator|<
literal|5
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|ATTR_RESPONSE_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WPS_RESP_ENROLLEE_INFO
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_build_uuid_e
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|uuid
argument_list|)
operator|<
literal|0
operator|||
name|p2p_add_wps_string
argument_list|(
name|buf
argument_list|,
name|ATTR_MANUFACTURER
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|manufacturer
argument_list|)
operator|<
literal|0
operator|||
name|p2p_add_wps_string
argument_list|(
name|buf
argument_list|,
name|ATTR_MODEL_NAME
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|model_name
argument_list|)
operator|<
literal|0
operator|||
name|p2p_add_wps_string
argument_list|(
name|buf
argument_list|,
name|ATTR_MODEL_NUMBER
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|model_number
argument_list|)
operator|<
literal|0
operator|||
name|p2p_add_wps_string
argument_list|(
name|buf
argument_list|,
name|ATTR_SERIAL_NUMBER
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|serial_number
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
operator|<
literal|4
operator|+
name|WPS_DEV_TYPE_LEN
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|ATTR_PRIMARY_DEV_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|pri_dev_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_add_wps_string
argument_list|(
name|buf
argument_list|,
name|ATTR_DEV_NAME
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_name
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
operator|<
literal|6
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|ATTR_CONFIG_METHODS
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|config_methods
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wps_build_wfa_ext
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|all_attr
operator|&&
name|p2p
operator|->
name|cfg
operator|->
name|num_sec_dev_types
condition|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
operator|<
literal|4
operator|+
name|WPS_DEV_TYPE_LEN
operator|*
name|p2p
operator|->
name|cfg
operator|->
name|num_sec_dev_types
condition|)
return|return
operator|-
literal|1
return|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|ATTR_SECONDARY_DEV_TYPE_LIST
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|WPS_DEV_TYPE_LEN
operator|*
name|p2p
operator|->
name|cfg
operator|->
name|num_sec_dev_types
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|sec_dev_type
argument_list|,
name|WPS_DEV_TYPE_LEN
operator|*
name|p2p
operator|->
name|cfg
operator|->
name|num_sec_dev_types
argument_list|)
expr_stmt|;
block|}
comment|/* Add the WPS vendor extensions */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|P2P_MAX_WPS_VENDOR_EXT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p2p
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|==
name|NULL
condition|)
break|break;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
operator|<
literal|4
operator|+
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
argument_list|)
condition|)
continue|continue;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|ATTR_VENDOR_EXT
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|p2p_buf_update_ie_hdr
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


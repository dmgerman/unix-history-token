begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * P2P - IE parser  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_i.h"
end_include

begin_include
include|#
directive|include
file|"p2p_i.h"
end_include

begin_function
specifier|static
name|int
name|p2p_parse_attribute
parameter_list|(
name|u8
name|id
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|u16
name|len
parameter_list|,
name|struct
name|p2p_message
modifier|*
name|msg
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|nlen
decl_stmt|;
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|P2P_ATTR_CAPABILITY
case|:
if|if
condition|(
name|len
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Capability "
literal|"attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|capability
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Device Capability %02x "
literal|"Group Capability %02x"
argument_list|,
name|data
index|[
literal|0
index|]
argument_list|,
name|data
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_DEVICE_ID
case|:
if|if
condition|(
name|len
operator|<
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Device ID "
literal|"attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|device_id
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Device ID "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|msg
operator|->
name|device_id
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_GROUP_OWNER_INTENT
case|:
if|if
condition|(
name|len
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short GO Intent "
literal|"attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|go_intent
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * GO Intent: Intent %u "
literal|"Tie breaker %u"
argument_list|,
name|data
index|[
literal|0
index|]
operator|>>
literal|1
argument_list|,
name|data
index|[
literal|0
index|]
operator|&
literal|0x01
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_STATUS
case|:
if|if
condition|(
name|len
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Status "
literal|"attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|status
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Status: %d"
argument_list|,
name|data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_LISTEN_CHANNEL
case|:
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Listen Channel: Ignore "
literal|"null channel"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|len
operator|<
literal|5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Listen Channel "
literal|"attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|listen_channel
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Listen Channel: "
literal|"Country %c%c(0x%02x) Regulatory "
literal|"Class %d Channel Number %d"
argument_list|,
name|data
index|[
literal|0
index|]
argument_list|,
name|data
index|[
literal|1
index|]
argument_list|,
name|data
index|[
literal|2
index|]
argument_list|,
name|data
index|[
literal|3
index|]
argument_list|,
name|data
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_OPERATING_CHANNEL
case|:
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Operating Channel: "
literal|"Ignore null channel"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|len
operator|<
literal|5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Operating "
literal|"Channel attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|operating_channel
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Operating Channel: "
literal|"Country %c%c(0x%02x) Regulatory "
literal|"Class %d Channel Number %d"
argument_list|,
name|data
index|[
literal|0
index|]
argument_list|,
name|data
index|[
literal|1
index|]
argument_list|,
name|data
index|[
literal|2
index|]
argument_list|,
name|data
index|[
literal|3
index|]
argument_list|,
name|data
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_CHANNEL_LIST
case|:
if|if
condition|(
name|len
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Channel List "
literal|"attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|channel_list
operator|=
name|data
expr_stmt|;
name|msg
operator|->
name|channel_list_len
operator|=
name|len
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Channel List: Country String "
literal|"'%c%c(0x%02x)'"
argument_list|,
name|data
index|[
literal|0
index|]
argument_list|,
name|data
index|[
literal|1
index|]
argument_list|,
name|data
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Channel List"
argument_list|,
name|msg
operator|->
name|channel_list
argument_list|,
name|msg
operator|->
name|channel_list_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_GROUP_INFO
case|:
name|msg
operator|->
name|group_info
operator|=
name|data
expr_stmt|;
name|msg
operator|->
name|group_info_len
operator|=
name|len
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Group Info"
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_DEVICE_INFO
case|:
if|if
condition|(
name|len
operator|<
name|ETH_ALEN
operator|+
literal|2
operator|+
literal|8
operator|+
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Device Info "
literal|"attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|p2p_device_info
operator|=
name|data
expr_stmt|;
name|msg
operator|->
name|p2p_device_info_len
operator|=
name|len
expr_stmt|;
name|pos
operator|=
name|data
expr_stmt|;
name|msg
operator|->
name|p2p_device_addr
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
name|msg
operator|->
name|config_methods
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|msg
operator|->
name|pri_dev_type
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|8
expr_stmt|;
name|msg
operator|->
name|num_sec_dev_types
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|num_sec_dev_types
operator|*
literal|8
operator|>
name|data
operator|+
name|len
operator|-
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Device Info underflow"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
name|msg
operator|->
name|num_sec_dev_types
operator|*
literal|8
expr_stmt|;
if|if
condition|(
name|data
operator|+
name|len
operator|-
name|pos
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid Device Name "
literal|"length %d"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|data
operator|+
name|len
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
operator|!=
name|ATTR_DEV_NAME
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unexpected Device Name "
literal|"header"
argument_list|,
name|pos
argument_list|,
literal|4
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
name|nlen
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|data
operator|+
name|len
operator|-
name|pos
operator|<
operator|(
name|int
operator|)
name|nlen
operator|||
name|nlen
operator|>
literal|32
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid Device Name "
literal|"length %d (buf len %d)"
argument_list|,
operator|(
name|int
operator|)
name|nlen
argument_list|,
call|(
name|int
call|)
argument_list|(
name|data
operator|+
name|len
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|msg
operator|->
name|device_name
argument_list|,
name|pos
argument_list|,
name|nlen
argument_list|)
expr_stmt|;
name|msg
operator|->
name|device_name
index|[
name|nlen
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nlen
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|msg
operator|->
name|device_name
index|[
name|i
index|]
operator|==
literal|'\0'
condition|)
break|break;
if|if
condition|(
name|msg
operator|->
name|device_name
index|[
name|i
index|]
operator|>
literal|0
operator|&&
name|msg
operator|->
name|device_name
index|[
name|i
index|]
operator|<
literal|32
condition|)
name|msg
operator|->
name|device_name
index|[
name|i
index|]
operator|=
literal|'_'
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Device Info: addr "
name|MACSTR
literal|" primary device type %s device name '%s' "
literal|"config methods 0x%x"
argument_list|,
name|MAC2STR
argument_list|(
name|msg
operator|->
name|p2p_device_addr
argument_list|)
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|msg
operator|->
name|pri_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|,
name|msg
operator|->
name|device_name
argument_list|,
name|msg
operator|->
name|config_methods
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_CONFIGURATION_TIMEOUT
case|:
if|if
condition|(
name|len
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Configuration "
literal|"Timeout attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|config_timeout
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Configuration Timeout"
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_INTENDED_INTERFACE_ADDR
case|:
if|if
condition|(
name|len
operator|<
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Intended P2P "
literal|"Interface Address attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|intended_addr
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Intended P2P Interface Address: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|msg
operator|->
name|intended_addr
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_GROUP_BSSID
case|:
if|if
condition|(
name|len
operator|<
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short P2P Group BSSID "
literal|"attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|group_bssid
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * P2P Group BSSID: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|msg
operator|->
name|group_bssid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_GROUP_ID
case|:
if|if
condition|(
name|len
operator|<
name|ETH_ALEN
operator|||
name|len
operator|>
name|ETH_ALEN
operator|+
literal|32
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid P2P Group ID "
literal|"attribute length %d"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|group_id
operator|=
name|data
expr_stmt|;
name|msg
operator|->
name|group_id_len
operator|=
name|len
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * P2P Group ID: Device Address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|msg
operator|->
name|group_id
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * P2P Group ID: SSID"
argument_list|,
name|msg
operator|->
name|group_id
operator|+
name|ETH_ALEN
argument_list|,
name|msg
operator|->
name|group_id_len
operator|-
name|ETH_ALEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_INVITATION_FLAGS
case|:
if|if
condition|(
name|len
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Invitation "
literal|"Flag attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|invitation_flags
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Invitation Flags: bitmap 0x%x"
argument_list|,
name|data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_MANAGEABILITY
case|:
if|if
condition|(
name|len
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Manageability "
literal|"attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|manageability
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Manageability: bitmap 0x%x"
argument_list|,
name|data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_NOTICE_OF_ABSENCE
case|:
if|if
condition|(
name|len
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Notice of "
literal|"Absence attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|noa
operator|=
name|data
expr_stmt|;
name|msg
operator|->
name|noa_len
operator|=
name|len
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Notice of Absence"
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_EXT_LISTEN_TIMING
case|:
if|if
condition|(
name|len
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Extended Listen "
literal|"Timing attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|ext_listen_timing
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Extended Listen Timing "
literal|"(period %u msec  interval %u msec)"
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|msg
operator|->
name|ext_listen_timing
argument_list|)
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|msg
operator|->
name|ext_listen_timing
operator|+
literal|2
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_ATTR_MINOR_REASON_CODE
case|:
if|if
condition|(
name|len
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Too short Minor Reason "
literal|"Code attribute (length %d)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|minor_reason_code
operator|=
name|data
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Minor Reason Code: %u"
argument_list|,
operator|*
name|msg
operator|->
name|minor_reason_code
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Skipped unknown attribute %d "
literal|"(length %d)"
argument_list|,
name|id
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * p2p_parse_p2p_ie - Parse P2P IE  * @buf: Concatenated P2P IE(s) payload  * @msg: Buffer for returning parsed attributes  * Returns: 0 on success, -1 on failure  *  * Note: Caller is responsible for clearing the msg data structure before  * calling this function.  */
end_comment

begin_function
name|int
name|p2p_parse_p2p_ie
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|p2p_message
modifier|*
name|msg
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|wpabuf_head_u8
argument_list|(
name|buf
argument_list|)
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Parsing P2P IE"
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|u16
name|attr_len
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|>=
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid P2P attribute"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr_len
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
operator|+
literal|1
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Attribute %d length %u"
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|,
name|attr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|3
operator|+
name|attr_len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Attribute underflow "
literal|"(len=%u left=%d)"
argument_list|,
name|attr_len
argument_list|,
call|(
name|int
call|)
argument_list|(
name|end
operator|-
name|pos
operator|-
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Data"
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|p2p_parse_attribute
argument_list|(
name|pos
index|[
literal|0
index|]
argument_list|,
name|pos
operator|+
literal|3
argument_list|,
name|attr_len
argument_list|,
name|msg
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
literal|3
operator|+
name|attr_len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p2p_parse_wps_ie
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|p2p_message
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Parsing WPS IE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|buf
argument_list|,
operator|&
name|attr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|attr
operator|.
name|dev_name
operator|&&
name|attr
operator|.
name|dev_name_len
operator|<
sizeof|sizeof
argument_list|(
name|msg
operator|->
name|device_name
argument_list|)
operator|&&
operator|!
name|msg
operator|->
name|device_name
index|[
literal|0
index|]
condition|)
name|os_memcpy
argument_list|(
name|msg
operator|->
name|device_name
argument_list|,
name|attr
operator|.
name|dev_name
argument_list|,
name|attr
operator|.
name|dev_name_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|config_methods
condition|)
block|{
name|msg
operator|->
name|wps_config_methods
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|config_methods
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Config Methods (WPS): 0x%x"
argument_list|,
name|msg
operator|->
name|wps_config_methods
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|dev_password_id
condition|)
block|{
name|msg
operator|->
name|dev_password_id
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|dev_password_id
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Device Password ID: %d"
argument_list|,
name|msg
operator|->
name|dev_password_id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|primary_dev_type
condition|)
block|{
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|msg
operator|->
name|wps_pri_dev_type
operator|=
name|attr
operator|.
name|primary_dev_type
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Primary Device Type (WPS): %s"
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|msg
operator|->
name|wps_pri_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|sec_dev_type_list
condition|)
block|{
name|msg
operator|->
name|wps_sec_dev_type_list
operator|=
name|attr
operator|.
name|sec_dev_type_list
expr_stmt|;
name|msg
operator|->
name|wps_sec_dev_type_list_len
operator|=
name|attr
operator|.
name|sec_dev_type_list_len
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|P2P_MAX_WPS_VENDOR_EXT
condition|;
name|i
operator|++
control|)
block|{
name|msg
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|=
name|attr
operator|.
name|vendor_ext
index|[
name|i
index|]
expr_stmt|;
name|msg
operator|->
name|wps_vendor_ext_len
index|[
name|i
index|]
operator|=
name|attr
operator|.
name|vendor_ext_len
index|[
name|i
index|]
expr_stmt|;
block|}
name|msg
operator|->
name|manufacturer
operator|=
name|attr
operator|.
name|manufacturer
expr_stmt|;
name|msg
operator|->
name|manufacturer_len
operator|=
name|attr
operator|.
name|manufacturer_len
expr_stmt|;
name|msg
operator|->
name|model_name
operator|=
name|attr
operator|.
name|model_name
expr_stmt|;
name|msg
operator|->
name|model_name_len
operator|=
name|attr
operator|.
name|model_name_len
expr_stmt|;
name|msg
operator|->
name|model_number
operator|=
name|attr
operator|.
name|model_number
expr_stmt|;
name|msg
operator|->
name|model_number_len
operator|=
name|attr
operator|.
name|model_number_len
expr_stmt|;
name|msg
operator|->
name|serial_number
operator|=
name|attr
operator|.
name|serial_number
expr_stmt|;
name|msg
operator|->
name|serial_number_len
operator|=
name|attr
operator|.
name|serial_number_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * p2p_parse_ies - Parse P2P message IEs (both WPS and P2P IE)  * @data: IEs from the message  * @len: Length of data buffer in octets  * @msg: Buffer for returning parsed attributes  * Returns: 0 on success, -1 on failure  *  * Note: Caller is responsible for clearing the msg data structure before  * calling this function.  *  * Note: Caller must free temporary memory allocations by calling  * p2p_parse_free() when the parsed data is not needed anymore.  */
end_comment

begin_function
name|int
name|p2p_parse_ies
parameter_list|(
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|p2p_message
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|ieee802_11_parse_elems
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|elems
operator|.
name|ds_params
operator|&&
name|elems
operator|.
name|ds_params_len
operator|>=
literal|1
condition|)
name|msg
operator|->
name|ds_params
operator|=
name|elems
operator|.
name|ds_params
expr_stmt|;
if|if
condition|(
name|elems
operator|.
name|ssid
condition|)
name|msg
operator|->
name|ssid
operator|=
name|elems
operator|.
name|ssid
operator|-
literal|2
expr_stmt|;
name|msg
operator|->
name|wps_attributes
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
name|WPS_DEV_OUI_WFA
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|wps_attributes
operator|&&
name|p2p_parse_wps_ie
argument_list|(
name|msg
operator|->
name|wps_attributes
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|p2p_parse_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|p2p_attributes
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|p2p_attributes
operator|&&
name|p2p_parse_p2p_ie
argument_list|(
name|msg
operator|->
name|p2p_attributes
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to parse P2P IE data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|->
name|p2p_attributes
condition|)
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: P2P IE data"
argument_list|,
name|msg
operator|->
name|p2p_attributes
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|elems
operator|.
name|wfd
condition|)
block|{
name|msg
operator|->
name|wfd_subelems
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
name|WFD_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * p2p_parse - Parse a P2P Action frame contents  * @data: Action frame payload after Category and Code fields  * @len: Length of data buffer in octets  * @msg: Buffer for returning parsed attributes  * Returns: 0 on success, -1 on failure  *  * Note: Caller must free temporary memory allocations by calling  * p2p_parse_free() when the parsed data is not needed anymore.  */
end_comment

begin_function
name|int
name|p2p_parse
parameter_list|(
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|p2p_message
modifier|*
name|msg
parameter_list|)
block|{
name|os_memset
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Parsing the received message"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No Dialog Token in the message"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg
operator|->
name|dialog_token
operator|=
name|data
index|[
literal|0
index|]
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: * Dialog Token: %d"
argument_list|,
name|msg
operator|->
name|dialog_token
argument_list|)
expr_stmt|;
return|return
name|p2p_parse_ies
argument_list|(
name|data
operator|+
literal|1
argument_list|,
name|len
operator|-
literal|1
argument_list|,
name|msg
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * p2p_parse_free - Free temporary data from P2P parsing  * @msg: Parsed attributes  */
end_comment

begin_function
name|void
name|p2p_parse_free
parameter_list|(
name|struct
name|p2p_message
modifier|*
name|msg
parameter_list|)
block|{
name|wpabuf_free
argument_list|(
name|msg
operator|->
name|p2p_attributes
argument_list|)
expr_stmt|;
name|msg
operator|->
name|p2p_attributes
operator|=
name|NULL
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
operator|->
name|wps_attributes
argument_list|)
expr_stmt|;
name|msg
operator|->
name|wps_attributes
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
name|wpabuf_free
argument_list|(
name|msg
operator|->
name|wfd_subelems
argument_list|)
expr_stmt|;
name|msg
operator|->
name|wfd_subelems
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
block|}
end_function

begin_function
name|int
name|p2p_group_info_parse
parameter_list|(
specifier|const
name|u8
modifier|*
name|gi
parameter_list|,
name|size_t
name|gi_len
parameter_list|,
name|struct
name|p2p_group_info
modifier|*
name|info
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|g
decl_stmt|,
modifier|*
name|gend
decl_stmt|;
name|os_memset
argument_list|(
name|info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|gi
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|g
operator|=
name|gi
expr_stmt|;
name|gend
operator|=
name|gi
operator|+
name|gi_len
expr_stmt|;
while|while
condition|(
name|g
operator|<
name|gend
condition|)
block|{
name|struct
name|p2p_client_info
modifier|*
name|cli
decl_stmt|;
specifier|const
name|u8
modifier|*
name|t
decl_stmt|,
modifier|*
name|cend
decl_stmt|;
name|int
name|count
decl_stmt|;
name|cli
operator|=
operator|&
name|info
operator|->
name|client
index|[
name|info
operator|->
name|num_clients
index|]
expr_stmt|;
name|cend
operator|=
name|g
operator|+
literal|1
operator|+
name|g
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|cend
operator|>
name|gend
condition|)
return|return
operator|-
literal|1
return|;
comment|/* invalid data */
comment|/* g at start of P2P Client Info Descriptor */
comment|/* t at Device Capability Bitmap */
name|t
operator|=
name|g
operator|+
literal|1
operator|+
literal|2
operator|*
name|ETH_ALEN
expr_stmt|;
if|if
condition|(
name|t
operator|>
name|cend
condition|)
return|return
operator|-
literal|1
return|;
comment|/* invalid data */
name|cli
operator|->
name|p2p_device_addr
operator|=
name|g
operator|+
literal|1
expr_stmt|;
name|cli
operator|->
name|p2p_interface_addr
operator|=
name|g
operator|+
literal|1
operator|+
name|ETH_ALEN
expr_stmt|;
name|cli
operator|->
name|dev_capab
operator|=
name|t
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|t
operator|+
literal|1
operator|+
literal|2
operator|+
literal|8
operator|+
literal|1
operator|>
name|cend
condition|)
return|return
operator|-
literal|1
return|;
comment|/* invalid data */
name|cli
operator|->
name|config_methods
operator|=
name|WPA_GET_BE16
argument_list|(
operator|&
name|t
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|cli
operator|->
name|pri_dev_type
operator|=
operator|&
name|t
index|[
literal|3
index|]
expr_stmt|;
name|t
operator|+=
literal|1
operator|+
literal|2
operator|+
literal|8
expr_stmt|;
comment|/* t at Number of Secondary Device Types */
name|cli
operator|->
name|num_sec_dev_types
operator|=
operator|*
name|t
operator|++
expr_stmt|;
if|if
condition|(
name|t
operator|+
literal|8
operator|*
name|cli
operator|->
name|num_sec_dev_types
operator|>
name|cend
condition|)
return|return
operator|-
literal|1
return|;
comment|/* invalid data */
name|cli
operator|->
name|sec_dev_types
operator|=
name|t
expr_stmt|;
name|t
operator|+=
literal|8
operator|*
name|cli
operator|->
name|num_sec_dev_types
expr_stmt|;
comment|/* t at Device Name in WPS TLV format */
if|if
condition|(
name|t
operator|+
literal|2
operator|+
literal|2
operator|>
name|cend
condition|)
return|return
operator|-
literal|1
return|;
comment|/* invalid data */
if|if
condition|(
name|WPA_GET_BE16
argument_list|(
name|t
argument_list|)
operator|!=
name|ATTR_DEV_NAME
condition|)
return|return
operator|-
literal|1
return|;
comment|/* invalid Device Name TLV */
name|t
operator|+=
literal|2
expr_stmt|;
name|count
operator|=
name|WPA_GET_BE16
argument_list|(
name|t
argument_list|)
expr_stmt|;
name|t
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|count
operator|>
name|cend
operator|-
name|t
condition|)
return|return
operator|-
literal|1
return|;
comment|/* invalid Device Name TLV */
if|if
condition|(
name|count
operator|>=
literal|32
condition|)
name|count
operator|=
literal|32
expr_stmt|;
name|cli
operator|->
name|dev_name
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|t
expr_stmt|;
name|cli
operator|->
name|dev_name_len
operator|=
name|count
expr_stmt|;
name|g
operator|=
name|cend
expr_stmt|;
name|info
operator|->
name|num_clients
operator|++
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|num_clients
operator|==
name|P2P_MAX_GROUP_ENTRIES
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p2p_group_info_text
parameter_list|(
specifier|const
name|u8
modifier|*
name|gi
parameter_list|,
name|size_t
name|gi_len
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
name|end
parameter_list|)
block|{
name|char
modifier|*
name|pos
init|=
name|buf
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|p2p_group_info
name|info
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|p2p_group_info_parse
argument_list|(
name|gi
argument_list|,
name|gi_len
argument_list|,
operator|&
name|info
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|info
operator|.
name|num_clients
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|p2p_client_info
modifier|*
name|cli
decl_stmt|;
name|char
name|name
index|[
literal|33
index|]
decl_stmt|;
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|u8
name|s
decl_stmt|;
name|int
name|count
decl_stmt|;
name|cli
operator|=
operator|&
name|info
operator|.
name|client
index|[
name|i
index|]
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"p2p_group_client: "
literal|"dev="
name|MACSTR
literal|" iface="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|cli
operator|->
name|p2p_device_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|cli
operator|->
name|p2p_interface_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" dev_capab=0x%x config_methods=0x%x "
literal|"dev_type=%s"
argument_list|,
name|cli
operator|->
name|dev_capab
argument_list|,
name|cli
operator|->
name|config_methods
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|cli
operator|->
name|pri_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
for|for
control|(
name|s
operator|=
literal|0
init|;
name|s
operator|<
name|cli
operator|->
name|num_sec_dev_types
condition|;
name|s
operator|++
control|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" dev_type=%s"
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
operator|&
name|cli
operator|->
name|sec_dev_types
index|[
name|s
operator|*
literal|8
index|]
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|name
argument_list|,
name|cli
operator|->
name|dev_name
argument_list|,
name|cli
operator|->
name|dev_name_len
argument_list|)
expr_stmt|;
name|name
index|[
name|cli
operator|->
name|dev_name_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|count
operator|=
operator|(
name|int
operator|)
name|cli
operator|->
name|dev_name_len
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|count
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|name
index|[
name|count
index|]
operator|>
literal|0
operator|&&
name|name
index|[
name|count
index|]
operator|<
literal|32
condition|)
name|name
index|[
name|count
index|]
operator|=
literal|'_'
expr_stmt|;
name|count
operator|--
expr_stmt|;
block|}
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" dev_name='%s'\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_comment
comment|/**  * p2p_attr_text - Build text format description of P2P IE attributes  * @data: P2P IE contents  * @buf: Buffer for returning text  * @end: Pointer to the end of the buf area  * Returns: Number of octets written to the buffer or -1 on faikure  *  * This function can be used to parse P2P IE contents into text format  * field=value lines.  */
end_comment

begin_function
name|int
name|p2p_attr_text
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|data
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
name|end
parameter_list|)
block|{
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|char
modifier|*
name|pos
init|=
name|buf
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_parse_p2p_ie
argument_list|(
name|data
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|msg
operator|.
name|capability
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"p2p_dev_capab=0x%x\n"
literal|"p2p_group_capab=0x%x\n"
argument_list|,
name|msg
operator|.
name|capability
index|[
literal|0
index|]
argument_list|,
name|msg
operator|.
name|capability
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
if|if
condition|(
name|msg
operator|.
name|pri_dev_type
condition|)
block|{
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"p2p_primary_device_type=%s\n"
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|msg
operator|.
name|pri_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"p2p_device_name=%s\n"
argument_list|,
name|msg
operator|.
name|device_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
if|if
condition|(
name|msg
operator|.
name|p2p_device_addr
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"p2p_device_addr="
name|MACSTR
literal|"\n"
argument_list|,
name|MAC2STR
argument_list|(
name|msg
operator|.
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"p2p_config_methods=0x%x\n"
argument_list|,
name|msg
operator|.
name|config_methods
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|end
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|ret
operator|=
name|p2p_group_info_text
argument_list|(
name|msg
operator|.
name|group_info
argument_list|,
name|msg
operator|.
name|group_info_len
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_function
name|int
name|p2p_get_cross_connect_disallowed
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|p2p_ie
parameter_list|)
block|{
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_parse_p2p_ie
argument_list|(
name|p2p_ie
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|msg
operator|.
name|manageability
condition|)
return|return
literal|0
return|;
return|return
operator|!
operator|(
name|msg
operator|.
name|manageability
index|[
literal|0
index|]
operator|&
name|P2P_MAN_CROSS_CONNECTION_PERMITTED
operator|)
return|;
block|}
end_function

begin_function
name|u8
name|p2p_get_group_capab
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|p2p_ie
parameter_list|)
block|{
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_parse_p2p_ie
argument_list|(
name|p2p_ie
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|msg
operator|.
name|capability
condition|)
return|return
literal|0
return|;
return|return
name|msg
operator|.
name|capability
index|[
literal|1
index|]
return|;
block|}
end_function

begin_function
specifier|const
name|u8
modifier|*
name|p2p_get_go_dev_addr
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|p2p_ie
parameter_list|)
block|{
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_parse_p2p_ie
argument_list|(
name|p2p_ie
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|msg
operator|.
name|p2p_device_addr
condition|)
return|return
name|msg
operator|.
name|p2p_device_addr
return|;
if|if
condition|(
name|msg
operator|.
name|device_id
condition|)
return|return
name|msg
operator|.
name|device_id
return|;
return|return
name|NULL
return|;
block|}
end_function

end_unit


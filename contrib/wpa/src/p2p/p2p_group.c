begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Direct - P2P group operations  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_defs.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_i.h"
end_include

begin_include
include|#
directive|include
file|"p2p_i.h"
end_include

begin_include
include|#
directive|include
file|"p2p.h"
end_include

begin_struct
struct|struct
name|p2p_group_member
block|{
name|struct
name|p2p_group_member
modifier|*
name|next
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
comment|/* P2P Interface Address */
name|u8
name|dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
comment|/* P2P Device Address */
name|struct
name|wpabuf
modifier|*
name|p2p_ie
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|wfd_ie
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|client_info
decl_stmt|;
name|u8
name|dev_capab
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/**  * struct p2p_group - Internal P2P module per-group data  */
end_comment

begin_struct
struct|struct
name|p2p_group
block|{
name|struct
name|p2p_data
modifier|*
name|p2p
decl_stmt|;
name|struct
name|p2p_group_config
modifier|*
name|cfg
decl_stmt|;
name|struct
name|p2p_group_member
modifier|*
name|members
decl_stmt|;
name|unsigned
name|int
name|num_members
decl_stmt|;
name|int
name|group_formation
decl_stmt|;
name|int
name|beacon_update
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|noa
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|wfd_ie
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|struct
name|p2p_group
modifier|*
name|p2p_group_init
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_group_config
modifier|*
name|config
parameter_list|)
block|{
name|struct
name|p2p_group
modifier|*
name|group
decl_stmt|,
modifier|*
modifier|*
name|groups
decl_stmt|;
name|group
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|group
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|groups
operator|=
name|os_realloc_array
argument_list|(
name|p2p
operator|->
name|groups
argument_list|,
name|p2p
operator|->
name|num_groups
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|p2p_group
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|groups
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|group
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|groups
index|[
name|p2p
operator|->
name|num_groups
operator|++
index|]
operator|=
name|group
expr_stmt|;
name|p2p
operator|->
name|groups
operator|=
name|groups
expr_stmt|;
name|group
operator|->
name|p2p
operator|=
name|p2p
expr_stmt|;
name|group
operator|->
name|cfg
operator|=
name|config
expr_stmt|;
name|group
operator|->
name|group_formation
operator|=
literal|1
expr_stmt|;
name|group
operator|->
name|beacon_update
operator|=
literal|1
expr_stmt|;
name|p2p_group_update_ies
argument_list|(
name|group
argument_list|)
expr_stmt|;
name|group
operator|->
name|cfg
operator|->
name|idle_update
argument_list|(
name|group
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|group
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_group_free_member
parameter_list|(
name|struct
name|p2p_group_member
modifier|*
name|m
parameter_list|)
block|{
name|wpabuf_free
argument_list|(
name|m
operator|->
name|wfd_ie
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|m
operator|->
name|p2p_ie
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|m
operator|->
name|client_info
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|m
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_group_free_members
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|m
operator|=
name|group
operator|->
name|members
expr_stmt|;
name|group
operator|->
name|members
operator|=
name|NULL
expr_stmt|;
name|group
operator|->
name|num_members
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|m
condition|)
block|{
name|prev
operator|=
name|m
expr_stmt|;
name|m
operator|=
name|m
operator|->
name|next
expr_stmt|;
name|p2p_group_free_member
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|p2p_group_deinit
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|)
block|{
name|size_t
name|g
decl_stmt|;
name|struct
name|p2p_data
modifier|*
name|p2p
decl_stmt|;
if|if
condition|(
name|group
operator|==
name|NULL
condition|)
return|return;
name|p2p
operator|=
name|group
operator|->
name|p2p
expr_stmt|;
for|for
control|(
name|g
operator|=
literal|0
init|;
name|g
operator|<
name|p2p
operator|->
name|num_groups
condition|;
name|g
operator|++
control|)
block|{
if|if
condition|(
name|p2p
operator|->
name|groups
index|[
name|g
index|]
operator|==
name|group
condition|)
block|{
while|while
condition|(
name|g
operator|+
literal|1
operator|<
name|p2p
operator|->
name|num_groups
condition|)
block|{
name|p2p
operator|->
name|groups
index|[
name|g
index|]
operator|=
name|p2p
operator|->
name|groups
index|[
name|g
operator|+
literal|1
index|]
expr_stmt|;
name|g
operator|++
expr_stmt|;
block|}
name|p2p
operator|->
name|num_groups
operator|--
expr_stmt|;
break|break;
block|}
block|}
name|p2p_group_free_members
argument_list|(
name|group
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|group
operator|->
name|cfg
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|group
operator|->
name|noa
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|group
operator|->
name|wfd_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|group
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_client_info
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|ie
parameter_list|,
name|struct
name|p2p_group_member
modifier|*
name|m
parameter_list|)
block|{
if|if
condition|(
name|m
operator|->
name|client_info
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|ie
argument_list|)
operator|<
name|wpabuf_len
argument_list|(
name|m
operator|->
name|client_info
argument_list|)
operator|+
literal|1
condition|)
return|return;
name|wpabuf_put_buf
argument_list|(
name|ie
argument_list|,
name|m
operator|->
name|client_info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_group_add_common_ies
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|ie
parameter_list|)
block|{
name|u8
name|dev_capab
init|=
name|group
operator|->
name|p2p
operator|->
name|dev_capab
decl_stmt|,
name|group_capab
init|=
literal|0
decl_stmt|;
comment|/* P2P Capability */
name|dev_capab
operator|&=
operator|~
name|P2P_DEV_CAPAB_CLIENT_DISCOVERABILITY
expr_stmt|;
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_GROUP_OWNER
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|cfg
operator|->
name|persistent_group
condition|)
block|{
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_PERSISTENT_GROUP
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|cfg
operator|->
name|persistent_group
operator|==
literal|2
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_PERSISTENT_RECONN
expr_stmt|;
block|}
if|if
condition|(
name|group
operator|->
name|p2p
operator|->
name|cfg
operator|->
name|p2p_intra_bss
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_INTRA_BSS_DIST
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|group_formation
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_GROUP_FORMATION
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|p2p
operator|->
name|cross_connect
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_CROSS_CONN
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|num_members
operator|>=
name|group
operator|->
name|cfg
operator|->
name|max_clients
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_GROUP_LIMIT
expr_stmt|;
name|p2p_buf_add_capability
argument_list|(
name|ie
argument_list|,
name|dev_capab
argument_list|,
name|group_capab
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_group_add_noa
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|ie
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|noa
parameter_list|)
block|{
if|if
condition|(
name|noa
operator|==
name|NULL
condition|)
return|return;
comment|/* Notice of Absence */
name|wpabuf_put_u8
argument_list|(
name|ie
argument_list|,
name|P2P_ATTR_NOTICE_OF_ABSENCE
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|ie
argument_list|,
name|wpabuf_len
argument_list|(
name|noa
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|ie
argument_list|,
name|noa
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_group_build_beacon_ie
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|size_t
name|extra
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|group
operator|->
name|p2p
operator|->
name|wfd_ie_beacon
condition|)
name|extra
operator|=
name|wpabuf_len
argument_list|(
name|group
operator|->
name|p2p
operator|->
name|wfd_ie_beacon
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
name|ie
operator|=
name|wpabuf_alloc
argument_list|(
literal|257
operator|+
name|extra
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|group
operator|->
name|p2p
operator|->
name|wfd_ie_beacon
condition|)
name|wpabuf_put_buf
argument_list|(
name|ie
argument_list|,
name|group
operator|->
name|p2p
operator|->
name|wfd_ie_beacon
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
name|len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|ie
argument_list|)
expr_stmt|;
name|p2p_group_add_common_ies
argument_list|(
name|group
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|p2p_buf_add_device_id
argument_list|(
name|ie
argument_list|,
name|group
operator|->
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|)
expr_stmt|;
name|p2p_group_add_noa
argument_list|(
name|ie
argument_list|,
name|group
operator|->
name|noa
argument_list|)
expr_stmt|;
name|p2p_buf_update_ie_hdr
argument_list|(
name|ie
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|ie
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
end_ifdef

begin_function
name|struct
name|wpabuf
modifier|*
name|p2p_group_get_wfd_ie
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|g
parameter_list|)
block|{
return|return
name|g
operator|->
name|wfd_ie
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wifi_display_encaps
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|subelems
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
if|if
condition|(
name|subelems
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ie
operator|=
name|wpabuf_alloc
argument_list|(
name|wpabuf_len
argument_list|(
name|subelems
argument_list|)
operator|+
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|subelems
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|subelems
argument_list|)
expr_stmt|;
while|while
condition|(
name|end
operator|>
name|pos
condition|)
block|{
name|size_t
name|frag_len
init|=
name|end
operator|-
name|pos
decl_stmt|;
if|if
condition|(
name|frag_len
operator|>
literal|251
condition|)
name|frag_len
operator|=
literal|251
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|ie
argument_list|,
name|WLAN_EID_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|ie
argument_list|,
literal|4
operator|+
name|frag_len
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|ie
argument_list|,
name|WFD_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|ie
argument_list|,
name|pos
argument_list|,
name|frag_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|frag_len
expr_stmt|;
block|}
return|return
name|ie
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wifi_display_add_dev_info_descr
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|struct
name|p2p_group_member
modifier|*
name|m
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
specifier|const
name|u8
modifier|*
name|dev_info
init|=
name|NULL
decl_stmt|;
specifier|const
name|u8
modifier|*
name|assoc_bssid
init|=
name|NULL
decl_stmt|;
specifier|const
name|u8
modifier|*
name|coupled_sink
init|=
name|NULL
decl_stmt|;
name|u8
name|zero_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|m
operator|->
name|wfd_ie
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|os_memset
argument_list|(
name|zero_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|=
name|wpabuf_head_u8
argument_list|(
name|m
operator|->
name|wfd_ie
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|m
operator|->
name|wfd_ie
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
name|u8
name|id
decl_stmt|;
name|u16
name|len
decl_stmt|;
name|id
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|len
operator|>
name|end
condition|)
break|break;
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|WFD_SUBELEM_DEVICE_INFO
case|:
if|if
condition|(
name|len
operator|<
literal|6
condition|)
break|break;
name|dev_info
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|WFD_SUBELEM_ASSOCIATED_BSSID
case|:
if|if
condition|(
name|len
operator|<
name|ETH_ALEN
condition|)
break|break;
name|assoc_bssid
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|WFD_SUBELEM_COUPLED_SINK
case|:
if|if
condition|(
name|len
operator|<
literal|1
operator|+
name|ETH_ALEN
condition|)
break|break;
name|coupled_sink
operator|=
name|pos
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|dev_info
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|23
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|m
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|assoc_bssid
condition|)
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|assoc_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|zero_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|dev_info
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* WFD Device Info */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|dev_info
operator|+
literal|4
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* WFD Device Max Throughput */
if|if
condition|(
name|coupled_sink
condition|)
block|{
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|coupled_sink
argument_list|,
literal|1
operator|+
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|zero_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wifi_display_build_go_ie
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wfd_subelems
decl_stmt|,
modifier|*
name|wfd_ie
decl_stmt|;
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|unsigned
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|group
operator|->
name|p2p
operator|->
name|wfd_ie_probe_resp
condition|)
return|return
name|NULL
return|;
name|wfd_subelems
operator|=
name|wpabuf_alloc
argument_list|(
name|wpabuf_len
argument_list|(
name|group
operator|->
name|p2p
operator|->
name|wfd_ie_probe_resp
argument_list|)
operator|+
name|group
operator|->
name|num_members
operator|*
literal|24
operator|+
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|wfd_subelems
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|group
operator|->
name|p2p
operator|->
name|wfd_dev_info
condition|)
name|wpabuf_put_buf
argument_list|(
name|wfd_subelems
argument_list|,
name|group
operator|->
name|p2p
operator|->
name|wfd_dev_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|p2p
operator|->
name|wfd_assoc_bssid
condition|)
name|wpabuf_put_buf
argument_list|(
name|wfd_subelems
argument_list|,
name|group
operator|->
name|p2p
operator|->
name|wfd_assoc_bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|p2p
operator|->
name|wfd_coupled_sink_info
condition|)
name|wpabuf_put_buf
argument_list|(
name|wfd_subelems
argument_list|,
name|group
operator|->
name|p2p
operator|->
name|wfd_coupled_sink_info
argument_list|)
expr_stmt|;
comment|/* Build WFD Session Info */
name|wpabuf_put_u8
argument_list|(
name|wfd_subelems
argument_list|,
name|WFD_SUBELEM_SESSION_INFO
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|wfd_subelems
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|m
operator|=
name|group
operator|->
name|members
expr_stmt|;
while|while
condition|(
name|m
condition|)
block|{
if|if
condition|(
name|wifi_display_add_dev_info_descr
argument_list|(
name|wfd_subelems
argument_list|,
name|m
argument_list|)
condition|)
name|count
operator|++
expr_stmt|;
name|m
operator|=
name|m
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
comment|/* No Wi-Fi Display clients - do not include subelement */
name|wfd_subelems
operator|->
name|used
operator|-=
literal|3
expr_stmt|;
block|}
else|else
block|{
name|WPA_PUT_BE16
argument_list|(
name|len
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|wfd_subelems
argument_list|,
literal|0
argument_list|)
operator|-
name|len
operator|-
literal|2
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WFD: WFD Session Info: %u descriptors"
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
name|wfd_ie
operator|=
name|wifi_display_encaps
argument_list|(
name|wfd_subelems
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wfd_subelems
argument_list|)
expr_stmt|;
return|return
name|wfd_ie
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wifi_display_group_update
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|)
block|{
name|wpabuf_free
argument_list|(
name|group
operator|->
name|wfd_ie
argument_list|)
expr_stmt|;
name|group
operator|->
name|wfd_ie
operator|=
name|wifi_display_build_go_ie
argument_list|(
name|group
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WIFI_DISPLAY */
end_comment

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_group_build_probe_resp_ie
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|)
block|{
name|u8
modifier|*
name|group_info
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|size_t
name|extra
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|group
operator|->
name|wfd_ie
condition|)
name|extra
operator|+=
name|wpabuf_len
argument_list|(
name|group
operator|->
name|wfd_ie
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
name|ie
operator|=
name|wpabuf_alloc
argument_list|(
literal|257
operator|+
name|extra
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|group
operator|->
name|wfd_ie
condition|)
name|wpabuf_put_buf
argument_list|(
name|ie
argument_list|,
name|group
operator|->
name|wfd_ie
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
name|len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|ie
argument_list|)
expr_stmt|;
name|p2p_group_add_common_ies
argument_list|(
name|group
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|p2p_group_add_noa
argument_list|(
name|ie
argument_list|,
name|group
operator|->
name|noa
argument_list|)
expr_stmt|;
comment|/* P2P Device Info */
name|p2p_buf_add_device_info
argument_list|(
name|ie
argument_list|,
name|group
operator|->
name|p2p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* P2P Group Info */
name|group_info
operator|=
name|wpabuf_put
argument_list|(
name|ie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|ie
argument_list|,
name|P2P_ATTR_GROUP_INFO
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|ie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Length to be filled */
for|for
control|(
name|m
operator|=
name|group
operator|->
name|members
init|;
name|m
condition|;
name|m
operator|=
name|m
operator|->
name|next
control|)
name|p2p_client_info
argument_list|(
name|ie
argument_list|,
name|m
argument_list|)
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|group_info
operator|+
literal|1
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|ie
argument_list|,
literal|0
argument_list|)
operator|-
name|group_info
operator|-
literal|3
argument_list|)
expr_stmt|;
name|p2p_buf_update_ie_hdr
argument_list|(
name|ie
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|ie
return|;
block|}
end_function

begin_function
name|void
name|p2p_group_update_ies
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|beacon_ie
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|probe_resp_ie
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
name|wifi_display_group_update
argument_list|(
name|group
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
name|probe_resp_ie
operator|=
name|p2p_group_build_probe_resp_ie
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|probe_resp_ie
operator|==
name|NULL
condition|)
return|return;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Update GO Probe Response P2P IE"
argument_list|,
name|probe_resp_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|beacon_update
condition|)
block|{
name|beacon_ie
operator|=
name|p2p_group_build_beacon_ie
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|beacon_ie
condition|)
name|group
operator|->
name|beacon_update
operator|=
literal|0
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Update GO Beacon P2P IE"
argument_list|,
name|beacon_ie
argument_list|)
expr_stmt|;
block|}
else|else
name|beacon_ie
operator|=
name|NULL
expr_stmt|;
name|group
operator|->
name|cfg
operator|->
name|ie_update
argument_list|(
name|group
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
name|beacon_ie
argument_list|,
name|probe_resp_ie
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * p2p_build_client_info - Build P2P Client Info Descriptor  * @addr: MAC address of the peer device  * @p2p_ie: P2P IE from (Re)Association Request  * @dev_capab: Buffer for returning Device Capability  * @dev_addr: Buffer for returning P2P Device Address  * Returns: P2P Client Info Descriptor or %NULL on failure  *  * This function builds P2P Client Info Descriptor based on the information  * available from (Re)Association Request frame. Group owner can use this to  * build the P2P Group Info attribute for Probe Response frames.  */
end_comment

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_build_client_info
parameter_list|(
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|p2p_ie
parameter_list|,
name|u8
modifier|*
name|dev_capab
parameter_list|,
name|u8
modifier|*
name|dev_addr
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|spos
decl_stmt|;
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
if|if
condition|(
name|p2p_ie
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_parse_p2p_ie
argument_list|(
name|p2p_ie
argument_list|,
operator|&
name|msg
argument_list|)
operator|||
name|msg
operator|.
name|capability
operator|==
name|NULL
operator|||
name|msg
operator|.
name|p2p_device_info
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|ETH_ALEN
operator|+
literal|1
operator|+
literal|1
operator|+
name|msg
operator|.
name|p2p_device_info_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|dev_capab
operator|=
name|msg
operator|.
name|capability
index|[
literal|0
index|]
expr_stmt|;
name|os_memcpy
argument_list|(
name|dev_addr
argument_list|,
name|msg
operator|.
name|p2p_device_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|spos
operator|=
name|msg
operator|.
name|p2p_device_info
expr_stmt|;
comment|/* P2P Device address */
comment|/* P2P Client Info Descriptor */
comment|/* Length to be set */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* P2P Device address */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|spos
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* P2P Interface address */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* Device Capability Bitmap */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|msg
operator|.
name|capability
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
comment|/* 	 * Config Methods, Primary Device Type, Number of Secondary Device 	 * Types, Secondary Device Type List, Device Name copied from 	 * Device Info 	 */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|spos
operator|+
name|ETH_ALEN
argument_list|,
name|msg
operator|.
name|p2p_device_info_len
operator|-
name|ETH_ALEN
argument_list|)
expr_stmt|;
operator|*
name|len_pos
operator|=
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
operator|-
literal|1
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p2p_group_remove_member
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|group
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|m
operator|=
name|group
operator|->
name|members
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|m
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|m
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|prev
operator|=
name|m
expr_stmt|;
name|m
operator|=
name|m
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|m
operator|->
name|next
expr_stmt|;
else|else
name|group
operator|->
name|members
operator|=
name|m
operator|->
name|next
expr_stmt|;
name|p2p_group_free_member
argument_list|(
name|m
argument_list|)
expr_stmt|;
name|group
operator|->
name|num_members
operator|--
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|p2p_group_notif_assoc
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|group
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|m
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|m
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|m
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|m
operator|->
name|p2p_ie
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|ie
argument_list|,
name|len
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|->
name|p2p_ie
condition|)
block|{
name|m
operator|->
name|client_info
operator|=
name|p2p_build_client_info
argument_list|(
name|addr
argument_list|,
name|m
operator|->
name|p2p_ie
argument_list|,
operator|&
name|m
operator|->
name|dev_capab
argument_list|,
name|m
operator|->
name|dev_addr
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
name|m
operator|->
name|wfd_ie
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|ie
argument_list|,
name|len
argument_list|,
name|WFD_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
name|p2p_group_remove_member
argument_list|(
name|group
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|m
operator|->
name|next
operator|=
name|group
operator|->
name|members
expr_stmt|;
name|group
operator|->
name|members
operator|=
name|m
expr_stmt|;
name|group
operator|->
name|num_members
operator|++
expr_stmt|;
name|wpa_msg
argument_list|(
name|group
operator|->
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add client "
name|MACSTR
literal|" to group (p2p=%d wfd=%d client_info=%d); num_members=%u/%u"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|m
operator|->
name|p2p_ie
condition|?
literal|1
else|:
literal|0
argument_list|,
name|m
operator|->
name|wfd_ie
condition|?
literal|1
else|:
literal|0
argument_list|,
name|m
operator|->
name|client_info
condition|?
literal|1
else|:
literal|0
argument_list|,
name|group
operator|->
name|num_members
argument_list|,
name|group
operator|->
name|cfg
operator|->
name|max_clients
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|num_members
operator|==
name|group
operator|->
name|cfg
operator|->
name|max_clients
condition|)
name|group
operator|->
name|beacon_update
operator|=
literal|1
expr_stmt|;
name|p2p_group_update_ies
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|num_members
operator|==
literal|1
condition|)
name|group
operator|->
name|cfg
operator|->
name|idle_update
argument_list|(
name|group
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|p2p_group_assoc_resp_ie
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
name|u8
name|status
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
name|u8
modifier|*
name|rlen
decl_stmt|;
name|size_t
name|extra
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|group
operator|->
name|wfd_ie
condition|)
name|extra
operator|=
name|wpabuf_len
argument_list|(
name|group
operator|->
name|wfd_ie
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
comment|/* 	 * (Re)Association Response - P2P IE 	 * Status attribute (shall be present when association request is 	 *	denied) 	 * Extended Listen Timing (may be present) 	 */
name|resp
operator|=
name|wpabuf_alloc
argument_list|(
literal|20
operator|+
name|extra
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|group
operator|->
name|wfd_ie
condition|)
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|group
operator|->
name|wfd_ie
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
name|rlen
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|P2P_SC_SUCCESS
condition|)
name|p2p_buf_add_status
argument_list|(
name|resp
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|p2p_buf_update_ie_hdr
argument_list|(
name|resp
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
return|return
name|resp
return|;
block|}
end_function

begin_function
name|void
name|p2p_group_notif_disassoc
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|p2p_group_remove_member
argument_list|(
name|group
argument_list|,
name|addr
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|group
operator|->
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove "
literal|"client "
name|MACSTR
literal|" from group; num_members=%u/%u"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|group
operator|->
name|num_members
argument_list|,
name|group
operator|->
name|cfg
operator|->
name|max_clients
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|num_members
operator|==
name|group
operator|->
name|cfg
operator|->
name|max_clients
operator|-
literal|1
condition|)
name|group
operator|->
name|beacon_update
operator|=
literal|1
expr_stmt|;
name|p2p_group_update_ies
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|num_members
operator|==
literal|0
condition|)
name|group
operator|->
name|cfg
operator|->
name|idle_update
argument_list|(
name|group
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * p2p_match_dev_type_member - Match client device type with requested type  * @m: Group member  * @wps: WPS TLVs from Probe Request frame (concatenated WPS IEs)  * Returns: 1 on match, 0 on mismatch  *  * This function can be used to match the Requested Device Type attribute in  * WPS IE with the device types of a group member for deciding whether a GO  * should reply to a Probe Request frame.  */
end_comment

begin_function
specifier|static
name|int
name|p2p_match_dev_type_member
parameter_list|(
name|struct
name|p2p_group_member
modifier|*
name|m
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|wps
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|u8
name|num_sec
decl_stmt|;
if|if
condition|(
name|m
operator|->
name|client_info
operator|==
name|NULL
operator|||
name|wps
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|m
operator|->
name|client_info
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|m
operator|->
name|client_info
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|1
operator|+
literal|2
operator|*
name|ETH_ALEN
operator|+
literal|1
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|WPS_DEV_TYPE_LEN
operator|+
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|wps
argument_list|,
operator|&
name|attr
argument_list|)
condition|)
return|return
literal|1
return|;
comment|/* assume no Requested Device Type attributes */
if|if
condition|(
name|attr
operator|.
name|num_req_dev_type
operator|==
literal|0
condition|)
return|return
literal|1
return|;
comment|/* no Requested Device Type attributes -> match */
if|if
condition|(
name|dev_type_list_match
argument_list|(
name|pos
argument_list|,
name|attr
operator|.
name|req_dev_type
argument_list|,
name|attr
operator|.
name|num_req_dev_type
argument_list|)
condition|)
return|return
literal|1
return|;
comment|/* Match with client Primary Device Type */
name|pos
operator|+=
name|WPS_DEV_TYPE_LEN
expr_stmt|;
name|num_sec
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|num_sec
operator|*
name|WPS_DEV_TYPE_LEN
condition|)
return|return
literal|0
return|;
while|while
condition|(
name|num_sec
operator|>
literal|0
condition|)
block|{
name|num_sec
operator|--
expr_stmt|;
if|if
condition|(
name|dev_type_list_match
argument_list|(
name|pos
argument_list|,
name|attr
operator|.
name|req_dev_type
argument_list|,
name|attr
operator|.
name|num_req_dev_type
argument_list|)
condition|)
return|return
literal|1
return|;
comment|/* Match with client Secondary Device Type */
name|pos
operator|+=
name|WPS_DEV_TYPE_LEN
expr_stmt|;
block|}
comment|/* No matching device type found */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|p2p_group_match_dev_type
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|p2p_match_dev_type
argument_list|(
name|group
operator|->
name|p2p
argument_list|,
name|wps
argument_list|)
condition|)
return|return
literal|1
return|;
comment|/* Match with own device type */
for|for
control|(
name|m
operator|=
name|group
operator|->
name|members
init|;
name|m
condition|;
name|m
operator|=
name|m
operator|->
name|next
control|)
block|{
if|if
condition|(
name|p2p_match_dev_type_member
argument_list|(
name|m
argument_list|,
name|wps
argument_list|)
condition|)
return|return
literal|1
return|;
comment|/* Match with group client device type */
block|}
comment|/* No match with Requested Device Type */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|p2p_group_match_dev_id
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|p2p
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_parse_p2p_ie
argument_list|(
name|p2p
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
return|return
literal|1
return|;
comment|/* Failed to parse - assume no filter on Device ID */
if|if
condition|(
operator|!
name|msg
operator|.
name|device_id
condition|)
return|return
literal|1
return|;
comment|/* No filter on Device ID */
if|if
condition|(
name|os_memcmp
argument_list|(
name|msg
operator|.
name|device_id
argument_list|,
name|group
operator|->
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
comment|/* Match with our P2P Device Address */
for|for
control|(
name|m
operator|=
name|group
operator|->
name|members
init|;
name|m
condition|;
name|m
operator|=
name|m
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|msg
operator|.
name|device_id
argument_list|,
name|m
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
comment|/* Match with group client P2P Device Address */
block|}
comment|/* No match with Device ID */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|p2p_group_notif_formation_done
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|)
block|{
if|if
condition|(
name|group
operator|==
name|NULL
condition|)
return|return;
name|group
operator|->
name|group_formation
operator|=
literal|0
expr_stmt|;
name|group
operator|->
name|beacon_update
operator|=
literal|1
expr_stmt|;
name|p2p_group_update_ies
argument_list|(
name|group
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|p2p_group_notif_noa
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|noa
parameter_list|,
name|size_t
name|noa_len
parameter_list|)
block|{
if|if
condition|(
name|noa
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|group
operator|->
name|noa
argument_list|)
expr_stmt|;
name|group
operator|->
name|noa
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|group
operator|->
name|noa
condition|)
block|{
if|if
condition|(
name|wpabuf_size
argument_list|(
name|group
operator|->
name|noa
argument_list|)
operator|>=
name|noa_len
condition|)
block|{
name|group
operator|->
name|noa
operator|->
name|used
operator|=
literal|0
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|group
operator|->
name|noa
argument_list|,
name|noa
argument_list|,
name|noa_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpabuf_free
argument_list|(
name|group
operator|->
name|noa
argument_list|)
expr_stmt|;
name|group
operator|->
name|noa
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|group
operator|->
name|noa
condition|)
block|{
name|group
operator|->
name|noa
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|noa
argument_list|,
name|noa_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|noa
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
block|}
name|group
operator|->
name|beacon_update
operator|=
literal|1
expr_stmt|;
name|p2p_group_update_ies
argument_list|(
name|group
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|p2p_group_member
modifier|*
name|p2p_group_get_client
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_id
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
for|for
control|(
name|m
operator|=
name|group
operator|->
name|members
init|;
name|m
condition|;
name|m
operator|=
name|m
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|dev_id
argument_list|,
name|m
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|m
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|p2p_group_member
modifier|*
name|p2p_group_get_client_iface
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|interface_addr
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
for|for
control|(
name|m
operator|=
name|group
operator|->
name|members
init|;
name|m
condition|;
name|m
operator|=
name|m
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|interface_addr
argument_list|,
name|m
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|m
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|u8
modifier|*
name|p2p_group_get_dev_addr
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
if|if
condition|(
name|group
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|m
operator|=
name|p2p_group_get_client_iface
argument_list|(
name|group
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|&&
operator|!
name|is_zero_ether_addr
argument_list|(
name|m
operator|->
name|dev_addr
argument_list|)
condition|)
return|return
name|m
operator|->
name|dev_addr
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_build_go_disc_req
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|p2p_buf_add_action_hdr
argument_list|(
name|buf
argument_list|,
name|P2P_GO_DISC_REQ
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|int
name|p2p_group_go_discover
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|searching_dev
parameter_list|,
name|int
name|rx_freq
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|req
decl_stmt|;
name|struct
name|p2p_data
modifier|*
name|p2p
init|=
name|group
operator|->
name|p2p
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|m
operator|=
name|p2p_group_get_client
argument_list|(
name|group
argument_list|,
name|dev_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
operator|||
name|m
operator|->
name|client_info
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested client was not in this "
literal|"group "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|group
operator|->
name|cfg
operator|->
name|interface_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|m
operator|->
name|dev_capab
operator|&
name|P2P_DEV_CAPAB_CLIENT_DISCOVERABILITY
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested client does not support "
literal|"client discoverability"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Schedule GO Discoverability Request to be "
literal|"sent to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev_id
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|=
name|p2p_build_go_disc_req
argument_list|()
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* TODO: Should really use group operating frequency here */
name|freq
operator|=
name|rx_freq
expr_stmt|;
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_PENDING_GO_DISC_REQ
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|cfg
operator|->
name|send_action
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
name|freq
argument_list|,
name|m
operator|->
name|addr
argument_list|,
name|group
operator|->
name|cfg
operator|->
name|interface_addr
argument_list|,
name|group
operator|->
name|cfg
operator|->
name|interface_addr
argument_list|,
name|wpabuf_head
argument_list|(
name|req
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|req
argument_list|)
argument_list|,
literal|200
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|msg_ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to send Action frame"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|const
name|u8
modifier|*
name|p2p_group_get_interface_addr
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|)
block|{
return|return
name|group
operator|->
name|cfg
operator|->
name|interface_addr
return|;
block|}
end_function

begin_function
name|u8
name|p2p_group_presence_req
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|client_interface_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|noa
parameter_list|,
name|size_t
name|noa_len
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
name|u8
name|curr_noa
index|[
literal|50
index|]
decl_stmt|;
name|int
name|curr_noa_len
decl_stmt|;
name|m
operator|=
name|p2p_group_get_client_iface
argument_list|(
name|group
argument_list|,
name|client_interface_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|m
operator|==
name|NULL
operator|||
name|m
operator|->
name|client_info
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Client was not in this group"
argument_list|)
expr_stmt|;
return|return
name|P2P_SC_FAIL_UNABLE_TO_ACCOMMODATE
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Presence Request NoA"
argument_list|,
name|noa
argument_list|,
name|noa_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|->
name|p2p
operator|->
name|cfg
operator|->
name|get_noa
condition|)
name|curr_noa_len
operator|=
name|group
operator|->
name|p2p
operator|->
name|cfg
operator|->
name|get_noa
argument_list|(
name|group
operator|->
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
name|group
operator|->
name|cfg
operator|->
name|interface_addr
argument_list|,
name|curr_noa
argument_list|,
sizeof|sizeof
argument_list|(
name|curr_noa
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|curr_noa_len
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|curr_noa_len
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to fetch current NoA"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|curr_noa_len
operator|==
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No NoA being advertized"
argument_list|)
expr_stmt|;
else|else
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Current NoA"
argument_list|,
name|curr_noa
argument_list|,
name|curr_noa_len
argument_list|)
expr_stmt|;
comment|/* TODO: properly process request and store copy */
if|if
condition|(
name|curr_noa_len
operator|>
literal|0
operator|||
name|curr_noa_len
operator|==
operator|-
literal|1
condition|)
return|return
name|P2P_SC_FAIL_UNABLE_TO_ACCOMMODATE
return|;
return|return
name|P2P_SC_SUCCESS
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|p2p_get_group_num_members
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|)
block|{
return|return
name|group
operator|->
name|num_members
return|;
block|}
end_function

begin_function
specifier|const
name|u8
modifier|*
name|p2p_iterate_group_members
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
name|void
modifier|*
modifier|*
name|next
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|iter
init|=
operator|*
name|next
decl_stmt|;
if|if
condition|(
operator|!
name|iter
condition|)
name|iter
operator|=
name|group
operator|->
name|members
expr_stmt|;
else|else
name|iter
operator|=
name|iter
operator|->
name|next
expr_stmt|;
operator|*
name|next
operator|=
name|iter
expr_stmt|;
if|if
condition|(
operator|!
name|iter
condition|)
return|return
name|NULL
return|;
return|return
name|iter
operator|->
name|addr
return|;
block|}
end_function

begin_function
name|int
name|p2p_group_is_client_connected
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|)
block|{
name|struct
name|p2p_group_member
modifier|*
name|m
decl_stmt|;
for|for
control|(
name|m
operator|=
name|group
operator|->
name|members
init|;
name|m
condition|;
name|m
operator|=
name|m
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|m
operator|->
name|dev_addr
argument_list|,
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|p2p_group_is_group_id_match
parameter_list|(
name|struct
name|p2p_group
modifier|*
name|group
parameter_list|,
specifier|const
name|u8
modifier|*
name|group_id
parameter_list|,
name|size_t
name|group_id_len
parameter_list|)
block|{
if|if
condition|(
name|group_id_len
operator|!=
name|ETH_ALEN
operator|+
name|group
operator|->
name|cfg
operator|->
name|ssid_len
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|group_id
argument_list|,
name|group
operator|->
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|os_memcmp
argument_list|(
name|group_id
operator|+
name|ETH_ALEN
argument_list|,
name|group
operator|->
name|cfg
operator|->
name|ssid
argument_list|,
name|group
operator|->
name|cfg
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Direct - P2P service discovery  * Copyright (c) 2009, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/gas.h"
end_include

begin_include
include|#
directive|include
file|"p2p_i.h"
end_include

begin_include
include|#
directive|include
file|"p2p.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
end_ifdef

begin_function
specifier|static
name|int
name|wfd_wsd_supported
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|wfd
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|subelem
decl_stmt|;
name|u16
name|len
decl_stmt|;
if|if
condition|(
name|wfd
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|wfd
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|wfd
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|3
operator|<=
name|end
condition|)
block|{
name|subelem
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|len
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|subelem
operator|==
name|WFD_SUBELEM_DEVICE_INFO
operator|&&
name|len
operator|>=
literal|6
condition|)
block|{
name|u16
name|info
init|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
decl_stmt|;
return|return
operator|!
operator|!
operator|(
name|info
operator|&
literal|0x0040
operator|)
return|;
block|}
name|pos
operator|+=
name|len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WIFI_DISPLAY */
end_comment

begin_function
name|struct
name|p2p_sd_query
modifier|*
name|p2p_pending_sd_req
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|p2p_sd_query
modifier|*
name|q
decl_stmt|;
name|int
name|wsd
init|=
literal|0
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|dev
operator|->
name|info
operator|.
name|dev_capab
operator|&
name|P2P_DEV_CAPAB_SERVICE_DISCOVERY
operator|)
condition|)
return|return
name|NULL
return|;
comment|/* peer does not support SD */
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|wfd_wsd_supported
argument_list|(
name|dev
operator|->
name|info
operator|.
name|wfd_subelems
argument_list|)
condition|)
name|wsd
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
for|for
control|(
name|q
operator|=
name|p2p
operator|->
name|sd_queries
init|;
name|q
condition|;
name|q
operator|=
name|q
operator|->
name|next
control|)
block|{
comment|/* Use WSD only if the peer indicates support or it */
if|if
condition|(
name|q
operator|->
name|wsd
operator|&&
operator|!
name|wsd
condition|)
continue|continue;
comment|/* if the query is a broadcast query */
if|if
condition|(
name|q
operator|->
name|for_all_peers
condition|)
block|{
comment|/* 			 * check if there are any broadcast queries pending for 			 * this device 			 */
if|if
condition|(
name|dev
operator|->
name|sd_pending_bcast_queries
operator|<=
literal|0
condition|)
return|return
name|NULL
return|;
comment|/* query number that needs to be send to the device */
if|if
condition|(
name|count
operator|==
name|dev
operator|->
name|sd_pending_bcast_queries
operator|-
literal|1
condition|)
goto|goto
name|found
goto|;
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|q
operator|->
name|for_all_peers
operator|&&
name|os_memcmp
argument_list|(
name|q
operator|->
name|peer
argument_list|,
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|found
goto|;
block|}
return|return
name|NULL
return|;
name|found
label|:
if|if
condition|(
name|dev
operator|->
name|sd_reqs
operator|>
literal|100
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Too many SD request attempts to "
name|MACSTR
literal|" - skip remaining queries"
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|q
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_decrease_sd_bc_queries
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|int
name|query_number
parameter_list|)
block|{
name|struct
name|p2p_device
modifier|*
name|dev
decl_stmt|;
name|p2p
operator|->
name|num_p2p_sd_queries
operator|--
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|dev
argument_list|,
argument|&p2p->devices
argument_list|,
argument|struct p2p_device
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|query_number
operator|<=
name|dev
operator|->
name|sd_pending_bcast_queries
operator|-
literal|1
condition|)
block|{
comment|/* 			 * Query not yet sent to the device and it is to be 			 * removed, so update the pending count. 			*/
name|dev
operator|->
name|sd_pending_bcast_queries
operator|--
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|p2p_unlink_sd_query
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_sd_query
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|p2p_sd_query
modifier|*
name|q
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|int
name|query_number
init|=
literal|0
decl_stmt|;
name|q
operator|=
name|p2p
operator|->
name|sd_queries
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|q
condition|)
block|{
if|if
condition|(
name|q
operator|==
name|query
condition|)
block|{
comment|/* If the query is a broadcast query, decrease one from 			 * all the devices */
if|if
condition|(
name|query
operator|->
name|for_all_peers
condition|)
name|p2p_decrease_sd_bc_queries
argument_list|(
name|p2p
argument_list|,
name|query_number
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|q
operator|->
name|next
expr_stmt|;
else|else
name|p2p
operator|->
name|sd_queries
operator|=
name|q
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|sd_query
operator|==
name|query
condition|)
name|p2p
operator|->
name|sd_query
operator|=
name|NULL
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|q
operator|->
name|for_all_peers
condition|)
name|query_number
operator|++
expr_stmt|;
name|prev
operator|=
name|q
expr_stmt|;
name|q
operator|=
name|q
operator|->
name|next
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_free_sd_query
parameter_list|(
name|struct
name|p2p_sd_query
modifier|*
name|q
parameter_list|)
block|{
if|if
condition|(
name|q
operator|==
name|NULL
condition|)
return|return;
name|wpabuf_free
argument_list|(
name|q
operator|->
name|tlvs
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|q
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_free_sd_queries
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|)
block|{
name|struct
name|p2p_sd_query
modifier|*
name|q
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|q
operator|=
name|p2p
operator|->
name|sd_queries
expr_stmt|;
name|p2p
operator|->
name|sd_queries
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|q
condition|)
block|{
name|prev
operator|=
name|q
expr_stmt|;
name|q
operator|=
name|q
operator|->
name|next
expr_stmt|;
name|p2p_free_sd_query
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|p2p
operator|->
name|num_p2p_sd_queries
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_build_sd_query
parameter_list|(
name|u16
name|update_indic
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|buf
operator|=
name|gas_anqp_build_initial_req
argument_list|(
literal|0
argument_list|,
literal|100
operator|+
name|wpabuf_len
argument_list|(
name|tlvs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* ANQP Query Request Frame */
name|len_pos
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|update_indic
argument_list|)
expr_stmt|;
comment|/* Service Update Indicator */
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len_pos
argument_list|)
expr_stmt|;
name|gas_anqp_set_len
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_send_gas_comeback_req
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|req
decl_stmt|;
name|req
operator|=
name|gas_build_comeback_req
argument_list|(
name|dialog_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return;
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_NO_PENDING_ACTION
expr_stmt|;
if|if
condition|(
name|p2p_send_action
argument_list|(
name|p2p
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|dst
argument_list|,
name|wpabuf_head
argument_list|(
name|req
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|req
argument_list|)
argument_list|,
literal|200
argument_list|)
operator|<
literal|0
condition|)
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Failed to send Action frame"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_build_sd_response
parameter_list|(
name|u8
name|dialog_token
parameter_list|,
name|u16
name|status_code
parameter_list|,
name|u16
name|comeback_delay
parameter_list|,
name|u16
name|update_indic
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|buf
operator|=
name|gas_anqp_build_initial_resp
argument_list|(
name|dialog_token
argument_list|,
name|status_code
argument_list|,
name|comeback_delay
argument_list|,
literal|100
operator|+
operator|(
name|tlvs
condition|?
name|wpabuf_len
argument_list|(
name|tlvs
argument_list|)
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|tlvs
condition|)
block|{
comment|/* ANQP Query Response Frame */
name|len_pos
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
comment|/* Service Update Indicator */
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|update_indic
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len_pos
argument_list|)
expr_stmt|;
block|}
name|gas_anqp_set_len
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_build_gas_comeback_resp
parameter_list|(
name|u8
name|dialog_token
parameter_list|,
name|u16
name|status_code
parameter_list|,
name|u16
name|update_indic
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|u8
name|frag_id
parameter_list|,
name|u8
name|more
parameter_list|,
name|u16
name|total_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|gas_anqp_build_comeback_resp
argument_list|(
name|dialog_token
argument_list|,
name|status_code
argument_list|,
name|frag_id
argument_list|,
name|more
argument_list|,
literal|0
argument_list|,
literal|100
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|frag_id
operator|==
literal|0
condition|)
block|{
comment|/* ANQP Query Response Frame */
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
comment|/* Info ID */
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|3
operator|+
literal|1
operator|+
literal|2
operator|+
name|total_len
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
comment|/* Service Update Indicator */
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|update_indic
argument_list|)
expr_stmt|;
block|}
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|gas_anqp_set_len
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|int
name|p2p_start_sd
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|req
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|p2p_sd_query
modifier|*
name|query
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|unsigned
name|int
name|wait_time
decl_stmt|;
name|freq
operator|=
name|dev
operator|->
name|listen_freq
operator|>
literal|0
condition|?
name|dev
operator|->
name|listen_freq
else|:
name|dev
operator|->
name|oper_freq
expr_stmt|;
if|if
condition|(
name|freq
operator|<=
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Listen/Operating frequency known for the peer "
name|MACSTR
literal|" to send SD Request"
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|query
operator|=
name|p2p_pending_sd_req
argument_list|(
name|p2p
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|query
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Start Service Discovery with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|=
name|p2p_build_sd_query
argument_list|(
name|p2p
operator|->
name|srv_update_indic
argument_list|,
name|query
operator|->
name|tlvs
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|dev
operator|->
name|sd_reqs
operator|++
expr_stmt|;
name|p2p
operator|->
name|sd_peer
operator|=
name|dev
expr_stmt|;
name|p2p
operator|->
name|sd_query
operator|=
name|query
expr_stmt|;
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_PENDING_SD
expr_stmt|;
name|wait_time
operator|=
literal|5000
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|cfg
operator|->
name|max_listen
operator|&&
name|wait_time
operator|>
name|p2p
operator|->
name|cfg
operator|->
name|max_listen
condition|)
name|wait_time
operator|=
name|p2p
operator|->
name|cfg
operator|->
name|max_listen
expr_stmt|;
if|if
condition|(
name|p2p_send_action
argument_list|(
name|p2p
argument_list|,
name|freq
argument_list|,
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|wpabuf_head
argument_list|(
name|req
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|req
argument_list|)
argument_list|,
name|wait_time
argument_list|)
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Failed to send Action frame"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|p2p_rx_gas_initial_req
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|rx_freq
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|data
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|data
operator|+
name|len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|next
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|u16
name|update_indic
decl_stmt|;
if|if
condition|(
name|p2p
operator|->
name|cfg
operator|->
name|sd_request
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|rx_freq
operator|>
literal|0
condition|)
name|freq
operator|=
name|rx_freq
expr_stmt|;
else|else
name|freq
operator|=
name|p2p_channel_to_freq
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|reg_class
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
name|len
operator|<
literal|1
operator|+
literal|2
condition|)
return|return;
name|dialog_token
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"GAS Initial Request from "
name|MACSTR
literal|" (dialog token %u, freq %d)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|,
name|rx_freq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
name|WLAN_EID_ADV_PROTO
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unexpected IE in GAS Initial Request: %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|++
expr_stmt|;
name|slen
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|next
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
if|if
condition|(
name|next
operator|>
name|end
operator|||
name|slen
operator|<
literal|2
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Invalid IE in GAS Initial Request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|++
expr_stmt|;
comment|/* skip QueryRespLenLimit and PAME-BI */
if|if
condition|(
operator|*
name|pos
operator|!=
name|ACCESS_NETWORK_QUERY_PROTOCOL
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported GAS advertisement protocol id %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|=
name|next
expr_stmt|;
comment|/* Query Request */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
return|return;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
condition|)
return|return;
name|end
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
comment|/* ANQP Query Request */
if|if
condition|(
name|pos
operator|+
literal|4
operator|>
name|end
condition|)
return|return;
if|if
condition|(
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
operator|!=
name|ANQP_VENDOR_SPECIFIC
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported ANQP Info ID %u"
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
operator|||
name|slen
operator|<
literal|3
operator|+
literal|1
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Invalid ANQP Query Request length"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|WPA_GET_BE32
argument_list|(
name|pos
argument_list|)
operator|!=
name|P2P_IE_VENDOR_TYPE
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported ANQP vendor OUI-type %08x"
argument_list|,
name|WPA_GET_BE32
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
return|return;
name|update_indic
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Service Update Indicator: %u"
argument_list|,
name|update_indic
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|p2p
operator|->
name|cfg
operator|->
name|sd_request
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|update_indic
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
comment|/* the response will be indicated with a call to p2p_sd_response() */
block|}
end_function

begin_function
name|void
name|p2p_sd_response
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|resp_tlvs
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
comment|/* TODO: fix the length limit to match with the maximum frame length */
if|if
condition|(
name|wpabuf_len
argument_list|(
name|resp_tlvs
argument_list|)
operator|>
literal|1400
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"SD response long enough to require fragmentation"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|sd_resp
condition|)
block|{
comment|/* 			 * TODO: Could consider storing the fragmented response 			 * separately for each peer to avoid having to drop old 			 * one if there is more than one pending SD query. 			 * Though, that would eat more memory, so there are 			 * also benefits to just using a single buffer. 			 */
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Drop previous SD response"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p
operator|->
name|sd_resp
argument_list|)
expr_stmt|;
block|}
name|p2p
operator|->
name|sd_resp
operator|=
name|wpabuf_dup
argument_list|(
name|resp_tlvs
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|sd_resp
operator|==
name|NULL
condition|)
block|{
name|p2p_err
argument_list|(
name|p2p
argument_list|,
literal|"Failed to allocate SD response fragmentation area"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|p2p
operator|->
name|sd_resp_addr
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|sd_resp_dialog_token
operator|=
name|dialog_token
expr_stmt|;
name|p2p
operator|->
name|sd_resp_pos
operator|=
literal|0
expr_stmt|;
name|p2p
operator|->
name|sd_frag_id
operator|=
literal|0
expr_stmt|;
name|resp
operator|=
name|p2p_build_sd_response
argument_list|(
name|dialog_token
argument_list|,
name|WLAN_STATUS_SUCCESS
argument_list|,
literal|1
argument_list|,
name|p2p
operator|->
name|srv_update_indic
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"SD response fits in initial response"
argument_list|)
expr_stmt|;
name|resp
operator|=
name|p2p_build_sd_response
argument_list|(
name|dialog_token
argument_list|,
name|WLAN_STATUS_SUCCESS
argument_list|,
literal|0
argument_list|,
name|p2p
operator|->
name|srv_update_indic
argument_list|,
name|resp_tlvs
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_NO_PENDING_ACTION
expr_stmt|;
if|if
condition|(
name|p2p_send_action
argument_list|(
name|p2p
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|wpabuf_head
argument_list|(
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
argument_list|,
literal|200
argument_list|)
operator|<
literal|0
condition|)
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Failed to send Action frame"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_rx_gas_initial_resp
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|rx_freq
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|data
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|data
operator|+
name|len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|next
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|u16
name|status_code
decl_stmt|;
name|u16
name|comeback_delay
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|u16
name|update_indic
decl_stmt|;
if|if
condition|(
name|p2p
operator|->
name|state
operator|!=
name|P2P_SD_DURING_FIND
operator|||
name|p2p
operator|->
name|sd_peer
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|p2p
operator|->
name|sd_peer
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Ignore unexpected GAS Initial Response from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|p2p
operator|->
name|cfg
operator|->
name|send_action_done
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|)
expr_stmt|;
name|p2p_clear_timeout
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Received GAS Initial Response from "
name|MACSTR
literal|" (len=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|5
operator|+
literal|2
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Too short GAS Initial Response frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dialog_token
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
comment|/* TODO: check dialog_token match */
name|status_code
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|comeback_delay
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"dialog_token=%u status_code=%u comeback_delay=%u"
argument_list|,
name|dialog_token
argument_list|,
name|status_code
argument_list|,
name|comeback_delay
argument_list|)
expr_stmt|;
if|if
condition|(
name|status_code
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Service Discovery failed: status code %u"
argument_list|,
name|status_code
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|*
name|pos
operator|!=
name|WLAN_EID_ADV_PROTO
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unexpected IE in GAS Initial Response: %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|++
expr_stmt|;
name|slen
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|next
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
if|if
condition|(
name|next
operator|>
name|end
operator|||
name|slen
operator|<
literal|2
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Invalid IE in GAS Initial Response"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|++
expr_stmt|;
comment|/* skip QueryRespLenLimit and PAME-BI */
if|if
condition|(
operator|*
name|pos
operator|!=
name|ACCESS_NETWORK_QUERY_PROTOCOL
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported GAS advertisement protocol id %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|=
name|next
expr_stmt|;
comment|/* Query Response */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Too short Query Response"
argument_list|)
expr_stmt|;
return|return;
block|}
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Query Response Length: %d"
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Not enough Query Response data"
argument_list|)
expr_stmt|;
return|return;
block|}
name|end
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
if|if
condition|(
name|comeback_delay
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Fragmented response - request fragments"
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|sd_rx_resp
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Drop old SD reassembly buffer"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p
operator|->
name|sd_rx_resp
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|sd_rx_resp
operator|=
name|NULL
expr_stmt|;
block|}
name|p2p_send_gas_comeback_req
argument_list|(
name|p2p
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|rx_freq
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* ANQP Query Response */
if|if
condition|(
name|pos
operator|+
literal|4
operator|>
name|end
condition|)
return|return;
if|if
condition|(
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
operator|!=
name|ANQP_VENDOR_SPECIFIC
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported ANQP Info ID %u"
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
operator|||
name|slen
operator|<
literal|3
operator|+
literal|1
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Invalid ANQP Query Response length"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|WPA_GET_BE32
argument_list|(
name|pos
argument_list|)
operator|!=
name|P2P_IE_VENDOR_TYPE
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported ANQP vendor OUI-type %08x"
argument_list|,
name|WPA_GET_BE32
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
return|return;
name|update_indic
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Service Update Indicator: %u"
argument_list|,
name|update_indic
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|p2p
operator|->
name|sd_peer
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|sd_query
condition|)
block|{
if|if
condition|(
operator|!
name|p2p
operator|->
name|sd_query
operator|->
name|for_all_peers
condition|)
block|{
name|struct
name|p2p_sd_query
modifier|*
name|q
decl_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Remove completed SD query %p"
argument_list|,
name|p2p
operator|->
name|sd_query
argument_list|)
expr_stmt|;
name|q
operator|=
name|p2p
operator|->
name|sd_query
expr_stmt|;
name|p2p_unlink_sd_query
argument_list|(
name|p2p
argument_list|,
name|p2p
operator|->
name|sd_query
argument_list|)
expr_stmt|;
name|p2p_free_sd_query
argument_list|(
name|q
argument_list|)
expr_stmt|;
block|}
name|p2p
operator|->
name|sd_query
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|p2p
operator|->
name|cfg
operator|->
name|sd_response
condition|)
name|p2p
operator|->
name|cfg
operator|->
name|sd_response
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
name|sa
argument_list|,
name|update_indic
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
name|p2p_continue_find
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_rx_gas_comeback_req
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|rx_freq
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|size_t
name|frag_len
decl_stmt|;
name|int
name|more
init|=
literal|0
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: RX GAS Comeback Request"
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|1
condition|)
return|return;
name|dialog_token
operator|=
operator|*
name|data
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Dialog Token: %u"
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|dialog_token
operator|!=
name|p2p
operator|->
name|sd_resp_dialog_token
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No pending SD response fragment for dialog token %u"
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|p2p
operator|->
name|sd_resp
operator|==
name|NULL
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No pending SD response fragment available"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|p2p
operator|->
name|sd_resp_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No pending SD response fragment for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|frag_len
operator|=
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|sd_resp
argument_list|)
operator|-
name|p2p
operator|->
name|sd_resp_pos
expr_stmt|;
if|if
condition|(
name|frag_len
operator|>
literal|1400
condition|)
block|{
name|frag_len
operator|=
literal|1400
expr_stmt|;
name|more
operator|=
literal|1
expr_stmt|;
block|}
name|resp
operator|=
name|p2p_build_gas_comeback_resp
argument_list|(
name|dialog_token
argument_list|,
name|WLAN_STATUS_SUCCESS
argument_list|,
name|p2p
operator|->
name|srv_update_indic
argument_list|,
name|wpabuf_head_u8
argument_list|(
name|p2p
operator|->
name|sd_resp
argument_list|)
operator|+
name|p2p
operator|->
name|sd_resp_pos
argument_list|,
name|frag_len
argument_list|,
name|p2p
operator|->
name|sd_frag_id
argument_list|,
name|more
argument_list|,
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|sd_resp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Send GAS Comeback Response (frag_id %d more=%d frag_len=%d)"
argument_list|,
name|p2p
operator|->
name|sd_frag_id
argument_list|,
name|more
argument_list|,
operator|(
name|int
operator|)
name|frag_len
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|sd_frag_id
operator|++
expr_stmt|;
name|p2p
operator|->
name|sd_resp_pos
operator|+=
name|frag_len
expr_stmt|;
if|if
condition|(
name|more
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"%d more bytes remain to be sent"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|sd_resp
argument_list|)
operator|-
name|p2p
operator|->
name|sd_resp_pos
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"All fragments of SD response sent"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p
operator|->
name|sd_resp
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|sd_resp
operator|=
name|NULL
expr_stmt|;
block|}
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_NO_PENDING_ACTION
expr_stmt|;
if|if
condition|(
name|p2p_send_action
argument_list|(
name|p2p
argument_list|,
name|rx_freq
argument_list|,
name|sa
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|wpabuf_head
argument_list|(
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
argument_list|,
literal|200
argument_list|)
operator|<
literal|0
condition|)
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Failed to send Action frame"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|p2p_rx_gas_comeback_resp
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|rx_freq
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|data
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|data
operator|+
name|len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|next
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|u16
name|status_code
decl_stmt|;
name|u8
name|frag_id
decl_stmt|;
name|u8
name|more_frags
decl_stmt|;
name|u16
name|comeback_delay
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: RX GAS Comeback Response"
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|state
operator|!=
name|P2P_SD_DURING_FIND
operator|||
name|p2p
operator|->
name|sd_peer
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|p2p
operator|->
name|sd_peer
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Ignore unexpected GAS Comeback Response from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|p2p
operator|->
name|cfg
operator|->
name|send_action_done
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|)
expr_stmt|;
name|p2p_clear_timeout
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Received GAS Comeback Response from "
name|MACSTR
literal|" (len=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|6
operator|+
literal|2
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Too short GAS Comeback Response frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dialog_token
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
comment|/* TODO: check dialog_token match */
name|status_code
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|frag_id
operator|=
operator|*
name|pos
operator|&
literal|0x7f
expr_stmt|;
name|more_frags
operator|=
operator|(
operator|*
name|pos
operator|&
literal|0x80
operator|)
operator|>>
literal|7
expr_stmt|;
name|pos
operator|++
expr_stmt|;
name|comeback_delay
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"dialog_token=%u status_code=%u frag_id=%d more_frags=%d "
literal|"comeback_delay=%u"
argument_list|,
name|dialog_token
argument_list|,
name|status_code
argument_list|,
name|frag_id
argument_list|,
name|more_frags
argument_list|,
name|comeback_delay
argument_list|)
expr_stmt|;
comment|/* TODO: check frag_id match */
if|if
condition|(
name|status_code
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Service Discovery failed: status code %u"
argument_list|,
name|status_code
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|*
name|pos
operator|!=
name|WLAN_EID_ADV_PROTO
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unexpected IE in GAS Comeback Response: %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|++
expr_stmt|;
name|slen
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|next
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
if|if
condition|(
name|next
operator|>
name|end
operator|||
name|slen
operator|<
literal|2
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Invalid IE in GAS Comeback Response"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|++
expr_stmt|;
comment|/* skip QueryRespLenLimit and PAME-BI */
if|if
condition|(
operator|*
name|pos
operator|!=
name|ACCESS_NETWORK_QUERY_PROTOCOL
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported GAS advertisement protocol id %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|=
name|next
expr_stmt|;
comment|/* Query Response */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Too short Query Response"
argument_list|)
expr_stmt|;
return|return;
block|}
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Query Response Length: %d"
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Not enough Query Response data"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|slen
operator|==
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Query Response data"
argument_list|)
expr_stmt|;
return|return;
block|}
name|end
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|sd_rx_resp
condition|)
block|{
comment|/* 		  * ANQP header is only included in the first fragment; rest of 		  * the fragments start with continue TLVs. 		  */
goto|goto
name|skip_nqp_header
goto|;
block|}
comment|/* ANQP Query Response */
if|if
condition|(
name|pos
operator|+
literal|4
operator|>
name|end
condition|)
return|return;
if|if
condition|(
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
operator|!=
name|ANQP_VENDOR_SPECIFIC
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported ANQP Info ID %u"
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"ANQP Query Response length: %u"
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|slen
operator|<
literal|3
operator|+
literal|1
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Invalid ANQP Query Response length"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|pos
operator|+
literal|4
operator|>
name|end
condition|)
return|return;
if|if
condition|(
name|WPA_GET_BE32
argument_list|(
name|pos
argument_list|)
operator|!=
name|P2P_IE_VENDOR_TYPE
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported ANQP vendor OUI-type %08x"
argument_list|,
name|WPA_GET_BE32
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
return|return;
name|p2p
operator|->
name|sd_rx_update_indic
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Service Update Indicator: %u"
argument_list|,
name|p2p
operator|->
name|sd_rx_update_indic
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|skip_nqp_header
label|:
if|if
condition|(
name|wpabuf_resize
argument_list|(
operator|&
name|p2p
operator|->
name|sd_rx_resp
argument_list|,
name|end
operator|-
name|pos
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|wpabuf_put_data
argument_list|(
name|p2p
operator|->
name|sd_rx_resp
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Current SD reassembly buffer length: %u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|sd_rx_resp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|more_frags
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"More fragments remains"
argument_list|)
expr_stmt|;
comment|/* TODO: what would be a good size limit? */
if|if
condition|(
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|sd_rx_resp
argument_list|)
operator|>
literal|64000
condition|)
block|{
name|wpabuf_free
argument_list|(
name|p2p
operator|->
name|sd_rx_resp
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|sd_rx_resp
operator|=
name|NULL
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Too long SD response - drop it"
argument_list|)
expr_stmt|;
return|return;
block|}
name|p2p_send_gas_comeback_req
argument_list|(
name|p2p
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|rx_freq
argument_list|)
expr_stmt|;
return|return;
block|}
name|p2p
operator|->
name|sd_peer
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|sd_query
condition|)
block|{
if|if
condition|(
operator|!
name|p2p
operator|->
name|sd_query
operator|->
name|for_all_peers
condition|)
block|{
name|struct
name|p2p_sd_query
modifier|*
name|q
decl_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Remove completed SD query %p"
argument_list|,
name|p2p
operator|->
name|sd_query
argument_list|)
expr_stmt|;
name|q
operator|=
name|p2p
operator|->
name|sd_query
expr_stmt|;
name|p2p_unlink_sd_query
argument_list|(
name|p2p
argument_list|,
name|p2p
operator|->
name|sd_query
argument_list|)
expr_stmt|;
name|p2p_free_sd_query
argument_list|(
name|q
argument_list|)
expr_stmt|;
block|}
name|p2p
operator|->
name|sd_query
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|p2p
operator|->
name|cfg
operator|->
name|sd_response
condition|)
name|p2p
operator|->
name|cfg
operator|->
name|sd_response
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
name|sa
argument_list|,
name|p2p
operator|->
name|sd_rx_update_indic
argument_list|,
name|wpabuf_head
argument_list|(
name|p2p
operator|->
name|sd_rx_resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|sd_rx_resp
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p
operator|->
name|sd_rx_resp
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|sd_rx_resp
operator|=
name|NULL
expr_stmt|;
name|p2p_continue_find
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
modifier|*
name|p2p_sd_request
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|)
block|{
name|struct
name|p2p_sd_query
modifier|*
name|q
decl_stmt|;
name|q
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|q
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|dst
condition|)
name|os_memcpy
argument_list|(
name|q
operator|->
name|peer
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|q
operator|->
name|for_all_peers
operator|=
literal|1
expr_stmt|;
name|q
operator|->
name|tlvs
operator|=
name|wpabuf_dup
argument_list|(
name|tlvs
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
operator|->
name|tlvs
operator|==
name|NULL
condition|)
block|{
name|p2p_free_sd_query
argument_list|(
name|q
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|q
operator|->
name|next
operator|=
name|p2p
operator|->
name|sd_queries
expr_stmt|;
name|p2p
operator|->
name|sd_queries
operator|=
name|q
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Added SD Query %p"
argument_list|,
name|q
argument_list|)
expr_stmt|;
if|if
condition|(
name|dst
operator|==
name|NULL
condition|)
block|{
name|struct
name|p2p_device
modifier|*
name|dev
decl_stmt|;
name|p2p
operator|->
name|num_p2p_sd_queries
operator|++
expr_stmt|;
comment|/* Update all the devices for the newly added broadcast query */
name|dl_list_for_each
argument_list|(
argument|dev
argument_list|,
argument|&p2p->devices
argument_list|,
argument|struct p2p_device
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|dev
operator|->
name|sd_pending_bcast_queries
operator|<=
literal|0
condition|)
name|dev
operator|->
name|sd_pending_bcast_queries
operator|=
literal|1
expr_stmt|;
else|else
name|dev
operator|->
name|sd_pending_bcast_queries
operator|++
expr_stmt|;
block|}
block|}
return|return
name|q
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
end_ifdef

begin_function
name|void
modifier|*
name|p2p_sd_request_wfd
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|)
block|{
name|struct
name|p2p_sd_query
modifier|*
name|q
decl_stmt|;
name|q
operator|=
name|p2p_sd_request
argument_list|(
name|p2p
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
if|if
condition|(
name|q
condition|)
name|q
operator|->
name|wsd
operator|=
literal|1
expr_stmt|;
return|return
name|q
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WIFI_DISPLAY */
end_comment

begin_function
name|void
name|p2p_sd_service_update
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|)
block|{
name|p2p
operator|->
name|srv_update_indic
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|int
name|p2p_sd_cancel_request
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|void
modifier|*
name|req
parameter_list|)
block|{
if|if
condition|(
name|p2p_unlink_sd_query
argument_list|(
name|p2p
argument_list|,
name|req
argument_list|)
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Cancel pending SD query %p"
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|p2p_free_sd_query
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

end_unit


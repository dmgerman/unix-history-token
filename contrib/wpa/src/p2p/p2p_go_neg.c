begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Direct - P2P Group Owner Negotiation  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_defs.h"
end_include

begin_include
include|#
directive|include
file|"p2p_i.h"
end_include

begin_include
include|#
directive|include
file|"p2p.h"
end_include

begin_function
specifier|static
name|int
name|p2p_go_det
parameter_list|(
name|u8
name|own_intent
parameter_list|,
name|u8
name|peer_value
parameter_list|)
block|{
name|u8
name|peer_intent
init|=
name|peer_value
operator|>>
literal|1
decl_stmt|;
if|if
condition|(
name|own_intent
operator|==
name|peer_intent
condition|)
block|{
if|if
condition|(
name|own_intent
operator|==
name|P2P_MAX_GO_INTENT
condition|)
return|return
operator|-
literal|1
return|;
comment|/* both devices want to become GO */
comment|/* Use tie breaker bit to determine GO */
return|return
operator|(
name|peer_value
operator|&
literal|0x01
operator|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
return|return
name|own_intent
operator|>
name|peer_intent
return|;
block|}
end_function

begin_function
name|int
name|p2p_peer_channels_check
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_channels
modifier|*
name|own
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|dev
parameter_list|,
specifier|const
name|u8
modifier|*
name|channel_list
parameter_list|,
name|size_t
name|channel_list_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|struct
name|p2p_channels
modifier|*
name|ch
decl_stmt|;
name|size_t
name|channels
decl_stmt|;
name|struct
name|p2p_channels
name|intersection
decl_stmt|;
name|ch
operator|=
operator|&
name|dev
operator|->
name|channels
expr_stmt|;
name|os_memset
argument_list|(
name|ch
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ch
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
name|channel_list
expr_stmt|;
name|end
operator|=
name|channel_list
operator|+
name|channel_list_len
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|3
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|dev
operator|->
name|country
argument_list|,
name|pos
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer country"
argument_list|,
name|pos
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|2
index|]
operator|!=
literal|0x04
operator|&&
name|os_memcmp
argument_list|(
name|pos
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
argument_list|,
literal|2
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|p2p_info
argument_list|(
name|p2p
argument_list|,
literal|"Mismatching country (ours=%c%c peer's=%c%c)"
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
index|[
literal|0
index|]
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
index|[
literal|1
index|]
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|3
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|2
operator|<
name|end
condition|)
block|{
name|struct
name|p2p_reg_class
modifier|*
name|cl
init|=
operator|&
name|ch
operator|->
name|reg_class
index|[
name|ch
operator|->
name|reg_classes
index|]
decl_stmt|;
name|cl
operator|->
name|reg_class
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|+
name|pos
index|[
literal|0
index|]
operator|>
name|end
condition|)
block|{
name|p2p_info
argument_list|(
name|p2p
argument_list|,
literal|"Invalid peer Channel List"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|channels
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|cl
operator|->
name|channels
operator|=
name|channels
operator|>
name|P2P_MAX_REG_CLASS_CHANNELS
condition|?
name|P2P_MAX_REG_CLASS_CHANNELS
else|:
name|channels
expr_stmt|;
name|os_memcpy
argument_list|(
name|cl
operator|->
name|channel
argument_list|,
name|pos
argument_list|,
name|cl
operator|->
name|channels
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|channels
expr_stmt|;
name|ch
operator|->
name|reg_classes
operator|++
expr_stmt|;
if|if
condition|(
name|ch
operator|->
name|reg_classes
operator|==
name|P2P_MAX_REG_CLASSES
condition|)
break|break;
block|}
name|p2p_channels_intersect
argument_list|(
name|own
argument_list|,
operator|&
name|dev
operator|->
name|channels
argument_list|,
operator|&
name|intersection
argument_list|)
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Own reg_classes %d peer reg_classes %d intersection reg_classes %d"
argument_list|,
operator|(
name|int
operator|)
name|own
operator|->
name|reg_classes
argument_list|,
operator|(
name|int
operator|)
name|dev
operator|->
name|channels
operator|.
name|reg_classes
argument_list|,
operator|(
name|int
operator|)
name|intersection
operator|.
name|reg_classes
argument_list|)
expr_stmt|;
if|if
condition|(
name|intersection
operator|.
name|reg_classes
operator|==
literal|0
condition|)
block|{
name|p2p_info
argument_list|(
name|p2p
argument_list|,
literal|"No common channels found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|p2p_peer_channels
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|dev
parameter_list|,
specifier|const
name|u8
modifier|*
name|channel_list
parameter_list|,
name|size_t
name|channel_list_len
parameter_list|)
block|{
return|return
name|p2p_peer_channels_check
argument_list|(
name|p2p
argument_list|,
operator|&
name|p2p
operator|->
name|channels
argument_list|,
name|dev
argument_list|,
name|channel_list
argument_list|,
name|channel_list_len
argument_list|)
return|;
block|}
end_function

begin_function
name|u16
name|p2p_wps_method_pw_id
parameter_list|(
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|)
block|{
switch|switch
condition|(
name|wps_method
condition|)
block|{
case|case
name|WPS_PIN_DISPLAY
case|:
return|return
name|DEV_PW_REGISTRAR_SPECIFIED
return|;
case|case
name|WPS_PIN_KEYPAD
case|:
return|return
name|DEV_PW_USER_SPECIFIED
return|;
case|case
name|WPS_PBC
case|:
return|return
name|DEV_PW_PUSHBUTTON
return|;
case|case
name|WPS_NFC
case|:
return|return
name|DEV_PW_NFC_CONNECTION_HANDOVER
return|;
case|case
name|WPS_P2PS
case|:
return|return
name|DEV_PW_P2PS_DEFAULT
return|;
default|default:
return|return
name|DEV_PW_DEFAULT
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|p2p_wps_method_str
parameter_list|(
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|)
block|{
switch|switch
condition|(
name|wps_method
condition|)
block|{
case|case
name|WPS_PIN_DISPLAY
case|:
return|return
literal|"Display"
return|;
case|case
name|WPS_PIN_KEYPAD
case|:
return|return
literal|"Keypad"
return|;
case|case
name|WPS_PBC
case|:
return|return
literal|"PBC"
return|;
case|case
name|WPS_NFC
case|:
return|return
literal|"NFC"
return|;
case|case
name|WPS_P2PS
case|:
return|return
literal|"P2PS"
return|;
default|default:
return|return
literal|"??"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_build_go_neg_req
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|u8
name|group_capab
decl_stmt|;
name|size_t
name|extra
init|=
literal|0
decl_stmt|;
name|u16
name|pw_id
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|p2p
operator|->
name|wfd_ie_go_neg
condition|)
name|extra
operator|=
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|wfd_ie_go_neg
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
if|if
condition|(
name|p2p
operator|->
name|vendor_elem
operator|&&
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_REQ
index|]
condition|)
name|extra
operator|+=
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_REQ
index|]
argument_list|)
expr_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
operator|+
name|extra
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|p2p_buf_add_public_action_hdr
argument_list|(
name|buf
argument_list|,
name|P2P_GO_NEG_REQ
argument_list|,
name|peer
operator|->
name|dialog_token
argument_list|)
expr_stmt|;
name|len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|group_capab
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|flags
operator|&
name|P2P_DEV_PREFER_PERSISTENT_GROUP
condition|)
block|{
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_PERSISTENT_GROUP
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|flags
operator|&
name|P2P_DEV_PREFER_PERSISTENT_RECONN
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_PERSISTENT_RECONN
expr_stmt|;
block|}
if|if
condition|(
name|p2p
operator|->
name|cross_connect
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_CROSS_CONN
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|cfg
operator|->
name|p2p_intra_bss
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_INTRA_BSS_DIST
expr_stmt|;
name|p2p_buf_add_capability
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|dev_capab
operator|&
operator|~
name|P2P_DEV_CAPAB_CLIENT_DISCOVERABILITY
argument_list|,
name|group_capab
argument_list|)
expr_stmt|;
name|p2p_buf_add_go_intent
argument_list|(
name|buf
argument_list|,
operator|(
name|p2p
operator|->
name|go_intent
operator|<<
literal|1
operator|)
operator||
name|peer
operator|->
name|tie_breaker
argument_list|)
expr_stmt|;
name|p2p_buf_add_config_timeout
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|go_timeout
argument_list|,
name|p2p
operator|->
name|client_timeout
argument_list|)
expr_stmt|;
name|p2p_buf_add_listen_channel
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|reg_class
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|ext_listen_interval
condition|)
name|p2p_buf_add_ext_listen_timing
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|ext_listen_period
argument_list|,
name|p2p
operator|->
name|ext_listen_interval
argument_list|)
expr_stmt|;
name|p2p_buf_add_intended_addr
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|intended_addr
argument_list|)
expr_stmt|;
name|p2p_buf_add_channel_list
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
argument_list|,
operator|&
name|p2p
operator|->
name|channels
argument_list|)
expr_stmt|;
name|p2p_buf_add_device_info
argument_list|(
name|buf
argument_list|,
name|p2p
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|p2p_buf_add_operating_channel
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
name|p2p_buf_update_ie_hdr
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* WPS IE with Device Password ID attribute */
name|pw_id
operator|=
name|p2p_wps_method_pw_id
argument_list|(
name|peer
operator|->
name|wps_method
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|oob_pw_id
condition|)
name|pw_id
operator|=
name|peer
operator|->
name|oob_pw_id
expr_stmt|;
if|if
condition|(
name|p2p_build_wps_ie
argument_list|(
name|p2p
argument_list|,
name|buf
argument_list|,
name|pw_id
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Failed to build WPS IE for GO Negotiation Request"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|p2p
operator|->
name|wfd_ie_go_neg
condition|)
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|wfd_ie_go_neg
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
if|if
condition|(
name|p2p
operator|->
name|vendor_elem
operator|&&
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_REQ
index|]
condition|)
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_REQ
index|]
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|int
name|p2p_connect_send
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|req
decl_stmt|;
name|int
name|freq
decl_stmt|;
if|if
condition|(
name|dev
operator|->
name|flags
operator|&
name|P2P_DEV_PD_BEFORE_GO_NEG
condition|)
block|{
name|u16
name|config_method
decl_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Use PD-before-GO-Neg workaround for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|==
name|WPS_PIN_DISPLAY
condition|)
name|config_method
operator|=
name|WPS_CONFIG_KEYPAD
expr_stmt|;
elseif|else
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|==
name|WPS_PIN_KEYPAD
condition|)
name|config_method
operator|=
name|WPS_CONFIG_DISPLAY
expr_stmt|;
elseif|else
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|==
name|WPS_PBC
condition|)
name|config_method
operator|=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
elseif|else
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|==
name|WPS_P2PS
condition|)
name|config_method
operator|=
name|WPS_CONFIG_P2PS
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
return|return
name|p2p_prov_disc_req
argument_list|(
name|p2p
argument_list|,
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|NULL
argument_list|,
name|config_method
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
return|;
block|}
name|freq
operator|=
name|dev
operator|->
name|listen_freq
operator|>
literal|0
condition|?
name|dev
operator|->
name|listen_freq
else|:
name|dev
operator|->
name|oper_freq
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|oob_go_neg_freq
operator|>
literal|0
condition|)
name|freq
operator|=
name|dev
operator|->
name|oob_go_neg_freq
expr_stmt|;
if|if
condition|(
name|freq
operator|<=
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Listen/Operating frequency known for the peer "
name|MACSTR
literal|" to send GO Negotiation Request"
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|req
operator|=
name|p2p_build_go_neg_req
argument_list|(
name|p2p
argument_list|,
name|dev
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Sending GO Negotiation Request"
argument_list|)
expr_stmt|;
name|p2p_set_state
argument_list|(
name|p2p
argument_list|,
name|P2P_CONNECT
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_PENDING_GO_NEG_REQUEST
expr_stmt|;
name|p2p
operator|->
name|go_neg_peer
operator|=
name|dev
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|p2p_go_neg_wait_timeout
argument_list|,
name|p2p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dev
operator|->
name|flags
operator||=
name|P2P_DEV_WAIT_GO_NEG_RESPONSE
expr_stmt|;
name|dev
operator|->
name|connect_reqs
operator|++
expr_stmt|;
if|if
condition|(
name|p2p_send_action
argument_list|(
name|p2p
argument_list|,
name|freq
argument_list|,
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|,
name|wpabuf_head
argument_list|(
name|req
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|req
argument_list|)
argument_list|,
literal|500
argument_list|)
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Failed to send Action frame"
argument_list|)
expr_stmt|;
comment|/* Use P2P find to recover and retry */
name|p2p_set_timeout
argument_list|(
name|p2p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|dev
operator|->
name|go_neg_req_sent
operator|++
expr_stmt|;
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_build_go_neg_resp
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|peer
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|u8
name|status
parameter_list|,
name|u8
name|tie_breaker
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|u8
name|group_capab
decl_stmt|;
name|size_t
name|extra
init|=
literal|0
decl_stmt|;
name|u16
name|pw_id
decl_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Building GO Negotiation Response"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|p2p
operator|->
name|wfd_ie_go_neg
condition|)
name|extra
operator|=
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|wfd_ie_go_neg
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
if|if
condition|(
name|p2p
operator|->
name|vendor_elem
operator|&&
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_RESP
index|]
condition|)
name|extra
operator|+=
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_RESP
index|]
argument_list|)
expr_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
operator|+
name|extra
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|p2p_buf_add_public_action_hdr
argument_list|(
name|buf
argument_list|,
name|P2P_GO_NEG_RESP
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
name|len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|p2p_buf_add_status
argument_list|(
name|buf
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|group_capab
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|peer
operator|&&
name|peer
operator|->
name|go_state
operator|==
name|LOCAL_GO
condition|)
block|{
if|if
condition|(
name|peer
operator|->
name|flags
operator|&
name|P2P_DEV_PREFER_PERSISTENT_GROUP
condition|)
block|{
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_PERSISTENT_GROUP
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|flags
operator|&
name|P2P_DEV_PREFER_PERSISTENT_RECONN
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_PERSISTENT_RECONN
expr_stmt|;
block|}
if|if
condition|(
name|p2p
operator|->
name|cross_connect
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_CROSS_CONN
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|cfg
operator|->
name|p2p_intra_bss
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_INTRA_BSS_DIST
expr_stmt|;
block|}
name|p2p_buf_add_capability
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|dev_capab
operator|&
operator|~
name|P2P_DEV_CAPAB_CLIENT_DISCOVERABILITY
argument_list|,
name|group_capab
argument_list|)
expr_stmt|;
name|p2p_buf_add_go_intent
argument_list|(
name|buf
argument_list|,
operator|(
name|p2p
operator|->
name|go_intent
operator|<<
literal|1
operator|)
operator||
name|tie_breaker
argument_list|)
expr_stmt|;
name|p2p_buf_add_config_timeout
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|go_timeout
argument_list|,
name|p2p
operator|->
name|client_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|&&
name|peer
operator|->
name|go_state
operator|==
name|REMOTE_GO
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Omit Operating Channel attribute"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p2p_buf_add_operating_channel
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
block|}
name|p2p_buf_add_intended_addr
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|intended_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|||
name|peer
operator|==
name|NULL
condition|)
block|{
name|p2p_buf_add_channel_list
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
argument_list|,
operator|&
name|p2p
operator|->
name|channels
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|peer
operator|->
name|go_state
operator|==
name|REMOTE_GO
condition|)
block|{
name|p2p_buf_add_channel_list
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
argument_list|,
operator|&
name|p2p
operator|->
name|channels
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|p2p_channels
name|res
decl_stmt|;
name|p2p_channels_intersect
argument_list|(
operator|&
name|p2p
operator|->
name|channels
argument_list|,
operator|&
name|peer
operator|->
name|channels
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
name|p2p_buf_add_channel_list
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
block|}
name|p2p_buf_add_device_info
argument_list|(
name|buf
argument_list|,
name|p2p
argument_list|,
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|&&
name|peer
operator|->
name|go_state
operator|==
name|LOCAL_GO
condition|)
block|{
name|p2p_buf_add_group_id
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|p2p
operator|->
name|ssid
argument_list|,
name|p2p
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
name|p2p_buf_update_ie_hdr
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* WPS IE with Device Password ID attribute */
name|pw_id
operator|=
name|p2p_wps_method_pw_id
argument_list|(
name|peer
condition|?
name|peer
operator|->
name|wps_method
else|:
name|WPS_NOT_READY
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|&&
name|peer
operator|->
name|oob_pw_id
condition|)
name|pw_id
operator|=
name|peer
operator|->
name|oob_pw_id
expr_stmt|;
if|if
condition|(
name|p2p_build_wps_ie
argument_list|(
name|p2p
argument_list|,
name|buf
argument_list|,
name|pw_id
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Failed to build WPS IE for GO Negotiation Response"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|p2p
operator|->
name|wfd_ie_go_neg
condition|)
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|wfd_ie_go_neg
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
if|if
condition|(
name|p2p
operator|->
name|vendor_elem
operator|&&
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_RESP
index|]
condition|)
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_RESP
index|]
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/**  * p2p_reselect_channel - Re-select operating channel based on peer information  * @p2p: P2P module context from p2p_init()  * @intersection: Support channel list intersection from local and peer  *  * This function is used to re-select the best channel after having received  * information from the peer to allow supported channel lists to be intersected.  * This can be used to improve initial channel selection done in  * p2p_prepare_channel() prior to the start of GO Negotiation. In addition, this  * can be used for Invitation case.  */
end_comment

begin_function
name|void
name|p2p_reselect_channel
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_channels
modifier|*
name|intersection
parameter_list|)
block|{
name|struct
name|p2p_reg_class
modifier|*
name|cl
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|u8
name|op_reg_class
decl_stmt|,
name|op_channel
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
specifier|const
name|int
name|op_classes_5ghz
index|[]
init|=
block|{
literal|124
block|,
literal|115
block|,
literal|0
block|}
decl_stmt|;
specifier|const
name|int
name|op_classes_ht40
index|[]
init|=
block|{
literal|126
block|,
literal|127
block|,
literal|116
block|,
literal|117
block|,
literal|0
block|}
decl_stmt|;
specifier|const
name|int
name|op_classes_vht
index|[]
init|=
block|{
literal|128
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|p2p
operator|->
name|own_freq_preference
operator|>
literal|0
operator|&&
name|p2p_freq_to_channel
argument_list|(
name|p2p
operator|->
name|own_freq_preference
argument_list|,
operator|&
name|op_reg_class
argument_list|,
operator|&
name|op_channel
argument_list|)
operator|==
literal|0
operator|&&
name|p2p_channels_includes
argument_list|(
name|intersection
argument_list|,
name|op_reg_class
argument_list|,
name|op_channel
argument_list|)
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Pick own channel preference (reg_class %u channel %u) from intersection"
argument_list|,
name|op_reg_class
argument_list|,
name|op_channel
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|op_reg_class
operator|=
name|op_reg_class
expr_stmt|;
name|p2p
operator|->
name|op_channel
operator|=
name|op_channel
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|p2p
operator|->
name|best_freq_overall
operator|>
literal|0
operator|&&
name|p2p_freq_to_channel
argument_list|(
name|p2p
operator|->
name|best_freq_overall
argument_list|,
operator|&
name|op_reg_class
argument_list|,
operator|&
name|op_channel
argument_list|)
operator|==
literal|0
operator|&&
name|p2p_channels_includes
argument_list|(
name|intersection
argument_list|,
name|op_reg_class
argument_list|,
name|op_channel
argument_list|)
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Pick best overall channel (reg_class %u channel %u) from intersection"
argument_list|,
name|op_reg_class
argument_list|,
name|op_channel
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|op_reg_class
operator|=
name|op_reg_class
expr_stmt|;
name|p2p
operator|->
name|op_channel
operator|=
name|op_channel
expr_stmt|;
return|return;
block|}
comment|/* First, try to pick the best channel from another band */
name|freq
operator|=
name|p2p_channel_to_freq
argument_list|(
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|>=
literal|2400
operator|&&
name|freq
operator|<
literal|2500
operator|&&
name|p2p
operator|->
name|best_freq_5
operator|>
literal|0
operator|&&
operator|!
name|p2p_channels_includes
argument_list|(
name|intersection
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
operator|&&
name|p2p_freq_to_channel
argument_list|(
name|p2p
operator|->
name|best_freq_5
argument_list|,
operator|&
name|op_reg_class
argument_list|,
operator|&
name|op_channel
argument_list|)
operator|==
literal|0
operator|&&
name|p2p_channels_includes
argument_list|(
name|intersection
argument_list|,
name|op_reg_class
argument_list|,
name|op_channel
argument_list|)
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Pick best 5 GHz channel (reg_class %u channel %u) from intersection"
argument_list|,
name|op_reg_class
argument_list|,
name|op_channel
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|op_reg_class
operator|=
name|op_reg_class
expr_stmt|;
name|p2p
operator|->
name|op_channel
operator|=
name|op_channel
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|freq
operator|>=
literal|4900
operator|&&
name|freq
operator|<
literal|6000
operator|&&
name|p2p
operator|->
name|best_freq_24
operator|>
literal|0
operator|&&
operator|!
name|p2p_channels_includes
argument_list|(
name|intersection
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
operator|&&
name|p2p_freq_to_channel
argument_list|(
name|p2p
operator|->
name|best_freq_24
argument_list|,
operator|&
name|op_reg_class
argument_list|,
operator|&
name|op_channel
argument_list|)
operator|==
literal|0
operator|&&
name|p2p_channels_includes
argument_list|(
name|intersection
argument_list|,
name|op_reg_class
argument_list|,
name|op_channel
argument_list|)
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Pick best 2.4 GHz channel (reg_class %u channel %u) from intersection"
argument_list|,
name|op_reg_class
argument_list|,
name|op_channel
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|op_reg_class
operator|=
name|op_reg_class
expr_stmt|;
name|p2p
operator|->
name|op_channel
operator|=
name|op_channel
expr_stmt|;
return|return;
block|}
comment|/* Select channel with highest preference if the peer supports it */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|p2p
operator|->
name|cfg
operator|->
name|pref_chan
operator|&&
name|i
operator|<
name|p2p
operator|->
name|cfg
operator|->
name|num_pref_chan
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p2p_channels_includes
argument_list|(
name|intersection
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|pref_chan
index|[
name|i
index|]
operator|.
name|op_class
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|pref_chan
index|[
name|i
index|]
operator|.
name|chan
argument_list|)
condition|)
block|{
name|p2p
operator|->
name|op_reg_class
operator|=
name|p2p
operator|->
name|cfg
operator|->
name|pref_chan
index|[
name|i
index|]
operator|.
name|op_class
expr_stmt|;
name|p2p
operator|->
name|op_channel
operator|=
name|p2p
operator|->
name|cfg
operator|->
name|pref_chan
index|[
name|i
index|]
operator|.
name|chan
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Pick highest preferred channel (op_class %u channel %u) from intersection"
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* Try a channel where we might be able to use VHT */
if|if
condition|(
name|p2p_channel_select
argument_list|(
name|intersection
argument_list|,
name|op_classes_vht
argument_list|,
operator|&
name|p2p
operator|->
name|op_reg_class
argument_list|,
operator|&
name|p2p
operator|->
name|op_channel
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Pick possible VHT channel (op_class %u channel %u) from intersection"
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Try a channel where we might be able to use HT40 */
if|if
condition|(
name|p2p_channel_select
argument_list|(
name|intersection
argument_list|,
name|op_classes_ht40
argument_list|,
operator|&
name|p2p
operator|->
name|op_reg_class
argument_list|,
operator|&
name|p2p
operator|->
name|op_channel
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Pick possible HT40 channel (op_class %u channel %u) from intersection"
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Prefer a 5 GHz channel */
if|if
condition|(
name|p2p_channel_select
argument_list|(
name|intersection
argument_list|,
name|op_classes_5ghz
argument_list|,
operator|&
name|p2p
operator|->
name|op_reg_class
argument_list|,
operator|&
name|p2p
operator|->
name|op_channel
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Pick possible 5 GHz channel (op_class %u channel %u) from intersection"
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Try to see if the original channel is in the intersection. If 	 * so, no need to change anything, as it already contains some 	 * randomness. 	 */
if|if
condition|(
name|p2p_channels_includes
argument_list|(
name|intersection
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Using original operating class and channel (op_class %u channel %u) from intersection"
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Fall back to whatever is included in the channel intersection since 	 * no better options seems to be available. 	 */
name|cl
operator|=
operator|&
name|intersection
operator|->
name|reg_class
index|[
literal|0
index|]
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Pick another channel (reg_class %u channel %u) from intersection"
argument_list|,
name|cl
operator|->
name|reg_class
argument_list|,
name|cl
operator|->
name|channel
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|op_reg_class
operator|=
name|cl
operator|->
name|reg_class
expr_stmt|;
name|p2p
operator|->
name|op_channel
operator|=
name|cl
operator|->
name|channel
index|[
literal|0
index|]
expr_stmt|;
block|}
end_function

begin_function
name|int
name|p2p_go_select_channel
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|dev
parameter_list|,
name|u8
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|p2p_channels
name|tmp
decl_stmt|,
name|intersection
decl_stmt|;
name|p2p_channels_dump
argument_list|(
name|p2p
argument_list|,
literal|"own channels"
argument_list|,
operator|&
name|p2p
operator|->
name|channels
argument_list|)
expr_stmt|;
name|p2p_channels_dump
argument_list|(
name|p2p
argument_list|,
literal|"peer channels"
argument_list|,
operator|&
name|dev
operator|->
name|channels
argument_list|)
expr_stmt|;
name|p2p_channels_intersect
argument_list|(
operator|&
name|p2p
operator|->
name|channels
argument_list|,
operator|&
name|dev
operator|->
name|channels
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|p2p_channels_dump
argument_list|(
name|p2p
argument_list|,
literal|"intersection"
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|p2p_channels_remove_freqs
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|p2p
operator|->
name|no_go_freq
argument_list|)
expr_stmt|;
name|p2p_channels_dump
argument_list|(
name|p2p
argument_list|,
literal|"intersection after no-GO removal"
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|p2p_channels_intersect
argument_list|(
operator|&
name|tmp
argument_list|,
operator|&
name|p2p
operator|->
name|cfg
operator|->
name|channels
argument_list|,
operator|&
name|intersection
argument_list|)
expr_stmt|;
name|p2p_channels_dump
argument_list|(
name|p2p
argument_list|,
literal|"intersection with local channel list"
argument_list|,
operator|&
name|intersection
argument_list|)
expr_stmt|;
if|if
condition|(
name|intersection
operator|.
name|reg_classes
operator|==
literal|0
operator|||
name|intersection
operator|.
name|reg_class
index|[
literal|0
index|]
operator|.
name|channels
operator|==
literal|0
condition|)
block|{
operator|*
name|status
operator|=
name|P2P_SC_FAIL_NO_COMMON_CHANNELS
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No common channels found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|p2p_channels_includes
argument_list|(
operator|&
name|intersection
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
condition|)
block|{
if|if
condition|(
name|dev
operator|->
name|flags
operator|&
name|P2P_DEV_FORCE_FREQ
condition|)
block|{
operator|*
name|status
operator|=
name|P2P_SC_FAIL_NO_COMMON_CHANNELS
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Peer does not support the forced channel"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Selected operating channel (op_class %u channel %u) not acceptable to the peer"
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
name|p2p_reselect_channel
argument_list|(
name|p2p
argument_list|,
operator|&
name|intersection
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|dev
operator|->
name|flags
operator|&
name|P2P_DEV_FORCE_FREQ
operator|)
operator|&&
operator|!
name|p2p
operator|->
name|cfg
operator|->
name|cfg_op_channel
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Try to optimize channel selection with peer information received; previously selected op_class %u channel %u"
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
name|p2p_reselect_channel
argument_list|(
name|p2p
argument_list|,
operator|&
name|intersection
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|p2p
operator|->
name|ssid_set
condition|)
block|{
name|p2p_build_ssid
argument_list|(
name|p2p
argument_list|,
name|p2p
operator|->
name|ssid
argument_list|,
operator|&
name|p2p
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|ssid_set
operator|=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|p2p_process_go_neg_req
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|rx_freq
parameter_list|)
block|{
name|struct
name|p2p_device
modifier|*
name|dev
init|=
name|NULL
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|u8
name|status
init|=
name|P2P_SC_FAIL_INVALID_PARAMS
decl_stmt|;
name|int
name|tie_breaker
init|=
literal|0
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Received GO Negotiation Request from "
name|MACSTR
literal|"(freq=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|rx_freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_parse
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|msg
operator|.
name|capability
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Mandatory Capability attribute missing from GO Negotiation Request"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P_STRICT
goto|goto
name|fail
goto|;
endif|#
directive|endif
comment|/* CONFIG_P2P_STRICT */
block|}
if|if
condition|(
name|msg
operator|.
name|go_intent
condition|)
name|tie_breaker
operator|=
operator|*
name|msg
operator|.
name|go_intent
operator|&
literal|0x01
expr_stmt|;
else|else
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Mandatory GO Intent attribute missing from GO Negotiation Request"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P_STRICT
goto|goto
name|fail
goto|;
endif|#
directive|endif
comment|/* CONFIG_P2P_STRICT */
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|config_timeout
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Mandatory Configuration Timeout attribute missing from GO Negotiation Request"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P_STRICT
goto|goto
name|fail
goto|;
endif|#
directive|endif
comment|/* CONFIG_P2P_STRICT */
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|listen_channel
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Listen Channel attribute received"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|operating_channel
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Operating Channel attribute received"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|channel_list
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Channel List attribute received"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|intended_addr
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Intended P2P Interface Address attribute received"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|p2p_device_info
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No P2P Device Info attribute received"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|msg
operator|.
name|p2p_device_addr
argument_list|,
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unexpected GO Negotiation Request SA="
name|MACSTR
literal|" != dev_addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|msg
operator|.
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|dev
operator|=
name|p2p_get_device
argument_list|(
name|p2p
argument_list|,
name|sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|.
name|status
operator|&&
operator|*
name|msg
operator|.
name|status
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unexpected Status attribute (%d) in GO Negotiation Request"
argument_list|,
operator|*
name|msg
operator|.
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|&&
name|p2p
operator|->
name|go_neg_peer
operator|==
name|dev
operator|&&
operator|*
name|msg
operator|.
name|status
operator|==
name|P2P_SC_FAIL_REJECTED_BY_USER
condition|)
block|{
comment|/* 			 * This mechanism for using Status attribute in GO 			 * Negotiation Request is not compliant with the P2P 			 * specification, but some deployed devices use it to 			 * indicate rejection of GO Negotiation in a case where 			 * they have sent out GO Negotiation Response with 			 * status 1. The P2P specification explicitly disallows 			 * this. To avoid unnecessary interoperability issues 			 * and extra frames, mark the pending negotiation as 			 * failed and do not reply to this GO Negotiation 			 * Request frame. 			 */
name|p2p
operator|->
name|cfg
operator|->
name|send_action_done
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|)
expr_stmt|;
name|p2p_go_neg_failed
argument_list|(
name|p2p
argument_list|,
operator|*
name|msg
operator|.
name|status
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|dev
operator|==
name|NULL
condition|)
name|dev
operator|=
name|p2p_add_dev_from_go_neg_req
argument_list|(
name|p2p
argument_list|,
name|sa
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dev
operator|->
name|flags
operator|&
name|P2P_DEV_PROBE_REQ_ONLY
operator|)
operator|||
operator|!
operator|(
name|dev
operator|->
name|flags
operator|&
name|P2P_DEV_REPORTED
operator|)
condition|)
name|p2p_add_dev_info
argument_list|(
name|p2p
argument_list|,
name|sa
argument_list|,
name|dev
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|dev
operator|->
name|listen_freq
operator|&&
operator|!
name|dev
operator|->
name|oper_freq
condition|)
block|{
comment|/* 		 * This may happen if the peer entry was added based on PD 		 * Request and no Probe Request/Response frame has been received 		 * from this peer (or that information has timed out). 		 */
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Update peer "
name|MACSTR
literal|" based on GO Neg Req since listen/oper freq not known"
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|info
operator|.
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
name|p2p_add_dev_info
argument_list|(
name|p2p
argument_list|,
name|sa
argument_list|,
name|dev
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p2p
operator|->
name|go_neg_peer
operator|&&
name|p2p
operator|->
name|go_neg_peer
operator|==
name|dev
condition|)
name|eloop_cancel_timeout
argument_list|(
name|p2p_go_neg_wait_timeout
argument_list|,
name|p2p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|&&
name|dev
operator|->
name|flags
operator|&
name|P2P_DEV_USER_REJECTED
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"User has rejected this peer"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_REJECTED_BY_USER
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dev
operator|==
name|NULL
operator|||
operator|(
name|dev
operator|->
name|wps_method
operator|==
name|WPS_NOT_READY
operator|&&
operator|(
name|p2p
operator|->
name|authorized_oob_dev_pw_id
operator|==
literal|0
operator|||
name|p2p
operator|->
name|authorized_oob_dev_pw_id
operator|!=
name|msg
operator|.
name|dev_password_id
operator|)
operator|)
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Not ready for GO negotiation with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INFO_CURRENTLY_UNAVAILABLE
expr_stmt|;
name|p2p
operator|->
name|cfg
operator|->
name|go_neg_req_rx
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|,
name|sa
argument_list|,
name|msg
operator|.
name|dev_password_id
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|p2p
operator|->
name|go_neg_peer
operator|&&
name|p2p
operator|->
name|go_neg_peer
operator|!=
name|dev
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Already in Group Formation with another peer"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_UNABLE_TO_ACCOMMODATE
expr_stmt|;
block|}
else|else
block|{
name|int
name|go
decl_stmt|;
if|if
condition|(
operator|!
name|p2p
operator|->
name|go_neg_peer
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Starting GO Negotiation with previously authorized peer"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|dev
operator|->
name|flags
operator|&
name|P2P_DEV_FORCE_FREQ
operator|)
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Use default channel settings"
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|op_reg_class
operator|=
name|p2p
operator|->
name|cfg
operator|->
name|op_reg_class
expr_stmt|;
name|p2p
operator|->
name|op_channel
operator|=
name|p2p
operator|->
name|cfg
operator|->
name|op_channel
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|p2p
operator|->
name|channels
argument_list|,
operator|&
name|p2p
operator|->
name|cfg
operator|->
name|channels
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|p2p_channels
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Use previously configured forced channel settings"
argument_list|)
expr_stmt|;
block|}
block|}
name|dev
operator|->
name|flags
operator|&=
operator|~
name|P2P_DEV_NOT_YET_READY
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|.
name|go_intent
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No GO Intent attribute received"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|(
operator|*
name|msg
operator|.
name|go_intent
operator|>>
literal|1
operator|)
operator|>
name|P2P_MAX_GO_INTENT
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Invalid GO Intent value (%u) received"
argument_list|,
operator|*
name|msg
operator|.
name|go_intent
operator|>>
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|dev
operator|->
name|go_neg_req_sent
operator|&&
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|>
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Do not reply since peer has higher address and GO Neg Request already sent"
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|go
operator|=
name|p2p_go_det
argument_list|(
name|p2p
operator|->
name|go_intent
argument_list|,
operator|*
name|msg
operator|.
name|go_intent
argument_list|)
expr_stmt|;
if|if
condition|(
name|go
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Incompatible GO Intent"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_BOTH_GO_INTENT_15
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|p2p_peer_channels
argument_list|(
name|p2p
argument_list|,
name|dev
argument_list|,
name|msg
operator|.
name|channel_list
argument_list|,
name|msg
operator|.
name|channel_list_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No common channels found"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_NO_COMMON_CHANNELS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
switch|switch
condition|(
name|msg
operator|.
name|dev_password_id
condition|)
block|{
case|case
name|DEV_PW_REGISTRAR_SPECIFIED
case|:
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"PIN from peer Display"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|!=
name|WPS_PIN_KEYPAD
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"We have wps_method=%s -> incompatible"
argument_list|,
name|p2p_wps_method_str
argument_list|(
name|dev
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
break|break;
case|case
name|DEV_PW_USER_SPECIFIED
case|:
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Peer entered PIN on Keypad"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|!=
name|WPS_PIN_DISPLAY
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"We have wps_method=%s -> incompatible"
argument_list|,
name|p2p_wps_method_str
argument_list|(
name|dev
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
break|break;
case|case
name|DEV_PW_PUSHBUTTON
case|:
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Peer using pushbutton"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|!=
name|WPS_PBC
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"We have wps_method=%s -> incompatible"
argument_list|,
name|p2p_wps_method_str
argument_list|(
name|dev
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
break|break;
case|case
name|DEV_PW_P2PS_DEFAULT
case|:
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Peer using P2PS pin"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|!=
name|WPS_P2PS
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"We have wps_method=%s -> incompatible"
argument_list|,
name|p2p_wps_method_str
argument_list|(
name|dev
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
break|break;
default|default:
if|if
condition|(
name|msg
operator|.
name|dev_password_id
operator|&&
name|msg
operator|.
name|dev_password_id
operator|==
name|dev
operator|->
name|oob_pw_id
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Peer using NFC"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|!=
name|WPS_NFC
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"We have wps_method=%s -> incompatible"
argument_list|,
name|p2p_wps_method_str
argument_list|(
name|dev
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
break|break;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
if|if
condition|(
name|p2p
operator|->
name|authorized_oob_dev_pw_id
operator|&&
name|msg
operator|.
name|dev_password_id
operator|==
name|p2p
operator|->
name|authorized_oob_dev_pw_id
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Using static handover with our device password from NFC Tag"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|wps_method
operator|=
name|WPS_NFC
expr_stmt|;
name|dev
operator|->
name|oob_pw_id
operator|=
name|p2p
operator|->
name|authorized_oob_dev_pw_id
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported Device Password ID %d"
argument_list|,
name|msg
operator|.
name|dev_password_id
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|go
operator|&&
name|p2p_go_select_channel
argument_list|(
name|p2p
argument_list|,
name|dev
argument_list|,
operator|&
name|status
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|dev
operator|->
name|go_state
operator|=
name|go
condition|?
name|LOCAL_GO
else|:
name|REMOTE_GO
expr_stmt|;
name|dev
operator|->
name|oper_freq
operator|=
name|p2p_channel_to_freq
argument_list|(
name|msg
operator|.
name|operating_channel
index|[
literal|3
index|]
argument_list|,
name|msg
operator|.
name|operating_channel
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Peer operating channel preference: %d MHz"
argument_list|,
name|dev
operator|->
name|oper_freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|.
name|config_timeout
condition|)
block|{
name|dev
operator|->
name|go_timeout
operator|=
name|msg
operator|.
name|config_timeout
index|[
literal|0
index|]
expr_stmt|;
name|dev
operator|->
name|client_timeout
operator|=
name|msg
operator|.
name|config_timeout
index|[
literal|1
index|]
expr_stmt|;
block|}
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"GO Negotiation with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|state
operator|!=
name|P2P_IDLE
condition|)
name|p2p_stop_find_for_freq
argument_list|(
name|p2p
argument_list|,
name|rx_freq
argument_list|)
expr_stmt|;
name|p2p_set_state
argument_list|(
name|p2p
argument_list|,
name|P2P_GO_NEG
argument_list|)
expr_stmt|;
name|p2p_clear_timeout
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|dev
operator|->
name|dialog_token
operator|=
name|msg
operator|.
name|dialog_token
expr_stmt|;
name|os_memcpy
argument_list|(
name|dev
operator|->
name|intended_addr
argument_list|,
name|msg
operator|.
name|intended_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|go_neg_peer
operator|=
name|dev
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|p2p_go_neg_wait_timeout
argument_list|,
name|p2p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_SUCCESS
expr_stmt|;
block|}
name|fail
label|:
if|if
condition|(
name|dev
condition|)
name|dev
operator|->
name|status
operator|=
name|status
expr_stmt|;
name|resp
operator|=
name|p2p_build_go_neg_resp
argument_list|(
name|p2p
argument_list|,
name|dev
argument_list|,
name|msg
operator|.
name|dialog_token
argument_list|,
name|status
argument_list|,
operator|!
name|tie_breaker
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Sending GO Negotiation Response"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rx_freq
operator|>
literal|0
condition|)
name|freq
operator|=
name|rx_freq
expr_stmt|;
else|else
name|freq
operator|=
name|p2p_channel_to_freq
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|reg_class
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unknown regulatory class/channel"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
operator|==
name|P2P_SC_SUCCESS
condition|)
block|{
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_PENDING_GO_NEG_RESPONSE
expr_stmt|;
name|dev
operator|->
name|flags
operator||=
name|P2P_DEV_WAIT_GO_NEG_CONFIRM
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* 			 * Peer has smaller address, so the GO Negotiation 			 * Response from us is expected to complete 			 * negotiation. Ignore a GO Negotiation Response from 			 * the peer if it happens to be received after this 			 * point due to a race condition in GO Negotiation 			 * Request transmission and processing. 			 */
name|dev
operator|->
name|flags
operator|&=
operator|~
name|P2P_DEV_WAIT_GO_NEG_RESPONSE
expr_stmt|;
block|}
block|}
else|else
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_PENDING_GO_NEG_RESPONSE_FAILURE
expr_stmt|;
if|if
condition|(
name|p2p_send_action
argument_list|(
name|p2p
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|wpabuf_head
argument_list|(
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
argument_list|,
literal|500
argument_list|)
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Failed to send Action frame"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|p2p_build_go_neg_conf
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
name|struct
name|p2p_device
modifier|*
name|peer
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|u8
name|status
parameter_list|,
specifier|const
name|u8
modifier|*
name|resp_chan
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|struct
name|p2p_channels
name|res
decl_stmt|;
name|u8
name|group_capab
decl_stmt|;
name|size_t
name|extra
init|=
literal|0
decl_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Building GO Negotiation Confirm"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|p2p
operator|->
name|wfd_ie_go_neg
condition|)
name|extra
operator|=
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|wfd_ie_go_neg
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
if|if
condition|(
name|p2p
operator|->
name|vendor_elem
operator|&&
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_CONF
index|]
condition|)
name|extra
operator|+=
name|wpabuf_len
argument_list|(
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_CONF
index|]
argument_list|)
expr_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
operator|+
name|extra
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|p2p_buf_add_public_action_hdr
argument_list|(
name|buf
argument_list|,
name|P2P_GO_NEG_CONF
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
name|len
operator|=
name|p2p_buf_add_ie_hdr
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|p2p_buf_add_status
argument_list|(
name|buf
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|group_capab
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|go_state
operator|==
name|LOCAL_GO
condition|)
block|{
if|if
condition|(
name|peer
operator|->
name|flags
operator|&
name|P2P_DEV_PREFER_PERSISTENT_GROUP
condition|)
block|{
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_PERSISTENT_GROUP
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|flags
operator|&
name|P2P_DEV_PREFER_PERSISTENT_RECONN
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_PERSISTENT_RECONN
expr_stmt|;
block|}
if|if
condition|(
name|p2p
operator|->
name|cross_connect
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_CROSS_CONN
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|cfg
operator|->
name|p2p_intra_bss
condition|)
name|group_capab
operator||=
name|P2P_GROUP_CAPAB_INTRA_BSS_DIST
expr_stmt|;
block|}
name|p2p_buf_add_capability
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|dev_capab
operator|&
operator|~
name|P2P_DEV_CAPAB_CLIENT_DISCOVERABILITY
argument_list|,
name|group_capab
argument_list|)
expr_stmt|;
if|if
condition|(
name|go
operator|||
name|resp_chan
operator|==
name|NULL
condition|)
name|p2p_buf_add_operating_channel
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
argument_list|,
name|p2p
operator|->
name|op_reg_class
argument_list|,
name|p2p
operator|->
name|op_channel
argument_list|)
expr_stmt|;
else|else
name|p2p_buf_add_operating_channel
argument_list|(
name|buf
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|resp_chan
argument_list|,
name|resp_chan
index|[
literal|3
index|]
argument_list|,
name|resp_chan
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|p2p_channels_intersect
argument_list|(
operator|&
name|p2p
operator|->
name|channels
argument_list|,
operator|&
name|peer
operator|->
name|channels
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
name|p2p_buf_add_channel_list
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|country
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|go
condition|)
block|{
name|p2p_buf_add_group_id
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|p2p
operator|->
name|ssid
argument_list|,
name|p2p
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
name|p2p_buf_update_ie_hdr
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
if|if
condition|(
name|p2p
operator|->
name|wfd_ie_go_neg
condition|)
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|wfd_ie_go_neg
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
if|if
condition|(
name|p2p
operator|->
name|vendor_elem
operator|&&
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_CONF
index|]
condition|)
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|p2p
operator|->
name|vendor_elem
index|[
name|VENDOR_ELEM_P2P_GO_NEG_CONF
index|]
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|void
name|p2p_process_go_neg_resp
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|rx_freq
parameter_list|)
block|{
name|struct
name|p2p_device
modifier|*
name|dev
decl_stmt|;
name|int
name|go
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|u8
name|status
init|=
name|P2P_SC_SUCCESS
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Received GO Negotiation Response from "
name|MACSTR
literal|" (freq=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|rx_freq
argument_list|)
expr_stmt|;
name|dev
operator|=
name|p2p_get_device
argument_list|(
name|p2p
argument_list|,
name|sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
operator|||
name|dev
operator|->
name|wps_method
operator|==
name|WPS_NOT_READY
operator|||
name|dev
operator|!=
name|p2p
operator|->
name|go_neg_peer
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Not ready for GO negotiation with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|p2p_parse
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|dev
operator|->
name|flags
operator|&
name|P2P_DEV_WAIT_GO_NEG_RESPONSE
operator|)
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Was not expecting GO Negotiation Response - ignore"
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|dev
operator|->
name|flags
operator|&=
operator|~
name|P2P_DEV_WAIT_GO_NEG_RESPONSE
expr_stmt|;
if|if
condition|(
name|msg
operator|.
name|dialog_token
operator|!=
name|dev
operator|->
name|dialog_token
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unexpected Dialog Token %u (expected %u)"
argument_list|,
name|msg
operator|.
name|dialog_token
argument_list|,
name|dev
operator|->
name|dialog_token
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|status
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Status attribute received"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INVALID_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|*
name|msg
operator|.
name|status
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"GO Negotiation rejected: status %d"
argument_list|,
operator|*
name|msg
operator|.
name|status
argument_list|)
expr_stmt|;
name|dev
operator|->
name|go_neg_req_sent
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|*
name|msg
operator|.
name|status
operator|==
name|P2P_SC_FAIL_INFO_CURRENTLY_UNAVAILABLE
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Wait for the peer to become ready for GO Negotiation"
argument_list|)
expr_stmt|;
name|dev
operator|->
name|flags
operator||=
name|P2P_DEV_NOT_YET_READY
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|p2p_go_neg_wait_timeout
argument_list|,
name|p2p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|120
argument_list|,
literal|0
argument_list|,
name|p2p_go_neg_wait_timeout
argument_list|,
name|p2p
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|->
name|state
operator|==
name|P2P_CONNECT_LISTEN
condition|)
name|p2p_set_state
argument_list|(
name|p2p
argument_list|,
name|P2P_WAIT_PEER_CONNECT
argument_list|)
expr_stmt|;
else|else
name|p2p_set_state
argument_list|(
name|p2p
argument_list|,
name|P2P_WAIT_PEER_IDLE
argument_list|)
expr_stmt|;
name|p2p_set_timeout
argument_list|(
name|p2p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Stop GO Negotiation attempt"
argument_list|)
expr_stmt|;
name|p2p_go_neg_failed
argument_list|(
name|p2p
argument_list|,
operator|*
name|msg
operator|.
name|status
argument_list|)
expr_stmt|;
block|}
name|p2p
operator|->
name|cfg
operator|->
name|send_action_done
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|capability
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Mandatory Capability attribute missing from GO Negotiation Response"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P_STRICT
name|status
operator|=
name|P2P_SC_FAIL_INVALID_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
endif|#
directive|endif
comment|/* CONFIG_P2P_STRICT */
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|p2p_device_info
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Mandatory P2P Device Info attribute missing from GO Negotiation Response"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P_STRICT
name|status
operator|=
name|P2P_SC_FAIL_INVALID_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
endif|#
directive|endif
comment|/* CONFIG_P2P_STRICT */
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|intended_addr
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Intended P2P Interface Address attribute received"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INVALID_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|go_intent
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No GO Intent attribute received"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INVALID_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|(
operator|*
name|msg
operator|.
name|go_intent
operator|>>
literal|1
operator|)
operator|>
name|P2P_MAX_GO_INTENT
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Invalid GO Intent value (%u) received"
argument_list|,
operator|*
name|msg
operator|.
name|go_intent
operator|>>
literal|1
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INVALID_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|go
operator|=
name|p2p_go_det
argument_list|(
name|p2p
operator|->
name|go_intent
argument_list|,
operator|*
name|msg
operator|.
name|go_intent
argument_list|)
expr_stmt|;
if|if
condition|(
name|go
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Incompatible GO Intent"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|go
operator|&&
name|msg
operator|.
name|group_id
condition|)
block|{
comment|/* Store SSID for Provisioning step */
name|p2p
operator|->
name|ssid_len
operator|=
name|msg
operator|.
name|group_id_len
operator|-
name|ETH_ALEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|->
name|ssid
argument_list|,
name|msg
operator|.
name|group_id
operator|+
name|ETH_ALEN
argument_list|,
name|p2p
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|go
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Mandatory P2P Group ID attribute missing from GO Negotiation Response"
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|ssid_len
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INVALID_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|config_timeout
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Mandatory Configuration Timeout attribute missing from GO Negotiation Response"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P_STRICT
name|status
operator|=
name|P2P_SC_FAIL_INVALID_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
endif|#
directive|endif
comment|/* CONFIG_P2P_STRICT */
block|}
else|else
block|{
name|dev
operator|->
name|go_timeout
operator|=
name|msg
operator|.
name|config_timeout
index|[
literal|0
index|]
expr_stmt|;
name|dev
operator|->
name|client_timeout
operator|=
name|msg
operator|.
name|config_timeout
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|operating_channel
operator|&&
operator|!
name|go
condition|)
block|{
comment|/* 		 * Note: P2P Client may omit Operating Channel attribute to 		 * indicate it does not have a preference. 		 */
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Operating Channel attribute received"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INVALID_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|channel_list
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Channel List attribute received"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INVALID_PARAMS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|p2p_peer_channels
argument_list|(
name|p2p
argument_list|,
name|dev
argument_list|,
name|msg
operator|.
name|channel_list
argument_list|,
name|msg
operator|.
name|channel_list_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No common channels found"
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_NO_COMMON_CHANNELS
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|msg
operator|.
name|operating_channel
condition|)
block|{
name|dev
operator|->
name|oper_freq
operator|=
name|p2p_channel_to_freq
argument_list|(
name|msg
operator|.
name|operating_channel
index|[
literal|3
index|]
argument_list|,
name|msg
operator|.
name|operating_channel
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Peer operating channel preference: %d MHz"
argument_list|,
name|dev
operator|->
name|oper_freq
argument_list|)
expr_stmt|;
block|}
else|else
name|dev
operator|->
name|oper_freq
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|msg
operator|.
name|dev_password_id
condition|)
block|{
case|case
name|DEV_PW_REGISTRAR_SPECIFIED
case|:
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"PIN from peer Display"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|!=
name|WPS_PIN_KEYPAD
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"We have wps_method=%s -> incompatible"
argument_list|,
name|p2p_wps_method_str
argument_list|(
name|dev
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
break|break;
case|case
name|DEV_PW_USER_SPECIFIED
case|:
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Peer entered PIN on Keypad"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|!=
name|WPS_PIN_DISPLAY
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"We have wps_method=%s -> incompatible"
argument_list|,
name|p2p_wps_method_str
argument_list|(
name|dev
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
break|break;
case|case
name|DEV_PW_PUSHBUTTON
case|:
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Peer using pushbutton"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|!=
name|WPS_PBC
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"We have wps_method=%s -> incompatible"
argument_list|,
name|p2p_wps_method_str
argument_list|(
name|dev
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
break|break;
case|case
name|DEV_PW_P2PS_DEFAULT
case|:
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"P2P: Peer using P2PS default pin"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|!=
name|WPS_P2PS
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"We have wps_method=%s -> incompatible"
argument_list|,
name|p2p_wps_method_str
argument_list|(
name|dev
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
break|break;
default|default:
if|if
condition|(
name|msg
operator|.
name|dev_password_id
operator|&&
name|msg
operator|.
name|dev_password_id
operator|==
name|dev
operator|->
name|oob_pw_id
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Peer using NFC"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|wps_method
operator|!=
name|WPS_NFC
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"We have wps_method=%s -> incompatible"
argument_list|,
name|p2p_wps_method_str
argument_list|(
name|dev
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
break|break;
block|}
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unsupported Device Password ID %d"
argument_list|,
name|msg
operator|.
name|dev_password_id
argument_list|)
expr_stmt|;
name|status
operator|=
name|P2P_SC_FAIL_INCOMPATIBLE_PROV_METHOD
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|go
operator|&&
name|p2p_go_select_channel
argument_list|(
name|p2p
argument_list|,
name|dev
argument_list|,
operator|&
name|status
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|p2p_set_state
argument_list|(
name|p2p
argument_list|,
name|P2P_GO_NEG
argument_list|)
expr_stmt|;
name|p2p_clear_timeout
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"GO Negotiation with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|dev
operator|->
name|intended_addr
argument_list|,
name|msg
operator|.
name|intended_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|fail
label|:
comment|/* Store GO Negotiation Confirmation to allow retransmission */
name|wpabuf_free
argument_list|(
name|dev
operator|->
name|go_neg_conf
argument_list|)
expr_stmt|;
name|dev
operator|->
name|go_neg_conf
operator|=
name|p2p_build_go_neg_conf
argument_list|(
name|p2p
argument_list|,
name|dev
argument_list|,
name|msg
operator|.
name|dialog_token
argument_list|,
name|status
argument_list|,
name|msg
operator|.
name|operating_channel
argument_list|,
name|go
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|go_neg_conf
operator|==
name|NULL
condition|)
return|return;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Sending GO Negotiation Confirm"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|P2P_SC_SUCCESS
condition|)
block|{
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_PENDING_GO_NEG_CONFIRM
expr_stmt|;
name|dev
operator|->
name|go_state
operator|=
name|go
condition|?
name|LOCAL_GO
else|:
name|REMOTE_GO
expr_stmt|;
block|}
else|else
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_NO_PENDING_ACTION
expr_stmt|;
if|if
condition|(
name|rx_freq
operator|>
literal|0
condition|)
name|freq
operator|=
name|rx_freq
expr_stmt|;
else|else
name|freq
operator|=
name|dev
operator|->
name|listen_freq
expr_stmt|;
name|dev
operator|->
name|go_neg_conf_freq
operator|=
name|freq
expr_stmt|;
name|dev
operator|->
name|go_neg_conf_sent
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p2p_send_action
argument_list|(
name|p2p
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|p2p
operator|->
name|cfg
operator|->
name|dev_addr
argument_list|,
name|sa
argument_list|,
name|wpabuf_head
argument_list|(
name|dev
operator|->
name|go_neg_conf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|dev
operator|->
name|go_neg_conf
argument_list|)
argument_list|,
literal|200
argument_list|)
operator|<
literal|0
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Failed to send Action frame"
argument_list|)
expr_stmt|;
name|p2p_go_neg_failed
argument_list|(
name|p2p
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|cfg
operator|->
name|send_action_done
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|)
expr_stmt|;
block|}
else|else
name|dev
operator|->
name|go_neg_conf_sent
operator|++
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|P2P_SC_SUCCESS
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"GO Negotiation failed"
argument_list|)
expr_stmt|;
name|p2p_go_neg_failed
argument_list|(
name|p2p
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|p2p_process_go_neg_conf
parameter_list|(
name|struct
name|p2p_data
modifier|*
name|p2p
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|p2p_device
modifier|*
name|dev
decl_stmt|;
name|struct
name|p2p_message
name|msg
decl_stmt|;
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Received GO Negotiation Confirm from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|dev
operator|=
name|p2p_get_device
argument_list|(
name|p2p
argument_list|,
name|sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
name|NULL
operator|||
name|dev
operator|->
name|wps_method
operator|==
name|WPS_NOT_READY
operator|||
name|dev
operator|!=
name|p2p
operator|->
name|go_neg_peer
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Not ready for GO negotiation with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|p2p
operator|->
name|pending_action_state
operator|==
name|P2P_PENDING_GO_NEG_RESPONSE
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Stopped waiting for TX status on GO Negotiation Response since we already received Confirmation"
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|pending_action_state
operator|=
name|P2P_NO_PENDING_ACTION
expr_stmt|;
block|}
if|if
condition|(
name|p2p_parse
argument_list|(
name|data
argument_list|,
name|len
argument_list|,
operator|&
name|msg
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|dev
operator|->
name|flags
operator|&
name|P2P_DEV_WAIT_GO_NEG_CONFIRM
operator|)
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Was not expecting GO Negotiation Confirm - ignore"
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|dev
operator|->
name|flags
operator|&=
operator|~
name|P2P_DEV_WAIT_GO_NEG_CONFIRM
expr_stmt|;
name|p2p
operator|->
name|cfg
operator|->
name|send_action_done
argument_list|(
name|p2p
operator|->
name|cfg
operator|->
name|cb_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|.
name|dialog_token
operator|!=
name|dev
operator|->
name|dialog_token
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unexpected Dialog Token %u (expected %u)"
argument_list|,
name|msg
operator|.
name|dialog_token
argument_list|,
name|dev
operator|->
name|dialog_token
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|status
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"No Status attribute received"
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|*
name|msg
operator|.
name|status
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"GO Negotiation rejected: status %d"
argument_list|,
operator|*
name|msg
operator|.
name|status
argument_list|)
expr_stmt|;
name|p2p_go_neg_failed
argument_list|(
name|p2p
argument_list|,
operator|*
name|msg
operator|.
name|status
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dev
operator|->
name|go_state
operator|==
name|REMOTE_GO
operator|&&
name|msg
operator|.
name|group_id
condition|)
block|{
comment|/* Store SSID for Provisioning step */
name|p2p
operator|->
name|ssid_len
operator|=
name|msg
operator|.
name|group_id_len
operator|-
name|ETH_ALEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|->
name|ssid
argument_list|,
name|msg
operator|.
name|group_id
operator|+
name|ETH_ALEN
argument_list|,
name|p2p
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dev
operator|->
name|go_state
operator|==
name|REMOTE_GO
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Mandatory P2P Group ID attribute missing from GO Negotiation Confirmation"
argument_list|)
expr_stmt|;
name|p2p
operator|->
name|ssid_len
operator|=
literal|0
expr_stmt|;
name|p2p_go_neg_failed
argument_list|(
name|p2p
argument_list|,
name|P2P_SC_FAIL_INVALID_PARAMS
argument_list|)
expr_stmt|;
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|operating_channel
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Mandatory Operating Channel attribute missing from GO Negotiation Confirmation"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P_STRICT
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
endif|#
directive|endif
comment|/* CONFIG_P2P_STRICT */
block|}
elseif|else
if|if
condition|(
name|dev
operator|->
name|go_state
operator|==
name|REMOTE_GO
condition|)
block|{
name|int
name|oper_freq
init|=
name|p2p_channel_to_freq
argument_list|(
name|msg
operator|.
name|operating_channel
index|[
literal|3
index|]
argument_list|,
name|msg
operator|.
name|operating_channel
index|[
literal|4
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|oper_freq
operator|!=
name|dev
operator|->
name|oper_freq
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Updated peer (GO) operating channel preference from %d MHz to %d MHz"
argument_list|,
name|dev
operator|->
name|oper_freq
argument_list|,
name|oper_freq
argument_list|)
expr_stmt|;
name|dev
operator|->
name|oper_freq
operator|=
name|oper_freq
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|msg
operator|.
name|channel_list
condition|)
block|{
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Mandatory Operating Channel attribute missing from GO Negotiation Confirmation"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P_STRICT
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
return|return;
endif|#
directive|endif
comment|/* CONFIG_P2P_STRICT */
block|}
name|p2p_parse_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|->
name|go_state
operator|==
name|UNKNOWN_GO
condition|)
block|{
comment|/* 		 * This should not happen since GO negotiation has already 		 * been completed. 		 */
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"Unexpected GO Neg state - do not know which end becomes GO"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * The peer could have missed our ctrl::ack frame for GO Negotiation 	 * Confirm and continue retransmitting the frame. To reduce the 	 * likelihood of the peer not getting successful TX status for the 	 * GO Negotiation Confirm frame, wait a short time here before starting 	 * the group so that we will remain on the current channel to 	 * acknowledge any possible retransmission from the peer. 	 */
name|p2p_dbg
argument_list|(
name|p2p
argument_list|,
literal|"20 ms wait on current channel before starting group"
argument_list|)
expr_stmt|;
name|os_sleep
argument_list|(
literal|0
argument_list|,
literal|20000
argument_list|)
expr_stmt|;
name|p2p_go_complete
argument_list|(
name|p2p
argument_list|,
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


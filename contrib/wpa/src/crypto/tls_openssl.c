begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * SSL/TLS interface functions for OpenSSL  * Copyright (c) 2004-2015, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_SMARTCARD
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
end_ifndef

begin_ifndef
ifndef|#
directive|ifndef
name|ANDROID
end_ifndef

begin_define
define|#
directive|define
name|OPENSSL_NO_ENGINE
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/pkcs12.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509v3.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
end_ifndef

begin_include
include|#
directive|include
file|<openssl/engine.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_ENGINE */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_DSA
end_ifndef

begin_include
include|#
directive|include
file|<openssl/dsa.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_DH
end_ifndef

begin_include
include|#
directive|include
file|<openssl/dh.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"sha256.h"
end_include

begin_include
include|#
directive|include
file|"tls.h"
end_include

begin_if
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|<
literal|0x10000000L
end_if

begin_comment
comment|/* ERR_remove_thread_state replaces ERR_remove_state and the latter is  * deprecated. However, OpenSSL 0.9.8 doesn't include  * ERR_remove_thread_state. */
end_comment

begin_define
define|#
directive|define
name|ERR_remove_thread_state
parameter_list|(
name|tid
parameter_list|)
value|ERR_remove_state(0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_if
if|#
directive|if
name|defined
argument_list|(
name|OPENSSL_IS_BORINGSSL
argument_list|)
end_if

begin_comment
comment|/* stack_index_t is the return type of OpenSSL's sk_XXX_num() functions. */
end_comment

begin_typedef
typedef|typedef
name|size_t
name|stack_index_t
typedef|;
end_typedef

begin_else
else|#
directive|else
end_else

begin_typedef
typedef|typedef
name|int
name|stack_index_t
typedef|;
end_typedef

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|SSL_set_tlsext_status_type
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_define
define|#
directive|define
name|HAVE_OCSP
end_define

begin_include
include|#
directive|include
file|<openssl/ocsp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_TLSEXT */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SSL_set_tlsext_status_type */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|ANDROID
end_ifdef

begin_include
include|#
directive|include
file|<openssl/pem.h>
end_include

begin_include
include|#
directive|include
file|<keystore/keystore_get.h>
end_include

begin_function
specifier|static
name|BIO
modifier|*
name|BIO_from_keystore
parameter_list|(
specifier|const
name|char
modifier|*
name|key
parameter_list|)
block|{
name|BIO
modifier|*
name|bio
init|=
name|NULL
decl_stmt|;
name|uint8_t
modifier|*
name|value
init|=
name|NULL
decl_stmt|;
name|int
name|length
init|=
name|keystore_get
argument_list|(
name|key
argument_list|,
name|strlen
argument_list|(
name|key
argument_list|)
argument_list|,
operator|&
name|value
argument_list|)
decl_stmt|;
if|if
condition|(
name|length
operator|!=
operator|-
literal|1
operator|&&
operator|(
name|bio
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|BIO_write
argument_list|(
name|bio
argument_list|,
name|value
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|value
argument_list|)
expr_stmt|;
return|return
name|bio
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ANDROID */
end_comment

begin_decl_stmt
specifier|static
name|int
name|tls_openssl_ref_count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|tls_ex_idx_session
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|tls_context
block|{
name|void
function_decl|(
modifier|*
name|event_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|tls_event
name|ev
parameter_list|,
name|union
name|tls_event_data
modifier|*
name|data
parameter_list|)
function_decl|;
name|void
modifier|*
name|cb_ctx
decl_stmt|;
name|int
name|cert_in_cb
decl_stmt|;
name|char
modifier|*
name|ocsp_stapling_response
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|tls_context
modifier|*
name|tls_global
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|tls_data
block|{
name|SSL_CTX
modifier|*
name|ssl
decl_stmt|;
name|unsigned
name|int
name|tls_session_lifetime
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|tls_connection
block|{
name|struct
name|tls_context
modifier|*
name|context
decl_stmt|;
name|SSL_CTX
modifier|*
name|ssl_ctx
decl_stmt|;
name|SSL
modifier|*
name|ssl
decl_stmt|;
name|BIO
modifier|*
name|ssl_in
decl_stmt|,
modifier|*
name|ssl_out
decl_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|ENGINE
modifier|*
name|engine
decl_stmt|;
comment|/* functional reference to the engine */
name|EVP_PKEY
modifier|*
name|private_key
decl_stmt|;
comment|/* the private key if using engine */
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
name|char
modifier|*
name|subject_match
decl_stmt|,
modifier|*
name|altsubject_match
decl_stmt|,
modifier|*
name|suffix_match
decl_stmt|,
modifier|*
name|domain_match
decl_stmt|;
name|int
name|read_alerts
decl_stmt|,
name|write_alerts
decl_stmt|,
name|failed
decl_stmt|;
name|tls_session_ticket_cb
name|session_ticket_cb
decl_stmt|;
name|void
modifier|*
name|session_ticket_cb_ctx
decl_stmt|;
comment|/* SessionTicket received from OpenSSL hello_extension_cb (server) */
name|u8
modifier|*
name|session_ticket
decl_stmt|;
name|size_t
name|session_ticket_len
decl_stmt|;
name|unsigned
name|int
name|ca_cert_verify
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|cert_probe
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|server_cert_only
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|invalid_hb_used
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|success_data
range|:
literal|1
decl_stmt|;
name|u8
name|srv_cert_hash
index|[
literal|32
index|]
decl_stmt|;
name|unsigned
name|int
name|flags
decl_stmt|;
name|X509
modifier|*
name|peer_cert
decl_stmt|;
name|X509
modifier|*
name|peer_issuer
decl_stmt|;
name|X509
modifier|*
name|peer_issuer_issuer
decl_stmt|;
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x10100000L
name|unsigned
name|char
name|client_random
index|[
name|SSL3_RANDOM_SIZE
index|]
decl_stmt|;
name|unsigned
name|char
name|server_random
index|[
name|SSL3_RANDOM_SIZE
index|]
decl_stmt|;
endif|#
directive|endif
block|}
struct|;
end_struct

begin_function
specifier|static
name|struct
name|tls_context
modifier|*
name|tls_context_new
parameter_list|(
specifier|const
name|struct
name|tls_config
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|tls_context
modifier|*
name|context
init|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|context
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|context
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|conf
condition|)
block|{
name|context
operator|->
name|event_cb
operator|=
name|conf
operator|->
name|event_cb
expr_stmt|;
name|context
operator|->
name|cb_ctx
operator|=
name|conf
operator|->
name|cb_ctx
expr_stmt|;
name|context
operator|->
name|cert_in_cb
operator|=
name|conf
operator|->
name|cert_in_cb
expr_stmt|;
block|}
return|return
name|context
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_NO_STDOUT_DEBUG
end_ifdef

begin_function
specifier|static
name|void
name|_tls_show_errors
parameter_list|(
name|void
parameter_list|)
block|{
name|unsigned
name|long
name|err
decl_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
comment|/* Just ignore the errors, since stdout is disabled */
block|}
block|}
end_function

begin_define
define|#
directive|define
name|tls_show_errors
parameter_list|(
name|l
parameter_list|,
name|f
parameter_list|,
name|t
parameter_list|)
value|_tls_show_errors()
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CONFIG_NO_STDOUT_DEBUG */
end_comment

begin_function
specifier|static
name|void
name|tls_show_errors
parameter_list|(
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|func
parameter_list|,
specifier|const
name|char
modifier|*
name|txt
parameter_list|)
block|{
name|unsigned
name|long
name|err
decl_stmt|;
name|wpa_printf
argument_list|(
name|level
argument_list|,
literal|"OpenSSL: %s - %s %s"
argument_list|,
name|func
argument_list|,
name|txt
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: pending error: %s"
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_STDOUT_DEBUG */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
end_ifdef

begin_comment
comment|/* Windows CryptoAPI and access to certificate stores */
end_comment

begin_include
include|#
directive|include
file|<wincrypt.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__MINGW32_VERSION
end_ifdef

begin_comment
comment|/*  * MinGW does not yet include all the needed definitions for CryptoAPI, so  * define here whatever extra is needed.  */
end_comment

begin_define
define|#
directive|define
name|CERT_SYSTEM_STORE_CURRENT_USER
value|(1<< 16)
end_define

begin_define
define|#
directive|define
name|CERT_STORE_READONLY_FLAG
value|0x00008000
end_define

begin_define
define|#
directive|define
name|CERT_STORE_OPEN_EXISTING_FLAG
value|0x00004000
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __MINGW32_VERSION */
end_comment

begin_struct
struct|struct
name|cryptoapi_rsa_data
block|{
specifier|const
name|CERT_CONTEXT
modifier|*
name|cert
decl_stmt|;
name|HCRYPTPROV
name|crypt_prov
decl_stmt|;
name|DWORD
name|key_spec
decl_stmt|;
name|BOOL
name|free_crypt_prov
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|cryptoapi_error
parameter_list|(
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CryptoAPI: %s; err=%u"
argument_list|,
name|msg
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cryptoapi_rsa_pub_enc
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - not implemented"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cryptoapi_rsa_pub_dec
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - not implemented"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cryptoapi_rsa_priv_enc
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|struct
name|cryptoapi_rsa_data
modifier|*
name|priv
init|=
operator|(
expr|struct
name|cryptoapi_rsa_data
operator|*
operator|)
name|rsa
operator|->
name|meth
operator|->
name|app_data
decl_stmt|;
name|HCRYPTHASH
name|hash
decl_stmt|;
name|DWORD
name|hash_size
decl_stmt|,
name|len
decl_stmt|,
name|i
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|priv
operator|==
name|NULL
condition|)
block|{
name|RSAerr
argument_list|(
name|RSA_F_RSA_EAY_PRIVATE_ENCRYPT
argument_list|,
name|ERR_R_PASSED_NULL_PARAMETER
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|padding
operator|!=
name|RSA_PKCS1_PADDING
condition|)
block|{
name|RSAerr
argument_list|(
name|RSA_F_RSA_EAY_PRIVATE_ENCRYPT
argument_list|,
name|RSA_R_UNKNOWN_PADDING_TYPE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|flen
operator|!=
literal|16
comment|/* MD5 */
operator|+
literal|20
comment|/* SHA-1 */
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s - only MD5-SHA1 hash supported"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|RSAerr
argument_list|(
name|RSA_F_RSA_EAY_PRIVATE_ENCRYPT
argument_list|,
name|RSA_R_INVALID_MESSAGE_LENGTH
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|CryptCreateHash
argument_list|(
name|priv
operator|->
name|crypt_prov
argument_list|,
name|CALG_SSL3_SHAMD5
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|hash
argument_list|)
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"CryptCreateHash failed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|len
operator|=
sizeof|sizeof
argument_list|(
name|hash_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|CryptGetHashParam
argument_list|(
name|hash
argument_list|,
name|HP_HASHSIZE
argument_list|,
operator|(
name|BYTE
operator|*
operator|)
operator|&
name|hash_size
argument_list|,
operator|&
name|len
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"CryptGetHashParam failed"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|(
name|int
operator|)
name|hash_size
operator|!=
name|flen
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CryptoAPI: Invalid hash size (%u != %d)"
argument_list|,
operator|(
name|unsigned
operator|)
name|hash_size
argument_list|,
name|flen
argument_list|)
expr_stmt|;
name|RSAerr
argument_list|(
name|RSA_F_RSA_EAY_PRIVATE_ENCRYPT
argument_list|,
name|RSA_R_INVALID_MESSAGE_LENGTH
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|CryptSetHashParam
argument_list|(
name|hash
argument_list|,
name|HP_HASHVAL
argument_list|,
operator|(
name|BYTE
operator|*
operator|)
name|from
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"CryptSetHashParam failed"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|len
operator|=
name|RSA_size
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|RSAerr
argument_list|(
name|RSA_F_RSA_EAY_PRIVATE_ENCRYPT
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|CryptSignHash
argument_list|(
name|hash
argument_list|,
name|priv
operator|->
name|key_spec
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|)
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"CryptSignHash failed"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|to
index|[
name|i
index|]
operator|=
name|buf
index|[
name|len
operator|-
name|i
operator|-
literal|1
index|]
expr_stmt|;
name|ret
operator|=
name|len
expr_stmt|;
name|err
label|:
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|CryptDestroyHash
argument_list|(
name|hash
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cryptoapi_rsa_priv_dec
parameter_list|(
name|int
name|flen
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|from
parameter_list|,
name|unsigned
name|char
modifier|*
name|to
parameter_list|,
name|RSA
modifier|*
name|rsa
parameter_list|,
name|int
name|padding
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - not implemented"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|cryptoapi_free_data
parameter_list|(
name|struct
name|cryptoapi_rsa_data
modifier|*
name|priv
parameter_list|)
block|{
if|if
condition|(
name|priv
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|priv
operator|->
name|crypt_prov
operator|&&
name|priv
operator|->
name|free_crypt_prov
condition|)
name|CryptReleaseContext
argument_list|(
name|priv
operator|->
name|crypt_prov
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|cert
condition|)
name|CertFreeCertificateContext
argument_list|(
name|priv
operator|->
name|cert
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cryptoapi_finish
parameter_list|(
name|RSA
modifier|*
name|rsa
parameter_list|)
block|{
name|cryptoapi_free_data
argument_list|(
operator|(
expr|struct
name|cryptoapi_rsa_data
operator|*
operator|)
name|rsa
operator|->
name|meth
operator|->
name|app_data
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
operator|(
name|void
operator|*
operator|)
name|rsa
operator|->
name|meth
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|meth
operator|=
name|NULL
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|CERT_CONTEXT
modifier|*
name|cryptoapi_find_cert
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|DWORD
name|store
parameter_list|)
block|{
name|HCERTSTORE
name|cs
decl_stmt|;
specifier|const
name|CERT_CONTEXT
modifier|*
name|ret
init|=
name|NULL
decl_stmt|;
name|cs
operator|=
name|CertOpenStore
argument_list|(
operator|(
name|LPCSTR
operator|)
name|CERT_STORE_PROV_SYSTEM
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|store
operator||
name|CERT_STORE_OPEN_EXISTING_FLAG
operator||
name|CERT_STORE_READONLY_FLAG
argument_list|,
literal|L"MY"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cs
operator|==
name|NULL
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"Failed to open 'My system store'"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"cert://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|unsigned
name|short
name|wbuf
index|[
literal|255
index|]
decl_stmt|;
name|MultiByteToWideChar
argument_list|(
name|CP_ACP
argument_list|,
literal|0
argument_list|,
name|name
operator|+
literal|7
argument_list|,
operator|-
literal|1
argument_list|,
name|wbuf
argument_list|,
literal|255
argument_list|)
expr_stmt|;
name|ret
operator|=
name|CertFindCertificateInStore
argument_list|(
name|cs
argument_list|,
name|X509_ASN_ENCODING
operator||
name|PKCS_7_ASN_ENCODING
argument_list|,
literal|0
argument_list|,
name|CERT_FIND_SUBJECT_STR
argument_list|,
name|wbuf
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"hash://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|CRYPT_HASH_BLOB
name|blob
decl_stmt|;
name|int
name|len
decl_stmt|;
specifier|const
name|char
modifier|*
name|hash
init|=
name|name
operator|+
literal|7
decl_stmt|;
name|unsigned
name|char
modifier|*
name|buf
decl_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|hash
argument_list|)
operator|/
literal|2
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|&&
name|hexstr2bin
argument_list|(
name|hash
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|blob
operator|.
name|cbData
operator|=
name|len
expr_stmt|;
name|blob
operator|.
name|pbData
operator|=
name|buf
expr_stmt|;
name|ret
operator|=
name|CertFindCertificateInStore
argument_list|(
name|cs
argument_list|,
name|X509_ASN_ENCODING
operator||
name|PKCS_7_ASN_ENCODING
argument_list|,
literal|0
argument_list|,
name|CERT_FIND_HASH
argument_list|,
operator|&
name|blob
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
name|CertCloseStore
argument_list|(
name|cs
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_cryptoapi_cert
parameter_list|(
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|X509
modifier|*
name|cert
init|=
name|NULL
decl_stmt|;
name|RSA
modifier|*
name|rsa
init|=
name|NULL
decl_stmt|,
modifier|*
name|pub_rsa
decl_stmt|;
name|struct
name|cryptoapi_rsa_data
modifier|*
name|priv
decl_stmt|;
name|RSA_METHOD
modifier|*
name|rsa_meth
decl_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
operator|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"cert://"
argument_list|,
literal|7
argument_list|)
operator|!=
literal|0
operator|&&
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"hash://"
argument_list|,
literal|7
argument_list|)
operator|!=
literal|0
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|priv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|priv
argument_list|)
argument_list|)
expr_stmt|;
name|rsa_meth
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rsa_meth
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|==
name|NULL
operator|||
name|rsa_meth
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"CryptoAPI: Failed to allocate memory "
literal|"for CryptoAPI RSA method"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|priv
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rsa_meth
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|priv
operator|->
name|cert
operator|=
name|cryptoapi_find_cert
argument_list|(
name|name
argument_list|,
name|CERT_SYSTEM_STORE_CURRENT_USER
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv
operator|->
name|cert
operator|==
name|NULL
condition|)
block|{
name|priv
operator|->
name|cert
operator|=
name|cryptoapi_find_cert
argument_list|(
name|name
argument_list|,
name|CERT_SYSTEM_STORE_LOCAL_MACHINE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|priv
operator|->
name|cert
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CryptoAPI: Could not find certificate "
literal|"'%s'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|cert
operator|=
name|d2i_X509
argument_list|(
name|NULL
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|*
operator|)
operator|&
name|priv
operator|->
name|cert
operator|->
name|pbCertEncoded
argument_list|,
name|priv
operator|->
name|cert
operator|->
name|cbCertEncoded
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CryptoAPI: Could not process X509 DER "
literal|"encoding"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|CryptAcquireCertificatePrivateKey
argument_list|(
name|priv
operator|->
name|cert
argument_list|,
name|CRYPT_ACQUIRE_COMPARE_KEY_FLAG
argument_list|,
name|NULL
argument_list|,
operator|&
name|priv
operator|->
name|crypt_prov
argument_list|,
operator|&
name|priv
operator|->
name|key_spec
argument_list|,
operator|&
name|priv
operator|->
name|free_crypt_prov
argument_list|)
condition|)
block|{
name|cryptoapi_error
argument_list|(
literal|"Failed to acquire a private key for the "
literal|"certificate"
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|rsa_meth
operator|->
name|name
operator|=
literal|"Microsoft CryptoAPI RSA Method"
expr_stmt|;
name|rsa_meth
operator|->
name|rsa_pub_enc
operator|=
name|cryptoapi_rsa_pub_enc
expr_stmt|;
name|rsa_meth
operator|->
name|rsa_pub_dec
operator|=
name|cryptoapi_rsa_pub_dec
expr_stmt|;
name|rsa_meth
operator|->
name|rsa_priv_enc
operator|=
name|cryptoapi_rsa_priv_enc
expr_stmt|;
name|rsa_meth
operator|->
name|rsa_priv_dec
operator|=
name|cryptoapi_rsa_priv_dec
expr_stmt|;
name|rsa_meth
operator|->
name|finish
operator|=
name|cryptoapi_finish
expr_stmt|;
name|rsa_meth
operator|->
name|flags
operator|=
name|RSA_METHOD_FLAG_NO_CHECK
expr_stmt|;
name|rsa_meth
operator|->
name|app_data
operator|=
operator|(
name|char
operator|*
operator|)
name|priv
expr_stmt|;
name|rsa
operator|=
name|RSA_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|rsa
operator|==
name|NULL
condition|)
block|{
name|SSLerr
argument_list|(
name|SSL_F_SSL_CTX_USE_CERTIFICATE_FILE
argument_list|,
name|ERR_R_MALLOC_FAILURE
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|SSL_use_certificate
argument_list|(
name|ssl
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
name|rsa
operator|=
name|NULL
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|pub_rsa
operator|=
name|cert
operator|->
name|cert_info
operator|->
name|key
operator|->
name|pkey
operator|->
name|pkey
operator|.
name|rsa
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|cert
operator|=
name|NULL
expr_stmt|;
name|rsa
operator|->
name|n
operator|=
name|BN_dup
argument_list|(
name|pub_rsa
operator|->
name|n
argument_list|)
expr_stmt|;
name|rsa
operator|->
name|e
operator|=
name|BN_dup
argument_list|(
name|pub_rsa
operator|->
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|RSA_set_method
argument_list|(
name|rsa
argument_list|,
name|rsa_meth
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|SSL_use_RSAPrivateKey
argument_list|(
name|ssl
argument_list|,
name|rsa
argument_list|)
condition|)
goto|goto
name|err
goto|;
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
if|if
condition|(
name|cert
condition|)
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsa
condition|)
name|RSA_free
argument_list|(
name|rsa
argument_list|)
expr_stmt|;
else|else
block|{
name|os_free
argument_list|(
name|rsa_meth
argument_list|)
expr_stmt|;
name|cryptoapi_free_data
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_cryptoapi_ca_cert
parameter_list|(
name|SSL_CTX
modifier|*
name|ssl_ctx
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|HCERTSTORE
name|cs
decl_stmt|;
name|PCCERT_CONTEXT
name|ctx
init|=
name|NULL
decl_stmt|;
name|X509
modifier|*
name|cert
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|store
decl_stmt|;
ifdef|#
directive|ifdef
name|UNICODE
name|WCHAR
modifier|*
name|wstore
decl_stmt|;
endif|#
directive|endif
comment|/* UNICODE */
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"cert_store://"
argument_list|,
literal|13
argument_list|)
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|store
operator|=
name|name
operator|+
literal|13
expr_stmt|;
ifdef|#
directive|ifdef
name|UNICODE
name|wstore
operator|=
name|os_malloc
argument_list|(
operator|(
name|os_strlen
argument_list|(
name|store
argument_list|)
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|WCHAR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wstore
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wsprintf
argument_list|(
name|wstore
argument_list|,
literal|L"%S"
argument_list|,
name|store
argument_list|)
expr_stmt|;
name|cs
operator|=
name|CertOpenSystemStore
argument_list|(
literal|0
argument_list|,
name|wstore
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wstore
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* UNICODE */
name|cs
operator|=
name|CertOpenSystemStore
argument_list|(
literal|0
argument_list|,
name|store
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* UNICODE */
if|if
condition|(
name|cs
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: failed to open system cert store "
literal|"'%s': error=%d"
argument_list|,
name|__func__
argument_list|,
name|store
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
operator|(
name|ctx
operator|=
name|CertEnumCertificatesInStore
argument_list|(
name|cs
argument_list|,
name|ctx
argument_list|)
operator|)
condition|)
block|{
name|cert
operator|=
name|d2i_X509
argument_list|(
name|NULL
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|*
operator|)
operator|&
name|ctx
operator|->
name|pbCertEncoded
argument_list|,
name|ctx
operator|->
name|cbCertEncoded
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CryptoAPI: Could not process "
literal|"X509 DER encoding for CA cert"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|cert
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Loaded CA certificate for "
literal|"system certificate store: subject='%s'"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509_STORE_add_cert
argument_list|(
name|ssl_ctx
operator|->
name|cert_store
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to add ca_cert to OpenSSL "
literal|"certificate store"
argument_list|)
expr_stmt|;
block|}
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|CertCloseStore
argument_list|(
name|cs
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: failed to close system cert store "
literal|"'%s': error=%d"
argument_list|,
name|__func__
argument_list|,
name|name
operator|+
literal|13
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_function
specifier|static
name|int
name|tls_cryptoapi_cert
parameter_list|(
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_function
specifier|static
name|void
name|ssl_info_cb
parameter_list|(
specifier|const
name|SSL
modifier|*
name|ssl
parameter_list|,
name|int
name|where
parameter_list|,
name|int
name|ret
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|w
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: (where=0x%x ret=0x%x)"
argument_list|,
name|where
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|w
operator|=
name|where
operator|&
operator|~
name|SSL_ST_MASK
expr_stmt|;
if|if
condition|(
name|w
operator|&
name|SSL_ST_CONNECT
condition|)
name|str
operator|=
literal|"SSL_connect"
expr_stmt|;
elseif|else
if|if
condition|(
name|w
operator|&
name|SSL_ST_ACCEPT
condition|)
name|str
operator|=
literal|"SSL_accept"
expr_stmt|;
else|else
name|str
operator|=
literal|"undefined"
expr_stmt|;
if|if
condition|(
name|where
operator|&
name|SSL_CB_LOOP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: %s:%s"
argument_list|,
name|str
argument_list|,
name|SSL_state_string_long
argument_list|(
name|ssl
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|where
operator|&
name|SSL_CB_ALERT
condition|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
name|SSL_get_app_data
argument_list|(
operator|(
name|SSL
operator|*
operator|)
name|ssl
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"SSL: SSL3 alert: %s:%s:%s"
argument_list|,
name|where
operator|&
name|SSL_CB_READ
condition|?
literal|"read (remote end reported an error)"
else|:
literal|"write (local SSL3 detected an error)"
argument_list|,
name|SSL_alert_type_string_long
argument_list|(
name|ret
argument_list|)
argument_list|,
name|SSL_alert_desc_string_long
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret
operator|>>
literal|8
operator|)
operator|==
name|SSL3_AL_FATAL
condition|)
block|{
if|if
condition|(
name|where
operator|&
name|SSL_CB_READ
condition|)
name|conn
operator|->
name|read_alerts
operator|++
expr_stmt|;
else|else
name|conn
operator|->
name|write_alerts
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|conn
operator|->
name|context
operator|->
name|event_cb
operator|!=
name|NULL
condition|)
block|{
name|union
name|tls_event_data
name|ev
decl_stmt|;
name|struct
name|tls_context
modifier|*
name|context
init|=
name|conn
operator|->
name|context
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|ev
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ev
argument_list|)
argument_list|)
expr_stmt|;
name|ev
operator|.
name|alert
operator|.
name|is_local
operator|=
operator|!
operator|(
name|where
operator|&
name|SSL_CB_READ
operator|)
expr_stmt|;
name|ev
operator|.
name|alert
operator|.
name|type
operator|=
name|SSL_alert_type_string_long
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|ev
operator|.
name|alert
operator|.
name|description
operator|=
name|SSL_alert_desc_string_long
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|context
operator|->
name|event_cb
argument_list|(
name|context
operator|->
name|cb_ctx
argument_list|,
name|TLS_ALERT
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|where
operator|&
name|SSL_CB_EXIT
operator|&&
name|ret
operator|<=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: %s:%s in %s"
argument_list|,
name|str
argument_list|,
name|ret
operator|==
literal|0
condition|?
literal|"failed"
else|:
literal|"error"
argument_list|,
name|SSL_state_string_long
argument_list|(
name|ssl
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
end_ifndef

begin_comment
comment|/**  * tls_engine_load_dynamic_generic - load any openssl engine  * @pre: an array of commands and values that load an engine initialized  *       in the engine specific function  * @post: an array of commands and values that initialize an already loaded  *        engine (or %NULL if not required)  * @id: the engine id of the engine to load (only required if post is not %NULL  *  * This function is a generic function that loads any openssl engine.  *  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
specifier|static
name|int
name|tls_engine_load_dynamic_generic
parameter_list|(
specifier|const
name|char
modifier|*
name|pre
index|[]
parameter_list|,
specifier|const
name|char
modifier|*
name|post
index|[]
parameter_list|,
specifier|const
name|char
modifier|*
name|id
parameter_list|)
block|{
name|ENGINE
modifier|*
name|engine
decl_stmt|;
specifier|const
name|char
modifier|*
name|dynamic_id
init|=
literal|"dynamic"
decl_stmt|;
name|engine
operator|=
name|ENGINE_by_id
argument_list|(
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|engine
condition|)
block|{
name|ENGINE_free
argument_list|(
name|engine
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: engine '%s' is already "
literal|"available"
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|engine
operator|=
name|ENGINE_by_id
argument_list|(
name|dynamic_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|engine
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ENGINE: Can't find engine %s [%s]"
argument_list|,
name|dynamic_id
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Perform the pre commands. This will load the engine. */
while|while
condition|(
name|pre
operator|&&
name|pre
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: '%s' '%s'"
argument_list|,
name|pre
index|[
literal|0
index|]
argument_list|,
name|pre
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ENGINE_ctrl_cmd_string
argument_list|(
name|engine
argument_list|,
name|pre
index|[
literal|0
index|]
argument_list|,
name|pre
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ENGINE: ctrl cmd_string failed: "
literal|"%s %s [%s]"
argument_list|,
name|pre
index|[
literal|0
index|]
argument_list|,
name|pre
index|[
literal|1
index|]
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|engine
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pre
operator|+=
literal|2
expr_stmt|;
block|}
comment|/* 	 * Free the reference to the "dynamic" engine. The loaded engine can 	 * now be looked up using ENGINE_by_id(). 	 */
name|ENGINE_free
argument_list|(
name|engine
argument_list|)
expr_stmt|;
name|engine
operator|=
name|ENGINE_by_id
argument_list|(
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|engine
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ENGINE: Can't find engine %s [%s]"
argument_list|,
name|id
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|post
operator|&&
name|post
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: '%s' '%s'"
argument_list|,
name|post
index|[
literal|0
index|]
argument_list|,
name|post
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ENGINE_ctrl_cmd_string
argument_list|(
name|engine
argument_list|,
name|post
index|[
literal|0
index|]
argument_list|,
name|post
index|[
literal|1
index|]
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: ctrl cmd_string failed:"
literal|" %s %s [%s]"
argument_list|,
name|post
index|[
literal|0
index|]
argument_list|,
name|post
index|[
literal|1
index|]
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|ENGINE_remove
argument_list|(
name|engine
argument_list|)
expr_stmt|;
name|ENGINE_free
argument_list|(
name|engine
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|post
operator|+=
literal|2
expr_stmt|;
block|}
name|ENGINE_free
argument_list|(
name|engine
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * tls_engine_load_dynamic_pkcs11 - load the pkcs11 engine provided by opensc  * @pkcs11_so_path: pksc11_so_path from the configuration  * @pcks11_module_path: pkcs11_module_path from the configuration  */
end_comment

begin_function
specifier|static
name|int
name|tls_engine_load_dynamic_pkcs11
parameter_list|(
specifier|const
name|char
modifier|*
name|pkcs11_so_path
parameter_list|,
specifier|const
name|char
modifier|*
name|pkcs11_module_path
parameter_list|)
block|{
name|char
modifier|*
name|engine_id
init|=
literal|"pkcs11"
decl_stmt|;
specifier|const
name|char
modifier|*
name|pre_cmd
index|[]
init|=
block|{
literal|"SO_PATH"
block|,
name|NULL
comment|/* pkcs11_so_path */
block|,
literal|"ID"
block|,
name|NULL
comment|/* engine_id */
block|,
literal|"LIST_ADD"
block|,
literal|"1"
block|,
comment|/* "NO_VCHECK", "1", */
literal|"LOAD"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
specifier|const
name|char
modifier|*
name|post_cmd
index|[]
init|=
block|{
literal|"MODULE_PATH"
block|,
name|NULL
comment|/* pkcs11_module_path */
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|pkcs11_so_path
condition|)
return|return
literal|0
return|;
name|pre_cmd
index|[
literal|1
index|]
operator|=
name|pkcs11_so_path
expr_stmt|;
name|pre_cmd
index|[
literal|3
index|]
operator|=
name|engine_id
expr_stmt|;
if|if
condition|(
name|pkcs11_module_path
condition|)
name|post_cmd
index|[
literal|1
index|]
operator|=
name|pkcs11_module_path
expr_stmt|;
else|else
name|post_cmd
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: Loading pkcs11 Engine from %s"
argument_list|,
name|pkcs11_so_path
argument_list|)
expr_stmt|;
return|return
name|tls_engine_load_dynamic_generic
argument_list|(
name|pre_cmd
argument_list|,
name|post_cmd
argument_list|,
name|engine_id
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * tls_engine_load_dynamic_opensc - load the opensc engine provided by opensc  * @opensc_so_path: opensc_so_path from the configuration  */
end_comment

begin_function
specifier|static
name|int
name|tls_engine_load_dynamic_opensc
parameter_list|(
specifier|const
name|char
modifier|*
name|opensc_so_path
parameter_list|)
block|{
name|char
modifier|*
name|engine_id
init|=
literal|"opensc"
decl_stmt|;
specifier|const
name|char
modifier|*
name|pre_cmd
index|[]
init|=
block|{
literal|"SO_PATH"
block|,
name|NULL
comment|/* opensc_so_path */
block|,
literal|"ID"
block|,
name|NULL
comment|/* engine_id */
block|,
literal|"LIST_ADD"
block|,
literal|"1"
block|,
literal|"LOAD"
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|opensc_so_path
condition|)
return|return
literal|0
return|;
name|pre_cmd
index|[
literal|1
index|]
operator|=
name|opensc_so_path
expr_stmt|;
name|pre_cmd
index|[
literal|3
index|]
operator|=
name|engine_id
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: Loading OpenSC Engine from %s"
argument_list|,
name|opensc_so_path
argument_list|)
expr_stmt|;
return|return
name|tls_engine_load_dynamic_generic
argument_list|(
name|pre_cmd
argument_list|,
name|NULL
argument_list|,
name|engine_id
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_ENGINE */
end_comment

begin_function
specifier|static
name|void
name|remove_session_cb
parameter_list|(
name|SSL_CTX
modifier|*
name|ctx
parameter_list|,
name|SSL_SESSION
modifier|*
name|sess
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
if|if
condition|(
name|tls_ex_idx_session
operator|<
literal|0
condition|)
return|return;
name|buf
operator|=
name|SSL_SESSION_get_ex_data
argument_list|(
name|sess
argument_list|,
name|tls_ex_idx_session
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Free application session data %p (sess %p)"
argument_list|,
name|buf
argument_list|,
name|sess
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|SSL_SESSION_set_ex_data
argument_list|(
name|sess
argument_list|,
name|tls_ex_idx_session
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
modifier|*
name|tls_init
parameter_list|(
specifier|const
name|struct
name|tls_config
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|tls_data
modifier|*
name|data
decl_stmt|;
name|SSL_CTX
modifier|*
name|ssl
decl_stmt|;
name|struct
name|tls_context
modifier|*
name|context
decl_stmt|;
specifier|const
name|char
modifier|*
name|ciphers
decl_stmt|;
if|if
condition|(
name|tls_openssl_ref_count
operator|==
literal|0
condition|)
block|{
name|tls_global
operator|=
name|context
operator|=
name|tls_context_new
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
ifdef|#
directive|ifdef
name|CONFIG_FIPS
ifdef|#
directive|ifdef
name|OPENSSL_FIPS
if|if
condition|(
name|conf
operator|&&
name|conf
operator|->
name|fips_mode
condition|)
block|{
specifier|static
name|int
name|fips_enabled
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|fips_enabled
operator|&&
operator|!
name|FIPS_mode_set
argument_list|(
literal|1
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to enable FIPS "
literal|"mode"
argument_list|)
expr_stmt|;
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tls_global
argument_list|)
expr_stmt|;
name|tls_global
operator|=
name|NULL
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Running in FIPS mode"
argument_list|)
expr_stmt|;
name|fips_enabled
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|#
directive|else
comment|/* OPENSSL_FIPS */
if|if
condition|(
name|conf
operator|&&
name|conf
operator|->
name|fips_mode
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"FIPS mode requested, but not "
literal|"supported"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tls_global
argument_list|)
expr_stmt|;
name|tls_global
operator|=
name|NULL
expr_stmt|;
return|return
name|NULL
return|;
block|}
endif|#
directive|endif
comment|/* OPENSSL_FIPS */
endif|#
directive|endif
comment|/* CONFIG_FIPS */
name|SSL_load_error_strings
argument_list|()
expr_stmt|;
name|SSL_library_init
argument_list|()
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_SHA256
name|EVP_add_digest
argument_list|(
name|EVP_sha256
argument_list|()
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_NO_SHA256 */
comment|/* TODO: if /dev/urandom is available, PRNG is seeded 		 * automatically. If this is not the case, random data should 		 * be added here. */
ifdef|#
directive|ifdef
name|PKCS12_FUNCS
ifndef|#
directive|ifndef
name|OPENSSL_NO_RC2
comment|/* 		 * 40-bit RC2 is commonly used in PKCS#12 files, so enable it. 		 * This is enabled by PKCS12_PBE_add() in OpenSSL 0.9.8 		 * versions, but it looks like OpenSSL 1.0.0 does not do that 		 * anymore. 		 */
name|EVP_add_cipher
argument_list|(
name|EVP_rc2_40_cbc
argument_list|()
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_NO_RC2 */
name|PKCS12_PBE_add
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* PKCS12_FUNCS */
block|}
else|else
block|{
name|context
operator|=
name|tls_context_new
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|context
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
block|}
name|tls_openssl_ref_count
operator|++
expr_stmt|;
name|data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
name|ssl
operator|=
name|SSL_CTX_new
argument_list|(
name|SSLv23_method
argument_list|()
argument_list|)
expr_stmt|;
else|else
name|ssl
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ssl
operator|==
name|NULL
condition|)
block|{
name|tls_openssl_ref_count
operator|--
expr_stmt|;
if|if
condition|(
name|context
operator|!=
name|tls_global
condition|)
name|os_free
argument_list|(
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_openssl_ref_count
operator|==
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|tls_global
argument_list|)
expr_stmt|;
name|tls_global
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|ssl
operator|=
name|ssl
expr_stmt|;
if|if
condition|(
name|conf
condition|)
name|data
operator|->
name|tls_session_lifetime
operator|=
name|conf
operator|->
name|tls_session_lifetime
expr_stmt|;
name|SSL_CTX_set_options
argument_list|(
name|ssl
argument_list|,
name|SSL_OP_NO_SSLv2
argument_list|)
expr_stmt|;
name|SSL_CTX_set_options
argument_list|(
name|ssl
argument_list|,
name|SSL_OP_NO_SSLv3
argument_list|)
expr_stmt|;
name|SSL_CTX_set_info_callback
argument_list|(
name|ssl
argument_list|,
name|ssl_info_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_app_data
argument_list|(
name|ssl
argument_list|,
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|tls_session_lifetime
operator|>
literal|0
condition|)
block|{
name|SSL_CTX_set_quiet_shutdown
argument_list|(
name|ssl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* 		 * Set default context here. In practice, this will be replaced 		 * by the per-EAP method context in tls_connection_set_verify(). 		 */
name|SSL_CTX_set_session_id_context
argument_list|(
name|ssl
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"hostapd"
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|SSL_CTX_set_session_cache_mode
argument_list|(
name|ssl
argument_list|,
name|SSL_SESS_CACHE_SERVER
argument_list|)
expr_stmt|;
name|SSL_CTX_set_timeout
argument_list|(
name|ssl
argument_list|,
name|data
operator|->
name|tls_session_lifetime
argument_list|)
expr_stmt|;
name|SSL_CTX_sess_set_remove_cb
argument_list|(
name|ssl
argument_list|,
name|remove_session_cb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SSL_CTX_set_session_cache_mode
argument_list|(
name|ssl
argument_list|,
name|SSL_SESS_CACHE_OFF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tls_ex_idx_session
operator|<
literal|0
condition|)
block|{
name|tls_ex_idx_session
operator|=
name|SSL_SESSION_get_ex_new_index
argument_list|(
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_ex_idx_session
operator|<
literal|0
condition|)
block|{
name|tls_deinit
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: Loading dynamic engine"
argument_list|)
expr_stmt|;
name|ERR_load_ENGINE_strings
argument_list|()
expr_stmt|;
name|ENGINE_load_dynamic
argument_list|()
expr_stmt|;
if|if
condition|(
name|conf
operator|&&
operator|(
name|conf
operator|->
name|opensc_engine_path
operator|||
name|conf
operator|->
name|pkcs11_engine_path
operator|||
name|conf
operator|->
name|pkcs11_module_path
operator|)
condition|)
block|{
if|if
condition|(
name|tls_engine_load_dynamic_opensc
argument_list|(
name|conf
operator|->
name|opensc_engine_path
argument_list|)
operator|||
name|tls_engine_load_dynamic_pkcs11
argument_list|(
name|conf
operator|->
name|pkcs11_engine_path
argument_list|,
name|conf
operator|->
name|pkcs11_module_path
argument_list|)
condition|)
block|{
name|tls_deinit
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
if|if
condition|(
name|conf
operator|&&
name|conf
operator|->
name|openssl_ciphers
condition|)
name|ciphers
operator|=
name|conf
operator|->
name|openssl_ciphers
expr_stmt|;
else|else
name|ciphers
operator|=
literal|"DEFAULT:!EXP:!LOW"
expr_stmt|;
if|if
condition|(
name|SSL_CTX_set_cipher_list
argument_list|(
name|ssl
argument_list|,
name|ciphers
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"OpenSSL: Failed to set cipher string '%s'"
argument_list|,
name|ciphers
argument_list|)
expr_stmt|;
name|tls_deinit
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|data
return|;
block|}
end_function

begin_function
name|void
name|tls_deinit
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|)
block|{
name|struct
name|tls_data
modifier|*
name|data
init|=
name|ssl_ctx
decl_stmt|;
name|SSL_CTX
modifier|*
name|ssl
init|=
name|data
operator|->
name|ssl
decl_stmt|;
name|struct
name|tls_context
modifier|*
name|context
init|=
name|SSL_CTX_get_app_data
argument_list|(
name|ssl
argument_list|)
decl_stmt|;
if|if
condition|(
name|context
operator|!=
name|tls_global
condition|)
name|os_free
argument_list|(
name|context
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|tls_session_lifetime
operator|>
literal|0
condition|)
name|SSL_CTX_flush_sessions
argument_list|(
name|ssl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|SSL_CTX_free
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
name|tls_openssl_ref_count
operator|--
expr_stmt|;
if|if
condition|(
name|tls_openssl_ref_count
operator|==
literal|0
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|ENGINE_cleanup
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
name|CRYPTO_cleanup_all_ex_data
argument_list|()
expr_stmt|;
name|ERR_remove_thread_state
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|ERR_free_strings
argument_list|()
expr_stmt|;
name|EVP_cleanup
argument_list|()
expr_stmt|;
name|os_free
argument_list|(
name|tls_global
operator|->
name|ocsp_stapling_response
argument_list|)
expr_stmt|;
name|tls_global
operator|->
name|ocsp_stapling_response
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|tls_global
argument_list|)
expr_stmt|;
name|tls_global
operator|=
name|NULL
expr_stmt|;
block|}
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
end_ifndef

begin_comment
comment|/* Cryptoki return values */
end_comment

begin_define
define|#
directive|define
name|CKR_PIN_INCORRECT
value|0x000000a0
end_define

begin_define
define|#
directive|define
name|CKR_PIN_INVALID
value|0x000000a1
end_define

begin_define
define|#
directive|define
name|CKR_PIN_LEN_RANGE
value|0x000000a2
end_define

begin_comment
comment|/* libp11 */
end_comment

begin_define
define|#
directive|define
name|ERR_LIB_PKCS11
value|ERR_LIB_USER
end_define

begin_function
specifier|static
name|int
name|tls_is_pin_error
parameter_list|(
name|unsigned
name|int
name|err
parameter_list|)
block|{
return|return
name|ERR_GET_LIB
argument_list|(
name|err
argument_list|)
operator|==
name|ERR_LIB_PKCS11
operator|&&
operator|(
name|ERR_GET_REASON
argument_list|(
name|err
argument_list|)
operator|==
name|CKR_PIN_INCORRECT
operator|||
name|ERR_GET_REASON
argument_list|(
name|err
argument_list|)
operator|==
name|CKR_PIN_INVALID
operator|||
name|ERR_GET_REASON
argument_list|(
name|err
argument_list|)
operator|==
name|CKR_PIN_LEN_RANGE
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_ENGINE */
end_comment

begin_function
specifier|static
name|int
name|tls_engine_init
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|engine_id
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
specifier|const
name|char
modifier|*
name|key_id
parameter_list|,
specifier|const
name|char
modifier|*
name|cert_id
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_cert_id
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|engine_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: Engine ID not set"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ERR_clear_error
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|ANDROID
name|ENGINE_load_dynamic
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|conn
operator|->
name|engine
operator|=
name|ENGINE_by_id
argument_list|(
name|engine_id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conn
operator|->
name|engine
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: engine %s not available [%s]"
argument_list|,
name|engine_id
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|ENGINE_init
argument_list|(
name|conn
operator|->
name|engine
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: engine init failed "
literal|"(engine: %s) [%s]"
argument_list|,
name|engine_id
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: engine initialized"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|ANDROID
if|if
condition|(
name|pin
operator|&&
name|ENGINE_ctrl_cmd_string
argument_list|(
name|conn
operator|->
name|engine
argument_list|,
literal|"PIN"
argument_list|,
name|pin
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: cannot set pin [%s]"
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
endif|#
directive|endif
if|if
condition|(
name|key_id
condition|)
block|{
comment|/* 		 * Ensure that the ENGINE does not attempt to use the OpenSSL 		 * UI system to obtain a PIN, if we didn't provide one. 		 */
struct|struct
block|{
specifier|const
name|void
modifier|*
name|password
decl_stmt|;
specifier|const
name|char
modifier|*
name|prompt_info
decl_stmt|;
block|}
name|key_cb
init|=
block|{
literal|""
block|,
name|NULL
block|}
struct|;
comment|/* load private key first in-case PIN is required for cert */
name|conn
operator|->
name|private_key
operator|=
name|ENGINE_load_private_key
argument_list|(
name|conn
operator|->
name|engine
argument_list|,
name|key_id
argument_list|,
name|NULL
argument_list|,
operator|&
name|key_cb
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conn
operator|->
name|private_key
condition|)
block|{
name|unsigned
name|long
name|err
init|=
name|ERR_get_error
argument_list|()
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: cannot load private key with id '%s' [%s]"
argument_list|,
name|key_id
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_is_pin_error
argument_list|(
name|err
argument_list|)
condition|)
name|ret
operator|=
name|TLS_SET_PARAMS_ENGINE_PRV_BAD_PIN
expr_stmt|;
else|else
name|ret
operator|=
name|TLS_SET_PARAMS_ENGINE_PRV_INIT_FAILED
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
comment|/* handle a certificate and/or CA certificate */
if|if
condition|(
name|cert_id
operator|||
name|ca_cert_id
condition|)
block|{
specifier|const
name|char
modifier|*
name|cmd_name
init|=
literal|"LOAD_CERT_CTRL"
decl_stmt|;
comment|/* test if the engine supports a LOAD_CERT_CTRL */
if|if
condition|(
operator|!
name|ENGINE_ctrl
argument_list|(
name|conn
operator|->
name|engine
argument_list|,
name|ENGINE_CTRL_GET_CMD_FROM_NAME
argument_list|,
literal|0
argument_list|,
operator|(
name|void
operator|*
operator|)
name|cmd_name
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: engine does not support"
literal|" loading certificates"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|TLS_SET_PARAMS_ENGINE_PRV_INIT_FAILED
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
return|return
literal|0
return|;
name|err
label|:
if|if
condition|(
name|conn
operator|->
name|engine
condition|)
block|{
name|ENGINE_free
argument_list|(
name|conn
operator|->
name|engine
argument_list|)
expr_stmt|;
name|conn
operator|->
name|engine
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|conn
operator|->
name|private_key
condition|)
block|{
name|EVP_PKEY_free
argument_list|(
name|conn
operator|->
name|private_key
argument_list|)
expr_stmt|;
name|conn
operator|->
name|private_key
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|ret
return|;
else|#
directive|else
comment|/* OPENSSL_NO_ENGINE */
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
block|}
end_function

begin_function
specifier|static
name|void
name|tls_engine_deinit
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: engine deinit"
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|private_key
condition|)
block|{
name|EVP_PKEY_free
argument_list|(
name|conn
operator|->
name|private_key
argument_list|)
expr_stmt|;
name|conn
operator|->
name|private_key
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|conn
operator|->
name|engine
condition|)
block|{
name|ENGINE_finish
argument_list|(
name|conn
operator|->
name|engine
argument_list|)
expr_stmt|;
name|conn
operator|->
name|engine
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
block|}
end_function

begin_function
name|int
name|tls_get_errors
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|err
decl_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS - SSL error: %s"
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tls_msg_cb
parameter_list|(
name|int
name|write_p
parameter_list|,
name|int
name|version
parameter_list|,
name|int
name|content_type
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
name|arg
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
init|=
name|buf
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s ver=0x%x content_type=%d"
argument_list|,
name|write_p
condition|?
literal|"TX"
else|:
literal|"RX"
argument_list|,
name|version
argument_list|,
name|content_type
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"OpenSSL: Message"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|content_type
operator|==
literal|24
operator|&&
name|len
operator|>=
literal|3
operator|&&
name|pos
index|[
literal|0
index|]
operator|==
literal|1
condition|)
block|{
name|size_t
name|payload_len
init|=
name|WPA_GET_BE16
argument_list|(
name|pos
operator|+
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|payload_len
operator|+
literal|3
operator|>
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"OpenSSL: Heartbeat attack detected"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|invalid_hb_used
operator|=
literal|1
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|struct
name|tls_connection
modifier|*
name|tls_connection_init
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|)
block|{
name|struct
name|tls_data
modifier|*
name|data
init|=
name|ssl_ctx
decl_stmt|;
name|SSL_CTX
modifier|*
name|ssl
init|=
name|data
operator|->
name|ssl
decl_stmt|;
name|struct
name|tls_connection
modifier|*
name|conn
decl_stmt|;
name|long
name|options
decl_stmt|;
name|struct
name|tls_context
modifier|*
name|context
init|=
name|SSL_CTX_get_app_data
argument_list|(
name|ssl
argument_list|)
decl_stmt|;
name|conn
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|conn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|conn
operator|->
name|ssl_ctx
operator|=
name|ssl
expr_stmt|;
name|conn
operator|->
name|ssl
operator|=
name|SSL_new
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|ssl
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to initialize new SSL connection"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|conn
operator|->
name|context
operator|=
name|context
expr_stmt|;
name|SSL_set_app_data
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|SSL_set_msg_callback
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|tls_msg_cb
argument_list|)
expr_stmt|;
name|SSL_set_msg_callback_arg
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|conn
argument_list|)
expr_stmt|;
name|options
operator|=
name|SSL_OP_NO_SSLv2
operator||
name|SSL_OP_NO_SSLv3
operator||
name|SSL_OP_SINGLE_DH_USE
expr_stmt|;
ifdef|#
directive|ifdef
name|SSL_OP_NO_COMPRESSION
name|options
operator||=
name|SSL_OP_NO_COMPRESSION
expr_stmt|;
endif|#
directive|endif
comment|/* SSL_OP_NO_COMPRESSION */
name|SSL_set_options
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|options
argument_list|)
expr_stmt|;
name|conn
operator|->
name|ssl_in
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conn
operator|->
name|ssl_in
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to create a new BIO for ssl_in"
argument_list|)
expr_stmt|;
name|SSL_free
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|conn
operator|->
name|ssl_out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conn
operator|->
name|ssl_out
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to create a new BIO for ssl_out"
argument_list|)
expr_stmt|;
name|SSL_free
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|conn
operator|->
name|ssl_in
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|SSL_set_bio
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|conn
operator|->
name|ssl_in
argument_list|,
name|conn
operator|->
name|ssl_out
argument_list|)
expr_stmt|;
return|return
name|conn
return|;
block|}
end_function

begin_function
name|void
name|tls_connection_deinit
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|conn
operator|->
name|success_data
condition|)
block|{
comment|/* 		 * Make sure ssl_clear_bad_session() does not remove this 		 * session. 		 */
name|SSL_set_quiet_shutdown
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SSL_shutdown
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
block|}
name|SSL_free
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|tls_engine_deinit
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|subject_match
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|altsubject_match
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|suffix_match
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|domain_match
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|session_ticket
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|tls_connection_established
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
name|conn
condition|?
name|SSL_is_init_finished
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
else|:
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_shutdown
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Shutdown previous TLS connection without notifying the peer 	 * because the connection was already terminated in practice 	 * and "close notify" shutdown alert would confuse AS. */
name|SSL_set_quiet_shutdown
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|SSL_shutdown
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
return|return
name|SSL_clear
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
operator|==
literal|1
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_match_altsubject_component
parameter_list|(
name|X509
modifier|*
name|cert
parameter_list|,
name|int
name|type
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|GENERAL_NAME
modifier|*
name|gen
decl_stmt|;
name|void
modifier|*
name|ext
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
name|stack_index_t
name|i
decl_stmt|;
name|ext
operator|=
name|X509_get_ext_d2i
argument_list|(
name|cert
argument_list|,
name|NID_subject_alt_name
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ext
operator|&&
name|i
operator|<
name|sk_GENERAL_NAME_num
argument_list|(
name|ext
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|gen
operator|=
name|sk_GENERAL_NAME_value
argument_list|(
name|ext
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen
operator|->
name|type
operator|!=
name|type
condition|)
continue|continue;
if|if
condition|(
name|os_strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|gen
operator|->
name|d
operator|.
name|ia5
operator|->
name|data
argument_list|)
operator|==
name|len
operator|&&
name|os_memcmp
argument_list|(
name|value
argument_list|,
name|gen
operator|->
name|d
operator|.
name|ia5
operator|->
name|data
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
name|found
operator|++
expr_stmt|;
block|}
return|return
name|found
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_match_altsubject
parameter_list|(
name|X509
modifier|*
name|cert
parameter_list|,
specifier|const
name|char
modifier|*
name|match
parameter_list|)
block|{
name|int
name|type
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|pos
operator|=
name|match
expr_stmt|;
do|do
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"EMAIL:"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|type
operator|=
name|GEN_EMAIL
expr_stmt|;
name|pos
operator|+=
literal|6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"DNS:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|type
operator|=
name|GEN_DNS
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"URI:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|type
operator|=
name|GEN_URI
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Invalid altSubjectName "
literal|"match '%s'"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|end
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|';'
argument_list|)
expr_stmt|;
while|while
condition|(
name|end
condition|)
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|end
operator|+
literal|1
argument_list|,
literal|"EMAIL:"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|||
name|os_strncmp
argument_list|(
name|end
operator|+
literal|1
argument_list|,
literal|"DNS:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|||
name|os_strncmp
argument_list|(
name|end
operator|+
literal|1
argument_list|,
literal|"URI:"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|end
operator|=
name|os_strchr
argument_list|(
name|end
operator|+
literal|1
argument_list|,
literal|';'
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|end
condition|)
name|len
operator|=
name|end
operator|-
name|pos
expr_stmt|;
else|else
name|len
operator|=
name|os_strlen
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_match_altsubject_component
argument_list|(
name|cert
argument_list|,
name|type
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
operator|>
literal|0
condition|)
return|return
literal|1
return|;
name|pos
operator|=
name|end
operator|+
literal|1
expr_stmt|;
block|}
do|while
condition|(
name|end
condition|)
do|;
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
end_ifndef

begin_function
specifier|static
name|int
name|domain_suffix_match
parameter_list|(
specifier|const
name|u8
modifier|*
name|val
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|char
modifier|*
name|match
parameter_list|,
name|int
name|full
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|match_len
decl_stmt|;
comment|/* Check for embedded nuls that could mess up suffix matching */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|val
index|[
name|i
index|]
operator|==
literal|'\0'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Embedded null in a string - reject"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|match_len
operator|=
name|os_strlen
argument_list|(
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|match_len
operator|>
name|len
operator|||
operator|(
name|full
operator|&&
name|match_len
operator|!=
name|len
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|val
operator|+
name|len
operator|-
name|match_len
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* no match */
if|if
condition|(
name|match_len
operator|==
name|len
condition|)
return|return
literal|1
return|;
comment|/* exact match */
if|if
condition|(
name|val
index|[
name|len
operator|-
name|match_len
operator|-
literal|1
index|]
operator|==
literal|'.'
condition|)
return|return
literal|1
return|;
comment|/* full label match completes suffix match */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Reject due to incomplete label match"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_function
specifier|static
name|int
name|tls_match_suffix
parameter_list|(
name|X509
modifier|*
name|cert
parameter_list|,
specifier|const
name|char
modifier|*
name|match
parameter_list|,
name|int
name|full
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
comment|/* wincrypt.h has conflicting X509_NAME definition */
return|return
operator|-
literal|1
return|;
else|#
directive|else
comment|/* CONFIG_NATIVE_WINDOWS */
name|GENERAL_NAME
modifier|*
name|gen
decl_stmt|;
name|void
modifier|*
name|ext
decl_stmt|;
name|int
name|i
decl_stmt|;
name|stack_index_t
name|j
decl_stmt|;
name|int
name|dns_name
init|=
literal|0
decl_stmt|;
name|X509_NAME
modifier|*
name|name
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Match domain against %s%s"
argument_list|,
name|full
condition|?
literal|""
else|:
literal|"suffix "
argument_list|,
name|match
argument_list|)
expr_stmt|;
name|ext
operator|=
name|X509_get_ext_d2i
argument_list|(
name|cert
argument_list|,
name|NID_subject_alt_name
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|ext
operator|&&
name|j
operator|<
name|sk_GENERAL_NAME_num
argument_list|(
name|ext
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|gen
operator|=
name|sk_GENERAL_NAME_value
argument_list|(
name|ext
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen
operator|->
name|type
operator|!=
name|GEN_DNS
condition|)
continue|continue;
name|dns_name
operator|++
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Certificate dNSName"
argument_list|,
name|gen
operator|->
name|d
operator|.
name|dNSName
operator|->
name|data
argument_list|,
name|gen
operator|->
name|d
operator|.
name|dNSName
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|domain_suffix_match
argument_list|(
name|gen
operator|->
name|d
operator|.
name|dNSName
operator|->
name|data
argument_list|,
name|gen
operator|->
name|d
operator|.
name|dNSName
operator|->
name|length
argument_list|,
name|match
argument_list|,
name|full
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: %s in dNSName found"
argument_list|,
name|full
condition|?
literal|"Match"
else|:
literal|"Suffix match"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
if|if
condition|(
name|dns_name
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: None of the dNSName(s) matched"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|name
operator|=
name|X509_get_subject_name
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|i
operator|=
operator|-
literal|1
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|X509_NAME_ENTRY
modifier|*
name|e
decl_stmt|;
name|ASN1_STRING
modifier|*
name|cn
decl_stmt|;
name|i
operator|=
name|X509_NAME_get_index_by_NID
argument_list|(
name|name
argument_list|,
name|NID_commonName
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
operator|-
literal|1
condition|)
break|break;
name|e
operator|=
name|X509_NAME_get_entry
argument_list|(
name|name
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
operator|==
name|NULL
condition|)
continue|continue;
name|cn
operator|=
name|X509_NAME_ENTRY_get_data
argument_list|(
name|e
argument_list|)
expr_stmt|;
if|if
condition|(
name|cn
operator|==
name|NULL
condition|)
continue|continue;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Certificate commonName"
argument_list|,
name|cn
operator|->
name|data
argument_list|,
name|cn
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|domain_suffix_match
argument_list|(
name|cn
operator|->
name|data
argument_list|,
name|cn
operator|->
name|length
argument_list|,
name|match
argument_list|,
name|full
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: %s in commonName found"
argument_list|,
name|full
condition|?
literal|"Match"
else|:
literal|"Suffix match"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: No CommonName %smatch found"
argument_list|,
name|full
condition|?
literal|""
else|:
literal|"suffix "
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
block|}
end_function

begin_function
specifier|static
name|enum
name|tls_fail_reason
name|openssl_tls_fail_reason
parameter_list|(
name|int
name|err
parameter_list|)
block|{
switch|switch
condition|(
name|err
condition|)
block|{
case|case
name|X509_V_ERR_CERT_REVOKED
case|:
return|return
name|TLS_FAIL_REVOKED
return|;
case|case
name|X509_V_ERR_CERT_NOT_YET_VALID
case|:
case|case
name|X509_V_ERR_CRL_NOT_YET_VALID
case|:
return|return
name|TLS_FAIL_NOT_YET_VALID
return|;
case|case
name|X509_V_ERR_CERT_HAS_EXPIRED
case|:
case|case
name|X509_V_ERR_CRL_HAS_EXPIRED
case|:
return|return
name|TLS_FAIL_EXPIRED
return|;
case|case
name|X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT
case|:
case|case
name|X509_V_ERR_UNABLE_TO_GET_CRL
case|:
case|case
name|X509_V_ERR_UNABLE_TO_GET_CRL_ISSUER
case|:
case|case
name|X509_V_ERR_SELF_SIGNED_CERT_IN_CHAIN
case|:
case|case
name|X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY
case|:
case|case
name|X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT
case|:
case|case
name|X509_V_ERR_UNABLE_TO_VERIFY_LEAF_SIGNATURE
case|:
case|case
name|X509_V_ERR_CERT_CHAIN_TOO_LONG
case|:
case|case
name|X509_V_ERR_PATH_LENGTH_EXCEEDED
case|:
case|case
name|X509_V_ERR_INVALID_CA
case|:
return|return
name|TLS_FAIL_UNTRUSTED
return|;
case|case
name|X509_V_ERR_UNABLE_TO_DECRYPT_CERT_SIGNATURE
case|:
case|case
name|X509_V_ERR_UNABLE_TO_DECRYPT_CRL_SIGNATURE
case|:
case|case
name|X509_V_ERR_UNABLE_TO_DECODE_ISSUER_PUBLIC_KEY
case|:
case|case
name|X509_V_ERR_ERROR_IN_CERT_NOT_BEFORE_FIELD
case|:
case|case
name|X509_V_ERR_ERROR_IN_CERT_NOT_AFTER_FIELD
case|:
case|case
name|X509_V_ERR_ERROR_IN_CRL_LAST_UPDATE_FIELD
case|:
case|case
name|X509_V_ERR_ERROR_IN_CRL_NEXT_UPDATE_FIELD
case|:
case|case
name|X509_V_ERR_CERT_UNTRUSTED
case|:
case|case
name|X509_V_ERR_CERT_REJECTED
case|:
return|return
name|TLS_FAIL_BAD_CERTIFICATE
return|;
default|default:
return|return
name|TLS_FAIL_UNSPECIFIED
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|get_x509_cert
parameter_list|(
name|X509
modifier|*
name|cert
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|tmp
decl_stmt|;
name|int
name|cert_len
init|=
name|i2d_X509
argument_list|(
name|cert
argument_list|,
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
name|cert_len
operator|<=
literal|0
condition|)
return|return
name|NULL
return|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|cert_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|tmp
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|cert_len
argument_list|)
expr_stmt|;
name|i2d_X509
argument_list|(
name|cert
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|openssl_tls_fail_event
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|X509
modifier|*
name|err_cert
parameter_list|,
name|int
name|err
parameter_list|,
name|int
name|depth
parameter_list|,
specifier|const
name|char
modifier|*
name|subject
parameter_list|,
specifier|const
name|char
modifier|*
name|err_str
parameter_list|,
name|enum
name|tls_fail_reason
name|reason
parameter_list|)
block|{
name|union
name|tls_event_data
name|ev
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|cert
init|=
name|NULL
decl_stmt|;
name|struct
name|tls_context
modifier|*
name|context
init|=
name|conn
operator|->
name|context
decl_stmt|;
if|if
condition|(
name|context
operator|->
name|event_cb
operator|==
name|NULL
condition|)
return|return;
name|cert
operator|=
name|get_x509_cert
argument_list|(
name|err_cert
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|ev
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ev
argument_list|)
argument_list|)
expr_stmt|;
name|ev
operator|.
name|cert_fail
operator|.
name|reason
operator|=
name|reason
operator|!=
name|TLS_FAIL_UNSPECIFIED
condition|?
name|reason
else|:
name|openssl_tls_fail_reason
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|ev
operator|.
name|cert_fail
operator|.
name|depth
operator|=
name|depth
expr_stmt|;
name|ev
operator|.
name|cert_fail
operator|.
name|subject
operator|=
name|subject
expr_stmt|;
name|ev
operator|.
name|cert_fail
operator|.
name|reason_txt
operator|=
name|err_str
expr_stmt|;
name|ev
operator|.
name|cert_fail
operator|.
name|cert
operator|=
name|cert
expr_stmt|;
name|context
operator|->
name|event_cb
argument_list|(
name|context
operator|->
name|cb_ctx
argument_list|,
name|TLS_CERT_CHAIN_FAILURE
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|openssl_tls_cert_event
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|X509
modifier|*
name|err_cert
parameter_list|,
name|int
name|depth
parameter_list|,
specifier|const
name|char
modifier|*
name|subject
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|cert
init|=
name|NULL
decl_stmt|;
name|union
name|tls_event_data
name|ev
decl_stmt|;
name|struct
name|tls_context
modifier|*
name|context
init|=
name|conn
operator|->
name|context
decl_stmt|;
name|char
modifier|*
name|altsubject
index|[
name|TLS_MAX_ALT_SUBJECT
index|]
decl_stmt|;
name|int
name|alt
decl_stmt|,
name|num_altsubject
init|=
literal|0
decl_stmt|;
name|GENERAL_NAME
modifier|*
name|gen
decl_stmt|;
name|void
modifier|*
name|ext
decl_stmt|;
name|stack_index_t
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_SHA256
name|u8
name|hash
index|[
literal|32
index|]
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SHA256 */
if|if
condition|(
name|context
operator|->
name|event_cb
operator|==
name|NULL
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|ev
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ev
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|cert_probe
operator|||
name|context
operator|->
name|cert_in_cb
condition|)
block|{
name|cert
operator|=
name|get_x509_cert
argument_list|(
name|err_cert
argument_list|)
expr_stmt|;
name|ev
operator|.
name|peer_cert
operator|.
name|cert
operator|=
name|cert
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SHA256
if|if
condition|(
name|cert
condition|)
block|{
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|1
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|1
index|]
decl_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|wpabuf_head
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|wpabuf_len
argument_list|(
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|sha256_vector
argument_list|(
literal|1
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ev
operator|.
name|peer_cert
operator|.
name|hash
operator|=
name|hash
expr_stmt|;
name|ev
operator|.
name|peer_cert
operator|.
name|hash_len
operator|=
sizeof|sizeof
argument_list|(
name|hash
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_SHA256 */
name|ev
operator|.
name|peer_cert
operator|.
name|depth
operator|=
name|depth
expr_stmt|;
name|ev
operator|.
name|peer_cert
operator|.
name|subject
operator|=
name|subject
expr_stmt|;
name|ext
operator|=
name|X509_get_ext_d2i
argument_list|(
name|err_cert
argument_list|,
name|NID_subject_alt_name
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ext
operator|&&
name|i
operator|<
name|sk_GENERAL_NAME_num
argument_list|(
name|ext
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|num_altsubject
operator|==
name|TLS_MAX_ALT_SUBJECT
condition|)
break|break;
name|gen
operator|=
name|sk_GENERAL_NAME_value
argument_list|(
name|ext
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|gen
operator|->
name|type
operator|!=
name|GEN_EMAIL
operator|&&
name|gen
operator|->
name|type
operator|!=
name|GEN_DNS
operator|&&
name|gen
operator|->
name|type
operator|!=
name|GEN_URI
condition|)
continue|continue;
name|pos
operator|=
name|os_malloc
argument_list|(
literal|10
operator|+
name|gen
operator|->
name|d
operator|.
name|ia5
operator|->
name|length
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
break|break;
name|altsubject
index|[
name|num_altsubject
operator|++
index|]
operator|=
name|pos
expr_stmt|;
switch|switch
condition|(
name|gen
operator|->
name|type
condition|)
block|{
case|case
name|GEN_EMAIL
case|:
name|os_memcpy
argument_list|(
name|pos
argument_list|,
literal|"EMAIL:"
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|6
expr_stmt|;
break|break;
case|case
name|GEN_DNS
case|:
name|os_memcpy
argument_list|(
name|pos
argument_list|,
literal|"DNS:"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
name|GEN_URI
case|:
name|os_memcpy
argument_list|(
name|pos
argument_list|,
literal|"URI:"
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
break|break;
block|}
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|gen
operator|->
name|d
operator|.
name|ia5
operator|->
name|data
argument_list|,
name|gen
operator|->
name|d
operator|.
name|ia5
operator|->
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|gen
operator|->
name|d
operator|.
name|ia5
operator|->
name|length
expr_stmt|;
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
block|}
for|for
control|(
name|alt
operator|=
literal|0
init|;
name|alt
operator|<
name|num_altsubject
condition|;
name|alt
operator|++
control|)
name|ev
operator|.
name|peer_cert
operator|.
name|altsubject
index|[
name|alt
index|]
operator|=
name|altsubject
index|[
name|alt
index|]
expr_stmt|;
name|ev
operator|.
name|peer_cert
operator|.
name|num_altsubject
operator|=
name|num_altsubject
expr_stmt|;
name|context
operator|->
name|event_cb
argument_list|(
name|context
operator|->
name|cb_ctx
argument_list|,
name|TLS_PEER_CERTIFICATE
argument_list|,
operator|&
name|ev
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
for|for
control|(
name|alt
operator|=
literal|0
init|;
name|alt
operator|<
name|num_altsubject
condition|;
name|alt
operator|++
control|)
name|os_free
argument_list|(
name|altsubject
index|[
name|alt
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_verify_cb
parameter_list|(
name|int
name|preverify_ok
parameter_list|,
name|X509_STORE_CTX
modifier|*
name|x509_ctx
parameter_list|)
block|{
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|X509
modifier|*
name|err_cert
decl_stmt|;
name|int
name|err
decl_stmt|,
name|depth
decl_stmt|;
name|SSL
modifier|*
name|ssl
decl_stmt|;
name|struct
name|tls_connection
modifier|*
name|conn
decl_stmt|;
name|struct
name|tls_context
modifier|*
name|context
decl_stmt|;
name|char
modifier|*
name|match
decl_stmt|,
modifier|*
name|altmatch
decl_stmt|,
modifier|*
name|suffix_match
decl_stmt|,
modifier|*
name|domain_match
decl_stmt|;
specifier|const
name|char
modifier|*
name|err_str
decl_stmt|;
name|err_cert
operator|=
name|X509_STORE_CTX_get_current_cert
argument_list|(
name|x509_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|err_cert
condition|)
return|return
literal|0
return|;
name|err
operator|=
name|X509_STORE_CTX_get_error
argument_list|(
name|x509_ctx
argument_list|)
expr_stmt|;
name|depth
operator|=
name|X509_STORE_CTX_get_error_depth
argument_list|(
name|x509_ctx
argument_list|)
expr_stmt|;
name|ssl
operator|=
name|X509_STORE_CTX_get_ex_data
argument_list|(
name|x509_ctx
argument_list|,
name|SSL_get_ex_data_X509_STORE_CTX_idx
argument_list|()
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|err_cert
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|=
name|SSL_get_app_data
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|depth
operator|==
literal|0
condition|)
name|conn
operator|->
name|peer_cert
operator|=
name|err_cert
expr_stmt|;
elseif|else
if|if
condition|(
name|depth
operator|==
literal|1
condition|)
name|conn
operator|->
name|peer_issuer
operator|=
name|err_cert
expr_stmt|;
elseif|else
if|if
condition|(
name|depth
operator|==
literal|2
condition|)
name|conn
operator|->
name|peer_issuer_issuer
operator|=
name|err_cert
expr_stmt|;
name|context
operator|=
name|conn
operator|->
name|context
expr_stmt|;
name|match
operator|=
name|conn
operator|->
name|subject_match
expr_stmt|;
name|altmatch
operator|=
name|conn
operator|->
name|altsubject_match
expr_stmt|;
name|suffix_match
operator|=
name|conn
operator|->
name|suffix_match
expr_stmt|;
name|domain_match
operator|=
name|conn
operator|->
name|domain_match
expr_stmt|;
if|if
condition|(
operator|!
name|preverify_ok
operator|&&
operator|!
name|conn
operator|->
name|ca_cert_verify
condition|)
name|preverify_ok
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|preverify_ok
operator|&&
name|depth
operator|>
literal|0
operator|&&
name|conn
operator|->
name|server_cert_only
condition|)
name|preverify_ok
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|preverify_ok
operator|&&
operator|(
name|conn
operator|->
name|flags
operator|&
name|TLS_CONN_DISABLE_TIME_CHECKS
operator|)
operator|&&
operator|(
name|err
operator|==
name|X509_V_ERR_CERT_HAS_EXPIRED
operator|||
name|err
operator|==
name|X509_V_ERR_CERT_NOT_YET_VALID
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Ignore certificate validity "
literal|"time mismatch"
argument_list|)
expr_stmt|;
name|preverify_ok
operator|=
literal|1
expr_stmt|;
block|}
name|err_str
operator|=
name|X509_verify_cert_error_string
argument_list|(
name|err
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_SHA256
comment|/* 	 * Do not require preverify_ok so we can explicity allow otherwise 	 * invalid pinned server certificates. 	 */
if|if
condition|(
name|depth
operator|==
literal|0
operator|&&
name|conn
operator|->
name|server_cert_only
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|cert
decl_stmt|;
name|cert
operator|=
name|get_x509_cert
argument_list|(
name|err_cert
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cert
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Could not fetch "
literal|"server certificate data"
argument_list|)
expr_stmt|;
name|preverify_ok
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|u8
name|hash
index|[
literal|32
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|1
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|1
index|]
decl_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|wpabuf_head
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|wpabuf_len
argument_list|(
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|sha256_vector
argument_list|(
literal|1
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
operator|<
literal|0
operator|||
name|os_memcmp
argument_list|(
name|conn
operator|->
name|srv_cert_hash
argument_list|,
name|hash
argument_list|,
literal|32
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|err_str
operator|=
literal|"Server certificate mismatch"
expr_stmt|;
name|err
operator|=
name|X509_V_ERR_SELF_SIGNED_CERT_IN_CHAIN
expr_stmt|;
name|preverify_ok
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|preverify_ok
condition|)
block|{
comment|/* 				 * Certificate matches pinned certificate, allow 				 * regardless of other problems. 				 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Ignore validation issues for a pinned server certificate"
argument_list|)
expr_stmt|;
name|preverify_ok
operator|=
literal|1
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_SHA256 */
if|if
condition|(
operator|!
name|preverify_ok
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TLS: Certificate verification failed,"
literal|" error %d (%s) depth %d for '%s'"
argument_list|,
name|err
argument_list|,
name|err_str
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|openssl_tls_fail_event
argument_list|(
name|conn
argument_list|,
name|err_cert
argument_list|,
name|err
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|,
name|err_str
argument_list|,
name|TLS_FAIL_UNSPECIFIED
argument_list|)
expr_stmt|;
return|return
name|preverify_ok
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: tls_verify_cb - preverify_ok=%d "
literal|"err=%d (%s) ca_cert_verify=%d depth=%d buf='%s'"
argument_list|,
name|preverify_ok
argument_list|,
name|err
argument_list|,
name|err_str
argument_list|,
name|conn
operator|->
name|ca_cert_verify
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth
operator|==
literal|0
operator|&&
name|match
operator|&&
name|os_strstr
argument_list|(
name|buf
argument_list|,
name|match
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TLS: Subject '%s' did not "
literal|"match with '%s'"
argument_list|,
name|buf
argument_list|,
name|match
argument_list|)
expr_stmt|;
name|preverify_ok
operator|=
literal|0
expr_stmt|;
name|openssl_tls_fail_event
argument_list|(
name|conn
argument_list|,
name|err_cert
argument_list|,
name|err
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|,
literal|"Subject mismatch"
argument_list|,
name|TLS_FAIL_SUBJECT_MISMATCH
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|depth
operator|==
literal|0
operator|&&
name|altmatch
operator|&&
operator|!
name|tls_match_altsubject
argument_list|(
name|err_cert
argument_list|,
name|altmatch
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TLS: altSubjectName match "
literal|"'%s' not found"
argument_list|,
name|altmatch
argument_list|)
expr_stmt|;
name|preverify_ok
operator|=
literal|0
expr_stmt|;
name|openssl_tls_fail_event
argument_list|(
name|conn
argument_list|,
name|err_cert
argument_list|,
name|err
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|,
literal|"AltSubject mismatch"
argument_list|,
name|TLS_FAIL_ALTSUBJECT_MISMATCH
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|depth
operator|==
literal|0
operator|&&
name|suffix_match
operator|&&
operator|!
name|tls_match_suffix
argument_list|(
name|err_cert
argument_list|,
name|suffix_match
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TLS: Domain suffix match '%s' not found"
argument_list|,
name|suffix_match
argument_list|)
expr_stmt|;
name|preverify_ok
operator|=
literal|0
expr_stmt|;
name|openssl_tls_fail_event
argument_list|(
name|conn
argument_list|,
name|err_cert
argument_list|,
name|err
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|,
literal|"Domain suffix mismatch"
argument_list|,
name|TLS_FAIL_DOMAIN_SUFFIX_MISMATCH
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|depth
operator|==
literal|0
operator|&&
name|domain_match
operator|&&
operator|!
name|tls_match_suffix
argument_list|(
name|err_cert
argument_list|,
name|domain_match
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TLS: Domain match '%s' not found"
argument_list|,
name|domain_match
argument_list|)
expr_stmt|;
name|preverify_ok
operator|=
literal|0
expr_stmt|;
name|openssl_tls_fail_event
argument_list|(
name|conn
argument_list|,
name|err_cert
argument_list|,
name|err
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|,
literal|"Domain mismatch"
argument_list|,
name|TLS_FAIL_DOMAIN_MISMATCH
argument_list|)
expr_stmt|;
block|}
else|else
name|openssl_tls_cert_event
argument_list|(
name|conn
argument_list|,
name|err_cert
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|cert_probe
operator|&&
name|preverify_ok
operator|&&
name|depth
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Reject server certificate "
literal|"on probe-only run"
argument_list|)
expr_stmt|;
name|preverify_ok
operator|=
literal|0
expr_stmt|;
name|openssl_tls_fail_event
argument_list|(
name|conn
argument_list|,
name|err_cert
argument_list|,
name|err
argument_list|,
name|depth
argument_list|,
name|buf
argument_list|,
literal|"Server certificate chain probe"
argument_list|,
name|TLS_FAIL_SERVER_CHAIN_PROBE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|preverify_ok
operator|&&
name|context
operator|->
name|event_cb
operator|!=
name|NULL
condition|)
name|context
operator|->
name|event_cb
argument_list|(
name|context
operator|->
name|cb_ctx
argument_list|,
name|TLS_CERT_CHAIN_SUCCESS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|preverify_ok
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
end_ifndef

begin_function
specifier|static
name|int
name|tls_load_ca_der
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_cert
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|data
operator|->
name|ssl
decl_stmt|;
name|X509_LOOKUP
modifier|*
name|lookup
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|lookup
operator|=
name|X509_STORE_add_lookup
argument_list|(
name|SSL_CTX_get_cert_store
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|,
name|X509_LOOKUP_file
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|lookup
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed add lookup for X509 store"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|X509_LOOKUP_load_file
argument_list|(
name|lookup
argument_list|,
name|ca_cert
argument_list|,
name|X509_FILETYPE_ASN1
argument_list|)
condition|)
block|{
name|unsigned
name|long
name|err
init|=
name|ERR_peek_error
argument_list|()
decl_stmt|;
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed load CA in DER format"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ERR_GET_LIB
argument_list|(
name|err
argument_list|)
operator|==
name|ERR_LIB_X509
operator|&&
name|ERR_GET_REASON
argument_list|(
name|err
argument_list|)
operator|==
name|X509_R_CERT_ALREADY_IN_HASH_TABLE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - ignoring "
literal|"cert already in hash table error"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_STDIO */
end_comment

begin_function
specifier|static
name|int
name|tls_connection_ca_cert
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|ca_cert_blob
parameter_list|,
name|size_t
name|ca_cert_blob_len
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_path
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|data
operator|->
name|ssl
decl_stmt|;
name|X509_STORE
modifier|*
name|store
decl_stmt|;
comment|/* 	 * Remove previously configured trusted CA certificates before adding 	 * new ones. 	 */
name|store
operator|=
name|X509_STORE_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|store
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - failed to allocate new "
literal|"certificate store"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|SSL_CTX_set_cert_store
argument_list|(
name|ssl_ctx
argument_list|,
name|store
argument_list|)
expr_stmt|;
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_PEER
argument_list|,
name|tls_verify_cb
argument_list|)
expr_stmt|;
name|conn
operator|->
name|ca_cert_verify
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ca_cert
operator|&&
name|os_strncmp
argument_list|(
name|ca_cert
argument_list|,
literal|"probe://"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Probe for server certificate "
literal|"chain"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|cert_probe
operator|=
literal|1
expr_stmt|;
name|conn
operator|->
name|ca_cert_verify
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ca_cert
operator|&&
name|os_strncmp
argument_list|(
name|ca_cert
argument_list|,
literal|"hash://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_SHA256
specifier|const
name|char
modifier|*
name|pos
init|=
name|ca_cert
operator|+
literal|7
decl_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"server/sha256/"
argument_list|,
literal|14
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Unsupported ca_cert "
literal|"hash value '%s'"
argument_list|,
name|ca_cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|14
expr_stmt|;
if|if
condition|(
name|os_strlen
argument_list|(
name|pos
argument_list|)
operator|!=
literal|32
operator|*
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Unexpected SHA256 "
literal|"hash length in ca_cert '%s'"
argument_list|,
name|ca_cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|conn
operator|->
name|srv_cert_hash
argument_list|,
literal|32
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Invalid SHA256 hash "
literal|"value in ca_cert '%s'"
argument_list|,
name|ca_cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|server_cert_only
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Checking only server "
literal|"certificate match"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* CONFIG_SHA256 */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No SHA256 included in the build - "
literal|"cannot validate server certificate hash"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_SHA256 */
block|}
if|if
condition|(
name|ca_cert_blob
condition|)
block|{
name|X509
modifier|*
name|cert
init|=
name|d2i_X509
argument_list|(
name|NULL
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|*
operator|)
operator|&
name|ca_cert_blob
argument_list|,
name|ca_cert_blob_len
argument_list|)
decl_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to parse ca_cert_blob"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|X509_STORE_add_cert
argument_list|(
name|SSL_CTX_get_cert_store
argument_list|(
name|ssl_ctx
argument_list|)
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|unsigned
name|long
name|err
init|=
name|ERR_peek_error
argument_list|()
decl_stmt|;
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to add ca_cert_blob to "
literal|"certificate store"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ERR_GET_LIB
argument_list|(
name|err
argument_list|)
operator|==
name|ERR_LIB_X509
operator|&&
name|ERR_GET_REASON
argument_list|(
name|err
argument_list|)
operator|==
name|X509_R_CERT_ALREADY_IN_HASH_TABLE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - ignoring "
literal|"cert already in hash table error"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - added ca_cert_blob "
literal|"to certificate store"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|ANDROID
if|if
condition|(
name|ca_cert
operator|&&
name|os_strncmp
argument_list|(
literal|"keystore://"
argument_list|,
name|ca_cert
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
condition|)
block|{
name|BIO
modifier|*
name|bio
init|=
name|BIO_from_keystore
argument_list|(
operator|&
name|ca_cert
index|[
literal|11
index|]
argument_list|)
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509_INFO
argument_list|)
operator|*
name|stack
operator|=
name|NULL
expr_stmt|;
name|stack_index_t
name|i
decl_stmt|;
if|if
condition|(
name|bio
condition|)
block|{
name|stack
operator|=
name|PEM_X509_INFO_read_bio
argument_list|(
name|bio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|stack
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|sk_X509_INFO_num
argument_list|(
name|stack
argument_list|)
condition|;
operator|++
name|i
control|)
block|{
name|X509_INFO
modifier|*
name|info
init|=
name|sk_X509_INFO_value
argument_list|(
name|stack
argument_list|,
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|info
operator|->
name|x509
condition|)
block|{
name|X509_STORE_add_cert
argument_list|(
name|ssl_ctx
operator|->
name|cert_store
argument_list|,
name|info
operator|->
name|x509
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|info
operator|->
name|crl
condition|)
block|{
name|X509_STORE_add_crl
argument_list|(
name|ssl_ctx
operator|->
name|cert_store
argument_list|,
name|info
operator|->
name|crl
argument_list|)
expr_stmt|;
block|}
block|}
name|sk_X509_INFO_pop_free
argument_list|(
name|stack
argument_list|,
name|X509_INFO_free
argument_list|)
expr_stmt|;
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_PEER
argument_list|,
name|tls_verify_cb
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* ANDROID */
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
if|if
condition|(
name|ca_cert
operator|&&
name|tls_cryptoapi_ca_cert
argument_list|(
name|ssl_ctx
argument_list|,
name|conn
operator|->
name|ssl
argument_list|,
name|ca_cert
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Added CA certificates from "
literal|"system certificate store"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
if|if
condition|(
name|ca_cert
operator|||
name|ca_path
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
if|if
condition|(
name|SSL_CTX_load_verify_locations
argument_list|(
name|ssl_ctx
argument_list|,
name|ca_cert
argument_list|,
name|ca_path
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to load root certificates"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ca_cert
operator|&&
name|tls_load_ca_der
argument_list|(
name|data
argument_list|,
name|ca_cert
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - loaded "
literal|"DER format CA certificate"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Trusted root "
literal|"certificate(s) loaded"
argument_list|)
expr_stmt|;
name|tls_get_errors
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* OPENSSL_NO_STDIO */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - OPENSSL_NO_STDIO"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
block|}
else|else
block|{
comment|/* No ca_cert configured - do not try to verify server 		 * certificate */
name|conn
operator|->
name|ca_cert_verify
operator|=
literal|0
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_global_ca_cert
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_cert
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|data
operator|->
name|ssl
decl_stmt|;
if|if
condition|(
name|ca_cert
condition|)
block|{
if|if
condition|(
name|SSL_CTX_load_verify_locations
argument_list|(
name|ssl_ctx
argument_list|,
name|ca_cert
argument_list|,
name|NULL
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to load root certificates"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Trusted root "
literal|"certificate(s) loaded"
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
comment|/* Add the same CAs to the client certificate requests */
name|SSL_CTX_set_client_CA_list
argument_list|(
name|ssl_ctx
argument_list|,
name|SSL_load_client_CA_file
argument_list|(
name|ca_cert
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_global_set_verify
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|int
name|check_crl
parameter_list|)
block|{
name|int
name|flags
decl_stmt|;
if|if
condition|(
name|check_crl
condition|)
block|{
name|struct
name|tls_data
modifier|*
name|data
init|=
name|ssl_ctx
decl_stmt|;
name|X509_STORE
modifier|*
name|cs
init|=
name|SSL_CTX_get_cert_store
argument_list|(
name|data
operator|->
name|ssl
argument_list|)
decl_stmt|;
if|if
condition|(
name|cs
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to get "
literal|"certificate store when enabling "
literal|"check_crl"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|flags
operator|=
name|X509_V_FLAG_CRL_CHECK
expr_stmt|;
if|if
condition|(
name|check_crl
operator|==
literal|2
condition|)
name|flags
operator||=
name|X509_V_FLAG_CRL_CHECK_ALL
expr_stmt|;
name|X509_STORE_set_flags
argument_list|(
name|cs
argument_list|,
name|flags
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_set_subject_match
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|subject_match
parameter_list|,
specifier|const
name|char
modifier|*
name|altsubject_match
parameter_list|,
specifier|const
name|char
modifier|*
name|suffix_match
parameter_list|,
specifier|const
name|char
modifier|*
name|domain_match
parameter_list|)
block|{
name|os_free
argument_list|(
name|conn
operator|->
name|subject_match
argument_list|)
expr_stmt|;
name|conn
operator|->
name|subject_match
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|subject_match
condition|)
block|{
name|conn
operator|->
name|subject_match
operator|=
name|os_strdup
argument_list|(
name|subject_match
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|subject_match
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|conn
operator|->
name|altsubject_match
argument_list|)
expr_stmt|;
name|conn
operator|->
name|altsubject_match
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|altsubject_match
condition|)
block|{
name|conn
operator|->
name|altsubject_match
operator|=
name|os_strdup
argument_list|(
name|altsubject_match
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|altsubject_match
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|conn
operator|->
name|suffix_match
argument_list|)
expr_stmt|;
name|conn
operator|->
name|suffix_match
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|suffix_match
condition|)
block|{
name|conn
operator|->
name|suffix_match
operator|=
name|os_strdup
argument_list|(
name|suffix_match
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|suffix_match
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|conn
operator|->
name|domain_match
argument_list|)
expr_stmt|;
name|conn
operator|->
name|domain_match
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|domain_match
condition|)
block|{
name|conn
operator|->
name|domain_match
operator|=
name|os_strdup
argument_list|(
name|domain_match
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|domain_match
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tls_set_conn_flags
parameter_list|(
name|SSL
modifier|*
name|ssl
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|SSL_OP_NO_TICKET
if|if
condition|(
name|flags
operator|&
name|TLS_CONN_DISABLE_SESSION_TICKET
condition|)
name|SSL_set_options
argument_list|(
name|ssl
argument_list|,
name|SSL_OP_NO_TICKET
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SSL_clear_options
else|else
name|SSL_clear_options
argument_list|(
name|ssl
argument_list|,
name|SSL_OP_NO_TICKET
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SSL_clear_options */
endif|#
directive|endif
comment|/* SSL_OP_NO_TICKET */
ifdef|#
directive|ifdef
name|SSL_OP_NO_TLSv1
if|if
condition|(
name|flags
operator|&
name|TLS_CONN_DISABLE_TLSv1_0
condition|)
name|SSL_set_options
argument_list|(
name|ssl
argument_list|,
name|SSL_OP_NO_TLSv1
argument_list|)
expr_stmt|;
else|else
name|SSL_clear_options
argument_list|(
name|ssl
argument_list|,
name|SSL_OP_NO_TLSv1
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SSL_OP_NO_TLSv1 */
ifdef|#
directive|ifdef
name|SSL_OP_NO_TLSv1_1
if|if
condition|(
name|flags
operator|&
name|TLS_CONN_DISABLE_TLSv1_1
condition|)
name|SSL_set_options
argument_list|(
name|ssl
argument_list|,
name|SSL_OP_NO_TLSv1_1
argument_list|)
expr_stmt|;
else|else
name|SSL_clear_options
argument_list|(
name|ssl
argument_list|,
name|SSL_OP_NO_TLSv1_1
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SSL_OP_NO_TLSv1_1 */
ifdef|#
directive|ifdef
name|SSL_OP_NO_TLSv1_2
if|if
condition|(
name|flags
operator|&
name|TLS_CONN_DISABLE_TLSv1_2
condition|)
name|SSL_set_options
argument_list|(
name|ssl
argument_list|,
name|SSL_OP_NO_TLSv1_2
argument_list|)
expr_stmt|;
else|else
name|SSL_clear_options
argument_list|(
name|ssl
argument_list|,
name|SSL_OP_NO_TLSv1_2
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SSL_OP_NO_TLSv1_2 */
block|}
end_function

begin_function
name|int
name|tls_connection_set_verify
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|int
name|verify_peer
parameter_list|,
name|unsigned
name|int
name|flags
parameter_list|,
specifier|const
name|u8
modifier|*
name|session_ctx
parameter_list|,
name|size_t
name|session_ctx_len
parameter_list|)
block|{
specifier|static
name|int
name|counter
init|=
literal|0
decl_stmt|;
name|struct
name|tls_data
modifier|*
name|data
init|=
name|ssl_ctx
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|verify_peer
condition|)
block|{
name|conn
operator|->
name|ca_cert_verify
operator|=
literal|1
expr_stmt|;
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_PEER
operator||
name|SSL_VERIFY_FAIL_IF_NO_PEER_CERT
operator||
name|SSL_VERIFY_CLIENT_ONCE
argument_list|,
name|tls_verify_cb
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|conn
operator|->
name|ca_cert_verify
operator|=
literal|0
expr_stmt|;
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_NONE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|tls_set_conn_flags
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|conn
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|SSL_set_accept_state
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|tls_session_lifetime
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Set session id context to a unique value to make sure 		 * session resumption cannot be used either through session 		 * caching or TLS ticket extension. 		 */
name|counter
operator|++
expr_stmt|;
name|SSL_set_session_id_context
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|)
operator|&
name|counter
argument_list|,
sizeof|sizeof
argument_list|(
name|counter
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|session_ctx
condition|)
block|{
name|SSL_set_session_id_context
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|session_ctx
argument_list|,
name|session_ctx_len
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_client_cert
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|client_cert_blob
parameter_list|,
name|size_t
name|client_cert_blob_len
parameter_list|)
block|{
if|if
condition|(
name|client_cert
operator|==
name|NULL
operator|&&
name|client_cert_blob
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|client_cert_blob
operator|&&
name|SSL_use_certificate_ASN1
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|client_cert_blob
argument_list|,
name|client_cert_blob_len
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: SSL_use_certificate_ASN1 --> "
literal|"OK"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|client_cert_blob
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_certificate_ASN1 failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|client_cert
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
ifdef|#
directive|ifdef
name|ANDROID
if|if
condition|(
name|os_strncmp
argument_list|(
literal|"keystore://"
argument_list|,
name|client_cert
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
condition|)
block|{
name|BIO
modifier|*
name|bio
init|=
name|BIO_from_keystore
argument_list|(
operator|&
name|client_cert
index|[
literal|11
index|]
argument_list|)
decl_stmt|;
name|X509
modifier|*
name|x509
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|bio
condition|)
block|{
name|x509
operator|=
name|PEM_read_bio_X509
argument_list|(
name|bio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|x509
condition|)
block|{
if|if
condition|(
name|SSL_use_certificate
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|x509
argument_list|)
operator|==
literal|1
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
name|X509_free
argument_list|(
name|x509
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
endif|#
directive|endif
comment|/* ANDROID */
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
if|if
condition|(
name|SSL_use_certificate_file
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|client_cert
argument_list|,
name|SSL_FILETYPE_ASN1
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: SSL_use_certificate_file (DER)"
literal|" --> OK"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|SSL_use_certificate_file
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|client_cert
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
operator|==
literal|1
condition|)
block|{
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: SSL_use_certificate_file (PEM)"
literal|" --> OK"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_certificate_file failed"
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* OPENSSL_NO_STDIO */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - OPENSSL_NO_STDIO"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_global_client_cert
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|data
operator|->
name|ssl
decl_stmt|;
if|if
condition|(
name|client_cert
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|SSL_CTX_use_certificate_file
argument_list|(
name|ssl_ctx
argument_list|,
name|client_cert
argument_list|,
name|SSL_FILETYPE_ASN1
argument_list|)
operator|!=
literal|1
operator|&&
name|SSL_CTX_use_certificate_chain_file
argument_list|(
name|ssl_ctx
argument_list|,
name|client_cert
argument_list|)
operator|!=
literal|1
operator|&&
name|SSL_CTX_use_certificate_file
argument_list|(
name|ssl_ctx
argument_list|,
name|client_cert
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to load client certificate"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* OPENSSL_NO_STDIO */
if|if
condition|(
name|client_cert
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - OPENSSL_NO_STDIO"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_passwd_cb
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|size
parameter_list|,
name|int
name|rwflag
parameter_list|,
name|void
modifier|*
name|password
parameter_list|)
block|{
if|if
condition|(
name|password
operator|==
name|NULL
condition|)
block|{
return|return
literal|0
return|;
block|}
name|os_strlcpy
argument_list|(
name|buf
argument_list|,
operator|(
name|char
operator|*
operator|)
name|password
argument_list|,
name|size
argument_list|)
expr_stmt|;
return|return
name|os_strlen
argument_list|(
name|buf
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PKCS12_FUNCS
end_ifdef

begin_function
specifier|static
name|int
name|tls_parse_pkcs12
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|,
name|PKCS12
modifier|*
name|p12
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|pkey
decl_stmt|;
name|X509
modifier|*
name|cert
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|certs
expr_stmt|;
name|int
name|res
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|pkey
operator|=
name|NULL
expr_stmt|;
name|cert
operator|=
name|NULL
expr_stmt|;
name|certs
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|passwd
condition|)
name|passwd
operator|=
literal|""
expr_stmt|;
if|if
condition|(
operator|!
name|PKCS12_parse
argument_list|(
name|p12
argument_list|,
name|passwd
argument_list|,
operator|&
name|pkey
argument_list|,
operator|&
name|cert
argument_list|,
operator|&
name|certs
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"Failed to parse PKCS12 file"
argument_list|)
expr_stmt|;
name|PKCS12_free
argument_list|(
name|p12
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Successfully parsed PKCS12 data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
condition|)
block|{
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|cert
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Got certificate from PKCS12: "
literal|"subject='%s'"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssl
condition|)
block|{
if|if
condition|(
name|SSL_use_certificate
argument_list|(
name|ssl
argument_list|,
name|cert
argument_list|)
operator|!=
literal|1
condition|)
name|res
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SSL_CTX_use_certificate
argument_list|(
name|data
operator|->
name|ssl
argument_list|,
name|cert
argument_list|)
operator|!=
literal|1
condition|)
name|res
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pkey
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Got private key from PKCS12"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssl
condition|)
block|{
if|if
condition|(
name|SSL_use_PrivateKey
argument_list|(
name|ssl
argument_list|,
name|pkey
argument_list|)
operator|!=
literal|1
condition|)
name|res
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SSL_CTX_use_PrivateKey
argument_list|(
name|data
operator|->
name|ssl
argument_list|,
name|pkey
argument_list|)
operator|!=
literal|1
condition|)
name|res
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|EVP_PKEY_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|certs
condition|)
block|{
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x10002000L
name|SSL_clear_chain_certs
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|cert
operator|=
name|sk_X509_pop
argument_list|(
name|certs
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|cert
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: additional certificate"
literal|" from PKCS12: subject='%s'"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|SSL_add1_chain_cert
argument_list|(
name|ssl
argument_list|,
name|cert
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"Failed to add additional certificate"
argument_list|)
expr_stmt|;
name|res
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|res
condition|)
block|{
comment|/* Try to continue anyway */
block|}
name|sk_X509_free
argument_list|(
name|certs
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_IS_BORINGSSL
name|res
operator|=
name|SSL_build_cert_chain
argument_list|(
name|ssl
argument_list|,
name|SSL_BUILD_CHAIN_FLAG_CHECK
operator||
name|SSL_BUILD_CHAIN_FLAG_IGNORE_ERROR
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_DEBUG
argument_list|,
name|__func__
argument_list|,
literal|"Failed to build certificate chain"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|res
operator|==
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Ignore certificate chain verification error when building chain with PKCS#12 extra certificates"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* OPENSSL_IS_BORINGSSL */
comment|/* 		 * Try to continue regardless of result since it is possible for 		 * the extra certificates not to be required. 		 */
name|res
operator|=
literal|0
expr_stmt|;
else|#
directive|else
comment|/* OPENSSL_VERSION_NUMBER>= 0x10002000L */
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x10001000L
name|SSL_CTX_clear_extra_chain_certs
argument_list|(
name|data
operator|->
name|ssl
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_VERSION_NUMBER>= 0x10001000L */
while|while
condition|(
operator|(
name|cert
operator|=
name|sk_X509_pop
argument_list|(
name|certs
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|X509_NAME_oneline
argument_list|(
name|X509_get_subject_name
argument_list|(
name|cert
argument_list|)
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: additional certificate"
literal|" from PKCS12: subject='%s'"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
comment|/* 			 * There is no SSL equivalent for the chain cert - so 			 * always add it to the context... 			 */
if|if
condition|(
name|SSL_CTX_add_extra_chain_cert
argument_list|(
name|data
operator|->
name|ssl
argument_list|,
name|cert
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|res
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
block|}
name|sk_X509_free
argument_list|(
name|certs
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_VERSION_NUMBER>= 0x10002000L */
block|}
name|PKCS12_free
argument_list|(
name|p12
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|tls_get_errors
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PKCS12_FUNCS */
end_comment

begin_function
specifier|static
name|int
name|tls_read_pkcs12
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PKCS12_FUNCS
name|FILE
modifier|*
name|f
decl_stmt|;
name|PKCS12
modifier|*
name|p12
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|private_key
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p12
operator|=
name|d2i_PKCS12_fp
argument_list|(
name|f
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|p12
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to use PKCS#12 file"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|tls_parse_pkcs12
argument_list|(
name|data
argument_list|,
name|ssl
argument_list|,
name|p12
argument_list|,
name|passwd
argument_list|)
return|;
else|#
directive|else
comment|/* PKCS12_FUNCS */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: PKCS12 support disabled - cannot read "
literal|"p12/pfx files"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* PKCS12_FUNCS */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_read_pkcs12_blob
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
name|SSL
modifier|*
name|ssl
parameter_list|,
specifier|const
name|u8
modifier|*
name|blob
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|PKCS12_FUNCS
name|PKCS12
modifier|*
name|p12
decl_stmt|;
name|p12
operator|=
name|d2i_PKCS12
argument_list|(
name|NULL
argument_list|,
operator|(
specifier|const
name|unsigned
name|char
operator|*
operator|*
operator|)
operator|&
name|blob
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p12
operator|==
name|NULL
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to use PKCS#12 blob"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|tls_parse_pkcs12
argument_list|(
name|data
argument_list|,
name|ssl
argument_list|,
name|p12
argument_list|,
name|passwd
argument_list|)
return|;
else|#
directive|else
comment|/* PKCS12_FUNCS */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: PKCS12 support disabled - cannot parse "
literal|"p12/pfx blobs"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* PKCS12_FUNCS */
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
end_ifndef

begin_function
specifier|static
name|int
name|tls_engine_get_cert
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|cert_id
parameter_list|,
name|X509
modifier|*
modifier|*
name|cert
parameter_list|)
block|{
comment|/* this runs after the private key is loaded so no PIN is required */
struct|struct
block|{
specifier|const
name|char
modifier|*
name|cert_id
decl_stmt|;
name|X509
modifier|*
name|cert
decl_stmt|;
block|}
name|params
struct|;
name|params
operator|.
name|cert_id
operator|=
name|cert_id
expr_stmt|;
name|params
operator|.
name|cert
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|ENGINE_ctrl_cmd
argument_list|(
name|conn
operator|->
name|engine
argument_list|,
literal|"LOAD_CERT_CTRL"
argument_list|,
literal|0
argument_list|,
operator|&
name|params
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|unsigned
name|long
name|err
init|=
name|ERR_get_error
argument_list|()
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: cannot load client cert with id"
literal|" '%s' [%s]"
argument_list|,
name|cert_id
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_is_pin_error
argument_list|(
name|err
argument_list|)
condition|)
return|return
name|TLS_SET_PARAMS_ENGINE_PRV_BAD_PIN
return|;
return|return
name|TLS_SET_PARAMS_ENGINE_PRV_INIT_FAILED
return|;
block|}
if|if
condition|(
operator|!
name|params
operator|.
name|cert
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ENGINE: did not properly cert with id"
literal|" '%s'"
argument_list|,
name|cert_id
argument_list|)
expr_stmt|;
return|return
name|TLS_SET_PARAMS_ENGINE_PRV_INIT_FAILED
return|;
block|}
operator|*
name|cert
operator|=
name|params
operator|.
name|cert
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_ENGINE */
end_comment

begin_function
specifier|static
name|int
name|tls_connection_engine_client_cert
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|cert_id
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|X509
modifier|*
name|cert
decl_stmt|;
if|if
condition|(
name|tls_engine_get_cert
argument_list|(
name|conn
argument_list|,
name|cert_id
argument_list|,
operator|&
name|cert
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|SSL_use_certificate
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_ERROR
argument_list|,
name|__func__
argument_list|,
literal|"SSL_use_certificate failed"
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ENGINE: SSL_use_certificate --> "
literal|"OK"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* OPENSSL_NO_ENGINE */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_engine_ca_cert
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_cert_id
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
name|X509
modifier|*
name|cert
decl_stmt|;
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|data
operator|->
name|ssl
decl_stmt|;
name|X509_STORE
modifier|*
name|store
decl_stmt|;
if|if
condition|(
name|tls_engine_get_cert
argument_list|(
name|conn
argument_list|,
name|ca_cert_id
argument_list|,
operator|&
name|cert
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* start off the same as tls_connection_ca_cert */
name|store
operator|=
name|X509_STORE_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|store
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - failed to allocate new "
literal|"certificate store"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|SSL_CTX_set_cert_store
argument_list|(
name|ssl_ctx
argument_list|,
name|store
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|X509_STORE_add_cert
argument_list|(
name|store
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|unsigned
name|long
name|err
init|=
name|ERR_peek_error
argument_list|()
decl_stmt|;
name|tls_show_errors
argument_list|(
name|MSG_WARNING
argument_list|,
name|__func__
argument_list|,
literal|"Failed to add CA certificate from engine "
literal|"to certificate store"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ERR_GET_LIB
argument_list|(
name|err
argument_list|)
operator|==
name|ERR_LIB_X509
operator|&&
name|ERR_GET_REASON
argument_list|(
name|err
argument_list|)
operator|==
name|X509_R_CERT_ALREADY_IN_HASH_TABLE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - ignoring cert"
literal|" already in hash table error"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - added CA certificate from engine "
literal|"to certificate store"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|SSL_set_verify
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_VERIFY_PEER
argument_list|,
name|tls_verify_cb
argument_list|)
expr_stmt|;
name|conn
operator|->
name|ca_cert_verify
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* OPENSSL_NO_ENGINE */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_engine_private_key
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_ENGINE
if|if
condition|(
name|SSL_use_PrivateKey
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|conn
operator|->
name|private_key
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_ERROR
argument_list|,
name|__func__
argument_list|,
literal|"ENGINE: cannot use private key for TLS"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|SSL_check_private_key
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Private key failed verification"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* OPENSSL_NO_ENGINE */
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"SSL: Configuration uses engine, but "
literal|"engine support was not compiled in"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_ENGINE */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_private_key
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key_passwd
parameter_list|,
specifier|const
name|u8
modifier|*
name|private_key_blob
parameter_list|,
name|size_t
name|private_key_blob_len
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|data
operator|->
name|ssl
decl_stmt|;
name|char
modifier|*
name|passwd
decl_stmt|;
name|int
name|ok
decl_stmt|;
if|if
condition|(
name|private_key
operator|==
name|NULL
operator|&&
name|private_key_blob
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|private_key_passwd
condition|)
block|{
name|passwd
operator|=
name|os_strdup
argument_list|(
name|private_key_passwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|passwd
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
name|passwd
operator|=
name|NULL
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb
argument_list|(
name|ssl_ctx
argument_list|,
name|tls_passwd_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb_userdata
argument_list|(
name|ssl_ctx
argument_list|,
name|passwd
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|private_key_blob
condition|)
block|{
if|if
condition|(
name|SSL_use_PrivateKey_ASN1
argument_list|(
name|EVP_PKEY_RSA
argument_list|,
name|conn
operator|->
name|ssl
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|private_key_blob
argument_list|,
name|private_key_blob_len
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: SSL_use_PrivateKey_"
literal|"ASN1(EVP_PKEY_RSA) --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|SSL_use_PrivateKey_ASN1
argument_list|(
name|EVP_PKEY_DSA
argument_list|,
name|conn
operator|->
name|ssl
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|private_key_blob
argument_list|,
name|private_key_blob_len
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: SSL_use_PrivateKey_"
literal|"ASN1(EVP_PKEY_DSA) --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|SSL_use_RSAPrivateKey_ASN1
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|private_key_blob
argument_list|,
name|private_key_blob_len
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: "
literal|"SSL_use_RSAPrivateKey_ASN1 --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tls_read_pkcs12_blob
argument_list|(
name|data
argument_list|,
name|conn
operator|->
name|ssl
argument_list|,
name|private_key_blob
argument_list|,
name|private_key_blob_len
argument_list|,
name|passwd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: PKCS#12 as blob --> "
literal|"OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
break|break;
block|}
while|while
condition|(
operator|!
name|ok
operator|&&
name|private_key
condition|)
block|{
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
if|if
condition|(
name|SSL_use_PrivateKey_file
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|private_key
argument_list|,
name|SSL_FILETYPE_ASN1
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: "
literal|"SSL_use_PrivateKey_File (DER) --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|SSL_use_PrivateKey_file
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|private_key
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: "
literal|"SSL_use_PrivateKey_File (PEM) --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
else|#
directive|else
comment|/* OPENSSL_NO_STDIO */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - OPENSSL_NO_STDIO"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
if|if
condition|(
name|tls_read_pkcs12
argument_list|(
name|data
argument_list|,
name|conn
operator|->
name|ssl
argument_list|,
name|private_key
argument_list|,
name|passwd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Reading PKCS#12 file "
literal|"--> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|tls_cryptoapi_cert
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|private_key
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Using CryptoAPI to "
literal|"access certificate store --> OK"
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
block|}
break|break;
block|}
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to load private key"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|passwd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb
argument_list|(
name|ssl_ctx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|passwd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SSL_check_private_key
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Private key failed "
literal|"verification"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: Private key loaded successfully"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_global_private_key
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key_passwd
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|data
operator|->
name|ssl
decl_stmt|;
name|char
modifier|*
name|passwd
decl_stmt|;
if|if
condition|(
name|private_key
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|private_key_passwd
condition|)
block|{
name|passwd
operator|=
name|os_strdup
argument_list|(
name|private_key_passwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|passwd
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
name|passwd
operator|=
name|NULL
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb
argument_list|(
name|ssl_ctx
argument_list|,
name|tls_passwd_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb_userdata
argument_list|(
name|ssl_ctx
argument_list|,
name|passwd
argument_list|)
expr_stmt|;
if|if
condition|(
ifndef|#
directive|ifndef
name|OPENSSL_NO_STDIO
name|SSL_CTX_use_PrivateKey_file
argument_list|(
name|ssl_ctx
argument_list|,
name|private_key
argument_list|,
name|SSL_FILETYPE_ASN1
argument_list|)
operator|!=
literal|1
operator|&&
name|SSL_CTX_use_PrivateKey_file
argument_list|(
name|ssl_ctx
argument_list|,
name|private_key
argument_list|,
name|SSL_FILETYPE_PEM
argument_list|)
operator|!=
literal|1
operator|&&
endif|#
directive|endif
comment|/* OPENSSL_NO_STDIO */
name|tls_read_pkcs12
argument_list|(
name|data
argument_list|,
name|NULL
argument_list|,
name|private_key
argument_list|,
name|passwd
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to load private key"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|passwd
argument_list|)
expr_stmt|;
name|ERR_clear_error
argument_list|()
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|passwd
argument_list|)
expr_stmt|;
name|ERR_clear_error
argument_list|()
expr_stmt|;
name|SSL_CTX_set_default_passwd_cb
argument_list|(
name|ssl_ctx
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SSL_CTX_check_private_key
argument_list|(
name|ssl_ctx
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Private key failed verification"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_connection_dh
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|dh_file
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|OPENSSL_NO_DH
if|if
condition|(
name|dh_file
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TLS: openssl does not include DH support, but "
literal|"dh_file specified"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
else|#
directive|else
comment|/* OPENSSL_NO_DH */
name|DH
modifier|*
name|dh
decl_stmt|;
name|BIO
modifier|*
name|bio
decl_stmt|;
comment|/* TODO: add support for dh_blob */
if|if
condition|(
name|dh_file
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bio
operator|=
name|BIO_new_file
argument_list|(
name|dh_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to open DH file '%s': %s"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dh
operator|=
name|PEM_read_bio_DHparams
argument_list|(
name|bio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_DSA
while|while
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|DSA
modifier|*
name|dsa
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Failed to parse DH file '%s': %s -"
literal|" trying to parse as DSA params"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|bio
operator|=
name|BIO_new_file
argument_list|(
name|dh_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio
operator|==
name|NULL
condition|)
break|break;
name|dsa
operator|=
name|PEM_read_bio_DSAparams
argument_list|(
name|bio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsa
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Failed to parse DSA file "
literal|"'%s': %s"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: DH file in DSA param format"
argument_list|)
expr_stmt|;
name|dh
operator|=
name|DSA_dup_DH
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
name|DSA_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to convert DSA "
literal|"params into DH params"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* !OPENSSL_NO_DSA */
if|if
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to read/parse DH/DSA file "
literal|"'%s'"
argument_list|,
name|dh_file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|SSL_set_tmp_dh
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|dh
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to set DH params from '%s': "
literal|"%s"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_DH */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_global_dh
parameter_list|(
name|struct
name|tls_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|dh_file
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|OPENSSL_NO_DH
if|if
condition|(
name|dh_file
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TLS: openssl does not include DH support, but "
literal|"dh_file specified"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
else|#
directive|else
comment|/* OPENSSL_NO_DH */
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|data
operator|->
name|ssl
decl_stmt|;
name|DH
modifier|*
name|dh
decl_stmt|;
name|BIO
modifier|*
name|bio
decl_stmt|;
comment|/* TODO: add support for dh_blob */
if|if
condition|(
name|dh_file
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ssl_ctx
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bio
operator|=
name|BIO_new_file
argument_list|(
name|dh_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to open DH file '%s': %s"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dh
operator|=
name|PEM_read_bio_DHparams
argument_list|(
name|bio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|OPENSSL_NO_DSA
while|while
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|DSA
modifier|*
name|dsa
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Failed to parse DH file '%s': %s -"
literal|" trying to parse as DSA params"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|bio
operator|=
name|BIO_new_file
argument_list|(
name|dh_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|bio
operator|==
name|NULL
condition|)
break|break;
name|dsa
operator|=
name|PEM_read_bio_DSAparams
argument_list|(
name|bio
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|bio
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsa
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Failed to parse DSA file "
literal|"'%s': %s"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: DH file in DSA param format"
argument_list|)
expr_stmt|;
name|dh
operator|=
name|DSA_dup_DH
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
name|DSA_free
argument_list|(
name|dsa
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to convert DSA "
literal|"params into DH params"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
block|}
endif|#
directive|endif
comment|/* !OPENSSL_NO_DSA */
if|if
condition|(
name|dh
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to read/parse DH/DSA file "
literal|"'%s'"
argument_list|,
name|dh_file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|SSL_CTX_set_tmp_dh
argument_list|(
name|ssl_ctx
argument_list|,
name|dh
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to set DH params from '%s': "
literal|"%s"
argument_list|,
name|dh_file
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|DH_free
argument_list|(
name|dh
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* OPENSSL_NO_DH */
block|}
end_function

begin_function
name|int
name|tls_connection_get_random
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|struct
name|tls_random
modifier|*
name|keys
parameter_list|)
block|{
name|SSL
modifier|*
name|ssl
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|keys
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ssl
operator|=
name|conn
operator|->
name|ssl
expr_stmt|;
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|<
literal|0x10100000L
if|if
condition|(
name|ssl
operator|==
name|NULL
operator|||
name|ssl
operator|->
name|s3
operator|==
name|NULL
operator|||
name|ssl
operator|->
name|session
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
name|keys
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|keys
operator|->
name|client_random
operator|=
name|ssl
operator|->
name|s3
operator|->
name|client_random
expr_stmt|;
name|keys
operator|->
name|client_random_len
operator|=
name|SSL3_RANDOM_SIZE
expr_stmt|;
name|keys
operator|->
name|server_random
operator|=
name|ssl
operator|->
name|s3
operator|->
name|server_random
expr_stmt|;
name|keys
operator|->
name|server_random_len
operator|=
name|SSL3_RANDOM_SIZE
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|ssl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
name|keys
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|keys
operator|->
name|client_random
operator|=
name|conn
operator|->
name|client_random
expr_stmt|;
name|keys
operator|->
name|client_random_len
operator|=
name|SSL_get_client_random
argument_list|(
name|ssl
argument_list|,
name|conn
operator|->
name|client_random
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|client_random
argument_list|)
argument_list|)
expr_stmt|;
name|keys
operator|->
name|server_random
operator|=
name|conn
operator|->
name|server_random
expr_stmt|;
name|keys
operator|->
name|server_random_len
operator|=
name|SSL_get_server_random
argument_list|(
name|ssl
argument_list|,
name|conn
operator|->
name|server_random
argument_list|,
sizeof|sizeof
argument_list|(
name|conn
operator|->
name|server_random
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_FIPS
end_ifndef

begin_function
specifier|static
name|int
name|openssl_get_keyblock_size
parameter_list|(
name|SSL
modifier|*
name|ssl
parameter_list|)
block|{
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|<
literal|0x10100000L
specifier|const
name|EVP_CIPHER
modifier|*
name|c
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|h
decl_stmt|;
name|int
name|md_size
decl_stmt|;
if|if
condition|(
name|ssl
operator|->
name|enc_read_ctx
operator|==
name|NULL
operator|||
name|ssl
operator|->
name|enc_read_ctx
operator|->
name|cipher
operator|==
name|NULL
operator|||
name|ssl
operator|->
name|read_hash
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|c
operator|=
name|ssl
operator|->
name|enc_read_ctx
operator|->
name|cipher
expr_stmt|;
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x00909000L
name|h
operator|=
name|EVP_MD_CTX_md
argument_list|(
name|ssl
operator|->
name|read_hash
argument_list|)
expr_stmt|;
else|#
directive|else
name|h
operator|=
name|ssl
operator|->
name|read_hash
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|h
condition|)
name|md_size
operator|=
name|EVP_MD_size
argument_list|(
name|h
argument_list|)
expr_stmt|;
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x10000000L
elseif|else
if|if
condition|(
name|ssl
operator|->
name|s3
condition|)
name|md_size
operator|=
name|ssl
operator|->
name|s3
operator|->
name|tmp
operator|.
name|new_mac_secret_size
expr_stmt|;
endif|#
directive|endif
else|else
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: keyblock size: key_len=%d MD_size=%d "
literal|"IV_len=%d"
argument_list|,
name|EVP_CIPHER_key_length
argument_list|(
name|c
argument_list|)
argument_list|,
name|md_size
argument_list|,
name|EVP_CIPHER_iv_length
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|2
operator|*
operator|(
name|EVP_CIPHER_key_length
argument_list|(
name|c
argument_list|)
operator|+
name|md_size
operator|+
name|EVP_CIPHER_iv_length
argument_list|(
name|c
argument_list|)
operator|)
return|;
else|#
directive|else
specifier|const
name|SSL_CIPHER
modifier|*
name|ssl_cipher
decl_stmt|;
name|int
name|cipher
decl_stmt|,
name|digest
decl_stmt|;
specifier|const
name|EVP_CIPHER
modifier|*
name|c
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|h
decl_stmt|;
name|ssl_cipher
operator|=
name|SSL_get_current_cipher
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssl_cipher
condition|)
return|return
operator|-
literal|1
return|;
name|cipher
operator|=
name|SSL_CIPHER_get_cipher_nid
argument_list|(
name|ssl_cipher
argument_list|)
expr_stmt|;
name|digest
operator|=
name|SSL_CIPHER_get_digest_nid
argument_list|(
name|ssl_cipher
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: cipher nid %d digest nid %d"
argument_list|,
name|cipher
argument_list|,
name|digest
argument_list|)
expr_stmt|;
if|if
condition|(
name|cipher
operator|<
literal|0
operator|||
name|digest
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|c
operator|=
name|EVP_get_cipherbynid
argument_list|(
name|cipher
argument_list|)
expr_stmt|;
name|h
operator|=
name|EVP_get_digestbynid
argument_list|(
name|digest
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
operator|||
operator|!
name|h
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: keyblock size: key_len=%d MD_size=%d IV_len=%d"
argument_list|,
name|EVP_CIPHER_key_length
argument_list|(
name|c
argument_list|)
argument_list|,
name|EVP_MD_size
argument_list|(
name|h
argument_list|)
argument_list|,
name|EVP_CIPHER_iv_length
argument_list|(
name|c
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|2
operator|*
operator|(
name|EVP_CIPHER_key_length
argument_list|(
name|c
argument_list|)
operator|+
name|EVP_MD_size
argument_list|(
name|h
argument_list|)
operator|+
name|EVP_CIPHER_iv_length
argument_list|(
name|c
argument_list|)
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_FIPS */
end_comment

begin_function
specifier|static
name|int
name|openssl_tls_prf
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|int
name|server_random_first
parameter_list|,
name|int
name|skip_keyblock
parameter_list|,
name|u8
modifier|*
name|out
parameter_list|,
name|size_t
name|out_len
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_FIPS
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"OpenSSL: TLS keys cannot be exported in FIPS "
literal|"mode"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
else|#
directive|else
comment|/* CONFIG_FIPS */
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|<
literal|0x10100000L
name|SSL
modifier|*
name|ssl
decl_stmt|;
name|u8
modifier|*
name|rnd
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|skip
init|=
literal|0
decl_stmt|;
name|u8
modifier|*
name|tmp_out
init|=
name|NULL
decl_stmt|;
name|u8
modifier|*
name|_out
init|=
name|out
decl_stmt|;
specifier|const
name|char
modifier|*
name|ver
decl_stmt|;
comment|/* 	 * TLS library did not support key generation, so get the needed TLS 	 * session parameters and use an internal implementation of TLS PRF to 	 * derive the key. 	 */
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ssl
operator|=
name|conn
operator|->
name|ssl
expr_stmt|;
if|if
condition|(
name|ssl
operator|==
name|NULL
operator|||
name|ssl
operator|->
name|s3
operator|==
name|NULL
operator|||
name|ssl
operator|->
name|session
operator|==
name|NULL
operator|||
name|ssl
operator|->
name|session
operator|->
name|master_key_length
operator|<=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ver
operator|=
name|SSL_get_version
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|skip_keyblock
condition|)
block|{
name|skip
operator|=
name|openssl_get_keyblock_size
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|skip
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|tmp_out
operator|=
name|os_malloc
argument_list|(
name|skip
operator|+
name|out_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp_out
condition|)
return|return
operator|-
literal|1
return|;
name|_out
operator|=
name|tmp_out
expr_stmt|;
block|}
name|rnd
operator|=
name|os_malloc
argument_list|(
literal|2
operator|*
name|SSL3_RANDOM_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rnd
condition|)
block|{
name|os_free
argument_list|(
name|tmp_out
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|server_random_first
condition|)
block|{
name|os_memcpy
argument_list|(
name|rnd
argument_list|,
name|ssl
operator|->
name|s3
operator|->
name|server_random
argument_list|,
name|SSL3_RANDOM_SIZE
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|rnd
operator|+
name|SSL3_RANDOM_SIZE
argument_list|,
name|ssl
operator|->
name|s3
operator|->
name|client_random
argument_list|,
name|SSL3_RANDOM_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|rnd
argument_list|,
name|ssl
operator|->
name|s3
operator|->
name|client_random
argument_list|,
name|SSL3_RANDOM_SIZE
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|rnd
operator|+
name|SSL3_RANDOM_SIZE
argument_list|,
name|ssl
operator|->
name|s3
operator|->
name|server_random
argument_list|,
name|SSL3_RANDOM_SIZE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|ver
argument_list|,
literal|"TLSv1.2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tls_prf_sha256
argument_list|(
name|ssl
operator|->
name|session
operator|->
name|master_key
argument_list|,
name|ssl
operator|->
name|session
operator|->
name|master_key_length
argument_list|,
name|label
argument_list|,
name|rnd
argument_list|,
literal|2
operator|*
name|SSL3_RANDOM_SIZE
argument_list|,
name|_out
argument_list|,
name|skip
operator|+
name|out_len
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tls_prf_sha1_md5
argument_list|(
name|ssl
operator|->
name|session
operator|->
name|master_key
argument_list|,
name|ssl
operator|->
name|session
operator|->
name|master_key_length
argument_list|,
name|label
argument_list|,
name|rnd
argument_list|,
literal|2
operator|*
name|SSL3_RANDOM_SIZE
argument_list|,
name|_out
argument_list|,
name|skip
operator|+
name|out_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|os_free
argument_list|(
name|rnd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
operator|&&
name|skip_keyblock
condition|)
name|os_memcpy
argument_list|(
name|out
argument_list|,
name|_out
operator|+
name|skip
argument_list|,
name|out_len
argument_list|)
expr_stmt|;
name|bin_clear_free
argument_list|(
name|tmp_out
argument_list|,
name|skip
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
else|#
directive|else
name|SSL
modifier|*
name|ssl
decl_stmt|;
name|SSL_SESSION
modifier|*
name|sess
decl_stmt|;
name|u8
modifier|*
name|rnd
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|skip
init|=
literal|0
decl_stmt|;
name|u8
modifier|*
name|tmp_out
init|=
name|NULL
decl_stmt|;
name|u8
modifier|*
name|_out
init|=
name|out
decl_stmt|;
name|unsigned
name|char
name|client_random
index|[
name|SSL3_RANDOM_SIZE
index|]
decl_stmt|;
name|unsigned
name|char
name|server_random
index|[
name|SSL3_RANDOM_SIZE
index|]
decl_stmt|;
name|unsigned
name|char
name|master_key
index|[
literal|64
index|]
decl_stmt|;
name|size_t
name|master_key_len
decl_stmt|;
specifier|const
name|char
modifier|*
name|ver
decl_stmt|;
comment|/* 	 * TLS library did not support key generation, so get the needed TLS 	 * session parameters and use an internal implementation of TLS PRF to 	 * derive the key. 	 */
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ssl
operator|=
name|conn
operator|->
name|ssl
expr_stmt|;
if|if
condition|(
name|ssl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ver
operator|=
name|SSL_get_version
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
name|sess
operator|=
name|SSL_get_session
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ver
operator|||
operator|!
name|sess
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|skip_keyblock
condition|)
block|{
name|skip
operator|=
name|openssl_get_keyblock_size
argument_list|(
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|skip
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|tmp_out
operator|=
name|os_malloc
argument_list|(
name|skip
operator|+
name|out_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp_out
condition|)
return|return
operator|-
literal|1
return|;
name|_out
operator|=
name|tmp_out
expr_stmt|;
block|}
name|rnd
operator|=
name|os_malloc
argument_list|(
literal|2
operator|*
name|SSL3_RANDOM_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rnd
condition|)
block|{
name|os_free
argument_list|(
name|tmp_out
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|SSL_get_client_random
argument_list|(
name|ssl
argument_list|,
name|client_random
argument_list|,
sizeof|sizeof
argument_list|(
name|client_random
argument_list|)
argument_list|)
expr_stmt|;
name|SSL_get_server_random
argument_list|(
name|ssl
argument_list|,
name|server_random
argument_list|,
sizeof|sizeof
argument_list|(
name|server_random
argument_list|)
argument_list|)
expr_stmt|;
name|master_key_len
operator|=
name|SSL_SESSION_get_master_key
argument_list|(
name|sess
argument_list|,
name|master_key
argument_list|,
sizeof|sizeof
argument_list|(
name|master_key
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|server_random_first
condition|)
block|{
name|os_memcpy
argument_list|(
name|rnd
argument_list|,
name|server_random
argument_list|,
name|SSL3_RANDOM_SIZE
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|rnd
operator|+
name|SSL3_RANDOM_SIZE
argument_list|,
name|client_random
argument_list|,
name|SSL3_RANDOM_SIZE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|rnd
argument_list|,
name|client_random
argument_list|,
name|SSL3_RANDOM_SIZE
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|rnd
operator|+
name|SSL3_RANDOM_SIZE
argument_list|,
name|server_random
argument_list|,
name|SSL3_RANDOM_SIZE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|ver
argument_list|,
literal|"TLSv1.2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tls_prf_sha256
argument_list|(
name|master_key
argument_list|,
name|master_key_len
argument_list|,
name|label
argument_list|,
name|rnd
argument_list|,
literal|2
operator|*
name|SSL3_RANDOM_SIZE
argument_list|,
name|_out
argument_list|,
name|skip
operator|+
name|out_len
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tls_prf_sha1_md5
argument_list|(
name|master_key
argument_list|,
name|master_key_len
argument_list|,
name|label
argument_list|,
name|rnd
argument_list|,
literal|2
operator|*
name|SSL3_RANDOM_SIZE
argument_list|,
name|_out
argument_list|,
name|skip
operator|+
name|out_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
block|}
name|os_memset
argument_list|(
name|master_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|master_key
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rnd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
operator|&&
name|skip_keyblock
condition|)
name|os_memcpy
argument_list|(
name|out
argument_list|,
name|_out
operator|+
name|skip
argument_list|,
name|out_len
argument_list|)
expr_stmt|;
name|bin_clear_free
argument_list|(
name|tmp_out
argument_list|,
name|skip
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
endif|#
directive|endif
endif|#
directive|endif
comment|/* CONFIG_FIPS */
block|}
end_function

begin_function
name|int
name|tls_connection_prf
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|int
name|server_random_first
parameter_list|,
name|int
name|skip_keyblock
parameter_list|,
name|u8
modifier|*
name|out
parameter_list|,
name|size_t
name|out_len
parameter_list|)
block|{
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x10001000L
name|SSL
modifier|*
name|ssl
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|server_random_first
operator|||
name|skip_keyblock
condition|)
return|return
name|openssl_tls_prf
argument_list|(
name|conn
argument_list|,
name|label
argument_list|,
name|server_random_first
argument_list|,
name|skip_keyblock
argument_list|,
name|out
argument_list|,
name|out_len
argument_list|)
return|;
name|ssl
operator|=
name|conn
operator|->
name|ssl
expr_stmt|;
if|if
condition|(
name|SSL_export_keying_material
argument_list|(
name|ssl
argument_list|,
name|out
argument_list|,
name|out_len
argument_list|,
name|label
argument_list|,
name|os_strlen
argument_list|(
name|label
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Using internal PRF"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
return|return
name|openssl_tls_prf
argument_list|(
name|conn
argument_list|,
name|label
argument_list|,
name|server_random_first
argument_list|,
name|skip_keyblock
argument_list|,
name|out
argument_list|,
name|out_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|openssl_handshake
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|,
name|int
name|server
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|out_data
decl_stmt|;
comment|/* 	 * Give TLS handshake data from the server (if available) to OpenSSL 	 * for processing. 	 */
if|if
condition|(
name|in_data
operator|&&
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
operator|>
literal|0
operator|&&
name|BIO_write
argument_list|(
name|conn
operator|->
name|ssl_in
argument_list|,
name|wpabuf_head
argument_list|(
name|in_data
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Handshake failed - BIO_write"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Initiate TLS handshake or continue the existing handshake */
if|if
condition|(
name|server
condition|)
name|res
operator|=
name|SSL_accept
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
else|else
name|res
operator|=
name|SSL_connect
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|1
condition|)
block|{
name|int
name|err
init|=
name|SSL_get_error
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|res
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|SSL_ERROR_WANT_READ
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: SSL_connect - want "
literal|"more data"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|err
operator|==
name|SSL_ERROR_WANT_WRITE
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: SSL_connect - want to "
literal|"write"
argument_list|)
expr_stmt|;
else|else
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"SSL_connect"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|failed
operator|++
expr_stmt|;
block|}
block|}
comment|/* Get the TLS handshake data to be sent to the server */
name|res
operator|=
name|BIO_ctrl_pending
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: %d bytes pending from ssl_out"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|out_data
operator|=
name|wpabuf_alloc
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|out_data
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: Failed to allocate memory for "
literal|"handshake output (%d bytes)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"BIO_reset failed"
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|res
operator|==
literal|0
condition|?
literal|0
else|:
name|BIO_read
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|,
name|wpabuf_mhead
argument_list|(
name|out_data
argument_list|)
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Handshake failed - BIO_read"
argument_list|)
expr_stmt|;
if|if
condition|(
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"BIO_reset failed"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|out_data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_put
argument_list|(
name|out_data
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|out_data
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|openssl_get_appl_data
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|size_t
name|max_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|appl_data
decl_stmt|;
name|int
name|res
decl_stmt|;
name|appl_data
operator|=
name|wpabuf_alloc
argument_list|(
name|max_len
operator|+
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|appl_data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|res
operator|=
name|SSL_read
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|wpabuf_mhead
argument_list|(
name|appl_data
argument_list|)
argument_list|,
name|wpabuf_size
argument_list|(
name|appl_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|int
name|err
init|=
name|SSL_get_error
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|res
argument_list|)
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|SSL_ERROR_WANT_READ
operator|||
name|err
operator|==
name|SSL_ERROR_WANT_WRITE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: No Application Data "
literal|"included"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to read possible "
literal|"Application Data"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|appl_data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_put
argument_list|(
name|appl_data
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"SSL: Application Data in Finished "
literal|"message"
argument_list|,
name|appl_data
argument_list|)
expr_stmt|;
return|return
name|appl_data
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|openssl_connection_handshake
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|appl_data
parameter_list|,
name|int
name|server
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|out_data
decl_stmt|;
if|if
condition|(
name|appl_data
condition|)
operator|*
name|appl_data
operator|=
name|NULL
expr_stmt|;
name|out_data
operator|=
name|openssl_handshake
argument_list|(
name|conn
argument_list|,
name|in_data
argument_list|,
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|out_data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|conn
operator|->
name|invalid_hb_used
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Heartbeat attack detected - do not send response"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|out_data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|SSL_is_init_finished
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Handshake finished - resumed=%d"
argument_list|,
name|tls_connection_resumed
argument_list|(
name|conn
operator|->
name|ssl_ctx
argument_list|,
name|conn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|appl_data
operator|&&
name|in_data
condition|)
operator|*
name|appl_data
operator|=
name|openssl_get_appl_data
argument_list|(
name|conn
argument_list|,
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|conn
operator|->
name|invalid_hb_used
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Heartbeat attack detected - do not send response"
argument_list|)
expr_stmt|;
if|if
condition|(
name|appl_data
condition|)
block|{
name|wpabuf_free
argument_list|(
operator|*
name|appl_data
argument_list|)
expr_stmt|;
operator|*
name|appl_data
operator|=
name|NULL
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|out_data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|out_data
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tls_connection_handshake
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|appl_data
parameter_list|)
block|{
return|return
name|openssl_connection_handshake
argument_list|(
name|conn
argument_list|,
name|in_data
argument_list|,
name|appl_data
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tls_connection_server_handshake
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|appl_data
parameter_list|)
block|{
return|return
name|openssl_connection_handshake
argument_list|(
name|conn
argument_list|,
name|in_data
argument_list|,
name|appl_data
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tls_connection_encrypt
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* Give plaintext data for OpenSSL to encrypt into the TLS tunnel. */
if|if
condition|(
operator|(
name|res
operator|=
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_in
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|res
operator|=
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"BIO_reset failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|res
operator|=
name|SSL_write
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|wpabuf_head
argument_list|(
name|in_data
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Encryption failed - SSL_write"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Read encrypted data to be sent to the server */
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
operator|+
literal|300
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|res
operator|=
name|BIO_read
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|,
name|wpabuf_mhead
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_size
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Encryption failed - BIO_read"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tls_connection_decrypt
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
comment|/* Give encrypted data from TLS tunnel for OpenSSL to decrypt. */
name|res
operator|=
name|BIO_write
argument_list|(
name|conn
operator|->
name|ssl_in
argument_list|,
name|wpabuf_head
argument_list|(
name|in_data
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Decryption failed - BIO_write"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|BIO_reset
argument_list|(
name|conn
operator|->
name|ssl_out
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"BIO_reset failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Read decrypted data for further processing */
comment|/* 	 * Even though we try to disable TLS compression, it is possible that 	 * this cannot be done with all TLS libraries. Add extra buffer space 	 * to handle the possibility of the decrypted data being longer than 	 * input data. 	 */
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
operator|(
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
operator|+
literal|500
operator|)
operator|*
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|res
operator|=
name|SSL_read
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|wpabuf_mhead
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_size
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Decryption failed - SSL_read"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|invalid_hb_used
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Heartbeat attack detected - do not send response"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_resumed
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x10001000L
return|return
name|conn
condition|?
name|SSL_cache_hit
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
else|:
literal|0
return|;
else|#
directive|else
return|return
name|conn
condition|?
name|conn
operator|->
name|ssl
operator|->
name|hit
else|:
literal|0
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|tls_connection_set_cipher_list
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|u8
modifier|*
name|ciphers
parameter_list|)
block|{
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
modifier|*
name|c
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|==
name|NULL
operator|||
name|ciphers
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|pos
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|c
operator|=
name|ciphers
expr_stmt|;
while|while
condition|(
operator|*
name|c
operator|!=
name|TLS_CIPHER_NONE
condition|)
block|{
specifier|const
name|char
modifier|*
name|suite
decl_stmt|;
switch|switch
condition|(
operator|*
name|c
condition|)
block|{
case|case
name|TLS_CIPHER_RC4_SHA
case|:
name|suite
operator|=
literal|"RC4-SHA"
expr_stmt|;
break|break;
case|case
name|TLS_CIPHER_AES128_SHA
case|:
name|suite
operator|=
literal|"AES128-SHA"
expr_stmt|;
break|break;
case|case
name|TLS_CIPHER_RSA_DHE_AES128_SHA
case|:
name|suite
operator|=
literal|"DHE-RSA-AES128-SHA"
expr_stmt|;
break|break;
case|case
name|TLS_CIPHER_ANON_DH_AES128_SHA
case|:
name|suite
operator|=
literal|"ADH-AES128-SHA"
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Unsupported "
literal|"cipher selection: %d"
argument_list|,
operator|*
name|c
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|":%s"
argument_list|,
name|suite
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
break|break;
name|pos
operator|+=
name|ret
expr_stmt|;
name|c
operator|++
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: cipher suites: %s"
argument_list|,
name|buf
operator|+
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|>=
literal|0x10100000L
if|#
directive|if
name|defined
argument_list|(
name|EAP_FAST
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_FAST_DYNAMIC
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_SERVER_FAST
argument_list|)
if|if
condition|(
name|os_strstr
argument_list|(
name|buf
argument_list|,
literal|":ADH-"
argument_list|)
condition|)
block|{
comment|/* 		 * Need to drop to security level 0 to allow anonymous 		 * cipher suites for EAP-FAST. 		 */
name|SSL_set_security_level
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SSL_get_security_level
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Force at least security level 1 */
name|SSL_set_security_level
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* EAP_FAST || EAP_FAST_DYNAMIC || EAP_SERVER_FAST */
endif|#
directive|endif
if|if
condition|(
name|SSL_set_cipher_list
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|buf
operator|+
literal|1
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Cipher suite configuration failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_get_version
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|name
operator|=
name|SSL_get_version
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_strlcpy
argument_list|(
name|buf
argument_list|,
name|name
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_get_cipher
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|name
operator|=
name|SSL_get_cipher
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_strlcpy
argument_list|(
name|buf
argument_list|,
name|name
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_enable_workaround
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
name|SSL_set_options
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|SSL_OP_DONT_INSERT_EMPTY_FRAGMENTS
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|EAP_FAST
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_FAST_DYNAMIC
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_SERVER_FAST
argument_list|)
end_if

begin_comment
comment|/* ClientHello TLS extensions require a patch to openssl, so this function is  * commented out unless explicitly needed for EAP-FAST in order to be able to  * build this file with unmodified openssl. */
end_comment

begin_function
name|int
name|tls_connection_client_hello_ext
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|int
name|ext_type
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|ssl
operator|==
name|NULL
operator|||
name|ext_type
operator|!=
literal|35
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|SSL_set_session_ticket_ext
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
operator|(
name|void
operator|*
operator|)
name|data
argument_list|,
name|data_len
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_FAST || EAP_FAST_DYNAMIC || EAP_SERVER_FAST */
end_comment

begin_function
name|int
name|tls_connection_get_failed
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|conn
operator|->
name|failed
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_get_read_alerts
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|conn
operator|->
name|read_alerts
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_get_write_alerts
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|conn
operator|->
name|write_alerts
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_OCSP
end_ifdef

begin_function
specifier|static
name|void
name|ocsp_debug_print_resp
parameter_list|(
name|OCSP_RESPONSE
modifier|*
name|rsp
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_NO_STDOUT_DEBUG
name|BIO
modifier|*
name|out
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
name|char
modifier|*
name|txt
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|wpa_debug_level
operator|>
name|MSG_DEBUG
condition|)
return|return;
name|out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|out
condition|)
return|return;
name|OCSP_RESPONSE_print
argument_list|(
name|out
argument_list|,
name|rsp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rlen
operator|=
name|BIO_ctrl_pending
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|txt
operator|=
name|os_malloc
argument_list|(
name|rlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|txt
condition|)
block|{
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|BIO_read
argument_list|(
name|out
argument_list|,
name|txt
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|txt
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP Response\n%s"
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|txt
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_STDOUT_DEBUG */
block|}
end_function

begin_function
specifier|static
name|void
name|debug_print_cert
parameter_list|(
name|X509
modifier|*
name|cert
parameter_list|,
specifier|const
name|char
modifier|*
name|title
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_NO_STDOUT_DEBUG
name|BIO
modifier|*
name|out
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
name|char
modifier|*
name|txt
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|wpa_debug_level
operator|>
name|MSG_DEBUG
condition|)
return|return;
name|out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|out
condition|)
return|return;
name|X509_print
argument_list|(
name|out
argument_list|,
name|cert
argument_list|)
expr_stmt|;
name|rlen
operator|=
name|BIO_ctrl_pending
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|txt
operator|=
name|os_malloc
argument_list|(
name|rlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|txt
condition|)
block|{
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|BIO_read
argument_list|(
name|out
argument_list|,
name|txt
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|txt
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s\n%s"
argument_list|,
name|title
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|txt
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_STDOUT_DEBUG */
block|}
end_function

begin_function
specifier|static
name|int
name|ocsp_resp_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
name|arg
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|,
name|status
decl_stmt|,
name|reason
decl_stmt|;
name|OCSP_RESPONSE
modifier|*
name|rsp
decl_stmt|;
name|OCSP_BASICRESP
modifier|*
name|basic
decl_stmt|;
name|OCSP_CERTID
modifier|*
name|id
decl_stmt|;
name|ASN1_GENERALIZEDTIME
modifier|*
name|produced_at
decl_stmt|,
modifier|*
name|this_update
decl_stmt|,
modifier|*
name|next_update
decl_stmt|;
name|X509_STORE
modifier|*
name|store
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|certs
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
name|SSL_get_tlsext_status_ocsp_resp
argument_list|(
name|s
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: No OCSP response received"
argument_list|)
expr_stmt|;
return|return
operator|(
name|conn
operator|->
name|flags
operator|&
name|TLS_CONN_REQUIRE_OCSP
operator|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP response"
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|d2i_OCSP_RESPONSE
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsp
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: Failed to parse OCSP response"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ocsp_debug_print_resp
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
name|status
operator|=
name|OCSP_response_status
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|OCSP_RESPONSE_STATUS_SUCCESSFUL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: OCSP responder error %d (%s)"
argument_list|,
name|status
argument_list|,
name|OCSP_response_status_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|basic
operator|=
name|OCSP_response_get1_basic
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|basic
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: Could not find BasicOCSPResponse"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|store
operator|=
name|SSL_CTX_get_cert_store
argument_list|(
name|conn
operator|->
name|ssl_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|peer_issuer
condition|)
block|{
name|debug_print_cert
argument_list|(
name|conn
operator|->
name|peer_issuer
argument_list|,
literal|"Add OCSP issuer"
argument_list|)
expr_stmt|;
if|if
condition|(
name|X509_STORE_add_cert
argument_list|(
name|store
argument_list|,
name|conn
operator|->
name|peer_issuer
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"OpenSSL: Could not add issuer to certificate store"
argument_list|)
expr_stmt|;
block|}
name|certs
operator|=
name|sk_X509_new_null
argument_list|()
expr_stmt|;
if|if
condition|(
name|certs
condition|)
block|{
name|X509
modifier|*
name|cert
decl_stmt|;
name|cert
operator|=
name|X509_dup
argument_list|(
name|conn
operator|->
name|peer_issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|&&
operator|!
name|sk_X509_push
argument_list|(
name|certs
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"OpenSSL: Could not add issuer to OCSP responder trust store"
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|sk_X509_free
argument_list|(
name|certs
argument_list|)
expr_stmt|;
name|certs
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|certs
operator|&&
name|conn
operator|->
name|peer_issuer_issuer
condition|)
block|{
name|cert
operator|=
name|X509_dup
argument_list|(
name|conn
operator|->
name|peer_issuer_issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|&&
operator|!
name|sk_X509_push
argument_list|(
name|certs
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"OpenSSL: Could not add issuer's issuer to OCSP responder trust store"
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|status
operator|=
name|OCSP_basic_verify
argument_list|(
name|basic
argument_list|,
name|certs
argument_list|,
name|store
argument_list|,
name|OCSP_TRUSTOTHER
argument_list|)
expr_stmt|;
name|sk_X509_pop_free
argument_list|(
name|certs
argument_list|,
name|X509_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|<=
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"OpenSSL: OCSP response failed verification"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP response verification succeeded"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conn
operator|->
name|peer_cert
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Peer certificate not available for OCSP status check"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|conn
operator|->
name|peer_issuer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Peer issuer certificate not available for OCSP status check"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|id
operator|=
name|OCSP_cert_to_id
argument_list|(
name|NULL
argument_list|,
name|conn
operator|->
name|peer_cert
argument_list|,
name|conn
operator|->
name|peer_issuer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Could not create OCSP certificate identifier"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|OCSP_resp_find_status
argument_list|(
name|basic
argument_list|,
name|id
argument_list|,
operator|&
name|status
argument_list|,
operator|&
name|reason
argument_list|,
operator|&
name|produced_at
argument_list|,
operator|&
name|this_update
argument_list|,
operator|&
name|next_update
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: Could not find current server certificate from OCSP response%s"
argument_list|,
operator|(
name|conn
operator|->
name|flags
operator|&
name|TLS_CONN_REQUIRE_OCSP
operator|)
condition|?
literal|""
else|:
literal|" (OCSP not required)"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
return|return
operator|(
name|conn
operator|->
name|flags
operator|&
name|TLS_CONN_REQUIRE_OCSP
operator|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|OCSP_check_validity
argument_list|(
name|this_update
argument_list|,
name|next_update
argument_list|,
literal|5
operator|*
literal|60
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"OpenSSL: OCSP status times invalid"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP status for server certificate: %s"
argument_list|,
name|OCSP_cert_status_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|V_OCSP_CERTSTATUS_GOOD
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|status
operator|==
name|V_OCSP_CERTSTATUS_REVOKED
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|conn
operator|->
name|flags
operator|&
name|TLS_CONN_REQUIRE_OCSP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP status unknown, but OCSP required"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP status unknown, but OCSP was not required, so allow connection to continue"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ocsp_status_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|;
name|char
modifier|*
name|resp
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|tls_global
operator|->
name|ocsp_stapling_response
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP status callback - no response configured"
argument_list|)
expr_stmt|;
return|return
name|SSL_TLSEXT_ERR_OK
return|;
block|}
name|resp
operator|=
name|os_readfile
argument_list|(
name|tls_global
operator|->
name|ocsp_stapling_response
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP status callback - could not read response file"
argument_list|)
expr_stmt|;
comment|/* TODO: Build OCSPResponse with responseStatus = internalError 		 */
return|return
name|SSL_TLSEXT_ERR_OK
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP status callback - send cached response"
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|OPENSSL_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
name|SSL_TLSEXT_ERR_ALERT_FATAL
return|;
block|}
name|os_memcpy
argument_list|(
name|tmp
argument_list|,
name|resp
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|SSL_set_tlsext_status_ocsp_resp
argument_list|(
name|s
argument_list|,
name|tmp
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
name|SSL_TLSEXT_ERR_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_OCSP */
end_comment

begin_function
name|int
name|tls_connection_set_params
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|tls_connection_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|tls_data
modifier|*
name|data
init|=
name|tls_ctx
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|unsigned
name|long
name|err
decl_stmt|;
name|int
name|can_pkcs11
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|key_id
init|=
name|params
operator|->
name|key_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|cert_id
init|=
name|params
operator|->
name|cert_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|ca_cert_id
init|=
name|params
operator|->
name|ca_cert_id
decl_stmt|;
specifier|const
name|char
modifier|*
name|engine_id
init|=
name|params
operator|->
name|engine
condition|?
name|params
operator|->
name|engine_id
else|:
name|NULL
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* 	 * If the engine isn't explicitly configured, and any of the 	 * cert/key fields are actually PKCS#11 URIs, then automatically 	 * use the PKCS#11 ENGINE. 	 */
if|if
condition|(
operator|!
name|engine_id
operator|||
name|os_strcmp
argument_list|(
name|engine_id
argument_list|,
literal|"pkcs11"
argument_list|)
operator|==
literal|0
condition|)
name|can_pkcs11
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|key_id
operator|&&
name|params
operator|->
name|private_key
operator|&&
name|can_pkcs11
operator|&&
name|os_strncmp
argument_list|(
name|params
operator|->
name|private_key
argument_list|,
literal|"pkcs11:"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|can_pkcs11
operator|=
literal|2
expr_stmt|;
name|key_id
operator|=
name|params
operator|->
name|private_key
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cert_id
operator|&&
name|params
operator|->
name|client_cert
operator|&&
name|can_pkcs11
operator|&&
name|os_strncmp
argument_list|(
name|params
operator|->
name|client_cert
argument_list|,
literal|"pkcs11:"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|can_pkcs11
operator|=
literal|2
expr_stmt|;
name|cert_id
operator|=
name|params
operator|->
name|client_cert
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ca_cert_id
operator|&&
name|params
operator|->
name|ca_cert
operator|&&
name|can_pkcs11
operator|&&
name|os_strncmp
argument_list|(
name|params
operator|->
name|ca_cert
argument_list|,
literal|"pkcs11:"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|can_pkcs11
operator|=
literal|2
expr_stmt|;
name|ca_cert_id
operator|=
name|params
operator|->
name|ca_cert
expr_stmt|;
block|}
comment|/* If we need to automatically enable the PKCS#11 ENGINE, do so. */
if|if
condition|(
name|can_pkcs11
operator|==
literal|2
operator|&&
operator|!
name|engine_id
condition|)
name|engine_id
operator|=
literal|"pkcs11"
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|EAP_FAST
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_FAST_DYNAMIC
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_SERVER_FAST
argument_list|)
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|<
literal|0x10100000L
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|TLS_CONN_EAP_FAST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Use TLSv1_method() for EAP-FAST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|SSL_set_ssl_method
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|TLSv1_method
argument_list|()
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|MSG_INFO
argument_list|,
name|__func__
argument_list|,
literal|"Failed to set TLSv1_method() for EAP-FAST"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
endif|#
directive|endif
endif|#
directive|endif
comment|/* EAP_FAST || EAP_FAST_DYNAMIC || EAP_SERVER_FAST */
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s: Clearing pending SSL error: %s"
argument_list|,
name|__func__
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|engine_id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SSL: Initializing TLS engine"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|tls_engine_init
argument_list|(
name|conn
argument_list|,
name|engine_id
argument_list|,
name|params
operator|->
name|pin
argument_list|,
name|key_id
argument_list|,
name|cert_id
argument_list|,
name|ca_cert_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
if|if
condition|(
name|tls_connection_set_subject_match
argument_list|(
name|conn
argument_list|,
name|params
operator|->
name|subject_match
argument_list|,
name|params
operator|->
name|altsubject_match
argument_list|,
name|params
operator|->
name|suffix_match
argument_list|,
name|params
operator|->
name|domain_match
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|engine_id
operator|&&
name|ca_cert_id
condition|)
block|{
if|if
condition|(
name|tls_connection_engine_ca_cert
argument_list|(
name|data
argument_list|,
name|conn
argument_list|,
name|ca_cert_id
argument_list|)
condition|)
return|return
name|TLS_SET_PARAMS_ENGINE_PRV_VERIFY_FAILED
return|;
block|}
elseif|else
if|if
condition|(
name|tls_connection_ca_cert
argument_list|(
name|data
argument_list|,
name|conn
argument_list|,
name|params
operator|->
name|ca_cert
argument_list|,
name|params
operator|->
name|ca_cert_blob
argument_list|,
name|params
operator|->
name|ca_cert_blob_len
argument_list|,
name|params
operator|->
name|ca_path
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|engine_id
operator|&&
name|cert_id
condition|)
block|{
if|if
condition|(
name|tls_connection_engine_client_cert
argument_list|(
name|conn
argument_list|,
name|cert_id
argument_list|)
condition|)
return|return
name|TLS_SET_PARAMS_ENGINE_PRV_VERIFY_FAILED
return|;
block|}
elseif|else
if|if
condition|(
name|tls_connection_client_cert
argument_list|(
name|conn
argument_list|,
name|params
operator|->
name|client_cert
argument_list|,
name|params
operator|->
name|client_cert_blob
argument_list|,
name|params
operator|->
name|client_cert_blob_len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|engine_id
operator|&&
name|key_id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLS: Using private key from engine"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_connection_engine_private_key
argument_list|(
name|conn
argument_list|)
condition|)
return|return
name|TLS_SET_PARAMS_ENGINE_PRV_VERIFY_FAILED
return|;
block|}
elseif|else
if|if
condition|(
name|tls_connection_private_key
argument_list|(
name|data
argument_list|,
name|conn
argument_list|,
name|params
operator|->
name|private_key
argument_list|,
name|params
operator|->
name|private_key_passwd
argument_list|,
name|params
operator|->
name|private_key_blob
argument_list|,
name|params
operator|->
name|private_key_blob_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to load private key '%s'"
argument_list|,
name|params
operator|->
name|private_key
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tls_connection_dh
argument_list|(
name|conn
argument_list|,
name|params
operator|->
name|dh_file
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to load DH file '%s'"
argument_list|,
name|params
operator|->
name|dh_file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|openssl_ciphers
operator|&&
name|SSL_set_cipher_list
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|params
operator|->
name|openssl_ciphers
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: Failed to set cipher string '%s'"
argument_list|,
name|params
operator|->
name|openssl_ciphers
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tls_set_conn_flags
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|params
operator|->
name|flags
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_OCSP
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|TLS_CONN_REQUEST_OCSP
condition|)
block|{
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|data
operator|->
name|ssl
decl_stmt|;
name|SSL_set_tlsext_status_type
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|TLSEXT_STATUSTYPE_ocsp
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_status_cb
argument_list|(
name|ssl_ctx
argument_list|,
name|ocsp_resp_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_status_arg
argument_list|(
name|ssl_ctx
argument_list|,
name|conn
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* HAVE_OCSP */
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|TLS_CONN_REQUIRE_OCSP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: No OCSP support included - reject configuration"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|TLS_CONN_REQUEST_OCSP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: No OCSP support included - allow optional OCSP case to continue"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* HAVE_OCSP */
name|conn
operator|->
name|flags
operator|=
name|params
operator|->
name|flags
expr_stmt|;
name|tls_get_errors
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_global_set_params
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
specifier|const
name|struct
name|tls_connection_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|tls_data
modifier|*
name|data
init|=
name|tls_ctx
decl_stmt|;
name|SSL_CTX
modifier|*
name|ssl_ctx
init|=
name|data
operator|->
name|ssl
decl_stmt|;
name|unsigned
name|long
name|err
decl_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s: Clearing pending SSL error: %s"
argument_list|,
name|__func__
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tls_global_ca_cert
argument_list|(
name|data
argument_list|,
name|params
operator|->
name|ca_cert
argument_list|)
operator|||
name|tls_global_client_cert
argument_list|(
name|data
argument_list|,
name|params
operator|->
name|client_cert
argument_list|)
operator|||
name|tls_global_private_key
argument_list|(
name|data
argument_list|,
name|params
operator|->
name|private_key
argument_list|,
name|params
operator|->
name|private_key_passwd
argument_list|)
operator|||
name|tls_global_dh
argument_list|(
name|data
argument_list|,
name|params
operator|->
name|dh_file
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLS: Failed to set global parameters"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|params
operator|->
name|openssl_ciphers
operator|&&
name|SSL_CTX_set_cipher_list
argument_list|(
name|ssl_ctx
argument_list|,
name|params
operator|->
name|openssl_ciphers
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: Failed to set cipher string '%s'"
argument_list|,
name|params
operator|->
name|openssl_ciphers
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|SSL_OP_NO_TICKET
if|if
condition|(
name|params
operator|->
name|flags
operator|&
name|TLS_CONN_DISABLE_SESSION_TICKET
condition|)
name|SSL_CTX_set_options
argument_list|(
name|ssl_ctx
argument_list|,
name|SSL_OP_NO_TICKET
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|SSL_CTX_clear_options
else|else
name|SSL_CTX_clear_options
argument_list|(
name|ssl_ctx
argument_list|,
name|SSL_OP_NO_TICKET
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* SSL_clear_options */
endif|#
directive|endif
comment|/*  SSL_OP_NO_TICKET */
ifdef|#
directive|ifdef
name|HAVE_OCSP
name|SSL_CTX_set_tlsext_status_cb
argument_list|(
name|ssl_ctx
argument_list|,
name|ocsp_status_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_status_arg
argument_list|(
name|ssl_ctx
argument_list|,
name|ssl_ctx
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tls_global
operator|->
name|ocsp_stapling_response
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|ocsp_stapling_response
condition|)
name|tls_global
operator|->
name|ocsp_stapling_response
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|ocsp_stapling_response
argument_list|)
expr_stmt|;
else|else
name|tls_global
operator|->
name|ocsp_stapling_response
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_OCSP */
return|return
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|EAP_FAST
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_FAST_DYNAMIC
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_SERVER_FAST
argument_list|)
end_if

begin_comment
comment|/* Pre-shared secred requires a patch to openssl, so this function is  * commented out unless explicitly needed for EAP-FAST in order to be able to  * build this file with unmodified openssl. */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|OPENSSL_IS_BORINGSSL
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|tls_sess_sec_cb
argument_list|(
name|SSL
operator|*
name|s
argument_list|,
name|void
operator|*
name|secret
argument_list|,
name|int
operator|*
name|secret_len
argument_list|,
name|STACK_OF
argument_list|(
name|SSL_CIPHER
argument_list|)
operator|*
name|peer_ciphers
argument_list|,
specifier|const
name|SSL_CIPHER
operator|*
operator|*
name|cipher
argument_list|,
name|void
operator|*
name|arg
argument_list|)
else|#
directive|else
comment|/* OPENSSL_IS_BORINGSSL */
decl|static
name|int
name|tls_sess_sec_cb
argument_list|(
name|SSL
operator|*
name|s
argument_list|,
name|void
operator|*
name|secret
argument_list|,
name|int
operator|*
name|secret_len
argument_list|,
name|STACK_OF
argument_list|(
name|SSL_CIPHER
argument_list|)
operator|*
name|peer_ciphers
argument_list|,
name|SSL_CIPHER
operator|*
operator|*
name|cipher
argument_list|,
name|void
operator|*
name|arg
argument_list|)
endif|#
directive|endif
comment|/* OPENSSL_IS_BORINGSSL */
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
name|arg
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|#
directive|if
name|OPENSSL_VERSION_NUMBER
operator|<
literal|0x10100000L
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|session_ticket_cb
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|conn
operator|->
name|session_ticket_cb
argument_list|(
name|conn
operator|->
name|session_ticket_cb_ctx
argument_list|,
name|conn
operator|->
name|session_ticket
argument_list|,
name|conn
operator|->
name|session_ticket_len
argument_list|,
name|s
operator|->
name|s3
operator|->
name|client_random
argument_list|,
name|s
operator|->
name|s3
operator|->
name|server_random
argument_list|,
name|secret
argument_list|)
expr_stmt|;
else|#
directive|else
name|unsigned
name|char
name|client_random
index|[
name|SSL3_RANDOM_SIZE
index|]
decl_stmt|;
name|unsigned
name|char
name|server_random
index|[
name|SSL3_RANDOM_SIZE
index|]
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|session_ticket_cb
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|SSL_get_client_random
argument_list|(
name|s
argument_list|,
name|client_random
argument_list|,
sizeof|sizeof
argument_list|(
name|client_random
argument_list|)
argument_list|)
expr_stmt|;
name|SSL_get_server_random
argument_list|(
name|s
argument_list|,
name|server_random
argument_list|,
sizeof|sizeof
argument_list|(
name|server_random
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|conn
operator|->
name|session_ticket_cb
argument_list|(
name|conn
operator|->
name|session_ticket_cb_ctx
argument_list|,
name|conn
operator|->
name|session_ticket
argument_list|,
name|conn
operator|->
name|session_ticket_len
argument_list|,
name|client_random
argument_list|,
name|server_random
argument_list|,
name|secret
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|os_free
argument_list|(
name|conn
operator|->
name|session_ticket
argument_list|)
expr_stmt|;
name|conn
operator|->
name|session_ticket
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
return|return
literal|0
return|;
operator|*
name|secret_len
operator|=
name|SSL_MAX_MASTER_KEY_LENGTH
expr_stmt|;
return|return
literal|1
return|;
block|}
end_decl_stmt

begin_function
specifier|static
name|int
name|tls_session_ticket_ext_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
name|arg
decl_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|conn
operator|->
name|session_ticket_cb
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s: length=%d"
argument_list|,
name|__func__
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|session_ticket
argument_list|)
expr_stmt|;
name|conn
operator|->
name|session_ticket
operator|=
name|NULL
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: ClientHello SessionTicket "
literal|"extension"
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|conn
operator|->
name|session_ticket
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|session_ticket
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|os_memcpy
argument_list|(
name|conn
operator|->
name|session_ticket
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|conn
operator|->
name|session_ticket_len
operator|=
name|len
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_FAST || EAP_FAST_DYNAMIC || EAP_SERVER_FAST */
end_comment

begin_function
name|int
name|tls_connection_set_session_ticket_cb
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|tls_session_ticket_cb
name|cb
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|EAP_FAST
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_FAST_DYNAMIC
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_SERVER_FAST
argument_list|)
name|conn
operator|->
name|session_ticket_cb
operator|=
name|cb
expr_stmt|;
name|conn
operator|->
name|session_ticket_cb_ctx
operator|=
name|ctx
expr_stmt|;
if|if
condition|(
name|cb
condition|)
block|{
if|if
condition|(
name|SSL_set_session_secret_cb
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|tls_sess_sec_cb
argument_list|,
name|conn
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|SSL_set_session_ticket_ext_cb
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|tls_session_ticket_ext_cb
argument_list|,
name|conn
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|SSL_set_session_secret_cb
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
literal|1
condition|)
return|return
operator|-
literal|1
return|;
name|SSL_set_session_ticket_ext_cb
argument_list|(
name|conn
operator|->
name|ssl
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* EAP_FAST || EAP_FAST_DYNAMIC || EAP_SERVER_FAST */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* EAP_FAST || EAP_FAST_DYNAMIC || EAP_SERVER_FAST */
block|}
end_function

begin_function
name|int
name|tls_get_library_version
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|)
block|{
return|return
name|os_snprintf
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|,
literal|"OpenSSL build=%s run=%s"
argument_list|,
name|OPENSSL_VERSION_TEXT
argument_list|,
name|SSLeay_version
argument_list|(
name|SSLEAY_VERSION
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|tls_connection_set_success_data
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|data
parameter_list|)
block|{
name|SSL_SESSION
modifier|*
name|sess
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|old
decl_stmt|;
if|if
condition|(
name|tls_ex_idx_session
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sess
operator|=
name|SSL_get_session
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sess
condition|)
goto|goto
name|fail
goto|;
name|old
operator|=
name|SSL_SESSION_get_ex_data
argument_list|(
name|sess
argument_list|,
name|tls_ex_idx_session
argument_list|)
expr_stmt|;
if|if
condition|(
name|old
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Replacing old success data %p"
argument_list|,
name|old
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|old
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SSL_SESSION_set_ex_data
argument_list|(
name|sess
argument_list|,
name|tls_ex_idx_session
argument_list|,
name|data
argument_list|)
operator|!=
literal|1
condition|)
goto|goto
name|fail
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Stored success data %p"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|conn
operator|->
name|success_data
operator|=
literal|1
expr_stmt|;
return|return;
name|fail
label|:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: Failed to store success data"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|tls_connection_set_success_data_resumed
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Success data accepted for resumed session"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|success_data
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|const
name|struct
name|wpabuf
modifier|*
name|tls_connection_get_success_data
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
name|SSL_SESSION
modifier|*
name|sess
decl_stmt|;
if|if
condition|(
name|tls_ex_idx_session
operator|<
literal|0
operator|||
operator|!
operator|(
name|sess
operator|=
name|SSL_get_session
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
operator|)
condition|)
return|return
name|NULL
return|;
return|return
name|SSL_SESSION_get_ex_data
argument_list|(
name|sess
argument_list|,
name|tls_ex_idx_session
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|tls_connection_remove_session
parameter_list|(
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
name|SSL_SESSION
modifier|*
name|sess
decl_stmt|;
name|sess
operator|=
name|SSL_get_session
argument_list|(
name|conn
operator|->
name|ssl
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sess
condition|)
return|return;
if|if
condition|(
name|SSL_CTX_remove_session
argument_list|(
name|conn
operator|->
name|ssl_ctx
argument_list|,
name|sess
argument_list|)
operator|!=
literal|1
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Session was not cached"
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Removed cached session to disable session resumption"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * SSL/TLS interface functions for NSS  * Copyright (c) 2009, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<nspr/prtypes.h>
end_include

begin_include
include|#
directive|include
file|<nspr/plarenas.h>
end_include

begin_include
include|#
directive|include
file|<nspr/plhash.h>
end_include

begin_include
include|#
directive|include
file|<nspr/prio.h>
end_include

begin_include
include|#
directive|include
file|<nspr/prclist.h>
end_include

begin_include
include|#
directive|include
file|<nspr/prlock.h>
end_include

begin_include
include|#
directive|include
file|<nspr/prinit.h>
end_include

begin_include
include|#
directive|include
file|<nspr/prerror.h>
end_include

begin_include
include|#
directive|include
file|<nspr/prmem.h>
end_include

begin_include
include|#
directive|include
file|<nss/nss.h>
end_include

begin_include
include|#
directive|include
file|<nss/nssilckt.h>
end_include

begin_include
include|#
directive|include
file|<nss/ssl.h>
end_include

begin_include
include|#
directive|include
file|<nss/pk11func.h>
end_include

begin_include
include|#
directive|include
file|<nss/secerr.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"tls.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|tls_nss_ref_count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|PRDescIdentity
name|nss_layer_id
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|tls_connection
block|{
name|PRFileDesc
modifier|*
name|fd
decl_stmt|;
name|int
name|established
decl_stmt|;
name|int
name|verify_peer
decl_stmt|;
name|u8
modifier|*
name|push_buf
decl_stmt|,
modifier|*
name|pull_buf
decl_stmt|,
modifier|*
name|pull_buf_offset
decl_stmt|;
name|size_t
name|push_buf_len
decl_stmt|,
name|pull_buf_len
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|PRStatus
name|nss_io_close
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O close"
argument_list|)
expr_stmt|;
return|return
name|PR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|PRInt32
name|nss_io_read
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|PRInt32
name|amount
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O read(%d)"
argument_list|,
name|amount
argument_list|)
expr_stmt|;
return|return
name|PR_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|PRInt32
name|nss_io_write
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|PRInt32
name|amount
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O write(%d)"
argument_list|,
name|amount
argument_list|)
expr_stmt|;
return|return
name|PR_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|PRInt32
name|nss_io_writev
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|,
specifier|const
name|PRIOVec
modifier|*
name|iov
parameter_list|,
name|PRInt32
name|iov_size
parameter_list|,
name|PRIntervalTime
name|timeout
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O writev(%d)"
argument_list|,
name|iov_size
argument_list|)
expr_stmt|;
return|return
name|PR_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|PRInt32
name|nss_io_recv
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|PRInt32
name|amount
parameter_list|,
name|PRIntn
name|flags
parameter_list|,
name|PRIntervalTime
name|timeout
parameter_list|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
operator|(
expr|struct
name|tls_connection
operator|*
operator|)
name|fd
operator|->
name|secret
decl_stmt|;
name|u8
modifier|*
name|end
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O recv(%d)"
argument_list|,
name|amount
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|pull_buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: No data available to be read yet"
argument_list|)
expr_stmt|;
return|return
name|PR_FAILURE
return|;
block|}
name|end
operator|=
name|conn
operator|->
name|pull_buf
operator|+
name|conn
operator|->
name|pull_buf_len
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|conn
operator|->
name|pull_buf_offset
operator|<
name|amount
condition|)
name|amount
operator|=
name|end
operator|-
name|conn
operator|->
name|pull_buf_offset
expr_stmt|;
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|conn
operator|->
name|pull_buf_offset
argument_list|,
name|amount
argument_list|)
expr_stmt|;
name|conn
operator|->
name|pull_buf_offset
operator|+=
name|amount
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|pull_buf_offset
operator|==
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - pull_buf consumed"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|pull_buf
argument_list|)
expr_stmt|;
name|conn
operator|->
name|pull_buf
operator|=
name|conn
operator|->
name|pull_buf_offset
operator|=
name|NULL
expr_stmt|;
name|conn
operator|->
name|pull_buf_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - %lu bytes remaining in pull_buf"
argument_list|,
name|__func__
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|end
operator|-
name|conn
operator|->
name|pull_buf_offset
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|amount
return|;
block|}
end_function

begin_function
specifier|static
name|PRInt32
name|nss_io_send
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|PRInt32
name|amount
parameter_list|,
name|PRIntn
name|flags
parameter_list|,
name|PRIntervalTime
name|timeout
parameter_list|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
operator|(
expr|struct
name|tls_connection
operator|*
operator|)
name|fd
operator|->
name|secret
decl_stmt|;
name|u8
modifier|*
name|nbuf
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"NSS: I/O send data"
argument_list|,
name|buf
argument_list|,
name|amount
argument_list|)
expr_stmt|;
name|nbuf
operator|=
name|os_realloc
argument_list|(
name|conn
operator|->
name|push_buf
argument_list|,
name|conn
operator|->
name|push_buf_len
operator|+
name|amount
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbuf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NSS: Failed to allocate memory for the "
literal|"data to be sent"
argument_list|)
expr_stmt|;
return|return
name|PR_FAILURE
return|;
block|}
name|os_memcpy
argument_list|(
name|nbuf
operator|+
name|conn
operator|->
name|push_buf_len
argument_list|,
name|buf
argument_list|,
name|amount
argument_list|)
expr_stmt|;
name|conn
operator|->
name|push_buf
operator|=
name|nbuf
expr_stmt|;
name|conn
operator|->
name|push_buf_len
operator|+=
name|amount
expr_stmt|;
return|return
name|amount
return|;
block|}
end_function

begin_function
specifier|static
name|PRInt32
name|nss_io_recvfrom
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|PRInt32
name|amount
parameter_list|,
name|PRIntn
name|flags
parameter_list|,
name|PRNetAddr
modifier|*
name|addr
parameter_list|,
name|PRIntervalTime
name|timeout
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|PR_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|PRInt32
name|nss_io_sendto
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|,
specifier|const
name|void
modifier|*
name|buf
parameter_list|,
name|PRInt32
name|amount
parameter_list|,
name|PRIntn
name|flags
parameter_list|,
specifier|const
name|PRNetAddr
modifier|*
name|addr
parameter_list|,
name|PRIntervalTime
name|timeout
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|PR_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|PRStatus
name|nss_io_getpeername
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|,
name|PRNetAddr
modifier|*
name|addr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O getpeername"
argument_list|)
expr_stmt|;
comment|/* 	 * It Looks like NSS only supports IPv4 and IPv6 TCP sockets. Provide a 	 * fake IPv4 address to work around this even though we are not really 	 * using TCP. 	 */
name|os_memset
argument_list|(
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|->
name|inet
operator|.
name|family
operator|=
name|PR_AF_INET
expr_stmt|;
return|return
name|PR_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|PRStatus
name|nss_io_getsocketoption
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|,
name|PRSocketOptionData
modifier|*
name|data
parameter_list|)
block|{
switch|switch
condition|(
name|data
operator|->
name|option
condition|)
block|{
case|case
name|PR_SockOpt_Nonblocking
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O getsocketoption(Nonblocking)"
argument_list|)
expr_stmt|;
name|data
operator|->
name|value
operator|.
name|non_blocking
operator|=
name|PR_TRUE
expr_stmt|;
return|return
name|PR_SUCCESS
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: I/O getsocketoption(%d)"
argument_list|,
name|data
operator|->
name|option
argument_list|)
expr_stmt|;
return|return
name|PR_FAILURE
return|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|PRIOMethods
name|nss_io
init|=
block|{
name|PR_DESC_LAYERED
block|,
name|nss_io_close
block|,
name|nss_io_read
block|,
name|nss_io_write
block|,
name|NULL
comment|/* available */
block|,
name|NULL
comment|/* available64 */
block|,
name|NULL
comment|/* fsync */
block|,
name|NULL
comment|/* fseek */
block|,
name|NULL
comment|/* fseek64 */
block|,
name|NULL
comment|/* fileinfo */
block|,
name|NULL
comment|/* fileinfo64 */
block|,
name|nss_io_writev
block|,
name|NULL
comment|/* connect */
block|,
name|NULL
comment|/* accept */
block|,
name|NULL
comment|/* bind */
block|,
name|NULL
comment|/* listen */
block|,
name|NULL
comment|/* shutdown */
block|,
name|nss_io_recv
block|,
name|nss_io_send
block|,
name|nss_io_recvfrom
block|,
name|nss_io_sendto
block|,
name|NULL
comment|/* poll */
block|,
name|NULL
comment|/* acceptread */
block|,
name|NULL
comment|/* transmitfile */
block|,
name|NULL
comment|/* getsockname */
block|,
name|nss_io_getpeername
block|,
name|NULL
comment|/* reserved_fn_6 */
block|,
name|NULL
comment|/* reserved_fn_5 */
block|,
name|nss_io_getsocketoption
block|,
name|NULL
comment|/* setsocketoption */
block|,
name|NULL
comment|/* sendfile */
block|,
name|NULL
comment|/* connectcontinue */
block|,
name|NULL
comment|/* reserved_fn_3 */
block|,
name|NULL
comment|/* reserved_fn_2 */
block|,
name|NULL
comment|/* reserved_fn_1 */
block|,
name|NULL
comment|/* reserved_fn_0 */
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|char
modifier|*
name|nss_password_cb
parameter_list|(
name|PK11SlotInfo
modifier|*
name|slot
parameter_list|,
name|PRBool
name|retry
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NSS: TODO - %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|tls_init
parameter_list|(
specifier|const
name|struct
name|tls_config
modifier|*
name|conf
parameter_list|)
block|{
name|char
modifier|*
name|dir
decl_stmt|;
name|tls_nss_ref_count
operator|++
expr_stmt|;
if|if
condition|(
name|tls_nss_ref_count
operator|>
literal|1
condition|)
return|return
operator|(
name|void
operator|*
operator|)
literal|1
return|;
name|PR_Init
argument_list|(
name|PR_SYSTEM_THREAD
argument_list|,
name|PR_PRIORITY_NORMAL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|nss_layer_id
operator|=
name|PR_GetUniqueIdentity
argument_list|(
literal|"wpa_supplicant"
argument_list|)
expr_stmt|;
name|PK11_SetPasswordFunc
argument_list|(
name|nss_password_cb
argument_list|)
expr_stmt|;
name|dir
operator|=
name|getenv
argument_list|(
literal|"SSL_DIR"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
condition|)
block|{
if|if
condition|(
name|NSS_Init
argument_list|(
name|dir
argument_list|)
operator|!=
name|SECSuccess
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NSS: NSS_Init(cert_dir=%s) "
literal|"failed"
argument_list|,
name|dir
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|NSS_NoDB_Init
argument_list|(
name|NULL
argument_list|)
operator|!=
name|SECSuccess
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NSS: NSS_NoDB_Init(NULL) "
literal|"failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|SSL_OptionSetDefault
argument_list|(
name|SSL_V2_COMPATIBLE_HELLO
argument_list|,
name|PR_FALSE
argument_list|)
operator|!=
name|SECSuccess
operator|||
name|SSL_OptionSetDefault
argument_list|(
name|SSL_ENABLE_SSL3
argument_list|,
name|PR_FALSE
argument_list|)
operator|!=
name|SECSuccess
operator|||
name|SSL_OptionSetDefault
argument_list|(
name|SSL_ENABLE_SSL2
argument_list|,
name|PR_FALSE
argument_list|)
operator|!=
name|SECSuccess
operator|||
name|SSL_OptionSetDefault
argument_list|(
name|SSL_ENABLE_TLS
argument_list|,
name|PR_TRUE
argument_list|)
operator|!=
name|SECSuccess
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NSS: SSL_OptionSetDefault failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|NSS_SetDomesticPolicy
argument_list|()
operator|!=
name|SECSuccess
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NSS: NSS_SetDomesticPolicy() failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
operator|(
name|void
operator|*
operator|)
literal|1
return|;
block|}
end_function

begin_function
name|void
name|tls_deinit
parameter_list|(
name|void
modifier|*
name|ssl_ctx
parameter_list|)
block|{
name|tls_nss_ref_count
operator|--
expr_stmt|;
if|if
condition|(
name|tls_nss_ref_count
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|NSS_Shutdown
argument_list|()
operator|!=
name|SECSuccess
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NSS: NSS_Shutdown() failed"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|tls_get_errors
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|SECStatus
name|nss_bad_cert_cb
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|PRFileDesc
modifier|*
name|fd
parameter_list|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
name|arg
decl_stmt|;
name|SECStatus
name|res
init|=
name|SECSuccess
decl_stmt|;
name|PRErrorCode
name|err
decl_stmt|;
name|CERTCertificate
modifier|*
name|cert
decl_stmt|;
name|char
modifier|*
name|subject
decl_stmt|,
modifier|*
name|issuer
decl_stmt|;
name|err
operator|=
name|PR_GetError
argument_list|()
expr_stmt|;
if|if
condition|(
name|IS_SEC_ERROR
argument_list|(
name|err
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: Bad Server Certificate (sec err "
literal|"%d)"
argument_list|,
name|err
operator|-
name|SEC_ERROR_BASE
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: Bad Server Certificate (err %d)"
argument_list|,
name|err
argument_list|)
expr_stmt|;
name|cert
operator|=
name|SSL_PeerCertificate
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|subject
operator|=
name|CERT_NameToAscii
argument_list|(
operator|&
name|cert
operator|->
name|subject
argument_list|)
expr_stmt|;
name|issuer
operator|=
name|CERT_NameToAscii
argument_list|(
operator|&
name|cert
operator|->
name|issuer
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: Peer certificate subject='%s' issuer='%s'"
argument_list|,
name|subject
argument_list|,
name|issuer
argument_list|)
expr_stmt|;
name|CERT_DestroyCertificate
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|PR_Free
argument_list|(
name|subject
argument_list|)
expr_stmt|;
name|PR_Free
argument_list|(
name|issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify_peer
condition|)
name|res
operator|=
name|SECFailure
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|nss_handshake_cb
parameter_list|(
name|PRFileDesc
modifier|*
name|fd
parameter_list|,
name|void
modifier|*
name|client_data
parameter_list|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
init|=
name|client_data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: Handshake completed"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|established
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|tls_connection
modifier|*
name|tls_connection_init
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|)
block|{
name|struct
name|tls_connection
modifier|*
name|conn
decl_stmt|;
name|conn
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|conn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|conn
operator|->
name|fd
operator|=
name|PR_CreateIOLayerStub
argument_list|(
name|nss_layer_id
argument_list|,
operator|&
name|nss_io
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|fd
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|conn
operator|->
name|fd
operator|->
name|secret
operator|=
operator|(
name|void
operator|*
operator|)
name|conn
expr_stmt|;
name|conn
operator|->
name|fd
operator|=
name|SSL_ImportFD
argument_list|(
name|NULL
argument_list|,
name|conn
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|fd
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|SSL_OptionSet
argument_list|(
name|conn
operator|->
name|fd
argument_list|,
name|SSL_SECURITY
argument_list|,
name|PR_TRUE
argument_list|)
operator|!=
name|SECSuccess
operator|||
name|SSL_OptionSet
argument_list|(
name|conn
operator|->
name|fd
argument_list|,
name|SSL_HANDSHAKE_AS_CLIENT
argument_list|,
name|PR_TRUE
argument_list|)
operator|!=
name|SECSuccess
operator|||
name|SSL_OptionSet
argument_list|(
name|conn
operator|->
name|fd
argument_list|,
name|SSL_HANDSHAKE_AS_SERVER
argument_list|,
name|PR_FALSE
argument_list|)
operator|!=
name|SECSuccess
operator|||
name|SSL_OptionSet
argument_list|(
name|conn
operator|->
name|fd
argument_list|,
name|SSL_ENABLE_TLS
argument_list|,
name|PR_TRUE
argument_list|)
operator|!=
name|SECSuccess
operator|||
name|SSL_BadCertHook
argument_list|(
name|conn
operator|->
name|fd
argument_list|,
name|nss_bad_cert_cb
argument_list|,
name|conn
argument_list|)
operator|!=
name|SECSuccess
operator|||
name|SSL_HandshakeCallback
argument_list|(
name|conn
operator|->
name|fd
argument_list|,
name|nss_handshake_cb
argument_list|,
name|conn
argument_list|)
operator|!=
name|SECSuccess
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NSS: Failed to set options"
argument_list|)
expr_stmt|;
name|PR_Close
argument_list|(
name|conn
operator|->
name|fd
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|SSL_ResetHandshake
argument_list|(
name|conn
operator|->
name|fd
argument_list|,
name|PR_FALSE
argument_list|)
expr_stmt|;
return|return
name|conn
return|;
block|}
end_function

begin_function
name|void
name|tls_connection_deinit
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
name|PR_Close
argument_list|(
name|conn
operator|->
name|fd
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|push_buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|pull_buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|tls_connection_established
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
name|conn
operator|->
name|established
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_shutdown
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_set_params
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|tls_connection_params
modifier|*
name|params
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NSS: TODO - %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_global_set_params
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
specifier|const
name|struct
name|tls_connection_params
modifier|*
name|params
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_global_set_verify
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|int
name|check_crl
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_set_verify
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|int
name|verify_peer
parameter_list|)
block|{
name|conn
operator|->
name|verify_peer
operator|=
name|verify_peer
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_set_ia
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|int
name|tls_ia
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_get_keys
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|struct
name|tls_keys
modifier|*
name|keys
parameter_list|)
block|{
comment|/* NSS does not export master secret or client/server random. */
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_prf
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
name|int
name|server_random_first
parameter_list|,
name|u8
modifier|*
name|out
parameter_list|,
name|size_t
name|out_len
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
operator|||
name|server_random_first
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"NSS: Unsupported PRF request "
literal|"(server_random_first=%d)"
argument_list|,
name|server_random_first
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|SSL_ExportKeyingMaterial
argument_list|(
name|conn
operator|->
name|fd
argument_list|,
name|label
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|out
argument_list|,
name|out_len
argument_list|)
operator|!=
name|SECSuccess
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"NSS: Failed to use TLS extractor "
literal|"(label='%s' out_len=%d"
argument_list|,
name|label
argument_list|,
operator|(
name|int
operator|)
name|out_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tls_connection_handshake
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|appl_data
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|out_data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: handshake: in_len=%u"
argument_list|,
name|in_data
condition|?
operator|(
name|unsigned
name|int
operator|)
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|appl_data
condition|)
operator|*
name|appl_data
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|in_data
operator|&&
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|conn
operator|->
name|pull_buf
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - %lu bytes remaining in "
literal|"pull_buf"
argument_list|,
name|__func__
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|conn
operator|->
name|pull_buf_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|pull_buf
argument_list|)
expr_stmt|;
block|}
name|conn
operator|->
name|pull_buf
operator|=
name|os_malloc
argument_list|(
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|pull_buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|conn
operator|->
name|pull_buf
argument_list|,
name|wpabuf_head
argument_list|(
name|in_data
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|pull_buf_offset
operator|=
name|conn
operator|->
name|pull_buf
expr_stmt|;
name|conn
operator|->
name|pull_buf_len
operator|=
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
expr_stmt|;
block|}
name|SSL_ForceHandshake
argument_list|(
name|conn
operator|->
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|established
operator|&&
name|conn
operator|->
name|push_buf
operator|==
name|NULL
condition|)
block|{
comment|/* Need to return something to get final TLS ACK. */
name|conn
operator|->
name|push_buf
operator|=
name|os_malloc
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|conn
operator|->
name|push_buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|out_data
operator|=
name|wpabuf_alloc_ext_data
argument_list|(
name|conn
operator|->
name|push_buf
argument_list|,
name|conn
operator|->
name|push_buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|out_data
operator|==
name|NULL
condition|)
name|os_free
argument_list|(
name|conn
operator|->
name|push_buf
argument_list|)
expr_stmt|;
name|conn
operator|->
name|push_buf
operator|=
name|NULL
expr_stmt|;
name|conn
operator|->
name|push_buf_len
operator|=
literal|0
expr_stmt|;
return|return
name|out_data
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tls_connection_server_handshake
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|appl_data
parameter_list|)
block|{
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tls_connection_encrypt
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|)
block|{
name|PRInt32
name|res
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: encrypt %d bytes"
argument_list|,
operator|(
name|int
operator|)
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|=
name|PR_Send
argument_list|(
name|conn
operator|->
name|fd
argument_list|,
name|wpabuf_head
argument_list|(
name|in_data
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"NSS: Encryption failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|conn
operator|->
name|push_buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|buf
operator|=
name|wpabuf_alloc_ext_data
argument_list|(
name|conn
operator|->
name|push_buf
argument_list|,
name|conn
operator|->
name|push_buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
name|os_free
argument_list|(
name|conn
operator|->
name|push_buf
argument_list|)
expr_stmt|;
name|conn
operator|->
name|push_buf
operator|=
name|NULL
expr_stmt|;
name|conn
operator|->
name|push_buf_len
operator|=
literal|0
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tls_connection_decrypt
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|)
block|{
name|PRInt32
name|res
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|out
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: decrypt %d bytes"
argument_list|,
operator|(
name|int
operator|)
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|pull_buf
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - %lu bytes remaining in "
literal|"pull_buf"
argument_list|,
name|__func__
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|conn
operator|->
name|pull_buf_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|pull_buf
argument_list|)
expr_stmt|;
block|}
name|conn
operator|->
name|pull_buf
operator|=
name|os_malloc
argument_list|(
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|pull_buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|conn
operator|->
name|pull_buf
argument_list|,
name|wpabuf_head
argument_list|(
name|in_data
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|pull_buf_offset
operator|=
name|conn
operator|->
name|pull_buf
expr_stmt|;
name|conn
operator|->
name|pull_buf_len
operator|=
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
expr_stmt|;
comment|/* 	 * Even though we try to disable TLS compression, it is possible that 	 * this cannot be done with all TLS libraries. Add extra buffer space 	 * to handle the possibility of the decrypted data being longer than 	 * input data. 	 */
name|out
operator|=
name|wpabuf_alloc
argument_list|(
operator|(
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
operator|+
literal|500
operator|)
operator|*
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|res
operator|=
name|PR_Recv
argument_list|(
name|conn
operator|->
name|fd
argument_list|,
name|wpabuf_mhead
argument_list|(
name|out
argument_list|)
argument_list|,
name|wpabuf_size
argument_list|(
name|out
argument_list|)
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NSS: PR_Recv: %d"
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_put
argument_list|(
name|out
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|out
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_resumed
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_set_cipher_list
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|u8
modifier|*
name|ciphers
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_get_cipher
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_enable_workaround
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_client_hello_ext
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|int
name|ext_type
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_get_failed
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_get_read_alerts
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_get_write_alerts
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_get_keyblock_size
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|tls_capabilities
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tls_connection_ia_send_phase_finished
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|int
name|final
parameter_list|)
block|{
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_ia_final_phase_finished
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_ia_permute_inner_secret
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|tls_connection_set_session_ticket_cb
parameter_list|(
name|void
modifier|*
name|tls_ctx
parameter_list|,
name|struct
name|tls_connection
modifier|*
name|conn
parameter_list|,
name|tls_session_ticket_cb
name|cb
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

end_unit


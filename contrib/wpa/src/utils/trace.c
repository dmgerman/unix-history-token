begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Backtrace debugging  * Copyright (c) 2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"trace.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|WPA_TRACE
end_ifdef

begin_decl_stmt
specifier|static
name|struct
name|dl_list
name|active_references
init|=
block|{
operator|&
name|active_references
block|,
operator|&
name|active_references
block|}
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|WPA_TRACE_BFD
end_ifdef

begin_include
include|#
directive|include
file|<bfd.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__linux__
end_ifdef

begin_include
include|#
directive|include
file|<demangle.h>
end_include

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* __linux__ */
end_comment

begin_include
include|#
directive|include
file|<libiberty/demangle.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __linux__ */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|prg_fname
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|bfd
modifier|*
name|cached_abfd
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|asymbol
modifier|*
modifier|*
name|syms
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|get_prg_fname
parameter_list|(
name|void
parameter_list|)
block|{
name|char
name|exe
index|[
literal|50
index|]
decl_stmt|,
name|fname
index|[
literal|512
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|os_snprintf
argument_list|(
name|exe
argument_list|,
sizeof|sizeof
argument_list|(
name|exe
argument_list|)
operator|-
literal|1
argument_list|,
literal|"/proc/%u/exe"
argument_list|,
name|getpid
argument_list|()
argument_list|)
expr_stmt|;
name|len
operator|=
name|readlink
argument_list|(
name|exe
argument_list|,
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
condition|)
block|{
name|perror
argument_list|(
literal|"readlink"
argument_list|)
expr_stmt|;
return|return;
block|}
name|fname
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|prg_fname
operator|=
name|strdup
argument_list|(
name|fname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|bfd
modifier|*
name|open_bfd
parameter_list|(
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|bfd
modifier|*
name|abfd
decl_stmt|;
name|char
modifier|*
modifier|*
name|matching
decl_stmt|;
name|abfd
operator|=
name|bfd_openr
argument_list|(
name|prg_fname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|abfd
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"bfd_openr failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|bfd_check_format
argument_list|(
name|abfd
argument_list|,
name|bfd_archive
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"bfd_check_format failed"
argument_list|)
expr_stmt|;
name|bfd_close
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|bfd_check_format_matches
argument_list|(
name|abfd
argument_list|,
name|bfd_object
argument_list|,
operator|&
name|matching
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"bfd_check_format_matches failed"
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|matching
argument_list|)
expr_stmt|;
name|bfd_close
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|abfd
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|read_syms
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|)
block|{
name|long
name|storage
decl_stmt|,
name|symcount
decl_stmt|;
name|bfd_boolean
name|dynamic
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|syms
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|bfd_get_file_flags
argument_list|(
name|abfd
argument_list|)
operator|&
name|HAS_SYMS
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No symbols"
argument_list|)
expr_stmt|;
return|return;
block|}
name|storage
operator|=
name|bfd_get_symtab_upper_bound
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|storage
operator|==
literal|0
condition|)
block|{
name|storage
operator|=
name|bfd_get_dynamic_symtab_upper_bound
argument_list|(
name|abfd
argument_list|)
expr_stmt|;
name|dynamic
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|storage
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unknown symtab upper bound"
argument_list|)
expr_stmt|;
return|return;
block|}
name|syms
operator|=
name|malloc
argument_list|(
name|storage
argument_list|)
expr_stmt|;
if|if
condition|(
name|syms
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to allocate memory for symtab "
literal|"(%ld bytes)"
argument_list|,
name|storage
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|dynamic
condition|)
name|symcount
operator|=
name|bfd_canonicalize_dynamic_symtab
argument_list|(
name|abfd
argument_list|,
name|syms
argument_list|)
expr_stmt|;
else|else
name|symcount
operator|=
name|bfd_canonicalize_symtab
argument_list|(
name|abfd
argument_list|,
name|syms
argument_list|)
expr_stmt|;
if|if
condition|(
name|symcount
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to canonicalize %ssymtab"
argument_list|,
name|dynamic
condition|?
literal|"dynamic "
else|:
literal|""
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|syms
argument_list|)
expr_stmt|;
name|syms
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_struct
struct|struct
name|bfd_data
block|{
name|bfd_vma
name|pc
decl_stmt|;
name|bfd_boolean
name|found
decl_stmt|;
specifier|const
name|char
modifier|*
name|filename
decl_stmt|;
specifier|const
name|char
modifier|*
name|function
decl_stmt|;
name|unsigned
name|int
name|line
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|find_addr_sect
parameter_list|(
name|bfd
modifier|*
name|abfd
parameter_list|,
name|asection
modifier|*
name|section
parameter_list|,
name|void
modifier|*
name|obj
parameter_list|)
block|{
name|struct
name|bfd_data
modifier|*
name|data
init|=
name|obj
decl_stmt|;
name|bfd_vma
name|vma
decl_stmt|;
name|bfd_size_type
name|size
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|found
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|bfd_get_section_vma
argument_list|(
name|abfd
argument_list|,
name|section
argument_list|)
operator|)
condition|)
return|return;
name|vma
operator|=
name|bfd_get_section_vma
argument_list|(
name|abfd
argument_list|,
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|pc
operator|<
name|vma
condition|)
return|return;
name|size
operator|=
name|bfd_get_section_size
argument_list|(
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|pc
operator|>=
name|vma
operator|+
name|size
condition|)
return|return;
name|data
operator|->
name|found
operator|=
name|bfd_find_nearest_line
argument_list|(
name|abfd
argument_list|,
name|section
argument_list|,
name|syms
argument_list|,
name|data
operator|->
name|pc
operator|-
name|vma
argument_list|,
operator|&
name|data
operator|->
name|filename
argument_list|,
operator|&
name|data
operator|->
name|function
argument_list|,
operator|&
name|data
operator|->
name|line
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_trace_bfd_addr
parameter_list|(
name|void
modifier|*
name|pc
parameter_list|)
block|{
name|bfd
modifier|*
name|abfd
init|=
name|cached_abfd
decl_stmt|;
name|struct
name|bfd_data
name|data
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|aname
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|filename
decl_stmt|;
if|if
condition|(
name|abfd
operator|==
name|NULL
condition|)
return|return;
name|data
operator|.
name|pc
operator|=
operator|(
name|bfd_vma
operator|)
name|pc
expr_stmt|;
name|data
operator|.
name|found
operator|=
name|FALSE
expr_stmt|;
name|bfd_map_over_sections
argument_list|(
name|abfd
argument_list|,
name|find_addr_sect
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
operator|.
name|found
condition|)
return|return;
do|do
block|{
if|if
condition|(
name|data
operator|.
name|function
condition|)
name|aname
operator|=
name|bfd_demangle
argument_list|(
name|abfd
argument_list|,
name|data
operator|.
name|function
argument_list|,
name|DMGL_ANSI
operator||
name|DMGL_PARAMS
argument_list|)
expr_stmt|;
name|name
operator|=
name|aname
condition|?
name|aname
else|:
name|data
operator|.
name|function
expr_stmt|;
name|filename
operator|=
name|data
operator|.
name|filename
expr_stmt|;
if|if
condition|(
name|filename
condition|)
block|{
name|char
modifier|*
name|end
init|=
name|os_strrchr
argument_list|(
name|filename
argument_list|,
literal|'/'
argument_list|)
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|*
name|filename
operator|&&
operator|*
name|filename
operator|==
name|prg_fname
index|[
name|i
index|]
operator|&&
name|filename
operator|<=
name|end
condition|)
block|{
name|filename
operator|++
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"     %s() %s:%u"
argument_list|,
name|name
argument_list|,
name|filename
argument_list|,
name|data
operator|.
name|line
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|aname
argument_list|)
expr_stmt|;
name|data
operator|.
name|found
operator|=
name|bfd_find_inliner_info
argument_list|(
name|abfd
argument_list|,
operator|&
name|data
operator|.
name|filename
argument_list|,
operator|&
name|data
operator|.
name|function
argument_list|,
operator|&
name|data
operator|.
name|line
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|data
operator|.
name|found
condition|)
do|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|wpa_trace_bfd_addr2func
parameter_list|(
name|void
modifier|*
name|pc
parameter_list|)
block|{
name|bfd
modifier|*
name|abfd
init|=
name|cached_abfd
decl_stmt|;
name|struct
name|bfd_data
name|data
decl_stmt|;
if|if
condition|(
name|abfd
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|.
name|pc
operator|=
operator|(
name|bfd_vma
operator|)
name|pc
expr_stmt|;
name|data
operator|.
name|found
operator|=
name|FALSE
expr_stmt|;
name|bfd_map_over_sections
argument_list|(
name|abfd
argument_list|,
name|find_addr_sect
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
operator|.
name|found
condition|)
return|return
name|NULL
return|;
return|return
name|data
operator|.
name|function
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_trace_bfd_init
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|prg_fname
condition|)
block|{
name|get_prg_fname
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|prg_fname
condition|)
return|return;
block|}
if|if
condition|(
operator|!
name|cached_abfd
condition|)
block|{
name|cached_abfd
operator|=
name|open_bfd
argument_list|(
name|prg_fname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cached_abfd
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to open bfd"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|read_syms
argument_list|(
name|cached_abfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|syms
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to read symbols"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
name|void
name|wpa_trace_dump_funcname
parameter_list|(
specifier|const
name|char
modifier|*
name|title
parameter_list|,
name|void
modifier|*
name|pc
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA_TRACE: %s: %p"
argument_list|,
name|title
argument_list|,
name|pc
argument_list|)
expr_stmt|;
name|wpa_trace_bfd_init
argument_list|()
expr_stmt|;
name|wpa_trace_bfd_addr
argument_list|(
name|pc
argument_list|)
expr_stmt|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* WPA_TRACE_BFD */
end_comment

begin_define
define|#
directive|define
name|wpa_trace_bfd_init
parameter_list|()
value|do { } while (0)
end_define

begin_define
define|#
directive|define
name|wpa_trace_bfd_addr
parameter_list|(
name|pc
parameter_list|)
value|do { } while (0)
end_define

begin_define
define|#
directive|define
name|wpa_trace_bfd_addr2func
parameter_list|(
name|pc
parameter_list|)
value|NULL
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* WPA_TRACE_BFD */
end_comment

begin_function
name|void
name|wpa_trace_dump_func
parameter_list|(
specifier|const
name|char
modifier|*
name|title
parameter_list|,
name|void
modifier|*
modifier|*
name|btrace
parameter_list|,
name|int
name|btrace_num
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|sym
decl_stmt|;
name|int
name|i
decl_stmt|;
enum|enum
block|{
name|TRACE_HEAD
block|,
name|TRACE_RELEVANT
block|,
name|TRACE_TAIL
block|}
name|state
enum|;
name|wpa_trace_bfd_init
argument_list|()
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA_TRACE: %s - START"
argument_list|,
name|title
argument_list|)
expr_stmt|;
name|sym
operator|=
name|backtrace_symbols
argument_list|(
name|btrace
argument_list|,
name|btrace_num
argument_list|)
expr_stmt|;
name|state
operator|=
name|TRACE_HEAD
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|btrace_num
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|char
modifier|*
name|func
init|=
name|wpa_trace_bfd_addr2func
argument_list|(
name|btrace
index|[
name|i
index|]
argument_list|)
decl_stmt|;
if|if
condition|(
name|state
operator|==
name|TRACE_HEAD
operator|&&
name|func
operator|&&
operator|(
name|os_strcmp
argument_list|(
name|func
argument_list|,
literal|"wpa_trace_add_ref_func"
argument_list|)
operator|==
literal|0
operator|||
name|os_strcmp
argument_list|(
name|func
argument_list|,
literal|"wpa_trace_check_ref"
argument_list|)
operator|==
literal|0
operator|||
name|os_strcmp
argument_list|(
name|func
argument_list|,
literal|"wpa_trace_show"
argument_list|)
operator|==
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
name|state
operator|==
name|TRACE_TAIL
operator|&&
name|sym
operator|&&
name|sym
index|[
name|i
index|]
operator|&&
name|os_strstr
argument_list|(
name|sym
index|[
name|i
index|]
argument_list|,
literal|"__libc_start_main"
argument_list|)
condition|)
break|break;
if|if
condition|(
name|state
operator|==
name|TRACE_HEAD
condition|)
name|state
operator|=
name|TRACE_RELEVANT
expr_stmt|;
if|if
condition|(
name|sym
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[%d]: %s"
argument_list|,
name|i
argument_list|,
name|sym
index|[
name|i
index|]
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"[%d]: ?? [%p]"
argument_list|,
name|i
argument_list|,
name|btrace
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|wpa_trace_bfd_addr
argument_list|(
name|btrace
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|TRACE_RELEVANT
operator|&&
name|func
operator|&&
name|os_strcmp
argument_list|(
name|func
argument_list|,
literal|"main"
argument_list|)
operator|==
literal|0
condition|)
name|state
operator|=
name|TRACE_TAIL
expr_stmt|;
block|}
name|free
argument_list|(
name|sym
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPA_TRACE: %s - END"
argument_list|,
name|title
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_trace_show
parameter_list|(
specifier|const
name|char
modifier|*
name|title
parameter_list|)
block|{
struct|struct
name|info
block|{
name|WPA_TRACE_INFO
block|}
name|info
struct|;
name|wpa_trace_record
argument_list|(
operator|&
name|info
argument_list|)
expr_stmt|;
name|wpa_trace_dump
argument_list|(
name|title
argument_list|,
operator|&
name|info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_trace_add_ref_func
parameter_list|(
name|struct
name|wpa_trace_ref
modifier|*
name|ref
parameter_list|,
specifier|const
name|void
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
return|return;
name|ref
operator|->
name|addr
operator|=
name|addr
expr_stmt|;
name|wpa_trace_record
argument_list|(
name|ref
argument_list|)
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|active_references
argument_list|,
operator|&
name|ref
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_trace_check_ref
parameter_list|(
specifier|const
name|void
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_trace_ref
modifier|*
name|ref
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|ref
argument_list|,
argument|&active_references
argument_list|,
argument|struct wpa_trace_ref
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|addr
operator|!=
name|ref
operator|->
name|addr
condition|)
continue|continue;
name|wpa_trace_show
argument_list|(
literal|"Freeing referenced memory"
argument_list|)
expr_stmt|;
name|wpa_trace_dump
argument_list|(
literal|"Reference registration"
argument_list|,
name|ref
argument_list|)
expr_stmt|;
name|abort
argument_list|()
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* WPA_TRACE */
end_comment

end_unit


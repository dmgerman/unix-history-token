begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * HTTP wrapper for libcurl  * Copyright (c) 2012-2014, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<curl/curl.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_TLS_OPENSSL
end_ifdef

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/asn1.h>
end_include

begin_include
include|#
directive|include
file|<openssl/asn1t.h>
end_include

begin_include
include|#
directive|include
file|<openssl/x509v3.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SSL_set_tlsext_status_type
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|OPENSSL_NO_TLSEXT
end_ifndef

begin_define
define|#
directive|define
name|HAVE_OCSP
end_define

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/ocsp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* OPENSSL_NO_TLSEXT */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* SSL_set_tlsext_status_type */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_TLS_OPENSSL */
end_comment

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"xml-utils.h"
end_include

begin_include
include|#
directive|include
file|"http-utils.h"
end_include

begin_struct
struct|struct
name|http_ctx
block|{
name|void
modifier|*
name|ctx
decl_stmt|;
name|struct
name|xml_node_ctx
modifier|*
name|xml
decl_stmt|;
name|CURL
modifier|*
name|curl
decl_stmt|;
name|struct
name|curl_slist
modifier|*
name|curl_hdr
decl_stmt|;
name|char
modifier|*
name|svc_address
decl_stmt|;
name|char
modifier|*
name|svc_ca_fname
decl_stmt|;
name|char
modifier|*
name|svc_username
decl_stmt|;
name|char
modifier|*
name|svc_password
decl_stmt|;
name|char
modifier|*
name|svc_client_cert
decl_stmt|;
name|char
modifier|*
name|svc_client_key
decl_stmt|;
name|char
modifier|*
name|curl_buf
decl_stmt|;
name|size_t
name|curl_buf_len
decl_stmt|;
name|int
function_decl|(
modifier|*
name|cert_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|cert
parameter_list|)
function_decl|;
name|void
modifier|*
name|cert_cb_ctx
decl_stmt|;
enum|enum
block|{
name|NO_OCSP
block|,
name|OPTIONAL_OCSP
block|,
name|MANDATORY_OCSP
block|}
name|ocsp
enum|;
name|X509
modifier|*
name|peer_cert
decl_stmt|;
name|X509
modifier|*
name|peer_issuer
decl_stmt|;
name|X509
modifier|*
name|peer_issuer_issuer
decl_stmt|;
specifier|const
name|char
modifier|*
name|last_err
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|clear_curl
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|ctx
operator|->
name|curl
condition|)
block|{
name|curl_easy_cleanup
argument_list|(
name|ctx
operator|->
name|curl
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|curl
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|ctx
operator|->
name|curl_hdr
condition|)
block|{
name|curl_slist_free_all
argument_list|(
name|ctx
operator|->
name|curl_hdr
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|curl_hdr
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|clone_str
parameter_list|(
name|char
modifier|*
modifier|*
name|dst
parameter_list|,
specifier|const
name|char
modifier|*
name|src
parameter_list|)
block|{
name|os_free
argument_list|(
operator|*
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|src
condition|)
operator|*
name|dst
operator|=
name|os_strdup
argument_list|(
name|src
argument_list|)
expr_stmt|;
else|else
operator|*
name|dst
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|debug_dump
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|title
parameter_list|,
specifier|const
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|char
modifier|*
name|txt
decl_stmt|;
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|buf
index|[
name|i
index|]
operator|<
literal|32
operator|&&
name|buf
index|[
name|i
index|]
operator|!=
literal|'\t'
operator|&&
name|buf
index|[
name|i
index|]
operator|!=
literal|'\n'
operator|&&
name|buf
index|[
name|i
index|]
operator|!=
literal|'\r'
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
name|title
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|txt
operator|=
name|os_malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|txt
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|txt
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|txt
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
name|len
operator|--
expr_stmt|;
if|if
condition|(
name|txt
index|[
name|len
index|]
operator|==
literal|'\n'
operator|||
name|txt
index|[
name|len
index|]
operator|==
literal|'\r'
condition|)
name|txt
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
else|else
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"%s[%s]"
argument_list|,
name|title
argument_list|,
name|txt
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|txt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|curl_cb_debug
parameter_list|(
name|CURL
modifier|*
name|curl
parameter_list|,
name|curl_infotype
name|info
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|struct
name|http_ctx
modifier|*
name|ctx
init|=
name|userdata
decl_stmt|;
switch|switch
condition|(
name|info
condition|)
block|{
case|case
name|CURLINFO_TEXT
case|:
name|debug_dump
argument_list|(
name|ctx
argument_list|,
literal|"CURLINFO_TEXT"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CURLINFO_HEADER_IN
case|:
name|debug_dump
argument_list|(
name|ctx
argument_list|,
literal|"CURLINFO_HEADER_IN"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CURLINFO_HEADER_OUT
case|:
name|debug_dump
argument_list|(
name|ctx
argument_list|,
literal|"CURLINFO_HEADER_OUT"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CURLINFO_DATA_IN
case|:
name|debug_dump
argument_list|(
name|ctx
argument_list|,
literal|"CURLINFO_DATA_IN"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CURLINFO_DATA_OUT
case|:
name|debug_dump
argument_list|(
name|ctx
argument_list|,
literal|"CURLINFO_DATA_OUT"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CURLINFO_SSL_DATA_IN
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"debug - CURLINFO_SSL_DATA_IN - %d"
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CURLINFO_SSL_DATA_OUT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"debug - CURLINFO_SSL_DATA_OUT - %d"
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|CURLINFO_END
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"debug - CURLINFO_END - %d"
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|curl_cb_write
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|,
name|size_t
name|size
parameter_list|,
name|size_t
name|nmemb
parameter_list|,
name|void
modifier|*
name|userdata
parameter_list|)
block|{
name|struct
name|http_ctx
modifier|*
name|ctx
init|=
name|userdata
decl_stmt|;
name|char
modifier|*
name|n
decl_stmt|;
name|n
operator|=
name|os_realloc
argument_list|(
name|ctx
operator|->
name|curl_buf
argument_list|,
name|ctx
operator|->
name|curl_buf_len
operator|+
name|size
operator|*
name|nmemb
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ctx
operator|->
name|curl_buf
operator|=
name|n
expr_stmt|;
name|os_memcpy
argument_list|(
name|n
operator|+
name|ctx
operator|->
name|curl_buf_len
argument_list|,
name|ptr
argument_list|,
name|size
operator|*
name|nmemb
argument_list|)
expr_stmt|;
name|n
index|[
name|ctx
operator|->
name|curl_buf_len
operator|+
name|size
operator|*
name|nmemb
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ctx
operator|->
name|curl_buf_len
operator|+=
name|size
operator|*
name|nmemb
expr_stmt|;
return|return
name|size
operator|*
name|nmemb
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_TLS_OPENSSL
end_ifdef

begin_function
specifier|static
name|void
name|debug_dump_cert
parameter_list|(
specifier|const
name|char
modifier|*
name|title
parameter_list|,
name|X509
modifier|*
name|cert
parameter_list|)
block|{
name|BIO
modifier|*
name|out
decl_stmt|;
name|char
modifier|*
name|txt
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
name|out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|out
condition|)
return|return;
name|X509_print_ex
argument_list|(
name|out
argument_list|,
name|cert
argument_list|,
name|XN_FLAG_COMPAT
argument_list|,
name|X509_FLAG_COMPAT
argument_list|)
expr_stmt|;
name|rlen
operator|=
name|BIO_ctrl_pending
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|txt
operator|=
name|os_malloc
argument_list|(
name|rlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|txt
condition|)
block|{
name|int
name|res
init|=
name|BIO_read
argument_list|(
name|out
argument_list|,
name|txt
argument_list|,
name|rlen
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|txt
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"%s:\n%s"
argument_list|,
name|title
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|txt
argument_list|)
expr_stmt|;
block|}
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_alt_name_othername
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|cert
parameter_list|,
name|OTHERNAME
modifier|*
name|o
parameter_list|)
block|{
name|char
name|txt
index|[
literal|100
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|http_othername
modifier|*
name|on
decl_stmt|;
name|ASN1_TYPE
modifier|*
name|val
decl_stmt|;
name|on
operator|=
name|os_realloc_array
argument_list|(
name|cert
operator|->
name|othername
argument_list|,
name|cert
operator|->
name|num_othername
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|http_othername
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|on
operator|==
name|NULL
condition|)
return|return;
name|cert
operator|->
name|othername
operator|=
name|on
expr_stmt|;
name|on
operator|=
operator|&
name|on
index|[
name|cert
operator|->
name|num_othername
index|]
expr_stmt|;
name|os_memset
argument_list|(
name|on
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|on
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|=
name|OBJ_obj2txt
argument_list|(
name|txt
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
name|o
operator|->
name|type_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|||
name|res
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
condition|)
return|return;
name|on
operator|->
name|oid
operator|=
name|os_strdup
argument_list|(
name|txt
argument_list|)
expr_stmt|;
if|if
condition|(
name|on
operator|->
name|oid
operator|==
name|NULL
condition|)
return|return;
name|val
operator|=
name|o
operator|->
name|value
expr_stmt|;
name|on
operator|->
name|data
operator|=
name|val
operator|->
name|value
operator|.
name|octet_string
operator|->
name|data
expr_stmt|;
name|on
operator|->
name|len
operator|=
name|val
operator|->
name|value
operator|.
name|octet_string
operator|->
name|length
expr_stmt|;
name|cert
operator|->
name|num_othername
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_alt_name_dns
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|cert
parameter_list|,
name|ASN1_STRING
modifier|*
name|name
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
modifier|*
name|n
decl_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ASN1_STRING_to_UTF8
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|*
operator|)
operator|&
name|buf
argument_list|,
name|name
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|n
operator|=
name|os_realloc_array
argument_list|(
name|cert
operator|->
name|dnsname
argument_list|,
name|cert
operator|->
name|num_dnsname
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return;
name|cert
operator|->
name|dnsname
operator|=
name|n
expr_stmt|;
name|n
index|[
name|cert
operator|->
name|num_dnsname
index|]
operator|=
name|buf
expr_stmt|;
name|cert
operator|->
name|num_dnsname
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_alt_name
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|cert
parameter_list|,
specifier|const
name|GENERAL_NAME
modifier|*
name|name
parameter_list|)
block|{
switch|switch
condition|(
name|name
operator|->
name|type
condition|)
block|{
case|case
name|GEN_OTHERNAME
case|:
name|add_alt_name_othername
argument_list|(
name|ctx
argument_list|,
name|cert
argument_list|,
name|name
operator|->
name|d
operator|.
name|otherName
argument_list|)
expr_stmt|;
break|break;
case|case
name|GEN_DNS
case|:
name|add_alt_name_dns
argument_list|(
name|ctx
argument_list|,
name|cert
argument_list|,
name|name
operator|->
name|d
operator|.
name|dNSName
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|add_alt_names
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|cert
parameter_list|,
name|GENERAL_NAMES
modifier|*
name|names
parameter_list|)
block|{
name|int
name|num
decl_stmt|,
name|i
decl_stmt|;
name|num
operator|=
name|sk_GENERAL_NAME_num
argument_list|(
name|names
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|GENERAL_NAME
modifier|*
name|name
decl_stmt|;
name|name
operator|=
name|sk_GENERAL_NAME_value
argument_list|(
name|names
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|add_alt_name
argument_list|(
name|ctx
argument_list|,
name|cert
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* RFC 3709 */
end_comment

begin_typedef
typedef|typedef
struct|struct
block|{
name|X509_ALGOR
modifier|*
name|hashAlg
decl_stmt|;
name|ASN1_OCTET_STRING
modifier|*
name|hashValue
decl_stmt|;
block|}
name|HashAlgAndValue
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|STACK_OF
argument_list|(
name|HashAlgAndValue
argument_list|)
operator|*
name|refStructHash
expr_stmt|;
name|STACK_OF
argument_list|(
name|ASN1_IA5STRING
argument_list|)
operator|*
name|refStructURI
expr_stmt|;
block|}
name|LogotypeReference
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|ASN1_IA5STRING
modifier|*
name|mediaType
decl_stmt|;
name|STACK_OF
argument_list|(
name|HashAlgAndValue
argument_list|)
operator|*
name|logotypeHash
expr_stmt|;
name|STACK_OF
argument_list|(
name|ASN1_IA5STRING
argument_list|)
operator|*
name|logotypeURI
expr_stmt|;
block|}
name|LogotypeDetails
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|int
name|type
decl_stmt|;
union|union
block|{
name|ASN1_INTEGER
modifier|*
name|numBits
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|tableSize
decl_stmt|;
block|}
name|d
union|;
block|}
name|LogotypeImageResolution
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|ASN1_INTEGER
modifier|*
name|type
decl_stmt|;
comment|/* LogotypeImageType ::= INTEGER */
name|ASN1_INTEGER
modifier|*
name|fileSize
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|xSize
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|ySize
decl_stmt|;
name|LogotypeImageResolution
modifier|*
name|resolution
decl_stmt|;
name|ASN1_IA5STRING
modifier|*
name|language
decl_stmt|;
block|}
name|LogotypeImageInfo
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|LogotypeDetails
modifier|*
name|imageDetails
decl_stmt|;
name|LogotypeImageInfo
modifier|*
name|imageInfo
decl_stmt|;
block|}
name|LogotypeImage
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|ASN1_INTEGER
modifier|*
name|fileSize
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|playTime
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|channels
decl_stmt|;
name|ASN1_INTEGER
modifier|*
name|sampleRate
decl_stmt|;
name|ASN1_IA5STRING
modifier|*
name|language
decl_stmt|;
block|}
name|LogotypeAudioInfo
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|LogotypeDetails
modifier|*
name|audioDetails
decl_stmt|;
name|LogotypeAudioInfo
modifier|*
name|audioInfo
decl_stmt|;
block|}
name|LogotypeAudio
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|STACK_OF
argument_list|(
name|LogotypeImage
argument_list|)
operator|*
name|image
expr_stmt|;
name|STACK_OF
argument_list|(
name|LogotypeAudio
argument_list|)
operator|*
name|audio
expr_stmt|;
block|}
name|LogotypeData
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|int
name|type
decl_stmt|;
union|union
block|{
name|LogotypeData
modifier|*
name|direct
decl_stmt|;
name|LogotypeReference
modifier|*
name|indirect
decl_stmt|;
block|}
name|d
union|;
block|}
name|LogotypeInfo
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|ASN1_OBJECT
modifier|*
name|logotypeType
decl_stmt|;
name|LogotypeInfo
modifier|*
name|info
decl_stmt|;
block|}
name|OtherLogotypeInfo
typedef|;
end_typedef

begin_typedef
typedef|typedef
struct|struct
block|{
name|STACK_OF
argument_list|(
name|LogotypeInfo
argument_list|)
operator|*
name|communityLogos
expr_stmt|;
name|LogotypeInfo
modifier|*
name|issuerLogo
decl_stmt|;
name|LogotypeInfo
modifier|*
name|subjectLogo
decl_stmt|;
name|STACK_OF
argument_list|(
name|OtherLogotypeInfo
argument_list|)
operator|*
name|otherLogos
expr_stmt|;
block|}
name|LogotypeExtn
typedef|;
end_typedef

begin_expr_stmt
name|ASN1_SEQUENCE
argument_list|(
name|HashAlgAndValue
argument_list|)
operator|=
block|{
name|ASN1_SIMPLE
argument_list|(
name|HashAlgAndValue
argument_list|,
name|hashAlg
argument_list|,
name|X509_ALGOR
argument_list|)
block|,
name|ASN1_SIMPLE
argument_list|(
argument|HashAlgAndValue
argument_list|,
argument|hashValue
argument_list|,
argument|ASN1_OCTET_STRING
argument_list|)
block|}
name|ASN1_SEQUENCE_END
argument_list|(
name|HashAlgAndValue
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_SEQUENCE
argument_list|(
name|LogotypeReference
argument_list|)
operator|=
block|{
name|ASN1_SEQUENCE_OF
argument_list|(
name|LogotypeReference
argument_list|,
name|refStructHash
argument_list|,
name|HashAlgAndValue
argument_list|)
block|,
name|ASN1_SEQUENCE_OF
argument_list|(
argument|LogotypeReference
argument_list|,
argument|refStructURI
argument_list|,
argument|ASN1_IA5STRING
argument_list|)
block|}
name|ASN1_SEQUENCE_END
argument_list|(
name|LogotypeReference
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_SEQUENCE
argument_list|(
name|LogotypeDetails
argument_list|)
operator|=
block|{
name|ASN1_SIMPLE
argument_list|(
name|LogotypeDetails
argument_list|,
name|mediaType
argument_list|,
name|ASN1_IA5STRING
argument_list|)
block|,
name|ASN1_SEQUENCE_OF
argument_list|(
name|LogotypeDetails
argument_list|,
name|logotypeHash
argument_list|,
name|HashAlgAndValue
argument_list|)
block|,
name|ASN1_SEQUENCE_OF
argument_list|(
argument|LogotypeDetails
argument_list|,
argument|logotypeURI
argument_list|,
argument|ASN1_IA5STRING
argument_list|)
block|}
name|ASN1_SEQUENCE_END
argument_list|(
name|LogotypeDetails
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_CHOICE
argument_list|(
name|LogotypeImageResolution
argument_list|)
operator|=
block|{
name|ASN1_IMP
argument_list|(
name|LogotypeImageResolution
argument_list|,
name|d
operator|.
name|numBits
argument_list|,
name|ASN1_INTEGER
argument_list|,
literal|1
argument_list|)
block|,
name|ASN1_IMP
argument_list|(
argument|LogotypeImageResolution
argument_list|,
argument|d.tableSize
argument_list|,
argument|ASN1_INTEGER
argument_list|,
literal|2
argument_list|)
block|}
name|ASN1_CHOICE_END
argument_list|(
name|LogotypeImageResolution
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_SEQUENCE
argument_list|(
name|LogotypeImageInfo
argument_list|)
operator|=
block|{
name|ASN1_IMP_OPT
argument_list|(
name|LogotypeImageInfo
argument_list|,
name|type
argument_list|,
name|ASN1_INTEGER
argument_list|,
literal|0
argument_list|)
block|,
name|ASN1_SIMPLE
argument_list|(
name|LogotypeImageInfo
argument_list|,
name|fileSize
argument_list|,
name|ASN1_INTEGER
argument_list|)
block|,
name|ASN1_SIMPLE
argument_list|(
name|LogotypeImageInfo
argument_list|,
name|xSize
argument_list|,
name|ASN1_INTEGER
argument_list|)
block|,
name|ASN1_SIMPLE
argument_list|(
name|LogotypeImageInfo
argument_list|,
name|ySize
argument_list|,
name|ASN1_INTEGER
argument_list|)
block|,
name|ASN1_OPT
argument_list|(
name|LogotypeImageInfo
argument_list|,
name|resolution
argument_list|,
name|LogotypeImageResolution
argument_list|)
block|,
name|ASN1_IMP_OPT
argument_list|(
name|LogotypeImageInfo
argument_list|,
name|language
argument_list|,
name|ASN1_IA5STRING
argument_list|,
literal|4
argument_list|)
block|, }
name|ASN1_SEQUENCE_END
argument_list|(
name|LogotypeImageInfo
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_SEQUENCE
argument_list|(
name|LogotypeImage
argument_list|)
operator|=
block|{
name|ASN1_SIMPLE
argument_list|(
name|LogotypeImage
argument_list|,
name|imageDetails
argument_list|,
name|LogotypeDetails
argument_list|)
block|,
name|ASN1_OPT
argument_list|(
argument|LogotypeImage
argument_list|,
argument|imageInfo
argument_list|,
argument|LogotypeImageInfo
argument_list|)
block|}
name|ASN1_SEQUENCE_END
argument_list|(
name|LogotypeImage
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_SEQUENCE
argument_list|(
name|LogotypeAudioInfo
argument_list|)
operator|=
block|{
name|ASN1_SIMPLE
argument_list|(
name|LogotypeAudioInfo
argument_list|,
name|fileSize
argument_list|,
name|ASN1_INTEGER
argument_list|)
block|,
name|ASN1_SIMPLE
argument_list|(
name|LogotypeAudioInfo
argument_list|,
name|playTime
argument_list|,
name|ASN1_INTEGER
argument_list|)
block|,
name|ASN1_SIMPLE
argument_list|(
name|LogotypeAudioInfo
argument_list|,
name|channels
argument_list|,
name|ASN1_INTEGER
argument_list|)
block|,
name|ASN1_IMP_OPT
argument_list|(
name|LogotypeAudioInfo
argument_list|,
name|sampleRate
argument_list|,
name|ASN1_INTEGER
argument_list|,
literal|3
argument_list|)
block|,
name|ASN1_IMP_OPT
argument_list|(
argument|LogotypeAudioInfo
argument_list|,
argument|language
argument_list|,
argument|ASN1_IA5STRING
argument_list|,
literal|4
argument_list|)
block|}
name|ASN1_SEQUENCE_END
argument_list|(
name|LogotypeAudioInfo
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_SEQUENCE
argument_list|(
name|LogotypeAudio
argument_list|)
operator|=
block|{
name|ASN1_SIMPLE
argument_list|(
name|LogotypeAudio
argument_list|,
name|audioDetails
argument_list|,
name|LogotypeDetails
argument_list|)
block|,
name|ASN1_OPT
argument_list|(
argument|LogotypeAudio
argument_list|,
argument|audioInfo
argument_list|,
argument|LogotypeAudioInfo
argument_list|)
block|}
name|ASN1_SEQUENCE_END
argument_list|(
name|LogotypeAudio
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_SEQUENCE
argument_list|(
name|LogotypeData
argument_list|)
operator|=
block|{
name|ASN1_SEQUENCE_OF_OPT
argument_list|(
name|LogotypeData
argument_list|,
name|image
argument_list|,
name|LogotypeImage
argument_list|)
block|,
name|ASN1_IMP_SEQUENCE_OF_OPT
argument_list|(
argument|LogotypeData
argument_list|,
argument|audio
argument_list|,
argument|LogotypeAudio
argument_list|,
literal|1
argument_list|)
block|}
name|ASN1_SEQUENCE_END
argument_list|(
name|LogotypeData
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_CHOICE
argument_list|(
name|LogotypeInfo
argument_list|)
operator|=
block|{
name|ASN1_IMP
argument_list|(
name|LogotypeInfo
argument_list|,
name|d
operator|.
name|direct
argument_list|,
name|LogotypeData
argument_list|,
literal|0
argument_list|)
block|,
name|ASN1_IMP
argument_list|(
argument|LogotypeInfo
argument_list|,
argument|d.indirect
argument_list|,
argument|LogotypeReference
argument_list|,
literal|1
argument_list|)
block|}
name|ASN1_CHOICE_END
argument_list|(
name|LogotypeInfo
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_SEQUENCE
argument_list|(
name|OtherLogotypeInfo
argument_list|)
operator|=
block|{
name|ASN1_SIMPLE
argument_list|(
name|OtherLogotypeInfo
argument_list|,
name|logotypeType
argument_list|,
name|ASN1_OBJECT
argument_list|)
block|,
name|ASN1_SIMPLE
argument_list|(
argument|OtherLogotypeInfo
argument_list|,
argument|info
argument_list|,
argument|LogotypeInfo
argument_list|)
block|}
name|ASN1_SEQUENCE_END
argument_list|(
name|OtherLogotypeInfo
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|ASN1_SEQUENCE
argument_list|(
name|LogotypeExtn
argument_list|)
operator|=
block|{
name|ASN1_EXP_SEQUENCE_OF_OPT
argument_list|(
name|LogotypeExtn
argument_list|,
name|communityLogos
argument_list|,
name|LogotypeInfo
argument_list|,
literal|0
argument_list|)
block|,
name|ASN1_EXP_OPT
argument_list|(
name|LogotypeExtn
argument_list|,
name|issuerLogo
argument_list|,
name|LogotypeInfo
argument_list|,
literal|1
argument_list|)
block|,
name|ASN1_EXP_OPT
argument_list|(
name|LogotypeExtn
argument_list|,
name|issuerLogo
argument_list|,
name|LogotypeInfo
argument_list|,
literal|2
argument_list|)
block|,
name|ASN1_EXP_SEQUENCE_OF_OPT
argument_list|(
argument|LogotypeExtn
argument_list|,
argument|otherLogos
argument_list|,
argument|OtherLogotypeInfo
argument_list|,
literal|3
argument_list|)
block|}
name|ASN1_SEQUENCE_END
argument_list|(
name|LogotypeExtn
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|IMPLEMENT_ASN1_FUNCTIONS
argument_list|(
name|LogotypeExtn
argument_list|)
expr_stmt|;
end_expr_stmt

begin_define
define|#
directive|define
name|sk_LogotypeInfo_num
parameter_list|(
name|st
parameter_list|)
value|SKM_sk_num(LogotypeInfo, (st))
end_define

begin_define
define|#
directive|define
name|sk_LogotypeInfo_value
parameter_list|(
name|st
parameter_list|,
name|i
parameter_list|)
value|SKM_sk_value(LogotypeInfo, (st), (i))
end_define

begin_define
define|#
directive|define
name|sk_LogotypeImage_num
parameter_list|(
name|st
parameter_list|)
value|SKM_sk_num(LogotypeImage, (st))
end_define

begin_define
define|#
directive|define
name|sk_LogotypeImage_value
parameter_list|(
name|st
parameter_list|,
name|i
parameter_list|)
value|SKM_sk_value(LogotypeImage, (st), (i))
end_define

begin_define
define|#
directive|define
name|sk_LogotypeAudio_num
parameter_list|(
name|st
parameter_list|)
value|SKM_sk_num(LogotypeAudio, (st))
end_define

begin_define
define|#
directive|define
name|sk_LogotypeAudio_value
parameter_list|(
name|st
parameter_list|,
name|i
parameter_list|)
value|SKM_sk_value(LogotypeAudio, (st), (i))
end_define

begin_define
define|#
directive|define
name|sk_HashAlgAndValue_num
parameter_list|(
name|st
parameter_list|)
value|SKM_sk_num(HashAlgAndValue, (st))
end_define

begin_define
define|#
directive|define
name|sk_HashAlgAndValue_value
parameter_list|(
name|st
parameter_list|,
name|i
parameter_list|)
value|SKM_sk_value(HashAlgAndValue, (st), (i))
end_define

begin_define
define|#
directive|define
name|sk_ASN1_IA5STRING_num
parameter_list|(
name|st
parameter_list|)
value|SKM_sk_num(ASN1_IA5STRING, (st))
end_define

begin_define
define|#
directive|define
name|sk_ASN1_IA5STRING_value
parameter_list|(
name|st
parameter_list|,
name|i
parameter_list|)
value|SKM_sk_value(ASN1_IA5STRING, (st), (i))
end_define

begin_function
specifier|static
name|void
name|add_logo
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|hcert
parameter_list|,
name|HashAlgAndValue
modifier|*
name|hash
parameter_list|,
name|ASN1_IA5STRING
modifier|*
name|uri
parameter_list|)
block|{
name|char
name|txt
index|[
literal|100
index|]
decl_stmt|;
name|int
name|res
decl_stmt|,
name|len
decl_stmt|;
name|struct
name|http_logo
modifier|*
name|n
decl_stmt|;
if|if
condition|(
name|hash
operator|==
name|NULL
operator|||
name|uri
operator|==
name|NULL
condition|)
return|return;
name|res
operator|=
name|OBJ_obj2txt
argument_list|(
name|txt
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
name|hash
operator|->
name|hashAlg
operator|->
name|algorithm
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|||
name|res
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
condition|)
return|return;
name|n
operator|=
name|os_realloc_array
argument_list|(
name|hcert
operator|->
name|logo
argument_list|,
name|hcert
operator|->
name|num_logo
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|http_logo
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return;
name|hcert
operator|->
name|logo
operator|=
name|n
expr_stmt|;
name|n
operator|=
operator|&
name|hcert
operator|->
name|logo
index|[
name|hcert
operator|->
name|num_logo
index|]
expr_stmt|;
name|os_memset
argument_list|(
name|n
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|n
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|->
name|alg_oid
operator|=
name|os_strdup
argument_list|(
name|txt
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|->
name|alg_oid
operator|==
name|NULL
condition|)
return|return;
name|n
operator|->
name|hash_len
operator|=
name|ASN1_STRING_length
argument_list|(
name|hash
operator|->
name|hashValue
argument_list|)
expr_stmt|;
name|n
operator|->
name|hash
operator|=
name|os_malloc
argument_list|(
name|n
operator|->
name|hash_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|->
name|hash
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|n
operator|->
name|alg_oid
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|n
operator|->
name|hash
argument_list|,
name|ASN1_STRING_data
argument_list|(
name|hash
operator|->
name|hashValue
argument_list|)
argument_list|,
name|n
operator|->
name|hash_len
argument_list|)
expr_stmt|;
name|len
operator|=
name|ASN1_STRING_length
argument_list|(
name|uri
argument_list|)
expr_stmt|;
name|n
operator|->
name|uri
operator|=
name|os_malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|->
name|uri
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|n
operator|->
name|alg_oid
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|n
operator|->
name|hash
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|n
operator|->
name|uri
argument_list|,
name|ASN1_STRING_data
argument_list|(
name|uri
argument_list|)
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|n
operator|->
name|uri
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|hcert
operator|->
name|num_logo
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_logo_direct
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|hcert
parameter_list|,
name|LogotypeData
modifier|*
name|data
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|num
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|image
operator|==
name|NULL
condition|)
return|return;
name|num
operator|=
name|sk_LogotypeImage_num
argument_list|(
name|data
operator|->
name|image
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|LogotypeImage
modifier|*
name|image
decl_stmt|;
name|LogotypeDetails
modifier|*
name|details
decl_stmt|;
name|int
name|j
decl_stmt|,
name|hash_num
decl_stmt|,
name|uri_num
decl_stmt|;
name|HashAlgAndValue
modifier|*
name|found_hash
init|=
name|NULL
decl_stmt|;
name|image
operator|=
name|sk_LogotypeImage_value
argument_list|(
name|data
operator|->
name|image
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|image
operator|==
name|NULL
condition|)
continue|continue;
name|details
operator|=
name|image
operator|->
name|imageDetails
expr_stmt|;
if|if
condition|(
name|details
operator|==
name|NULL
condition|)
continue|continue;
name|hash_num
operator|=
name|sk_HashAlgAndValue_num
argument_list|(
name|details
operator|->
name|logotypeHash
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|hash_num
condition|;
name|j
operator|++
control|)
block|{
name|HashAlgAndValue
modifier|*
name|hash
decl_stmt|;
name|char
name|txt
index|[
literal|100
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|hash
operator|=
name|sk_HashAlgAndValue_value
argument_list|(
name|details
operator|->
name|logotypeHash
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|hash
operator|==
name|NULL
condition|)
continue|continue;
name|res
operator|=
name|OBJ_obj2txt
argument_list|(
name|txt
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
name|hash
operator|->
name|hashAlg
operator|->
name|algorithm
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|||
name|res
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|os_strcmp
argument_list|(
name|txt
argument_list|,
literal|"2.16.840.1.101.3.4.2.1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found_hash
operator|=
name|hash
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found_hash
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: No SHA256 hash found for the logo"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|uri_num
operator|=
name|sk_ASN1_IA5STRING_num
argument_list|(
name|details
operator|->
name|logotypeURI
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|uri_num
condition|;
name|j
operator|++
control|)
block|{
name|ASN1_IA5STRING
modifier|*
name|uri
decl_stmt|;
name|uri
operator|=
name|sk_ASN1_IA5STRING_value
argument_list|(
name|details
operator|->
name|logotypeURI
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|add_logo
argument_list|(
name|ctx
argument_list|,
name|hcert
argument_list|,
name|found_hash
argument_list|,
name|uri
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|add_logo_indirect
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|hcert
parameter_list|,
name|LogotypeReference
modifier|*
name|ref
parameter_list|)
block|{
name|int
name|j
decl_stmt|,
name|hash_num
decl_stmt|,
name|uri_num
decl_stmt|;
name|hash_num
operator|=
name|sk_HashAlgAndValue_num
argument_list|(
name|ref
operator|->
name|refStructHash
argument_list|)
expr_stmt|;
name|uri_num
operator|=
name|sk_ASN1_IA5STRING_num
argument_list|(
name|ref
operator|->
name|refStructURI
argument_list|)
expr_stmt|;
if|if
condition|(
name|hash_num
operator|!=
name|uri_num
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Unexpected LogotypeReference array size difference %d != %d"
argument_list|,
name|hash_num
argument_list|,
name|uri_num
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|hash_num
condition|;
name|j
operator|++
control|)
block|{
name|HashAlgAndValue
modifier|*
name|hash
decl_stmt|;
name|ASN1_IA5STRING
modifier|*
name|uri
decl_stmt|;
name|hash
operator|=
name|sk_HashAlgAndValue_value
argument_list|(
name|ref
operator|->
name|refStructHash
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|uri
operator|=
name|sk_ASN1_IA5STRING_value
argument_list|(
name|ref
operator|->
name|refStructURI
argument_list|,
name|j
argument_list|)
expr_stmt|;
name|add_logo
argument_list|(
name|ctx
argument_list|,
name|hcert
argument_list|,
name|hash
argument_list|,
name|uri
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|i2r_HashAlgAndValue
parameter_list|(
name|HashAlgAndValue
modifier|*
name|hash
parameter_list|,
name|BIO
modifier|*
name|out
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|data
decl_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*shashAlg: "
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|i2a_ASN1_OBJECT
argument_list|(
name|out
argument_list|,
name|hash
operator|->
name|hashAlg
operator|->
name|algorithm
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*shashValue: "
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|data
operator|=
name|hash
operator|->
name|hashValue
operator|->
name|data
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hash
operator|->
name|hashValue
operator|->
name|length
condition|;
name|i
operator|++
control|)
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%s%02x"
argument_list|,
name|i
operator|>
literal|0
condition|?
literal|":"
else|:
literal|""
argument_list|,
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|i2r_LogotypeDetails
parameter_list|(
name|LogotypeDetails
modifier|*
name|details
parameter_list|,
name|BIO
modifier|*
name|out
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|num
decl_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*sLogotypeDetails\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|details
operator|->
name|mediaType
condition|)
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*smediaType: "
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ASN1_STRING_print
argument_list|(
name|out
argument_list|,
name|details
operator|->
name|mediaType
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|num
operator|=
name|details
operator|->
name|logotypeHash
condition|?
name|sk_HashAlgAndValue_num
argument_list|(
name|details
operator|->
name|logotypeHash
argument_list|)
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|HashAlgAndValue
modifier|*
name|hash
decl_stmt|;
name|hash
operator|=
name|sk_HashAlgAndValue_value
argument_list|(
name|details
operator|->
name|logotypeHash
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|i2r_HashAlgAndValue
argument_list|(
name|hash
argument_list|,
name|out
argument_list|,
name|indent
argument_list|)
expr_stmt|;
block|}
name|num
operator|=
name|details
operator|->
name|logotypeURI
condition|?
name|sk_ASN1_IA5STRING_num
argument_list|(
name|details
operator|->
name|logotypeURI
argument_list|)
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|ASN1_IA5STRING
modifier|*
name|uri
decl_stmt|;
name|uri
operator|=
name|sk_ASN1_IA5STRING_value
argument_list|(
name|details
operator|->
name|logotypeURI
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*slogotypeURI: "
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ASN1_STRING_print
argument_list|(
name|out
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|i2r_LogotypeImageInfo
parameter_list|(
name|LogotypeImageInfo
modifier|*
name|info
parameter_list|,
name|BIO
modifier|*
name|out
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
name|long
name|val
decl_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*sLogotypeImageInfo\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|type
condition|)
block|{
name|val
operator|=
name|ASN1_INTEGER_get
argument_list|(
name|info
operator|->
name|type
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*stype: %ld\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*stype: default (1)\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
name|val
operator|=
name|ASN1_INTEGER_get
argument_list|(
name|info
operator|->
name|xSize
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*sxSize: %ld\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|ASN1_INTEGER_get
argument_list|(
name|info
operator|->
name|ySize
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*sySize: %ld\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|->
name|resolution
condition|)
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*sresolution\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
comment|/* TODO */
block|}
if|if
condition|(
name|info
operator|->
name|language
condition|)
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*slanguage: "
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ASN1_STRING_print
argument_list|(
name|out
argument_list|,
name|info
operator|->
name|language
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|i2r_LogotypeImage
parameter_list|(
name|LogotypeImage
modifier|*
name|image
parameter_list|,
name|BIO
modifier|*
name|out
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*sLogotypeImage\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|image
operator|->
name|imageDetails
condition|)
block|{
name|i2r_LogotypeDetails
argument_list|(
name|image
operator|->
name|imageDetails
argument_list|,
name|out
argument_list|,
name|indent
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|image
operator|->
name|imageInfo
condition|)
block|{
name|i2r_LogotypeImageInfo
argument_list|(
name|image
operator|->
name|imageInfo
argument_list|,
name|out
argument_list|,
name|indent
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|i2r_LogotypeData
parameter_list|(
name|LogotypeData
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|title
parameter_list|,
name|BIO
modifier|*
name|out
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|num
decl_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*s%s - LogotypeData\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|title
argument_list|)
expr_stmt|;
name|num
operator|=
name|data
operator|->
name|image
condition|?
name|sk_LogotypeImage_num
argument_list|(
name|data
operator|->
name|image
argument_list|)
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|LogotypeImage
modifier|*
name|image
init|=
name|sk_LogotypeImage_value
argument_list|(
name|data
operator|->
name|image
argument_list|,
name|i
argument_list|)
decl_stmt|;
name|i2r_LogotypeImage
argument_list|(
name|image
argument_list|,
name|out
argument_list|,
name|indent
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
name|num
operator|=
name|data
operator|->
name|audio
condition|?
name|sk_LogotypeAudio_num
argument_list|(
name|data
operator|->
name|audio
argument_list|)
else|:
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*saudio: TODO\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|i2r_LogotypeReference
parameter_list|(
name|LogotypeReference
modifier|*
name|ref
parameter_list|,
specifier|const
name|char
modifier|*
name|title
parameter_list|,
name|BIO
modifier|*
name|out
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|hash_num
decl_stmt|,
name|uri_num
decl_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*s%s - LogotypeReference\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|title
argument_list|)
expr_stmt|;
name|hash_num
operator|=
name|ref
operator|->
name|refStructHash
condition|?
name|sk_HashAlgAndValue_num
argument_list|(
name|ref
operator|->
name|refStructHash
argument_list|)
else|:
literal|0
expr_stmt|;
name|uri_num
operator|=
name|ref
operator|->
name|refStructURI
condition|?
name|sk_ASN1_IA5STRING_num
argument_list|(
name|ref
operator|->
name|refStructURI
argument_list|)
else|:
literal|0
expr_stmt|;
if|if
condition|(
name|hash_num
operator|!=
name|uri_num
condition|)
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*sUnexpected LogotypeReference array size difference %d != %d\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|,
name|hash_num
argument_list|,
name|uri_num
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hash_num
condition|;
name|i
operator|++
control|)
block|{
name|HashAlgAndValue
modifier|*
name|hash
decl_stmt|;
name|ASN1_IA5STRING
modifier|*
name|uri
decl_stmt|;
name|hash
operator|=
name|sk_HashAlgAndValue_value
argument_list|(
name|ref
operator|->
name|refStructHash
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|i2r_HashAlgAndValue
argument_list|(
name|hash
argument_list|,
name|out
argument_list|,
name|indent
argument_list|)
expr_stmt|;
name|uri
operator|=
name|sk_ASN1_IA5STRING_value
argument_list|(
name|ref
operator|->
name|refStructURI
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*srefStructURI: "
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|ASN1_STRING_print
argument_list|(
name|out
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|i2r_LogotypeInfo
parameter_list|(
name|LogotypeInfo
modifier|*
name|info
parameter_list|,
specifier|const
name|char
modifier|*
name|title
parameter_list|,
name|BIO
modifier|*
name|out
parameter_list|,
name|int
name|indent
parameter_list|)
block|{
switch|switch
condition|(
name|info
operator|->
name|type
condition|)
block|{
case|case
literal|0
case|:
name|i2r_LogotypeData
argument_list|(
name|info
operator|->
name|d
operator|.
name|direct
argument_list|,
name|title
argument_list|,
name|out
argument_list|,
name|indent
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|i2r_LogotypeReference
argument_list|(
name|info
operator|->
name|d
operator|.
name|indirect
argument_list|,
name|title
argument_list|,
name|out
argument_list|,
name|indent
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|debug_print_logotypeext
parameter_list|(
name|LogotypeExtn
modifier|*
name|logo
parameter_list|)
block|{
name|BIO
modifier|*
name|out
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num
decl_stmt|;
name|int
name|indent
init|=
literal|0
decl_stmt|;
name|out
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|logo
operator|->
name|communityLogos
condition|)
block|{
name|num
operator|=
name|sk_LogotypeInfo_num
argument_list|(
name|logo
operator|->
name|communityLogos
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|LogotypeInfo
modifier|*
name|info
decl_stmt|;
name|info
operator|=
name|sk_LogotypeInfo_value
argument_list|(
name|logo
operator|->
name|communityLogos
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|i2r_LogotypeInfo
argument_list|(
name|info
argument_list|,
literal|"communityLogo"
argument_list|,
name|out
argument_list|,
name|indent
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|logo
operator|->
name|issuerLogo
condition|)
block|{
name|i2r_LogotypeInfo
argument_list|(
name|logo
operator|->
name|issuerLogo
argument_list|,
literal|"issuerLogo"
argument_list|,
name|out
argument_list|,
name|indent
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|logo
operator|->
name|subjectLogo
condition|)
block|{
name|i2r_LogotypeInfo
argument_list|(
name|logo
operator|->
name|subjectLogo
argument_list|,
literal|"subjectLogo"
argument_list|,
name|out
argument_list|,
name|indent
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|logo
operator|->
name|otherLogos
condition|)
block|{
name|BIO_printf
argument_list|(
name|out
argument_list|,
literal|"%*sotherLogos - TODO\n"
argument_list|,
name|indent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
block|}
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|add_logotype_ext
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|hcert
parameter_list|,
name|X509
modifier|*
name|cert
parameter_list|)
block|{
name|ASN1_OBJECT
modifier|*
name|obj
decl_stmt|;
name|int
name|pos
decl_stmt|;
name|X509_EXTENSION
modifier|*
name|ext
decl_stmt|;
name|ASN1_OCTET_STRING
modifier|*
name|os
decl_stmt|;
name|LogotypeExtn
modifier|*
name|logo
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|data
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num
decl_stmt|;
name|obj
operator|=
name|OBJ_txt2obj
argument_list|(
literal|"1.3.6.1.5.5.7.1.12"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|obj
operator|==
name|NULL
condition|)
return|return;
name|pos
operator|=
name|X509_get_ext_by_OBJ
argument_list|(
name|cert
argument_list|,
name|obj
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No logotype extension included"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Parsing logotype extension"
argument_list|)
expr_stmt|;
name|ext
operator|=
name|X509_get_ext
argument_list|(
name|cert
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ext
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get logotype extension"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os
operator|=
name|X509_EXTENSION_get_data
argument_list|(
name|ext
argument_list|)
expr_stmt|;
if|if
condition|(
name|os
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get logotype extension data"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"logotypeExtn"
argument_list|,
name|ASN1_STRING_data
argument_list|(
name|os
argument_list|)
argument_list|,
name|ASN1_STRING_length
argument_list|(
name|os
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|=
name|ASN1_STRING_data
argument_list|(
name|os
argument_list|)
expr_stmt|;
name|logo
operator|=
name|d2i_LogotypeExtn
argument_list|(
name|NULL
argument_list|,
operator|&
name|data
argument_list|,
name|ASN1_STRING_length
argument_list|(
name|os
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|logo
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to parse logotypeExtn"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_debug_level
operator|<
name|MSG_INFO
condition|)
name|debug_print_logotypeext
argument_list|(
name|logo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|logo
operator|->
name|communityLogos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No communityLogos included"
argument_list|)
expr_stmt|;
name|LogotypeExtn_free
argument_list|(
name|logo
argument_list|)
expr_stmt|;
return|return;
block|}
name|num
operator|=
name|sk_LogotypeInfo_num
argument_list|(
name|logo
operator|->
name|communityLogos
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|LogotypeInfo
modifier|*
name|info
decl_stmt|;
name|info
operator|=
name|sk_LogotypeInfo_value
argument_list|(
name|logo
operator|->
name|communityLogos
argument_list|,
name|i
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|info
operator|->
name|type
condition|)
block|{
case|case
literal|0
case|:
name|add_logo_direct
argument_list|(
name|ctx
argument_list|,
name|hcert
argument_list|,
name|info
operator|->
name|d
operator|.
name|direct
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|add_logo_indirect
argument_list|(
name|ctx
argument_list|,
name|hcert
argument_list|,
name|info
operator|->
name|d
operator|.
name|indirect
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|LogotypeExtn_free
argument_list|(
name|logo
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|parse_cert
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|hcert
parameter_list|,
name|X509
modifier|*
name|cert
parameter_list|,
name|GENERAL_NAMES
modifier|*
modifier|*
name|names
parameter_list|)
block|{
name|os_memset
argument_list|(
name|hcert
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|hcert
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|names
operator|=
name|X509_get_ext_d2i
argument_list|(
name|cert
argument_list|,
name|NID_subject_alt_name
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|names
condition|)
name|add_alt_names
argument_list|(
name|ctx
argument_list|,
name|hcert
argument_list|,
operator|*
name|names
argument_list|)
expr_stmt|;
name|add_logotype_ext
argument_list|(
name|ctx
argument_list|,
name|hcert
argument_list|,
name|cert
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|parse_cert_free
parameter_list|(
name|struct
name|http_cert
modifier|*
name|hcert
parameter_list|,
name|GENERAL_NAMES
modifier|*
name|names
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hcert
operator|->
name|num_dnsname
condition|;
name|i
operator|++
control|)
name|OPENSSL_free
argument_list|(
name|hcert
operator|->
name|dnsname
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hcert
operator|->
name|dnsname
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hcert
operator|->
name|num_othername
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
name|hcert
operator|->
name|othername
index|[
name|i
index|]
operator|.
name|oid
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hcert
operator|->
name|othername
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hcert
operator|->
name|num_logo
condition|;
name|i
operator|++
control|)
block|{
name|os_free
argument_list|(
name|hcert
operator|->
name|logo
index|[
name|i
index|]
operator|.
name|alg_oid
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hcert
operator|->
name|logo
index|[
name|i
index|]
operator|.
name|hash
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hcert
operator|->
name|logo
index|[
name|i
index|]
operator|.
name|uri
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|hcert
operator|->
name|logo
argument_list|)
expr_stmt|;
name|sk_GENERAL_NAME_pop_free
argument_list|(
name|names
argument_list|,
name|GENERAL_NAME_free
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|validate_server_cert
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|X509
modifier|*
name|cert
parameter_list|)
block|{
name|GENERAL_NAMES
modifier|*
name|names
decl_stmt|;
name|struct
name|http_cert
name|hcert
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|ctx
operator|->
name|cert_cb
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
literal|0
condition|)
block|{
name|BIO
modifier|*
name|out
decl_stmt|;
name|out
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
name|X509_print_ex
argument_list|(
name|out
argument_list|,
name|cert
argument_list|,
name|XN_FLAG_COMPAT
argument_list|,
name|X509_FLAG_COMPAT
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
name|parse_cert
argument_list|(
name|ctx
argument_list|,
operator|&
name|hcert
argument_list|,
name|cert
argument_list|,
operator|&
name|names
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ctx
operator|->
name|cert_cb
argument_list|(
name|ctx
operator|->
name|cert_cb_ctx
argument_list|,
operator|&
name|hcert
argument_list|)
expr_stmt|;
name|parse_cert_free
argument_list|(
operator|&
name|hcert
argument_list|,
name|names
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|http_parse_x509_certificate
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|BIO
modifier|*
name|in
decl_stmt|,
modifier|*
name|out
decl_stmt|;
name|X509
modifier|*
name|cert
decl_stmt|;
name|GENERAL_NAMES
modifier|*
name|names
decl_stmt|;
name|struct
name|http_cert
name|hcert
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|in
operator|=
name|BIO_new_file
argument_list|(
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|in
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not read '%s'"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return;
block|}
name|cert
operator|=
name|d2i_X509_bio
argument_list|(
name|in
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|in
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not parse certificate"
argument_list|)
expr_stmt|;
return|return;
block|}
name|out
operator|=
name|BIO_new_fp
argument_list|(
name|stdout
argument_list|,
name|BIO_NOCLOSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|out
condition|)
block|{
name|X509_print_ex
argument_list|(
name|out
argument_list|,
name|cert
argument_list|,
name|XN_FLAG_COMPAT
argument_list|,
name|X509_FLAG_COMPAT
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Additional parsing information:"
argument_list|)
expr_stmt|;
name|parse_cert
argument_list|(
name|ctx
argument_list|,
operator|&
name|hcert
argument_list|,
name|cert
argument_list|,
operator|&
name|names
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hcert
operator|.
name|num_othername
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|hcert
operator|.
name|othername
index|[
name|i
index|]
operator|.
name|oid
argument_list|,
literal|"1.3.6.1.4.1.40808.1.1.1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|name
init|=
name|os_zalloc
argument_list|(
name|hcert
operator|.
name|othername
index|[
name|i
index|]
operator|.
name|len
operator|+
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|name
condition|)
block|{
name|os_memcpy
argument_list|(
name|name
argument_list|,
name|hcert
operator|.
name|othername
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|hcert
operator|.
name|othername
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"id-wfa-hotspot-friendlyName: %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_INFO
argument_list|,
literal|"id-wfa-hotspot-friendlyName"
argument_list|,
name|hcert
operator|.
name|othername
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|hcert
operator|.
name|othername
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"subjAltName[othername]: oid=%s"
argument_list|,
name|hcert
operator|.
name|othername
index|[
name|i
index|]
operator|.
name|oid
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_INFO
argument_list|,
literal|"unknown othername"
argument_list|,
name|hcert
operator|.
name|othername
index|[
name|i
index|]
operator|.
name|data
argument_list|,
name|hcert
operator|.
name|othername
index|[
name|i
index|]
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
block|}
name|parse_cert_free
argument_list|(
operator|&
name|hcert
argument_list|,
name|names
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|curl_cb_ssl_verify
parameter_list|(
name|int
name|preverify_ok
parameter_list|,
name|X509_STORE_CTX
modifier|*
name|x509_ctx
parameter_list|)
block|{
name|struct
name|http_ctx
modifier|*
name|ctx
decl_stmt|;
name|X509
modifier|*
name|cert
decl_stmt|;
name|int
name|err
decl_stmt|,
name|depth
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|;
name|X509_NAME
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|err_str
decl_stmt|;
name|SSL
modifier|*
name|ssl
decl_stmt|;
name|SSL_CTX
modifier|*
name|ssl_ctx
decl_stmt|;
name|ssl
operator|=
name|X509_STORE_CTX_get_ex_data
argument_list|(
name|x509_ctx
argument_list|,
name|SSL_get_ex_data_X509_STORE_CTX_idx
argument_list|()
argument_list|)
expr_stmt|;
name|ssl_ctx
operator|=
name|ssl
operator|->
name|ctx
expr_stmt|;
name|ctx
operator|=
name|SSL_CTX_get_app_data
argument_list|(
name|ssl_ctx
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"curl_cb_ssl_verify"
argument_list|)
expr_stmt|;
name|err
operator|=
name|X509_STORE_CTX_get_error
argument_list|(
name|x509_ctx
argument_list|)
expr_stmt|;
name|err_str
operator|=
name|X509_verify_cert_error_string
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|depth
operator|=
name|X509_STORE_CTX_get_error_depth
argument_list|(
name|x509_ctx
argument_list|)
expr_stmt|;
name|cert
operator|=
name|X509_STORE_CTX_get_current_cert
argument_list|(
name|x509_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cert
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"No server certificate available"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"No server certificate available"
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|depth
operator|==
literal|0
condition|)
name|ctx
operator|->
name|peer_cert
operator|=
name|cert
expr_stmt|;
elseif|else
if|if
condition|(
name|depth
operator|==
literal|1
condition|)
name|ctx
operator|->
name|peer_issuer
operator|=
name|cert
expr_stmt|;
elseif|else
if|if
condition|(
name|depth
operator|==
literal|2
condition|)
name|ctx
operator|->
name|peer_issuer_issuer
operator|=
name|cert
expr_stmt|;
name|name
operator|=
name|X509_get_subject_name
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|X509_NAME_oneline
argument_list|(
name|name
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Server certificate chain - depth=%d err=%d (%s) subject=%s"
argument_list|,
name|depth
argument_list|,
name|err
argument_list|,
name|err_str
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|debug_dump_cert
argument_list|(
literal|"Server certificate chain - certificate"
argument_list|,
name|cert
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth
operator|==
literal|0
operator|&&
name|preverify_ok
operator|&&
name|validate_server_cert
argument_list|(
name|ctx
argument_list|,
name|cert
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|preverify_ok
condition|)
name|ctx
operator|->
name|last_err
operator|=
literal|"TLS validation failed"
expr_stmt|;
return|return
name|preverify_ok
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_OCSP
end_ifdef

begin_function
specifier|static
name|void
name|ocsp_debug_print_resp
parameter_list|(
name|OCSP_RESPONSE
modifier|*
name|rsp
parameter_list|)
block|{
name|BIO
modifier|*
name|out
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
name|char
modifier|*
name|txt
decl_stmt|;
name|int
name|res
decl_stmt|;
name|out
operator|=
name|BIO_new
argument_list|(
name|BIO_s_mem
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|out
condition|)
return|return;
name|OCSP_RESPONSE_print
argument_list|(
name|out
argument_list|,
name|rsp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|rlen
operator|=
name|BIO_ctrl_pending
argument_list|(
name|out
argument_list|)
expr_stmt|;
name|txt
operator|=
name|os_malloc
argument_list|(
name|rlen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|txt
condition|)
block|{
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|BIO_read
argument_list|(
name|out
argument_list|,
name|txt
argument_list|,
name|rlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|txt
index|[
name|res
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"OpenSSL: OCSP Response\n%s"
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|txt
argument_list|)
expr_stmt|;
name|BIO_free
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|tls_show_errors
parameter_list|(
specifier|const
name|char
modifier|*
name|func
parameter_list|,
specifier|const
name|char
modifier|*
name|txt
parameter_list|)
block|{
name|unsigned
name|long
name|err
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: %s - %s %s"
argument_list|,
name|func
argument_list|,
name|txt
argument_list|,
name|ERR_error_string
argument_list|(
name|ERR_get_error
argument_list|()
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|err
operator|=
name|ERR_get_error
argument_list|()
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: pending error: %s"
argument_list|,
name|ERR_error_string
argument_list|(
name|err
argument_list|,
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|ocsp_resp_cb
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|http_ctx
modifier|*
name|ctx
init|=
name|arg
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|len
decl_stmt|,
name|status
decl_stmt|,
name|reason
decl_stmt|;
name|OCSP_RESPONSE
modifier|*
name|rsp
decl_stmt|;
name|OCSP_BASICRESP
modifier|*
name|basic
decl_stmt|;
name|OCSP_CERTID
modifier|*
name|id
decl_stmt|;
name|ASN1_GENERALIZEDTIME
modifier|*
name|produced_at
decl_stmt|,
modifier|*
name|this_update
decl_stmt|,
modifier|*
name|next_update
decl_stmt|;
name|X509_STORE
modifier|*
name|store
decl_stmt|;
name|STACK_OF
argument_list|(
name|X509
argument_list|)
operator|*
name|certs
operator|=
name|NULL
expr_stmt|;
name|len
operator|=
name|SSL_get_tlsext_status_ocsp_resp
argument_list|(
name|s
argument_list|,
operator|&
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: No OCSP response received"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|ocsp
operator|==
name|MANDATORY_OCSP
condition|)
name|ctx
operator|->
name|last_err
operator|=
literal|"No OCSP response received"
expr_stmt|;
return|return
operator|(
name|ctx
operator|->
name|ocsp
operator|==
name|MANDATORY_OCSP
operator|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP response"
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|rsp
operator|=
name|d2i_OCSP_RESPONSE
argument_list|(
name|NULL
argument_list|,
operator|&
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsp
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: Failed to parse OCSP response"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"Failed to parse OCSP response"
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ocsp_debug_print_resp
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
name|status
operator|=
name|OCSP_response_status
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|OCSP_RESPONSE_STATUS_SUCCESSFUL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: OCSP responder error %d (%s)"
argument_list|,
name|status
argument_list|,
name|OCSP_response_status_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"OCSP responder error"
expr_stmt|;
return|return
literal|0
return|;
block|}
name|basic
operator|=
name|OCSP_response_get1_basic
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|basic
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: Could not find BasicOCSPResponse"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"Could not find BasicOCSPResponse"
expr_stmt|;
return|return
literal|0
return|;
block|}
name|store
operator|=
name|SSL_CTX_get_cert_store
argument_list|(
name|s
operator|->
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|peer_issuer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Add issuer"
argument_list|)
expr_stmt|;
name|debug_dump_cert
argument_list|(
literal|"OpenSSL: Issuer certificate"
argument_list|,
name|ctx
operator|->
name|peer_issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|X509_STORE_add_cert
argument_list|(
name|store
argument_list|,
name|ctx
operator|->
name|peer_issuer
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|tls_show_errors
argument_list|(
name|__func__
argument_list|,
literal|"OpenSSL: Could not add issuer to certificate store"
argument_list|)
expr_stmt|;
block|}
name|certs
operator|=
name|sk_X509_new_null
argument_list|()
expr_stmt|;
if|if
condition|(
name|certs
condition|)
block|{
name|X509
modifier|*
name|cert
decl_stmt|;
name|cert
operator|=
name|X509_dup
argument_list|(
name|ctx
operator|->
name|peer_issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|&&
operator|!
name|sk_X509_push
argument_list|(
name|certs
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|__func__
argument_list|,
literal|"OpenSSL: Could not add issuer to OCSP responder trust store"
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
name|sk_X509_free
argument_list|(
name|certs
argument_list|)
expr_stmt|;
name|certs
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|certs
operator|&&
name|ctx
operator|->
name|peer_issuer_issuer
condition|)
block|{
name|cert
operator|=
name|X509_dup
argument_list|(
name|ctx
operator|->
name|peer_issuer_issuer
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|&&
operator|!
name|sk_X509_push
argument_list|(
name|certs
argument_list|,
name|cert
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|__func__
argument_list|,
literal|"OpenSSL: Could not add issuer's issuer to OCSP responder trust store"
argument_list|)
expr_stmt|;
name|X509_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|status
operator|=
name|OCSP_basic_verify
argument_list|(
name|basic
argument_list|,
name|certs
argument_list|,
name|store
argument_list|,
name|OCSP_TRUSTOTHER
argument_list|)
expr_stmt|;
name|sk_X509_pop_free
argument_list|(
name|certs
argument_list|,
name|X509_free
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|<=
literal|0
condition|)
block|{
name|tls_show_errors
argument_list|(
name|__func__
argument_list|,
literal|"OpenSSL: OCSP response failed verification"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"OCSP response failed verification"
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP response verification succeeded"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ctx
operator|->
name|peer_cert
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Peer certificate not available for OCSP status check"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"Peer certificate not available for OCSP status check"
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|ctx
operator|->
name|peer_issuer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Peer issuer certificate not available for OCSP status check"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"Peer issuer certificate not available for OCSP status check"
expr_stmt|;
return|return
literal|0
return|;
block|}
name|id
operator|=
name|OCSP_cert_to_id
argument_list|(
name|NULL
argument_list|,
name|ctx
operator|->
name|peer_cert
argument_list|,
name|ctx
operator|->
name|peer_issuer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: Could not create OCSP certificate identifier"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"Could not create OCSP certificate identifier"
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|OCSP_resp_find_status
argument_list|(
name|basic
argument_list|,
name|id
argument_list|,
operator|&
name|status
argument_list|,
operator|&
name|reason
argument_list|,
operator|&
name|produced_at
argument_list|,
operator|&
name|this_update
argument_list|,
operator|&
name|next_update
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"OpenSSL: Could not find current server certificate from OCSP response%s"
argument_list|,
operator|(
name|ctx
operator|->
name|ocsp
operator|==
name|MANDATORY_OCSP
operator|)
condition|?
literal|""
else|:
literal|" (OCSP not required)"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|ocsp
operator|==
name|MANDATORY_OCSP
condition|)
name|ctx
operator|->
name|last_err
operator|=
literal|"Could not find current server certificate from OCSP response"
expr_stmt|;
return|return
operator|(
name|ctx
operator|->
name|ocsp
operator|==
name|MANDATORY_OCSP
operator|)
condition|?
literal|0
else|:
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|OCSP_check_validity
argument_list|(
name|this_update
argument_list|,
name|next_update
argument_list|,
literal|5
operator|*
literal|60
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
block|{
name|tls_show_errors
argument_list|(
name|__func__
argument_list|,
literal|"OpenSSL: OCSP status times invalid"
argument_list|)
expr_stmt|;
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"OCSP status times invalid"
expr_stmt|;
return|return
literal|0
return|;
block|}
name|OCSP_BASICRESP_free
argument_list|(
name|basic
argument_list|)
expr_stmt|;
name|OCSP_RESPONSE_free
argument_list|(
name|rsp
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP status for server certificate: %s"
argument_list|,
name|OCSP_cert_status_str
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|V_OCSP_CERTSTATUS_GOOD
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|status
operator|==
name|V_OCSP_CERTSTATUS_REVOKED
condition|)
block|{
name|ctx
operator|->
name|last_err
operator|=
literal|"Server certificate has been revoked"
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|ocsp
operator|==
name|MANDATORY_OCSP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP status unknown, but OCSP required"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"OCSP status unknown"
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OpenSSL: OCSP status unknown, but OCSP was not required, so allow connection to continue"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|SSL_METHOD
name|patch_ssl_method
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|SSL_METHOD
modifier|*
name|real_ssl_method
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|curl_patch_ssl_new
parameter_list|(
name|SSL
modifier|*
name|s
parameter_list|)
block|{
name|SSL_CTX
modifier|*
name|ssl
init|=
name|s
operator|->
name|ctx
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ssl
operator|->
name|method
operator|=
name|real_ssl_method
expr_stmt|;
name|s
operator|->
name|method
operator|=
name|real_ssl_method
expr_stmt|;
name|ret
operator|=
name|s
operator|->
name|method
operator|->
name|ssl_new
argument_list|(
name|s
argument_list|)
expr_stmt|;
name|SSL_set_tlsext_status_type
argument_list|(
name|s
argument_list|,
name|TLSEXT_STATUSTYPE_ocsp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_OCSP */
end_comment

begin_function
specifier|static
name|CURLcode
name|curl_cb_ssl
parameter_list|(
name|CURL
modifier|*
name|curl
parameter_list|,
name|void
modifier|*
name|sslctx
parameter_list|,
name|void
modifier|*
name|parm
parameter_list|)
block|{
name|struct
name|http_ctx
modifier|*
name|ctx
init|=
name|parm
decl_stmt|;
name|SSL_CTX
modifier|*
name|ssl
init|=
name|sslctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"curl_cb_ssl"
argument_list|)
expr_stmt|;
name|SSL_CTX_set_app_data
argument_list|(
name|ssl
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|SSL_CTX_set_verify
argument_list|(
name|ssl
argument_list|,
name|SSL_VERIFY_PEER
argument_list|,
name|curl_cb_ssl_verify
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_OCSP
if|if
condition|(
name|ctx
operator|->
name|ocsp
operator|!=
name|NO_OCSP
condition|)
block|{
name|SSL_CTX_set_tlsext_status_cb
argument_list|(
name|ssl
argument_list|,
name|ocsp_resp_cb
argument_list|)
expr_stmt|;
name|SSL_CTX_set_tlsext_status_arg
argument_list|(
name|ssl
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
comment|/* 		 * Use a temporary SSL_METHOD to get a callback on SSL_new() 		 * from libcurl since there is no proper callback registration 		 * available for this. 		 */
name|os_memset
argument_list|(
operator|&
name|patch_ssl_method
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|patch_ssl_method
argument_list|)
argument_list|)
expr_stmt|;
name|patch_ssl_method
operator|.
name|ssl_new
operator|=
name|curl_patch_ssl_new
expr_stmt|;
name|real_ssl_method
operator|=
name|ssl
operator|->
name|method
expr_stmt|;
name|ssl
operator|->
name|method
operator|=
operator|&
name|patch_ssl_method
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* HAVE_OCSP */
return|return
name|CURLE_OK
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_TLS_OPENSSL */
end_comment

begin_function
specifier|static
name|CURL
modifier|*
name|setup_curl_post
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|address
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|username
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|char
modifier|*
name|client_key
parameter_list|)
block|{
name|CURL
modifier|*
name|curl
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Start HTTP client: address=%s ca_fname=%s "
literal|"username=%s"
argument_list|,
name|address
argument_list|,
name|ca_fname
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|curl
operator|=
name|curl_easy_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|curl
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_URL
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_POST
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
if|if
condition|(
name|ca_fname
condition|)
block|{
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_CAINFO
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_SSL_VERIFYPEER
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|EAP_TLS_OPENSSL
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_SSL_CTX_FUNCTION
argument_list|,
name|curl_cb_ssl
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_SSL_CTX_DATA
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* EAP_TLS_OPENSSL */
block|}
else|else
block|{
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_SSL_VERIFYPEER
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|client_cert
operator|&&
name|client_key
condition|)
block|{
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_SSLCERT
argument_list|,
name|client_cert
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_SSLKEY
argument_list|,
name|client_key
argument_list|)
expr_stmt|;
block|}
comment|/* TODO: use curl_easy_getinfo() with CURLINFO_CERTINFO to fetch 	 * information about the server certificate */
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_CERTINFO
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_DEBUGFUNCTION
argument_list|,
name|curl_cb_debug
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_DEBUGDATA
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_WRITEFUNCTION
argument_list|,
name|curl_cb_write
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_WRITEDATA
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_VERBOSE
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
if|if
condition|(
name|username
condition|)
block|{
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_HTTPAUTH
argument_list|,
name|CURLAUTH_ANYSAFE
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_USERNAME
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_PASSWORD
argument_list|,
name|password
argument_list|)
expr_stmt|;
block|}
return|return
name|curl
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|post_init_client
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|address
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|username
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|char
modifier|*
name|client_key
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|int
name|count
decl_stmt|;
name|clone_str
argument_list|(
operator|&
name|ctx
operator|->
name|svc_address
argument_list|,
name|address
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|ctx
operator|->
name|svc_ca_fname
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|ctx
operator|->
name|svc_username
argument_list|,
name|username
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|ctx
operator|->
name|svc_password
argument_list|,
name|password
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|ctx
operator|->
name|svc_client_cert
argument_list|,
name|client_cert
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|ctx
operator|->
name|svc_client_key
argument_list|,
name|client_key
argument_list|)
expr_stmt|;
comment|/* 	 * Workaround for Apache "Hostname 'FOO' provided via SNI and hostname 	 * 'foo' provided via HTTP are different. 	 */
for|for
control|(
name|count
operator|=
literal|0
operator|,
name|pos
operator|=
name|ctx
operator|->
name|svc_address
init|;
name|count
operator|<
literal|3
operator|&&
name|pos
operator|&&
operator|*
name|pos
condition|;
name|pos
operator|++
control|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
literal|'/'
condition|)
name|count
operator|++
expr_stmt|;
operator|*
name|pos
operator|=
name|tolower
argument_list|(
operator|*
name|pos
argument_list|)
expr_stmt|;
block|}
name|ctx
operator|->
name|curl
operator|=
name|setup_curl_post
argument_list|(
name|ctx
argument_list|,
name|ctx
operator|->
name|svc_address
argument_list|,
name|ca_fname
argument_list|,
name|username
argument_list|,
name|password
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|->
name|curl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|soap_init_client
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|address
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|username
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|char
modifier|*
name|client_key
parameter_list|)
block|{
if|if
condition|(
name|post_init_client
argument_list|(
name|ctx
argument_list|,
name|address
argument_list|,
name|ca_fname
argument_list|,
name|username
argument_list|,
name|password
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ctx
operator|->
name|curl_hdr
operator|=
name|curl_slist_append
argument_list|(
name|ctx
operator|->
name|curl_hdr
argument_list|,
literal|"Content-Type: application/soap+xml"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|curl_hdr
operator|=
name|curl_slist_append
argument_list|(
name|ctx
operator|->
name|curl_hdr
argument_list|,
literal|"SOAPAction: "
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|curl_hdr
operator|=
name|curl_slist_append
argument_list|(
name|ctx
operator|->
name|curl_hdr
argument_list|,
literal|"Expect:"
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|ctx
operator|->
name|curl
argument_list|,
name|CURLOPT_HTTPHEADER
argument_list|,
name|ctx
operator|->
name|curl_hdr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|soap_reinit_client
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|)
block|{
name|char
modifier|*
name|address
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ca_fname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|username
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|password
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|client_cert
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|client_key
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|clear_curl
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|address
argument_list|,
name|ctx
operator|->
name|svc_address
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|ca_fname
argument_list|,
name|ctx
operator|->
name|svc_ca_fname
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|username
argument_list|,
name|ctx
operator|->
name|svc_username
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|password
argument_list|,
name|ctx
operator|->
name|svc_password
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|client_cert
argument_list|,
name|ctx
operator|->
name|svc_client_cert
argument_list|)
expr_stmt|;
name|clone_str
argument_list|(
operator|&
name|client_key
argument_list|,
name|ctx
operator|->
name|svc_client_key
argument_list|)
expr_stmt|;
name|ret
operator|=
name|soap_init_client
argument_list|(
name|ctx
argument_list|,
name|address
argument_list|,
name|ca_fname
argument_list|,
name|username
argument_list|,
name|password
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|address
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ca_fname
argument_list|)
expr_stmt|;
name|str_clear_free
argument_list|(
name|username
argument_list|)
expr_stmt|;
name|str_clear_free
argument_list|(
name|password
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|client_cert
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|client_key
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_curl_buf
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|)
block|{
name|os_free
argument_list|(
name|ctx
operator|->
name|curl_buf
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|curl_buf
operator|=
name|NULL
expr_stmt|;
name|ctx
operator|->
name|curl_buf_len
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|xml_node_t
modifier|*
name|soap_send_receive
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|xml_node_t
modifier|*
name|envelope
decl_stmt|,
modifier|*
name|ret
decl_stmt|,
modifier|*
name|resp
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|CURLcode
name|res
decl_stmt|;
name|long
name|http
init|=
literal|0
decl_stmt|;
name|ctx
operator|->
name|last_err
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SOAP: Sending message"
argument_list|)
expr_stmt|;
name|envelope
operator|=
name|soap_build_envelope
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|str
operator|=
name|xml_node_to_str
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|envelope
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|envelope
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"SOAP[%s]"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|ctx
operator|->
name|curl
argument_list|,
name|CURLOPT_POSTFIELDS
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free_curl_buf
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|res
operator|=
name|curl_easy_perform
argument_list|(
name|ctx
operator|->
name|curl
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|CURLE_OK
condition|)
block|{
if|if
condition|(
operator|!
name|ctx
operator|->
name|last_err
condition|)
name|ctx
operator|->
name|last_err
operator|=
name|curl_easy_strerror
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"curl_easy_perform() failed: %s"
argument_list|,
name|ctx
operator|->
name|last_err
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|free_curl_buf
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|curl_easy_getinfo
argument_list|(
name|ctx
operator|->
name|curl
argument_list|,
name|CURLINFO_RESPONSE_CODE
argument_list|,
operator|&
name|http
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SOAP: Server response code %ld"
argument_list|,
name|http
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
operator|!=
literal|200
condition|)
block|{
name|ctx
operator|->
name|last_err
operator|=
literal|"HTTP download failed"
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"HTTP download failed - code %ld"
argument_list|,
name|http
argument_list|)
expr_stmt|;
name|free_curl_buf
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|curl_buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"Server response:\n%s"
argument_list|,
name|ctx
operator|->
name|curl_buf
argument_list|)
expr_stmt|;
name|resp
operator|=
name|xml_node_from_buf
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ctx
operator|->
name|curl_buf
argument_list|)
expr_stmt|;
name|free_curl_buf
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not parse SOAP response"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"Could not parse SOAP response"
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ret
operator|=
name|soap_get_body
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Could not get SOAP body"
argument_list|)
expr_stmt|;
name|ctx
operator|->
name|last_err
operator|=
literal|"Could not get SOAP body"
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SOAP body localname: '%s'"
argument_list|,
name|xml_node_get_localname
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|n
operator|=
name|xml_node_copy
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|xml_node_free
argument_list|(
name|ctx
operator|->
name|xml
argument_list|,
name|resp
argument_list|)
expr_stmt|;
return|return
name|n
return|;
block|}
end_function

begin_function
name|struct
name|http_ctx
modifier|*
name|http_init_ctx
parameter_list|(
name|void
modifier|*
name|upper_ctx
parameter_list|,
name|struct
name|xml_node_ctx
modifier|*
name|xml_ctx
parameter_list|)
block|{
name|struct
name|http_ctx
modifier|*
name|ctx
decl_stmt|;
name|ctx
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ctx
operator|->
name|ctx
operator|=
name|upper_ctx
expr_stmt|;
name|ctx
operator|->
name|xml
operator|=
name|xml_ctx
expr_stmt|;
name|ctx
operator|->
name|ocsp
operator|=
name|OPTIONAL_OCSP
expr_stmt|;
name|curl_global_init
argument_list|(
name|CURL_GLOBAL_ALL
argument_list|)
expr_stmt|;
return|return
name|ctx
return|;
block|}
end_function

begin_function
name|void
name|http_ocsp_set
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|int
name|val
parameter_list|)
block|{
if|if
condition|(
name|val
operator|==
literal|0
condition|)
name|ctx
operator|->
name|ocsp
operator|=
name|NO_OCSP
expr_stmt|;
elseif|else
if|if
condition|(
name|val
operator|==
literal|1
condition|)
name|ctx
operator|->
name|ocsp
operator|=
name|OPTIONAL_OCSP
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|2
condition|)
name|ctx
operator|->
name|ocsp
operator|=
name|MANDATORY_OCSP
expr_stmt|;
block|}
end_function

begin_function
name|void
name|http_deinit_ctx
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|)
block|{
name|clear_curl
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|curl_buf
argument_list|)
expr_stmt|;
name|curl_global_cleanup
argument_list|()
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|svc_address
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|svc_ca_fname
argument_list|)
expr_stmt|;
name|str_clear_free
argument_list|(
name|ctx
operator|->
name|svc_username
argument_list|)
expr_stmt|;
name|str_clear_free
argument_list|(
name|ctx
operator|->
name|svc_password
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|svc_client_cert
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
operator|->
name|svc_client_key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|http_download_file
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_fname
parameter_list|)
block|{
name|CURL
modifier|*
name|curl
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|CURLcode
name|res
decl_stmt|;
name|long
name|http
init|=
literal|0
decl_stmt|;
name|ctx
operator|->
name|last_err
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"curl: Download file from %s to %s (ca=%s)"
argument_list|,
name|url
argument_list|,
name|fname
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
name|curl
operator|=
name|curl_easy_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|curl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|curl_easy_cleanup
argument_list|(
name|curl
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_URL
argument_list|,
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
name|ca_fname
condition|)
block|{
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_CAINFO
argument_list|,
name|ca_fname
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_SSL_VERIFYPEER
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_CERTINFO
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_SSL_VERIFYPEER
argument_list|,
literal|0L
argument_list|)
expr_stmt|;
block|}
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_DEBUGFUNCTION
argument_list|,
name|curl_cb_debug
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_DEBUGDATA
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_WRITEFUNCTION
argument_list|,
name|fwrite
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_WRITEDATA
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_VERBOSE
argument_list|,
literal|1L
argument_list|)
expr_stmt|;
name|res
operator|=
name|curl_easy_perform
argument_list|(
name|curl
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|CURLE_OK
condition|)
block|{
if|if
condition|(
operator|!
name|ctx
operator|->
name|last_err
condition|)
name|ctx
operator|->
name|last_err
operator|=
name|curl_easy_strerror
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"curl_easy_perform() failed: %s"
argument_list|,
name|ctx
operator|->
name|last_err
argument_list|)
expr_stmt|;
name|curl_easy_cleanup
argument_list|(
name|curl
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|curl_easy_getinfo
argument_list|(
name|curl
argument_list|,
name|CURLINFO_RESPONSE_CODE
argument_list|,
operator|&
name|http
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"curl: Server response code %ld"
argument_list|,
name|http
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
operator|!=
literal|200
condition|)
block|{
name|ctx
operator|->
name|last_err
operator|=
literal|"HTTP download failed"
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"HTTP download failed - code %ld"
argument_list|,
name|http
argument_list|)
expr_stmt|;
name|curl_easy_cleanup
argument_list|(
name|curl
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|curl_easy_cleanup
argument_list|(
name|curl
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|http_post
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
specifier|const
name|char
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|content_type
parameter_list|,
specifier|const
name|char
modifier|*
name|ext_hdr
parameter_list|,
specifier|const
name|char
modifier|*
name|ca_fname
parameter_list|,
specifier|const
name|char
modifier|*
name|username
parameter_list|,
specifier|const
name|char
modifier|*
name|password
parameter_list|,
specifier|const
name|char
modifier|*
name|client_cert
parameter_list|,
specifier|const
name|char
modifier|*
name|client_key
parameter_list|,
name|size_t
modifier|*
name|resp_len
parameter_list|)
block|{
name|long
name|http
init|=
literal|0
decl_stmt|;
name|CURLcode
name|res
decl_stmt|;
name|char
modifier|*
name|ret
decl_stmt|;
name|CURL
modifier|*
name|curl
decl_stmt|;
name|struct
name|curl_slist
modifier|*
name|curl_hdr
init|=
name|NULL
decl_stmt|;
name|ctx
operator|->
name|last_err
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"curl: HTTP POST to %s"
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|curl
operator|=
name|setup_curl_post
argument_list|(
name|ctx
argument_list|,
name|url
argument_list|,
name|ca_fname
argument_list|,
name|username
argument_list|,
name|password
argument_list|,
name|client_cert
argument_list|,
name|client_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|curl
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|content_type
condition|)
block|{
name|char
name|ct
index|[
literal|200
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|ct
argument_list|,
sizeof|sizeof
argument_list|(
name|ct
argument_list|)
argument_list|,
literal|"Content-Type: %s"
argument_list|,
name|content_type
argument_list|)
expr_stmt|;
name|curl_hdr
operator|=
name|curl_slist_append
argument_list|(
name|curl_hdr
argument_list|,
name|ct
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ext_hdr
condition|)
name|curl_hdr
operator|=
name|curl_slist_append
argument_list|(
name|curl_hdr
argument_list|,
name|ext_hdr
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_HTTPHEADER
argument_list|,
name|curl_hdr
argument_list|)
expr_stmt|;
name|curl_easy_setopt
argument_list|(
name|curl
argument_list|,
name|CURLOPT_POSTFIELDS
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|free_curl_buf
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|res
operator|=
name|curl_easy_perform
argument_list|(
name|curl
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|CURLE_OK
condition|)
block|{
if|if
condition|(
operator|!
name|ctx
operator|->
name|last_err
condition|)
name|ctx
operator|->
name|last_err
operator|=
name|curl_easy_strerror
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"curl_easy_perform() failed: %s"
argument_list|,
name|ctx
operator|->
name|last_err
argument_list|)
expr_stmt|;
name|free_curl_buf
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|curl_easy_getinfo
argument_list|(
name|curl
argument_list|,
name|CURLINFO_RESPONSE_CODE
argument_list|,
operator|&
name|http
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"curl: Server response code %ld"
argument_list|,
name|http
argument_list|)
expr_stmt|;
if|if
condition|(
name|http
operator|!=
literal|200
condition|)
block|{
name|ctx
operator|->
name|last_err
operator|=
literal|"HTTP POST failed"
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"HTTP POST failed - code %ld"
argument_list|,
name|http
argument_list|)
expr_stmt|;
name|free_curl_buf
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ctx
operator|->
name|curl_buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|ctx
operator|->
name|curl_buf
expr_stmt|;
if|if
condition|(
name|resp_len
condition|)
operator|*
name|resp_len
operator|=
name|ctx
operator|->
name|curl_buf_len
expr_stmt|;
name|ctx
operator|->
name|curl_buf
operator|=
name|NULL
expr_stmt|;
name|ctx
operator|->
name|curl_buf_len
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"Server response:\n%s"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|http_set_cert_cb
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|,
name|int
function_decl|(
modifier|*
name|cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_cert
modifier|*
name|cert
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cb_ctx
parameter_list|)
block|{
name|ctx
operator|->
name|cert_cb
operator|=
name|cb
expr_stmt|;
name|ctx
operator|->
name|cert_cb_ctx
operator|=
name|cb_ctx
expr_stmt|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|http_get_err
parameter_list|(
name|struct
name|http_ctx
modifier|*
name|ctx
parameter_list|)
block|{
return|return
name|ctx
operator|->
name|last_err
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Generic XML helper functions  * Copyright (c) 2012-2013, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"xml-utils.h"
end_include

begin_function
specifier|static
name|xml_node_t
modifier|*
name|get_node_uri_iter
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|root
parameter_list|,
name|char
modifier|*
name|uri
parameter_list|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|end
operator|=
name|strchr
argument_list|(
name|uri
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|node
operator|=
name|root
expr_stmt|;
name|xml_node_for_each_sibling
argument_list|(
argument|ctx
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
name|uri
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|end
condition|)
block|{
return|return
name|get_node_uri_iter
argument_list|(
name|ctx
argument_list|,
name|xml_node_first_child
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
argument_list|,
name|end
argument_list|)
return|;
block|}
return|return
name|node
return|;
block|}
end_function

begin_function
name|xml_node_t
modifier|*
name|get_node_uri
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|uri
parameter_list|)
block|{
name|char
modifier|*
name|search
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|search
operator|=
name|os_strdup
argument_list|(
name|uri
argument_list|)
expr_stmt|;
if|if
condition|(
name|search
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|node
operator|=
name|get_node_uri_iter
argument_list|(
name|ctx
argument_list|,
name|root
argument_list|,
name|search
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|search
argument_list|)
expr_stmt|;
return|return
name|node
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|get_node_iter
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|end
operator|=
name|os_strchr
argument_list|(
name|path
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|++
operator|=
literal|'\0'
expr_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx
argument_list|,
argument|node
argument_list|,
argument|root
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|name
argument_list|,
name|path
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|end
condition|)
return|return
name|get_node_iter
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|end
argument_list|)
return|;
return|return
name|node
return|;
block|}
end_function

begin_function
name|xml_node_t
modifier|*
name|get_node
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|char
modifier|*
name|search
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|search
operator|=
name|os_strdup
argument_list|(
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|search
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|node
operator|=
name|get_node_iter
argument_list|(
name|ctx
argument_list|,
name|root
argument_list|,
name|search
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|search
argument_list|)
expr_stmt|;
return|return
name|node
return|;
block|}
end_function

begin_function
name|xml_node_t
modifier|*
name|get_child_node
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|root
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|xml_node_t
modifier|*
name|match
decl_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx
argument_list|,
argument|node
argument_list|,
argument|root
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|match
operator|=
name|get_node
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|match
condition|)
return|return
name|match
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|xml_node_t
modifier|*
name|node_from_file
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|buf2
decl_stmt|,
modifier|*
name|start
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|buf
operator|=
name|os_readfile
argument_list|(
name|name
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|buf2
operator|=
name|os_realloc
argument_list|(
name|buf
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf2
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|buf
operator|=
name|buf2
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|start
operator|=
name|os_strstr
argument_list|(
name|buf
argument_list|,
literal|"<!DOCTYPE "
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
condition|)
block|{
name|char
modifier|*
name|pos
init|=
name|start
operator|+
literal|1
decl_stmt|;
name|int
name|count
init|=
literal|1
decl_stmt|;
while|while
condition|(
operator|*
name|pos
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
literal|'<'
condition|)
name|count
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|pos
operator|==
literal|'>'
condition|)
block|{
name|count
operator|--
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|pos
operator|++
expr_stmt|;
break|break;
block|}
block|}
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
comment|/* Remove DOCTYPE to allow the file to be parsed */
name|os_memset
argument_list|(
name|start
argument_list|,
literal|' '
argument_list|,
name|pos
operator|-
name|start
argument_list|)
expr_stmt|;
block|}
block|}
name|node
operator|=
name|xml_node_from_buf
argument_list|(
name|ctx
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|node
return|;
block|}
end_function

begin_function
name|int
name|node_to_file
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|str
operator|=
name|xml_node_to_str
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|f
condition|)
block|{
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|get_val
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|char
modifier|*
name|val
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|val
operator|=
name|xml_node_get_text
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|val
expr_stmt|;
while|while
condition|(
operator|*
name|pos
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|!=
literal|' '
operator|&&
operator|*
name|pos
operator|!=
literal|'\t'
operator|&&
operator|*
name|pos
operator|!=
literal|'\r'
operator|&&
operator|*
name|pos
operator|!=
literal|'\n'
condition|)
return|return
name|val
return|;
name|pos
operator|++
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|add_path
parameter_list|(
specifier|const
name|char
modifier|*
name|prev
parameter_list|,
specifier|const
name|char
modifier|*
name|leaf
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|char
modifier|*
name|new_uri
decl_stmt|;
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|len
operator|=
name|os_strlen
argument_list|(
name|prev
argument_list|)
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|leaf
argument_list|)
operator|+
literal|1
expr_stmt|;
name|new_uri
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_uri
condition|)
name|os_snprintf
argument_list|(
name|new_uri
argument_list|,
name|len
argument_list|,
literal|"%s/%s"
argument_list|,
name|prev
argument_list|,
name|leaf
argument_list|)
expr_stmt|;
return|return
name|new_uri
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|node_to_tnds
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|out
parameter_list|,
name|xml_node_t
modifier|*
name|in
parameter_list|,
specifier|const
name|char
modifier|*
name|uri
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|xml_node_t
modifier|*
name|tnds
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
name|char
modifier|*
name|new_uri
decl_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx
argument_list|,
argument|node
argument_list|,
argument|in
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|tnds
operator|=
name|xml_node_create
argument_list|(
name|ctx
argument_list|,
name|out
argument_list|,
name|NULL
argument_list|,
literal|"Node"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tnds
operator|==
name|NULL
condition|)
return|return;
name|xml_node_create_text
argument_list|(
name|ctx
argument_list|,
name|tnds
argument_list|,
name|NULL
argument_list|,
literal|"NodeName"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|uri
condition|)
name|xml_node_create_text
argument_list|(
name|ctx
argument_list|,
name|tnds
argument_list|,
name|NULL
argument_list|,
literal|"Path"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|val
operator|=
name|get_val
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
condition|)
block|{
name|xml_node_create_text
argument_list|(
name|ctx
argument_list|,
name|tnds
argument_list|,
name|NULL
argument_list|,
literal|"Value"
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
argument_list|,
name|val
argument_list|)
expr_stmt|;
block|}
name|new_uri
operator|=
name|add_path
argument_list|(
name|uri
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|node_to_tnds
argument_list|(
name|ctx
argument_list|,
name|new_uri
condition|?
name|out
else|:
name|tnds
argument_list|,
name|node
argument_list|,
name|new_uri
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|new_uri
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|add_ddfname
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|parent
parameter_list|,
specifier|const
name|char
modifier|*
name|urn
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|node
operator|=
name|xml_node_create
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
name|NULL
argument_list|,
literal|"RTProperties"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|node
operator|=
name|xml_node_create
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"Type"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|xml_node_create_text
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"DDFName"
argument_list|,
name|urn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|xml_node_t
modifier|*
name|mo_to_tnds
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|mo
parameter_list|,
name|int
name|use_path
parameter_list|,
specifier|const
name|char
modifier|*
name|urn
parameter_list|,
specifier|const
name|char
modifier|*
name|ns_uri
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|root
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|root
operator|=
name|xml_node_create_root
argument_list|(
name|ctx
argument_list|,
name|ns_uri
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|"MgmtTree"
argument_list|)
expr_stmt|;
if|if
condition|(
name|root
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|xml_node_create_text
argument_list|(
name|ctx
argument_list|,
name|root
argument_list|,
name|NULL
argument_list|,
literal|"VerDTD"
argument_list|,
literal|"1.2"
argument_list|)
expr_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
argument_list|,
name|mo
argument_list|)
expr_stmt|;
name|node
operator|=
name|xml_node_create
argument_list|(
name|ctx
argument_list|,
name|root
argument_list|,
name|NULL
argument_list|,
literal|"Node"
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|xml_node_create_text
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|,
literal|"NodeName"
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|urn
condition|)
name|add_ddfname
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|urn
argument_list|)
expr_stmt|;
name|node_to_tnds
argument_list|(
name|ctx
argument_list|,
name|use_path
condition|?
name|root
else|:
name|node
argument_list|,
name|mo
argument_list|,
name|use_path
condition|?
name|name
else|:
name|NULL
argument_list|)
expr_stmt|;
return|return
name|root
return|;
name|fail
label|:
name|xml_node_free
argument_list|(
name|ctx
argument_list|,
name|root
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|get_first_child_node
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|lname
decl_stmt|;
name|xml_node_t
modifier|*
name|child
decl_stmt|;
name|xml_node_for_each_child
argument_list|(
argument|ctx
argument_list|,
argument|child
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
name|lname
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|lname
argument_list|,
name|name
argument_list|)
operator|==
literal|0
condition|)
return|return
name|child
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|get_node_text
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|node_name
parameter_list|)
block|{
name|node
operator|=
name|get_first_child_node
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
name|node_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|node
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
return|return
name|xml_node_get_text
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|add_mo_node
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|root
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|uri
parameter_list|)
block|{
name|char
modifier|*
name|nodename
decl_stmt|,
modifier|*
name|value
decl_stmt|,
modifier|*
name|path
decl_stmt|;
name|xml_node_t
modifier|*
name|parent
decl_stmt|;
name|nodename
operator|=
name|get_node_text
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
literal|"NodeName"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nodename
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|value
operator|=
name|get_node_text
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
literal|"Value"
argument_list|)
expr_stmt|;
if|if
condition|(
name|root
operator|==
name|NULL
condition|)
block|{
name|root
operator|=
name|xml_node_create_root
argument_list|(
name|ctx
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
if|if
condition|(
name|root
operator|&&
name|value
condition|)
name|xml_node_set_text
argument_list|(
name|ctx
argument_list|,
name|root
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|uri
operator|==
name|NULL
condition|)
block|{
name|xml_node_get_text_free
argument_list|(
name|ctx
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|path
operator|=
name|get_node_text
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
literal|"Path"
argument_list|)
expr_stmt|;
if|if
condition|(
name|path
condition|)
name|uri
operator|=
name|path
expr_stmt|;
name|parent
operator|=
name|get_node_uri
argument_list|(
name|ctx
argument_list|,
name|root
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|parent
operator|==
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"Could not find URI '%s'\n"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|value
condition|)
name|xml_node_create_text
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
name|NULL
argument_list|,
name|nodename
argument_list|,
name|value
argument_list|)
expr_stmt|;
else|else
name|xml_node_create
argument_list|(
name|ctx
argument_list|,
name|parent
argument_list|,
name|NULL
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|root
return|;
block|}
end_function

begin_function
specifier|static
name|xml_node_t
modifier|*
name|tnds_to_mo_iter
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|root
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|,
specifier|const
name|char
modifier|*
name|uri
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|child
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|nodename
decl_stmt|;
name|xml_node_for_each_sibling
argument_list|(
argument|ctx
argument_list|,
argument|node
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
name|nodename
operator|=
name|get_node_text
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
literal|"NodeName"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nodename
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|)
expr_stmt|;
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"Node"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|root
operator|&&
operator|!
name|uri
condition|)
block|{
name|printf
argument_list|(
literal|"Invalid TNDS tree structure - "
literal|"multiple top level nodes\n"
argument_list|)
expr_stmt|;
name|xml_node_get_text_free
argument_list|(
name|ctx
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|root
operator|=
name|add_mo_node
argument_list|(
name|ctx
argument_list|,
name|root
argument_list|,
name|node
argument_list|,
name|uri
argument_list|)
expr_stmt|;
block|}
name|child
operator|=
name|get_first_child_node
argument_list|(
name|ctx
argument_list|,
name|node
argument_list|,
literal|"Node"
argument_list|)
expr_stmt|;
if|if
condition|(
name|child
condition|)
block|{
if|if
condition|(
name|uri
operator|==
name|NULL
condition|)
name|tnds_to_mo_iter
argument_list|(
name|ctx
argument_list|,
name|root
argument_list|,
name|child
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
else|else
block|{
name|char
modifier|*
name|new_uri
decl_stmt|;
name|new_uri
operator|=
name|add_path
argument_list|(
name|uri
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
name|tnds_to_mo_iter
argument_list|(
name|ctx
argument_list|,
name|root
argument_list|,
name|child
argument_list|,
name|new_uri
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|new_uri
argument_list|)
expr_stmt|;
block|}
block|}
name|xml_node_get_text_free
argument_list|(
name|ctx
argument_list|,
name|nodename
argument_list|)
expr_stmt|;
block|}
return|return
name|root
return|;
block|}
end_function

begin_function
name|xml_node_t
modifier|*
name|tnds_to_mo
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|tnds
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|xml_node_t
modifier|*
name|node
decl_stmt|;
name|name
operator|=
name|xml_node_get_localname
argument_list|(
name|ctx
argument_list|,
name|tnds
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
operator|||
name|os_strcmp
argument_list|(
name|name
argument_list|,
literal|"MgmtTree"
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
name|node
operator|=
name|get_first_child_node
argument_list|(
name|ctx
argument_list|,
name|tnds
argument_list|,
literal|"Node"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|node
condition|)
return|return
name|NULL
return|;
return|return
name|tnds_to_mo_iter
argument_list|(
name|ctx
argument_list|,
name|NULL
argument_list|,
name|node
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|xml_node_t
modifier|*
name|soap_build_envelope
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|node
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|envelope
decl_stmt|,
modifier|*
name|body
decl_stmt|;
name|xml_namespace_t
modifier|*
name|ns
decl_stmt|;
name|envelope
operator|=
name|xml_node_create_root
argument_list|(
name|ctx
argument_list|,
literal|"http://www.w3.org/2003/05/soap-envelope"
argument_list|,
literal|"soap12"
argument_list|,
operator|&
name|ns
argument_list|,
literal|"Envelope"
argument_list|)
expr_stmt|;
if|if
condition|(
name|envelope
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|body
operator|=
name|xml_node_create
argument_list|(
name|ctx
argument_list|,
name|envelope
argument_list|,
name|ns
argument_list|,
literal|"Body"
argument_list|)
expr_stmt|;
name|xml_node_add_child
argument_list|(
name|ctx
argument_list|,
name|body
argument_list|,
name|node
argument_list|)
expr_stmt|;
return|return
name|envelope
return|;
block|}
end_function

begin_function
name|xml_node_t
modifier|*
name|soap_get_body
parameter_list|(
name|struct
name|xml_node_ctx
modifier|*
name|ctx
parameter_list|,
name|xml_node_t
modifier|*
name|soap
parameter_list|)
block|{
name|xml_node_t
modifier|*
name|body
decl_stmt|,
modifier|*
name|child
decl_stmt|;
name|body
operator|=
name|get_node_uri
argument_list|(
name|ctx
argument_list|,
name|soap
argument_list|,
literal|"Envelope/Body"
argument_list|)
expr_stmt|;
if|if
condition|(
name|body
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|xml_node_for_each_child
argument_list|(
argument|ctx
argument_list|,
argument|child
argument_list|,
argument|body
argument_list|)
block|{
name|xml_node_for_each_check
argument_list|(
name|ctx
argument_list|,
name|child
argument_list|)
expr_stmt|;
return|return
name|child
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

end_unit


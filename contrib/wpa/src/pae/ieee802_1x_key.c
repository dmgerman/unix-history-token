begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * IEEE 802.1X-2010 Key Hierarchy  * Copyright (c) 2013, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  *  * SAK derivation specified in IEEE Std 802.1X-2010, Clause 6.2 */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/md5.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha1.h"
end_include

begin_include
include|#
directive|include
file|"crypto/aes_wrap.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x_key.h"
end_include

begin_function
specifier|static
name|void
name|joint_two_mac
parameter_list|(
specifier|const
name|u8
modifier|*
name|mac1
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac2
parameter_list|,
name|u8
modifier|*
name|out
parameter_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|mac1
argument_list|,
name|mac2
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|out
argument_list|,
name|mac1
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|out
operator|+
name|ETH_ALEN
argument_list|,
name|mac2
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|out
argument_list|,
name|mac2
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|out
operator|+
name|ETH_ALEN
argument_list|,
name|mac1
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* IEEE Std 802.1X-2010, 6.2.1 KDF */
end_comment

begin_function
specifier|static
name|int
name|aes_kdf_128
parameter_list|(
specifier|const
name|u8
modifier|*
name|kdk
parameter_list|,
specifier|const
name|char
modifier|*
name|label
parameter_list|,
specifier|const
name|u8
modifier|*
name|context
parameter_list|,
name|int
name|ctx_bits
parameter_list|,
name|int
name|ret_bits
parameter_list|,
name|u8
modifier|*
name|ret
parameter_list|)
block|{
specifier|const
name|int
name|h
init|=
literal|128
decl_stmt|;
specifier|const
name|int
name|r
init|=
literal|8
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|;
name|int
name|lab_len
decl_stmt|,
name|ctx_len
decl_stmt|,
name|ret_len
decl_stmt|,
name|buf_len
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|;
name|lab_len
operator|=
name|os_strlen
argument_list|(
name|label
argument_list|)
expr_stmt|;
name|ctx_len
operator|=
operator|(
name|ctx_bits
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
name|ret_len
operator|=
operator|(
operator|(
name|ret_bits
operator|&
literal|0xffff
operator|)
operator|+
literal|7
operator|)
operator|/
literal|8
expr_stmt|;
name|buf_len
operator|=
name|lab_len
operator|+
name|ctx_len
operator|+
literal|4
expr_stmt|;
name|os_memset
argument_list|(
name|ret
argument_list|,
literal|0
argument_list|,
name|ret_len
argument_list|)
expr_stmt|;
name|n
operator|=
operator|(
name|ret_bits
operator|+
name|h
operator|-
literal|1
operator|)
operator|/
name|h
expr_stmt|;
if|if
condition|(
name|n
operator|>
operator|(
operator|(
literal|0x1
operator|<<
name|r
operator|)
operator|-
literal|1
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|buf
operator|=
name|os_zalloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
name|label
argument_list|,
name|lab_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|buf
operator|+
name|lab_len
operator|+
literal|2
argument_list|,
name|context
argument_list|,
name|ctx_len
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
operator|&
name|buf
index|[
name|buf_len
operator|-
literal|2
index|]
argument_list|,
name|ret_bits
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|buf
index|[
literal|0
index|]
operator|=
call|(
name|u8
call|)
argument_list|(
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|omac1_aes_128
argument_list|(
name|kdk
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|,
name|ret
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|ret
operator|+
name|h
operator|/
literal|8
expr_stmt|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/********** AES-CMAC-128 **********/
end_comment

begin_comment
comment|/**  * ieee802_1x_cak_128bits_aes_cmac  *  * IEEE Std 802.1X-2010, 6.2.2  * CAK = KDF(Key, Label, mac1 | mac2, CAKlength)  */
end_comment

begin_function
name|int
name|ieee802_1x_cak_128bits_aes_cmac
parameter_list|(
specifier|const
name|u8
modifier|*
name|msk
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac1
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac2
parameter_list|,
name|u8
modifier|*
name|cak
parameter_list|)
block|{
name|u8
name|context
index|[
literal|2
operator|*
name|ETH_ALEN
index|]
decl_stmt|;
name|joint_two_mac
argument_list|(
name|mac1
argument_list|,
name|mac2
argument_list|,
name|context
argument_list|)
expr_stmt|;
return|return
name|aes_kdf_128
argument_list|(
name|msk
argument_list|,
literal|"IEEE8021 EAP CAK"
argument_list|,
name|context
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
operator|*
literal|8
argument_list|,
literal|128
argument_list|,
name|cak
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_ckn_128bits_aes_cmac  *  * IEEE Std 802.1X-2010, 6.2.2  * CKN = KDF(Key, Label, ID | mac1 | mac2, CKNlength)  */
end_comment

begin_function
name|int
name|ieee802_1x_ckn_128bits_aes_cmac
parameter_list|(
specifier|const
name|u8
modifier|*
name|msk
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac1
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac2
parameter_list|,
specifier|const
name|u8
modifier|*
name|sid
parameter_list|,
name|size_t
name|sid_bytes
parameter_list|,
name|u8
modifier|*
name|ckn
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|u8
modifier|*
name|context
decl_stmt|;
name|size_t
name|ctx_len
init|=
name|sid_bytes
operator|+
name|ETH_ALEN
operator|*
literal|2
decl_stmt|;
name|context
operator|=
name|os_zalloc
argument_list|(
name|ctx_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|context
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"MKA-%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|context
argument_list|,
name|sid
argument_list|,
name|sid_bytes
argument_list|)
expr_stmt|;
name|joint_two_mac
argument_list|(
name|mac1
argument_list|,
name|mac2
argument_list|,
name|context
operator|+
name|sid_bytes
argument_list|)
expr_stmt|;
name|res
operator|=
name|aes_kdf_128
argument_list|(
name|msk
argument_list|,
literal|"IEEE8021 EAP CKN"
argument_list|,
name|context
argument_list|,
name|ctx_len
operator|*
literal|8
argument_list|,
literal|128
argument_list|,
name|ckn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kek_128bits_aes_cmac  *  * IEEE Std 802.1X-2010, 9.3.3  * KEK = KDF(Key, Label, Keyid, KEKLength)  */
end_comment

begin_function
name|int
name|ieee802_1x_kek_128bits_aes_cmac
parameter_list|(
specifier|const
name|u8
modifier|*
name|cak
parameter_list|,
specifier|const
name|u8
modifier|*
name|ckn
parameter_list|,
name|size_t
name|ckn_bytes
parameter_list|,
name|u8
modifier|*
name|kek
parameter_list|)
block|{
name|u8
name|context
index|[
literal|16
index|]
decl_stmt|;
comment|/* First 16 octets of CKN, with null octets appended to pad if needed */
name|os_memset
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|context
argument_list|,
name|ckn
argument_list|,
operator|(
name|ckn_bytes
operator|<
literal|16
operator|)
condition|?
name|ckn_bytes
else|:
literal|16
argument_list|)
expr_stmt|;
return|return
name|aes_kdf_128
argument_list|(
name|cak
argument_list|,
literal|"IEEE8021 KEK"
argument_list|,
name|context
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
operator|*
literal|8
argument_list|,
literal|128
argument_list|,
name|kek
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_ick_128bits_aes_cmac  *  * IEEE Std 802.1X-2010, 9.3.3  * ICK = KDF(Key, Label, Keyid, ICKLength)  */
end_comment

begin_function
name|int
name|ieee802_1x_ick_128bits_aes_cmac
parameter_list|(
specifier|const
name|u8
modifier|*
name|cak
parameter_list|,
specifier|const
name|u8
modifier|*
name|ckn
parameter_list|,
name|size_t
name|ckn_bytes
parameter_list|,
name|u8
modifier|*
name|ick
parameter_list|)
block|{
name|u8
name|context
index|[
literal|16
index|]
decl_stmt|;
comment|/* First 16 octets of CKN, with null octets appended to pad if needed */
name|os_memset
argument_list|(
name|context
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|context
argument_list|,
name|ckn
argument_list|,
operator|(
name|ckn_bytes
operator|<
literal|16
operator|)
condition|?
name|ckn_bytes
else|:
literal|16
argument_list|)
expr_stmt|;
return|return
name|aes_kdf_128
argument_list|(
name|cak
argument_list|,
literal|"IEEE8021 ICK"
argument_list|,
name|context
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
operator|*
literal|8
argument_list|,
literal|128
argument_list|,
name|ick
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_icv_128bits_aes_cmac  *  * IEEE Std 802.1X-2010, 9.4.1  * ICV = AES-CMAC(ICK, M, 128)  */
end_comment

begin_function
name|int
name|ieee802_1x_icv_128bits_aes_cmac
parameter_list|(
specifier|const
name|u8
modifier|*
name|ick
parameter_list|,
specifier|const
name|u8
modifier|*
name|msg
parameter_list|,
name|size_t
name|msg_bytes
parameter_list|,
name|u8
modifier|*
name|icv
parameter_list|)
block|{
if|if
condition|(
name|omac1_aes_128
argument_list|(
name|ick
argument_list|,
name|msg
argument_list|,
name|msg_bytes
argument_list|,
name|icv
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"MKA: omac1_aes_128 failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_sak_128bits_aes_cmac  *  * IEEE Std 802.1X-2010, 9.8.1  * SAK = KDF(Key, Label, KS-nonce | MI-value list | KN, SAKLength)  */
end_comment

begin_function
name|int
name|ieee802_1x_sak_128bits_aes_cmac
parameter_list|(
specifier|const
name|u8
modifier|*
name|cak
parameter_list|,
specifier|const
name|u8
modifier|*
name|ctx
parameter_list|,
name|size_t
name|ctx_bytes
parameter_list|,
name|u8
modifier|*
name|sak
parameter_list|)
block|{
return|return
name|aes_kdf_128
argument_list|(
name|cak
argument_list|,
literal|"IEEE8021 SAK"
argument_list|,
name|ctx
argument_list|,
name|ctx_bytes
operator|*
literal|8
argument_list|,
literal|128
argument_list|,
name|sak
argument_list|)
return|;
block|}
end_function

end_unit


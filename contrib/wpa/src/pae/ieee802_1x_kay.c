begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * IEEE 802.1X-2010 Key Agree Protocol of PAE state machine  * Copyright (c) 2013, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"list.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"wpabuf.h"
end_include

begin_include
include|#
directive|include
file|"state_machine.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"common/eapol_common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/aes_wrap.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x_cp.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x_key.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x_kay.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x_kay_i.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x_secy_ops.h"
end_include

begin_define
define|#
directive|define
name|DEFAULT_SA_KEY_LEN
value|16
end_define

begin_define
define|#
directive|define
name|DEFAULT_ICV_LEN
value|16
end_define

begin_define
define|#
directive|define
name|MAX_ICV_LEN
value|32
end_define

begin_comment
comment|/* 32 bytes, 256 bits */
end_comment

begin_define
define|#
directive|define
name|PENDING_PN_EXHAUSTION
value|0xC0000000
end_define

begin_comment
comment|/* IEEE Std 802.1X-2010, Table 9-1 - MKA Algorithm Agility */
end_comment

begin_define
define|#
directive|define
name|MKA_ALGO_AGILITY_2009
value|{ 0x00, 0x80, 0xC2, 0x01 }
end_define

begin_decl_stmt
specifier|static
name|u8
name|mka_algo_agility
index|[
literal|4
index|]
init|=
name|MKA_ALGO_AGILITY_2009
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* IEEE802.1AE-2006 Table 14-1 MACsec Cipher Suites */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|macsec_ciphersuite
name|cipher_suite_tbl
index|[]
init|=
block|{
comment|/* GCM-AES-128 */
block|{
name|CS_ID_GCM_AES_128
block|,
name|CS_NAME_GCM_AES_128
block|,
name|MACSEC_CAP_INTEG_AND_CONF_0_30_50
block|,
literal|16
block|,
literal|0
comment|/* index */
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|CS_TABLE_SIZE
value|(ARRAY_SIZE(cipher_suite_tbl))
end_define

begin_define
define|#
directive|define
name|DEFAULT_CS_INDEX
value|0
end_define

begin_decl_stmt
specifier|static
name|struct
name|mka_alg
name|mka_alg_tbl
index|[]
init|=
block|{
block|{
name|MKA_ALGO_AGILITY_2009
block|,
comment|/* 128-bit CAK, KEK, ICK, ICV */
literal|16
block|,
literal|16
block|,
literal|16
block|,
literal|16
block|,
name|ieee802_1x_cak_128bits_aes_cmac
block|,
name|ieee802_1x_ckn_128bits_aes_cmac
block|,
name|ieee802_1x_kek_128bits_aes_cmac
block|,
name|ieee802_1x_ick_128bits_aes_cmac
block|,
name|ieee802_1x_icv_128bits_aes_cmac
block|,
literal|1
block|,
comment|/* index */
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MKA_ALG_TABLE_SIZE
value|(ARRAY_SIZE(mka_alg_tbl))
end_define

begin_function
specifier|static
name|int
name|is_ki_equal
parameter_list|(
name|struct
name|ieee802_1x_mka_ki
modifier|*
name|ki1
parameter_list|,
name|struct
name|ieee802_1x_mka_ki
modifier|*
name|ki2
parameter_list|)
block|{
return|return
name|os_memcmp
argument_list|(
name|ki1
operator|->
name|mi
argument_list|,
name|ki2
operator|->
name|mi
argument_list|,
name|MI_LEN
argument_list|)
operator|==
literal|0
operator|&&
name|ki1
operator|->
name|kn
operator|==
name|ki2
operator|->
name|kn
return|;
block|}
end_function

begin_struct
struct|struct
name|mka_param_body_handler
block|{
name|int
function_decl|(
modifier|*
name|body_tx
function_decl|)
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|body_rx
function_decl|)
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mka_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|body_length
function_decl|)
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
function_decl|;
name|Boolean
function_decl|(
modifier|*
name|body_present
function_decl|)
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|set_mka_param_body_len
parameter_list|(
name|void
modifier|*
name|body
parameter_list|,
name|unsigned
name|int
name|len
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
init|=
name|body
decl_stmt|;
name|hdr
operator|->
name|length
operator|=
operator|(
name|len
operator|>>
literal|8
operator|)
operator|&
literal|0x0f
expr_stmt|;
name|hdr
operator|->
name|length1
operator|=
name|len
operator|&
literal|0xff
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|get_mka_param_body_len
parameter_list|(
specifier|const
name|void
modifier|*
name|body
parameter_list|)
block|{
specifier|const
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
init|=
name|body
decl_stmt|;
return|return
operator|(
name|hdr
operator|->
name|length
operator|<<
literal|8
operator|)
operator||
name|hdr
operator|->
name|length1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_mka_param_body_type
parameter_list|(
specifier|const
name|void
modifier|*
name|body
parameter_list|)
block|{
specifier|const
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
init|=
name|body
decl_stmt|;
return|return
name|hdr
operator|->
name|type
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_dump_basic_body -  */
end_comment

begin_function
specifier|static
name|void
name|ieee802_1x_mka_dump_basic_body
parameter_list|(
name|struct
name|ieee802_1x_mka_basic_body
modifier|*
name|body
parameter_list|)
block|{
name|size_t
name|body_len
decl_stmt|;
if|if
condition|(
operator|!
name|body
condition|)
return|return;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|body
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"*** MKA Basic Parameter set ***"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tVersion.......: %d"
argument_list|,
name|body
operator|->
name|version
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tPriority......: %d"
argument_list|,
name|body
operator|->
name|priority
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tKeySvr........: %d"
argument_list|,
name|body
operator|->
name|key_server
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMACSecDesired.: %d"
argument_list|,
name|body
operator|->
name|macsec_desired
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMACSecCapable.: %d"
argument_list|,
name|body
operator|->
name|macsec_capbility
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tBody Length...: %d"
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tSCI MAC.......: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|body
operator|->
name|actor_sci
operator|.
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tSCI Port .....: %d"
argument_list|,
name|be_to_host16
argument_list|(
name|body
operator|->
name|actor_sci
operator|.
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMember Id.....:"
argument_list|,
name|body
operator|->
name|actor_mi
argument_list|,
sizeof|sizeof
argument_list|(
name|body
operator|->
name|actor_mi
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMessage Number: %d"
argument_list|,
name|be_to_host32
argument_list|(
name|body
operator|->
name|actor_mn
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tAlgo Agility..:"
argument_list|,
name|body
operator|->
name|algo_agility
argument_list|,
sizeof|sizeof
argument_list|(
name|body
operator|->
name|algo_agility
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tCAK Name......:"
argument_list|,
name|body
operator|->
name|ckn
argument_list|,
name|body_len
operator|+
name|MKA_HDR_LEN
operator|-
sizeof|sizeof
argument_list|(
operator|*
name|body
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_dump_peer_body -  */
end_comment

begin_function
specifier|static
name|void
name|ieee802_1x_mka_dump_peer_body
parameter_list|(
name|struct
name|ieee802_1x_mka_peer_body
modifier|*
name|body
parameter_list|)
block|{
name|size_t
name|body_len
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|u8
modifier|*
name|mi
decl_stmt|;
name|u32
name|mn
decl_stmt|;
if|if
condition|(
name|body
operator|==
name|NULL
condition|)
return|return;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|body
argument_list|)
expr_stmt|;
if|if
condition|(
name|body
operator|->
name|type
operator|==
name|MKA_LIVE_PEER_LIST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"*** Live Peer List ***"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tBody Length...: %d"
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|body
operator|->
name|type
operator|==
name|MKA_POTENTIAL_PEER_LIST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"*** Potential Live Peer List ***"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tBody Length...: %d"
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|body_len
condition|;
name|i
operator|+=
name|MI_LEN
operator|+
sizeof|sizeof
argument_list|(
name|mn
argument_list|)
control|)
block|{
name|mi
operator|=
name|body
operator|->
name|peer
operator|+
name|i
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|mn
argument_list|,
name|mi
operator|+
name|MI_LEN
argument_list|,
sizeof|sizeof
argument_list|(
name|mn
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMember Id.....:"
argument_list|,
name|mi
argument_list|,
name|MI_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMessage Number: %d"
argument_list|,
name|be_to_host32
argument_list|(
name|mn
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_dump_dist_sak_body -  */
end_comment

begin_function
specifier|static
name|void
name|ieee802_1x_mka_dump_dist_sak_body
parameter_list|(
name|struct
name|ieee802_1x_mka_dist_sak_body
modifier|*
name|body
parameter_list|)
block|{
name|size_t
name|body_len
decl_stmt|;
if|if
condition|(
name|body
operator|==
name|NULL
condition|)
return|return;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|body
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"*** Distributed SAK ***"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"\tDistributed AN........: %d"
argument_list|,
name|body
operator|->
name|dan
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"\tConfidentiality Offset: %d"
argument_list|,
name|body
operator|->
name|confid_offset
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"\tBody Length...........: %d"
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|body_len
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"\tKey Number............: %d"
argument_list|,
name|be_to_host32
argument_list|(
name|body
operator|->
name|kn
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_INFO
argument_list|,
literal|"\tAES Key Wrap of SAK...:"
argument_list|,
name|body
operator|->
name|sak
argument_list|,
literal|24
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|yes_no
parameter_list|(
name|int
name|val
parameter_list|)
block|{
return|return
name|val
condition|?
literal|"Yes"
else|:
literal|"No"
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_dump_sak_use_body -  */
end_comment

begin_function
specifier|static
name|void
name|ieee802_1x_mka_dump_sak_use_body
parameter_list|(
name|struct
name|ieee802_1x_mka_sak_use_body
modifier|*
name|body
parameter_list|)
block|{
name|int
name|body_len
decl_stmt|;
if|if
condition|(
name|body
operator|==
name|NULL
condition|)
return|return;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|body
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"*** MACsec SAK Use ***"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tLatest Key AN....: %d"
argument_list|,
name|body
operator|->
name|lan
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tLatest Key Tx....: %s"
argument_list|,
name|yes_no
argument_list|(
name|body
operator|->
name|ltx
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tLatest Key Rx....: %s"
argument_list|,
name|yes_no
argument_list|(
name|body
operator|->
name|lrx
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tOld Key AN....: %d"
argument_list|,
name|body
operator|->
name|oan
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tOld Key Tx....: %s"
argument_list|,
name|yes_no
argument_list|(
name|body
operator|->
name|otx
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tOld Key Rx....: %s"
argument_list|,
name|yes_no
argument_list|(
name|body
operator|->
name|orx
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tPlain Key Tx....: %s"
argument_list|,
name|yes_no
argument_list|(
name|body
operator|->
name|ptx
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tPlain Key Rx....: %s"
argument_list|,
name|yes_no
argument_list|(
name|body
operator|->
name|prx
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tDelay Protect....: %s"
argument_list|,
name|yes_no
argument_list|(
name|body
operator|->
name|delay_protect
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tBody Length......: %d"
argument_list|,
name|body_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|body_len
condition|)
return|return;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tKey Server MI....:"
argument_list|,
name|body
operator|->
name|lsrv_mi
argument_list|,
sizeof|sizeof
argument_list|(
name|body
operator|->
name|lsrv_mi
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tKey Number.......: %u"
argument_list|,
name|be_to_host32
argument_list|(
name|body
operator|->
name|lkn
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tLowest PN........: %u"
argument_list|,
name|be_to_host32
argument_list|(
name|body
operator|->
name|llpn
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tOld Key Server MI....:"
argument_list|,
name|body
operator|->
name|osrv_mi
argument_list|,
sizeof|sizeof
argument_list|(
name|body
operator|->
name|osrv_mi
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tOld Key Number.......: %u"
argument_list|,
name|be_to_host32
argument_list|(
name|body
operator|->
name|okn
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tOld Lowest PN........: %u"
argument_list|,
name|be_to_host32
argument_list|(
name|body
operator|->
name|olpn
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_get_participant -  */
end_comment

begin_function
specifier|static
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|ieee802_1x_kay_get_participant
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
specifier|const
name|u8
modifier|*
name|ckn
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|participant
argument_list|,
argument|&kay->participant_list
argument_list|,
argument|struct ieee802_1x_mka_participant
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|participant
operator|->
name|ckn
operator|.
name|name
argument_list|,
name|ckn
argument_list|,
name|participant
operator|->
name|ckn
operator|.
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
name|participant
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: participant is not found"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_get_principal_participant -  */
end_comment

begin_function
specifier|static
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|ieee802_1x_kay_get_principal_participant
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|participant
argument_list|,
argument|&kay->participant_list
argument_list|,
argument|struct ieee802_1x_mka_participant
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|participant
operator|->
name|principal
condition|)
return|return
name|participant
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: principal participant is not founded"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|get_peer_mi
parameter_list|(
name|struct
name|dl_list
modifier|*
name|peers
parameter_list|,
specifier|const
name|u8
modifier|*
name|mi
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|mi
argument_list|,
name|mi
argument_list|,
name|MI_LEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|peer
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_is_in_potential_peer  */
end_comment

begin_function
specifier|static
name|Boolean
name|ieee802_1x_kay_is_in_potential_peer
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mi
parameter_list|)
block|{
return|return
name|get_peer_mi
argument_list|(
operator|&
name|participant
operator|->
name|potential_peers
argument_list|,
name|mi
argument_list|)
operator|!=
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_is_in_live_peer  */
end_comment

begin_function
specifier|static
name|Boolean
name|ieee802_1x_kay_is_in_live_peer
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mi
parameter_list|)
block|{
return|return
name|get_peer_mi
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|,
name|mi
argument_list|)
operator|!=
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_is_in_peer  */
end_comment

begin_function
specifier|static
name|Boolean
name|ieee802_1x_kay_is_in_peer
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mi
parameter_list|)
block|{
return|return
name|ieee802_1x_kay_is_in_live_peer
argument_list|(
name|participant
argument_list|,
name|mi
argument_list|)
operator|||
name|ieee802_1x_kay_is_in_potential_peer
argument_list|(
name|participant
argument_list|,
name|mi
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_get_peer  */
end_comment

begin_function
specifier|static
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|ieee802_1x_kay_get_peer
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mi
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|peer
operator|=
name|get_peer_mi
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|,
name|mi
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
condition|)
return|return
name|peer
return|;
return|return
name|get_peer_mi
argument_list|(
operator|&
name|participant
operator|->
name|potential_peers
argument_list|,
name|mi
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_get_live_peer  */
end_comment

begin_function
specifier|static
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|ieee802_1x_kay_get_live_peer
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mi
parameter_list|)
block|{
return|return
name|get_peer_mi
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|,
name|mi
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_get_cipher_suite  */
end_comment

begin_function
specifier|static
name|struct
name|macsec_ciphersuite
modifier|*
name|ieee802_1x_kay_get_cipher_suite
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|u8
modifier|*
name|cs_id
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|CS_TABLE_SIZE
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|cipher_suite_tbl
index|[
name|i
index|]
operator|.
name|id
argument_list|,
name|cs_id
argument_list|,
name|CS_ID_LEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|CS_TABLE_SIZE
condition|)
return|return
name|NULL
return|;
return|return
operator|&
name|cipher_suite_tbl
index|[
name|i
index|]
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_get_peer_sci  */
end_comment

begin_function
specifier|static
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|ieee802_1x_kay_get_peer_sci
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|struct
name|ieee802_1x_mka_sci
modifier|*
name|sci
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->live_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
operator|&
name|peer
operator|->
name|sci
argument_list|,
name|sci
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|sci
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
name|peer
return|;
block|}
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->potential_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
operator|&
name|peer
operator|->
name|sci
argument_list|,
name|sci
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|sci
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
return|return
name|peer
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_init_receive_sa -  */
end_comment

begin_function
specifier|static
name|struct
name|receive_sa
modifier|*
name|ieee802_1x_kay_init_receive_sa
parameter_list|(
name|struct
name|receive_sc
modifier|*
name|psc
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
name|lowest_pn
parameter_list|,
name|struct
name|data_key
modifier|*
name|key
parameter_list|)
block|{
name|struct
name|receive_sa
modifier|*
name|psa
decl_stmt|;
if|if
condition|(
operator|!
name|psc
operator|||
operator|!
name|key
condition|)
return|return
name|NULL
return|;
name|psa
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|psa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|psa
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|psa
operator|->
name|pkey
operator|=
name|key
expr_stmt|;
name|psa
operator|->
name|lowest_pn
operator|=
name|lowest_pn
expr_stmt|;
name|psa
operator|->
name|next_pn
operator|=
name|lowest_pn
expr_stmt|;
name|psa
operator|->
name|an
operator|=
name|an
expr_stmt|;
name|psa
operator|->
name|sc
operator|=
name|psc
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|psa
operator|->
name|created_time
argument_list|)
expr_stmt|;
name|psa
operator|->
name|in_use
operator|=
name|FALSE
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|psc
operator|->
name|sa_list
argument_list|,
operator|&
name|psa
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Create receive SA(AN: %d lowest_pn: %u of SC(channel: %d)"
argument_list|,
operator|(
name|int
operator|)
name|an
argument_list|,
name|lowest_pn
argument_list|,
name|psc
operator|->
name|channel
argument_list|)
expr_stmt|;
return|return
name|psa
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_deinit_receive_sa -  */
end_comment

begin_function
specifier|static
name|void
name|ieee802_1x_kay_deinit_receive_sa
parameter_list|(
name|struct
name|receive_sa
modifier|*
name|psa
parameter_list|)
block|{
name|psa
operator|->
name|pkey
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Delete receive SA(an: %d) of SC(channel: %d)"
argument_list|,
name|psa
operator|->
name|an
argument_list|,
name|psa
operator|->
name|sc
operator|->
name|channel
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|psa
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|psa
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_init_receive_sc -  */
end_comment

begin_function
specifier|static
name|struct
name|receive_sc
modifier|*
name|ieee802_1x_kay_init_receive_sc
parameter_list|(
specifier|const
name|struct
name|ieee802_1x_mka_sci
modifier|*
name|psci
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
name|struct
name|receive_sc
modifier|*
name|psc
decl_stmt|;
if|if
condition|(
operator|!
name|psci
condition|)
return|return
name|NULL
return|;
name|psc
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|psc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|psc
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
operator|&
name|psc
operator|->
name|sci
argument_list|,
name|psci
argument_list|,
sizeof|sizeof
argument_list|(
name|psc
operator|->
name|sci
argument_list|)
argument_list|)
expr_stmt|;
name|psc
operator|->
name|channel
operator|=
name|channel
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|psc
operator|->
name|created_time
argument_list|)
expr_stmt|;
name|psc
operator|->
name|receiving
operator|=
name|FALSE
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|psc
operator|->
name|sa_list
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Create receive SC(channel: %d)"
argument_list|,
name|channel
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCI: "
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|psci
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|psci
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|psc
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_deinit_receive_sc -  **/
end_comment

begin_function
specifier|static
name|void
name|ieee802_1x_kay_deinit_receive_sc
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|struct
name|receive_sc
modifier|*
name|psc
parameter_list|)
block|{
name|struct
name|receive_sa
modifier|*
name|psa
decl_stmt|,
modifier|*
name|pre_sa
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Delete receive SC(channel: %d)"
argument_list|,
name|psc
operator|->
name|channel
argument_list|)
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|psa
argument_list|,
argument|pre_sa
argument_list|,
argument|&psc->sa_list
argument_list|,
argument|struct receive_sa
argument_list|,
argument|list
argument_list|)
block|{
name|secy_disable_receive_sa
argument_list|(
name|participant
operator|->
name|kay
argument_list|,
name|psa
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_deinit_receive_sa
argument_list|(
name|psa
argument_list|)
expr_stmt|;
block|}
name|dl_list_del
argument_list|(
operator|&
name|psc
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|psc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_create_live_peer  */
end_comment

begin_function
specifier|static
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|ieee802_1x_kay_create_live_peer
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|u8
modifier|*
name|mi
parameter_list|,
name|u32
name|mn
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|receive_sc
modifier|*
name|rxsc
decl_stmt|;
name|u32
name|sc_ch
init|=
literal|0
decl_stmt|;
name|peer
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|peer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY-%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|peer
operator|->
name|mi
argument_list|,
name|mi
argument_list|,
name|MI_LEN
argument_list|)
expr_stmt|;
name|peer
operator|->
name|mn
operator|=
name|mn
expr_stmt|;
name|peer
operator|->
name|expire
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|+
name|MKA_LIFE_TIME
operator|/
literal|1000
expr_stmt|;
name|peer
operator|->
name|sak_used
operator|=
name|FALSE
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|peer
operator|->
name|sci
argument_list|,
operator|&
name|participant
operator|->
name|current_peer_sci
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|sci
argument_list|)
argument_list|)
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|,
operator|&
name|peer
operator|->
name|list
argument_list|)
expr_stmt|;
name|secy_get_available_receive_sc
argument_list|(
name|participant
operator|->
name|kay
argument_list|,
operator|&
name|sc_ch
argument_list|)
expr_stmt|;
name|rxsc
operator|=
name|ieee802_1x_kay_init_receive_sc
argument_list|(
operator|&
name|peer
operator|->
name|sci
argument_list|,
name|sc_ch
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rxsc
condition|)
return|return
name|NULL
return|;
name|dl_list_add
argument_list|(
operator|&
name|participant
operator|->
name|rxsc_list
argument_list|,
operator|&
name|rxsc
operator|->
name|list
argument_list|)
expr_stmt|;
name|secy_create_receive_sc
argument_list|(
name|participant
operator|->
name|kay
argument_list|,
name|rxsc
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Live peer created"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMI: "
argument_list|,
name|peer
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|mi
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMN: %d"
argument_list|,
name|peer
operator|->
name|mn
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tSCI Addr: "
argument_list|,
name|peer
operator|->
name|sci
operator|.
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tPort: %d"
argument_list|,
name|peer
operator|->
name|sci
operator|.
name|port
argument_list|)
expr_stmt|;
return|return
name|peer
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_create_potential_peer  */
end_comment

begin_function
specifier|static
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|ieee802_1x_kay_create_potential_peer
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mi
parameter_list|,
name|u32
name|mn
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|peer
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|peer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY-%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|peer
operator|->
name|mi
argument_list|,
name|mi
argument_list|,
name|MI_LEN
argument_list|)
expr_stmt|;
name|peer
operator|->
name|mn
operator|=
name|mn
expr_stmt|;
name|peer
operator|->
name|expire
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|+
name|MKA_LIFE_TIME
operator|/
literal|1000
expr_stmt|;
name|peer
operator|->
name|sak_used
operator|=
name|FALSE
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|participant
operator|->
name|potential_peers
argument_list|,
operator|&
name|peer
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: potential peer created"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMI: "
argument_list|,
name|peer
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|mi
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMN: %d"
argument_list|,
name|peer
operator|->
name|mn
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tSCI Addr: "
argument_list|,
name|peer
operator|->
name|sci
operator|.
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tPort: %d"
argument_list|,
name|peer
operator|->
name|sci
operator|.
name|port
argument_list|)
expr_stmt|;
return|return
name|peer
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_move_live_peer  */
end_comment

begin_function
specifier|static
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|ieee802_1x_kay_move_live_peer
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|u8
modifier|*
name|mi
parameter_list|,
name|u32
name|mn
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|receive_sc
modifier|*
name|rxsc
decl_stmt|;
name|u32
name|sc_ch
init|=
literal|0
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->potential_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|mi
argument_list|,
name|mi
argument_list|,
name|MI_LEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
name|os_memcpy
argument_list|(
operator|&
name|peer
operator|->
name|sci
argument_list|,
operator|&
name|participant
operator|->
name|current_peer_sci
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|sci
argument_list|)
argument_list|)
expr_stmt|;
name|peer
operator|->
name|mn
operator|=
name|mn
expr_stmt|;
name|peer
operator|->
name|expire
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|+
name|MKA_LIFE_TIME
operator|/
literal|1000
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: move potential peer to live peer"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMI: "
argument_list|,
name|peer
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|mi
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMN: %d"
argument_list|,
name|peer
operator|->
name|mn
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tSCI Addr: "
argument_list|,
name|peer
operator|->
name|sci
operator|.
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tPort: %d"
argument_list|,
name|peer
operator|->
name|sci
operator|.
name|port
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|peer
operator|->
name|list
argument_list|)
expr_stmt|;
name|dl_list_add_tail
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|,
operator|&
name|peer
operator|->
name|list
argument_list|)
expr_stmt|;
name|secy_get_available_receive_sc
argument_list|(
name|participant
operator|->
name|kay
argument_list|,
operator|&
name|sc_ch
argument_list|)
expr_stmt|;
name|rxsc
operator|=
name|ieee802_1x_kay_init_receive_sc
argument_list|(
operator|&
name|peer
operator|->
name|sci
argument_list|,
name|sc_ch
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rxsc
condition|)
return|return
name|NULL
return|;
name|dl_list_add
argument_list|(
operator|&
name|participant
operator|->
name|rxsc_list
argument_list|,
operator|&
name|rxsc
operator|->
name|list
argument_list|)
expr_stmt|;
name|secy_create_receive_sc
argument_list|(
name|participant
operator|->
name|kay
argument_list|,
name|rxsc
argument_list|)
expr_stmt|;
return|return
name|peer
return|;
block|}
end_function

begin_comment
comment|/**  *  ieee802_1x_mka_basic_body_present -  */
end_comment

begin_function
specifier|static
name|Boolean
name|ieee802_1x_mka_basic_body_present
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_basic_body_length -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_basic_body_length
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_basic_body
argument_list|)
expr_stmt|;
name|length
operator|+=
name|participant
operator|->
name|ckn
operator|.
name|len
expr_stmt|;
return|return
operator|(
name|length
operator|+
literal|0x3
operator|)
operator|&
operator|~
literal|0x3
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_encode_basic_body  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_encode_basic_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_basic_body
modifier|*
name|body
decl_stmt|;
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
init|=
name|participant
operator|->
name|kay
decl_stmt|;
name|unsigned
name|int
name|length
init|=
name|ieee802_1x_mka_basic_body_length
argument_list|(
name|participant
argument_list|)
decl_stmt|;
name|body
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|body
operator|->
name|version
operator|=
name|kay
operator|->
name|mka_version
expr_stmt|;
name|body
operator|->
name|priority
operator|=
name|kay
operator|->
name|actor_priority
expr_stmt|;
if|if
condition|(
name|participant
operator|->
name|is_elected
condition|)
name|body
operator|->
name|key_server
operator|=
name|participant
operator|->
name|is_key_server
expr_stmt|;
else|else
name|body
operator|->
name|key_server
operator|=
name|participant
operator|->
name|can_be_key_server
expr_stmt|;
name|body
operator|->
name|macsec_desired
operator|=
name|kay
operator|->
name|macsec_desired
expr_stmt|;
name|body
operator|->
name|macsec_capbility
operator|=
name|kay
operator|->
name|macsec_capable
expr_stmt|;
name|set_mka_param_body_len
argument_list|(
name|body
argument_list|,
name|length
operator|-
name|MKA_HDR_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|body
operator|->
name|actor_sci
operator|.
name|addr
argument_list|,
name|kay
operator|->
name|actor_sci
operator|.
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|kay
operator|->
name|actor_sci
operator|.
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|body
operator|->
name|actor_sci
operator|.
name|port
operator|=
name|host_to_be16
argument_list|(
name|kay
operator|->
name|actor_sci
operator|.
name|port
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|body
operator|->
name|actor_mi
argument_list|,
name|participant
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|body
operator|->
name|actor_mi
argument_list|)
argument_list|)
expr_stmt|;
name|participant
operator|->
name|mn
operator|=
name|participant
operator|->
name|mn
operator|+
literal|1
expr_stmt|;
name|body
operator|->
name|actor_mn
operator|=
name|host_to_be32
argument_list|(
name|participant
operator|->
name|mn
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|body
operator|->
name|algo_agility
argument_list|,
name|participant
operator|->
name|kay
operator|->
name|algo_agility
argument_list|,
sizeof|sizeof
argument_list|(
name|body
operator|->
name|algo_agility
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|body
operator|->
name|ckn
argument_list|,
name|participant
operator|->
name|ckn
operator|.
name|name
argument_list|,
name|participant
operator|->
name|ckn
operator|.
name|len
argument_list|)
expr_stmt|;
name|ieee802_1x_mka_dump_basic_body
argument_list|(
name|body
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_decode_basic_body -  */
end_comment

begin_function
specifier|static
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|ieee802_1x_mka_decode_basic_body
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
specifier|const
name|u8
modifier|*
name|mka_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
specifier|const
name|struct
name|ieee802_1x_mka_basic_body
modifier|*
name|body
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|body
operator|=
operator|(
specifier|const
expr|struct
name|ieee802_1x_mka_basic_body
operator|*
operator|)
name|mka_msg
expr_stmt|;
if|if
condition|(
name|body
operator|->
name|version
operator|>
name|MKA_VERSION_ID
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: peer's version(%d) greater than mka current version(%d)"
argument_list|,
name|body
operator|->
name|version
argument_list|,
name|MKA_VERSION_ID
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|kay
operator|->
name|is_obliged_key_server
operator|&&
name|body
operator|->
name|key_server
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"I must be as key server"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|participant
operator|=
name|ieee802_1x_kay_get_participant
argument_list|(
name|kay
argument_list|,
name|body
operator|->
name|ckn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|participant
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Peer is not included in my CA"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* If the peer's MI is my MI, I will choose new MI */
if|if
condition|(
name|os_memcmp
argument_list|(
name|body
operator|->
name|actor_mi
argument_list|,
name|participant
operator|->
name|mi
argument_list|,
name|MI_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|os_get_random
argument_list|(
name|participant
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|mi
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|participant
operator|->
name|mn
operator|=
literal|0
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|participant
operator|->
name|current_peer_id
operator|.
name|mi
argument_list|,
name|body
operator|->
name|actor_mi
argument_list|,
name|MI_LEN
argument_list|)
expr_stmt|;
name|participant
operator|->
name|current_peer_id
operator|.
name|mn
operator|=
name|be_to_host32
argument_list|(
name|body
operator|->
name|actor_mn
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|participant
operator|->
name|current_peer_sci
operator|.
name|addr
argument_list|,
name|body
operator|->
name|actor_sci
operator|.
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|current_peer_sci
operator|.
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|participant
operator|->
name|current_peer_sci
operator|.
name|port
operator|=
name|be_to_host16
argument_list|(
name|body
operator|->
name|actor_sci
operator|.
name|port
argument_list|)
expr_stmt|;
comment|/* handler peer */
name|peer
operator|=
name|ieee802_1x_kay_get_peer
argument_list|(
name|participant
argument_list|,
name|body
operator|->
name|actor_mi
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|peer
condition|)
block|{
comment|/* Check duplicated SCI */
comment|/* TODO: What policy should be applied to detect duplicated SCI 		 * is active attacker or a valid peer whose MI is be changed? 		 */
name|peer
operator|=
name|ieee802_1x_kay_get_peer_sci
argument_list|(
name|participant
argument_list|,
operator|&
name|body
operator|->
name|actor_sci
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: duplicated SCI detected, Maybe active attacker"
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|peer
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
block|}
name|peer
operator|=
name|ieee802_1x_kay_create_potential_peer
argument_list|(
name|participant
argument_list|,
name|body
operator|->
name|actor_mi
argument_list|,
name|be_to_host32
argument_list|(
name|body
operator|->
name|actor_mn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|peer
condition|)
return|return
name|NULL
return|;
name|peer
operator|->
name|macsec_desired
operator|=
name|body
operator|->
name|macsec_desired
expr_stmt|;
name|peer
operator|->
name|macsec_capbility
operator|=
name|body
operator|->
name|macsec_capbility
expr_stmt|;
name|peer
operator|->
name|is_key_server
operator|=
operator|(
name|Boolean
operator|)
name|body
operator|->
name|key_server
expr_stmt|;
name|peer
operator|->
name|key_server_priority
operator|=
name|body
operator|->
name|priority
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|peer
operator|->
name|mn
operator|<
name|be_to_host32
argument_list|(
name|body
operator|->
name|actor_mn
argument_list|)
condition|)
block|{
name|peer
operator|->
name|mn
operator|=
name|be_to_host32
argument_list|(
name|body
operator|->
name|actor_mn
argument_list|)
expr_stmt|;
name|peer
operator|->
name|expire
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|+
name|MKA_LIFE_TIME
operator|/
literal|1000
expr_stmt|;
name|peer
operator|->
name|macsec_desired
operator|=
name|body
operator|->
name|macsec_desired
expr_stmt|;
name|peer
operator|->
name|macsec_capbility
operator|=
name|body
operator|->
name|macsec_capbility
expr_stmt|;
name|peer
operator|->
name|is_key_server
operator|=
operator|(
name|Boolean
operator|)
name|body
operator|->
name|key_server
expr_stmt|;
name|peer
operator|->
name|key_server_priority
operator|=
name|body
operator|->
name|priority
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: The peer MN have received"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|participant
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_live_peer_body_present  */
end_comment

begin_function
specifier|static
name|Boolean
name|ieee802_1x_mka_live_peer_body_present
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
return|return
operator|!
name|dl_list_empty
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_get_live_peer_length  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_get_live_peer_length
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
name|int
name|len
init|=
name|MKA_HDR_LEN
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->live_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
name|len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_peer_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|len
operator|+
literal|0x3
operator|)
operator|&
operator|~
literal|0x3
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_encode_live_peer_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_encode_live_peer_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_peer_body
modifier|*
name|body
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|unsigned
name|int
name|length
decl_stmt|;
name|struct
name|ieee802_1x_mka_peer_id
modifier|*
name|body_peer
decl_stmt|;
name|length
operator|=
name|ieee802_1x_mka_get_live_peer_length
argument_list|(
name|participant
argument_list|)
expr_stmt|;
name|body
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_peer_body
argument_list|)
argument_list|)
expr_stmt|;
name|body
operator|->
name|type
operator|=
name|MKA_LIVE_PEER_LIST
expr_stmt|;
name|set_mka_param_body_len
argument_list|(
name|body
argument_list|,
name|length
operator|-
name|MKA_HDR_LEN
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->live_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
name|body_peer
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_peer_id
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|body_peer
operator|->
name|mi
argument_list|,
name|peer
operator|->
name|mi
argument_list|,
name|MI_LEN
argument_list|)
expr_stmt|;
name|body_peer
operator|->
name|mn
operator|=
name|host_to_be32
argument_list|(
name|peer
operator|->
name|mn
argument_list|)
expr_stmt|;
name|body_peer
operator|++
expr_stmt|;
block|}
name|ieee802_1x_mka_dump_peer_body
argument_list|(
name|body
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_potential_peer_body_present  */
end_comment

begin_function
specifier|static
name|Boolean
name|ieee802_1x_mka_potential_peer_body_present
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
return|return
operator|!
name|dl_list_empty
argument_list|(
operator|&
name|participant
operator|->
name|potential_peers
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_get_potential_peer_length  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_get_potential_peer_length
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
name|int
name|len
init|=
name|MKA_HDR_LEN
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->potential_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
name|len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_peer_id
argument_list|)
expr_stmt|;
return|return
operator|(
name|len
operator|+
literal|0x3
operator|)
operator|&
operator|~
literal|0x3
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_encode_potential_peer_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_encode_potential_peer_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_peer_body
modifier|*
name|body
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|unsigned
name|int
name|length
decl_stmt|;
name|struct
name|ieee802_1x_mka_peer_id
modifier|*
name|body_peer
decl_stmt|;
name|length
operator|=
name|ieee802_1x_mka_get_potential_peer_length
argument_list|(
name|participant
argument_list|)
expr_stmt|;
name|body
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_peer_body
argument_list|)
argument_list|)
expr_stmt|;
name|body
operator|->
name|type
operator|=
name|MKA_POTENTIAL_PEER_LIST
expr_stmt|;
name|set_mka_param_body_len
argument_list|(
name|body
argument_list|,
name|length
operator|-
name|MKA_HDR_LEN
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->potential_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
name|body_peer
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_peer_id
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|body_peer
operator|->
name|mi
argument_list|,
name|peer
operator|->
name|mi
argument_list|,
name|MI_LEN
argument_list|)
expr_stmt|;
name|body_peer
operator|->
name|mn
operator|=
name|host_to_be32
argument_list|(
name|peer
operator|->
name|mn
argument_list|)
expr_stmt|;
name|body_peer
operator|++
expr_stmt|;
block|}
name|ieee802_1x_mka_dump_peer_body
argument_list|(
name|body
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_i_in_peerlist -  */
end_comment

begin_function
specifier|static
name|Boolean
name|ieee802_1x_mka_i_in_peerlist
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mka_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
name|Boolean
name|included
init|=
name|FALSE
decl_stmt|;
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
decl_stmt|;
name|size_t
name|body_len
decl_stmt|;
name|size_t
name|left_len
decl_stmt|;
name|int
name|body_type
decl_stmt|;
name|u32
name|peer_mn
decl_stmt|;
specifier|const
name|u8
modifier|*
name|peer_mi
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|pos
operator|=
name|mka_msg
expr_stmt|;
name|left_len
operator|=
name|msg_len
expr_stmt|;
while|while
condition|(
name|left_len
operator|>
operator|(
name|MKA_HDR_LEN
operator|+
name|DEFAULT_ICV_LEN
operator|)
condition|)
block|{
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
name|body_type
operator|=
name|get_mka_param_body_type
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|body_type
operator|!=
name|MKA_LIVE_PEER_LIST
operator|&&
name|body_type
operator|!=
name|MKA_POTENTIAL_PEER_LIST
condition|)
goto|goto
name|SKIP_PEER
goto|;
name|ieee802_1x_mka_dump_peer_body
argument_list|(
operator|(
expr|struct
name|ieee802_1x_mka_peer_body
operator|*
operator|)
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|left_len
operator|<
operator|(
name|MKA_HDR_LEN
operator|+
name|body_len
operator|+
name|DEFAULT_ICV_LEN
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: MKA Peer Packet Body Length (%d bytes) is less than the Parameter Set Header Length (%d bytes) + the Parameter Set Body Length (%d bytes) + %d bytes of ICV"
argument_list|,
operator|(
name|int
operator|)
name|left_len
argument_list|,
operator|(
name|int
operator|)
name|MKA_HDR_LEN
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|,
name|DEFAULT_ICV_LEN
argument_list|)
expr_stmt|;
goto|goto
name|SKIP_PEER
goto|;
block|}
if|if
condition|(
operator|(
name|body_len
operator|%
literal|16
operator|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: MKA Peer Packet Body Length (%d bytes) should multiple of 16 octets"
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|)
expr_stmt|;
goto|goto
name|SKIP_PEER
goto|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|body_len
condition|;
name|i
operator|+=
name|MI_LEN
operator|+
sizeof|sizeof
argument_list|(
name|peer_mn
argument_list|)
control|)
block|{
name|peer_mi
operator|=
name|MKA_HDR_LEN
operator|+
name|pos
operator|+
name|i
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|peer_mn
argument_list|,
name|peer_mi
operator|+
name|MI_LEN
argument_list|,
sizeof|sizeof
argument_list|(
name|peer_mn
argument_list|)
argument_list|)
expr_stmt|;
name|peer_mn
operator|=
name|be_to_host32
argument_list|(
name|peer_mn
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer_mi
argument_list|,
name|participant
operator|->
name|mi
argument_list|,
name|MI_LEN
argument_list|)
operator|==
literal|0
operator|&&
name|peer_mn
operator|==
name|participant
operator|->
name|mn
condition|)
block|{
name|included
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|included
condition|)
return|return
name|TRUE
return|;
name|SKIP_PEER
label|:
name|left_len
operator|-=
name|body_len
operator|+
name|MKA_HDR_LEN
expr_stmt|;
name|pos
operator|+=
name|body_len
operator|+
name|MKA_HDR_LEN
expr_stmt|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_decode_live_peer_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_decode_live_peer_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
specifier|const
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|size_t
name|body_len
decl_stmt|;
name|u32
name|peer_mn
decl_stmt|;
specifier|const
name|u8
modifier|*
name|peer_mi
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|Boolean
name|is_included
decl_stmt|;
name|is_included
operator|=
name|ieee802_1x_kay_is_in_live_peer
argument_list|(
name|participant
argument_list|,
name|participant
operator|->
name|current_peer_id
operator|.
name|mi
argument_list|)
expr_stmt|;
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
name|peer_msg
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|body_len
condition|;
name|i
operator|+=
name|MI_LEN
operator|+
sizeof|sizeof
argument_list|(
name|peer_mn
argument_list|)
control|)
block|{
name|peer_mi
operator|=
name|MKA_HDR_LEN
operator|+
name|peer_msg
operator|+
name|i
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|peer_mn
argument_list|,
name|peer_mi
operator|+
name|MI_LEN
argument_list|,
sizeof|sizeof
argument_list|(
name|peer_mn
argument_list|)
argument_list|)
expr_stmt|;
name|peer_mn
operator|=
name|be_to_host32
argument_list|(
name|peer_mn
argument_list|)
expr_stmt|;
comment|/* it is myself */
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer_mi
argument_list|,
name|participant
operator|->
name|mi
argument_list|,
name|MI_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* My message id is used by other participant */
if|if
condition|(
name|peer_mn
operator|>
name|participant
operator|->
name|mn
condition|)
block|{
if|if
condition|(
name|os_get_random
argument_list|(
name|participant
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|mi
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Could not update mi"
argument_list|)
expr_stmt|;
name|participant
operator|->
name|mn
operator|=
literal|0
expr_stmt|;
block|}
continue|continue;
block|}
if|if
condition|(
operator|!
name|is_included
condition|)
continue|continue;
name|peer
operator|=
name|ieee802_1x_kay_get_peer
argument_list|(
name|participant
argument_list|,
name|peer_mi
argument_list|)
expr_stmt|;
if|if
condition|(
name|NULL
operator|!=
name|peer
condition|)
block|{
name|peer
operator|->
name|mn
operator|=
name|peer_mn
expr_stmt|;
name|peer
operator|->
name|expire
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
operator|+
name|MKA_LIFE_TIME
operator|/
literal|1000
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|ieee802_1x_kay_create_potential_peer
argument_list|(
name|participant
argument_list|,
name|peer_mi
argument_list|,
name|peer_mn
argument_list|)
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_decode_potential_peer_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_decode_potential_peer_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
decl_stmt|;
name|size_t
name|body_len
decl_stmt|;
name|u32
name|peer_mn
decl_stmt|;
specifier|const
name|u8
modifier|*
name|peer_mi
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
name|peer_msg
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|body_len
condition|;
name|i
operator|+=
name|MI_LEN
operator|+
sizeof|sizeof
argument_list|(
name|peer_mn
argument_list|)
control|)
block|{
name|peer_mi
operator|=
name|MKA_HDR_LEN
operator|+
name|peer_msg
operator|+
name|i
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|peer_mn
argument_list|,
name|peer_mi
operator|+
name|MI_LEN
argument_list|,
sizeof|sizeof
argument_list|(
name|peer_mn
argument_list|)
argument_list|)
expr_stmt|;
name|peer_mn
operator|=
name|be_to_host32
argument_list|(
name|peer_mn
argument_list|)
expr_stmt|;
comment|/* it is myself */
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer_mi
argument_list|,
name|participant
operator|->
name|mi
argument_list|,
name|MI_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* My message id is used by other participant */
if|if
condition|(
name|peer_mn
operator|>
name|participant
operator|->
name|mn
condition|)
block|{
if|if
condition|(
name|os_get_random
argument_list|(
name|participant
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|mi
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Could not update mi"
argument_list|)
expr_stmt|;
name|participant
operator|->
name|mn
operator|=
literal|0
expr_stmt|;
block|}
continue|continue;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_sak_use_body_present  */
end_comment

begin_function
specifier|static
name|Boolean
name|ieee802_1x_mka_sak_use_body_present
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
if|if
condition|(
name|participant
operator|->
name|to_use_sak
condition|)
return|return
name|TRUE
return|;
else|else
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_get_sak_use_length  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_get_sak_use_length
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
name|int
name|length
init|=
name|MKA_HDR_LEN
decl_stmt|;
if|if
condition|(
name|participant
operator|->
name|kay
operator|->
name|macsec_desired
operator|&&
name|participant
operator|->
name|advised_desired
condition|)
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_sak_use_body
argument_list|)
expr_stmt|;
else|else
name|length
operator|=
name|MKA_HDR_LEN
expr_stmt|;
name|length
operator|=
operator|(
name|length
operator|+
literal|0x3
operator|)
operator|&
operator|~
literal|0x3
expr_stmt|;
return|return
name|length
return|;
block|}
end_function

begin_comment
comment|/**  *  */
end_comment

begin_function
specifier|static
name|u32
name|ieee802_1x_mka_get_lpn
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|principal
parameter_list|,
name|struct
name|ieee802_1x_mka_ki
modifier|*
name|ki
parameter_list|)
block|{
name|struct
name|receive_sa
modifier|*
name|rxsa
decl_stmt|;
name|struct
name|receive_sc
modifier|*
name|rxsc
decl_stmt|;
name|u32
name|lpn
init|=
literal|0
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|rxsc
argument_list|,
argument|&principal->rxsc_list
argument_list|,
argument|struct receive_sc
argument_list|,
argument|list
argument_list|)
block|{
name|dl_list_for_each
argument_list|(
argument|rxsa
argument_list|,
argument|&rxsc->sa_list
argument_list|,
argument|struct receive_sa
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|is_ki_equal
argument_list|(
operator|&
name|rxsa
operator|->
name|pkey
operator|->
name|key_identifier
argument_list|,
name|ki
argument_list|)
condition|)
block|{
name|secy_get_receive_lowest_pn
argument_list|(
name|principal
operator|->
name|kay
argument_list|,
name|rxsa
argument_list|)
expr_stmt|;
name|lpn
operator|=
name|lpn
operator|>
name|rxsa
operator|->
name|lowest_pn
condition|?
name|lpn
else|:
name|rxsa
operator|->
name|lowest_pn
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|lpn
operator|==
literal|0
condition|)
name|lpn
operator|=
literal|1
expr_stmt|;
return|return
name|lpn
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_encode_sak_use_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_encode_sak_use_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_sak_use_body
modifier|*
name|body
decl_stmt|;
name|unsigned
name|int
name|length
decl_stmt|;
name|u32
name|pn
init|=
literal|1
decl_stmt|;
name|length
operator|=
name|ieee802_1x_mka_get_sak_use_length
argument_list|(
name|participant
argument_list|)
expr_stmt|;
name|body
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_sak_use_body
argument_list|)
argument_list|)
expr_stmt|;
name|body
operator|->
name|type
operator|=
name|MKA_SAK_USE
expr_stmt|;
name|set_mka_param_body_len
argument_list|(
name|body
argument_list|,
name|length
operator|-
name|MKA_HDR_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|==
name|MKA_HDR_LEN
condition|)
block|{
name|body
operator|->
name|ptx
operator|=
name|TRUE
expr_stmt|;
name|body
operator|->
name|prx
operator|=
name|TRUE
expr_stmt|;
name|body
operator|->
name|lan
operator|=
literal|0
expr_stmt|;
name|body
operator|->
name|lrx
operator|=
name|FALSE
expr_stmt|;
name|body
operator|->
name|ltx
operator|=
name|FALSE
expr_stmt|;
name|body
operator|->
name|delay_protect
operator|=
name|FALSE
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* data protect, lowest accept packet number */
name|body
operator|->
name|delay_protect
operator|=
name|participant
operator|->
name|kay
operator|->
name|macsec_replay_protect
expr_stmt|;
name|pn
operator|=
name|ieee802_1x_mka_get_lpn
argument_list|(
name|participant
argument_list|,
operator|&
name|participant
operator|->
name|lki
argument_list|)
expr_stmt|;
if|if
condition|(
name|pn
operator|>
name|participant
operator|->
name|kay
operator|->
name|pn_exhaustion
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: My LPN exhaustion"
argument_list|)
expr_stmt|;
if|if
condition|(
name|participant
operator|->
name|is_key_server
condition|)
name|participant
operator|->
name|new_sak
operator|=
name|TRUE
expr_stmt|;
block|}
name|body
operator|->
name|llpn
operator|=
name|host_to_be32
argument_list|(
name|pn
argument_list|)
expr_stmt|;
name|pn
operator|=
name|ieee802_1x_mka_get_lpn
argument_list|(
name|participant
argument_list|,
operator|&
name|participant
operator|->
name|oki
argument_list|)
expr_stmt|;
name|body
operator|->
name|olpn
operator|=
name|host_to_be32
argument_list|(
name|pn
argument_list|)
expr_stmt|;
comment|/* plain tx, plain rx */
if|if
condition|(
name|participant
operator|->
name|kay
operator|->
name|macsec_protect
condition|)
name|body
operator|->
name|ptx
operator|=
name|FALSE
expr_stmt|;
else|else
name|body
operator|->
name|ptx
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|participant
operator|->
name|kay
operator|->
name|macsec_validate
operator|==
name|Strict
condition|)
name|body
operator|->
name|prx
operator|=
name|FALSE
expr_stmt|;
else|else
name|body
operator|->
name|prx
operator|=
name|TRUE
expr_stmt|;
comment|/* latest key: rx, tx, key server member identifier key number */
name|body
operator|->
name|lan
operator|=
name|participant
operator|->
name|lan
expr_stmt|;
name|os_memcpy
argument_list|(
name|body
operator|->
name|lsrv_mi
argument_list|,
name|participant
operator|->
name|lki
operator|.
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|body
operator|->
name|lsrv_mi
argument_list|)
argument_list|)
expr_stmt|;
name|body
operator|->
name|lkn
operator|=
name|host_to_be32
argument_list|(
name|participant
operator|->
name|lki
operator|.
name|kn
argument_list|)
expr_stmt|;
name|body
operator|->
name|lrx
operator|=
name|participant
operator|->
name|lrx
expr_stmt|;
name|body
operator|->
name|ltx
operator|=
name|participant
operator|->
name|ltx
expr_stmt|;
comment|/* old key: rx, tx, key server member identifier key number */
name|body
operator|->
name|oan
operator|=
name|participant
operator|->
name|oan
expr_stmt|;
if|if
condition|(
name|participant
operator|->
name|oki
operator|.
name|kn
operator|!=
name|participant
operator|->
name|lki
operator|.
name|kn
operator|&&
name|participant
operator|->
name|oki
operator|.
name|kn
operator|!=
literal|0
condition|)
block|{
name|body
operator|->
name|otx
operator|=
name|TRUE
expr_stmt|;
name|body
operator|->
name|orx
operator|=
name|TRUE
expr_stmt|;
name|os_memcpy
argument_list|(
name|body
operator|->
name|osrv_mi
argument_list|,
name|participant
operator|->
name|oki
operator|.
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|body
operator|->
name|osrv_mi
argument_list|)
argument_list|)
expr_stmt|;
name|body
operator|->
name|okn
operator|=
name|host_to_be32
argument_list|(
name|participant
operator|->
name|oki
operator|.
name|kn
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|body
operator|->
name|otx
operator|=
name|FALSE
expr_stmt|;
name|body
operator|->
name|orx
operator|=
name|FALSE
expr_stmt|;
block|}
comment|/* set CP's variable */
if|if
condition|(
name|body
operator|->
name|ltx
condition|)
block|{
if|if
condition|(
operator|!
name|participant
operator|->
name|kay
operator|->
name|tx_enable
condition|)
name|participant
operator|->
name|kay
operator|->
name|tx_enable
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
operator|!
name|participant
operator|->
name|kay
operator|->
name|port_enable
condition|)
name|participant
operator|->
name|kay
operator|->
name|port_enable
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|body
operator|->
name|lrx
condition|)
block|{
if|if
condition|(
operator|!
name|participant
operator|->
name|kay
operator|->
name|rx_enable
condition|)
name|participant
operator|->
name|kay
operator|->
name|rx_enable
operator|=
name|TRUE
expr_stmt|;
block|}
name|ieee802_1x_mka_dump_sak_use_body
argument_list|(
name|body
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_decode_sak_use_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_decode_sak_use_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mka_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ieee802_1x_mka_sak_use_body
modifier|*
name|body
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|transmit_sa
modifier|*
name|txsa
decl_stmt|;
name|struct
name|data_key
modifier|*
name|sa_key
init|=
name|NULL
decl_stmt|;
name|size_t
name|body_len
decl_stmt|;
name|struct
name|ieee802_1x_mka_ki
name|ki
decl_stmt|;
name|u32
name|lpn
decl_stmt|;
name|Boolean
name|all_receiving
decl_stmt|;
name|Boolean
name|founded
decl_stmt|;
if|if
condition|(
operator|!
name|participant
operator|->
name|principal
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: Participant is not principal"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|=
name|ieee802_1x_kay_get_live_peer
argument_list|(
name|participant
argument_list|,
name|participant
operator|->
name|current_peer_id
operator|.
name|mi
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|peer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: the peer is not my live peer"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
name|mka_msg
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
name|body
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_sak_use_body
operator|*
operator|)
name|mka_msg
expr_stmt|;
name|ieee802_1x_mka_dump_sak_use_body
argument_list|(
name|body
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|body_len
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|body_len
operator|<
literal|40
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: MKA Use SAK Packet Body Length (%d bytes) should be 0, 40, or more octets"
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO: what action should I take when peer does not support MACsec */
if|if
condition|(
name|body_len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: Peer does not support MACsec"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* TODO: when the plain tx or rx of peer is true, should I change 	 * the attribute of controlled port 	 */
if|if
condition|(
name|body
operator|->
name|prx
condition|)
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: peer's plain rx are TRUE"
argument_list|)
expr_stmt|;
if|if
condition|(
name|body
operator|->
name|ptx
condition|)
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: peer's plain tx are TRUE"
argument_list|)
expr_stmt|;
comment|/* check latest key is valid */
if|if
condition|(
name|body
operator|->
name|ltx
operator|||
name|body
operator|->
name|lrx
condition|)
block|{
name|founded
operator|=
name|FALSE
expr_stmt|;
name|os_memcpy
argument_list|(
name|ki
operator|.
name|mi
argument_list|,
name|body
operator|->
name|lsrv_mi
argument_list|,
sizeof|sizeof
argument_list|(
name|ki
operator|.
name|mi
argument_list|)
argument_list|)
expr_stmt|;
name|ki
operator|.
name|kn
operator|=
name|ntohl
argument_list|(
name|body
operator|->
name|lkn
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|sa_key
argument_list|,
argument|&participant->sak_list
argument_list|,
argument|struct data_key
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|is_ki_equal
argument_list|(
operator|&
name|sa_key
operator|->
name|key_identifier
argument_list|,
operator|&
name|ki
argument_list|)
condition|)
block|{
name|founded
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|founded
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: Latest key is invalid"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|participant
operator|->
name|lki
operator|.
name|mi
argument_list|,
name|body
operator|->
name|lsrv_mi
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|lki
operator|.
name|mi
argument_list|)
argument_list|)
operator|==
literal|0
operator|&&
name|ntohl
argument_list|(
name|body
operator|->
name|lkn
argument_list|)
operator|==
name|participant
operator|->
name|lki
operator|.
name|kn
operator|&&
name|body
operator|->
name|lan
operator|==
name|participant
operator|->
name|lan
condition|)
block|{
name|peer
operator|->
name|sak_used
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|body
operator|->
name|ltx
operator|&&
name|peer
operator|->
name|is_key_server
condition|)
block|{
name|ieee802_1x_cp_set_servertransmitting
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* check old key is valid */
if|if
condition|(
name|body
operator|->
name|otx
operator|||
name|body
operator|->
name|orx
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|participant
operator|->
name|oki
operator|.
name|mi
argument_list|,
name|body
operator|->
name|osrv_mi
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|oki
operator|.
name|mi
argument_list|)
argument_list|)
operator|!=
literal|0
operator|||
name|ntohl
argument_list|(
name|body
operator|->
name|okn
argument_list|)
operator|!=
name|participant
operator|->
name|oki
operator|.
name|kn
operator|||
name|body
operator|->
name|oan
operator|!=
name|participant
operator|->
name|oan
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: Old key is invalid"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
comment|/* TODO: how to set the MACsec hardware when delay_protect is true */
if|if
condition|(
name|body
operator|->
name|delay_protect
operator|&&
operator|(
operator|!
name|ntohl
argument_list|(
name|body
operator|->
name|llpn
argument_list|)
operator|||
operator|!
name|ntohl
argument_list|(
name|body
operator|->
name|olpn
argument_list|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: Lowest packet number should greater than 0 when delay_protect is TRUE"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* check all live peer have used the sak for receiving sa */
name|all_receiving
operator|=
name|TRUE
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->live_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|peer
operator|->
name|sak_used
condition|)
block|{
name|all_receiving
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|all_receiving
condition|)
block|{
name|participant
operator|->
name|to_dist_sak
operator|=
name|FALSE
expr_stmt|;
name|ieee802_1x_cp_set_allreceiving
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
block|}
comment|/* if i'm key server, and detects peer member pn exhaustion, rekey.*/
name|lpn
operator|=
name|ntohl
argument_list|(
name|body
operator|->
name|llpn
argument_list|)
expr_stmt|;
if|if
condition|(
name|lpn
operator|>
name|participant
operator|->
name|kay
operator|->
name|pn_exhaustion
condition|)
block|{
if|if
condition|(
name|participant
operator|->
name|is_key_server
condition|)
block|{
name|participant
operator|->
name|new_sak
operator|=
name|TRUE
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: Peer LPN exhaustion"
argument_list|)
expr_stmt|;
block|}
block|}
name|founded
operator|=
name|FALSE
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|txsa
argument_list|,
argument|&participant->txsc->sa_list
argument_list|,
argument|struct transmit_sa
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|sa_key
operator|!=
name|NULL
operator|&&
name|txsa
operator|->
name|pkey
operator|==
name|sa_key
condition|)
block|{
name|founded
operator|=
name|TRUE
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|founded
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: Can't find txsa"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* FIXME: Secy creates txsa with default npn. If MKA detected Latest Key 	 * npn is larger than txsa's npn, set it to txsa. 	 */
name|secy_get_transmit_next_pn
argument_list|(
name|participant
operator|->
name|kay
argument_list|,
name|txsa
argument_list|)
expr_stmt|;
if|if
condition|(
name|lpn
operator|>
name|txsa
operator|->
name|next_pn
condition|)
block|{
name|secy_set_transmit_next_pn
argument_list|(
name|participant
operator|->
name|kay
argument_list|,
name|txsa
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"KaY: update lpn =0x%x"
argument_list|,
name|lpn
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_dist_sak_body_present  */
end_comment

begin_function
specifier|static
name|Boolean
name|ieee802_1x_mka_dist_sak_body_present
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
if|if
condition|(
operator|!
name|participant
operator|->
name|to_dist_sak
operator|||
operator|!
name|participant
operator|->
name|new_key
condition|)
return|return
name|FALSE
return|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_get_dist_sak_length  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_get_dist_sak_length
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|int
name|cs_index
init|=
name|participant
operator|->
name|kay
operator|->
name|macsec_csindex
decl_stmt|;
if|if
condition|(
name|participant
operator|->
name|advised_desired
condition|)
block|{
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_dist_sak_body
argument_list|)
expr_stmt|;
if|if
condition|(
name|cs_index
operator|!=
name|DEFAULT_CS_INDEX
condition|)
name|length
operator|+=
name|CS_ID_LEN
expr_stmt|;
name|length
operator|+=
name|cipher_suite_tbl
index|[
name|cs_index
index|]
operator|.
name|sak_len
operator|+
literal|8
expr_stmt|;
block|}
else|else
block|{
name|length
operator|=
name|MKA_HDR_LEN
expr_stmt|;
block|}
name|length
operator|=
operator|(
name|length
operator|+
literal|0x3
operator|)
operator|&
operator|~
literal|0x3
expr_stmt|;
return|return
name|length
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_encode_dist_sak_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_encode_dist_sak_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_dist_sak_body
modifier|*
name|body
decl_stmt|;
name|struct
name|data_key
modifier|*
name|sak
decl_stmt|;
name|unsigned
name|int
name|length
decl_stmt|;
name|int
name|cs_index
decl_stmt|;
name|int
name|sak_pos
decl_stmt|;
name|length
operator|=
name|ieee802_1x_mka_get_dist_sak_length
argument_list|(
name|participant
argument_list|)
expr_stmt|;
name|body
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|body
operator|->
name|type
operator|=
name|MKA_DISTRIBUTED_SAK
expr_stmt|;
name|set_mka_param_body_len
argument_list|(
name|body
argument_list|,
name|length
operator|-
name|MKA_HDR_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|==
name|MKA_HDR_LEN
condition|)
block|{
name|body
operator|->
name|confid_offset
operator|=
literal|0
expr_stmt|;
name|body
operator|->
name|dan
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|sak
operator|=
name|participant
operator|->
name|new_key
expr_stmt|;
name|body
operator|->
name|confid_offset
operator|=
name|sak
operator|->
name|confidentiality_offset
expr_stmt|;
name|body
operator|->
name|dan
operator|=
name|sak
operator|->
name|an
expr_stmt|;
name|body
operator|->
name|kn
operator|=
name|host_to_be32
argument_list|(
name|sak
operator|->
name|key_identifier
operator|.
name|kn
argument_list|)
expr_stmt|;
name|cs_index
operator|=
name|participant
operator|->
name|kay
operator|->
name|macsec_csindex
expr_stmt|;
name|sak_pos
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cs_index
operator|!=
name|DEFAULT_CS_INDEX
condition|)
block|{
name|os_memcpy
argument_list|(
name|body
operator|->
name|sak
argument_list|,
name|cipher_suite_tbl
index|[
name|cs_index
index|]
operator|.
name|id
argument_list|,
name|CS_ID_LEN
argument_list|)
expr_stmt|;
name|sak_pos
operator|=
name|CS_ID_LEN
expr_stmt|;
block|}
if|if
condition|(
name|aes_wrap
argument_list|(
name|participant
operator|->
name|kek
operator|.
name|key
argument_list|,
literal|16
argument_list|,
name|cipher_suite_tbl
index|[
name|cs_index
index|]
operator|.
name|sak_len
operator|/
literal|8
argument_list|,
name|sak
operator|->
name|key
argument_list|,
name|body
operator|->
name|sak
operator|+
name|sak_pos
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: AES wrap failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ieee802_1x_mka_dump_dist_sak_body
argument_list|(
name|body
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_init_data_key -  */
end_comment

begin_function
specifier|static
name|struct
name|data_key
modifier|*
name|ieee802_1x_kay_init_data_key
parameter_list|(
specifier|const
name|struct
name|key_conf
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|data_key
modifier|*
name|pkey
decl_stmt|;
if|if
condition|(
operator|!
name|conf
condition|)
return|return
name|NULL
return|;
name|pkey
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pkey
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkey
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pkey
operator|->
name|key
operator|=
name|os_zalloc
argument_list|(
name|conf
operator|->
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkey
operator|->
name|key
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|pkey
operator|->
name|key
argument_list|,
name|conf
operator|->
name|key
argument_list|,
name|conf
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|pkey
operator|->
name|key_identifier
argument_list|,
operator|&
name|conf
operator|->
name|ki
argument_list|,
sizeof|sizeof
argument_list|(
name|pkey
operator|->
name|key_identifier
argument_list|)
argument_list|)
expr_stmt|;
name|pkey
operator|->
name|confidentiality_offset
operator|=
name|conf
operator|->
name|offset
expr_stmt|;
name|pkey
operator|->
name|an
operator|=
name|conf
operator|->
name|an
expr_stmt|;
name|pkey
operator|->
name|transmits
operator|=
name|conf
operator|->
name|tx
expr_stmt|;
name|pkey
operator|->
name|receives
operator|=
name|conf
operator|->
name|rx
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|pkey
operator|->
name|created_time
argument_list|)
expr_stmt|;
name|pkey
operator|->
name|user
operator|=
literal|1
expr_stmt|;
return|return
name|pkey
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_decode_dist_sak_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_decode_dist_sak_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mka_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ieee802_1x_mka_dist_sak_body
modifier|*
name|body
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|macsec_ciphersuite
modifier|*
name|cs
decl_stmt|;
name|size_t
name|body_len
decl_stmt|;
name|struct
name|key_conf
modifier|*
name|conf
decl_stmt|;
name|struct
name|data_key
modifier|*
name|sa_key
init|=
name|NULL
decl_stmt|;
name|struct
name|ieee802_1x_mka_ki
name|sak_ki
decl_stmt|;
name|int
name|sak_len
decl_stmt|;
name|u8
modifier|*
name|wrap_sak
decl_stmt|;
name|u8
modifier|*
name|unwrap_sak
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
name|mka_msg
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|body_len
operator|!=
literal|0
operator|)
operator|&&
operator|(
name|body_len
operator|!=
literal|28
operator|)
operator|&&
operator|(
name|body_len
operator|<
literal|36
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: MKA Use SAK Packet Body Length (%d bytes) should be 0, 28, 36, or more octets"
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|participant
operator|->
name|principal
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: I can't accept the distributed SAK as I am not principal"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|participant
operator|->
name|is_key_server
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: I can't accept the distributed SAK as myself is key server "
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|participant
operator|->
name|kay
operator|->
name|macsec_desired
operator|||
name|participant
operator|->
name|kay
operator|->
name|macsec_capable
operator|==
name|MACSEC_CAP_NOT_IMPLEMENTED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: I am not MACsec-desired or without MACsec capable"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|=
name|ieee802_1x_kay_get_live_peer
argument_list|(
name|participant
argument_list|,
name|participant
operator|->
name|current_peer_id
operator|.
name|mi
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|peer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: The key server is not in my live peers list"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
operator|&
name|participant
operator|->
name|kay
operator|->
name|key_server_sci
argument_list|,
operator|&
name|peer
operator|->
name|sci
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_sci
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: The key server is not elected"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|body_len
operator|==
literal|0
condition|)
block|{
name|participant
operator|->
name|kay
operator|->
name|authenticated
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|kay
operator|->
name|secured
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|kay
operator|->
name|failed
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|advised_desired
operator|=
name|FALSE
expr_stmt|;
name|ieee802_1x_cp_connect_authenticated
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY:The Key server advise no MACsec"
argument_list|)
expr_stmt|;
name|participant
operator|->
name|to_use_sak
operator|=
name|TRUE
expr_stmt|;
return|return
literal|0
return|;
block|}
name|participant
operator|->
name|advised_desired
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|kay
operator|->
name|authenticated
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|kay
operator|->
name|secured
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|kay
operator|->
name|failed
operator|=
name|FALSE
expr_stmt|;
name|ieee802_1x_cp_connect_secure
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|body
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_dist_sak_body
operator|*
operator|)
name|mka_msg
expr_stmt|;
name|ieee802_1x_mka_dump_dist_sak_body
argument_list|(
name|body
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|sa_key
argument_list|,
argument|&participant->sak_list
argument_list|,
argument|struct data_key
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|sa_key
operator|->
name|key_identifier
operator|.
name|mi
argument_list|,
name|participant
operator|->
name|current_peer_id
operator|.
name|mi
argument_list|,
name|MI_LEN
argument_list|)
operator|==
literal|0
operator|&&
name|sa_key
operator|->
name|key_identifier
operator|.
name|kn
operator|==
name|be_to_host32
argument_list|(
name|body
operator|->
name|kn
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY:The Key has installed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|body_len
operator|==
literal|28
condition|)
block|{
name|sak_len
operator|=
name|DEFAULT_SA_KEY_LEN
expr_stmt|;
name|wrap_sak
operator|=
name|body
operator|->
name|sak
expr_stmt|;
name|participant
operator|->
name|kay
operator|->
name|macsec_csindex
operator|=
name|DEFAULT_CS_INDEX
expr_stmt|;
block|}
else|else
block|{
name|cs
operator|=
name|ieee802_1x_kay_get_cipher_suite
argument_list|(
name|participant
argument_list|,
name|body
operator|->
name|sak
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cs
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: I can't support the Cipher Suite advised by key server"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sak_len
operator|=
name|cs
operator|->
name|sak_len
expr_stmt|;
name|wrap_sak
operator|=
name|body
operator|->
name|sak
operator|+
name|CS_ID_LEN
expr_stmt|;
name|participant
operator|->
name|kay
operator|->
name|macsec_csindex
operator|=
name|cs
operator|->
name|index
expr_stmt|;
block|}
name|unwrap_sak
operator|=
name|os_zalloc
argument_list|(
name|sak_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|unwrap_sak
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY-%s: Out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|aes_unwrap
argument_list|(
name|participant
operator|->
name|kek
operator|.
name|key
argument_list|,
literal|16
argument_list|,
name|sak_len
operator|>>
literal|3
argument_list|,
name|wrap_sak
argument_list|,
name|unwrap_sak
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: AES unwrap failed"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|unwrap_sak
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tAES Key Unwrap of SAK:"
argument_list|,
name|unwrap_sak
argument_list|,
name|sak_len
argument_list|)
expr_stmt|;
name|conf
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|conf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conf
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY-%s: Out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|unwrap_sak
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conf
operator|->
name|key_len
operator|=
name|sak_len
expr_stmt|;
name|conf
operator|->
name|key
operator|=
name|os_zalloc
argument_list|(
name|conf
operator|->
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conf
operator|->
name|key
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY-%s: Out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|unwrap_sak
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|conf
operator|->
name|key
argument_list|,
name|unwrap_sak
argument_list|,
name|conf
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|sak_ki
operator|.
name|mi
argument_list|,
operator|&
name|participant
operator|->
name|current_peer_id
operator|.
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|sak_ki
operator|.
name|mi
argument_list|)
argument_list|)
expr_stmt|;
name|sak_ki
operator|.
name|kn
operator|=
name|be_to_host32
argument_list|(
name|body
operator|->
name|kn
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|conf
operator|->
name|ki
operator|.
name|mi
argument_list|,
name|sak_ki
operator|.
name|mi
argument_list|,
name|MI_LEN
argument_list|)
expr_stmt|;
name|conf
operator|->
name|ki
operator|.
name|kn
operator|=
name|sak_ki
operator|.
name|kn
expr_stmt|;
name|conf
operator|->
name|an
operator|=
name|body
operator|->
name|dan
expr_stmt|;
name|conf
operator|->
name|offset
operator|=
name|body
operator|->
name|confid_offset
expr_stmt|;
name|conf
operator|->
name|rx
operator|=
name|TRUE
expr_stmt|;
name|conf
operator|->
name|tx
operator|=
name|TRUE
expr_stmt|;
name|sa_key
operator|=
name|ieee802_1x_kay_init_data_key
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sa_key
condition|)
block|{
name|os_free
argument_list|(
name|unwrap_sak
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
operator|->
name|key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dl_list_add
argument_list|(
operator|&
name|participant
operator|->
name|sak_list
argument_list|,
operator|&
name|sa_key
operator|->
name|list
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_set_ciphersuite
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|,
name|cipher_suite_tbl
index|[
name|participant
operator|->
name|kay
operator|->
name|macsec_csindex
index|]
operator|.
name|id
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_set_offset
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|,
name|body
operator|->
name|confid_offset
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_set_distributedki
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|,
operator|&
name|sak_ki
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_set_distributedan
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|,
name|body
operator|->
name|dan
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_signal_newsak
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|participant
operator|->
name|to_use_sak
operator|=
name|TRUE
expr_stmt|;
name|os_free
argument_list|(
name|unwrap_sak
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
operator|->
name|key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_icv_body_present  */
end_comment

begin_function
specifier|static
name|Boolean
name|ieee802_1x_mka_icv_body_present
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_get_icv_length  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_get_icv_length
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
name|int
name|length
decl_stmt|;
name|length
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_mka_icv_body
argument_list|)
expr_stmt|;
name|length
operator|+=
name|mka_alg_tbl
index|[
name|participant
operator|->
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|icv_len
expr_stmt|;
return|return
operator|(
name|length
operator|+
literal|0x3
operator|)
operator|&
operator|~
literal|0x3
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_encode_icv_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_encode_icv_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_icv_body
modifier|*
name|body
decl_stmt|;
name|unsigned
name|int
name|length
decl_stmt|;
name|u8
name|cmac
index|[
name|MAX_ICV_LEN
index|]
decl_stmt|;
name|length
operator|=
name|ieee802_1x_mka_get_icv_length
argument_list|(
name|participant
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|!=
name|DEFAULT_ICV_LEN
condition|)
block|{
name|body
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|MKA_HDR_LEN
argument_list|)
expr_stmt|;
name|body
operator|->
name|type
operator|=
name|MKA_ICV_INDICATOR
expr_stmt|;
name|set_mka_param_body_len
argument_list|(
name|body
argument_list|,
name|length
operator|-
name|MKA_HDR_LEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mka_alg_tbl
index|[
name|participant
operator|->
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|icv_hash
argument_list|(
name|participant
operator|->
name|ick
operator|.
name|key
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|buf
operator|->
name|used
argument_list|,
name|cmac
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY, omac1_aes_128 failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|length
operator|!=
name|DEFAULT_ICV_LEN
condition|)
block|{
name|os_memcpy
argument_list|(
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|length
operator|-
name|MKA_HDR_LEN
argument_list|)
argument_list|,
name|cmac
argument_list|,
name|length
operator|-
name|MKA_HDR_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|length
argument_list|)
argument_list|,
name|cmac
argument_list|,
name|length
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_decode_icv_body -  */
end_comment

begin_function
specifier|static
name|u8
modifier|*
name|ieee802_1x_mka_decode_icv_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mka_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|ieee802_1x_mka_icv_body
modifier|*
name|body
decl_stmt|;
name|size_t
name|body_len
decl_stmt|;
name|size_t
name|left_len
decl_stmt|;
name|int
name|body_type
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
name|mka_msg
expr_stmt|;
name|left_len
operator|=
name|msg_len
expr_stmt|;
while|while
condition|(
name|left_len
operator|>
operator|(
name|MKA_HDR_LEN
operator|+
name|DEFAULT_ICV_LEN
operator|)
condition|)
block|{
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
name|body_type
operator|=
name|get_mka_param_body_type
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|left_len
operator|<
operator|(
name|body_len
operator|+
name|MKA_HDR_LEN
operator|)
condition|)
break|break;
if|if
condition|(
name|body_type
operator|!=
name|MKA_ICV_INDICATOR
condition|)
block|{
name|left_len
operator|-=
name|MKA_HDR_LEN
operator|+
name|body_len
expr_stmt|;
name|pos
operator|+=
name|MKA_HDR_LEN
operator|+
name|body_len
expr_stmt|;
continue|continue;
block|}
name|body
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_icv_body
operator|*
operator|)
name|pos
expr_stmt|;
if|if
condition|(
name|body_len
operator|<
name|mka_alg_tbl
index|[
name|participant
operator|->
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|icv_len
condition|)
block|{
return|return
name|NULL
return|;
block|}
return|return
name|body
operator|->
name|icv
return|;
block|}
return|return
operator|(
name|u8
operator|*
operator|)
operator|(
name|mka_msg
operator|+
name|msg_len
operator|-
name|DEFAULT_ICV_LEN
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_decode_dist_cak_body-  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_decode_dist_cak_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mka_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
decl_stmt|;
name|size_t
name|body_len
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
name|mka_msg
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|body_len
operator|<
literal|28
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: MKA Use SAK Packet Body Length (%d bytes) should be 28 or more octets"
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_decode_kmd_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_decode_kmd_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mka_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
decl_stmt|;
name|size_t
name|body_len
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
name|mka_msg
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|body_len
operator|<
literal|5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: MKA Use SAK Packet Body Length (%d bytes) should be 5 or more octets"
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_mka_decode_announce_body -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_mka_decode_announce_body
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
specifier|const
name|u8
modifier|*
name|mka_msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|mka_param_body_handler
name|mak_body_handler
index|[]
init|=
block|{
comment|/* basic parameter set */
block|{
name|ieee802_1x_mka_encode_basic_body
block|,
name|NULL
block|,
name|ieee802_1x_mka_basic_body_length
block|,
name|ieee802_1x_mka_basic_body_present
block|}
block|,
comment|/* live peer list parameter set */
block|{
name|ieee802_1x_mka_encode_live_peer_body
block|,
name|ieee802_1x_mka_decode_live_peer_body
block|,
name|ieee802_1x_mka_get_live_peer_length
block|,
name|ieee802_1x_mka_live_peer_body_present
block|}
block|,
comment|/* potential peer list parameter set */
block|{
name|ieee802_1x_mka_encode_potential_peer_body
block|,
name|ieee802_1x_mka_decode_potential_peer_body
block|,
name|ieee802_1x_mka_get_potential_peer_length
block|,
name|ieee802_1x_mka_potential_peer_body_present
block|}
block|,
comment|/* sak use parameter set */
block|{
name|ieee802_1x_mka_encode_sak_use_body
block|,
name|ieee802_1x_mka_decode_sak_use_body
block|,
name|ieee802_1x_mka_get_sak_use_length
block|,
name|ieee802_1x_mka_sak_use_body_present
block|}
block|,
comment|/* distribute sak parameter set */
block|{
name|ieee802_1x_mka_encode_dist_sak_body
block|,
name|ieee802_1x_mka_decode_dist_sak_body
block|,
name|ieee802_1x_mka_get_dist_sak_length
block|,
name|ieee802_1x_mka_dist_sak_body_present
block|}
block|,
comment|/* distribute cak parameter set */
block|{
name|NULL
block|,
name|ieee802_1x_mka_decode_dist_cak_body
block|,
name|NULL
block|,
name|NULL
block|}
block|,
comment|/* kmd parameter set */
block|{
name|NULL
block|,
name|ieee802_1x_mka_decode_kmd_body
block|,
name|NULL
block|,
name|NULL
block|}
block|,
comment|/* announce parameter set */
block|{
name|NULL
block|,
name|ieee802_1x_mka_decode_announce_body
block|,
name|NULL
block|,
name|NULL
block|}
block|,
comment|/* icv parameter set */
block|{
name|ieee802_1x_mka_encode_icv_body
block|,
name|NULL
block|,
name|ieee802_1x_mka_get_icv_length
block|,
name|ieee802_1x_mka_icv_body_present
block|}
block|, }
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * ieee802_1x_kay_deinit_data_key -  */
end_comment

begin_function
name|void
name|ieee802_1x_kay_deinit_data_key
parameter_list|(
name|struct
name|data_key
modifier|*
name|pkey
parameter_list|)
block|{
if|if
condition|(
operator|!
name|pkey
condition|)
return|return;
name|pkey
operator|->
name|user
operator|--
expr_stmt|;
if|if
condition|(
name|pkey
operator|->
name|user
operator|>
literal|1
condition|)
return|return;
name|dl_list_del
argument_list|(
operator|&
name|pkey
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pkey
operator|->
name|key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pkey
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_generate_new_sak -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_kay_generate_new_sak
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
name|struct
name|data_key
modifier|*
name|sa_key
init|=
name|NULL
decl_stmt|;
name|struct
name|key_conf
modifier|*
name|conf
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
init|=
name|participant
operator|->
name|kay
decl_stmt|;
name|int
name|ctx_len
decl_stmt|,
name|ctx_offset
decl_stmt|;
name|u8
modifier|*
name|context
decl_stmt|;
comment|/* check condition for generating a fresh SAK: 	 * must have one live peer 	 * and MKA life time elapse since last distribution 	 * or potential peer is empty 	 */
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: Live peers list must not empty when generating fresh SAK"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* FIXME: A fresh SAK not generated until 	 * the live peer list contains at least one peer and 	 * MKA life time has elapsed since the prior SAK was first distributed, 	 * or the Key server's potential peer is empty 	 * but I can't understand the second item, so 	 * here only check first item and ingore 	 *&& (!dl_list_empty(&participant->potential_peers))) { 	 */
if|if
condition|(
operator|(
name|time
argument_list|(
name|NULL
argument_list|)
operator|-
name|kay
operator|->
name|dist_time
operator|)
operator|<
name|MKA_LIFE_TIME
operator|/
literal|1000
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: Life time have not elapsed since prior SAK distributed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conf
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|conf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conf
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY-%s: Out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conf
operator|->
name|key_len
operator|=
name|cipher_suite_tbl
index|[
name|kay
operator|->
name|macsec_csindex
index|]
operator|.
name|sak_len
expr_stmt|;
name|conf
operator|->
name|key
operator|=
name|os_zalloc
argument_list|(
name|conf
operator|->
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conf
operator|->
name|key
condition|)
block|{
name|os_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY-%s: Out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ctx_len
operator|=
name|conf
operator|->
name|key_len
operator|+
sizeof|sizeof
argument_list|(
name|kay
operator|->
name|dist_kn
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->live_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
name|ctx_len
operator|+=
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|mi
argument_list|)
expr_stmt|;
name|ctx_len
operator|+=
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|mi
argument_list|)
expr_stmt|;
name|context
operator|=
name|os_zalloc
argument_list|(
name|ctx_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|context
condition|)
block|{
name|os_free
argument_list|(
name|conf
operator|->
name|key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ctx_offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|context
operator|+
name|ctx_offset
argument_list|,
name|conf
operator|->
name|key_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|context
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
operator|->
name|key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ctx_offset
operator|+=
name|conf
operator|->
name|key_len
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->live_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
name|os_memcpy
argument_list|(
name|context
operator|+
name|ctx_offset
argument_list|,
name|peer
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|mi
argument_list|)
argument_list|)
expr_stmt|;
name|ctx_offset
operator|+=
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|mi
argument_list|)
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|context
operator|+
name|ctx_offset
argument_list|,
name|participant
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|mi
argument_list|)
argument_list|)
expr_stmt|;
name|ctx_offset
operator|+=
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|mi
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|context
operator|+
name|ctx_offset
argument_list|,
operator|&
name|kay
operator|->
name|dist_kn
argument_list|,
sizeof|sizeof
argument_list|(
name|kay
operator|->
name|dist_kn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|key_len
operator|==
literal|16
condition|)
block|{
name|ieee802_1x_sak_128bits_aes_cmac
argument_list|(
name|participant
operator|->
name|cak
operator|.
name|key
argument_list|,
name|context
argument_list|,
name|ctx_len
argument_list|,
name|conf
operator|->
name|key
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|conf
operator|->
name|key_len
operator|==
literal|32
condition|)
block|{
name|ieee802_1x_sak_128bits_aes_cmac
argument_list|(
name|participant
operator|->
name|cak
operator|.
name|key
argument_list|,
name|context
argument_list|,
name|ctx_len
argument_list|,
name|conf
operator|->
name|key
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: SAK Length not support"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
operator|->
name|key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: generated new SAK"
argument_list|,
name|conf
operator|->
name|key
argument_list|,
name|conf
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|conf
operator|->
name|ki
operator|.
name|mi
argument_list|,
name|participant
operator|->
name|mi
argument_list|,
name|MI_LEN
argument_list|)
expr_stmt|;
name|conf
operator|->
name|ki
operator|.
name|kn
operator|=
name|participant
operator|->
name|kay
operator|->
name|dist_kn
expr_stmt|;
name|conf
operator|->
name|an
operator|=
name|participant
operator|->
name|kay
operator|->
name|dist_an
expr_stmt|;
name|conf
operator|->
name|offset
operator|=
name|kay
operator|->
name|macsec_confidentiality
expr_stmt|;
name|conf
operator|->
name|rx
operator|=
name|TRUE
expr_stmt|;
name|conf
operator|->
name|tx
operator|=
name|TRUE
expr_stmt|;
name|sa_key
operator|=
name|ieee802_1x_kay_init_data_key
argument_list|(
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sa_key
condition|)
block|{
name|os_free
argument_list|(
name|conf
operator|->
name|key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|participant
operator|->
name|new_key
operator|=
name|sa_key
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|participant
operator|->
name|sak_list
argument_list|,
operator|&
name|sa_key
operator|->
name|list
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_set_ciphersuite
argument_list|(
name|participant
operator|->
name|kay
operator|->
name|cp
argument_list|,
name|cipher_suite_tbl
index|[
name|kay
operator|->
name|macsec_csindex
index|]
operator|.
name|id
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_set_offset
argument_list|(
name|kay
operator|->
name|cp
argument_list|,
name|conf
operator|->
name|offset
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_set_distributedki
argument_list|(
name|kay
operator|->
name|cp
argument_list|,
operator|&
name|conf
operator|->
name|ki
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_set_distributedan
argument_list|(
name|kay
operator|->
name|cp
argument_list|,
name|conf
operator|->
name|an
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_signal_newsak
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->live_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
name|peer
operator|->
name|sak_used
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|kay
operator|->
name|dist_kn
operator|++
expr_stmt|;
name|participant
operator|->
name|kay
operator|->
name|dist_an
operator|++
expr_stmt|;
if|if
condition|(
name|participant
operator|->
name|kay
operator|->
name|dist_an
operator|>
literal|3
condition|)
name|participant
operator|->
name|kay
operator|->
name|dist_an
operator|=
literal|0
expr_stmt|;
name|participant
operator|->
name|kay
operator|->
name|dist_time
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
operator|->
name|key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_elect_key_server - elect the key server  * when to elect: whenever the live peers list changes  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_kay_elect_key_server
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|key_server
init|=
name|NULL
decl_stmt|;
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
init|=
name|participant
operator|->
name|kay
decl_stmt|;
name|Boolean
name|i_is_key_server
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|participant
operator|->
name|is_obliged_key_server
condition|)
block|{
name|participant
operator|->
name|new_sak
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|to_dist_sak
operator|=
name|FALSE
expr_stmt|;
name|ieee802_1x_cp_set_electedself
argument_list|(
name|kay
operator|->
name|cp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* elect the key server among the peers */
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->live_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|peer
operator|->
name|is_key_server
condition|)
continue|continue;
if|if
condition|(
operator|!
name|key_server
condition|)
block|{
name|key_server
operator|=
name|peer
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|peer
operator|->
name|key_server_priority
operator|<
name|key_server
operator|->
name|key_server_priority
condition|)
block|{
name|key_server
operator|=
name|peer
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|peer
operator|->
name|key_server_priority
operator|==
name|key_server
operator|->
name|key_server_priority
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|peer
operator|->
name|sci
operator|.
name|addr
index|[
name|i
index|]
operator|<
name|key_server
operator|->
name|sci
operator|.
name|addr
index|[
name|i
index|]
condition|)
name|key_server
operator|=
name|peer
expr_stmt|;
block|}
block|}
block|}
comment|/* elect the key server between me and the above elected peer */
name|i_is_key_server
operator|=
name|FALSE
expr_stmt|;
if|if
condition|(
name|key_server
operator|&&
name|participant
operator|->
name|can_be_key_server
condition|)
block|{
if|if
condition|(
name|kay
operator|->
name|actor_priority
operator|<
name|key_server
operator|->
name|key_server_priority
condition|)
block|{
name|i_is_key_server
operator|=
name|TRUE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|kay
operator|->
name|actor_priority
operator|==
name|key_server
operator|->
name|key_server_priority
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|kay
operator|->
name|actor_sci
operator|.
name|addr
index|[
name|i
index|]
operator|<
name|key_server
operator|->
name|sci
operator|.
name|addr
index|[
name|i
index|]
condition|)
block|{
name|i_is_key_server
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
operator|!
name|key_server
operator|&&
operator|!
name|i_is_key_server
condition|)
block|{
name|participant
operator|->
name|principal
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|is_key_server
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|is_elected
operator|=
name|FALSE
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|i_is_key_server
condition|)
block|{
name|ieee802_1x_cp_set_electedself
argument_list|(
name|kay
operator|->
name|cp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
operator|&
name|kay
operator|->
name|key_server_sci
argument_list|,
operator|&
name|kay
operator|->
name|actor_sci
argument_list|,
sizeof|sizeof
argument_list|(
name|kay
operator|->
name|key_server_sci
argument_list|)
argument_list|)
condition|)
block|{
name|ieee802_1x_cp_signal_chgdserver
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
block|}
name|participant
operator|->
name|is_key_server
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|principal
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|new_sak
operator|=
name|TRUE
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: I is elected as key server"
argument_list|)
expr_stmt|;
name|participant
operator|->
name|to_dist_sak
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|is_elected
operator|=
name|TRUE
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|kay
operator|->
name|key_server_sci
argument_list|,
operator|&
name|kay
operator|->
name|actor_sci
argument_list|,
sizeof|sizeof
argument_list|(
name|kay
operator|->
name|key_server_sci
argument_list|)
argument_list|)
expr_stmt|;
name|kay
operator|->
name|key_server_priority
operator|=
name|kay
operator|->
name|actor_priority
expr_stmt|;
block|}
if|if
condition|(
name|key_server
condition|)
block|{
name|ieee802_1x_cp_set_electedself
argument_list|(
name|kay
operator|->
name|cp
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
operator|&
name|kay
operator|->
name|key_server_sci
argument_list|,
operator|&
name|key_server
operator|->
name|sci
argument_list|,
sizeof|sizeof
argument_list|(
name|kay
operator|->
name|key_server_sci
argument_list|)
argument_list|)
condition|)
block|{
name|ieee802_1x_cp_signal_chgdserver
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
block|}
name|participant
operator|->
name|is_key_server
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|principal
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|is_elected
operator|=
name|TRUE
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|kay
operator|->
name|key_server_sci
argument_list|,
operator|&
name|key_server
operator|->
name|sci
argument_list|,
sizeof|sizeof
argument_list|(
name|kay
operator|->
name|key_server_sci
argument_list|)
argument_list|)
expr_stmt|;
name|kay
operator|->
name|key_server_priority
operator|=
name|key_server
operator|->
name|key_server_priority
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_decide_macsec_use - the key server determinate  *		 how to use MACsec: whether use MACsec and its capability  * protectFrames will be advised if the key server and one of its live peers are  * MACsec capable and one of those request MACsec protection  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_kay_decide_macsec_use
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
init|=
name|participant
operator|->
name|kay
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|enum
name|macsec_cap
name|less_capability
decl_stmt|;
name|Boolean
name|has_peer
decl_stmt|;
if|if
condition|(
operator|!
name|participant
operator|->
name|is_key_server
condition|)
return|return
operator|-
literal|1
return|;
comment|/* key server self is MACsec-desired and requesting MACsec */
if|if
condition|(
operator|!
name|kay
operator|->
name|macsec_desired
condition|)
block|{
name|participant
operator|->
name|advised_desired
operator|=
name|FALSE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|kay
operator|->
name|macsec_capable
operator|==
name|MACSEC_CAP_NOT_IMPLEMENTED
condition|)
block|{
name|participant
operator|->
name|advised_desired
operator|=
name|FALSE
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|less_capability
operator|=
name|kay
operator|->
name|macsec_capable
expr_stmt|;
comment|/* at least one of peers is MACsec-desired and requesting MACsec */
name|has_peer
operator|=
name|FALSE
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|peer
argument_list|,
argument|&participant->live_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|peer
operator|->
name|macsec_desired
condition|)
continue|continue;
if|if
condition|(
name|peer
operator|->
name|macsec_capbility
operator|==
name|MACSEC_CAP_NOT_IMPLEMENTED
condition|)
continue|continue;
name|less_capability
operator|=
operator|(
name|less_capability
operator|<
name|peer
operator|->
name|macsec_capbility
operator|)
condition|?
name|less_capability
else|:
name|peer
operator|->
name|macsec_capbility
expr_stmt|;
name|has_peer
operator|=
name|TRUE
expr_stmt|;
block|}
if|if
condition|(
name|has_peer
condition|)
block|{
name|participant
operator|->
name|advised_desired
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|advised_capability
operator|=
name|less_capability
expr_stmt|;
name|kay
operator|->
name|authenticated
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|secured
operator|=
name|TRUE
expr_stmt|;
name|kay
operator|->
name|failed
operator|=
name|FALSE
expr_stmt|;
name|ieee802_1x_cp_connect_secure
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|participant
operator|->
name|advised_desired
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|advised_capability
operator|=
name|MACSEC_CAP_NOT_IMPLEMENTED
expr_stmt|;
name|participant
operator|->
name|to_use_sak
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|authenticated
operator|=
name|TRUE
expr_stmt|;
name|kay
operator|->
name|secured
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|failed
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|ltx_kn
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|ltx_an
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|lrx_kn
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|lrx_an
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|otx_kn
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|otx_an
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|orx_kn
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|orx_an
operator|=
literal|0
expr_stmt|;
name|ieee802_1x_cp_connect_authenticated
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|u8
name|pae_group_addr
index|[
name|ETH_ALEN
index|]
init|=
block|{
literal|0x01
block|,
literal|0x80
block|,
literal|0xc2
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x03
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * ieee802_1x_kay_encode_mkpdu -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_kay_encode_mkpdu
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|pbuf
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|struct
name|ieee8023_hdr
modifier|*
name|ether_hdr
decl_stmt|;
name|struct
name|ieee802_1x_hdr
modifier|*
name|eapol_hdr
decl_stmt|;
name|ether_hdr
operator|=
name|wpabuf_put
argument_list|(
name|pbuf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ether_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ether_hdr
operator|->
name|dest
argument_list|,
name|pae_group_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ether_hdr
operator|->
name|dest
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ether_hdr
operator|->
name|src
argument_list|,
name|participant
operator|->
name|kay
operator|->
name|actor_sci
operator|.
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ether_hdr
operator|->
name|dest
argument_list|)
argument_list|)
expr_stmt|;
name|ether_hdr
operator|->
name|ethertype
operator|=
name|host_to_be16
argument_list|(
name|ETH_P_EAPOL
argument_list|)
expr_stmt|;
name|eapol_hdr
operator|=
name|wpabuf_put
argument_list|(
name|pbuf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|eapol_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|eapol_hdr
operator|->
name|version
operator|=
name|EAPOL_VERSION
expr_stmt|;
name|eapol_hdr
operator|->
name|type
operator|=
name|IEEE802_1X_TYPE_EAPOL_MKA
expr_stmt|;
name|eapol_hdr
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
name|pbuf
operator|->
name|size
operator|-
name|pbuf
operator|->
name|used
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|mak_body_handler
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mak_body_handler
index|[
name|i
index|]
operator|.
name|body_present
operator|&&
name|mak_body_handler
index|[
name|i
index|]
operator|.
name|body_present
argument_list|(
name|participant
argument_list|)
condition|)
block|{
if|if
condition|(
name|mak_body_handler
index|[
name|i
index|]
operator|.
name|body_tx
argument_list|(
name|participant
argument_list|,
name|pbuf
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_participant_send_mkpdu -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_participant_send_mkpdu
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
init|=
name|participant
operator|->
name|kay
decl_stmt|;
name|size_t
name|length
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: to enpacket and send the MKPDU"
argument_list|)
expr_stmt|;
name|length
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ieee8023_hdr
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|mak_body_handler
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mak_body_handler
index|[
name|i
index|]
operator|.
name|body_present
operator|&&
name|mak_body_handler
index|[
name|i
index|]
operator|.
name|body_present
argument_list|(
name|participant
argument_list|)
condition|)
name|length
operator|+=
name|mak_body_handler
index|[
name|i
index|]
operator|.
name|body_length
argument_list|(
name|participant
argument_list|)
expr_stmt|;
block|}
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: out of memory"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ieee802_1x_kay_encode_mkpdu
argument_list|(
name|participant
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: encode mkpdu fail!"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|l2_packet_send
argument_list|(
name|kay
operator|->
name|l2_mka
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|kay
operator|->
name|active
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|active
operator|=
name|TRUE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|ieee802_1x_kay_deinit_transmit_sa
parameter_list|(
name|struct
name|transmit_sa
modifier|*
name|psa
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**  * ieee802_1x_participant_timer -  */
end_comment

begin_function
specifier|static
name|void
name|ieee802_1x_participant_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|,
modifier|*
name|pre_peer
decl_stmt|;
name|time_t
name|now
init|=
name|time
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
name|Boolean
name|lp_changed
decl_stmt|;
name|struct
name|receive_sc
modifier|*
name|rxsc
decl_stmt|,
modifier|*
name|pre_rxsc
decl_stmt|;
name|struct
name|transmit_sa
modifier|*
name|txsa
decl_stmt|,
modifier|*
name|pre_txsa
decl_stmt|;
name|participant
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_participant
operator|*
operator|)
name|eloop_ctx
expr_stmt|;
name|kay
operator|=
name|participant
operator|->
name|kay
expr_stmt|;
if|if
condition|(
name|participant
operator|->
name|cak_life
condition|)
block|{
if|if
condition|(
name|now
operator|>
name|participant
operator|->
name|cak_life
condition|)
block|{
name|kay
operator|->
name|authenticated
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|secured
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|failed
operator|=
name|TRUE
expr_stmt|;
name|ieee802_1x_kay_delete_mka
argument_list|(
name|kay
argument_list|,
operator|&
name|participant
operator|->
name|ckn
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
comment|/* should delete MKA instance if there are not live peers 	 * when the MKA life elapsed since its creating */
if|if
condition|(
name|participant
operator|->
name|mka_life
condition|)
block|{
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|)
condition|)
block|{
if|if
condition|(
name|now
operator|>
name|participant
operator|->
name|mka_life
condition|)
block|{
name|kay
operator|->
name|authenticated
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|secured
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|failed
operator|=
name|TRUE
expr_stmt|;
name|ieee802_1x_kay_delete_mka
argument_list|(
name|kay
argument_list|,
operator|&
name|participant
operator|->
name|ckn
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
block|{
name|participant
operator|->
name|mka_life
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|lp_changed
operator|=
name|FALSE
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|peer
argument_list|,
argument|pre_peer
argument_list|,
argument|&participant->live_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|now
operator|>
name|peer
operator|->
name|expire
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Live peer removed"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMI: "
argument_list|,
name|peer
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|mi
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMN: %d"
argument_list|,
name|peer
operator|->
name|mn
argument_list|)
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|rxsc
argument_list|,
argument|pre_rxsc
argument_list|,
argument|&participant->rxsc_list
argument_list|,
argument|struct receive_sc
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
operator|&
name|rxsc
operator|->
name|sci
argument_list|,
operator|&
name|peer
operator|->
name|sci
argument_list|,
sizeof|sizeof
argument_list|(
name|rxsc
operator|->
name|sci
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|secy_delete_receive_sc
argument_list|(
name|kay
argument_list|,
name|rxsc
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_deinit_receive_sc
argument_list|(
name|participant
argument_list|,
name|rxsc
argument_list|)
expr_stmt|;
block|}
block|}
name|dl_list_del
argument_list|(
operator|&
name|peer
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
name|lp_changed
operator|=
name|TRUE
expr_stmt|;
block|}
block|}
if|if
condition|(
name|lp_changed
condition|)
block|{
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|)
condition|)
block|{
name|participant
operator|->
name|advised_desired
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|advised_capability
operator|=
name|MACSEC_CAP_NOT_IMPLEMENTED
expr_stmt|;
name|participant
operator|->
name|to_use_sak
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|authenticated
operator|=
name|TRUE
expr_stmt|;
name|kay
operator|->
name|secured
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|failed
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|ltx_kn
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|ltx_an
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|lrx_kn
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|lrx_an
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|otx_kn
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|otx_an
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|orx_kn
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|orx_an
operator|=
literal|0
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|txsa
argument_list|,
argument|pre_txsa
argument_list|,
argument|&participant->txsc->sa_list
argument_list|,
argument|struct transmit_sa
argument_list|,
argument|list
argument_list|)
block|{
name|secy_disable_transmit_sa
argument_list|(
name|kay
argument_list|,
name|txsa
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_deinit_transmit_sa
argument_list|(
name|txsa
argument_list|)
expr_stmt|;
block|}
name|ieee802_1x_cp_connect_authenticated
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ieee802_1x_kay_elect_key_server
argument_list|(
name|participant
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_decide_macsec_use
argument_list|(
name|participant
argument_list|)
expr_stmt|;
block|}
block|}
name|dl_list_for_each_safe
argument_list|(
argument|peer
argument_list|,
argument|pre_peer
argument_list|,
argument|&participant->potential_peers
argument_list|,
argument|struct ieee802_1x_kay_peer
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|now
operator|>
name|peer
operator|->
name|expire
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Potential peer removed"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMI: "
argument_list|,
name|peer
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|mi
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"\tMN: %d"
argument_list|,
name|peer
operator|->
name|mn
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|peer
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|participant
operator|->
name|new_sak
condition|)
block|{
if|if
condition|(
operator|!
name|ieee802_1x_kay_generate_new_sak
argument_list|(
name|participant
argument_list|)
condition|)
name|participant
operator|->
name|to_dist_sak
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|new_sak
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|participant
operator|->
name|retry_count
operator|<
name|MAX_RETRY_CNT
condition|)
block|{
name|ieee802_1x_participant_send_mkpdu
argument_list|(
name|participant
argument_list|)
expr_stmt|;
name|participant
operator|->
name|retry_count
operator|++
expr_stmt|;
block|}
name|eloop_register_timeout
argument_list|(
name|MKA_HELLO_TIME
operator|/
literal|1000
argument_list|,
literal|0
argument_list|,
name|ieee802_1x_participant_timer
argument_list|,
name|participant
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_init_transmit_sa -  */
end_comment

begin_function
specifier|static
name|struct
name|transmit_sa
modifier|*
name|ieee802_1x_kay_init_transmit_sa
parameter_list|(
name|struct
name|transmit_sc
modifier|*
name|psc
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
name|next_PN
parameter_list|,
name|struct
name|data_key
modifier|*
name|key
parameter_list|)
block|{
name|struct
name|transmit_sa
modifier|*
name|psa
decl_stmt|;
name|key
operator|->
name|tx_latest
operator|=
name|TRUE
expr_stmt|;
name|key
operator|->
name|rx_latest
operator|=
name|TRUE
expr_stmt|;
name|psa
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|psa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|psa
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|key
operator|->
name|confidentiality_offset
operator|>=
name|CONFIDENTIALITY_OFFSET_0
operator|&&
name|key
operator|->
name|confidentiality_offset
operator|<=
name|CONFIDENTIALITY_OFFSET_50
condition|)
name|psa
operator|->
name|confidentiality
operator|=
name|TRUE
expr_stmt|;
else|else
name|psa
operator|->
name|confidentiality
operator|=
name|FALSE
expr_stmt|;
name|psa
operator|->
name|an
operator|=
name|an
expr_stmt|;
name|psa
operator|->
name|pkey
operator|=
name|key
expr_stmt|;
name|psa
operator|->
name|next_pn
operator|=
name|next_PN
expr_stmt|;
name|psa
operator|->
name|sc
operator|=
name|psc
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|psa
operator|->
name|created_time
argument_list|)
expr_stmt|;
name|psa
operator|->
name|in_use
operator|=
name|FALSE
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|psc
operator|->
name|sa_list
argument_list|,
operator|&
name|psa
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Create transmit SA(an: %d, next_PN: %u) of SC(channel: %d)"
argument_list|,
operator|(
name|int
operator|)
name|an
argument_list|,
name|next_PN
argument_list|,
name|psc
operator|->
name|channel
argument_list|)
expr_stmt|;
return|return
name|psa
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_deinit_transmit_sa -  */
end_comment

begin_function
specifier|static
name|void
name|ieee802_1x_kay_deinit_transmit_sa
parameter_list|(
name|struct
name|transmit_sa
modifier|*
name|psa
parameter_list|)
block|{
name|psa
operator|->
name|pkey
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Delete transmit SA(an: %d) of SC(channel: %d)"
argument_list|,
name|psa
operator|->
name|an
argument_list|,
name|psa
operator|->
name|sc
operator|->
name|channel
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|psa
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|psa
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * init_transmit_sc -  */
end_comment

begin_function
specifier|static
name|struct
name|transmit_sc
modifier|*
name|ieee802_1x_kay_init_transmit_sc
parameter_list|(
specifier|const
name|struct
name|ieee802_1x_mka_sci
modifier|*
name|sci
parameter_list|,
name|int
name|channel
parameter_list|)
block|{
name|struct
name|transmit_sc
modifier|*
name|psc
decl_stmt|;
name|psc
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|psc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|psc
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
operator|&
name|psc
operator|->
name|sci
argument_list|,
name|sci
argument_list|,
sizeof|sizeof
argument_list|(
name|psc
operator|->
name|sci
argument_list|)
argument_list|)
expr_stmt|;
name|psc
operator|->
name|channel
operator|=
name|channel
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|psc
operator|->
name|created_time
argument_list|)
expr_stmt|;
name|psc
operator|->
name|transmitting
operator|=
name|FALSE
expr_stmt|;
name|psc
operator|->
name|encoding_sa
operator|=
name|FALSE
expr_stmt|;
name|psc
operator|->
name|enciphering_sa
operator|=
name|FALSE
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|psc
operator|->
name|sa_list
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Create transmit SC(channel: %d)"
argument_list|,
name|channel
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCI: "
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|sci
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sci
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|psc
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_deinit_transmit_sc -  */
end_comment

begin_function
specifier|static
name|void
name|ieee802_1x_kay_deinit_transmit_sc
parameter_list|(
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
parameter_list|,
name|struct
name|transmit_sc
modifier|*
name|psc
parameter_list|)
block|{
name|struct
name|transmit_sa
modifier|*
name|psa
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Delete transmit SC(channel: %d)"
argument_list|,
name|psc
operator|->
name|channel
argument_list|)
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|psa
argument_list|,
argument|tmp
argument_list|,
argument|&psc->sa_list
argument_list|,
argument|struct transmit_sa
argument_list|,
argument|list
argument_list|)
block|{
name|secy_disable_transmit_sa
argument_list|(
name|participant
operator|->
name|kay
argument_list|,
name|psa
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_deinit_transmit_sa
argument_list|(
name|psa
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|psc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/****************** Interface between CP and KAY *********************/
end_comment

begin_comment
comment|/**  * ieee802_1x_kay_set_latest_sa_attr -  */
end_comment

begin_function
name|int
name|ieee802_1x_kay_set_latest_sa_attr
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|struct
name|ieee802_1x_mka_ki
modifier|*
name|lki
parameter_list|,
name|u8
name|lan
parameter_list|,
name|Boolean
name|ltx
parameter_list|,
name|Boolean
name|lrx
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|principal
decl_stmt|;
name|principal
operator|=
name|ieee802_1x_kay_get_principal_participant
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|principal
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|lki
condition|)
name|os_memset
argument_list|(
operator|&
name|principal
operator|->
name|lki
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|->
name|lki
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|os_memcpy
argument_list|(
operator|&
name|principal
operator|->
name|lki
argument_list|,
name|lki
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|->
name|lki
argument_list|)
argument_list|)
expr_stmt|;
name|principal
operator|->
name|lan
operator|=
name|lan
expr_stmt|;
name|principal
operator|->
name|ltx
operator|=
name|ltx
expr_stmt|;
name|principal
operator|->
name|lrx
operator|=
name|lrx
expr_stmt|;
if|if
condition|(
operator|!
name|lki
condition|)
block|{
name|kay
operator|->
name|ltx_kn
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|lrx_kn
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|kay
operator|->
name|ltx_kn
operator|=
name|lki
operator|->
name|kn
expr_stmt|;
name|kay
operator|->
name|lrx_kn
operator|=
name|lki
operator|->
name|kn
expr_stmt|;
block|}
name|kay
operator|->
name|ltx_an
operator|=
name|lan
expr_stmt|;
name|kay
operator|->
name|lrx_an
operator|=
name|lan
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_set_old_sa_attr -  */
end_comment

begin_function
name|int
name|ieee802_1x_kay_set_old_sa_attr
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|struct
name|ieee802_1x_mka_ki
modifier|*
name|oki
parameter_list|,
name|u8
name|oan
parameter_list|,
name|Boolean
name|otx
parameter_list|,
name|Boolean
name|orx
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|principal
decl_stmt|;
name|principal
operator|=
name|ieee802_1x_kay_get_principal_participant
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|principal
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|oki
condition|)
name|os_memset
argument_list|(
operator|&
name|principal
operator|->
name|oki
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|->
name|oki
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|os_memcpy
argument_list|(
operator|&
name|principal
operator|->
name|oki
argument_list|,
name|oki
argument_list|,
sizeof|sizeof
argument_list|(
name|principal
operator|->
name|oki
argument_list|)
argument_list|)
expr_stmt|;
name|principal
operator|->
name|oan
operator|=
name|oan
expr_stmt|;
name|principal
operator|->
name|otx
operator|=
name|otx
expr_stmt|;
name|principal
operator|->
name|orx
operator|=
name|orx
expr_stmt|;
if|if
condition|(
operator|!
name|oki
condition|)
block|{
name|kay
operator|->
name|otx_kn
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|orx_kn
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|kay
operator|->
name|otx_kn
operator|=
name|oki
operator|->
name|kn
expr_stmt|;
name|kay
operator|->
name|orx_kn
operator|=
name|oki
operator|->
name|kn
expr_stmt|;
block|}
name|kay
operator|->
name|otx_an
operator|=
name|oan
expr_stmt|;
name|kay
operator|->
name|orx_an
operator|=
name|oan
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_create_sas -  */
end_comment

begin_function
name|int
name|ieee802_1x_kay_create_sas
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|struct
name|ieee802_1x_mka_ki
modifier|*
name|lki
parameter_list|)
block|{
name|struct
name|data_key
modifier|*
name|sa_key
decl_stmt|,
modifier|*
name|latest_sak
decl_stmt|;
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|principal
decl_stmt|;
name|struct
name|receive_sc
modifier|*
name|rxsc
decl_stmt|;
name|struct
name|receive_sa
modifier|*
name|rxsa
decl_stmt|;
name|struct
name|transmit_sa
modifier|*
name|txsa
decl_stmt|;
name|principal
operator|=
name|ieee802_1x_kay_get_principal_participant
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|principal
condition|)
return|return
operator|-
literal|1
return|;
name|latest_sak
operator|=
name|NULL
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|sa_key
argument_list|,
argument|&principal->sak_list
argument_list|,
argument|struct data_key
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|is_ki_equal
argument_list|(
operator|&
name|sa_key
operator|->
name|key_identifier
argument_list|,
name|lki
argument_list|)
condition|)
block|{
name|sa_key
operator|->
name|rx_latest
operator|=
name|TRUE
expr_stmt|;
name|sa_key
operator|->
name|tx_latest
operator|=
name|TRUE
expr_stmt|;
name|latest_sak
operator|=
name|sa_key
expr_stmt|;
name|principal
operator|->
name|to_use_sak
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|sa_key
operator|->
name|rx_latest
operator|=
name|FALSE
expr_stmt|;
name|sa_key
operator|->
name|tx_latest
operator|=
name|FALSE
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|latest_sak
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"lki related sak not found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dl_list_for_each
argument_list|(
argument|rxsc
argument_list|,
argument|&principal->rxsc_list
argument_list|,
argument|struct receive_sc
argument_list|,
argument|list
argument_list|)
block|{
name|rxsa
operator|=
name|ieee802_1x_kay_init_receive_sa
argument_list|(
name|rxsc
argument_list|,
name|latest_sak
operator|->
name|an
argument_list|,
literal|1
argument_list|,
name|latest_sak
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rxsa
condition|)
return|return
operator|-
literal|1
return|;
name|secy_create_receive_sa
argument_list|(
name|kay
argument_list|,
name|rxsa
argument_list|)
expr_stmt|;
block|}
name|txsa
operator|=
name|ieee802_1x_kay_init_transmit_sa
argument_list|(
name|principal
operator|->
name|txsc
argument_list|,
name|latest_sak
operator|->
name|an
argument_list|,
literal|1
argument_list|,
name|latest_sak
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|txsa
condition|)
return|return
operator|-
literal|1
return|;
name|secy_create_transmit_sa
argument_list|(
name|kay
argument_list|,
name|txsa
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_delete_sas -  */
end_comment

begin_function
name|int
name|ieee802_1x_kay_delete_sas
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|struct
name|ieee802_1x_mka_ki
modifier|*
name|ki
parameter_list|)
block|{
name|struct
name|data_key
modifier|*
name|sa_key
decl_stmt|,
modifier|*
name|pre_key
decl_stmt|;
name|struct
name|transmit_sa
modifier|*
name|txsa
decl_stmt|,
modifier|*
name|pre_txsa
decl_stmt|;
name|struct
name|receive_sa
modifier|*
name|rxsa
decl_stmt|,
modifier|*
name|pre_rxsa
decl_stmt|;
name|struct
name|receive_sc
modifier|*
name|rxsc
decl_stmt|;
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|principal
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Entry into %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|principal
operator|=
name|ieee802_1x_kay_get_principal_participant
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|principal
condition|)
return|return
operator|-
literal|1
return|;
comment|/* remove the transmit sa */
name|dl_list_for_each_safe
argument_list|(
argument|txsa
argument_list|,
argument|pre_txsa
argument_list|,
argument|&principal->txsc->sa_list
argument_list|,
argument|struct transmit_sa
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|is_ki_equal
argument_list|(
operator|&
name|txsa
operator|->
name|pkey
operator|->
name|key_identifier
argument_list|,
name|ki
argument_list|)
condition|)
block|{
name|secy_disable_transmit_sa
argument_list|(
name|kay
argument_list|,
name|txsa
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_deinit_transmit_sa
argument_list|(
name|txsa
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* remove the receive sa */
name|dl_list_for_each
argument_list|(
argument|rxsc
argument_list|,
argument|&principal->rxsc_list
argument_list|,
argument|struct receive_sc
argument_list|,
argument|list
argument_list|)
block|{
name|dl_list_for_each_safe
argument_list|(
argument|rxsa
argument_list|,
argument|pre_rxsa
argument_list|,
argument|&rxsc->sa_list
argument_list|,
argument|struct receive_sa
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|is_ki_equal
argument_list|(
operator|&
name|rxsa
operator|->
name|pkey
operator|->
name|key_identifier
argument_list|,
name|ki
argument_list|)
condition|)
block|{
name|secy_disable_receive_sa
argument_list|(
name|kay
argument_list|,
name|rxsa
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_deinit_receive_sa
argument_list|(
name|rxsa
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* remove the sak */
name|dl_list_for_each_safe
argument_list|(
argument|sa_key
argument_list|,
argument|pre_key
argument_list|,
argument|&principal->sak_list
argument_list|,
argument|struct data_key
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|is_ki_equal
argument_list|(
operator|&
name|sa_key
operator|->
name|key_identifier
argument_list|,
name|ki
argument_list|)
condition|)
block|{
name|ieee802_1x_kay_deinit_data_key
argument_list|(
name|sa_key
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|principal
operator|->
name|new_key
operator|==
name|sa_key
condition|)
name|principal
operator|->
name|new_key
operator|=
name|NULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_enable_tx_sas -  */
end_comment

begin_function
name|int
name|ieee802_1x_kay_enable_tx_sas
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|struct
name|ieee802_1x_mka_ki
modifier|*
name|lki
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|principal
decl_stmt|;
name|struct
name|transmit_sa
modifier|*
name|txsa
decl_stmt|;
name|principal
operator|=
name|ieee802_1x_kay_get_principal_participant
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|principal
condition|)
return|return
operator|-
literal|1
return|;
name|dl_list_for_each
argument_list|(
argument|txsa
argument_list|,
argument|&principal->txsc->sa_list
argument_list|,
argument|struct transmit_sa
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|is_ki_equal
argument_list|(
operator|&
name|txsa
operator|->
name|pkey
operator|->
name|key_identifier
argument_list|,
name|lki
argument_list|)
condition|)
block|{
name|txsa
operator|->
name|in_use
operator|=
name|TRUE
expr_stmt|;
name|secy_enable_transmit_sa
argument_list|(
name|kay
argument_list|,
name|txsa
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_set_usingtransmitas
argument_list|(
name|principal
operator|->
name|kay
operator|->
name|cp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|principal
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_enable_rx_sas -  */
end_comment

begin_function
name|int
name|ieee802_1x_kay_enable_rx_sas
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|struct
name|ieee802_1x_mka_ki
modifier|*
name|lki
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|principal
decl_stmt|;
name|struct
name|receive_sa
modifier|*
name|rxsa
decl_stmt|;
name|struct
name|receive_sc
modifier|*
name|rxsc
decl_stmt|;
name|principal
operator|=
name|ieee802_1x_kay_get_principal_participant
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|principal
condition|)
return|return
operator|-
literal|1
return|;
name|dl_list_for_each
argument_list|(
argument|rxsc
argument_list|,
argument|&principal->rxsc_list
argument_list|,
argument|struct receive_sc
argument_list|,
argument|list
argument_list|)
block|{
name|dl_list_for_each
argument_list|(
argument|rxsa
argument_list|,
argument|&rxsc->sa_list
argument_list|,
argument|struct receive_sa
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|is_ki_equal
argument_list|(
operator|&
name|rxsa
operator|->
name|pkey
operator|->
name|key_identifier
argument_list|,
name|lki
argument_list|)
condition|)
block|{
name|rxsa
operator|->
name|in_use
operator|=
name|TRUE
expr_stmt|;
name|secy_enable_receive_sa
argument_list|(
name|kay
argument_list|,
name|rxsa
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_set_usingreceivesas
argument_list|(
name|principal
operator|->
name|kay
operator|->
name|cp
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|principal
operator|->
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_enable_new_info -  */
end_comment

begin_function
name|int
name|ieee802_1x_kay_enable_new_info
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|principal
decl_stmt|;
name|principal
operator|=
name|ieee802_1x_kay_get_principal_participant
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|principal
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|principal
operator|->
name|retry_count
operator|<
name|MAX_RETRY_CNT
condition|)
block|{
name|ieee802_1x_participant_send_mkpdu
argument_list|(
name|principal
argument_list|)
expr_stmt|;
name|principal
operator|->
name|retry_count
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_cp_conf -  */
end_comment

begin_function
name|int
name|ieee802_1x_kay_cp_conf
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|struct
name|ieee802_1x_cp_conf
modifier|*
name|pconf
parameter_list|)
block|{
name|pconf
operator|->
name|protect
operator|=
name|kay
operator|->
name|macsec_protect
expr_stmt|;
name|pconf
operator|->
name|replay_protect
operator|=
name|kay
operator|->
name|macsec_replay_protect
expr_stmt|;
name|pconf
operator|->
name|validate
operator|=
name|kay
operator|->
name|macsec_validate
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_alloc_cp_sm -  */
end_comment

begin_function
specifier|static
name|struct
name|ieee802_1x_cp_sm
modifier|*
name|ieee802_1x_kay_alloc_cp_sm
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|)
block|{
name|struct
name|ieee802_1x_cp_conf
name|conf
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|conf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conf
argument_list|)
argument_list|)
expr_stmt|;
name|conf
operator|.
name|protect
operator|=
name|kay
operator|->
name|macsec_protect
expr_stmt|;
name|conf
operator|.
name|replay_protect
operator|=
name|kay
operator|->
name|macsec_replay_protect
expr_stmt|;
name|conf
operator|.
name|validate
operator|=
name|kay
operator|->
name|macsec_validate
expr_stmt|;
name|conf
operator|.
name|replay_window
operator|=
name|kay
operator|->
name|macsec_replay_window
expr_stmt|;
return|return
name|ieee802_1x_cp_sm_init
argument_list|(
name|kay
argument_list|,
operator|&
name|conf
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_mkpdu_sanity_check -  *     sanity check specified in clause 11.11.2 of IEEE802.1X-2010  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_kay_mkpdu_sanity_check
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|ieee8023_hdr
modifier|*
name|eth_hdr
decl_stmt|;
name|struct
name|ieee802_1x_hdr
modifier|*
name|eapol_hdr
decl_stmt|;
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|mka_hdr
decl_stmt|;
name|struct
name|ieee802_1x_mka_basic_body
modifier|*
name|body
decl_stmt|;
name|size_t
name|mka_msg_len
decl_stmt|;
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
name|size_t
name|body_len
decl_stmt|;
name|u8
name|icv
index|[
name|MAX_ICV_LEN
index|]
decl_stmt|;
name|u8
modifier|*
name|msg_icv
decl_stmt|;
name|eth_hdr
operator|=
operator|(
expr|struct
name|ieee8023_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|eapol_hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_hdr
operator|*
operator|)
operator|(
name|eth_hdr
operator|+
literal|1
operator|)
expr_stmt|;
name|mka_hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
operator|(
name|eapol_hdr
operator|+
literal|1
operator|)
expr_stmt|;
comment|/* destination address should be not individual address */
if|if
condition|(
name|os_memcmp
argument_list|(
name|eth_hdr
operator|->
name|dest
argument_list|,
name|pae_group_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"KaY: ethernet destination address is not PAE group address"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* MKPDU should not less than 32 octets */
name|mka_msg_len
operator|=
name|be_to_host16
argument_list|(
name|eapol_hdr
operator|->
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|mka_msg_len
operator|<
literal|32
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"KaY: MKPDU is less than 32 octets"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* MKPDU should multiple 4 octets */
if|if
condition|(
operator|(
name|mka_msg_len
operator|%
literal|4
operator|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"KaY: MKPDU is not multiple of 4 octets"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|body
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_basic_body
operator|*
operator|)
name|mka_hdr
expr_stmt|;
name|ieee802_1x_mka_dump_basic_body
argument_list|(
name|body
argument_list|)
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|body
argument_list|)
expr_stmt|;
comment|/* EAPOL-MKA body should comprise basic parameter set and ICV */
if|if
condition|(
name|mka_msg_len
operator|<
name|MKA_HDR_LEN
operator|+
name|body_len
operator|+
name|DEFAULT_ICV_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: Received EAPOL-MKA Packet Body Length (%d bytes) is less than the Basic Parameter Set Header Length (%d bytes) + the Basic Parameter Set Body Length (%d bytes) + %d bytes of ICV"
argument_list|,
operator|(
name|int
operator|)
name|mka_msg_len
argument_list|,
operator|(
name|int
operator|)
name|MKA_HDR_LEN
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|,
name|DEFAULT_ICV_LEN
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* CKN should be owned by I */
name|participant
operator|=
name|ieee802_1x_kay_get_participant
argument_list|(
name|kay
argument_list|,
name|body
operator|->
name|ckn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|participant
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CKN is not included in my CA"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* algorithm agility check */
if|if
condition|(
name|os_memcmp
argument_list|(
name|body
operator|->
name|algo_agility
argument_list|,
name|mka_algo_agility
argument_list|,
sizeof|sizeof
argument_list|(
name|body
operator|->
name|algo_agility
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: peer's algorithm agility not supported for me"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* ICV check */
comment|/* 	 * The ICV will comprise the final octets of the packet body, whatever 	 * its size, not the fixed length 16 octets, indicated by the EAPOL 	 * packet body length. 	 */
if|if
condition|(
name|mka_alg_tbl
index|[
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|icv_hash
argument_list|(
name|participant
operator|->
name|ick
operator|.
name|key
argument_list|,
name|buf
argument_list|,
name|len
operator|-
name|mka_alg_tbl
index|[
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|icv_len
argument_list|,
name|icv
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: omac1_aes_128 failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|msg_icv
operator|=
name|ieee802_1x_mka_decode_icv_body
argument_list|(
name|participant
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|mka_hdr
argument_list|,
name|mka_msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg_icv
condition|)
block|{
if|if
condition|(
name|os_memcmp_const
argument_list|(
name|msg_icv
argument_list|,
name|icv
argument_list|,
name|mka_alg_tbl
index|[
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|icv_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: Computed ICV is not equal to Received ICV"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: No ICV"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_decode_mkpdu -  */
end_comment

begin_function
specifier|static
name|int
name|ieee802_1x_kay_decode_mkpdu
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
name|struct
name|ieee802_1x_mka_hdr
modifier|*
name|hdr
decl_stmt|;
name|size_t
name|body_len
decl_stmt|;
name|size_t
name|left_len
decl_stmt|;
name|int
name|body_type
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|Boolean
name|my_included
decl_stmt|;
name|Boolean
name|handled
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|ieee802_1x_kay_mkpdu_sanity_check
argument_list|(
name|kay
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
comment|/* handle basic parameter set */
name|pos
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ieee8023_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_hdr
argument_list|)
expr_stmt|;
name|left_len
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ieee8023_hdr
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|ieee802_1x_hdr
argument_list|)
expr_stmt|;
name|participant
operator|=
name|ieee802_1x_mka_decode_basic_body
argument_list|(
name|kay
argument_list|,
name|pos
argument_list|,
name|left_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|participant
condition|)
return|return
operator|-
literal|1
return|;
comment|/* to skip basic parameter set */
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|body_len
operator|+
name|MKA_HDR_LEN
expr_stmt|;
name|left_len
operator|-=
name|body_len
operator|+
name|MKA_HDR_LEN
expr_stmt|;
comment|/* check i am in the peer's peer list */
name|my_included
operator|=
name|ieee802_1x_mka_i_in_peerlist
argument_list|(
name|participant
argument_list|,
name|pos
argument_list|,
name|left_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_included
condition|)
block|{
comment|/* accept the peer as live peer */
if|if
condition|(
operator|!
name|ieee802_1x_kay_is_in_peer
argument_list|(
name|participant
argument_list|,
name|participant
operator|->
name|current_peer_id
operator|.
name|mi
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|ieee802_1x_kay_create_live_peer
argument_list|(
name|participant
argument_list|,
name|participant
operator|->
name|current_peer_id
operator|.
name|mi
argument_list|,
name|participant
operator|->
name|current_peer_id
operator|.
name|mn
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|ieee802_1x_kay_elect_key_server
argument_list|(
name|participant
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_decide_macsec_use
argument_list|(
name|participant
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ieee802_1x_kay_is_in_potential_peer
argument_list|(
name|participant
argument_list|,
name|participant
operator|->
name|current_peer_id
operator|.
name|mi
argument_list|)
condition|)
block|{
name|ieee802_1x_kay_move_live_peer
argument_list|(
name|participant
argument_list|,
name|participant
operator|->
name|current_peer_id
operator|.
name|mi
argument_list|,
name|participant
operator|->
name|current_peer_id
operator|.
name|mn
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_elect_key_server
argument_list|(
name|participant
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_decide_macsec_use
argument_list|(
name|participant
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * Handle other parameter set than basic parameter set. 	 * Each parameter set should be present only once. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|handled
index|[
name|i
index|]
operator|=
name|FALSE
expr_stmt|;
name|handled
index|[
literal|0
index|]
operator|=
name|TRUE
expr_stmt|;
while|while
condition|(
name|left_len
operator|>
name|MKA_HDR_LEN
operator|+
name|DEFAULT_ICV_LEN
condition|)
block|{
name|hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_mka_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|body_len
operator|=
name|get_mka_param_body_len
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
name|body_type
operator|=
name|get_mka_param_body_type
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|body_type
operator|==
name|MKA_ICV_INDICATOR
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|left_len
operator|<
operator|(
name|MKA_HDR_LEN
operator|+
name|body_len
operator|+
name|DEFAULT_ICV_LEN
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: MKA Peer Packet Body Length (%d bytes) is less than the Parameter Set Header Length (%d bytes) + the Parameter Set Body Length (%d bytes) + %d bytes of ICV"
argument_list|,
operator|(
name|int
operator|)
name|left_len
argument_list|,
operator|(
name|int
operator|)
name|MKA_HDR_LEN
argument_list|,
operator|(
name|int
operator|)
name|body_len
argument_list|,
name|DEFAULT_ICV_LEN
argument_list|)
expr_stmt|;
goto|goto
name|next_para_set
goto|;
block|}
if|if
condition|(
name|handled
index|[
name|body_type
index|]
condition|)
goto|goto
name|next_para_set
goto|;
name|handled
index|[
name|body_type
index|]
operator|=
name|TRUE
expr_stmt|;
if|if
condition|(
name|mak_body_handler
index|[
name|body_type
index|]
operator|.
name|body_rx
condition|)
block|{
name|mak_body_handler
index|[
name|body_type
index|]
operator|.
name|body_rx
argument_list|(
name|participant
argument_list|,
name|pos
argument_list|,
name|left_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"The type %d not supported in this MKA version %d"
argument_list|,
name|body_type
argument_list|,
name|MKA_VERSION_ID
argument_list|)
expr_stmt|;
block|}
name|next_para_set
label|:
name|pos
operator|+=
name|body_len
operator|+
name|MKA_HDR_LEN
expr_stmt|;
name|left_len
operator|-=
name|body_len
operator|+
name|MKA_HDR_LEN
expr_stmt|;
block|}
name|kay
operator|->
name|active
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|retry_count
operator|=
literal|0
expr_stmt|;
name|participant
operator|->
name|active
operator|=
name|TRUE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|kay_l2_receive
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
init|=
name|ctx
decl_stmt|;
name|struct
name|ieee8023_hdr
modifier|*
name|eth_hdr
decl_stmt|;
name|struct
name|ieee802_1x_hdr
modifier|*
name|eapol_hdr
decl_stmt|;
comment|/* must contain at least ieee8023_hdr + ieee802_1x_hdr */
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|eth_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|eapol_hdr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"KaY: EAPOL frame too short (%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|eth_hdr
operator|=
operator|(
expr|struct
name|ieee8023_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|eapol_hdr
operator|=
operator|(
expr|struct
name|ieee802_1x_hdr
operator|*
operator|)
operator|(
name|eth_hdr
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|eth_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|eapol_hdr
argument_list|)
operator|+
name|ntohs
argument_list|(
name|eapol_hdr
operator|->
name|length
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"KAY: EAPOL MPDU is invalid: (%lu-%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|ntohs
argument_list|(
name|eapol_hdr
operator|->
name|length
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|eapol_hdr
operator|->
name|version
operator|<
name|EAPOL_VERSION
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"KaY: version %d does not support MKA"
argument_list|,
name|eapol_hdr
operator|->
name|version
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ntohs
argument_list|(
name|eth_hdr
operator|->
name|ethertype
argument_list|)
operator|!=
name|ETH_P_PAE
operator|||
name|eapol_hdr
operator|->
name|type
operator|!=
name|IEEE802_1X_TYPE_EAPOL_MKA
condition|)
return|return;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RX EAPOL-MKA: "
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|kay
operator|->
name|participant_list
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: no MKA participant instance"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ieee802_1x_kay_decode_mkpdu
argument_list|(
name|kay
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_init -  */
end_comment

begin_function
name|struct
name|ieee802_1x_kay
modifier|*
name|ieee802_1x_kay_init
parameter_list|(
name|struct
name|ieee802_1x_kay_ctx
modifier|*
name|ctx
parameter_list|,
name|enum
name|macsec_policy
name|policy
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
decl_stmt|;
name|kay
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|kay
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kay
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY-%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|kay
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|kay
operator|->
name|enable
operator|=
name|TRUE
expr_stmt|;
name|kay
operator|->
name|active
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|authenticated
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|secured
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|failed
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|policy
operator|=
name|policy
expr_stmt|;
name|os_strlcpy
argument_list|(
name|kay
operator|->
name|if_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|kay
operator|->
name|actor_sci
operator|.
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|kay
operator|->
name|actor_sci
operator|.
name|port
operator|=
literal|0x0001
expr_stmt|;
name|kay
operator|->
name|actor_priority
operator|=
name|DEFAULT_PRIO_NOT_KEY_SERVER
expr_stmt|;
comment|/* While actor acts as a key server, shall distribute sakey */
name|kay
operator|->
name|dist_kn
operator|=
literal|1
expr_stmt|;
name|kay
operator|->
name|dist_an
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|dist_time
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|pn_exhaustion
operator|=
name|PENDING_PN_EXHAUSTION
expr_stmt|;
name|kay
operator|->
name|macsec_csindex
operator|=
name|DEFAULT_CS_INDEX
expr_stmt|;
name|kay
operator|->
name|mka_algindex
operator|=
name|DEFAULT_MKA_ALG_INDEX
expr_stmt|;
name|kay
operator|->
name|mka_version
operator|=
name|MKA_VERSION_ID
expr_stmt|;
name|os_memcpy
argument_list|(
name|kay
operator|->
name|algo_agility
argument_list|,
name|mka_algo_agility
argument_list|,
sizeof|sizeof
argument_list|(
name|kay
operator|->
name|algo_agility
argument_list|)
argument_list|)
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|kay
operator|->
name|participant_list
argument_list|)
expr_stmt|;
if|if
condition|(
name|policy
operator|==
name|DO_NOT_SECURE
condition|)
block|{
name|kay
operator|->
name|macsec_capable
operator|=
name|MACSEC_CAP_NOT_IMPLEMENTED
expr_stmt|;
name|kay
operator|->
name|macsec_desired
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|macsec_protect
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|macsec_validate
operator|=
name|Disabled
expr_stmt|;
name|kay
operator|->
name|macsec_replay_protect
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|macsec_replay_window
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|macsec_confidentiality
operator|=
name|CONFIDENTIALITY_NONE
expr_stmt|;
block|}
else|else
block|{
name|kay
operator|->
name|macsec_capable
operator|=
name|MACSEC_CAP_INTEG_AND_CONF_0_30_50
expr_stmt|;
name|kay
operator|->
name|macsec_desired
operator|=
name|TRUE
expr_stmt|;
name|kay
operator|->
name|macsec_protect
operator|=
name|TRUE
expr_stmt|;
name|kay
operator|->
name|macsec_validate
operator|=
name|Strict
expr_stmt|;
name|kay
operator|->
name|macsec_replay_protect
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|macsec_replay_window
operator|=
literal|0
expr_stmt|;
name|kay
operator|->
name|macsec_confidentiality
operator|=
name|CONFIDENTIALITY_OFFSET_0
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: state machine created"
argument_list|)
expr_stmt|;
comment|/* Initialize the SecY must be prio to CP, as CP will control SecY */
name|secy_init_macsec
argument_list|(
name|kay
argument_list|)
expr_stmt|;
name|secy_get_available_transmit_sc
argument_list|(
name|kay
argument_list|,
operator|&
name|kay
operator|->
name|sc_ch
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: secy init macsec done"
argument_list|)
expr_stmt|;
comment|/* init CP */
name|kay
operator|->
name|cp
operator|=
name|ieee802_1x_kay_alloc_cp_sm
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
name|kay
operator|->
name|cp
operator|==
name|NULL
condition|)
block|{
name|ieee802_1x_kay_deinit
argument_list|(
name|kay
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|policy
operator|==
name|DO_NOT_SECURE
condition|)
block|{
name|ieee802_1x_cp_connect_authenticated
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|ieee802_1x_cp_sm_step
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|kay
operator|->
name|l2_mka
operator|=
name|l2_packet_init
argument_list|(
name|kay
operator|->
name|if_name
argument_list|,
name|NULL
argument_list|,
name|ETH_P_PAE
argument_list|,
name|kay_l2_receive
argument_list|,
name|kay
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|kay
operator|->
name|l2_mka
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"KaY: Failed to initialize L2 packet processing for MKA packet"
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_deinit
argument_list|(
name|kay
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
return|return
name|kay
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_deinit -  */
end_comment

begin_function
name|void
name|ieee802_1x_kay_deinit
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
if|if
condition|(
operator|!
name|kay
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: state machine removed"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|dl_list_empty
argument_list|(
operator|&
name|kay
operator|->
name|participant_list
argument_list|)
condition|)
block|{
name|participant
operator|=
name|dl_list_entry
argument_list|(
name|kay
operator|->
name|participant_list
operator|.
name|next
argument_list|,
expr|struct
name|ieee802_1x_mka_participant
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_delete_mka
argument_list|(
name|kay
argument_list|,
operator|&
name|participant
operator|->
name|ckn
argument_list|)
expr_stmt|;
block|}
name|ieee802_1x_cp_sm_deinit
argument_list|(
name|kay
operator|->
name|cp
argument_list|)
expr_stmt|;
name|secy_deinit_macsec
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
name|kay
operator|->
name|l2_mka
condition|)
block|{
name|l2_packet_deinit
argument_list|(
name|kay
operator|->
name|l2_mka
argument_list|)
expr_stmt|;
name|kay
operator|->
name|l2_mka
operator|=
name|NULL
expr_stmt|;
block|}
name|os_free
argument_list|(
name|kay
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|kay
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_create_mka -  */
end_comment

begin_function
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|ieee802_1x_kay_create_mka
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|struct
name|mka_key_name
modifier|*
name|ckn
parameter_list|,
name|struct
name|mka_key
modifier|*
name|cak
parameter_list|,
name|u32
name|life
parameter_list|,
name|enum
name|mka_created_mode
name|mode
parameter_list|,
name|Boolean
name|is_authenticator
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
name|unsigned
name|int
name|usecs
decl_stmt|;
if|if
condition|(
operator|!
name|kay
operator|||
operator|!
name|ckn
operator|||
operator|!
name|cak
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: ckn or cak is null"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|cak
operator|->
name|len
operator|!=
name|mka_alg_tbl
index|[
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|cak_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: CAK length not follow key schema"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ckn
operator|->
name|len
operator|>
name|MAX_CKN_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: CKN is out of range(<=32 bytes)"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|kay
operator|->
name|enable
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: Now is at disable state"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|participant
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|participant
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|participant
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY-%s: out of memory"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|participant
operator|->
name|ckn
operator|.
name|len
operator|=
name|ckn
operator|->
name|len
expr_stmt|;
name|os_memcpy
argument_list|(
name|participant
operator|->
name|ckn
operator|.
name|name
argument_list|,
name|ckn
operator|->
name|name
argument_list|,
name|ckn
operator|->
name|len
argument_list|)
expr_stmt|;
name|participant
operator|->
name|cak
operator|.
name|len
operator|=
name|cak
operator|->
name|len
expr_stmt|;
name|os_memcpy
argument_list|(
name|participant
operator|->
name|cak
operator|.
name|key
argument_list|,
name|cak
operator|->
name|key
argument_list|,
name|cak
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|life
condition|)
name|participant
operator|->
name|cak_life
operator|=
name|life
operator|+
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mode
condition|)
block|{
case|case
name|EAP_EXCHANGE
case|:
if|if
condition|(
name|is_authenticator
condition|)
block|{
name|participant
operator|->
name|is_obliged_key_server
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|can_be_key_server
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|is_key_server
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|principal
operator|=
name|TRUE
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|kay
operator|->
name|key_server_sci
argument_list|,
operator|&
name|kay
operator|->
name|actor_sci
argument_list|,
sizeof|sizeof
argument_list|(
name|kay
operator|->
name|key_server_sci
argument_list|)
argument_list|)
expr_stmt|;
name|kay
operator|->
name|key_server_priority
operator|=
name|kay
operator|->
name|actor_priority
expr_stmt|;
name|participant
operator|->
name|is_elected
operator|=
name|TRUE
expr_stmt|;
block|}
else|else
block|{
name|participant
operator|->
name|is_obliged_key_server
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|can_be_key_server
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|is_key_server
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|is_elected
operator|=
name|TRUE
expr_stmt|;
block|}
break|break;
default|default:
name|participant
operator|->
name|is_obliged_key_server
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|can_be_key_server
operator|=
name|TRUE
expr_stmt|;
name|participant
operator|->
name|is_key_server
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|is_elected
operator|=
name|FALSE
expr_stmt|;
break|break;
block|}
name|participant
operator|->
name|cached
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|active
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|participant
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|retain
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|activate
operator|=
name|DEFAULT
expr_stmt|;
if|if
condition|(
name|participant
operator|->
name|is_key_server
condition|)
name|participant
operator|->
name|principal
operator|=
name|TRUE
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|)
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|participant
operator|->
name|potential_peers
argument_list|)
expr_stmt|;
name|participant
operator|->
name|retry_count
operator|=
literal|0
expr_stmt|;
name|participant
operator|->
name|kay
operator|=
name|kay
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|participant
operator|->
name|mi
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|mi
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|participant
operator|->
name|mn
operator|=
literal|0
expr_stmt|;
name|participant
operator|->
name|lrx
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|ltx
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|orx
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|otx
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|to_dist_sak
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|to_use_sak
operator|=
name|FALSE
expr_stmt|;
name|participant
operator|->
name|new_sak
operator|=
name|FALSE
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|participant
operator|->
name|sak_list
argument_list|)
expr_stmt|;
name|participant
operator|->
name|new_key
operator|=
name|NULL
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|participant
operator|->
name|rxsc_list
argument_list|)
expr_stmt|;
name|participant
operator|->
name|txsc
operator|=
name|ieee802_1x_kay_init_transmit_sc
argument_list|(
operator|&
name|kay
operator|->
name|actor_sci
argument_list|,
name|kay
operator|->
name|sc_ch
argument_list|)
expr_stmt|;
name|secy_cp_control_protect_frames
argument_list|(
name|kay
argument_list|,
name|kay
operator|->
name|macsec_protect
argument_list|)
expr_stmt|;
name|secy_cp_control_replay
argument_list|(
name|kay
argument_list|,
name|kay
operator|->
name|macsec_replay_protect
argument_list|,
name|kay
operator|->
name|macsec_replay_window
argument_list|)
expr_stmt|;
name|secy_create_transmit_sc
argument_list|(
name|kay
argument_list|,
name|participant
operator|->
name|txsc
argument_list|)
expr_stmt|;
comment|/* to derive KEK from CAK and CKN */
name|participant
operator|->
name|kek
operator|.
name|len
operator|=
name|mka_alg_tbl
index|[
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|kek_len
expr_stmt|;
if|if
condition|(
name|mka_alg_tbl
index|[
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|kek_trfm
argument_list|(
name|participant
operator|->
name|cak
operator|.
name|key
argument_list|,
name|participant
operator|->
name|ckn
operator|.
name|name
argument_list|,
name|participant
operator|->
name|ckn
operator|.
name|len
argument_list|,
name|participant
operator|->
name|kek
operator|.
name|key
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: Derived KEK failed"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Derived KEK"
argument_list|,
name|participant
operator|->
name|kek
operator|.
name|key
argument_list|,
name|participant
operator|->
name|kek
operator|.
name|len
argument_list|)
expr_stmt|;
comment|/* to derive ICK from CAK and CKN */
name|participant
operator|->
name|ick
operator|.
name|len
operator|=
name|mka_alg_tbl
index|[
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|ick_len
expr_stmt|;
if|if
condition|(
name|mka_alg_tbl
index|[
name|kay
operator|->
name|mka_algindex
index|]
operator|.
name|ick_trfm
argument_list|(
name|participant
operator|->
name|cak
operator|.
name|key
argument_list|,
name|participant
operator|->
name|ckn
operator|.
name|name
argument_list|,
name|participant
operator|->
name|ckn
operator|.
name|len
argument_list|,
name|participant
operator|->
name|ick
operator|.
name|key
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: Derived ICK failed"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Derived ICK"
argument_list|,
name|participant
operator|->
name|ick
operator|.
name|key
argument_list|,
name|participant
operator|->
name|ick
operator|.
name|len
argument_list|)
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|kay
operator|->
name|participant_list
argument_list|,
operator|&
name|participant
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: Participant created:"
argument_list|,
name|ckn
operator|->
name|name
argument_list|,
name|ckn
operator|->
name|len
argument_list|)
expr_stmt|;
name|usecs
operator|=
name|os_random
argument_list|()
operator|%
operator|(
name|MKA_HELLO_TIME
operator|*
literal|1000
operator|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
name|usecs
argument_list|,
name|ieee802_1x_participant_timer
argument_list|,
name|participant
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|participant
operator|->
name|mka_life
operator|=
name|MKA_LIFE_TIME
operator|/
literal|1000
operator|+
name|time
argument_list|(
name|NULL
argument_list|)
operator|+
name|usecs
operator|/
literal|1000000
expr_stmt|;
return|return
name|participant
return|;
name|fail
label|:
name|os_free
argument_list|(
name|participant
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_delete_mka -  */
end_comment

begin_function
name|void
name|ieee802_1x_kay_delete_mka
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|struct
name|mka_key_name
modifier|*
name|ckn
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
name|struct
name|ieee802_1x_kay_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|data_key
modifier|*
name|sak
decl_stmt|;
name|struct
name|receive_sc
modifier|*
name|rxsc
decl_stmt|;
if|if
condition|(
operator|!
name|kay
operator|||
operator|!
name|ckn
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: participant removed"
argument_list|)
expr_stmt|;
comment|/* get the participant */
name|participant
operator|=
name|ieee802_1x_kay_get_participant
argument_list|(
name|kay
argument_list|,
name|ckn
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|participant
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: participant is not found"
argument_list|,
name|ckn
operator|->
name|name
argument_list|,
name|ckn
operator|->
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_del
argument_list|(
operator|&
name|participant
operator|->
name|list
argument_list|)
expr_stmt|;
comment|/* remove live peer */
while|while
condition|(
operator|!
name|dl_list_empty
argument_list|(
operator|&
name|participant
operator|->
name|live_peers
argument_list|)
condition|)
block|{
name|peer
operator|=
name|dl_list_entry
argument_list|(
name|participant
operator|->
name|live_peers
operator|.
name|next
argument_list|,
expr|struct
name|ieee802_1x_kay_peer
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|peer
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
block|}
comment|/* remove potential peer */
while|while
condition|(
operator|!
name|dl_list_empty
argument_list|(
operator|&
name|participant
operator|->
name|potential_peers
argument_list|)
condition|)
block|{
name|peer
operator|=
name|dl_list_entry
argument_list|(
name|participant
operator|->
name|potential_peers
operator|.
name|next
argument_list|,
expr|struct
name|ieee802_1x_kay_peer
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|peer
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
block|}
comment|/* remove sak */
while|while
condition|(
operator|!
name|dl_list_empty
argument_list|(
operator|&
name|participant
operator|->
name|sak_list
argument_list|)
condition|)
block|{
name|sak
operator|=
name|dl_list_entry
argument_list|(
name|participant
operator|->
name|sak_list
operator|.
name|next
argument_list|,
expr|struct
name|data_key
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|sak
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|sak
operator|->
name|key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|sak
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
operator|!
name|dl_list_empty
argument_list|(
operator|&
name|participant
operator|->
name|rxsc_list
argument_list|)
condition|)
block|{
name|rxsc
operator|=
name|dl_list_entry
argument_list|(
name|participant
operator|->
name|rxsc_list
operator|.
name|next
argument_list|,
expr|struct
name|receive_sc
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|secy_delete_receive_sc
argument_list|(
name|kay
argument_list|,
name|rxsc
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_deinit_receive_sc
argument_list|(
name|participant
argument_list|,
name|rxsc
argument_list|)
expr_stmt|;
block|}
name|secy_delete_transmit_sc
argument_list|(
name|kay
argument_list|,
name|participant
operator|->
name|txsc
argument_list|)
expr_stmt|;
name|ieee802_1x_kay_deinit_transmit_sc
argument_list|(
name|participant
argument_list|,
name|participant
operator|->
name|txsc
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|participant
operator|->
name|cak
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|cak
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|participant
operator|->
name|kek
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|kek
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|participant
operator|->
name|ick
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|participant
operator|->
name|ick
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|participant
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_mka_participate -  */
end_comment

begin_function
name|void
name|ieee802_1x_kay_mka_participate
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|struct
name|mka_key_name
modifier|*
name|ckn
parameter_list|,
name|Boolean
name|status
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
if|if
condition|(
operator|!
name|kay
operator|||
operator|!
name|ckn
condition|)
return|return;
name|participant
operator|=
name|ieee802_1x_kay_get_participant
argument_list|(
name|kay
argument_list|,
name|ckn
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|participant
condition|)
return|return;
name|participant
operator|->
name|active
operator|=
name|status
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_new_sak -  */
end_comment

begin_function
name|int
name|ieee802_1x_kay_new_sak
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
if|if
condition|(
operator|!
name|kay
condition|)
return|return
operator|-
literal|1
return|;
name|participant
operator|=
name|ieee802_1x_kay_get_principal_participant
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|participant
condition|)
return|return
operator|-
literal|1
return|;
name|participant
operator|->
name|new_sak
operator|=
name|TRUE
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"KaY: new SAK signal"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * ieee802_1x_kay_change_cipher_suite -  */
end_comment

begin_function
name|int
name|ieee802_1x_kay_change_cipher_suite
parameter_list|(
name|struct
name|ieee802_1x_kay
modifier|*
name|kay
parameter_list|,
name|int
name|cs_index
parameter_list|)
block|{
name|struct
name|ieee802_1x_mka_participant
modifier|*
name|participant
decl_stmt|;
if|if
condition|(
operator|!
name|kay
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|(
name|unsigned
name|int
operator|)
name|cs_index
operator|>=
name|CS_TABLE_SIZE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"KaY: Configured cipher suite index is out of range"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|kay
operator|->
name|macsec_csindex
operator|==
name|cs_index
condition|)
return|return
operator|-
literal|2
return|;
if|if
condition|(
name|cs_index
operator|==
literal|0
condition|)
name|kay
operator|->
name|macsec_desired
operator|=
name|FALSE
expr_stmt|;
name|kay
operator|->
name|macsec_csindex
operator|=
name|cs_index
expr_stmt|;
name|kay
operator|->
name|macsec_capable
operator|=
name|cipher_suite_tbl
index|[
name|kay
operator|->
name|macsec_csindex
index|]
operator|.
name|capable
expr_stmt|;
name|participant
operator|=
name|ieee802_1x_kay_get_principal_participant
argument_list|(
name|kay
argument_list|)
expr_stmt|;
if|if
condition|(
name|participant
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"KaY: Cipher Suite changed"
argument_list|)
expr_stmt|;
name|participant
operator|->
name|new_sak
operator|=
name|TRUE
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


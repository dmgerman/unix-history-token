begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant - TDLS  * Copyright (c) 2010-2011, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"utils/os.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"crypto/aes_wrap.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa_ie.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa_i.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
end_ifdef

begin_define
define|#
directive|define
name|TDLS_TESTING_LONG_FRAME
value|BIT(0)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_ALT_RSN_IE
value|BIT(1)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_DIFF_BSSID
value|BIT(2)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_SHORT_LIFETIME
value|BIT(3)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_WRONG_LIFETIME_RESP
value|BIT(4)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_WRONG_LIFETIME_CONF
value|BIT(5)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_LONG_LIFETIME
value|BIT(6)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_CONCURRENT_INIT
value|BIT(7)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_NO_TPK_EXPIRATION
value|BIT(8)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_DECLINE_RESP
value|BIT(9)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_IGNORE_AP_PROHIBIT
value|BIT(10)
end_define

begin_define
define|#
directive|define
name|TDLS_TESTING_WRONG_MIC
value|BIT(11)
end_define

begin_decl_stmt
name|unsigned
name|int
name|tdls_testing
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_TDLS_TESTING */
end_comment

begin_define
define|#
directive|define
name|TPK_LIFETIME
value|43200
end_define

begin_comment
comment|/* 12 hours */
end_comment

begin_define
define|#
directive|define
name|TPK_M1_RETRY_COUNT
value|3
end_define

begin_define
define|#
directive|define
name|TPK_M1_TIMEOUT
value|5000
end_define

begin_comment
comment|/* in milliseconds */
end_comment

begin_define
define|#
directive|define
name|TPK_M2_RETRY_COUNT
value|10
end_define

begin_define
define|#
directive|define
name|TPK_M2_TIMEOUT
value|500
end_define

begin_comment
comment|/* in milliseconds */
end_comment

begin_define
define|#
directive|define
name|TDLS_MIC_LEN
value|16
end_define

begin_define
define|#
directive|define
name|TDLS_TIMEOUT_LEN
value|4
end_define

begin_struct
struct|struct
name|wpa_tdls_ftie
block|{
name|u8
name|ie_type
decl_stmt|;
comment|/* FTIE */
name|u8
name|ie_len
decl_stmt|;
name|u8
name|mic_ctrl
index|[
literal|2
index|]
decl_stmt|;
name|u8
name|mic
index|[
name|TDLS_MIC_LEN
index|]
decl_stmt|;
name|u8
name|Anonce
index|[
name|WPA_NONCE_LEN
index|]
decl_stmt|;
comment|/* Responder Nonce in TDLS */
name|u8
name|Snonce
index|[
name|WPA_NONCE_LEN
index|]
decl_stmt|;
comment|/* Initiator Nonce in TDLS */
comment|/* followed by optional elements */
block|}
name|STRUCT_PACKED
struct|;
end_struct

begin_struct
struct|struct
name|wpa_tdls_timeoutie
block|{
name|u8
name|ie_type
decl_stmt|;
comment|/* Timeout IE */
name|u8
name|ie_len
decl_stmt|;
name|u8
name|interval_type
decl_stmt|;
name|u8
name|value
index|[
name|TDLS_TIMEOUT_LEN
index|]
decl_stmt|;
block|}
name|STRUCT_PACKED
struct|;
end_struct

begin_struct
struct|struct
name|wpa_tdls_lnkid
block|{
name|u8
name|ie_type
decl_stmt|;
comment|/* Link Identifier IE */
name|u8
name|ie_len
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|init_sta
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|resp_sta
index|[
name|ETH_ALEN
index|]
decl_stmt|;
block|}
name|STRUCT_PACKED
struct|;
end_struct

begin_comment
comment|/* TDLS frame headers as per IEEE Std 802.11z-2010 */
end_comment

begin_struct
struct|struct
name|wpa_tdls_frame
block|{
name|u8
name|payloadtype
decl_stmt|;
comment|/* IEEE80211_TDLS_RFTYPE */
name|u8
name|category
decl_stmt|;
comment|/* Category */
name|u8
name|action
decl_stmt|;
comment|/* Action (enum tdls_frame_type) */
block|}
name|STRUCT_PACKED
struct|;
end_struct

begin_function_decl
specifier|static
name|u8
modifier|*
name|wpa_add_tdls_timeoutie
parameter_list|(
name|u8
modifier|*
name|pos
parameter_list|,
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|u32
name|tsecs
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_tdls_tpk_retry_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_tdls_peer_free
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpa_tdls_disable_peer_link
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpa_tdls_send_teardown
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u16
name|reason_code
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|TDLS_MAX_IE_LEN
value|80
end_define

begin_define
define|#
directive|define
name|IEEE80211_MAX_SUPP_RATES
value|32
end_define

begin_struct
struct|struct
name|wpa_tdls_peer
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|next
decl_stmt|;
name|unsigned
name|int
name|reconfig_key
range|:
literal|1
decl_stmt|;
name|int
name|initiator
decl_stmt|;
comment|/* whether this end was initiator for TDLS setup */
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
comment|/* other end MAC address */
name|u8
name|inonce
index|[
name|WPA_NONCE_LEN
index|]
decl_stmt|;
comment|/* Initiator Nonce */
name|u8
name|rnonce
index|[
name|WPA_NONCE_LEN
index|]
decl_stmt|;
comment|/* Responder Nonce */
name|u8
name|rsnie_i
index|[
name|TDLS_MAX_IE_LEN
index|]
decl_stmt|;
comment|/* Initiator RSN IE */
name|size_t
name|rsnie_i_len
decl_stmt|;
name|u8
name|rsnie_p
index|[
name|TDLS_MAX_IE_LEN
index|]
decl_stmt|;
comment|/* Peer RSN IE */
name|size_t
name|rsnie_p_len
decl_stmt|;
name|u32
name|lifetime
decl_stmt|;
name|int
name|cipher
decl_stmt|;
comment|/* Selected cipher (WPA_CIPHER_*) */
name|u8
name|dtoken
decl_stmt|;
struct|struct
name|tpk
block|{
name|u8
name|kck
index|[
literal|16
index|]
decl_stmt|;
comment|/* TPK-KCK */
name|u8
name|tk
index|[
literal|16
index|]
decl_stmt|;
comment|/* TPK-TK; assuming only CCMP will be used */
block|}
name|tpk
struct|;
name|int
name|tpk_set
decl_stmt|;
name|int
name|tk_set
decl_stmt|;
comment|/* TPK-TK configured to the driver */
name|int
name|tpk_success
decl_stmt|;
name|int
name|tpk_in_progress
decl_stmt|;
struct|struct
name|tpk_timer
block|{
name|u8
name|dest
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|count
decl_stmt|;
comment|/* Retry Count */
name|int
name|timer
decl_stmt|;
comment|/* Timeout in milliseconds */
name|u8
name|action_code
decl_stmt|;
comment|/* TDLS frame type */
name|u8
name|dialog_token
decl_stmt|;
name|u16
name|status_code
decl_stmt|;
name|u32
name|peer_capab
decl_stmt|;
name|int
name|buf_len
decl_stmt|;
comment|/* length of TPK message for retransmission */
name|u8
modifier|*
name|buf
decl_stmt|;
comment|/* buffer for TPK message */
block|}
name|sm_tmr
struct|;
name|u16
name|capability
decl_stmt|;
name|u8
name|supp_rates
index|[
name|IEEE80211_MAX_SUPP_RATES
index|]
decl_stmt|;
name|size_t
name|supp_rates_len
decl_stmt|;
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|ht_capabilities
decl_stmt|;
name|struct
name|ieee80211_vht_capabilities
modifier|*
name|vht_capabilities
decl_stmt|;
name|u8
name|qos_info
decl_stmt|;
name|u16
name|aid
decl_stmt|;
name|u8
modifier|*
name|ext_capab
decl_stmt|;
name|size_t
name|ext_capab_len
decl_stmt|;
name|u8
modifier|*
name|supp_channels
decl_stmt|;
name|size_t
name|supp_channels_len
decl_stmt|;
name|u8
modifier|*
name|supp_oper_classes
decl_stmt|;
name|size_t
name|supp_oper_classes_len
decl_stmt|;
name|u8
name|wmm_capable
decl_stmt|;
comment|/* channel switch currently enabled */
name|int
name|chan_switch_enabled
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wpa_tdls_get_privacy
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
comment|/* 	 * Get info needed from supplicant to check if the current BSS supports 	 * security. Other than OPEN mode, rest are considered secured 	 * WEP/WPA/WPA2 hence TDLS frames are processed for TPK handshake. 	 */
return|return
name|sm
operator|->
name|pairwise_cipher
operator|!=
name|WPA_CIPHER_NONE
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|wpa_add_ie
parameter_list|(
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
return|return
name|pos
operator|+
name|ie_len
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_del_key
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
if|if
condition|(
name|wpa_sm_set_key
argument_list|(
name|sm
argument_list|,
name|WPA_ALG_NONE
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TDLS: Failed to delete TPK-TK from "
literal|"the driver"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_set_key
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
name|u8
name|key_len
decl_stmt|;
name|u8
name|rsc
index|[
literal|6
index|]
decl_stmt|;
name|enum
name|wpa_alg
name|alg
decl_stmt|;
if|if
condition|(
name|peer
operator|->
name|tk_set
condition|)
block|{
comment|/* 		 * This same TPK-TK has already been configured to the driver 		 * and this new configuration attempt (likely due to an 		 * unexpected retransmitted frame) would result in clearing 		 * the TX/RX sequence number which can break security, so must 		 * not allow that to happen. 		 */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: TPK-TK for the peer "
name|MACSTR
literal|" has already been configured to the driver - do not reconfigure"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
name|rsc
argument_list|,
literal|0
argument_list|,
literal|6
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|peer
operator|->
name|cipher
condition|)
block|{
case|case
name|WPA_CIPHER_CCMP
case|:
name|alg
operator|=
name|WPA_ALG_CCMP
expr_stmt|;
name|key_len
operator|=
literal|16
expr_stmt|;
break|break;
case|case
name|WPA_CIPHER_NONE
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Pairwise Cipher Suite: "
literal|"NONE - do not use pairwise keys"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TDLS: Unsupported pairwise cipher %d"
argument_list|,
name|sm
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Configure pairwise key for peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peer
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_sm_set_key
argument_list|(
name|sm
argument_list|,
name|alg
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
name|rsc
argument_list|,
sizeof|sizeof
argument_list|(
name|rsc
argument_list|)
argument_list|,
name|peer
operator|->
name|tpk
operator|.
name|tk
argument_list|,
name|key_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TDLS: Failed to set TPK to the "
literal|"driver"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|->
name|tk_set
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_send_tpk_msg
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|action_code
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|u16
name|status_code
parameter_list|,
name|u32
name|peer_capab
parameter_list|,
name|int
name|initiator
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
return|return
name|wpa_sm_send_tdls_mgmt
argument_list|(
name|sm
argument_list|,
name|dst
argument_list|,
name|action_code
argument_list|,
name|dialog_token
argument_list|,
name|status_code
argument_list|,
name|peer_capab
argument_list|,
name|initiator
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_tpk_send
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|dest
parameter_list|,
name|u8
name|action_code
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|u16
name|status_code
parameter_list|,
name|u32
name|peer_capab
parameter_list|,
name|int
name|initiator
parameter_list|,
specifier|const
name|u8
modifier|*
name|msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK send dest="
name|MACSTR
literal|" action_code=%u "
literal|"dialog_token=%u status_code=%u peer_capab=%u initiator=%d "
literal|"msg_len=%u"
argument_list|,
name|MAC2STR
argument_list|(
name|dest
argument_list|)
argument_list|,
name|action_code
argument_list|,
name|dialog_token
argument_list|,
name|status_code
argument_list|,
name|peer_capab
argument_list|,
name|initiator
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_tdls_send_tpk_msg
argument_list|(
name|sm
argument_list|,
name|dest
argument_list|,
name|action_code
argument_list|,
name|dialog_token
argument_list|,
name|status_code
argument_list|,
name|peer_capab
argument_list|,
name|initiator
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Failed to send message "
literal|"(action_code=%u)"
argument_list|,
name|action_code
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|action_code
operator|==
name|WLAN_TDLS_SETUP_CONFIRM
operator|||
name|action_code
operator|==
name|WLAN_TDLS_TEARDOWN
operator|||
name|action_code
operator|==
name|WLAN_TDLS_DISCOVERY_REQUEST
operator|||
name|action_code
operator|==
name|WLAN_TDLS_DISCOVERY_RESPONSE
condition|)
return|return
literal|0
return|;
comment|/* No retries */
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|dest
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No matching entry found for "
literal|"retry "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dest
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|wpa_tdls_tpk_retry_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|action_code
operator|==
name|WLAN_TDLS_SETUP_RESPONSE
condition|)
block|{
name|peer
operator|->
name|sm_tmr
operator|.
name|count
operator|=
name|TPK_M2_RETRY_COUNT
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|timer
operator|=
name|TPK_M2_TIMEOUT
expr_stmt|;
block|}
else|else
block|{
name|peer
operator|->
name|sm_tmr
operator|.
name|count
operator|=
name|TPK_M1_RETRY_COUNT
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|timer
operator|=
name|TPK_M1_TIMEOUT
expr_stmt|;
block|}
comment|/* Copy message to resend on timeout */
name|os_memcpy
argument_list|(
name|peer
operator|->
name|sm_tmr
operator|.
name|dest
argument_list|,
name|dest
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|action_code
operator|=
name|action_code
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|dialog_token
operator|=
name|dialog_token
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|status_code
operator|=
name|status_code
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|peer_capab
operator|=
name|peer_capab
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|buf_len
operator|=
name|msg_len
expr_stmt|;
name|os_free
argument_list|(
name|peer
operator|->
name|sm_tmr
operator|.
name|buf
argument_list|)
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|buf
operator|=
name|os_malloc
argument_list|(
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|sm_tmr
operator|.
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|peer
operator|->
name|sm_tmr
operator|.
name|buf
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Retry timeout registered "
literal|"(action_code=%u)"
argument_list|,
name|action_code
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|peer
operator|->
name|sm_tmr
operator|.
name|timer
operator|/
literal|1000
argument_list|,
operator|(
name|peer
operator|->
name|sm_tmr
operator|.
name|timer
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|wpa_tdls_tpk_retry_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_do_teardown
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|,
name|u16
name|reason_code
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|wpa_tdls_send_teardown
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
comment|/* disable the link after teardown was sent */
name|wpa_tdls_disable_peer_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_tdls_tpk_retry_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_sm
modifier|*
name|sm
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
init|=
name|timeout_ctx
decl_stmt|;
if|if
condition|(
name|peer
operator|->
name|sm_tmr
operator|.
name|count
condition|)
block|{
name|peer
operator|->
name|sm_tmr
operator|.
name|count
operator|--
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Retrying sending of message "
literal|"(action_code=%u)"
argument_list|,
name|peer
operator|->
name|sm_tmr
operator|.
name|action_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|sm_tmr
operator|.
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No retry buffer available "
literal|"for action_code=%u"
argument_list|,
name|peer
operator|->
name|sm_tmr
operator|.
name|action_code
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_tdls_tpk_retry_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* resend TPK Handshake Message to Peer */
if|if
condition|(
name|wpa_tdls_send_tpk_msg
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|sm_tmr
operator|.
name|dest
argument_list|,
name|peer
operator|->
name|sm_tmr
operator|.
name|action_code
argument_list|,
name|peer
operator|->
name|sm_tmr
operator|.
name|dialog_token
argument_list|,
name|peer
operator|->
name|sm_tmr
operator|.
name|status_code
argument_list|,
name|peer
operator|->
name|sm_tmr
operator|.
name|peer_capab
argument_list|,
name|peer
operator|->
name|initiator
argument_list|,
name|peer
operator|->
name|sm_tmr
operator|.
name|buf
argument_list|,
name|peer
operator|->
name|sm_tmr
operator|.
name|buf_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Failed to retry "
literal|"transmission"
argument_list|)
expr_stmt|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|wpa_tdls_tpk_retry_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|peer
operator|->
name|sm_tmr
operator|.
name|timer
operator|/
literal|1000
argument_list|,
operator|(
name|peer
operator|->
name|sm_tmr
operator|.
name|timer
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|wpa_tdls_tpk_retry_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpa_tdls_tpk_retry_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Sending Teardown Request"
argument_list|)
expr_stmt|;
name|wpa_tdls_do_teardown
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|WLAN_REASON_TDLS_TEARDOWN_UNSPECIFIED
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_tdls_tpk_retry_timeout_cancel
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|,
name|u8
name|action_code
parameter_list|)
block|{
if|if
condition|(
name|action_code
operator|==
name|peer
operator|->
name|sm_tmr
operator|.
name|action_code
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Retry timeout cancelled for "
literal|"action_code=%u"
argument_list|,
name|action_code
argument_list|)
expr_stmt|;
comment|/* Cancel Timeout registered */
name|eloop_cancel_timeout
argument_list|(
name|wpa_tdls_tpk_retry_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
comment|/* free all resources meant for retry */
name|os_free
argument_list|(
name|peer
operator|->
name|sm_tmr
operator|.
name|buf
argument_list|)
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|buf
operator|=
name|NULL
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|count
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|timer
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|buf_len
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|action_code
operator|=
literal|0xff
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Error in cancelling retry timeout "
literal|"(Unknown action_code=%u)"
argument_list|,
name|action_code
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_tdls_generate_tpk
parameter_list|(
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|u8
name|key_input
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|nonce
index|[
literal|2
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|2
index|]
decl_stmt|;
name|u8
name|data
index|[
literal|3
operator|*
name|ETH_ALEN
index|]
decl_stmt|;
comment|/* IEEE Std 802.11z-2010 8.5.9.1: 	 * TPK-Key-Input = SHA-256(min(SNonce, ANonce) || max(SNonce, ANonce)) 	 */
name|len
index|[
literal|0
index|]
operator|=
name|WPA_NONCE_LEN
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|WPA_NONCE_LEN
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|inonce
argument_list|,
name|peer
operator|->
name|rnonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|nonce
index|[
literal|0
index|]
operator|=
name|peer
operator|->
name|inonce
expr_stmt|;
name|nonce
index|[
literal|1
index|]
operator|=
name|peer
operator|->
name|rnonce
expr_stmt|;
block|}
else|else
block|{
name|nonce
index|[
literal|0
index|]
operator|=
name|peer
operator|->
name|rnonce
expr_stmt|;
name|nonce
index|[
literal|1
index|]
operator|=
name|peer
operator|->
name|inonce
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: min(Nonce)"
argument_list|,
name|nonce
index|[
literal|0
index|]
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: max(Nonce)"
argument_list|,
name|nonce
index|[
literal|1
index|]
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|sha256_vector
argument_list|(
literal|2
argument_list|,
name|nonce
argument_list|,
name|len
argument_list|,
name|key_input
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK-Key-Input"
argument_list|,
name|key_input
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
comment|/* 	 * TPK-Key-Data = KDF-N_KEY(TPK-Key-Input, "TDLS PMK", 	 *	min(MAC_I, MAC_R) || max(MAC_I, MAC_R) || BSSID || N_KEY) 	 * TODO: is N_KEY really included in KDF Context and if so, in which 	 * presentation format (little endian 16-bit?) is it used? It gets 	 * added by the KDF anyway.. 	 */
if|if
condition|(
name|os_memcmp
argument_list|(
name|own_addr
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|data
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|+
name|ETH_ALEN
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|data
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|+
name|ETH_ALEN
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|+
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: KDF Context"
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|sha256_prf
argument_list|(
name|key_input
argument_list|,
name|SHA256_MAC_LEN
argument_list|,
literal|"TDLS PMK"
argument_list|,
name|data
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|peer
operator|->
name|tpk
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|tpk
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK-KCK"
argument_list|,
name|peer
operator|->
name|tpk
operator|.
name|kck
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|tpk
operator|.
name|kck
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK-TK"
argument_list|,
name|peer
operator|->
name|tpk
operator|.
name|tk
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|tpk
operator|.
name|tk
argument_list|)
argument_list|)
expr_stmt|;
name|peer
operator|->
name|tpk_set
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_tdls_ftie_mic - Calculate TDLS FTIE MIC  * @kck: TPK-KCK  * @lnkid: Pointer to the beginning of Link Identifier IE  * @rsnie: Pointer to the beginning of RSN IE used for handshake  * @timeoutie: Pointer to the beginning of Timeout IE used for handshake  * @ftie: Pointer to the beginning of FT IE  * @mic: Pointer for writing MIC  *  * Calculate MIC for TDLS frame.  */
end_comment

begin_function
specifier|static
name|int
name|wpa_tdls_ftie_mic
parameter_list|(
specifier|const
name|u8
modifier|*
name|kck
parameter_list|,
name|u8
name|trans_seq
parameter_list|,
specifier|const
name|u8
modifier|*
name|lnkid
parameter_list|,
specifier|const
name|u8
modifier|*
name|rsnie
parameter_list|,
specifier|const
name|u8
modifier|*
name|timeoutie
parameter_list|,
specifier|const
name|u8
modifier|*
name|ftie
parameter_list|,
name|u8
modifier|*
name|mic
parameter_list|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|struct
name|wpa_tdls_ftie
modifier|*
name|_ftie
decl_stmt|;
specifier|const
name|struct
name|wpa_tdls_lnkid
modifier|*
name|_lnkid
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|len
init|=
literal|2
operator|*
name|ETH_ALEN
operator|+
literal|1
operator|+
literal|2
operator|+
name|lnkid
index|[
literal|1
index|]
operator|+
literal|2
operator|+
name|rsnie
index|[
literal|1
index|]
operator|+
literal|2
operator|+
name|timeoutie
index|[
literal|1
index|]
operator|+
literal|2
operator|+
name|ftie
index|[
literal|1
index|]
decl_stmt|;
name|buf
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TDLS: No memory for MIC calculation"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|buf
expr_stmt|;
name|_lnkid
operator|=
operator|(
specifier|const
expr|struct
name|wpa_tdls_lnkid
operator|*
operator|)
name|lnkid
expr_stmt|;
comment|/* 1) TDLS initiator STA MAC address */
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|_lnkid
operator|->
name|init_sta
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
comment|/* 2) TDLS responder STA MAC address */
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|_lnkid
operator|->
name|resp_sta
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
comment|/* 3) Transaction Sequence number */
operator|*
name|pos
operator|++
operator|=
name|trans_seq
expr_stmt|;
comment|/* 4) Link Identifier IE */
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|lnkid
argument_list|,
literal|2
operator|+
name|lnkid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|lnkid
index|[
literal|1
index|]
expr_stmt|;
comment|/* 5) RSN IE */
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|rsnie
argument_list|,
literal|2
operator|+
name|rsnie
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|rsnie
index|[
literal|1
index|]
expr_stmt|;
comment|/* 6) Timeout Interval IE */
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|timeoutie
argument_list|,
literal|2
operator|+
name|timeoutie
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|timeoutie
index|[
literal|1
index|]
expr_stmt|;
comment|/* 7) FTIE, with the MIC field of the FTIE set to 0 */
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|ftie
argument_list|,
literal|2
operator|+
name|ftie
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|_ftie
operator|=
operator|(
expr|struct
name|wpa_tdls_ftie
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memset
argument_list|(
name|_ftie
operator|->
name|mic
argument_list|,
literal|0
argument_list|,
name|TDLS_MIC_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|ftie
index|[
literal|1
index|]
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Data for FTIE MIC"
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: KCK"
argument_list|,
name|kck
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ret
operator|=
name|omac1_aes_128
argument_list|(
name|kck
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
name|mic
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: FTIE MIC"
argument_list|,
name|mic
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_tdls_key_mic_teardown - Calculate TDLS FTIE MIC for Teardown frame  * @kck: TPK-KCK  * @trans_seq: Transaction Sequence Number (4 - Teardown)  * @rcode: Reason code for Teardown  * @dtoken: Dialog Token used for that particular link  * @lnkid: Pointer to the beginning of Link Identifier IE  * @ftie: Pointer to the beginning of FT IE  * @mic: Pointer for writing MIC  *  * Calculate MIC for TDLS frame.  */
end_comment

begin_function
specifier|static
name|int
name|wpa_tdls_key_mic_teardown
parameter_list|(
specifier|const
name|u8
modifier|*
name|kck
parameter_list|,
name|u8
name|trans_seq
parameter_list|,
name|u16
name|rcode
parameter_list|,
name|u8
name|dtoken
parameter_list|,
specifier|const
name|u8
modifier|*
name|lnkid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ftie
parameter_list|,
name|u8
modifier|*
name|mic
parameter_list|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|struct
name|wpa_tdls_ftie
modifier|*
name|_ftie
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|lnkid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
literal|2
operator|+
name|lnkid
index|[
literal|1
index|]
operator|+
sizeof|sizeof
argument_list|(
name|rcode
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|dtoken
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|trans_seq
argument_list|)
operator|+
literal|2
operator|+
name|ftie
index|[
literal|1
index|]
expr_stmt|;
name|buf
operator|=
name|os_zalloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TDLS: No memory for MIC calculation"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|buf
expr_stmt|;
comment|/* 1) Link Identifier IE */
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|lnkid
argument_list|,
literal|2
operator|+
name|lnkid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|lnkid
index|[
literal|1
index|]
expr_stmt|;
comment|/* 2) Reason Code */
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
name|rcode
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|rcode
argument_list|)
expr_stmt|;
comment|/* 3) Dialog token */
operator|*
name|pos
operator|++
operator|=
name|dtoken
expr_stmt|;
comment|/* 4) Transaction Sequence number */
operator|*
name|pos
operator|++
operator|=
name|trans_seq
expr_stmt|;
comment|/* 7) FTIE, with the MIC field of the FTIE set to 0 */
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|ftie
argument_list|,
literal|2
operator|+
name|ftie
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|_ftie
operator|=
operator|(
expr|struct
name|wpa_tdls_ftie
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memset
argument_list|(
name|_ftie
operator|->
name|mic
argument_list|,
literal|0
argument_list|,
name|TDLS_MIC_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|ftie
index|[
literal|1
index|]
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Data for FTIE MIC"
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: KCK"
argument_list|,
name|kck
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|ret
operator|=
name|omac1_aes_128
argument_list|(
name|kck
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
name|mic
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: FTIE MIC"
argument_list|,
name|mic
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_verify_tdls_mic
parameter_list|(
name|u8
name|trans_seq
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|,
specifier|const
name|u8
modifier|*
name|lnkid
parameter_list|,
specifier|const
name|u8
modifier|*
name|timeoutie
parameter_list|,
specifier|const
name|struct
name|wpa_tdls_ftie
modifier|*
name|ftie
parameter_list|)
block|{
name|u8
name|mic
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|peer
operator|->
name|tpk_set
condition|)
block|{
name|wpa_tdls_ftie_mic
argument_list|(
name|peer
operator|->
name|tpk
operator|.
name|kck
argument_list|,
name|trans_seq
argument_list|,
name|lnkid
argument_list|,
name|peer
operator|->
name|rsnie_p
argument_list|,
name|timeoutie
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ftie
argument_list|,
name|mic
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp_const
argument_list|(
name|mic
argument_list|,
name|ftie
operator|->
name|mic
argument_list|,
literal|16
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Invalid MIC in FTIE - "
literal|"dropping packet"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Received MIC"
argument_list|,
name|ftie
operator|->
name|mic
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Calculated MIC"
argument_list|,
name|mic
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"TDLS: Could not verify TDLS MIC, "
literal|"TPK not set - dropping packet"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_verify_tdls_mic_teardown
parameter_list|(
name|u8
name|trans_seq
parameter_list|,
name|u16
name|rcode
parameter_list|,
name|u8
name|dtoken
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|,
specifier|const
name|u8
modifier|*
name|lnkid
parameter_list|,
specifier|const
name|struct
name|wpa_tdls_ftie
modifier|*
name|ftie
parameter_list|)
block|{
name|u8
name|mic
index|[
literal|16
index|]
decl_stmt|;
if|if
condition|(
name|peer
operator|->
name|tpk_set
condition|)
block|{
name|wpa_tdls_key_mic_teardown
argument_list|(
name|peer
operator|->
name|tpk
operator|.
name|kck
argument_list|,
name|trans_seq
argument_list|,
name|rcode
argument_list|,
name|dtoken
argument_list|,
name|lnkid
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ftie
argument_list|,
name|mic
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp_const
argument_list|(
name|mic
argument_list|,
name|ftie
operator|->
name|mic
argument_list|,
literal|16
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Invalid MIC in Teardown - "
literal|"dropping packet"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Could not verify TDLS Teardown "
literal|"MIC, TPK not set - dropping packet"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_tdls_tpk_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_sm
modifier|*
name|sm
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
init|=
name|timeout_ctx
decl_stmt|;
comment|/* 	 * On TPK lifetime expiration, we have an option of either tearing down 	 * the direct link or trying to re-initiate it. The selection of what 	 * to do is not strictly speaking controlled by our role in the expired 	 * link, but for now, use that to select whether to renew or tear down 	 * the link. 	 */
if|if
condition|(
name|peer
operator|->
name|initiator
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK lifetime expired for "
name|MACSTR
literal|" - try to renew"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_tdls_start
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK lifetime expired for "
name|MACSTR
literal|" - tear down"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_tdls_do_teardown
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|WLAN_REASON_TDLS_TEARDOWN_UNSPECIFIED
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_tdls_peer_remove_from_list
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|cur
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|cur
operator|=
name|sm
operator|->
name|tdls
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|cur
operator|&&
name|cur
operator|!=
name|peer
condition|)
block|{
name|prev
operator|=
name|cur
expr_stmt|;
name|cur
operator|=
name|cur
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|cur
operator|!=
name|peer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TDLS: Could not find peer "
name|MACSTR
literal|" to remove it from the list"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|peer
operator|->
name|next
expr_stmt|;
else|else
name|sm
operator|->
name|tdls
operator|=
name|peer
operator|->
name|next
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_tdls_peer_clear
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Clear state for peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peer
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_tdls_tpk_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_tdls_tpk_retry_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|peer
operator|->
name|reconfig_key
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|initiator
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|tpk_in_progress
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|peer
operator|->
name|sm_tmr
operator|.
name|buf
argument_list|)
expr_stmt|;
name|peer
operator|->
name|sm_tmr
operator|.
name|buf
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|peer
operator|->
name|ht_capabilities
argument_list|)
expr_stmt|;
name|peer
operator|->
name|ht_capabilities
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|peer
operator|->
name|vht_capabilities
argument_list|)
expr_stmt|;
name|peer
operator|->
name|vht_capabilities
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|peer
operator|->
name|ext_capab
argument_list|)
expr_stmt|;
name|peer
operator|->
name|ext_capab
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|peer
operator|->
name|supp_channels
argument_list|)
expr_stmt|;
name|peer
operator|->
name|supp_channels
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|peer
operator|->
name|supp_oper_classes
argument_list|)
expr_stmt|;
name|peer
operator|->
name|supp_oper_classes
operator|=
name|NULL
expr_stmt|;
name|peer
operator|->
name|rsnie_i_len
operator|=
name|peer
operator|->
name|rsnie_p_len
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|cipher
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|qos_info
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|wmm_capable
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|tk_set
operator|=
name|peer
operator|->
name|tpk_set
operator|=
name|peer
operator|->
name|tpk_success
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|chan_switch_enabled
operator|=
literal|0
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|peer
operator|->
name|tpk
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|tpk
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|peer
operator|->
name|inonce
argument_list|,
literal|0
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|peer
operator|->
name|rnonce
argument_list|,
literal|0
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_tdls_peer_free
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
name|wpa_tdls_peer_clear
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|wpa_tdls_peer_remove_from_list
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|peer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_tdls_linkid
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|,
name|struct
name|wpa_tdls_lnkid
modifier|*
name|lnkid
parameter_list|)
block|{
name|lnkid
operator|->
name|ie_type
operator|=
name|WLAN_EID_LINK_ID
expr_stmt|;
name|lnkid
operator|->
name|ie_len
operator|=
literal|3
operator|*
name|ETH_ALEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|lnkid
operator|->
name|bssid
argument_list|,
name|sm
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|initiator
condition|)
block|{
name|os_memcpy
argument_list|(
name|lnkid
operator|->
name|init_sta
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|lnkid
operator|->
name|resp_sta
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|lnkid
operator|->
name|init_sta
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|lnkid
operator|->
name|resp_sta
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_send_teardown
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u16
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|wpa_tdls_ftie
modifier|*
name|ftie
decl_stmt|;
name|struct
name|wpa_tdls_lnkid
name|lnkid
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|u8
modifier|*
name|rbuf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|int
name|ielen
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|tdls_disabled
operator|||
operator|!
name|sm
operator|->
name|tdls_supported
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Find the node and free from the list */
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No matching entry found for "
literal|"Teardown "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Cancel active channel switch before teardown */
if|if
condition|(
name|peer
operator|->
name|chan_switch_enabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: First returning link with "
name|MACSTR
literal|" to base channel"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_sm_tdls_disable_channel_switch
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
expr_stmt|;
block|}
name|dialog_token
operator|=
name|peer
operator|->
name|dtoken
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TDLS Teardown for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|ielen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
operator|&&
name|peer
operator|->
name|tpk_set
operator|&&
name|peer
operator|->
name|tpk_success
condition|)
block|{
comment|/* To add FTIE for Teardown request and compute MIC */
name|ielen
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|ftie
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_LONG_FRAME
condition|)
name|ielen
operator|+=
literal|170
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
block|}
name|rbuf
operator|=
name|os_zalloc
argument_list|(
name|ielen
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rbuf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|rbuf
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
operator|||
operator|!
name|peer
operator|->
name|tpk_set
operator|||
operator|!
name|peer
operator|->
name|tpk_success
condition|)
goto|goto
name|skip_ies
goto|;
name|ftie
operator|=
operator|(
expr|struct
name|wpa_tdls_ftie
operator|*
operator|)
name|pos
expr_stmt|;
name|ftie
operator|->
name|ie_type
operator|=
name|WLAN_EID_FAST_BSS_TRANSITION
expr_stmt|;
comment|/* Using the recent nonce which should be for CONFIRM frame */
name|os_memcpy
argument_list|(
name|ftie
operator|->
name|Anonce
argument_list|,
name|peer
operator|->
name|rnonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ftie
operator|->
name|Snonce
argument_list|,
name|peer
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|ftie
operator|->
name|ie_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_ftie
argument_list|)
operator|-
literal|2
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|ftie
operator|+
literal|1
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_LONG_FRAME
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - add extra subelem to "
literal|"FTIE"
argument_list|)
expr_stmt|;
name|ftie
operator|->
name|ie_len
operator|+=
literal|170
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|255
expr_stmt|;
comment|/* FTIE subelem */
operator|*
name|pos
operator|++
operator|=
literal|168
expr_stmt|;
comment|/* FTIE subelem length */
name|pos
operator|+=
literal|168
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: FTIE for TDLS Teardown handshake"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ftie
argument_list|,
name|pos
operator|-
operator|(
name|u8
operator|*
operator|)
name|ftie
argument_list|)
expr_stmt|;
comment|/* compute MIC before sending */
name|wpa_tdls_linkid
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
operator|&
name|lnkid
argument_list|)
expr_stmt|;
name|wpa_tdls_key_mic_teardown
argument_list|(
name|peer
operator|->
name|tpk
operator|.
name|kck
argument_list|,
literal|4
argument_list|,
name|reason_code
argument_list|,
name|dialog_token
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|lnkid
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ftie
argument_list|,
name|ftie
operator|->
name|mic
argument_list|)
expr_stmt|;
name|skip_ies
label|:
comment|/* TODO: register for a Timeout handler, if Teardown is not received at 	 * the other end, then try again another time */
comment|/* request driver to send Teardown using this FTIE */
name|wpa_tdls_tpk_send
argument_list|(
name|sm
argument_list|,
name|addr
argument_list|,
name|WLAN_TDLS_TEARDOWN
argument_list|,
literal|0
argument_list|,
name|reason_code
argument_list|,
literal|0
argument_list|,
name|peer
operator|->
name|initiator
argument_list|,
name|rbuf
argument_list|,
name|pos
operator|-
name|rbuf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rbuf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_tdls_teardown_link
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u16
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|tdls_disabled
operator|||
operator|!
name|sm
operator|->
name|tdls_supported
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Could not find peer "
name|MACSTR
literal|" for link Teardown"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|peer
operator|->
name|tpk_success
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Peer "
name|MACSTR
literal|" not connected - cannot Teardown link"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|wpa_tdls_do_teardown
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|reason_code
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_tdls_disable_peer_link
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
name|wpa_sm_tdls_oper
argument_list|(
name|sm
argument_list|,
name|TDLS_DISABLE_LINK
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
expr_stmt|;
name|wpa_tdls_peer_free
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_tdls_disable_unreachable_link
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|peer
operator|||
operator|!
name|peer
operator|->
name|tpk_success
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Peer "
name|MACSTR
literal|" not connected - cannot teardown unreachable link"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_tdls_is_external_setup
argument_list|(
name|sm
argument_list|)
condition|)
block|{
comment|/* 		 * Get us on the base channel, disable the link, send a 		 * teardown packet through the AP, and then reset link data. 		 */
if|if
condition|(
name|peer
operator|->
name|chan_switch_enabled
condition|)
name|wpa_sm_tdls_disable_channel_switch
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
expr_stmt|;
name|wpa_sm_tdls_oper
argument_list|(
name|sm
argument_list|,
name|TDLS_DISABLE_LINK
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|wpa_tdls_send_teardown
argument_list|(
name|sm
argument_list|,
name|addr
argument_list|,
name|WLAN_REASON_TDLS_TEARDOWN_UNREACHABLE
argument_list|)
expr_stmt|;
name|wpa_tdls_peer_free
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_tdls_disable_peer_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|wpa_tdls_get_link_status
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|tdls_disabled
operator|||
operator|!
name|sm
operator|->
name|tdls_supported
condition|)
return|return
literal|"disabled"
return|;
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
return|return
literal|"peer does not exist"
return|;
if|if
condition|(
operator|!
name|peer
operator|->
name|tpk_success
condition|)
return|return
literal|"peer not connected"
return|;
return|return
literal|"connected"
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_recv_teardown
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_tdls_ftie
modifier|*
name|ftie
decl_stmt|;
name|struct
name|wpa_tdls_lnkid
modifier|*
name|lnkid
decl_stmt|;
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
name|u16
name|reason_code
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|int
name|ielen
decl_stmt|;
comment|/* Find the node and free from the list */
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No matching entry found for "
literal|"Teardown "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pos
operator|=
name|buf
expr_stmt|;
name|pos
operator|+=
literal|1
comment|/* pkt_type */
operator|+
literal|1
comment|/* Category */
operator|+
literal|1
comment|/* Action */
expr_stmt|;
name|reason_code
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TDLS Teardown Request from "
name|MACSTR
literal|" (reason code %u)"
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|ielen
operator|=
name|len
operator|-
operator|(
name|pos
operator|-
name|buf
operator|)
expr_stmt|;
comment|/* start of IE in buf */
comment|/* 	 * Don't reject the message if failing to parse IEs. The IEs we need are 	 * explicitly checked below. Some APs may add arbitrary padding to the 	 * end of short TDLS frames and that would look like invalid IEs. 	 */
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
name|pos
argument_list|,
name|ielen
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Failed to parse IEs in Teardown - ignore as an interop workaround"
argument_list|)
expr_stmt|;
if|if
condition|(
name|kde
operator|.
name|lnkid
operator|==
name|NULL
operator|||
name|kde
operator|.
name|lnkid_len
operator|<
literal|3
operator|*
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No Link Identifier IE in TDLS "
literal|"Teardown"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|lnkid
operator|=
operator|(
expr|struct
name|wpa_tdls_lnkid
operator|*
operator|)
name|kde
operator|.
name|lnkid
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
operator|||
operator|!
name|peer
operator|->
name|tpk_set
operator|||
operator|!
name|peer
operator|->
name|tpk_success
condition|)
goto|goto
name|skip_ftie
goto|;
if|if
condition|(
name|kde
operator|.
name|ftie
operator|==
name|NULL
operator|||
name|kde
operator|.
name|ftie_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ftie
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No FTIE in TDLS Teardown"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ftie
operator|=
operator|(
expr|struct
name|wpa_tdls_ftie
operator|*
operator|)
name|kde
operator|.
name|ftie
expr_stmt|;
comment|/* Process MIC check to see if TDLS Teardown is right */
if|if
condition|(
name|wpa_supplicant_verify_tdls_mic_teardown
argument_list|(
literal|4
argument_list|,
name|reason_code
argument_list|,
name|peer
operator|->
name|dtoken
argument_list|,
name|peer
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|lnkid
argument_list|,
name|ftie
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: MIC failure for TDLS "
literal|"Teardown Request from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|skip_ftie
label|:
comment|/* 	 * Request the driver to disable the direct link and clear associated 	 * keys. 	 */
name|wpa_tdls_disable_peer_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_tdls_send_error - To send suitable TDLS status response with  *	appropriate status code mentioning reason for error/failure.  * @dst 	- MAC addr of Peer station  * @tdls_action - TDLS frame type for which error code is sent  * @initiator   - was this end the initiator of the connection  * @status 	- status code mentioning reason  */
end_comment

begin_function
specifier|static
name|int
name|wpa_tdls_send_error
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|tdls_action
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|int
name|initiator
parameter_list|,
name|u16
name|status
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Sending error to "
name|MACSTR
literal|" (action=%u status=%u)"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
name|tdls_action
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return
name|wpa_tdls_tpk_send
argument_list|(
name|sm
argument_list|,
name|dst
argument_list|,
name|tdls_action
argument_list|,
name|dialog_token
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
name|initiator
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_tdls_peer
modifier|*
name|wpa_tdls_add_peer
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
modifier|*
name|existing
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
if|if
condition|(
name|existing
condition|)
operator|*
name|existing
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|existing
condition|)
operator|*
name|existing
operator|=
literal|1
expr_stmt|;
return|return
name|peer
return|;
comment|/* re-use existing entry */
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Creating peer entry for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|peer
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|peer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|peer
operator|->
name|next
operator|=
name|sm
operator|->
name|tdls
expr_stmt|;
name|sm
operator|->
name|tdls
operator|=
name|peer
expr_stmt|;
return|return
name|peer
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_send_tpk_m1
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
name|size_t
name|buf_len
decl_stmt|;
name|struct
name|wpa_tdls_timeoutie
name|timeoutie
decl_stmt|;
name|u16
name|rsn_capab
decl_stmt|;
name|struct
name|wpa_tdls_ftie
modifier|*
name|ftie
decl_stmt|;
name|u8
modifier|*
name|rbuf
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|count_pos
decl_stmt|;
name|u16
name|count
decl_stmt|;
name|struct
name|rsn_ie_hdr
modifier|*
name|hdr
decl_stmt|;
name|int
name|status
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: No security used on the link"
argument_list|)
expr_stmt|;
name|peer
operator|->
name|rsnie_i_len
operator|=
literal|0
expr_stmt|;
goto|goto
name|skip_rsnie
goto|;
block|}
comment|/* 	 * TPK Handshake Message 1: 	 * FTIE: ANonce=0, SNonce=initiator nonce MIC=0, DataKDs=(RSNIE_I, 	 * Timeout Interval IE)) 	 */
comment|/* Filling RSN IE */
name|hdr
operator|=
operator|(
expr|struct
name|rsn_ie_hdr
operator|*
operator|)
name|peer
operator|->
name|rsnie_i
expr_stmt|;
name|hdr
operator|->
name|elem_id
operator|=
name|WLAN_EID_RSN
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|hdr
operator|->
name|version
argument_list|,
name|RSN_VERSION
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_NO_GROUP_ADDRESSED
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|count_pos
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
comment|/* 	 * AES-CCMP is the default Encryption preferred for TDLS, so 	 * RSN IE is filled only with CCMP CIPHER 	 * Note: TKIP is not used to encrypt TDLS link. 	 * 	 * Regardless of the cipher used on the AP connection, select CCMP 	 * here. 	 */
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_CCMP
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|count_pos
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_AUTH_KEY_MGMT_TPK_HANDSHAKE
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|rsn_capab
operator|=
name|WPA_CAPABILITY_PEERKEY_ENABLED
expr_stmt|;
name|rsn_capab
operator||=
name|RSN_NUM_REPLAY_COUNTERS_16
operator|<<
literal|2
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_ALT_RSN_IE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Use alternative RSN IE for "
literal|"testing"
argument_list|)
expr_stmt|;
name|rsn_capab
operator|=
name|WPA_CAPABILITY_PEERKEY_ENABLED
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
name|rsn_capab
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_ALT_RSN_IE
condition|)
block|{
comment|/* Number of PMKIDs */
operator|*
name|pos
operator|++
operator|=
literal|0x00
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|0x00
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|hdr
operator|->
name|len
operator|=
operator|(
name|pos
operator|-
name|peer
operator|->
name|rsnie_i
operator|)
operator|-
literal|2
expr_stmt|;
name|peer
operator|->
name|rsnie_i_len
operator|=
name|pos
operator|-
name|peer
operator|->
name|rsnie_i
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: RSN IE for TPK handshake"
argument_list|,
name|peer
operator|->
name|rsnie_i
argument_list|,
name|peer
operator|->
name|rsnie_i_len
argument_list|)
expr_stmt|;
name|skip_rsnie
label|:
name|buf_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
name|buf_len
operator|+=
name|peer
operator|->
name|rsnie_i_len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_ftie
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_timeoutie
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
operator|&&
operator|(
name|tdls_testing
operator|&
name|TDLS_TESTING_LONG_FRAME
operator|)
condition|)
name|buf_len
operator|+=
literal|170
expr_stmt|;
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_DIFF_BSSID
condition|)
name|buf_len
operator|+=
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_lnkid
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|rbuf
operator|=
name|os_zalloc
argument_list|(
name|buf_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rbuf
operator|==
name|NULL
condition|)
block|{
name|wpa_tdls_peer_free
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|rbuf
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
goto|goto
name|skip_ies
goto|;
comment|/* Initiator RSN IE */
name|pos
operator|=
name|wpa_add_ie
argument_list|(
name|pos
argument_list|,
name|peer
operator|->
name|rsnie_i
argument_list|,
name|peer
operator|->
name|rsnie_i_len
argument_list|)
expr_stmt|;
name|ftie
operator|=
operator|(
expr|struct
name|wpa_tdls_ftie
operator|*
operator|)
name|pos
expr_stmt|;
name|ftie
operator|->
name|ie_type
operator|=
name|WLAN_EID_FAST_BSS_TRANSITION
expr_stmt|;
name|ftie
operator|->
name|ie_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_ftie
argument_list|)
operator|-
literal|2
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|peer
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|msg_ctx
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"TDLS: Failed to get random data for initiator Nonce"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rbuf
argument_list|)
expr_stmt|;
name|wpa_tdls_peer_free
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|->
name|tk_set
operator|=
literal|0
expr_stmt|;
comment|/* A new nonce results in a new TK */
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Initiator Nonce for TPK handshake"
argument_list|,
name|peer
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ftie
operator|->
name|Snonce
argument_list|,
name|peer
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: FTIE for TPK Handshake M1"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ftie
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_ftie
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|ftie
operator|+
literal|1
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_LONG_FRAME
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - add extra subelem to "
literal|"FTIE"
argument_list|)
expr_stmt|;
name|ftie
operator|->
name|ie_len
operator|+=
literal|170
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|255
expr_stmt|;
comment|/* FTIE subelem */
operator|*
name|pos
operator|++
operator|=
literal|168
expr_stmt|;
comment|/* FTIE subelem length */
name|pos
operator|+=
literal|168
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
comment|/* Lifetime */
name|peer
operator|->
name|lifetime
operator|=
name|TPK_LIFETIME
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_SHORT_LIFETIME
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - use short TPK "
literal|"lifetime"
argument_list|)
expr_stmt|;
name|peer
operator|->
name|lifetime
operator|=
literal|301
expr_stmt|;
block|}
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_LONG_LIFETIME
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - use long TPK "
literal|"lifetime"
argument_list|)
expr_stmt|;
name|peer
operator|->
name|lifetime
operator|=
literal|0xffffffff
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|pos
operator|=
name|wpa_add_tdls_timeoutie
argument_list|(
name|pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|timeoutie
argument_list|,
sizeof|sizeof
argument_list|(
name|timeoutie
argument_list|)
argument_list|,
name|peer
operator|->
name|lifetime
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK lifetime %u seconds"
argument_list|,
name|peer
operator|->
name|lifetime
argument_list|)
expr_stmt|;
name|skip_ies
label|:
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_DIFF_BSSID
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - use incorrect BSSID in "
literal|"Link Identifier"
argument_list|)
expr_stmt|;
name|struct
name|wpa_tdls_lnkid
modifier|*
name|l
init|=
operator|(
expr|struct
name|wpa_tdls_lnkid
operator|*
operator|)
name|pos
decl_stmt|;
name|wpa_tdls_linkid
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|l
operator|->
name|bssid
index|[
literal|5
index|]
operator|^=
literal|0x01
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|l
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Sending TDLS Setup Request / TPK "
literal|"Handshake Message 1 (peer "
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|status
operator|=
name|wpa_tdls_tpk_send
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|WLAN_TDLS_SETUP_REQUEST
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|peer
operator|->
name|initiator
argument_list|,
name|rbuf
argument_list|,
name|pos
operator|-
name|rbuf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rbuf
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_send_tpk_m2
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|src_addr
parameter_list|,
name|u8
name|dtoken
parameter_list|,
name|struct
name|wpa_tdls_lnkid
modifier|*
name|lnkid
parameter_list|,
specifier|const
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
name|u8
modifier|*
name|rbuf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|u32
name|lifetime
decl_stmt|;
name|struct
name|wpa_tdls_timeoutie
name|timeoutie
decl_stmt|;
name|struct
name|wpa_tdls_ftie
modifier|*
name|ftie
decl_stmt|;
name|int
name|status
decl_stmt|;
name|buf_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
block|{
comment|/* Peer RSN IE, FTIE(Initiator Nonce, Responder Nonce), 		 * Lifetime */
name|buf_len
operator|+=
name|peer
operator|->
name|rsnie_i_len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_ftie
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_timeoutie
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_LONG_FRAME
condition|)
name|buf_len
operator|+=
literal|170
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
block|}
name|rbuf
operator|=
name|os_zalloc
argument_list|(
name|buf_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rbuf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|rbuf
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
goto|goto
name|skip_ies
goto|;
comment|/* Peer RSN IE */
name|pos
operator|=
name|wpa_add_ie
argument_list|(
name|pos
argument_list|,
name|peer
operator|->
name|rsnie_p
argument_list|,
name|peer
operator|->
name|rsnie_p_len
argument_list|)
expr_stmt|;
name|ftie
operator|=
operator|(
expr|struct
name|wpa_tdls_ftie
operator|*
operator|)
name|pos
expr_stmt|;
name|ftie
operator|->
name|ie_type
operator|=
name|WLAN_EID_FAST_BSS_TRANSITION
expr_stmt|;
comment|/* TODO: ftie->mic_control to set 2-RESPONSE */
name|os_memcpy
argument_list|(
name|ftie
operator|->
name|Anonce
argument_list|,
name|peer
operator|->
name|rnonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ftie
operator|->
name|Snonce
argument_list|,
name|peer
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|ftie
operator|->
name|ie_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_ftie
argument_list|)
operator|-
literal|2
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: FTIE for TPK M2"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ftie
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ftie
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|ftie
operator|+
literal|1
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_LONG_FRAME
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - add extra subelem to "
literal|"FTIE"
argument_list|)
expr_stmt|;
name|ftie
operator|->
name|ie_len
operator|+=
literal|170
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|255
expr_stmt|;
comment|/* FTIE subelem */
operator|*
name|pos
operator|++
operator|=
literal|168
expr_stmt|;
comment|/* FTIE subelem length */
name|pos
operator|+=
literal|168
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
comment|/* Lifetime */
name|lifetime
operator|=
name|peer
operator|->
name|lifetime
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_WRONG_LIFETIME_RESP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - use wrong TPK "
literal|"lifetime in response"
argument_list|)
expr_stmt|;
name|lifetime
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|pos
operator|=
name|wpa_add_tdls_timeoutie
argument_list|(
name|pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|timeoutie
argument_list|,
sizeof|sizeof
argument_list|(
name|timeoutie
argument_list|)
argument_list|,
name|lifetime
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK lifetime %u seconds from initiator"
argument_list|,
name|lifetime
argument_list|)
expr_stmt|;
comment|/* compute MIC before sending */
name|wpa_tdls_ftie_mic
argument_list|(
name|peer
operator|->
name|tpk
operator|.
name|kck
argument_list|,
literal|2
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|lnkid
argument_list|,
name|peer
operator|->
name|rsnie_p
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|timeoutie
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ftie
argument_list|,
name|ftie
operator|->
name|mic
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_WRONG_MIC
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - use wrong MIC"
argument_list|)
expr_stmt|;
name|ftie
operator|->
name|mic
index|[
literal|0
index|]
operator|^=
literal|0x01
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|skip_ies
label|:
name|status
operator|=
name|wpa_tdls_tpk_send
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|WLAN_TDLS_SETUP_RESPONSE
argument_list|,
name|dtoken
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|peer
operator|->
name|initiator
argument_list|,
name|rbuf
argument_list|,
name|pos
operator|-
name|rbuf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rbuf
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_send_tpk_m3
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|unsigned
name|char
modifier|*
name|src_addr
parameter_list|,
name|u8
name|dtoken
parameter_list|,
name|struct
name|wpa_tdls_lnkid
modifier|*
name|lnkid
parameter_list|,
specifier|const
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
name|u8
modifier|*
name|rbuf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|struct
name|wpa_tdls_ftie
modifier|*
name|ftie
decl_stmt|;
name|struct
name|wpa_tdls_timeoutie
name|timeoutie
decl_stmt|;
name|u32
name|lifetime
decl_stmt|;
name|int
name|status
decl_stmt|;
name|u32
name|peer_capab
init|=
literal|0
decl_stmt|;
name|buf_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
block|{
comment|/* Peer RSN IE, FTIE(Initiator Nonce, Responder Nonce), 		 * Lifetime */
name|buf_len
operator|+=
name|peer
operator|->
name|rsnie_i_len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_ftie
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_timeoutie
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_LONG_FRAME
condition|)
name|buf_len
operator|+=
literal|170
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
block|}
name|rbuf
operator|=
name|os_zalloc
argument_list|(
name|buf_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rbuf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|rbuf
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
goto|goto
name|skip_ies
goto|;
comment|/* Peer RSN IE */
name|pos
operator|=
name|wpa_add_ie
argument_list|(
name|pos
argument_list|,
name|peer
operator|->
name|rsnie_p
argument_list|,
name|peer
operator|->
name|rsnie_p_len
argument_list|)
expr_stmt|;
name|ftie
operator|=
operator|(
expr|struct
name|wpa_tdls_ftie
operator|*
operator|)
name|pos
expr_stmt|;
name|ftie
operator|->
name|ie_type
operator|=
name|WLAN_EID_FAST_BSS_TRANSITION
expr_stmt|;
comment|/*TODO: ftie->mic_control to set 3-CONFIRM */
name|os_memcpy
argument_list|(
name|ftie
operator|->
name|Anonce
argument_list|,
name|peer
operator|->
name|rnonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ftie
operator|->
name|Snonce
argument_list|,
name|peer
operator|->
name|inonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|ftie
operator|->
name|ie_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_ftie
argument_list|)
operator|-
literal|2
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|ftie
operator|+
literal|1
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_LONG_FRAME
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - add extra subelem to "
literal|"FTIE"
argument_list|)
expr_stmt|;
name|ftie
operator|->
name|ie_len
operator|+=
literal|170
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|255
expr_stmt|;
comment|/* FTIE subelem */
operator|*
name|pos
operator|++
operator|=
literal|168
expr_stmt|;
comment|/* FTIE subelem length */
name|pos
operator|+=
literal|168
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
comment|/* Lifetime */
name|lifetime
operator|=
name|peer
operator|->
name|lifetime
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_WRONG_LIFETIME_CONF
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - use wrong TPK "
literal|"lifetime in confirm"
argument_list|)
expr_stmt|;
name|lifetime
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|pos
operator|=
name|wpa_add_tdls_timeoutie
argument_list|(
name|pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|timeoutie
argument_list|,
sizeof|sizeof
argument_list|(
name|timeoutie
argument_list|)
argument_list|,
name|lifetime
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK lifetime %u seconds"
argument_list|,
name|lifetime
argument_list|)
expr_stmt|;
comment|/* compute MIC before sending */
name|wpa_tdls_ftie_mic
argument_list|(
name|peer
operator|->
name|tpk
operator|.
name|kck
argument_list|,
literal|3
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|lnkid
argument_list|,
name|peer
operator|->
name|rsnie_p
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|timeoutie
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ftie
argument_list|,
name|ftie
operator|->
name|mic
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_WRONG_MIC
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - use wrong MIC"
argument_list|)
expr_stmt|;
name|ftie
operator|->
name|mic
index|[
literal|0
index|]
operator|^=
literal|0x01
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|skip_ies
label|:
if|if
condition|(
name|peer
operator|->
name|vht_capabilities
condition|)
name|peer_capab
operator||=
name|TDLS_PEER_VHT
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|ht_capabilities
condition|)
name|peer_capab
operator||=
name|TDLS_PEER_HT
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|wmm_capable
condition|)
name|peer_capab
operator||=
name|TDLS_PEER_WMM
expr_stmt|;
name|status
operator|=
name|wpa_tdls_tpk_send
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|WLAN_TDLS_SETUP_CONFIRM
argument_list|,
name|dtoken
argument_list|,
literal|0
argument_list|,
name|peer_capab
argument_list|,
name|peer
operator|->
name|initiator
argument_list|,
name|rbuf
argument_list|,
name|pos
operator|-
name|rbuf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rbuf
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_send_discovery_response
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|,
name|u8
name|dialog_token
parameter_list|)
block|{
name|size_t
name|buf_len
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_tdls_timeoutie
name|timeoutie
decl_stmt|;
name|u16
name|rsn_capab
decl_stmt|;
name|u8
modifier|*
name|rbuf
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|count_pos
decl_stmt|;
name|u16
name|count
decl_stmt|;
name|struct
name|rsn_ie_hdr
modifier|*
name|hdr
decl_stmt|;
name|int
name|status
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Sending TDLS Discovery Response "
literal|"(peer "
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
goto|goto
name|skip_rsn_ies
goto|;
comment|/* Filling RSN IE */
name|hdr
operator|=
operator|(
expr|struct
name|rsn_ie_hdr
operator|*
operator|)
name|peer
operator|->
name|rsnie_i
expr_stmt|;
name|hdr
operator|->
name|elem_id
operator|=
name|WLAN_EID_RSN
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|hdr
operator|->
name|version
argument_list|,
name|RSN_VERSION
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_NO_GROUP_ADDRESSED
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|count_pos
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
comment|/* 	* AES-CCMP is the default encryption preferred for TDLS, so 	* RSN IE is filled only with CCMP cipher suite. 	* Note: TKIP is not used to encrypt TDLS link. 	* 	* Regardless of the cipher used on the AP connection, select CCMP 	* here. 	*/
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_CCMP
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|count_pos
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_AUTH_KEY_MGMT_TPK_HANDSHAKE
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|rsn_capab
operator|=
name|WPA_CAPABILITY_PEERKEY_ENABLED
expr_stmt|;
name|rsn_capab
operator||=
name|RSN_NUM_REPLAY_COUNTERS_16
operator|<<
literal|2
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
name|rsn_capab
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|hdr
operator|->
name|len
operator|=
operator|(
name|pos
operator|-
operator|(
name|u8
operator|*
operator|)
name|hdr
operator|)
operator|-
literal|2
expr_stmt|;
name|peer
operator|->
name|rsnie_i_len
operator|=
name|pos
operator|-
name|peer
operator|->
name|rsnie_i
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: RSN IE for Discovery Response"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|hdr
argument_list|,
name|hdr
operator|->
name|len
operator|+
literal|2
argument_list|)
expr_stmt|;
name|skip_rsn_ies
label|:
name|buf_len
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
block|{
comment|/* Peer RSN IE, Lifetime */
name|buf_len
operator|+=
name|peer
operator|->
name|rsnie_i_len
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_timeoutie
argument_list|)
expr_stmt|;
block|}
name|rbuf
operator|=
name|os_zalloc
argument_list|(
name|buf_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|rbuf
operator|==
name|NULL
condition|)
block|{
name|wpa_tdls_peer_free
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|rbuf
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
goto|goto
name|skip_ies
goto|;
comment|/* Initiator RSN IE */
name|pos
operator|=
name|wpa_add_ie
argument_list|(
name|pos
argument_list|,
name|peer
operator|->
name|rsnie_i
argument_list|,
name|peer
operator|->
name|rsnie_i_len
argument_list|)
expr_stmt|;
comment|/* Lifetime */
name|peer
operator|->
name|lifetime
operator|=
name|TPK_LIFETIME
expr_stmt|;
name|pos
operator|=
name|wpa_add_tdls_timeoutie
argument_list|(
name|pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|timeoutie
argument_list|,
sizeof|sizeof
argument_list|(
name|timeoutie
argument_list|)
argument_list|,
name|peer
operator|->
name|lifetime
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK lifetime %u seconds"
argument_list|,
name|peer
operator|->
name|lifetime
argument_list|)
expr_stmt|;
name|skip_ies
label|:
name|status
operator|=
name|wpa_tdls_tpk_send
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|WLAN_TDLS_DISCOVERY_RESPONSE
argument_list|,
name|dialog_token
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|rbuf
argument_list|,
name|pos
operator|-
name|rbuf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rbuf
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_process_discovery_request
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
specifier|const
name|struct
name|wpa_tdls_lnkid
modifier|*
name|lnkid
decl_stmt|;
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
name|size_t
name|min_req_len
init|=
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_frame
argument_list|)
operator|+
literal|1
comment|/* dialog token */
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_lnkid
argument_list|)
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Discovery Request from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|min_req_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS Discovery Request is too short: "
literal|"%d"
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dialog_token
operator|=
name|buf
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_frame
argument_list|)
index|]
expr_stmt|;
comment|/* 	 * Some APs will tack on a weird IE to the end of a TDLS 	 * discovery request packet. This needn't fail the response, 	 * since the required IE are verified separately. 	 */
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_frame
argument_list|)
operator|+
literal|1
argument_list|,
name|len
operator|-
operator|(
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_frame
argument_list|)
operator|+
literal|1
operator|)
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Failed to parse IEs in Discovery Request - ignore as an interop workaround"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|kde
operator|.
name|lnkid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Link ID not found in Discovery "
literal|"Request"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|lnkid
operator|=
operator|(
specifier|const
expr|struct
name|wpa_tdls_lnkid
operator|*
operator|)
name|kde
operator|.
name|lnkid
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sm
operator|->
name|bssid
argument_list|,
name|lnkid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Discovery Request from different "
literal|" BSS "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|lnkid
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|=
name|wpa_tdls_add_peer
argument_list|(
name|sm
argument_list|,
name|addr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpa_tdls_send_discovery_response
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|dialog_token
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpa_tdls_send_discovery_request
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|sm
operator|->
name|tdls_disabled
operator|||
operator|!
name|sm
operator|->
name|tdls_supported
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Sending Discovery Request to peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|wpa_tdls_tpk_send
argument_list|(
name|sm
argument_list|,
name|addr
argument_list|,
name|WLAN_TDLS_DISCOVERY_REQUEST
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|copy_supp_rates
parameter_list|(
specifier|const
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
if|if
condition|(
operator|!
name|kde
operator|->
name|supp_rates
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: No supported rates received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|->
name|supp_rates_len
operator|=
name|merge_byte_arrays
argument_list|(
name|peer
operator|->
name|supp_rates
argument_list|,
sizeof|sizeof
argument_list|(
name|peer
operator|->
name|supp_rates
argument_list|)
argument_list|,
name|kde
operator|->
name|supp_rates
operator|+
literal|2
argument_list|,
name|kde
operator|->
name|supp_rates_len
operator|-
literal|2
argument_list|,
name|kde
operator|->
name|ext_supp_rates
condition|?
name|kde
operator|->
name|ext_supp_rates
operator|+
literal|2
else|:
name|NULL
argument_list|,
name|kde
operator|->
name|ext_supp_rates_len
operator|-
literal|2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|copy_peer_ht_capab
parameter_list|(
specifier|const
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
if|if
condition|(
operator|!
name|kde
operator|->
name|ht_capabilities
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: No supported ht capabilities "
literal|"received"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|peer
operator|->
name|ht_capabilities
condition|)
block|{
name|peer
operator|->
name|ht_capabilities
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_ht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|ht_capabilities
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|peer
operator|->
name|ht_capabilities
argument_list|,
name|kde
operator|->
name|ht_capabilities
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_ht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Peer HT capabilities"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|peer
operator|->
name|ht_capabilities
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_ht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|copy_peer_vht_capab
parameter_list|(
specifier|const
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
if|if
condition|(
operator|!
name|kde
operator|->
name|vht_capabilities
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: No supported vht capabilities "
literal|"received"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|peer
operator|->
name|vht_capabilities
condition|)
block|{
name|peer
operator|->
name|vht_capabilities
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_vht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|vht_capabilities
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|peer
operator|->
name|vht_capabilities
argument_list|,
name|kde
operator|->
name|vht_capabilities
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_vht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Peer VHT capabilities"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|peer
operator|->
name|vht_capabilities
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_vht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|copy_peer_ext_capab
parameter_list|(
specifier|const
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
if|if
condition|(
operator|!
name|kde
operator|->
name|ext_capab
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: No extended capabilities "
literal|"received"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|peer
operator|->
name|ext_capab
operator|||
name|peer
operator|->
name|ext_capab_len
operator|<
name|kde
operator|->
name|ext_capab_len
operator|-
literal|2
condition|)
block|{
comment|/* Need to allocate buffer to fit the new information */
name|os_free
argument_list|(
name|peer
operator|->
name|ext_capab
argument_list|)
expr_stmt|;
name|peer
operator|->
name|ext_capab
operator|=
name|os_zalloc
argument_list|(
name|kde
operator|->
name|ext_capab_len
operator|-
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|ext_capab
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|->
name|ext_capab_len
operator|=
name|kde
operator|->
name|ext_capab_len
operator|-
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|peer
operator|->
name|ext_capab
argument_list|,
name|kde
operator|->
name|ext_capab
operator|+
literal|2
argument_list|,
name|peer
operator|->
name|ext_capab_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|copy_peer_wmm_capab
parameter_list|(
specifier|const
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|wmm_information_element
modifier|*
name|wmm
decl_stmt|;
if|if
condition|(
operator|!
name|kde
operator|->
name|wmm
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: No supported WMM capabilities received"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|kde
operator|->
name|wmm_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|wmm_information_element
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Invalid supported WMM capabilities received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wmm
operator|=
operator|(
expr|struct
name|wmm_information_element
operator|*
operator|)
name|kde
operator|->
name|wmm
expr_stmt|;
name|peer
operator|->
name|qos_info
operator|=
name|wmm
operator|->
name|qos_info
expr_stmt|;
name|peer
operator|->
name|wmm_capable
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Peer WMM QOS Info 0x%x"
argument_list|,
name|peer
operator|->
name|qos_info
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|copy_peer_supp_channels
parameter_list|(
specifier|const
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
if|if
condition|(
operator|!
name|kde
operator|->
name|supp_channels
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: No supported channels received"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|peer
operator|->
name|supp_channels
operator|||
name|peer
operator|->
name|supp_channels_len
operator|<
name|kde
operator|->
name|supp_channels_len
condition|)
block|{
name|os_free
argument_list|(
name|peer
operator|->
name|supp_channels
argument_list|)
expr_stmt|;
name|peer
operator|->
name|supp_channels
operator|=
name|os_zalloc
argument_list|(
name|kde
operator|->
name|supp_channels_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|supp_channels
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|->
name|supp_channels_len
operator|=
name|kde
operator|->
name|supp_channels_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|peer
operator|->
name|supp_channels
argument_list|,
name|kde
operator|->
name|supp_channels
argument_list|,
name|peer
operator|->
name|supp_channels_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Peer Supported Channels"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|peer
operator|->
name|supp_channels
argument_list|,
name|peer
operator|->
name|supp_channels_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|copy_peer_supp_oper_classes
parameter_list|(
specifier|const
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
if|if
condition|(
operator|!
name|kde
operator|->
name|supp_oper_classes
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: No supported operating classes received"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|peer
operator|->
name|supp_oper_classes
operator|||
name|peer
operator|->
name|supp_oper_classes_len
operator|<
name|kde
operator|->
name|supp_oper_classes_len
condition|)
block|{
name|os_free
argument_list|(
name|peer
operator|->
name|supp_oper_classes
argument_list|)
expr_stmt|;
name|peer
operator|->
name|supp_oper_classes
operator|=
name|os_zalloc
argument_list|(
name|kde
operator|->
name|supp_oper_classes_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|supp_oper_classes
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|->
name|supp_oper_classes_len
operator|=
name|kde
operator|->
name|supp_oper_classes_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|peer
operator|->
name|supp_oper_classes
argument_list|,
name|kde
operator|->
name|supp_oper_classes
argument_list|,
name|peer
operator|->
name|supp_oper_classes_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Peer Supported Operating Classes"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|peer
operator|->
name|supp_oper_classes
argument_list|,
name|peer
operator|->
name|supp_oper_classes_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_addset_peer
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|,
name|int
name|add
parameter_list|)
block|{
return|return
name|wpa_sm_tdls_peer_addset
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|add
argument_list|,
name|peer
operator|->
name|aid
argument_list|,
name|peer
operator|->
name|capability
argument_list|,
name|peer
operator|->
name|supp_rates
argument_list|,
name|peer
operator|->
name|supp_rates_len
argument_list|,
name|peer
operator|->
name|ht_capabilities
argument_list|,
name|peer
operator|->
name|vht_capabilities
argument_list|,
name|peer
operator|->
name|qos_info
argument_list|,
name|peer
operator|->
name|wmm_capable
argument_list|,
name|peer
operator|->
name|ext_capab
argument_list|,
name|peer
operator|->
name|ext_capab_len
argument_list|,
name|peer
operator|->
name|supp_channels
argument_list|,
name|peer
operator|->
name|supp_channels_len
argument_list|,
name|peer
operator|->
name|supp_oper_classes
argument_list|,
name|peer
operator|->
name|supp_oper_classes_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tdls_nonce_set
parameter_list|(
specifier|const
name|u8
modifier|*
name|nonce
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|WPA_NONCE_LEN
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|nonce
index|[
name|i
index|]
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_process_tpk_m1
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|cipher
decl_stmt|;
specifier|const
name|u8
modifier|*
name|cpos
decl_stmt|;
name|struct
name|wpa_tdls_ftie
modifier|*
name|ftie
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_tdls_timeoutie
modifier|*
name|timeoutie
decl_stmt|;
name|struct
name|wpa_tdls_lnkid
modifier|*
name|lnkid
decl_stmt|;
name|u32
name|lifetime
init|=
literal|0
decl_stmt|;
if|#
directive|if
literal|0
block|struct rsn_ie_hdr *hdr; 	u8 *pos; 	u16 rsn_capab; 	u16 rsn_ver;
endif|#
directive|endif
name|u8
name|dtoken
decl_stmt|;
name|u16
name|ielen
decl_stmt|;
name|u16
name|status
init|=
name|WLAN_STATUS_UNSPECIFIED_FAILURE
decl_stmt|;
name|int
name|tdls_prohibited
init|=
name|sm
operator|->
name|tdls_prohibited
decl_stmt|;
name|int
name|existing_peer
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|3
operator|+
literal|3
condition|)
return|return
operator|-
literal|1
return|;
name|cpos
operator|=
name|buf
expr_stmt|;
name|cpos
operator|+=
literal|1
comment|/* pkt_type */
operator|+
literal|1
comment|/* Category */
operator|+
literal|1
comment|/* Action */
expr_stmt|;
comment|/* driver had already verified the frame format */
name|dtoken
operator|=
operator|*
name|cpos
operator|++
expr_stmt|;
comment|/* dialog token */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Dialog Token in TPK M1 %d"
argument_list|,
name|dtoken
argument_list|)
expr_stmt|;
name|peer
operator|=
name|wpa_tdls_add_peer
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
operator|&
name|existing_peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
comment|/* If found, use existing entry instead of adding a new one; 	 * how to handle the case where both ends initiate at the 	 * same time? */
if|if
condition|(
name|existing_peer
condition|)
block|{
if|if
condition|(
name|peer
operator|->
name|tpk_success
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TDLS Setup Request while "
literal|"direct link is enabled - tear down the "
literal|"old link first"
argument_list|)
expr_stmt|;
name|wpa_sm_tdls_oper
argument_list|(
name|sm
argument_list|,
name|TDLS_DISABLE_LINK
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
expr_stmt|;
name|wpa_tdls_peer_clear
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|peer
operator|->
name|initiator
condition|)
block|{
comment|/* 			 * An entry is already present, so check if we already 			 * sent a TDLS Setup Request. If so, compare MAC 			 * addresses and let the STA with the lower MAC address 			 * continue as the initiator. The other negotiation is 			 * terminated. 			 */
if|if
condition|(
name|os_memcmp
argument_list|(
name|sm
operator|->
name|own_addr
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Discard request "
literal|"from peer with higher address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Accept request "
literal|"from peer with lower address "
name|MACSTR
literal|" (terminate previously "
literal|"initiated negotiation"
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_sm_tdls_oper
argument_list|(
name|sm
argument_list|,
name|TDLS_DISABLE_LINK
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
expr_stmt|;
name|wpa_tdls_peer_clear
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
block|}
block|}
comment|/* capability information */
name|peer
operator|->
name|capability
operator|=
name|WPA_GET_LE16
argument_list|(
name|cpos
argument_list|)
expr_stmt|;
name|cpos
operator|+=
literal|2
expr_stmt|;
name|ielen
operator|=
name|len
operator|-
operator|(
name|cpos
operator|-
name|buf
operator|)
expr_stmt|;
comment|/* start of IE in buf */
comment|/* 	 * Don't reject the message if failing to parse IEs. The IEs we need are 	 * explicitly checked below. Some APs may add arbitrary padding to the 	 * end of short TDLS frames and that would look like invalid IEs. 	 */
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
name|cpos
argument_list|,
name|ielen
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Failed to parse IEs in TPK M1 - ignore as an interop workaround"
argument_list|)
expr_stmt|;
if|if
condition|(
name|kde
operator|.
name|lnkid
operator|==
name|NULL
operator|||
name|kde
operator|.
name|lnkid_len
operator|<
literal|3
operator|*
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No valid Link Identifier IE in "
literal|"TPK M1"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Link ID Received from TPK M1"
argument_list|,
name|kde
operator|.
name|lnkid
argument_list|,
name|kde
operator|.
name|lnkid_len
argument_list|)
expr_stmt|;
name|lnkid
operator|=
operator|(
expr|struct
name|wpa_tdls_lnkid
operator|*
operator|)
name|kde
operator|.
name|lnkid
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sm
operator|->
name|bssid
argument_list|,
name|lnkid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: TPK M1 from diff BSS"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_REQUEST_DECLINED
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK M1 - TPK initiator "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|copy_supp_rates
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|copy_peer_ht_capab
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|copy_peer_vht_capab
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|copy_peer_ext_capab
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|copy_peer_supp_channels
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|copy_peer_supp_oper_classes
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
name|peer
operator|->
name|qos_info
operator|=
name|kde
operator|.
name|qosinfo
expr_stmt|;
comment|/* Overwrite with the qos_info obtained in WMM IE */
if|if
condition|(
name|copy_peer_wmm_capab
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
name|peer
operator|->
name|aid
operator|=
name|kde
operator|.
name|aid
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_CONCURRENT_INIT
condition|)
block|{
name|peer
operator|=
name|wpa_tdls_add_peer
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing concurrent initiation of "
literal|"TDLS setup - send own request"
argument_list|)
expr_stmt|;
name|peer
operator|->
name|initiator
operator|=
literal|1
expr_stmt|;
name|wpa_sm_tdls_peer_addset
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_tdls_send_tpk_m1
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|tdls_testing
operator|&
name|TDLS_TESTING_IGNORE_AP_PROHIBIT
operator|)
operator|&&
name|tdls_prohibited
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - ignore AP prohibition "
literal|"on TDLS"
argument_list|)
expr_stmt|;
name|tdls_prohibited
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
if|if
condition|(
name|tdls_prohibited
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: TDLS prohibited in this BSS"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_REQUEST_DECLINED
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
block|{
if|if
condition|(
name|kde
operator|.
name|rsn_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: RSN IE in TPK M1 while "
literal|"security is disabled"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_SECURITY_DISABLED
expr_stmt|;
goto|goto
name|error
goto|;
block|}
goto|goto
name|skip_rsn
goto|;
block|}
if|if
condition|(
name|kde
operator|.
name|ftie
operator|==
name|NULL
operator|||
name|kde
operator|.
name|ftie_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ftie
argument_list|)
operator|||
name|kde
operator|.
name|rsn_ie
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No FTIE or RSN IE in TPK M1"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_PARAMETERS
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|kde
operator|.
name|rsn_ie_len
operator|>
name|TDLS_MAX_IE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Too long Initiator RSN IE in "
literal|"TPK M1"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_RSNIE
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|wpa_parse_wpa_ie_rsn
argument_list|(
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Failed to parse RSN IE in TPK M1"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_RSNIE
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|cipher
operator|=
name|ie
operator|.
name|pairwise_cipher
expr_stmt|;
if|if
condition|(
name|cipher
operator|&
name|WPA_CIPHER_CCMP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Using CCMP for direct link"
argument_list|)
expr_stmt|;
name|cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No acceptable cipher in TPK M1"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_PAIRWISE_CIPHER_NOT_VALID
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|(
name|ie
operator|.
name|capabilities
operator|&
operator|(
name|WPA_CAPABILITY_NO_PAIRWISE
operator||
name|WPA_CAPABILITY_PEERKEY_ENABLED
operator|)
operator|)
operator|!=
name|WPA_CAPABILITY_PEERKEY_ENABLED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Invalid RSN Capabilities in "
literal|"TPK M1"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_RSN_IE_CAPAB
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* Lifetime */
if|if
condition|(
name|kde
operator|.
name|key_lifetime
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No Key Lifetime IE in TPK M1"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_UNACCEPTABLE_LIFETIME
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|timeoutie
operator|=
operator|(
expr|struct
name|wpa_tdls_timeoutie
operator|*
operator|)
name|kde
operator|.
name|key_lifetime
expr_stmt|;
name|lifetime
operator|=
name|WPA_GET_LE32
argument_list|(
name|timeoutie
operator|->
name|value
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK lifetime %u seconds"
argument_list|,
name|lifetime
argument_list|)
expr_stmt|;
if|if
condition|(
name|lifetime
operator|<
literal|300
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Too short TPK lifetime"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_UNACCEPTABLE_LIFETIME
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|skip_rsn
label|:
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_CONCURRENT_INIT
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|sm
operator|->
name|own_addr
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* 			 * The request frame from us is going to win, so do not 			 * replace information based on this request frame from 			 * the peer. 			 */
goto|goto
name|skip_rsn_check
goto|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|peer
operator|->
name|initiator
operator|=
literal|0
expr_stmt|;
comment|/* Need to check */
name|peer
operator|->
name|dtoken
operator|=
name|dtoken
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
block|{
name|peer
operator|->
name|rsnie_i_len
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|rsnie_p_len
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
goto|goto
name|skip_rsn_check
goto|;
block|}
name|ftie
operator|=
operator|(
expr|struct
name|wpa_tdls_ftie
operator|*
operator|)
name|kde
operator|.
name|ftie
expr_stmt|;
name|os_memcpy
argument_list|(
name|peer
operator|->
name|rsnie_i
argument_list|,
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
expr_stmt|;
name|peer
operator|->
name|rsnie_i_len
operator|=
name|kde
operator|.
name|rsn_ie_len
expr_stmt|;
name|peer
operator|->
name|cipher
operator|=
name|cipher
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|inonce
argument_list|,
name|ftie
operator|->
name|Snonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|!=
literal|0
operator|||
operator|!
name|tdls_nonce_set
argument_list|(
name|peer
operator|->
name|inonce
argument_list|)
condition|)
block|{
comment|/* 		 * There is no point in updating the RNonce for every obtained 		 * TPK M1 frame (e.g., retransmission due to timeout) with the 		 * same INonce (SNonce in FTIE). However, if the TPK M1 is 		 * retransmitted with a different INonce, update the RNonce 		 * since this is for a new TDLS session. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: New TPK M1 INonce - generate new RNonce"
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|peer
operator|->
name|inonce
argument_list|,
name|ftie
operator|->
name|Snonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|peer
operator|->
name|rnonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|sm
operator|->
name|ctx
operator|->
name|ctx
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"TDLS: Failed to get random data for responder nonce"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|peer
operator|->
name|tk_set
operator|=
literal|0
expr_stmt|;
comment|/* A new nonce results in a new TK */
block|}
if|#
directive|if
literal|0
comment|/* get version info from RSNIE received from Peer */
block|hdr = (struct rsn_ie_hdr *) kde.rsn_ie; 	rsn_ver = WPA_GET_LE16(hdr->version);
comment|/* use min(peer's version, out version) */
block|if (rsn_ver> RSN_VERSION) 		rsn_ver = RSN_VERSION;  	hdr = (struct rsn_ie_hdr *) peer->rsnie_p;  	hdr->elem_id = WLAN_EID_RSN; 	WPA_PUT_LE16(hdr->version, rsn_ver); 	pos = (u8 *) (hdr + 1);  	RSN_SELECTOR_PUT(pos, RSN_CIPHER_SUITE_NO_GROUP_ADDRESSED); 	pos += RSN_SELECTOR_LEN;
comment|/* Include only the selected cipher in pairwise cipher suite */
block|WPA_PUT_LE16(pos, 1); 	pos += 2; 	if (cipher == WPA_CIPHER_CCMP) 		RSN_SELECTOR_PUT(pos, RSN_CIPHER_SUITE_CCMP); 	pos += RSN_SELECTOR_LEN;  	WPA_PUT_LE16(pos, 1); 	pos += 2; 	RSN_SELECTOR_PUT(pos, RSN_AUTH_KEY_MGMT_TPK_HANDSHAKE); 	pos += RSN_SELECTOR_LEN;  	rsn_capab = WPA_CAPABILITY_PEERKEY_ENABLED; 	rsn_capab |= RSN_NUM_REPLAY_COUNTERS_16<< 2; 	WPA_PUT_LE16(pos, rsn_capab); 	pos += 2;  	hdr->len = (pos - peer->rsnie_p) - 2; 	peer->rsnie_p_len = pos - peer->rsnie_p;
endif|#
directive|endif
comment|/* temp fix: validation of RSNIE later */
name|os_memcpy
argument_list|(
name|peer
operator|->
name|rsnie_p
argument_list|,
name|peer
operator|->
name|rsnie_i
argument_list|,
name|peer
operator|->
name|rsnie_i_len
argument_list|)
expr_stmt|;
name|peer
operator|->
name|rsnie_p_len
operator|=
name|peer
operator|->
name|rsnie_i_len
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: RSN IE for TPK handshake"
argument_list|,
name|peer
operator|->
name|rsnie_p
argument_list|,
name|peer
operator|->
name|rsnie_p_len
argument_list|)
expr_stmt|;
name|peer
operator|->
name|lifetime
operator|=
name|lifetime
expr_stmt|;
name|wpa_tdls_generate_tpk
argument_list|(
name|peer
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|sm
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|skip_rsn_check
label|:
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_CONCURRENT_INIT
condition|)
goto|goto
name|skip_add_peer
goto|;
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
comment|/* add supported rates, capabilities, and qos_info to the TDLS peer */
if|if
condition|(
name|wpa_tdls_addset_peer
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
name|skip_add_peer
label|:
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
name|peer
operator|->
name|tpk_in_progress
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Sending TDLS Setup Response / TPK M2"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_tdls_send_tpk_m2
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|dtoken
argument_list|,
name|lnkid
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_sm_tdls_oper
argument_list|(
name|sm
argument_list|,
name|TDLS_DISABLE_LINK
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
return|return
literal|0
return|;
name|error
label|:
name|wpa_tdls_send_error
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|WLAN_TDLS_SETUP_RESPONSE
argument_list|,
name|dtoken
argument_list|,
literal|0
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
condition|)
name|wpa_tdls_peer_free
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_enable_link
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
parameter_list|)
block|{
name|peer
operator|->
name|tpk_success
operator|=
literal|1
expr_stmt|;
name|peer
operator|->
name|tpk_in_progress
operator|=
literal|0
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_tdls_tpk_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
block|{
name|u32
name|lifetime
init|=
name|peer
operator|->
name|lifetime
decl_stmt|;
comment|/* 		 * Start the initiator process a bit earlier to avoid race 		 * condition with the responder sending teardown request. 		 */
if|if
condition|(
name|lifetime
operator|>
literal|3
operator|&&
name|peer
operator|->
name|initiator
condition|)
name|lifetime
operator|-=
literal|3
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|lifetime
argument_list|,
literal|0
argument_list|,
name|wpa_tdls_tpk_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_NO_TPK_EXPIRATION
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - disable TPK "
literal|"expiration"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_tdls_tpk_timeout
argument_list|,
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
block|}
if|if
condition|(
name|peer
operator|->
name|reconfig_key
operator|&&
name|wpa_tdls_set_key
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Could not configure key to the "
literal|"driver"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|->
name|reconfig_key
operator|=
literal|0
expr_stmt|;
return|return
name|wpa_sm_tdls_oper
argument_list|(
name|sm
argument_list|,
name|TDLS_ENABLE_LINK
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_process_tpk_m2
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|cipher
decl_stmt|;
name|struct
name|wpa_tdls_ftie
modifier|*
name|ftie
decl_stmt|;
name|struct
name|wpa_tdls_timeoutie
modifier|*
name|timeoutie
decl_stmt|;
name|struct
name|wpa_tdls_lnkid
modifier|*
name|lnkid
decl_stmt|;
name|u32
name|lifetime
decl_stmt|;
name|u8
name|dtoken
decl_stmt|;
name|int
name|ielen
decl_stmt|;
name|u16
name|status
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Received TDLS Setup Response / TPK M2 "
literal|"(Peer "
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No matching peer found for "
literal|"TPK M2: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|peer
operator|->
name|initiator
condition|)
block|{
comment|/* 		 * This may happen if both devices try to initiate TDLS at the 		 * same time and we accept the TPK M1 from the peer in 		 * wpa_tdls_process_tpk_m1() and clear our previous state. 		 */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: We were not the initiator, so "
literal|"ignore TPK M2 from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|peer
operator|->
name|tpk_success
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Ignore incoming TPK M2 retry, from "
name|MACSTR
literal|" as TPK M3 was already sent"
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_tdls_tpk_retry_timeout_cancel
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|WLAN_TDLS_SETUP_REQUEST
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|3
operator|+
literal|2
operator|+
literal|1
condition|)
block|{
name|wpa_tdls_disable_peer_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|buf
expr_stmt|;
name|pos
operator|+=
literal|1
comment|/* pkt_type */
operator|+
literal|1
comment|/* Category */
operator|+
literal|1
comment|/* Action */
expr_stmt|;
name|status
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
comment|/* status code */
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Status code in TPK M2: %u"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|wpa_tdls_disable_peer_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|status
operator|=
name|WLAN_STATUS_UNSPECIFIED_FAILURE
expr_stmt|;
comment|/* TODO: need to verify dialog token matches here or in kernel */
name|dtoken
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
comment|/* dialog token */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Dialog Token in TPK M2 %d"
argument_list|,
name|dtoken
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|3
operator|+
literal|2
operator|+
literal|1
operator|+
literal|2
condition|)
block|{
name|wpa_tdls_disable_peer_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* capability information */
name|peer
operator|->
name|capability
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|ielen
operator|=
name|len
operator|-
operator|(
name|pos
operator|-
name|buf
operator|)
expr_stmt|;
comment|/* start of IE in buf */
comment|/* 	 * Don't reject the message if failing to parse IEs. The IEs we need are 	 * explicitly checked below. Some APs may add arbitrary padding to the 	 * end of short TDLS frames and that would look like invalid IEs. 	 */
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
name|pos
argument_list|,
name|ielen
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Failed to parse IEs in TPK M2 - ignore as an interop workaround"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
name|tdls_testing
operator|&
name|TDLS_TESTING_DECLINE_RESP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - decline response"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_REQUEST_DECLINED
expr_stmt|;
goto|goto
name|error
goto|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
if|if
condition|(
name|kde
operator|.
name|lnkid
operator|==
name|NULL
operator|||
name|kde
operator|.
name|lnkid_len
operator|<
literal|3
operator|*
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No valid Link Identifier IE in "
literal|"TPK M2"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Link ID Received from TPK M2"
argument_list|,
name|kde
operator|.
name|lnkid
argument_list|,
name|kde
operator|.
name|lnkid_len
argument_list|)
expr_stmt|;
name|lnkid
operator|=
operator|(
expr|struct
name|wpa_tdls_lnkid
operator|*
operator|)
name|kde
operator|.
name|lnkid
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sm
operator|->
name|bssid
argument_list|,
name|lnkid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: TPK M2 from different BSS"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_NOT_IN_SAME_BSS
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|copy_supp_rates
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|copy_peer_ht_capab
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|copy_peer_vht_capab
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|copy_peer_ext_capab
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|copy_peer_supp_channels
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|copy_peer_supp_oper_classes
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
name|peer
operator|->
name|qos_info
operator|=
name|kde
operator|.
name|qosinfo
expr_stmt|;
comment|/* Overwrite with the qos_info obtained in WMM IE */
if|if
condition|(
name|copy_peer_wmm_capab
argument_list|(
operator|&
name|kde
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
name|peer
operator|->
name|aid
operator|=
name|kde
operator|.
name|aid
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
block|{
name|peer
operator|->
name|rsnie_p_len
operator|=
literal|0
expr_stmt|;
name|peer
operator|->
name|cipher
operator|=
name|WPA_CIPHER_NONE
expr_stmt|;
goto|goto
name|skip_rsn
goto|;
block|}
if|if
condition|(
name|kde
operator|.
name|ftie
operator|==
name|NULL
operator|||
name|kde
operator|.
name|ftie_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ftie
argument_list|)
operator|||
name|kde
operator|.
name|rsn_ie
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No FTIE or RSN IE in TPK M2"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_PARAMETERS
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: RSN IE Received from TPK M2"
argument_list|,
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|kde
operator|.
name|rsn_ie_len
operator|>
name|TDLS_MAX_IE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Too long Responder RSN IE in TPK M2"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_RSNIE
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* 	 * FIX: bitwise comparison of RSN IE is not the correct way of 	 * validation this. It can be different, but certain fields must 	 * match. Since we list only a single pairwise cipher in TPK M1, the 	 * memcmp is likely to work in most cases, though. 	 */
if|if
condition|(
name|kde
operator|.
name|rsn_ie_len
operator|!=
name|peer
operator|->
name|rsnie_i_len
operator|||
name|os_memcmp
argument_list|(
name|peer
operator|->
name|rsnie_i
argument_list|,
name|kde
operator|.
name|rsn_ie
argument_list|,
name|peer
operator|->
name|rsnie_i_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: RSN IE in TPK M2 does "
literal|"not match with RSN IE used in TPK M1"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: RSN IE Sent in TPK M1"
argument_list|,
name|peer
operator|->
name|rsnie_i
argument_list|,
name|peer
operator|->
name|rsnie_i_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: RSN IE Received from TPK M2"
argument_list|,
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_RSNIE
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|wpa_parse_wpa_ie_rsn
argument_list|(
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Failed to parse RSN IE in TPK M2"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_RSNIE
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|cipher
operator|=
name|ie
operator|.
name|pairwise_cipher
expr_stmt|;
if|if
condition|(
name|cipher
operator|==
name|WPA_CIPHER_CCMP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Using CCMP for direct link"
argument_list|)
expr_stmt|;
name|cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No acceptable cipher in TPK M2"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_PAIRWISE_CIPHER_NOT_VALID
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: FTIE Received from TPK M2"
argument_list|,
name|kde
operator|.
name|ftie
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ftie
argument_list|)
argument_list|)
expr_stmt|;
name|ftie
operator|=
operator|(
expr|struct
name|wpa_tdls_ftie
operator|*
operator|)
name|kde
operator|.
name|ftie
expr_stmt|;
if|if
condition|(
operator|!
name|os_memcmp
argument_list|(
name|peer
operator|->
name|inonce
argument_list|,
name|ftie
operator|->
name|Snonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: FTIE SNonce in TPK M2 does "
literal|"not match with FTIE SNonce used in TPK M1"
argument_list|)
expr_stmt|;
comment|/* Silently discard the frame */
return|return
operator|-
literal|1
return|;
block|}
comment|/* Responder Nonce and RSN IE */
name|os_memcpy
argument_list|(
name|peer
operator|->
name|rnonce
argument_list|,
name|ftie
operator|->
name|Anonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|peer
operator|->
name|rsnie_p
argument_list|,
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
expr_stmt|;
name|peer
operator|->
name|rsnie_p_len
operator|=
name|kde
operator|.
name|rsn_ie_len
expr_stmt|;
name|peer
operator|->
name|cipher
operator|=
name|cipher
expr_stmt|;
comment|/* Lifetime */
if|if
condition|(
name|kde
operator|.
name|key_lifetime
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No Key Lifetime IE in TPK M2"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_UNACCEPTABLE_LIFETIME
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|timeoutie
operator|=
operator|(
expr|struct
name|wpa_tdls_timeoutie
operator|*
operator|)
name|kde
operator|.
name|key_lifetime
expr_stmt|;
name|lifetime
operator|=
name|WPA_GET_LE32
argument_list|(
name|timeoutie
operator|->
name|value
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK lifetime %u seconds in TPK M2"
argument_list|,
name|lifetime
argument_list|)
expr_stmt|;
if|if
condition|(
name|lifetime
operator|!=
name|peer
operator|->
name|lifetime
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Unexpected TPK lifetime %u in "
literal|"TPK M2 (expected %u)"
argument_list|,
name|lifetime
argument_list|,
name|peer
operator|->
name|lifetime
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_UNACCEPTABLE_LIFETIME
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_tdls_generate_tpk
argument_list|(
name|peer
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|sm
operator|->
name|bssid
argument_list|)
expr_stmt|;
comment|/* Process MIC check to see if TPK M2 is right */
if|if
condition|(
name|wpa_supplicant_verify_tdls_mic
argument_list|(
literal|2
argument_list|,
name|peer
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|lnkid
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|timeoutie
argument_list|,
name|ftie
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* Discard the frame */
name|wpa_tdls_del_key
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|wpa_tdls_disable_peer_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_tdls_set_key
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* 		 * Some drivers may not be able to config the key prior to full 		 * STA entry having been configured. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Try to configure TPK again after "
literal|"STA entry is complete"
argument_list|)
expr_stmt|;
name|peer
operator|->
name|reconfig_key
operator|=
literal|1
expr_stmt|;
block|}
name|skip_rsn
label|:
name|peer
operator|->
name|dtoken
operator|=
name|dtoken
expr_stmt|;
comment|/* add supported rates, capabilities, and qos_info to the TDLS peer */
if|if
condition|(
name|wpa_tdls_addset_peer
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Sending TDLS Setup Confirm / "
literal|"TPK Handshake Message 3"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_tdls_send_tpk_m3
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|dtoken
argument_list|,
name|lnkid
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|peer
operator|->
name|tpk_success
condition|)
block|{
comment|/* 		 * Enable Link only when tpk_success is 0, signifying that this 		 * processing of TPK M2 frame is not because of a retransmission 		 * during TDLS setup handshake. 		 */
name|ret
operator|=
name|wpa_tdls_enable_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Could not enable link"
argument_list|)
expr_stmt|;
name|wpa_tdls_do_teardown
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|WLAN_REASON_TDLS_TEARDOWN_UNSPECIFIED
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
name|error
label|:
name|wpa_tdls_send_error
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|WLAN_TDLS_SETUP_CONFIRM
argument_list|,
name|dtoken
argument_list|,
literal|1
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|wpa_tdls_disable_peer_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_process_tpk_m3
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
name|struct
name|wpa_tdls_ftie
modifier|*
name|ftie
decl_stmt|;
name|struct
name|wpa_tdls_timeoutie
modifier|*
name|timeoutie
decl_stmt|;
name|struct
name|wpa_tdls_lnkid
modifier|*
name|lnkid
decl_stmt|;
name|int
name|ielen
decl_stmt|;
name|u16
name|status
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|u32
name|lifetime
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Received TDLS Setup Confirm / TPK M3 "
literal|"(Peer "
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|src_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No matching peer found for "
literal|"TPK M3: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|src_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_tdls_tpk_retry_timeout_cancel
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|WLAN_TDLS_SETUP_RESPONSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|3
operator|+
literal|3
condition|)
goto|goto
name|error
goto|;
name|pos
operator|=
name|buf
expr_stmt|;
name|pos
operator|+=
literal|1
comment|/* pkt_type */
operator|+
literal|1
comment|/* Category */
operator|+
literal|1
comment|/* Action */
expr_stmt|;
name|status
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Status code in TPK M3: %u"
argument_list|,
name|status
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|pos
operator|+=
literal|2
comment|/* status code */
operator|+
literal|1
comment|/* dialog token */
expr_stmt|;
name|ielen
operator|=
name|len
operator|-
operator|(
name|pos
operator|-
name|buf
operator|)
expr_stmt|;
comment|/* start of IE in buf */
comment|/* 	 * Don't reject the message if failing to parse IEs. The IEs we need are 	 * explicitly checked below. Some APs piggy-back broken IEs to the end 	 * of a TDLS Confirm packet, which will fail the link if we don't ignore 	 * this error. 	 */
if|if
condition|(
name|wpa_supplicant_parse_ies
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
name|pos
argument_list|,
name|ielen
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Failed to parse KDEs in TPK M3 - ignore as an interop workaround"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|kde
operator|.
name|lnkid
operator|==
name|NULL
operator|||
name|kde
operator|.
name|lnkid_len
operator|<
literal|3
operator|*
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No Link Identifier IE in TPK M3"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Link ID Received from TPK M3"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|kde
operator|.
name|lnkid
argument_list|,
name|kde
operator|.
name|lnkid_len
argument_list|)
expr_stmt|;
name|lnkid
operator|=
operator|(
expr|struct
name|wpa_tdls_lnkid
operator|*
operator|)
name|kde
operator|.
name|lnkid
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sm
operator|->
name|bssid
argument_list|,
name|lnkid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: TPK M3 from diff BSS"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_tdls_get_privacy
argument_list|(
name|sm
argument_list|)
condition|)
goto|goto
name|skip_rsn
goto|;
if|if
condition|(
name|kde
operator|.
name|ftie
operator|==
name|NULL
operator|||
name|kde
operator|.
name|ftie_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|ftie
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No FTIE in TPK M3"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: FTIE Received from TPK M3"
argument_list|,
name|kde
operator|.
name|ftie
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ftie
argument_list|)
argument_list|)
expr_stmt|;
name|ftie
operator|=
operator|(
expr|struct
name|wpa_tdls_ftie
operator|*
operator|)
name|kde
operator|.
name|ftie
expr_stmt|;
if|if
condition|(
name|kde
operator|.
name|rsn_ie
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No RSN IE in TPK M3"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: RSN IE Received from TPK M3"
argument_list|,
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|kde
operator|.
name|rsn_ie_len
operator|!=
name|peer
operator|->
name|rsnie_p_len
operator|||
name|os_memcmp
argument_list|(
name|kde
operator|.
name|rsn_ie
argument_list|,
name|peer
operator|->
name|rsnie_p
argument_list|,
name|peer
operator|->
name|rsnie_p_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: RSN IE in TPK M3 does not match "
literal|"with the one sent in TPK M2"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|os_memcmp
argument_list|(
name|peer
operator|->
name|rnonce
argument_list|,
name|ftie
operator|->
name|Anonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: FTIE ANonce in TPK M3 does "
literal|"not match with FTIE ANonce used in TPK M2"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|os_memcmp
argument_list|(
name|peer
operator|->
name|inonce
argument_list|,
name|ftie
operator|->
name|Snonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: FTIE SNonce in TPK M3 does not "
literal|"match with FTIE SNonce used in TPK M1"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|kde
operator|.
name|key_lifetime
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: No Key Lifetime IE in TPK M3"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|timeoutie
operator|=
operator|(
expr|struct
name|wpa_tdls_timeoutie
operator|*
operator|)
name|kde
operator|.
name|key_lifetime
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Timeout IE Received from TPK M3"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|timeoutie
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|timeoutie
argument_list|)
argument_list|)
expr_stmt|;
name|lifetime
operator|=
name|WPA_GET_LE32
argument_list|(
name|timeoutie
operator|->
name|value
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TPK lifetime %u seconds in TPK M3"
argument_list|,
name|lifetime
argument_list|)
expr_stmt|;
if|if
condition|(
name|lifetime
operator|!=
name|peer
operator|->
name|lifetime
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Unexpected TPK lifetime %u in "
literal|"TPK M3 (expected %u)"
argument_list|,
name|lifetime
argument_list|,
name|peer
operator|->
name|lifetime
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|wpa_supplicant_verify_tdls_mic
argument_list|(
literal|3
argument_list|,
name|peer
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|lnkid
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|timeoutie
argument_list|,
name|ftie
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_tdls_del_key
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|wpa_tdls_set_key
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* 		 * Some drivers may not be able to config the key prior to full 		 * STA entry having been configured. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Try to configure TPK again after "
literal|"STA entry is complete"
argument_list|)
expr_stmt|;
name|peer
operator|->
name|reconfig_key
operator|=
literal|1
expr_stmt|;
block|}
name|skip_rsn
label|:
comment|/* add supported rates, capabilities, and qos_info to the TDLS peer */
if|if
condition|(
name|wpa_tdls_addset_peer
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|peer
operator|->
name|tpk_success
condition|)
block|{
comment|/* 		 * Enable Link only when tpk_success is 0, signifying that this 		 * processing of TPK M3 frame is not because of a retransmission 		 * during TDLS setup handshake. 		 */
name|ret
operator|=
name|wpa_tdls_enable_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Could not enable link"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
return|return
name|ret
return|;
name|error
label|:
name|wpa_tdls_do_teardown
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|WLAN_REASON_TDLS_TEARDOWN_UNSPECIFIED
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|wpa_add_tdls_timeoutie
parameter_list|(
name|u8
modifier|*
name|pos
parameter_list|,
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|u32
name|tsecs
parameter_list|)
block|{
name|struct
name|wpa_tdls_timeoutie
modifier|*
name|lifetime
init|=
operator|(
expr|struct
name|wpa_tdls_timeoutie
operator|*
operator|)
name|ie
decl_stmt|;
name|os_memset
argument_list|(
name|lifetime
argument_list|,
literal|0
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
name|lifetime
operator|->
name|ie_type
operator|=
name|WLAN_EID_TIMEOUT_INTERVAL
expr_stmt|;
name|lifetime
operator|->
name|ie_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_tdls_timeoutie
argument_list|)
operator|-
literal|2
expr_stmt|;
name|lifetime
operator|->
name|interval_type
operator|=
name|WLAN_TIMEOUT_KEY_LIFETIME
expr_stmt|;
name|WPA_PUT_LE32
argument_list|(
name|lifetime
operator|->
name|value
argument_list|,
name|tsecs
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
return|return
name|pos
operator|+
name|ie_len
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_tdls_start - Initiate TDLS handshake (send TPK Handshake Message 1)  * @sm: Pointer to WPA state machine data from wpa_sm_init()  * @peer: MAC address of the peer STA  * Returns: 0 on success, or -1 on failure  *  * Send TPK Handshake Message 1 info to driver to start TDLS  * handshake with the peer.  */
end_comment

begin_function
name|int
name|wpa_tdls_start
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
name|int
name|tdls_prohibited
init|=
name|sm
operator|->
name|tdls_prohibited
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|tdls_disabled
operator|||
operator|!
name|sm
operator|->
name|tdls_supported
condition|)
return|return
operator|-
literal|1
return|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS_TESTING
if|if
condition|(
operator|(
name|tdls_testing
operator|&
name|TDLS_TESTING_IGNORE_AP_PROHIBIT
operator|)
operator|&&
name|tdls_prohibited
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Testing - ignore AP prohibition "
literal|"on TDLS"
argument_list|)
expr_stmt|;
name|tdls_prohibited
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS_TESTING */
if|if
condition|(
name|tdls_prohibited
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TDLS is prohibited in this BSS - "
literal|"reject request to start setup"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|=
name|wpa_tdls_add_peer
argument_list|(
name|sm
argument_list|,
name|addr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|peer
operator|->
name|tpk_in_progress
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Setup is already in progress with the peer"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|peer
operator|->
name|initiator
operator|=
literal|1
expr_stmt|;
comment|/* add the peer to the driver as a "setup in progress" peer */
if|if
condition|(
name|wpa_sm_tdls_peer_addset
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_tdls_disable_peer_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|peer
operator|->
name|tpk_in_progress
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_tdls_send_tpk_m1
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_tdls_disable_peer_link
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpa_tdls_remove
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|tdls_disabled
operator|||
operator|!
name|sm
operator|->
name|tdls_supported
condition|)
return|return;
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peer
operator|==
name|NULL
operator|||
operator|!
name|peer
operator|->
name|tpk_success
condition|)
return|return;
if|if
condition|(
name|sm
operator|->
name|tdls_external_setup
condition|)
block|{
comment|/* 		 * Disable previous link to allow renegotiation to be completed 		 * on AP path. 		 */
name|wpa_tdls_do_teardown
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|WLAN_REASON_TDLS_TEARDOWN_UNSPECIFIED
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_rx_tdls - Receive TDLS data frame  *  * This function is called to receive TDLS (ethertype = 0x890d) data frames.  */
end_comment

begin_function
specifier|static
name|void
name|wpa_supplicant_rx_tdls
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_sm
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_tdls_frame
modifier|*
name|tf
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Received Data frame encapsulation"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|tdls_disabled
operator|||
operator|!
name|sm
operator|->
name|tdls_supported
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Discard message - TDLS disabled "
literal|"or unsupported by driver"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|src_addr
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Discard copy of own message"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|tf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Drop too short frame"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Check to make sure its a valid encapsulated TDLS frame */
name|tf
operator|=
operator|(
expr|struct
name|wpa_tdls_frame
operator|*
operator|)
name|buf
expr_stmt|;
if|if
condition|(
name|tf
operator|->
name|payloadtype
operator|!=
literal|2
comment|/* TDLS_RFTYPE */
operator|||
name|tf
operator|->
name|category
operator|!=
name|WLAN_ACTION_TDLS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TDLS: Invalid frame - payloadtype=%u "
literal|"category=%u action=%u"
argument_list|,
name|tf
operator|->
name|payloadtype
argument_list|,
name|tf
operator|->
name|category
argument_list|,
name|tf
operator|->
name|action
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|tf
operator|->
name|action
condition|)
block|{
case|case
name|WLAN_TDLS_SETUP_REQUEST
case|:
name|wpa_tdls_process_tpk_m1
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_TDLS_SETUP_RESPONSE
case|:
name|wpa_tdls_process_tpk_m2
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_TDLS_SETUP_CONFIRM
case|:
name|wpa_tdls_process_tpk_m3
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_TDLS_TEARDOWN
case|:
name|wpa_tdls_recv_teardown
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_TDLS_DISCOVERY_REQUEST
case|:
name|wpa_tdls_process_discovery_request
argument_list|(
name|sm
argument_list|,
name|src_addr
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* Kernel code will process remaining frames */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Ignore TDLS frame action code %u"
argument_list|,
name|tf
operator|->
name|action
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_tdls_init - Initialize driver interface parameters for TDLS  * @wpa_s: Pointer to wpa_supplicant data  * Returns: 0 on success, -1 on failure  *  * This function is called to initialize driver interface parameters for TDLS.  * wpa_drv_init() must have been called before this function to initialize the  * driver interface.  */
end_comment

begin_function
name|int
name|wpa_tdls_init
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|sm
operator|->
name|l2_tdls
operator|=
name|l2_packet_init
argument_list|(
name|sm
operator|->
name|bridge_ifname
condition|?
name|sm
operator|->
name|bridge_ifname
else|:
name|sm
operator|->
name|ifname
argument_list|,
name|sm
operator|->
name|own_addr
argument_list|,
name|ETH_P_80211_ENCAP
argument_list|,
name|wpa_supplicant_rx_tdls
argument_list|,
name|sm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|l2_tdls
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TDLS: Failed to open l2_packet "
literal|"connection"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * Drivers that support TDLS but don't implement the get_capa callback 	 * are assumed to perform everything internally 	 */
if|if
condition|(
name|wpa_sm_tdls_get_capa
argument_list|(
name|sm
argument_list|,
operator|&
name|sm
operator|->
name|tdls_supported
argument_list|,
operator|&
name|sm
operator|->
name|tdls_external_setup
argument_list|,
operator|&
name|sm
operator|->
name|tdls_chan_switch
argument_list|)
operator|<
literal|0
condition|)
block|{
name|sm
operator|->
name|tdls_supported
operator|=
literal|1
expr_stmt|;
name|sm
operator|->
name|tdls_external_setup
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TDLS operation%s supported by "
literal|"driver"
argument_list|,
name|sm
operator|->
name|tdls_supported
condition|?
literal|""
else|:
literal|" not"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Driver uses %s link setup"
argument_list|,
name|sm
operator|->
name|tdls_external_setup
condition|?
literal|"external"
else|:
literal|"internal"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Driver %s TDLS channel switching"
argument_list|,
name|sm
operator|->
name|tdls_chan_switch
condition|?
literal|"supports"
else|:
literal|"does not support"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpa_tdls_teardown_peers
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
if|if
condition|(
operator|!
name|sm
condition|)
return|return;
name|peer
operator|=
name|sm
operator|->
name|tdls
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Tear down peers"
argument_list|)
expr_stmt|;
while|while
condition|(
name|peer
condition|)
block|{
name|tmp
operator|=
name|peer
operator|->
name|next
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Tear down peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peer
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|tdls_external_setup
condition|)
name|wpa_tdls_do_teardown
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
else|else
name|wpa_sm_tdls_oper
argument_list|(
name|sm
argument_list|,
name|TDLS_TEARDOWN
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
expr_stmt|;
name|peer
operator|=
name|tmp
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_tdls_remove_peers
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|peer
operator|=
name|sm
operator|->
name|tdls
expr_stmt|;
while|while
condition|(
name|peer
condition|)
block|{
name|int
name|res
decl_stmt|;
name|tmp
operator|=
name|peer
operator|->
name|next
expr_stmt|;
name|res
operator|=
name|wpa_sm_tdls_oper
argument_list|(
name|sm
argument_list|,
name|TDLS_DISABLE_LINK
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Remove peer "
name|MACSTR
literal|" (res=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
operator|->
name|addr
argument_list|)
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wpa_tdls_peer_free
argument_list|(
name|sm
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|peer
operator|=
name|tmp
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_tdls_deinit - Deinitialize driver interface parameters for TDLS  *  * This function is called to recover driver interface parameters for TDLS  * and frees resources allocated for it.  */
end_comment

begin_function
name|void
name|wpa_tdls_deinit
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|sm
operator|->
name|l2_tdls
condition|)
name|l2_packet_deinit
argument_list|(
name|sm
operator|->
name|l2_tdls
argument_list|)
expr_stmt|;
name|sm
operator|->
name|l2_tdls
operator|=
name|NULL
expr_stmt|;
name|wpa_tdls_remove_peers
argument_list|(
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_tdls_assoc
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Remove peers on association"
argument_list|)
expr_stmt|;
name|wpa_tdls_remove_peers
argument_list|(
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_tdls_disassoc
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Remove peers on disassociation"
argument_list|)
expr_stmt|;
name|wpa_tdls_remove_peers
argument_list|(
name|sm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_prohibited
parameter_list|(
name|struct
name|ieee802_11_elems
modifier|*
name|elems
parameter_list|)
block|{
comment|/* bit 38 - TDLS Prohibited */
return|return
operator|!
operator|!
operator|(
name|elems
operator|->
name|ext_capab
index|[
literal|2
operator|+
literal|4
index|]
operator|&
literal|0x40
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_tdls_chan_switch_prohibited
parameter_list|(
name|struct
name|ieee802_11_elems
modifier|*
name|elems
parameter_list|)
block|{
comment|/* bit 39 - TDLS Channel Switch Prohibited */
return|return
operator|!
operator|!
operator|(
name|elems
operator|->
name|ext_capab
index|[
literal|2
operator|+
literal|4
index|]
operator|&
literal|0x80
operator|)
return|;
block|}
end_function

begin_function
name|void
name|wpa_tdls_ap_ies
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|sm
operator|->
name|tdls_prohibited
operator|=
literal|0
expr_stmt|;
name|sm
operator|->
name|tdls_chan_switch_prohibited
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
operator|||
name|ieee802_11_parse_elems
argument_list|(
name|ies
argument_list|,
name|len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|==
name|ParseFailed
operator|||
name|elems
operator|.
name|ext_capab
operator|==
name|NULL
operator|||
name|elems
operator|.
name|ext_capab_len
operator|<
literal|2
operator|+
literal|5
condition|)
return|return;
name|sm
operator|->
name|tdls_prohibited
operator|=
name|wpa_tdls_prohibited
argument_list|(
operator|&
name|elems
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TDLS is %s in the target BSS"
argument_list|,
name|sm
operator|->
name|tdls_prohibited
condition|?
literal|"prohibited"
else|:
literal|"allowed"
argument_list|)
expr_stmt|;
name|sm
operator|->
name|tdls_chan_switch_prohibited
operator|=
name|wpa_tdls_chan_switch_prohibited
argument_list|(
operator|&
name|elems
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TDLS channel switch %s in the target BSS"
argument_list|,
name|sm
operator|->
name|tdls_chan_switch_prohibited
condition|?
literal|"prohibited"
else|:
literal|"allowed"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_tdls_assoc_resp_ies
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
operator|||
name|ieee802_11_parse_elems
argument_list|(
name|ies
argument_list|,
name|len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|==
name|ParseFailed
operator|||
name|elems
operator|.
name|ext_capab
operator|==
name|NULL
operator|||
name|elems
operator|.
name|ext_capab_len
operator|<
literal|2
operator|+
literal|5
condition|)
return|return;
if|if
condition|(
operator|!
name|sm
operator|->
name|tdls_prohibited
operator|&&
name|wpa_tdls_prohibited
argument_list|(
operator|&
name|elems
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TDLS prohibited based on "
literal|"(Re)Association Response IEs"
argument_list|)
expr_stmt|;
name|sm
operator|->
name|tdls_prohibited
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|sm
operator|->
name|tdls_chan_switch_prohibited
operator|&&
name|wpa_tdls_chan_switch_prohibited
argument_list|(
operator|&
name|elems
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: TDLS channel switch prohibited based on (Re)Association Response IEs"
argument_list|)
expr_stmt|;
name|sm
operator|->
name|tdls_chan_switch_prohibited
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpa_tdls_enable
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: %s"
argument_list|,
name|enabled
condition|?
literal|"enabled"
else|:
literal|"disabled"
argument_list|)
expr_stmt|;
name|sm
operator|->
name|tdls_disabled
operator|=
operator|!
name|enabled
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpa_tdls_is_external_setup
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
return|return
name|sm
operator|->
name|tdls_external_setup
return|;
block|}
end_function

begin_function
name|int
name|wpa_tdls_enable_chan_switch
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
name|oper_class
parameter_list|,
name|struct
name|hostapd_freq_params
modifier|*
name|freq_params
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|tdls_disabled
operator|||
operator|!
name|sm
operator|->
name|tdls_supported
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|sm
operator|->
name|tdls_chan_switch
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Channel switching not supported by the driver"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|sm
operator|->
name|tdls_chan_switch_prohibited
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Channel switching is prohibited in this BSS - reject request to switch channel"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|peer
operator|==
name|NULL
operator|||
operator|!
name|peer
operator|->
name|tpk_success
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TDLS: Peer "
name|MACSTR
literal|" not found for channel switching"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|peer
operator|->
name|chan_switch_enabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Peer "
name|MACSTR
literal|" already has channel switching enabled"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ret
operator|=
name|wpa_sm_tdls_enable_channel_switch
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|,
name|oper_class
argument_list|,
name|freq_params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
name|peer
operator|->
name|chan_switch_enabled
operator|=
literal|1
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpa_tdls_disable_chan_switch
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_tdls_peer
modifier|*
name|peer
decl_stmt|;
if|if
condition|(
name|sm
operator|->
name|tdls_disabled
operator|||
operator|!
name|sm
operator|->
name|tdls_supported
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|peer
operator|=
name|sm
operator|->
name|tdls
init|;
name|peer
condition|;
name|peer
operator|=
name|peer
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|peer
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|peer
operator|||
operator|!
name|peer
operator|->
name|chan_switch_enabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TDLS: Channel switching not enabled for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* ignore the return value */
name|wpa_sm_tdls_disable_channel_switch
argument_list|(
name|sm
argument_list|,
name|peer
operator|->
name|addr
argument_list|)
expr_stmt|;
name|peer
operator|->
name|chan_switch_enabled
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


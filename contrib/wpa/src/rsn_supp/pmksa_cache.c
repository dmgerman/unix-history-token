begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - RSN PMKSA cache  * Copyright (c) 2004-2009, 2011-2012, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"wpa.h"
end_include

begin_include
include|#
directive|include
file|"wpa_i.h"
end_include

begin_include
include|#
directive|include
file|"pmksa_cache.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|IEEE8021X_EAPOL
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|CONFIG_NO_WPA2
argument_list|)
end_if

begin_decl_stmt
specifier|static
specifier|const
name|int
name|pmksa_cache_max_entries
init|=
literal|32
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|rsn_pmksa_cache
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa
decl_stmt|;
comment|/* PMKSA cache */
name|int
name|pmksa_count
decl_stmt|;
comment|/* number of entries in PMKSA cache */
name|struct
name|wpa_sm
modifier|*
name|sm
decl_stmt|;
comment|/* TODO: get rid of this reference(?) */
name|void
function_decl|(
modifier|*
name|free_cb
function_decl|)
parameter_list|(
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|pmksa_free_reason
name|reason
parameter_list|)
function_decl|;
name|void
modifier|*
name|ctx
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|pmksa_cache_set_expiration
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|_pmksa_cache_free_entry
parameter_list|(
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
parameter_list|)
block|{
name|os_free
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pmksa_cache_free_entry
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|,
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
parameter_list|,
name|enum
name|pmksa_free_reason
name|reason
parameter_list|)
block|{
name|wpa_sm_remove_pmkid
argument_list|(
name|pmksa
operator|->
name|sm
argument_list|,
name|entry
operator|->
name|aa
argument_list|,
name|entry
operator|->
name|pmkid
argument_list|)
expr_stmt|;
name|pmksa
operator|->
name|pmksa_count
operator|--
expr_stmt|;
name|pmksa
operator|->
name|free_cb
argument_list|(
name|entry
argument_list|,
name|pmksa
operator|->
name|ctx
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|_pmksa_cache_free_entry
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pmksa_cache_expire
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
while|while
condition|(
name|pmksa
operator|->
name|pmksa
operator|&&
name|pmksa
operator|->
name|pmksa
operator|->
name|expiration
operator|<=
name|now
operator|.
name|sec
condition|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
init|=
name|pmksa
operator|->
name|pmksa
decl_stmt|;
name|pmksa
operator|->
name|pmksa
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: expired PMKSA cache entry for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|entry
operator|->
name|aa
argument_list|)
argument_list|)
expr_stmt|;
name|pmksa_cache_free_entry
argument_list|(
name|pmksa
argument_list|,
name|entry
argument_list|,
name|PMKSA_EXPIRE
argument_list|)
expr_stmt|;
block|}
name|pmksa_cache_set_expiration
argument_list|(
name|pmksa
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pmksa_cache_reauth
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
init|=
name|eloop_ctx
decl_stmt|;
name|pmksa
operator|->
name|sm
operator|->
name|cur_pmksa
operator|=
name|NULL
expr_stmt|;
name|eapol_sm_request_reauth
argument_list|(
name|pmksa
operator|->
name|sm
operator|->
name|eapol
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|pmksa_cache_set_expiration
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|)
block|{
name|int
name|sec
decl_stmt|;
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|pmksa_cache_expire
argument_list|,
name|pmksa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|pmksa_cache_reauth
argument_list|,
name|pmksa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmksa
operator|->
name|pmksa
operator|==
name|NULL
condition|)
return|return;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|sec
operator|=
name|pmksa
operator|->
name|pmksa
operator|->
name|expiration
operator|-
name|now
operator|.
name|sec
expr_stmt|;
if|if
condition|(
name|sec
operator|<
literal|0
condition|)
name|sec
operator|=
literal|0
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
operator|+
literal|1
argument_list|,
literal|0
argument_list|,
name|pmksa_cache_expire
argument_list|,
name|pmksa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|entry
operator|=
name|pmksa
operator|->
name|sm
operator|->
name|cur_pmksa
condition|?
name|pmksa
operator|->
name|sm
operator|->
name|cur_pmksa
else|:
name|pmksa_cache_get
argument_list|(
name|pmksa
argument_list|,
name|pmksa
operator|->
name|sm
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
condition|)
block|{
name|sec
operator|=
name|pmksa
operator|->
name|pmksa
operator|->
name|reauth_time
operator|-
name|now
operator|.
name|sec
expr_stmt|;
if|if
condition|(
name|sec
operator|<
literal|0
condition|)
name|sec
operator|=
literal|0
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
argument_list|,
literal|0
argument_list|,
name|pmksa_cache_reauth
argument_list|,
name|pmksa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_add - Add a PMKSA cache entry  * @pmksa: Pointer to PMKSA cache data from pmksa_cache_init()  * @pmk: The new pairwise master key  * @pmk_len: PMK length in bytes, usually PMK_LEN (32)  * @aa: Authenticator address  * @spa: Supplicant address  * @network_ctx: Network configuration context for this PMK  * @akmp: WPA_KEY_MGMT_* used in key derivation  * Returns: Pointer to the added PMKSA cache entry or %NULL on error  *  * This function create a PMKSA entry for a new PMK and adds it to the PMKSA  * cache. If an old entry is already in the cache for the same Authenticator,  * this entry will be replaced with the new entry. PMKID will be calculated  * based on the PMK and the driver interface is notified of the new PMKID.  */
end_comment

begin_function
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa_cache_add
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmk
parameter_list|,
name|size_t
name|pmk_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|aa
parameter_list|,
specifier|const
name|u8
modifier|*
name|spa
parameter_list|,
name|void
modifier|*
name|network_ctx
parameter_list|,
name|int
name|akmp
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
if|if
condition|(
name|pmk_len
operator|>
name|PMK_LEN
condition|)
return|return
name|NULL
return|;
name|entry
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|entry
operator|->
name|pmk
argument_list|,
name|pmk
argument_list|,
name|pmk_len
argument_list|)
expr_stmt|;
name|entry
operator|->
name|pmk_len
operator|=
name|pmk_len
expr_stmt|;
name|rsn_pmkid
argument_list|(
name|pmk
argument_list|,
name|pmk_len
argument_list|,
name|aa
argument_list|,
name|spa
argument_list|,
name|entry
operator|->
name|pmkid
argument_list|,
name|wpa_key_mgmt_sha256
argument_list|(
name|akmp
argument_list|)
argument_list|)
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|entry
operator|->
name|expiration
operator|=
name|now
operator|.
name|sec
operator|+
name|pmksa
operator|->
name|sm
operator|->
name|dot11RSNAConfigPMKLifetime
expr_stmt|;
name|entry
operator|->
name|reauth_time
operator|=
name|now
operator|.
name|sec
operator|+
name|pmksa
operator|->
name|sm
operator|->
name|dot11RSNAConfigPMKLifetime
operator|*
name|pmksa
operator|->
name|sm
operator|->
name|dot11RSNAConfigPMKReauthThreshold
operator|/
literal|100
expr_stmt|;
name|entry
operator|->
name|akmp
operator|=
name|akmp
expr_stmt|;
name|os_memcpy
argument_list|(
name|entry
operator|->
name|aa
argument_list|,
name|aa
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|entry
operator|->
name|network_ctx
operator|=
name|network_ctx
expr_stmt|;
comment|/* Replace an old entry for the same Authenticator (if found) with the 	 * new entry */
name|pos
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pos
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|aa
argument_list|,
name|pos
operator|->
name|aa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|pos
operator|->
name|pmk_len
operator|==
name|pmk_len
operator|&&
name|os_memcmp
argument_list|(
name|pos
operator|->
name|pmk
argument_list|,
name|pmk
argument_list|,
name|pmk_len
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|pos
operator|->
name|pmkid
argument_list|,
name|entry
operator|->
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: reusing previous "
literal|"PMKSA entry"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|entry
argument_list|)
expr_stmt|;
return|return
name|pos
return|;
block|}
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
name|pmksa
operator|->
name|pmksa
operator|=
name|pos
operator|->
name|next
expr_stmt|;
else|else
name|prev
operator|->
name|next
operator|=
name|pos
operator|->
name|next
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Replace PMKSA entry for "
literal|"the current AP"
argument_list|)
expr_stmt|;
name|pmksa_cache_free_entry
argument_list|(
name|pmksa
argument_list|,
name|pos
argument_list|,
name|PMKSA_REPLACE
argument_list|)
expr_stmt|;
comment|/* 			 * If OKC is used, there may be other PMKSA cache 			 * entries based on the same PMK. These needs to be 			 * flushed so that a new entry can be created based on 			 * the new PMK. 			 */
name|pmksa_cache_flush
argument_list|(
name|pmksa
argument_list|,
name|network_ctx
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|pos
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|pmksa
operator|->
name|pmksa_count
operator|>=
name|pmksa_cache_max_entries
operator|&&
name|pmksa
operator|->
name|pmksa
condition|)
block|{
comment|/* Remove the oldest entry to make room for the new entry */
name|pos
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|pmksa
operator|->
name|sm
operator|->
name|cur_pmksa
condition|)
block|{
comment|/* 			 * Never remove the current PMKSA cache entry, since 			 * it's in use, and removing it triggers a needless 			 * deauthentication. 			 */
name|pos
operator|=
name|pos
operator|->
name|next
expr_stmt|;
name|pmksa
operator|->
name|pmksa
operator|->
name|next
operator|=
name|pos
condition|?
name|pos
operator|->
name|next
else|:
name|NULL
expr_stmt|;
block|}
else|else
name|pmksa
operator|->
name|pmksa
operator|=
name|pos
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: removed the oldest idle "
literal|"PMKSA cache entry (for "
name|MACSTR
literal|") to "
literal|"make room for new one"
argument_list|,
name|MAC2STR
argument_list|(
name|pos
operator|->
name|aa
argument_list|)
argument_list|)
expr_stmt|;
name|pmksa_cache_free_entry
argument_list|(
name|pmksa
argument_list|,
name|pos
argument_list|,
name|PMKSA_FREE
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Add the new entry; order by expiration time */
name|pos
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pos
condition|)
block|{
if|if
condition|(
name|pos
operator|->
name|expiration
operator|>
name|entry
operator|->
name|expiration
condition|)
break|break;
name|prev
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|pos
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
block|{
name|entry
operator|->
name|next
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
name|pmksa
operator|->
name|pmksa
operator|=
name|entry
expr_stmt|;
name|pmksa_cache_set_expiration
argument_list|(
name|pmksa
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|entry
operator|->
name|next
operator|=
name|prev
operator|->
name|next
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|entry
expr_stmt|;
block|}
name|pmksa
operator|->
name|pmksa_count
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Added PMKSA cache entry for "
name|MACSTR
literal|" network_ctx=%p"
argument_list|,
name|MAC2STR
argument_list|(
name|entry
operator|->
name|aa
argument_list|)
argument_list|,
name|network_ctx
argument_list|)
expr_stmt|;
name|wpa_sm_add_pmkid
argument_list|(
name|pmksa
operator|->
name|sm
argument_list|,
name|entry
operator|->
name|aa
argument_list|,
name|entry
operator|->
name|pmkid
argument_list|)
expr_stmt|;
return|return
name|entry
return|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_flush - Flush PMKSA cache entries for a specific network  * @pmksa: Pointer to PMKSA cache data from pmksa_cache_init()  * @network_ctx: Network configuration context or %NULL to flush all entries  */
end_comment

begin_function
name|void
name|pmksa_cache_flush
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|,
name|void
modifier|*
name|network_ctx
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|int
name|removed
init|=
literal|0
decl_stmt|;
name|entry
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
name|entry
operator|->
name|network_ctx
operator|==
name|network_ctx
operator|||
name|network_ctx
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Flush PMKSA cache entry "
literal|"for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|entry
operator|->
name|aa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|entry
operator|->
name|next
expr_stmt|;
else|else
name|pmksa
operator|->
name|pmksa
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|tmp
operator|=
name|entry
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|pmksa_cache_free_entry
argument_list|(
name|pmksa
argument_list|,
name|tmp
argument_list|,
name|PMKSA_FREE
argument_list|)
expr_stmt|;
name|removed
operator|++
expr_stmt|;
block|}
else|else
block|{
name|prev
operator|=
name|entry
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
block|}
if|if
condition|(
name|removed
condition|)
name|pmksa_cache_set_expiration
argument_list|(
name|pmksa
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_deinit - Free all entries in PMKSA cache  * @pmksa: Pointer to PMKSA cache data from pmksa_cache_init()  */
end_comment

begin_function
name|void
name|pmksa_cache_deinit
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|pmksa
operator|==
name|NULL
condition|)
return|return;
name|entry
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
name|pmksa
operator|->
name|pmksa
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
name|prev
operator|=
name|entry
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|pmksa_cache_set_expiration
argument_list|(
name|pmksa
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pmksa
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_get - Fetch a PMKSA cache entry  * @pmksa: Pointer to PMKSA cache data from pmksa_cache_init()  * @aa: Authenticator address or %NULL to match any  * @pmkid: PMKID or %NULL to match any  * @network_ctx: Network context or %NULL to match any  * Returns: Pointer to PMKSA cache entry or %NULL if no match was found  */
end_comment

begin_function
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa_cache_get
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|,
specifier|const
name|u8
modifier|*
name|aa
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|,
specifier|const
name|void
modifier|*
name|network_ctx
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
init|=
name|pmksa
operator|->
name|pmksa
decl_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
operator|(
name|aa
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|entry
operator|->
name|aa
argument_list|,
name|aa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|pmkid
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|entry
operator|->
name|pmkid
argument_list|,
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|network_ctx
operator|==
name|NULL
operator|||
name|network_ctx
operator|==
name|entry
operator|->
name|network_ctx
operator|)
condition|)
return|return
name|entry
return|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa_cache_clone_entry
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|,
specifier|const
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|old_entry
parameter_list|,
specifier|const
name|u8
modifier|*
name|aa
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|new_entry
decl_stmt|;
name|new_entry
operator|=
name|pmksa_cache_add
argument_list|(
name|pmksa
argument_list|,
name|old_entry
operator|->
name|pmk
argument_list|,
name|old_entry
operator|->
name|pmk_len
argument_list|,
name|aa
argument_list|,
name|pmksa
operator|->
name|sm
operator|->
name|own_addr
argument_list|,
name|old_entry
operator|->
name|network_ctx
argument_list|,
name|old_entry
operator|->
name|akmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_entry
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* TODO: reorder entries based on expiration time? */
name|new_entry
operator|->
name|expiration
operator|=
name|old_entry
operator|->
name|expiration
expr_stmt|;
name|new_entry
operator|->
name|opportunistic
operator|=
literal|1
expr_stmt|;
return|return
name|new_entry
return|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_get_opportunistic - Try to get an opportunistic PMKSA entry  * @pmksa: Pointer to PMKSA cache data from pmksa_cache_init()  * @network_ctx: Network configuration context  * @aa: Authenticator address for the new AP  * Returns: Pointer to a new PMKSA cache entry or %NULL if not available  *  * Try to create a new PMKSA cache entry opportunistically by guessing that the  * new AP is sharing the same PMK as another AP that has the same SSID and has  * already an entry in PMKSA cache.  */
end_comment

begin_function
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa_cache_get_opportunistic
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|,
name|void
modifier|*
name|network_ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|aa
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
init|=
name|pmksa
operator|->
name|pmksa
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Consider "
name|MACSTR
literal|" for OKC"
argument_list|,
name|MAC2STR
argument_list|(
name|aa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|network_ctx
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
while|while
condition|(
name|entry
condition|)
block|{
if|if
condition|(
name|entry
operator|->
name|network_ctx
operator|==
name|network_ctx
condition|)
block|{
name|entry
operator|=
name|pmksa_cache_clone_entry
argument_list|(
name|pmksa
argument_list|,
name|entry
argument_list|,
name|aa
argument_list|)
expr_stmt|;
if|if
condition|(
name|entry
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: added "
literal|"opportunistic PMKSA cache entry "
literal|"for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|aa
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|entry
return|;
block|}
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_get_current - Get the current used PMKSA entry  * @sm: Pointer to WPA state machine data from wpa_sm_init()  * Returns: Pointer to the current PMKSA cache entry or %NULL if not available  */
end_comment

begin_function
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa_cache_get_current
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
return|return
name|sm
operator|->
name|cur_pmksa
return|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_clear_current - Clear the current PMKSA entry selection  * @sm: Pointer to WPA state machine data from wpa_sm_init()  */
end_comment

begin_function
name|void
name|pmksa_cache_clear_current
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return;
name|sm
operator|->
name|cur_pmksa
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_set_current - Set the current PMKSA entry selection  * @sm: Pointer to WPA state machine data from wpa_sm_init()  * @pmkid: PMKID for selecting PMKSA or %NULL if not used  * @bssid: BSSID for PMKSA or %NULL if not used  * @network_ctx: Network configuration context  * @try_opportunistic: Whether to allow opportunistic PMKSA caching  * Returns: 0 if PMKSA was found or -1 if no matching entry was found  */
end_comment

begin_function
name|int
name|pmksa_cache_set_current
parameter_list|(
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|void
modifier|*
name|network_ctx
parameter_list|,
name|int
name|try_opportunistic
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
init|=
name|sm
operator|->
name|pmksa
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKSA cache search - network_ctx=%p "
literal|"try_opportunistic=%d"
argument_list|,
name|network_ctx
argument_list|,
name|try_opportunistic
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmkid
condition|)
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Search for PMKID"
argument_list|,
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|bssid
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Search for BSSID "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|sm
operator|->
name|cur_pmksa
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|pmkid
condition|)
name|sm
operator|->
name|cur_pmksa
operator|=
name|pmksa_cache_get
argument_list|(
name|pmksa
argument_list|,
name|NULL
argument_list|,
name|pmkid
argument_list|,
name|network_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|cur_pmksa
operator|==
name|NULL
operator|&&
name|bssid
condition|)
name|sm
operator|->
name|cur_pmksa
operator|=
name|pmksa_cache_get
argument_list|(
name|pmksa
argument_list|,
name|bssid
argument_list|,
name|NULL
argument_list|,
name|network_ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|cur_pmksa
operator|==
name|NULL
operator|&&
name|try_opportunistic
operator|&&
name|bssid
condition|)
name|sm
operator|->
name|cur_pmksa
operator|=
name|pmksa_cache_get_opportunistic
argument_list|(
name|pmksa
argument_list|,
name|network_ctx
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|cur_pmksa
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKSA cache entry found - PMKID"
argument_list|,
name|sm
operator|->
name|cur_pmksa
operator|->
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: No PMKSA cache entry found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_list - Dump text list of entries in PMKSA cache  * @pmksa: Pointer to PMKSA cache data from pmksa_cache_init()  * @buf: Buffer for the list  * @len: Length of the buffer  * Returns: number of bytes written to buffer  *  * This function is used to generate a text format representation of the  * current PMKSA cache contents for the ctrl_iface PMKSA command.  */
end_comment

begin_function
name|int
name|pmksa_cache_list
parameter_list|(
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|ret
decl_stmt|;
name|char
modifier|*
name|pos
init|=
name|buf
decl_stmt|;
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|buf
operator|+
name|len
operator|-
name|pos
argument_list|,
literal|"Index / AA / PMKID / expiration (in seconds) / "
literal|"opportunistic\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|buf
operator|+
name|len
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
name|entry
operator|=
name|pmksa
operator|->
name|pmksa
expr_stmt|;
while|while
condition|(
name|entry
condition|)
block|{
name|i
operator|++
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|buf
operator|+
name|len
operator|-
name|pos
argument_list|,
literal|"%d "
name|MACSTR
literal|" "
argument_list|,
name|i
argument_list|,
name|MAC2STR
argument_list|(
name|entry
operator|->
name|aa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|buf
operator|+
name|len
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
name|pos
argument_list|,
name|buf
operator|+
name|len
operator|-
name|pos
argument_list|,
name|entry
operator|->
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|buf
operator|+
name|len
operator|-
name|pos
argument_list|,
literal|" %d %d\n"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|entry
operator|->
name|expiration
operator|-
name|now
operator|.
name|sec
argument_list|)
argument_list|,
name|entry
operator|->
name|opportunistic
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|buf
operator|+
name|len
operator|-
name|pos
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
name|entry
operator|=
name|entry
operator|->
name|next
expr_stmt|;
block|}
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_comment
comment|/**  * pmksa_cache_init - Initialize PMKSA cache  * @free_cb: Callback function to be called when a PMKSA cache entry is freed  * @ctx: Context pointer for free_cb function  * @sm: Pointer to WPA state machine data from wpa_sm_init()  * Returns: Pointer to PMKSA cache data or %NULL on failure  */
end_comment

begin_function
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa_cache_init
parameter_list|(
name|void
function_decl|(
modifier|*
name|free_cb
function_decl|)
parameter_list|(
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|entry
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|pmksa_free_reason
name|reason
parameter_list|)
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|wpa_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|rsn_pmksa_cache
modifier|*
name|pmksa
decl_stmt|;
name|pmksa
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pmksa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmksa
condition|)
block|{
name|pmksa
operator|->
name|free_cb
operator|=
name|free_cb
expr_stmt|;
name|pmksa
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|pmksa
operator|->
name|sm
operator|=
name|sm
expr_stmt|;
block|}
return|return
name|pmksa
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* IEEE8021X_EAPOL and !CONFIG_NO_WPA2 */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * RADIUS Dynamic Authorization Server (DAS) (RFC 5176)  * Copyright (c) 2012, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"utils/ip_addr.h"
end_include

begin_include
include|#
directive|include
file|"radius.h"
end_include

begin_include
include|#
directive|include
file|"radius_das.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|radius_das_data
block|{
name|int
name|sock
decl_stmt|;
name|u8
modifier|*
name|shared_secret
decl_stmt|;
name|size_t
name|shared_secret_len
decl_stmt|;
name|struct
name|hostapd_ip_addr
name|client_addr
decl_stmt|;
name|unsigned
name|int
name|time_window
decl_stmt|;
name|int
name|require_event_timestamp
decl_stmt|;
name|void
modifier|*
name|ctx
decl_stmt|;
name|enum
name|radius_das_res
function_decl|(
modifier|*
name|disconnect
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|radius_das_attrs
modifier|*
name|attr
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|struct
name|radius_msg
modifier|*
name|radius_das_disconnect
parameter_list|(
name|struct
name|radius_das_data
modifier|*
name|das
parameter_list|,
name|struct
name|radius_msg
modifier|*
name|msg
parameter_list|,
specifier|const
name|char
modifier|*
name|abuf
parameter_list|,
name|int
name|from_port
parameter_list|)
block|{
name|struct
name|radius_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|radius_msg
modifier|*
name|reply
decl_stmt|;
name|u8
name|allowed
index|[]
init|=
block|{
name|RADIUS_ATTR_USER_NAME
block|,
name|RADIUS_ATTR_CALLING_STATION_ID
block|,
name|RADIUS_ATTR_ACCT_SESSION_ID
block|,
name|RADIUS_ATTR_EVENT_TIMESTAMP
block|,
name|RADIUS_ATTR_MESSAGE_AUTHENTICATOR
block|,
name|RADIUS_ATTR_CHARGEABLE_USER_IDENTITY
block|,
literal|0
block|}
decl_stmt|;
name|int
name|error
init|=
literal|405
decl_stmt|;
name|u8
name|attr
decl_stmt|;
name|enum
name|radius_das_res
name|res
decl_stmt|;
name|struct
name|radius_das_attrs
name|attrs
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|char
name|tmp
index|[
literal|100
index|]
decl_stmt|;
name|u8
name|sta_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|hdr
operator|=
name|radius_msg_get_hdr
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|attr
operator|=
name|radius_msg_find_unlisted_attr
argument_list|(
name|msg
argument_list|,
name|allowed
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"DAS: Unsupported attribute %u in "
literal|"Disconnect-Request from %s:%d"
argument_list|,
name|attr
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
name|error
operator|=
literal|401
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_memset
argument_list|(
operator|&
name|attrs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|attrs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|radius_msg_get_attr_ptr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_CALLING_STATION_ID
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|len
operator|>=
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
condition|)
name|len
operator|=
sizeof|sizeof
argument_list|(
name|tmp
argument_list|)
operator|-
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|tmp
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|tmp
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|hwaddr_aton2
argument_list|(
name|tmp
argument_list|,
name|sta_addr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"DAS: Invalid Calling-Station-Id "
literal|"'%s' from %s:%d"
argument_list|,
name|tmp
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
name|error
operator|=
literal|407
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|attrs
operator|.
name|sta_addr
operator|=
name|sta_addr
expr_stmt|;
block|}
if|if
condition|(
name|radius_msg_get_attr_ptr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_USER_NAME
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|attrs
operator|.
name|user_name
operator|=
name|buf
expr_stmt|;
name|attrs
operator|.
name|user_name_len
operator|=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|radius_msg_get_attr_ptr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_ACCT_SESSION_ID
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|attrs
operator|.
name|acct_session_id
operator|=
name|buf
expr_stmt|;
name|attrs
operator|.
name|acct_session_id_len
operator|=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|radius_msg_get_attr_ptr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_CHARGEABLE_USER_IDENTITY
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|)
operator|==
literal|0
condition|)
block|{
name|attrs
operator|.
name|cui
operator|=
name|buf
expr_stmt|;
name|attrs
operator|.
name|cui_len
operator|=
name|len
expr_stmt|;
block|}
name|res
operator|=
name|das
operator|->
name|disconnect
argument_list|(
name|das
operator|->
name|ctx
argument_list|,
operator|&
name|attrs
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|res
condition|)
block|{
case|case
name|RADIUS_DAS_NAS_MISMATCH
case|:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"DAS: NAS mismatch from %s:%d"
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
name|error
operator|=
literal|403
expr_stmt|;
break|break;
case|case
name|RADIUS_DAS_SESSION_NOT_FOUND
case|:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"DAS: Session not found for request from "
literal|"%s:%d"
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
name|error
operator|=
literal|503
expr_stmt|;
break|break;
case|case
name|RADIUS_DAS_SUCCESS
case|:
name|error
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|fail
label|:
name|reply
operator|=
name|radius_msg_new
argument_list|(
name|error
condition|?
name|RADIUS_CODE_DISCONNECT_NAK
else|:
name|RADIUS_CODE_DISCONNECT_ACK
argument_list|,
name|hdr
operator|->
name|identifier
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|error
condition|)
block|{
if|if
condition|(
operator|!
name|radius_msg_add_attr_int32
argument_list|(
name|reply
argument_list|,
name|RADIUS_ATTR_ERROR_CAUSE
argument_list|,
name|error
argument_list|)
condition|)
block|{
name|radius_msg_free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
return|return
name|reply
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|radius_das_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|radius_das_data
modifier|*
name|das
init|=
name|eloop_ctx
decl_stmt|;
name|u8
name|buf
index|[
literal|1500
index|]
decl_stmt|;
union|union
block|{
name|struct
name|sockaddr_storage
name|ss
decl_stmt|;
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IPV6
name|struct
name|sockaddr_in6
name|sin6
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IPV6 */
block|}
name|from
union|;
name|char
name|abuf
index|[
literal|50
index|]
decl_stmt|;
name|int
name|from_port
init|=
literal|0
decl_stmt|;
name|socklen_t
name|fromlen
decl_stmt|;
name|int
name|len
decl_stmt|;
name|struct
name|radius_msg
modifier|*
name|msg
decl_stmt|,
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|struct
name|radius_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|rbuf
decl_stmt|;
name|u32
name|val
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|fromlen
operator|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
expr_stmt|;
name|len
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
operator|.
name|ss
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"DAS: recvfrom: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_strlcpy
argument_list|(
name|abuf
argument_list|,
name|inet_ntoa
argument_list|(
name|from
operator|.
name|sin
operator|.
name|sin_addr
argument_list|)
argument_list|,
sizeof|sizeof
argument_list|(
name|abuf
argument_list|)
argument_list|)
expr_stmt|;
name|from_port
operator|=
name|ntohs
argument_list|(
name|from
operator|.
name|sin
operator|.
name|sin_port
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DAS: Received %d bytes from %s:%d"
argument_list|,
name|len
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
if|if
condition|(
name|das
operator|->
name|client_addr
operator|.
name|u
operator|.
name|v4
operator|.
name|s_addr
operator|!=
name|from
operator|.
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DAS: Drop message from unknown client"
argument_list|)
expr_stmt|;
return|return;
block|}
name|msg
operator|=
name|radius_msg_parse
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DAS: Parsing incoming RADIUS packet "
literal|"from %s:%d failed"
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_debug_level
operator|<=
name|MSG_MSGDUMP
condition|)
name|radius_msg_dump
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|radius_msg_verify_das_req
argument_list|(
name|msg
argument_list|,
name|das
operator|->
name|shared_secret
argument_list|,
name|das
operator|->
name|shared_secret_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DAS: Invalid authenticator in packet "
literal|"from %s:%d - drop"
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|res
operator|=
name|radius_msg_get_attr
argument_list|(
name|msg
argument_list|,
name|RADIUS_ATTR_EVENT_TIMESTAMP
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|val
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|4
condition|)
block|{
name|u32
name|timestamp
init|=
name|ntohl
argument_list|(
name|val
argument_list|)
decl_stmt|;
if|if
condition|(
name|abs
argument_list|(
name|now
operator|.
name|sec
operator|-
name|timestamp
argument_list|)
operator|>
name|das
operator|->
name|time_window
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DAS: Unacceptable "
literal|"Event-Timestamp (%u; local time %u) in "
literal|"packet from %s:%d - drop"
argument_list|,
name|timestamp
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|now
operator|.
name|sec
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|das
operator|->
name|require_event_timestamp
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DAS: Missing Event-Timestamp in packet "
literal|"from %s:%d - drop"
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|hdr
operator|=
name|radius_msg_get_hdr
argument_list|(
name|msg
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|hdr
operator|->
name|code
condition|)
block|{
case|case
name|RADIUS_CODE_DISCONNECT_REQUEST
case|:
name|reply
operator|=
name|radius_das_disconnect
argument_list|(
name|das
argument_list|,
name|msg
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
break|break;
case|case
name|RADIUS_CODE_COA_REQUEST
case|:
comment|/* TODO */
name|reply
operator|=
name|radius_msg_new
argument_list|(
name|RADIUS_CODE_COA_NAK
argument_list|,
name|hdr
operator|->
name|identifier
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
break|break;
comment|/* Unsupported Service */
if|if
condition|(
operator|!
name|radius_msg_add_attr_int32
argument_list|(
name|reply
argument_list|,
name|RADIUS_ATTR_ERROR_CAUSE
argument_list|,
literal|405
argument_list|)
condition|)
block|{
name|radius_msg_free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|reply
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DAS: Unexpected RADIUS code %u in "
literal|"packet from %s:%d"
argument_list|,
name|hdr
operator|->
name|code
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|reply
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DAS: Reply to %s:%d"
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|radius_msg_add_attr_int32
argument_list|(
name|reply
argument_list|,
name|RADIUS_ATTR_EVENT_TIMESTAMP
argument_list|,
name|now
operator|.
name|sec
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DAS: Failed to add "
literal|"Event-Timestamp attribute"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|radius_msg_finish_das_resp
argument_list|(
name|reply
argument_list|,
name|das
operator|->
name|shared_secret
argument_list|,
name|das
operator|->
name|shared_secret_len
argument_list|,
name|hdr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DAS: Failed to add "
literal|"Message-Authenticator attribute"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_debug_level
operator|<=
name|MSG_MSGDUMP
condition|)
name|radius_msg_dump
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|rbuf
operator|=
name|radius_msg_get_buf
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|res
operator|=
name|sendto
argument_list|(
name|das
operator|->
name|sock
argument_list|,
name|wpabuf_head
argument_list|(
name|rbuf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|rbuf
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
operator|.
name|ss
argument_list|,
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"DAS: sendto(to %s:%d): %s"
argument_list|,
name|abuf
argument_list|,
name|from_port
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|fail
label|:
name|radius_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|radius_msg_free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|radius_das_open_socket
parameter_list|(
name|int
name|port
parameter_list|)
block|{
name|int
name|s
decl_stmt|;
name|struct
name|sockaddr_in
name|addr
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|addr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|s
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"bind"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|s
return|;
block|}
end_function

begin_function
name|struct
name|radius_das_data
modifier|*
name|radius_das_init
parameter_list|(
name|struct
name|radius_das_conf
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|radius_das_data
modifier|*
name|das
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|port
operator|==
literal|0
operator|||
name|conf
operator|->
name|shared_secret
operator|==
name|NULL
operator|||
name|conf
operator|->
name|client_addr
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|das
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|das
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|das
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|das
operator|->
name|time_window
operator|=
name|conf
operator|->
name|time_window
expr_stmt|;
name|das
operator|->
name|require_event_timestamp
operator|=
name|conf
operator|->
name|require_event_timestamp
expr_stmt|;
name|das
operator|->
name|ctx
operator|=
name|conf
operator|->
name|ctx
expr_stmt|;
name|das
operator|->
name|disconnect
operator|=
name|conf
operator|->
name|disconnect
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|das
operator|->
name|client_addr
argument_list|,
name|conf
operator|->
name|client_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|das
operator|->
name|client_addr
argument_list|)
argument_list|)
expr_stmt|;
name|das
operator|->
name|shared_secret
operator|=
name|os_malloc
argument_list|(
name|conf
operator|->
name|shared_secret_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|das
operator|->
name|shared_secret
operator|==
name|NULL
condition|)
block|{
name|radius_das_deinit
argument_list|(
name|das
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|das
operator|->
name|shared_secret
argument_list|,
name|conf
operator|->
name|shared_secret
argument_list|,
name|conf
operator|->
name|shared_secret_len
argument_list|)
expr_stmt|;
name|das
operator|->
name|shared_secret_len
operator|=
name|conf
operator|->
name|shared_secret_len
expr_stmt|;
name|das
operator|->
name|sock
operator|=
name|radius_das_open_socket
argument_list|(
name|conf
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|das
operator|->
name|sock
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to open UDP socket for RADIUS "
literal|"DAS"
argument_list|)
expr_stmt|;
name|radius_das_deinit
argument_list|(
name|das
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|eloop_register_read_sock
argument_list|(
name|das
operator|->
name|sock
argument_list|,
name|radius_das_receive
argument_list|,
name|das
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|radius_das_deinit
argument_list|(
name|das
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|das
return|;
block|}
end_function

begin_function
name|void
name|radius_das_deinit
parameter_list|(
name|struct
name|radius_das_data
modifier|*
name|das
parameter_list|)
block|{
if|if
condition|(
name|das
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|das
operator|->
name|sock
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|das
operator|->
name|sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|das
operator|->
name|sock
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|das
operator|->
name|shared_secret
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|das
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - privilege separated driver interface  * Copyright (c) 2007-2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/privsep_commands.h"
end_include

begin_struct
struct|struct
name|wpa_driver_privsep_data
block|{
name|void
modifier|*
name|ctx
decl_stmt|;
name|u8
name|own_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|priv_socket
decl_stmt|;
name|char
modifier|*
name|own_socket_path
decl_stmt|;
name|int
name|cmd_socket
decl_stmt|;
name|char
modifier|*
name|own_cmd_path
decl_stmt|;
name|struct
name|sockaddr_un
name|priv_addr
decl_stmt|;
name|char
name|ifname
index|[
literal|16
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wpa_priv_reg_cmd
parameter_list|(
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
parameter_list|,
name|int
name|cmd
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|sendto
argument_list|(
name|drv
operator|->
name|priv_socket
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|drv
operator|->
name|priv_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|priv_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"sendto"
argument_list|)
expr_stmt|;
return|return
name|res
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_priv_cmd
parameter_list|(
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
parameter_list|,
name|int
name|cmd
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|void
modifier|*
name|reply
parameter_list|,
name|size_t
modifier|*
name|reply_len
parameter_list|)
block|{
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|2
index|]
decl_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
operator|&
name|cmd
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|u8
operator|*
operator|)
name|data
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|data_len
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
name|data
condition|?
literal|2
else|:
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|drv
operator|->
name|priv_addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|priv_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendmsg
argument_list|(
name|drv
operator|->
name|cmd_socket
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendmsg(cmd_socket)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|reply
condition|)
block|{
name|fd_set
name|rfds
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|int
name|res
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|rfds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|drv
operator|->
name|cmd_socket
argument_list|,
operator|&
name|rfds
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
literal|5
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|res
operator|=
name|select
argument_list|(
name|drv
operator|->
name|cmd_socket
operator|+
literal|1
argument_list|,
operator|&
name|rfds
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|&&
name|errno
operator|!=
name|EINTR
condition|)
block|{
name|perror
argument_list|(
literal|"select"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|FD_ISSET
argument_list|(
name|drv
operator|->
name|cmd_socket
argument_list|,
operator|&
name|rfds
argument_list|)
condition|)
block|{
name|res
operator|=
name|recv
argument_list|(
name|drv
operator|->
name|cmd_socket
argument_list|,
name|reply
argument_list|,
operator|*
name|reply_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recv"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|reply_len
operator|=
name|res
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PRIVSEP: Timeout while waiting "
literal|"for reply (cmd=%d)"
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_privsep_scan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ssid
init|=
name|params
operator|->
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
decl_stmt|;
name|size_t
name|ssid_len
init|=
name|params
operator|->
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: priv=%p"
argument_list|,
name|__func__
argument_list|,
name|priv
argument_list|)
expr_stmt|;
return|return
name|wpa_priv_cmd
argument_list|(
name|drv
argument_list|,
name|PRIVSEP_CMD_SCAN
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_scan_results
modifier|*
name|wpa_driver_privsep_get_scan_results2
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|res
decl_stmt|,
name|num
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|reply_len
init|=
literal|60000
decl_stmt|;
name|struct
name|wpa_scan_results
modifier|*
name|results
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|r
decl_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|reply_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|res
operator|=
name|wpa_priv_cmd
argument_list|(
name|drv
argument_list|,
name|PRIVSEP_CMD_GET_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|buf
argument_list|,
operator|&
name|reply_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"privsep: Received %lu bytes of scan results"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|reply_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply_len
operator|<
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"privsep: Invalid scan result len %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|reply_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|reply_len
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|num
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|num
operator|<
literal|0
operator|||
name|num
operator|>
literal|1000
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|results
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|results
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|results
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|results
operator|->
name|res
operator|=
name|os_calloc
argument_list|(
name|num
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_res
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|results
operator|->
name|res
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|results
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
while|while
condition|(
name|results
operator|->
name|num
operator|<
operator|(
name|size_t
operator|)
name|num
operator|&&
name|pos
operator|+
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|<
name|end
condition|)
block|{
name|int
name|len
decl_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|len
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>
literal|10000
operator|||
name|pos
operator|+
name|len
operator|>
name|end
condition|)
break|break;
name|r
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|r
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|len
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
operator|+
name|r
operator|->
name|ie_len
operator|>
operator|(
name|size_t
operator|)
name|len
condition|)
block|{
name|os_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
break|break;
block|}
name|results
operator|->
name|res
index|[
name|results
operator|->
name|num
operator|++
index|]
operator|=
name|r
expr_stmt|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|results
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_privsep_set_key
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|key_idx
parameter_list|,
name|int
name|set_tx
parameter_list|,
specifier|const
name|u8
modifier|*
name|seq
parameter_list|,
name|size_t
name|seq_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|privsep_cmd_set_key
name|cmd
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: priv=%p alg=%d key_idx=%d set_tx=%d"
argument_list|,
name|__func__
argument_list|,
name|priv
argument_list|,
name|alg
argument_list|,
name|key_idx
argument_list|,
name|set_tx
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|alg
operator|=
name|alg
expr_stmt|;
if|if
condition|(
name|addr
condition|)
name|os_memcpy
argument_list|(
name|cmd
operator|.
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|os_memset
argument_list|(
name|cmd
operator|.
name|addr
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|key_idx
operator|=
name|key_idx
expr_stmt|;
name|cmd
operator|.
name|set_tx
operator|=
name|set_tx
expr_stmt|;
if|if
condition|(
name|seq
operator|&&
name|seq_len
operator|>
literal|0
operator|&&
name|seq_len
operator|<
sizeof|sizeof
argument_list|(
name|cmd
operator|.
name|seq
argument_list|)
condition|)
block|{
name|os_memcpy
argument_list|(
name|cmd
operator|.
name|seq
argument_list|,
name|seq
argument_list|,
name|seq_len
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|seq_len
operator|=
name|seq_len
expr_stmt|;
block|}
if|if
condition|(
name|key
operator|&&
name|key_len
operator|>
literal|0
operator|&&
name|key_len
operator|<
sizeof|sizeof
argument_list|(
name|cmd
operator|.
name|key
argument_list|)
condition|)
block|{
name|os_memcpy
argument_list|(
name|cmd
operator|.
name|key
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|cmd
operator|.
name|key_len
operator|=
name|key_len
expr_stmt|;
block|}
return|return
name|wpa_priv_cmd
argument_list|(
name|drv
argument_list|,
name|PRIVSEP_CMD_SET_KEY
argument_list|,
operator|&
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_privsep_associate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|struct
name|privsep_cmd_associate
modifier|*
name|data
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|buflen
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: priv=%p freq=%d pairwise_suite=%d "
literal|"group_suite=%d key_mgmt_suite=%d auth_alg=%d mode=%d"
argument_list|,
name|__func__
argument_list|,
name|priv
argument_list|,
name|params
operator|->
name|freq
argument_list|,
name|params
operator|->
name|pairwise_suite
argument_list|,
name|params
operator|->
name|group_suite
argument_list|,
name|params
operator|->
name|key_mgmt_suite
argument_list|,
name|params
operator|->
name|auth_alg
argument_list|,
name|params
operator|->
name|mode
argument_list|)
expr_stmt|;
name|buflen
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
operator|+
name|params
operator|->
name|wpa_ie_len
expr_stmt|;
name|data
operator|=
name|os_zalloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|->
name|bssid
condition|)
name|os_memcpy
argument_list|(
name|data
operator|->
name|bssid
argument_list|,
name|params
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
name|data
operator|->
name|freq
operator|=
name|params
operator|->
name|freq
expr_stmt|;
name|data
operator|->
name|pairwise_suite
operator|=
name|params
operator|->
name|pairwise_suite
expr_stmt|;
name|data
operator|->
name|group_suite
operator|=
name|params
operator|->
name|group_suite
expr_stmt|;
name|data
operator|->
name|key_mgmt_suite
operator|=
name|params
operator|->
name|key_mgmt_suite
expr_stmt|;
name|data
operator|->
name|auth_alg
operator|=
name|params
operator|->
name|auth_alg
expr_stmt|;
name|data
operator|->
name|mode
operator|=
name|params
operator|->
name|mode
expr_stmt|;
name|data
operator|->
name|wpa_ie_len
operator|=
name|params
operator|->
name|wpa_ie_len
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_ie
condition|)
name|os_memcpy
argument_list|(
name|data
operator|+
literal|1
argument_list|,
name|params
operator|->
name|wpa_ie
argument_list|,
name|params
operator|->
name|wpa_ie_len
argument_list|)
expr_stmt|;
comment|/* TODO: add support for other assoc parameters */
name|res
operator|=
name|wpa_priv_cmd
argument_list|(
name|drv
argument_list|,
name|PRIVSEP_CMD_ASSOCIATE
argument_list|,
name|data
argument_list|,
name|buflen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_privsep_get_bssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|len
init|=
name|ETH_ALEN
decl_stmt|;
name|res
operator|=
name|wpa_priv_cmd
argument_list|(
name|drv
argument_list|,
name|PRIVSEP_CMD_GET_BSSID
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|bssid
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|||
name|len
operator|!=
name|ETH_ALEN
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_privsep_get_ssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|res
decl_stmt|,
name|ssid_len
decl_stmt|;
name|u8
name|reply
index|[
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
literal|32
index|]
decl_stmt|;
name|size_t
name|len
init|=
sizeof|sizeof
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|res
operator|=
name|wpa_priv_cmd
argument_list|(
name|drv
argument_list|,
name|PRIVSEP_CMD_GET_SSID
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|reply
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|||
name|len
operator|<
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
operator|&
name|ssid_len
argument_list|,
name|reply
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid_len
operator|<
literal|0
operator|||
name|ssid_len
operator|>
literal|32
operator|||
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
name|ssid_len
operator|>
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"privsep: Invalid get SSID reply"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|ssid
argument_list|,
operator|&
name|reply
index|[
sizeof|sizeof
argument_list|(
name|int
argument_list|)
index|]
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
return|return
name|ssid_len
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_privsep_deauthenticate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
comment|//struct wpa_driver_privsep_data *drv = priv;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s addr="
name|MACSTR
literal|" reason_code=%d"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|reason_code
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - TODO"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_privsep_event_assoc
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|wpa_event_type
name|event
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|int
name|inc_data
init|=
literal|0
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|ie_len
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
return|return;
name|os_memcpy
argument_list|(
operator|&
name|ie_len
argument_list|,
name|pos
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie_len
operator|<
literal|0
operator|||
name|ie_len
operator|>
name|end
operator|-
name|pos
condition|)
return|return;
if|if
condition|(
name|ie_len
condition|)
block|{
name|data
operator|.
name|assoc_info
operator|.
name|req_ies
operator|=
name|pos
expr_stmt|;
name|data
operator|.
name|assoc_info
operator|.
name|req_ies_len
operator|=
name|ie_len
expr_stmt|;
name|pos
operator|+=
name|ie_len
expr_stmt|;
name|inc_data
operator|=
literal|1
expr_stmt|;
block|}
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|event
argument_list|,
name|inc_data
condition|?
operator|&
name|data
else|:
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_privsep_event_interface_status
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
name|int
name|ievent
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|||
name|len
operator|-
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|>
sizeof|sizeof
argument_list|(
name|data
operator|.
name|interface_status
operator|.
name|ifname
argument_list|)
condition|)
return|return;
name|os_memcpy
argument_list|(
operator|&
name|ievent
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|interface_status
operator|.
name|ievent
operator|=
name|ievent
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|interface_status
operator|.
name|ifname
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
name|len
operator|-
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_INTERFACE_STATUS
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_privsep_event_michael_mic_failure
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|data
operator|.
name|michael_mic_failure
operator|.
name|unicast
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_MICHAEL_MIC_FAILURE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_privsep_event_pmkid_candidate
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|pmkid_candidate
argument_list|)
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|data
operator|.
name|pmkid_candidate
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_PMKID_CANDIDATE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_privsep_event_stkstart
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
if|if
condition|(
name|len
operator|!=
name|ETH_ALEN
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|stkstart
operator|.
name|peer
argument_list|,
name|buf
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_STKSTART
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_privsep_event_ft_response
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|union
name|wpa_event_data
name|data
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
name|ETH_ALEN
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|data
operator|.
name|ft_ies
operator|.
name|ft_action
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|.
name|ft_ies
operator|.
name|target_ap
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|data
operator|.
name|ft_ies
operator|.
name|ies
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
name|ETH_ALEN
expr_stmt|;
name|data
operator|.
name|ft_ies
operator|.
name|ies_len
operator|=
name|len
operator|-
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|-
name|ETH_ALEN
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_FT_RESPONSE
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_privsep_event_rx_eapol
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|len
operator|<
name|ETH_ALEN
condition|)
return|return;
name|drv_event_eapol_rx
argument_list|(
name|ctx
argument_list|,
name|buf
argument_list|,
name|buf
operator|+
name|ETH_ALEN
argument_list|,
name|len
operator|-
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_privsep_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|event_buf
decl_stmt|;
name|size_t
name|event_len
decl_stmt|;
name|int
name|res
decl_stmt|,
name|event
decl_stmt|;
name|enum
name|privsep_event
name|e
decl_stmt|;
name|struct
name|sockaddr_un
name|from
decl_stmt|;
name|socklen_t
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
decl_stmt|;
specifier|const
name|size_t
name|buflen
init|=
literal|2000
decl_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|res
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom(priv_socket)"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"privsep_driver: received %u bytes"
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Too short event message (len=%d)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
operator|&
name|event
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|event_buf
operator|=
operator|&
name|buf
index|[
sizeof|sizeof
argument_list|(
name|int
argument_list|)
index|]
expr_stmt|;
name|event_len
operator|=
name|res
operator|-
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"privsep: Event %d received (len=%lu)"
argument_list|,
name|event
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|event_len
argument_list|)
expr_stmt|;
name|e
operator|=
name|event
expr_stmt|;
switch|switch
condition|(
name|e
condition|)
block|{
case|case
name|PRIVSEP_EVENT_SCAN_RESULTS
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_EVENT_ASSOC
case|:
name|wpa_driver_privsep_event_assoc
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOC
argument_list|,
name|event_buf
argument_list|,
name|event_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_EVENT_DISASSOC
case|:
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_EVENT_ASSOCINFO
case|:
name|wpa_driver_privsep_event_assoc
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_ASSOCINFO
argument_list|,
name|event_buf
argument_list|,
name|event_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_EVENT_MICHAEL_MIC_FAILURE
case|:
name|wpa_driver_privsep_event_michael_mic_failure
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|event_buf
argument_list|,
name|event_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_EVENT_INTERFACE_STATUS
case|:
name|wpa_driver_privsep_event_interface_status
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|event_buf
argument_list|,
name|event_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_EVENT_PMKID_CANDIDATE
case|:
name|wpa_driver_privsep_event_pmkid_candidate
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|event_buf
argument_list|,
name|event_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_EVENT_STKSTART
case|:
name|wpa_driver_privsep_event_stkstart
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|event_buf
argument_list|,
name|event_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_EVENT_FT_RESPONSE
case|:
name|wpa_driver_privsep_event_ft_response
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|event_buf
argument_list|,
name|event_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_EVENT_RX_EAPOL
case|:
name|wpa_driver_privsep_event_rx_eapol
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|event_buf
argument_list|,
name|event_len
argument_list|)
expr_stmt|;
break|break;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|wpa_driver_privsep_init
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
decl_stmt|;
name|drv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|drv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|drv
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|drv
operator|->
name|priv_socket
operator|=
operator|-
literal|1
expr_stmt|;
name|drv
operator|->
name|cmd_socket
operator|=
operator|-
literal|1
expr_stmt|;
name|os_strlcpy
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|drv
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_privsep_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|priv_socket
operator|>=
literal|0
condition|)
block|{
name|wpa_priv_reg_cmd
argument_list|(
name|drv
argument_list|,
name|PRIVSEP_CMD_UNREGISTER
argument_list|)
expr_stmt|;
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|priv_socket
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|priv_socket
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|own_socket_path
condition|)
block|{
name|unlink
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|cmd_socket
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|cmd_socket
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|cmd_socket
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|own_cmd_path
condition|)
block|{
name|unlink
argument_list|(
name|drv
operator|->
name|own_cmd_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|own_cmd_path
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_privsep_set_param
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|param
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|char
modifier|*
name|own_dir
decl_stmt|,
modifier|*
name|priv_dir
decl_stmt|;
specifier|static
name|unsigned
name|int
name|counter
init|=
literal|0
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: param='%s'"
argument_list|,
name|__func__
argument_list|,
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
name|param
operator|==
name|NULL
condition|)
name|pos
operator|=
name|NULL
expr_stmt|;
else|else
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"own_dir="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
name|own_dir
operator|=
name|os_strdup
argument_list|(
name|pos
operator|+
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|own_dir
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|end
operator|=
name|os_strchr
argument_list|(
name|own_dir
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|own_dir
operator|=
name|os_strdup
argument_list|(
literal|"/tmp"
argument_list|)
expr_stmt|;
if|if
condition|(
name|own_dir
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|param
operator|==
name|NULL
condition|)
name|pos
operator|=
name|NULL
expr_stmt|;
else|else
name|pos
operator|=
name|os_strstr
argument_list|(
name|param
argument_list|,
literal|"priv_dir="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|char
modifier|*
name|end
decl_stmt|;
name|priv_dir
operator|=
name|os_strdup
argument_list|(
name|pos
operator|+
literal|9
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv_dir
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|own_dir
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|=
name|os_strchr
argument_list|(
name|priv_dir
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|priv_dir
operator|=
name|os_strdup
argument_list|(
literal|"/var/run/wpa_priv"
argument_list|)
expr_stmt|;
if|if
condition|(
name|priv_dir
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|own_dir
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|len
operator|=
name|os_strlen
argument_list|(
name|own_dir
argument_list|)
operator|+
literal|50
expr_stmt|;
name|drv
operator|->
name|own_socket_path
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|own_socket_path
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|priv_dir
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|own_dir
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_snprintf
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|,
name|len
argument_list|,
literal|"%s/wpa_privsep-%d-%d"
argument_list|,
name|own_dir
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|counter
operator|++
argument_list|)
expr_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|own_dir
argument_list|)
operator|+
literal|50
expr_stmt|;
name|drv
operator|->
name|own_cmd_path
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|own_cmd_path
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|drv
operator|->
name|own_socket_path
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|priv_dir
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|own_dir
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_snprintf
argument_list|(
name|drv
operator|->
name|own_cmd_path
argument_list|,
name|len
argument_list|,
literal|"%s/wpa_privsep-%d-%d"
argument_list|,
name|own_dir
argument_list|,
name|getpid
argument_list|()
argument_list|,
name|counter
operator|++
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|own_dir
argument_list|)
expr_stmt|;
name|drv
operator|->
name|priv_addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_snprintf
argument_list|(
name|drv
operator|->
name|priv_addr
operator|.
name|sun_path
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|priv_addr
operator|.
name|sun_path
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|priv_dir
argument_list|,
name|drv
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|priv_dir
argument_list|)
expr_stmt|;
name|drv
operator|->
name|priv_socket
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|priv_socket
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_UNIX)"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|drv
operator|->
name|own_socket_path
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_strlcpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|drv
operator|->
name|own_socket_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|drv
operator|->
name|priv_socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"privsep-set-params priv-sock: bind(PF_UNIX)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|priv_socket
argument_list|)
expr_stmt|;
name|drv
operator|->
name|priv_socket
operator|=
operator|-
literal|1
expr_stmt|;
name|unlink
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|own_socket_path
argument_list|)
expr_stmt|;
name|drv
operator|->
name|own_socket_path
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|priv_socket
argument_list|,
name|wpa_driver_privsep_receive
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|drv
operator|->
name|cmd_socket
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|cmd_socket
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_UNIX)"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|own_cmd_path
argument_list|)
expr_stmt|;
name|drv
operator|->
name|own_cmd_path
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_strlcpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|drv
operator|->
name|own_cmd_path
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|drv
operator|->
name|cmd_socket
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"privsep-set-params cmd-sock: bind(PF_UNIX)"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|cmd_socket
argument_list|)
expr_stmt|;
name|drv
operator|->
name|cmd_socket
operator|=
operator|-
literal|1
expr_stmt|;
name|unlink
argument_list|(
name|drv
operator|->
name|own_cmd_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
operator|->
name|own_cmd_path
argument_list|)
expr_stmt|;
name|drv
operator|->
name|own_cmd_path
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_priv_reg_cmd
argument_list|(
name|drv
argument_list|,
name|PRIVSEP_CMD_REGISTER
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to register with wpa_priv"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_privsep_get_capa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_capa
modifier|*
name|capa
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|len
init|=
sizeof|sizeof
argument_list|(
operator|*
name|capa
argument_list|)
decl_stmt|;
name|res
operator|=
name|wpa_priv_cmd
argument_list|(
name|drv
argument_list|,
name|PRIVSEP_CMD_GET_CAPA
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|capa
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|||
name|len
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|capa
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|wpa_driver_privsep_get_mac_addr
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|drv
operator|->
name|own_addr
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_privsep_set_country
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|char
modifier|*
name|alpha2
parameter_list|)
block|{
name|struct
name|wpa_driver_privsep_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s country='%s'"
argument_list|,
name|__func__
argument_list|,
name|alpha2
argument_list|)
expr_stmt|;
return|return
name|wpa_priv_cmd
argument_list|(
name|drv
argument_list|,
name|PRIVSEP_CMD_SET_COUNTRY
argument_list|,
name|alpha2
argument_list|,
name|os_strlen
argument_list|(
name|alpha2
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_decl_stmt
name|struct
name|wpa_driver_ops
name|wpa_driver_privsep_ops
init|=
block|{
literal|"privsep"
block|,
literal|"wpa_supplicant privilege separated driver"
block|,
operator|.
name|get_bssid
operator|=
name|wpa_driver_privsep_get_bssid
block|,
operator|.
name|get_ssid
operator|=
name|wpa_driver_privsep_get_ssid
block|,
operator|.
name|set_key
operator|=
name|wpa_driver_privsep_set_key
block|,
operator|.
name|init
operator|=
name|wpa_driver_privsep_init
block|,
operator|.
name|deinit
operator|=
name|wpa_driver_privsep_deinit
block|,
operator|.
name|set_param
operator|=
name|wpa_driver_privsep_set_param
block|,
operator|.
name|scan2
operator|=
name|wpa_driver_privsep_scan
block|,
operator|.
name|deauthenticate
operator|=
name|wpa_driver_privsep_deauthenticate
block|,
operator|.
name|associate
operator|=
name|wpa_driver_privsep_associate
block|,
operator|.
name|get_capa
operator|=
name|wpa_driver_privsep_get_capa
block|,
operator|.
name|get_mac_addr
operator|=
name|wpa_driver_privsep_get_mac_addr
block|,
operator|.
name|get_scan_results2
operator|=
name|wpa_driver_privsep_get_scan_results2
block|,
operator|.
name|set_country
operator|=
name|wpa_driver_privsep_set_country
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|wpa_driver_ops
modifier|*
name|wpa_drivers
index|[]
init|=
block|{
operator|&
name|wpa_driver_privsep_ops
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

end_unit


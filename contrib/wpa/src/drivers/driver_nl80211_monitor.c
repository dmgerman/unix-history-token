begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Driver interaction with Linux nl80211/cfg80211 - AP monitor interface  * Copyright (c) 2002-2014, Jouni Malinen<j@w1.fi>  * Copyright (c) 2003-2004, Instant802 Networks, Inc.  * Copyright (c) 2005-2006, Devicescape Software, Inc.  * Copyright (c) 2007, Johannes Berg<johannes@sipsolutions.net>  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<netpacket/packet.h>
end_include

begin_include
include|#
directive|include
file|<linux/filter.h>
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"linux_ioctl.h"
end_include

begin_include
include|#
directive|include
file|"radiotap_iter.h"
end_include

begin_include
include|#
directive|include
file|"driver_nl80211.h"
end_include

begin_function
specifier|static
name|void
name|handle_tx_callback
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|ok
parameter_list|)
block|{
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|type
operator|=
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|stype
operator|=
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|dst
operator|=
name|hdr
operator|->
name|addr1
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|data
operator|=
name|buf
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|data_len
operator|=
name|len
expr_stmt|;
name|event
operator|.
name|tx_status
operator|.
name|ack
operator|=
name|ok
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|ctx
argument_list|,
name|EVENT_TX_STATUS
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|from_unknown_sta
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
init|=
operator|(
name|void
operator|*
operator|)
name|buf
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
return|return;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_from_unknown
operator|.
name|bssid
operator|=
name|get_hdr_bssid
argument_list|(
name|hdr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_from_unknown
operator|.
name|addr
operator|=
name|hdr
operator|->
name|addr2
expr_stmt|;
name|event
operator|.
name|rx_from_unknown
operator|.
name|wds
operator|=
operator|(
name|fc
operator|&
operator|(
name|WLAN_FC_FROMDS
operator||
name|WLAN_FC_TODS
operator|)
operator|)
operator|==
operator|(
name|WLAN_FC_FROMDS
operator||
name|WLAN_FC_TODS
operator|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_RX_FROM_UNKNOWN
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|handle_frame
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|datarate
parameter_list|,
name|int
name|ssi_signal
parameter_list|)
block|{
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|union
name|wpa_event_data
name|event
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
condition|)
block|{
case|case
name|WLAN_FC_TYPE_MGMT
case|:
name|os_memset
argument_list|(
operator|&
name|event
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|frame
operator|=
name|buf
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|frame_len
operator|=
name|len
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|datarate
operator|=
name|datarate
expr_stmt|;
name|event
operator|.
name|rx_mgmt
operator|.
name|ssi_signal
operator|=
name|ssi_signal
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|EVENT_RX_MGMT
argument_list|,
operator|&
name|event
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_TYPE_CTRL
case|:
comment|/* can only get here with PS-Poll frames */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL"
argument_list|)
expr_stmt|;
name|from_unknown_sta
argument_list|(
name|drv
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_TYPE_DATA
case|:
name|from_unknown_sta
argument_list|(
name|drv
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|handle_monitor_read
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
name|int
name|len
decl_stmt|;
name|unsigned
name|char
name|buf
index|[
literal|3000
index|]
decl_stmt|;
name|struct
name|ieee80211_radiotap_iterator
name|iter
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|datarate
init|=
literal|0
decl_stmt|,
name|ssi_signal
init|=
literal|0
decl_stmt|;
name|int
name|injected
init|=
literal|0
decl_stmt|,
name|failed
init|=
literal|0
decl_stmt|,
name|rxflags
init|=
literal|0
decl_stmt|;
name|len
operator|=
name|recv
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Monitor socket recv failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ieee80211_radiotap_iterator_init
argument_list|(
operator|&
name|iter
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
name|len
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: received invalid radiotap frame"
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|ret
operator|=
name|ieee80211_radiotap_iterator_next
argument_list|(
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
name|ENOENT
condition|)
break|break;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: received invalid radiotap frame (%d)"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|iter
operator|.
name|this_arg_index
condition|)
block|{
case|case
name|IEEE80211_RADIOTAP_FLAGS
case|:
if|if
condition|(
operator|*
name|iter
operator|.
name|this_arg
operator|&
name|IEEE80211_RADIOTAP_F_FCS
condition|)
name|len
operator|-=
literal|4
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_RX_FLAGS
case|:
name|rxflags
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_TX_FLAGS
case|:
name|injected
operator|=
literal|1
expr_stmt|;
name|failed
operator|=
name|le_to_host16
argument_list|(
operator|(
operator|*
operator|(
name|uint16_t
operator|*
operator|)
name|iter
operator|.
name|this_arg
operator|)
argument_list|)
operator|&
name|IEEE80211_RADIOTAP_F_TX_FAIL
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DATA_RETRIES
case|:
break|break;
case|case
name|IEEE80211_RADIOTAP_CHANNEL
case|:
comment|/* TODO: convert from freq/flags to channel number */
break|break;
case|case
name|IEEE80211_RADIOTAP_RATE
case|:
name|datarate
operator|=
operator|*
name|iter
operator|.
name|this_arg
operator|*
literal|5
expr_stmt|;
break|break;
case|case
name|IEEE80211_RADIOTAP_DBM_ANTSIGNAL
case|:
name|ssi_signal
operator|=
operator|(
name|s8
operator|)
operator|*
name|iter
operator|.
name|this_arg
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|rxflags
operator|&&
name|injected
condition|)
return|return;
if|if
condition|(
operator|!
name|injected
condition|)
name|handle_frame
argument_list|(
name|drv
argument_list|,
name|buf
operator|+
name|iter
operator|.
name|_max_length
argument_list|,
name|len
operator|-
name|iter
operator|.
name|_max_length
argument_list|,
name|datarate
argument_list|,
name|ssi_signal
argument_list|)
expr_stmt|;
else|else
name|handle_tx_callback
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|buf
operator|+
name|iter
operator|.
name|_max_length
argument_list|,
name|len
operator|-
name|iter
operator|.
name|_max_length
argument_list|,
operator|!
name|failed
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * we post-process the filter code later and rewrite  * this to the offset to the last instruction  */
end_comment

begin_define
define|#
directive|define
name|PASS
value|0xFF
end_define

begin_define
define|#
directive|define
name|FAIL
value|0xFE
end_define

begin_decl_stmt
specifier|static
name|struct
name|sock_filter
name|msock_filter_insns
index|[]
init|=
block|{
comment|/* 	 * do a little-endian load of the radiotap length field 	 */
comment|/* load lower byte into A */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_B
operator||
name|BPF_ABS
argument_list|,
literal|2
argument_list|)
block|,
comment|/* put it into X (== index register) */
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator||
name|BPF_TAX
argument_list|,
literal|0
argument_list|)
block|,
comment|/* load upper byte into A */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_B
operator||
name|BPF_ABS
argument_list|,
literal|3
argument_list|)
block|,
comment|/* left-shift it by 8 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_LSH
operator||
name|BPF_K
argument_list|,
literal|8
argument_list|)
block|,
comment|/* or with X */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_OR
operator||
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* put result into X */
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator||
name|BPF_TAX
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 	 * Allow management frames through, this also gives us those 	 * management frames that we sent ourselves with status 	 */
comment|/* load the lower byte of the IEEE 802.11 frame control field */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_B
operator||
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
comment|/* mask off frame type and version */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_AND
operator||
name|BPF_K
argument_list|,
literal|0xF
argument_list|)
block|,
comment|/* accept frame if it's both 0, fall through otherwise */
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator||
name|BPF_JEQ
operator||
name|BPF_K
argument_list|,
literal|0
argument_list|,
name|PASS
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 	 * TODO: add a bit to radiotap RX flags that indicates 	 * that the sending station is not associated, then 	 * add a filter here that filters on our DA and that flag 	 * to allow us to deauth frames to that bad station. 	 * 	 * For now allow all To DS data frames through. 	 */
comment|/* load the IEEE 802.11 frame control field */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_H
operator||
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
comment|/* mask off frame type, version and DS status */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_AND
operator||
name|BPF_K
argument_list|,
literal|0x0F03
argument_list|)
block|,
comment|/* accept frame if version 0, type 2 and To DS, fall through otherwise 	 */
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator||
name|BPF_JEQ
operator||
name|BPF_K
argument_list|,
literal|0x0801
argument_list|,
name|PASS
argument_list|,
literal|0
argument_list|)
block|,
if|#
directive|if
literal|0
comment|/* 	 * drop non-data frames 	 */
comment|/* load the lower byte of the frame control field */
block|BPF_STMT(BPF_LD   | BPF_B | BPF_IND, 0),
comment|/* mask off QoS bit */
block|BPF_STMT(BPF_ALU  | BPF_AND | BPF_K, 0x0c),
comment|/* drop non-data frames */
block|BPF_JUMP(BPF_JMP  | BPF_JEQ | BPF_K, 8, 0, FAIL),
endif|#
directive|endif
comment|/* load the upper byte of the frame control field */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_B
operator||
name|BPF_IND
argument_list|,
literal|1
argument_list|)
block|,
comment|/* mask off toDS/fromDS */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_AND
operator||
name|BPF_K
argument_list|,
literal|0x03
argument_list|)
block|,
comment|/* accept WDS frames */
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator||
name|BPF_JEQ
operator||
name|BPF_K
argument_list|,
literal|3
argument_list|,
name|PASS
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 	 * add header length to index 	 */
comment|/* load the lower byte of the frame control field */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_B
operator||
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
comment|/* mask off QoS bit */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_AND
operator||
name|BPF_K
argument_list|,
literal|0x80
argument_list|)
block|,
comment|/* right shift it by 6 to give 0 or 2 */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_RSH
operator||
name|BPF_K
argument_list|,
literal|6
argument_list|)
block|,
comment|/* add data frame header length */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_ADD
operator||
name|BPF_K
argument_list|,
literal|24
argument_list|)
block|,
comment|/* add index, was start of 802.11 header */
name|BPF_STMT
argument_list|(
name|BPF_ALU
operator||
name|BPF_ADD
operator||
name|BPF_X
argument_list|,
literal|0
argument_list|)
block|,
comment|/* move to index, now start of LL header */
name|BPF_STMT
argument_list|(
name|BPF_MISC
operator||
name|BPF_TAX
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 	 * Accept empty data frames, we use those for 	 * polling activity. 	 */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_W
operator||
name|BPF_LEN
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator||
name|BPF_JEQ
operator||
name|BPF_X
argument_list|,
literal|0
argument_list|,
name|PASS
argument_list|,
literal|0
argument_list|)
block|,
comment|/* 	 * Accept EAPOL frames 	 */
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_W
operator||
name|BPF_IND
argument_list|,
literal|0
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator||
name|BPF_JEQ
operator||
name|BPF_K
argument_list|,
literal|0xAAAA0300
argument_list|,
literal|0
argument_list|,
name|FAIL
argument_list|)
block|,
name|BPF_STMT
argument_list|(
name|BPF_LD
operator||
name|BPF_W
operator||
name|BPF_IND
argument_list|,
literal|4
argument_list|)
block|,
name|BPF_JUMP
argument_list|(
name|BPF_JMP
operator||
name|BPF_JEQ
operator||
name|BPF_K
argument_list|,
literal|0x0000888E
argument_list|,
name|PASS
argument_list|,
name|FAIL
argument_list|)
block|,
comment|/* keep these last two statements or change the code below */
comment|/* return 0 == "DROP" */
name|BPF_STMT
argument_list|(
name|BPF_RET
operator||
name|BPF_K
argument_list|,
literal|0
argument_list|)
block|,
comment|/* return ~0 == "keep all" */
name|BPF_STMT
argument_list|(
name|BPF_RET
operator||
name|BPF_K
argument_list|,
operator|~
literal|0
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sock_fprog
name|msock_filter
init|=
block|{
operator|.
name|len
operator|=
name|ARRAY_SIZE
argument_list|(
name|msock_filter_insns
argument_list|)
block|,
operator|.
name|filter
operator|=
name|msock_filter_insns
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|add_monitor_filter
parameter_list|(
name|int
name|s
parameter_list|)
block|{
name|int
name|idx
decl_stmt|;
comment|/* rewrite all PASS/FAIL jump offsets */
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|msock_filter
operator|.
name|len
condition|;
name|idx
operator|++
control|)
block|{
name|struct
name|sock_filter
modifier|*
name|insn
init|=
operator|&
name|msock_filter_insns
index|[
name|idx
index|]
decl_stmt|;
if|if
condition|(
name|BPF_CLASS
argument_list|(
name|insn
operator|->
name|code
argument_list|)
operator|==
name|BPF_JMP
condition|)
block|{
if|if
condition|(
name|insn
operator|->
name|code
operator|==
operator|(
name|BPF_JMP
operator||
name|BPF_JA
operator|)
condition|)
block|{
if|if
condition|(
name|insn
operator|->
name|k
operator|==
name|PASS
condition|)
name|insn
operator|->
name|k
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|insn
operator|->
name|k
operator|==
name|FAIL
condition|)
name|insn
operator|->
name|k
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|3
expr_stmt|;
block|}
if|if
condition|(
name|insn
operator|->
name|jt
operator|==
name|PASS
condition|)
name|insn
operator|->
name|jt
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|insn
operator|->
name|jt
operator|==
name|FAIL
condition|)
name|insn
operator|->
name|jt
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|3
expr_stmt|;
if|if
condition|(
name|insn
operator|->
name|jf
operator|==
name|PASS
condition|)
name|insn
operator|->
name|jf
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|insn
operator|->
name|jf
operator|==
name|FAIL
condition|)
name|insn
operator|->
name|jf
operator|=
name|msock_filter
operator|.
name|len
operator|-
name|idx
operator|-
literal|3
expr_stmt|;
block|}
block|}
if|if
condition|(
name|setsockopt
argument_list|(
name|s
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_ATTACH_FILTER
argument_list|,
operator|&
name|msock_filter
argument_list|,
sizeof|sizeof
argument_list|(
name|msock_filter
argument_list|)
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: setsockopt(SO_ATTACH_FILTER) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|nl80211_remove_monitor_interface
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
if|if
condition|(
name|drv
operator|->
name|monitor_refcount
operator|>
literal|0
condition|)
name|drv
operator|->
name|monitor_refcount
operator|--
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Remove monitor interface: refcount=%d"
argument_list|,
name|drv
operator|->
name|monitor_refcount
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|monitor_refcount
operator|>
literal|0
condition|)
return|return;
if|if
condition|(
name|drv
operator|->
name|monitor_ifidx
operator|>=
literal|0
condition|)
block|{
name|nl80211_remove_iface
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|monitor_ifidx
argument_list|)
expr_stmt|;
name|drv
operator|->
name|monitor_ifidx
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|monitor_sock
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|)
expr_stmt|;
name|drv
operator|->
name|monitor_sock
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|nl80211_create_monitor_interface
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
name|char
name|buf
index|[
name|IFNAMSIZ
index|]
decl_stmt|;
name|struct
name|sockaddr_ll
name|ll
decl_stmt|;
name|int
name|optval
decl_stmt|;
name|socklen_t
name|optlen
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|monitor_ifidx
operator|>=
literal|0
condition|)
block|{
name|drv
operator|->
name|monitor_refcount
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Re-use existing monitor interface: refcount=%d"
argument_list|,
name|drv
operator|->
name|monitor_refcount
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|os_strncmp
argument_list|(
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|,
literal|"p2p-"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * P2P interface name is of the format p2p-%s-%d. For monitor 		 * interface name corresponding to P2P GO, replace "p2p-" with 		 * "mon-" to retain the same interface name length and to 		 * indicate that it is a monitor interface. 		 */
name|snprintf
argument_list|(
name|buf
argument_list|,
name|IFNAMSIZ
argument_list|,
literal|"mon-%s"
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|ifname
operator|+
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Non-P2P interface with AP functionality. */
name|snprintf
argument_list|(
name|buf
argument_list|,
name|IFNAMSIZ
argument_list|,
literal|"mon.%s"
argument_list|,
name|drv
operator|->
name|first_bss
operator|->
name|ifname
argument_list|)
expr_stmt|;
block|}
name|buf
index|[
name|IFNAMSIZ
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|drv
operator|->
name|monitor_ifidx
operator|=
name|nl80211_create_iface
argument_list|(
name|drv
argument_list|,
name|buf
argument_list|,
name|NL80211_IFTYPE_MONITOR
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|monitor_ifidx
operator|==
operator|-
name|EOPNOTSUPP
condition|)
block|{
comment|/* 		 * This is backward compatibility for a few versions of 		 * the kernel only that didn't advertise the right 		 * attributes for the only driver that then supported 		 * AP mode w/o monitor -- ath6kl. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Driver does not support "
literal|"monitor interface type - try to run without it"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|device_ap_sme
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|monitor_ifidx
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|linux_set_iface_flags
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|buf
argument_list|,
literal|1
argument_list|)
condition|)
goto|goto
name|error
goto|;
name|memset
argument_list|(
operator|&
name|ll
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
expr_stmt|;
name|ll
operator|.
name|sll_family
operator|=
name|AF_PACKET
expr_stmt|;
name|ll
operator|.
name|sll_ifindex
operator|=
name|drv
operator|->
name|monitor_ifidx
expr_stmt|;
name|drv
operator|->
name|monitor_sock
operator|=
name|socket
argument_list|(
name|PF_PACKET
argument_list|,
name|SOCK_RAW
argument_list|,
name|htons
argument_list|(
name|ETH_P_ALL
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|monitor_sock
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: socket[PF_PACKET,SOCK_RAW] failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|add_monitor_filter
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Failed to set socket filter for monitor "
literal|"interface; do filtering in user space"
argument_list|)
expr_stmt|;
comment|/* This works, but will cost in performance. */
block|}
if|if
condition|(
name|bind
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|ll
argument_list|,
sizeof|sizeof
argument_list|(
name|ll
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: monitor socket bind failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|optlen
operator|=
sizeof|sizeof
argument_list|(
name|optval
argument_list|)
expr_stmt|;
name|optval
operator|=
literal|20
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|,
name|SOL_SOCKET
argument_list|,
name|SO_PRIORITY
argument_list|,
operator|&
name|optval
argument_list|,
name|optlen
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nl80211: Failed to set socket priority: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|eloop_register_read_sock
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|,
name|handle_monitor_read
argument_list|,
name|drv
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: Could not register monitor read socket"
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|drv
operator|->
name|monitor_refcount
operator|++
expr_stmt|;
return|return
literal|0
return|;
name|error
label|:
name|nl80211_remove_monitor_interface
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|nl80211_send_monitor
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|encrypt
parameter_list|,
name|int
name|noack
parameter_list|)
block|{
name|__u8
name|rtap_hdr
index|[]
init|=
block|{
literal|0x00
block|,
literal|0x00
block|,
comment|/* radiotap version */
literal|0x0e
block|,
literal|0x00
block|,
comment|/* radiotap length */
literal|0x02
block|,
literal|0xc0
block|,
literal|0x00
block|,
literal|0x00
block|,
comment|/* bmap: flags, tx and rx flags */
name|IEEE80211_RADIOTAP_F_FRAG
block|,
comment|/* F_FRAG (fragment if required) */
literal|0x00
block|,
comment|/* padding */
literal|0x00
block|,
literal|0x00
block|,
comment|/* RX and TX flags to indicate that */
literal|0x00
block|,
literal|0x00
block|,
comment|/* this is the injected frame directly */
block|}
decl_stmt|;
name|struct
name|iovec
name|iov
index|[
literal|2
index|]
init|=
block|{
block|{
operator|.
name|iov_base
operator|=
operator|&
name|rtap_hdr
block|,
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|rtap_hdr
argument_list|)
block|, 		}
block|,
block|{
operator|.
name|iov_base
operator|=
operator|(
name|void
operator|*
operator|)
name|data
block|,
operator|.
name|iov_len
operator|=
name|len
block|, 		}
block|}
decl_stmt|;
name|struct
name|msghdr
name|msg
init|=
block|{
operator|.
name|msg_name
operator|=
name|NULL
block|,
operator|.
name|msg_namelen
operator|=
literal|0
block|,
operator|.
name|msg_iov
operator|=
name|iov
block|,
operator|.
name|msg_iovlen
operator|=
literal|2
block|,
operator|.
name|msg_control
operator|=
name|NULL
block|,
operator|.
name|msg_controllen
operator|=
literal|0
block|,
operator|.
name|msg_flags
operator|=
literal|0
block|, 	}
decl_stmt|;
name|int
name|res
decl_stmt|;
name|u16
name|txflags
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|encrypt
condition|)
name|rtap_hdr
index|[
literal|8
index|]
operator||=
name|IEEE80211_RADIOTAP_F_WEP
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|monitor_sock
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: No monitor socket available "
literal|"for %s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|noack
condition|)
name|txflags
operator||=
name|IEEE80211_RADIOTAP_F_TX_NOACK
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
operator|&
name|rtap_hdr
index|[
literal|12
index|]
argument_list|,
name|txflags
argument_list|)
expr_stmt|;
name|res
operator|=
name|sendmsg
argument_list|(
name|drv
operator|->
name|monitor_sock
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"nl80211: sendmsg: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


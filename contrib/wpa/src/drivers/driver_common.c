begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Common driver-related functions  * Copyright (c) 2003-2011, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_function
name|void
name|wpa_scan_results_free
parameter_list|(
name|struct
name|wpa_scan_results
modifier|*
name|res
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|res
operator|->
name|num
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
name|res
operator|->
name|res
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|res
operator|->
name|res
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|event_to_string
parameter_list|(
name|enum
name|wpa_event_type
name|event
parameter_list|)
block|{
define|#
directive|define
name|E2S
parameter_list|(
name|n
parameter_list|)
value|case EVENT_ ## n: return #n
switch|switch
condition|(
name|event
condition|)
block|{
name|E2S
argument_list|(
name|ASSOC
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|DISASSOC
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|MICHAEL_MIC_FAILURE
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|SCAN_RESULTS
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|ASSOCINFO
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|INTERFACE_STATUS
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|PMKID_CANDIDATE
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|STKSTART
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|TDLS
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|FT_RESPONSE
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|IBSS_RSN_START
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|AUTH
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|DEAUTH
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|ASSOC_REJECT
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|AUTH_TIMED_OUT
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|ASSOC_TIMED_OUT
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|WPS_BUTTON_PUSHED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|TX_STATUS
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|RX_FROM_UNKNOWN
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|RX_MGMT
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|REMAIN_ON_CHANNEL
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|CANCEL_REMAIN_ON_CHANNEL
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|RX_PROBE_REQ
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|NEW_STA
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|EAPOL_RX
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|SIGNAL_CHANGE
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|INTERFACE_ENABLED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|INTERFACE_DISABLED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|CHANNEL_LIST_CHANGED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|INTERFACE_UNAVAILABLE
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|BEST_CHANNEL
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|UNPROT_DEAUTH
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|UNPROT_DISASSOC
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|STATION_LOW_ACK
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|IBSS_PEER_LOST
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|DRIVER_GTK_REKEY
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|SCHED_SCAN_STOPPED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|DRIVER_CLIENT_POLL_OK
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|EAPOL_TX_STATUS
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|CH_SWITCH
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|WNM
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|CONNECT_FAILED_REASON
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|DFS_RADAR_DETECTED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|DFS_CAC_FINISHED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|DFS_CAC_ABORTED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|DFS_NOP_FINISHED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|SURVEY
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|SCAN_STARTED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|AVOID_FREQUENCIES
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|NEW_PEER_CANDIDATE
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|ACS_CHANNEL_SELECTED
argument_list|)
expr_stmt|;
name|E2S
argument_list|(
name|DFS_CAC_STARTED
argument_list|)
expr_stmt|;
block|}
return|return
literal|"UNKNOWN"
return|;
undef|#
directive|undef
name|E2S
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|channel_width_to_string
parameter_list|(
name|enum
name|chan_width
name|width
parameter_list|)
block|{
switch|switch
condition|(
name|width
condition|)
block|{
case|case
name|CHAN_WIDTH_20_NOHT
case|:
return|return
literal|"20 MHz (no HT)"
return|;
case|case
name|CHAN_WIDTH_20
case|:
return|return
literal|"20 MHz"
return|;
case|case
name|CHAN_WIDTH_40
case|:
return|return
literal|"40 MHz"
return|;
case|case
name|CHAN_WIDTH_80
case|:
return|return
literal|"80 MHz"
return|;
case|case
name|CHAN_WIDTH_80P80
case|:
return|return
literal|"80+80 MHz"
return|;
case|case
name|CHAN_WIDTH_160
case|:
return|return
literal|"160 MHz"
return|;
default|default:
return|return
literal|"unknown"
return|;
block|}
block|}
end_function

begin_function
name|int
name|ht_supported
parameter_list|(
specifier|const
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|mode
operator|->
name|flags
operator|&
name|HOSTAPD_MODE_FLAG_HT_INFO_KNOWN
operator|)
condition|)
block|{
comment|/* 		 * The driver did not indicate whether it supports HT. Assume 		 * it does to avoid connection issues. 		 */
return|return
literal|1
return|;
block|}
comment|/* 	 * IEEE Std 802.11n-2009 20.1.1: 	 * An HT non-AP STA shall support all EQM rates for one spatial stream. 	 */
return|return
name|mode
operator|->
name|mcs_set
index|[
literal|0
index|]
operator|==
literal|0xff
return|;
block|}
end_function

begin_function
name|int
name|vht_supported
parameter_list|(
specifier|const
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|mode
operator|->
name|flags
operator|&
name|HOSTAPD_MODE_FLAG_VHT_INFO_KNOWN
operator|)
condition|)
block|{
comment|/* 		 * The driver did not indicate whether it supports VHT. Assume 		 * it does to avoid connection issues. 		 */
return|return
literal|1
return|;
block|}
comment|/* 	 * A VHT non-AP STA shall support MCS 0-7 for one spatial stream. 	 * TODO: Verify if this complies with the standard 	 */
return|return
operator|(
name|mode
operator|->
name|vht_mcs_set
index|[
literal|0
index|]
operator|&
literal|0x3
operator|)
operator|!=
literal|3
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_check_wowlan_trigger
parameter_list|(
specifier|const
name|char
modifier|*
name|start
parameter_list|,
specifier|const
name|char
modifier|*
name|trigger
parameter_list|,
name|int
name|capa_trigger
parameter_list|,
name|u8
modifier|*
name|param_trigger
parameter_list|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|start
argument_list|,
name|trigger
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|capa_trigger
condition|)
return|return
literal|0
return|;
operator|*
name|param_trigger
operator|=
literal|1
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|struct
name|wowlan_triggers
modifier|*
name|wpa_get_wowlan_triggers
parameter_list|(
specifier|const
name|char
modifier|*
name|wowlan_triggers
parameter_list|,
specifier|const
name|struct
name|wpa_driver_capa
modifier|*
name|capa
parameter_list|)
block|{
name|struct
name|wowlan_triggers
modifier|*
name|triggers
decl_stmt|;
name|char
modifier|*
name|start
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|buf
decl_stmt|;
name|int
name|last
decl_stmt|;
if|if
condition|(
operator|!
name|wowlan_triggers
condition|)
return|return
name|NULL
return|;
name|buf
operator|=
name|os_strdup
argument_list|(
name|wowlan_triggers
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|triggers
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|triggers
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|triggers
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
define|#
directive|define
name|CHECK_TRIGGER
parameter_list|(
name|trigger
parameter_list|)
define|\
value|wpa_check_wowlan_trigger(start, #trigger,			\ 				  capa->wowlan_triggers.trigger,	\&triggers->trigger)
name|start
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|start
operator|!=
literal|'\0'
condition|)
block|{
while|while
condition|(
name|isblank
argument_list|(
operator|*
name|start
argument_list|)
condition|)
name|start
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|start
operator|==
literal|'\0'
condition|)
break|break;
name|end
operator|=
name|start
expr_stmt|;
while|while
condition|(
operator|!
name|isblank
argument_list|(
operator|*
name|end
argument_list|)
operator|&&
operator|*
name|end
operator|!=
literal|'\0'
condition|)
name|end
operator|++
expr_stmt|;
name|last
operator|=
operator|*
name|end
operator|==
literal|'\0'
expr_stmt|;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|!
name|CHECK_TRIGGER
argument_list|(
name|any
argument_list|)
operator|&&
operator|!
name|CHECK_TRIGGER
argument_list|(
name|disconnect
argument_list|)
operator|&&
operator|!
name|CHECK_TRIGGER
argument_list|(
name|magic_pkt
argument_list|)
operator|&&
operator|!
name|CHECK_TRIGGER
argument_list|(
name|gtk_rekey_failure
argument_list|)
operator|&&
operator|!
name|CHECK_TRIGGER
argument_list|(
name|eap_identity_req
argument_list|)
operator|&&
operator|!
name|CHECK_TRIGGER
argument_list|(
name|four_way_handshake
argument_list|)
operator|&&
operator|!
name|CHECK_TRIGGER
argument_list|(
name|rfkill_release
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unknown/unsupported wowlan trigger '%s'"
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|triggers
argument_list|)
expr_stmt|;
name|triggers
operator|=
name|NULL
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|last
condition|)
break|break;
name|start
operator|=
name|end
operator|+
literal|1
expr_stmt|;
block|}
undef|#
directive|undef
name|CHECK_TRIGGER
name|out
label|:
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|triggers
return|;
block|}
end_function

end_unit


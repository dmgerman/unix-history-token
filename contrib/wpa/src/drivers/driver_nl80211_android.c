begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Driver interaction with Linux nl80211/cfg80211 - Android specific  * Copyright (c) 2002-2014, Jouni Malinen<j@w1.fi>  * Copyright (c) 2007, Johannes Berg<johannes@sipsolutions.net>  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/genl.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/family.h>
end_include

begin_include
include|#
directive|include
file|<netlink/genl/ctrl.h>
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"driver_nl80211.h"
end_include

begin_include
include|#
directive|include
file|"android_drv.h"
end_include

begin_typedef
typedef|typedef
struct|struct
name|android_wifi_priv_cmd
block|{
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|used_len
decl_stmt|;
name|int
name|total_len
decl_stmt|;
block|}
name|android_wifi_priv_cmd
typedef|;
end_typedef

begin_decl_stmt
specifier|static
name|int
name|drv_errors
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|wpa_driver_send_hang_msg
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
name|drv_errors
operator|++
expr_stmt|;
if|if
condition|(
name|drv_errors
operator|>
name|DRV_NUMBER_SEQUENTIAL_ERRORS
condition|)
block|{
name|drv_errors
operator|=
literal|0
expr_stmt|;
name|wpa_msg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_DRIVER_STATE
literal|"HANGED"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|android_priv_cmd
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|android_wifi_priv_cmd
name|priv_cmd
decl_stmt|;
name|char
name|buf
index|[
name|MAX_DRV_CMD_SIZE
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|priv_cmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|priv_cmd
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|buf
argument_list|,
name|cmd
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|priv_cmd
operator|.
name|buf
operator|=
name|buf
expr_stmt|;
name|priv_cmd
operator|.
name|used_len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|priv_cmd
operator|.
name|total_len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|&
name|priv_cmd
expr_stmt|;
name|ret
operator|=
name|ioctl
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|SIOCDEVPRIVATE
operator|+
literal|1
argument_list|,
operator|&
name|ifr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s: failed to issue private commands"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|wpa_driver_send_hang_msg
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|drv_errors
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|android_pno_start
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|android_wifi_priv_cmd
name|priv_cmd
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|,
name|bp
decl_stmt|;
name|char
name|buf
index|[
name|WEXT_PNO_MAX_COMMAND_SIZE
index|]
decl_stmt|;
name|bp
operator|=
name|WEXT_PNOSETUP_HEADER_SIZE
expr_stmt|;
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|WEXT_PNOSETUP_HEADER
argument_list|,
name|bp
argument_list|)
expr_stmt|;
name|buf
index|[
name|bp
operator|++
index|]
operator|=
name|WEXT_PNO_TLV_PREFIX
expr_stmt|;
name|buf
index|[
name|bp
operator|++
index|]
operator|=
name|WEXT_PNO_TLV_VERSION
expr_stmt|;
name|buf
index|[
name|bp
operator|++
index|]
operator|=
name|WEXT_PNO_TLV_SUBVERSION
expr_stmt|;
name|buf
index|[
name|bp
operator|++
index|]
operator|=
name|WEXT_PNO_TLV_RESERVED
expr_stmt|;
while|while
condition|(
name|i
operator|<
name|WEXT_PNO_AMOUNT
operator|&&
operator|(
name|size_t
operator|)
name|i
operator|<
name|params
operator|->
name|num_ssids
condition|)
block|{
comment|/* Check that there is enough space needed for 1 more SSID, the 		 * other sections and null termination */
if|if
condition|(
operator|(
name|bp
operator|+
name|WEXT_PNO_SSID_HEADER_SIZE
operator|+
name|MAX_SSID_LEN
operator|+
name|WEXT_PNO_NONSSID_SECTIONS_SIZE
operator|+
literal|1
operator|)
operator|>=
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
break|break;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"For PNO Scan"
argument_list|,
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid
argument_list|,
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|buf
index|[
name|bp
operator|++
index|]
operator|=
name|WEXT_PNO_SSID_SECTION
expr_stmt|;
name|buf
index|[
name|bp
operator|++
index|]
operator|=
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|buf
index|[
name|bp
index|]
argument_list|,
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid
argument_list|,
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid_len
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|buf
index|[
name|bp
operator|++
index|]
operator|=
name|WEXT_PNO_SCAN_INTERVAL_SECTION
expr_stmt|;
name|os_snprintf
argument_list|(
operator|&
name|buf
index|[
name|bp
index|]
argument_list|,
name|WEXT_PNO_SCAN_INTERVAL_LENGTH
operator|+
literal|1
argument_list|,
literal|"%x"
argument_list|,
name|WEXT_PNO_SCAN_INTERVAL
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|WEXT_PNO_SCAN_INTERVAL_LENGTH
expr_stmt|;
name|buf
index|[
name|bp
operator|++
index|]
operator|=
name|WEXT_PNO_REPEAT_SECTION
expr_stmt|;
name|os_snprintf
argument_list|(
operator|&
name|buf
index|[
name|bp
index|]
argument_list|,
name|WEXT_PNO_REPEAT_LENGTH
operator|+
literal|1
argument_list|,
literal|"%x"
argument_list|,
name|WEXT_PNO_REPEAT
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|WEXT_PNO_REPEAT_LENGTH
expr_stmt|;
name|buf
index|[
name|bp
operator|++
index|]
operator|=
name|WEXT_PNO_MAX_REPEAT_SECTION
expr_stmt|;
name|os_snprintf
argument_list|(
operator|&
name|buf
index|[
name|bp
index|]
argument_list|,
name|WEXT_PNO_MAX_REPEAT_LENGTH
operator|+
literal|1
argument_list|,
literal|"%x"
argument_list|,
name|WEXT_PNO_MAX_REPEAT
argument_list|)
expr_stmt|;
name|bp
operator|+=
name|WEXT_PNO_MAX_REPEAT_LENGTH
operator|+
literal|1
expr_stmt|;
name|memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|priv_cmd
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|priv_cmd
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|bss
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|priv_cmd
operator|.
name|buf
operator|=
name|buf
expr_stmt|;
name|priv_cmd
operator|.
name|used_len
operator|=
name|bp
expr_stmt|;
name|priv_cmd
operator|.
name|total_len
operator|=
name|bp
expr_stmt|;
name|ifr
operator|.
name|ifr_data
operator|=
operator|&
name|priv_cmd
expr_stmt|;
name|ret
operator|=
name|ioctl
argument_list|(
name|drv
operator|->
name|global
operator|->
name|ioctl_sock
argument_list|,
name|SIOCDEVPRIVATE
operator|+
literal|1
argument_list|,
operator|&
name|ifr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ioctl[SIOCSIWPRIV] (pnosetup): %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|wpa_driver_send_hang_msg
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|drv_errors
operator|=
literal|0
expr_stmt|;
return|return
name|android_priv_cmd
argument_list|(
name|bss
argument_list|,
literal|"PNOFORCE 1"
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|android_pno_stop
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|)
block|{
return|return
name|android_priv_cmd
argument_list|(
name|bss
argument_list|,
literal|"PNOFORCE 0"
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|ANDROID_P2P
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|ANDROID_LIB_STUB
end_ifdef

begin_function
name|int
name|wpa_driver_set_p2p_noa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
name|count
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|duration
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_driver_get_p2p_noa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_driver_set_p2p_ps
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|legacy_ps
parameter_list|,
name|int
name|opp_ps
parameter_list|,
name|int
name|ctwindow
parameter_list|)
block|{
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|wpa_driver_set_ap_wps_p2p_ie
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|beacon
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|proberesp
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|assocresp
parameter_list|)
block|{
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ANDROID_LIB_STUB */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* ANDROID_P2P */
end_comment

begin_function
name|int
name|android_nl_socket_set_nonblocking
parameter_list|(
name|struct
name|nl_handle
modifier|*
name|handle
parameter_list|)
block|{
return|return
name|fcntl
argument_list|(
name|nl_socket_get_fd
argument_list|(
name|handle
argument_list|)
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - Helper functions for scan result processing  * Copyright (c) 2007-2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_function
specifier|const
name|u8
modifier|*
name|wpa_scan_get_ie
parameter_list|(
specifier|const
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|,
name|u8
name|ie
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|res
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|res
operator|->
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|ie
condition|)
return|return
name|pos
return|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|u8
modifier|*
name|wpa_scan_get_vendor_ie
parameter_list|(
specifier|const
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|,
name|u32
name|vendor_type
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|res
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|res
operator|->
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|vendor_type
operator|==
name|WPA_GET_BE32
argument_list|(
operator|&
name|pos
index|[
literal|2
index|]
argument_list|)
condition|)
return|return
name|pos
return|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wpa_scan_get_vendor_ie_multi
parameter_list|(
specifier|const
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|,
name|u32
name|vendor_type
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|res
operator|->
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|res
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|res
operator|->
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|vendor_type
operator|==
name|WPA_GET_BE32
argument_list|(
operator|&
name|pos
index|[
literal|2
index|]
argument_list|)
condition|)
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|pos
operator|+
literal|2
operator|+
literal|4
argument_list|,
name|pos
index|[
literal|1
index|]
operator|-
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
name|int
name|wpa_scan_get_max_rate
parameter_list|(
specifier|const
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|)
block|{
name|int
name|rate
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|res
argument_list|,
name|WLAN_EID_SUPP_RATES
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ie
operator|&&
name|i
operator|<
name|ie
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
operator|)
operator|>
name|rate
condition|)
name|rate
operator|=
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
expr_stmt|;
block|}
name|ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|res
argument_list|,
name|WLAN_EID_EXT_SUPP_RATES
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ie
operator|&&
name|i
operator|<
name|ie
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
operator|)
operator|>
name|rate
condition|)
name|rate
operator|=
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
expr_stmt|;
block|}
return|return
name|rate
return|;
block|}
end_function

begin_function
name|void
name|wpa_scan_results_free
parameter_list|(
name|struct
name|wpa_scan_results
modifier|*
name|res
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|res
operator|->
name|num
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
name|res
operator|->
name|res
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|res
operator|->
name|res
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Compare function for sorting scan results. Return>0 if @b is considered  * better. */
end_comment

begin_function
specifier|static
name|int
name|wpa_scan_result_compar
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
name|struct
name|wpa_scan_res
modifier|*
modifier|*
name|_wa
init|=
operator|(
name|void
operator|*
operator|)
name|a
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
modifier|*
name|_wb
init|=
operator|(
name|void
operator|*
operator|)
name|b
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|wa
init|=
operator|*
name|_wa
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|wb
init|=
operator|*
name|_wb
decl_stmt|;
name|int
name|wpa_a
decl_stmt|,
name|wpa_b
decl_stmt|,
name|maxrate_a
decl_stmt|,
name|maxrate_b
decl_stmt|;
comment|/* WPA/WPA2 support preferred */
name|wpa_a
operator|=
name|wpa_scan_get_vendor_ie
argument_list|(
name|wa
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
operator|!=
name|NULL
operator|||
name|wpa_scan_get_ie
argument_list|(
name|wa
argument_list|,
name|WLAN_EID_RSN
argument_list|)
operator|!=
name|NULL
expr_stmt|;
name|wpa_b
operator|=
name|wpa_scan_get_vendor_ie
argument_list|(
name|wb
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
operator|!=
name|NULL
operator|||
name|wpa_scan_get_ie
argument_list|(
name|wb
argument_list|,
name|WLAN_EID_RSN
argument_list|)
operator|!=
name|NULL
expr_stmt|;
if|if
condition|(
name|wpa_b
operator|&&
operator|!
name|wpa_a
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|wpa_b
operator|&&
name|wpa_a
condition|)
return|return
operator|-
literal|1
return|;
comment|/* privacy support preferred */
if|if
condition|(
operator|(
name|wa
operator|->
name|caps
operator|&
name|IEEE80211_CAP_PRIVACY
operator|)
operator|==
literal|0
operator|&&
operator|(
name|wb
operator|->
name|caps
operator|&
name|IEEE80211_CAP_PRIVACY
operator|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|(
name|wa
operator|->
name|caps
operator|&
name|IEEE80211_CAP_PRIVACY
operator|)
operator|&&
operator|(
name|wb
operator|->
name|caps
operator|&
name|IEEE80211_CAP_PRIVACY
operator|)
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
comment|/* best/max rate preferred if signal level close enough XXX */
if|if
condition|(
operator|(
name|wa
operator|->
name|level
operator|&&
name|wb
operator|->
name|level
operator|&&
name|abs
argument_list|(
name|wb
operator|->
name|level
operator|-
name|wa
operator|->
name|level
argument_list|)
operator|<
literal|5
operator|)
operator|||
operator|(
name|wa
operator|->
name|qual
operator|&&
name|wb
operator|->
name|qual
operator|&&
name|abs
argument_list|(
name|wb
operator|->
name|qual
operator|-
name|wa
operator|->
name|qual
argument_list|)
operator|<
literal|10
operator|)
condition|)
block|{
name|maxrate_a
operator|=
name|wpa_scan_get_max_rate
argument_list|(
name|wa
argument_list|)
expr_stmt|;
name|maxrate_b
operator|=
name|wpa_scan_get_max_rate
argument_list|(
name|wb
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxrate_a
operator|!=
name|maxrate_b
condition|)
return|return
name|maxrate_b
operator|-
name|maxrate_a
return|;
block|}
comment|/* use freq for channel preference */
comment|/* all things being equal, use signal level; if signal levels are 	 * identical, use quality values since some drivers may only report 	 * that value and leave the signal level zero */
if|if
condition|(
name|wb
operator|->
name|level
operator|==
name|wa
operator|->
name|level
condition|)
return|return
name|wb
operator|->
name|qual
operator|-
name|wa
operator|->
name|qual
return|;
return|return
name|wb
operator|->
name|level
operator|-
name|wa
operator|->
name|level
return|;
block|}
end_function

begin_function
name|void
name|wpa_scan_sort_results
parameter_list|(
name|struct
name|wpa_scan_results
modifier|*
name|res
parameter_list|)
block|{
name|qsort
argument_list|(
name|res
operator|->
name|res
argument_list|,
name|res
operator|->
name|num
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_res
operator|*
argument_list|)
argument_list|,
name|wpa_scan_result_compar
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


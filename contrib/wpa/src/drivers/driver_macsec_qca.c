begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wired Ethernet driver interface for QCA MACsec driver  * Copyright (c) 2005-2009, Jouni Malinen<j@w1.fi>  * Copyright (c) 2004, Gunter Burchardt<tira@isx.de>  * Copyright (c) 2013-2014, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__linux__
end_ifdef

begin_include
include|#
directive|include
file|<netpacket/packet.h>
end_include

begin_include
include|#
directive|include
file|<net/if_arp.h>
end_include

begin_include
include|#
directive|include
file|<net/if.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __linux__ */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__DragonFly__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD_kernel__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<net/if_dl.h>
end_include

begin_include
include|#
directive|include
file|<net/if_media.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(__FreeBSD__) || defined(__DragonFly__) || defined(__FreeBSD_kernel__) */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|__sun__
end_ifdef

begin_include
include|#
directive|include
file|<sys/sockio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __sun__ */
end_comment

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_1x_defs.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"nss_macsec_secy.h"
end_include

begin_include
include|#
directive|include
file|"nss_macsec_secy_rx.h"
end_include

begin_include
include|#
directive|include
file|"nss_macsec_secy_tx.h"
end_include

begin_define
define|#
directive|define
name|MAXSC
value|16
end_define

begin_comment
comment|/* TCI field definition */
end_comment

begin_define
define|#
directive|define
name|TCI_ES
value|0x40
end_define

begin_define
define|#
directive|define
name|TCI_SC
value|0x20
end_define

begin_define
define|#
directive|define
name|TCI_SCB
value|0x10
end_define

begin_define
define|#
directive|define
name|TCI_E
value|0x08
end_define

begin_define
define|#
directive|define
name|TCI_C
value|0x04
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|_MSC_VER
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|pack
name|(
name|push
name|,
name|1
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _MSC_VER */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|_MSC_VER
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|pack
name|(
name|pop
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* _MSC_VER */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|u8
name|pae_group_addr
index|[
name|ETH_ALEN
index|]
init|=
block|{
literal|0x01
block|,
literal|0x80
block|,
literal|0xc2
block|,
literal|0x00
block|,
literal|0x00
block|,
literal|0x03
block|}
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|macsec_qca_data
block|{
name|char
name|ifname
index|[
name|IFNAMSIZ
operator|+
literal|1
index|]
decl_stmt|;
name|u32
name|secy_id
decl_stmt|;
name|void
modifier|*
name|ctx
decl_stmt|;
name|int
name|sock
decl_stmt|;
comment|/* raw packet socket for driver access */
name|int
name|pf_sock
decl_stmt|;
name|int
name|membership
decl_stmt|,
name|multi
decl_stmt|,
name|iff_allmulti
decl_stmt|,
name|iff_up
decl_stmt|;
comment|/* shadow */
name|Boolean
name|always_include_sci
decl_stmt|;
name|Boolean
name|use_es
decl_stmt|;
name|Boolean
name|use_scb
decl_stmt|;
name|Boolean
name|protect_frames
decl_stmt|;
name|Boolean
name|replay_protect
decl_stmt|;
name|u32
name|replay_window
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|macsec_qca_multicast_membership
parameter_list|(
name|int
name|sock
parameter_list|,
name|int
name|ifindex
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|add
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|struct
name|packet_mreq
name|mreq
decl_stmt|;
if|if
condition|(
name|sock
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
operator|&
name|mreq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
argument_list|)
expr_stmt|;
name|mreq
operator|.
name|mr_ifindex
operator|=
name|ifindex
expr_stmt|;
name|mreq
operator|.
name|mr_type
operator|=
name|PACKET_MR_MULTICAST
expr_stmt|;
name|mreq
operator|.
name|mr_alen
operator|=
name|ETH_ALEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|mreq
operator|.
name|mr_address
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|setsockopt
argument_list|(
name|sock
argument_list|,
name|SOL_PACKET
argument_list|,
name|add
condition|?
name|PACKET_ADD_MEMBERSHIP
else|:
name|PACKET_DROP_MEMBERSHIP
argument_list|,
operator|&
name|mreq
argument_list|,
sizeof|sizeof
argument_list|(
name|mreq
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"setsockopt: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* __linux__ */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* __linux__ */
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_get_ssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|ssid
parameter_list|)
block|{
name|ssid
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_get_bssid
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
comment|/* Report PAE group address as the "BSSID" for macsec connection. */
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|pae_group_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_get_capa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_capa
modifier|*
name|capa
parameter_list|)
block|{
name|os_memset
argument_list|(
name|capa
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|capa
argument_list|)
argument_list|)
expr_stmt|;
name|capa
operator|->
name|flags
operator|=
name|WPA_DRIVER_FLAGS_WIRED
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_get_ifflags
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
modifier|*
name|flags
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"socket: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFFLAGS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ioctl[SIOCGIFFLAGS]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
operator|*
name|flags
operator|=
name|ifr
operator|.
name|ifr_flags
operator|&
literal|0xffff
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_set_ifflags
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|flags
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"socket: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ifr
operator|.
name|ifr_flags
operator|=
name|flags
operator|&
literal|0xffff
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCSIFFLAGS
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ioctl[SIOCSIFFLAGS]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__DragonFly__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD_kernel__
argument_list|)
end_if

begin_function
specifier|static
name|int
name|macsec_qca_get_ifstatus
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
modifier|*
name|status
parameter_list|)
block|{
name|struct
name|ifmediareq
name|ifmr
decl_stmt|;
name|int
name|s
decl_stmt|;
name|s
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|wpa_print
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"socket: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|ifmr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifmr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ifmr
operator|.
name|ifm_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|SIOCGIFMEDIA
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifmr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ioctl[SIOCGIFMEDIA]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
operator|*
name|status
operator|=
operator|(
name|ifmr
operator|.
name|ifm_status
operator|&
operator|(
name|IFM_ACTIVE
operator||
name|IFM_AVALID
operator|)
operator|)
operator|==
operator|(
name|IFM_ACTIVE
operator||
name|IFM_AVALID
operator|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* defined(__FreeBSD__) || defined(__DragonFly__) || defined(FreeBSD_kernel__) */
end_comment

begin_function
specifier|static
name|int
name|macsec_qca_multi
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|add
parameter_list|)
block|{
name|struct
name|ifreq
name|ifr
decl_stmt|;
name|int
name|s
decl_stmt|;
ifdef|#
directive|ifdef
name|__sun__
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* __sun__ */
name|s
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"socket: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|ifr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|ifr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|ifr
operator|.
name|ifr_name
argument_list|,
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|__linux__
name|ifr
operator|.
name|ifr_hwaddr
operator|.
name|sa_family
operator|=
name|AF_UNSPEC
expr_stmt|;
name|os_memcpy
argument_list|(
name|ifr
operator|.
name|ifr_hwaddr
operator|.
name|sa_data
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* __linux__ */
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__DragonFly__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD_kernel__
argument_list|)
block|{
name|struct
name|sockaddr_dl
modifier|*
name|dlp
decl_stmt|;
name|dlp
operator|=
operator|(
expr|struct
name|sockaddr_dl
operator|*
operator|)
operator|&
name|ifr
operator|.
name|ifr_addr
expr_stmt|;
name|dlp
operator|->
name|sdl_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr_dl
argument_list|)
expr_stmt|;
name|dlp
operator|->
name|sdl_family
operator|=
name|AF_LINK
expr_stmt|;
name|dlp
operator|->
name|sdl_index
operator|=
literal|0
expr_stmt|;
name|dlp
operator|->
name|sdl_nlen
operator|=
literal|0
expr_stmt|;
name|dlp
operator|->
name|sdl_alen
operator|=
name|ETH_ALEN
expr_stmt|;
name|dlp
operator|->
name|sdl_slen
operator|=
literal|0
expr_stmt|;
name|os_memcpy
argument_list|(
name|LLADDR
argument_list|(
name|dlp
argument_list|)
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* defined(__FreeBSD__) || defined(__DragonFly__) || defined(FreeBSD_kernel__) */
if|#
directive|if
name|defined
argument_list|(
name|__NetBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__OpenBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__APPLE__
argument_list|)
block|{
name|struct
name|sockaddr
modifier|*
name|sap
decl_stmt|;
name|sap
operator|=
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|ifr
operator|.
name|ifr_addr
expr_stmt|;
name|sap
operator|->
name|sa_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|sockaddr
argument_list|)
expr_stmt|;
name|sap
operator|->
name|sa_family
operator|=
name|AF_UNSPEC
expr_stmt|;
name|os_memcpy
argument_list|(
name|sap
operator|->
name|sa_data
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* defined(__NetBSD__) || defined(__OpenBSD__) || defined(__APPLE__) */
if|if
condition|(
name|ioctl
argument_list|(
name|s
argument_list|,
name|add
condition|?
name|SIOCADDMULTI
else|:
name|SIOCDELMULTI
argument_list|,
operator|(
name|caddr_t
operator|)
operator|&
name|ifr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ioctl[SIOC{ADD/DEL}MULTI]: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|__macsec_drv_init
parameter_list|(
name|struct
name|macsec_qca_data
modifier|*
name|drv
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|fal_rx_ctl_filt_t
name|rx_ctl_filt
decl_stmt|;
name|fal_tx_ctl_filt_t
name|tx_ctl_filt
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s: secy_id=%d"
argument_list|,
name|__func__
argument_list|,
name|drv
operator|->
name|secy_id
argument_list|)
expr_stmt|;
comment|/* Enable Secy and Let EAPoL bypass */
name|ret
operator|=
name|nss_macsec_secy_en_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nss_macsec_secy_en_set: FAIL"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|nss_macsec_secy_sc_sa_mapping_mode_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|FAL_SC_SA_MAP_1_4
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nss_macsec_secy_sc_sa_mapping_mode_set: FAIL"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|rx_ctl_filt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rx_ctl_filt
argument_list|)
argument_list|)
expr_stmt|;
name|rx_ctl_filt
operator|.
name|bypass
operator|=
literal|1
expr_stmt|;
name|rx_ctl_filt
operator|.
name|match_type
operator|=
name|IG_CTL_COMPARE_ETHER_TYPE
expr_stmt|;
name|rx_ctl_filt
operator|.
name|match_mask
operator|=
literal|0xffff
expr_stmt|;
name|rx_ctl_filt
operator|.
name|ether_type_da_range
operator|=
literal|0x888e
expr_stmt|;
name|ret
operator|=
name|nss_macsec_secy_rx_ctl_filt_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
literal|0
argument_list|,
operator|&
name|rx_ctl_filt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nss_macsec_secy_rx_ctl_filt_set: FAIL"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|tx_ctl_filt
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tx_ctl_filt
argument_list|)
argument_list|)
expr_stmt|;
name|tx_ctl_filt
operator|.
name|bypass
operator|=
literal|1
expr_stmt|;
name|tx_ctl_filt
operator|.
name|match_type
operator|=
name|EG_CTL_COMPARE_ETHER_TYPE
expr_stmt|;
name|tx_ctl_filt
operator|.
name|match_mask
operator|=
literal|0xffff
expr_stmt|;
name|tx_ctl_filt
operator|.
name|ether_type_da_range
operator|=
literal|0x888e
expr_stmt|;
name|ret
operator|=
name|nss_macsec_secy_tx_ctl_filt_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
literal|0
argument_list|,
operator|&
name|tx_ctl_filt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"nss_macsec_secy_tx_ctl_filt_set: FAIL"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|__macsec_drv_deinit
parameter_list|(
name|struct
name|macsec_qca_data
modifier|*
name|drv
parameter_list|)
block|{
name|nss_macsec_secy_en_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|nss_macsec_secy_rx_sc_del_all
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|)
expr_stmt|;
name|nss_macsec_secy_tx_sc_del_all
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|macsec_qca_init
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|drv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|drv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_strlcpy
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
comment|/* Board specific settings */
if|if
condition|(
name|os_memcmp
argument_list|(
literal|"eth2"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|drv
operator|->
name|secy_id
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|os_memcmp
argument_list|(
literal|"eth3"
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|drv
operator|->
name|secy_id
operator|=
literal|2
expr_stmt|;
else|else
name|drv
operator|->
name|secy_id
operator|=
operator|-
literal|1
expr_stmt|;
ifdef|#
directive|ifdef
name|__linux__
name|drv
operator|->
name|pf_sock
operator|=
name|socket
argument_list|(
name|PF_PACKET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|pf_sock
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"socket(PF_PACKET): %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* __linux__ */
name|drv
operator|->
name|pf_sock
operator|=
operator|-
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* __linux__ */
if|if
condition|(
name|macsec_qca_get_ifflags
argument_list|(
name|ifname
argument_list|,
operator|&
name|flags
argument_list|)
operator|==
literal|0
operator|&&
operator|!
operator|(
name|flags
operator|&
name|IFF_UP
operator|)
operator|&&
name|macsec_qca_set_ifflags
argument_list|(
name|ifname
argument_list|,
name|flags
operator||
name|IFF_UP
argument_list|)
operator|==
literal|0
condition|)
block|{
name|drv
operator|->
name|iff_up
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|macsec_qca_multicast_membership
argument_list|(
name|drv
operator|->
name|pf_sock
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|,
name|pae_group_addr
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Added multicast membership with packet socket"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|drv
operator|->
name|membership
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|macsec_qca_multi
argument_list|(
name|ifname
argument_list|,
name|pae_group_addr
argument_list|,
literal|1
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Added multicast membership with SIOCADDMULTI"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|drv
operator|->
name|multi
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|macsec_qca_get_ifflags
argument_list|(
name|ifname
argument_list|,
operator|&
name|flags
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s: Could not get interface flags"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
elseif|else
if|if
condition|(
name|flags
operator|&
name|IFF_ALLMULTI
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Interface is already configured for multicast"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|macsec_qca_set_ifflags
argument_list|(
name|ifname
argument_list|,
name|flags
operator||
name|IFF_ALLMULTI
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s: Failed to enable allmulti"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Enabled allmulti mode"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|drv
operator|->
name|iff_allmulti
operator|=
literal|1
expr_stmt|;
block|}
if|#
directive|if
name|defined
argument_list|(
name|__FreeBSD__
argument_list|)
operator|||
name|defined
argument_list|(
name|__DragonFly__
argument_list|)
operator|||
name|defined
argument_list|(
name|__FreeBSD_kernel__
argument_list|)
block|{
name|int
name|status
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: waiting for link to become active"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
while|while
condition|(
name|macsec_qca_get_ifstatus
argument_list|(
name|ifname
argument_list|,
operator|&
name|status
argument_list|)
operator|==
literal|0
operator|&&
name|status
operator|==
literal|0
condition|)
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* defined(__FreeBSD__) || defined(__DragonFly__) || defined(FreeBSD_kernel__) */
return|return
name|drv
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|macsec_qca_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|flags
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|membership
operator|&&
name|macsec_qca_multicast_membership
argument_list|(
name|drv
operator|->
name|pf_sock
argument_list|,
name|if_nametoindex
argument_list|(
name|drv
operator|->
name|ifname
argument_list|)
argument_list|,
name|pae_group_addr
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Failed to remove PAE multicast group (PACKET)"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|multi
operator|&&
name|macsec_qca_multi
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|pae_group_addr
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Failed to remove PAE multicast group (SIOCDELMULTI)"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|iff_allmulti
operator|&&
operator|(
name|macsec_qca_get_ifflags
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
operator|&
name|flags
argument_list|)
operator|<
literal|0
operator|||
name|macsec_qca_set_ifflags
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|flags
operator|&
operator|~
name|IFF_ALLMULTI
argument_list|)
operator|<
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Failed to disable allmulti mode"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|iff_up
operator|&&
name|macsec_qca_get_ifflags
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
operator|&
name|flags
argument_list|)
operator|==
literal|0
operator|&&
operator|(
name|flags
operator|&
name|IFF_UP
operator|)
operator|&&
name|macsec_qca_set_ifflags
argument_list|(
name|drv
operator|->
name|ifname
argument_list|,
name|flags
operator|&
operator|~
name|IFF_UP
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Failed to set the interface down"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|drv
operator|->
name|pf_sock
operator|!=
operator|-
literal|1
condition|)
name|close
argument_list|(
name|drv
operator|->
name|pf_sock
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|drv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_macsec_init
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|macsec_init_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|drv
operator|->
name|always_include_sci
operator|=
name|params
operator|->
name|always_include_sci
expr_stmt|;
name|drv
operator|->
name|use_es
operator|=
name|params
operator|->
name|use_es
expr_stmt|;
name|drv
operator|->
name|use_scb
operator|=
name|params
operator|->
name|use_scb
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: es=%d, scb=%d, sci=%d"
argument_list|,
name|__func__
argument_list|,
name|drv
operator|->
name|use_es
argument_list|,
name|drv
operator|->
name|use_scb
argument_list|,
name|drv
operator|->
name|always_include_sci
argument_list|)
expr_stmt|;
name|__macsec_drv_init
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_macsec_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|__macsec_drv_deinit
argument_list|(
name|drv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_enable_protect_frames
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|Boolean
name|enabled
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: enabled=%d"
argument_list|,
name|__func__
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
name|drv
operator|->
name|protect_frames
operator|=
name|enabled
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_set_replay_protect
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|Boolean
name|enabled
parameter_list|,
name|unsigned
name|int
name|window
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: enabled=%d, win=%u"
argument_list|,
name|__func__
argument_list|,
name|enabled
argument_list|,
name|window
argument_list|)
expr_stmt|;
name|drv
operator|->
name|replay_protect
operator|=
name|enabled
expr_stmt|;
name|drv
operator|->
name|replay_window
operator|=
name|window
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_set_current_cipher_suite
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
specifier|const
name|u8
modifier|*
name|cs
parameter_list|,
name|size_t
name|cs_len
parameter_list|)
block|{
name|u8
name|default_cs_id
index|[]
init|=
name|CS_ID_GCM_AES_128
decl_stmt|;
if|if
condition|(
name|cs_len
operator|!=
name|CS_ID_LEN
operator|||
name|os_memcmp
argument_list|(
name|cs
argument_list|,
name|default_cs_id
argument_list|,
name|cs_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"macsec: NOT supported CipherSuite"
argument_list|,
name|cs
argument_list|,
name|cs_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Support default Cipher Suite 0080020001000001 (GCM-AES-128) */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: default support aes-gcm-128"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_enable_controlled_port
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|Boolean
name|enabled
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: enable=%d"
argument_list|,
name|__func__
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_controlled_port_en_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_get_receive_lowest_pn
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
modifier|*
name|lowest_pn
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|u32
name|next_pn
init|=
literal|0
decl_stmt|;
name|bool
name|enabled
init|=
name|FALSE
decl_stmt|;
name|u32
name|win
decl_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sa_next_pn_get
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
operator|&
name|next_pn
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sc_replay_protect_get
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
operator|&
name|enabled
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sc_anti_replay_window_get
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
operator|&
name|win
argument_list|)
expr_stmt|;
if|if
condition|(
name|enabled
condition|)
operator|*
name|lowest_pn
operator|=
operator|(
name|next_pn
operator|>
name|win
operator|)
condition|?
operator|(
name|next_pn
operator|-
name|win
operator|)
else|:
literal|1
expr_stmt|;
else|else
operator|*
name|lowest_pn
operator|=
name|next_pn
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: lpn=0x%x"
argument_list|,
name|__func__
argument_list|,
operator|*
name|lowest_pn
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_get_transmit_next_pn
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
modifier|*
name|next_pn
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sa_next_pn_get
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|next_pn
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: npn=0x%x"
argument_list|,
name|__func__
argument_list|,
operator|*
name|next_pn
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|macsec_qca_set_transmit_next_pn
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
name|next_pn
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sa_next_pn_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|next_pn
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s: npn=0x%x"
argument_list|,
name|__func__
argument_list|,
name|next_pn
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_get_available_receive_sc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
modifier|*
name|channel
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|u32
name|sc_ch
init|=
literal|0
decl_stmt|;
name|bool
name|in_use
init|=
name|FALSE
decl_stmt|;
for|for
control|(
name|sc_ch
operator|=
literal|0
init|;
name|sc_ch
operator|<
name|MAXSC
condition|;
name|sc_ch
operator|++
control|)
block|{
name|ret
operator|=
name|nss_macsec_secy_rx_sc_in_used_get
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|sc_ch
argument_list|,
operator|&
name|in_use
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
continue|continue;
if|if
condition|(
operator|!
name|in_use
condition|)
block|{
operator|*
name|channel
operator|=
name|sc_ch
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d"
argument_list|,
name|__func__
argument_list|,
operator|*
name|channel
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: no available channel"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_create_receive_sc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
specifier|const
name|u8
modifier|*
name|sci_addr
parameter_list|,
name|u16
name|sci_port
parameter_list|,
name|unsigned
name|int
name|conf_offset
parameter_list|,
name|int
name|validation
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|fal_rx_prc_lut_t
name|entry
decl_stmt|;
name|fal_rx_sc_validate_frame_e
name|vf
decl_stmt|;
name|enum
name|validate_frames
name|validate_frames
init|=
name|validation
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|)
expr_stmt|;
comment|/* rx prc lut */
name|os_memset
argument_list|(
operator|&
name|entry
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|entry
operator|.
name|sci
argument_list|,
name|sci_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|entry
operator|.
name|sci
index|[
literal|6
index|]
operator|=
operator|(
name|sci_port
operator|>>
literal|8
operator|)
operator|&
literal|0xf
expr_stmt|;
name|entry
operator|.
name|sci
index|[
literal|7
index|]
operator|=
name|sci_port
operator|&
literal|0xf
expr_stmt|;
name|entry
operator|.
name|sci_mask
operator|=
literal|0xf
expr_stmt|;
name|entry
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
name|entry
operator|.
name|channel
operator|=
name|channel
expr_stmt|;
name|entry
operator|.
name|action
operator|=
name|FAL_RX_PRC_ACTION_PROCESS
expr_stmt|;
name|entry
operator|.
name|offset
operator|=
name|conf_offset
expr_stmt|;
comment|/* rx validate frame  */
if|if
condition|(
name|validate_frames
operator|==
name|Strict
condition|)
name|vf
operator|=
name|FAL_RX_SC_VALIDATE_FRAME_STRICT
expr_stmt|;
elseif|else
if|if
condition|(
name|validate_frames
operator|==
name|Checked
condition|)
name|vf
operator|=
name|FAL_RX_SC_VALIDATE_FRAME_CHECK
expr_stmt|;
else|else
name|vf
operator|=
name|FAL_RX_SC_VALIDATE_FRAME_DISABLED
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_prc_lut_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sc_create
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sc_validate_frame_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|vf
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sc_replay_protect_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|drv
operator|->
name|replay_protect
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sc_anti_replay_window_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|drv
operator|->
name|replay_window
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_delete_receive_sc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|fal_rx_prc_lut_t
name|entry
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|)
expr_stmt|;
comment|/* rx prc lut */
name|os_memset
argument_list|(
operator|&
name|entry
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sc_del
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_prc_lut_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_create_receive_sa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
name|lowest_pn
parameter_list|,
specifier|const
name|u8
modifier|*
name|sak
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|fal_rx_sak_t
name|rx_sak
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s, channel=%d, an=%d, lpn=0x%x"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|lowest_pn
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|rx_sak
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rx_sak
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|rx_sak
operator|.
name|sak
index|[
name|i
index|]
operator|=
name|sak
index|[
literal|15
operator|-
name|i
index|]
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sa_create
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sak_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
operator|&
name|rx_sak
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_enable_receive_sa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d, an=%d"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|,
name|an
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sa_en_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_disable_receive_sa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d, an=%d"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|,
name|an
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_rx_sa_en_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_get_available_transmit_sc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
modifier|*
name|channel
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|u32
name|sc_ch
init|=
literal|0
decl_stmt|;
name|bool
name|in_use
init|=
name|FALSE
decl_stmt|;
for|for
control|(
name|sc_ch
operator|=
literal|0
init|;
name|sc_ch
operator|<
name|MAXSC
condition|;
name|sc_ch
operator|++
control|)
block|{
name|ret
operator|=
name|nss_macsec_secy_tx_sc_in_used_get
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|sc_ch
argument_list|,
operator|&
name|in_use
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
continue|continue;
if|if
condition|(
operator|!
name|in_use
condition|)
block|{
operator|*
name|channel
operator|=
name|sc_ch
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d"
argument_list|,
name|__func__
argument_list|,
operator|*
name|channel
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: no avaiable channel"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_create_transmit_sc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
specifier|const
name|u8
modifier|*
name|sci_addr
parameter_list|,
name|u16
name|sci_port
parameter_list|,
name|unsigned
name|int
name|conf_offset
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|fal_tx_class_lut_t
name|entry
decl_stmt|;
name|u8
name|psci
index|[
name|ETH_ALEN
operator|+
literal|2
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|)
expr_stmt|;
comment|/* class lut */
name|os_memset
argument_list|(
operator|&
name|entry
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|entry
operator|.
name|valid
operator|=
literal|1
expr_stmt|;
name|entry
operator|.
name|action
operator|=
name|FAL_TX_CLASS_ACTION_FORWARD
expr_stmt|;
name|entry
operator|.
name|channel
operator|=
name|channel
expr_stmt|;
name|os_memcpy
argument_list|(
name|psci
argument_list|,
name|sci_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|psci
index|[
literal|6
index|]
operator|=
operator|(
name|sci_port
operator|>>
literal|8
operator|)
operator|&
literal|0xf
expr_stmt|;
name|psci
index|[
literal|7
index|]
operator|=
name|sci_port
operator|&
literal|0xf
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_class_lut_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sc_create
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|psci
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sc_protect_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|drv
operator|->
name|protect_frames
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sc_confidentiality_offset_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|conf_offset
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_delete_transmit_sc
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|fal_tx_class_lut_t
name|entry
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|)
expr_stmt|;
comment|/* class lut */
name|os_memset
argument_list|(
operator|&
name|entry
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_class_lut_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sc_del
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_create_transmit_sa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
name|next_pn
parameter_list|,
name|Boolean
name|confidentiality
parameter_list|,
specifier|const
name|u8
modifier|*
name|sak
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|u8
name|tci
init|=
literal|0
decl_stmt|;
name|fal_tx_sak_t
name|tx_sak
decl_stmt|;
name|int
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d, an=%d, next_pn=0x%x, confidentiality=%d"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|next_pn
argument_list|,
name|confidentiality
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|always_include_sci
condition|)
name|tci
operator||=
name|TCI_SC
expr_stmt|;
elseif|else
if|if
condition|(
name|drv
operator|->
name|use_es
condition|)
name|tci
operator||=
name|TCI_ES
expr_stmt|;
elseif|else
if|if
condition|(
name|drv
operator|->
name|use_scb
condition|)
name|tci
operator||=
name|TCI_SCB
expr_stmt|;
if|if
condition|(
name|confidentiality
condition|)
name|tci
operator||=
name|TCI_E
operator||
name|TCI_C
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|tx_sak
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|tx_sak
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|tx_sak
operator|.
name|sak
index|[
name|i
index|]
operator|=
name|sak
index|[
literal|15
operator|-
name|i
index|]
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sa_next_pn_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|next_pn
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sak_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
operator|&
name|tx_sak
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sc_tci_7_2_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
operator|(
name|tci
operator|>>
literal|2
operator|)
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sc_an_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_enable_transmit_sa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d, an=%d"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|,
name|an
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sa_en_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|macsec_qca_disable_transmit_sa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|)
block|{
name|struct
name|macsec_qca_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: channel=%d, an=%d"
argument_list|,
name|__func__
argument_list|,
name|channel
argument_list|,
name|an
argument_list|)
expr_stmt|;
name|ret
operator|+=
name|nss_macsec_secy_tx_sa_en_set
argument_list|(
name|drv
operator|->
name|secy_id
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|wpa_driver_ops
name|wpa_driver_macsec_qca_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"macsec_qca"
block|,
operator|.
name|desc
operator|=
literal|"QCA MACsec Ethernet driver"
block|,
operator|.
name|get_ssid
operator|=
name|macsec_qca_get_ssid
block|,
operator|.
name|get_bssid
operator|=
name|macsec_qca_get_bssid
block|,
operator|.
name|get_capa
operator|=
name|macsec_qca_get_capa
block|,
operator|.
name|init
operator|=
name|macsec_qca_init
block|,
operator|.
name|deinit
operator|=
name|macsec_qca_deinit
block|,
operator|.
name|macsec_init
operator|=
name|macsec_qca_macsec_init
block|,
operator|.
name|macsec_deinit
operator|=
name|macsec_qca_macsec_deinit
block|,
operator|.
name|enable_protect_frames
operator|=
name|macsec_qca_enable_protect_frames
block|,
operator|.
name|set_replay_protect
operator|=
name|macsec_qca_set_replay_protect
block|,
operator|.
name|set_current_cipher_suite
operator|=
name|macsec_qca_set_current_cipher_suite
block|,
operator|.
name|enable_controlled_port
operator|=
name|macsec_qca_enable_controlled_port
block|,
operator|.
name|get_receive_lowest_pn
operator|=
name|macsec_qca_get_receive_lowest_pn
block|,
operator|.
name|get_transmit_next_pn
operator|=
name|macsec_qca_get_transmit_next_pn
block|,
operator|.
name|set_transmit_next_pn
operator|=
name|macsec_qca_set_transmit_next_pn
block|,
operator|.
name|get_available_receive_sc
operator|=
name|macsec_qca_get_available_receive_sc
block|,
operator|.
name|create_receive_sc
operator|=
name|macsec_qca_create_receive_sc
block|,
operator|.
name|delete_receive_sc
operator|=
name|macsec_qca_delete_receive_sc
block|,
operator|.
name|create_receive_sa
operator|=
name|macsec_qca_create_receive_sa
block|,
operator|.
name|enable_receive_sa
operator|=
name|macsec_qca_enable_receive_sa
block|,
operator|.
name|disable_receive_sa
operator|=
name|macsec_qca_disable_receive_sa
block|,
operator|.
name|get_available_transmit_sc
operator|=
name|macsec_qca_get_available_transmit_sc
block|,
operator|.
name|create_transmit_sc
operator|=
name|macsec_qca_create_transmit_sc
block|,
operator|.
name|delete_transmit_sc
operator|=
name|macsec_qca_delete_transmit_sc
block|,
operator|.
name|create_transmit_sa
operator|=
name|macsec_qca_create_transmit_sa
block|,
operator|.
name|enable_transmit_sa
operator|=
name|macsec_qca_enable_transmit_sa
block|,
operator|.
name|disable_transmit_sa
operator|=
name|macsec_qca_disable_transmit_sa
block|, }
decl_stmt|;
end_decl_stmt

end_unit


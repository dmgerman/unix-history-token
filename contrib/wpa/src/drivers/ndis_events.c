begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ndis_events - Receive NdisMIndicateStatus() events using WMI  * Copyright (c) 2004-2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_define
define|#
directive|define
name|_WIN32_WINNT
value|0x0400
end_define

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|COBJMACROS
end_ifndef

begin_define
define|#
directive|define
name|COBJMACROS
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* COBJMACROS */
end_comment

begin_include
include|#
directive|include
file|<wbemidl.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_decl_stmt
specifier|static
name|int
name|wmi_refcnt
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|wmi_first
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|ndis_events_data
block|{
name|IWbemObjectSink
name|sink
decl_stmt|;
name|IWbemObjectSinkVtbl
name|sink_vtbl
decl_stmt|;
name|IWbemServices
modifier|*
name|pSvc
decl_stmt|;
name|IWbemLocator
modifier|*
name|pLoc
decl_stmt|;
name|HANDLE
name|read_pipe
decl_stmt|,
name|write_pipe
decl_stmt|,
name|event_avail
decl_stmt|;
name|UINT
name|ref
decl_stmt|;
name|int
name|terminating
decl_stmt|;
name|char
modifier|*
name|ifname
decl_stmt|;
comment|/* {GUID..} */
name|WCHAR
modifier|*
name|adapter_desc
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|BstrAlloc
parameter_list|(
name|x
parameter_list|)
value|(x) ? SysAllocString(x) : NULL
end_define

begin_define
define|#
directive|define
name|BstrFree
parameter_list|(
name|x
parameter_list|)
value|if (x) SysFreeString(x)
end_define

begin_comment
comment|/* WBEM / WMI wrapper functions, to perform in-place conversion of WCHARs to  * BSTRs */
end_comment

begin_function
name|HRESULT
name|STDMETHODCALLTYPE
name|call_IWbemServices_ExecQuery
parameter_list|(
name|IWbemServices
modifier|*
name|pSvc
parameter_list|,
name|LPCWSTR
name|strQueryLanguage
parameter_list|,
name|LPCWSTR
name|strQuery
parameter_list|,
name|long
name|lFlags
parameter_list|,
name|IWbemContext
modifier|*
name|pCtx
parameter_list|,
name|IEnumWbemClassObject
modifier|*
modifier|*
name|ppEnum
parameter_list|)
block|{
name|BSTR
name|bsQueryLanguage
decl_stmt|,
name|bsQuery
decl_stmt|;
name|HRESULT
name|hr
decl_stmt|;
name|bsQueryLanguage
operator|=
name|BstrAlloc
argument_list|(
name|strQueryLanguage
argument_list|)
expr_stmt|;
name|bsQuery
operator|=
name|BstrAlloc
argument_list|(
name|strQuery
argument_list|)
expr_stmt|;
name|hr
operator|=
name|IWbemServices_ExecQuery
argument_list|(
name|pSvc
argument_list|,
name|bsQueryLanguage
argument_list|,
name|bsQuery
argument_list|,
name|lFlags
argument_list|,
name|pCtx
argument_list|,
name|ppEnum
argument_list|)
expr_stmt|;
name|BstrFree
argument_list|(
name|bsQueryLanguage
argument_list|)
expr_stmt|;
name|BstrFree
argument_list|(
name|bsQuery
argument_list|)
expr_stmt|;
return|return
name|hr
return|;
block|}
end_function

begin_function
name|HRESULT
name|STDMETHODCALLTYPE
name|call_IWbemServices_ExecNotificationQueryAsync
parameter_list|(
name|IWbemServices
modifier|*
name|pSvc
parameter_list|,
name|LPCWSTR
name|strQueryLanguage
parameter_list|,
name|LPCWSTR
name|strQuery
parameter_list|,
name|long
name|lFlags
parameter_list|,
name|IWbemContext
modifier|*
name|pCtx
parameter_list|,
name|IWbemObjectSink
modifier|*
name|pResponseHandler
parameter_list|)
block|{
name|BSTR
name|bsQueryLanguage
decl_stmt|,
name|bsQuery
decl_stmt|;
name|HRESULT
name|hr
decl_stmt|;
name|bsQueryLanguage
operator|=
name|BstrAlloc
argument_list|(
name|strQueryLanguage
argument_list|)
expr_stmt|;
name|bsQuery
operator|=
name|BstrAlloc
argument_list|(
name|strQuery
argument_list|)
expr_stmt|;
name|hr
operator|=
name|IWbemServices_ExecNotificationQueryAsync
argument_list|(
name|pSvc
argument_list|,
name|bsQueryLanguage
argument_list|,
name|bsQuery
argument_list|,
name|lFlags
argument_list|,
name|pCtx
argument_list|,
name|pResponseHandler
argument_list|)
expr_stmt|;
name|BstrFree
argument_list|(
name|bsQueryLanguage
argument_list|)
expr_stmt|;
name|BstrFree
argument_list|(
name|bsQuery
argument_list|)
expr_stmt|;
return|return
name|hr
return|;
block|}
end_function

begin_function
name|HRESULT
name|STDMETHODCALLTYPE
name|call_IWbemLocator_ConnectServer
parameter_list|(
name|IWbemLocator
modifier|*
name|pLoc
parameter_list|,
name|LPCWSTR
name|strNetworkResource
parameter_list|,
name|LPCWSTR
name|strUser
parameter_list|,
name|LPCWSTR
name|strPassword
parameter_list|,
name|LPCWSTR
name|strLocale
parameter_list|,
name|long
name|lSecurityFlags
parameter_list|,
name|LPCWSTR
name|strAuthority
parameter_list|,
name|IWbemContext
modifier|*
name|pCtx
parameter_list|,
name|IWbemServices
modifier|*
modifier|*
name|ppNamespace
parameter_list|)
block|{
name|BSTR
name|bsNetworkResource
decl_stmt|,
name|bsUser
decl_stmt|,
name|bsPassword
decl_stmt|,
name|bsLocale
decl_stmt|,
name|bsAuthority
decl_stmt|;
name|HRESULT
name|hr
decl_stmt|;
name|bsNetworkResource
operator|=
name|BstrAlloc
argument_list|(
name|strNetworkResource
argument_list|)
expr_stmt|;
name|bsUser
operator|=
name|BstrAlloc
argument_list|(
name|strUser
argument_list|)
expr_stmt|;
name|bsPassword
operator|=
name|BstrAlloc
argument_list|(
name|strPassword
argument_list|)
expr_stmt|;
name|bsLocale
operator|=
name|BstrAlloc
argument_list|(
name|strLocale
argument_list|)
expr_stmt|;
name|bsAuthority
operator|=
name|BstrAlloc
argument_list|(
name|strAuthority
argument_list|)
expr_stmt|;
name|hr
operator|=
name|IWbemLocator_ConnectServer
argument_list|(
name|pLoc
argument_list|,
name|bsNetworkResource
argument_list|,
name|bsUser
argument_list|,
name|bsPassword
argument_list|,
name|bsLocale
argument_list|,
name|lSecurityFlags
argument_list|,
name|bsAuthority
argument_list|,
name|pCtx
argument_list|,
name|ppNamespace
argument_list|)
expr_stmt|;
name|BstrFree
argument_list|(
name|bsNetworkResource
argument_list|)
expr_stmt|;
name|BstrFree
argument_list|(
name|bsUser
argument_list|)
expr_stmt|;
name|BstrFree
argument_list|(
name|bsPassword
argument_list|)
expr_stmt|;
name|BstrFree
argument_list|(
name|bsLocale
argument_list|)
expr_stmt|;
name|BstrFree
argument_list|(
name|bsAuthority
argument_list|)
expr_stmt|;
return|return
name|hr
return|;
block|}
end_function

begin_enum
enum|enum
name|event_types
block|{
name|EVENT_CONNECT
block|,
name|EVENT_DISCONNECT
block|,
name|EVENT_MEDIA_SPECIFIC
block|,
name|EVENT_ADAPTER_ARRIVAL
block|,
name|EVENT_ADAPTER_REMOVAL
block|}
enum|;
end_enum

begin_function_decl
specifier|static
name|int
name|ndis_events_get_adapter
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|char
modifier|*
name|desc
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|ndis_events_constructor
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|)
block|{
name|events
operator|->
name|ref
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|CreatePipe
argument_list|(
operator|&
name|events
operator|->
name|read_pipe
argument_list|,
operator|&
name|events
operator|->
name|write_pipe
argument_list|,
name|NULL
argument_list|,
literal|512
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"CreatePipe() failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|events
operator|->
name|event_avail
operator|=
name|CreateEvent
argument_list|(
name|NULL
argument_list|,
name|TRUE
argument_list|,
name|FALSE
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|->
name|event_avail
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"CreateEvent() failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
name|CloseHandle
argument_list|(
name|events
operator|->
name|read_pipe
argument_list|)
expr_stmt|;
name|CloseHandle
argument_list|(
name|events
operator|->
name|write_pipe
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ndis_events_destructor
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|)
block|{
name|CloseHandle
argument_list|(
name|events
operator|->
name|read_pipe
argument_list|)
expr_stmt|;
name|CloseHandle
argument_list|(
name|events
operator|->
name|write_pipe
argument_list|)
expr_stmt|;
name|CloseHandle
argument_list|(
name|events
operator|->
name|event_avail
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|events
operator|->
name|pSvc
argument_list|)
expr_stmt|;
name|IWbemLocator_Release
argument_list|(
name|events
operator|->
name|pLoc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|wmi_refcnt
operator|==
literal|0
condition|)
name|CoUninitialize
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|HRESULT
name|STDMETHODCALLTYPE
name|ndis_events_query_interface
parameter_list|(
name|IWbemObjectSink
modifier|*
name|this
parameter_list|,
name|REFIID
name|riid
parameter_list|,
name|void
modifier|*
modifier|*
name|obj
parameter_list|)
block|{
operator|*
name|obj
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|IsEqualIID
argument_list|(
name|riid
argument_list|,
operator|&
name|IID_IUnknown
argument_list|)
operator|||
name|IsEqualIID
argument_list|(
name|riid
argument_list|,
operator|&
name|IID_IWbemObjectSink
argument_list|)
condition|)
block|{
operator|*
name|obj
operator|=
name|this
expr_stmt|;
name|IWbemObjectSink_AddRef
argument_list|(
name|this
argument_list|)
expr_stmt|;
return|return
name|NOERROR
return|;
block|}
return|return
name|E_NOINTERFACE
return|;
block|}
end_function

begin_function
specifier|static
name|ULONG
name|STDMETHODCALLTYPE
name|ndis_events_add_ref
parameter_list|(
name|IWbemObjectSink
modifier|*
name|this
parameter_list|)
block|{
name|struct
name|ndis_events_data
modifier|*
name|events
init|=
operator|(
expr|struct
name|ndis_events_data
operator|*
operator|)
name|this
decl_stmt|;
return|return
operator|++
name|events
operator|->
name|ref
return|;
block|}
end_function

begin_function
specifier|static
name|ULONG
name|STDMETHODCALLTYPE
name|ndis_events_release
parameter_list|(
name|IWbemObjectSink
modifier|*
name|this
parameter_list|)
block|{
name|struct
name|ndis_events_data
modifier|*
name|events
init|=
operator|(
expr|struct
name|ndis_events_data
operator|*
operator|)
name|this
decl_stmt|;
if|if
condition|(
operator|--
name|events
operator|->
name|ref
operator|!=
literal|0
condition|)
return|return
name|events
operator|->
name|ref
return|;
name|ndis_events_destructor
argument_list|(
name|events
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: terminated"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|events
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|events
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|events
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_events_send_event
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|,
name|enum
name|event_types
name|type
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|_type
decl_stmt|;
name|DWORD
name|written
decl_stmt|;
name|end
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|_type
operator|=
operator|(
name|int
operator|)
name|type
expr_stmt|;
name|os_memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|_type
argument_list|,
sizeof|sizeof
argument_list|(
name|_type
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
block|{
if|if
condition|(
literal|2
operator|+
name|data_len
operator|>
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Not enough room for send_event "
literal|"data (%d)"
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|pos
operator|++
operator|=
name|data_len
operator|>>
literal|8
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|data_len
operator|&
literal|0xff
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|data_len
expr_stmt|;
block|}
if|if
condition|(
name|WriteFile
argument_list|(
name|events
operator|->
name|write_pipe
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
operator|&
name|written
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|SetEvent
argument_list|(
name|events
operator|->
name|event_avail
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WriteFile() failed: %d"
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ndis_events_media_connect
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MSNdis_StatusMediaConnect"
argument_list|)
expr_stmt|;
name|ndis_events_send_event
argument_list|(
name|events
argument_list|,
name|EVENT_CONNECT
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ndis_events_media_disconnect
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MSNdis_StatusMediaDisconnect"
argument_list|)
expr_stmt|;
name|ndis_events_send_event
argument_list|(
name|events
argument_list|,
name|EVENT_DISCONNECT
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ndis_events_media_specific
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|,
name|IWbemClassObject
modifier|*
name|pObj
parameter_list|)
block|{
name|VARIANT
name|vt
decl_stmt|;
name|HRESULT
name|hr
decl_stmt|;
name|LONG
name|lower
decl_stmt|,
name|upper
decl_stmt|,
name|k
decl_stmt|;
name|UCHAR
name|ch
decl_stmt|;
name|char
modifier|*
name|data
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|data_len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MSNdis_StatusMediaSpecificIndication"
argument_list|)
expr_stmt|;
comment|/* This is the StatusBuffer from NdisMIndicateStatus() call */
name|hr
operator|=
name|IWbemClassObject_Get
argument_list|(
name|pObj
argument_list|,
literal|L"NdisStatusMediaSpecificIndication"
argument_list|,
literal|0
argument_list|,
operator|&
name|vt
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Could not get "
literal|"NdisStatusMediaSpecificIndication from "
literal|"the object?!"
argument_list|)
expr_stmt|;
return|return;
block|}
name|SafeArrayGetLBound
argument_list|(
name|V_ARRAY
argument_list|(
operator|&
name|vt
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|lower
argument_list|)
expr_stmt|;
name|SafeArrayGetUBound
argument_list|(
name|V_ARRAY
argument_list|(
operator|&
name|vt
argument_list|)
argument_list|,
literal|1
argument_list|,
operator|&
name|upper
argument_list|)
expr_stmt|;
name|data_len
operator|=
name|upper
operator|-
name|lower
operator|+
literal|1
expr_stmt|;
name|data
operator|=
name|os_malloc
argument_list|(
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to allocate buffer for event "
literal|"data"
argument_list|)
expr_stmt|;
name|VariantClear
argument_list|(
operator|&
name|vt
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|=
name|data
expr_stmt|;
for|for
control|(
name|k
operator|=
name|lower
init|;
name|k
operator|<=
name|upper
condition|;
name|k
operator|++
control|)
block|{
name|SafeArrayGetElement
argument_list|(
name|V_ARRAY
argument_list|(
operator|&
name|vt
argument_list|)
argument_list|,
operator|&
name|k
argument_list|,
operator|&
name|ch
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|ch
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MediaSpecificEvent"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|VariantClear
argument_list|(
operator|&
name|vt
argument_list|)
expr_stmt|;
name|ndis_events_send_event
argument_list|(
name|events
argument_list|,
name|EVENT_MEDIA_SPECIFIC
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ndis_events_adapter_arrival
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MSNdis_NotifyAdapterArrival"
argument_list|)
expr_stmt|;
name|ndis_events_send_event
argument_list|(
name|events
argument_list|,
name|EVENT_ADAPTER_ARRIVAL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ndis_events_adapter_removal
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MSNdis_NotifyAdapterRemoval"
argument_list|)
expr_stmt|;
name|ndis_events_send_event
argument_list|(
name|events
argument_list|,
name|EVENT_ADAPTER_REMOVAL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|HRESULT
name|STDMETHODCALLTYPE
name|ndis_events_indicate
parameter_list|(
name|IWbemObjectSink
modifier|*
name|this
parameter_list|,
name|long
name|lObjectCount
parameter_list|,
name|IWbemClassObject
name|__RPC_FAR
modifier|*
name|__RPC_FAR
modifier|*
name|ppObjArray
parameter_list|)
block|{
name|struct
name|ndis_events_data
modifier|*
name|events
init|=
operator|(
expr|struct
name|ndis_events_data
operator|*
operator|)
name|this
decl_stmt|;
name|long
name|i
decl_stmt|;
if|if
condition|(
name|events
operator|->
name|terminating
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events_indicate: Ignore "
literal|"indication - terminating"
argument_list|)
expr_stmt|;
return|return
name|WBEM_NO_ERROR
return|;
block|}
comment|/* wpa_printf(MSG_DEBUG, "Notification received - %d object(s)", 	   lObjectCount); */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|lObjectCount
condition|;
name|i
operator|++
control|)
block|{
name|IWbemClassObject
modifier|*
name|pObj
init|=
name|ppObjArray
index|[
name|i
index|]
decl_stmt|;
name|HRESULT
name|hr
decl_stmt|;
name|VARIANT
name|vtClass
decl_stmt|,
name|vt
decl_stmt|;
name|hr
operator|=
name|IWbemClassObject_Get
argument_list|(
name|pObj
argument_list|,
literal|L"__CLASS"
argument_list|,
literal|0
argument_list|,
operator|&
name|vtClass
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to get __CLASS from "
literal|"event."
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* wpa_printf(MSG_DEBUG, "CLASS: '%S'", vtClass.bstrVal); */
name|hr
operator|=
name|IWbemClassObject_Get
argument_list|(
name|pObj
argument_list|,
literal|L"InstanceName"
argument_list|,
literal|0
argument_list|,
operator|&
name|vt
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to get InstanceName "
literal|"from event."
argument_list|)
expr_stmt|;
name|VariantClear
argument_list|(
operator|&
name|vtClass
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wcscmp
argument_list|(
name|vtClass
operator|.
name|bstrVal
argument_list|,
literal|L"MSNdis_NotifyAdapterArrival"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events_indicate: Try to "
literal|"update adapter description since it may "
literal|"have changed with new adapter instance"
argument_list|)
expr_stmt|;
name|ndis_events_get_adapter
argument_list|(
name|events
argument_list|,
name|events
operator|->
name|ifname
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wcscmp
argument_list|(
name|events
operator|->
name|adapter_desc
argument_list|,
name|vt
operator|.
name|bstrVal
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events_indicate: Ignore "
literal|"indication for foreign adapter: "
literal|"InstanceName: '%S' __CLASS: '%S'"
argument_list|,
name|vt
operator|.
name|bstrVal
argument_list|,
name|vtClass
operator|.
name|bstrVal
argument_list|)
expr_stmt|;
name|VariantClear
argument_list|(
operator|&
name|vtClass
argument_list|)
expr_stmt|;
name|VariantClear
argument_list|(
operator|&
name|vt
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|VariantClear
argument_list|(
operator|&
name|vt
argument_list|)
expr_stmt|;
if|if
condition|(
name|wcscmp
argument_list|(
name|vtClass
operator|.
name|bstrVal
argument_list|,
literal|L"MSNdis_StatusMediaSpecificIndication"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ndis_events_media_specific
argument_list|(
name|events
argument_list|,
name|pObj
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wcscmp
argument_list|(
name|vtClass
operator|.
name|bstrVal
argument_list|,
literal|L"MSNdis_StatusMediaConnect"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ndis_events_media_connect
argument_list|(
name|events
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wcscmp
argument_list|(
name|vtClass
operator|.
name|bstrVal
argument_list|,
literal|L"MSNdis_StatusMediaDisconnect"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ndis_events_media_disconnect
argument_list|(
name|events
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wcscmp
argument_list|(
name|vtClass
operator|.
name|bstrVal
argument_list|,
literal|L"MSNdis_NotifyAdapterArrival"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ndis_events_adapter_arrival
argument_list|(
name|events
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wcscmp
argument_list|(
name|vtClass
operator|.
name|bstrVal
argument_list|,
literal|L"MSNdis_NotifyAdapterRemoval"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ndis_events_adapter_removal
argument_list|(
name|events
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unepected event - __CLASS: "
literal|"'%S'"
argument_list|,
name|vtClass
operator|.
name|bstrVal
argument_list|)
expr_stmt|;
block|}
name|VariantClear
argument_list|(
operator|&
name|vtClass
argument_list|)
expr_stmt|;
block|}
return|return
name|WBEM_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|HRESULT
name|STDMETHODCALLTYPE
name|ndis_events_set_status
parameter_list|(
name|IWbemObjectSink
modifier|*
name|this
parameter_list|,
name|long
name|lFlags
parameter_list|,
name|HRESULT
name|hResult
parameter_list|,
name|BSTR
name|strParam
parameter_list|,
name|IWbemClassObject
name|__RPC_FAR
modifier|*
name|pObjParam
parameter_list|)
block|{
return|return
name|WBEM_NO_ERROR
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|notification_query
parameter_list|(
name|IWbemObjectSink
modifier|*
name|pDestSink
parameter_list|,
name|IWbemServices
modifier|*
name|pSvc
parameter_list|,
specifier|const
name|char
modifier|*
name|class_name
parameter_list|)
block|{
name|HRESULT
name|hr
decl_stmt|;
name|WCHAR
name|query
index|[
literal|256
index|]
decl_stmt|;
name|_snwprintf
argument_list|(
name|query
argument_list|,
literal|256
argument_list|,
literal|L"SELECT * FROM %S"
argument_list|,
name|class_name
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: WMI: %S"
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|hr
operator|=
name|call_IWbemServices_ExecNotificationQueryAsync
argument_list|(
name|pSvc
argument_list|,
literal|L"WQL"
argument_list|,
name|query
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|pDestSink
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ExecNotificationQueryAsync for %s "
literal|"failed with hresult of 0x%x"
argument_list|,
name|class_name
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|register_async_notification
parameter_list|(
name|IWbemObjectSink
modifier|*
name|pDestSink
parameter_list|,
name|IWbemServices
modifier|*
name|pSvc
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
specifier|const
name|char
modifier|*
name|class_list
index|[]
init|=
block|{
literal|"MSNdis_StatusMediaConnect"
block|,
literal|"MSNdis_StatusMediaDisconnect"
block|,
literal|"MSNdis_StatusMediaSpecificIndication"
block|,
literal|"MSNdis_NotifyAdapterArrival"
block|,
literal|"MSNdis_NotifyAdapterRemoval"
block|,
name|NULL
block|}
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|class_list
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|notification_query
argument_list|(
name|pDestSink
argument_list|,
name|pSvc
argument_list|,
name|class_list
index|[
name|i
index|]
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ndis_events_deinit
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|)
block|{
name|events
operator|->
name|terminating
operator|=
literal|1
expr_stmt|;
name|IWbemServices_CancelAsyncCall
argument_list|(
name|events
operator|->
name|pSvc
argument_list|,
operator|&
name|events
operator|->
name|sink
argument_list|)
expr_stmt|;
name|IWbemObjectSink_Release
argument_list|(
operator|&
name|events
operator|->
name|sink
argument_list|)
expr_stmt|;
comment|/* 	 * Rest of deinitialization is done in ndis_events_destructor() once 	 * all reference count drops to zero. 	 */
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_events_use_desc
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|,
specifier|const
name|char
modifier|*
name|desc
parameter_list|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|desc
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|events
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Continue using old description */
return|return
literal|0
return|;
block|}
name|tmp
operator|=
name|os_strdup
argument_list|(
name|desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|tmp
argument_list|,
literal|" (Microsoft's Packet Scheduler)"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|events
operator|->
name|adapter_desc
operator|=
name|os_malloc
argument_list|(
operator|(
name|len
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|WCHAR
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|_snwprintf
argument_list|(
name|events
operator|->
name|adapter_desc
argument_list|,
name|len
operator|+
literal|1
argument_list|,
literal|L"%S"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ndis_events_get_adapter
parameter_list|(
name|struct
name|ndis_events_data
modifier|*
name|events
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|char
modifier|*
name|desc
parameter_list|)
block|{
name|HRESULT
name|hr
decl_stmt|;
name|IWbemServices
modifier|*
name|pSvc
decl_stmt|;
define|#
directive|define
name|MAX_QUERY_LEN
value|256
name|WCHAR
name|query
index|[
name|MAX_QUERY_LEN
index|]
decl_stmt|;
name|IEnumWbemClassObject
modifier|*
name|pEnumerator
decl_stmt|;
name|IWbemClassObject
modifier|*
name|pObj
decl_stmt|;
name|ULONG
name|uReturned
decl_stmt|;
name|VARIANT
name|vt
decl_stmt|;
name|int
name|len
decl_stmt|,
name|pos
decl_stmt|;
comment|/* 	 * Try to get adapter descriptor through WMI CIMv2 Win32_NetworkAdapter 	 * to have better probability of matching with InstanceName from 	 * MSNdis events. If this fails, use the provided description. 	 */
name|os_free
argument_list|(
name|events
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
name|events
operator|->
name|adapter_desc
operator|=
name|NULL
expr_stmt|;
name|hr
operator|=
name|call_IWbemLocator_ConnectServer
argument_list|(
name|events
operator|->
name|pLoc
argument_list|,
literal|L"ROOT\\CIMV2"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|pSvc
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ndis_events: Could not connect to WMI "
literal|"server (ROOT\\CIMV2) - error 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Connected to ROOT\\CIMV2."
argument_list|)
expr_stmt|;
name|_snwprintf
argument_list|(
name|query
argument_list|,
name|MAX_QUERY_LEN
argument_list|,
literal|L"SELECT Index FROM Win32_NetworkAdapterConfiguration "
literal|L"WHERE SettingID='%S'"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: WMI: %S"
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|hr
operator|=
name|call_IWbemServices_ExecQuery
argument_list|(
name|pSvc
argument_list|,
literal|L"WQL"
argument_list|,
name|query
argument_list|,
name|WBEM_FLAG_FORWARD_ONLY
operator||
name|WBEM_FLAG_RETURN_IMMEDIATELY
argument_list|,
name|NULL
argument_list|,
operator|&
name|pEnumerator
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SUCCEEDED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Failed to query interface "
literal|"GUID from Win32_NetworkAdapterConfiguration: "
literal|"0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
block|}
name|uReturned
operator|=
literal|0
expr_stmt|;
name|hr
operator|=
name|IEnumWbemClassObject_Next
argument_list|(
name|pEnumerator
argument_list|,
name|WBEM_INFINITE
argument_list|,
literal|1
argument_list|,
operator|&
name|pObj
argument_list|,
operator|&
name|uReturned
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SUCCEEDED
argument_list|(
name|hr
argument_list|)
operator|||
name|uReturned
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Failed to find interface "
literal|"GUID from Win32_NetworkAdapterConfiguration: "
literal|"0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|IEnumWbemClassObject_Release
argument_list|(
name|pEnumerator
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
block|}
name|IEnumWbemClassObject_Release
argument_list|(
name|pEnumerator
argument_list|)
expr_stmt|;
name|VariantInit
argument_list|(
operator|&
name|vt
argument_list|)
expr_stmt|;
name|hr
operator|=
name|IWbemClassObject_Get
argument_list|(
name|pObj
argument_list|,
literal|L"Index"
argument_list|,
literal|0
argument_list|,
operator|&
name|vt
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SUCCEEDED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Failed to get Index from "
literal|"Win32_NetworkAdapterConfiguration: 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
block|}
name|_snwprintf
argument_list|(
name|query
argument_list|,
name|MAX_QUERY_LEN
argument_list|,
literal|L"SELECT Name,PNPDeviceID FROM Win32_NetworkAdapter WHERE "
literal|L"Index=%d"
argument_list|,
name|vt
operator|.
name|uintVal
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: WMI: %S"
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|VariantClear
argument_list|(
operator|&
name|vt
argument_list|)
expr_stmt|;
name|IWbemClassObject_Release
argument_list|(
name|pObj
argument_list|)
expr_stmt|;
name|hr
operator|=
name|call_IWbemServices_ExecQuery
argument_list|(
name|pSvc
argument_list|,
literal|L"WQL"
argument_list|,
name|query
argument_list|,
name|WBEM_FLAG_FORWARD_ONLY
operator||
name|WBEM_FLAG_RETURN_IMMEDIATELY
argument_list|,
name|NULL
argument_list|,
operator|&
name|pEnumerator
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SUCCEEDED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Failed to query interface "
literal|"from Win32_NetworkAdapter: 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
block|}
name|uReturned
operator|=
literal|0
expr_stmt|;
name|hr
operator|=
name|IEnumWbemClassObject_Next
argument_list|(
name|pEnumerator
argument_list|,
name|WBEM_INFINITE
argument_list|,
literal|1
argument_list|,
operator|&
name|pObj
argument_list|,
operator|&
name|uReturned
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SUCCEEDED
argument_list|(
name|hr
argument_list|)
operator|||
name|uReturned
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Failed to find interface "
literal|"from Win32_NetworkAdapter: 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|IEnumWbemClassObject_Release
argument_list|(
name|pEnumerator
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
block|}
name|IEnumWbemClassObject_Release
argument_list|(
name|pEnumerator
argument_list|)
expr_stmt|;
name|hr
operator|=
name|IWbemClassObject_Get
argument_list|(
name|pObj
argument_list|,
literal|L"Name"
argument_list|,
literal|0
argument_list|,
operator|&
name|vt
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SUCCEEDED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Failed to get Name from "
literal|"Win32_NetworkAdapter: 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|IWbemClassObject_Release
argument_list|(
name|pObj
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Win32_NetworkAdapter::Name='%S'"
argument_list|,
name|vt
operator|.
name|bstrVal
argument_list|)
expr_stmt|;
name|events
operator|->
name|adapter_desc
operator|=
name|_wcsdup
argument_list|(
name|vt
operator|.
name|bstrVal
argument_list|)
expr_stmt|;
name|VariantClear
argument_list|(
operator|&
name|vt
argument_list|)
expr_stmt|;
comment|/* 	 * Try to get even better candidate for matching with InstanceName 	 * from Win32_PnPEntity. This is needed at least for some USB cards 	 * that can change the InstanceName whenever being unplugged and 	 * plugged again. 	 */
name|hr
operator|=
name|IWbemClassObject_Get
argument_list|(
name|pObj
argument_list|,
literal|L"PNPDeviceID"
argument_list|,
literal|0
argument_list|,
operator|&
name|vt
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SUCCEEDED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Failed to get PNPDeviceID "
literal|"from Win32_NetworkAdapter: 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|IWbemClassObject_Release
argument_list|(
name|pObj
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
return|return
literal|0
return|;
comment|/* use Win32_NetworkAdapter::Name */
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Win32_NetworkAdapter::PNPDeviceID="
literal|"'%S'"
argument_list|,
name|vt
operator|.
name|bstrVal
argument_list|)
expr_stmt|;
name|len
operator|=
name|_snwprintf
argument_list|(
name|query
argument_list|,
name|MAX_QUERY_LEN
argument_list|,
literal|L"SELECT Name FROM Win32_PnPEntity WHERE DeviceID='"
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|0
operator|||
name|len
operator|>=
name|MAX_QUERY_LEN
operator|-
literal|1
condition|)
block|{
name|VariantClear
argument_list|(
operator|&
name|vt
argument_list|)
expr_stmt|;
name|IWbemClassObject_Release
argument_list|(
name|pObj
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
return|return
literal|0
return|;
comment|/* use Win32_NetworkAdapter::Name */
block|}
comment|/* Escape \ as \\ */
for|for
control|(
name|pos
operator|=
literal|0
init|;
name|vt
operator|.
name|bstrVal
index|[
name|pos
index|]
operator|&&
name|len
operator|<
name|MAX_QUERY_LEN
operator|-
literal|2
condition|;
name|pos
operator|++
control|)
block|{
if|if
condition|(
name|vt
operator|.
name|bstrVal
index|[
name|pos
index|]
operator|==
literal|'\\'
condition|)
block|{
if|if
condition|(
name|len
operator|>=
name|MAX_QUERY_LEN
operator|-
literal|3
condition|)
break|break;
name|query
index|[
name|len
operator|++
index|]
operator|=
literal|'\\'
expr_stmt|;
block|}
name|query
index|[
name|len
operator|++
index|]
operator|=
name|vt
operator|.
name|bstrVal
index|[
name|pos
index|]
expr_stmt|;
block|}
name|query
index|[
name|len
operator|++
index|]
operator|=
literal|L'
expr|\''
expr_stmt|;
name|query
index|[
name|len
index|]
operator|=
literal|L'
expr|\0'
expr_stmt|;
name|VariantClear
argument_list|(
operator|&
name|vt
argument_list|)
expr_stmt|;
name|IWbemClassObject_Release
argument_list|(
name|pObj
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: WMI: %S"
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|hr
operator|=
name|call_IWbemServices_ExecQuery
argument_list|(
name|pSvc
argument_list|,
literal|L"WQL"
argument_list|,
name|query
argument_list|,
name|WBEM_FLAG_FORWARD_ONLY
operator||
name|WBEM_FLAG_RETURN_IMMEDIATELY
argument_list|,
name|NULL
argument_list|,
operator|&
name|pEnumerator
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SUCCEEDED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Failed to query interface "
literal|"Name from Win32_PnPEntity: 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
return|return
literal|0
return|;
comment|/* use Win32_NetworkAdapter::Name */
block|}
name|uReturned
operator|=
literal|0
expr_stmt|;
name|hr
operator|=
name|IEnumWbemClassObject_Next
argument_list|(
name|pEnumerator
argument_list|,
name|WBEM_INFINITE
argument_list|,
literal|1
argument_list|,
operator|&
name|pObj
argument_list|,
operator|&
name|uReturned
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SUCCEEDED
argument_list|(
name|hr
argument_list|)
operator|||
name|uReturned
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Failed to find interface "
literal|"from Win32_PnPEntity: 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|IEnumWbemClassObject_Release
argument_list|(
name|pEnumerator
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
return|return
literal|0
return|;
comment|/* use Win32_NetworkAdapter::Name */
block|}
name|IEnumWbemClassObject_Release
argument_list|(
name|pEnumerator
argument_list|)
expr_stmt|;
name|hr
operator|=
name|IWbemClassObject_Get
argument_list|(
name|pObj
argument_list|,
literal|L"Name"
argument_list|,
literal|0
argument_list|,
operator|&
name|vt
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|SUCCEEDED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Failed to get Name from "
literal|"Win32_PnPEntity: 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|IWbemClassObject_Release
argument_list|(
name|pObj
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
return|return
literal|0
return|;
comment|/* use Win32_NetworkAdapter::Name */
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: Win32_PnPEntity::Name='%S'"
argument_list|,
name|vt
operator|.
name|bstrVal
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|events
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
name|events
operator|->
name|adapter_desc
operator|=
name|_wcsdup
argument_list|(
name|vt
operator|.
name|bstrVal
argument_list|)
expr_stmt|;
name|VariantClear
argument_list|(
operator|&
name|vt
argument_list|)
expr_stmt|;
name|IWbemClassObject_Release
argument_list|(
name|pObj
argument_list|)
expr_stmt|;
name|IWbemServices_Release
argument_list|(
name|pSvc
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|->
name|adapter_desc
operator|==
name|NULL
condition|)
return|return
name|ndis_events_use_desc
argument_list|(
name|events
argument_list|,
name|desc
argument_list|)
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|ndis_events_data
modifier|*
name|ndis_events_init
parameter_list|(
name|HANDLE
modifier|*
name|read_pipe
parameter_list|,
name|HANDLE
modifier|*
name|event_avail
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|char
modifier|*
name|desc
parameter_list|)
block|{
name|HRESULT
name|hr
decl_stmt|;
name|IWbemObjectSink
modifier|*
name|pSink
decl_stmt|;
name|struct
name|ndis_events_data
modifier|*
name|events
decl_stmt|;
name|events
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|events
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not allocate sink for events."
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|events
operator|->
name|ifname
operator|=
name|os_strdup
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|events
operator|->
name|ifname
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|events
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wmi_refcnt
operator|++
operator|==
literal|0
condition|)
block|{
name|hr
operator|=
name|CoInitializeEx
argument_list|(
literal|0
argument_list|,
name|COINIT_MULTITHREADED
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"CoInitializeEx() failed - "
literal|"returned 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|events
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|wmi_first
condition|)
block|{
comment|/* CoInitializeSecurity() must be called once and only once 		 * per process, so let's use wmi_first flag to protect against 		 * multiple calls. */
name|wmi_first
operator|=
literal|0
expr_stmt|;
name|hr
operator|=
name|CoInitializeSecurity
argument_list|(
name|NULL
argument_list|,
operator|-
literal|1
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|RPC_C_AUTHN_LEVEL_PKT_PRIVACY
argument_list|,
name|RPC_C_IMP_LEVEL_IMPERSONATE
argument_list|,
name|NULL
argument_list|,
name|EOAC_SECURE_REFS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"CoInitializeSecurity() failed "
literal|"- returned 0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|events
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|hr
operator|=
name|CoCreateInstance
argument_list|(
operator|&
name|CLSID_WbemLocator
argument_list|,
literal|0
argument_list|,
name|CLSCTX_INPROC_SERVER
argument_list|,
operator|&
name|IID_IWbemLocator
argument_list|,
operator|(
name|LPVOID
operator|*
operator|)
operator|(
name|void
operator|*
operator|)
operator|&
name|events
operator|->
name|pLoc
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"CoCreateInstance() failed - returned "
literal|"0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|CoUninitialize
argument_list|()
expr_stmt|;
name|os_free
argument_list|(
name|events
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|ndis_events_get_adapter
argument_list|(
name|events
argument_list|,
name|ifname
argument_list|,
name|desc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|CoUninitialize
argument_list|()
expr_stmt|;
name|os_free
argument_list|(
name|events
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ndis_events: use adapter descriptor '%S'"
argument_list|,
name|events
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
name|hr
operator|=
name|call_IWbemLocator_ConnectServer
argument_list|(
name|events
operator|->
name|pLoc
argument_list|,
literal|L"ROOT\\WMI"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|events
operator|->
name|pSvc
argument_list|)
expr_stmt|;
if|if
condition|(
name|FAILED
argument_list|(
name|hr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not connect to server - error "
literal|"0x%x"
argument_list|,
operator|(
name|int
operator|)
name|hr
argument_list|)
expr_stmt|;
name|CoUninitialize
argument_list|()
expr_stmt|;
name|os_free
argument_list|(
name|events
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|events
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Connected to ROOT\\WMI."
argument_list|)
expr_stmt|;
name|ndis_events_constructor
argument_list|(
name|events
argument_list|)
expr_stmt|;
name|pSink
operator|=
operator|&
name|events
operator|->
name|sink
expr_stmt|;
name|pSink
operator|->
name|lpVtbl
operator|=
operator|&
name|events
operator|->
name|sink_vtbl
expr_stmt|;
name|events
operator|->
name|sink_vtbl
operator|.
name|QueryInterface
operator|=
name|ndis_events_query_interface
expr_stmt|;
name|events
operator|->
name|sink_vtbl
operator|.
name|AddRef
operator|=
name|ndis_events_add_ref
expr_stmt|;
name|events
operator|->
name|sink_vtbl
operator|.
name|Release
operator|=
name|ndis_events_release
expr_stmt|;
name|events
operator|->
name|sink_vtbl
operator|.
name|Indicate
operator|=
name|ndis_events_indicate
expr_stmt|;
name|events
operator|->
name|sink_vtbl
operator|.
name|SetStatus
operator|=
name|ndis_events_set_status
expr_stmt|;
if|if
condition|(
name|register_async_notification
argument_list|(
name|pSink
argument_list|,
name|events
operator|->
name|pSvc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to register async "
literal|"notifications"
argument_list|)
expr_stmt|;
name|ndis_events_destructor
argument_list|(
name|events
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|events
operator|->
name|adapter_desc
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|events
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|read_pipe
operator|=
name|events
operator|->
name|read_pipe
expr_stmt|;
operator|*
name|event_avail
operator|=
name|events
operator|->
name|event_avail
expr_stmt|;
return|return
name|events
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - PS3 Linux wireless extension driver interface  * Copyright 2007, 2008 Sony Corporation  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|"wireless_copy.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"wpa_common.h"
end_include

begin_include
include|#
directive|include
file|"driver.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"driver_wext.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_function
specifier|static
name|int
name|wpa_driver_ps3_set_wpa_key
parameter_list|(
name|struct
name|wpa_driver_wext_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|str
decl_stmt|;
if|if
condition|(
operator|!
name|params
operator|->
name|psk
operator|&&
operator|!
name|params
operator|->
name|passphrase
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s:no PSK error"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|psk
condition|)
block|{
comment|/* includes null */
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|=
name|PMK_LEN
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|str
operator|=
name|buf
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|PMK_LEN
condition|;
name|i
operator|++
control|)
block|{
name|str
operator|+=
name|snprintf
argument_list|(
name|str
argument_list|,
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|-
operator|(
name|str
operator|-
name|buf
operator|)
argument_list|,
literal|"%02x"
argument_list|,
name|params
operator|->
name|psk
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|params
operator|->
name|passphrase
condition|)
block|{
comment|/* including quotations and null */
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|=
name|strlen
argument_list|(
name|params
operator|->
name|passphrase
argument_list|)
operator|+
literal|3
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|buf
index|[
literal|0
index|]
operator|=
literal|'"'
expr_stmt|;
name|os_memcpy
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
name|params
operator|->
name|passphrase
argument_list|,
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|-
literal|3
argument_list|)
expr_stmt|;
name|buf
index|[
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|-
literal|2
index|]
operator|=
literal|'"'
expr_stmt|;
name|buf
index|[
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|length
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
return|return
operator|-
name|EINVAL
return|;
name|iwr
operator|.
name|u
operator|.
name|data
operator|.
name|pointer
operator|=
operator|(
name|caddr_t
operator|)
name|buf
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|ret
operator|=
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCIWFIRSTPRIV
argument_list|,
operator|&
name|iwr
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ps3_set_wep_keys
parameter_list|(
name|struct
name|wpa_driver_wext_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|iwreq
name|iwr
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|os_memset
argument_list|(
operator|&
name|iwr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iwr
argument_list|)
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|iwr
operator|.
name|ifr_name
argument_list|,
name|drv
operator|->
name|ifname
argument_list|,
name|IFNAMSIZ
argument_list|)
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|encoding
operator|.
name|flags
operator|=
name|i
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
condition|)
block|{
name|iwr
operator|.
name|u
operator|.
name|encoding
operator|.
name|pointer
operator|=
operator|(
name|caddr_t
operator|)
name|params
operator|->
name|wep_key
index|[
name|i
index|]
expr_stmt|;
name|iwr
operator|.
name|u
operator|.
name|encoding
operator|.
name|length
operator|=
name|params
operator|->
name|wep_key_len
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
name|iwr
operator|.
name|u
operator|.
name|encoding
operator|.
name|flags
operator|=
name|IW_ENCODE_NOKEY
operator||
name|IW_ENCODE_DISABLED
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|drv
operator|->
name|ioctl_sock
argument_list|,
name|SIOCSIWENCODE
argument_list|,
operator|&
name|iwr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"ioctl[SIOCSIWENCODE]"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ps3_associate
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_associate_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_wext_data
modifier|*
name|drv
init|=
name|priv
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|value
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s:<-"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
comment|/* clear BSSID */
if|if
condition|(
operator|!
name|params
operator|->
name|bssid
operator|&&
name|wpa_driver_wext_set_bssid
argument_list|(
name|drv
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_driver_wext_set_mode
argument_list|(
name|drv
argument_list|,
name|params
operator|->
name|mode
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|wpa_ie
operator|==
name|NULL
operator|||
name|params
operator|->
name|wpa_ie_len
operator|==
literal|0
condition|)
name|value
operator|=
name|IW_AUTH_WPA_VERSION_DISABLED
expr_stmt|;
elseif|else
if|if
condition|(
name|params
operator|->
name|wpa_ie
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
condition|)
name|value
operator|=
name|IW_AUTH_WPA_VERSION_WPA2
expr_stmt|;
else|else
name|value
operator|=
name|IW_AUTH_WPA_VERSION_WPA
expr_stmt|;
if|if
condition|(
name|wpa_driver_wext_set_auth_param
argument_list|(
name|drv
argument_list|,
name|IW_AUTH_WPA_VERSION
argument_list|,
name|value
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|value
operator|=
name|wpa_driver_wext_cipher2wext
argument_list|(
name|params
operator|->
name|pairwise_suite
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_wext_set_auth_param
argument_list|(
name|drv
argument_list|,
name|IW_AUTH_CIPHER_PAIRWISE
argument_list|,
name|value
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|value
operator|=
name|wpa_driver_wext_cipher2wext
argument_list|(
name|params
operator|->
name|group_suite
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_wext_set_auth_param
argument_list|(
name|drv
argument_list|,
name|IW_AUTH_CIPHER_GROUP
argument_list|,
name|value
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|value
operator|=
name|wpa_driver_wext_keymgmt2wext
argument_list|(
name|params
operator|->
name|key_mgmt_suite
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_driver_wext_set_auth_param
argument_list|(
name|drv
argument_list|,
name|IW_AUTH_KEY_MGMT
argument_list|,
name|value
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* set selected BSSID */
if|if
condition|(
name|params
operator|->
name|bssid
operator|&&
name|wpa_driver_wext_set_bssid
argument_list|(
name|drv
argument_list|,
name|params
operator|->
name|bssid
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
switch|switch
condition|(
name|params
operator|->
name|group_suite
condition|)
block|{
case|case
name|CIPHER_NONE
case|:
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|CIPHER_WEP40
case|:
case|case
name|CIPHER_WEP104
case|:
name|ret
operator|=
name|wpa_driver_ps3_set_wep_keys
argument_list|(
name|drv
argument_list|,
name|params
argument_list|)
expr_stmt|;
break|break;
case|case
name|CIPHER_TKIP
case|:
case|case
name|CIPHER_CCMP
case|:
name|ret
operator|=
name|wpa_driver_ps3_set_wpa_key
argument_list|(
name|drv
argument_list|,
name|params
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* start to associate */
name|ret
operator|=
name|wpa_driver_wext_set_ssid
argument_list|(
name|drv
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: ->"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_driver_ps3_get_capa
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_capa
modifier|*
name|capa
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s:<-"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_driver_wext_get_capa
argument_list|(
name|priv
argument_list|,
name|capa
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s: base wext returns error %d"
argument_list|,
name|__func__
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
comment|/* PS3 hypervisor does association and 4way handshake by itself */
name|capa
operator|->
name|flags
operator||=
name|WPA_DRIVER_FLAGS_4WAY_HANDSHAKE
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s:->"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|wpa_driver_ops
name|wpa_driver_ps3_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"ps3"
block|,
operator|.
name|desc
operator|=
literal|"PLAYSTATION3 Linux wireless extension driver"
block|,
operator|.
name|get_bssid
operator|=
name|wpa_driver_wext_get_bssid
block|,
operator|.
name|get_ssid
operator|=
name|wpa_driver_wext_get_ssid
block|,
operator|.
name|scan
operator|=
name|wpa_driver_wext_scan
block|,
operator|.
name|get_scan_results2
operator|=
name|wpa_driver_wext_get_scan_results
block|,
operator|.
name|associate
operator|=
name|wpa_driver_ps3_associate
block|,
comment|/* PS3 */
operator|.
name|init
operator|=
name|wpa_driver_wext_init
block|,
operator|.
name|deinit
operator|=
name|wpa_driver_wext_deinit
block|,
operator|.
name|get_capa
operator|=
name|wpa_driver_ps3_get_capa
block|,
comment|/* PS3 */
block|}
decl_stmt|;
end_decl_stmt

end_unit


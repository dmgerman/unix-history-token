begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Driver interaction with Linux nl80211/cfg80211 - Scanning  * Copyright (c) 2002-2014, Jouni Malinen<j@w1.fi>  * Copyright (c) 2007, Johannes Berg<johannes@sipsolutions.net>  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<netlink/genl/genl.h>
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"driver_nl80211.h"
end_include

begin_function
specifier|static
name|int
name|get_noise_for_scan_results
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|sinfo
index|[
name|NL80211_SURVEY_INFO_MAX
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|survey_policy
index|[
name|NL80211_SURVEY_INFO_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_SURVEY_INFO_FREQUENCY
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_SURVEY_INFO_NOISE
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U8
block|}
block|, 	}
decl_stmt|;
name|struct
name|wpa_scan_results
modifier|*
name|scan_results
init|=
name|arg
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|scan_res
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_SURVEY_INFO
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Survey data missing"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
if|if
condition|(
name|nla_parse_nested
argument_list|(
name|sinfo
argument_list|,
name|NL80211_SURVEY_INFO_MAX
argument_list|,
name|tb
index|[
name|NL80211_ATTR_SURVEY_INFO
index|]
argument_list|,
name|survey_policy
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to parse nested "
literal|"attributes"
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
if|if
condition|(
operator|!
name|sinfo
index|[
name|NL80211_SURVEY_INFO_NOISE
index|]
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
operator|!
name|sinfo
index|[
name|NL80211_SURVEY_INFO_FREQUENCY
index|]
condition|)
return|return
name|NL_SKIP
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scan_results
operator|->
name|num
condition|;
operator|++
name|i
control|)
block|{
name|scan_res
operator|=
name|scan_results
operator|->
name|res
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|scan_res
condition|)
continue|continue;
if|if
condition|(
operator|(
name|int
operator|)
name|nla_get_u32
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_FREQUENCY
index|]
argument_list|)
operator|!=
name|scan_res
operator|->
name|freq
condition|)
continue|continue;
if|if
condition|(
operator|!
operator|(
name|scan_res
operator|->
name|flags
operator|&
name|WPA_SCAN_NOISE_INVALID
operator|)
condition|)
continue|continue;
name|scan_res
operator|->
name|noise
operator|=
operator|(
name|s8
operator|)
name|nla_get_u8
argument_list|(
name|sinfo
index|[
name|NL80211_SURVEY_INFO_NOISE
index|]
argument_list|)
expr_stmt|;
name|scan_res
operator|->
name|flags
operator|&=
operator|~
name|WPA_SCAN_NOISE_INVALID
expr_stmt|;
block|}
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_get_noise_for_scan_results
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
name|NLM_F_DUMP
argument_list|,
name|NL80211_CMD_GET_SURVEY
argument_list|)
expr_stmt|;
return|return
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|get_noise_for_scan_results
argument_list|,
name|scan_res
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_driver_nl80211_scan_timeout - Scan timeout to report scan completion  * @eloop_ctx: Driver private data  * @timeout_ctx: ctx argument given to wpa_driver_nl80211_init()  *  * This function can be used as registered timeout when starting a scan to  * generate a scan completed event if the driver does not report this.  */
end_comment

begin_function
name|void
name|wpa_driver_nl80211_scan_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|ap_scan_as_station
operator|!=
name|NL80211_IFTYPE_UNSPECIFIED
condition|)
block|{
name|wpa_driver_nl80211_set_mode
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
name|drv
operator|->
name|ap_scan_as_station
argument_list|)
expr_stmt|;
name|drv
operator|->
name|ap_scan_as_station
operator|=
name|NL80211_IFTYPE_UNSPECIFIED
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan timeout - try to get results"
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|timeout_ctx
argument_list|,
name|EVENT_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|nl_msg
modifier|*
name|nl80211_scan_common
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|u8
name|cmd
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|u32
name|scan_flags
init|=
literal|0
decl_stmt|;
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|bss
argument_list|,
literal|0
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|params
operator|->
name|num_ssids
condition|)
block|{
name|struct
name|nlattr
modifier|*
name|ssids
decl_stmt|;
name|ssids
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SCAN_SSIDS
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssids
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|params
operator|->
name|num_ssids
condition|;
name|i
operator|++
control|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: Scan SSID"
argument_list|,
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid
argument_list|,
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid_len
argument_list|,
name|params
operator|->
name|ssids
index|[
name|i
index|]
operator|.
name|ssid
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|ssids
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|extra_ies
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: Scan extra IEs"
argument_list|,
name|params
operator|->
name|extra_ies
argument_list|,
name|params
operator|->
name|extra_ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_IE
argument_list|,
name|params
operator|->
name|extra_ies_len
argument_list|,
name|params
operator|->
name|extra_ies
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|freqs
condition|)
block|{
name|struct
name|nlattr
modifier|*
name|freqs
decl_stmt|;
name|freqs
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SCAN_FREQUENCIES
argument_list|)
expr_stmt|;
if|if
condition|(
name|freqs
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|params
operator|->
name|freqs
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: Scan frequency %u "
literal|"MHz"
argument_list|,
name|params
operator|->
name|freqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|i
operator|+
literal|1
argument_list|,
name|params
operator|->
name|freqs
index|[
name|i
index|]
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|freqs
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|drv
operator|->
name|filter_ssids
argument_list|)
expr_stmt|;
name|drv
operator|->
name|filter_ssids
operator|=
name|params
operator|->
name|filter_ssids
expr_stmt|;
name|params
operator|->
name|filter_ssids
operator|=
name|NULL
expr_stmt|;
name|drv
operator|->
name|num_filter_ssids
operator|=
name|params
operator|->
name|num_filter_ssids
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|only_new_results
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Add NL80211_SCAN_FLAG_FLUSH"
argument_list|)
expr_stmt|;
name|scan_flags
operator||=
name|NL80211_SCAN_FLAG_FLUSH
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|low_priority
operator|&&
name|drv
operator|->
name|have_low_prio_scan
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Add NL80211_SCAN_FLAG_LOW_PRIORITY"
argument_list|)
expr_stmt|;
name|scan_flags
operator||=
name|NL80211_SCAN_FLAG_LOW_PRIORITY
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|mac_addr_rand
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Add NL80211_SCAN_FLAG_RANDOM_ADDR"
argument_list|)
expr_stmt|;
name|scan_flags
operator||=
name|NL80211_SCAN_FLAG_RANDOM_ADDR
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|mac_addr
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: MAC address: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC
argument_list|,
name|ETH_ALEN
argument_list|,
name|params
operator|->
name|mac_addr
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|params
operator|->
name|mac_addr_mask
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: MAC address mask: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|mac_addr_mask
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_MAC_MASK
argument_list|,
name|ETH_ALEN
argument_list|,
name|params
operator|->
name|mac_addr_mask
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
name|scan_flags
operator|&&
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SCAN_FLAGS
argument_list|,
name|scan_flags
argument_list|)
condition|)
goto|goto
name|fail
goto|;
return|return
name|msg
return|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_driver_nl80211_scan - Request the driver to initiate scan  * @bss: Pointer to private driver data from wpa_driver_nl80211_init()  * @params: Scan parameters  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|wpa_driver_nl80211_scan
parameter_list|(
name|struct
name|i802_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|,
name|timeout
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: scan request"
argument_list|)
expr_stmt|;
name|drv
operator|->
name|scan_for_auth
operator|=
literal|0
expr_stmt|;
name|msg
operator|=
name|nl80211_scan_common
argument_list|(
name|bss
argument_list|,
name|NL80211_CMD_TRIGGER_SCAN
argument_list|,
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|->
name|p2p_probe
condition|)
block|{
name|struct
name|nlattr
modifier|*
name|rates
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: P2P probe - mask SuppRates"
argument_list|)
expr_stmt|;
name|rates
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SCAN_SUPP_RATES
argument_list|)
expr_stmt|;
if|if
condition|(
name|rates
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
comment|/* 		 * Remove 2.4 GHz rates 1, 2, 5.5, 11 Mbps from supported rates 		 * by masking out everything else apart from the OFDM rates 6, 		 * 9, 12, 18, 24, 36, 48, 54 Mbps from non-MCS rates. All 5 GHz 		 * rates are left enabled. 		 */
if|if
condition|(
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_BAND_2GHZ
argument_list|,
literal|8
argument_list|,
literal|"\x0c\x12\x18\x24\x30\x48\x60\x6c"
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|rates
argument_list|)
expr_stmt|;
if|if
condition|(
name|nla_put_flag
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_TX_NO_CCK_RATE
argument_list|)
condition|)
goto|goto
name|fail
goto|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Scan trigger failed: ret=%d "
literal|"(%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|hostapd
operator|&&
name|is_ap_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
condition|)
block|{
name|enum
name|nl80211_iftype
name|old_mode
init|=
name|drv
operator|->
name|nlmode
decl_stmt|;
comment|/* 			 * mac80211 does not allow scan requests in AP mode, so 			 * try to do this in station mode. 			 */
if|if
condition|(
name|wpa_driver_nl80211_set_mode
argument_list|(
name|bss
argument_list|,
name|NL80211_IFTYPE_STATION
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|wpa_driver_nl80211_scan
argument_list|(
name|bss
argument_list|,
name|params
argument_list|)
condition|)
block|{
name|wpa_driver_nl80211_set_mode
argument_list|(
name|bss
argument_list|,
name|old_mode
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Restore AP mode when processing scan results */
name|drv
operator|->
name|ap_scan_as_station
operator|=
name|old_mode
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
goto|goto
name|fail
goto|;
block|}
name|drv
operator|->
name|scan_state
operator|=
name|SCAN_REQUESTED
expr_stmt|;
comment|/* Not all drivers generate "scan completed" wireless event, so try to 	 * read results after a timeout. */
name|timeout
operator|=
literal|10
expr_stmt|;
if|if
condition|(
name|drv
operator|->
name|scan_complete_events
condition|)
block|{
comment|/* 		 * The driver seems to deliver events to notify when scan is 		 * complete, so use longer timeout to avoid race conditions 		 * with scanning and following association request. 		 */
name|timeout
operator|=
literal|30
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Scan requested (ret=%d) - scan timeout %d "
literal|"seconds"
argument_list|,
name|ret
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_driver_nl80211_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|timeout
argument_list|,
literal|0
argument_list|,
name|wpa_driver_nl80211_scan_timeout
argument_list|,
name|drv
argument_list|,
name|drv
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_driver_nl80211_sched_scan - Initiate a scheduled scan  * @priv: Pointer to private driver data from wpa_driver_nl80211_init()  * @params: Scan parameters  * @interval: Interval between scan cycles in milliseconds  * Returns: 0 on success, -1 on failure or if not supported  */
end_comment

begin_function
name|int
name|wpa_driver_nl80211_sched_scan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|,
name|u32
name|interval
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|wpa_dbg
argument_list|(
name|drv
operator|->
name|ctx
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nl80211: sched_scan request"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|ANDROID
if|if
condition|(
operator|!
name|drv
operator|->
name|capa
operator|.
name|sched_scan_supported
condition|)
return|return
name|android_pno_start
argument_list|(
name|bss
argument_list|,
name|params
argument_list|)
return|;
endif|#
directive|endif
comment|/* ANDROID */
name|msg
operator|=
name|nl80211_scan_common
argument_list|(
name|bss
argument_list|,
name|NL80211_CMD_START_SCHED_SCAN
argument_list|,
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msg
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SCHED_SCAN_INTERVAL
argument_list|,
name|interval
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
operator|(
name|drv
operator|->
name|num_filter_ssids
operator|&&
operator|(
name|int
operator|)
name|drv
operator|->
name|num_filter_ssids
operator|<=
name|drv
operator|->
name|capa
operator|.
name|max_match_sets
operator|)
operator|||
name|params
operator|->
name|filter_rssi
condition|)
block|{
name|struct
name|nlattr
modifier|*
name|match_sets
decl_stmt|;
name|match_sets
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SCHED_SCAN_MATCH
argument_list|)
expr_stmt|;
if|if
condition|(
name|match_sets
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|num_filter_ssids
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|nlattr
modifier|*
name|match_set_ssid
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: Sched scan filter SSID"
argument_list|,
name|drv
operator|->
name|filter_ssids
index|[
name|i
index|]
operator|.
name|ssid
argument_list|,
name|drv
operator|->
name|filter_ssids
index|[
name|i
index|]
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|match_set_ssid
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|match_set_ssid
operator|==
name|NULL
operator|||
name|nla_put
argument_list|(
name|msg
argument_list|,
name|NL80211_ATTR_SCHED_SCAN_MATCH_SSID
argument_list|,
name|drv
operator|->
name|filter_ssids
index|[
name|i
index|]
operator|.
name|ssid_len
argument_list|,
name|drv
operator|->
name|filter_ssids
index|[
name|i
index|]
operator|.
name|ssid
argument_list|)
operator|||
operator|(
name|params
operator|->
name|filter_rssi
operator|&&
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_SCHED_SCAN_MATCH_ATTR_RSSI
argument_list|,
name|params
operator|->
name|filter_rssi
argument_list|)
operator|)
condition|)
goto|goto
name|fail
goto|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|match_set_ssid
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Due to backward compatibility code, newer kernels treat this 		 * matchset (with only an RSSI filter) as the default for all 		 * other matchsets, unless it's the only one, in which case the 		 * matchset will actually allow all SSIDs above the RSSI. 		 */
if|if
condition|(
name|params
operator|->
name|filter_rssi
condition|)
block|{
name|struct
name|nlattr
modifier|*
name|match_set_rssi
decl_stmt|;
name|match_set_rssi
operator|=
name|nla_nest_start
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|match_set_rssi
operator|==
name|NULL
operator|||
name|nla_put_u32
argument_list|(
name|msg
argument_list|,
name|NL80211_SCHED_SCAN_MATCH_ATTR_RSSI
argument_list|,
name|params
operator|->
name|filter_rssi
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"nl80211: Sched scan RSSI filter %d dBm"
argument_list|,
name|params
operator|->
name|filter_rssi
argument_list|)
expr_stmt|;
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|match_set_rssi
argument_list|)
expr_stmt|;
block|}
name|nla_nest_end
argument_list|(
name|msg
argument_list|,
name|match_sets
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* TODO: if we get an error here, we should fall back to normal scan */
name|msg
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Sched scan start failed: "
literal|"ret=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Sched scan requested (ret=%d) - "
literal|"scan interval %d msec"
argument_list|,
name|ret
argument_list|,
name|interval
argument_list|)
expr_stmt|;
name|fail
label|:
name|nlmsg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_driver_nl80211_stop_sched_scan - Stop a scheduled scan  * @priv: Pointer to private driver data from wpa_driver_nl80211_init()  * Returns: 0 on success, -1 on failure or if not supported  */
end_comment

begin_function
name|int
name|wpa_driver_nl80211_stop_sched_scan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
ifdef|#
directive|ifdef
name|ANDROID
if|if
condition|(
operator|!
name|drv
operator|->
name|capa
operator|.
name|sched_scan_supported
condition|)
return|return
name|android_pno_stop
argument_list|(
name|bss
argument_list|)
return|;
endif|#
directive|endif
comment|/* ANDROID */
name|msg
operator|=
name|nl80211_drv_msg
argument_list|(
name|drv
argument_list|,
literal|0
argument_list|,
name|NL80211_CMD_STOP_SCHED_SCAN
argument_list|)
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Sched scan stop failed: ret=%d (%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Sched scan stop sent"
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|nl80211_get_ie
parameter_list|(
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
name|u8
name|ie
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|ies
expr_stmt|;
name|end
operator|=
name|ies
operator|+
name|ies_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|ie
condition|)
return|return
name|pos
return|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nl80211_scan_filtered
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|ssid
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|drv
operator|->
name|filter_ssids
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ssid
operator|=
name|nl80211_get_ie
argument_list|(
name|ie
argument_list|,
name|ie_len
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|drv
operator|->
name|num_filter_ssids
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
index|[
literal|1
index|]
operator|==
name|drv
operator|->
name|filter_ssids
index|[
name|i
index|]
operator|.
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
operator|+
literal|2
argument_list|,
name|drv
operator|->
name|filter_ssids
index|[
name|i
index|]
operator|.
name|ssid
argument_list|,
name|ssid
index|[
literal|1
index|]
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|bss_info_handler
parameter_list|(
name|struct
name|nl_msg
modifier|*
name|msg
parameter_list|,
name|void
modifier|*
name|arg
parameter_list|)
block|{
name|struct
name|nlattr
modifier|*
name|tb
index|[
name|NL80211_ATTR_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|struct
name|genlmsghdr
modifier|*
name|gnlh
init|=
name|nlmsg_data
argument_list|(
name|nlmsg_hdr
argument_list|(
name|msg
argument_list|)
argument_list|)
decl_stmt|;
name|struct
name|nlattr
modifier|*
name|bss
index|[
name|NL80211_BSS_MAX
operator|+
literal|1
index|]
decl_stmt|;
specifier|static
name|struct
name|nla_policy
name|bss_policy
index|[
name|NL80211_BSS_MAX
operator|+
literal|1
index|]
init|=
block|{
index|[
name|NL80211_BSS_BSSID
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_UNSPEC
block|}
block|,
index|[
name|NL80211_BSS_FREQUENCY
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_BSS_TSF
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U64
block|}
block|,
index|[
name|NL80211_BSS_BEACON_INTERVAL
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U16
block|}
block|,
index|[
name|NL80211_BSS_CAPABILITY
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U16
block|}
block|,
index|[
name|NL80211_BSS_INFORMATION_ELEMENTS
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_UNSPEC
block|}
block|,
index|[
name|NL80211_BSS_SIGNAL_MBM
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_BSS_SIGNAL_UNSPEC
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U8
block|}
block|,
index|[
name|NL80211_BSS_STATUS
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_BSS_SEEN_MS_AGO
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_U32
block|}
block|,
index|[
name|NL80211_BSS_BEACON_IES
index|]
operator|=
block|{
operator|.
name|type
operator|=
name|NLA_UNSPEC
block|}
block|, 	}
decl_stmt|;
name|struct
name|nl80211_bss_info_arg
modifier|*
name|_arg
init|=
name|arg
decl_stmt|;
name|struct
name|wpa_scan_results
modifier|*
name|res
init|=
name|_arg
operator|->
name|res
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
modifier|*
name|tmp
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|r
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|,
modifier|*
name|beacon_ie
decl_stmt|;
name|size_t
name|ie_len
decl_stmt|,
name|beacon_ie_len
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|nla_parse
argument_list|(
name|tb
argument_list|,
name|NL80211_ATTR_MAX
argument_list|,
name|genlmsg_attrdata
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|genlmsg_attrlen
argument_list|(
name|gnlh
argument_list|,
literal|0
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tb
index|[
name|NL80211_ATTR_BSS
index|]
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
name|nla_parse_nested
argument_list|(
name|bss
argument_list|,
name|NL80211_BSS_MAX
argument_list|,
name|tb
index|[
name|NL80211_ATTR_BSS
index|]
argument_list|,
name|bss_policy
argument_list|)
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_STATUS
index|]
condition|)
block|{
name|enum
name|nl80211_bss_status
name|status
decl_stmt|;
name|status
operator|=
name|nla_get_u32
argument_list|(
name|bss
index|[
name|NL80211_BSS_STATUS
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|NL80211_BSS_STATUS_ASSOCIATED
operator|&&
name|bss
index|[
name|NL80211_BSS_FREQUENCY
index|]
condition|)
block|{
name|_arg
operator|->
name|assoc_freq
operator|=
name|nla_get_u32
argument_list|(
name|bss
index|[
name|NL80211_BSS_FREQUENCY
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Associated on %u MHz"
argument_list|,
name|_arg
operator|->
name|assoc_freq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|NL80211_BSS_STATUS_IBSS_JOINED
operator|&&
name|bss
index|[
name|NL80211_BSS_FREQUENCY
index|]
condition|)
block|{
name|_arg
operator|->
name|ibss_freq
operator|=
name|nla_get_u32
argument_list|(
name|bss
index|[
name|NL80211_BSS_FREQUENCY
index|]
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: IBSS-joined on %u MHz"
argument_list|,
name|_arg
operator|->
name|ibss_freq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|==
name|NL80211_BSS_STATUS_ASSOCIATED
operator|&&
name|bss
index|[
name|NL80211_BSS_BSSID
index|]
condition|)
block|{
name|os_memcpy
argument_list|(
name|_arg
operator|->
name|assoc_bssid
argument_list|,
name|nla_data
argument_list|(
name|bss
index|[
name|NL80211_BSS_BSSID
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Associated with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|_arg
operator|->
name|assoc_bssid
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_INFORMATION_ELEMENTS
index|]
condition|)
block|{
name|ie
operator|=
name|nla_data
argument_list|(
name|bss
index|[
name|NL80211_BSS_INFORMATION_ELEMENTS
index|]
argument_list|)
expr_stmt|;
name|ie_len
operator|=
name|nla_len
argument_list|(
name|bss
index|[
name|NL80211_BSS_INFORMATION_ELEMENTS
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ie
operator|=
name|NULL
expr_stmt|;
name|ie_len
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_BEACON_IES
index|]
condition|)
block|{
name|beacon_ie
operator|=
name|nla_data
argument_list|(
name|bss
index|[
name|NL80211_BSS_BEACON_IES
index|]
argument_list|)
expr_stmt|;
name|beacon_ie_len
operator|=
name|nla_len
argument_list|(
name|bss
index|[
name|NL80211_BSS_BEACON_IES
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|beacon_ie
operator|=
name|NULL
expr_stmt|;
name|beacon_ie_len
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|nl80211_scan_filtered
argument_list|(
name|_arg
operator|->
name|drv
argument_list|,
name|ie
condition|?
name|ie
else|:
name|beacon_ie
argument_list|,
name|ie
condition|?
name|ie_len
else|:
name|beacon_ie_len
argument_list|)
condition|)
return|return
name|NL_SKIP
return|;
name|r
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
operator|+
name|ie_len
operator|+
name|beacon_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
name|NULL
condition|)
return|return
name|NL_SKIP
return|;
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_BSSID
index|]
condition|)
name|os_memcpy
argument_list|(
name|r
operator|->
name|bssid
argument_list|,
name|nla_data
argument_list|(
name|bss
index|[
name|NL80211_BSS_BSSID
index|]
argument_list|)
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_FREQUENCY
index|]
condition|)
name|r
operator|->
name|freq
operator|=
name|nla_get_u32
argument_list|(
name|bss
index|[
name|NL80211_BSS_FREQUENCY
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_BEACON_INTERVAL
index|]
condition|)
name|r
operator|->
name|beacon_int
operator|=
name|nla_get_u16
argument_list|(
name|bss
index|[
name|NL80211_BSS_BEACON_INTERVAL
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_CAPABILITY
index|]
condition|)
name|r
operator|->
name|caps
operator|=
name|nla_get_u16
argument_list|(
name|bss
index|[
name|NL80211_BSS_CAPABILITY
index|]
argument_list|)
expr_stmt|;
name|r
operator|->
name|flags
operator||=
name|WPA_SCAN_NOISE_INVALID
expr_stmt|;
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_SIGNAL_MBM
index|]
condition|)
block|{
name|r
operator|->
name|level
operator|=
name|nla_get_u32
argument_list|(
name|bss
index|[
name|NL80211_BSS_SIGNAL_MBM
index|]
argument_list|)
expr_stmt|;
name|r
operator|->
name|level
operator|/=
literal|100
expr_stmt|;
comment|/* mBm to dBm */
name|r
operator|->
name|flags
operator||=
name|WPA_SCAN_LEVEL_DBM
operator||
name|WPA_SCAN_QUAL_INVALID
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_SIGNAL_UNSPEC
index|]
condition|)
block|{
name|r
operator|->
name|level
operator|=
name|nla_get_u8
argument_list|(
name|bss
index|[
name|NL80211_BSS_SIGNAL_UNSPEC
index|]
argument_list|)
expr_stmt|;
name|r
operator|->
name|flags
operator||=
name|WPA_SCAN_QUAL_INVALID
expr_stmt|;
block|}
else|else
name|r
operator|->
name|flags
operator||=
name|WPA_SCAN_LEVEL_INVALID
operator||
name|WPA_SCAN_QUAL_INVALID
expr_stmt|;
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_TSF
index|]
condition|)
name|r
operator|->
name|tsf
operator|=
name|nla_get_u64
argument_list|(
name|bss
index|[
name|NL80211_BSS_TSF
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_SEEN_MS_AGO
index|]
condition|)
name|r
operator|->
name|age
operator|=
name|nla_get_u32
argument_list|(
name|bss
index|[
name|NL80211_BSS_SEEN_MS_AGO
index|]
argument_list|)
expr_stmt|;
name|r
operator|->
name|ie_len
operator|=
name|ie_len
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|r
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|ie
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ie_len
expr_stmt|;
block|}
name|r
operator|->
name|beacon_ie_len
operator|=
name|beacon_ie_len
expr_stmt|;
if|if
condition|(
name|beacon_ie
condition|)
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|beacon_ie
argument_list|,
name|beacon_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
index|[
name|NL80211_BSS_STATUS
index|]
condition|)
block|{
name|enum
name|nl80211_bss_status
name|status
decl_stmt|;
name|status
operator|=
name|nla_get_u32
argument_list|(
name|bss
index|[
name|NL80211_BSS_STATUS
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|status
condition|)
block|{
case|case
name|NL80211_BSS_STATUS_ASSOCIATED
case|:
name|r
operator|->
name|flags
operator||=
name|WPA_SCAN_ASSOCIATED
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
comment|/* 	 * cfg80211 maintains separate BSS table entries for APs if the same 	 * BSSID,SSID pair is seen on multiple channels. wpa_supplicant does 	 * not use frequency as a separate key in the BSS table, so filter out 	 * duplicated entries. Prefer associated BSS entry in such a case in 	 * order to get the correct frequency into the BSS table. Similarly, 	 * prefer newer entries over older. 	 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|u8
modifier|*
name|s1
decl_stmt|,
modifier|*
name|s2
decl_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|res
operator|->
name|res
index|[
name|i
index|]
operator|->
name|bssid
argument_list|,
name|r
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|s1
operator|=
name|nl80211_get_ie
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|(
name|res
operator|->
name|res
index|[
name|i
index|]
operator|+
literal|1
operator|)
argument_list|,
name|res
operator|->
name|res
index|[
name|i
index|]
operator|->
name|ie_len
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
name|s2
operator|=
name|nl80211_get_ie
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|(
name|r
operator|+
literal|1
operator|)
argument_list|,
name|r
operator|->
name|ie_len
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
if|if
condition|(
name|s1
operator|==
name|NULL
operator|||
name|s2
operator|==
name|NULL
operator|||
name|s1
index|[
literal|1
index|]
operator|!=
name|s2
index|[
literal|1
index|]
operator|||
name|os_memcmp
argument_list|(
name|s1
argument_list|,
name|s2
argument_list|,
literal|2
operator|+
name|s1
index|[
literal|1
index|]
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
comment|/* Same BSSID,SSID was already included in scan results */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Remove duplicated scan result "
literal|"for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|r
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|(
name|r
operator|->
name|flags
operator|&
name|WPA_SCAN_ASSOCIATED
operator|)
operator|&&
operator|!
operator|(
name|res
operator|->
name|res
index|[
name|i
index|]
operator|->
name|flags
operator|&
name|WPA_SCAN_ASSOCIATED
operator|)
operator|)
operator|||
name|r
operator|->
name|age
operator|<
name|res
operator|->
name|res
index|[
name|i
index|]
operator|->
name|age
condition|)
block|{
name|os_free
argument_list|(
name|res
operator|->
name|res
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|res
operator|->
name|res
index|[
name|i
index|]
operator|=
name|r
expr_stmt|;
block|}
else|else
name|os_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
name|tmp
operator|=
name|os_realloc_array
argument_list|(
name|res
operator|->
name|res
argument_list|,
name|res
operator|->
name|num
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_scan_res
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
name|tmp
index|[
name|res
operator|->
name|num
operator|++
index|]
operator|=
name|r
expr_stmt|;
name|res
operator|->
name|res
operator|=
name|tmp
expr_stmt|;
return|return
name|NL_SKIP
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|clear_state_mismatch
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|drv
operator|->
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SME
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Clear possible state "
literal|"mismatch ("
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_driver_nl80211_mlme
argument_list|(
name|drv
argument_list|,
name|addr
argument_list|,
name|NL80211_CMD_DEAUTHENTICATE
argument_list|,
name|WLAN_REASON_PREV_AUTH_NOT_VALID
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_driver_nl80211_check_bss_status
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|res
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|r
init|=
name|res
operator|->
name|res
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|r
operator|->
name|flags
operator|&
name|WPA_SCAN_ASSOCIATED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Scan results "
literal|"indicate BSS status with "
name|MACSTR
literal|" as associated"
argument_list|,
name|MAC2STR
argument_list|(
name|r
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_sta_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
operator|&&
operator|!
name|drv
operator|->
name|associated
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Local state "
literal|"(not associated) does not match "
literal|"with BSS state"
argument_list|)
expr_stmt|;
name|clear_state_mismatch
argument_list|(
name|drv
argument_list|,
name|r
operator|->
name|bssid
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|is_sta_interface
argument_list|(
name|drv
operator|->
name|nlmode
argument_list|)
operator|&&
name|os_memcmp
argument_list|(
name|drv
operator|->
name|bssid
argument_list|,
name|r
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Local state "
literal|"(associated with "
name|MACSTR
literal|") does "
literal|"not match with BSS state"
argument_list|,
name|MAC2STR
argument_list|(
name|drv
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|clear_state_mismatch
argument_list|(
name|drv
argument_list|,
name|r
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|clear_state_mismatch
argument_list|(
name|drv
argument_list|,
name|drv
operator|->
name|bssid
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_scan_results
modifier|*
name|nl80211_get_scan_results
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|nl_msg
modifier|*
name|msg
decl_stmt|;
name|struct
name|wpa_scan_results
modifier|*
name|res
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|nl80211_bss_info_arg
name|arg
decl_stmt|;
name|res
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|res
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
operator|(
name|msg
operator|=
name|nl80211_cmd_msg
argument_list|(
name|drv
operator|->
name|first_bss
argument_list|,
name|NLM_F_DUMP
argument_list|,
name|NL80211_CMD_GET_SCAN
argument_list|)
operator|)
condition|)
block|{
name|wpa_scan_results_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|arg
operator|.
name|drv
operator|=
name|drv
expr_stmt|;
name|arg
operator|.
name|res
operator|=
name|res
expr_stmt|;
name|ret
operator|=
name|send_and_recv_msgs
argument_list|(
name|drv
argument_list|,
name|msg
argument_list|,
name|bss_info_handler
argument_list|,
operator|&
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Received scan results (%lu "
literal|"BSSes)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
operator|->
name|num
argument_list|)
expr_stmt|;
name|nl80211_get_noise_for_scan_results
argument_list|(
name|drv
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Scan result fetch failed: ret=%d "
literal|"(%s)"
argument_list|,
name|ret
argument_list|,
name|strerror
argument_list|(
operator|-
name|ret
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_scan_results_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_driver_nl80211_get_scan_results - Fetch the latest scan results  * @priv: Pointer to private wext data from wpa_driver_nl80211_init()  * Returns: Scan results on success, -1 on failure  */
end_comment

begin_function
name|struct
name|wpa_scan_results
modifier|*
name|wpa_driver_nl80211_get_scan_results
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|i802_bss
modifier|*
name|bss
init|=
name|priv
decl_stmt|;
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
init|=
name|bss
operator|->
name|drv
decl_stmt|;
name|struct
name|wpa_scan_results
modifier|*
name|res
decl_stmt|;
name|res
operator|=
name|nl80211_get_scan_results
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
name|wpa_driver_nl80211_check_bss_status
argument_list|(
name|drv
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
name|void
name|nl80211_dump_scan
parameter_list|(
name|struct
name|wpa_driver_nl80211_data
modifier|*
name|drv
parameter_list|)
block|{
name|struct
name|wpa_scan_results
modifier|*
name|res
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|res
operator|=
name|nl80211_get_scan_results
argument_list|(
name|drv
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Failed to get scan results"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: Scan result dump"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|r
init|=
name|res
operator|->
name|res
index|[
name|i
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"nl80211: %d/%d "
name|MACSTR
literal|"%s"
argument_list|,
operator|(
name|int
operator|)
name|i
argument_list|,
operator|(
name|int
operator|)
name|res
operator|->
name|num
argument_list|,
name|MAC2STR
argument_list|(
name|r
operator|->
name|bssid
argument_list|)
argument_list|,
name|r
operator|->
name|flags
operator|&
name|WPA_SCAN_ASSOCIATED
condition|?
literal|" [assoc]"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
name|wpa_scan_results_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


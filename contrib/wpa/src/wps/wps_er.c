begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Protected Setup - External Registrar  * Copyright (c) 2009, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"base64.h"
end_include

begin_include
include|#
directive|include
file|"uuid.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"httpread.h"
end_include

begin_include
include|#
directive|include
file|"http_client.h"
end_include

begin_include
include|#
directive|include
file|"http_server.h"
end_include

begin_include
include|#
directive|include
file|"upnp_xml.h"
end_include

begin_include
include|#
directive|include
file|"wps_i.h"
end_include

begin_include
include|#
directive|include
file|"wps_upnp.h"
end_include

begin_include
include|#
directive|include
file|"wps_upnp_i.h"
end_include

begin_include
include|#
directive|include
file|"wps_er.h"
end_include

begin_function_decl
specifier|static
name|void
name|wps_er_deinit_finish
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wps_er_ap_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wps_er_sta_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wps_er_ap_process
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wps_er_send_get_device_info
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|void
function_decl|(
modifier|*
name|m1_handler
function_decl|)
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|m1
parameter_list|)
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|wps_er_sta_event
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
name|struct
name|wps_er_sta
modifier|*
name|sta
parameter_list|,
name|enum
name|wps_event
name|event
parameter_list|)
block|{
name|union
name|wps_event_data
name|data
decl_stmt|;
name|struct
name|wps_event_er_enrollee
modifier|*
name|ev
init|=
operator|&
name|data
operator|.
name|enrollee
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|event_cb
operator|==
name|NULL
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|ev
operator|->
name|uuid
operator|=
name|sta
operator|->
name|uuid
expr_stmt|;
name|ev
operator|->
name|mac_addr
operator|=
name|sta
operator|->
name|addr
expr_stmt|;
name|ev
operator|->
name|m1_received
operator|=
name|sta
operator|->
name|m1_received
expr_stmt|;
name|ev
operator|->
name|config_methods
operator|=
name|sta
operator|->
name|config_methods
expr_stmt|;
name|ev
operator|->
name|dev_passwd_id
operator|=
name|sta
operator|->
name|dev_passwd_id
expr_stmt|;
name|ev
operator|->
name|pri_dev_type
operator|=
name|sta
operator|->
name|pri_dev_type
expr_stmt|;
name|ev
operator|->
name|dev_name
operator|=
name|sta
operator|->
name|dev_name
expr_stmt|;
name|ev
operator|->
name|manufacturer
operator|=
name|sta
operator|->
name|manufacturer
expr_stmt|;
name|ev
operator|->
name|model_name
operator|=
name|sta
operator|->
name|model_name
expr_stmt|;
name|ev
operator|->
name|model_number
operator|=
name|sta
operator|->
name|model_number
expr_stmt|;
name|ev
operator|->
name|serial_number
operator|=
name|sta
operator|->
name|serial_number
expr_stmt|;
name|wps
operator|->
name|event_cb
argument_list|(
name|wps
operator|->
name|cb_ctx
argument_list|,
name|event
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wps_er_sta
modifier|*
name|wps_er_sta_get
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wps_er_sta
modifier|*
name|sta
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|sta
argument_list|,
argument|&ap->sta
argument_list|,
argument|struct wps_er_sta
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|sta
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|sta
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_sta_free
parameter_list|(
name|struct
name|wps_er_sta
modifier|*
name|sta
parameter_list|)
block|{
name|wps_er_sta_event
argument_list|(
name|sta
operator|->
name|ap
operator|->
name|er
operator|->
name|wps
argument_list|,
name|sta
argument_list|,
name|WPS_EV_ER_ENROLLEE_REMOVE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|wps
condition|)
name|wps_deinit
argument_list|(
name|sta
operator|->
name|wps
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|sta
operator|->
name|manufacturer
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|sta
operator|->
name|model_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|sta
operator|->
name|model_number
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|sta
operator|->
name|serial_number
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|sta
operator|->
name|dev_name
argument_list|)
expr_stmt|;
name|http_client_free
argument_list|(
name|sta
operator|->
name|http
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_er_sta_timeout
argument_list|,
name|sta
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|sta
operator|->
name|cred
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_sta_remove_all
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|)
block|{
name|struct
name|wps_er_sta
modifier|*
name|prev
decl_stmt|,
modifier|*
name|sta
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|sta
argument_list|,
argument|prev
argument_list|,
argument|&ap->sta
argument_list|,
argument|struct wps_er_sta
argument_list|,
argument|list
argument_list|)
name|wps_er_sta_free
argument_list|(
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wps_er_ap
modifier|*
name|wps_er_ap_get
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
name|struct
name|in_addr
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|ap
argument_list|,
argument|&er->ap
argument_list|,
argument|struct wps_er_ap
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|(
name|addr
operator|==
name|NULL
operator|||
name|ap
operator|->
name|addr
operator|.
name|s_addr
operator|==
name|addr
operator|->
name|s_addr
operator|)
operator|&&
operator|(
name|uuid
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|uuid
argument_list|,
name|ap
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
return|return
name|ap
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wps_er_ap
modifier|*
name|wps_er_ap_get_id
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
name|unsigned
name|int
name|id
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|ap
argument_list|,
argument|&er->ap
argument_list|,
argument|struct wps_er_ap
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|ap
operator|->
name|id
operator|==
name|id
condition|)
return|return
name|ap
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_event
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|enum
name|wps_event
name|event
parameter_list|)
block|{
name|union
name|wps_event_data
name|data
decl_stmt|;
name|struct
name|wps_event_er_ap
modifier|*
name|evap
init|=
operator|&
name|data
operator|.
name|ap
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|event_cb
operator|==
name|NULL
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|evap
operator|->
name|uuid
operator|=
name|ap
operator|->
name|uuid
expr_stmt|;
name|evap
operator|->
name|friendly_name
operator|=
name|ap
operator|->
name|friendly_name
expr_stmt|;
name|evap
operator|->
name|manufacturer
operator|=
name|ap
operator|->
name|manufacturer
expr_stmt|;
name|evap
operator|->
name|manufacturer_url
operator|=
name|ap
operator|->
name|manufacturer_url
expr_stmt|;
name|evap
operator|->
name|model_description
operator|=
name|ap
operator|->
name|model_description
expr_stmt|;
name|evap
operator|->
name|model_name
operator|=
name|ap
operator|->
name|model_name
expr_stmt|;
name|evap
operator|->
name|model_number
operator|=
name|ap
operator|->
name|model_number
expr_stmt|;
name|evap
operator|->
name|model_url
operator|=
name|ap
operator|->
name|model_url
expr_stmt|;
name|evap
operator|->
name|serial_number
operator|=
name|ap
operator|->
name|serial_number
expr_stmt|;
name|evap
operator|->
name|upc
operator|=
name|ap
operator|->
name|upc
expr_stmt|;
name|evap
operator|->
name|pri_dev_type
operator|=
name|ap
operator|->
name|pri_dev_type
expr_stmt|;
name|evap
operator|->
name|wps_state
operator|=
name|ap
operator|->
name|wps_state
expr_stmt|;
name|evap
operator|->
name|mac_addr
operator|=
name|ap
operator|->
name|mac_addr
expr_stmt|;
name|wps
operator|->
name|event_cb
argument_list|(
name|wps
operator|->
name|cb_ctx
argument_list|,
name|event
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_free
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|)
block|{
name|http_client_free
argument_list|(
name|ap
operator|->
name|http
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|location
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|friendly_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|manufacturer
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|manufacturer_url
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|model_description
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|model_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|model_number
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|model_url
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|serial_number
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|udn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|upc
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|scpd_url
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|control_url
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|event_sub_url
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|ap_settings
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_unsubscribed
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Unsubscribed from AP %s (%s)"
argument_list|,
name|inet_ntoa
argument_list|(
name|ap
operator|->
name|addr
argument_list|)
argument_list|,
name|ap
operator|->
name|location
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|ap
operator|->
name|list
argument_list|)
expr_stmt|;
name|wps_er_ap_free
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|er
operator|->
name|deinitializing
operator|&&
name|dl_list_empty
argument_list|(
operator|&
name|er
operator|->
name|ap_unsubscribing
argument_list|)
condition|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wps_er_deinit_finish
argument_list|,
name|er
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wps_er_deinit_finish
argument_list|(
name|er
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_unsubscribe_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_client
modifier|*
name|c
parameter_list|,
name|enum
name|http_client_event
name|event
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
init|=
name|ctx
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|HTTP_CLIENT_OK
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Unsubscribed from events"
argument_list|)
expr_stmt|;
name|ap
operator|->
name|subscribed
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|HTTP_CLIENT_FAILED
case|:
case|case
name|HTTP_CLIENT_INVALID_REPLY
case|:
case|case
name|HTTP_CLIENT_TIMEOUT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to unsubscribe from "
literal|"events"
argument_list|)
expr_stmt|;
break|break;
block|}
name|http_client_free
argument_list|(
name|ap
operator|->
name|http
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Need to get rid of the AP entry regardless of whether we managed to 	 * unsubscribe cleanly or not. 	 */
name|wps_er_ap_unsubscribed
argument_list|(
name|ap
operator|->
name|er
argument_list|,
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_unsubscribe
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|req
decl_stmt|;
name|struct
name|sockaddr_in
name|dst
decl_stmt|;
name|char
modifier|*
name|url
decl_stmt|,
modifier|*
name|path
decl_stmt|;
name|char
name|sid
index|[
literal|100
index|]
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|event_sub_url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: No eventSubURL - cannot "
literal|"subscribe"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|ap
operator|->
name|http
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Pending HTTP request - cannot "
literal|"send subscribe request"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|url
operator|=
name|http_client_url_parse
argument_list|(
name|ap
operator|->
name|event_sub_url
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to parse eventSubURL"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|req
operator|=
name|wpabuf_alloc
argument_list|(
name|os_strlen
argument_list|(
name|ap
operator|->
name|event_sub_url
argument_list|)
operator|+
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|uuid_bin2str
argument_list|(
name|ap
operator|->
name|sid
argument_list|,
name|sid
argument_list|,
sizeof|sizeof
argument_list|(
name|sid
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_printf
argument_list|(
name|req
argument_list|,
literal|"UNSUBSCRIBE %s HTTP/1.1\r\n"
literal|"HOST: %s:%d\r\n"
literal|"SID: uuid:%s\r\n"
literal|"\r\n"
argument_list|,
name|path
argument_list|,
name|inet_ntoa
argument_list|(
name|dst
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|dst
operator|.
name|sin_port
argument_list|)
argument_list|,
name|sid
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS ER: Unsubscription request"
argument_list|,
name|wpabuf_head
argument_list|(
name|req
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|http_client_addr
argument_list|(
operator|&
name|dst
argument_list|,
name|req
argument_list|,
literal|1000
argument_list|,
name|wps_er_http_unsubscribe_cb
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|http
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
return|return;
name|fail
label|:
comment|/* 	 * Need to get rid of the AP entry even when we fail to unsubscribe 	 * cleanly. 	 */
name|wps_er_ap_unsubscribed
argument_list|(
name|ap
operator|->
name|er
argument_list|,
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_remove_entry
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Removing AP entry for %s (%s)"
argument_list|,
name|inet_ntoa
argument_list|(
name|ap
operator|->
name|addr
argument_list|)
argument_list|,
name|ap
operator|->
name|location
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_er_ap_timeout
argument_list|,
name|er
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|wps_er_sta_remove_all
argument_list|(
name|ap
argument_list|)
expr_stmt|;
name|wps_er_ap_event
argument_list|(
name|er
operator|->
name|wps
argument_list|,
name|ap
argument_list|,
name|WPS_EV_ER_AP_REMOVE
argument_list|)
expr_stmt|;
name|http_client_free
argument_list|(
name|ap
operator|->
name|http
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|wps
condition|)
block|{
name|wps_deinit
argument_list|(
name|ap
operator|->
name|wps
argument_list|)
expr_stmt|;
name|ap
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
block|}
name|dl_list_del
argument_list|(
operator|&
name|ap
operator|->
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|subscribed
condition|)
block|{
name|dl_list_add
argument_list|(
operator|&
name|er
operator|->
name|ap_unsubscribing
argument_list|,
operator|&
name|ap
operator|->
name|list
argument_list|)
expr_stmt|;
name|wps_er_ap_unsubscribe
argument_list|(
name|er
argument_list|,
name|ap
argument_list|)
expr_stmt|;
block|}
else|else
name|wps_er_ap_free
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|wps_er
modifier|*
name|er
init|=
name|eloop_data
decl_stmt|;
name|struct
name|wps_er_ap
modifier|*
name|ap
init|=
name|user_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: AP advertisement timed out"
argument_list|)
expr_stmt|;
name|wps_er_ap_remove_entry
argument_list|(
name|er
argument_list|,
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_er_get_sid
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|char
modifier|*
name|sid
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|char
name|txt
index|[
literal|100
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|sid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: No SID received from %s (%s)"
argument_list|,
name|inet_ntoa
argument_list|(
name|ap
operator|->
name|addr
argument_list|)
argument_list|,
name|ap
operator|->
name|location
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|os_strstr
argument_list|(
name|sid
argument_list|,
literal|"uuid:"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Invalid SID received from "
literal|"%s (%s): '%s'"
argument_list|,
name|inet_ntoa
argument_list|(
name|ap
operator|->
name|addr
argument_list|)
argument_list|,
name|ap
operator|->
name|location
argument_list|,
name|sid
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|5
expr_stmt|;
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|pos
argument_list|,
name|ap
operator|->
name|sid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Invalid SID received from "
literal|"%s (%s): '%s'"
argument_list|,
name|inet_ntoa
argument_list|(
name|ap
operator|->
name|addr
argument_list|)
argument_list|,
name|ap
operator|->
name|location
argument_list|,
name|sid
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|uuid_bin2str
argument_list|(
name|ap
operator|->
name|sid
argument_list|,
name|txt
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: SID for subscription with %s (%s): %s"
argument_list|,
name|inet_ntoa
argument_list|(
name|ap
operator|->
name|addr
argument_list|)
argument_list|,
name|ap
operator|->
name|location
argument_list|,
name|txt
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_subscribe_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_client
modifier|*
name|c
parameter_list|,
name|enum
name|http_client_event
name|event
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
init|=
name|ctx
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|HTTP_CLIENT_OK
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Subscribed to events"
argument_list|)
expr_stmt|;
name|ap
operator|->
name|subscribed
operator|=
literal|1
expr_stmt|;
name|wps_er_get_sid
argument_list|(
name|ap
argument_list|,
name|http_client_get_hdr_line
argument_list|(
name|c
argument_list|,
literal|"SID"
argument_list|)
argument_list|)
expr_stmt|;
name|wps_er_ap_event
argument_list|(
name|ap
operator|->
name|er
operator|->
name|wps
argument_list|,
name|ap
argument_list|,
name|WPS_EV_ER_AP_ADD
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTP_CLIENT_FAILED
case|:
case|case
name|HTTP_CLIENT_INVALID_REPLY
case|:
case|case
name|HTTP_CLIENT_TIMEOUT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to subscribe to events"
argument_list|)
expr_stmt|;
break|break;
block|}
name|http_client_free
argument_list|(
name|ap
operator|->
name|http
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_subscribe
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|req
decl_stmt|;
name|struct
name|sockaddr_in
name|dst
decl_stmt|;
name|char
modifier|*
name|url
decl_stmt|,
modifier|*
name|path
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|event_sub_url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: No eventSubURL - cannot "
literal|"subscribe"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ap
operator|->
name|http
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Pending HTTP request - cannot "
literal|"send subscribe request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|url
operator|=
name|http_client_url_parse
argument_list|(
name|ap
operator|->
name|event_sub_url
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to parse eventSubURL"
argument_list|)
expr_stmt|;
return|return;
block|}
name|req
operator|=
name|wpabuf_alloc
argument_list|(
name|os_strlen
argument_list|(
name|ap
operator|->
name|event_sub_url
argument_list|)
operator|+
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpabuf_printf
argument_list|(
name|req
argument_list|,
literal|"SUBSCRIBE %s HTTP/1.1\r\n"
literal|"HOST: %s:%d\r\n"
literal|"CALLBACK:<http://%s:%d/event/%u/%u>\r\n"
literal|"NT: upnp:event\r\n"
literal|"TIMEOUT: Second-%d\r\n"
literal|"\r\n"
argument_list|,
name|path
argument_list|,
name|inet_ntoa
argument_list|(
name|dst
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|dst
operator|.
name|sin_port
argument_list|)
argument_list|,
name|ap
operator|->
name|er
operator|->
name|ip_addr_text
argument_list|,
name|ap
operator|->
name|er
operator|->
name|http_port
argument_list|,
name|ap
operator|->
name|er
operator|->
name|event_id
argument_list|,
name|ap
operator|->
name|id
argument_list|,
literal|1800
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS ER: Subscription request"
argument_list|,
name|wpabuf_head
argument_list|(
name|req
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|http_client_addr
argument_list|(
operator|&
name|dst
argument_list|,
name|req
argument_list|,
literal|1000
argument_list|,
name|wps_er_http_subscribe_cb
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|http
operator|==
name|NULL
condition|)
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_get_m1
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|m1
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|m1
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to parse M1"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|attr
operator|.
name|primary_dev_type
condition|)
name|os_memcpy
argument_list|(
name|ap
operator|->
name|pri_dev_type
argument_list|,
name|attr
operator|.
name|primary_dev_type
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|wps_state
condition|)
name|ap
operator|->
name|wps_state
operator|=
operator|*
name|attr
operator|.
name|wps_state
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|mac_addr
condition|)
name|os_memcpy
argument_list|(
name|ap
operator|->
name|mac_addr
argument_list|,
name|attr
operator|.
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wps_er_subscribe
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_get_device_info
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|)
block|{
name|wps_er_send_get_device_info
argument_list|(
name|ap
argument_list|,
name|wps_er_ap_get_m1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_parse_device_description
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|reply
parameter_list|)
block|{
comment|/* Note: reply includes null termination after the buffer data */
specifier|const
name|char
modifier|*
name|data
init|=
name|wpabuf_head
argument_list|(
name|reply
argument_list|)
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS ER: Device info"
argument_list|,
name|wpabuf_head
argument_list|(
name|reply
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
name|ap
operator|->
name|friendly_name
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"friendlyName"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: friendlyName='%s'"
argument_list|,
name|ap
operator|->
name|friendly_name
argument_list|)
expr_stmt|;
name|ap
operator|->
name|manufacturer
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"manufacturer"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: manufacturer='%s'"
argument_list|,
name|ap
operator|->
name|manufacturer
argument_list|)
expr_stmt|;
name|ap
operator|->
name|manufacturer_url
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"manufacturerURL"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: manufacturerURL='%s'"
argument_list|,
name|ap
operator|->
name|manufacturer_url
argument_list|)
expr_stmt|;
name|ap
operator|->
name|model_description
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"modelDescription"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: modelDescription='%s'"
argument_list|,
name|ap
operator|->
name|model_description
argument_list|)
expr_stmt|;
name|ap
operator|->
name|model_name
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"modelName"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: modelName='%s'"
argument_list|,
name|ap
operator|->
name|model_name
argument_list|)
expr_stmt|;
name|ap
operator|->
name|model_number
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"modelNumber"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: modelNumber='%s'"
argument_list|,
name|ap
operator|->
name|model_number
argument_list|)
expr_stmt|;
name|ap
operator|->
name|model_url
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"modelURL"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: modelURL='%s'"
argument_list|,
name|ap
operator|->
name|model_url
argument_list|)
expr_stmt|;
name|ap
operator|->
name|serial_number
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"serialNumber"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: serialNumber='%s'"
argument_list|,
name|ap
operator|->
name|serial_number
argument_list|)
expr_stmt|;
name|ap
operator|->
name|udn
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"UDN"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: UDN='%s'"
argument_list|,
name|ap
operator|->
name|udn
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|ap
operator|->
name|udn
argument_list|,
literal|"uuid:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|+=
literal|5
expr_stmt|;
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|pos
argument_list|,
name|ap
operator|->
name|uuid
argument_list|)
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Invalid UUID in UDN"
argument_list|)
expr_stmt|;
block|}
name|ap
operator|->
name|upc
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"UPC"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: UPC='%s'"
argument_list|,
name|ap
operator|->
name|upc
argument_list|)
expr_stmt|;
name|ap
operator|->
name|scpd_url
operator|=
name|http_link_update
argument_list|(
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"SCPDURL"
argument_list|)
argument_list|,
name|ap
operator|->
name|location
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: SCPDURL='%s'"
argument_list|,
name|ap
operator|->
name|scpd_url
argument_list|)
expr_stmt|;
name|ap
operator|->
name|control_url
operator|=
name|http_link_update
argument_list|(
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"controlURL"
argument_list|)
argument_list|,
name|ap
operator|->
name|location
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: controlURL='%s'"
argument_list|,
name|ap
operator|->
name|control_url
argument_list|)
expr_stmt|;
name|ap
operator|->
name|event_sub_url
operator|=
name|http_link_update
argument_list|(
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"eventSubURL"
argument_list|)
argument_list|,
name|ap
operator|->
name|location
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: eventSubURL='%s'"
argument_list|,
name|ap
operator|->
name|event_sub_url
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_dev_desc_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_client
modifier|*
name|c
parameter_list|,
name|enum
name|http_client_event
name|event
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
init|=
name|ctx
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|reply
decl_stmt|;
name|int
name|ok
init|=
literal|0
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|HTTP_CLIENT_OK
case|:
name|reply
operator|=
name|http_client_get_body
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
break|break;
name|wps_er_parse_device_description
argument_list|(
name|ap
argument_list|,
name|reply
argument_list|)
expr_stmt|;
name|ok
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|HTTP_CLIENT_FAILED
case|:
case|case
name|HTTP_CLIENT_INVALID_REPLY
case|:
case|case
name|HTTP_CLIENT_TIMEOUT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to fetch device info"
argument_list|)
expr_stmt|;
break|break;
block|}
name|http_client_free
argument_list|(
name|ap
operator|->
name|http
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ok
condition|)
name|wps_er_get_device_info
argument_list|(
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wps_er_ap_add
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|,
name|struct
name|in_addr
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|location
parameter_list|,
name|int
name|max_age
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
decl_stmt|;
name|ap
operator|=
name|wps_er_ap_get
argument_list|(
name|er
argument_list|,
name|addr
argument_list|,
name|uuid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
condition|)
block|{
comment|/* Update advertisement timeout */
name|eloop_cancel_timeout
argument_list|(
name|wps_er_ap_timeout
argument_list|,
name|er
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|max_age
argument_list|,
literal|0
argument_list|,
name|wps_er_ap_timeout
argument_list|,
name|er
argument_list|,
name|ap
argument_list|)
expr_stmt|;
return|return;
block|}
name|ap
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ap
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|==
name|NULL
condition|)
return|return;
name|dl_list_init
argument_list|(
operator|&
name|ap
operator|->
name|sta
argument_list|)
expr_stmt|;
name|ap
operator|->
name|er
operator|=
name|er
expr_stmt|;
name|ap
operator|->
name|id
operator|=
operator|++
name|er
operator|->
name|next_ap_id
expr_stmt|;
name|ap
operator|->
name|location
operator|=
name|os_strdup
argument_list|(
name|location
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|location
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|ap
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_add
argument_list|(
operator|&
name|er
operator|->
name|ap
argument_list|,
operator|&
name|ap
operator|->
name|list
argument_list|)
expr_stmt|;
name|ap
operator|->
name|addr
operator|.
name|s_addr
operator|=
name|addr
operator|->
name|s_addr
expr_stmt|;
name|os_memcpy
argument_list|(
name|ap
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|max_age
argument_list|,
literal|0
argument_list|,
name|wps_er_ap_timeout
argument_list|,
name|er
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Added AP entry for %s (%s)"
argument_list|,
name|inet_ntoa
argument_list|(
name|ap
operator|->
name|addr
argument_list|)
argument_list|,
name|ap
operator|->
name|location
argument_list|)
expr_stmt|;
comment|/* Fetch device description */
name|ap
operator|->
name|http
operator|=
name|http_client_url
argument_list|(
name|ap
operator|->
name|location
argument_list|,
name|NULL
argument_list|,
literal|10000
argument_list|,
name|wps_er_http_dev_desc_cb
argument_list|,
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wps_er_ap_remove
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
name|struct
name|in_addr
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|ap
argument_list|,
argument|&er->ap
argument_list|,
argument|struct wps_er_ap
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|ap
operator|->
name|addr
operator|.
name|s_addr
operator|==
name|addr
operator|->
name|s_addr
condition|)
block|{
name|wps_er_ap_remove_entry
argument_list|(
name|er
argument_list|,
name|ap
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_remove_all
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|prev
decl_stmt|,
modifier|*
name|ap
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|ap
argument_list|,
argument|prev
argument_list|,
argument|&er->ap
argument_list|,
argument|struct wps_er_ap
argument_list|,
argument|list
argument_list|)
name|wps_er_ap_remove_entry
argument_list|(
name|er
argument_list|,
name|ap
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_put_date
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"Date: "
argument_list|)
expr_stmt|;
name|format_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_resp_not_found
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"HTTP/1.1 404 Not Found\r\n"
literal|"Server: unspecified, UPnP/1.0, unspecified\r\n"
literal|"Connection: close\r\n"
argument_list|)
expr_stmt|;
name|http_put_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|http_request_send_and_deinit
argument_list|(
name|req
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_resp_ok
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"HTTP/1.1 200 OK\r\n"
literal|"Server: unspecified, UPnP/1.0, unspecified\r\n"
literal|"Connection: close\r\n"
literal|"Content-Length: 0\r\n"
argument_list|)
expr_stmt|;
name|http_put_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|http_request_send_and_deinit
argument_list|(
name|req
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_sta_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|wps_er_sta
modifier|*
name|sta
init|=
name|eloop_data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: STA entry timed out"
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|sta
operator|->
name|list
argument_list|)
expr_stmt|;
name|wps_er_sta_free
argument_list|(
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wps_er_sta
modifier|*
name|wps_er_add_sta_data
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|,
name|int
name|probe_req
parameter_list|)
block|{
name|struct
name|wps_er_sta
modifier|*
name|sta
init|=
name|wps_er_sta_get
argument_list|(
name|ap
argument_list|,
name|addr
argument_list|)
decl_stmt|;
name|int
name|new_sta
init|=
literal|0
decl_stmt|;
name|int
name|m1
decl_stmt|;
name|m1
operator|=
operator|!
name|probe_req
operator|&&
name|attr
operator|->
name|msg_type
operator|&&
operator|*
name|attr
operator|->
name|msg_type
operator|==
name|WPS_M1
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * Only allow new STA entry to be added based on Probe Request 		 * or M1. This will filter out bogus events and anything that 		 * may have been ongoing at the time ER subscribed for events. 		 */
if|if
condition|(
operator|!
name|probe_req
operator|&&
operator|!
name|m1
condition|)
return|return
name|NULL
return|;
name|sta
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sta
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|sta
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|sta
operator|->
name|ap
operator|=
name|ap
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|ap
operator|->
name|sta
argument_list|,
operator|&
name|sta
operator|->
name|list
argument_list|)
expr_stmt|;
name|new_sta
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|m1
condition|)
name|sta
operator|->
name|m1_received
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|config_methods
operator|&&
operator|(
operator|!
name|probe_req
operator|||
operator|!
name|sta
operator|->
name|m1_received
operator|)
condition|)
name|sta
operator|->
name|config_methods
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|->
name|config_methods
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|uuid_e
operator|&&
operator|(
operator|!
name|probe_req
operator|||
operator|!
name|sta
operator|->
name|m1_received
operator|)
condition|)
name|os_memcpy
argument_list|(
name|sta
operator|->
name|uuid
argument_list|,
name|attr
operator|->
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|primary_dev_type
operator|&&
operator|(
operator|!
name|probe_req
operator|||
operator|!
name|sta
operator|->
name|m1_received
operator|)
condition|)
name|os_memcpy
argument_list|(
name|sta
operator|->
name|pri_dev_type
argument_list|,
name|attr
operator|->
name|primary_dev_type
argument_list|,
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|dev_password_id
operator|&&
operator|(
operator|!
name|probe_req
operator|||
operator|!
name|sta
operator|->
name|m1_received
operator|)
condition|)
name|sta
operator|->
name|dev_passwd_id
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|->
name|dev_password_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|manufacturer
condition|)
block|{
name|os_free
argument_list|(
name|sta
operator|->
name|manufacturer
argument_list|)
expr_stmt|;
name|sta
operator|->
name|manufacturer
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|manufacturer_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|manufacturer
condition|)
block|{
name|os_memcpy
argument_list|(
name|sta
operator|->
name|manufacturer
argument_list|,
name|attr
operator|->
name|manufacturer
argument_list|,
name|attr
operator|->
name|manufacturer_len
argument_list|)
expr_stmt|;
name|sta
operator|->
name|manufacturer
index|[
name|attr
operator|->
name|manufacturer_len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
if|if
condition|(
name|attr
operator|->
name|model_name
condition|)
block|{
name|os_free
argument_list|(
name|sta
operator|->
name|model_name
argument_list|)
expr_stmt|;
name|sta
operator|->
name|model_name
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|model_name_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|model_name
condition|)
block|{
name|os_memcpy
argument_list|(
name|sta
operator|->
name|model_name
argument_list|,
name|attr
operator|->
name|model_name
argument_list|,
name|attr
operator|->
name|model_name_len
argument_list|)
expr_stmt|;
name|sta
operator|->
name|model_name
index|[
name|attr
operator|->
name|model_name_len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
if|if
condition|(
name|attr
operator|->
name|model_number
condition|)
block|{
name|os_free
argument_list|(
name|sta
operator|->
name|model_number
argument_list|)
expr_stmt|;
name|sta
operator|->
name|model_number
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|model_number_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|model_number
condition|)
block|{
name|os_memcpy
argument_list|(
name|sta
operator|->
name|model_number
argument_list|,
name|attr
operator|->
name|model_number
argument_list|,
name|attr
operator|->
name|model_number_len
argument_list|)
expr_stmt|;
name|sta
operator|->
name|model_number
index|[
name|attr
operator|->
name|model_number_len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
if|if
condition|(
name|attr
operator|->
name|serial_number
condition|)
block|{
name|os_free
argument_list|(
name|sta
operator|->
name|serial_number
argument_list|)
expr_stmt|;
name|sta
operator|->
name|serial_number
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|serial_number_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|serial_number
condition|)
block|{
name|os_memcpy
argument_list|(
name|sta
operator|->
name|serial_number
argument_list|,
name|attr
operator|->
name|serial_number
argument_list|,
name|attr
operator|->
name|serial_number_len
argument_list|)
expr_stmt|;
name|sta
operator|->
name|serial_number
index|[
name|attr
operator|->
name|serial_number_len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
if|if
condition|(
name|attr
operator|->
name|dev_name
condition|)
block|{
name|os_free
argument_list|(
name|sta
operator|->
name|dev_name
argument_list|)
expr_stmt|;
name|sta
operator|->
name|dev_name
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|dev_name_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|dev_name
condition|)
block|{
name|os_memcpy
argument_list|(
name|sta
operator|->
name|dev_name
argument_list|,
name|attr
operator|->
name|dev_name
argument_list|,
name|attr
operator|->
name|dev_name_len
argument_list|)
expr_stmt|;
name|sta
operator|->
name|dev_name
index|[
name|attr
operator|->
name|dev_name_len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
name|eloop_cancel_timeout
argument_list|(
name|wps_er_sta_timeout
argument_list|,
name|sta
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|300
argument_list|,
literal|0
argument_list|,
name|wps_er_sta_timeout
argument_list|,
name|sta
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|m1
operator|||
name|new_sta
condition|)
name|wps_er_sta_event
argument_list|(
name|ap
operator|->
name|er
operator|->
name|wps
argument_list|,
name|sta
argument_list|,
name|WPS_EV_ER_ENROLLEE_ADD
argument_list|)
expr_stmt|;
return|return
name|sta
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_process_wlanevent_probe_req
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: WLANEvent - Probe Request - from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS ER: WLANEvent - Enrollee's message "
literal|"(TLVs from Probe Request)"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to parse TLVs in "
literal|"WLANEvent message"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wps_er_add_sta_data
argument_list|(
name|ap
argument_list|,
name|addr
argument_list|,
operator|&
name|attr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_put_wlan_response_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_client
modifier|*
name|c
parameter_list|,
name|enum
name|http_client_event
name|event
parameter_list|)
block|{
name|struct
name|wps_er_sta
modifier|*
name|sta
init|=
name|ctx
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|HTTP_CLIENT_OK
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: PutWLANResponse OK"
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTP_CLIENT_FAILED
case|:
case|case
name|HTTP_CLIENT_INVALID_REPLY
case|:
case|case
name|HTTP_CLIENT_TIMEOUT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: PutWLANResponse failed"
argument_list|)
expr_stmt|;
break|break;
block|}
name|http_client_free
argument_list|(
name|sta
operator|->
name|http
argument_list|)
expr_stmt|;
name|sta
operator|->
name|http
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|soap_prefix
init|=
literal|"<?xml version=\"1.0\"?>\n"
literal|"<s:Envelope xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\" "
literal|"s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\">\n"
literal|"<s:Body>\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|soap_postfix
init|=
literal|"</s:Body>\n</s:Envelope>\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|urn_wfawlanconfig
init|=
literal|"urn:schemas-wifialliance-org:service:WFAWLANConfig:1"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_er_soap_hdr
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
specifier|const
name|char
modifier|*
name|arg_name
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|,
specifier|const
name|struct
name|sockaddr_in
modifier|*
name|dst
parameter_list|,
name|char
modifier|*
modifier|*
name|len_ptr
parameter_list|,
name|char
modifier|*
modifier|*
name|body_ptr
parameter_list|)
block|{
name|unsigned
name|char
modifier|*
name|encoded
decl_stmt|;
name|size_t
name|encoded_len
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
if|if
condition|(
name|msg
condition|)
block|{
name|encoded
operator|=
name|base64_encode
argument_list|(
name|wpabuf_head
argument_list|(
name|msg
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
argument_list|,
operator|&
name|encoded_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|encoded
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
block|}
else|else
block|{
name|encoded
operator|=
name|NULL
expr_stmt|;
name|encoded_len
operator|=
literal|0
expr_stmt|;
block|}
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
operator|+
name|encoded_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"POST %s HTTP/1.1\r\n"
literal|"Host: %s:%d\r\n"
literal|"Content-Type: text/xml; charset=\"utf-8\"\r\n"
literal|"Content-Length: "
argument_list|,
name|path
argument_list|,
name|inet_ntoa
argument_list|(
name|dst
operator|->
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|dst
operator|->
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|len_ptr
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"        \r\n"
literal|"SOAPACTION: \"%s#%s\"\r\n"
literal|"\r\n"
argument_list|,
name|urn_wfawlanconfig
argument_list|,
name|name
argument_list|)
expr_stmt|;
operator|*
name|body_ptr
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|soap_prefix
argument_list|)
expr_stmt|;
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"<u:%s xmlns:u=\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|urn_wfawlanconfig
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\">\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|encoded
condition|)
block|{
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"<%s>%s</%s>\n"
argument_list|,
name|arg_name
argument_list|,
operator|(
name|char
operator|*
operator|)
name|encoded
argument_list|,
name|arg_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|encoded
argument_list|)
expr_stmt|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_soap_end
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|char
modifier|*
name|len_ptr
parameter_list|,
name|char
modifier|*
name|body_ptr
parameter_list|)
block|{
name|char
name|len_buf
index|[
literal|10
index|]
decl_stmt|;
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"</u:%s>\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|soap_postfix
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|len_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|len_buf
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
call|(
name|int
call|)
argument_list|(
operator|(
name|char
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|body_ptr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|len_ptr
argument_list|,
name|len_buf
argument_list|,
name|os_strlen
argument_list|(
name|len_buf
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_sta_send_msg
parameter_list|(
name|struct
name|wps_er_sta
modifier|*
name|sta
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|len_ptr
decl_stmt|,
modifier|*
name|body_ptr
decl_stmt|;
name|struct
name|sockaddr_in
name|dst
decl_stmt|;
name|char
modifier|*
name|url
decl_stmt|,
modifier|*
name|path
decl_stmt|;
if|if
condition|(
name|sta
operator|->
name|http
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Pending HTTP request for STA - "
literal|"ignore new request"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sta
operator|->
name|ap
operator|->
name|control_url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: No controlURL for AP"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|url
operator|=
name|http_client_url_parse
argument_list|(
name|sta
operator|->
name|ap
operator|->
name|control_url
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to parse controlURL"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
operator|=
name|wps_er_soap_hdr
argument_list|(
name|msg
argument_list|,
literal|"PutWLANResponse"
argument_list|,
literal|"NewMessage"
argument_list|,
name|path
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|len_ptr
argument_list|,
operator|&
name|body_ptr
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"<NewWLANEventType>%d</NewWLANEventType>\n"
argument_list|,
name|UPNP_WPS_WLANEVENT_TYPE_EAP
argument_list|)
expr_stmt|;
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"<NewWLANEventMAC>"
name|MACSTR
literal|"</NewWLANEventMAC>\n"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wps_er_soap_end
argument_list|(
name|buf
argument_list|,
literal|"PutWLANResponse"
argument_list|,
name|len_ptr
argument_list|,
name|body_ptr
argument_list|)
expr_stmt|;
name|sta
operator|->
name|http
operator|=
name|http_client_addr
argument_list|(
operator|&
name|dst
argument_list|,
name|buf
argument_list|,
literal|1000
argument_list|,
name|wps_er_http_put_wlan_response_cb
argument_list|,
name|sta
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|http
operator|==
name|NULL
condition|)
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_sta_process
parameter_list|(
name|struct
name|wps_er_sta
modifier|*
name|sta
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|enum
name|wsc_op_code
name|op_code
parameter_list|)
block|{
name|enum
name|wps_process_res
name|res
decl_stmt|;
name|res
operator|=
name|wps_process_msg
argument_list|(
name|sta
operator|->
name|wps
argument_list|,
name|op_code
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|WPS_CONTINUE
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|next
init|=
name|wps_get_msg
argument_list|(
name|sta
operator|->
name|wps
argument_list|,
operator|&
name|op_code
argument_list|)
decl_stmt|;
if|if
condition|(
name|next
condition|)
name|wps_er_sta_send_msg
argument_list|(
name|sta
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Protocol run %s with the "
literal|"enrollee (res=%d)"
argument_list|,
name|res
operator|==
name|WPS_DONE
condition|?
literal|"succeeded"
else|:
literal|"failed"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wps_deinit
argument_list|(
name|sta
operator|->
name|wps
argument_list|)
expr_stmt|;
name|sta
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|WPS_DONE
condition|)
block|{
comment|/* Remove the STA entry after short timeout */
name|eloop_cancel_timeout
argument_list|(
name|wps_er_sta_timeout
argument_list|,
name|sta
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|10
argument_list|,
literal|0
argument_list|,
name|wps_er_sta_timeout
argument_list|,
name|sta
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_sta_start
parameter_list|(
name|struct
name|wps_er_sta
modifier|*
name|sta
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_config
name|cfg
decl_stmt|;
if|if
condition|(
name|sta
operator|->
name|wps
condition|)
name|wps_deinit
argument_list|(
name|sta
operator|->
name|wps
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|wps
operator|=
name|sta
operator|->
name|ap
operator|->
name|er
operator|->
name|wps
expr_stmt|;
name|cfg
operator|.
name|registrar
operator|=
literal|1
expr_stmt|;
name|cfg
operator|.
name|peer_addr
operator|=
name|sta
operator|->
name|addr
expr_stmt|;
name|sta
operator|->
name|wps
operator|=
name|wps_init
argument_list|(
operator|&
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return;
name|sta
operator|->
name|wps
operator|->
name|er
operator|=
literal|1
expr_stmt|;
name|sta
operator|->
name|wps
operator|->
name|use_cred
operator|=
name|sta
operator|->
name|ap
operator|->
name|ap_settings
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|ap
operator|->
name|ap_settings
condition|)
block|{
name|os_free
argument_list|(
name|sta
operator|->
name|cred
argument_list|)
expr_stmt|;
name|sta
operator|->
name|cred
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sta
operator|->
name|cred
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|cred
condition|)
block|{
name|os_memcpy
argument_list|(
name|sta
operator|->
name|cred
argument_list|,
name|sta
operator|->
name|ap
operator|->
name|ap_settings
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sta
operator|->
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|sta
operator|->
name|cred
operator|->
name|cred_attr
operator|=
name|NULL
expr_stmt|;
name|os_memcpy
argument_list|(
name|sta
operator|->
name|cred
operator|->
name|mac_addr
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|sta
operator|->
name|wps
operator|->
name|use_cred
operator|=
name|sta
operator|->
name|cred
expr_stmt|;
block|}
block|}
name|wps_er_sta_process
argument_list|(
name|sta
argument_list|,
name|msg
argument_list|,
name|WSC_MSG
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_process_wlanevent_eap
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|struct
name|wps_er_sta
modifier|*
name|sta
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: WLANEvent - EAP - from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS ER: WLANEvent - Enrollee's message "
literal|"(TLVs from EAP-WSC)"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to parse TLVs in "
literal|"WLANEvent message"
argument_list|)
expr_stmt|;
return|return;
block|}
name|sta
operator|=
name|wps_er_add_sta_data
argument_list|(
name|ap
argument_list|,
name|addr
argument_list|,
operator|&
name|attr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|&&
operator|*
name|attr
operator|.
name|msg_type
operator|==
name|WPS_M1
condition|)
name|wps_er_sta_start
argument_list|(
name|sta
argument_list|,
name|msg
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sta
operator|->
name|wps
condition|)
block|{
name|enum
name|wsc_op_code
name|op_code
init|=
name|WSC_MSG
decl_stmt|;
if|if
condition|(
name|attr
operator|.
name|msg_type
condition|)
block|{
switch|switch
condition|(
operator|*
name|attr
operator|.
name|msg_type
condition|)
block|{
case|case
name|WPS_WSC_ACK
case|:
name|op_code
operator|=
name|WSC_ACK
expr_stmt|;
break|break;
case|case
name|WPS_WSC_NACK
case|:
name|op_code
operator|=
name|WSC_NACK
expr_stmt|;
break|break;
case|case
name|WPS_WSC_DONE
case|:
name|op_code
operator|=
name|WSC_Done
expr_stmt|;
break|break;
block|}
block|}
name|wps_er_sta_process
argument_list|(
name|sta
argument_list|,
name|msg
argument_list|,
name|op_code
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_process_wlanevent
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|event
parameter_list|)
block|{
name|u8
modifier|*
name|data
decl_stmt|;
name|u8
name|wlan_event_type
decl_stmt|;
name|u8
name|wlan_event_mac
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|wpabuf
name|msg
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS ER: Received WLANEvent"
argument_list|,
name|wpabuf_head
argument_list|(
name|event
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|event
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|event
argument_list|)
operator|<
literal|1
operator|+
literal|17
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Too short WLANEvent"
argument_list|)
expr_stmt|;
return|return;
block|}
name|data
operator|=
name|wpabuf_mhead
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|wlan_event_type
operator|=
name|data
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
operator|(
name|char
operator|*
operator|)
name|data
operator|+
literal|1
argument_list|,
name|wlan_event_mac
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Invalid WLANEventMAC in "
literal|"WLANEvent"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpabuf_set
argument_list|(
operator|&
name|msg
argument_list|,
name|data
operator|+
literal|1
operator|+
literal|17
argument_list|,
name|wpabuf_len
argument_list|(
name|event
argument_list|)
operator|-
operator|(
literal|1
operator|+
literal|17
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|wlan_event_type
condition|)
block|{
case|case
literal|1
case|:
name|wps_er_process_wlanevent_probe_req
argument_list|(
name|ap
argument_list|,
name|wlan_event_mac
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|wps_er_process_wlanevent_eap
argument_list|(
name|ap
argument_list|,
name|wlan_event_mac
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Unknown WLANEventType %d"
argument_list|,
name|wlan_event_type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_event
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
name|struct
name|http_request
modifier|*
name|req
parameter_list|,
name|unsigned
name|int
name|ap_id
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
init|=
name|wps_er_ap_get_id
argument_list|(
name|er
argument_list|,
name|ap_id
argument_list|)
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|event
decl_stmt|;
name|enum
name|http_reply_code
name|ret
decl_stmt|;
if|if
condition|(
name|ap
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: HTTP event from unknown AP id "
literal|"%u"
argument_list|,
name|ap_id
argument_list|)
expr_stmt|;
name|wps_er_http_resp_not_found
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS ER: HTTP event from AP id %u: %s"
argument_list|,
name|ap_id
argument_list|,
name|http_request_get_data
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|event
operator|=
name|xml_get_base64_item
argument_list|(
name|http_request_get_data
argument_list|(
name|req
argument_list|)
argument_list|,
literal|"WLANEvent"
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|event
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Could not extract WLANEvent "
literal|"from the event notification"
argument_list|)
expr_stmt|;
comment|/* 		 * Reply with OK anyway to avoid getting unregistered from 		 * events. 		 */
name|wps_er_http_resp_ok
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
name|wps_er_process_wlanevent
argument_list|(
name|ap
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|wps_er_http_resp_ok
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_notify
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
name|char
modifier|*
name|uri
init|=
name|http_request_get_uri
argument_list|(
name|req
argument_list|)
decl_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|uri
argument_list|,
literal|"/event/"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|unsigned
name|int
name|event_id
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|event_id
operator|=
name|atoi
argument_list|(
name|uri
operator|+
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|event_id
operator|!=
name|er
operator|->
name|event_id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: HTTP event for an "
literal|"unknown event id %u"
argument_list|,
name|event_id
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|=
name|os_strchr
argument_list|(
name|uri
operator|+
literal|7
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return;
name|pos
operator|++
expr_stmt|;
name|wps_er_http_event
argument_list|(
name|er
argument_list|,
name|req
argument_list|,
name|atoi
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Unknown HTTP NOTIFY for '%s'"
argument_list|,
name|uri
argument_list|)
expr_stmt|;
name|wps_er_http_resp_not_found
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_req
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|wps_er
modifier|*
name|er
init|=
name|ctx
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|cli
init|=
name|http_request_get_cli_addr
argument_list|(
name|req
argument_list|)
decl_stmt|;
name|enum
name|httpread_hdr_type
name|type
init|=
name|http_request_get_type
argument_list|(
name|req
argument_list|)
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: HTTP request: '%s' (type %d) from "
literal|"%s:%d"
argument_list|,
name|http_request_get_uri
argument_list|(
name|req
argument_list|)
argument_list|,
name|type
argument_list|,
name|inet_ntoa
argument_list|(
name|cli
operator|->
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|cli
operator|->
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|HTTPREAD_HDR_TYPE_NOTIFY
case|:
name|wps_er_http_notify
argument_list|(
name|er
argument_list|,
name|req
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Unsupported HTTP request type "
literal|"%d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"HTTP/1.1 501 Unimplemented\r\n"
literal|"Connection: close\r\n"
argument_list|)
expr_stmt|;
name|http_put_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|http_request_send_and_deinit
argument_list|(
name|req
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|struct
name|wps_er
modifier|*
name|wps_er_init
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wps_er
modifier|*
name|er
decl_stmt|;
name|struct
name|in_addr
name|addr
decl_stmt|;
name|er
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|er
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|er
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|dl_list_init
argument_list|(
operator|&
name|er
operator|->
name|ap
argument_list|)
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|er
operator|->
name|ap_unsubscribing
argument_list|)
expr_stmt|;
name|er
operator|->
name|multicast_sd
operator|=
operator|-
literal|1
expr_stmt|;
name|er
operator|->
name|ssdp_sd
operator|=
operator|-
literal|1
expr_stmt|;
name|os_strlcpy
argument_list|(
name|er
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|er
operator|->
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|er
operator|->
name|wps
operator|=
name|wps
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|er
operator|->
name|event_id
argument_list|,
sizeof|sizeof
argument_list|(
name|er
operator|->
name|event_id
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wps_er_deinit
argument_list|(
name|er
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* Limit event_id to< 32 bits to avoid issues with atoi() */
name|er
operator|->
name|event_id
operator|&=
literal|0x0fffffff
expr_stmt|;
if|if
condition|(
name|get_netif_info
argument_list|(
name|ifname
argument_list|,
operator|&
name|er
operator|->
name|ip_addr
argument_list|,
operator|&
name|er
operator|->
name|ip_addr_text
argument_list|,
name|er
operator|->
name|mac_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS UPnP: Could not get IP/MAC address "
literal|"for %s. Does it have IP address?"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|wps_er_deinit
argument_list|(
name|er
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps_er_ssdp_init
argument_list|(
name|er
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wps_er_deinit
argument_list|(
name|er
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|addr
operator|.
name|s_addr
operator|=
name|er
operator|->
name|ip_addr
expr_stmt|;
name|er
operator|->
name|http_srv
operator|=
name|http_server_init
argument_list|(
operator|&
name|addr
argument_list|,
operator|-
literal|1
argument_list|,
name|wps_er_http_req
argument_list|,
name|er
argument_list|)
expr_stmt|;
if|if
condition|(
name|er
operator|->
name|http_srv
operator|==
name|NULL
condition|)
block|{
name|wps_er_deinit
argument_list|(
name|er
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|er
operator|->
name|http_port
operator|=
name|http_server_get_port
argument_list|(
name|er
operator|->
name|http_srv
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Start (ifname=%s ip_addr=%s)"
argument_list|,
name|er
operator|->
name|ifname
argument_list|,
name|er
operator|->
name|ip_addr_text
argument_list|)
expr_stmt|;
return|return
name|er
return|;
block|}
end_function

begin_function
name|void
name|wps_er_refresh
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
decl_stmt|;
name|struct
name|wps_er_sta
modifier|*
name|sta
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|ap
argument_list|,
argument|&er->ap
argument_list|,
argument|struct wps_er_ap
argument_list|,
argument|list
argument_list|)
block|{
name|wps_er_ap_event
argument_list|(
name|er
operator|->
name|wps
argument_list|,
name|ap
argument_list|,
name|WPS_EV_ER_AP_ADD
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|sta
argument_list|,
argument|&ap->sta
argument_list|,
argument|struct wps_er_sta
argument_list|,
argument|list
argument_list|)
name|wps_er_sta_event
argument_list|(
name|er
operator|->
name|wps
argument_list|,
name|sta
argument_list|,
name|WPS_EV_ER_ENROLLEE_ADD
argument_list|)
expr_stmt|;
block|}
name|wps_er_send_ssdp_msearch
argument_list|(
name|er
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_deinit_finish
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|wps_er
modifier|*
name|er
init|=
name|eloop_data
decl_stmt|;
name|void
function_decl|(
modifier|*
name|deinit_done_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
function_decl|;
name|void
modifier|*
name|deinit_done_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Finishing deinit"
argument_list|)
expr_stmt|;
name|deinit_done_cb
operator|=
name|er
operator|->
name|deinit_done_cb
expr_stmt|;
name|deinit_done_ctx
operator|=
name|er
operator|->
name|deinit_done_ctx
expr_stmt|;
name|os_free
argument_list|(
name|er
operator|->
name|ip_addr_text
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|er
argument_list|)
expr_stmt|;
if|if
condition|(
name|deinit_done_cb
condition|)
name|deinit_done_cb
argument_list|(
name|deinit_done_ctx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wps_er_deinit
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
name|void
function_decl|(
modifier|*
name|cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|er
operator|==
name|NULL
condition|)
return|return;
name|http_server_deinit
argument_list|(
name|er
operator|->
name|http_srv
argument_list|)
expr_stmt|;
name|wps_er_ap_remove_all
argument_list|(
name|er
argument_list|)
expr_stmt|;
name|wps_er_ssdp_deinit
argument_list|(
name|er
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|dl_list_empty
argument_list|(
operator|&
name|er
operator|->
name|ap_unsubscribing
argument_list|)
condition|?
literal|0
else|:
literal|5
argument_list|,
literal|0
argument_list|,
name|wps_er_deinit_finish
argument_list|,
name|er
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Finish deinit from timeout"
argument_list|)
expr_stmt|;
name|er
operator|->
name|deinitializing
operator|=
literal|1
expr_stmt|;
name|er
operator|->
name|deinit_done_cb
operator|=
name|cb
expr_stmt|;
name|er
operator|->
name|deinit_done_ctx
operator|=
name|ctx
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_set_sel_reg_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_client
modifier|*
name|c
parameter_list|,
name|enum
name|http_client_event
name|event
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
init|=
name|ctx
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|HTTP_CLIENT_OK
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: SetSelectedRegistrar OK"
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTP_CLIENT_FAILED
case|:
case|case
name|HTTP_CLIENT_INVALID_REPLY
case|:
case|case
name|HTTP_CLIENT_TIMEOUT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: SetSelectedRegistrar failed"
argument_list|)
expr_stmt|;
break|break;
block|}
name|http_client_free
argument_list|(
name|ap
operator|->
name|http
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_send_set_sel_reg
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|len_ptr
decl_stmt|,
modifier|*
name|body_ptr
decl_stmt|;
name|struct
name|sockaddr_in
name|dst
decl_stmt|;
name|char
modifier|*
name|url
decl_stmt|,
modifier|*
name|path
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|control_url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: No controlURL for AP"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ap
operator|->
name|http
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Pending HTTP request for AP - "
literal|"ignore new request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|url
operator|=
name|http_client_url_parse
argument_list|(
name|ap
operator|->
name|control_url
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to parse controlURL"
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
operator|=
name|wps_er_soap_hdr
argument_list|(
name|msg
argument_list|,
literal|"SetSelectedRegistrar"
argument_list|,
literal|"NewMessage"
argument_list|,
name|path
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|len_ptr
argument_list|,
operator|&
name|body_ptr
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|wps_er_soap_end
argument_list|(
name|buf
argument_list|,
literal|"SetSelectedRegistrar"
argument_list|,
name|len_ptr
argument_list|,
name|body_ptr
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|http_client_addr
argument_list|(
operator|&
name|dst
argument_list|,
name|buf
argument_list|,
literal|1000
argument_list|,
name|wps_er_http_set_sel_reg_cb
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|http
operator|==
name|NULL
condition|)
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_er_build_selected_registrar
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|int
name|sel_reg
parameter_list|)
block|{
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_SELECTED_REGISTRAR
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
operator|!
operator|!
name|sel_reg
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_er_build_dev_password_id
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|u16
name|dev_passwd_id
parameter_list|)
block|{
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_DEV_PASSWORD_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|dev_passwd_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_er_build_sel_reg_config_methods
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|u16
name|sel_reg_config_methods
parameter_list|)
block|{
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_SELECTED_REGISTRAR_CONFIG_METHODS
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|sel_reg_config_methods
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wps_er_set_sel_reg
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
name|int
name|sel_reg
parameter_list|,
name|u16
name|dev_passwd_id
parameter_list|,
name|u16
name|sel_reg_config_methods
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|struct
name|wps_er_ap
modifier|*
name|ap
decl_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|500
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_er_build_selected_registrar
argument_list|(
name|msg
argument_list|,
name|sel_reg
argument_list|)
operator|||
name|wps_er_build_dev_password_id
argument_list|(
name|msg
argument_list|,
name|dev_passwd_id
argument_list|)
operator|||
name|wps_er_build_sel_reg_config_methods
argument_list|(
name|msg
argument_list|,
name|sel_reg_config_methods
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|ap
argument_list|,
argument|&er->ap
argument_list|,
argument|struct wps_er_ap
argument_list|,
argument|list
argument_list|)
name|wps_er_send_set_sel_reg
argument_list|(
name|ap
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wps_er_pbc
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|)
block|{
if|if
condition|(
name|er
operator|==
name|NULL
operator|||
name|er
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* 	 * TODO: Should enable PBC mode only in a single AP based on which AP 	 * the Enrollee (uuid) is using. Now, we may end up enabling multiple 	 * APs in PBC mode which could result in session overlap at the 	 * Enrollee. 	 */
if|if
condition|(
name|wps_registrar_button_pushed
argument_list|(
name|er
operator|->
name|wps
operator|->
name|registrar
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_settings_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
init|=
name|ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: AP Settings received"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ap
operator|->
name|ap_settings
argument_list|)
expr_stmt|;
name|ap
operator|->
name|ap_settings
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cred
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|ap_settings
condition|)
block|{
name|os_memcpy
argument_list|(
name|ap
operator|->
name|ap_settings
argument_list|,
name|cred
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|ap
operator|->
name|ap_settings
operator|->
name|cred_attr
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* TODO: send info through ctrl_iface */
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_put_message_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_client
modifier|*
name|c
parameter_list|,
name|enum
name|http_client_event
name|event
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
init|=
name|ctx
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|reply
decl_stmt|;
name|char
modifier|*
name|msg
init|=
name|NULL
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|HTTP_CLIENT_OK
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: PutMessage OK"
argument_list|)
expr_stmt|;
name|reply
operator|=
name|http_client_get_body
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
break|break;
name|msg
operator|=
name|os_zalloc
argument_list|(
name|wpabuf_len
argument_list|(
name|reply
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|msg
argument_list|,
name|wpabuf_head
argument_list|(
name|reply
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTP_CLIENT_FAILED
case|:
case|case
name|HTTP_CLIENT_INVALID_REPLY
case|:
case|case
name|HTTP_CLIENT_TIMEOUT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: PutMessage failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|wps
condition|)
block|{
name|wps_deinit
argument_list|(
name|ap
operator|->
name|wps
argument_list|)
expr_stmt|;
name|ap
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
block|}
break|break;
block|}
name|http_client_free
argument_list|(
name|ap
operator|->
name|http
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|msg
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|enum
name|http_reply_code
name|ret
decl_stmt|;
name|buf
operator|=
name|xml_get_base64_item
argument_list|(
name|msg
argument_list|,
literal|"NewOutMessage"
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Could not extract "
literal|"NewOutMessage from PutMessage response"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wps_er_ap_process
argument_list|(
name|ap
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_put_message
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|len_ptr
decl_stmt|,
modifier|*
name|body_ptr
decl_stmt|;
name|struct
name|sockaddr_in
name|dst
decl_stmt|;
name|char
modifier|*
name|url
decl_stmt|,
modifier|*
name|path
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|http
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Pending HTTP operation ongoing "
literal|"with the AP - cannot continue learn"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ap
operator|->
name|control_url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: No controlURL for AP"
argument_list|)
expr_stmt|;
return|return;
block|}
name|url
operator|=
name|http_client_url_parse
argument_list|(
name|ap
operator|->
name|control_url
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to parse controlURL"
argument_list|)
expr_stmt|;
return|return;
block|}
name|buf
operator|=
name|wps_er_soap_hdr
argument_list|(
name|msg
argument_list|,
literal|"PutMessage"
argument_list|,
literal|"NewInMessage"
argument_list|,
name|path
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|len_ptr
argument_list|,
operator|&
name|body_ptr
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|wps_er_soap_end
argument_list|(
name|buf
argument_list|,
literal|"PutMessage"
argument_list|,
name|len_ptr
argument_list|,
name|body_ptr
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|http_client_addr
argument_list|(
operator|&
name|dst
argument_list|,
name|buf
argument_list|,
literal|10000
argument_list|,
name|wps_er_http_put_message_cb
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|http
operator|==
name|NULL
condition|)
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_process
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|enum
name|wps_process_res
name|res
decl_stmt|;
name|res
operator|=
name|wps_process_msg
argument_list|(
name|ap
operator|->
name|wps
argument_list|,
name|WSC_MSG
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|WPS_CONTINUE
condition|)
block|{
name|enum
name|wsc_op_code
name|op_code
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|next
init|=
name|wps_get_msg
argument_list|(
name|ap
operator|->
name|wps
argument_list|,
operator|&
name|op_code
argument_list|)
decl_stmt|;
if|if
condition|(
name|next
condition|)
block|{
name|wps_er_ap_put_message
argument_list|(
name|ap
argument_list|,
name|next
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|next
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to build "
literal|"message"
argument_list|)
expr_stmt|;
name|wps_deinit
argument_list|(
name|ap
operator|->
name|wps
argument_list|)
expr_stmt|;
name|ap
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to process message from "
literal|"AP (res=%d)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wps_deinit
argument_list|(
name|ap
operator|->
name|wps
argument_list|)
expr_stmt|;
name|ap
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_learn_m1
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|m1
parameter_list|)
block|{
name|struct
name|wps_config
name|cfg
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|wps
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Protocol run already in "
literal|"progress with this AP"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|cfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|wps
operator|=
name|ap
operator|->
name|er
operator|->
name|wps
expr_stmt|;
name|cfg
operator|.
name|registrar
operator|=
literal|1
expr_stmt|;
name|ap
operator|->
name|wps
operator|=
name|wps_init
argument_list|(
operator|&
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return;
name|ap
operator|->
name|wps
operator|->
name|ap_settings_cb
operator|=
name|wps_er_ap_settings_cb
expr_stmt|;
name|ap
operator|->
name|wps
operator|->
name|ap_settings_cb_ctx
operator|=
name|ap
expr_stmt|;
name|wps_er_ap_process
argument_list|(
name|ap
argument_list|,
name|m1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_ap_learn
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
specifier|const
name|char
modifier|*
name|dev_info
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|info
decl_stmt|;
name|enum
name|http_reply_code
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Received GetDeviceInfo response (M1) "
literal|"from the AP"
argument_list|)
expr_stmt|;
name|info
operator|=
name|xml_get_base64_item
argument_list|(
name|dev_info
argument_list|,
literal|"NewDeviceInfo"
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Could not extract "
literal|"NewDeviceInfo from GetDeviceInfo response"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ap
operator|->
name|m1_handler
argument_list|(
name|ap
argument_list|,
name|info
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|info
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_er_http_get_dev_info_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_client
modifier|*
name|c
parameter_list|,
name|enum
name|http_client_event
name|event
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
init|=
name|ctx
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|reply
decl_stmt|;
name|char
modifier|*
name|dev_info
init|=
name|NULL
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|HTTP_CLIENT_OK
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: GetDeviceInfo OK"
argument_list|)
expr_stmt|;
name|reply
operator|=
name|http_client_get_body
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
break|break;
name|dev_info
operator|=
name|os_zalloc
argument_list|(
name|wpabuf_len
argument_list|(
name|reply
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_info
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|dev_info
argument_list|,
name|wpabuf_head
argument_list|(
name|reply
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|reply
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTP_CLIENT_FAILED
case|:
case|case
name|HTTP_CLIENT_INVALID_REPLY
case|:
case|case
name|HTTP_CLIENT_TIMEOUT
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: GetDeviceInfo failed"
argument_list|)
expr_stmt|;
break|break;
block|}
name|http_client_free
argument_list|(
name|ap
operator|->
name|http
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|dev_info
condition|)
block|{
name|wps_er_ap_learn
argument_list|(
name|ap
argument_list|,
name|dev_info
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|dev_info
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wps_er_send_get_device_info
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|void
function_decl|(
modifier|*
name|m1_handler
function_decl|)
parameter_list|(
name|struct
name|wps_er_ap
modifier|*
name|ap
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|m1
parameter_list|)
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|len_ptr
decl_stmt|,
modifier|*
name|body_ptr
decl_stmt|;
name|struct
name|sockaddr_in
name|dst
decl_stmt|;
name|char
modifier|*
name|url
decl_stmt|,
modifier|*
name|path
decl_stmt|;
if|if
condition|(
name|ap
operator|->
name|http
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Pending HTTP operation ongoing "
literal|"with the AP - cannot get device info"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ap
operator|->
name|control_url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: No controlURL for AP"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|url
operator|=
name|http_client_url_parse
argument_list|(
name|ap
operator|->
name|control_url
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Failed to parse controlURL"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|buf
operator|=
name|wps_er_soap_hdr
argument_list|(
name|NULL
argument_list|,
literal|"GetDeviceInfo"
argument_list|,
name|NULL
argument_list|,
name|path
argument_list|,
operator|&
name|dst
argument_list|,
operator|&
name|len_ptr
argument_list|,
operator|&
name|body_ptr
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wps_er_soap_end
argument_list|(
name|buf
argument_list|,
literal|"GetDeviceInfo"
argument_list|,
name|len_ptr
argument_list|,
name|body_ptr
argument_list|)
expr_stmt|;
name|ap
operator|->
name|http
operator|=
name|http_client_addr
argument_list|(
operator|&
name|dst
argument_list|,
name|buf
argument_list|,
literal|10000
argument_list|,
name|wps_er_http_get_dev_info_cb
argument_list|,
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|http
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ap
operator|->
name|m1_handler
operator|=
name|m1_handler
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wps_er_learn
parameter_list|(
name|struct
name|wps_er
modifier|*
name|er
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pin
parameter_list|,
name|size_t
name|pin_len
parameter_list|)
block|{
name|struct
name|wps_er_ap
modifier|*
name|ap
decl_stmt|;
if|if
condition|(
name|er
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ap
operator|=
name|wps_er_ap_get
argument_list|(
name|er
argument_list|,
name|NULL
argument_list|,
name|uuid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: AP not found for learn "
literal|"request"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ap
operator|->
name|wps
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Pending operation ongoing "
literal|"with the AP - cannot start learn"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wps_er_send_get_device_info
argument_list|(
name|ap
argument_list|,
name|wps_er_ap_learn_m1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
comment|/* TODO: add PIN without SetSelectedRegistrar trigger to all APs */
name|wps_registrar_add_pin
argument_list|(
name|er
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|uuid
argument_list|,
name|pin
argument_list|,
name|pin_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


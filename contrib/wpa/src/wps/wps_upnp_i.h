begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * UPnP for WPS / internal definitions  * Copyright (c) 2000-2003 Intel Corporation  * Copyright (c) 2006-2007 Sony Corporation  * Copyright (c) 2008-2009 Atheros Communications  * Copyright (c) 2009, Jouni Malinen<j@w1.fi>  *  * See wps_upnp.c for more details on licensing and code history.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|WPS_UPNP_I_H
end_ifndef

begin_define
define|#
directive|define
name|WPS_UPNP_I_H
end_define

begin_include
include|#
directive|include
file|"utils/list.h"
end_include

begin_include
include|#
directive|include
file|"http.h"
end_include

begin_define
define|#
directive|define
name|UPNP_MULTICAST_ADDRESS
value|"239.255.255.250"
end_define

begin_comment
comment|/* for UPnP multicasting */
end_comment

begin_define
define|#
directive|define
name|UPNP_MULTICAST_PORT
value|1900
end_define

begin_comment
comment|/* UDP port to monitor for UPnP */
end_comment

begin_comment
comment|/* min subscribe time per UPnP standard */
end_comment

begin_define
define|#
directive|define
name|UPNP_SUBSCRIBE_SEC_MIN
value|1800
end_define

begin_comment
comment|/* subscribe time we use */
end_comment

begin_define
define|#
directive|define
name|UPNP_SUBSCRIBE_SEC
value|(UPNP_SUBSCRIBE_SEC_MIN + 1)
end_define

begin_comment
comment|/* "filenames" used in URLs that we service via our "web server": */
end_comment

begin_define
define|#
directive|define
name|UPNP_WPS_DEVICE_XML_FILE
value|"wps_device.xml"
end_define

begin_define
define|#
directive|define
name|UPNP_WPS_SCPD_XML_FILE
value|"wps_scpd.xml"
end_define

begin_define
define|#
directive|define
name|UPNP_WPS_DEVICE_CONTROL_FILE
value|"wps_control"
end_define

begin_define
define|#
directive|define
name|UPNP_WPS_DEVICE_EVENT_FILE
value|"wps_event"
end_define

begin_define
define|#
directive|define
name|MULTICAST_MAX_READ
value|1600
end_define

begin_comment
comment|/* max bytes we'll read for UPD request */
end_comment

begin_struct_decl
struct_decl|struct
name|upnp_wps_device_sm
struct_decl|;
end_struct_decl

begin_struct_decl
struct_decl|struct
name|wps_registrar
struct_decl|;
end_struct_decl

begin_enum
enum|enum
name|advertisement_type_enum
block|{
name|ADVERTISE_UP
init|=
literal|0
block|,
name|ADVERTISE_DOWN
init|=
literal|1
block|,
name|MSEARCH_REPLY
init|=
literal|2
block|}
enum|;
end_enum

begin_comment
comment|/*  * Advertisements are broadcast via UDP NOTIFYs, and are also the essence of  * the reply to UDP M-SEARCH requests. This struct handles both cases.  *  * A state machine is needed because a number of variant forms must be sent in  * separate packets and spread out in time to avoid congestion.  */
end_comment

begin_struct
struct|struct
name|advertisement_state_machine
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|enum
name|advertisement_type_enum
name|type
decl_stmt|;
name|int
name|state
decl_stmt|;
name|int
name|nerrors
decl_stmt|;
name|struct
name|sockaddr_in
name|client
decl_stmt|;
comment|/* for M-SEARCH replies */
block|}
struct|;
end_struct

begin_comment
comment|/*  * An address of a subscriber (who may have multiple addresses). We are  * supposed to send (via TCP) updates to each subscriber, trying each address  * for a subscriber until we find one that seems to work.  */
end_comment

begin_struct
struct|struct
name|subscr_addr
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|char
modifier|*
name|domain_and_port
decl_stmt|;
comment|/* domain and port part of url */
name|char
modifier|*
name|path
decl_stmt|;
comment|/* "filepath" part of url (from "mem") */
name|struct
name|sockaddr_in
name|saddr
decl_stmt|;
comment|/* address for doing connect */
name|unsigned
name|num_failures
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Subscribers to our events are recorded in this struct. This includes a max  * of one outgoing connection (sending an "event message") per subscriber. We  * also have to age out subscribers unless they renew.  */
end_comment

begin_struct
struct|struct
name|subscription
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
decl_stmt|;
comment|/* parent */
name|time_t
name|timeout_time
decl_stmt|;
comment|/* when to age out the subscription */
name|unsigned
name|next_subscriber_sequence
decl_stmt|;
comment|/* number our messages */
comment|/* 	 * This uuid identifies the subscription and is randomly generated by 	 * us and given to the subscriber when the subscription is accepted; 	 * and is then included with each event sent to the subscriber. 	 */
name|u8
name|uuid
index|[
name|UUID_LEN
index|]
decl_stmt|;
comment|/* Linked list of address alternatives (rotate through on failure) */
name|struct
name|dl_list
name|addr_list
decl_stmt|;
name|struct
name|dl_list
name|event_queue
decl_stmt|;
comment|/* Queued event messages. */
name|struct
name|wps_event_
modifier|*
name|current_event
decl_stmt|;
comment|/* non-NULL if being sent (not in q) 					   */
name|int
name|last_event_failed
decl_stmt|;
comment|/* Whether delivery of last event failed */
comment|/* Information from SetSelectedRegistrar action */
name|u8
name|selected_registrar
decl_stmt|;
name|u16
name|dev_password_id
decl_stmt|;
name|u16
name|config_methods
decl_stmt|;
name|u8
name|authorized_macs
index|[
name|WPS_MAX_AUTHORIZED_MACS
index|]
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|wps_registrar
modifier|*
name|reg
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|upnp_wps_device_interface
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|struct
name|upnp_wps_device_ctx
modifier|*
name|ctx
decl_stmt|;
comment|/* callback table */
name|struct
name|wps_context
modifier|*
name|wps
decl_stmt|;
name|void
modifier|*
name|priv
decl_stmt|;
comment|/* FIX: maintain separate structures for each UPnP peer */
name|struct
name|upnp_wps_peer
name|peer
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/*  * Our instance data corresponding to the AP device. Note that there may be  * multiple wireless interfaces sharing the same UPnP device instance. Each  * such interface is stored in the list of struct upnp_wps_device_interface  * instances.  *  * This is known as an opaque struct declaration to users of the WPS UPnP code.  */
end_comment

begin_struct
struct|struct
name|upnp_wps_device_sm
block|{
name|struct
name|dl_list
name|interfaces
decl_stmt|;
comment|/* struct upnp_wps_device_interface */
name|char
modifier|*
name|root_dir
decl_stmt|;
name|char
modifier|*
name|desc_url
decl_stmt|;
name|int
name|started
decl_stmt|;
comment|/* nonzero if we are active */
name|u8
name|mac_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
comment|/* mac addr of network i.f. we use */
name|char
modifier|*
name|ip_addr_text
decl_stmt|;
comment|/* IP address of network i.f. we use */
name|unsigned
name|ip_addr
decl_stmt|;
comment|/* IP address of network i.f. we use (host order) */
name|int
name|multicast_sd
decl_stmt|;
comment|/* send multicast messages over this socket */
name|int
name|ssdp_sd
decl_stmt|;
comment|/* receive discovery UPD packets on socket */
name|int
name|ssdp_sd_registered
decl_stmt|;
comment|/* nonzero if we must unregister */
name|unsigned
name|advertise_count
decl_stmt|;
comment|/* how many advertisements done */
name|struct
name|advertisement_state_machine
name|advertisement
decl_stmt|;
name|struct
name|dl_list
name|msearch_replies
decl_stmt|;
name|int
name|web_port
decl_stmt|;
comment|/* our port that others get xml files from */
name|struct
name|http_server
modifier|*
name|web_srv
decl_stmt|;
comment|/* Note: subscriptions are kept in expiry order */
name|struct
name|dl_list
name|subscriptions
decl_stmt|;
name|int
name|event_send_all_queued
decl_stmt|;
comment|/* if we are scheduled to send events soon 				    */
name|char
modifier|*
name|wlanevent
decl_stmt|;
comment|/* the last WLANEvent data */
name|enum
name|upnp_wps_wlanevent_type
name|wlanevent_type
decl_stmt|;
name|os_time_t
name|last_event_sec
decl_stmt|;
name|unsigned
name|int
name|num_events_in_sec
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* wps_upnp.c */
end_comment

begin_function_decl
name|void
name|format_date
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|subscription
modifier|*
name|subscription_start
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|char
modifier|*
name|callback_urls
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|subscription
modifier|*
name|subscription_renew
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
name|uuid
index|[
name|UUID_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|subscription_destroy
parameter_list|(
name|struct
name|subscription
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|subscription
modifier|*
name|subscription_find
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
name|uuid
index|[
name|UUID_LEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|subscr_addr_delete
parameter_list|(
name|struct
name|subscr_addr
modifier|*
name|a
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|send_wpabuf
parameter_list|(
name|int
name|fd
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|get_netif_info
parameter_list|(
specifier|const
name|char
modifier|*
name|net_if
parameter_list|,
name|unsigned
modifier|*
name|ip_addr
parameter_list|,
name|char
modifier|*
modifier|*
name|ip_addr_text
parameter_list|,
name|u8
name|mac
index|[
name|ETH_ALEN
index|]
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* wps_upnp_ssdp.c */
end_comment

begin_function_decl
name|void
name|msearchreply_state_machine_stop
parameter_list|(
name|struct
name|advertisement_state_machine
modifier|*
name|a
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|advertisement_state_machine_start
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|advertisement_state_machine_stop
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|int
name|send_byebye
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|ssdp_listener_stop
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|ssdp_listener_start
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|ssdp_listener_open
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|add_ssdp_network
parameter_list|(
specifier|const
name|char
modifier|*
name|net_if
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|ssdp_open_multicast_sock
parameter_list|(
name|u32
name|ip_addr
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|int
name|ssdp_open_multicast
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* wps_upnp_web.c */
end_comment

begin_function_decl
name|int
name|web_listener_start
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|web_listener_stop
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* wps_upnp_event.c */
end_comment

begin_function_decl
name|int
name|event_add
parameter_list|(
name|struct
name|subscription
modifier|*
name|s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|data
parameter_list|,
name|int
name|probereq
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|event_delete_all
parameter_list|(
name|struct
name|subscription
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|event_send_all_later
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|event_send_stop_all
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* wps_upnp_ap.c */
end_comment

begin_function_decl
name|int
name|upnp_er_set_selected_registrar
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|subscription
modifier|*
name|s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|upnp_er_remove_notification
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|subscription
modifier|*
name|s
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* WPS_UPNP_I_H */
end_comment

end_unit


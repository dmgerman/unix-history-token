begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Protected Setup - Registrar  * Copyright (c) 2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"sha256.h"
end_include

begin_include
include|#
directive|include
file|"base64.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"wps_i.h"
end_include

begin_include
include|#
directive|include
file|"wps_dev_attr.h"
end_include

begin_include
include|#
directive|include
file|"wps_upnp.h"
end_include

begin_define
define|#
directive|define
name|WPS_WORKAROUNDS
end_define

begin_struct
struct|struct
name|wps_uuid_pin
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|next
decl_stmt|;
name|u8
name|uuid
index|[
name|WPS_UUID_LEN
index|]
decl_stmt|;
name|int
name|wildcard_uuid
decl_stmt|;
name|u8
modifier|*
name|pin
decl_stmt|;
name|size_t
name|pin_len
decl_stmt|;
define|#
directive|define
name|PIN_LOCKED
value|BIT(0)
define|#
directive|define
name|PIN_EXPIRES
value|BIT(1)
name|int
name|flags
decl_stmt|;
name|struct
name|os_time
name|expiration
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|wps_free_pin
parameter_list|(
name|struct
name|wps_uuid_pin
modifier|*
name|pin
parameter_list|)
block|{
name|os_free
argument_list|(
name|pin
operator|->
name|pin
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pin
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_free_pins
parameter_list|(
name|struct
name|wps_uuid_pin
modifier|*
name|pins
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|pin
operator|=
name|pins
expr_stmt|;
while|while
condition|(
name|pin
condition|)
block|{
name|prev
operator|=
name|pin
expr_stmt|;
name|pin
operator|=
name|pin
operator|->
name|next
expr_stmt|;
name|wps_free_pin
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|wps_pbc_session
block|{
name|struct
name|wps_pbc_session
modifier|*
name|next
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|uuid_e
index|[
name|WPS_UUID_LEN
index|]
decl_stmt|;
name|struct
name|os_time
name|timestamp
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|wps_free_pbc_sessions
parameter_list|(
name|struct
name|wps_pbc_session
modifier|*
name|pbc
parameter_list|)
block|{
name|struct
name|wps_pbc_session
modifier|*
name|prev
decl_stmt|;
while|while
condition|(
name|pbc
condition|)
block|{
name|prev
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|wps_registrar
block|{
name|struct
name|wps_context
modifier|*
name|wps
decl_stmt|;
name|int
name|pbc
decl_stmt|;
name|int
name|selected_registrar
decl_stmt|;
name|int
function_decl|(
modifier|*
name|new_psk_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|set_ie_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|beacon_ie
parameter_list|,
name|size_t
name|beacon_ie_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|probe_resp_ie
parameter_list|,
name|size_t
name|probe_resp_ie_len
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|pin_needed_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|reg_success_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|)
function_decl|;
name|void
modifier|*
name|cb_ctx
decl_stmt|;
name|struct
name|wps_uuid_pin
modifier|*
name|pins
decl_stmt|;
name|struct
name|wps_pbc_session
modifier|*
name|pbc_sessions
decl_stmt|;
name|int
name|skip_cred_build
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|extra_cred
decl_stmt|;
name|int
name|disable_auto_conf
decl_stmt|;
name|int
name|sel_reg_dev_password_id_override
decl_stmt|;
name|int
name|sel_reg_config_methods_override
decl_stmt|;
name|int
name|static_wep_only
decl_stmt|;
name|int
name|force_pbc_overlap
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|wps_set_ie
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wps_registrar_pbc_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wps_registrar_set_selected_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|wps_registrar_add_pbc_session
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|)
block|{
name|struct
name|wps_pbc_session
modifier|*
name|pbc
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|pbc
operator|=
name|reg
operator|->
name|pbc_sessions
expr_stmt|;
while|while
condition|(
name|pbc
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|pbc
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|pbc
operator|->
name|uuid_e
argument_list|,
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
else|else
name|reg
operator|->
name|pbc_sessions
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pbc
condition|)
block|{
name|pbc
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pbc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pbc
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|pbc
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|uuid_e
condition|)
name|os_memcpy
argument_list|(
name|pbc
operator|->
name|uuid_e
argument_list|,
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
block|}
name|pbc
operator|->
name|next
operator|=
name|reg
operator|->
name|pbc_sessions
expr_stmt|;
name|reg
operator|->
name|pbc_sessions
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|->
name|timestamp
operator|=
name|now
expr_stmt|;
comment|/* remove entries that have timed out */
name|prev
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
while|while
condition|(
name|pbc
condition|)
block|{
if|if
condition|(
name|now
operator|.
name|sec
operator|>
name|pbc
operator|->
name|timestamp
operator|.
name|sec
operator|+
name|WPS_PBC_WALK_TIME
condition|)
block|{
name|prev
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|wps_free_pbc_sessions
argument_list|(
name|pbc
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_remove_pbc_session
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|)
block|{
name|struct
name|wps_pbc_session
modifier|*
name|pbc
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
name|pbc
operator|=
name|reg
operator|->
name|pbc_sessions
expr_stmt|;
while|while
condition|(
name|pbc
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|pbc
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|pbc
operator|->
name|uuid_e
argument_list|,
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
else|else
name|reg
operator|->
name|pbc_sessions
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|pbc
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wps_registrar_pbc_overlap
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|struct
name|wps_pbc_session
modifier|*
name|pbc
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
for|for
control|(
name|pbc
operator|=
name|reg
operator|->
name|pbc_sessions
init|;
name|pbc
condition|;
name|pbc
operator|=
name|pbc
operator|->
name|next
control|)
block|{
if|if
condition|(
name|now
operator|.
name|sec
operator|>
name|pbc
operator|->
name|timestamp
operator|.
name|sec
operator|+
name|WPS_PBC_WALK_TIME
condition|)
break|break;
if|if
condition|(
name|addr
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|addr
argument_list|,
name|pbc
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|||
name|uuid_e
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|uuid_e
argument_list|,
name|pbc
operator|->
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
condition|)
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|addr
operator|||
name|uuid_e
condition|)
name|count
operator|++
expr_stmt|;
return|return
name|count
operator|>
literal|1
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_wps_state
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Wi-Fi Protected Setup State (%d)"
argument_list|,
name|wps
operator|->
name|wps_state
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_WPS_STATE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|wps_state
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
end_ifdef

begin_function
specifier|static
name|void
name|wps_registrar_free_pending_m2
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|upnp_pending_message
modifier|*
name|p
decl_stmt|,
modifier|*
name|p2
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
name|p
operator|=
name|wps
operator|->
name|upnp_msgs
expr_stmt|;
while|while
condition|(
name|p
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|type
operator|==
name|WPS_M2
operator|||
name|p
operator|->
name|type
operator|==
name|WPS_M2D
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
name|wps
operator|->
name|upnp_msgs
operator|=
name|p
operator|->
name|next
expr_stmt|;
else|else
name|prev
operator|->
name|next
operator|=
name|p
operator|->
name|next
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Drop pending M2/M2D"
argument_list|)
expr_stmt|;
name|p2
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|next
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2
operator|->
name|msg
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|p2
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|prev
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_UPNP */
end_comment

begin_function
specifier|static
name|int
name|wps_build_ap_setup_locked
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|wps
operator|->
name|ap_setup_locked
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * AP Setup Locked"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_AP_SETUP_LOCKED
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_selected_registrar
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
operator|!
name|reg
operator|->
name|selected_registrar
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Selected Registrar"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_SELECTED_REGISTRAR
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_sel_reg_dev_password_id
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u16
name|id
init|=
name|reg
operator|->
name|pbc
condition|?
name|DEV_PW_PUSHBUTTON
else|:
name|DEV_PW_DEFAULT
decl_stmt|;
if|if
condition|(
operator|!
name|reg
operator|->
name|selected_registrar
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|>=
literal|0
condition|)
name|id
operator|=
name|reg
operator|->
name|sel_reg_dev_password_id_override
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Device Password ID (%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_DEV_PASSWORD_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_sel_reg_config_methods
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u16
name|methods
decl_stmt|;
if|if
condition|(
operator|!
name|reg
operator|->
name|selected_registrar
condition|)
return|return
literal|0
return|;
name|methods
operator|=
name|reg
operator|->
name|wps
operator|->
name|config_methods
operator|&
operator|~
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|pbc
condition|)
name|methods
operator||=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|sel_reg_config_methods_override
operator|>=
literal|0
condition|)
name|methods
operator|=
name|reg
operator|->
name|sel_reg_config_methods_override
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Selected Registrar Config Methods (%x)"
argument_list|,
name|methods
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_SELECTED_REGISTRAR_CONFIG_METHODS
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|methods
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_probe_config_methods
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u16
name|methods
decl_stmt|;
name|methods
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Config Methods (%x)"
argument_list|,
name|methods
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_CONFIG_METHODS
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|methods
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_config_methods_r
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u16
name|methods
decl_stmt|;
name|methods
operator|=
name|reg
operator|->
name|wps
operator|->
name|config_methods
operator|&
operator|~
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|pbc
condition|)
name|methods
operator||=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
return|return
name|wps_build_config_methods
argument_list|(
name|msg
argument_list|,
name|methods
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_resp_type
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u8
name|resp
init|=
name|reg
operator|->
name|wps
operator|->
name|ap
condition|?
name|WPS_RESP_AP
else|:
name|WPS_RESP_REGISTRAR
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Response Type (%d)"
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_RESPONSE_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
name|resp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_init - Initialize WPS Registrar data  * @wps: Pointer to longterm WPS context  * @cfg: Registrar configuration  * Returns: Pointer to allocated Registrar data or %NULL on failure  *  * This function is used to initialize WPS Registrar functionality. It can be  * used for a single Registrar run (e.g., when run in a supplicant) or multiple  * runs (e.g., when run as an internal Registrar in an AP). Caller is  * responsible for freeing the returned data with wps_registrar_deinit() when  * Registrar functionality is not needed anymore.  */
end_comment

begin_function
name|struct
name|wps_registrar
modifier|*
name|wps_registrar_init
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wps_registrar_config
modifier|*
name|cfg
parameter_list|)
block|{
name|struct
name|wps_registrar
modifier|*
name|reg
init|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|reg
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|reg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|reg
operator|->
name|wps
operator|=
name|wps
expr_stmt|;
name|reg
operator|->
name|new_psk_cb
operator|=
name|cfg
operator|->
name|new_psk_cb
expr_stmt|;
name|reg
operator|->
name|set_ie_cb
operator|=
name|cfg
operator|->
name|set_ie_cb
expr_stmt|;
name|reg
operator|->
name|pin_needed_cb
operator|=
name|cfg
operator|->
name|pin_needed_cb
expr_stmt|;
name|reg
operator|->
name|reg_success_cb
operator|=
name|cfg
operator|->
name|reg_success_cb
expr_stmt|;
name|reg
operator|->
name|cb_ctx
operator|=
name|cfg
operator|->
name|cb_ctx
expr_stmt|;
name|reg
operator|->
name|skip_cred_build
operator|=
name|cfg
operator|->
name|skip_cred_build
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|extra_cred
condition|)
block|{
name|reg
operator|->
name|extra_cred
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|cfg
operator|->
name|extra_cred
argument_list|,
name|cfg
operator|->
name|extra_cred_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|extra_cred
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|reg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|reg
operator|->
name|disable_auto_conf
operator|=
name|cfg
operator|->
name|disable_auto_conf
expr_stmt|;
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|=
operator|-
literal|1
expr_stmt|;
name|reg
operator|->
name|sel_reg_config_methods_override
operator|=
operator|-
literal|1
expr_stmt|;
name|reg
operator|->
name|static_wep_only
operator|=
name|cfg
operator|->
name|static_wep_only
expr_stmt|;
if|if
condition|(
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
condition|)
block|{
name|wps_registrar_deinit
argument_list|(
name|reg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|reg
return|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_deinit - Deinitialize WPS Registrar data  * @reg: Registrar data from wps_registrar_init()  */
end_comment

begin_function
name|void
name|wps_registrar_deinit
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|==
name|NULL
condition|)
return|return;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_pbc_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wps_free_pins
argument_list|(
name|reg
operator|->
name|pins
argument_list|)
expr_stmt|;
name|wps_free_pbc_sessions
argument_list|(
name|reg
operator|->
name|pbc_sessions
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|reg
operator|->
name|extra_cred
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_add_pin - Configure a new PIN for Registrar  * @reg: Registrar data from wps_registrar_init()  * @uuid: UUID-E or %NULL for wildcard (any UUID)  * @pin: PIN (Device Password)  * @pin_len: Length of pin in octets  * @timeout: Time (in seconds) when the PIN will be invalidated; 0 = no timeout  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|wps_registrar_add_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pin
parameter_list|,
name|size_t
name|pin_len
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|uuid
operator|==
name|NULL
condition|)
name|p
operator|->
name|wildcard_uuid
operator|=
literal|1
expr_stmt|;
else|else
name|os_memcpy
argument_list|(
name|p
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|p
operator|->
name|pin
operator|=
name|os_malloc
argument_list|(
name|pin_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|pin
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|p
operator|->
name|pin
argument_list|,
name|pin
argument_list|,
name|pin_len
argument_list|)
expr_stmt|;
name|p
operator|->
name|pin_len
operator|=
name|pin_len
expr_stmt|;
if|if
condition|(
name|timeout
condition|)
block|{
name|p
operator|->
name|flags
operator||=
name|PIN_EXPIRES
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|p
operator|->
name|expiration
argument_list|)
expr_stmt|;
name|p
operator|->
name|expiration
operator|.
name|sec
operator|+=
name|timeout
expr_stmt|;
block|}
name|p
operator|->
name|next
operator|=
name|reg
operator|->
name|pins
expr_stmt|;
name|reg
operator|->
name|pins
operator|=
name|p
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: A new PIN configured (timeout=%d)"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID"
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN"
argument_list|,
name|pin
argument_list|,
name|pin_len
argument_list|)
expr_stmt|;
name|reg
operator|->
name|selected_registrar
operator|=
literal|1
expr_stmt|;
name|reg
operator|->
name|pbc
operator|=
literal|0
expr_stmt|;
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_expire_pins
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|,
modifier|*
name|prev
decl_stmt|,
modifier|*
name|del
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|pin
operator|=
name|reg
operator|->
name|pins
expr_stmt|;
while|while
condition|(
name|pin
condition|)
block|{
if|if
condition|(
operator|(
name|pin
operator|->
name|flags
operator|&
name|PIN_EXPIRES
operator|)
operator|&&
name|os_time_before
argument_list|(
operator|&
name|pin
operator|->
name|expiration
argument_list|,
operator|&
name|now
argument_list|)
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
name|reg
operator|->
name|pins
operator|=
name|pin
operator|->
name|next
expr_stmt|;
else|else
name|prev
operator|->
name|next
operator|=
name|pin
operator|->
name|next
expr_stmt|;
name|del
operator|=
name|pin
expr_stmt|;
name|pin
operator|=
name|pin
operator|->
name|next
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Expired PIN for UUID"
argument_list|,
name|del
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wps_free_pin
argument_list|(
name|del
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|prev
operator|=
name|pin
expr_stmt|;
name|pin
operator|=
name|pin
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wps_registrar_invalidate_pin - Invalidate a PIN for a specific UUID-E  * @reg: Registrar data from wps_registrar_init()  * @uuid: UUID-E  * Returns: 0 on success, -1 on failure (e.g., PIN not found)  */
end_comment

begin_function
name|int
name|wps_registrar_invalidate_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|pin
operator|=
name|reg
operator|->
name|pins
expr_stmt|;
while|while
condition|(
name|pin
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|pin
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
name|reg
operator|->
name|pins
operator|=
name|pin
operator|->
name|next
expr_stmt|;
else|else
name|prev
operator|->
name|next
operator|=
name|pin
operator|->
name|next
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalidated PIN for UUID"
argument_list|,
name|pin
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wps_free_pin
argument_list|(
name|pin
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|prev
operator|=
name|pin
expr_stmt|;
name|pin
operator|=
name|pin
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|wps_registrar_get_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|,
name|size_t
modifier|*
name|pin_len
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|;
name|wps_registrar_expire_pins
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|pin
operator|=
name|reg
operator|->
name|pins
expr_stmt|;
while|while
condition|(
name|pin
condition|)
block|{
if|if
condition|(
operator|!
name|pin
operator|->
name|wildcard_uuid
operator|&&
name|os_memcmp
argument_list|(
name|pin
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|pin
operator|=
name|pin
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pin
condition|)
block|{
comment|/* Check for wildcard UUIDs since none of the UUID-specific 		 * PINs matched */
name|pin
operator|=
name|reg
operator|->
name|pins
expr_stmt|;
while|while
condition|(
name|pin
condition|)
block|{
if|if
condition|(
name|pin
operator|->
name|wildcard_uuid
operator|==
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Found a wildcard "
literal|"PIN. Assigned it for this UUID-E"
argument_list|)
expr_stmt|;
name|pin
operator|->
name|wildcard_uuid
operator|=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pin
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
break|break;
block|}
name|pin
operator|=
name|pin
operator|->
name|next
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|pin
condition|)
return|return
name|NULL
return|;
comment|/* 	 * Lock the PIN to avoid attacks based on concurrent re-use of the PIN 	 * that could otherwise avoid PIN invalidations. 	 */
if|if
condition|(
name|pin
operator|->
name|flags
operator|&
name|PIN_LOCKED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Selected PIN locked - do not "
literal|"allow concurrent re-use"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|pin_len
operator|=
name|pin
operator|->
name|pin_len
expr_stmt|;
name|pin
operator|->
name|flags
operator||=
name|PIN_LOCKED
expr_stmt|;
return|return
name|pin
operator|->
name|pin
return|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_unlock_pin - Unlock a PIN for a specific UUID-E  * @reg: Registrar data from wps_registrar_init()  * @uuid: UUID-E  * Returns: 0 on success, -1 on failure  *  * PINs are locked to enforce only one concurrent use. This function unlocks a  * PIN to allow it to be used again. If the specified PIN was configured using  * a wildcard UUID, it will be removed instead of allowing multiple uses.  */
end_comment

begin_function
name|int
name|wps_registrar_unlock_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|;
name|pin
operator|=
name|reg
operator|->
name|pins
expr_stmt|;
while|while
condition|(
name|pin
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|pin
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|pin
operator|->
name|wildcard_uuid
operator|==
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalidating used "
literal|"wildcard PIN"
argument_list|)
expr_stmt|;
return|return
name|wps_registrar_invalidate_pin
argument_list|(
name|reg
argument_list|,
name|uuid
argument_list|)
return|;
block|}
name|pin
operator|->
name|flags
operator|&=
operator|~
name|PIN_LOCKED
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pin
operator|=
name|pin
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_stop_pbc
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|reg
operator|->
name|selected_registrar
operator|=
literal|0
expr_stmt|;
name|reg
operator|->
name|pbc
operator|=
literal|0
expr_stmt|;
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_pbc_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wps_registrar
modifier|*
name|reg
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC timed out - disable PBC mode"
argument_list|)
expr_stmt|;
name|wps_pbc_timeout_event
argument_list|(
name|reg
operator|->
name|wps
argument_list|)
expr_stmt|;
name|wps_registrar_stop_pbc
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_button_pushed - Notify Registrar that AP button was pushed  * @reg: Registrar data from wps_registrar_init()  * Returns: 0 on success, -1 on failure  *  * This function is called on an AP when a push button is pushed to activate  * PBC mode. The PBC mode will be stopped after walk time (2 minutes) timeout  * or when a PBC registration is completed.  */
end_comment

begin_function
name|int
name|wps_registrar_button_pushed
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
if|if
condition|(
name|wps_registrar_pbc_overlap
argument_list|(
name|reg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC overlap - do not start PBC "
literal|"mode"
argument_list|)
expr_stmt|;
name|wps_pbc_overlap_event
argument_list|(
name|reg
operator|->
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Button pushed - PBC mode started"
argument_list|)
expr_stmt|;
name|reg
operator|->
name|force_pbc_overlap
operator|=
literal|0
expr_stmt|;
name|reg
operator|->
name|selected_registrar
operator|=
literal|1
expr_stmt|;
name|reg
operator|->
name|pbc
operator|=
literal|1
expr_stmt|;
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_pbc_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wps_registrar_pbc_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_pbc_completed
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC completed - stopping PBC mode"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_pbc_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wps_registrar_stop_pbc
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_pin_completed
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN completed using internal Registrar"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|reg
operator|->
name|selected_registrar
operator|=
literal|0
expr_stmt|;
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_probe_req_rx - Notify Registrar of Probe Request  * @reg: Registrar data from wps_registrar_init()  * @addr: MAC address of the Probe Request sender  * @wps_data: WPS IE contents  *  * This function is called on an AP when a Probe Request with WPS IE is  * received. This is used to track PBC mode use and to detect possible overlap  * situation with other WPS APs.  */
end_comment

begin_function
name|void
name|wps_registrar_probe_req_rx
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|wps_data
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|u16
name|methods
decl_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS: Probe Request with WPS data received"
argument_list|,
name|wps_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|wps_data
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|wps_version_supported
argument_list|(
name|attr
operator|.
name|version
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported ProbeReq WPS IE "
literal|"version 0x%x"
argument_list|,
name|attr
operator|.
name|version
condition|?
operator|*
name|attr
operator|.
name|version
else|:
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|attr
operator|.
name|config_methods
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Config Methods attribute in "
literal|"Probe Request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|methods
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|config_methods
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|methods
operator|&
name|WPS_CONFIG_PUSHBUTTON
operator|)
condition|)
return|return;
comment|/* Not PBC */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Probe Request for PBC received from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|uuid_e
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Probe Request WPS IE: No "
literal|"UUID-E included"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wps_registrar_add_pbc_session
argument_list|(
name|reg
argument_list|,
name|addr
argument_list|,
name|attr
operator|.
name|uuid_e
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_registrar_pbc_overlap
argument_list|(
name|reg
argument_list|,
name|addr
argument_list|,
name|attr
operator|.
name|uuid_e
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC session overlap detected"
argument_list|)
expr_stmt|;
name|reg
operator|->
name|force_pbc_overlap
operator|=
literal|1
expr_stmt|;
name|wps_pbc_overlap_event
argument_list|(
name|reg
operator|->
name|wps
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wps_cb_new_psk
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|->
name|new_psk_cb
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
name|reg
operator|->
name|new_psk_cb
argument_list|(
name|reg
operator|->
name|cb_ctx
argument_list|,
name|mac_addr
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_cb_pin_needed
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|->
name|pin_needed_cb
operator|==
name|NULL
condition|)
return|return;
name|reg
operator|->
name|pin_needed_cb
argument_list|(
name|reg
operator|->
name|cb_ctx
argument_list|,
name|uuid_e
argument_list|,
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_cb_reg_success
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|->
name|reg_success_cb
operator|==
name|NULL
condition|)
return|return;
name|reg
operator|->
name|reg_success_cb
argument_list|(
name|reg
operator|->
name|cb_ctx
argument_list|,
name|mac_addr
argument_list|,
name|uuid_e
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_cb_set_ie
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|beacon_ie
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|probe_resp_ie
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|->
name|set_ie_cb
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
name|reg
operator|->
name|set_ie_cb
argument_list|(
name|reg
operator|->
name|cb_ctx
argument_list|,
name|wpabuf_head
argument_list|(
name|beacon_ie
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|beacon_ie
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|probe_resp_ie
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|probe_resp_ie
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Encapsulate WPS IE data with one (or more, if needed) IE headers */
end_comment

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_ie_encapsulate
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|ie
operator|=
name|wpabuf_alloc
argument_list|(
name|wpabuf_len
argument_list|(
name|data
argument_list|)
operator|+
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|data
argument_list|)
expr_stmt|;
while|while
condition|(
name|end
operator|>
name|pos
condition|)
block|{
name|size_t
name|frag_len
init|=
name|end
operator|-
name|pos
decl_stmt|;
if|if
condition|(
name|frag_len
operator|>
literal|251
condition|)
name|frag_len
operator|=
literal|251
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|ie
argument_list|,
name|WLAN_EID_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|ie
argument_list|,
literal|4
operator|+
name|frag_len
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|ie
argument_list|,
name|WPS_DEV_OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|ie
argument_list|,
name|pos
argument_list|,
name|frag_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|frag_len
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|ie
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_set_ie
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|beacon
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|probe
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Build Beacon and Probe Response IEs"
argument_list|)
expr_stmt|;
name|beacon
operator|=
name|wpabuf_alloc
argument_list|(
literal|300
argument_list|)
expr_stmt|;
if|if
condition|(
name|beacon
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|probe
operator|=
name|wpabuf_alloc
argument_list|(
literal|400
argument_list|)
expr_stmt|;
if|if
condition|(
name|probe
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wps_build_version
argument_list|(
name|beacon
argument_list|)
operator|||
name|wps_build_wps_state
argument_list|(
name|reg
operator|->
name|wps
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_ap_setup_locked
argument_list|(
name|reg
operator|->
name|wps
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_selected_registrar
argument_list|(
name|reg
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_sel_reg_dev_password_id
argument_list|(
name|reg
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_sel_reg_config_methods
argument_list|(
name|reg
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_version
argument_list|(
name|probe
argument_list|)
operator|||
name|wps_build_wps_state
argument_list|(
name|reg
operator|->
name|wps
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_ap_setup_locked
argument_list|(
name|reg
operator|->
name|wps
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_selected_registrar
argument_list|(
name|reg
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_sel_reg_dev_password_id
argument_list|(
name|reg
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_sel_reg_config_methods
argument_list|(
name|reg
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_resp_type
argument_list|(
name|reg
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_uuid_e
argument_list|(
name|probe
argument_list|,
name|reg
operator|->
name|wps
operator|->
name|uuid
argument_list|)
operator|||
name|wps_build_device_attrs
argument_list|(
operator|&
name|reg
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_probe_config_methods
argument_list|(
name|reg
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_rf_bands
argument_list|(
operator|&
name|reg
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|probe
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|probe
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|beacon
operator|=
name|wps_ie_encapsulate
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
name|probe
operator|=
name|wps_ie_encapsulate
argument_list|(
name|probe
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|beacon
operator|||
operator|!
name|probe
condition|)
block|{
name|wpabuf_free
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|probe
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|reg
operator|->
name|static_wep_only
condition|)
block|{
comment|/* 		 * Windows XP and Vista clients can get confused about 		 * EAP-Identity/Request when they probe the network with 		 * EAPOL-Start. In such a case, they may assume the network is 		 * using IEEE 802.1X and prompt user for a certificate while 		 * the correct (non-WPS) behavior would be to ask for the 		 * static WEP key. As a workaround, use Microsoft Provisioning 		 * IE to advertise that legacy 802.1X is not supported. 		 */
specifier|const
name|u8
name|ms_wps
index|[
literal|7
index|]
init|=
block|{
name|WLAN_EID_VENDOR_SPECIFIC
block|,
literal|5
block|,
comment|/* Microsoft Provisioning IE (00:50:f2:5) */
literal|0x00
block|,
literal|0x50
block|,
literal|0xf2
block|,
literal|5
block|,
literal|0x00
comment|/* no legacy 802.1X or MS WPS */
block|}
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Add Microsoft Provisioning IE "
literal|"into Beacon/Probe Response frames"
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|beacon
argument_list|,
name|ms_wps
argument_list|,
sizeof|sizeof
argument_list|(
name|ms_wps
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|probe
argument_list|,
name|ms_wps
argument_list|,
sizeof|sizeof
argument_list|(
name|ms_wps
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|wps_cb_set_ie
argument_list|(
name|reg
argument_list|,
name|beacon
argument_list|,
name|probe
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|probe
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_get_dev_password
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pin
decl_stmt|;
name|size_t
name|pin_len
init|=
literal|0
decl_stmt|;
name|os_free
argument_list|(
name|wps
operator|->
name|dev_password
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev_password
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|pbc
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Use default PIN for PBC"
argument_list|)
expr_stmt|;
name|pin
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
literal|"00000000"
expr_stmt|;
name|pin_len
operator|=
literal|8
expr_stmt|;
block|}
else|else
block|{
name|pin
operator|=
name|wps_registrar_get_pin
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|,
operator|&
name|pin_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pin
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Device Password available for "
literal|"the Enrollee"
argument_list|)
expr_stmt|;
name|wps_cb_pin_needed
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|,
operator|&
name|wps
operator|->
name|peer_dev
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|dev_password
operator|=
name|os_malloc
argument_list|(
name|pin_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dev_password
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev_password
argument_list|,
name|pin
argument_list|,
name|pin_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev_password_len
operator|=
name|pin_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_uuid_r
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * UUID-R"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_UUID_R
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|uuid_r
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_r_hash
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u8
modifier|*
name|hash
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|wps
operator|->
name|snonce
argument_list|,
literal|2
operator|*
name|WPS_SECRET_NONCE_LEN
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-S1"
argument_list|,
name|wps
operator|->
name|snonce
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-S2"
argument_list|,
name|wps
operator|->
name|snonce
operator|+
name|WPS_SECRET_NONCE_LEN
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dh_pubkey_e
operator|==
name|NULL
operator|||
name|wps
operator|->
name|dh_pubkey_r
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: DH public keys not available for "
literal|"R-Hash derivation"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * R-Hash1"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_R_HASH1
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|hash
operator|=
name|wpabuf_put
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
comment|/* R-Hash1 = HMAC_AuthKey(R-S1 || PSK1 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|wps
operator|->
name|snonce
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk1
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|WPS_PSK_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-Hash1"
argument_list|,
name|hash
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * R-Hash2"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_R_HASH2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|hash
operator|=
name|wpabuf_put
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
comment|/* R-Hash2 = HMAC_AuthKey(R-S2 || PSK2 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|wps
operator|->
name|snonce
operator|+
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk2
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-Hash2"
argument_list|,
name|hash
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_r_snonce1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * R-SNonce1"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_R_SNONCE1
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|snonce
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_r_snonce2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * R-SNonce2"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_R_SNONCE2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|snonce
operator|+
name|WPS_SECRET_NONCE_LEN
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_network_idx
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Network Index"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_NETWORK_INDEX
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_ssid
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * SSID"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_SSID
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_auth_type
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Authentication Type (0x%x)"
argument_list|,
name|cred
operator|->
name|auth_type
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_AUTH_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|auth_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_encr_type
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Encryption Type (0x%x)"
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_ENCR_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_network_key
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Network Key"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_NETWORK_KEY
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_mac_addr
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * MAC Address ("
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|cred
operator|->
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_MAC_ADDR
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_credential
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
if|if
condition|(
name|wps_build_cred_network_idx
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
operator|||
name|wps_build_cred_ssid
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
operator|||
name|wps_build_cred_auth_type
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
operator|||
name|wps_build_cred_encr_type
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
operator|||
name|wps_build_cred_network_key
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
operator|||
name|wps_build_cred_mac_addr
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|cred
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|skip_cred_build
condition|)
goto|goto
name|skip_cred_build
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Credential"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|wps
operator|->
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wps
operator|->
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|ssid
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|ssid_len
operator|=
name|wps
operator|->
name|wps
operator|->
name|ssid_len
expr_stmt|;
comment|/* Select the best authentication and encryption type */
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|&
name|WPS_AUTH_WPA2PSK
condition|)
name|wps
operator|->
name|auth_type
operator|=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|&
name|WPS_AUTH_WPAPSK
condition|)
name|wps
operator|->
name|auth_type
operator|=
name|WPS_AUTH_WPAPSK
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|&
name|WPS_AUTH_OPEN
condition|)
name|wps
operator|->
name|auth_type
operator|=
name|WPS_AUTH_OPEN
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|&
name|WPS_AUTH_SHARED
condition|)
name|wps
operator|->
name|auth_type
operator|=
name|WPS_AUTH_SHARED
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported auth_type 0x%x"
argument_list|,
name|wps
operator|->
name|auth_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|cred
operator|.
name|auth_type
operator|=
name|wps
operator|->
name|auth_type
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|==
name|WPS_AUTH_WPA2PSK
operator|||
name|wps
operator|->
name|auth_type
operator|==
name|WPS_AUTH_WPAPSK
condition|)
block|{
if|if
condition|(
name|wps
operator|->
name|encr_type
operator|&
name|WPS_ENCR_AES
condition|)
name|wps
operator|->
name|encr_type
operator|=
name|WPS_ENCR_AES
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|encr_type
operator|&
name|WPS_ENCR_TKIP
condition|)
name|wps
operator|->
name|encr_type
operator|=
name|WPS_ENCR_TKIP
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No suitable encryption "
literal|"type for WPA/WPA2"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|wps
operator|->
name|encr_type
operator|&
name|WPS_ENCR_WEP
condition|)
name|wps
operator|->
name|encr_type
operator|=
name|WPS_ENCR_WEP
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|encr_type
operator|&
name|WPS_ENCR_NONE
condition|)
name|wps
operator|->
name|encr_type
operator|=
name|WPS_ENCR_NONE
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No suitable encryption "
literal|"type for non-WPA/WPA2 mode"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|=
name|wps
operator|->
name|encr_type
expr_stmt|;
comment|/* 	 * Set MAC address in the Credential to be the Enrollee's MAC address 	 */
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|mac_addr
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_state
operator|==
name|WPS_STATE_NOT_CONFIGURED
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
operator|!
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|disable_auto_conf
condition|)
block|{
name|u8
name|r
index|[
literal|16
index|]
decl_stmt|;
comment|/* Generate a random passphrase */
if|if
condition|(
name|os_get_random
argument_list|(
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|os_free
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps
operator|->
name|new_psk
operator|=
name|base64_encode
argument_list|(
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|,
operator|&
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|new_psk
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wps
operator|->
name|new_psk_len
operator|--
expr_stmt|;
comment|/* remove newline */
while|while
condition|(
name|wps
operator|->
name|new_psk_len
operator|&&
name|wps
operator|->
name|new_psk
index|[
name|wps
operator|->
name|new_psk_len
operator|-
literal|1
index|]
operator|==
literal|'='
condition|)
name|wps
operator|->
name|new_psk_len
operator|--
expr_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Generated passphrase"
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|key
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|key_len
operator|=
name|wps
operator|->
name|new_psk_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|network_key
condition|)
block|{
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|key
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|network_key
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|network_key_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|key_len
operator|=
name|wps
operator|->
name|wps
operator|->
name|network_key_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPAPSK
operator||
name|WPS_AUTH_WPA2PSK
operator|)
condition|)
block|{
name|char
name|hex
index|[
literal|65
index|]
decl_stmt|;
comment|/* Generate a random per-device PSK */
name|os_free
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps
operator|->
name|new_psk_len
operator|=
literal|32
expr_stmt|;
name|wps
operator|->
name|new_psk
operator|=
name|os_malloc
argument_list|(
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|new_psk
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|os_get_random
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps
operator|->
name|new_psk
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Generated per-device PSK"
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
name|wpa_snprintf_hex
argument_list|(
name|hex
argument_list|,
sizeof|sizeof
argument_list|(
name|hex
argument_list|)
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|key
argument_list|,
name|hex
argument_list|,
name|wps
operator|->
name|new_psk_len
operator|*
literal|2
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|key_len
operator|=
name|wps
operator|->
name|new_psk_len
operator|*
literal|2
expr_stmt|;
block|}
name|cred
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wps_build_credential
argument_list|(
name|cred
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|cred
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_CRED
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|wpabuf_len
argument_list|(
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|cred
argument_list|)
expr_stmt|;
name|skip_cred_build
label|:
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|extra_cred
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Credential (pre-configured)"
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|extra_cred
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_ap_settings
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * AP Settings"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_build_credential
argument_list|(
name|msg
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Registrar Nonce"
argument_list|,
name|wps
operator|->
name|nonce_r
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID-R"
argument_list|,
name|wps
operator|->
name|uuid_r
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M2"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M2
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_uuid_r
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_public_key
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_derive_keys
argument_list|(
name|wps
argument_list|)
operator|||
name|wps_build_auth_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_encr_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_conn_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_config_methods_r
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_device_attrs
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_rf_bands
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_assoc_state
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_config_error
argument_list|(
name|msg
argument_list|,
name|WPS_CFG_NO_ERROR
argument_list|)
operator|||
name|wps_build_dev_password_id
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|dev_pw_id
argument_list|)
operator|||
name|wps_build_os_version
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wps
operator|->
name|state
operator|=
name|RECV_M3
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m2d
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|u16
name|err
init|=
name|wps
operator|->
name|config_error
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M2D"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap_setup_locked
operator|&&
name|err
operator|==
name|WPS_CFG_NO_ERROR
condition|)
name|err
operator|=
name|WPS_CFG_SETUP_LOCKED
expr_stmt|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M2D
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_uuid_r
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_auth_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_encr_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_conn_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_config_methods_r
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_device_attrs
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_rf_bands
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_assoc_state
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_config_error
argument_list|(
name|msg
argument_list|,
name|err
argument_list|)
operator|||
name|wps_build_os_version
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wps
operator|->
name|state
operator|=
name|RECV_M2D_ACK
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m4
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|,
modifier|*
name|plain
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M4"
argument_list|)
expr_stmt|;
name|wps_derive_psk
argument_list|(
name|wps
argument_list|,
name|wps
operator|->
name|dev_password
argument_list|,
name|wps
operator|->
name|dev_password_len
argument_list|)
expr_stmt|;
name|plain
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M4
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_r_hash
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_r_snonce1
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_encr_settings
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|RECV_M5
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m6
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|,
modifier|*
name|plain
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M6"
argument_list|)
expr_stmt|;
name|plain
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M6
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_r_snonce2
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_encr_settings
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps_pin_revealed
operator|=
literal|1
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|RECV_M7
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m8
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|,
modifier|*
name|plain
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M8"
argument_list|)
expr_stmt|;
name|plain
operator|=
name|wpabuf_alloc
argument_list|(
literal|500
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M8
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
operator|(
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
name|wps_build_cred
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
name|wps_build_ap_settings
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|)
operator|||
name|wps_build_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_encr_settings
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|RECV_DONE
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_wsc_ack
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message WSC_ACK"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_WSC_ACK
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_wsc_nack
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message WSC_NACK"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_WSC_NACK
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_config_error
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|config_error
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_registrar_get_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|enum
name|wsc_op_code
modifier|*
name|op_code
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
condition|)
block|{
name|struct
name|upnp_pending_message
modifier|*
name|p
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|ext_reg
operator|>
literal|1
condition|)
name|wps_registrar_free_pending_m2
argument_list|(
name|wps
operator|->
name|wps
argument_list|)
expr_stmt|;
name|p
operator|=
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
expr_stmt|;
comment|/* TODO: check pending message MAC address */
while|while
condition|(
name|p
operator|&&
name|p
operator|->
name|next
condition|)
block|{
name|prev
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|p
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Use pending message from "
literal|"UPnP"
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
else|else
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
operator|=
name|NULL
expr_stmt|;
name|msg
operator|=
name|p
operator|->
name|msg
expr_stmt|;
switch|switch
condition|(
name|p
operator|->
name|type
condition|)
block|{
case|case
name|WPS_WSC_ACK
case|:
operator|*
name|op_code
operator|=
name|WSC_ACK
expr_stmt|;
break|break;
case|case
name|WPS_WSC_NACK
case|:
operator|*
name|op_code
operator|=
name|WSC_NACK
expr_stmt|;
break|break;
default|default:
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
block|}
name|os_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|ext_reg
operator|==
literal|0
condition|)
name|wps
operator|->
name|ext_reg
operator|=
literal|1
expr_stmt|;
return|return
name|msg
return|;
block|}
block|}
if|if
condition|(
name|wps
operator|->
name|ext_reg
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Using external Registrar, but no "
literal|"pending message available"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
switch|switch
condition|(
name|wps
operator|->
name|state
condition|)
block|{
case|case
name|SEND_M2
case|:
if|if
condition|(
name|wps_get_dev_password
argument_list|(
name|wps
argument_list|)
operator|<
literal|0
condition|)
name|msg
operator|=
name|wps_build_m2d
argument_list|(
name|wps
argument_list|)
expr_stmt|;
else|else
name|msg
operator|=
name|wps_build_m2
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M2D
case|:
name|msg
operator|=
name|wps_build_m2d
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M4
case|:
name|msg
operator|=
name|wps_build_m4
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M6
case|:
name|msg
operator|=
name|wps_build_m6
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M8
case|:
name|msg
operator|=
name|wps_build_m8
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|RECV_DONE
case|:
name|msg
operator|=
name|wps_build_wsc_ack
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_ACK
expr_stmt|;
break|break;
case|case
name|SEND_WSC_NACK
case|:
name|msg
operator|=
name|wps_build_wsc_nack
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_NACK
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported state %d for building "
literal|"a message"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|op_code
operator|==
name|WSC_MSG
operator|&&
name|msg
condition|)
block|{
comment|/* Save a copy of the last message for Authenticator derivation 		 */
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|last_msg
argument_list|)
expr_stmt|;
name|wps
operator|->
name|last_msg
operator|=
name|wpabuf_dup
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_enrollee_nonce
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_nonce
parameter_list|)
block|{
if|if
condition|(
name|e_nonce
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Enrollee Nonce received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|e_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Nonce"
argument_list|,
name|wps
operator|->
name|nonce_e
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_registrar_nonce
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|r_nonce
parameter_list|)
block|{
if|if
condition|(
name|r_nonce
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Registrar Nonce received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|r_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Registrar Nonce received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_uuid_e
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|)
block|{
if|if
condition|(
name|uuid_e
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No UUID-E received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|uuid_e
argument_list|,
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID-E"
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_dev_password_id
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|pw_id
parameter_list|)
block|{
if|if
condition|(
name|pw_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Device Password ID received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|dev_pw_id
operator|=
name|WPA_GET_BE16
argument_list|(
name|pw_id
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Device Password ID %d"
argument_list|,
name|wps
operator|->
name|dev_pw_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_e_hash1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_hash1
parameter_list|)
block|{
if|if
condition|(
name|e_hash1
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No E-Hash1 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|peer_hash1
argument_list|,
name|e_hash1
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-Hash1"
argument_list|,
name|wps
operator|->
name|peer_hash1
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_e_hash2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_hash2
parameter_list|)
block|{
if|if
condition|(
name|e_hash2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No E-Hash2 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|peer_hash2
argument_list|,
name|e_hash2
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-Hash2"
argument_list|,
name|wps
operator|->
name|peer_hash2
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_e_snonce1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_snonce1
parameter_list|)
block|{
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|e_snonce1
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No E-SNonce1 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-SNonce1"
argument_list|,
name|e_snonce1
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
comment|/* E-Hash1 = HMAC_AuthKey(E-S1 || PSK1 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|e_snonce1
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk1
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|WPS_PSK_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|wps
operator|->
name|peer_hash1
argument_list|,
name|hash
argument_list|,
name|WPS_HASH_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-Hash1 derived from E-S1 does "
literal|"not match with the pre-committed value"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_DEV_PASSWORD_AUTH_FAILURE
expr_stmt|;
name|wps_pwd_auth_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee proved knowledge of the first "
literal|"half of the device password"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_e_snonce2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_snonce2
parameter_list|)
block|{
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|e_snonce2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No E-SNonce2 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-SNonce2"
argument_list|,
name|e_snonce2
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
comment|/* E-Hash2 = HMAC_AuthKey(E-S2 || PSK2 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|e_snonce2
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk2
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|WPS_PSK_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|wps
operator|->
name|peer_hash2
argument_list|,
name|hash
argument_list|,
name|WPS_HASH_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-Hash2 derived from E-S2 does "
literal|"not match with the pre-committed value"
argument_list|)
expr_stmt|;
name|wps_registrar_invalidate_pin
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_DEV_PASSWORD_AUTH_FAILURE
expr_stmt|;
name|wps_pwd_auth_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee proved knowledge of the second "
literal|"half of the device password"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps_pin_revealed
operator|=
literal|0
expr_stmt|;
name|wps_registrar_unlock_pin
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_mac_addr
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|)
block|{
if|if
condition|(
name|mac_addr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No MAC Address received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee MAC Address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|peer_dev
operator|.
name|mac_addr
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_pubkey
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|pk
parameter_list|,
name|size_t
name|pk_len
parameter_list|)
block|{
if|if
condition|(
name|pk
operator|==
name|NULL
operator|||
name|pk_len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Public Key received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dh_pubkey_e
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pk
argument_list|,
name|pk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dh_pubkey_e
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_auth_type_flags
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|auth
parameter_list|)
block|{
name|u16
name|auth_types
decl_stmt|;
if|if
condition|(
name|auth
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Authentication Type flags "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|auth_types
operator|=
name|WPA_GET_BE16
argument_list|(
name|auth
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Authentication Type flags 0x%x"
argument_list|,
name|auth_types
argument_list|)
expr_stmt|;
name|wps
operator|->
name|auth_type
operator|=
name|wps
operator|->
name|wps
operator|->
name|auth_types
operator|&
name|auth_types
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No match in supported "
literal|"authentication types (own 0x%x Enrollee 0x%x)"
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|auth_types
argument_list|,
name|auth_types
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
comment|/* 		 * Some deployed implementations seem to advertise incorrect 		 * information in this attribute. For example, Linksys WRT350N 		 * seems to have a byteorder bug that breaks this negotiation. 		 * In order to interoperate with existing implementations, 		 * assume that the Enrollee supports everything we do. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Workaround - assume Enrollee "
literal|"does not advertise supported authentication types "
literal|"correctly"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|auth_type
operator|=
name|wps
operator|->
name|wps
operator|->
name|auth_types
expr_stmt|;
else|#
directive|else
comment|/* WPS_WORKAROUNDS */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_encr_type_flags
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|encr
parameter_list|)
block|{
name|u16
name|encr_types
decl_stmt|;
if|if
condition|(
name|encr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Encryption Type flags "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|encr_types
operator|=
name|WPA_GET_BE16
argument_list|(
name|encr
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Encryption Type flags 0x%x"
argument_list|,
name|encr_types
argument_list|)
expr_stmt|;
name|wps
operator|->
name|encr_type
operator|=
name|wps
operator|->
name|wps
operator|->
name|encr_types
operator|&
name|encr_types
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|encr_type
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No match in supported "
literal|"encryption types (own 0x%x Enrollee 0x%x)"
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|encr_types
argument_list|,
name|encr_types
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
comment|/* 		 * Some deployed implementations seem to advertise incorrect 		 * information in this attribute. For example, Linksys WRT350N 		 * seems to have a byteorder bug that breaks this negotiation. 		 * In order to interoperate with existing implementations, 		 * assume that the Enrollee supports everything we do. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Workaround - assume Enrollee "
literal|"does not advertise supported encryption types "
literal|"correctly"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|encr_type
operator|=
name|wps
operator|->
name|wps
operator|->
name|encr_types
expr_stmt|;
else|#
directive|else
comment|/* WPS_WORKAROUNDS */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_conn_type_flags
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Connection Type flags "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Connection Type flags 0x%x"
argument_list|,
operator|*
name|conn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_config_methods
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|methods
parameter_list|)
block|{
name|u16
name|m
decl_stmt|;
if|if
condition|(
name|methods
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Config Methods received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|m
operator|=
name|WPA_GET_BE16
argument_list|(
name|methods
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Config Methods 0x%x"
argument_list|,
name|m
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_wps_state
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|state
parameter_list|)
block|{
if|if
condition|(
name|state
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Wi-Fi Protected Setup State "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Wi-Fi Protected Setup State %d"
argument_list|,
operator|*
name|state
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_assoc_state
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|assoc
parameter_list|)
block|{
name|u16
name|a
decl_stmt|;
if|if
condition|(
name|assoc
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Association State received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|a
operator|=
name|WPA_GET_BE16
argument_list|(
name|assoc
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Association State %d"
argument_list|,
name|a
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_config_error
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|err
parameter_list|)
block|{
name|u16
name|e
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Configuration Error received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|e
operator|=
name|WPA_GET_BE16
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Configuration Error %d"
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M1"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M1"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|wps_process_uuid_e
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|uuid_e
argument_list|)
operator|||
name|wps_process_mac_addr
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|mac_addr
argument_list|)
operator|||
name|wps_process_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|enrollee_nonce
argument_list|)
operator|||
name|wps_process_pubkey
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|public_key
argument_list|,
name|attr
operator|->
name|public_key_len
argument_list|)
operator|||
name|wps_process_auth_type_flags
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|auth_type_flags
argument_list|)
operator|||
name|wps_process_encr_type_flags
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|encr_type_flags
argument_list|)
operator|||
name|wps_process_conn_type_flags
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|conn_type_flags
argument_list|)
operator|||
name|wps_process_config_methods
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|config_methods
argument_list|)
operator|||
name|wps_process_wps_state
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|wps_state
argument_list|)
operator|||
name|wps_process_device_attrs
argument_list|(
operator|&
name|wps
operator|->
name|peer_dev
argument_list|,
name|attr
argument_list|)
operator|||
name|wps_process_rf_bands
argument_list|(
operator|&
name|wps
operator|->
name|peer_dev
argument_list|,
name|attr
operator|->
name|rf_bands
argument_list|)
operator|||
name|wps_process_assoc_state
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|assoc_state
argument_list|)
operator|||
name|wps_process_dev_password_id
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|dev_password_id
argument_list|)
operator|||
name|wps_process_config_error
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|config_error
argument_list|)
operator|||
name|wps_process_os_version
argument_list|(
operator|&
name|wps
operator|->
name|peer_dev
argument_list|,
name|attr
operator|->
name|os_version
argument_list|)
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_DEFAULT
operator|&&
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_USER_SPECIFIED
operator|&&
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_MACHINE_SPECIFIED
operator|&&
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_REGISTRAR_SPECIFIED
operator|&&
operator|(
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_PUSHBUTTON
operator|||
operator|!
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|pbc
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported Device Password ID %d"
argument_list|,
name|wps
operator|->
name|dev_pw_id
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M2D
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|dev_pw_id
operator|==
name|DEV_PW_PUSHBUTTON
condition|)
block|{
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_pbc_overlap
operator|||
name|wps_registrar_pbc_overlap
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC overlap - deny PBC "
literal|"negotiation"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M2D
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_MULTIPLE_PBC_DETECTED
expr_stmt|;
name|wps_pbc_overlap_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_pbc_overlap
operator|=
literal|1
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wps_registrar_add_pbc_session
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
name|wps
operator|->
name|pbc
operator|=
literal|1
expr_stmt|;
block|}
name|wps
operator|->
name|state
operator|=
name|SEND_M2
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m3
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M3"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M3"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|pbc
operator|&&
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_pbc_overlap
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reject negotiation due to PBC "
literal|"session overlap"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_MULTIPLE_PBC_DETECTED
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|registrar_nonce
argument_list|)
operator|||
name|wps_process_authenticator
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|authenticator
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_process_e_hash1
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|e_hash1
argument_list|)
operator|||
name|wps_process_e_hash2
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|e_hash2
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wps
operator|->
name|state
operator|=
name|SEND_M4
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m5
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|decrypted
decl_stmt|;
name|struct
name|wps_parse_attr
name|eattr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M5"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M5"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|pbc
operator|&&
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_pbc_overlap
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reject negotiation due to PBC "
literal|"session overlap"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_MULTIPLE_PBC_DETECTED
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|registrar_nonce
argument_list|)
operator|||
name|wps_process_authenticator
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|authenticator
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|decrypted
operator|=
name|wps_decrypt_encr_settings
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|encr_settings
argument_list|,
name|attr
operator|->
name|encr_settings_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to decrypted Encrypted "
literal|"Settings attribute"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing decrypted Encrypted Settings "
literal|"attribute"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|decrypted
argument_list|,
operator|&
name|eattr
argument_list|)
operator|<
literal|0
operator|||
name|wps_process_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|decrypted
argument_list|,
name|eattr
operator|.
name|key_wrap_auth
argument_list|)
operator|||
name|wps_process_e_snonce1
argument_list|(
name|wps
argument_list|,
name|eattr
operator|.
name|e_snonce1
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M6
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_sta_cred_cb
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
comment|/* 	 * Update credential to only include a single authentication and 	 * encryption type in case the AP configuration includes more than one 	 * option. 	 */
if|if
condition|(
name|wps
operator|->
name|cred
operator|.
name|auth_type
operator|&
name|WPS_AUTH_WPA2PSK
condition|)
name|wps
operator|->
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|cred
operator|.
name|auth_type
operator|&
name|WPS_AUTH_WPAPSK
condition|)
name|wps
operator|->
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPAPSK
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|&
name|WPS_ENCR_AES
condition|)
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_AES
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|&
name|WPS_ENCR_TKIP
condition|)
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_TKIP
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Update local configuration based on the "
literal|"AP configuration"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|cred_cb
condition|)
name|wps
operator|->
name|wps
operator|->
name|cred_cb
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_ap_settings_r
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
condition|)
return|return
literal|0
return|;
comment|/* AP Settings Attributes in M7 when Enrollee is an AP */
if|if
condition|(
name|wps_process_ap_settings
argument_list|(
name|attr
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Received old AP configuration from AP"
argument_list|)
expr_stmt|;
if|#
directive|if
literal|0
comment|/* 	 * TODO: Provide access to AP settings and allow changes before sending 	 * out M8. For now, just copy the settings unchanged into M8. 	 */
block|return 0;
else|#
directive|else
comment|/* 	 * For now, use the AP PIN only to receive the current AP settings, 	 * not to reconfigure the AP. 	 */
name|wps_sta_cred_cb
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m7
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|decrypted
decl_stmt|;
name|struct
name|wps_parse_attr
name|eattr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M7"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M7
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M7"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|pbc
operator|&&
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_pbc_overlap
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reject negotiation due to PBC "
literal|"session overlap"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_MULTIPLE_PBC_DETECTED
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|registrar_nonce
argument_list|)
operator|||
name|wps_process_authenticator
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|authenticator
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|decrypted
operator|=
name|wps_decrypt_encr_settings
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|encr_settings
argument_list|,
name|attr
operator|->
name|encr_settings_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to decrypted Encrypted "
literal|"Settings attribute"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing decrypted Encrypted Settings "
literal|"attribute"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|decrypted
argument_list|,
operator|&
name|eattr
argument_list|)
operator|<
literal|0
operator|||
name|wps_process_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|decrypted
argument_list|,
name|eattr
operator|.
name|key_wrap_auth
argument_list|)
operator|||
name|wps_process_e_snonce2
argument_list|(
name|wps
argument_list|,
name|eattr
operator|.
name|e_snonce2
argument_list|)
operator|||
name|wps_process_ap_settings_r
argument_list|(
name|wps
argument_list|,
operator|&
name|eattr
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M8
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|enum
name|wps_process_res
name|ret
init|=
name|WPS_CONTINUE
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_MSG"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
operator|!
name|wps_version_supported
argument_list|(
name|attr
operator|.
name|version
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported message version 0x%x"
argument_list|,
name|attr
operator|.
name|version
condition|?
operator|*
name|attr
operator|.
name|version
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_M1
operator|&&
operator|(
name|attr
operator|.
name|registrar_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
operator|!=
literal|0
argument_list|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in registrar nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
switch|switch
condition|(
operator|*
name|attr
operator|.
name|msg_type
condition|)
block|{
case|case
name|WPS_M1
case|:
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|attr
operator|.
name|mac_addr
condition|)
block|{
comment|/* Remove old pending messages when starting new run */
name|wps_free_pending_msgs
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
operator|=
name|NULL
expr_stmt|;
name|upnp_wps_device_send_wlan_event
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
argument_list|,
name|attr
operator|.
name|mac_addr
argument_list|,
name|UPNP_WPS_WLANEVENT_TYPE_EAP
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|ret
operator|=
name|wps_process_m1
argument_list|(
name|wps
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_M3
case|:
name|ret
operator|=
name|wps_process_m3
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
operator|||
name|wps
operator|->
name|state
operator|==
name|SEND_WSC_NACK
condition|)
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M3
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_M5
case|:
name|ret
operator|=
name|wps_process_m5
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
operator|||
name|wps
operator|->
name|state
operator|==
name|SEND_WSC_NACK
condition|)
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M5
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_M7
case|:
name|ret
operator|=
name|wps_process_m7
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
operator|||
name|wps
operator|->
name|state
operator|==
name|SEND_WSC_NACK
condition|)
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M7
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|ret
operator|==
name|WPS_CONTINUE
condition|)
block|{
comment|/* Save a copy of the last message for Authenticator derivation 		 */
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|last_msg
argument_list|)
expr_stmt|;
name|wps
operator|->
name|last_msg
operator|=
name|wpabuf_dup
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_ack
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_ACK"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
operator|!
name|wps_version_supported
argument_list|(
name|attr
operator|.
name|version
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported message version 0x%x"
argument_list|,
name|attr
operator|.
name|version
condition|?
operator|*
name|attr
operator|.
name|version
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_WSC_ACK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|wps
operator|->
name|ext_reg
operator|&&
name|wps
operator|->
name|state
operator|==
name|RECV_M2D_ACK
operator|&&
name|upnp_wps_subscribers
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
argument_list|)
condition|)
block|{
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
condition|)
return|return
name|WPS_CONTINUE
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Wait for response from an "
literal|"external Registrar"
argument_list|)
expr_stmt|;
return|return
name|WPS_PENDING
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
if|if
condition|(
name|attr
operator|.
name|registrar_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in registrar nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|enrollee_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|attr
operator|.
name|enrollee_nonce
argument_list|,
name|WPS_NONCE_LEN
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in enrollee nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|state
operator|==
name|RECV_M2D_ACK
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|upnp_wps_subscribers
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
argument_list|)
condition|)
block|{
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
condition|)
return|return
name|WPS_CONTINUE
return|;
if|if
condition|(
name|wps
operator|->
name|ext_reg
operator|==
literal|0
condition|)
name|wps
operator|->
name|ext_reg
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Wait for response from an "
literal|"external Registrar"
argument_list|)
expr_stmt|;
return|return
name|WPS_PENDING
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No more registrars available - "
literal|"terminate negotiation"
argument_list|)
expr_stmt|;
block|}
return|return
name|WPS_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_nack
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|int
name|old_state
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_NACK"
argument_list|)
expr_stmt|;
name|old_state
operator|=
name|wps
operator|->
name|state
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
operator|!
name|wps_version_supported
argument_list|(
name|attr
operator|.
name|version
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported message version 0x%x"
argument_list|,
name|attr
operator|.
name|version
condition|?
operator|*
name|attr
operator|.
name|version
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_WSC_NACK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|wps
operator|->
name|ext_reg
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Negotiation using external "
literal|"Registrar terminated by the Enrollee"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
if|if
condition|(
name|attr
operator|.
name|registrar_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in registrar nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|enrollee_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|attr
operator|.
name|enrollee_nonce
argument_list|,
name|WPS_NONCE_LEN
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in enrollee nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|config_error
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Configuration Error attribute "
literal|"in WSC_NACK"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee terminated negotiation with "
literal|"Configuration Error %d"
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|config_error
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|old_state
condition|)
block|{
case|case
name|RECV_M3
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M2
argument_list|)
expr_stmt|;
break|break;
case|case
name|RECV_M5
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M4
argument_list|)
expr_stmt|;
break|break;
case|case
name|RECV_M7
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M6
argument_list|)
expr_stmt|;
break|break;
case|case
name|RECV_DONE
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M8
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|WPS_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_done
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_Done"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_DONE
operator|&&
operator|(
operator|!
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|||
operator|!
name|wps
operator|->
name|ext_reg
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving WSC_Done"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
operator|!
name|wps_version_supported
argument_list|(
name|attr
operator|.
name|version
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported message version 0x%x"
argument_list|,
name|attr
operator|.
name|version
condition|?
operator|*
name|attr
operator|.
name|version
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_WSC_DONE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|wps
operator|->
name|ext_reg
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Negotiation using external "
literal|"Registrar completed successfully"
argument_list|)
expr_stmt|;
return|return
name|WPS_DONE
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
if|if
condition|(
name|attr
operator|.
name|registrar_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in registrar nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|enrollee_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|attr
operator|.
name|enrollee_nonce
argument_list|,
name|WPS_NONCE_LEN
operator|!=
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in enrollee nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Negotiation completed successfully"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_state
operator|==
name|WPS_STATE_NOT_CONFIGURED
operator|&&
name|wps
operator|->
name|new_psk
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
operator|!
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|disable_auto_conf
condition|)
block|{
name|struct
name|wps_credential
name|cred
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Moving to Configured state based "
literal|"on first Enrollee connection"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|cred
operator|.
name|ssid
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|cred
operator|.
name|ssid_len
operator|=
name|wps
operator|->
name|wps
operator|->
name|ssid_len
expr_stmt|;
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPAPSK
operator||
name|WPS_AUTH_WPA2PSK
expr_stmt|;
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_TKIP
operator||
name|WPS_ENCR_AES
expr_stmt|;
name|os_memcpy
argument_list|(
name|cred
operator|.
name|key
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
name|cred
operator|.
name|key_len
operator|=
name|wps
operator|->
name|new_psk_len
expr_stmt|;
name|wps
operator|->
name|wps
operator|->
name|wps_state
operator|=
name|WPS_STATE_CONFIGURED
expr_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Generated random passphrase"
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|cred_cb
condition|)
name|wps
operator|->
name|wps
operator|->
name|cred_cb
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|,
operator|&
name|cred
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps
operator|->
name|new_psk
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wps
operator|->
name|wps
operator|->
name|ap
condition|)
name|wps_sta_cred_cb
argument_list|(
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|new_psk
condition|)
block|{
if|if
condition|(
name|wps_cb_new_psk
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to configure the "
literal|"new PSK"
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps
operator|->
name|new_psk
operator|=
name|NULL
expr_stmt|;
block|}
name|wps_cb_reg_success
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|pbc
condition|)
block|{
name|wps_registrar_remove_pbc_session
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
name|wps_registrar_pbc_completed
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wps_registrar_pin_completed
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
block|}
name|wps_success_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|)
expr_stmt|;
return|return
name|WPS_DONE
return|;
block|}
end_function

begin_function
name|enum
name|wps_process_res
name|wps_registrar_process_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|enum
name|wsc_op_code
name|op_code
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|enum
name|wps_process_res
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing received message (len=%lu "
literal|"op_code=%d)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
argument_list|,
name|op_code
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|op_code
operator|==
name|WSC_MSG
operator|&&
name|wps
operator|->
name|ext_reg
operator|==
literal|1
condition|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|==
literal|0
operator|&&
name|attr
operator|.
name|msg_type
operator|&&
operator|*
name|attr
operator|.
name|msg_type
operator|==
name|WPS_M3
condition|)
name|wps
operator|->
name|ext_reg
operator|=
literal|2
expr_stmt|;
comment|/* past M2/M2D phase */
block|}
if|if
condition|(
name|wps
operator|->
name|ext_reg
operator|>
literal|1
condition|)
name|wps_registrar_free_pending_m2
argument_list|(
name|wps
operator|->
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|wps
operator|->
name|ext_reg
operator|&&
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
operator|==
name|NULL
operator|&&
operator|(
name|op_code
operator|==
name|WSC_MSG
operator|||
name|op_code
operator|==
name|WSC_Done
operator|||
name|op_code
operator|==
name|WSC_NACK
operator|)
condition|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|int
name|type
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
operator|||
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
name|type
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|type
operator|=
operator|*
name|attr
operator|.
name|msg_type
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Sending received message (type %d)"
literal|" to external Registrar for processing"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|upnp_wps_device_send_wlan_event
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|UPNP_WPS_WLANEVENT_TYPE_EAP
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_code
operator|==
name|WSC_MSG
condition|)
return|return
name|WPS_PENDING
return|;
block|}
elseif|else
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|wps
operator|->
name|ext_reg
operator|&&
name|op_code
operator|==
name|WSC_MSG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Skip internal processing - using "
literal|"external Registrar"
argument_list|)
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
switch|switch
condition|(
name|op_code
condition|)
block|{
case|case
name|WSC_MSG
case|:
return|return
name|wps_process_wsc_msg
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
return|;
case|case
name|WSC_ACK
case|:
return|return
name|wps_process_wsc_ack
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
return|;
case|case
name|WSC_NACK
case|:
return|return
name|wps_process_wsc_nack
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
return|;
case|case
name|WSC_Done
case|:
name|ret
operator|=
name|wps_process_wsc_done
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_WSC_DONE
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported op_code %d"
argument_list|,
name|op_code
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
block|}
end_function

begin_function
name|int
name|wps_registrar_update_ie
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
return|return
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_set_selected_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wps_registrar
modifier|*
name|reg
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: SetSelectedRegistrar timed out - "
literal|"unselect Registrar"
argument_list|)
expr_stmt|;
name|reg
operator|->
name|selected_registrar
operator|=
literal|0
expr_stmt|;
name|reg
operator|->
name|pbc
operator|=
literal|0
expr_stmt|;
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|=
operator|-
literal|1
expr_stmt|;
name|reg
operator|->
name|sel_reg_config_methods_override
operator|=
operator|-
literal|1
expr_stmt|;
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_set_selected_registrar - Notification of SetSelectedRegistrar  * @reg: Registrar data from wps_registrar_init()  * @msg: Received message from SetSelectedRegistrar  * Returns: 0 on success, -1 on failure  *  * This function is called when an AP receives a SetSelectedRegistrar UPnP  * message.  */
end_comment

begin_function
name|int
name|wps_registrar_set_selected_registrar
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS: SetSelectedRegistrar attributes"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|wps_version_supported
argument_list|(
name|attr
operator|.
name|version
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported SetSelectedRegistrar "
literal|"version 0x%x"
argument_list|,
name|attr
operator|.
name|version
condition|?
operator|*
name|attr
operator|.
name|version
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|selected_registrar
operator|==
name|NULL
operator|||
operator|*
name|attr
operator|.
name|selected_registrar
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: SetSelectedRegistrar: Disable "
literal|"Selected Registrar"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wps_registrar_set_selected_timeout
argument_list|(
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|reg
operator|->
name|selected_registrar
operator|=
literal|1
expr_stmt|;
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|=
name|attr
operator|.
name|dev_password_id
condition|?
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|dev_password_id
argument_list|)
else|:
name|DEV_PW_DEFAULT
expr_stmt|;
name|reg
operator|->
name|sel_reg_config_methods_override
operator|=
name|attr
operator|.
name|sel_reg_config_methods
condition|?
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|sel_reg_config_methods
argument_list|)
else|:
operator|-
literal|1
expr_stmt|;
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


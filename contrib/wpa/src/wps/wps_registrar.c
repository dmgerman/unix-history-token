begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Protected Setup - Registrar  * Copyright (c) 2008-2013, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/base64.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"utils/uuid.h"
end_include

begin_include
include|#
directive|include
file|"utils/list.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"wps_i.h"
end_include

begin_include
include|#
directive|include
file|"wps_dev_attr.h"
end_include

begin_include
include|#
directive|include
file|"wps_upnp.h"
end_include

begin_include
include|#
directive|include
file|"wps_upnp_i.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_WPS_STRICT
end_ifndef

begin_define
define|#
directive|define
name|WPS_WORKAROUNDS
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_STRICT */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
end_ifdef

begin_struct
struct|struct
name|wps_nfc_pw_token
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|u8
name|pubkey_hash
index|[
name|WPS_OOB_PUBKEY_HASH_LEN
index|]
decl_stmt|;
name|unsigned
name|int
name|peer_pk_hash_known
range|:
literal|1
decl_stmt|;
name|u16
name|pw_id
decl_stmt|;
name|u8
name|dev_pw
index|[
name|WPS_OOB_DEVICE_PASSWORD_LEN
operator|*
literal|2
operator|+
literal|1
index|]
decl_stmt|;
name|size_t
name|dev_pw_len
decl_stmt|;
name|int
name|pk_hash_provided_oob
decl_stmt|;
comment|/* whether own PK hash was provided OOB */
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|wps_remove_nfc_pw_token
parameter_list|(
name|struct
name|wps_nfc_pw_token
modifier|*
name|token
parameter_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|token
operator|->
name|list
argument_list|)
expr_stmt|;
name|bin_clear_free
argument_list|(
name|token
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|token
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_free_nfc_pw_tokens
parameter_list|(
name|struct
name|dl_list
modifier|*
name|tokens
parameter_list|,
name|u16
name|pw_id
parameter_list|)
block|{
name|struct
name|wps_nfc_pw_token
modifier|*
name|token
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|token
argument_list|,
argument|prev
argument_list|,
argument|tokens
argument_list|,
argument|struct wps_nfc_pw_token
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|pw_id
operator|==
literal|0
operator|||
name|pw_id
operator|==
name|token
operator|->
name|pw_id
condition|)
name|wps_remove_nfc_pw_token
argument_list|(
name|token
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|wps_nfc_pw_token
modifier|*
name|wps_get_nfc_pw_token
parameter_list|(
name|struct
name|dl_list
modifier|*
name|tokens
parameter_list|,
name|u16
name|pw_id
parameter_list|)
block|{
name|struct
name|wps_nfc_pw_token
modifier|*
name|token
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|token
argument_list|,
argument|tokens
argument_list|,
argument|struct wps_nfc_pw_token
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|pw_id
operator|==
name|token
operator|->
name|pw_id
condition|)
return|return
name|token
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CONFIG_WPS_NFC */
end_comment

begin_define
define|#
directive|define
name|wps_free_nfc_pw_tokens
parameter_list|(
name|t
parameter_list|,
name|p
parameter_list|)
value|do { } while (0)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_NFC */
end_comment

begin_struct
struct|struct
name|wps_uuid_pin
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|u8
name|uuid
index|[
name|WPS_UUID_LEN
index|]
decl_stmt|;
name|int
name|wildcard_uuid
decl_stmt|;
name|u8
modifier|*
name|pin
decl_stmt|;
name|size_t
name|pin_len
decl_stmt|;
define|#
directive|define
name|PIN_LOCKED
value|BIT(0)
define|#
directive|define
name|PIN_EXPIRES
value|BIT(1)
name|int
name|flags
decl_stmt|;
name|struct
name|os_reltime
name|expiration
decl_stmt|;
name|u8
name|enrollee_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|wps_free_pin
parameter_list|(
name|struct
name|wps_uuid_pin
modifier|*
name|pin
parameter_list|)
block|{
name|bin_clear_free
argument_list|(
name|pin
operator|->
name|pin
argument_list|,
name|pin
operator|->
name|pin_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pin
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_remove_pin
parameter_list|(
name|struct
name|wps_uuid_pin
modifier|*
name|pin
parameter_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|pin
operator|->
name|list
argument_list|)
expr_stmt|;
name|wps_free_pin
argument_list|(
name|pin
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_free_pins
parameter_list|(
name|struct
name|dl_list
modifier|*
name|pins
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|pin
argument_list|,
argument|prev
argument_list|,
argument|pins
argument_list|,
argument|struct wps_uuid_pin
argument_list|,
argument|list
argument_list|)
name|wps_remove_pin
argument_list|(
name|pin
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|wps_pbc_session
block|{
name|struct
name|wps_pbc_session
modifier|*
name|next
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|uuid_e
index|[
name|WPS_UUID_LEN
index|]
decl_stmt|;
name|struct
name|os_reltime
name|timestamp
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|wps_free_pbc_sessions
parameter_list|(
name|struct
name|wps_pbc_session
modifier|*
name|pbc
parameter_list|)
block|{
name|struct
name|wps_pbc_session
modifier|*
name|prev
decl_stmt|;
while|while
condition|(
name|pbc
condition|)
block|{
name|prev
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|wps_registrar_device
block|{
name|struct
name|wps_registrar_device
modifier|*
name|next
decl_stmt|;
name|struct
name|wps_device_data
name|dev
decl_stmt|;
name|u8
name|uuid
index|[
name|WPS_UUID_LEN
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|wps_registrar
block|{
name|struct
name|wps_context
modifier|*
name|wps
decl_stmt|;
name|int
name|pbc
decl_stmt|;
name|int
name|selected_registrar
decl_stmt|;
name|int
function_decl|(
modifier|*
name|new_psk_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|)
function_decl|;
name|int
function_decl|(
modifier|*
name|set_ie_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|beacon_ie
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|probe_resp_ie
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|pin_needed_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|reg_success_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_pw
parameter_list|,
name|size_t
name|dev_pw_len
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|set_sel_reg_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|sel_reg
parameter_list|,
name|u16
name|dev_passwd_id
parameter_list|,
name|u16
name|sel_reg_config_methods
parameter_list|)
function_decl|;
name|void
function_decl|(
modifier|*
name|enrollee_seen_cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|u8
modifier|*
name|pri_dev_type
parameter_list|,
name|u16
name|config_methods
parameter_list|,
name|u16
name|dev_password_id
parameter_list|,
name|u8
name|request_type
parameter_list|,
specifier|const
name|char
modifier|*
name|dev_name
parameter_list|)
function_decl|;
name|void
modifier|*
name|cb_ctx
decl_stmt|;
name|struct
name|dl_list
name|pins
decl_stmt|;
name|struct
name|dl_list
name|nfc_pw_tokens
decl_stmt|;
name|struct
name|wps_pbc_session
modifier|*
name|pbc_sessions
decl_stmt|;
name|int
name|skip_cred_build
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|extra_cred
decl_stmt|;
name|int
name|disable_auto_conf
decl_stmt|;
name|int
name|sel_reg_union
decl_stmt|;
name|int
name|sel_reg_dev_password_id_override
decl_stmt|;
name|int
name|sel_reg_config_methods_override
decl_stmt|;
name|int
name|static_wep_only
decl_stmt|;
name|int
name|dualband
decl_stmt|;
name|int
name|force_per_enrollee_psk
decl_stmt|;
name|struct
name|wps_registrar_device
modifier|*
name|devices
decl_stmt|;
name|int
name|force_pbc_overlap
decl_stmt|;
name|u8
name|authorized_macs
index|[
name|WPS_MAX_AUTHORIZED_MACS
index|]
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|authorized_macs_union
index|[
name|WPS_MAX_AUTHORIZED_MACS
index|]
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|p2p_dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|pbc_ignore_uuid
index|[
name|WPS_UUID_LEN
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
name|struct
name|os_reltime
name|pbc_ignore_start
decl_stmt|;
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|int
name|wps_set_ie
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wps_registrar_pbc_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wps_registrar_set_selected_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wps_registrar_remove_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wps_uuid_pin
modifier|*
name|pin
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|wps_registrar_add_authorized_mac
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Add authorized MAC "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|WPS_MAX_AUTHORIZED_MACS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|os_memcmp
argument_list|(
name|reg
operator|->
name|authorized_macs
index|[
name|i
index|]
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authorized MAC was "
literal|"already in the list"
argument_list|)
expr_stmt|;
return|return;
comment|/* already in list */
block|}
for|for
control|(
name|i
operator|=
name|WPS_MAX_AUTHORIZED_MACS
operator|-
literal|1
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
name|os_memcpy
argument_list|(
name|reg
operator|->
name|authorized_macs
index|[
name|i
index|]
argument_list|,
name|reg
operator|->
name|authorized_macs
index|[
name|i
operator|-
literal|1
index|]
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|reg
operator|->
name|authorized_macs
index|[
literal|0
index|]
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authorized MACs"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|reg
operator|->
name|authorized_macs
argument_list|,
sizeof|sizeof
argument_list|(
name|reg
operator|->
name|authorized_macs
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_remove_authorized_mac
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Remove authorized MAC "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|WPS_MAX_AUTHORIZED_MACS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|reg
operator|->
name|authorized_macs
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|WPS_MAX_AUTHORIZED_MACS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authorized MAC was not in the "
literal|"list"
argument_list|)
expr_stmt|;
return|return;
comment|/* not in the list */
block|}
for|for
control|(
init|;
name|i
operator|+
literal|1
operator|<
name|WPS_MAX_AUTHORIZED_MACS
condition|;
name|i
operator|++
control|)
name|os_memcpy
argument_list|(
name|reg
operator|->
name|authorized_macs
index|[
name|i
index|]
argument_list|,
name|reg
operator|->
name|authorized_macs
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|reg
operator|->
name|authorized_macs
index|[
name|WPS_MAX_AUTHORIZED_MACS
operator|-
literal|1
index|]
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authorized MACs"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|reg
operator|->
name|authorized_macs
argument_list|,
sizeof|sizeof
argument_list|(
name|reg
operator|->
name|authorized_macs
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_free_devices
parameter_list|(
name|struct
name|wps_registrar_device
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|wps_registrar_device
modifier|*
name|prev
decl_stmt|;
while|while
condition|(
name|dev
condition|)
block|{
name|prev
operator|=
name|dev
expr_stmt|;
name|dev
operator|=
name|dev
operator|->
name|next
expr_stmt|;
name|wps_device_data_free
argument_list|(
operator|&
name|prev
operator|->
name|dev
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|wps_registrar_device
modifier|*
name|wps_device_get
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wps_registrar_device
modifier|*
name|dev
decl_stmt|;
for|for
control|(
name|dev
operator|=
name|reg
operator|->
name|devices
init|;
name|dev
condition|;
name|dev
operator|=
name|dev
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|dev
operator|->
name|dev
operator|.
name|mac_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|dev
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_device_clone_data
parameter_list|(
name|struct
name|wps_device_data
modifier|*
name|dst
parameter_list|,
name|struct
name|wps_device_data
modifier|*
name|src
parameter_list|)
block|{
name|os_memcpy
argument_list|(
name|dst
operator|->
name|mac_addr
argument_list|,
name|src
operator|->
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|dst
operator|->
name|pri_dev_type
argument_list|,
name|src
operator|->
name|pri_dev_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
define|#
directive|define
name|WPS_STRDUP
parameter_list|(
name|n
parameter_list|)
define|\
value|os_free(dst->n); \ 	dst->n = src->n ? os_strdup(src->n) : NULL
name|WPS_STRDUP
argument_list|(
name|device_name
argument_list|)
expr_stmt|;
name|WPS_STRDUP
argument_list|(
name|manufacturer
argument_list|)
expr_stmt|;
name|WPS_STRDUP
argument_list|(
name|model_name
argument_list|)
expr_stmt|;
name|WPS_STRDUP
argument_list|(
name|model_number
argument_list|)
expr_stmt|;
name|WPS_STRDUP
argument_list|(
name|serial_number
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|WPS_STRDUP
block|}
end_function

begin_function
name|int
name|wps_device_store
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|)
block|{
name|struct
name|wps_registrar_device
modifier|*
name|d
decl_stmt|;
name|d
operator|=
name|wps_device_get
argument_list|(
name|reg
argument_list|,
name|dev
operator|->
name|mac_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|==
name|NULL
condition|)
block|{
name|d
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|d
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|d
operator|->
name|next
operator|=
name|reg
operator|->
name|devices
expr_stmt|;
name|reg
operator|->
name|devices
operator|=
name|d
expr_stmt|;
block|}
name|wps_device_clone_data
argument_list|(
operator|&
name|d
operator|->
name|dev
argument_list|,
name|dev
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|d
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_add_pbc_session
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|)
block|{
name|struct
name|wps_pbc_session
modifier|*
name|pbc
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
name|struct
name|os_reltime
name|now
decl_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|pbc
operator|=
name|reg
operator|->
name|pbc_sessions
expr_stmt|;
while|while
condition|(
name|pbc
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|pbc
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|pbc
operator|->
name|uuid_e
argument_list|,
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
else|else
name|reg
operator|->
name|pbc_sessions
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pbc
condition|)
block|{
name|pbc
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pbc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pbc
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|pbc
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|uuid_e
condition|)
name|os_memcpy
argument_list|(
name|pbc
operator|->
name|uuid_e
argument_list|,
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
block|}
name|pbc
operator|->
name|next
operator|=
name|reg
operator|->
name|pbc_sessions
expr_stmt|;
name|reg
operator|->
name|pbc_sessions
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|->
name|timestamp
operator|=
name|now
expr_stmt|;
comment|/* remove entries that have timed out */
name|prev
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
while|while
condition|(
name|pbc
condition|)
block|{
if|if
condition|(
name|os_reltime_expired
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|pbc
operator|->
name|timestamp
argument_list|,
name|WPS_PBC_WALK_TIME
argument_list|)
condition|)
block|{
name|prev
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|wps_free_pbc_sessions
argument_list|(
name|pbc
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_remove_pbc_session
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
parameter_list|)
block|{
name|struct
name|wps_pbc_session
modifier|*
name|pbc
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|pbc
operator|=
name|reg
operator|->
name|pbc_sessions
expr_stmt|;
while|while
condition|(
name|pbc
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|pbc
operator|->
name|uuid_e
argument_list|,
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
operator|||
operator|(
name|p2p_dev_addr
operator|&&
operator|!
name|is_zero_ether_addr
argument_list|(
name|reg
operator|->
name|p2p_dev_addr
argument_list|)
operator|&&
name|os_memcmp
argument_list|(
name|reg
operator|->
name|p2p_dev_addr
argument_list|,
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
else|else
name|reg
operator|->
name|pbc_sessions
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
name|tmp
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Removing PBC session for "
literal|"addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|tmp
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Removed UUID-E"
argument_list|,
name|tmp
operator|->
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|prev
operator|=
name|pbc
expr_stmt|;
name|pbc
operator|=
name|pbc
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wps_registrar_pbc_overlap
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
name|struct
name|wps_pbc_session
modifier|*
name|pbc
decl_stmt|;
name|struct
name|wps_pbc_session
modifier|*
name|first
init|=
name|NULL
decl_stmt|;
name|struct
name|os_reltime
name|now
decl_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Checking active PBC sessions for overlap"
argument_list|)
expr_stmt|;
if|if
condition|(
name|uuid_e
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Add one for the requested UUID"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Requested UUID"
argument_list|,
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
for|for
control|(
name|pbc
operator|=
name|reg
operator|->
name|pbc_sessions
init|;
name|pbc
condition|;
name|pbc
operator|=
name|pbc
operator|->
name|next
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Consider PBC session with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|pbc
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID-E"
argument_list|,
name|pbc
operator|->
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_reltime_expired
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|pbc
operator|->
name|timestamp
argument_list|,
name|WPS_PBC_WALK_TIME
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC walk time has expired"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|first
operator|&&
name|os_memcmp
argument_list|(
name|pbc
operator|->
name|uuid_e
argument_list|,
name|first
operator|->
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Same Enrollee"
argument_list|)
expr_stmt|;
continue|continue;
comment|/* same Enrollee */
block|}
if|if
condition|(
name|uuid_e
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|uuid_e
argument_list|,
name|pbc
operator|->
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: New Enrollee"
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|first
operator|==
name|NULL
condition|)
name|first
operator|=
name|pbc
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: %u active PBC session(s) found"
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
name|count
operator|>
literal|1
condition|?
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_wps_state
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Wi-Fi Protected Setup State (%d)"
argument_list|,
name|wps
operator|->
name|wps_state
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_WPS_STATE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|wps_state
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
end_ifdef

begin_function
specifier|static
name|void
name|wps_registrar_free_pending_m2
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|upnp_pending_message
modifier|*
name|p
decl_stmt|,
modifier|*
name|p2
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
name|p
operator|=
name|wps
operator|->
name|upnp_msgs
expr_stmt|;
while|while
condition|(
name|p
condition|)
block|{
if|if
condition|(
name|p
operator|->
name|type
operator|==
name|WPS_M2
operator|||
name|p
operator|->
name|type
operator|==
name|WPS_M2D
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
name|wps
operator|->
name|upnp_msgs
operator|=
name|p
operator|->
name|next
expr_stmt|;
else|else
name|prev
operator|->
name|next
operator|=
name|p
operator|->
name|next
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Drop pending M2/M2D"
argument_list|)
expr_stmt|;
name|p2
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|next
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2
operator|->
name|msg
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|p2
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|prev
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_UPNP */
end_comment

begin_function
specifier|static
name|int
name|wps_build_ap_setup_locked
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|wps
operator|->
name|ap_setup_locked
operator|&&
name|wps
operator|->
name|ap_setup_locked
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * AP Setup Locked"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_AP_SETUP_LOCKED
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_selected_registrar
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
operator|!
name|reg
operator|->
name|sel_reg_union
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Selected Registrar"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_SELECTED_REGISTRAR
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_sel_reg_dev_password_id
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u16
name|id
init|=
name|reg
operator|->
name|pbc
condition|?
name|DEV_PW_PUSHBUTTON
else|:
name|DEV_PW_DEFAULT
decl_stmt|;
if|if
condition|(
operator|!
name|reg
operator|->
name|sel_reg_union
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|>=
literal|0
condition|)
name|id
operator|=
name|reg
operator|->
name|sel_reg_dev_password_id_override
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Device Password ID (%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_DEV_PASSWORD_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_sel_pbc_reg_uuid_e
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u16
name|id
init|=
name|reg
operator|->
name|pbc
condition|?
name|DEV_PW_PUSHBUTTON
else|:
name|DEV_PW_DEFAULT
decl_stmt|;
if|if
condition|(
operator|!
name|reg
operator|->
name|sel_reg_union
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|>=
literal|0
condition|)
name|id
operator|=
name|reg
operator|->
name|sel_reg_dev_password_id_override
expr_stmt|;
if|if
condition|(
name|id
operator|!=
name|DEV_PW_PUSHBUTTON
operator|||
operator|!
name|reg
operator|->
name|dualband
condition|)
return|return
literal|0
return|;
return|return
name|wps_build_uuid_e
argument_list|(
name|msg
argument_list|,
name|reg
operator|->
name|wps
operator|->
name|uuid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_set_pushbutton
parameter_list|(
name|u16
modifier|*
name|methods
parameter_list|,
name|u16
name|conf_methods
parameter_list|)
block|{
operator|*
name|methods
operator||=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
if|if
condition|(
operator|(
name|conf_methods
operator|&
name|WPS_CONFIG_VIRT_PUSHBUTTON
operator|)
operator|==
name|WPS_CONFIG_VIRT_PUSHBUTTON
condition|)
operator|*
name|methods
operator||=
name|WPS_CONFIG_VIRT_PUSHBUTTON
expr_stmt|;
if|if
condition|(
operator|(
name|conf_methods
operator|&
name|WPS_CONFIG_PHY_PUSHBUTTON
operator|)
operator|==
name|WPS_CONFIG_PHY_PUSHBUTTON
condition|)
operator|*
name|methods
operator||=
name|WPS_CONFIG_PHY_PUSHBUTTON
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|methods
operator|&
name|WPS_CONFIG_VIRT_PUSHBUTTON
operator|)
operator|!=
name|WPS_CONFIG_VIRT_PUSHBUTTON
operator|&&
operator|(
operator|*
name|methods
operator|&
name|WPS_CONFIG_PHY_PUSHBUTTON
operator|)
operator|!=
name|WPS_CONFIG_PHY_PUSHBUTTON
condition|)
block|{
comment|/* 		 * Required to include virtual/physical flag, but we were not 		 * configured with push button type, so have to default to one 		 * of them. 		 */
operator|*
name|methods
operator||=
name|WPS_CONFIG_PHY_PUSHBUTTON
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_sel_reg_config_methods
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u16
name|methods
decl_stmt|;
if|if
condition|(
operator|!
name|reg
operator|->
name|sel_reg_union
condition|)
return|return
literal|0
return|;
name|methods
operator|=
name|reg
operator|->
name|wps
operator|->
name|config_methods
expr_stmt|;
name|methods
operator|&=
operator|~
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
name|methods
operator|&=
operator|~
operator|(
name|WPS_CONFIG_VIRT_PUSHBUTTON
operator||
name|WPS_CONFIG_PHY_PUSHBUTTON
operator|)
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|pbc
condition|)
name|wps_set_pushbutton
argument_list|(
operator|&
name|methods
argument_list|,
name|reg
operator|->
name|wps
operator|->
name|config_methods
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|sel_reg_config_methods_override
operator|>=
literal|0
condition|)
name|methods
operator|=
name|reg
operator|->
name|sel_reg_config_methods_override
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Selected Registrar Config Methods (%x)"
argument_list|,
name|methods
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_SELECTED_REGISTRAR_CONFIG_METHODS
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|methods
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_probe_config_methods
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u16
name|methods
decl_stmt|;
comment|/* 	 * These are the methods that the AP supports as an Enrollee for adding 	 * external Registrars. 	 */
name|methods
operator|=
name|reg
operator|->
name|wps
operator|->
name|config_methods
operator|&
operator|~
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
name|methods
operator|&=
operator|~
operator|(
name|WPS_CONFIG_VIRT_PUSHBUTTON
operator||
name|WPS_CONFIG_PHY_PUSHBUTTON
operator|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Config Methods (%x)"
argument_list|,
name|methods
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_CONFIG_METHODS
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|methods
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_config_methods_r
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
return|return
name|wps_build_config_methods
argument_list|(
name|msg
argument_list|,
name|reg
operator|->
name|wps
operator|->
name|config_methods
argument_list|)
return|;
block|}
end_function

begin_function
specifier|const
name|u8
modifier|*
name|wps_authorized_macs
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|size_t
modifier|*
name|count
parameter_list|)
block|{
operator|*
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|count
operator|<
name|WPS_MAX_AUTHORIZED_MACS
condition|)
block|{
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|reg
operator|->
name|authorized_macs_union
index|[
operator|*
name|count
index|]
argument_list|)
condition|)
break|break;
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
block|}
return|return
operator|(
specifier|const
name|u8
operator|*
operator|)
name|reg
operator|->
name|authorized_macs_union
return|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_init - Initialize WPS Registrar data  * @wps: Pointer to longterm WPS context  * @cfg: Registrar configuration  * Returns: Pointer to allocated Registrar data or %NULL on failure  *  * This function is used to initialize WPS Registrar functionality. It can be  * used for a single Registrar run (e.g., when run in a supplicant) or multiple  * runs (e.g., when run as an internal Registrar in an AP). Caller is  * responsible for freeing the returned data with wps_registrar_deinit() when  * Registrar functionality is not needed anymore.  */
end_comment

begin_function
name|struct
name|wps_registrar
modifier|*
name|wps_registrar_init
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wps_registrar_config
modifier|*
name|cfg
parameter_list|)
block|{
name|struct
name|wps_registrar
modifier|*
name|reg
init|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|reg
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|reg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|dl_list_init
argument_list|(
operator|&
name|reg
operator|->
name|pins
argument_list|)
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|reg
operator|->
name|nfc_pw_tokens
argument_list|)
expr_stmt|;
name|reg
operator|->
name|wps
operator|=
name|wps
expr_stmt|;
name|reg
operator|->
name|new_psk_cb
operator|=
name|cfg
operator|->
name|new_psk_cb
expr_stmt|;
name|reg
operator|->
name|set_ie_cb
operator|=
name|cfg
operator|->
name|set_ie_cb
expr_stmt|;
name|reg
operator|->
name|pin_needed_cb
operator|=
name|cfg
operator|->
name|pin_needed_cb
expr_stmt|;
name|reg
operator|->
name|reg_success_cb
operator|=
name|cfg
operator|->
name|reg_success_cb
expr_stmt|;
name|reg
operator|->
name|set_sel_reg_cb
operator|=
name|cfg
operator|->
name|set_sel_reg_cb
expr_stmt|;
name|reg
operator|->
name|enrollee_seen_cb
operator|=
name|cfg
operator|->
name|enrollee_seen_cb
expr_stmt|;
name|reg
operator|->
name|cb_ctx
operator|=
name|cfg
operator|->
name|cb_ctx
expr_stmt|;
name|reg
operator|->
name|skip_cred_build
operator|=
name|cfg
operator|->
name|skip_cred_build
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|extra_cred
condition|)
block|{
name|reg
operator|->
name|extra_cred
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|cfg
operator|->
name|extra_cred
argument_list|,
name|cfg
operator|->
name|extra_cred_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|extra_cred
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|reg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|reg
operator|->
name|disable_auto_conf
operator|=
name|cfg
operator|->
name|disable_auto_conf
expr_stmt|;
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|=
operator|-
literal|1
expr_stmt|;
name|reg
operator|->
name|sel_reg_config_methods_override
operator|=
operator|-
literal|1
expr_stmt|;
name|reg
operator|->
name|static_wep_only
operator|=
name|cfg
operator|->
name|static_wep_only
expr_stmt|;
name|reg
operator|->
name|dualband
operator|=
name|cfg
operator|->
name|dualband
expr_stmt|;
name|reg
operator|->
name|force_per_enrollee_psk
operator|=
name|cfg
operator|->
name|force_per_enrollee_psk
expr_stmt|;
if|if
condition|(
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
condition|)
block|{
name|wps_registrar_deinit
argument_list|(
name|reg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|reg
return|;
block|}
end_function

begin_function
name|void
name|wps_registrar_flush
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|==
name|NULL
condition|)
return|return;
name|wps_free_pins
argument_list|(
operator|&
name|reg
operator|->
name|pins
argument_list|)
expr_stmt|;
name|wps_free_nfc_pw_tokens
argument_list|(
operator|&
name|reg
operator|->
name|nfc_pw_tokens
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wps_free_pbc_sessions
argument_list|(
name|reg
operator|->
name|pbc_sessions
argument_list|)
expr_stmt|;
name|reg
operator|->
name|pbc_sessions
operator|=
name|NULL
expr_stmt|;
name|wps_free_devices
argument_list|(
name|reg
operator|->
name|devices
argument_list|)
expr_stmt|;
name|reg
operator|->
name|devices
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
name|reg
operator|->
name|pbc_ignore_start
operator|.
name|sec
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
block|}
end_function

begin_comment
comment|/**  * wps_registrar_deinit - Deinitialize WPS Registrar data  * @reg: Registrar data from wps_registrar_init()  */
end_comment

begin_function
name|void
name|wps_registrar_deinit
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|==
name|NULL
condition|)
return|return;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_pbc_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wps_registrar_flush
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|reg
operator|->
name|extra_cred
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_invalidate_unused
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|pin
argument_list|,
argument|&reg->pins
argument_list|,
argument|struct wps_uuid_pin
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|pin
operator|->
name|wildcard_uuid
operator|==
literal|1
operator|&&
operator|!
operator|(
name|pin
operator|->
name|flags
operator|&
name|PIN_LOCKED
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalidate previously "
literal|"configured wildcard PIN"
argument_list|)
expr_stmt|;
name|wps_registrar_remove_pin
argument_list|(
name|reg
argument_list|,
name|pin
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * wps_registrar_add_pin - Configure a new PIN for Registrar  * @reg: Registrar data from wps_registrar_init()  * @addr: Enrollee MAC address or %NULL if not known  * @uuid: UUID-E or %NULL for wildcard (any UUID)  * @pin: PIN (Device Password)  * @pin_len: Length of pin in octets  * @timeout: Time (in seconds) when the PIN will be invalidated; 0 = no timeout  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|wps_registrar_add_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|,
specifier|const
name|u8
modifier|*
name|pin
parameter_list|,
name|size_t
name|pin_len
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|addr
condition|)
name|os_memcpy
argument_list|(
name|p
operator|->
name|enrollee_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|uuid
operator|==
name|NULL
condition|)
name|p
operator|->
name|wildcard_uuid
operator|=
literal|1
expr_stmt|;
else|else
name|os_memcpy
argument_list|(
name|p
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|p
operator|->
name|pin
operator|=
name|os_malloc
argument_list|(
name|pin_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|->
name|pin
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|p
operator|->
name|pin
argument_list|,
name|pin
argument_list|,
name|pin_len
argument_list|)
expr_stmt|;
name|p
operator|->
name|pin_len
operator|=
name|pin_len
expr_stmt|;
if|if
condition|(
name|timeout
condition|)
block|{
name|p
operator|->
name|flags
operator||=
name|PIN_EXPIRES
expr_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|p
operator|->
name|expiration
argument_list|)
expr_stmt|;
name|p
operator|->
name|expiration
operator|.
name|sec
operator|+=
name|timeout
expr_stmt|;
block|}
if|if
condition|(
name|p
operator|->
name|wildcard_uuid
condition|)
name|wps_registrar_invalidate_unused
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|reg
operator|->
name|pins
argument_list|,
operator|&
name|p
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: A new PIN configured (timeout=%d)"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID"
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN"
argument_list|,
name|pin
argument_list|,
name|pin_len
argument_list|)
expr_stmt|;
name|reg
operator|->
name|selected_registrar
operator|=
literal|1
expr_stmt|;
name|reg
operator|->
name|pbc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|addr
condition|)
name|wps_registrar_add_authorized_mac
argument_list|(
name|reg
argument_list|,
name|addr
argument_list|)
expr_stmt|;
else|else
name|wps_registrar_add_authorized_mac
argument_list|(
name|reg
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|)
expr_stmt|;
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_remove_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wps_uuid_pin
modifier|*
name|pin
parameter_list|)
block|{
name|u8
modifier|*
name|addr
decl_stmt|;
name|u8
name|bcast
index|[
name|ETH_ALEN
index|]
init|=
block|{
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|,
literal|0xff
block|}
decl_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|pin
operator|->
name|enrollee_addr
argument_list|)
condition|)
name|addr
operator|=
name|bcast
expr_stmt|;
else|else
name|addr
operator|=
name|pin
operator|->
name|enrollee_addr
expr_stmt|;
name|wps_registrar_remove_authorized_mac
argument_list|(
name|reg
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|wps_remove_pin
argument_list|(
name|pin
argument_list|)
expr_stmt|;
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_expire_pins
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|struct
name|os_reltime
name|now
decl_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|pin
argument_list|,
argument|prev
argument_list|,
argument|&reg->pins
argument_list|,
argument|struct wps_uuid_pin
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|(
name|pin
operator|->
name|flags
operator|&
name|PIN_EXPIRES
operator|)
operator|&&
name|os_reltime_before
argument_list|(
operator|&
name|pin
operator|->
name|expiration
argument_list|,
operator|&
name|now
argument_list|)
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Expired PIN for UUID"
argument_list|,
name|pin
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wps_registrar_remove_pin
argument_list|(
name|reg
argument_list|,
name|pin
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * wps_registrar_invalidate_wildcard_pin - Invalidate a wildcard PIN  * @reg: Registrar data from wps_registrar_init()  * @dev_pw: PIN to search for or %NULL to match any  * @dev_pw_len: Length of dev_pw in octets  * Returns: 0 on success, -1 if not wildcard PIN is enabled  */
end_comment

begin_function
specifier|static
name|int
name|wps_registrar_invalidate_wildcard_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_pw
parameter_list|,
name|size_t
name|dev_pw_len
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|pin
argument_list|,
argument|prev
argument_list|,
argument|&reg->pins
argument_list|,
argument|struct wps_uuid_pin
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|dev_pw
operator|&&
name|pin
operator|->
name|pin
operator|&&
operator|(
name|dev_pw_len
operator|!=
name|pin
operator|->
name|pin_len
operator|||
name|os_memcmp_const
argument_list|(
name|dev_pw
argument_list|,
name|pin
operator|->
name|pin
argument_list|,
name|dev_pw_len
argument_list|)
operator|!=
literal|0
operator|)
condition|)
continue|continue;
comment|/* different PIN */
if|if
condition|(
name|pin
operator|->
name|wildcard_uuid
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalidated PIN for UUID"
argument_list|,
name|pin
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wps_registrar_remove_pin
argument_list|(
name|reg
argument_list|,
name|pin
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_invalidate_pin - Invalidate a PIN for a specific UUID-E  * @reg: Registrar data from wps_registrar_init()  * @uuid: UUID-E  * Returns: 0 on success, -1 on failure (e.g., PIN not found)  */
end_comment

begin_function
name|int
name|wps_registrar_invalidate_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|pin
argument_list|,
argument|prev
argument_list|,
argument|&reg->pins
argument_list|,
argument|struct wps_uuid_pin
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|pin
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalidated PIN for UUID"
argument_list|,
name|pin
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wps_registrar_remove_pin
argument_list|(
name|reg
argument_list|,
name|pin
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|wps_registrar_get_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|,
name|size_t
modifier|*
name|pin_len
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|,
modifier|*
name|found
init|=
name|NULL
decl_stmt|;
name|wps_registrar_expire_pins
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|pin
argument_list|,
argument|&reg->pins
argument_list|,
argument|struct wps_uuid_pin
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|pin
operator|->
name|wildcard_uuid
operator|&&
name|os_memcmp
argument_list|(
name|pin
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|found
operator|=
name|pin
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
comment|/* Check for wildcard UUIDs since none of the UUID-specific 		 * PINs matched */
name|dl_list_for_each
argument_list|(
argument|pin
argument_list|,
argument|&reg->pins
argument_list|,
argument|struct wps_uuid_pin
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|pin
operator|->
name|wildcard_uuid
operator|==
literal|1
operator|||
name|pin
operator|->
name|wildcard_uuid
operator|==
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Found a wildcard "
literal|"PIN. Assigned it for this UUID-E"
argument_list|)
expr_stmt|;
name|pin
operator|->
name|wildcard_uuid
operator|++
expr_stmt|;
name|os_memcpy
argument_list|(
name|pin
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|found
operator|=
name|pin
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
return|return
name|NULL
return|;
comment|/* 	 * Lock the PIN to avoid attacks based on concurrent re-use of the PIN 	 * that could otherwise avoid PIN invalidations. 	 */
if|if
condition|(
name|found
operator|->
name|flags
operator|&
name|PIN_LOCKED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Selected PIN locked - do not "
literal|"allow concurrent re-use"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|pin_len
operator|=
name|found
operator|->
name|pin_len
expr_stmt|;
name|found
operator|->
name|flags
operator||=
name|PIN_LOCKED
expr_stmt|;
return|return
name|found
operator|->
name|pin
return|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_unlock_pin - Unlock a PIN for a specific UUID-E  * @reg: Registrar data from wps_registrar_init()  * @uuid: UUID-E  * Returns: 0 on success, -1 on failure  *  * PINs are locked to enforce only one concurrent use. This function unlocks a  * PIN to allow it to be used again. If the specified PIN was configured using  * a wildcard UUID, it will be removed instead of allowing multiple uses.  */
end_comment

begin_function
name|int
name|wps_registrar_unlock_pin
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|)
block|{
name|struct
name|wps_uuid_pin
modifier|*
name|pin
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|pin
argument_list|,
argument|&reg->pins
argument_list|,
argument|struct wps_uuid_pin
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|pin
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|pin
operator|->
name|wildcard_uuid
operator|==
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalidating used "
literal|"wildcard PIN"
argument_list|)
expr_stmt|;
return|return
name|wps_registrar_invalidate_pin
argument_list|(
name|reg
argument_list|,
name|uuid
argument_list|)
return|;
block|}
name|pin
operator|->
name|flags
operator|&=
operator|~
name|PIN_LOCKED
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_stop_pbc
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|reg
operator|->
name|selected_registrar
operator|=
literal|0
expr_stmt|;
name|reg
operator|->
name|pbc
operator|=
literal|0
expr_stmt|;
name|os_memset
argument_list|(
name|reg
operator|->
name|p2p_dev_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wps_registrar_remove_authorized_mac
argument_list|(
name|reg
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|)
expr_stmt|;
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_pbc_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wps_registrar
modifier|*
name|reg
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC timed out - disable PBC mode"
argument_list|)
expr_stmt|;
name|wps_pbc_timeout_event
argument_list|(
name|reg
operator|->
name|wps
argument_list|)
expr_stmt|;
name|wps_registrar_stop_pbc
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_button_pushed - Notify Registrar that AP button was pushed  * @reg: Registrar data from wps_registrar_init()  * @p2p_dev_addr: Limit allowed PBC devices to the specified P2P device, %NULL  *	indicates no such filtering  * Returns: 0 on success, -1 on failure, -2 on session overlap  *  * This function is called on an AP when a push button is pushed to activate  * PBC mode. The PBC mode will be stopped after walk time (2 minutes) timeout  * or when a PBC registration is completed. If more than one Enrollee in active  * PBC mode has been detected during the monitor time (previous 2 minutes), the  * PBC mode is not activated and -2 is returned to indicate session overlap.  * This is skipped if a specific Enrollee is selected.  */
end_comment

begin_function
name|int
name|wps_registrar_button_pushed
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
parameter_list|)
block|{
if|if
condition|(
name|p2p_dev_addr
operator|==
name|NULL
operator|&&
name|wps_registrar_pbc_overlap
argument_list|(
name|reg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC overlap - do not start PBC "
literal|"mode"
argument_list|)
expr_stmt|;
name|wps_pbc_overlap_event
argument_list|(
name|reg
operator|->
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Button pushed - PBC mode started"
argument_list|)
expr_stmt|;
name|reg
operator|->
name|force_pbc_overlap
operator|=
literal|0
expr_stmt|;
name|reg
operator|->
name|selected_registrar
operator|=
literal|1
expr_stmt|;
name|reg
operator|->
name|pbc
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|p2p_dev_addr
condition|)
name|os_memcpy
argument_list|(
name|reg
operator|->
name|p2p_dev_addr
argument_list|,
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|os_memset
argument_list|(
name|reg
operator|->
name|p2p_dev_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wps_registrar_add_authorized_mac
argument_list|(
name|reg
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|)
expr_stmt|;
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wps_pbc_active_event
argument_list|(
name|reg
operator|->
name|wps
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_pbc_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wps_registrar_pbc_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_pbc_completed
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC completed - stopping PBC mode"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_pbc_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wps_registrar_stop_pbc
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|wps_pbc_disable_event
argument_list|(
name|reg
operator|->
name|wps
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_pin_completed
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN completed using internal Registrar"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|reg
operator|->
name|selected_registrar
operator|=
literal|0
expr_stmt|;
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wps_registrar_complete
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|registrar
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_pw
parameter_list|,
name|size_t
name|dev_pw_len
parameter_list|)
block|{
if|if
condition|(
name|registrar
operator|->
name|pbc
condition|)
block|{
name|wps_registrar_remove_pbc_session
argument_list|(
name|registrar
argument_list|,
name|uuid_e
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wps_registrar_pbc_completed
argument_list|(
name|registrar
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
name|os_get_reltime
argument_list|(
operator|&
name|registrar
operator|->
name|pbc_ignore_start
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
name|os_memcpy
argument_list|(
name|registrar
operator|->
name|pbc_ignore_uuid
argument_list|,
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wps_registrar_pin_completed
argument_list|(
name|registrar
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dev_pw
operator|&&
name|wps_registrar_invalidate_wildcard_pin
argument_list|(
name|registrar
argument_list|,
name|dev_pw
argument_list|,
name|dev_pw_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalidated wildcard PIN"
argument_list|,
name|dev_pw
argument_list|,
name|dev_pw_len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wps_registrar_wps_cancel
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|->
name|pbc
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC is set - cancelling it"
argument_list|)
expr_stmt|;
name|wps_registrar_pbc_timeout
argument_list|(
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_pbc_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|reg
operator|->
name|selected_registrar
condition|)
block|{
comment|/* PIN Method */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN is set - cancelling it"
argument_list|)
expr_stmt|;
name|wps_registrar_pin_completed
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|wps_registrar_invalidate_wildcard_pin
argument_list|(
name|reg
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wps_registrar_probe_req_rx - Notify Registrar of Probe Request  * @reg: Registrar data from wps_registrar_init()  * @addr: MAC address of the Probe Request sender  * @wps_data: WPS IE contents  *  * This function is called on an AP when a Probe Request with WPS IE is  * received. This is used to track PBC mode use and to detect possible overlap  * situation with other WPS APs.  */
end_comment

begin_function
name|void
name|wps_registrar_probe_req_rx
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|wps_data
parameter_list|,
name|int
name|p2p_wildcard
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|int
name|skip_add
init|=
literal|0
decl_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS: Probe Request with WPS data received"
argument_list|,
name|wps_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|wps_data
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
name|attr
operator|.
name|config_methods
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Config Methods attribute in "
literal|"Probe Request"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|attr
operator|.
name|dev_password_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Device Password Id attribute "
literal|"in Probe Request"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|reg
operator|->
name|enrollee_seen_cb
operator|&&
name|attr
operator|.
name|uuid_e
operator|&&
name|attr
operator|.
name|primary_dev_type
operator|&&
name|attr
operator|.
name|request_type
operator|&&
operator|!
name|p2p_wildcard
condition|)
block|{
name|char
modifier|*
name|dev_name
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|attr
operator|.
name|dev_name
condition|)
block|{
name|dev_name
operator|=
name|os_zalloc
argument_list|(
name|attr
operator|.
name|dev_name_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_name
condition|)
block|{
name|os_memcpy
argument_list|(
name|dev_name
argument_list|,
name|attr
operator|.
name|dev_name
argument_list|,
name|attr
operator|.
name|dev_name_len
argument_list|)
expr_stmt|;
block|}
block|}
name|reg
operator|->
name|enrollee_seen_cb
argument_list|(
name|reg
operator|->
name|cb_ctx
argument_list|,
name|addr
argument_list|,
name|attr
operator|.
name|uuid_e
argument_list|,
name|attr
operator|.
name|primary_dev_type
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|config_methods
argument_list|)
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|dev_password_id
argument_list|)
argument_list|,
operator|*
name|attr
operator|.
name|request_type
argument_list|,
name|dev_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|dev_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|dev_password_id
argument_list|)
operator|!=
name|DEV_PW_PUSHBUTTON
condition|)
return|return;
comment|/* Not PBC */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Probe Request for PBC received from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|uuid_e
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Probe Request WPS IE: No "
literal|"UUID-E included"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID-E from Probe Request"
argument_list|,
name|attr
operator|.
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
if|if
condition|(
name|reg
operator|->
name|pbc_ignore_start
operator|.
name|sec
operator|&&
name|os_memcmp
argument_list|(
name|attr
operator|.
name|uuid_e
argument_list|,
name|reg
operator|->
name|pbc_ignore_uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|os_reltime
name|now
decl_stmt|,
name|dur
decl_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|os_reltime_sub
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|reg
operator|->
name|pbc_ignore_start
argument_list|,
operator|&
name|dur
argument_list|)
expr_stmt|;
if|if
condition|(
name|dur
operator|.
name|sec
operator|>=
literal|0
operator|&&
name|dur
operator|.
name|sec
operator|<
literal|5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Ignore PBC activation "
literal|"based on Probe Request from the Enrollee "
literal|"that just completed PBC provisioning"
argument_list|)
expr_stmt|;
name|skip_add
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|reg
operator|->
name|pbc_ignore_start
operator|.
name|sec
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
if|if
condition|(
operator|!
name|skip_add
condition|)
name|wps_registrar_add_pbc_session
argument_list|(
name|reg
argument_list|,
name|addr
argument_list|,
name|attr
operator|.
name|uuid_e
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_registrar_pbc_overlap
argument_list|(
name|reg
argument_list|,
name|addr
argument_list|,
name|attr
operator|.
name|uuid_e
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC session overlap detected"
argument_list|)
expr_stmt|;
name|reg
operator|->
name|force_pbc_overlap
operator|=
literal|1
expr_stmt|;
name|wps_pbc_overlap_event
argument_list|(
name|reg
operator|->
name|wps
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wps_cb_new_psk
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|->
name|new_psk_cb
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
name|reg
operator|->
name|new_psk_cb
argument_list|(
name|reg
operator|->
name|cb_ctx
argument_list|,
name|mac_addr
argument_list|,
name|p2p_dev_addr
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_cb_pin_needed
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|->
name|pin_needed_cb
operator|==
name|NULL
condition|)
return|return;
name|reg
operator|->
name|pin_needed_cb
argument_list|(
name|reg
operator|->
name|cb_ctx
argument_list|,
name|uuid_e
argument_list|,
name|dev
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_cb_reg_success
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_pw
parameter_list|,
name|size_t
name|dev_pw_len
parameter_list|)
block|{
if|if
condition|(
name|reg
operator|->
name|reg_success_cb
operator|==
name|NULL
condition|)
return|return;
name|reg
operator|->
name|reg_success_cb
argument_list|(
name|reg
operator|->
name|cb_ctx
argument_list|,
name|mac_addr
argument_list|,
name|uuid_e
argument_list|,
name|dev_pw
argument_list|,
name|dev_pw_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_cb_set_ie
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|beacon_ie
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|probe_resp_ie
parameter_list|)
block|{
return|return
name|reg
operator|->
name|set_ie_cb
argument_list|(
name|reg
operator|->
name|cb_ctx
argument_list|,
name|beacon_ie
argument_list|,
name|probe_resp_ie
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_cb_set_sel_reg
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|u16
name|methods
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|reg
operator|->
name|set_sel_reg_cb
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|reg
operator|->
name|selected_registrar
condition|)
block|{
name|methods
operator|=
name|reg
operator|->
name|wps
operator|->
name|config_methods
operator|&
operator|~
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
name|methods
operator|&=
operator|~
operator|(
name|WPS_CONFIG_VIRT_PUSHBUTTON
operator||
name|WPS_CONFIG_PHY_PUSHBUTTON
operator|)
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|pbc
condition|)
name|wps_set_pushbutton
argument_list|(
operator|&
name|methods
argument_list|,
name|reg
operator|->
name|wps
operator|->
name|config_methods
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: wps_cb_set_sel_reg: sel_reg=%d "
literal|"config_methods=0x%x pbc=%d methods=0x%x"
argument_list|,
name|reg
operator|->
name|selected_registrar
argument_list|,
name|reg
operator|->
name|wps
operator|->
name|config_methods
argument_list|,
name|reg
operator|->
name|pbc
argument_list|,
name|methods
argument_list|)
expr_stmt|;
name|reg
operator|->
name|set_sel_reg_cb
argument_list|(
name|reg
operator|->
name|cb_ctx
argument_list|,
name|reg
operator|->
name|selected_registrar
argument_list|,
name|reg
operator|->
name|pbc
condition|?
name|DEV_PW_PUSHBUTTON
else|:
name|DEV_PW_DEFAULT
argument_list|,
name|methods
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_set_ie
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|beacon
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|probe
decl_stmt|;
specifier|const
name|u8
modifier|*
name|auth_macs
decl_stmt|;
name|size_t
name|count
decl_stmt|;
name|size_t
name|vendor_len
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|reg
operator|->
name|set_ie_cb
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_WPS_VENDOR_EXTENSIONS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|reg
operator|->
name|wps
operator|->
name|dev
operator|.
name|vendor_ext
index|[
name|i
index|]
condition|)
block|{
name|vendor_len
operator|+=
literal|2
operator|+
literal|2
expr_stmt|;
name|vendor_len
operator|+=
name|wpabuf_len
argument_list|(
name|reg
operator|->
name|wps
operator|->
name|dev
operator|.
name|vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|beacon
operator|=
name|wpabuf_alloc
argument_list|(
literal|400
operator|+
name|vendor_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|beacon
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|probe
operator|=
name|wpabuf_alloc
argument_list|(
literal|500
operator|+
name|vendor_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|probe
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|auth_macs
operator|=
name|wps_authorized_macs
argument_list|(
name|reg
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Build Beacon IEs"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|beacon
argument_list|)
operator|||
name|wps_build_wps_state
argument_list|(
name|reg
operator|->
name|wps
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_ap_setup_locked
argument_list|(
name|reg
operator|->
name|wps
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_selected_registrar
argument_list|(
name|reg
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_sel_reg_dev_password_id
argument_list|(
name|reg
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_sel_reg_config_methods
argument_list|(
name|reg
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_sel_pbc_reg_uuid_e
argument_list|(
name|reg
argument_list|,
name|beacon
argument_list|)
operator|||
operator|(
name|reg
operator|->
name|dualband
operator|&&
name|wps_build_rf_bands
argument_list|(
operator|&
name|reg
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|beacon
argument_list|,
literal|0
argument_list|)
operator|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|beacon
argument_list|,
literal|0
argument_list|,
name|auth_macs
argument_list|,
name|count
argument_list|)
operator|||
name|wps_build_vendor_ext
argument_list|(
operator|&
name|reg
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|beacon
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|probe
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wps_build_dev_name
argument_list|(
operator|&
name|reg
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|beacon
argument_list|)
operator|||
name|wps_build_primary_dev_type
argument_list|(
operator|&
name|reg
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|beacon
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|probe
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Build Probe Response IEs"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|probe
argument_list|)
operator|||
name|wps_build_wps_state
argument_list|(
name|reg
operator|->
name|wps
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_ap_setup_locked
argument_list|(
name|reg
operator|->
name|wps
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_selected_registrar
argument_list|(
name|reg
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_sel_reg_dev_password_id
argument_list|(
name|reg
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_sel_reg_config_methods
argument_list|(
name|reg
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_resp_type
argument_list|(
name|probe
argument_list|,
name|reg
operator|->
name|wps
operator|->
name|ap
condition|?
name|WPS_RESP_AP
else|:
name|WPS_RESP_REGISTRAR
argument_list|)
operator|||
name|wps_build_uuid_e
argument_list|(
name|probe
argument_list|,
name|reg
operator|->
name|wps
operator|->
name|uuid
argument_list|)
operator|||
name|wps_build_device_attrs
argument_list|(
operator|&
name|reg
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|probe
argument_list|)
operator|||
name|wps_build_probe_config_methods
argument_list|(
name|reg
argument_list|,
name|probe
argument_list|)
operator|||
operator|(
name|reg
operator|->
name|dualband
operator|&&
name|wps_build_rf_bands
argument_list|(
operator|&
name|reg
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|probe
argument_list|,
literal|0
argument_list|)
operator|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|probe
argument_list|,
literal|0
argument_list|,
name|auth_macs
argument_list|,
name|count
argument_list|)
operator|||
name|wps_build_vendor_ext
argument_list|(
operator|&
name|reg
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|probe
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|probe
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|beacon
operator|=
name|wps_ie_encapsulate
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
name|probe
operator|=
name|wps_ie_encapsulate
argument_list|(
name|probe
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|beacon
operator|||
operator|!
name|probe
condition|)
block|{
name|wpabuf_free
argument_list|(
name|beacon
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|probe
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|reg
operator|->
name|static_wep_only
condition|)
block|{
comment|/* 		 * Windows XP and Vista clients can get confused about 		 * EAP-Identity/Request when they probe the network with 		 * EAPOL-Start. In such a case, they may assume the network is 		 * using IEEE 802.1X and prompt user for a certificate while 		 * the correct (non-WPS) behavior would be to ask for the 		 * static WEP key. As a workaround, use Microsoft Provisioning 		 * IE to advertise that legacy 802.1X is not supported. 		 */
specifier|const
name|u8
name|ms_wps
index|[
literal|7
index|]
init|=
block|{
name|WLAN_EID_VENDOR_SPECIFIC
block|,
literal|5
block|,
comment|/* Microsoft Provisioning IE (00:50:f2:5) */
literal|0x00
block|,
literal|0x50
block|,
literal|0xf2
block|,
literal|5
block|,
literal|0x00
comment|/* no legacy 802.1X or MS WPS */
block|}
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Add Microsoft Provisioning IE "
literal|"into Beacon/Probe Response frames"
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|beacon
argument_list|,
name|ms_wps
argument_list|,
sizeof|sizeof
argument_list|(
name|ms_wps
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|probe
argument_list|,
name|ms_wps
argument_list|,
sizeof|sizeof
argument_list|(
name|ms_wps
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|wps_cb_set_ie
argument_list|(
name|reg
argument_list|,
name|beacon
argument_list|,
name|probe
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_get_dev_password
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pin
decl_stmt|;
name|size_t
name|pin_len
init|=
literal|0
decl_stmt|;
name|bin_clear_free
argument_list|(
name|wps
operator|->
name|dev_password
argument_list|,
name|wps
operator|->
name|dev_password_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev_password
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|pbc
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Use default PIN for PBC"
argument_list|)
expr_stmt|;
name|pin
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
literal|"00000000"
expr_stmt|;
name|pin_len
operator|=
literal|8
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
block|}
elseif|else
if|if
condition|(
name|wps
operator|->
name|nfc_pw_token
condition|)
block|{
if|if
condition|(
name|wps
operator|->
name|nfc_pw_token
operator|->
name|pw_id
operator|==
name|DEV_PW_NFC_CONNECTION_HANDOVER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Using NFC connection "
literal|"handover and abbreviated WPS handshake "
literal|"without Device Password"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Use OOB Device Password from NFC "
literal|"Password Token"
argument_list|)
expr_stmt|;
name|pin
operator|=
name|wps
operator|->
name|nfc_pw_token
operator|->
name|dev_pw
expr_stmt|;
name|pin_len
operator|=
name|wps
operator|->
name|nfc_pw_token
operator|->
name|dev_pw_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wps
operator|->
name|dev_pw_id
operator|>=
literal|0x10
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw_id
operator|==
name|wps
operator|->
name|dev_pw_id
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Use OOB Device Password from own NFC Password Token"
argument_list|)
expr_stmt|;
name|pin
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw
argument_list|)
expr_stmt|;
name|pin_len
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
block|}
else|else
block|{
name|pin
operator|=
name|wps_registrar_get_pin
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|,
operator|&
name|pin_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pin
operator|&&
name|wps
operator|->
name|dev_pw_id
operator|>=
literal|0x10
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No match for OOB Device "
literal|"Password ID, but PIN found"
argument_list|)
expr_stmt|;
comment|/* 			 * See whether Enrollee is willing to use PIN instead. 			 */
name|wps
operator|->
name|dev_pw_id
operator|=
name|DEV_PW_DEFAULT
expr_stmt|;
block|}
block|}
if|if
condition|(
name|pin
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Device Password available for "
literal|"the Enrollee (context %p registrar %p)"
argument_list|,
name|wps
operator|->
name|wps
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
name|wps_cb_pin_needed
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|,
operator|&
name|wps
operator|->
name|peer_dev
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|dev_password
operator|=
name|os_malloc
argument_list|(
name|pin_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dev_password
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev_password
argument_list|,
name|pin
argument_list|,
name|pin_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev_password_len
operator|=
name|pin_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_uuid_r
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * UUID-R"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_UUID_R
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|uuid_r
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_r_hash
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u8
modifier|*
name|hash
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|random_get_bytes
argument_list|(
name|wps
operator|->
name|snonce
argument_list|,
literal|2
operator|*
name|WPS_SECRET_NONCE_LEN
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-S1"
argument_list|,
name|wps
operator|->
name|snonce
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-S2"
argument_list|,
name|wps
operator|->
name|snonce
operator|+
name|WPS_SECRET_NONCE_LEN
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dh_pubkey_e
operator|==
name|NULL
operator|||
name|wps
operator|->
name|dh_pubkey_r
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: DH public keys not available for "
literal|"R-Hash derivation"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * R-Hash1"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_R_HASH1
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|hash
operator|=
name|wpabuf_put
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
comment|/* R-Hash1 = HMAC_AuthKey(R-S1 || PSK1 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|wps
operator|->
name|snonce
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk1
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|WPS_PSK_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-Hash1"
argument_list|,
name|hash
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * R-Hash2"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_R_HASH2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|hash
operator|=
name|wpabuf_put
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
comment|/* R-Hash2 = HMAC_AuthKey(R-S2 || PSK2 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|wps
operator|->
name|snonce
operator|+
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk2
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-Hash2"
argument_list|,
name|hash
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_r_snonce1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * R-SNonce1"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_R_SNONCE1
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|snonce
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_r_snonce2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * R-SNonce2"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_R_SNONCE2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|snonce
operator|+
name|WPS_SECRET_NONCE_LEN
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_network_idx
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Network Index (1)"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_NETWORK_INDEX
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_ssid
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * SSID"
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: SSID for Credential"
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_SSID
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_auth_type
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Authentication Type (0x%x)"
argument_list|,
name|cred
operator|->
name|auth_type
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_AUTH_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|auth_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_encr_type
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Encryption Type (0x%x)"
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_ENCR_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_network_key
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Network Key (len=%d)"
argument_list|,
operator|(
name|int
operator|)
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network Key"
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_NETWORK_KEY
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_credential
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
if|if
condition|(
name|wps_build_cred_network_idx
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
operator|||
name|wps_build_cred_ssid
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
operator|||
name|wps_build_cred_auth_type
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
operator|||
name|wps_build_cred_encr_type
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
operator|||
name|wps_build_cred_network_key
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
operator|||
name|wps_build_mac_addr
argument_list|(
name|msg
argument_list|,
name|cred
operator|->
name|mac_addr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wps_build_credential_wrap
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wbuf
decl_stmt|;
name|wbuf
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|wbuf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wps_build_credential
argument_list|(
name|wbuf
argument_list|,
name|cred
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|wbuf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_CRED
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|wpabuf_len
argument_list|(
name|wbuf
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|msg
argument_list|,
name|wbuf
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wbuf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wps_build_cred
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|cred
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|skip_cred_build
condition|)
goto|goto
name|skip_cred_build
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Credential"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|use_cred
condition|)
block|{
name|os_memcpy
argument_list|(
operator|&
name|wps
operator|->
name|cred
argument_list|,
name|wps
operator|->
name|use_cred
argument_list|,
sizeof|sizeof
argument_list|(
name|wps
operator|->
name|cred
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|use_provided
goto|;
block|}
name|os_memset
argument_list|(
operator|&
name|wps
operator|->
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wps
operator|->
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|ssid
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|ssid_len
operator|=
name|wps
operator|->
name|wps
operator|->
name|ssid_len
expr_stmt|;
comment|/* Select the best authentication and encryption type */
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|&
name|WPS_AUTH_WPA2PSK
condition|)
name|wps
operator|->
name|auth_type
operator|=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|&
name|WPS_AUTH_WPAPSK
condition|)
name|wps
operator|->
name|auth_type
operator|=
name|WPS_AUTH_WPAPSK
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|&
name|WPS_AUTH_OPEN
condition|)
name|wps
operator|->
name|auth_type
operator|=
name|WPS_AUTH_OPEN
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported auth_type 0x%x"
argument_list|,
name|wps
operator|->
name|auth_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|cred
operator|.
name|auth_type
operator|=
name|wps
operator|->
name|auth_type
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|==
name|WPS_AUTH_WPA2PSK
operator|||
name|wps
operator|->
name|auth_type
operator|==
name|WPS_AUTH_WPAPSK
condition|)
block|{
if|if
condition|(
name|wps
operator|->
name|encr_type
operator|&
name|WPS_ENCR_AES
condition|)
name|wps
operator|->
name|encr_type
operator|=
name|WPS_ENCR_AES
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|encr_type
operator|&
name|WPS_ENCR_TKIP
condition|)
name|wps
operator|->
name|encr_type
operator|=
name|WPS_ENCR_TKIP
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No suitable encryption "
literal|"type for WPA/WPA2"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|wps
operator|->
name|encr_type
operator|&
name|WPS_ENCR_NONE
condition|)
name|wps
operator|->
name|encr_type
operator|=
name|WPS_ENCR_NONE
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
elseif|else
if|if
condition|(
name|wps
operator|->
name|encr_type
operator|&
name|WPS_ENCR_WEP
condition|)
name|wps
operator|->
name|encr_type
operator|=
name|WPS_ENCR_WEP
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No suitable encryption "
literal|"type for non-WPA/WPA2 mode"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|=
name|wps
operator|->
name|encr_type
expr_stmt|;
comment|/* 	 * Set MAC address in the Credential to be the Enrollee's MAC address 	 */
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|mac_addr
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_state
operator|==
name|WPS_STATE_NOT_CONFIGURED
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
operator|!
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|disable_auto_conf
condition|)
block|{
name|u8
name|r
index|[
literal|16
index|]
decl_stmt|;
comment|/* Generate a random passphrase */
if|if
condition|(
name|random_pool_ready
argument_list|()
operator|!=
literal|1
operator|||
name|random_get_bytes
argument_list|(
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Could not generate random PSK"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps
operator|->
name|new_psk
operator|=
name|base64_encode
argument_list|(
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|,
operator|&
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|new_psk
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wps
operator|->
name|new_psk_len
operator|--
expr_stmt|;
comment|/* remove newline */
while|while
condition|(
name|wps
operator|->
name|new_psk_len
operator|&&
name|wps
operator|->
name|new_psk
index|[
name|wps
operator|->
name|new_psk_len
operator|-
literal|1
index|]
operator|==
literal|'='
condition|)
name|wps
operator|->
name|new_psk_len
operator|--
expr_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Generated passphrase"
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|key
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|key_len
operator|=
name|wps
operator|->
name|new_psk_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_per_enrollee_psk
operator|&&
name|wps
operator|->
name|use_psk_key
operator|&&
name|wps
operator|->
name|wps
operator|->
name|psk_set
condition|)
block|{
name|char
name|hex
index|[
literal|65
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Use PSK format for Network Key"
argument_list|)
expr_stmt|;
name|wpa_snprintf_hex
argument_list|(
name|hex
argument_list|,
sizeof|sizeof
argument_list|(
name|hex
argument_list|)
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|psk
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|key
argument_list|,
name|hex
argument_list|,
literal|32
operator|*
literal|2
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|key_len
operator|=
literal|32
operator|*
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_per_enrollee_psk
operator|&&
name|wps
operator|->
name|wps
operator|->
name|network_key
condition|)
block|{
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|key
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|network_key
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|network_key_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|key_len
operator|=
name|wps
operator|->
name|wps
operator|->
name|network_key_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPAPSK
operator||
name|WPS_AUTH_WPA2PSK
operator|)
condition|)
block|{
name|char
name|hex
index|[
literal|65
index|]
decl_stmt|;
comment|/* Generate a random per-device PSK */
name|os_free
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps
operator|->
name|new_psk_len
operator|=
literal|32
expr_stmt|;
name|wps
operator|->
name|new_psk
operator|=
name|os_malloc
argument_list|(
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|new_psk
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|random_pool_ready
argument_list|()
operator|!=
literal|1
operator|||
name|random_get_bytes
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Could not generate random PSK"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps
operator|->
name|new_psk
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Generated per-device PSK"
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
name|wpa_snprintf_hex
argument_list|(
name|hex
argument_list|,
sizeof|sizeof
argument_list|(
name|hex
argument_list|)
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|key
argument_list|,
name|hex
argument_list|,
name|wps
operator|->
name|new_psk_len
operator|*
literal|2
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|key_len
operator|=
name|wps
operator|->
name|new_psk_len
operator|*
literal|2
expr_stmt|;
block|}
name|use_provided
label|:
ifdef|#
directive|ifdef
name|CONFIG_WPS_TESTING
if|if
condition|(
name|wps_testing_dummy_cred
condition|)
name|cred
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
else|else
name|cred
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|cred
condition|)
block|{
name|struct
name|wps_credential
name|dummy
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Add dummy credential"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|dummy
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|dummy
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|dummy
operator|.
name|ssid
argument_list|,
literal|"dummy"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|dummy
operator|.
name|ssid_len
operator|=
literal|5
expr_stmt|;
name|dummy
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
name|dummy
operator|.
name|encr_type
operator|=
name|WPS_ENCR_AES
expr_stmt|;
name|os_memcpy
argument_list|(
name|dummy
operator|.
name|key
argument_list|,
literal|"dummy psk"
argument_list|,
literal|9
argument_list|)
expr_stmt|;
name|dummy
operator|.
name|key_len
operator|=
literal|9
expr_stmt|;
name|os_memcpy
argument_list|(
name|dummy
operator|.
name|mac_addr
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wps_build_credential
argument_list|(
name|cred
argument_list|,
operator|&
name|dummy
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Dummy Credential"
argument_list|,
name|cred
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_CRED
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|wpabuf_len
argument_list|(
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|cred
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_TESTING */
name|cred
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wps_build_credential
argument_list|(
name|cred
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|cred
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_CRED
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|wpabuf_len
argument_list|(
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|msg
argument_list|,
name|cred
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|cred
argument_list|)
expr_stmt|;
name|skip_cred_build
label|:
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|extra_cred
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Credential (pre-configured)"
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|extra_cred
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_ap_settings
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * AP Settings"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_build_credential
argument_list|(
name|msg
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_ap_cred
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|,
modifier|*
name|plain
decl_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|plain
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps_build_ap_settings
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_CRED
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|wpabuf_len
argument_list|(
name|plain
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|msg
argument_list|,
name|plain
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|int
name|config_in_m2
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|random_get_bytes
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Registrar Nonce"
argument_list|,
name|wps
operator|->
name|nonce_r
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID-R"
argument_list|,
name|wps
operator|->
name|uuid_r
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M2"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M2
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_uuid_r
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_public_key
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_derive_keys
argument_list|(
name|wps
argument_list|)
operator|||
name|wps_build_auth_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_encr_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_conn_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_config_methods_r
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_device_attrs
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_rf_bands
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|rf_band_cb
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|)
argument_list|)
operator|||
name|wps_build_assoc_state
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_config_error
argument_list|(
name|msg
argument_list|,
name|WPS_CFG_NO_ERROR
argument_list|)
operator|||
name|wps_build_dev_password_id
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|dev_pw_id
argument_list|)
operator|||
name|wps_build_os_version
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
if|if
condition|(
name|wps
operator|->
name|nfc_pw_token
operator|&&
name|wps
operator|->
name|nfc_pw_token
operator|->
name|pk_hash_provided_oob
operator|&&
name|wps
operator|->
name|nfc_pw_token
operator|->
name|pw_id
operator|==
name|DEV_PW_NFC_CONNECTION_HANDOVER
condition|)
block|{
comment|/* 		 * Use abbreviated handshake since public key hash allowed 		 * Enrollee to validate our public key similarly to how Enrollee 		 * public key was validated. There is no need to validate Device 		 * Password in this case. 		 */
name|struct
name|wpabuf
modifier|*
name|plain
init|=
name|wpabuf_alloc
argument_list|(
literal|500
argument_list|)
decl_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
operator|||
name|wps_build_cred
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_encr_settings
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
name|plain
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|config_in_m2
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
if|if
condition|(
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wps
operator|->
name|int_reg
operator|=
literal|1
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|config_in_m2
condition|?
name|RECV_DONE
else|:
name|RECV_M3
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m2d
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|u16
name|err
init|=
name|wps
operator|->
name|config_error
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M2D"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap_setup_locked
operator|&&
name|err
operator|==
name|WPS_CFG_NO_ERROR
condition|)
name|err
operator|=
name|WPS_CFG_SETUP_LOCKED
expr_stmt|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M2D
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_uuid_r
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_auth_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_encr_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_conn_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_config_methods_r
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_device_attrs
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_rf_bands
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|rf_band_cb
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|)
argument_list|)
operator|||
name|wps_build_assoc_state
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_config_error
argument_list|(
name|msg
argument_list|,
name|err
argument_list|)
operator|||
name|wps_build_os_version
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wps
operator|->
name|state
operator|=
name|RECV_M2D_ACK
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m4
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|,
modifier|*
name|plain
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M4"
argument_list|)
expr_stmt|;
name|wps_derive_psk
argument_list|(
name|wps
argument_list|,
name|wps
operator|->
name|dev_password
argument_list|,
name|wps
operator|->
name|dev_password_len
argument_list|)
expr_stmt|;
name|plain
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M4
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_r_hash
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_r_snonce1
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_encr_settings
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|||
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|RECV_M5
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m6
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|,
modifier|*
name|plain
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M6"
argument_list|)
expr_stmt|;
name|plain
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M6
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_r_snonce2
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_encr_settings
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|||
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps_pin_revealed
operator|=
literal|1
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|RECV_M7
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m8
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|,
modifier|*
name|plain
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M8"
argument_list|)
expr_stmt|;
name|plain
operator|=
name|wpabuf_alloc
argument_list|(
literal|500
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M8
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
operator|(
operator|(
name|wps
operator|->
name|wps
operator|->
name|ap
operator|||
name|wps
operator|->
name|er
operator|)
operator|&&
name|wps_build_cred
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
operator|!
name|wps
operator|->
name|er
operator|&&
name|wps_build_ap_settings
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|)
operator|||
name|wps_build_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_encr_settings
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|||
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|RECV_DONE
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_registrar_get_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|enum
name|wsc_op_code
modifier|*
name|op_code
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
operator|!
name|wps
operator|->
name|int_reg
operator|&&
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
condition|)
block|{
name|struct
name|upnp_pending_message
modifier|*
name|p
decl_stmt|,
modifier|*
name|prev
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|ext_reg
operator|>
literal|1
condition|)
name|wps_registrar_free_pending_m2
argument_list|(
name|wps
operator|->
name|wps
argument_list|)
expr_stmt|;
name|p
operator|=
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
expr_stmt|;
comment|/* TODO: check pending message MAC address */
while|while
condition|(
name|p
operator|&&
name|p
operator|->
name|next
condition|)
block|{
name|prev
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|p
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Use pending message from "
literal|"UPnP"
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
else|else
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
operator|=
name|NULL
expr_stmt|;
name|msg
operator|=
name|p
operator|->
name|msg
expr_stmt|;
switch|switch
condition|(
name|p
operator|->
name|type
condition|)
block|{
case|case
name|WPS_WSC_ACK
case|:
operator|*
name|op_code
operator|=
name|WSC_ACK
expr_stmt|;
break|break;
case|case
name|WPS_WSC_NACK
case|:
operator|*
name|op_code
operator|=
name|WSC_NACK
expr_stmt|;
break|break;
default|default:
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
block|}
name|os_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|ext_reg
operator|==
literal|0
condition|)
name|wps
operator|->
name|ext_reg
operator|=
literal|1
expr_stmt|;
return|return
name|msg
return|;
block|}
block|}
if|if
condition|(
name|wps
operator|->
name|ext_reg
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Using external Registrar, but no "
literal|"pending message available"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
switch|switch
condition|(
name|wps
operator|->
name|state
condition|)
block|{
case|case
name|SEND_M2
case|:
if|if
condition|(
name|wps_get_dev_password
argument_list|(
name|wps
argument_list|)
operator|<
literal|0
condition|)
name|msg
operator|=
name|wps_build_m2d
argument_list|(
name|wps
argument_list|)
expr_stmt|;
else|else
name|msg
operator|=
name|wps_build_m2
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M2D
case|:
name|msg
operator|=
name|wps_build_m2d
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M4
case|:
name|msg
operator|=
name|wps_build_m4
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M6
case|:
name|msg
operator|=
name|wps_build_m6
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M8
case|:
name|msg
operator|=
name|wps_build_m8
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|RECV_DONE
case|:
name|msg
operator|=
name|wps_build_wsc_ack
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_ACK
expr_stmt|;
break|break;
case|case
name|SEND_WSC_NACK
case|:
name|msg
operator|=
name|wps_build_wsc_nack
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_NACK
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported state %d for building "
literal|"a message"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|op_code
operator|==
name|WSC_MSG
operator|&&
name|msg
condition|)
block|{
comment|/* Save a copy of the last message for Authenticator derivation 		 */
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|last_msg
argument_list|)
expr_stmt|;
name|wps
operator|->
name|last_msg
operator|=
name|wpabuf_dup
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_enrollee_nonce
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_nonce
parameter_list|)
block|{
if|if
condition|(
name|e_nonce
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Enrollee Nonce received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|e_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Nonce"
argument_list|,
name|wps
operator|->
name|nonce_e
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_registrar_nonce
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|r_nonce
parameter_list|)
block|{
if|if
condition|(
name|r_nonce
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Registrar Nonce received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|r_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Registrar Nonce received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_uuid_e
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|)
block|{
if|if
condition|(
name|uuid_e
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No UUID-E received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|uuid_e
argument_list|,
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID-E"
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_dev_password_id
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|pw_id
parameter_list|)
block|{
if|if
condition|(
name|pw_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Device Password ID received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|dev_pw_id
operator|=
name|WPA_GET_BE16
argument_list|(
name|pw_id
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Device Password ID %d"
argument_list|,
name|wps
operator|->
name|dev_pw_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_e_hash1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_hash1
parameter_list|)
block|{
if|if
condition|(
name|e_hash1
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No E-Hash1 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|peer_hash1
argument_list|,
name|e_hash1
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-Hash1"
argument_list|,
name|wps
operator|->
name|peer_hash1
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_e_hash2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_hash2
parameter_list|)
block|{
if|if
condition|(
name|e_hash2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No E-Hash2 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|peer_hash2
argument_list|,
name|e_hash2
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-Hash2"
argument_list|,
name|wps
operator|->
name|peer_hash2
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_e_snonce1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_snonce1
parameter_list|)
block|{
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|e_snonce1
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No E-SNonce1 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-SNonce1"
argument_list|,
name|e_snonce1
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
comment|/* E-Hash1 = HMAC_AuthKey(E-S1 || PSK1 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|e_snonce1
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk1
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|WPS_PSK_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp_const
argument_list|(
name|wps
operator|->
name|peer_hash1
argument_list|,
name|hash
argument_list|,
name|WPS_HASH_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-Hash1 derived from E-S1 does "
literal|"not match with the pre-committed value"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_DEV_PASSWORD_AUTH_FAILURE
expr_stmt|;
name|wps_pwd_auth_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee proved knowledge of the first "
literal|"half of the device password"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_e_snonce2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_snonce2
parameter_list|)
block|{
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|e_snonce2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No E-SNonce2 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-SNonce2"
argument_list|,
name|e_snonce2
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
comment|/* E-Hash2 = HMAC_AuthKey(E-S2 || PSK2 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|e_snonce2
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk2
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|WPS_PSK_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp_const
argument_list|(
name|wps
operator|->
name|peer_hash2
argument_list|,
name|hash
argument_list|,
name|WPS_HASH_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-Hash2 derived from E-S2 does "
literal|"not match with the pre-committed value"
argument_list|)
expr_stmt|;
name|wps_registrar_invalidate_pin
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_DEV_PASSWORD_AUTH_FAILURE
expr_stmt|;
name|wps_pwd_auth_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee proved knowledge of the second "
literal|"half of the device password"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps_pin_revealed
operator|=
literal|0
expr_stmt|;
name|wps_registrar_unlock_pin
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
comment|/* 	 * In case wildcard PIN is used and WPS handshake succeeds in the first 	 * attempt, wps_registrar_unlock_pin() would not free the PIN, so make 	 * sure the PIN gets invalidated here. 	 */
name|wps_registrar_invalidate_pin
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_mac_addr
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|)
block|{
if|if
condition|(
name|mac_addr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No MAC Address received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee MAC Address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|peer_dev
operator|.
name|mac_addr
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_pubkey
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|pk
parameter_list|,
name|size_t
name|pk_len
parameter_list|)
block|{
if|if
condition|(
name|pk
operator|==
name|NULL
operator|||
name|pk_len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Public Key received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dh_pubkey_e
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pk
argument_list|,
name|pk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dh_pubkey_e
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_auth_type_flags
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|auth
parameter_list|)
block|{
name|u16
name|auth_types
decl_stmt|;
if|if
condition|(
name|auth
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Authentication Type flags "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|auth_types
operator|=
name|WPA_GET_BE16
argument_list|(
name|auth
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Authentication Type flags 0x%x"
argument_list|,
name|auth_types
argument_list|)
expr_stmt|;
name|wps
operator|->
name|auth_type
operator|=
name|wps
operator|->
name|wps
operator|->
name|auth_types
operator|&
name|auth_types
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|auth_type
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No match in supported "
literal|"authentication types (own 0x%x Enrollee 0x%x)"
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|auth_types
argument_list|,
name|auth_types
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
comment|/* 		 * Some deployed implementations seem to advertise incorrect 		 * information in this attribute. For example, Linksys WRT350N 		 * seems to have a byteorder bug that breaks this negotiation. 		 * In order to interoperate with existing implementations, 		 * assume that the Enrollee supports everything we do. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Workaround - assume Enrollee "
literal|"does not advertise supported authentication types "
literal|"correctly"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|auth_type
operator|=
name|wps
operator|->
name|wps
operator|->
name|auth_types
expr_stmt|;
else|#
directive|else
comment|/* WPS_WORKAROUNDS */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_encr_type_flags
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|encr
parameter_list|)
block|{
name|u16
name|encr_types
decl_stmt|;
if|if
condition|(
name|encr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Encryption Type flags "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|encr_types
operator|=
name|WPA_GET_BE16
argument_list|(
name|encr
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Encryption Type flags 0x%x"
argument_list|,
name|encr_types
argument_list|)
expr_stmt|;
name|wps
operator|->
name|encr_type
operator|=
name|wps
operator|->
name|wps
operator|->
name|encr_types
operator|&
name|encr_types
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|encr_type
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No match in supported "
literal|"encryption types (own 0x%x Enrollee 0x%x)"
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|encr_types
argument_list|,
name|encr_types
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
comment|/* 		 * Some deployed implementations seem to advertise incorrect 		 * information in this attribute. For example, Linksys WRT350N 		 * seems to have a byteorder bug that breaks this negotiation. 		 * In order to interoperate with existing implementations, 		 * assume that the Enrollee supports everything we do. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Workaround - assume Enrollee "
literal|"does not advertise supported encryption types "
literal|"correctly"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|encr_type
operator|=
name|wps
operator|->
name|wps
operator|->
name|encr_types
expr_stmt|;
else|#
directive|else
comment|/* WPS_WORKAROUNDS */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_conn_type_flags
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|conn
parameter_list|)
block|{
if|if
condition|(
name|conn
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Connection Type flags "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Connection Type flags 0x%x"
argument_list|,
operator|*
name|conn
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_config_methods
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|methods
parameter_list|)
block|{
name|u16
name|m
decl_stmt|;
if|if
condition|(
name|methods
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Config Methods received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|m
operator|=
name|WPA_GET_BE16
argument_list|(
name|methods
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Config Methods 0x%x"
literal|"%s%s%s%s%s%s%s%s%s"
argument_list|,
name|m
argument_list|,
name|m
operator|&
name|WPS_CONFIG_USBA
condition|?
literal|" [USBA]"
else|:
literal|""
argument_list|,
name|m
operator|&
name|WPS_CONFIG_ETHERNET
condition|?
literal|" [Ethernet]"
else|:
literal|""
argument_list|,
name|m
operator|&
name|WPS_CONFIG_LABEL
condition|?
literal|" [Label]"
else|:
literal|""
argument_list|,
name|m
operator|&
name|WPS_CONFIG_DISPLAY
condition|?
literal|" [Display]"
else|:
literal|""
argument_list|,
name|m
operator|&
name|WPS_CONFIG_EXT_NFC_TOKEN
condition|?
literal|" [Ext NFC Token]"
else|:
literal|""
argument_list|,
name|m
operator|&
name|WPS_CONFIG_INT_NFC_TOKEN
condition|?
literal|" [Int NFC Token]"
else|:
literal|""
argument_list|,
name|m
operator|&
name|WPS_CONFIG_NFC_INTERFACE
condition|?
literal|" [NFC]"
else|:
literal|""
argument_list|,
name|m
operator|&
name|WPS_CONFIG_PUSHBUTTON
condition|?
literal|" [PBC]"
else|:
literal|""
argument_list|,
name|m
operator|&
name|WPS_CONFIG_KEYPAD
condition|?
literal|" [Keypad]"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|m
operator|&
name|WPS_CONFIG_DISPLAY
operator|)
operator|&&
operator|!
name|wps
operator|->
name|use_psk_key
condition|)
block|{
comment|/* 		 * The Enrollee does not have a display so it is unlikely to be 		 * able to show the passphrase to a user and as such, could 		 * benefit from receiving PSK to reduce key derivation time. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Prefer PSK format key due to "
literal|"Enrollee not supporting display"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|use_psk_key
operator|=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_wps_state
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|state
parameter_list|)
block|{
if|if
condition|(
name|state
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Wi-Fi Protected Setup State "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Wi-Fi Protected Setup State %d"
argument_list|,
operator|*
name|state
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_assoc_state
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|assoc
parameter_list|)
block|{
name|u16
name|a
decl_stmt|;
if|if
condition|(
name|assoc
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Association State received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|a
operator|=
name|WPA_GET_BE16
argument_list|(
name|assoc
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Association State %d"
argument_list|,
name|a
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_config_error
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|err
parameter_list|)
block|{
name|u16
name|e
decl_stmt|;
if|if
condition|(
name|err
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Configuration Error received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|e
operator|=
name|WPA_GET_BE16
argument_list|(
name|err
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Configuration Error %d"
argument_list|,
name|e
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_registrar_p2p_dev_addr_match
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|struct
name|wps_registrar
modifier|*
name|reg
init|=
name|wps
operator|->
name|wps
operator|->
name|registrar
decl_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|reg
operator|->
name|p2p_dev_addr
argument_list|)
condition|)
return|return
literal|1
return|;
comment|/* no filtering in use */
if|if
condition|(
name|os_memcmp
argument_list|(
name|reg
operator|->
name|p2p_dev_addr
argument_list|,
name|wps
operator|->
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No match on P2P Device Address "
literal|"filtering for PBC: expected "
name|MACSTR
literal|" was "
name|MACSTR
literal|" - indicate PBC session overlap"
argument_list|,
name|MAC2STR
argument_list|(
name|reg
operator|->
name|p2p_dev_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|wps
operator|->
name|p2p_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_registrar_skip_overlap
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|struct
name|wps_registrar
modifier|*
name|reg
init|=
name|wps
operator|->
name|wps
operator|->
name|registrar
decl_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|reg
operator|->
name|p2p_dev_addr
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* no specific Enrollee selected */
if|if
condition|(
name|os_memcmp
argument_list|(
name|reg
operator|->
name|p2p_dev_addr
argument_list|,
name|wps
operator|->
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Skip PBC overlap due to selected "
literal|"Enrollee match"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M1"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M1"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|wps_process_uuid_e
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|uuid_e
argument_list|)
operator|||
name|wps_process_mac_addr
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|mac_addr
argument_list|)
operator|||
name|wps_process_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|enrollee_nonce
argument_list|)
operator|||
name|wps_process_pubkey
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|public_key
argument_list|,
name|attr
operator|->
name|public_key_len
argument_list|)
operator|||
name|wps_process_auth_type_flags
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|auth_type_flags
argument_list|)
operator|||
name|wps_process_encr_type_flags
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|encr_type_flags
argument_list|)
operator|||
name|wps_process_conn_type_flags
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|conn_type_flags
argument_list|)
operator|||
name|wps_process_config_methods
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|config_methods
argument_list|)
operator|||
name|wps_process_wps_state
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|wps_state
argument_list|)
operator|||
name|wps_process_device_attrs
argument_list|(
operator|&
name|wps
operator|->
name|peer_dev
argument_list|,
name|attr
argument_list|)
operator|||
name|wps_process_rf_bands
argument_list|(
operator|&
name|wps
operator|->
name|peer_dev
argument_list|,
name|attr
operator|->
name|rf_bands
argument_list|)
operator|||
name|wps_process_assoc_state
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|assoc_state
argument_list|)
operator|||
name|wps_process_dev_password_id
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|dev_password_id
argument_list|)
operator|||
name|wps_process_config_error
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|config_error
argument_list|)
operator|||
name|wps_process_os_version
argument_list|(
operator|&
name|wps
operator|->
name|peer_dev
argument_list|,
name|attr
operator|->
name|os_version
argument_list|)
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
name|wps
operator|->
name|dev_pw_id
operator|<
literal|0x10
operator|&&
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_DEFAULT
operator|&&
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_P2PS_DEFAULT
operator|&&
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_USER_SPECIFIED
operator|&&
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_MACHINE_SPECIFIED
operator|&&
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_REGISTRAR_SPECIFIED
operator|&&
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_NFC_CONNECTION_HANDOVER
operator|&&
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
operator|(
name|wps
operator|->
name|dev_pw_id
operator|!=
name|DEV_PW_PUSHBUTTON
operator|||
operator|!
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|pbc
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported Device Password ID %d"
argument_list|,
name|wps
operator|->
name|dev_pw_id
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M2D
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
if|if
condition|(
name|wps
operator|->
name|dev_pw_id
operator|>=
literal|0x10
operator|||
name|wps
operator|->
name|dev_pw_id
operator|==
name|DEV_PW_NFC_CONNECTION_HANDOVER
condition|)
block|{
name|struct
name|wps_nfc_pw_token
modifier|*
name|token
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|1
index|]
decl_stmt|;
name|u8
name|hash
index|[
name|WPS_HASH_LEN
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Searching for NFC token match for id=%d (ctx %p registrar %p)"
argument_list|,
name|wps
operator|->
name|dev_pw_id
argument_list|,
name|wps
operator|->
name|wps
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
name|token
operator|=
name|wps_get_nfc_pw_token
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|nfc_pw_tokens
argument_list|,
name|wps
operator|->
name|dev_pw_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|token
operator|&&
name|token
operator|->
name|peer_pk_hash_known
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Found matching NFC "
literal|"Password Token"
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|token
operator|->
name|list
argument_list|)
expr_stmt|;
name|wps
operator|->
name|nfc_pw_token
operator|=
name|token
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|attr
operator|->
name|public_key
expr_stmt|;
name|sha256_vector
argument_list|(
literal|1
argument_list|,
name|addr
argument_list|,
operator|&
name|attr
operator|->
name|public_key_len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp_const
argument_list|(
name|hash
argument_list|,
name|wps
operator|->
name|nfc_pw_token
operator|->
name|pubkey_hash
argument_list|,
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Public Key hash "
literal|"mismatch"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M2D
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_PUBLIC_KEY_HASH_MISMATCH
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|token
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Found matching NFC "
literal|"Password Token (no peer PK hash)"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|nfc_pw_token
operator|=
name|token
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wps
operator|->
name|dev_pw_id
operator|>=
literal|0x10
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw_id
operator|==
name|wps
operator|->
name|dev_pw_id
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap_nfc_dev_pw
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Found match with own NFC Password Token"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
if|if
condition|(
name|wps
operator|->
name|dev_pw_id
operator|==
name|DEV_PW_PUSHBUTTON
condition|)
block|{
if|if
condition|(
operator|(
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_pbc_overlap
operator|||
name|wps_registrar_pbc_overlap
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
operator|||
operator|!
name|wps_registrar_p2p_dev_addr_match
argument_list|(
name|wps
argument_list|)
operator|)
operator|&&
operator|!
name|wps_registrar_skip_overlap
argument_list|(
name|wps
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PBC overlap - deny PBC "
literal|"negotiation"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M2D
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_MULTIPLE_PBC_DETECTED
expr_stmt|;
name|wps_pbc_overlap_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|)
expr_stmt|;
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M1
argument_list|,
name|WPS_CFG_MULTIPLE_PBC_DETECTED
argument_list|,
name|WPS_EI_NO_ERROR
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_pbc_overlap
operator|=
literal|1
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wps_registrar_add_pbc_session
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
name|wps
operator|->
name|pbc
operator|=
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
comment|/* 	 * It looks like Mac OS X 10.6.3 and 10.6.4 do not like Network Key in 	 * passphrase format. To avoid interop issues, force PSK format to be 	 * used. 	 */
if|if
condition|(
operator|!
name|wps
operator|->
name|use_psk_key
operator|&&
name|wps
operator|->
name|peer_dev
operator|.
name|manufacturer
operator|&&
name|os_strncmp
argument_list|(
name|wps
operator|->
name|peer_dev
operator|.
name|manufacturer
argument_list|,
literal|"Apple "
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|&&
name|wps
operator|->
name|peer_dev
operator|.
name|model_name
operator|&&
name|os_strcmp
argument_list|(
name|wps
operator|->
name|peer_dev
operator|.
name|model_name
argument_list|,
literal|"AirPort"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Workaround - Force Network Key in "
literal|"PSK format"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|use_psk_key
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
name|wps
operator|->
name|state
operator|=
name|SEND_M2
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m3
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M3"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M3"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|pbc
operator|&&
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_pbc_overlap
operator|&&
operator|!
name|wps_registrar_skip_overlap
argument_list|(
name|wps
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reject negotiation due to PBC "
literal|"session overlap"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_MULTIPLE_PBC_DETECTED
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|registrar_nonce
argument_list|)
operator|||
name|wps_process_authenticator
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|authenticator
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_process_e_hash1
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|e_hash1
argument_list|)
operator|||
name|wps_process_e_hash2
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|e_hash2
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wps
operator|->
name|state
operator|=
name|SEND_M4
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m5
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|decrypted
decl_stmt|;
name|struct
name|wps_parse_attr
name|eattr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M5"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M5"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|pbc
operator|&&
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_pbc_overlap
operator|&&
operator|!
name|wps_registrar_skip_overlap
argument_list|(
name|wps
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reject negotiation due to PBC "
literal|"session overlap"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_MULTIPLE_PBC_DETECTED
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|registrar_nonce
argument_list|)
operator|||
name|wps_process_authenticator
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|authenticator
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|decrypted
operator|=
name|wps_decrypt_encr_settings
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|encr_settings
argument_list|,
name|attr
operator|->
name|encr_settings_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to decrypted Encrypted "
literal|"Settings attribute"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_validate_m5_encr
argument_list|(
name|decrypted
argument_list|,
name|attr
operator|->
name|version2
operator|!=
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing decrypted Encrypted Settings "
literal|"attribute"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|decrypted
argument_list|,
operator|&
name|eattr
argument_list|)
operator|<
literal|0
operator|||
name|wps_process_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|decrypted
argument_list|,
name|eattr
operator|.
name|key_wrap_auth
argument_list|)
operator|||
name|wps_process_e_snonce1
argument_list|(
name|wps
argument_list|,
name|eattr
operator|.
name|e_snonce1
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M6
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_sta_cred_cb
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
comment|/* 	 * Update credential to only include a single authentication and 	 * encryption type in case the AP configuration includes more than one 	 * option. 	 */
if|if
condition|(
name|wps
operator|->
name|cred
operator|.
name|auth_type
operator|&
name|WPS_AUTH_WPA2PSK
condition|)
name|wps
operator|->
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|cred
operator|.
name|auth_type
operator|&
name|WPS_AUTH_WPAPSK
condition|)
name|wps
operator|->
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPAPSK
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|&
name|WPS_ENCR_AES
condition|)
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_AES
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|&
name|WPS_ENCR_TKIP
condition|)
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_TKIP
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Update local configuration based on the "
literal|"AP configuration"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|cred_cb
condition|)
name|wps
operator|->
name|wps
operator|->
name|cred_cb
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_cred_update
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|dst
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|src
parameter_list|)
block|{
name|os_memcpy
argument_list|(
name|dst
operator|->
name|ssid
argument_list|,
name|src
operator|->
name|ssid
argument_list|,
sizeof|sizeof
argument_list|(
name|dst
operator|->
name|ssid
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|->
name|ssid_len
operator|=
name|src
operator|->
name|ssid_len
expr_stmt|;
name|dst
operator|->
name|auth_type
operator|=
name|src
operator|->
name|auth_type
expr_stmt|;
name|dst
operator|->
name|encr_type
operator|=
name|src
operator|->
name|encr_type
expr_stmt|;
name|dst
operator|->
name|key_idx
operator|=
name|src
operator|->
name|key_idx
expr_stmt|;
name|os_memcpy
argument_list|(
name|dst
operator|->
name|key
argument_list|,
name|src
operator|->
name|key
argument_list|,
sizeof|sizeof
argument_list|(
name|dst
operator|->
name|key
argument_list|)
argument_list|)
expr_stmt|;
name|dst
operator|->
name|key_len
operator|=
name|src
operator|->
name|key_len
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_ap_settings_r
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
operator|||
name|wps
operator|->
name|er
condition|)
return|return
literal|0
return|;
comment|/* AP Settings Attributes in M7 when Enrollee is an AP */
if|if
condition|(
name|wps_process_ap_settings
argument_list|(
name|attr
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Received old AP configuration from AP"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|new_ap_settings
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Update AP configuration based on "
literal|"new settings"
argument_list|)
expr_stmt|;
name|wps_cred_update
argument_list|(
operator|&
name|wps
operator|->
name|cred
argument_list|,
name|wps
operator|->
name|new_ap_settings
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
comment|/* 		 * Use the AP PIN only to receive the current AP settings, not 		 * to reconfigure the AP. 		 */
comment|/* 		 * Clear selected registrar here since we do not get to 		 * WSC_Done in this protocol run. 		 */
name|wps_registrar_pin_completed
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
name|msg
operator|=
name|wps_build_ap_cred
argument_list|(
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wps
operator|->
name|cred
operator|.
name|cred_attr
operator|=
name|wpabuf_head
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|cred_attr_len
operator|=
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|ap_settings_cb
condition|)
block|{
name|wps
operator|->
name|ap_settings_cb
argument_list|(
name|wps
operator|->
name|ap_settings_cb_ctx
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|wps_sta_cred_cb
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|cred_attr
operator|=
name|NULL
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|cred_attr_len
operator|=
literal|0
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m7
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|decrypted
decl_stmt|;
name|struct
name|wps_parse_attr
name|eattr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M7"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M7
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M7"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|pbc
operator|&&
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|force_pbc_overlap
operator|&&
operator|!
name|wps_registrar_skip_overlap
argument_list|(
name|wps
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reject negotiation due to PBC "
literal|"session overlap"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_MULTIPLE_PBC_DETECTED
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|registrar_nonce
argument_list|)
operator|||
name|wps_process_authenticator
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|authenticator
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|decrypted
operator|=
name|wps_decrypt_encr_settings
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|encr_settings
argument_list|,
name|attr
operator|->
name|encr_settings_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to decrypt Encrypted "
literal|"Settings attribute"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_validate_m7_encr
argument_list|(
name|decrypted
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ap
operator|||
name|wps
operator|->
name|er
argument_list|,
name|attr
operator|->
name|version2
operator|!=
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing decrypted Encrypted Settings "
literal|"attribute"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|decrypted
argument_list|,
operator|&
name|eattr
argument_list|)
operator|<
literal|0
operator|||
name|wps_process_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|decrypted
argument_list|,
name|eattr
operator|.
name|key_wrap_auth
argument_list|)
operator|||
name|wps_process_e_snonce2
argument_list|(
name|wps
argument_list|,
name|eattr
operator|.
name|e_snonce2
argument_list|)
operator|||
name|wps_process_ap_settings_r
argument_list|(
name|wps
argument_list|,
operator|&
name|eattr
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M8
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|enum
name|wps_process_res
name|ret
init|=
name|WPS_CONTINUE
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_MSG"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_M1
operator|&&
operator|(
name|attr
operator|.
name|registrar_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in registrar nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
switch|switch
condition|(
operator|*
name|attr
operator|.
name|msg_type
condition|)
block|{
case|case
name|WPS_M1
case|:
if|if
condition|(
name|wps_validate_m1
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|attr
operator|.
name|mac_addr
condition|)
block|{
comment|/* Remove old pending messages when starting new run */
name|wps_free_pending_msgs
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
operator|=
name|NULL
expr_stmt|;
name|upnp_wps_device_send_wlan_event
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
argument_list|,
name|attr
operator|.
name|mac_addr
argument_list|,
name|UPNP_WPS_WLANEVENT_TYPE_EAP
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|ret
operator|=
name|wps_process_m1
argument_list|(
name|wps
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_M3
case|:
if|if
condition|(
name|wps_validate_m3
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
name|ret
operator|=
name|wps_process_m3
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
operator|||
name|wps
operator|->
name|state
operator|==
name|SEND_WSC_NACK
condition|)
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M3
argument_list|,
name|wps
operator|->
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_M5
case|:
if|if
condition|(
name|wps_validate_m5
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
name|ret
operator|=
name|wps_process_m5
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
operator|||
name|wps
operator|->
name|state
operator|==
name|SEND_WSC_NACK
condition|)
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M5
argument_list|,
name|wps
operator|->
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_M7
case|:
if|if
condition|(
name|wps_validate_m7
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
name|ret
operator|=
name|wps_process_m7
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
operator|||
name|wps
operator|->
name|state
operator|==
name|SEND_WSC_NACK
condition|)
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M7
argument_list|,
name|wps
operator|->
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|ret
operator|==
name|WPS_CONTINUE
condition|)
block|{
comment|/* Save a copy of the last message for Authenticator derivation 		 */
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|last_msg
argument_list|)
expr_stmt|;
name|wps
operator|->
name|last_msg
operator|=
name|wpabuf_dup
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_ack
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_ACK"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_WSC_ACK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|wps
operator|->
name|ext_reg
operator|&&
name|wps
operator|->
name|state
operator|==
name|RECV_M2D_ACK
operator|&&
name|upnp_wps_subscribers
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
argument_list|)
condition|)
block|{
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
condition|)
return|return
name|WPS_CONTINUE
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Wait for response from an "
literal|"external Registrar"
argument_list|)
expr_stmt|;
return|return
name|WPS_PENDING
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
if|if
condition|(
name|attr
operator|.
name|registrar_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in registrar nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|enrollee_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|attr
operator|.
name|enrollee_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in enrollee nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|state
operator|==
name|RECV_M2D_ACK
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|upnp_wps_subscribers
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
argument_list|)
condition|)
block|{
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
condition|)
return|return
name|WPS_CONTINUE
return|;
if|if
condition|(
name|wps
operator|->
name|ext_reg
operator|==
literal|0
condition|)
name|wps
operator|->
name|ext_reg
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Wait for response from an "
literal|"external Registrar"
argument_list|)
expr_stmt|;
return|return
name|WPS_PENDING
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No more registrars available - "
literal|"terminate negotiation"
argument_list|)
expr_stmt|;
block|}
return|return
name|WPS_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_nack
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|int
name|old_state
decl_stmt|;
name|u16
name|config_error
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_NACK"
argument_list|)
expr_stmt|;
name|old_state
operator|=
name|wps
operator|->
name|state
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_WSC_NACK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|wps
operator|->
name|ext_reg
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Negotiation using external "
literal|"Registrar terminated by the Enrollee"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
if|if
condition|(
name|attr
operator|.
name|registrar_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in registrar nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|enrollee_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|attr
operator|.
name|enrollee_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in enrollee nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|config_error
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Configuration Error attribute "
literal|"in WSC_NACK"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
name|config_error
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|config_error
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee terminated negotiation with "
literal|"Configuration Error %d"
argument_list|,
name|config_error
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|old_state
condition|)
block|{
case|case
name|RECV_M3
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M2
argument_list|,
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
break|break;
case|case
name|RECV_M5
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M4
argument_list|,
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
break|break;
case|case
name|RECV_M7
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M6
argument_list|,
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
break|break;
case|case
name|RECV_DONE
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M8
argument_list|,
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
return|return
name|WPS_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_done
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_Done"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_DONE
operator|&&
operator|(
operator|!
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|||
operator|!
name|wps
operator|->
name|ext_reg
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving WSC_Done"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_WSC_DONE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|wps
operator|->
name|ext_reg
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Negotiation using external "
literal|"Registrar completed successfully"
argument_list|)
expr_stmt|;
name|wps_device_store
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
operator|&
name|wps
operator|->
name|peer_dev
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
return|return
name|WPS_DONE
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
if|if
condition|(
name|attr
operator|.
name|registrar_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in registrar nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|enrollee_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|attr
operator|.
name|enrollee_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in enrollee nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Negotiation completed successfully"
argument_list|)
expr_stmt|;
name|wps_device_store
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
operator|&
name|wps
operator|->
name|peer_dev
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_state
operator|==
name|WPS_STATE_NOT_CONFIGURED
operator|&&
name|wps
operator|->
name|new_psk
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
operator|!
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|disable_auto_conf
condition|)
block|{
name|struct
name|wps_credential
name|cred
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Moving to Configured state based "
literal|"on first Enrollee connection"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|cred
operator|.
name|ssid
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|cred
operator|.
name|ssid_len
operator|=
name|wps
operator|->
name|wps
operator|->
name|ssid_len
expr_stmt|;
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPAPSK
operator||
name|WPS_AUTH_WPA2PSK
expr_stmt|;
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_TKIP
operator||
name|WPS_ENCR_AES
expr_stmt|;
name|os_memcpy
argument_list|(
name|cred
operator|.
name|key
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
name|cred
operator|.
name|key_len
operator|=
name|wps
operator|->
name|new_psk_len
expr_stmt|;
name|wps
operator|->
name|wps
operator|->
name|wps_state
operator|=
name|WPS_STATE_CONFIGURED
expr_stmt|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Generated random passphrase"
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|cred_cb
condition|)
name|wps
operator|->
name|wps
operator|->
name|cred_cb
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|,
operator|&
name|cred
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps
operator|->
name|new_psk
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
operator|!
name|wps
operator|->
name|er
condition|)
name|wps_sta_cred_cb
argument_list|(
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|new_psk
condition|)
block|{
if|if
condition|(
name|wps_cb_new_psk
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|wps
operator|->
name|p2p_dev_addr
argument_list|,
name|wps
operator|->
name|new_psk
argument_list|,
name|wps
operator|->
name|new_psk_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to configure the "
literal|"new PSK"
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wps
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps
operator|->
name|new_psk
operator|=
name|NULL
expr_stmt|;
block|}
name|wps_cb_reg_success
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|,
name|wps
operator|->
name|dev_password
argument_list|,
name|wps
operator|->
name|dev_password_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|pbc
condition|)
block|{
name|wps_registrar_remove_pbc_session
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|,
name|wps
operator|->
name|p2p_dev_addr
argument_list|)
expr_stmt|;
name|wps_registrar_pbc_completed
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
name|os_get_reltime
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|pbc_ignore_start
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
name|os_memcpy
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
operator|->
name|pbc_ignore_uuid
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wps_registrar_pin_completed
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
block|}
comment|/* TODO: maintain AuthorizedMACs somewhere separately for each ER and 	 * merge them into APs own list.. */
name|wps_success_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
return|return
name|WPS_DONE
return|;
block|}
end_function

begin_function
name|enum
name|wps_process_res
name|wps_registrar_process_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|enum
name|wsc_op_code
name|op_code
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|enum
name|wps_process_res
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing received message (len=%lu "
literal|"op_code=%d)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
argument_list|,
name|op_code
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|op_code
operator|==
name|WSC_MSG
operator|&&
name|wps
operator|->
name|ext_reg
operator|==
literal|1
condition|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|==
literal|0
operator|&&
name|attr
operator|.
name|msg_type
operator|&&
operator|*
name|attr
operator|.
name|msg_type
operator|==
name|WPS_M3
condition|)
name|wps
operator|->
name|ext_reg
operator|=
literal|2
expr_stmt|;
comment|/* past M2/M2D phase */
block|}
if|if
condition|(
name|wps
operator|->
name|ext_reg
operator|>
literal|1
condition|)
name|wps_registrar_free_pending_m2
argument_list|(
name|wps
operator|->
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|wps
operator|->
name|ext_reg
operator|&&
name|wps
operator|->
name|wps
operator|->
name|upnp_msgs
operator|==
name|NULL
operator|&&
operator|(
name|op_code
operator|==
name|WSC_MSG
operator|||
name|op_code
operator|==
name|WSC_Done
operator|||
name|op_code
operator|==
name|WSC_NACK
operator|)
condition|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|int
name|type
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
operator|||
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
name|type
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|type
operator|=
operator|*
name|attr
operator|.
name|msg_type
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Sending received message (type %d)"
literal|" to external Registrar for processing"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|upnp_wps_device_send_wlan_event
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|UPNP_WPS_WLANEVENT_TYPE_EAP
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_code
operator|==
name|WSC_MSG
condition|)
return|return
name|WPS_PENDING
return|;
block|}
elseif|else
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|wps_upnp
operator|&&
name|wps
operator|->
name|ext_reg
operator|&&
name|op_code
operator|==
name|WSC_MSG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Skip internal processing - using "
literal|"external Registrar"
argument_list|)
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
switch|switch
condition|(
name|op_code
condition|)
block|{
case|case
name|WSC_MSG
case|:
return|return
name|wps_process_wsc_msg
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
return|;
case|case
name|WSC_ACK
case|:
if|if
condition|(
name|wps_validate_wsc_ack
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
return|return
name|wps_process_wsc_ack
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
return|;
case|case
name|WSC_NACK
case|:
if|if
condition|(
name|wps_validate_wsc_nack
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
return|return
name|wps_process_wsc_nack
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
return|;
case|case
name|WSC_Done
case|:
if|if
condition|(
name|wps_validate_wsc_done
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
name|ret
operator|=
name|wps_process_wsc_done
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_WSC_DONE
argument_list|,
name|wps
operator|->
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported op_code %d"
argument_list|,
name|op_code
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
block|}
end_function

begin_function
name|int
name|wps_registrar_update_ie
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
return|return
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_registrar_set_selected_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wps_registrar
modifier|*
name|reg
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Selected Registrar timeout - "
literal|"unselect internal Registrar"
argument_list|)
expr_stmt|;
name|reg
operator|->
name|selected_registrar
operator|=
literal|0
expr_stmt|;
name|reg
operator|->
name|pbc
operator|=
literal|0
expr_stmt|;
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
end_ifdef

begin_function
specifier|static
name|void
name|wps_registrar_sel_reg_add
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|subscription
modifier|*
name|s
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: External Registrar selected (dev_pw_id=%d "
literal|"config_methods=0x%x)"
argument_list|,
name|s
operator|->
name|dev_password_id
argument_list|,
name|s
operator|->
name|config_methods
argument_list|)
expr_stmt|;
name|reg
operator|->
name|sel_reg_union
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|!=
name|DEV_PW_PUSHBUTTON
condition|)
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|=
name|s
operator|->
name|dev_password_id
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|sel_reg_config_methods_override
operator|==
operator|-
literal|1
condition|)
name|reg
operator|->
name|sel_reg_config_methods_override
operator|=
literal|0
expr_stmt|;
name|reg
operator|->
name|sel_reg_config_methods_override
operator||=
name|s
operator|->
name|config_methods
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|WPS_MAX_AUTHORIZED_MACS
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|reg
operator|->
name|authorized_macs_union
index|[
name|i
index|]
argument_list|)
condition|)
break|break;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|WPS_MAX_AUTHORIZED_MACS
operator|&&
name|j
operator|<
name|WPS_MAX_AUTHORIZED_MACS
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|s
operator|->
name|authorized_macs
index|[
name|j
index|]
argument_list|)
condition|)
break|break;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Add authorized MAC into union: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|s
operator|->
name|authorized_macs
index|[
name|j
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|reg
operator|->
name|authorized_macs_union
index|[
name|i
index|]
argument_list|,
name|s
operator|->
name|authorized_macs
index|[
name|j
index|]
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authorized MACs union"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|reg
operator|->
name|authorized_macs_union
argument_list|,
sizeof|sizeof
argument_list|(
name|reg
operator|->
name|authorized_macs_union
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_UPNP */
end_comment

begin_function
specifier|static
name|void
name|wps_registrar_sel_reg_union
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
name|struct
name|subscription
modifier|*
name|s
decl_stmt|;
if|if
condition|(
name|reg
operator|->
name|wps
operator|->
name|wps_upnp
operator|==
name|NULL
condition|)
return|return;
name|dl_list_for_each
argument_list|(
argument|s
argument_list|,
argument|&reg->wps->wps_upnp->subscriptions
argument_list|,
argument|struct subscription
argument_list|,
argument|list
argument_list|)
block|{
name|struct
name|subscr_addr
modifier|*
name|sa
decl_stmt|;
name|sa
operator|=
name|dl_list_first
argument_list|(
operator|&
name|s
operator|->
name|addr_list
argument_list|,
expr|struct
name|subscr_addr
argument_list|,
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|sa
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: External Registrar %s:%d"
argument_list|,
name|inet_ntoa
argument_list|(
name|sa
operator|->
name|saddr
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|sa
operator|->
name|saddr
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|->
name|selected_registrar
condition|)
name|wps_registrar_sel_reg_add
argument_list|(
name|reg
argument_list|,
name|s
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: External Registrar not "
literal|"selected"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
block|}
end_function

begin_comment
comment|/**  * wps_registrar_selected_registrar_changed - SetSelectedRegistrar change  * @reg: Registrar data from wps_registrar_init()  *  * This function is called when selected registrar state changes, e.g., when an  * AP receives a SetSelectedRegistrar UPnP message.  */
end_comment

begin_function
name|void
name|wps_registrar_selected_registrar_changed
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|u16
name|dev_pw_id
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Selected registrar information changed"
argument_list|)
expr_stmt|;
name|reg
operator|->
name|sel_reg_union
operator|=
name|reg
operator|->
name|selected_registrar
expr_stmt|;
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|=
operator|-
literal|1
expr_stmt|;
name|reg
operator|->
name|sel_reg_config_methods_override
operator|=
operator|-
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|reg
operator|->
name|authorized_macs_union
argument_list|,
name|reg
operator|->
name|authorized_macs
argument_list|,
name|WPS_MAX_AUTHORIZED_MACS
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authorized MACs union (start with own)"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|reg
operator|->
name|authorized_macs_union
argument_list|,
sizeof|sizeof
argument_list|(
name|reg
operator|->
name|authorized_macs_union
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|selected_registrar
condition|)
block|{
name|u16
name|methods
decl_stmt|;
name|methods
operator|=
name|reg
operator|->
name|wps
operator|->
name|config_methods
operator|&
operator|~
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
name|methods
operator|&=
operator|~
operator|(
name|WPS_CONFIG_VIRT_PUSHBUTTON
operator||
name|WPS_CONFIG_PHY_PUSHBUTTON
operator|)
expr_stmt|;
if|if
condition|(
name|reg
operator|->
name|pbc
condition|)
block|{
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|=
name|DEV_PW_PUSHBUTTON
expr_stmt|;
name|wps_set_pushbutton
argument_list|(
operator|&
name|methods
argument_list|,
name|reg
operator|->
name|wps
operator|->
name|config_methods
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|dev_pw_id
condition|)
name|reg
operator|->
name|sel_reg_dev_password_id_override
operator|=
name|dev_pw_id
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Internal Registrar selected "
literal|"(pbc=%d)"
argument_list|,
name|reg
operator|->
name|pbc
argument_list|)
expr_stmt|;
name|reg
operator|->
name|sel_reg_config_methods_override
operator|=
name|methods
expr_stmt|;
block|}
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Internal Registrar not selected"
argument_list|)
expr_stmt|;
name|wps_registrar_sel_reg_union
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|wps_set_ie
argument_list|(
name|reg
argument_list|)
expr_stmt|;
name|wps_cb_set_sel_reg
argument_list|(
name|reg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wps_registrar_get_info
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|wps_registrar_device
modifier|*
name|d
decl_stmt|;
name|int
name|len
init|=
literal|0
decl_stmt|,
name|ret
decl_stmt|;
name|char
name|uuid
index|[
literal|40
index|]
decl_stmt|;
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|d
operator|=
name|wps_device_get
argument_list|(
name|reg
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|d
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|uuid_bin2str
argument_list|(
name|d
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid
argument_list|)
argument_list|)
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|buf
operator|+
name|len
argument_list|,
name|buflen
operator|-
name|len
argument_list|,
literal|"wpsUuid=%s\n"
literal|"wpsPrimaryDeviceType=%s\n"
literal|"wpsDeviceName=%s\n"
literal|"wpsManufacturer=%s\n"
literal|"wpsModelName=%s\n"
literal|"wpsModelNumber=%s\n"
literal|"wpsSerialNumber=%s\n"
argument_list|,
name|uuid
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|d
operator|->
name|dev
operator|.
name|pri_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|,
name|d
operator|->
name|dev
operator|.
name|device_name
condition|?
name|d
operator|->
name|dev
operator|.
name|device_name
else|:
literal|""
argument_list|,
name|d
operator|->
name|dev
operator|.
name|manufacturer
condition|?
name|d
operator|->
name|dev
operator|.
name|manufacturer
else|:
literal|""
argument_list|,
name|d
operator|->
name|dev
operator|.
name|model_name
condition|?
name|d
operator|->
name|dev
operator|.
name|model_name
else|:
literal|""
argument_list|,
name|d
operator|->
name|dev
operator|.
name|model_number
condition|?
name|d
operator|->
name|dev
operator|.
name|model_number
else|:
literal|""
argument_list|,
name|d
operator|->
name|dev
operator|.
name|serial_number
condition|?
name|d
operator|->
name|dev
operator|.
name|serial_number
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|buflen
operator|-
name|len
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|len
return|;
name|len
operator|+=
name|ret
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|int
name|wps_registrar_config_ap
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: encr_type=0x%x"
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|cred
operator|->
name|encr_type
operator|&
operator|(
name|WPS_ENCR_NONE
operator||
name|WPS_ENCR_TKIP
operator||
name|WPS_ENCR_AES
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|cred
operator|->
name|encr_type
operator|&
name|WPS_ENCR_WEP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Reject new AP settings "
literal|"due to WEP configuration"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Reject new AP settings due to "
literal|"invalid encr_type 0x%x"
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|cred
operator|->
name|encr_type
operator|&
operator|(
name|WPS_ENCR_TKIP
operator||
name|WPS_ENCR_AES
operator|)
operator|)
operator|==
name|WPS_ENCR_TKIP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Upgrade encr_type TKIP -> "
literal|"TKIP+AES"
argument_list|)
expr_stmt|;
name|cred
operator|->
name|encr_type
operator||=
name|WPS_ENCR_AES
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPAPSK
operator||
name|WPS_AUTH_WPA2PSK
operator|)
operator|)
operator|==
name|WPS_AUTH_WPAPSK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Upgrade auth_type WPAPSK -> "
literal|"WPAPSK+WPA2PSK"
argument_list|)
expr_stmt|;
name|cred
operator|->
name|auth_type
operator||=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
block|}
if|if
condition|(
name|reg
operator|->
name|wps
operator|->
name|cred_cb
condition|)
return|return
name|reg
operator|->
name|wps
operator|->
name|cred_cb
argument_list|(
name|reg
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|,
name|cred
argument_list|)
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
end_ifdef

begin_function
name|int
name|wps_registrar_add_nfc_pw_token
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|pubkey_hash
parameter_list|,
name|u16
name|pw_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_pw
parameter_list|,
name|size_t
name|dev_pw_len
parameter_list|,
name|int
name|pk_hash_provided_oob
parameter_list|)
block|{
name|struct
name|wps_nfc_pw_token
modifier|*
name|token
decl_stmt|;
if|if
condition|(
name|dev_pw_len
operator|>
name|WPS_OOB_DEVICE_PASSWORD_LEN
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|pw_id
operator|==
name|DEV_PW_NFC_CONNECTION_HANDOVER
operator|&&
operator|(
name|pubkey_hash
operator|==
name|NULL
operator|||
operator|!
name|pk_hash_provided_oob
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected NFC Password Token "
literal|"addition - missing public key hash"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps_free_nfc_pw_tokens
argument_list|(
operator|&
name|reg
operator|->
name|nfc_pw_tokens
argument_list|,
name|pw_id
argument_list|)
expr_stmt|;
name|token
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|token
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|token
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|token
operator|->
name|peer_pk_hash_known
operator|=
name|pubkey_hash
operator|!=
name|NULL
expr_stmt|;
if|if
condition|(
name|pubkey_hash
condition|)
name|os_memcpy
argument_list|(
name|token
operator|->
name|pubkey_hash
argument_list|,
name|pubkey_hash
argument_list|,
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
name|token
operator|->
name|pw_id
operator|=
name|pw_id
expr_stmt|;
name|token
operator|->
name|pk_hash_provided_oob
operator|=
name|pk_hash_provided_oob
expr_stmt|;
if|if
condition|(
name|dev_pw
condition|)
block|{
name|wpa_snprintf_hex_uppercase
argument_list|(
operator|(
name|char
operator|*
operator|)
name|token
operator|->
name|dev_pw
argument_list|,
sizeof|sizeof
argument_list|(
name|token
operator|->
name|dev_pw
argument_list|)
argument_list|,
name|dev_pw
argument_list|,
name|dev_pw_len
argument_list|)
expr_stmt|;
name|token
operator|->
name|dev_pw_len
operator|=
name|dev_pw_len
operator|*
literal|2
expr_stmt|;
block|}
name|dl_list_add
argument_list|(
operator|&
name|reg
operator|->
name|nfc_pw_tokens
argument_list|,
operator|&
name|token
operator|->
name|list
argument_list|)
expr_stmt|;
name|reg
operator|->
name|selected_registrar
operator|=
literal|1
expr_stmt|;
name|reg
operator|->
name|pbc
operator|=
literal|0
expr_stmt|;
name|wps_registrar_add_authorized_mac
argument_list|(
name|reg
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|)
expr_stmt|;
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|,
name|pw_id
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wps_registrar_set_selected_timeout
argument_list|,
name|reg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Added NFC Device Password %u to Registrar"
argument_list|,
name|pw_id
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wps_registrar_add_nfc_password_token
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
specifier|const
name|u8
modifier|*
name|oob_dev_pw
parameter_list|,
name|size_t
name|oob_dev_pw_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|hash
decl_stmt|,
modifier|*
name|dev_pw
decl_stmt|;
name|u16
name|id
decl_stmt|;
name|size_t
name|dev_pw_len
decl_stmt|;
if|if
condition|(
name|oob_dev_pw_len
operator|<
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|2
operator|||
name|oob_dev_pw_len
operator|>
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|2
operator|+
name|WPS_OOB_DEVICE_PASSWORD_LEN
condition|)
return|return
operator|-
literal|1
return|;
name|hash
operator|=
name|oob_dev_pw
expr_stmt|;
name|pos
operator|=
name|oob_dev_pw
operator|+
name|WPS_OOB_PUBKEY_HASH_LEN
expr_stmt|;
name|id
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|dev_pw
operator|=
name|pos
operator|+
literal|2
expr_stmt|;
name|dev_pw_len
operator|=
name|oob_dev_pw
operator|+
name|oob_dev_pw_len
operator|-
name|dev_pw
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Add NFC Password Token for Password ID %u"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Public Key Hash"
argument_list|,
name|hash
argument_list|,
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Device Password"
argument_list|,
name|dev_pw
argument_list|,
name|dev_pw_len
argument_list|)
expr_stmt|;
return|return
name|wps_registrar_add_nfc_pw_token
argument_list|(
name|reg
argument_list|,
name|hash
argument_list|,
name|id
argument_list|,
name|dev_pw
argument_list|,
name|dev_pw_len
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wps_registrar_remove_nfc_pw_token
parameter_list|(
name|struct
name|wps_registrar
modifier|*
name|reg
parameter_list|,
name|struct
name|wps_nfc_pw_token
modifier|*
name|token
parameter_list|)
block|{
name|wps_registrar_remove_authorized_mac
argument_list|(
name|reg
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|"\xff\xff\xff\xff\xff\xff"
argument_list|)
expr_stmt|;
name|wps_registrar_selected_registrar_changed
argument_list|(
name|reg
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* 	 * Free the NFC password token if it was used only for a single protocol 	 * run. The static handover case uses the same password token multiple 	 * times, so do not free that case here. 	 */
if|if
condition|(
name|token
operator|->
name|peer_pk_hash_known
condition|)
name|os_free
argument_list|(
name|token
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_NFC */
end_comment

end_unit


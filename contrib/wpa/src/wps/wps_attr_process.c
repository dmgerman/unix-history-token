begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Protected Setup - attribute processing  * Copyright (c) 2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"sha256.h"
end_include

begin_include
include|#
directive|include
file|"wps_i.h"
end_include

begin_function
name|int
name|wps_process_authenticator
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|authenticator
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|2
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|authenticator
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Authenticator attribute "
literal|"included"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|last_msg
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Last message not available for "
literal|"validating authenticator"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Authenticator = HMAC-SHA256_AuthKey(M_prev || M_curr*) 	 * (M_curr* is M_curr without the Authenticator attribute) 	 */
name|addr
index|[
literal|0
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|last_msg
argument_list|)
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|last_msg
argument_list|)
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wpabuf_head
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
operator|-
literal|4
operator|-
name|WPS_AUTHENTICATOR_LEN
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|2
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|hash
argument_list|,
name|authenticator
argument_list|,
name|WPS_AUTHENTICATOR_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Incorrect Authenticator"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wps_process_key_wrap_auth
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
specifier|const
name|u8
modifier|*
name|key_wrap_auth
parameter_list|)
block|{
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|head
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|key_wrap_auth
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No KWA in decrypted attribute"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|head
operator|=
name|wpabuf_head
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
operator|-
literal|4
operator|-
name|WPS_KWA_LEN
expr_stmt|;
if|if
condition|(
name|head
operator|+
name|len
operator|!=
name|key_wrap_auth
operator|-
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: KWA not in the end of the "
literal|"decrypted attribute"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hmac_sha256
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
name|head
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|hash
argument_list|,
name|key_wrap_auth
argument_list|,
name|WPS_KWA_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid KWA"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_network_idx
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|idx
parameter_list|)
block|{
if|if
condition|(
name|idx
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Credential did not include "
literal|"Network Index"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network Index: %d"
argument_list|,
operator|*
name|idx
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_ssid
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Credential did not include SSID"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Remove zero-padding since some Registrar implementations seem to use 	 * hardcoded 32-octet length for this attribute */
while|while
condition|(
name|ssid_len
operator|>
literal|0
operator|&&
name|ssid
index|[
name|ssid_len
operator|-
literal|1
index|]
operator|==
literal|0
condition|)
name|ssid_len
operator|--
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: SSID"
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid_len
operator|<=
sizeof|sizeof
argument_list|(
name|cred
operator|->
name|ssid
argument_list|)
condition|)
block|{
name|os_memcpy
argument_list|(
name|cred
operator|->
name|ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|cred
operator|->
name|ssid_len
operator|=
name|ssid_len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_auth_type
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|auth_type
parameter_list|)
block|{
if|if
condition|(
name|auth_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Credential did not include "
literal|"Authentication Type"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cred
operator|->
name|auth_type
operator|=
name|WPA_GET_BE16
argument_list|(
name|auth_type
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authentication Type: 0x%x"
argument_list|,
name|cred
operator|->
name|auth_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_encr_type
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|encr_type
parameter_list|)
block|{
if|if
condition|(
name|encr_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Credential did not include "
literal|"Encryption Type"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cred
operator|->
name|encr_type
operator|=
name|WPA_GET_BE16
argument_list|(
name|encr_type
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Encryption Type: 0x%x"
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_network_key_idx
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|key_idx
parameter_list|)
block|{
if|if
condition|(
name|key_idx
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* optional attribute */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network Key Index: %d"
argument_list|,
operator|*
name|key_idx
argument_list|)
expr_stmt|;
name|cred
operator|->
name|key_idx
operator|=
operator|*
name|key_idx
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_network_key
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Credential did not include "
literal|"Network Key"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network Key"
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|key_len
operator|<=
sizeof|sizeof
argument_list|(
name|cred
operator|->
name|key
argument_list|)
condition|)
block|{
name|os_memcpy
argument_list|(
name|cred
operator|->
name|key
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|cred
operator|->
name|key_len
operator|=
name|key_len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_mac_addr
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|)
block|{
if|if
condition|(
name|mac_addr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Credential did not include "
literal|"MAC Address"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MAC Address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|cred
operator|->
name|mac_addr
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_eap_type
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|eap_type
parameter_list|,
name|size_t
name|eap_type_len
parameter_list|)
block|{
if|if
condition|(
name|eap_type
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* optional attribute */
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: EAP Type"
argument_list|,
name|eap_type
argument_list|,
name|eap_type_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_eap_identity
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|identity
parameter_list|,
name|size_t
name|identity_len
parameter_list|)
block|{
if|if
condition|(
name|identity
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* optional attribute */
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: EAP Identity"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_key_prov_auto
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|key_prov_auto
parameter_list|)
block|{
if|if
condition|(
name|key_prov_auto
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* optional attribute */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Key Provided Automatically: %d"
argument_list|,
operator|*
name|key_prov_auto
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_802_1x_enabled
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|dot1x_enabled
parameter_list|)
block|{
if|if
condition|(
name|dot1x_enabled
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* optional attribute */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: 802.1X Enabled: %d"
argument_list|,
operator|*
name|dot1x_enabled
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_workaround_cred_key
parameter_list|(
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPAPSK
operator||
name|WPS_AUTH_WPA2PSK
operator|)
operator|&&
name|cred
operator|->
name|key_len
operator|>
literal|8
operator|&&
name|cred
operator|->
name|key_len
operator|<
literal|64
operator|&&
name|cred
operator|->
name|key
index|[
name|cred
operator|->
name|key_len
operator|-
literal|1
index|]
operator|==
literal|0
condition|)
block|{
comment|/* 		 * A deployed external registrar is known to encode ASCII 		 * passphrases incorrectly. Remove the extra NULL termination 		 * to fix the encoding. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Workaround - remove NULL "
literal|"termination from ASCII passphrase"
argument_list|)
expr_stmt|;
name|cred
operator|->
name|key_len
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wps_process_cred
parameter_list|(
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Process Credential"
argument_list|)
expr_stmt|;
comment|/* TODO: support multiple Network Keys */
if|if
condition|(
name|wps_process_cred_network_idx
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|network_idx
argument_list|)
operator|||
name|wps_process_cred_ssid
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|ssid
argument_list|,
name|attr
operator|->
name|ssid_len
argument_list|)
operator|||
name|wps_process_cred_auth_type
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|auth_type
argument_list|)
operator|||
name|wps_process_cred_encr_type
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|encr_type
argument_list|)
operator|||
name|wps_process_cred_network_key_idx
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|network_key_idx
argument_list|)
operator|||
name|wps_process_cred_network_key
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|network_key
argument_list|,
name|attr
operator|->
name|network_key_len
argument_list|)
operator|||
name|wps_process_cred_mac_addr
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|mac_addr
argument_list|)
operator|||
name|wps_process_cred_eap_type
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|eap_type
argument_list|,
name|attr
operator|->
name|eap_type_len
argument_list|)
operator|||
name|wps_process_cred_eap_identity
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|eap_identity
argument_list|,
name|attr
operator|->
name|eap_identity_len
argument_list|)
operator|||
name|wps_process_cred_key_prov_auto
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|key_prov_auto
argument_list|)
operator|||
name|wps_process_cred_802_1x_enabled
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|dot1x_enabled
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wps_workaround_cred_key
argument_list|(
name|cred
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wps_process_ap_settings
parameter_list|(
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing AP Settings"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cred
argument_list|)
argument_list|)
expr_stmt|;
comment|/* TODO: optional attributes New Password and Device Password ID */
if|if
condition|(
name|wps_process_cred_ssid
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|ssid
argument_list|,
name|attr
operator|->
name|ssid_len
argument_list|)
operator|||
name|wps_process_cred_auth_type
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|auth_type
argument_list|)
operator|||
name|wps_process_cred_encr_type
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|encr_type
argument_list|)
operator|||
name|wps_process_cred_network_key_idx
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|network_key_idx
argument_list|)
operator|||
name|wps_process_cred_network_key
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|network_key
argument_list|,
name|attr
operator|->
name|network_key_len
argument_list|)
operator|||
name|wps_process_cred_mac_addr
argument_list|(
name|cred
argument_list|,
name|attr
operator|->
name|mac_addr
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wps_workaround_cred_key
argument_list|(
name|cred
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


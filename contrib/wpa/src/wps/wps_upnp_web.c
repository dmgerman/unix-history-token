begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * UPnP WPS Device - Web connections  * Copyright (c) 2000-2003 Intel Corporation  * Copyright (c) 2006-2007 Sony Corporation  * Copyright (c) 2008-2009 Atheros Communications  * Copyright (c) 2009, Jouni Malinen<j@w1.fi>  *  * See wps_upnp.c for more details on licensing and code history.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"base64.h"
end_include

begin_include
include|#
directive|include
file|"uuid.h"
end_include

begin_include
include|#
directive|include
file|"httpread.h"
end_include

begin_include
include|#
directive|include
file|"http_server.h"
end_include

begin_include
include|#
directive|include
file|"wps_i.h"
end_include

begin_include
include|#
directive|include
file|"wps_upnp.h"
end_include

begin_include
include|#
directive|include
file|"wps_upnp_i.h"
end_include

begin_include
include|#
directive|include
file|"upnp_xml.h"
end_include

begin_comment
comment|/***************************************************************************  * Web connections (we serve pages of info about ourselves, handle  * requests, etc. etc.).  **************************************************************************/
end_comment

begin_define
define|#
directive|define
name|WEB_CONNECTION_TIMEOUT_SEC
value|30
end_define

begin_comment
comment|/* Drop web connection after t.o. */
end_comment

begin_define
define|#
directive|define
name|WEB_CONNECTION_MAX_READ
value|8000
end_define

begin_comment
comment|/* Max we'll read for TCP request */
end_comment

begin_define
define|#
directive|define
name|MAX_WEB_CONNECTIONS
value|10
end_define

begin_comment
comment|/* max simultaneous web connects */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|urn_wfawlanconfig
init|=
literal|"urn:schemas-wifialliance-org:service:WFAWLANConfig:1"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|http_server_hdr
init|=
literal|"Server: unspecified, UPnP/1.0, unspecified\r\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|http_connection_close
init|=
literal|"Connection: close\r\n"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * "Files" that we serve via HTTP. The format of these files is given by  * WFA WPS specifications. Extra white space has been removed to save space.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
name|wps_scpd_xml
index|[]
init|=
literal|"<?xml version=\"1.0\"?>\n"
literal|"<scpd xmlns=\"urn:schemas-upnp-org:service-1-0\">\n"
literal|"<specVersion><major>1</major><minor>0</minor></specVersion>\n"
literal|"<actionList>\n"
literal|"<action>\n"
literal|"<name>GetDeviceInfo</name>\n"
literal|"<argumentList>\n"
literal|"<argument>\n"
literal|"<name>NewDeviceInfo</name>\n"
literal|"<direction>out</direction>\n"
literal|"<relatedStateVariable>DeviceInfo</relatedStateVariable>\n"
literal|"</argument>\n"
literal|"</argumentList>\n"
literal|"</action>\n"
literal|"<action>\n"
literal|"<name>PutMessage</name>\n"
literal|"<argumentList>\n"
literal|"<argument>\n"
literal|"<name>NewInMessage</name>\n"
literal|"<direction>in</direction>\n"
literal|"<relatedStateVariable>InMessage</relatedStateVariable>\n"
literal|"</argument>\n"
literal|"<argument>\n"
literal|"<name>NewOutMessage</name>\n"
literal|"<direction>out</direction>\n"
literal|"<relatedStateVariable>OutMessage</relatedStateVariable>\n"
literal|"</argument>\n"
literal|"</argumentList>\n"
literal|"</action>\n"
literal|"<action>\n"
literal|"<name>PutWLANResponse</name>\n"
literal|"<argumentList>\n"
literal|"<argument>\n"
literal|"<name>NewMessage</name>\n"
literal|"<direction>in</direction>\n"
literal|"<relatedStateVariable>Message</relatedStateVariable>\n"
literal|"</argument>\n"
literal|"<argument>\n"
literal|"<name>NewWLANEventType</name>\n"
literal|"<direction>in</direction>\n"
literal|"<relatedStateVariable>WLANEventType</relatedStateVariable>\n"
literal|"</argument>\n"
literal|"<argument>\n"
literal|"<name>NewWLANEventMAC</name>\n"
literal|"<direction>in</direction>\n"
literal|"<relatedStateVariable>WLANEventMAC</relatedStateVariable>\n"
literal|"</argument>\n"
literal|"</argumentList>\n"
literal|"</action>\n"
literal|"<action>\n"
literal|"<name>SetSelectedRegistrar</name>\n"
literal|"<argumentList>\n"
literal|"<argument>\n"
literal|"<name>NewMessage</name>\n"
literal|"<direction>in</direction>\n"
literal|"<relatedStateVariable>Message</relatedStateVariable>\n"
literal|"</argument>\n"
literal|"</argumentList>\n"
literal|"</action>\n"
literal|"</actionList>\n"
literal|"<serviceStateTable>\n"
literal|"<stateVariable sendEvents=\"no\">\n"
literal|"<name>Message</name>\n"
literal|"<dataType>bin.base64</dataType>\n"
literal|"</stateVariable>\n"
literal|"<stateVariable sendEvents=\"no\">\n"
literal|"<name>InMessage</name>\n"
literal|"<dataType>bin.base64</dataType>\n"
literal|"</stateVariable>\n"
literal|"<stateVariable sendEvents=\"no\">\n"
literal|"<name>OutMessage</name>\n"
literal|"<dataType>bin.base64</dataType>\n"
literal|"</stateVariable>\n"
literal|"<stateVariable sendEvents=\"no\">\n"
literal|"<name>DeviceInfo</name>\n"
literal|"<dataType>bin.base64</dataType>\n"
literal|"</stateVariable>\n"
literal|"<stateVariable sendEvents=\"yes\">\n"
literal|"<name>APStatus</name>\n"
literal|"<dataType>ui1</dataType>\n"
literal|"</stateVariable>\n"
literal|"<stateVariable sendEvents=\"yes\">\n"
literal|"<name>STAStatus</name>\n"
literal|"<dataType>ui1</dataType>\n"
literal|"</stateVariable>\n"
literal|"<stateVariable sendEvents=\"yes\">\n"
literal|"<name>WLANEvent</name>\n"
literal|"<dataType>bin.base64</dataType>\n"
literal|"</stateVariable>\n"
literal|"<stateVariable sendEvents=\"no\">\n"
literal|"<name>WLANEventType</name>\n"
literal|"<dataType>ui1</dataType>\n"
literal|"</stateVariable>\n"
literal|"<stateVariable sendEvents=\"no\">\n"
literal|"<name>WLANEventMAC</name>\n"
literal|"<dataType>string</dataType>\n"
literal|"</stateVariable>\n"
literal|"<stateVariable sendEvents=\"no\">\n"
literal|"<name>WLANResponse</name>\n"
literal|"<dataType>bin.base64</dataType>\n"
literal|"</stateVariable>\n"
literal|"</serviceStateTable>\n"
literal|"</scpd>\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|wps_device_xml_prefix
init|=
literal|"<?xml version=\"1.0\"?>\n"
literal|"<root xmlns=\"urn:schemas-upnp-org:device-1-0\">\n"
literal|"<specVersion>\n"
literal|"<major>1</major>\n"
literal|"<minor>0</minor>\n"
literal|"</specVersion>\n"
literal|"<device>\n"
literal|"<deviceType>urn:schemas-wifialliance-org:device:WFADevice:1"
literal|"</deviceType>\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|wps_device_xml_postfix
init|=
literal|"<serviceList>\n"
literal|"<service>\n"
literal|"<serviceType>urn:schemas-wifialliance-org:service:WFAWLANConfig:1"
literal|"</serviceType>\n"
literal|"<serviceId>urn:wifialliance-org:serviceId:WFAWLANConfig1</serviceId>"
literal|"\n"
literal|"<SCPDURL>"
name|UPNP_WPS_SCPD_XML_FILE
literal|"</SCPDURL>\n"
literal|"<controlURL>"
name|UPNP_WPS_DEVICE_CONTROL_FILE
literal|"</controlURL>\n"
literal|"<eventSubURL>"
name|UPNP_WPS_DEVICE_EVENT_FILE
literal|"</eventSubURL>\n"
literal|"</service>\n"
literal|"</serviceList>\n"
literal|"</device>\n"
literal|"</root>\n"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* format_wps_device_xml -- produce content of "file" wps_device.xml  * (UPNP_WPS_DEVICE_XML_FILE)  */
end_comment

begin_function
specifier|static
name|void
name|format_wps_device_xml
parameter_list|(
name|struct
name|upnp_wps_device_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|s
decl_stmt|;
name|char
name|uuid_string
index|[
literal|80
index|]
decl_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|wps_device_xml_prefix
argument_list|)
expr_stmt|;
comment|/* 	 * Add required fields with default values if not configured. Add 	 * optional and recommended fields only if configured. 	 */
name|s
operator|=
name|iface
operator|->
name|wps
operator|->
name|friendly_name
expr_stmt|;
name|s
operator|=
operator|(
operator|(
name|s
operator|&&
operator|*
name|s
operator|)
condition|?
name|s
else|:
literal|"WPS Access Point"
operator|)
expr_stmt|;
name|xml_add_tagged_data
argument_list|(
name|buf
argument_list|,
literal|"friendlyName"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|s
operator|=
name|iface
operator|->
name|wps
operator|->
name|dev
operator|.
name|manufacturer
expr_stmt|;
name|s
operator|=
operator|(
operator|(
name|s
operator|&&
operator|*
name|s
operator|)
condition|?
name|s
else|:
literal|""
operator|)
expr_stmt|;
name|xml_add_tagged_data
argument_list|(
name|buf
argument_list|,
literal|"manufacturer"
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|manufacturer_url
condition|)
name|xml_add_tagged_data
argument_list|(
name|buf
argument_list|,
literal|"manufacturerURL"
argument_list|,
name|iface
operator|->
name|wps
operator|->
name|manufacturer_url
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|model_description
condition|)
name|xml_add_tagged_data
argument_list|(
name|buf
argument_list|,
literal|"modelDescription"
argument_list|,
name|iface
operator|->
name|wps
operator|->
name|model_description
argument_list|)
expr_stmt|;
name|s
operator|=
name|iface
operator|->
name|wps
operator|->
name|dev
operator|.
name|model_name
expr_stmt|;
name|s
operator|=
operator|(
operator|(
name|s
operator|&&
operator|*
name|s
operator|)
condition|?
name|s
else|:
literal|""
operator|)
expr_stmt|;
name|xml_add_tagged_data
argument_list|(
name|buf
argument_list|,
literal|"modelName"
argument_list|,
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|dev
operator|.
name|model_number
condition|)
name|xml_add_tagged_data
argument_list|(
name|buf
argument_list|,
literal|"modelNumber"
argument_list|,
name|iface
operator|->
name|wps
operator|->
name|dev
operator|.
name|model_number
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|model_url
condition|)
name|xml_add_tagged_data
argument_list|(
name|buf
argument_list|,
literal|"modelURL"
argument_list|,
name|iface
operator|->
name|wps
operator|->
name|model_url
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|dev
operator|.
name|serial_number
condition|)
name|xml_add_tagged_data
argument_list|(
name|buf
argument_list|,
literal|"serialNumber"
argument_list|,
name|iface
operator|->
name|wps
operator|->
name|dev
operator|.
name|serial_number
argument_list|)
expr_stmt|;
name|uuid_bin2str
argument_list|(
name|iface
operator|->
name|wps
operator|->
name|uuid
argument_list|,
name|uuid_string
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid_string
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|uuid_string
expr_stmt|;
comment|/* Need "uuid:" prefix, thus we can't use xml_add_tagged_data() 	 * easily... 	 */
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"<UDN>uuid:"
argument_list|)
expr_stmt|;
name|xml_data_encode
argument_list|(
name|buf
argument_list|,
name|s
argument_list|,
name|os_strlen
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"</UDN>\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|upc
condition|)
name|xml_add_tagged_data
argument_list|(
name|buf
argument_list|,
literal|"UPC"
argument_list|,
name|iface
operator|->
name|wps
operator|->
name|upc
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|wps_device_xml_postfix
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_put_reply_code
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|enum
name|http_reply_code
name|code
parameter_list|)
block|{
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"HTTP/1.1 "
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|code
condition|)
block|{
case|case
name|HTTP_OK
case|:
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"200 OK\r\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTP_BAD_REQUEST
case|:
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"400 Bad request\r\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTP_PRECONDITION_FAILED
case|:
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"412 Precondition failed\r\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTP_UNIMPLEMENTED
case|:
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"501 Unimplemented\r\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTP_INTERNAL_SERVER_ERROR
case|:
default|default:
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"500 Internal server error\r\n"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|http_put_date
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"Date: "
argument_list|)
expr_stmt|;
name|format_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_put_empty
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|enum
name|http_reply_code
name|code
parameter_list|)
block|{
name|http_put_reply_code
argument_list|(
name|buf
argument_list|,
name|code
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|http_server_hdr
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|http_connection_close
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"Content-Length: 0\r\n"
literal|"\r\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Given that we have received a header w/ GET, act upon it  *  * Format of GET (case-insensitive):  *  * First line must be:  *      GET /<file> HTTP/1.1  * Since we don't do anything fancy we just ignore other lines.  *  * Our response (if no error) which includes only required lines is:  * HTTP/1.1 200 OK  * Connection: close  * Content-Type: text/xml  * Date:<rfc1123-date>  *  * Header lines must end with \r\n  * Per RFC 2616, content-length: is not required but connection:close  * would appear to be required (given that we will be closing it!).  */
end_comment

begin_function
specifier|static
name|void
name|web_connection_parse_get
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|http_request
modifier|*
name|hreq
parameter_list|,
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
comment|/* output buffer, allocated */
name|char
modifier|*
name|put_length_here
decl_stmt|;
name|char
modifier|*
name|body_start
decl_stmt|;
enum|enum
block|{
name|GET_DEVICE_XML_FILE
block|,
name|GET_SCPD_XML_FILE
block|}
name|req
enum|;
name|size_t
name|extra_len
init|=
literal|0
decl_stmt|;
name|int
name|body_length
decl_stmt|;
name|char
name|len_buf
index|[
literal|10
index|]
decl_stmt|;
name|struct
name|upnp_wps_device_interface
modifier|*
name|iface
decl_stmt|;
name|iface
operator|=
name|dl_list_first
argument_list|(
operator|&
name|sm
operator|->
name|interfaces
argument_list|,
expr|struct
name|upnp_wps_device_interface
argument_list|,
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
condition|)
block|{
name|http_request_deinit
argument_list|(
name|hreq
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * It is not required that filenames be case insensitive but it is 	 * allowed and cannot hurt here. 	 */
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|filename
argument_list|,
name|UPNP_WPS_DEVICE_XML_FILE
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: HTTP GET for device XML"
argument_list|)
expr_stmt|;
name|req
operator|=
name|GET_DEVICE_XML_FILE
expr_stmt|;
name|extra_len
operator|=
literal|3000
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|friendly_name
condition|)
name|extra_len
operator|+=
name|os_strlen
argument_list|(
name|iface
operator|->
name|wps
operator|->
name|friendly_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|manufacturer_url
condition|)
name|extra_len
operator|+=
name|os_strlen
argument_list|(
name|iface
operator|->
name|wps
operator|->
name|manufacturer_url
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|model_description
condition|)
name|extra_len
operator|+=
name|os_strlen
argument_list|(
name|iface
operator|->
name|wps
operator|->
name|model_description
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|model_url
condition|)
name|extra_len
operator|+=
name|os_strlen
argument_list|(
name|iface
operator|->
name|wps
operator|->
name|model_url
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|wps
operator|->
name|upc
condition|)
name|extra_len
operator|+=
name|os_strlen
argument_list|(
name|iface
operator|->
name|wps
operator|->
name|upc
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcasecmp
argument_list|(
name|filename
argument_list|,
name|UPNP_WPS_SCPD_XML_FILE
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: HTTP GET for SCPD XML"
argument_list|)
expr_stmt|;
name|req
operator|=
name|GET_SCPD_XML_FILE
expr_stmt|;
name|extra_len
operator|=
name|os_strlen
argument_list|(
name|wps_scpd_xml
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* File not found */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: HTTP GET file not found: %s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|http_request_deinit
argument_list|(
name|hreq
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"HTTP/1.1 404 Not Found\r\n"
literal|"Connection: close\r\n"
argument_list|)
expr_stmt|;
name|http_put_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* terminating empty line */
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
goto|goto
name|send_buf
goto|;
block|}
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
operator|+
name|extra_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|http_request_deinit
argument_list|(
name|hreq
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"HTTP/1.1 200 OK\r\n"
literal|"Content-Type: text/xml; charset=\"utf-8\"\r\n"
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"Server: Unspecified, UPnP/1.0, Unspecified\r\n"
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"Connection: close\r\n"
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"Content-Length: "
argument_list|)
expr_stmt|;
comment|/* 	 * We will paste the length in later, leaving some extra whitespace. 	 * HTTP code is supposed to be tolerant of extra whitespace. 	 */
name|put_length_here
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"        \r\n"
argument_list|)
expr_stmt|;
name|http_put_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* terminating empty line */
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|body_start
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|req
condition|)
block|{
case|case
name|GET_DEVICE_XML_FILE
case|:
name|format_wps_device_xml
argument_list|(
name|iface
argument_list|,
name|sm
argument_list|,
name|buf
argument_list|)
expr_stmt|;
break|break;
case|case
name|GET_SCPD_XML_FILE
case|:
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|wps_scpd_xml
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Now patch in the content length at the end */
name|body_length
operator|=
operator|(
name|char
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|body_start
expr_stmt|;
name|os_snprintf
argument_list|(
name|len_buf
argument_list|,
literal|10
argument_list|,
literal|"%d"
argument_list|,
name|body_length
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|put_length_here
argument_list|,
name|len_buf
argument_list|,
name|os_strlen
argument_list|(
name|len_buf
argument_list|)
argument_list|)
expr_stmt|;
name|send_buf
label|:
name|http_request_send_and_deinit
argument_list|(
name|hreq
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|enum
name|http_reply_code
name|web_process_get_device_info
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|reply
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|replyname
parameter_list|)
block|{
specifier|static
specifier|const
name|char
modifier|*
name|name
init|=
literal|"NewDeviceInfo"
decl_stmt|;
name|struct
name|wps_config
name|cfg
decl_stmt|;
name|struct
name|upnp_wps_device_interface
modifier|*
name|iface
decl_stmt|;
name|struct
name|upnp_wps_peer
modifier|*
name|peer
decl_stmt|;
name|iface
operator|=
name|dl_list_first
argument_list|(
operator|&
name|sm
operator|->
name|interfaces
argument_list|,
expr|struct
name|upnp_wps_device_interface
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: GetDeviceInfo"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iface
operator|||
name|iface
operator|->
name|ctx
operator|->
name|ap_pin
operator|==
name|NULL
condition|)
return|return
name|HTTP_INTERNAL_SERVER_ERROR
return|;
name|peer
operator|=
operator|&
name|iface
operator|->
name|peer
expr_stmt|;
comment|/* 	 * Request for DeviceInfo, i.e., M1 TLVs. This is a start of WPS 	 * registration over UPnP with the AP acting as an Enrollee. It should 	 * be noted that this is frequently used just to get the device data, 	 * i.e., there may not be any intent to actually complete the 	 * registration. 	 */
if|if
condition|(
name|peer
operator|->
name|wps
condition|)
name|wps_deinit
argument_list|(
name|peer
operator|->
name|wps
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|wps
operator|=
name|iface
operator|->
name|wps
expr_stmt|;
name|cfg
operator|.
name|pin
operator|=
operator|(
name|u8
operator|*
operator|)
name|iface
operator|->
name|ctx
operator|->
name|ap_pin
expr_stmt|;
name|cfg
operator|.
name|pin_len
operator|=
name|os_strlen
argument_list|(
name|iface
operator|->
name|ctx
operator|->
name|ap_pin
argument_list|)
expr_stmt|;
name|peer
operator|->
name|wps
operator|=
name|wps_init
argument_list|(
operator|&
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
operator|->
name|wps
condition|)
block|{
name|enum
name|wsc_op_code
name|op_code
decl_stmt|;
operator|*
name|reply
operator|=
name|wps_get_msg
argument_list|(
name|peer
operator|->
name|wps
argument_list|,
operator|&
name|op_code
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|reply
operator|==
name|NULL
condition|)
block|{
name|wps_deinit
argument_list|(
name|peer
operator|->
name|wps
argument_list|)
expr_stmt|;
name|peer
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
operator|*
name|reply
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|*
name|reply
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS UPnP: Failed to get DeviceInfo"
argument_list|)
expr_stmt|;
return|return
name|HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
operator|*
name|replyname
operator|=
name|name
expr_stmt|;
return|return
name|HTTP_OK
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|http_reply_code
name|web_process_put_message
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|reply
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|replyname
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
specifier|static
specifier|const
name|char
modifier|*
name|name
init|=
literal|"NewOutMessage"
decl_stmt|;
name|enum
name|http_reply_code
name|ret
decl_stmt|;
name|enum
name|wps_process_res
name|res
decl_stmt|;
name|enum
name|wsc_op_code
name|op_code
decl_stmt|;
name|struct
name|upnp_wps_device_interface
modifier|*
name|iface
decl_stmt|;
name|iface
operator|=
name|dl_list_first
argument_list|(
operator|&
name|sm
operator|->
name|interfaces
argument_list|,
expr|struct
name|upnp_wps_device_interface
argument_list|,
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iface
condition|)
return|return
name|HTTP_INTERNAL_SERVER_ERROR
return|;
comment|/* 	 * PutMessage is used by external UPnP-based Registrar to perform WPS 	 * operation with the access point itself; as compared with 	 * PutWLANResponse which is for proxying. 	 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: PutMessage"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|xml_get_base64_item
argument_list|(
name|data
argument_list|,
literal|"NewInMessage"
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|ret
return|;
name|res
operator|=
name|wps_process_msg
argument_list|(
name|iface
operator|->
name|peer
operator|.
name|wps
argument_list|,
name|WSC_UPnP
argument_list|,
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|WPS_FAILURE
condition|)
operator|*
name|reply
operator|=
name|NULL
expr_stmt|;
else|else
operator|*
name|reply
operator|=
name|wps_get_msg
argument_list|(
name|iface
operator|->
name|peer
operator|.
name|wps
argument_list|,
operator|&
name|op_code
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|reply
operator|==
name|NULL
condition|)
return|return
name|HTTP_INTERNAL_SERVER_ERROR
return|;
operator|*
name|replyname
operator|=
name|name
expr_stmt|;
return|return
name|HTTP_OK
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|http_reply_code
name|web_process_put_wlan_response
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|reply
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|replyname
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|enum
name|http_reply_code
name|ret
decl_stmt|;
name|u8
name|macaddr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|ev_type
decl_stmt|;
name|int
name|type
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
name|struct
name|upnp_wps_device_interface
modifier|*
name|iface
decl_stmt|;
name|int
name|ok
init|=
literal|0
decl_stmt|;
comment|/* 	 * External UPnP-based Registrar is passing us a message to be proxied 	 * over to a Wi-Fi -based client of ours. 	 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: PutWLANResponse"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|xml_get_base64_item
argument_list|(
name|data
argument_list|,
literal|"NewMessage"
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Could not extract NewMessage "
literal|"from PutWLANResponse"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|val
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"NewWLANEventType"
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: No NewWLANEventType in "
literal|"PutWLANResponse"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|UPNP_ARG_VALUE_INVALID
return|;
block|}
name|ev_type
operator|=
name|atol
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|xml_get_first_item
argument_list|(
name|data
argument_list|,
literal|"NewWLANEventMAC"
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: No NewWLANEventMAC in "
literal|"PutWLANResponse"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|UPNP_ARG_VALUE_INVALID
return|;
block|}
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|val
argument_list|,
name|macaddr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Invalid NewWLANEventMAC in "
literal|"PutWLANResponse: '%s'"
argument_list|,
name|val
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_STRICT
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
operator|||
name|attr
operator|.
name|version2
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
name|UPNP_ARG_VALUE_INVALID
return|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
if|if
condition|(
name|hwaddr_aton2
argument_list|(
name|val
argument_list|,
name|macaddr
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/* 			 * At least some versions of Intel PROset seem to be 			 * using dot-deliminated MAC address format here. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Workaround - allow "
literal|"incorrect MAC address format in "
literal|"NewWLANEventMAC: %s -> "
name|MACSTR
argument_list|,
name|val
argument_list|,
name|MAC2STR
argument_list|(
name|macaddr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
name|UPNP_ARG_VALUE_INVALID
return|;
block|}
block|}
name|os_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev_type
operator|==
name|UPNP_WPS_WLANEVENT_TYPE_EAP
condition|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
operator|||
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
name|type
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|type
operator|=
operator|*
name|attr
operator|.
name|msg_type
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Message Type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
else|else
name|type
operator|=
operator|-
literal|1
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|iface
argument_list|,
argument|&sm->interfaces
argument_list|,
argument|struct upnp_wps_device_interface
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|iface
operator|->
name|ctx
operator|->
name|rx_req_put_wlan_response
operator|&&
name|iface
operator|->
name|ctx
operator|->
name|rx_req_put_wlan_response
argument_list|(
name|iface
operator|->
name|priv
argument_list|,
name|ev_type
argument_list|,
name|macaddr
argument_list|,
name|msg
argument_list|,
name|type
argument_list|)
operator|==
literal|0
condition|)
name|ok
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ok
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS UPnP: Fail: sm->ctx->"
literal|"rx_req_put_wlan_response"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|HTTP_INTERNAL_SERVER_ERROR
return|;
block|}
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
operator|*
name|replyname
operator|=
name|NULL
expr_stmt|;
operator|*
name|reply
operator|=
name|NULL
expr_stmt|;
return|return
name|HTTP_OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|find_er_addr
parameter_list|(
name|struct
name|subscription
modifier|*
name|s
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|cli
parameter_list|)
block|{
name|struct
name|subscr_addr
modifier|*
name|a
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|a
argument_list|,
argument|&s->addr_list
argument_list|,
argument|struct subscr_addr
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|cli
operator|->
name|sin_addr
operator|.
name|s_addr
operator|==
name|a
operator|->
name|saddr
operator|.
name|sin_addr
operator|.
name|s_addr
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|subscription
modifier|*
name|find_er
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|cli
parameter_list|)
block|{
name|struct
name|subscription
modifier|*
name|s
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|s
argument_list|,
argument|&sm->subscriptions
argument_list|,
argument|struct subscription
argument_list|,
argument|list
argument_list|)
if|if
condition|(
name|find_er_addr
argument_list|(
name|s
argument_list|,
name|cli
argument_list|)
condition|)
return|return
name|s
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|http_reply_code
name|web_process_set_selected_registrar
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|cli
parameter_list|,
name|char
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|reply
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|replyname
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|enum
name|http_reply_code
name|ret
decl_stmt|;
name|struct
name|subscription
modifier|*
name|s
decl_stmt|;
name|struct
name|upnp_wps_device_interface
modifier|*
name|iface
decl_stmt|;
name|int
name|err
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: SetSelectedRegistrar"
argument_list|)
expr_stmt|;
name|s
operator|=
name|find_er
argument_list|(
name|sm
argument_list|,
name|cli
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Ignore SetSelectedRegistrar "
literal|"from unknown ER"
argument_list|)
expr_stmt|;
return|return
name|UPNP_ACTION_FAILED
return|;
block|}
name|msg
operator|=
name|xml_get_base64_item
argument_list|(
name|data
argument_list|,
literal|"NewMessage"
argument_list|,
operator|&
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|ret
return|;
name|dl_list_for_each
argument_list|(
argument|iface
argument_list|,
argument|&sm->interfaces
argument_list|,
argument|struct upnp_wps_device_interface
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|upnp_er_set_selected_registrar
argument_list|(
name|iface
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|s
argument_list|,
name|msg
argument_list|)
condition|)
name|err
operator|=
literal|1
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
return|return
name|HTTP_INTERNAL_SERVER_ERROR
return|;
operator|*
name|replyname
operator|=
name|NULL
expr_stmt|;
operator|*
name|reply
operator|=
name|NULL
expr_stmt|;
return|return
name|HTTP_OK
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|soap_prefix
init|=
literal|"<?xml version=\"1.0\"?>\n"
literal|"<s:Envelope xmlns:s=\"http://schemas.xmlsoap.org/soap/envelope/\" "
literal|"s:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\">\n"
literal|"<s:Body>\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|soap_postfix
init|=
literal|"</s:Body>\n</s:Envelope>\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|soap_error_prefix
init|=
literal|"<s:Fault>\n"
literal|"<faultcode>s:Client</faultcode>\n"
literal|"<faultstring>UPnPError</faultstring>\n"
literal|"<detail>\n"
literal|"<UPnPError xmlns=\"urn:schemas-upnp-org:control-1-0\">\n"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|soap_error_postfix
init|=
literal|"<errorDescription>Error</errorDescription>\n"
literal|"</UPnPError>\n"
literal|"</detail>\n"
literal|"</s:Fault>\n"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|web_connection_send_reply
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|,
name|enum
name|http_reply_code
name|ret
parameter_list|,
specifier|const
name|char
modifier|*
name|action
parameter_list|,
name|int
name|action_len
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reply
parameter_list|,
specifier|const
name|char
modifier|*
name|replyname
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|replydata
decl_stmt|;
name|char
modifier|*
name|put_length_here
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|body_start
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|reply
condition|)
block|{
name|size_t
name|len
decl_stmt|;
name|replydata
operator|=
operator|(
name|char
operator|*
operator|)
name|base64_encode
argument_list|(
name|wpabuf_head
argument_list|(
name|reply
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|reply
argument_list|)
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
block|}
else|else
name|replydata
operator|=
name|NULL
expr_stmt|;
comment|/* Parameters of the response: 	 *      action(action_len) -- action we are responding to 	 *      replyname -- a name we need for the reply 	 *      replydata -- NULL or null-terminated string 	 */
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
operator|+
operator|(
name|replydata
condition|?
name|os_strlen
argument_list|(
name|replydata
argument_list|)
else|:
literal|0U
operator|)
operator|+
operator|(
name|action_len
operator|>
literal|0
condition|?
name|action_len
operator|*
literal|2
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS UPnP: Cannot allocate reply to "
literal|"POST"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|replydata
argument_list|)
expr_stmt|;
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * Assuming we will be successful, put in the output header first. 	 * Note: we do not keep connections alive (and httpread does 	 * not support it)... therefore we must have Connection: close. 	 */
if|if
condition|(
name|ret
operator|==
name|HTTP_OK
condition|)
block|{
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"HTTP/1.1 200 OK\r\n"
literal|"Content-Type: text/xml; "
literal|"charset=\"utf-8\"\r\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"HTTP/1.1 %d Error\r\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|http_connection_close
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"Content-Length: "
argument_list|)
expr_stmt|;
comment|/* 	 * We will paste the length in later, leaving some extra whitespace. 	 * HTTP code is supposed to be tolerant of extra whitespace. 	 */
name|put_length_here
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"        \r\n"
argument_list|)
expr_stmt|;
name|http_put_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* terminating empty line */
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|body_start
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|HTTP_OK
condition|)
block|{
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|soap_prefix
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"<u:"
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|action
argument_list|,
name|action_len
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"Response xmlns:u=\""
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|urn_wfawlanconfig
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\">\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|replydata
operator|&&
name|replyname
condition|)
block|{
comment|/* TODO: might possibly need to escape part of reply 			 * data? ... 			 * probably not, unlikely to have ampersand(&) or left 			 * angle bracket (<) in it... 			 */
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"<%s>"
argument_list|,
name|replyname
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|replydata
argument_list|)
expr_stmt|;
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"</%s>\n"
argument_list|,
name|replyname
argument_list|)
expr_stmt|;
block|}
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"</u:"
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|action
argument_list|,
name|action_len
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"Response>\n"
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|soap_postfix
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Error case */
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|soap_prefix
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|soap_error_prefix
argument_list|)
expr_stmt|;
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"<errorCode>%d</errorCode>\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|soap_error_postfix
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|soap_postfix
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|replydata
argument_list|)
expr_stmt|;
comment|/* Now patch in the content length at the end */
if|if
condition|(
name|body_start
operator|&&
name|put_length_here
condition|)
block|{
name|int
name|body_length
init|=
operator|(
name|char
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
operator|-
name|body_start
decl_stmt|;
name|char
name|len_buf
index|[
literal|10
index|]
decl_stmt|;
name|os_snprintf
argument_list|(
name|len_buf
argument_list|,
sizeof|sizeof
argument_list|(
name|len_buf
argument_list|)
argument_list|,
literal|"%d"
argument_list|,
name|body_length
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|put_length_here
argument_list|,
name|len_buf
argument_list|,
name|os_strlen
argument_list|(
name|len_buf
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|http_request_send_and_deinit
argument_list|(
name|req
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|web_get_action
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|,
name|size_t
modifier|*
name|action_len
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|match
decl_stmt|;
name|int
name|match_len
decl_stmt|;
name|char
modifier|*
name|b
decl_stmt|;
name|char
modifier|*
name|action
decl_stmt|;
operator|*
name|action_len
operator|=
literal|0
expr_stmt|;
comment|/* The SOAPAction line of the header tells us what we want to do */
name|b
operator|=
name|http_request_get_hdr_line
argument_list|(
name|req
argument_list|,
literal|"SOAPAction:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|*
name|b
operator|==
literal|'"'
condition|)
name|b
operator|++
expr_stmt|;
else|else
return|return
name|NULL
return|;
name|match
operator|=
name|urn_wfawlanconfig
expr_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|urn_wfawlanconfig
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|b
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
condition|)
return|return
name|NULL
return|;
name|b
operator|+=
name|match_len
expr_stmt|;
comment|/* skip over version */
while|while
condition|(
name|isgraph
argument_list|(
operator|*
name|b
argument_list|)
operator|&&
operator|*
name|b
operator|!=
literal|'#'
condition|)
name|b
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|b
operator|!=
literal|'#'
condition|)
return|return
name|NULL
return|;
name|b
operator|++
expr_stmt|;
comment|/* Following the sharp(#) should be the action and a double quote */
name|action
operator|=
name|b
expr_stmt|;
while|while
condition|(
name|isgraph
argument_list|(
operator|*
name|b
argument_list|)
operator|&&
operator|*
name|b
operator|!=
literal|'"'
condition|)
name|b
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|b
operator|!=
literal|'"'
condition|)
return|return
name|NULL
return|;
operator|*
name|action_len
operator|=
name|b
operator|-
name|action
expr_stmt|;
return|return
name|action
return|;
block|}
end_function

begin_comment
comment|/* Given that we have received a header w/ POST, act upon it  *  * Format of POST (case-insensitive):  *  * First line must be:  *      POST /<file> HTTP/1.1  * Since we don't do anything fancy we just ignore other lines.  *  * Our response (if no error) which includes only required lines is:  * HTTP/1.1 200 OK  * Connection: close  * Content-Type: text/xml  * Date:<rfc1123-date>  *  * Header lines must end with \r\n  * Per RFC 2616, content-length: is not required but connection:close  * would appear to be required (given that we will be closing it!).  */
end_comment

begin_function
specifier|static
name|void
name|web_connection_parse_post
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|cli
parameter_list|,
name|struct
name|http_request
modifier|*
name|req
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|enum
name|http_reply_code
name|ret
decl_stmt|;
name|char
modifier|*
name|data
init|=
name|http_request_get_data
argument_list|(
name|req
argument_list|)
decl_stmt|;
comment|/* body of http msg */
specifier|const
name|char
modifier|*
name|action
init|=
name|NULL
decl_stmt|;
name|size_t
name|action_len
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|replyname
init|=
name|NULL
decl_stmt|;
comment|/* argument name for the reply */
name|struct
name|wpabuf
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
comment|/* data for the reply */
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|filename
argument_list|,
name|UPNP_WPS_DEVICE_CONTROL_FILE
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS UPnP: Invalid POST filename %s"
argument_list|,
name|filename
argument_list|)
expr_stmt|;
name|ret
operator|=
name|HTTP_NOT_FOUND
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ret
operator|=
name|UPNP_INVALID_ACTION
expr_stmt|;
name|action
operator|=
name|web_get_action
argument_list|(
name|req
argument_list|,
operator|&
name|action_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|action
operator|==
name|NULL
condition|)
goto|goto
name|bad
goto|;
if|if
condition|(
operator|!
name|os_strncasecmp
argument_list|(
literal|"GetDeviceInfo"
argument_list|,
name|action
argument_list|,
name|action_len
argument_list|)
condition|)
name|ret
operator|=
name|web_process_get_device_info
argument_list|(
name|sm
argument_list|,
operator|&
name|reply
argument_list|,
operator|&
name|replyname
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strncasecmp
argument_list|(
literal|"PutMessage"
argument_list|,
name|action
argument_list|,
name|action_len
argument_list|)
condition|)
name|ret
operator|=
name|web_process_put_message
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
operator|&
name|reply
argument_list|,
operator|&
name|replyname
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strncasecmp
argument_list|(
literal|"PutWLANResponse"
argument_list|,
name|action
argument_list|,
name|action_len
argument_list|)
condition|)
name|ret
operator|=
name|web_process_put_wlan_response
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
operator|&
name|reply
argument_list|,
operator|&
name|replyname
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strncasecmp
argument_list|(
literal|"SetSelectedRegistrar"
argument_list|,
name|action
argument_list|,
name|action_len
argument_list|)
condition|)
name|ret
operator|=
name|web_process_set_selected_registrar
argument_list|(
name|sm
argument_list|,
name|cli
argument_list|,
name|data
argument_list|,
operator|&
name|reply
argument_list|,
operator|&
name|replyname
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS UPnP: Unknown POST type"
argument_list|)
expr_stmt|;
name|bad
label|:
if|if
condition|(
name|ret
operator|!=
name|HTTP_OK
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS UPnP: POST failure ret=%d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|web_connection_send_reply
argument_list|(
name|req
argument_list|,
name|ret
argument_list|,
name|action
argument_list|,
name|action_len
argument_list|,
name|reply
argument_list|,
name|replyname
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|reply
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Given that we have received a header w/ SUBSCRIBE, act upon it  *  * Format of SUBSCRIBE (case-insensitive):  *  * First line must be:  *      SUBSCRIBE /wps_event HTTP/1.1  *  * Our response (if no error) which includes only required lines is:  * HTTP/1.1 200 OK  * Server: xx, UPnP/1.0, xx  * SID: uuid:xxxxxxxxx  * Timeout: Second-<n>  * Content-Length: 0  * Date: xxxx  *  * Header lines must end with \r\n  * Per RFC 2616, content-length: is not required but connection:close  * would appear to be required (given that we will be closing it!).  */
end_comment

begin_function
specifier|static
name|void
name|web_connection_parse_subscribe
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|http_request
modifier|*
name|req
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|b
decl_stmt|;
name|char
modifier|*
name|hdr
init|=
name|http_request_get_hdr
argument_list|(
name|req
argument_list|)
decl_stmt|;
name|char
modifier|*
name|h
decl_stmt|;
name|char
modifier|*
name|match
decl_stmt|;
name|int
name|match_len
decl_stmt|;
name|char
modifier|*
name|end
decl_stmt|;
name|int
name|len
decl_stmt|;
name|int
name|got_nt
init|=
literal|0
decl_stmt|;
name|u8
name|uuid
index|[
name|UUID_LEN
index|]
decl_stmt|;
name|int
name|got_uuid
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|callback_urls
init|=
name|NULL
decl_stmt|;
name|struct
name|subscription
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|enum
name|http_reply_code
name|ret
init|=
name|HTTP_INTERNAL_SERVER_ERROR
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: HTTP SUBSCRIBE"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|hdr
argument_list|,
name|os_strlen
argument_list|(
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Parse/validate headers */
name|h
operator|=
name|hdr
expr_stmt|;
comment|/* First line: SUBSCRIBE /wps_event HTTP/1.1 	 * has already been parsed. 	 */
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|filename
argument_list|,
name|UPNP_WPS_DEVICE_EVENT_FILE
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|HTTP_PRECONDITION_FAILED
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: HTTP SUBSCRIBE for event"
argument_list|)
expr_stmt|;
name|end
operator|=
name|os_strchr
argument_list|(
name|h
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
while|while
condition|(
name|end
condition|)
block|{
comment|/* Option line by option line */
name|h
operator|=
name|end
operator|+
literal|1
expr_stmt|;
name|end
operator|=
name|os_strchr
argument_list|(
name|h
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
break|break;
comment|/* no unterminated lines allowed */
comment|/* NT assures that it is our type of subscription; 		 * not used for a renewal. 		 **/
name|match
operator|=
literal|"NT:"
expr_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|h
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|h
operator|+=
name|match_len
expr_stmt|;
while|while
condition|(
operator|*
name|h
operator|==
literal|' '
operator|||
operator|*
name|h
operator|==
literal|'\t'
condition|)
name|h
operator|++
expr_stmt|;
name|match
operator|=
literal|"upnp:event"
expr_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|h
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|HTTP_BAD_REQUEST
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|got_nt
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
comment|/* HOST should refer to us */
if|#
directive|if
literal|0
block|match = "HOST:"; 		match_len = os_strlen(match); 		if (os_strncasecmp(h, match, match_len) == 0) { 			h += match_len; 			while (*h == ' ' || *h == '\t') 				h++; 			..... 		}
endif|#
directive|endif
comment|/* CALLBACK gives one or more URLs for NOTIFYs 		 * to be sent as a result of the subscription. 		 * Each URL is enclosed in angle brackets. 		 */
name|match
operator|=
literal|"CALLBACK:"
expr_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|h
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|h
operator|+=
name|match_len
expr_stmt|;
while|while
condition|(
operator|*
name|h
operator|==
literal|' '
operator|||
operator|*
name|h
operator|==
literal|'\t'
condition|)
name|h
operator|++
expr_stmt|;
name|len
operator|=
name|end
operator|-
name|h
expr_stmt|;
name|os_free
argument_list|(
name|callback_urls
argument_list|)
expr_stmt|;
name|callback_urls
operator|=
name|dup_binstr
argument_list|(
name|h
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|callback_urls
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|HTTP_INTERNAL_SERVER_ERROR
expr_stmt|;
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|len
operator|>
literal|0
operator|&&
name|callback_urls
index|[
name|len
operator|-
literal|1
index|]
operator|==
literal|'\r'
condition|)
name|callback_urls
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
continue|continue;
block|}
comment|/* SID is only for renewal */
name|match
operator|=
literal|"SID:"
expr_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|h
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|h
operator|+=
name|match_len
expr_stmt|;
while|while
condition|(
operator|*
name|h
operator|==
literal|' '
operator|||
operator|*
name|h
operator|==
literal|'\t'
condition|)
name|h
operator|++
expr_stmt|;
name|match
operator|=
literal|"uuid:"
expr_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|h
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|HTTP_BAD_REQUEST
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|h
operator|+=
name|match_len
expr_stmt|;
while|while
condition|(
operator|*
name|h
operator|==
literal|' '
operator|||
operator|*
name|h
operator|==
literal|'\t'
condition|)
name|h
operator|++
expr_stmt|;
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|h
argument_list|,
name|uuid
argument_list|)
condition|)
block|{
name|ret
operator|=
name|HTTP_BAD_REQUEST
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|got_uuid
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
comment|/* TIMEOUT is requested timeout, but apparently we can 		 * just ignore this. 		 */
block|}
if|if
condition|(
name|got_uuid
condition|)
block|{
comment|/* renewal */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Subscription renewal"
argument_list|)
expr_stmt|;
if|if
condition|(
name|callback_urls
condition|)
block|{
name|ret
operator|=
name|HTTP_BAD_REQUEST
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|s
operator|=
name|subscription_renew
argument_list|(
name|sm
argument_list|,
name|uuid
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|char
name|str
index|[
literal|80
index|]
decl_stmt|;
name|uuid_bin2str
argument_list|(
name|uuid
argument_list|,
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Could not find "
literal|"SID %s"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|ret
operator|=
name|HTTP_PRECONDITION_FAILED
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|callback_urls
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: New subscription"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|got_nt
condition|)
block|{
name|ret
operator|=
name|HTTP_PRECONDITION_FAILED
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|s
operator|=
name|subscription_start
argument_list|(
name|sm
argument_list|,
name|callback_urls
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
block|{
name|ret
operator|=
name|HTTP_INTERNAL_SERVER_ERROR
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|HTTP_PRECONDITION_FAILED
expr_stmt|;
goto|goto
name|error
goto|;
block|}
comment|/* success */
name|http_put_reply_code
argument_list|(
name|buf
argument_list|,
name|HTTP_OK
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|http_server_hdr
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
name|http_connection_close
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"Content-Length: 0\r\n"
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"SID: uuid:"
argument_list|)
expr_stmt|;
comment|/* subscription id */
name|b
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|uuid_bin2str
argument_list|(
name|s
operator|->
name|uuid
argument_list|,
name|b
argument_list|,
literal|80
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Assigned SID %s"
argument_list|,
name|b
argument_list|)
expr_stmt|;
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|os_strlen
argument_list|(
name|b
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|wpabuf_printf
argument_list|(
name|buf
argument_list|,
literal|"Timeout: Second-%d\r\n"
argument_list|,
name|UPNP_SUBSCRIBE_SEC
argument_list|)
expr_stmt|;
name|http_put_date
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* And empty line to terminate header: */
name|wpabuf_put_str
argument_list|(
name|buf
argument_list|,
literal|"\r\n"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|callback_urls
argument_list|)
expr_stmt|;
name|http_request_send_and_deinit
argument_list|(
name|req
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return;
name|error
label|:
comment|/* Per UPnP spec: 	* Errors 	* Incompatible headers 	*   400 Bad Request. If SID header and one of NT or CALLBACK headers 	*     are present, the publisher must respond with HTTP error 	*     400 Bad Request. 	* Missing or invalid CALLBACK 	*   412 Precondition Failed. If CALLBACK header is missing or does not 	*     contain a valid HTTP URL, the publisher must respond with HTTP 	*     error 412 Precondition Failed. 	* Invalid NT 	*   412 Precondition Failed. If NT header does not equal upnp:event, 	*     the publisher must respond with HTTP error 412 Precondition 	*     Failed. 	* [For resubscription, use 412 if unknown uuid]. 	* Unable to accept subscription 	*   5xx. If a publisher is not able to accept a subscription (such as 	*     due to insufficient resources), it must respond with a 	*     HTTP 500-series error code. 	*   599 Too many subscriptions (not a standard HTTP error) 	*/
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: SUBSCRIBE failed - return %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|http_put_empty
argument_list|(
name|buf
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|http_request_send_and_deinit
argument_list|(
name|req
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|callback_urls
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Given that we have received a header w/ UNSUBSCRIBE, act upon it  *  * Format of UNSUBSCRIBE (case-insensitive):  *  * First line must be:  *      UNSUBSCRIBE /wps_event HTTP/1.1  *  * Our response (if no error) which includes only required lines is:  * HTTP/1.1 200 OK  * Content-Length: 0  *  * Header lines must end with \r\n  * Per RFC 2616, content-length: is not required but connection:close  * would appear to be required (given that we will be closing it!).  */
end_comment

begin_function
specifier|static
name|void
name|web_connection_parse_unsubscribe
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|http_request
modifier|*
name|req
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|hdr
init|=
name|http_request_get_hdr
argument_list|(
name|req
argument_list|)
decl_stmt|;
name|char
modifier|*
name|h
decl_stmt|;
name|char
modifier|*
name|match
decl_stmt|;
name|int
name|match_len
decl_stmt|;
name|char
modifier|*
name|end
decl_stmt|;
name|u8
name|uuid
index|[
name|UUID_LEN
index|]
decl_stmt|;
name|int
name|got_uuid
init|=
literal|0
decl_stmt|;
name|struct
name|subscription
modifier|*
name|s
init|=
name|NULL
decl_stmt|;
name|enum
name|http_reply_code
name|ret
init|=
name|HTTP_INTERNAL_SERVER_ERROR
decl_stmt|;
comment|/* Parse/validate headers */
name|h
operator|=
name|hdr
expr_stmt|;
comment|/* First line: UNSUBSCRIBE /wps_event HTTP/1.1 	 * has already been parsed. 	 */
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|filename
argument_list|,
name|UPNP_WPS_DEVICE_EVENT_FILE
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|HTTP_PRECONDITION_FAILED
expr_stmt|;
goto|goto
name|send_msg
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: HTTP UNSUBSCRIBE for event"
argument_list|)
expr_stmt|;
name|end
operator|=
name|os_strchr
argument_list|(
name|h
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
while|while
condition|(
name|end
condition|)
block|{
comment|/* Option line by option line */
name|h
operator|=
name|end
operator|+
literal|1
expr_stmt|;
name|end
operator|=
name|os_strchr
argument_list|(
name|h
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
break|break;
comment|/* no unterminated lines allowed */
comment|/* HOST should refer to us */
if|#
directive|if
literal|0
block|match = "HOST:"; 		match_len = os_strlen(match); 		if (os_strncasecmp(h, match, match_len) == 0) { 			h += match_len; 			while (*h == ' ' || *h == '\t') 				h++; 			..... 		}
endif|#
directive|endif
name|match
operator|=
literal|"SID:"
expr_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|h
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|h
operator|+=
name|match_len
expr_stmt|;
while|while
condition|(
operator|*
name|h
operator|==
literal|' '
operator|||
operator|*
name|h
operator|==
literal|'\t'
condition|)
name|h
operator|++
expr_stmt|;
name|match
operator|=
literal|"uuid:"
expr_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|h
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
name|HTTP_BAD_REQUEST
expr_stmt|;
goto|goto
name|send_msg
goto|;
block|}
name|h
operator|+=
name|match_len
expr_stmt|;
while|while
condition|(
operator|*
name|h
operator|==
literal|' '
operator|||
operator|*
name|h
operator|==
literal|'\t'
condition|)
name|h
operator|++
expr_stmt|;
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|h
argument_list|,
name|uuid
argument_list|)
condition|)
block|{
name|ret
operator|=
name|HTTP_BAD_REQUEST
expr_stmt|;
goto|goto
name|send_msg
goto|;
block|}
name|got_uuid
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
name|match
operator|=
literal|"NT:"
expr_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|h
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|HTTP_BAD_REQUEST
expr_stmt|;
goto|goto
name|send_msg
goto|;
block|}
name|match
operator|=
literal|"CALLBACK:"
expr_stmt|;
name|match_len
operator|=
name|os_strlen
argument_list|(
name|match
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|h
argument_list|,
name|match
argument_list|,
name|match_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ret
operator|=
name|HTTP_BAD_REQUEST
expr_stmt|;
goto|goto
name|send_msg
goto|;
block|}
block|}
if|if
condition|(
name|got_uuid
condition|)
block|{
name|char
name|str
index|[
literal|80
index|]
decl_stmt|;
name|uuid_bin2str
argument_list|(
name|uuid
argument_list|,
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|=
name|subscription_find
argument_list|(
name|sm
argument_list|,
name|uuid
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
name|struct
name|subscr_addr
modifier|*
name|sa
decl_stmt|;
name|sa
operator|=
name|dl_list_first
argument_list|(
operator|&
name|s
operator|->
name|addr_list
argument_list|,
expr|struct
name|subscr_addr
argument_list|,
name|list
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Unsubscribing %p (SID %s) %s"
argument_list|,
name|s
argument_list|,
name|str
argument_list|,
operator|(
name|sa
operator|&&
name|sa
operator|->
name|domain_and_port
operator|)
condition|?
name|sa
operator|->
name|domain_and_port
else|:
literal|"-null-"
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|s
operator|->
name|list
argument_list|)
expr_stmt|;
name|subscription_destroy
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS UPnP: Could not find matching subscription to unsubscribe (SID %s)"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|ret
operator|=
name|HTTP_PRECONDITION_FAILED
expr_stmt|;
goto|goto
name|send_msg
goto|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS UPnP: Unsubscribe fails (not "
literal|"found)"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|HTTP_PRECONDITION_FAILED
expr_stmt|;
goto|goto
name|send_msg
goto|;
block|}
name|ret
operator|=
name|HTTP_OK
expr_stmt|;
name|send_msg
label|:
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
name|http_put_empty
argument_list|(
name|buf
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|http_request_send_and_deinit
argument_list|(
name|req
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Send error in response to unknown requests */
end_comment

begin_function
specifier|static
name|void
name|web_connection_unimplemented
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
name|http_put_empty
argument_list|(
name|buf
argument_list|,
name|HTTP_UNIMPLEMENTED
argument_list|)
expr_stmt|;
name|http_request_send_and_deinit
argument_list|(
name|req
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Called when we have gotten an apparently valid http request.  */
end_comment

begin_function
specifier|static
name|void
name|web_connection_check_data
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
init|=
name|ctx
decl_stmt|;
name|enum
name|httpread_hdr_type
name|htype
init|=
name|http_request_get_type
argument_list|(
name|req
argument_list|)
decl_stmt|;
name|char
modifier|*
name|filename
init|=
name|http_request_get_uri
argument_list|(
name|req
argument_list|)
decl_stmt|;
name|struct
name|sockaddr_in
modifier|*
name|cli
init|=
name|http_request_get_cli_addr
argument_list|(
name|req
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|filename
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS UPnP: Could not get HTTP URI"
argument_list|)
expr_stmt|;
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Trim leading slashes from filename */
while|while
condition|(
operator|*
name|filename
operator|==
literal|'/'
condition|)
name|filename
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Got HTTP request type %d from %s:%d"
argument_list|,
name|htype
argument_list|,
name|inet_ntoa
argument_list|(
name|cli
operator|->
name|sin_addr
argument_list|)
argument_list|,
name|htons
argument_list|(
name|cli
operator|->
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|htype
condition|)
block|{
case|case
name|HTTPREAD_HDR_TYPE_GET
case|:
name|web_connection_parse_get
argument_list|(
name|sm
argument_list|,
name|req
argument_list|,
name|filename
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTPREAD_HDR_TYPE_POST
case|:
name|web_connection_parse_post
argument_list|(
name|sm
argument_list|,
name|cli
argument_list|,
name|req
argument_list|,
name|filename
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTPREAD_HDR_TYPE_SUBSCRIBE
case|:
name|web_connection_parse_subscribe
argument_list|(
name|sm
argument_list|,
name|req
argument_list|,
name|filename
argument_list|)
expr_stmt|;
break|break;
case|case
name|HTTPREAD_HDR_TYPE_UNSUBSCRIBE
case|:
name|web_connection_parse_unsubscribe
argument_list|(
name|sm
argument_list|,
name|req
argument_list|,
name|filename
argument_list|)
expr_stmt|;
break|break;
comment|/* We are not required to support M-POST; just plain 		 * POST is supposed to work, so we only support that. 		 * If for some reason we need to support M-POST, it is 		 * mostly the same as POST, with small differences. 		 */
default|default:
comment|/* Send 501 for anything else */
name|web_connection_unimplemented
argument_list|(
name|req
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_comment
comment|/*  * Listening for web connections  * We have a single TCP listening port, and hand off connections as we get  * them.  */
end_comment

begin_function
name|void
name|web_listener_stop
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|)
block|{
name|http_server_deinit
argument_list|(
name|sm
operator|->
name|web_srv
argument_list|)
expr_stmt|;
name|sm
operator|->
name|web_srv
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|web_listener_start
parameter_list|(
name|struct
name|upnp_wps_device_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|in_addr
name|addr
decl_stmt|;
name|addr
operator|.
name|s_addr
operator|=
name|sm
operator|->
name|ip_addr
expr_stmt|;
name|sm
operator|->
name|web_srv
operator|=
name|http_server_init
argument_list|(
operator|&
name|addr
argument_list|,
operator|-
literal|1
argument_list|,
name|web_connection_check_data
argument_list|,
name|sm
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|web_srv
operator|==
name|NULL
condition|)
block|{
name|web_listener_stop
argument_list|(
name|sm
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sm
operator|->
name|web_port
operator|=
name|http_server_get_port
argument_list|(
name|sm
operator|->
name|web_srv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


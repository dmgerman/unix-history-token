begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Protected Setup - Enrollee  * Copyright (c) 2008, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"wps_i.h"
end_include

begin_include
include|#
directive|include
file|"wps_dev_attr.h"
end_include

begin_function
specifier|static
name|int
name|wps_build_mac_addr
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * MAC Address"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_MAC_ADDR
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|mac_addr_e
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_wps_state
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u8
name|state
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
condition|)
name|state
operator|=
name|wps
operator|->
name|wps
operator|->
name|wps_state
expr_stmt|;
else|else
name|state
operator|=
name|WPS_STATE_NOT_CONFIGURED
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Wi-Fi Protected Setup State (%d)"
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_WPS_STATE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|msg
argument_list|,
name|state
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_e_hash
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u8
modifier|*
name|hash
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|random_get_bytes
argument_list|(
name|wps
operator|->
name|snonce
argument_list|,
literal|2
operator|*
name|WPS_SECRET_NONCE_LEN
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-S1"
argument_list|,
name|wps
operator|->
name|snonce
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-S2"
argument_list|,
name|wps
operator|->
name|snonce
operator|+
name|WPS_SECRET_NONCE_LEN
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dh_pubkey_e
operator|==
name|NULL
operator|||
name|wps
operator|->
name|dh_pubkey_r
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: DH public keys not available for "
literal|"E-Hash derivation"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * E-Hash1"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_E_HASH1
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|hash
operator|=
name|wpabuf_put
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
comment|/* E-Hash1 = HMAC_AuthKey(E-S1 || PSK1 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|wps
operator|->
name|snonce
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk1
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|WPS_PSK_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-Hash1"
argument_list|,
name|hash
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * E-Hash2"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_E_HASH2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|hash
operator|=
name|wpabuf_put
argument_list|(
name|msg
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
comment|/* E-Hash2 = HMAC_AuthKey(E-S2 || PSK2 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|wps
operator|->
name|snonce
operator|+
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk2
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: E-Hash2"
argument_list|,
name|hash
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_e_snonce1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * E-SNonce1"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_E_SNONCE1
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|snonce
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_e_snonce2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * E-SNonce2"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_E_SNONCE2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|snonce
operator|+
name|WPS_SECRET_NONCE_LEN
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|u16
name|config_methods
decl_stmt|;
if|if
condition|(
name|random_get_bytes
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Nonce"
argument_list|,
name|wps
operator|->
name|nonce_e
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M1"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|config_methods
operator|=
name|wps
operator|->
name|wps
operator|->
name|config_methods
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
operator|!
name|wps
operator|->
name|pbc_in_m1
operator|&&
operator|(
name|wps
operator|->
name|dev_password_len
operator|!=
literal|0
operator|||
operator|(
name|config_methods
operator|&
name|WPS_CONFIG_DISPLAY
operator|)
operator|)
condition|)
block|{
comment|/* 		 * These are the methods that the AP supports as an Enrollee 		 * for adding external Registrars, so remove PushButton. 		 * 		 * As a workaround for Windows 7 mechanism for probing WPS 		 * capabilities from M1, leave PushButton option if no PIN 		 * method is available or if WPS configuration enables PBC 		 * workaround. 		 */
name|config_methods
operator|&=
operator|~
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS2
name|config_methods
operator|&=
operator|~
operator|(
name|WPS_CONFIG_VIRT_PUSHBUTTON
operator||
name|WPS_CONFIG_PHY_PUSHBUTTON
operator|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS2 */
block|}
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M1
argument_list|)
operator|||
name|wps_build_uuid_e
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|uuid_e
argument_list|)
operator|||
name|wps_build_mac_addr
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_public_key
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_auth_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_encr_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_conn_type_flags
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_config_methods
argument_list|(
name|msg
argument_list|,
name|config_methods
argument_list|)
operator|||
name|wps_build_wps_state
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_device_attrs
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_rf_bands
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_assoc_state
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_dev_password_id
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|dev_pw_id
argument_list|)
operator|||
name|wps_build_config_error
argument_list|(
name|msg
argument_list|,
name|WPS_CFG_NO_ERROR
argument_list|)
operator|||
name|wps_build_os_version
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|||
name|wps_build_vendor_ext_m1
argument_list|(
operator|&
name|wps
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wps
operator|->
name|state
operator|=
name|RECV_M2
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m3
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M3"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dev_password
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Device Password available"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wps_derive_psk
argument_list|(
name|wps
argument_list|,
name|wps
operator|->
name|dev_password
argument_list|,
name|wps
operator|->
name|dev_password_len
argument_list|)
expr_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M3
argument_list|)
operator|||
name|wps_build_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_e_hash
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|||
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wps
operator|->
name|state
operator|=
name|RECV_M4
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m5
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|,
modifier|*
name|plain
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M5"
argument_list|)
expr_stmt|;
name|plain
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M5
argument_list|)
operator|||
name|wps_build_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_e_snonce1
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_encr_settings
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|||
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|RECV_M6
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_ssid
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * SSID"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_SSID
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_auth_type
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u16
name|auth_type
init|=
name|wps
operator|->
name|wps
operator|->
name|auth_types
decl_stmt|;
comment|/* Select the best authentication type */
if|if
condition|(
name|auth_type
operator|&
name|WPS_AUTH_WPA2PSK
condition|)
name|auth_type
operator|=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
elseif|else
if|if
condition|(
name|auth_type
operator|&
name|WPS_AUTH_WPAPSK
condition|)
name|auth_type
operator|=
name|WPS_AUTH_WPAPSK
expr_stmt|;
elseif|else
if|if
condition|(
name|auth_type
operator|&
name|WPS_AUTH_OPEN
condition|)
name|auth_type
operator|=
name|WPS_AUTH_OPEN
expr_stmt|;
elseif|else
if|if
condition|(
name|auth_type
operator|&
name|WPS_AUTH_SHARED
condition|)
name|auth_type
operator|=
name|WPS_AUTH_SHARED
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Authentication Type (0x%x)"
argument_list|,
name|auth_type
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_AUTH_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|auth_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_encr_type
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|u16
name|encr_type
init|=
name|wps
operator|->
name|wps
operator|->
name|encr_types
decl_stmt|;
comment|/* Select the best encryption type */
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|auth_types
operator|&
operator|(
name|WPS_AUTH_WPA2PSK
operator||
name|WPS_AUTH_WPAPSK
operator|)
condition|)
block|{
if|if
condition|(
name|encr_type
operator|&
name|WPS_ENCR_AES
condition|)
name|encr_type
operator|=
name|WPS_ENCR_AES
expr_stmt|;
elseif|else
if|if
condition|(
name|encr_type
operator|&
name|WPS_ENCR_TKIP
condition|)
name|encr_type
operator|=
name|WPS_ENCR_TKIP
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|encr_type
operator|&
name|WPS_ENCR_WEP
condition|)
name|encr_type
operator|=
name|WPS_ENCR_WEP
expr_stmt|;
elseif|else
if|if
condition|(
name|encr_type
operator|&
name|WPS_ENCR_NONE
condition|)
name|encr_type
operator|=
name|WPS_ENCR_NONE
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Encryption Type (0x%x)"
argument_list|,
name|encr_type
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_ENCR_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|encr_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_network_key
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * Network Key"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_NETWORK_KEY
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|network_key_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|network_key
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|network_key_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_cred_mac_addr
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * MAC Address (AP BSSID)"
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ATTR_MAC_ADDR
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|msg
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|msg
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_build_ap_settings
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|plain
parameter_list|)
block|{
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap_settings
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS:  * AP Settings (pre-configured)"
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|plain
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ap_settings
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ap_settings_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
name|wps_build_cred_ssid
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_cred_mac_addr
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_cred_auth_type
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_cred_encr_type
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_cred_network_key
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_m7
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|,
modifier|*
name|plain
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message M7"
argument_list|)
expr_stmt|;
name|plain
operator|=
name|wpabuf_alloc
argument_list|(
literal|500
operator|+
name|wps
operator|->
name|wps
operator|->
name|ap_settings_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|plain
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
operator|+
name|wps
operator|->
name|wps
operator|->
name|ap_settings_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_M7
argument_list|)
operator|||
name|wps_build_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_e_snonce2
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
operator|(
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
name|wps_build_ap_settings
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|)
operator|||
name|wps_build_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_encr_settings
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
name|plain
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|||
name|wps_build_authenticator
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_free
argument_list|(
name|plain
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
name|wps
operator|->
name|wps
operator|->
name|registrar
condition|)
block|{
comment|/* 		 * If the Registrar is only learning our current configuration, 		 * it may not continue protocol run to successful completion. 		 * Store information here to make sure it remains available. 		 */
name|wps_device_store
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|registrar
argument_list|,
operator|&
name|wps
operator|->
name|peer_dev
argument_list|,
name|wps
operator|->
name|uuid_r
argument_list|)
expr_stmt|;
block|}
name|wps
operator|->
name|state
operator|=
name|RECV_M8
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wps_build_wsc_done
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building Message WSC_Done"
argument_list|)
expr_stmt|;
name|msg
operator|=
name|wpabuf_alloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|msg
argument_list|)
operator|||
name|wps_build_msg_type
argument_list|(
name|msg
argument_list|,
name|WPS_WSC_DONE
argument_list|)
operator|||
name|wps_build_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_build_wfa_ext
argument_list|(
name|msg
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
condition|)
name|wps
operator|->
name|state
operator|=
name|RECV_ACK
expr_stmt|;
else|else
block|{
name|wps_success_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|WPS_FINISHED
expr_stmt|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_enrollee_get_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|enum
name|wsc_op_code
modifier|*
name|op_code
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|msg
decl_stmt|;
switch|switch
condition|(
name|wps
operator|->
name|state
condition|)
block|{
case|case
name|SEND_M1
case|:
name|msg
operator|=
name|wps_build_m1
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M3
case|:
name|msg
operator|=
name|wps_build_m3
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M5
case|:
name|msg
operator|=
name|wps_build_m5
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|SEND_M7
case|:
name|msg
operator|=
name|wps_build_m7
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_MSG
expr_stmt|;
break|break;
case|case
name|RECEIVED_M2D
case|:
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
condition|)
block|{
name|msg
operator|=
name|wps_build_wsc_nack
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_NACK
expr_stmt|;
break|break;
block|}
name|msg
operator|=
name|wps_build_wsc_ack
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_ACK
expr_stmt|;
if|if
condition|(
name|msg
condition|)
block|{
comment|/* Another M2/M2D may be received */
name|wps
operator|->
name|state
operator|=
name|RECV_M2
expr_stmt|;
block|}
break|break;
case|case
name|SEND_WSC_NACK
case|:
name|msg
operator|=
name|wps_build_wsc_nack
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_NACK
expr_stmt|;
break|break;
case|case
name|WPS_MSG_DONE
case|:
name|msg
operator|=
name|wps_build_wsc_done
argument_list|(
name|wps
argument_list|)
expr_stmt|;
operator|*
name|op_code
operator|=
name|WSC_Done
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported state %d for building "
literal|"a message"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|msg
operator|=
name|NULL
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|op_code
operator|==
name|WSC_MSG
operator|&&
name|msg
condition|)
block|{
comment|/* Save a copy of the last message for Authenticator derivation 		 */
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|last_msg
argument_list|)
expr_stmt|;
name|wps
operator|->
name|last_msg
operator|=
name|wpabuf_dup
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_registrar_nonce
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|r_nonce
parameter_list|)
block|{
if|if
condition|(
name|r_nonce
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Registrar Nonce received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|r_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Registrar Nonce"
argument_list|,
name|wps
operator|->
name|nonce_r
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_enrollee_nonce
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|e_nonce
parameter_list|)
block|{
if|if
condition|(
name|e_nonce
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Enrollee Nonce received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|e_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Enrollee Nonce received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_uuid_r
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_r
parameter_list|)
block|{
if|if
condition|(
name|uuid_r
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No UUID-R received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|uuid_r
argument_list|,
name|uuid_r
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID-R"
argument_list|,
name|wps
operator|->
name|uuid_r
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_pubkey
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|pk
parameter_list|,
name|size_t
name|pk_len
parameter_list|)
block|{
if|if
condition|(
name|pk
operator|==
name|NULL
operator|||
name|pk_len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Public Key received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dh_pubkey_r
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pk
argument_list|,
name|pk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dh_pubkey_r
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wps_derive_keys
argument_list|(
name|wps
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_r_hash1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|r_hash1
parameter_list|)
block|{
if|if
condition|(
name|r_hash1
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No R-Hash1 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|peer_hash1
argument_list|,
name|r_hash1
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-Hash1"
argument_list|,
name|wps
operator|->
name|peer_hash1
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_r_hash2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|r_hash2
parameter_list|)
block|{
if|if
condition|(
name|r_hash2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No R-Hash2 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|peer_hash2
argument_list|,
name|r_hash2
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-Hash2"
argument_list|,
name|wps
operator|->
name|peer_hash2
argument_list|,
name|WPS_HASH_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_r_snonce1
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|r_snonce1
parameter_list|)
block|{
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|r_snonce1
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No R-SNonce1 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-SNonce1"
argument_list|,
name|r_snonce1
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
comment|/* R-Hash1 = HMAC_AuthKey(R-S1 || PSK1 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|r_snonce1
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk1
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|WPS_PSK_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|wps
operator|->
name|peer_hash1
argument_list|,
name|hash
argument_list|,
name|WPS_HASH_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-Hash1 derived from R-S1 does "
literal|"not match with the pre-committed value"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_DEV_PASSWORD_AUTH_FAILURE
expr_stmt|;
name|wps_pwd_auth_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Registrar proved knowledge of the first "
literal|"half of the device password"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_r_snonce2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|r_snonce2
parameter_list|)
block|{
name|u8
name|hash
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|4
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|4
index|]
decl_stmt|;
if|if
condition|(
name|r_snonce2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No R-SNonce2 received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-SNonce2"
argument_list|,
name|r_snonce2
argument_list|,
name|WPS_SECRET_NONCE_LEN
argument_list|)
expr_stmt|;
comment|/* R-Hash2 = HMAC_AuthKey(R-S2 || PSK2 || PK_E || PK_R) */
name|addr
index|[
literal|0
index|]
operator|=
name|r_snonce2
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|WPS_SECRET_NONCE_LEN
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|wps
operator|->
name|psk2
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|WPS_PSK_LEN
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|wpabuf_head
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|wpabuf_len
argument_list|(
name|wps
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|wps
operator|->
name|authkey
argument_list|,
name|WPS_AUTHKEY_LEN
argument_list|,
literal|4
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|wps
operator|->
name|peer_hash2
argument_list|,
name|hash
argument_list|,
name|WPS_HASH_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: R-Hash2 derived from R-S2 does "
literal|"not match with the pre-committed value"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_DEV_PASSWORD_AUTH_FAILURE
expr_stmt|;
name|wps_pwd_auth_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Registrar proved knowledge of the second "
literal|"half of the device password"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_cred_e
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|cred
parameter_list|,
name|size_t
name|cred_len
parameter_list|,
name|int
name|wps2
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|struct
name|wpabuf
name|msg
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received Credential"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|wps
operator|->
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wps
operator|->
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_set
argument_list|(
operator|&
name|msg
argument_list|,
name|cred
argument_list|,
name|cred_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
operator|&
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
operator|||
name|wps_process_cred
argument_list|(
operator|&
name|attr
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|mac_addr
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MAC Address in the Credential ("
name|MACSTR
literal|") does not match with own address ("
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|wps
operator|->
name|cred
operator|.
name|mac_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * In theory, this could be consider fatal error, but there are 		 * number of deployed implementations using other address here 		 * due to unclarity in the specification. For interoperability 		 * reasons, allow this to be processed since we do not really 		 * use the MAC Address information for anything. 		 */
ifdef|#
directive|ifdef
name|CONFIG_WPS_STRICT
if|if
condition|(
name|wps2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Do not accept incorrect "
literal|"MAC Address in AP Settings"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS2
if|if
condition|(
operator|!
operator|(
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|&
operator|(
name|WPS_ENCR_NONE
operator||
name|WPS_ENCR_TKIP
operator||
name|WPS_ENCR_AES
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|wps
operator|->
name|cred
operator|.
name|encr_type
operator|&
name|WPS_ENCR_WEP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Reject Credential "
literal|"due to WEP configuration"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|error_indication
operator|=
name|WPS_EI_SECURITY_WEP_PROHIBITED
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Reject Credential due to "
literal|"invalid encr_type 0x%x"
argument_list|,
name|wps
operator|->
name|cred
operator|.
name|encr_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS2 */
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|cred_cb
condition|)
block|{
name|wps
operator|->
name|cred
operator|.
name|cred_attr
operator|=
name|cred
operator|-
literal|4
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|cred_attr_len
operator|=
name|cred_len
operator|+
literal|4
expr_stmt|;
name|ret
operator|=
name|wps
operator|->
name|wps
operator|->
name|cred_cb
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|,
operator|&
name|wps
operator|->
name|cred
argument_list|)
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|cred_attr
operator|=
name|NULL
expr_stmt|;
name|wps
operator|->
name|cred
operator|.
name|cred_attr_len
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_creds
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|u8
modifier|*
name|cred
index|[]
parameter_list|,
name|size_t
name|cred_len
index|[]
parameter_list|,
name|size_t
name|num_cred
parameter_list|,
name|int
name|wps2
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|int
name|ok
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|num_cred
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Credential attributes "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_cred
condition|;
name|i
operator|++
control|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|wps_process_cred_e
argument_list|(
name|wps
argument_list|,
name|cred
index|[
name|i
index|]
argument_list|,
name|cred_len
index|[
name|i
index|]
argument_list|,
name|wps2
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
name|ok
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
operator|-
literal|2
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: WEP credential skipped"
argument_list|)
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ok
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No valid Credential attribute "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_process_ap_settings_e
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|attrs
parameter_list|,
name|int
name|wps2
parameter_list|)
block|{
name|struct
name|wps_credential
name|cred
decl_stmt|;
if|if
condition|(
operator|!
name|wps
operator|->
name|wps
operator|->
name|ap
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wps_process_ap_settings
argument_list|(
name|attr
argument_list|,
operator|&
name|cred
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Received new AP configuration from "
literal|"Registrar"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|cred
operator|.
name|mac_addr
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MAC Address in the AP Settings ("
name|MACSTR
literal|") does not match with own address ("
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|cred
operator|.
name|mac_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * In theory, this could be consider fatal error, but there are 		 * number of deployed implementations using other address here 		 * due to unclarity in the specification. For interoperability 		 * reasons, allow this to be processed since we do not really 		 * use the MAC Address information for anything. 		 */
ifdef|#
directive|ifdef
name|CONFIG_WPS_STRICT
if|if
condition|(
name|wps2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Do not accept incorrect "
literal|"MAC Address in AP Settings"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS2
if|if
condition|(
operator|!
operator|(
name|cred
operator|.
name|encr_type
operator|&
operator|(
name|WPS_ENCR_NONE
operator||
name|WPS_ENCR_TKIP
operator||
name|WPS_ENCR_AES
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|cred
operator|.
name|encr_type
operator|&
name|WPS_ENCR_WEP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Reject new AP settings "
literal|"due to WEP configuration"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|error_indication
operator|=
name|WPS_EI_SECURITY_WEP_PROHIBITED
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Reject new AP settings due to "
literal|"invalid encr_type 0x%x"
argument_list|,
name|cred
operator|.
name|encr_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS2 */
ifdef|#
directive|ifdef
name|CONFIG_WPS_STRICT
if|if
condition|(
name|wps2
condition|)
block|{
if|if
condition|(
operator|(
name|cred
operator|.
name|encr_type
operator|&
operator|(
name|WPS_ENCR_TKIP
operator||
name|WPS_ENCR_AES
operator|)
operator|)
operator|==
name|WPS_ENCR_TKIP
operator|||
operator|(
name|cred
operator|.
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPAPSK
operator||
name|WPS_AUTH_WPA2PSK
operator|)
operator|)
operator|==
name|WPS_AUTH_WPAPSK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS-STRICT: Invalid WSC 2.0 "
literal|"AP Settings: WPA-Personal/TKIP only"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|error_indication
operator|=
name|WPS_EI_SECURITY_TKIP_ONLY_PROHIBITED
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
ifdef|#
directive|ifdef
name|CONFIG_WPS2
if|if
condition|(
operator|(
name|cred
operator|.
name|encr_type
operator|&
operator|(
name|WPS_ENCR_TKIP
operator||
name|WPS_ENCR_AES
operator|)
operator|)
operator|==
name|WPS_ENCR_TKIP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Upgrade encr_type TKIP -> "
literal|"TKIP+AES"
argument_list|)
expr_stmt|;
name|cred
operator|.
name|encr_type
operator||=
name|WPS_ENCR_AES
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cred
operator|.
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPAPSK
operator||
name|WPS_AUTH_WPA2PSK
operator|)
operator|)
operator|==
name|WPS_AUTH_WPAPSK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Upgrade auth_type WPAPSK -> "
literal|"WPAPSK+WPA2PSK"
argument_list|)
expr_stmt|;
name|cred
operator|.
name|auth_type
operator||=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS2 */
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|cred_cb
condition|)
block|{
name|cred
operator|.
name|cred_attr
operator|=
name|wpabuf_head
argument_list|(
name|attrs
argument_list|)
expr_stmt|;
name|cred
operator|.
name|cred_attr_len
operator|=
name|wpabuf_len
argument_list|(
name|attrs
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps
operator|->
name|cred_cb
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|,
operator|&
name|cred
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m2
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M2"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M2"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_registrar_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|registrar_nonce
argument_list|)
operator|||
name|wps_process_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|enrollee_nonce
argument_list|)
operator|||
name|wps_process_uuid_r
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|uuid_r
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
comment|/* 	 * Stop here on an AP as an Enrollee if AP Setup is locked unless the 	 * special locked mode is used to allow protocol run up to M7 in order 	 * to support external Registrars that only learn the current AP 	 * configuration without changing it. 	 */
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
operator|(
operator|(
name|wps
operator|->
name|wps
operator|->
name|ap_setup_locked
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap_setup_locked
operator|!=
literal|2
operator|)
operator|||
name|wps
operator|->
name|dev_password
operator|==
name|NULL
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP Setup is locked - refuse "
literal|"registration of a new Registrar"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_SETUP_LOCKED
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_pubkey
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|public_key
argument_list|,
name|attr
operator|->
name|public_key_len
argument_list|)
operator|||
name|wps_process_authenticator
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|authenticator
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_process_device_attrs
argument_list|(
operator|&
name|wps
operator|->
name|peer_dev
argument_list|,
name|attr
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wps
operator|->
name|state
operator|=
name|SEND_M3
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m2d
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M2D"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M2D"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Manufacturer"
argument_list|,
name|attr
operator|->
name|manufacturer
argument_list|,
name|attr
operator|->
name|manufacturer_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Model Name"
argument_list|,
name|attr
operator|->
name|model_name
argument_list|,
name|attr
operator|->
name|model_name_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Model Number"
argument_list|,
name|attr
operator|->
name|model_number
argument_list|,
name|attr
operator|->
name|model_number_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Serial Number"
argument_list|,
name|attr
operator|->
name|serial_number
argument_list|,
name|attr
operator|->
name|serial_number_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Device Name"
argument_list|,
name|attr
operator|->
name|dev_name
argument_list|,
name|attr
operator|->
name|dev_name_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|event_cb
condition|)
block|{
name|union
name|wps_event_data
name|data
decl_stmt|;
name|struct
name|wps_event_m2d
modifier|*
name|m2d
init|=
operator|&
name|data
operator|.
name|m2d
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|config_methods
condition|)
name|m2d
operator|->
name|config_methods
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|->
name|config_methods
argument_list|)
expr_stmt|;
name|m2d
operator|->
name|manufacturer
operator|=
name|attr
operator|->
name|manufacturer
expr_stmt|;
name|m2d
operator|->
name|manufacturer_len
operator|=
name|attr
operator|->
name|manufacturer_len
expr_stmt|;
name|m2d
operator|->
name|model_name
operator|=
name|attr
operator|->
name|model_name
expr_stmt|;
name|m2d
operator|->
name|model_name_len
operator|=
name|attr
operator|->
name|model_name_len
expr_stmt|;
name|m2d
operator|->
name|model_number
operator|=
name|attr
operator|->
name|model_number
expr_stmt|;
name|m2d
operator|->
name|model_number_len
operator|=
name|attr
operator|->
name|model_number_len
expr_stmt|;
name|m2d
operator|->
name|serial_number
operator|=
name|attr
operator|->
name|serial_number
expr_stmt|;
name|m2d
operator|->
name|serial_number_len
operator|=
name|attr
operator|->
name|serial_number_len
expr_stmt|;
name|m2d
operator|->
name|dev_name
operator|=
name|attr
operator|->
name|dev_name
expr_stmt|;
name|m2d
operator|->
name|dev_name_len
operator|=
name|attr
operator|->
name|dev_name_len
expr_stmt|;
name|m2d
operator|->
name|primary_dev_type
operator|=
name|attr
operator|->
name|primary_dev_type
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|config_error
condition|)
name|m2d
operator|->
name|config_error
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|->
name|config_error
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|dev_password_id
condition|)
name|m2d
operator|->
name|dev_password_id
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|->
name|dev_password_id
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps
operator|->
name|event_cb
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|,
name|WPS_EV_M2D
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
name|wps
operator|->
name|state
operator|=
name|RECEIVED_M2D
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m4
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|decrypted
decl_stmt|;
name|struct
name|wps_parse_attr
name|eattr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M4"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M4"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|enrollee_nonce
argument_list|)
operator|||
name|wps_process_authenticator
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|authenticator
argument_list|,
name|msg
argument_list|)
operator|||
name|wps_process_r_hash1
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|r_hash1
argument_list|)
operator|||
name|wps_process_r_hash2
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|r_hash2
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|decrypted
operator|=
name|wps_decrypt_encr_settings
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|encr_settings
argument_list|,
name|attr
operator|->
name|encr_settings_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to decrypted Encrypted "
literal|"Settings attribute"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_validate_m4_encr
argument_list|(
name|decrypted
argument_list|,
name|attr
operator|->
name|version2
operator|!=
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing decrypted Encrypted Settings "
literal|"attribute"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|decrypted
argument_list|,
operator|&
name|eattr
argument_list|)
operator|<
literal|0
operator|||
name|wps_process_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|decrypted
argument_list|,
name|eattr
operator|.
name|key_wrap_auth
argument_list|)
operator|||
name|wps_process_r_snonce1
argument_list|(
name|wps
argument_list|,
name|eattr
operator|.
name|r_snonce1
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M5
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m6
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|decrypted
decl_stmt|;
name|struct
name|wps_parse_attr
name|eattr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M6"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M6
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M6"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|enrollee_nonce
argument_list|)
operator|||
name|wps_process_authenticator
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|authenticator
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|decrypted
operator|=
name|wps_decrypt_encr_settings
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|encr_settings
argument_list|,
name|attr
operator|->
name|encr_settings_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to decrypted Encrypted "
literal|"Settings attribute"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_validate_m6_encr
argument_list|(
name|decrypted
argument_list|,
name|attr
operator|->
name|version2
operator|!=
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing decrypted Encrypted Settings "
literal|"attribute"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|decrypted
argument_list|,
operator|&
name|eattr
argument_list|)
operator|<
literal|0
operator|||
name|wps_process_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|decrypted
argument_list|,
name|eattr
operator|.
name|key_wrap_auth
argument_list|)
operator|||
name|wps_process_r_snonce2
argument_list|(
name|wps
argument_list|,
name|eattr
operator|.
name|r_snonce2
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
condition|)
name|wps
operator|->
name|wps
operator|->
name|event_cb
argument_list|(
name|wps
operator|->
name|wps
operator|->
name|cb_ctx
argument_list|,
name|WPS_EV_AP_PIN_SUCCESS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_M7
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_m8
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|decrypted
decl_stmt|;
name|struct
name|wps_parse_attr
name|eattr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received M8"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|state
operator|!=
name|RECV_M8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected state (%d) for "
literal|"receiving M8"
argument_list|,
name|wps
operator|->
name|state
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_process_enrollee_nonce
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|enrollee_nonce
argument_list|)
operator|||
name|wps_process_authenticator
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|authenticator
argument_list|,
name|msg
argument_list|)
condition|)
block|{
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|wps
operator|->
name|ap
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap_setup_locked
condition|)
block|{
comment|/* 		 * Stop here if special ap_setup_locked == 2 mode allowed the 		 * protocol to continue beyond M2. This allows ER to learn the 		 * current AP settings without changing them. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP Setup is locked - refuse "
literal|"registration of a new Registrar"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_error
operator|=
name|WPS_CFG_SETUP_LOCKED
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|decrypted
operator|=
name|wps_decrypt_encr_settings
argument_list|(
name|wps
argument_list|,
name|attr
operator|->
name|encr_settings
argument_list|,
name|attr
operator|->
name|encr_settings_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to decrypted Encrypted "
literal|"Settings attribute"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
if|if
condition|(
name|wps_validate_m8_encr
argument_list|(
name|decrypted
argument_list|,
name|wps
operator|->
name|wps
operator|->
name|ap
argument_list|,
name|attr
operator|->
name|version2
operator|!=
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing decrypted Encrypted Settings "
literal|"attribute"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|decrypted
argument_list|,
operator|&
name|eattr
argument_list|)
operator|<
literal|0
operator|||
name|wps_process_key_wrap_auth
argument_list|(
name|wps
argument_list|,
name|decrypted
argument_list|,
name|eattr
operator|.
name|key_wrap_auth
argument_list|)
operator|||
name|wps_process_creds
argument_list|(
name|wps
argument_list|,
name|eattr
operator|.
name|cred
argument_list|,
name|eattr
operator|.
name|cred_len
argument_list|,
name|eattr
operator|.
name|num_cred
argument_list|,
name|attr
operator|->
name|version2
operator|!=
name|NULL
argument_list|)
operator|||
name|wps_process_ap_settings_e
argument_list|(
name|wps
argument_list|,
operator|&
name|eattr
argument_list|,
name|decrypted
argument_list|,
name|attr
operator|->
name|version2
operator|!=
name|NULL
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
name|wpabuf_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|WPS_MSG_DONE
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|enum
name|wps_process_res
name|ret
init|=
name|WPS_CONTINUE
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_MSG"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
name|attr
operator|.
name|enrollee_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|attr
operator|.
name|enrollee_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in enrollee nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_CONTINUE
return|;
block|}
switch|switch
condition|(
operator|*
name|attr
operator|.
name|msg_type
condition|)
block|{
case|case
name|WPS_M2
case|:
if|if
condition|(
name|wps_validate_m2
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
name|ret
operator|=
name|wps_process_m2
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_M2D
case|:
if|if
condition|(
name|wps_validate_m2d
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
name|ret
operator|=
name|wps_process_m2d
argument_list|(
name|wps
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_M4
case|:
if|if
condition|(
name|wps_validate_m4
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
name|ret
operator|=
name|wps_process_m4
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
operator|||
name|wps
operator|->
name|state
operator|==
name|SEND_WSC_NACK
condition|)
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M4
argument_list|,
name|wps
operator|->
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_M6
case|:
if|if
condition|(
name|wps_validate_m6
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
name|ret
operator|=
name|wps_process_m6
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
operator|||
name|wps
operator|->
name|state
operator|==
name|SEND_WSC_NACK
condition|)
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M6
argument_list|,
name|wps
operator|->
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_M8
case|:
if|if
condition|(
name|wps_validate_m8
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
name|ret
operator|=
name|wps_process_m8
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|WPS_FAILURE
operator|||
name|wps
operator|->
name|state
operator|==
name|SEND_WSC_NACK
condition|)
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M8
argument_list|,
name|wps
operator|->
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
comment|/* 	 * Save a copy of the last message for Authenticator derivation if we 	 * are continuing. However, skip M2D since it is not authenticated and 	 * neither is the ACK/NACK response frame. This allows the possibly 	 * following M2 to be processed correctly by using the previously sent 	 * M1 in Authenticator derivation. 	 */
if|if
condition|(
name|ret
operator|==
name|WPS_CONTINUE
operator|&&
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_M2D
condition|)
block|{
comment|/* Save a copy of the last message for Authenticator derivation 		 */
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|last_msg
argument_list|)
expr_stmt|;
name|wps
operator|->
name|last_msg
operator|=
name|wpabuf_dup
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_ack
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_ACK"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_WSC_ACK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|registrar_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in registrar nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|enrollee_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|attr
operator|.
name|enrollee_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in enrollee nonce"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|wps
operator|->
name|state
operator|==
name|RECV_ACK
operator|&&
name|wps
operator|->
name|wps
operator|->
name|ap
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: External Registrar registration "
literal|"completed successfully"
argument_list|)
expr_stmt|;
name|wps_success_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|)
expr_stmt|;
name|wps
operator|->
name|state
operator|=
name|WPS_FINISHED
expr_stmt|;
return|return
name|WPS_DONE
return|;
block|}
return|return
name|WPS_FAILURE
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wps_process_res
name|wps_process_wsc_nack
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|u16
name|config_error
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received WSC_NACK"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
if|if
condition|(
name|attr
operator|.
name|msg_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Message Type attribute"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|!=
name|WPS_WSC_NACK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Message Type %d"
argument_list|,
operator|*
name|attr
operator|.
name|msg_type
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|registrar_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_r
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in registrar nonce"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received Registrar Nonce"
argument_list|,
name|attr
operator|.
name|registrar_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Expected Registrar Nonce"
argument_list|,
name|wps
operator|->
name|nonce_r
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|enrollee_nonce
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|wps
operator|->
name|nonce_e
argument_list|,
name|attr
operator|.
name|enrollee_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mismatch in enrollee nonce"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received Enrollee Nonce"
argument_list|,
name|attr
operator|.
name|enrollee_nonce
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Expected Enrollee Nonce"
argument_list|,
name|wps
operator|->
name|nonce_e
argument_list|,
name|WPS_NONCE_LEN
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|config_error
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Configuration Error attribute "
literal|"in WSC_NACK"
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
name|config_error
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|config_error
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Registrar terminated negotiation with "
literal|"Configuration Error %d"
argument_list|,
name|config_error
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|wps
operator|->
name|state
condition|)
block|{
case|case
name|RECV_M4
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M3
argument_list|,
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|)
expr_stmt|;
break|break;
case|case
name|RECV_M6
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M5
argument_list|,
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|)
expr_stmt|;
break|break;
case|case
name|RECV_M8
case|:
name|wps_fail_event
argument_list|(
name|wps
operator|->
name|wps
argument_list|,
name|WPS_M7
argument_list|,
name|config_error
argument_list|,
name|wps
operator|->
name|error_indication
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
comment|/* Followed by NACK if Enrollee is Supplicant or EAP-Failure if 	 * Enrollee is Authenticator */
name|wps
operator|->
name|state
operator|=
name|SEND_WSC_NACK
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
end_function

begin_function
name|enum
name|wps_process_res
name|wps_enrollee_process_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|enum
name|wsc_op_code
name|op_code
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Processing received message (len=%lu "
literal|"op_code=%d)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
argument_list|,
name|op_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|op_code
operator|==
name|WSC_UPnP
condition|)
block|{
comment|/* Determine the OpCode based on message type attribute */
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|==
literal|0
operator|&&
name|attr
operator|.
name|msg_type
condition|)
block|{
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|==
name|WPS_WSC_ACK
condition|)
name|op_code
operator|=
name|WSC_ACK
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|attr
operator|.
name|msg_type
operator|==
name|WPS_WSC_NACK
condition|)
name|op_code
operator|=
name|WSC_NACK
expr_stmt|;
block|}
block|}
switch|switch
condition|(
name|op_code
condition|)
block|{
case|case
name|WSC_MSG
case|:
case|case
name|WSC_UPnP
case|:
return|return
name|wps_process_wsc_msg
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
return|;
case|case
name|WSC_ACK
case|:
if|if
condition|(
name|wps_validate_wsc_ack
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
return|return
name|wps_process_wsc_ack
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
return|;
case|case
name|WSC_NACK
case|:
if|if
condition|(
name|wps_validate_wsc_nack
argument_list|(
name|msg
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WPS_FAILURE
return|;
return|return
name|wps_process_wsc_nack
argument_list|(
name|wps
argument_list|,
name|msg
argument_list|)
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported op_code %d"
argument_list|,
name|op_code
argument_list|)
expr_stmt|;
return|return
name|WPS_FAILURE
return|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Protected Setup - attribute parsing  * Copyright (c) 2008, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"wps_defs.h"
end_include

begin_include
include|#
directive|include
file|"wps_attr_parse.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_WPS_STRICT
end_ifndef

begin_define
define|#
directive|define
name|WPS_WORKAROUNDS
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_STRICT */
end_comment

begin_function
specifier|static
name|int
name|wps_set_vendor_ext_wfa_subelem
parameter_list|(
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|,
name|u8
name|id
parameter_list|,
name|u8
name|len
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_EXCESSIVE
argument_list|,
literal|"WPS: WFA subelement id=%u len=%u"
argument_list|,
name|id
argument_list|,
name|len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|WFA_ELEM_VERSION2
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Version2 length "
literal|"%u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|version2
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|WFA_ELEM_AUTHORIZEDMACS
case|:
name|attr
operator|->
name|authorized_macs
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|authorized_macs_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|WFA_ELEM_NETWORK_KEY_SHAREABLE
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Network Key "
literal|"Shareable length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|network_key_shareable
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|WFA_ELEM_REQUEST_TO_ENROLL
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Request to Enroll "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|request_to_enroll
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|WFA_ELEM_SETTINGS_DELAY_TIME
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Settings Delay "
literal|"Time length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|settings_delay_time
operator|=
name|pos
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS: Skipped unknown WFA Vendor "
literal|"Extension subelement %u"
argument_list|,
name|id
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_parse_vendor_ext_wfa
parameter_list|(
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|u16
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
init|=
name|pos
operator|+
name|len
decl_stmt|;
name|u8
name|id
decl_stmt|,
name|elen
decl_stmt|;
while|while
condition|(
name|pos
operator|+
literal|2
operator|<
name|end
condition|)
block|{
name|id
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|elen
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|elen
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|wps_set_vendor_ext_wfa_subelem
argument_list|(
name|attr
argument_list|,
name|id
argument_list|,
name|elen
argument_list|,
name|pos
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|elen
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_parse_vendor_ext
parameter_list|(
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|u16
name|len
parameter_list|)
block|{
name|u32
name|vendor_id
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Skip invalid Vendor Extension"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|vendor_id
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|vendor_id
condition|)
block|{
case|case
name|WPS_VENDOR_ID_WFA
case|:
return|return
name|wps_parse_vendor_ext_wfa
argument_list|(
name|attr
argument_list|,
name|pos
operator|+
literal|3
argument_list|,
name|len
operator|-
literal|3
argument_list|)
return|;
block|}
comment|/* Handle unknown vendor extensions */
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS: Unknown Vendor Extension (Vendor ID %u)"
argument_list|,
name|vendor_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|WPS_MAX_VENDOR_EXT_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Too long Vendor Extension (%u)"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|attr
operator|->
name|num_vendor_ext
operator|>=
name|MAX_WPS_PARSE_VENDOR_EXT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Skipped Vendor Extension "
literal|"attribute (max %d vendor extensions)"
argument_list|,
name|MAX_WPS_PARSE_VENDOR_EXT
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|vendor_ext
index|[
name|attr
operator|->
name|num_vendor_ext
index|]
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|vendor_ext_len
index|[
name|attr
operator|->
name|num_vendor_ext
index|]
operator|=
name|len
expr_stmt|;
name|attr
operator|->
name|num_vendor_ext
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_set_attr
parameter_list|(
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|,
name|u16
name|type
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|u16
name|len
parameter_list|)
block|{
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|ATTR_VERSION
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Version length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|version
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_MSG_TYPE
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Message Type "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|msg_type
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_ENROLLEE_NONCE
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_NONCE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Enrollee Nonce "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|enrollee_nonce
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_REGISTRAR_NONCE
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_NONCE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Registrar Nonce "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|registrar_nonce
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_UUID_E
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_UUID_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid UUID-E length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|uuid_e
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_UUID_R
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_UUID_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid UUID-R length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|uuid_r
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_AUTH_TYPE_FLAGS
case|:
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Authentication "
literal|"Type Flags length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|auth_type_flags
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_ENCR_TYPE_FLAGS
case|:
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Encryption Type "
literal|"Flags length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|encr_type_flags
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_CONN_TYPE_FLAGS
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Connection Type "
literal|"Flags length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|conn_type_flags
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_CONFIG_METHODS
case|:
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Config Methods "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|config_methods
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_SELECTED_REGISTRAR_CONFIG_METHODS
case|:
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Selected "
literal|"Registrar Config Methods length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|sel_reg_config_methods
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_PRIMARY_DEV_TYPE
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_DEV_TYPE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Primary Device "
literal|"Type length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|primary_dev_type
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_RF_BANDS
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid RF Bands length "
literal|"%u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|rf_bands
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_ASSOC_STATE
case|:
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Association State "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|assoc_state
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_CONFIG_ERROR
case|:
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Configuration "
literal|"Error length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|config_error
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_DEV_PASSWORD_ID
case|:
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Device Password "
literal|"ID length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|dev_password_id
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_OOB_DEVICE_PASSWORD
case|:
if|if
condition|(
name|len
operator|<
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|2
operator|+
name|WPS_OOB_DEVICE_PASSWORD_MIN_LEN
operator|||
name|len
operator|>
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|2
operator|+
name|WPS_OOB_DEVICE_PASSWORD_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid OOB Device "
literal|"Password length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|oob_dev_password
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|oob_dev_password_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_OS_VERSION
case|:
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid OS Version length "
literal|"%u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|os_version
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_WPS_STATE
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Wi-Fi Protected "
literal|"Setup State length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|wps_state
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_AUTHENTICATOR
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_AUTHENTICATOR_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Authenticator "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|authenticator
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_R_HASH1
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_HASH_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid R-Hash1 length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|r_hash1
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_R_HASH2
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_HASH_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid R-Hash2 length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|r_hash2
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_E_HASH1
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_HASH_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid E-Hash1 length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|e_hash1
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_E_HASH2
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_HASH_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid E-Hash2 length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|e_hash2
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_R_SNONCE1
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_SECRET_NONCE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid R-SNonce1 length "
literal|"%u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|r_snonce1
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_R_SNONCE2
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_SECRET_NONCE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid R-SNonce2 length "
literal|"%u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|r_snonce2
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_E_SNONCE1
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_SECRET_NONCE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid E-SNonce1 length "
literal|"%u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|e_snonce1
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_E_SNONCE2
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_SECRET_NONCE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid E-SNonce2 length "
literal|"%u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|e_snonce2
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_KEY_WRAP_AUTH
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_KWA_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Key Wrap "
literal|"Authenticator length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|key_wrap_auth
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_AUTH_TYPE
case|:
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Authentication "
literal|"Type length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|auth_type
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_ENCR_TYPE
case|:
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Encryption "
literal|"Type length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|encr_type
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_NETWORK_INDEX
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Network Index "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|network_idx
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_NETWORK_KEY_INDEX
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Network Key Index "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|network_key_idx
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_MAC_ADDR
case|:
if|if
condition|(
name|len
operator|!=
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid MAC Address "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|mac_addr
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_KEY_PROVIDED_AUTO
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Key Provided "
literal|"Automatically length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|key_prov_auto
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_802_1X_ENABLED
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid 802.1X Enabled "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|dot1x_enabled
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_SELECTED_REGISTRAR
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Selected Registrar"
literal|" length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|selected_registrar
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_REQUEST_TYPE
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Request Type "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|request_type
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_RESPONSE_TYPE
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Response Type "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|response_type
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_MANUFACTURER
case|:
name|attr
operator|->
name|manufacturer
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|manufacturer_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_MODEL_NAME
case|:
name|attr
operator|->
name|model_name
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|model_name_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_MODEL_NUMBER
case|:
name|attr
operator|->
name|model_number
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|model_number_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_SERIAL_NUMBER
case|:
name|attr
operator|->
name|serial_number
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|serial_number_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_DEV_NAME
case|:
name|attr
operator|->
name|dev_name
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|dev_name_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_PUBLIC_KEY
case|:
name|attr
operator|->
name|public_key
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|public_key_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_ENCR_SETTINGS
case|:
name|attr
operator|->
name|encr_settings
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|encr_settings_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_CRED
case|:
if|if
condition|(
name|attr
operator|->
name|num_cred
operator|>=
name|MAX_CRED_COUNT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Skipped Credential "
literal|"attribute (max %d credentials)"
argument_list|,
name|MAX_CRED_COUNT
argument_list|)
expr_stmt|;
break|break;
block|}
name|attr
operator|->
name|cred
index|[
name|attr
operator|->
name|num_cred
index|]
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|cred_len
index|[
name|attr
operator|->
name|num_cred
index|]
operator|=
name|len
expr_stmt|;
name|attr
operator|->
name|num_cred
operator|++
expr_stmt|;
break|break;
case|case
name|ATTR_SSID
case|:
name|attr
operator|->
name|ssid
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|ssid_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_NETWORK_KEY
case|:
name|attr
operator|->
name|network_key
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|network_key_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_EAP_TYPE
case|:
name|attr
operator|->
name|eap_type
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|eap_type_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_EAP_IDENTITY
case|:
name|attr
operator|->
name|eap_identity
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|eap_identity_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_AP_SETUP_LOCKED
case|:
if|if
condition|(
name|len
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid AP Setup Locked "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|ap_setup_locked
operator|=
name|pos
expr_stmt|;
break|break;
case|case
name|ATTR_REQUESTED_DEV_TYPE
case|:
if|if
condition|(
name|len
operator|!=
name|WPS_DEV_TYPE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Requested Device "
literal|"Type length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|attr
operator|->
name|num_req_dev_type
operator|>=
name|MAX_REQ_DEV_TYPE_COUNT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Skipped Requested Device "
literal|"Type attribute (max %u types)"
argument_list|,
name|MAX_REQ_DEV_TYPE_COUNT
argument_list|)
expr_stmt|;
break|break;
block|}
name|attr
operator|->
name|req_dev_type
index|[
name|attr
operator|->
name|num_req_dev_type
index|]
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|num_req_dev_type
operator|++
expr_stmt|;
break|break;
case|case
name|ATTR_SECONDARY_DEV_TYPE_LIST
case|:
if|if
condition|(
name|len
operator|>
name|WPS_SEC_DEV_TYPE_MAX_LEN
operator|||
operator|(
name|len
operator|%
name|WPS_DEV_TYPE_LEN
operator|)
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid Secondary Device "
literal|"Type length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|sec_dev_type_list
operator|=
name|pos
expr_stmt|;
name|attr
operator|->
name|sec_dev_type_list_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|ATTR_VENDOR_EXT
case|:
if|if
condition|(
name|wps_parse_vendor_ext
argument_list|(
name|attr
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|ATTR_AP_CHANNEL
case|:
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid AP Channel "
literal|"length %u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|attr
operator|->
name|ap_channel
operator|=
name|pos
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unsupported attribute type 0x%x "
literal|"len=%u"
argument_list|,
name|type
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wps_parse_msg
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u16
name|type
decl_stmt|,
name|len
decl_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
name|u16
name|prev_type
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
name|os_memset
argument_list|(
name|attr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid message - "
literal|"%lu bytes remaining"
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_EXCESSIVE
argument_list|,
literal|"WPS: attr type=0x%x len=%u"
argument_list|,
name|type
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|end
operator|-
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Attribute overflow"
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS: Message data"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
comment|/* 			 * Some deployed APs seem to have a bug in encoding of 			 * Network Key attribute in the Credential attribute 			 * where they add an extra octet after the Network Key 			 * attribute at least when open network is being 			 * provisioned. 			 */
if|if
condition|(
operator|(
name|type
operator|&
literal|0xff00
operator|)
operator|!=
literal|0x1000
operator|&&
name|prev_type
operator|==
name|ATTR_NETWORK_KEY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Workaround - try "
literal|"to skip unexpected octet after "
literal|"Network Key"
argument_list|)
expr_stmt|;
name|pos
operator|-=
literal|3
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
if|if
condition|(
name|type
operator|==
literal|0
operator|&&
name|len
operator|==
literal|0
condition|)
block|{
comment|/* 			 * Mac OS X 10.6 seems to be adding 0x00 padding to the 			 * end of M1. Skip those to avoid interop issues. 			 */
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|end
operator|-
name|pos
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pos
index|[
name|i
index|]
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|end
operator|-
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Workaround - skip "
literal|"unexpected message padding"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
if|if
condition|(
name|wps_set_attr
argument_list|(
name|attr
argument_list|,
name|type
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
ifdef|#
directive|ifdef
name|WPS_WORKAROUNDS
name|prev_type
operator|=
name|type
expr_stmt|;
endif|#
directive|endif
comment|/* WPS_WORKAROUNDS */
name|pos
operator|+=
name|len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


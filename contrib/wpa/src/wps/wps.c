begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Protected Setup  * Copyright (c) 2007-2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"wps_i.h"
end_include

begin_include
include|#
directive|include
file|"wps_dev_attr.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_comment
comment|/**  * wps_init - Initialize WPS Registration protocol data  * @cfg: WPS configuration  * Returns: Pointer to allocated data or %NULL on failure  *  * This function is used to initialize WPS data for a registration protocol  * instance (i.e., each run of registration protocol as a Registrar of  * Enrollee. The caller is responsible for freeing this data after the  * registration run has been completed by calling wps_deinit().  */
end_comment

begin_function
name|struct
name|wps_data
modifier|*
name|wps_init
parameter_list|(
specifier|const
name|struct
name|wps_config
modifier|*
name|cfg
parameter_list|)
block|{
name|struct
name|wps_data
modifier|*
name|data
init|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|->
name|wps
operator|=
name|cfg
operator|->
name|wps
expr_stmt|;
name|data
operator|->
name|registrar
operator|=
name|cfg
operator|->
name|registrar
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|registrar
condition|)
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|uuid_r
argument_list|,
name|cfg
operator|->
name|wps
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|mac_addr_e
argument_list|,
name|cfg
operator|->
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|uuid_e
argument_list|,
name|cfg
operator|->
name|wps
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cfg
operator|->
name|pin
condition|)
block|{
name|data
operator|->
name|dev_pw_id
operator|=
name|DEV_PW_DEFAULT
expr_stmt|;
name|data
operator|->
name|dev_password
operator|=
name|os_malloc
argument_list|(
name|cfg
operator|->
name|pin_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|dev_password
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|dev_password
argument_list|,
name|cfg
operator|->
name|pin
argument_list|,
name|cfg
operator|->
name|pin_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|dev_password_len
operator|=
name|cfg
operator|->
name|pin_len
expr_stmt|;
block|}
name|data
operator|->
name|pbc
operator|=
name|cfg
operator|->
name|pbc
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|pbc
condition|)
block|{
comment|/* Use special PIN '00000000' for PBC */
name|data
operator|->
name|dev_pw_id
operator|=
name|DEV_PW_PUSHBUTTON
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|dev_password
argument_list|)
expr_stmt|;
name|data
operator|->
name|dev_password
operator|=
name|os_malloc
argument_list|(
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|dev_password
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memset
argument_list|(
name|data
operator|->
name|dev_password
argument_list|,
literal|'0'
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|data
operator|->
name|dev_password_len
operator|=
literal|8
expr_stmt|;
block|}
name|data
operator|->
name|state
operator|=
name|data
operator|->
name|registrar
condition|?
name|RECV_M1
else|:
name|SEND_M1
expr_stmt|;
if|if
condition|(
name|cfg
operator|->
name|assoc_wps_ie
condition|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: WPS IE from (Re)AssocReq"
argument_list|,
name|cfg
operator|->
name|assoc_wps_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|cfg
operator|->
name|assoc_wps_ie
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to parse WPS IE "
literal|"from (Re)AssocReq"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|attr
operator|.
name|request_type
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Request Type attribute "
literal|"in (Re)AssocReq WPS IE"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Request Type (from WPS IE "
literal|"in (Re)AssocReq WPS IE): %d"
argument_list|,
operator|*
name|attr
operator|.
name|request_type
argument_list|)
expr_stmt|;
name|data
operator|->
name|request_type
operator|=
operator|*
name|attr
operator|.
name|request_type
expr_stmt|;
block|}
block|}
return|return
name|data
return|;
block|}
end_function

begin_comment
comment|/**  * wps_deinit - Deinitialize WPS Registration protocol data  * @data: WPS Registration protocol data from wps_init()  */
end_comment

begin_function
name|void
name|wps_deinit
parameter_list|(
name|struct
name|wps_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|->
name|wps_pin_revealed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Full PIN information revealed and "
literal|"negotiation failed"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|registrar
condition|)
name|wps_registrar_invalidate_pin
argument_list|(
name|data
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|data
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|registrar
condition|)
name|wps_registrar_unlock_pin
argument_list|(
name|data
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|data
operator|->
name|uuid_e
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|dh_privkey
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|dh_pubkey_e
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|dh_pubkey_r
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|data
operator|->
name|last_msg
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|dev_password
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|new_psk
argument_list|)
expr_stmt|;
name|wps_device_data_free
argument_list|(
operator|&
name|data
operator|->
name|peer_dev
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wps_process_msg - Process a WPS message  * @wps: WPS Registration protocol data from wps_init()  * @op_code: Message OP Code  * @msg: Message data  * Returns: Processing result  *  * This function is used to process WPS messages with OP Codes WSC_ACK,  * WSC_NACK, WSC_MSG, and WSC_Done. The caller (e.g., EAP server/peer) is  * responsible for reassembling the messages before calling this function.  * Response to this message is built by calling wps_get_msg().  */
end_comment

begin_function
name|enum
name|wps_process_res
name|wps_process_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|enum
name|wsc_op_code
name|op_code
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
if|if
condition|(
name|wps
operator|->
name|registrar
condition|)
return|return
name|wps_registrar_process_msg
argument_list|(
name|wps
argument_list|,
name|op_code
argument_list|,
name|msg
argument_list|)
return|;
else|else
return|return
name|wps_enrollee_process_msg
argument_list|(
name|wps
argument_list|,
name|op_code
argument_list|,
name|msg
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wps_get_msg - Build a WPS message  * @wps: WPS Registration protocol data from wps_init()  * @op_code: Buffer for returning message OP Code  * Returns: The generated WPS message or %NULL on failure  *  * This function is used to build a response to a message processed by calling  * wps_process_msg(). The caller is responsible for freeing the buffer.  */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_get_msg
parameter_list|(
name|struct
name|wps_data
modifier|*
name|wps
parameter_list|,
name|enum
name|wsc_op_code
modifier|*
name|op_code
parameter_list|)
block|{
if|if
condition|(
name|wps
operator|->
name|registrar
condition|)
return|return
name|wps_registrar_get_msg
argument_list|(
name|wps
argument_list|,
name|op_code
argument_list|)
return|;
else|else
return|return
name|wps_enrollee_get_msg
argument_list|(
name|wps
argument_list|,
name|op_code
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wps_is_selected_pbc_registrar - Check whether WPS IE indicates active PBC  * @msg: WPS IE contents from Beacon or Probe Response frame  * Returns: 1 if PBC Registrar is active, 0 if not  */
end_comment

begin_function
name|int
name|wps_is_selected_pbc_registrar
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
comment|/* 	 * In theory, this could also verify that attr.sel_reg_config_methods 	 * includes WPS_CONFIG_PUSHBUTTON, but some deployed AP implementations 	 * do not set Selected Registrar Config Methods attribute properly, so 	 * it is safer to just use Device Password ID here. 	 */
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
operator|||
operator|!
name|attr
operator|.
name|selected_registrar
operator|||
operator|*
name|attr
operator|.
name|selected_registrar
operator|==
literal|0
operator|||
operator|!
name|attr
operator|.
name|dev_password_id
operator|||
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|dev_password_id
argument_list|)
operator|!=
name|DEV_PW_PUSHBUTTON
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wps_is_selected_pin_registrar - Check whether WPS IE indicates active PIN  * @msg: WPS IE contents from Beacon or Probe Response frame  * Returns: 1 if PIN Registrar is active, 0 if not  */
end_comment

begin_function
name|int
name|wps_is_selected_pin_registrar
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
comment|/* 	 * In theory, this could also verify that attr.sel_reg_config_methods 	 * includes WPS_CONFIG_LABEL, WPS_CONFIG_DISPLAY, or WPS_CONFIG_KEYPAD, 	 * but some deployed AP implementations do not set Selected Registrar 	 * Config Methods attribute properly, so it is safer to just use 	 * Device Password ID here. 	 */
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|attr
operator|.
name|selected_registrar
operator|||
operator|*
name|attr
operator|.
name|selected_registrar
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|attr
operator|.
name|dev_password_id
operator|!=
name|NULL
operator|&&
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|dev_password_id
argument_list|)
operator|==
name|DEV_PW_PUSHBUTTON
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wps_get_uuid_e - Get UUID-E from WPS IE  * @msg: WPS IE contents from Beacon or Probe Response frame  * Returns: Pointer to UUID-E or %NULL if not included  *  * The returned pointer is to the msg contents and it remains valid only as  * long as the msg buffer is valid.  */
end_comment

begin_function
specifier|const
name|u8
modifier|*
name|wps_get_uuid_e
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
return|return
name|attr
operator|.
name|uuid_e
return|;
block|}
end_function

begin_comment
comment|/**  * wps_build_assoc_req_ie - Build WPS IE for (Re)Association Request  * @req_type: Value for Request Type attribute  * Returns: WPS IE or %NULL on failure  *  * The caller is responsible for freeing the buffer.  */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_build_assoc_req_ie
parameter_list|(
name|enum
name|wps_request_type
name|req_type
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building WPS IE for (Re)Association "
literal|"Request"
argument_list|)
expr_stmt|;
name|ie
operator|=
name|wpabuf_alloc
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpabuf_put_u8
argument_list|(
name|ie
argument_list|,
name|WLAN_EID_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|ie
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|ie
argument_list|,
name|WPS_DEV_OUI_WFA
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|ie
argument_list|)
operator|||
name|wps_build_req_type
argument_list|(
name|ie
argument_list|,
name|req_type
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|len
operator|=
name|wpabuf_len
argument_list|(
name|ie
argument_list|)
operator|-
literal|2
expr_stmt|;
return|return
name|ie
return|;
block|}
end_function

begin_comment
comment|/**  * wps_build_probe_req_ie - Build WPS IE for Probe Request  * @pbc: Whether searching for PBC mode APs  * @dev: Device attributes  * @uuid: Own UUID  * @req_type: Value for Request Type attribute  * Returns: WPS IE or %NULL on failure  *  * The caller is responsible for freeing the buffer.  */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wps_build_probe_req_ie
parameter_list|(
name|int
name|pbc
parameter_list|,
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid
parameter_list|,
name|enum
name|wps_request_type
name|req_type
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
name|u8
modifier|*
name|len
decl_stmt|;
name|u16
name|methods
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Building WPS IE for Probe Request"
argument_list|)
expr_stmt|;
name|ie
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpabuf_put_u8
argument_list|(
name|ie
argument_list|,
name|WLAN_EID_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|ie
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|ie
argument_list|,
name|WPS_DEV_OUI_WFA
argument_list|)
expr_stmt|;
if|if
condition|(
name|pbc
condition|)
name|methods
operator|=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
else|else
name|methods
operator|=
name|WPS_CONFIG_LABEL
operator||
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_KEYPAD
expr_stmt|;
if|if
condition|(
name|wps_build_version
argument_list|(
name|ie
argument_list|)
operator|||
name|wps_build_req_type
argument_list|(
name|ie
argument_list|,
name|req_type
argument_list|)
operator|||
name|wps_build_config_methods
argument_list|(
name|ie
argument_list|,
name|methods
argument_list|)
operator|||
name|wps_build_uuid_e
argument_list|(
name|ie
argument_list|,
name|uuid
argument_list|)
operator|||
name|wps_build_primary_dev_type
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|)
operator|||
name|wps_build_rf_bands
argument_list|(
name|dev
argument_list|,
name|ie
argument_list|)
operator|||
name|wps_build_assoc_state
argument_list|(
name|NULL
argument_list|,
name|ie
argument_list|)
operator|||
name|wps_build_config_error
argument_list|(
name|ie
argument_list|,
name|WPS_CFG_NO_ERROR
argument_list|)
operator|||
name|wps_build_dev_password_id
argument_list|(
name|ie
argument_list|,
name|pbc
condition|?
name|DEV_PW_PUSHBUTTON
else|:
name|DEV_PW_DEFAULT
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|len
operator|=
name|wpabuf_len
argument_list|(
name|ie
argument_list|)
operator|-
literal|2
expr_stmt|;
return|return
name|ie
return|;
block|}
end_function

begin_function
name|void
name|wps_free_pending_msgs
parameter_list|(
name|struct
name|upnp_pending_message
modifier|*
name|msgs
parameter_list|)
block|{
name|struct
name|upnp_pending_message
modifier|*
name|p
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|p
operator|=
name|msgs
expr_stmt|;
while|while
condition|(
name|p
condition|)
block|{
name|prev
operator|=
name|p
expr_stmt|;
name|p
operator|=
name|p
operator|->
name|next
expr_stmt|;
name|wpabuf_free
argument_list|(
name|prev
operator|->
name|msg
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * http_server - HTTP server  * Copyright (c) 2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"httpread.h"
end_include

begin_include
include|#
directive|include
file|"http_server.h"
end_include

begin_define
define|#
directive|define
name|HTTP_SERVER_TIMEOUT
value|30
end_define

begin_define
define|#
directive|define
name|HTTP_SERVER_MAX_REQ_LEN
value|8000
end_define

begin_define
define|#
directive|define
name|HTTP_SERVER_MAX_CONNECTIONS
value|10
end_define

begin_struct
struct|struct
name|http_request
block|{
name|struct
name|http_request
modifier|*
name|next
decl_stmt|;
name|struct
name|http_server
modifier|*
name|srv
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|sockaddr_in
name|cli
decl_stmt|;
name|struct
name|httpread
modifier|*
name|hread
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|http_server
block|{
name|void
function_decl|(
modifier|*
name|cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
function_decl|;
name|void
modifier|*
name|cb_ctx
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|int
name|port
decl_stmt|;
name|struct
name|http_request
modifier|*
name|requests
decl_stmt|;
name|unsigned
name|int
name|request_count
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|http_request_cb
parameter_list|(
name|struct
name|httpread
modifier|*
name|handle
parameter_list|,
name|void
modifier|*
name|cookie
parameter_list|,
name|enum
name|httpread_event
name|en
parameter_list|)
block|{
name|struct
name|http_request
modifier|*
name|req
init|=
name|cookie
decl_stmt|;
name|struct
name|http_server
modifier|*
name|srv
init|=
name|req
operator|->
name|srv
decl_stmt|;
if|if
condition|(
name|en
operator|==
name|HTTPREAD_EVENT_FILE_READY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HTTP: Request from %s:%d received"
argument_list|,
name|inet_ntoa
argument_list|(
name|req
operator|->
name|cli
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|req
operator|->
name|cli
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
name|srv
operator|->
name|cb
argument_list|(
name|srv
operator|->
name|cb_ctx
argument_list|,
name|req
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HTTP: Request from %s:%d could not be received "
literal|"completely"
argument_list|,
name|inet_ntoa
argument_list|(
name|req
operator|->
name|cli
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|req
operator|->
name|cli
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|http_request
modifier|*
name|http_request_init
parameter_list|(
name|struct
name|http_server
modifier|*
name|srv
parameter_list|,
name|int
name|fd
parameter_list|,
name|struct
name|sockaddr_in
modifier|*
name|cli
parameter_list|)
block|{
name|struct
name|http_request
modifier|*
name|req
decl_stmt|;
if|if
condition|(
name|srv
operator|->
name|request_count
operator|>=
name|HTTP_SERVER_MAX_CONNECTIONS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HTTP: Too many concurrent requests"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|req
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|req
operator|->
name|srv
operator|=
name|srv
expr_stmt|;
name|req
operator|->
name|fd
operator|=
name|fd
expr_stmt|;
name|req
operator|->
name|cli
operator|=
operator|*
name|cli
expr_stmt|;
name|req
operator|->
name|hread
operator|=
name|httpread_create
argument_list|(
name|req
operator|->
name|fd
argument_list|,
name|http_request_cb
argument_list|,
name|req
argument_list|,
name|HTTP_SERVER_MAX_REQ_LEN
argument_list|,
name|HTTP_SERVER_TIMEOUT
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|->
name|hread
operator|==
name|NULL
condition|)
block|{
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|req
return|;
block|}
end_function

begin_function
name|void
name|http_request_deinit
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|http_request
modifier|*
name|r
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|struct
name|http_server
modifier|*
name|srv
decl_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
return|return;
name|srv
operator|=
name|req
operator|->
name|srv
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
name|r
operator|=
name|srv
operator|->
name|requests
expr_stmt|;
while|while
condition|(
name|r
condition|)
block|{
if|if
condition|(
name|r
operator|==
name|req
condition|)
block|{
if|if
condition|(
name|p
condition|)
name|p
operator|->
name|next
operator|=
name|r
operator|->
name|next
expr_stmt|;
else|else
name|srv
operator|->
name|requests
operator|=
name|r
operator|->
name|next
expr_stmt|;
name|srv
operator|->
name|request_count
operator|--
expr_stmt|;
break|break;
block|}
name|p
operator|=
name|r
expr_stmt|;
name|r
operator|=
name|r
operator|->
name|next
expr_stmt|;
block|}
name|httpread_destroy
argument_list|(
name|req
operator|->
name|hread
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|req
operator|->
name|fd
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_request_free_all
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|http_request
modifier|*
name|prev
decl_stmt|;
while|while
condition|(
name|req
condition|)
block|{
name|prev
operator|=
name|req
expr_stmt|;
name|req
operator|=
name|req
operator|->
name|next
expr_stmt|;
name|http_request_deinit
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|http_request_send
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HTTP: Send %lu byte response to %s:%d"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
argument_list|,
name|inet_ntoa
argument_list|(
name|req
operator|->
name|cli
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|req
operator|->
name|cli
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|=
name|send
argument_list|(
name|req
operator|->
name|fd
argument_list|,
name|wpabuf_head
argument_list|(
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HTTP: Send failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|size_t
operator|)
name|res
operator|<
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HTTP: Sent only %d of %lu bytes"
argument_list|,
name|res
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* TODO: add eloop handler for sending rest of the data */
block|}
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|http_request_send_and_deinit
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|)
block|{
name|http_request_send
argument_list|(
name|req
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|http_request_deinit
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|enum
name|httpread_hdr_type
name|http_request_get_type
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
return|return
name|httpread_hdr_type_get
argument_list|(
name|req
operator|->
name|hread
argument_list|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|http_request_get_uri
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
return|return
name|httpread_uri_get
argument_list|(
name|req
operator|->
name|hread
argument_list|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|http_request_get_hdr
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
return|return
name|httpread_hdr_get
argument_list|(
name|req
operator|->
name|hread
argument_list|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|http_request_get_data
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
return|return
name|httpread_data_get
argument_list|(
name|req
operator|->
name|hread
argument_list|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|http_request_get_hdr_line
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|,
specifier|const
name|char
modifier|*
name|tag
parameter_list|)
block|{
return|return
name|httpread_hdr_line_get
argument_list|(
name|req
operator|->
name|hread
argument_list|,
name|tag
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|sockaddr_in
modifier|*
name|http_request_get_cli_addr
parameter_list|(
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
block|{
return|return
operator|&
name|req
operator|->
name|cli
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|http_server_cb
parameter_list|(
name|int
name|sd
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|addr
decl_stmt|;
name|socklen_t
name|addr_len
init|=
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
decl_stmt|;
name|struct
name|http_server
modifier|*
name|srv
init|=
name|eloop_ctx
decl_stmt|;
name|int
name|conn
decl_stmt|;
name|struct
name|http_request
modifier|*
name|req
decl_stmt|;
name|conn
operator|=
name|accept
argument_list|(
name|srv
operator|->
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
operator|&
name|addr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HTTP: Failed to accept new connection: "
literal|"%s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HTTP: Connection from %s:%d"
argument_list|,
name|inet_ntoa
argument_list|(
name|addr
operator|.
name|sin_addr
argument_list|)
argument_list|,
name|ntohs
argument_list|(
name|addr
operator|.
name|sin_port
argument_list|)
argument_list|)
expr_stmt|;
name|req
operator|=
name|http_request_init
argument_list|(
name|srv
argument_list|,
name|conn
argument_list|,
operator|&
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|close
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return;
block|}
name|req
operator|->
name|next
operator|=
name|srv
operator|->
name|requests
expr_stmt|;
name|srv
operator|->
name|requests
operator|=
name|req
expr_stmt|;
name|srv
operator|->
name|request_count
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|http_server
modifier|*
name|http_server_init
parameter_list|(
name|struct
name|in_addr
modifier|*
name|addr
parameter_list|,
name|int
name|port
parameter_list|,
name|void
function_decl|(
modifier|*
name|cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|http_request
modifier|*
name|req
parameter_list|)
parameter_list|,
name|void
modifier|*
name|cb_ctx
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|sin
decl_stmt|;
name|struct
name|http_server
modifier|*
name|srv
decl_stmt|;
name|srv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|srv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|srv
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|srv
operator|->
name|cb
operator|=
name|cb
expr_stmt|;
name|srv
operator|->
name|cb_ctx
operator|=
name|cb_ctx
expr_stmt|;
name|srv
operator|->
name|fd
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|srv
operator|->
name|fd
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|fcntl
argument_list|(
name|srv
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|port
operator|<
literal|0
condition|)
name|srv
operator|->
name|port
operator|=
literal|49152
expr_stmt|;
else|else
name|srv
operator|->
name|port
operator|=
name|port
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|sin
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
argument_list|)
expr_stmt|;
name|sin
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
name|sin
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|addr
operator|->
name|s_addr
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|sin
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
name|srv
operator|->
name|port
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|srv
operator|->
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|sin
argument_list|,
sizeof|sizeof
argument_list|(
name|sin
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
break|break;
if|if
condition|(
name|errno
operator|==
name|EADDRINUSE
condition|)
block|{
comment|/* search for unused port */
if|if
condition|(
operator|++
name|srv
operator|->
name|port
operator|==
literal|65535
operator|||
name|port
operator|>=
literal|0
condition|)
goto|goto
name|fail
goto|;
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HTTP: Failed to bind server port %d: "
literal|"%s"
argument_list|,
name|srv
operator|->
name|port
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|listen
argument_list|(
name|srv
operator|->
name|fd
argument_list|,
literal|10
comment|/* max backlog */
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|fcntl
argument_list|(
name|srv
operator|->
name|fd
argument_list|,
name|F_SETFL
argument_list|,
name|O_NONBLOCK
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|eloop_register_sock
argument_list|(
name|srv
operator|->
name|fd
argument_list|,
name|EVENT_TYPE_READ
argument_list|,
name|http_server_cb
argument_list|,
name|srv
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HTTP: Started server on %s:%d"
argument_list|,
name|inet_ntoa
argument_list|(
operator|*
name|addr
argument_list|)
argument_list|,
name|srv
operator|->
name|port
argument_list|)
expr_stmt|;
return|return
name|srv
return|;
name|fail
label|:
name|http_server_deinit
argument_list|(
name|srv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|http_server_deinit
parameter_list|(
name|struct
name|http_server
modifier|*
name|srv
parameter_list|)
block|{
if|if
condition|(
name|srv
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|srv
operator|->
name|fd
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_sock
argument_list|(
name|srv
operator|->
name|fd
argument_list|,
name|EVENT_TYPE_READ
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|srv
operator|->
name|fd
argument_list|)
expr_stmt|;
block|}
name|http_request_free_all
argument_list|(
name|srv
operator|->
name|requests
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|srv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|http_server_get_port
parameter_list|(
name|struct
name|http_server
modifier|*
name|srv
parameter_list|)
block|{
return|return
name|srv
operator|->
name|port
return|;
block|}
end_function

end_unit


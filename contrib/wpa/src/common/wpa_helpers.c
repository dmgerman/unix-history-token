begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant ctrl_iface helpers  * Copyright (c) 2010-2011, Atheros Communications, Inc.  * Copyright (c) 2011-2012, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"wpa_helpers.h"
end_include

begin_decl_stmt
name|char
modifier|*
name|wpas_ctrl_path
init|=
literal|"/var/run/wpa_supplicant/"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|default_timeout
init|=
literal|60
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|wpa_ctrl
modifier|*
name|wpa_open_ctrl
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|wpa_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%s%s"
argument_list|,
name|wpas_ctrl_path
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|wpa_ctrl_open
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"wpa_command: wpa_ctrl_open(%s) failed\n"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
name|ctrl
return|;
block|}
end_function

begin_function
name|int
name|wpa_command
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|)
block|{
name|struct
name|wpa_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|printf
argument_list|(
literal|"wpa_command(ifname='%s', cmd='%s')\n"
argument_list|,
name|ifname
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|wpa_open_ctrl
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_ctrl_request
argument_list|(
name|ctrl
argument_list|,
name|cmd
argument_list|,
name|strlen
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"wpa_command: wpa_ctrl_request failed\n"
argument_list|)
expr_stmt|;
name|wpa_ctrl_close
argument_list|(
name|ctrl
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_ctrl_close
argument_list|(
name|ctrl
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|buf
argument_list|,
literal|"FAIL"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"wpa_command: Command failed (FAIL received)\n"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_command_resp
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|char
modifier|*
name|cmd
parameter_list|,
name|char
modifier|*
name|resp
parameter_list|,
name|size_t
name|resp_size
parameter_list|)
block|{
name|struct
name|wpa_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|printf
argument_list|(
literal|"wpa_command(ifname='%s', cmd='%s')\n"
argument_list|,
name|ifname
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|ctrl
operator|=
name|wpa_open_ctrl
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
name|resp_size
expr_stmt|;
if|if
condition|(
name|wpa_ctrl_request
argument_list|(
name|ctrl
argument_list|,
name|cmd
argument_list|,
name|strlen
argument_list|(
name|cmd
argument_list|)
argument_list|,
name|resp
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"wpa_command: wpa_ctrl_request failed\n"
argument_list|)
expr_stmt|;
name|wpa_ctrl_close
argument_list|(
name|ctrl
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_ctrl_close
argument_list|(
name|ctrl
argument_list|)
expr_stmt|;
name|resp
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|wpa_ctrl
modifier|*
name|open_wpa_mon
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wpa_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|ctrl
operator|=
name|wpa_open_ctrl
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wpa_ctrl_attach
argument_list|(
name|ctrl
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_ctrl_close
argument_list|(
name|ctrl
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|ctrl
return|;
block|}
end_function

begin_function
name|int
name|get_wpa_cli_event2
parameter_list|(
name|struct
name|wpa_ctrl
modifier|*
name|mon
parameter_list|,
specifier|const
name|char
modifier|*
name|event
parameter_list|,
specifier|const
name|char
modifier|*
name|event2
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_size
parameter_list|)
block|{
name|int
name|fd
decl_stmt|,
name|ret
decl_stmt|;
name|fd_set
name|rfd
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|time_t
name|start
decl_stmt|,
name|now
decl_stmt|;
name|printf
argument_list|(
literal|"Waiting for wpa_cli event %s\n"
argument_list|,
name|event
argument_list|)
expr_stmt|;
name|fd
operator|=
name|wpa_ctrl_get_fd
argument_list|(
name|mon
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|time
argument_list|(
operator|&
name|start
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|size_t
name|len
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|rfd
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fd
argument_list|,
operator|&
name|rfd
argument_list|)
expr_stmt|;
name|tv
operator|.
name|tv_sec
operator|=
name|default_timeout
expr_stmt|;
name|tv
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|select
argument_list|(
name|fd
operator|+
literal|1
argument_list|,
operator|&
name|rfd
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|tv
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Timeout on waiting for event %s\n"
argument_list|,
name|event
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"select: %s\n"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
name|buf_size
expr_stmt|;
if|if
condition|(
name|wpa_ctrl_recv
argument_list|(
name|mon
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Failure while waiting for event %s\n"
argument_list|,
name|event
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|len
operator|==
name|buf_size
condition|)
name|len
operator|--
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|'>'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|&&
operator|(
name|strncmp
argument_list|(
name|pos
operator|+
literal|1
argument_list|,
name|event
argument_list|,
name|strlen
argument_list|(
name|event
argument_list|)
argument_list|)
operator|==
literal|0
operator|||
operator|(
name|event2
operator|&&
name|strncmp
argument_list|(
name|pos
operator|+
literal|1
argument_list|,
name|event2
argument_list|,
name|strlen
argument_list|(
name|event2
argument_list|)
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
return|return
literal|0
return|;
comment|/* Event found */
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
call|(
name|int
call|)
argument_list|(
name|now
operator|-
name|start
argument_list|)
operator|>
name|default_timeout
condition|)
block|{
name|printf
argument_list|(
literal|"Timeout on waiting for event %s\n"
argument_list|,
name|event
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|get_wpa_cli_event
parameter_list|(
name|struct
name|wpa_ctrl
modifier|*
name|mon
parameter_list|,
specifier|const
name|char
modifier|*
name|event
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_size
parameter_list|)
block|{
return|return
name|get_wpa_cli_event2
argument_list|(
name|mon
argument_list|,
name|event
argument_list|,
name|NULL
argument_list|,
name|buf
argument_list|,
name|buf_size
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|get_wpa_status
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
name|char
modifier|*
name|obuf
parameter_list|,
name|size_t
name|obuf_size
parameter_list|)
block|{
name|struct
name|wpa_ctrl
modifier|*
name|ctrl
decl_stmt|;
name|char
name|buf
index|[
literal|4096
index|]
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|flen
decl_stmt|;
name|ctrl
operator|=
name|wpa_open_ctrl
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_ctrl_request
argument_list|(
name|ctrl
argument_list|,
literal|"STATUS"
argument_list|,
literal|6
argument_list|,
name|buf
argument_list|,
operator|&
name|len
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_ctrl_close
argument_list|(
name|ctrl
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_ctrl_close
argument_list|(
name|ctrl
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|flen
operator|=
name|strlen
argument_list|(
name|field
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
while|while
condition|(
name|pos
operator|+
name|flen
operator|<
name|buf
operator|+
name|len
condition|)
block|{
if|if
condition|(
name|pos
operator|>
name|buf
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|!=
literal|'\n'
condition|)
block|{
name|pos
operator|++
expr_stmt|;
continue|continue;
block|}
name|pos
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|strncmp
argument_list|(
name|pos
argument_list|,
name|field
argument_list|,
name|flen
argument_list|)
operator|!=
literal|0
operator|||
name|pos
index|[
name|flen
index|]
operator|!=
literal|'='
condition|)
block|{
name|pos
operator|++
expr_stmt|;
continue|continue;
block|}
name|pos
operator|+=
name|flen
operator|+
literal|1
expr_stmt|;
name|end
operator|=
name|strchr
argument_list|(
name|pos
argument_list|,
literal|'\n'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|end
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|>
operator|(
name|int
operator|)
name|obuf_size
condition|)
return|return
operator|-
literal|1
return|;
name|memcpy
argument_list|(
name|obuf
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|wait_ip_addr
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|char
name|ip
index|[
literal|30
index|]
decl_stmt|;
name|int
name|count
init|=
name|timeout
decl_stmt|;
name|struct
name|wpa_ctrl
modifier|*
name|ctrl
decl_stmt|;
while|while
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"%s: ifname='%s' - %d seconds remaining\n"
argument_list|,
name|__func__
argument_list|,
name|ifname
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|count
operator|--
expr_stmt|;
if|if
condition|(
name|get_wpa_status
argument_list|(
name|ifname
argument_list|,
literal|"ip_address"
argument_list|,
name|ip
argument_list|,
sizeof|sizeof
argument_list|(
name|ip
argument_list|)
argument_list|)
operator|==
literal|0
operator|&&
name|strlen
argument_list|(
name|ip
argument_list|)
operator|>
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"IP address found: '%s'\n"
argument_list|,
name|ip
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|ctrl
operator|=
name|wpa_open_ctrl
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_ctrl_close
argument_list|(
name|ctrl
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s: Could not get IP address for ifname='%s'"
argument_list|,
name|__func__
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|add_network
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|char
name|res
index|[
literal|30
index|]
decl_stmt|;
if|if
condition|(
name|wpa_command_resp
argument_list|(
name|ifname
argument_list|,
literal|"ADD_NETWORK"
argument_list|,
name|res
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|atoi
argument_list|(
name|res
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|set_network
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|id
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"SET_NETWORK %d %s %s"
argument_list|,
name|id
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|wpa_command
argument_list|(
name|ifname
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|set_network_quoted
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|id
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"SET_NETWORK %d %s \"%s\""
argument_list|,
name|id
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|wpa_command
argument_list|(
name|ifname
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|add_cred
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|char
name|res
index|[
literal|30
index|]
decl_stmt|;
if|if
condition|(
name|wpa_command_resp
argument_list|(
name|ifname
argument_list|,
literal|"ADD_CRED"
argument_list|,
name|res
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|atoi
argument_list|(
name|res
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|set_cred
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|id
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"SET_CRED %d %s %s"
argument_list|,
name|id
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|wpa_command
argument_list|(
name|ifname
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|set_cred_quoted
parameter_list|(
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
name|int
name|id
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
specifier|const
name|char
modifier|*
name|value
parameter_list|)
block|{
name|char
name|buf
index|[
literal|200
index|]
decl_stmt|;
name|snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"SET_CRED %d %s \"%s\""
argument_list|,
name|id
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
expr_stmt|;
return|return
name|wpa_command
argument_list|(
name|ifname
argument_list|,
name|buf
argument_list|)
return|;
block|}
end_function

end_unit


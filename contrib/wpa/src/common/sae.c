begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Simultaneous authentication of equals  * Copyright (c) 2012-2015, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"crypto/dh_groups.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"sae.h"
end_include

begin_function
name|int
name|sae_set_group
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
name|int
name|group
parameter_list|)
block|{
name|struct
name|sae_temporary_data
modifier|*
name|tmp
decl_stmt|;
name|sae_clear_data
argument_list|(
name|sae
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|sae
operator|->
name|tmp
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|tmp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* First, check if this is an ECC group */
name|tmp
operator|->
name|ec
operator|=
name|crypto_ec_init
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|ec
condition|)
block|{
name|sae
operator|->
name|group
operator|=
name|group
expr_stmt|;
name|tmp
operator|->
name|prime_len
operator|=
name|crypto_ec_prime_len
argument_list|(
name|tmp
operator|->
name|ec
argument_list|)
expr_stmt|;
name|tmp
operator|->
name|prime
operator|=
name|crypto_ec_get_prime
argument_list|(
name|tmp
operator|->
name|ec
argument_list|)
expr_stmt|;
name|tmp
operator|->
name|order
operator|=
name|crypto_ec_get_order
argument_list|(
name|tmp
operator|->
name|ec
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Not an ECC group, check FFC */
name|tmp
operator|->
name|dh
operator|=
name|dh_groups_get
argument_list|(
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|dh
condition|)
block|{
name|sae
operator|->
name|group
operator|=
name|group
expr_stmt|;
name|tmp
operator|->
name|prime_len
operator|=
name|tmp
operator|->
name|dh
operator|->
name|prime_len
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|prime_len
operator|>
name|SAE_MAX_PRIME_LEN
condition|)
block|{
name|sae_clear_data
argument_list|(
name|sae
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tmp
operator|->
name|prime_buf
operator|=
name|crypto_bignum_init_set
argument_list|(
name|tmp
operator|->
name|dh
operator|->
name|prime
argument_list|,
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|prime_buf
operator|==
name|NULL
condition|)
block|{
name|sae_clear_data
argument_list|(
name|sae
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tmp
operator|->
name|prime
operator|=
name|tmp
operator|->
name|prime_buf
expr_stmt|;
name|tmp
operator|->
name|order_buf
operator|=
name|crypto_bignum_init_set
argument_list|(
name|tmp
operator|->
name|dh
operator|->
name|order
argument_list|,
name|tmp
operator|->
name|dh
operator|->
name|order_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|->
name|order_buf
operator|==
name|NULL
condition|)
block|{
name|sae_clear_data
argument_list|(
name|sae
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tmp
operator|->
name|order
operator|=
name|tmp
operator|->
name|order_buf
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Unsupported group */
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|sae_clear_temp_data
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|)
block|{
name|struct
name|sae_temporary_data
modifier|*
name|tmp
decl_stmt|;
if|if
condition|(
name|sae
operator|==
name|NULL
operator|||
name|sae
operator|->
name|tmp
operator|==
name|NULL
condition|)
return|return;
name|tmp
operator|=
name|sae
operator|->
name|tmp
expr_stmt|;
name|crypto_ec_deinit
argument_list|(
name|tmp
operator|->
name|ec
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|tmp
operator|->
name|prime_buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|tmp
operator|->
name|order_buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|tmp
operator|->
name|sae_rand
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|tmp
operator|->
name|pwe_ffc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|tmp
operator|->
name|own_commit_scalar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|tmp
operator|->
name|own_commit_element_ffc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|tmp
operator|->
name|peer_commit_element_ffc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crypto_ec_point_deinit
argument_list|(
name|tmp
operator|->
name|pwe_ecc
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|crypto_ec_point_deinit
argument_list|(
name|tmp
operator|->
name|own_commit_element_ecc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crypto_ec_point_deinit
argument_list|(
name|tmp
operator|->
name|peer_commit_element_ecc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tmp
operator|->
name|anti_clogging_token
argument_list|)
expr_stmt|;
name|bin_clear_free
argument_list|(
name|tmp
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tmp
argument_list|)
argument_list|)
expr_stmt|;
name|sae
operator|->
name|tmp
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sae_clear_data
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|)
block|{
if|if
condition|(
name|sae
operator|==
name|NULL
condition|)
return|return;
name|sae_clear_temp_data
argument_list|(
name|sae
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|sae
operator|->
name|peer_commit_scalar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|sae
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|sae
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|buf_shift_right
parameter_list|(
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|size_t
name|bits
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|len
operator|-
literal|1
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
name|buf
index|[
name|i
index|]
operator|=
operator|(
name|buf
index|[
name|i
operator|-
literal|1
index|]
operator|<<
operator|(
literal|8
operator|-
name|bits
operator|)
operator|)
operator||
operator|(
name|buf
index|[
name|i
index|]
operator|>>
name|bits
operator|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|>>=
name|bits
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|crypto_bignum
modifier|*
name|sae_get_rand
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|)
block|{
name|u8
name|val
index|[
name|SAE_MAX_PRIME_LEN
index|]
decl_stmt|;
name|int
name|iter
init|=
literal|0
decl_stmt|;
name|struct
name|crypto_bignum
modifier|*
name|bn
init|=
name|NULL
decl_stmt|;
name|int
name|order_len_bits
init|=
name|crypto_bignum_bits
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|order
argument_list|)
decl_stmt|;
name|size_t
name|order_len
init|=
operator|(
name|order_len_bits
operator|+
literal|7
operator|)
operator|/
literal|8
decl_stmt|;
if|if
condition|(
name|order_len
operator|>
sizeof|sizeof
argument_list|(
name|val
argument_list|)
condition|)
return|return
name|NULL
return|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|iter
operator|++
operator|>
literal|100
operator|||
name|random_get_bytes
argument_list|(
name|val
argument_list|,
name|order_len
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|order_len_bits
operator|%
literal|8
condition|)
name|buf_shift_right
argument_list|(
name|val
argument_list|,
name|order_len
argument_list|,
literal|8
operator|-
name|order_len_bits
operator|%
literal|8
argument_list|)
expr_stmt|;
name|bn
operator|=
name|crypto_bignum_init_set
argument_list|(
name|val
argument_list|,
name|order_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bn
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|crypto_bignum_is_zero
argument_list|(
name|bn
argument_list|)
operator|||
name|crypto_bignum_is_one
argument_list|(
name|bn
argument_list|)
operator|||
name|crypto_bignum_cmp
argument_list|(
name|bn
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|order
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|crypto_bignum_deinit
argument_list|(
name|bn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
name|os_memset
argument_list|(
name|val
argument_list|,
literal|0
argument_list|,
name|order_len
argument_list|)
expr_stmt|;
return|return
name|bn
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|crypto_bignum
modifier|*
name|sae_get_rand_and_mask
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|)
block|{
name|crypto_bignum_deinit
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|sae_rand
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|sae
operator|->
name|tmp
operator|->
name|sae_rand
operator|=
name|sae_get_rand
argument_list|(
name|sae
argument_list|)
expr_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|sae_rand
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
return|return
name|sae_get_rand
argument_list|(
name|sae
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sae_pwd_seed_key
parameter_list|(
specifier|const
name|u8
modifier|*
name|addr1
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr2
parameter_list|,
name|u8
modifier|*
name|key
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: PWE derivation - addr1="
name|MACSTR
literal|" addr2="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr1
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|addr2
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|addr1
argument_list|,
name|addr2
argument_list|,
name|ETH_ALEN
argument_list|)
operator|>
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|addr1
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|key
operator|+
name|ETH_ALEN
argument_list|,
name|addr2
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|addr2
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|key
operator|+
name|ETH_ALEN
argument_list|,
name|addr1
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|crypto_bignum
modifier|*
name|get_rand_1_to_p_1
parameter_list|(
specifier|const
name|u8
modifier|*
name|prime
parameter_list|,
name|size_t
name|prime_len
parameter_list|,
name|size_t
name|prime_bits
parameter_list|,
name|int
modifier|*
name|r_odd
parameter_list|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
name|struct
name|crypto_bignum
modifier|*
name|r
decl_stmt|;
name|u8
name|tmp
index|[
name|SAE_MAX_ECC_PRIME_LEN
index|]
decl_stmt|;
if|if
condition|(
name|random_get_bytes
argument_list|(
name|tmp
argument_list|,
name|prime_len
argument_list|)
operator|<
literal|0
condition|)
break|break;
if|if
condition|(
name|prime_bits
operator|%
literal|8
condition|)
name|buf_shift_right
argument_list|(
name|tmp
argument_list|,
name|prime_len
argument_list|,
literal|8
operator|-
name|prime_bits
operator|%
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|tmp
argument_list|,
name|prime
argument_list|,
name|prime_len
argument_list|)
operator|>=
literal|0
condition|)
continue|continue;
name|r
operator|=
name|crypto_bignum_init_set
argument_list|(
name|tmp
argument_list|,
name|prime_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
break|break;
if|if
condition|(
name|crypto_bignum_is_zero
argument_list|(
name|r
argument_list|)
condition|)
block|{
name|crypto_bignum_deinit
argument_list|(
name|r
argument_list|,
literal|0
argument_list|)
expr_stmt|;
continue|continue;
block|}
operator|*
name|r_odd
operator|=
name|tmp
index|[
name|prime_len
operator|-
literal|1
index|]
operator|&
literal|0x01
expr_stmt|;
return|return
name|r
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|is_quadratic_residue_blind
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|prime
parameter_list|,
name|size_t
name|bits
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|qr
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|qnr
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|y_sqr
parameter_list|)
block|{
name|struct
name|crypto_bignum
modifier|*
name|r
decl_stmt|,
modifier|*
name|num
decl_stmt|;
name|int
name|r_odd
decl_stmt|,
name|check
decl_stmt|,
name|res
init|=
operator|-
literal|1
decl_stmt|;
comment|/* 	 * Use the blinding technique to mask y_sqr while determining 	 * whether it is a quadratic residue modulo p to avoid leaking 	 * timing information while determining the Legendre symbol. 	 * 	 * v = y_sqr 	 * r = a random number between 1 and p-1, inclusive 	 * num = (v * r * r) modulo p 	 */
name|r
operator|=
name|get_rand_1_to_p_1
argument_list|(
name|prime
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|bits
argument_list|,
operator|&
name|r_odd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
return|return
operator|-
literal|1
return|;
name|num
operator|=
name|crypto_bignum_init
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|num
operator|||
name|crypto_bignum_mulmod
argument_list|(
name|y_sqr
argument_list|,
name|r
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|num
argument_list|)
operator|<
literal|0
operator|||
name|crypto_bignum_mulmod
argument_list|(
name|num
argument_list|,
name|r
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|num
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|r_odd
condition|)
block|{
comment|/* 		 * num = (num * qr) module p 		 * LGR(num, p) = 1 ==> quadratic residue 		 */
if|if
condition|(
name|crypto_bignum_mulmod
argument_list|(
name|num
argument_list|,
name|qr
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|num
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|check
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * num = (num * qnr) module p 		 * LGR(num, p) = -1 ==> quadratic residue 		 */
if|if
condition|(
name|crypto_bignum_mulmod
argument_list|(
name|num
argument_list|,
name|qnr
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|num
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|check
operator|=
operator|-
literal|1
expr_stmt|;
block|}
name|res
operator|=
name|crypto_bignum_legendre
argument_list|(
name|num
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
operator|-
literal|2
condition|)
block|{
name|res
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|res
operator|=
name|res
operator|==
name|check
expr_stmt|;
name|fail
label|:
name|crypto_bignum_deinit
argument_list|(
name|num
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|r
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sae_test_pwd_seed_ecc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|pwd_seed
parameter_list|,
specifier|const
name|u8
modifier|*
name|prime
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|qr
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|qnr
parameter_list|,
name|struct
name|crypto_bignum
modifier|*
modifier|*
name|ret_x_cand
parameter_list|)
block|{
name|u8
name|pwd_value
index|[
name|SAE_MAX_ECC_PRIME_LEN
index|]
decl_stmt|;
name|struct
name|crypto_bignum
modifier|*
name|y_sqr
decl_stmt|,
modifier|*
name|x_cand
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|bits
decl_stmt|;
operator|*
name|ret_x_cand
operator|=
name|NULL
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: pwd-seed"
argument_list|,
name|pwd_seed
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
comment|/* pwd-value = KDF-z(pwd-seed, "SAE Hunting and Pecking", p) */
name|bits
operator|=
name|crypto_ec_prime_len_bits
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|)
expr_stmt|;
name|sha256_prf_bits
argument_list|(
name|pwd_seed
argument_list|,
name|SHA256_MAC_LEN
argument_list|,
literal|"SAE Hunting and Pecking"
argument_list|,
name|prime
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|pwd_value
argument_list|,
name|bits
argument_list|)
expr_stmt|;
if|if
condition|(
name|bits
operator|%
literal|8
condition|)
name|buf_shift_right
argument_list|(
name|pwd_value
argument_list|,
sizeof|sizeof
argument_list|(
name|pwd_value
argument_list|)
argument_list|,
literal|8
operator|-
name|bits
operator|%
literal|8
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: pwd-value"
argument_list|,
name|pwd_value
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|pwd_value
argument_list|,
name|prime
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
operator|>=
literal|0
condition|)
return|return
literal|0
return|;
name|x_cand
operator|=
name|crypto_bignum_init_set
argument_list|(
name|pwd_value
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|x_cand
condition|)
return|return
operator|-
literal|1
return|;
name|y_sqr
operator|=
name|crypto_ec_point_compute_y_sqr
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|x_cand
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|y_sqr
condition|)
block|{
name|crypto_bignum_deinit
argument_list|(
name|x_cand
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res
operator|=
name|is_quadratic_residue_blind
argument_list|(
name|sae
argument_list|,
name|prime
argument_list|,
name|bits
argument_list|,
name|qr
argument_list|,
name|qnr
argument_list|,
name|y_sqr
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|y_sqr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<=
literal|0
condition|)
block|{
name|crypto_bignum_deinit
argument_list|(
name|x_cand
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
operator|*
name|ret_x_cand
operator|=
name|x_cand
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sae_test_pwd_seed_ffc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|pwd_seed
parameter_list|,
name|struct
name|crypto_bignum
modifier|*
name|pwe
parameter_list|)
block|{
name|u8
name|pwd_value
index|[
name|SAE_MAX_PRIME_LEN
index|]
decl_stmt|;
name|size_t
name|bits
init|=
name|sae
operator|->
name|tmp
operator|->
name|prime_len
operator|*
literal|8
decl_stmt|;
name|u8
name|exp
index|[
literal|1
index|]
decl_stmt|;
name|struct
name|crypto_bignum
modifier|*
name|a
decl_stmt|,
modifier|*
name|b
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: pwd-seed"
argument_list|,
name|pwd_seed
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
comment|/* pwd-value = KDF-z(pwd-seed, "SAE Hunting and Pecking", p) */
name|sha256_prf_bits
argument_list|(
name|pwd_seed
argument_list|,
name|SHA256_MAC_LEN
argument_list|,
literal|"SAE Hunting and Pecking"
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|dh
operator|->
name|prime
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|pwd_value
argument_list|,
name|bits
argument_list|)
expr_stmt|;
if|if
condition|(
name|bits
operator|%
literal|8
condition|)
name|buf_shift_right
argument_list|(
name|pwd_value
argument_list|,
sizeof|sizeof
argument_list|(
name|pwd_value
argument_list|)
argument_list|,
literal|8
operator|-
name|bits
operator|%
literal|8
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: pwd-value"
argument_list|,
name|pwd_value
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|pwd_value
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|dh
operator|->
name|prime
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: pwd-value>= p"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* PWE = pwd-value^((p-1)/r) modulo p */
name|a
operator|=
name|crypto_bignum_init_set
argument_list|(
name|pwd_value
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|dh
operator|->
name|safe_prime
condition|)
block|{
comment|/* 		 * r = (p-1)/2 for the group used here, so this becomes: 		 * PWE = pwd-value^2 modulo p 		 */
name|exp
index|[
literal|0
index|]
operator|=
literal|2
expr_stmt|;
name|b
operator|=
name|crypto_bignum_init_set
argument_list|(
name|exp
argument_list|,
sizeof|sizeof
argument_list|(
name|exp
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Calculate exponent: (p-1)/r */
name|exp
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|b
operator|=
name|crypto_bignum_init_set
argument_list|(
name|exp
argument_list|,
sizeof|sizeof
argument_list|(
name|exp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
name|NULL
operator|||
name|crypto_bignum_sub
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|b
argument_list|,
name|b
argument_list|)
operator|<
literal|0
operator|||
name|crypto_bignum_div
argument_list|(
name|b
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|order
argument_list|,
name|b
argument_list|)
operator|<
literal|0
condition|)
block|{
name|crypto_bignum_deinit
argument_list|(
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|b
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|a
operator|==
name|NULL
operator|||
name|b
operator|==
name|NULL
condition|)
name|res
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|res
operator|=
name|crypto_bignum_exptmod
argument_list|(
name|a
argument_list|,
name|b
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|pwe
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|a
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|b
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Failed to calculate PWE"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* if (PWE> 1) --> found */
if|if
condition|(
name|crypto_bignum_is_zero
argument_list|(
name|pwe
argument_list|)
operator|||
name|crypto_bignum_is_one
argument_list|(
name|pwe
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: PWE<= 1"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: PWE found"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_random_qr_qnr
parameter_list|(
specifier|const
name|u8
modifier|*
name|prime
parameter_list|,
name|size_t
name|prime_len
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|prime_bn
parameter_list|,
name|size_t
name|prime_bits
parameter_list|,
name|struct
name|crypto_bignum
modifier|*
modifier|*
name|qr
parameter_list|,
name|struct
name|crypto_bignum
modifier|*
modifier|*
name|qnr
parameter_list|)
block|{
operator|*
name|qr
operator|=
name|NULL
expr_stmt|;
operator|*
name|qnr
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
operator|!
operator|(
operator|*
name|qr
operator|)
operator|||
operator|!
operator|(
operator|*
name|qnr
operator|)
condition|)
block|{
name|u8
name|tmp
index|[
name|SAE_MAX_ECC_PRIME_LEN
index|]
decl_stmt|;
name|struct
name|crypto_bignum
modifier|*
name|q
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|random_get_bytes
argument_list|(
name|tmp
argument_list|,
name|prime_len
argument_list|)
operator|<
literal|0
condition|)
break|break;
if|if
condition|(
name|prime_bits
operator|%
literal|8
condition|)
name|buf_shift_right
argument_list|(
name|tmp
argument_list|,
name|prime_len
argument_list|,
literal|8
operator|-
name|prime_bits
operator|%
literal|8
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|tmp
argument_list|,
name|prime
argument_list|,
name|prime_len
argument_list|)
operator|>=
literal|0
condition|)
continue|continue;
name|q
operator|=
name|crypto_bignum_init_set
argument_list|(
name|tmp
argument_list|,
name|prime_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|q
condition|)
break|break;
name|res
operator|=
name|crypto_bignum_legendre
argument_list|(
name|q
argument_list|,
name|prime_bn
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|1
operator|&&
operator|!
operator|(
operator|*
name|qr
operator|)
condition|)
operator|*
name|qr
operator|=
name|q
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
operator|-
literal|1
operator|&&
operator|!
operator|(
operator|*
name|qnr
operator|)
condition|)
operator|*
name|qnr
operator|=
name|q
expr_stmt|;
else|else
name|crypto_bignum_deinit
argument_list|(
name|q
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
operator|*
name|qr
operator|&&
operator|*
name|qnr
operator|)
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sae_derive_pwe_ecc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr1
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr2
parameter_list|,
specifier|const
name|u8
modifier|*
name|password
parameter_list|,
name|size_t
name|password_len
parameter_list|)
block|{
name|u8
name|counter
decl_stmt|,
name|k
init|=
literal|40
decl_stmt|;
name|u8
name|addrs
index|[
literal|2
operator|*
name|ETH_ALEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|2
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|2
index|]
decl_stmt|;
name|u8
name|dummy_password
index|[
literal|32
index|]
decl_stmt|;
name|size_t
name|dummy_password_len
decl_stmt|;
name|int
name|pwd_seed_odd
init|=
literal|0
decl_stmt|;
name|u8
name|prime
index|[
name|SAE_MAX_ECC_PRIME_LEN
index|]
decl_stmt|;
name|size_t
name|prime_len
decl_stmt|;
name|struct
name|crypto_bignum
modifier|*
name|x
init|=
name|NULL
decl_stmt|,
modifier|*
name|qr
decl_stmt|,
modifier|*
name|qnr
decl_stmt|;
name|size_t
name|bits
decl_stmt|;
name|int
name|res
decl_stmt|;
name|dummy_password_len
operator|=
name|password_len
expr_stmt|;
if|if
condition|(
name|dummy_password_len
operator|>
sizeof|sizeof
argument_list|(
name|dummy_password
argument_list|)
condition|)
name|dummy_password_len
operator|=
sizeof|sizeof
argument_list|(
name|dummy_password
argument_list|)
expr_stmt|;
if|if
condition|(
name|random_get_bytes
argument_list|(
name|dummy_password
argument_list|,
name|dummy_password_len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|prime_len
operator|=
name|sae
operator|->
name|tmp
operator|->
name|prime_len
expr_stmt|;
if|if
condition|(
name|crypto_bignum_to_bin
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|prime
argument_list|,
sizeof|sizeof
argument_list|(
name|prime
argument_list|)
argument_list|,
name|prime_len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|bits
operator|=
name|crypto_ec_prime_len_bits
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|)
expr_stmt|;
comment|/* 	 * Create a random quadratic residue (qr) and quadratic non-residue 	 * (qnr) modulo p for blinding purposes during the loop. 	 */
if|if
condition|(
name|get_random_qr_qnr
argument_list|(
name|prime
argument_list|,
name|prime_len
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|bits
argument_list|,
operator|&
name|qr
argument_list|,
operator|&
name|qnr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: password"
argument_list|,
name|password
argument_list|,
name|password_len
argument_list|)
expr_stmt|;
comment|/* 	 * H(salt, ikm) = HMAC-SHA256(salt, ikm) 	 * base = password 	 * pwd-seed = H(MAX(STA-A-MAC, STA-B-MAC) || MIN(STA-A-MAC, STA-B-MAC), 	 *              base || counter) 	 */
name|sae_pwd_seed_key
argument_list|(
name|addr1
argument_list|,
name|addr2
argument_list|,
name|addrs
argument_list|)
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|password
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|password_len
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
operator|&
name|counter
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
sizeof|sizeof
argument_list|(
name|counter
argument_list|)
expr_stmt|;
comment|/* 	 * Continue for at least k iterations to protect against side-channel 	 * attacks that attempt to determine the number of iterations required 	 * in the loop. 	 */
for|for
control|(
name|counter
operator|=
literal|1
init|;
name|counter
operator|<=
name|k
operator|||
operator|!
name|x
condition|;
name|counter
operator|++
control|)
block|{
name|u8
name|pwd_seed
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|struct
name|crypto_bignum
modifier|*
name|x_cand
decl_stmt|;
if|if
condition|(
name|counter
operator|>
literal|200
condition|)
block|{
comment|/* This should not happen in practice */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Failed to derive PWE"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: counter = %u"
argument_list|,
name|counter
argument_list|)
expr_stmt|;
if|if
condition|(
name|hmac_sha256_vector
argument_list|(
name|addrs
argument_list|,
sizeof|sizeof
argument_list|(
name|addrs
argument_list|)
argument_list|,
literal|2
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|pwd_seed
argument_list|)
operator|<
literal|0
condition|)
break|break;
name|res
operator|=
name|sae_test_pwd_seed_ecc
argument_list|(
name|sae
argument_list|,
name|pwd_seed
argument_list|,
name|prime
argument_list|,
name|qr
argument_list|,
name|qnr
argument_list|,
operator|&
name|x_cand
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|res
operator|>
literal|0
operator|&&
operator|!
name|x
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Selected pwd-seed with counter %u"
argument_list|,
name|counter
argument_list|)
expr_stmt|;
name|x
operator|=
name|x_cand
expr_stmt|;
name|pwd_seed_odd
operator|=
name|pwd_seed
index|[
name|SHA256_MAC_LEN
operator|-
literal|1
index|]
operator|&
literal|0x01
expr_stmt|;
name|os_memset
argument_list|(
name|pwd_seed
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|pwd_seed
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 			 * Use a dummy password for the following rounds, if 			 * any. 			 */
name|addr
index|[
literal|0
index|]
operator|=
name|dummy_password
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|dummy_password_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|crypto_bignum_deinit
argument_list|(
name|x_cand
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|x
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Could not generate PWE"
argument_list|)
expr_stmt|;
name|res
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|pwe_ecc
condition|)
name|sae
operator|->
name|tmp
operator|->
name|pwe_ecc
operator|=
name|crypto_ec_point_init
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|pwe_ecc
condition|)
name|res
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|res
operator|=
name|crypto_ec_point_solve_y_coord
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|pwe_ecc
argument_list|,
name|x
argument_list|,
name|pwd_seed_odd
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|x
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
comment|/* 		 * This should not happen since we already checked that there 		 * is a result. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Could not solve y"
argument_list|)
expr_stmt|;
block|}
name|fail
label|:
name|crypto_bignum_deinit
argument_list|(
name|qr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|qnr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sae_derive_pwe_ffc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr1
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr2
parameter_list|,
specifier|const
name|u8
modifier|*
name|password
parameter_list|,
name|size_t
name|password_len
parameter_list|)
block|{
name|u8
name|counter
decl_stmt|;
name|u8
name|addrs
index|[
literal|2
operator|*
name|ETH_ALEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|2
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|2
index|]
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|pwe_ffc
operator|==
name|NULL
condition|)
block|{
name|sae
operator|->
name|tmp
operator|->
name|pwe_ffc
operator|=
name|crypto_bignum_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|pwe_ffc
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_ascii_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: password"
argument_list|,
name|password
argument_list|,
name|password_len
argument_list|)
expr_stmt|;
comment|/* 	 * H(salt, ikm) = HMAC-SHA256(salt, ikm) 	 * pwd-seed = H(MAX(STA-A-MAC, STA-B-MAC) || MIN(STA-A-MAC, STA-B-MAC), 	 *              password || counter) 	 */
name|sae_pwd_seed_key
argument_list|(
name|addr1
argument_list|,
name|addr2
argument_list|,
name|addrs
argument_list|)
expr_stmt|;
name|addr
index|[
literal|0
index|]
operator|=
name|password
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|password_len
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
operator|&
name|counter
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
sizeof|sizeof
argument_list|(
name|counter
argument_list|)
expr_stmt|;
for|for
control|(
name|counter
operator|=
literal|1
init|;
operator|!
name|found
condition|;
name|counter
operator|++
control|)
block|{
name|u8
name|pwd_seed
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|counter
operator|>
literal|200
condition|)
block|{
comment|/* This should not happen in practice */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Failed to derive PWE"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: counter = %u"
argument_list|,
name|counter
argument_list|)
expr_stmt|;
if|if
condition|(
name|hmac_sha256_vector
argument_list|(
name|addrs
argument_list|,
sizeof|sizeof
argument_list|(
name|addrs
argument_list|)
argument_list|,
literal|2
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|pwd_seed
argument_list|)
operator|<
literal|0
condition|)
break|break;
name|res
operator|=
name|sae_test_pwd_seed_ffc
argument_list|(
name|sae
argument_list|,
name|pwd_seed
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|pwe_ffc
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
break|break;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Use this PWE"
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
block|}
return|return
name|found
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sae_derive_commit_element_ecc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
name|struct
name|crypto_bignum
modifier|*
name|mask
parameter_list|)
block|{
comment|/* COMMIT-ELEMENT = inverse(scalar-op(mask, PWE)) */
if|if
condition|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ecc
condition|)
block|{
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ecc
operator|=
name|crypto_ec_point_init
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ecc
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|crypto_ec_point_mul
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|pwe_ecc
argument_list|,
name|mask
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ecc
argument_list|)
operator|<
literal|0
operator|||
name|crypto_ec_point_invert
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ecc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Could not compute commit-element"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sae_derive_commit_element_ffc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
name|struct
name|crypto_bignum
modifier|*
name|mask
parameter_list|)
block|{
comment|/* COMMIT-ELEMENT = inverse(scalar-op(mask, PWE)) */
if|if
condition|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
condition|)
block|{
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
operator|=
name|crypto_bignum_init
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|crypto_bignum_exptmod
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|pwe_ffc
argument_list|,
name|mask
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
argument_list|)
operator|<
literal|0
operator|||
name|crypto_bignum_inverse
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Could not compute commit-element"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sae_derive_commit
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|)
block|{
name|struct
name|crypto_bignum
modifier|*
name|mask
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|unsigned
name|int
name|counter
init|=
literal|0
decl_stmt|;
do|do
block|{
name|counter
operator|++
expr_stmt|;
if|if
condition|(
name|counter
operator|>
literal|100
condition|)
block|{
comment|/* 			 * This cannot really happen in practice if the random 			 * number generator is working. Anyway, to avoid even a 			 * theoretical infinite loop, break out after 100 			 * attemps. 			 */
return|return
operator|-
literal|1
return|;
block|}
name|mask
operator|=
name|sae_get_rand_and_mask
argument_list|(
name|sae
argument_list|)
expr_stmt|;
if|if
condition|(
name|mask
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Could not get rand/mask"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* commit-scalar = (rand + mask) modulo r */
if|if
condition|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
condition|)
block|{
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
operator|=
name|crypto_bignum_init
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
condition|)
goto|goto
name|fail
goto|;
block|}
name|crypto_bignum_add
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|sae_rand
argument_list|,
name|mask
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|)
expr_stmt|;
name|crypto_bignum_mod
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|order
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|crypto_bignum_is_zero
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|)
operator|||
name|crypto_bignum_is_one
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|)
condition|)
do|;
if|if
condition|(
operator|(
name|sae
operator|->
name|tmp
operator|->
name|ec
operator|&&
name|sae_derive_commit_element_ecc
argument_list|(
name|sae
argument_list|,
name|mask
argument_list|)
operator|<
literal|0
operator|)
operator|||
operator|(
name|sae
operator|->
name|tmp
operator|->
name|dh
operator|&&
name|sae_derive_commit_element_ffc
argument_list|(
name|sae
argument_list|,
name|mask
argument_list|)
operator|<
literal|0
operator|)
condition|)
goto|goto
name|fail
goto|;
name|ret
operator|=
literal|0
expr_stmt|;
name|fail
label|:
name|crypto_bignum_deinit
argument_list|(
name|mask
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|sae_prepare_commit
parameter_list|(
specifier|const
name|u8
modifier|*
name|addr1
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr2
parameter_list|,
specifier|const
name|u8
modifier|*
name|password
parameter_list|,
name|size_t
name|password_len
parameter_list|,
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|)
block|{
if|if
condition|(
name|sae
operator|->
name|tmp
operator|==
name|NULL
operator|||
operator|(
name|sae
operator|->
name|tmp
operator|->
name|ec
operator|&&
name|sae_derive_pwe_ecc
argument_list|(
name|sae
argument_list|,
name|addr1
argument_list|,
name|addr2
argument_list|,
name|password
argument_list|,
name|password_len
argument_list|)
operator|<
literal|0
operator|)
operator|||
operator|(
name|sae
operator|->
name|tmp
operator|->
name|dh
operator|&&
name|sae_derive_pwe_ffc
argument_list|(
name|sae
argument_list|,
name|addr1
argument_list|,
name|addr2
argument_list|,
name|password
argument_list|,
name|password_len
argument_list|)
operator|<
literal|0
operator|)
operator|||
name|sae_derive_commit
argument_list|(
name|sae
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sae_derive_k_ecc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
name|u8
modifier|*
name|k
parameter_list|)
block|{
name|struct
name|crypto_ec_point
modifier|*
name|K
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|K
operator|=
name|crypto_ec_point_init
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|)
expr_stmt|;
if|if
condition|(
name|K
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
comment|/* 	 * K = scalar-op(rand, (elem-op(scalar-op(peer-commit-scalar, PWE), 	 *                                        PEER-COMMIT-ELEMENT))) 	 * If K is identity element (point-at-infinity), reject 	 * k = F(K) (= x coordinate) 	 */
if|if
condition|(
name|crypto_ec_point_mul
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|pwe_ecc
argument_list|,
name|sae
operator|->
name|peer_commit_scalar
argument_list|,
name|K
argument_list|)
operator|<
literal|0
operator|||
name|crypto_ec_point_add
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|K
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ecc
argument_list|,
name|K
argument_list|)
operator|<
literal|0
operator|||
name|crypto_ec_point_mul
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|K
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|sae_rand
argument_list|,
name|K
argument_list|)
operator|<
literal|0
operator|||
name|crypto_ec_point_is_at_infinity
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|K
argument_list|)
operator|||
name|crypto_ec_point_to_bin
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|K
argument_list|,
name|k
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Failed to calculate K and k"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: k"
argument_list|,
name|k
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|fail
label|:
name|crypto_ec_point_deinit
argument_list|(
name|K
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sae_derive_k_ffc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
name|u8
modifier|*
name|k
parameter_list|)
block|{
name|struct
name|crypto_bignum
modifier|*
name|K
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|K
operator|=
name|crypto_bignum_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|K
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
comment|/* 	 * K = scalar-op(rand, (elem-op(scalar-op(peer-commit-scalar, PWE), 	 *                                        PEER-COMMIT-ELEMENT))) 	 * If K is identity element (one), reject. 	 * k = F(K) (= x coordinate) 	 */
if|if
condition|(
name|crypto_bignum_exptmod
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|pwe_ffc
argument_list|,
name|sae
operator|->
name|peer_commit_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|K
argument_list|)
operator|<
literal|0
operator|||
name|crypto_bignum_mulmod
argument_list|(
name|K
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|K
argument_list|)
operator|<
literal|0
operator|||
name|crypto_bignum_exptmod
argument_list|(
name|K
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|sae_rand
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|K
argument_list|)
operator|<
literal|0
operator|||
name|crypto_bignum_is_one
argument_list|(
name|K
argument_list|)
operator|||
name|crypto_bignum_to_bin
argument_list|(
name|K
argument_list|,
name|k
argument_list|,
name|SAE_MAX_PRIME_LEN
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Failed to calculate K and k"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: k"
argument_list|,
name|k
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|fail
label|:
name|crypto_bignum_deinit
argument_list|(
name|K
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sae_derive_keys
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|k
parameter_list|)
block|{
name|u8
name|null_key
index|[
name|SAE_KEYSEED_KEY_LEN
index|]
decl_stmt|,
name|val
index|[
name|SAE_MAX_PRIME_LEN
index|]
decl_stmt|;
name|u8
name|keyseed
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
name|u8
name|keys
index|[
name|SAE_KCK_LEN
operator|+
name|SAE_PMK_LEN
index|]
decl_stmt|;
name|struct
name|crypto_bignum
modifier|*
name|tmp
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|tmp
operator|=
name|crypto_bignum_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
comment|/* keyseed = H(<0>32, k) 	 * KCK || PMK = KDF-512(keyseed, "SAE KCK and PMK", 	 *                      (commit-scalar + peer-commit-scalar) modulo r) 	 * PMKID = L((commit-scalar + peer-commit-scalar) modulo r, 0, 128) 	 */
name|os_memset
argument_list|(
name|null_key
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|null_key
argument_list|)
argument_list|)
expr_stmt|;
name|hmac_sha256
argument_list|(
name|null_key
argument_list|,
sizeof|sizeof
argument_list|(
name|null_key
argument_list|)
argument_list|,
name|k
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|keyseed
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: keyseed"
argument_list|,
name|keyseed
argument_list|,
sizeof|sizeof
argument_list|(
name|keyseed
argument_list|)
argument_list|)
expr_stmt|;
name|crypto_bignum_add
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|,
name|sae
operator|->
name|peer_commit_scalar
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|crypto_bignum_mod
argument_list|(
name|tmp
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|order
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|crypto_bignum_to_bin
argument_list|(
name|tmp
argument_list|,
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: PMKID"
argument_list|,
name|val
argument_list|,
name|SAE_PMKID_LEN
argument_list|)
expr_stmt|;
name|sha256_prf
argument_list|(
name|keyseed
argument_list|,
sizeof|sizeof
argument_list|(
name|keyseed
argument_list|)
argument_list|,
literal|"SAE KCK and PMK"
argument_list|,
name|val
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|keys
argument_list|,
sizeof|sizeof
argument_list|(
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|keyseed
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|keyseed
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|kck
argument_list|,
name|keys
argument_list|,
name|SAE_KCK_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|sae
operator|->
name|pmk
argument_list|,
name|keys
operator|+
name|SAE_KCK_LEN
argument_list|,
name|SAE_PMK_LEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|keys
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|keys
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: KCK"
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|kck
argument_list|,
name|SAE_KCK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: PMK"
argument_list|,
name|sae
operator|->
name|pmk
argument_list|,
name|SAE_PMK_LEN
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|fail
label|:
name|crypto_bignum_deinit
argument_list|(
name|tmp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|sae_process_commit
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|)
block|{
name|u8
name|k
index|[
name|SAE_MAX_PRIME_LEN
index|]
decl_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|==
name|NULL
operator|||
operator|(
name|sae
operator|->
name|tmp
operator|->
name|ec
operator|&&
name|sae_derive_k_ecc
argument_list|(
name|sae
argument_list|,
name|k
argument_list|)
operator|<
literal|0
operator|)
operator|||
operator|(
name|sae
operator|->
name|tmp
operator|->
name|dh
operator|&&
name|sae_derive_k_ffc
argument_list|(
name|sae
argument_list|,
name|k
argument_list|)
operator|<
literal|0
operator|)
operator|||
name|sae_derive_keys
argument_list|(
name|sae
argument_list|,
name|k
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|sae_write_commit
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|token
parameter_list|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|==
name|NULL
condition|)
return|return;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|sae
operator|->
name|group
argument_list|)
expr_stmt|;
comment|/* Finite Cyclic Group */
if|if
condition|(
name|token
condition|)
block|{
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|token
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Anti-clogging token"
argument_list|,
name|wpabuf_head
argument_list|(
name|token
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|token
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|crypto_bignum_to_bin
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|,
name|pos
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: own commit-scalar"
argument_list|,
name|pos
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|ec
condition|)
block|{
name|pos
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
operator|*
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|crypto_ec_point_to_bin
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ecc
argument_list|,
name|pos
argument_list|,
name|pos
operator|+
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: own commit-element(x)"
argument_list|,
name|pos
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: own commit-element(y)"
argument_list|,
name|pos
operator|+
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|pos
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|crypto_bignum_to_bin
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
argument_list|,
name|pos
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: own commit-element"
argument_list|,
name|pos
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|u16
name|sae_group_allowed
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
name|int
modifier|*
name|allowed_groups
parameter_list|,
name|u16
name|group
parameter_list|)
block|{
if|if
condition|(
name|allowed_groups
condition|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|allowed_groups
index|[
name|i
index|]
operator|>
literal|0
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|allowed_groups
index|[
name|i
index|]
operator|==
name|group
condition|)
break|break;
block|}
if|if
condition|(
name|allowed_groups
index|[
name|i
index|]
operator|!=
name|group
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Proposed group %u not "
literal|"enabled in the current configuration"
argument_list|,
name|group
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_FINITE_CYCLIC_GROUP_NOT_SUPPORTED
return|;
block|}
block|}
if|if
condition|(
name|sae
operator|->
name|state
operator|==
name|SAE_COMMITTED
operator|&&
name|group
operator|!=
name|sae
operator|->
name|group
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Do not allow group to be changed"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_FINITE_CYCLIC_GROUP_NOT_SUPPORTED
return|;
block|}
if|if
condition|(
name|group
operator|!=
name|sae
operator|->
name|group
operator|&&
name|sae_set_group
argument_list|(
name|sae
argument_list|,
name|group
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Unsupported Finite Cyclic Group %u"
argument_list|,
name|group
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_FINITE_CYCLIC_GROUP_NOT_SUPPORTED
return|;
block|}
if|if
condition|(
name|sae
operator|->
name|tmp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Group information not yet initialized"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|dh
operator|&&
operator|!
name|allowed_groups
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Do not allow FFC group %u without "
literal|"explicit configuration enabling it"
argument_list|,
name|group
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_FINITE_CYCLIC_GROUP_NOT_SUPPORTED
return|;
block|}
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sae_parse_commit_token
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|,
specifier|const
name|u8
modifier|*
modifier|*
name|token
parameter_list|,
name|size_t
modifier|*
name|token_len
parameter_list|)
block|{
if|if
condition|(
operator|*
name|pos
operator|+
operator|(
name|sae
operator|->
name|tmp
operator|->
name|ec
condition|?
literal|3
else|:
literal|2
operator|)
operator|*
name|sae
operator|->
name|tmp
operator|->
name|prime_len
operator|<
name|end
condition|)
block|{
name|size_t
name|tlen
init|=
name|end
operator|-
operator|(
operator|*
name|pos
operator|+
operator|(
name|sae
operator|->
name|tmp
operator|->
name|ec
condition|?
literal|3
else|:
literal|2
operator|)
operator|*
name|sae
operator|->
name|tmp
operator|->
name|prime_len
operator|)
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Anti-Clogging Token"
argument_list|,
operator|*
name|pos
argument_list|,
name|tlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|token
condition|)
operator|*
name|token
operator|=
operator|*
name|pos
expr_stmt|;
if|if
condition|(
name|token_len
condition|)
operator|*
name|token_len
operator|=
name|tlen
expr_stmt|;
operator|*
name|pos
operator|+=
name|tlen
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|token
condition|)
operator|*
name|token
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|token_len
condition|)
operator|*
name|token_len
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|u16
name|sae_parse_commit_scalar
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|struct
name|crypto_bignum
modifier|*
name|peer_scalar
decl_stmt|;
if|if
condition|(
operator|*
name|pos
operator|+
name|sae
operator|->
name|tmp
operator|->
name|prime_len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Not enough data for scalar"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|peer_scalar
operator|=
name|crypto_bignum_init_set
argument_list|(
operator|*
name|pos
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer_scalar
operator|==
name|NULL
condition|)
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
comment|/* 	 * IEEE Std 802.11-2012, 11.3.8.6.1: If there is a protocol instance for 	 * the peer and it is in Authenticated state, the new Commit Message 	 * shall be dropped if the peer-scalar is identical to the one used in 	 * the existing protocol instance. 	 */
if|if
condition|(
name|sae
operator|->
name|state
operator|==
name|SAE_ACCEPTED
operator|&&
name|sae
operator|->
name|peer_commit_scalar
operator|&&
name|crypto_bignum_cmp
argument_list|(
name|sae
operator|->
name|peer_commit_scalar
argument_list|,
name|peer_scalar
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Do not accept re-use of previous "
literal|"peer-commit-scalar"
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|peer_scalar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
comment|/* 1< scalar< r */
if|if
condition|(
name|crypto_bignum_is_zero
argument_list|(
name|peer_scalar
argument_list|)
operator|||
name|crypto_bignum_is_one
argument_list|(
name|peer_scalar
argument_list|)
operator|||
name|crypto_bignum_cmp
argument_list|(
name|peer_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|order
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Invalid peer scalar"
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|peer_scalar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|crypto_bignum_deinit
argument_list|(
name|sae
operator|->
name|peer_commit_scalar
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sae
operator|->
name|peer_commit_scalar
operator|=
name|peer_scalar
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Peer commit-scalar"
argument_list|,
operator|*
name|pos
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|+=
name|sae
operator|->
name|tmp
operator|->
name|prime_len
expr_stmt|;
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|u16
name|sae_parse_commit_element_ecc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|u8
name|prime
index|[
name|SAE_MAX_ECC_PRIME_LEN
index|]
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|*
name|sae
operator|->
name|tmp
operator|->
name|prime_len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Not enough data for "
literal|"commit-element"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
if|if
condition|(
name|crypto_bignum_to_bin
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|prime
argument_list|,
sizeof|sizeof
argument_list|(
name|prime
argument_list|)
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
comment|/* element x and y coordinates< p */
if|if
condition|(
name|os_memcmp
argument_list|(
name|pos
argument_list|,
name|prime
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
operator|>=
literal|0
operator|||
name|os_memcmp
argument_list|(
name|pos
operator|+
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|prime
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Invalid coordinates in peer "
literal|"element"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Peer commit-element(x)"
argument_list|,
name|pos
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Peer commit-element(y)"
argument_list|,
name|pos
operator|+
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|crypto_ec_point_deinit
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ecc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ecc
operator|=
name|crypto_ec_point_from_bin
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ecc
operator|==
name|NULL
condition|)
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
if|if
condition|(
operator|!
name|crypto_ec_point_is_on_curve
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ecc
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Peer element is not on curve"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|u16
name|sae_parse_commit_element_ffc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|struct
name|crypto_bignum
modifier|*
name|res
decl_stmt|,
modifier|*
name|one
decl_stmt|;
specifier|const
name|u8
name|one_bin
index|[
literal|1
index|]
init|=
block|{
literal|0x01
block|}
decl_stmt|;
if|if
condition|(
name|pos
operator|+
name|sae
operator|->
name|tmp
operator|->
name|prime_len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Not enough data for "
literal|"commit-element"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Peer commit-element"
argument_list|,
name|pos
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
operator|=
name|crypto_bignum_init_set
argument_list|(
name|pos
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
operator|==
name|NULL
condition|)
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
comment|/* 1< element< p - 1 */
name|res
operator|=
name|crypto_bignum_init
argument_list|()
expr_stmt|;
name|one
operator|=
name|crypto_bignum_init_set
argument_list|(
name|one_bin
argument_list|,
sizeof|sizeof
argument_list|(
name|one_bin
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
operator|||
operator|!
name|one
operator|||
name|crypto_bignum_sub
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|one
argument_list|,
name|res
argument_list|)
operator|||
name|crypto_bignum_is_zero
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
argument_list|)
operator|||
name|crypto_bignum_is_one
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
argument_list|)
operator|||
name|crypto_bignum_cmp
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
argument_list|,
name|res
argument_list|)
operator|>=
literal|0
condition|)
block|{
name|crypto_bignum_deinit
argument_list|(
name|res
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|one
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Invalid peer element"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|crypto_bignum_deinit
argument_list|(
name|one
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* scalar-op(r, ELEMENT) = 1 modulo p */
if|if
condition|(
name|crypto_bignum_exptmod
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|order
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime
argument_list|,
name|res
argument_list|)
operator|<
literal|0
operator|||
operator|!
name|crypto_bignum_is_one
argument_list|(
name|res
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Invalid peer element (scalar-op)"
argument_list|)
expr_stmt|;
name|crypto_bignum_deinit
argument_list|(
name|res
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|crypto_bignum_deinit
argument_list|(
name|res
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|u16
name|sae_parse_commit_element
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|dh
condition|)
return|return
name|sae_parse_commit_element_ffc
argument_list|(
name|sae
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
return|return
name|sae_parse_commit_element_ecc
argument_list|(
name|sae
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
name|u16
name|sae_parse_commit
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|u8
modifier|*
modifier|*
name|token
parameter_list|,
name|size_t
modifier|*
name|token_len
parameter_list|,
name|int
modifier|*
name|allowed_groups
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|data
decl_stmt|,
modifier|*
name|end
init|=
name|data
operator|+
name|len
decl_stmt|;
name|u16
name|res
decl_stmt|;
comment|/* Check Finite Cyclic Group */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
name|res
operator|=
name|sae_group_allowed
argument_list|(
name|sae
argument_list|,
name|allowed_groups
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
return|return
name|res
return|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* Optional Anti-Clogging Token */
name|sae_parse_commit_token
argument_list|(
name|sae
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|,
name|token
argument_list|,
name|token_len
argument_list|)
expr_stmt|;
comment|/* commit-scalar */
name|res
operator|=
name|sae_parse_commit_scalar
argument_list|(
name|sae
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
return|return
name|res
return|;
comment|/* commit-element */
name|res
operator|=
name|sae_parse_commit_element
argument_list|(
name|sae
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
return|return
name|res
return|;
comment|/* 	 * Check whether peer-commit-scalar and PEER-COMMIT-ELEMENT are same as 	 * the values we sent which would be evidence of a reflection attack. 	 */
if|if
condition|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
operator|||
name|crypto_bignum_cmp
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|,
name|sae
operator|->
name|peer_commit_scalar
argument_list|)
operator|!=
literal|0
operator|||
operator|(
name|sae
operator|->
name|tmp
operator|->
name|dh
operator|&&
operator|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
operator|||
name|crypto_bignum_cmp
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
argument_list|)
operator|!=
literal|0
operator|)
operator|)
operator|||
operator|(
name|sae
operator|->
name|tmp
operator|->
name|ec
operator|&&
operator|(
operator|!
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ecc
operator|||
name|crypto_ec_point_cmp
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ecc
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ecc
argument_list|)
operator|!=
literal|0
operator|)
operator|)
condition|)
return|return
name|WLAN_STATUS_SUCCESS
return|;
comment|/* scalars/elements are different */
comment|/* 	 * This is a reflection attack - return special value to trigger caller 	 * to silently discard the frame instead of replying with a specific 	 * status code. 	 */
return|return
name|SAE_SILENTLY_DISCARD
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sae_cn_confirm
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|scalar1
parameter_list|,
specifier|const
name|u8
modifier|*
name|element1
parameter_list|,
name|size_t
name|element1_len
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|scalar2
parameter_list|,
specifier|const
name|u8
modifier|*
name|element2
parameter_list|,
name|size_t
name|element2_len
parameter_list|,
name|u8
modifier|*
name|confirm
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|5
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|5
index|]
decl_stmt|;
name|u8
name|scalar_b1
index|[
name|SAE_MAX_PRIME_LEN
index|]
decl_stmt|,
name|scalar_b2
index|[
name|SAE_MAX_PRIME_LEN
index|]
decl_stmt|;
comment|/* Confirm 	 * CN(key, X, Y, Z, ...) = 	 *    HMAC-SHA256(key, D2OS(X) || D2OS(Y) || D2OS(Z) | ...) 	 * confirm = CN(KCK, send-confirm, commit-scalar, COMMIT-ELEMENT, 	 *              peer-commit-scalar, PEER-COMMIT-ELEMENT) 	 * verifier = CN(KCK, peer-send-confirm, peer-commit-scalar, 	 *               PEER-COMMIT-ELEMENT, commit-scalar, COMMIT-ELEMENT) 	 */
name|addr
index|[
literal|0
index|]
operator|=
name|sc
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
literal|2
expr_stmt|;
name|crypto_bignum_to_bin
argument_list|(
name|scalar1
argument_list|,
name|scalar_b1
argument_list|,
sizeof|sizeof
argument_list|(
name|scalar_b1
argument_list|)
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|scalar_b1
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|sae
operator|->
name|tmp
operator|->
name|prime_len
expr_stmt|;
name|addr
index|[
literal|2
index|]
operator|=
name|element1
expr_stmt|;
name|len
index|[
literal|2
index|]
operator|=
name|element1_len
expr_stmt|;
name|crypto_bignum_to_bin
argument_list|(
name|scalar2
argument_list|,
name|scalar_b2
argument_list|,
sizeof|sizeof
argument_list|(
name|scalar_b2
argument_list|)
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|addr
index|[
literal|3
index|]
operator|=
name|scalar_b2
expr_stmt|;
name|len
index|[
literal|3
index|]
operator|=
name|sae
operator|->
name|tmp
operator|->
name|prime_len
expr_stmt|;
name|addr
index|[
literal|4
index|]
operator|=
name|element2
expr_stmt|;
name|len
index|[
literal|4
index|]
operator|=
name|element2_len
expr_stmt|;
name|hmac_sha256_vector
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|kck
argument_list|,
sizeof|sizeof
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|kck
argument_list|)
argument_list|,
literal|5
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|confirm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sae_cn_confirm_ecc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|scalar1
parameter_list|,
specifier|const
name|struct
name|crypto_ec_point
modifier|*
name|element1
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|scalar2
parameter_list|,
specifier|const
name|struct
name|crypto_ec_point
modifier|*
name|element2
parameter_list|,
name|u8
modifier|*
name|confirm
parameter_list|)
block|{
name|u8
name|element_b1
index|[
literal|2
operator|*
name|SAE_MAX_ECC_PRIME_LEN
index|]
decl_stmt|;
name|u8
name|element_b2
index|[
literal|2
operator|*
name|SAE_MAX_ECC_PRIME_LEN
index|]
decl_stmt|;
name|crypto_ec_point_to_bin
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|element1
argument_list|,
name|element_b1
argument_list|,
name|element_b1
operator|+
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|crypto_ec_point_to_bin
argument_list|(
name|sae
operator|->
name|tmp
operator|->
name|ec
argument_list|,
name|element2
argument_list|,
name|element_b2
argument_list|,
name|element_b2
operator|+
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|sae_cn_confirm
argument_list|(
name|sae
argument_list|,
name|sc
argument_list|,
name|scalar1
argument_list|,
name|element_b1
argument_list|,
literal|2
operator|*
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|scalar2
argument_list|,
name|element_b2
argument_list|,
literal|2
operator|*
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|confirm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sae_cn_confirm_ffc
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|sc
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|scalar1
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|element1
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|scalar2
parameter_list|,
specifier|const
name|struct
name|crypto_bignum
modifier|*
name|element2
parameter_list|,
name|u8
modifier|*
name|confirm
parameter_list|)
block|{
name|u8
name|element_b1
index|[
name|SAE_MAX_PRIME_LEN
index|]
decl_stmt|;
name|u8
name|element_b2
index|[
name|SAE_MAX_PRIME_LEN
index|]
decl_stmt|;
name|crypto_bignum_to_bin
argument_list|(
name|element1
argument_list|,
name|element_b1
argument_list|,
sizeof|sizeof
argument_list|(
name|element_b1
argument_list|)
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|crypto_bignum_to_bin
argument_list|(
name|element2
argument_list|,
name|element_b2
argument_list|,
sizeof|sizeof
argument_list|(
name|element_b2
argument_list|)
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|)
expr_stmt|;
name|sae_cn_confirm
argument_list|(
name|sae
argument_list|,
name|sc
argument_list|,
name|scalar1
argument_list|,
name|element_b1
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|scalar2
argument_list|,
name|element_b2
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|prime_len
argument_list|,
name|confirm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sae_write_confirm
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|sc
decl_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|==
name|NULL
condition|)
return|return;
comment|/* Send-Confirm */
name|sc
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|sae
operator|->
name|send_confirm
argument_list|)
expr_stmt|;
name|sae
operator|->
name|send_confirm
operator|++
expr_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|ec
condition|)
name|sae_cn_confirm_ecc
argument_list|(
name|sae
argument_list|,
name|sc
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ecc
argument_list|,
name|sae
operator|->
name|peer_commit_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ecc
argument_list|,
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|sae_cn_confirm_ffc
argument_list|(
name|sae
argument_list|,
name|sc
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
argument_list|,
name|sae
operator|->
name|peer_commit_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
argument_list|,
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sae_check_confirm
parameter_list|(
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u8
name|verifier
index|[
name|SHA256_MAC_LEN
index|]
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
operator|+
name|SHA256_MAC_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Too short confirm message"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: peer-send-confirm %u"
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sae
operator|->
name|tmp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Temporary data not yet available"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|sae
operator|->
name|tmp
operator|->
name|ec
condition|)
name|sae_cn_confirm_ecc
argument_list|(
name|sae
argument_list|,
name|data
argument_list|,
name|sae
operator|->
name|peer_commit_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ecc
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ecc
argument_list|,
name|verifier
argument_list|)
expr_stmt|;
else|else
name|sae_cn_confirm_ffc
argument_list|(
name|sae
argument_list|,
name|data
argument_list|,
name|sae
operator|->
name|peer_commit_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|peer_commit_element_ffc
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_scalar
argument_list|,
name|sae
operator|->
name|tmp
operator|->
name|own_commit_element_ffc
argument_list|,
name|verifier
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp_const
argument_list|(
name|verifier
argument_list|,
name|data
operator|+
literal|2
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Confirm mismatch"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Received confirm"
argument_list|,
name|data
operator|+
literal|2
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Calculated verifier"
argument_list|,
name|verifier
argument_list|,
name|SHA256_MAC_LEN
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


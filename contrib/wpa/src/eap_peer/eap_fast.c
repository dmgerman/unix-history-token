begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * EAP peer method: EAP-FAST (RFC 4851)  * Copyright (c) 2004-2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eap_i.h"
end_include

begin_include
include|#
directive|include
file|"eap_tls_common.h"
end_include

begin_include
include|#
directive|include
file|"eap_config.h"
end_include

begin_include
include|#
directive|include
file|"tls.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_tlv_common.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"eap_fast_pac.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_FAST_DYNAMIC
end_ifdef

begin_include
include|#
directive|include
file|"eap_fast_pac.c"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_FAST_DYNAMIC */
end_comment

begin_comment
comment|/* TODO:  * - test session resumption and enable it if it interoperates  * - password change (pending mschapv2 packet; replay decrypted packet)  */
end_comment

begin_function_decl
specifier|static
name|void
name|eap_fast_deinit
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|eap_fast_data
block|{
name|struct
name|eap_ssl_data
name|ssl
decl_stmt|;
name|int
name|fast_version
decl_stmt|;
specifier|const
name|struct
name|eap_method
modifier|*
name|phase2_method
decl_stmt|;
name|void
modifier|*
name|phase2_priv
decl_stmt|;
name|int
name|phase2_success
decl_stmt|;
name|struct
name|eap_method_type
name|phase2_type
decl_stmt|;
name|struct
name|eap_method_type
modifier|*
name|phase2_types
decl_stmt|;
name|size_t
name|num_phase2_types
decl_stmt|;
name|int
name|resuming
decl_stmt|;
comment|/* starting a resumed session */
name|struct
name|eap_fast_key_block_provisioning
modifier|*
name|key_block_p
decl_stmt|;
define|#
directive|define
name|EAP_FAST_PROV_UNAUTH
value|1
define|#
directive|define
name|EAP_FAST_PROV_AUTH
value|2
name|int
name|provisioning_allowed
decl_stmt|;
comment|/* Allowed PAC provisioning modes */
name|int
name|provisioning
decl_stmt|;
comment|/* doing PAC provisioning (not the normal auth) */
name|int
name|anon_provisioning
decl_stmt|;
comment|/* doing anonymous (unauthenticated) 				* provisioning */
name|int
name|session_ticket_used
decl_stmt|;
name|u8
name|key_data
index|[
name|EAP_FAST_KEY_LEN
index|]
decl_stmt|;
name|u8
name|emsk
index|[
name|EAP_EMSK_LEN
index|]
decl_stmt|;
name|int
name|success
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|current_pac
decl_stmt|;
name|size_t
name|max_pac_list_len
decl_stmt|;
name|int
name|use_pac_binary_format
decl_stmt|;
name|u8
name|simck
index|[
name|EAP_FAST_SIMCK_LEN
index|]
decl_stmt|;
name|int
name|simck_idx
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|pending_phase2_req
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|eap_fast_session_ticket_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|ticket
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|u8
modifier|*
name|client_random
parameter_list|,
specifier|const
name|u8
modifier|*
name|server_random
parameter_list|,
name|u8
modifier|*
name|master_secret
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: SessionTicket callback"
argument_list|)
expr_stmt|;
if|if
condition|(
name|client_random
operator|==
name|NULL
operator|||
name|server_random
operator|==
name|NULL
operator|||
name|master_secret
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: SessionTicket failed - fall "
literal|"back to full TLS handshake"
argument_list|)
expr_stmt|;
name|data
operator|->
name|session_ticket_used
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|provisioning_allowed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Try to provision a "
literal|"new PAC-Key"
argument_list|)
expr_stmt|;
name|data
operator|->
name|provisioning
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|current_pac
operator|=
name|NULL
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: SessionTicket"
argument_list|,
name|ticket
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|current_pac
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: No PAC-Key available for "
literal|"using SessionTicket"
argument_list|)
expr_stmt|;
name|data
operator|->
name|session_ticket_used
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|eap_fast_derive_master_secret
argument_list|(
name|data
operator|->
name|current_pac
operator|->
name|pac_key
argument_list|,
name|server_random
argument_list|,
name|client_random
argument_list|,
name|master_secret
argument_list|)
expr_stmt|;
name|data
operator|->
name|session_ticket_used
operator|=
literal|1
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_parse_phase1
parameter_list|(
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|phase1
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|phase1
argument_list|,
literal|"fast_provisioning="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|data
operator|->
name|provisioning_allowed
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|18
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Automatic PAC provisioning "
literal|"mode: %d"
argument_list|,
name|data
operator|->
name|provisioning_allowed
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
name|os_strstr
argument_list|(
name|phase1
argument_list|,
literal|"fast_max_pac_list_len="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|data
operator|->
name|max_pac_list_len
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|22
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|max_pac_list_len
operator|==
literal|0
condition|)
name|data
operator|->
name|max_pac_list_len
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Maximum PAC list length: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|data
operator|->
name|max_pac_list_len
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
name|os_strstr
argument_list|(
name|phase1
argument_list|,
literal|"fast_pac_format=binary"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|data
operator|->
name|use_pac_binary_format
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Using binary format for PAC "
literal|"list"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|eap_fast_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
decl_stmt|;
name|struct
name|eap_peer_config
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|->
name|fast_version
operator|=
name|EAP_FAST_VERSION
expr_stmt|;
name|data
operator|->
name|max_pac_list_len
operator|=
literal|10
expr_stmt|;
if|if
condition|(
name|config
operator|&&
name|config
operator|->
name|phase1
operator|&&
name|eap_fast_parse_phase1
argument_list|(
name|data
argument_list|,
name|config
operator|->
name|phase1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|eap_peer_select_phase2_methods
argument_list|(
name|config
argument_list|,
literal|"auth="
argument_list|,
operator|&
name|data
operator|->
name|phase2_types
argument_list|,
operator|&
name|data
operator|->
name|num_phase2_types
argument_list|)
operator|<
literal|0
condition|)
block|{
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|phase2_type
operator|.
name|vendor
operator|=
name|EAP_VENDOR_IETF
expr_stmt|;
name|data
operator|->
name|phase2_type
operator|.
name|method
operator|=
name|EAP_TYPE_NONE
expr_stmt|;
if|if
condition|(
name|eap_peer_tls_ssl_init
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|config
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to initialize SSL."
argument_list|)
expr_stmt|;
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|tls_connection_set_session_ticket_cb
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|eap_fast_session_ticket_cb
argument_list|,
name|data
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to set SessionTicket "
literal|"callback"
argument_list|)
expr_stmt|;
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	 * The local RADIUS server in a Cisco AP does not seem to like empty 	 * fragments before data, so disable that workaround for CBC. 	 * TODO: consider making this configurable 	 */
if|if
condition|(
name|tls_connection_enable_workaround
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to enable TLS "
literal|"workarounds"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|use_pac_binary_format
operator|&&
name|eap_fast_load_pac_bin
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|pac
argument_list|,
name|config
operator|->
name|pac_file
argument_list|)
operator|<
literal|0
condition|)
block|{
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|data
operator|->
name|use_pac_binary_format
operator|&&
name|eap_fast_load_pac
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|pac
argument_list|,
name|config
operator|->
name|pac_file
argument_list|)
operator|<
literal|0
condition|)
block|{
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|eap_fast_pac_list_truncate
argument_list|(
name|data
operator|->
name|pac
argument_list|,
name|data
operator|->
name|max_pac_list_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|pac
operator|==
name|NULL
operator|&&
operator|!
name|data
operator|->
name|provisioning_allowed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: No PAC configured and "
literal|"provisioning disabled"
argument_list|)
expr_stmt|;
name|eap_fast_deinit
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_deinit
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|data
operator|->
name|phase2_priv
operator|&&
name|data
operator|->
name|phase2_method
condition|)
name|data
operator|->
name|phase2_method
operator|->
name|deinit
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|phase2_priv
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|phase2_types
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|key_block_p
argument_list|)
expr_stmt|;
name|eap_peer_tls_ssl_deinit
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|pac
operator|=
name|data
operator|->
name|pac
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
name|prev
operator|=
name|pac
expr_stmt|;
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
name|eap_fast_free_pac
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|data
operator|->
name|pending_phase2_req
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_derive_msk
parameter_list|(
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
name|eap_fast_derive_eap_msk
argument_list|(
name|data
operator|->
name|simck
argument_list|,
name|data
operator|->
name|key_data
argument_list|)
expr_stmt|;
name|eap_fast_derive_eap_emsk
argument_list|(
name|data
operator|->
name|simck
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
name|data
operator|->
name|success
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_derive_key_auth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
name|u8
modifier|*
name|sks
decl_stmt|;
comment|/* RFC 4851, Section 5.1: 	 * Extra key material after TLS key_block: session_key_seed[40] 	 */
name|sks
operator|=
name|eap_fast_derive_key
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
literal|"key expansion"
argument_list|,
name|EAP_FAST_SKS_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|sks
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to derive "
literal|"session_key_seed"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * RFC 4851, Section 5.2: 	 * S-IMCK[0] = session_key_seed 	 */
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: session_key_seed (SKS = S-IMCK[0])"
argument_list|,
name|sks
argument_list|,
name|EAP_FAST_SKS_LEN
argument_list|)
expr_stmt|;
name|data
operator|->
name|simck_idx
operator|=
literal|0
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|simck
argument_list|,
name|sks
argument_list|,
name|EAP_FAST_SIMCK_LEN
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|sks
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_derive_key_provisioning
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|key_block_p
argument_list|)
expr_stmt|;
name|data
operator|->
name|key_block_p
operator|=
operator|(
expr|struct
name|eap_fast_key_block_provisioning
operator|*
operator|)
name|eap_fast_derive_key
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
literal|"key expansion"
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|data
operator|->
name|key_block_p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|key_block_p
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to derive key block"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * RFC 4851, Section 5.2: 	 * S-IMCK[0] = session_key_seed 	 */
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: session_key_seed (SKS = S-IMCK[0])"
argument_list|,
name|data
operator|->
name|key_block_p
operator|->
name|session_key_seed
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|key_block_p
operator|->
name|session_key_seed
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|simck_idx
operator|=
literal|0
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|simck
argument_list|,
name|data
operator|->
name|key_block_p
operator|->
name|session_key_seed
argument_list|,
name|EAP_FAST_SIMCK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: server_challenge"
argument_list|,
name|data
operator|->
name|key_block_p
operator|->
name|server_challenge
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|key_block_p
operator|->
name|server_challenge
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: client_challenge"
argument_list|,
name|data
operator|->
name|key_block_p
operator|->
name|client_challenge
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|->
name|key_block_p
operator|->
name|client_challenge
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_derive_keys
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|->
name|anon_provisioning
condition|)
name|eap_fast_derive_key_provisioning
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
else|else
name|eap_fast_derive_key_auth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_init_phase2_method
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
name|data
operator|->
name|phase2_method
operator|=
name|eap_peer_get_eap_method
argument_list|(
name|data
operator|->
name|phase2_type
operator|.
name|vendor
argument_list|,
name|data
operator|->
name|phase2_type
operator|.
name|method
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|phase2_method
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|data
operator|->
name|key_block_p
condition|)
block|{
name|sm
operator|->
name|auth_challenge
operator|=
name|data
operator|->
name|key_block_p
operator|->
name|server_challenge
expr_stmt|;
name|sm
operator|->
name|peer_challenge
operator|=
name|data
operator|->
name|key_block_p
operator|->
name|client_challenge
expr_stmt|;
block|}
name|sm
operator|->
name|init_phase2
operator|=
literal|1
expr_stmt|;
name|data
operator|->
name|phase2_priv
operator|=
name|data
operator|->
name|phase2_method
operator|->
name|init
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|sm
operator|->
name|init_phase2
operator|=
literal|0
expr_stmt|;
name|sm
operator|->
name|auth_challenge
operator|=
name|NULL
expr_stmt|;
name|sm
operator|->
name|peer_challenge
operator|=
name|NULL
expr_stmt|;
return|return
name|data
operator|->
name|phase2_priv
operator|==
name|NULL
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_select_phase2_method
parameter_list|(
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|u8
name|type
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
comment|/* TODO: TNC with anonymous provisioning; need to require both 	 * completed MSCHAPv2 and TNC */
if|if
condition|(
name|data
operator|->
name|anon_provisioning
operator|&&
name|type
operator|!=
name|EAP_TYPE_MSCHAPV2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Only EAP-MSCHAPv2 is allowed "
literal|"during unauthenticated provisioning; reject phase2"
literal|" type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|EAP_TNC
if|if
condition|(
name|type
operator|==
name|EAP_TYPE_TNC
condition|)
block|{
name|data
operator|->
name|phase2_type
operator|.
name|vendor
operator|=
name|EAP_VENDOR_IETF
expr_stmt|;
name|data
operator|->
name|phase2_type
operator|.
name|method
operator|=
name|EAP_TYPE_TNC
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Selected Phase 2 EAP "
literal|"vendor %d method %d for TNC"
argument_list|,
name|data
operator|->
name|phase2_type
operator|.
name|vendor
argument_list|,
name|data
operator|->
name|phase2_type
operator|.
name|method
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* EAP_TNC */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|num_phase2_types
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|data
operator|->
name|phase2_types
index|[
name|i
index|]
operator|.
name|vendor
operator|!=
name|EAP_VENDOR_IETF
operator|||
name|data
operator|->
name|phase2_types
index|[
name|i
index|]
operator|.
name|method
operator|!=
name|type
condition|)
continue|continue;
name|data
operator|->
name|phase2_type
operator|.
name|vendor
operator|=
name|data
operator|->
name|phase2_types
index|[
name|i
index|]
operator|.
name|vendor
expr_stmt|;
name|data
operator|->
name|phase2_type
operator|.
name|method
operator|=
name|data
operator|->
name|phase2_types
index|[
name|i
index|]
operator|.
name|method
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Selected Phase 2 EAP "
literal|"vendor %d method %d"
argument_list|,
name|data
operator|->
name|phase2_type
operator|.
name|vendor
argument_list|,
name|data
operator|->
name|phase2_type
operator|.
name|method
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|type
operator|!=
name|data
operator|->
name|phase2_type
operator|.
name|method
operator|||
name|type
operator|==
name|EAP_TYPE_NONE
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_phase2_request
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
name|struct
name|eap_hdr
modifier|*
name|hdr
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|resp
parameter_list|)
block|{
name|size_t
name|len
init|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|length
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|eap_method_ret
name|iret
decl_stmt|;
name|struct
name|eap_peer_config
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|struct
name|wpabuf
name|msg
decl_stmt|;
if|if
condition|(
name|len
operator|<=
sizeof|sizeof
argument_list|(
expr|struct
name|eap_hdr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: too short "
literal|"Phase 2 request (len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Phase 2 Request: type=%d"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
name|EAP_TYPE_IDENTITY
condition|)
block|{
operator|*
name|resp
operator|=
name|eap_sm_buildIdentity
argument_list|(
name|sm
argument_list|,
name|hdr
operator|->
name|identifier
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|data
operator|->
name|phase2_priv
operator|&&
name|data
operator|->
name|phase2_method
operator|&&
operator|*
name|pos
operator|!=
name|data
operator|->
name|phase2_type
operator|.
name|method
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Phase 2 EAP sequence - "
literal|"deinitialize previous method"
argument_list|)
expr_stmt|;
name|data
operator|->
name|phase2_method
operator|->
name|deinit
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|phase2_priv
argument_list|)
expr_stmt|;
name|data
operator|->
name|phase2_method
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|phase2_priv
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|phase2_type
operator|.
name|vendor
operator|=
name|EAP_VENDOR_IETF
expr_stmt|;
name|data
operator|->
name|phase2_type
operator|.
name|method
operator|=
name|EAP_TYPE_NONE
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|phase2_type
operator|.
name|vendor
operator|==
name|EAP_VENDOR_IETF
operator|&&
name|data
operator|->
name|phase2_type
operator|.
name|method
operator|==
name|EAP_TYPE_NONE
operator|&&
name|eap_fast_select_phase2_method
argument_list|(
name|data
argument_list|,
operator|*
name|pos
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|eap_peer_tls_phase2_nak
argument_list|(
name|data
operator|->
name|phase2_types
argument_list|,
name|data
operator|->
name|num_phase2_types
argument_list|,
name|hdr
argument_list|,
name|resp
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|data
operator|->
name|phase2_priv
operator|==
name|NULL
operator|&&
name|eap_fast_init_phase2_method
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to initialize "
literal|"Phase 2 EAP method %d"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|iret
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iret
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_set
argument_list|(
operator|&
name|msg
argument_list|,
name|hdr
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|resp
operator|=
name|data
operator|->
name|phase2_method
operator|->
name|process
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|phase2_priv
argument_list|,
operator|&
name|iret
argument_list|,
operator|&
name|msg
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
operator|||
operator|(
name|iret
operator|.
name|methodState
operator|==
name|METHOD_DONE
operator|&&
name|iret
operator|.
name|decision
operator|==
name|DECISION_FAIL
operator|)
condition|)
block|{
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|iret
operator|.
name|methodState
operator|==
name|METHOD_DONE
operator|||
name|iret
operator|.
name|methodState
operator|==
name|METHOD_MAY_CONT
operator|)
operator|&&
operator|(
name|iret
operator|.
name|decision
operator|==
name|DECISION_UNCOND_SUCC
operator|||
name|iret
operator|.
name|decision
operator|==
name|DECISION_COND_SUCC
operator|)
condition|)
block|{
name|data
operator|->
name|phase2_success
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
operator|&&
name|config
operator|&&
operator|(
name|config
operator|->
name|pending_req_identity
operator|||
name|config
operator|->
name|pending_req_password
operator|||
name|config
operator|->
name|pending_req_otp
operator|||
name|config
operator|->
name|pending_req_new_password
operator|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|data
operator|->
name|pending_phase2_req
argument_list|)
expr_stmt|;
name|data
operator|->
name|pending_phase2_req
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|hdr
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|resp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_fast_tlv_nak
parameter_list|(
name|int
name|vendor_id
parameter_list|,
name|int
name|tlv_type
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|struct
name|eap_tlv_nak_tlv
modifier|*
name|nak
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|nak
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|nak
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|nak
argument_list|)
argument_list|)
expr_stmt|;
name|nak
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_TYPE_MANDATORY
operator||
name|EAP_TLV_NAK_TLV
argument_list|)
expr_stmt|;
name|nak
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
literal|6
argument_list|)
expr_stmt|;
name|nak
operator|->
name|vendor_id
operator|=
name|host_to_be32
argument_list|(
name|vendor_id
argument_list|)
expr_stmt|;
name|nak
operator|->
name|nak_type
operator|=
name|host_to_be16
argument_list|(
name|tlv_type
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_fast_tlv_result
parameter_list|(
name|int
name|status
parameter_list|,
name|int
name|intermediate
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|struct
name|eap_tlv_intermediate_result_tlv
modifier|*
name|result
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Add %sResult TLV(status=%d)"
argument_list|,
name|intermediate
condition|?
literal|"Intermediate "
else|:
literal|""
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|result
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|result
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_TYPE_MANDATORY
operator||
operator|(
name|intermediate
condition|?
name|EAP_TLV_INTERMEDIATE_RESULT_TLV
else|:
name|EAP_TLV_RESULT_TLV
operator|)
argument_list|)
expr_stmt|;
name|result
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|result
operator|->
name|status
operator|=
name|host_to_be16
argument_list|(
name|status
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_fast_tlv_pac_ack
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|struct
name|eap_tlv_result_tlv
modifier|*
name|res
decl_stmt|;
name|struct
name|eap_tlv_pac_ack_tlv
modifier|*
name|ack
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|res
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ack
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Add PAC TLV (ack)"
argument_list|)
expr_stmt|;
name|ack
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ack
argument_list|)
argument_list|)
expr_stmt|;
name|ack
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_PAC_TLV
operator||
name|EAP_TLV_TYPE_MANDATORY
argument_list|)
expr_stmt|;
name|ack
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ack
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|ack
operator|->
name|pac_type
operator|=
name|host_to_be16
argument_list|(
name|PAC_TYPE_PAC_ACKNOWLEDGEMENT
argument_list|)
expr_stmt|;
name|ack
operator|->
name|pac_len
operator|=
name|host_to_be16
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|ack
operator|->
name|result
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_RESULT_SUCCESS
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_fast_process_eap_payload_tlv
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|u8
modifier|*
name|eap_payload_tlv
parameter_list|,
name|size_t
name|eap_payload_tlv_len
parameter_list|)
block|{
name|struct
name|eap_hdr
modifier|*
name|hdr
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|resp
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|eap_payload_tlv_len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: too short EAP "
literal|"Payload TLV (len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|eap_payload_tlv_len
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|hdr
operator|=
operator|(
expr|struct
name|eap_hdr
operator|*
operator|)
name|eap_payload_tlv
expr_stmt|;
if|if
condition|(
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|length
argument_list|)
operator|>
name|eap_payload_tlv_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: EAP packet overflow in "
literal|"EAP Payload TLV"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|hdr
operator|->
name|code
operator|!=
name|EAP_CODE_REQUEST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Unexpected code=%d in "
literal|"Phase 2 EAP header"
argument_list|,
name|hdr
operator|->
name|code
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|eap_fast_phase2_request
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|hdr
argument_list|,
operator|&
name|resp
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Phase2 Request processing "
literal|"failed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|eap_fast_tlv_eap_payload
argument_list|(
name|resp
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_validate_crypto_binding
parameter_list|(
name|struct
name|eap_tlv_crypto_binding_tlv
modifier|*
name|_bind
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Crypto-Binding TLV: Version %d "
literal|"Received Version %d SubType %d"
argument_list|,
name|_bind
operator|->
name|version
argument_list|,
name|_bind
operator|->
name|received_version
argument_list|,
name|_bind
operator|->
name|subtype
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: NONCE"
argument_list|,
name|_bind
operator|->
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|_bind
operator|->
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Compound MAC"
argument_list|,
name|_bind
operator|->
name|compound_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|_bind
operator|->
name|compound_mac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|_bind
operator|->
name|version
operator|!=
name|EAP_FAST_VERSION
operator|||
name|_bind
operator|->
name|received_version
operator|!=
name|EAP_FAST_VERSION
operator|||
name|_bind
operator|->
name|subtype
operator|!=
name|EAP_TLV_CRYPTO_BINDING_SUBTYPE_REQUEST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Invalid version/subtype in "
literal|"Crypto-Binding TLV: Version %d "
literal|"Received Version %d SubType %d"
argument_list|,
name|_bind
operator|->
name|version
argument_list|,
name|_bind
operator|->
name|received_version
argument_list|,
name|_bind
operator|->
name|subtype
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_write_crypto_binding
parameter_list|(
name|struct
name|eap_tlv_crypto_binding_tlv
modifier|*
name|rbind
parameter_list|,
name|struct
name|eap_tlv_crypto_binding_tlv
modifier|*
name|_bind
parameter_list|,
specifier|const
name|u8
modifier|*
name|cmk
parameter_list|)
block|{
name|rbind
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_TYPE_MANDATORY
operator||
name|EAP_TLV_CRYPTO_BINDING_TLV
argument_list|)
expr_stmt|;
name|rbind
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|rbind
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_hdr
argument_list|)
argument_list|)
expr_stmt|;
name|rbind
operator|->
name|version
operator|=
name|EAP_FAST_VERSION
expr_stmt|;
name|rbind
operator|->
name|received_version
operator|=
name|_bind
operator|->
name|version
expr_stmt|;
name|rbind
operator|->
name|subtype
operator|=
name|EAP_TLV_CRYPTO_BINDING_SUBTYPE_RESPONSE
expr_stmt|;
name|os_memcpy
argument_list|(
name|rbind
operator|->
name|nonce
argument_list|,
name|_bind
operator|->
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|_bind
operator|->
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|inc_byte_array
argument_list|(
name|rbind
operator|->
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|rbind
operator|->
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|hmac_sha1
argument_list|(
name|cmk
argument_list|,
name|EAP_FAST_CMK_LEN
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|rbind
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rbind
argument_list|)
argument_list|,
name|rbind
operator|->
name|compound_mac
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Reply Crypto-Binding TLV: Version %d "
literal|"Received Version %d SubType %d"
argument_list|,
name|rbind
operator|->
name|version
argument_list|,
name|rbind
operator|->
name|received_version
argument_list|,
name|rbind
operator|->
name|subtype
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: NONCE"
argument_list|,
name|rbind
operator|->
name|nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|rbind
operator|->
name|nonce
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Compound MAC"
argument_list|,
name|rbind
operator|->
name|compound_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|rbind
operator|->
name|compound_mac
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_get_phase2_key
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|u8
modifier|*
name|isk
parameter_list|,
name|size_t
name|isk_len
parameter_list|)
block|{
name|u8
modifier|*
name|key
decl_stmt|;
name|size_t
name|key_len
decl_stmt|;
name|os_memset
argument_list|(
name|isk
argument_list|,
literal|0
argument_list|,
name|isk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|phase2_method
operator|==
name|NULL
operator|||
name|data
operator|->
name|phase2_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Phase 2 method not "
literal|"available"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|data
operator|->
name|phase2_method
operator|->
name|isKeyAvailable
operator|==
name|NULL
operator|||
name|data
operator|->
name|phase2_method
operator|->
name|getKey
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|data
operator|->
name|phase2_method
operator|->
name|isKeyAvailable
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|phase2_priv
argument_list|)
operator|||
operator|(
name|key
operator|=
name|data
operator|->
name|phase2_method
operator|->
name|getKey
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|phase2_priv
argument_list|,
operator|&
name|key_len
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Could not get key material "
literal|"from Phase 2"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|key_len
operator|>
name|isk_len
condition|)
name|key_len
operator|=
name|isk_len
expr_stmt|;
if|if
condition|(
name|key_len
operator|==
literal|32
operator|&&
name|data
operator|->
name|phase2_method
operator|->
name|vendor
operator|==
name|EAP_VENDOR_IETF
operator|&&
name|data
operator|->
name|phase2_method
operator|->
name|method
operator|==
name|EAP_TYPE_MSCHAPV2
condition|)
block|{
comment|/* 		 * EAP-FAST uses reverse order for MS-MPPE keys when deriving 		 * MSK from EAP-MSCHAPv2. Swap the keys here to get the correct 		 * ISK for EAP-FAST cryptobinding. 		 */
name|os_memcpy
argument_list|(
name|isk
argument_list|,
name|key
operator|+
literal|16
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|isk
operator|+
literal|16
argument_list|,
name|key
argument_list|,
literal|16
argument_list|)
expr_stmt|;
block|}
else|else
name|os_memcpy
argument_list|(
name|isk
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_get_cmk
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|u8
modifier|*
name|cmk
parameter_list|)
block|{
name|u8
name|isk
index|[
literal|32
index|]
decl_stmt|,
name|imck
index|[
literal|60
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Determining CMK[%d] for Compound MIC "
literal|"calculation"
argument_list|,
name|data
operator|->
name|simck_idx
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* 	 * RFC 4851, Section 5.2: 	 * IMCK[j] = T-PRF(S-IMCK[j-1], "Inner Methods Compound Keys", 	 *                 MSK[j], 60) 	 * S-IMCK[j] = first 40 octets of IMCK[j] 	 * CMK[j] = last 20 octets of IMCK[j] 	 */
if|if
condition|(
name|eap_fast_get_phase2_key
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|isk
argument_list|,
sizeof|sizeof
argument_list|(
name|isk
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: ISK[j]"
argument_list|,
name|isk
argument_list|,
sizeof|sizeof
argument_list|(
name|isk
argument_list|)
argument_list|)
expr_stmt|;
name|sha1_t_prf
argument_list|(
name|data
operator|->
name|simck
argument_list|,
name|EAP_FAST_SIMCK_LEN
argument_list|,
literal|"Inner Methods Compound Keys"
argument_list|,
name|isk
argument_list|,
sizeof|sizeof
argument_list|(
name|isk
argument_list|)
argument_list|,
name|imck
argument_list|,
sizeof|sizeof
argument_list|(
name|imck
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|simck_idx
operator|++
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|simck
argument_list|,
name|imck
argument_list|,
name|EAP_FAST_SIMCK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: S-IMCK[j]"
argument_list|,
name|data
operator|->
name|simck
argument_list|,
name|EAP_FAST_SIMCK_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|cmk
argument_list|,
name|imck
operator|+
name|EAP_FAST_SIMCK_LEN
argument_list|,
name|EAP_FAST_CMK_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: CMK[j]"
argument_list|,
name|cmk
argument_list|,
name|EAP_FAST_CMK_LEN
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_write_pac_request
parameter_list|(
name|u8
modifier|*
name|pos
parameter_list|,
name|u16
name|pac_type
parameter_list|)
block|{
name|struct
name|eap_tlv_hdr
modifier|*
name|pac
decl_stmt|;
name|struct
name|eap_tlv_request_action_tlv
modifier|*
name|act
decl_stmt|;
name|struct
name|eap_tlv_pac_type_tlv
modifier|*
name|type
decl_stmt|;
name|act
operator|=
operator|(
expr|struct
name|eap_tlv_request_action_tlv
operator|*
operator|)
name|pos
expr_stmt|;
name|act
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_REQUEST_ACTION_TLV
argument_list|)
expr_stmt|;
name|act
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|act
operator|->
name|action
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_ACTION_PROCESS_TLV
argument_list|)
expr_stmt|;
name|pac
operator|=
operator|(
expr|struct
name|eap_tlv_hdr
operator|*
operator|)
operator|(
name|act
operator|+
literal|1
operator|)
expr_stmt|;
name|pac
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|EAP_TLV_PAC_TLV
argument_list|)
expr_stmt|;
name|pac
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|type
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
operator|(
expr|struct
name|eap_tlv_pac_type_tlv
operator|*
operator|)
operator|(
name|pac
operator|+
literal|1
operator|)
expr_stmt|;
name|type
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|PAC_TYPE_PAC_TYPE
argument_list|)
expr_stmt|;
name|type
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|type
operator|->
name|pac_type
operator|=
name|host_to_be16
argument_list|(
name|pac_type
argument_list|)
expr_stmt|;
return|return
operator|(
name|u8
operator|*
operator|)
operator|(
name|type
operator|+
literal|1
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_fast_process_crypto_binding
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
name|struct
name|eap_tlv_crypto_binding_tlv
modifier|*
name|_bind
parameter_list|,
name|size_t
name|bind_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|u8
name|cmk
index|[
name|EAP_FAST_CMK_LEN
index|]
decl_stmt|,
name|cmac
index|[
name|SHA1_MAC_LEN
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|eap_fast_validate_crypto_binding
argument_list|(
name|_bind
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|eap_fast_get_cmk
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|cmk
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
comment|/* Validate received Compound MAC */
name|os_memcpy
argument_list|(
name|cmac
argument_list|,
name|_bind
operator|->
name|compound_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|_bind
operator|->
name|compound_mac
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Crypto-Binding TLV for Compound "
literal|"MAC calculation"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|_bind
argument_list|,
name|bind_len
argument_list|)
expr_stmt|;
name|hmac_sha1
argument_list|(
name|cmk
argument_list|,
name|EAP_FAST_CMK_LEN
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|_bind
argument_list|,
name|bind_len
argument_list|,
name|_bind
operator|->
name|compound_mac
argument_list|)
expr_stmt|;
name|res
operator|=
name|os_memcmp
argument_list|(
name|cmac
argument_list|,
name|_bind
operator|->
name|compound_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Received Compound MAC"
argument_list|,
name|cmac
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Calculated Compound MAC"
argument_list|,
name|_bind
operator|->
name|compound_mac
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Compound MAC did not match"
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|_bind
operator|->
name|compound_mac
argument_list|,
name|cmac
argument_list|,
sizeof|sizeof
argument_list|(
name|cmac
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* 	 * Compound MAC was valid, so authentication succeeded. Reply with 	 * crypto binding to allow server to complete authentication. 	 */
name|len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_crypto_binding_tlv
argument_list|)
expr_stmt|;
name|resp
operator|=
name|wpabuf_alloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|data
operator|->
name|anon_provisioning
operator|&&
name|data
operator|->
name|phase2_success
operator|&&
name|eap_fast_derive_msk
argument_list|(
name|data
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to generate MSK"
argument_list|)
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|data
operator|->
name|phase2_success
operator|=
literal|0
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_crypto_binding_tlv
argument_list|)
argument_list|)
expr_stmt|;
name|eap_fast_write_crypto_binding
argument_list|(
operator|(
expr|struct
name|eap_tlv_crypto_binding_tlv
operator|*
operator|)
name|pos
argument_list|,
name|_bind
argument_list|,
name|cmk
argument_list|)
expr_stmt|;
return|return
name|resp
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_parse_pac_tlv
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|entry
parameter_list|,
name|int
name|type
parameter_list|,
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
modifier|*
name|pac_key_found
parameter_list|)
block|{
switch|switch
condition|(
name|type
operator|&
literal|0x7fff
condition|)
block|{
case|case
name|PAC_TYPE_PAC_KEY
case|:
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Key"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|EAP_FAST_PAC_KEY_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Invalid PAC-Key "
literal|"length %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
operator|*
name|pac_key_found
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|entry
operator|->
name|pac_key
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PAC_TYPE_PAC_OPAQUE
case|:
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Opaque"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|entry
operator|->
name|pac_opaque
operator|=
name|pos
expr_stmt|;
name|entry
operator|->
name|pac_opaque_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|PAC_TYPE_PAC_INFO
case|:
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|entry
operator|->
name|pac_info
operator|=
name|pos
expr_stmt|;
name|entry
operator|->
name|pac_info_len
operator|=
name|len
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Ignored unknown PAC type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_process_pac_tlv
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|entry
parameter_list|,
name|u8
modifier|*
name|pac
parameter_list|,
name|size_t
name|pac_len
parameter_list|)
block|{
name|struct
name|pac_tlv_hdr
modifier|*
name|hdr
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|;
name|int
name|type
decl_stmt|,
name|pac_key_found
init|=
literal|0
decl_stmt|;
name|pos
operator|=
name|pac
expr_stmt|;
name|left
operator|=
name|pac_len
expr_stmt|;
while|while
condition|(
name|left
operator|>
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|hdr
operator|=
operator|(
expr|struct
name|pac_tlv_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|type
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|type
argument_list|)
expr_stmt|;
name|len
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|len
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|left
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC TLV overrun "
literal|"(type=%d len=%lu left=%lu)"
argument_list|,
name|type
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eap_fast_parse_pac_tlv
argument_list|(
name|entry
argument_list|,
name|type
argument_list|,
name|pos
argument_list|,
name|len
argument_list|,
operator|&
name|pac_key_found
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|len
expr_stmt|;
name|left
operator|-=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pac_key_found
operator|||
operator|!
name|entry
operator|->
name|pac_opaque
operator|||
operator|!
name|entry
operator|->
name|pac_info
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC TLV does not include "
literal|"all the required fields"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_parse_pac_info
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|entry
parameter_list|,
name|int
name|type
parameter_list|,
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u16
name|pac_type
decl_stmt|;
name|u32
name|lifetime
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
switch|switch
condition|(
name|type
operator|&
literal|0x7fff
condition|)
block|{
case|case
name|PAC_TYPE_CRED_LIFETIME
case|:
if|if
condition|(
name|len
operator|!=
literal|4
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info - "
literal|"Invalid CRED_LIFETIME length - ignored"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 		 * This is not currently saved separately in PAC files since 		 * the server can automatically initiate PAC update when 		 * needed. Anyway, the information is available from PAC-Info 		 * dump if it is needed for something in the future. 		 */
name|lifetime
operator|=
name|WPA_GET_BE32
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info - CRED_LIFETIME %d "
literal|"(%d days)"
argument_list|,
name|lifetime
argument_list|,
operator|(
name|lifetime
operator|-
operator|(
name|u32
operator|)
name|now
operator|.
name|sec
operator|)
operator|/
literal|86400
argument_list|)
expr_stmt|;
break|break;
case|case
name|PAC_TYPE_A_ID
case|:
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info - A-ID"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|entry
operator|->
name|a_id
operator|=
name|pos
expr_stmt|;
name|entry
operator|->
name|a_id_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|PAC_TYPE_I_ID
case|:
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info - I-ID"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|entry
operator|->
name|i_id
operator|=
name|pos
expr_stmt|;
name|entry
operator|->
name|i_id_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|PAC_TYPE_A_ID_INFO
case|:
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info - A-ID-Info"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|entry
operator|->
name|a_id_info
operator|=
name|pos
expr_stmt|;
name|entry
operator|->
name|a_id_info_len
operator|=
name|len
expr_stmt|;
break|break;
case|case
name|PAC_TYPE_PAC_TYPE
case|:
comment|/* 		 * draft-cam-winget-eap-fast-provisioning-04.txt, 		 * Section 4.2.6 - PAC-Type TLV 		 */
if|if
condition|(
name|len
operator|!=
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Invalid PAC-Type "
literal|"length %lu (expected 2)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info - PAC-Type"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pac_type
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac_type
operator|!=
name|PAC_TYPE_TUNNEL_PAC
operator|&&
name|pac_type
operator|!=
name|PAC_TYPE_USER_AUTHORIZATION
operator|&&
name|pac_type
operator|!=
name|PAC_TYPE_MACHINE_AUTHENTICATION
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Unsupported PAC Type "
literal|"%d"
argument_list|,
name|pac_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info - PAC-Type %d"
argument_list|,
name|pac_type
argument_list|)
expr_stmt|;
name|entry
operator|->
name|pac_type
operator|=
name|pac_type
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Ignored unknown PAC-Info "
literal|"type %d"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_process_pac_info
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|entry
parameter_list|)
block|{
name|struct
name|pac_tlv_hdr
modifier|*
name|hdr
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|;
name|int
name|type
decl_stmt|;
comment|/* draft-cam-winget-eap-fast-provisioning-04.txt, Section 4.2.4 */
comment|/* PAC-Type defaults to Tunnel PAC (Type 1) */
name|entry
operator|->
name|pac_type
operator|=
name|PAC_TYPE_TUNNEL_PAC
expr_stmt|;
name|pos
operator|=
name|entry
operator|->
name|pac_info
expr_stmt|;
name|left
operator|=
name|entry
operator|->
name|pac_info_len
expr_stmt|;
while|while
condition|(
name|left
operator|>
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|hdr
operator|=
operator|(
expr|struct
name|pac_tlv_hdr
operator|*
operator|)
name|pos
expr_stmt|;
name|type
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|type
argument_list|)
expr_stmt|;
name|len
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|len
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|left
operator|-=
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info overrun "
literal|"(type=%d len=%lu left=%lu)"
argument_list|,
name|type
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|eap_fast_parse_pac_info
argument_list|(
name|entry
argument_list|,
name|type
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|len
expr_stmt|;
name|left
operator|-=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|entry
operator|->
name|a_id
operator|==
name|NULL
operator|||
name|entry
operator|->
name|a_id_info
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC-Info does not include "
literal|"all the required fields"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_fast_process_pac
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
name|u8
modifier|*
name|pac
parameter_list|,
name|size_t
name|pac_len
parameter_list|)
block|{
name|struct
name|eap_peer_config
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|struct
name|eap_fast_pac
name|entry
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|entry
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|entry
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_fast_process_pac_tlv
argument_list|(
operator|&
name|entry
argument_list|,
name|pac
argument_list|,
name|pac_len
argument_list|)
operator|||
name|eap_fast_process_pac_info
argument_list|(
operator|&
name|entry
argument_list|)
condition|)
return|return
name|NULL
return|;
name|eap_fast_add_pac
argument_list|(
operator|&
name|data
operator|->
name|pac
argument_list|,
operator|&
name|data
operator|->
name|current_pac
argument_list|,
operator|&
name|entry
argument_list|)
expr_stmt|;
name|eap_fast_pac_list_truncate
argument_list|(
name|data
operator|->
name|pac
argument_list|,
name|data
operator|->
name|max_pac_list_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|use_pac_binary_format
condition|)
name|eap_fast_save_pac_bin
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|pac
argument_list|,
name|config
operator|->
name|pac_file
argument_list|)
expr_stmt|;
else|else
name|eap_fast_save_pac
argument_list|(
name|sm
argument_list|,
name|data
operator|->
name|pac
argument_list|,
name|config
operator|->
name|pac_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|provisioning
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|anon_provisioning
condition|)
block|{
comment|/* 			 * Unauthenticated provisioning does not provide keying 			 * material and must end with an EAP-Failure. 			 * Authentication will be done separately after this. 			 */
name|data
operator|->
name|success
operator|=
literal|0
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * Server may or may not allow authenticated 			 * provisioning also for key generation. 			 */
name|ret
operator|->
name|decision
operator|=
name|DECISION_COND_SUCC
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Send PAC-Acknowledgement TLV "
literal|"- Provisioning completed successfully"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * This is PAC refreshing, i.e., normal authentication that is 		 * expected to be completed with an EAP-Success. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Send PAC-Acknowledgement TLV "
literal|"- PAC refreshing completed successfully"
argument_list|)
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_UNCOND_SUCC
expr_stmt|;
block|}
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
return|return
name|eap_fast_tlv_pac_ack
argument_list|()
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_parse_decrypted
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|decrypted
parameter_list|,
name|struct
name|eap_fast_tlv_parse
modifier|*
name|tlv
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|resp
parameter_list|)
block|{
name|int
name|mandatory
decl_stmt|,
name|tlv_type
decl_stmt|,
name|len
decl_stmt|,
name|res
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|os_memset
argument_list|(
name|tlv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tlv
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Parse TLVs from the decrypted Phase 2 data */
name|pos
operator|=
name|wpabuf_mhead
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|4
operator|<
name|end
condition|)
block|{
name|mandatory
operator|=
name|pos
index|[
literal|0
index|]
operator|&
literal|0x80
expr_stmt|;
name|tlv_type
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
operator|&
literal|0x3fff
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: TLV overflow"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Received Phase 2: "
literal|"TLV type %d length %d%s"
argument_list|,
name|tlv_type
argument_list|,
name|len
argument_list|,
name|mandatory
condition|?
literal|" (mandatory)"
else|:
literal|""
argument_list|)
expr_stmt|;
name|res
operator|=
name|eap_fast_parse_tlv
argument_list|(
name|tlv
argument_list|,
name|tlv_type
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
operator|-
literal|2
condition|)
break|break;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|mandatory
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Nak unknown "
literal|"mandatory TLV type %d"
argument_list|,
name|tlv_type
argument_list|)
expr_stmt|;
operator|*
name|resp
operator|=
name|eap_fast_tlv_nak
argument_list|(
literal|0
argument_list|,
name|tlv_type
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: ignored "
literal|"unknown optional TLV type %d"
argument_list|,
name|tlv_type
argument_list|)
expr_stmt|;
block|}
block|}
name|pos
operator|+=
name|len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_encrypt_response
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|identifier
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|out_data
parameter_list|)
block|{
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Encrypting Phase 2 data"
argument_list|,
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_peer_tls_encrypt
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|EAP_TYPE_FAST
argument_list|,
name|data
operator|->
name|fast_version
argument_list|,
name|identifier
argument_list|,
name|resp
argument_list|,
name|out_data
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to encrypt a Phase 2 "
literal|"frame"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_fast_pac_request
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|tmp
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|tmp
operator|=
name|wpabuf_alloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_hdr
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_request_action_tlv
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|eap_tlv_pac_type_tlv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|wpabuf_put
argument_list|(
name|tmp
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pos2
operator|=
name|eap_fast_write_pac_request
argument_list|(
name|pos
argument_list|,
name|PAC_TYPE_TUNNEL_PAC
argument_list|)
expr_stmt|;
name|wpabuf_put
argument_list|(
name|tmp
argument_list|,
name|pos2
operator|-
name|pos
argument_list|)
expr_stmt|;
return|return
name|tmp
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_process_decrypted
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|decrypted
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|out_data
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|resp
init|=
name|NULL
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|struct
name|eap_fast_tlv_parse
name|tlv
decl_stmt|;
name|int
name|failed
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|eap_fast_parse_decrypted
argument_list|(
name|decrypted
argument_list|,
operator|&
name|tlv
argument_list|,
operator|&
name|resp
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|resp
condition|)
return|return
name|eap_fast_encrypt_response
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|resp
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|out_data
argument_list|)
return|;
if|if
condition|(
name|tlv
operator|.
name|result
operator|==
name|EAP_TLV_RESULT_FAILURE
condition|)
block|{
name|resp
operator|=
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|eap_fast_encrypt_response
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|resp
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|out_data
argument_list|)
return|;
block|}
if|if
condition|(
name|tlv
operator|.
name|iresult
operator|==
name|EAP_TLV_RESULT_FAILURE
condition|)
block|{
name|resp
operator|=
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|eap_fast_encrypt_response
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|resp
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|out_data
argument_list|)
return|;
block|}
if|if
condition|(
name|tlv
operator|.
name|crypto_binding
condition|)
block|{
name|tmp
operator|=
name|eap_fast_process_crypto_binding
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|tlv
operator|.
name|crypto_binding
argument_list|,
name|tlv
operator|.
name|crypto_binding_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
name|failed
operator|=
literal|1
expr_stmt|;
else|else
name|resp
operator|=
name|wpabuf_concat
argument_list|(
name|resp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tlv
operator|.
name|iresult
operator|==
name|EAP_TLV_RESULT_SUCCESS
condition|)
block|{
name|tmp
operator|=
name|eap_fast_tlv_result
argument_list|(
name|failed
condition|?
name|EAP_TLV_RESULT_FAILURE
else|:
name|EAP_TLV_RESULT_SUCCESS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|resp
operator|=
name|wpabuf_concat
argument_list|(
name|resp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tlv
operator|.
name|eap_payload_tlv
condition|)
block|{
name|tmp
operator|=
name|eap_fast_process_eap_payload_tlv
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|req
argument_list|,
name|tlv
operator|.
name|eap_payload_tlv
argument_list|,
name|tlv
operator|.
name|eap_payload_tlv_len
argument_list|)
expr_stmt|;
name|resp
operator|=
name|wpabuf_concat
argument_list|(
name|resp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tlv
operator|.
name|pac
operator|&&
name|tlv
operator|.
name|result
operator|!=
name|EAP_TLV_RESULT_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC TLV without Result TLV "
literal|"acknowledging success"
argument_list|)
expr_stmt|;
name|failed
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|tlv
operator|.
name|pac
operator|&&
name|tlv
operator|.
name|result
operator|==
name|EAP_TLV_RESULT_SUCCESS
condition|)
block|{
name|tmp
operator|=
name|eap_fast_process_pac
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|tlv
operator|.
name|pac
argument_list|,
name|tlv
operator|.
name|pac_len
argument_list|)
expr_stmt|;
name|resp
operator|=
name|wpabuf_concat
argument_list|(
name|resp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|current_pac
operator|==
name|NULL
operator|&&
name|data
operator|->
name|provisioning
operator|&&
operator|!
name|data
operator|->
name|anon_provisioning
operator|&&
operator|!
name|tlv
operator|.
name|pac
operator|&&
operator|(
name|tlv
operator|.
name|iresult
operator|==
name|EAP_TLV_RESULT_SUCCESS
operator|||
name|tlv
operator|.
name|result
operator|==
name|EAP_TLV_RESULT_SUCCESS
operator|)
condition|)
block|{
comment|/* 		 * Need to request Tunnel PAC when using authenticated 		 * provisioning. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Request Tunnel PAC"
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|eap_fast_pac_request
argument_list|()
expr_stmt|;
name|resp
operator|=
name|wpabuf_concat
argument_list|(
name|resp
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tlv
operator|.
name|result
operator|==
name|EAP_TLV_RESULT_SUCCESS
operator|&&
operator|!
name|failed
condition|)
block|{
name|tmp
operator|=
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_SUCCESS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|resp
operator|=
name|wpabuf_concat
argument_list|(
name|tmp
argument_list|,
name|resp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|failed
condition|)
block|{
name|tmp
operator|=
name|eap_fast_tlv_result
argument_list|(
name|EAP_TLV_RESULT_FAILURE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|resp
operator|=
name|wpabuf_concat
argument_list|(
name|tmp
argument_list|,
name|resp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|resp
operator|&&
name|tlv
operator|.
name|result
operator|==
name|EAP_TLV_RESULT_SUCCESS
operator|&&
operator|!
name|failed
operator|&&
name|tlv
operator|.
name|crypto_binding
operator|&&
name|data
operator|->
name|phase2_success
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|anon_provisioning
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Unauthenticated "
literal|"provisioning completed successfully."
argument_list|)
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Authentication "
literal|"completed successfully."
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|provisioning
condition|)
name|ret
operator|->
name|methodState
operator|=
name|METHOD_MAY_CONT
expr_stmt|;
else|else
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_UNCOND_SUCC
expr_stmt|;
block|}
block|}
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: No recognized TLVs - send "
literal|"empty response packet"
argument_list|)
expr_stmt|;
name|resp
operator|=
name|wpabuf_alloc
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
return|return
name|eap_fast_encrypt_response
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|resp
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|out_data
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_decrypt
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|in_data
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|out_data
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|in_decrypted
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Received %lu bytes encrypted data for"
literal|" Phase 2"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|pending_phase2_req
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Pending Phase 2 request - "
literal|"skip decryption and use old data"
argument_list|)
expr_stmt|;
comment|/* Clear TLS reassembly state. */
name|eap_peer_tls_reset_input
argument_list|(
operator|&
name|data
operator|->
name|ssl
argument_list|)
expr_stmt|;
name|in_decrypted
operator|=
name|data
operator|->
name|pending_phase2_req
expr_stmt|;
name|data
operator|->
name|pending_phase2_req
operator|=
name|NULL
expr_stmt|;
goto|goto
name|continue_req
goto|;
block|}
if|if
condition|(
name|wpabuf_len
argument_list|(
name|in_data
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Received TLS ACK - requesting more fragments */
return|return
name|eap_peer_tls_encrypt
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|EAP_TYPE_FAST
argument_list|,
name|data
operator|->
name|fast_version
argument_list|,
name|req
operator|->
name|identifier
argument_list|,
name|NULL
argument_list|,
name|out_data
argument_list|)
return|;
block|}
name|res
operator|=
name|eap_peer_tls_decrypt
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|in_data
argument_list|,
operator|&
name|in_decrypted
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
name|continue_req
label|:
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: Decrypted Phase 2 TLV(s)"
argument_list|,
name|in_decrypted
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|in_decrypted
argument_list|)
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Too short Phase 2 "
literal|"TLV frame (len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|wpabuf_len
argument_list|(
name|in_decrypted
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res
operator|=
name|eap_fast_process_decrypted
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|req
argument_list|,
name|in_decrypted
argument_list|,
name|out_data
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|in_decrypted
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|eap_fast_get_a_id
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|size_t
modifier|*
name|id_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|a_id
decl_stmt|;
name|struct
name|pac_tlv_hdr
modifier|*
name|hdr
decl_stmt|;
comment|/* 	 * Parse authority identity (A-ID) from the EAP-FAST/Start. This 	 * supports both raw A-ID and one inside an A-ID TLV. 	 */
name|a_id
operator|=
name|buf
expr_stmt|;
operator|*
name|id_len
operator|=
name|len
expr_stmt|;
if|if
condition|(
name|len
operator|>
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
condition|)
block|{
name|int
name|tlen
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|pac_tlv_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|tlen
operator|=
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|be_to_host16
argument_list|(
name|hdr
operator|->
name|type
argument_list|)
operator|==
name|PAC_TYPE_A_ID
operator|&&
sizeof|sizeof
argument_list|(
operator|*
name|hdr
argument_list|)
operator|+
name|tlen
operator|<=
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: A-ID was in TLV "
literal|"(Start)"
argument_list|)
expr_stmt|;
name|a_id
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
operator|*
name|id_len
operator|=
name|tlen
expr_stmt|;
block|}
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: A-ID"
argument_list|,
name|a_id
argument_list|,
operator|*
name|id_len
argument_list|)
expr_stmt|;
return|return
name|a_id
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_select_pac
parameter_list|(
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|a_id
parameter_list|,
name|size_t
name|a_id_len
parameter_list|)
block|{
name|data
operator|->
name|current_pac
operator|=
name|eap_fast_get_pac
argument_list|(
name|data
operator|->
name|pac
argument_list|,
name|a_id
argument_list|,
name|a_id_len
argument_list|,
name|PAC_TYPE_TUNNEL_PAC
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|current_pac
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * Tunnel PAC was not available for this A-ID. Try to use 		 * Machine Authentication PAC, if one is available. 		 */
name|data
operator|->
name|current_pac
operator|=
name|eap_fast_get_pac
argument_list|(
name|data
operator|->
name|pac
argument_list|,
name|a_id
argument_list|,
name|a_id_len
argument_list|,
name|PAC_TYPE_MACHINE_AUTHENTICATION
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|current_pac
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: PAC found for this A-ID "
literal|"(PAC-Type %d)"
argument_list|,
name|data
operator|->
name|current_pac
operator|->
name|pac_type
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"EAP-FAST: A-ID-Info"
argument_list|,
name|data
operator|->
name|current_pac
operator|->
name|a_id_info
argument_list|,
name|data
operator|->
name|current_pac
operator|->
name|a_id_info_len
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_use_pac_opaque
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|)
block|{
name|u8
modifier|*
name|tlv
decl_stmt|;
name|size_t
name|tlv_len
decl_stmt|,
name|olen
decl_stmt|;
name|struct
name|eap_tlv_hdr
modifier|*
name|ehdr
decl_stmt|;
name|olen
operator|=
name|pac
operator|->
name|pac_opaque_len
expr_stmt|;
name|tlv_len
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ehdr
argument_list|)
operator|+
name|olen
expr_stmt|;
name|tlv
operator|=
name|os_malloc
argument_list|(
name|tlv_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlv
condition|)
block|{
name|ehdr
operator|=
operator|(
expr|struct
name|eap_tlv_hdr
operator|*
operator|)
name|tlv
expr_stmt|;
name|ehdr
operator|->
name|tlv_type
operator|=
name|host_to_be16
argument_list|(
name|PAC_TYPE_PAC_OPAQUE
argument_list|)
expr_stmt|;
name|ehdr
operator|->
name|length
operator|=
name|host_to_be16
argument_list|(
name|olen
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ehdr
operator|+
literal|1
argument_list|,
name|pac
operator|->
name|pac_opaque
argument_list|,
name|olen
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tlv
operator|==
name|NULL
operator|||
name|tls_connection_client_hello_ext
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|TLS_EXT_PAC_OPAQUE
argument_list|,
name|tlv
argument_list|,
name|tlv_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to add PAC-Opaque TLS "
literal|"extension"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tlv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|tlv
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_clear_pac_opaque_ext
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|tls_connection_client_hello_ext
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|TLS_EXT_PAC_OPAQUE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Failed to remove PAC-Opaque "
literal|"TLS extension"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_set_provisioning_ciphers
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|)
block|{
name|u8
name|ciphers
index|[
literal|5
index|]
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|provisioning_allowed
operator|&
name|EAP_FAST_PROV_UNAUTH
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Enabling unauthenticated "
literal|"provisioning TLS cipher suites"
argument_list|)
expr_stmt|;
name|ciphers
index|[
name|count
operator|++
index|]
operator|=
name|TLS_CIPHER_ANON_DH_AES128_SHA
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|provisioning_allowed
operator|&
name|EAP_FAST_PROV_AUTH
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Enabling authenticated "
literal|"provisioning TLS cipher suites"
argument_list|)
expr_stmt|;
name|ciphers
index|[
name|count
operator|++
index|]
operator|=
name|TLS_CIPHER_RSA_DHE_AES128_SHA
expr_stmt|;
name|ciphers
index|[
name|count
operator|++
index|]
operator|=
name|TLS_CIPHER_AES128_SHA
expr_stmt|;
name|ciphers
index|[
name|count
operator|++
index|]
operator|=
name|TLS_CIPHER_RC4_SHA
expr_stmt|;
block|}
name|ciphers
index|[
name|count
operator|++
index|]
operator|=
name|TLS_CIPHER_NONE
expr_stmt|;
if|if
condition|(
name|tls_connection_set_cipher_list
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|ciphers
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Could not configure TLS "
literal|"cipher suites for provisioning"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_process_start
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_data
modifier|*
name|data
parameter_list|,
name|u8
name|flags
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|left
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|a_id
decl_stmt|;
name|size_t
name|a_id_len
decl_stmt|;
comment|/* EAP-FAST Version negotiation (section 3.1) */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Start (server ver=%d, own ver=%d)"
argument_list|,
name|flags
operator|&
name|EAP_PEAP_VERSION_MASK
argument_list|,
name|data
operator|->
name|fast_version
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|EAP_PEAP_VERSION_MASK
operator|)
operator|<
name|data
operator|->
name|fast_version
condition|)
name|data
operator|->
name|fast_version
operator|=
name|flags
operator|&
name|EAP_PEAP_VERSION_MASK
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Using FAST version %d"
argument_list|,
name|data
operator|->
name|fast_version
argument_list|)
expr_stmt|;
name|a_id
operator|=
name|eap_fast_get_a_id
argument_list|(
name|pos
argument_list|,
name|left
argument_list|,
operator|&
name|a_id_len
argument_list|)
expr_stmt|;
name|eap_fast_select_pac
argument_list|(
name|data
argument_list|,
name|a_id
argument_list|,
name|a_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|resuming
operator|&&
name|data
operator|->
name|current_pac
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Trying to resume session - "
literal|"do not add PAC-Opaque to TLS ClientHello"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_fast_clear_pac_opaque_ext
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|current_pac
condition|)
block|{
comment|/* 		 * PAC found for the A-ID and we are not resuming an old 		 * session, so add PAC-Opaque extension to ClientHello. 		 */
if|if
condition|(
name|eap_fast_use_pac_opaque
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|data
operator|->
name|current_pac
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
comment|/* No PAC found, so we must provision one. */
if|if
condition|(
operator|!
name|data
operator|->
name|provisioning_allowed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: No PAC found and "
literal|"provisioning disabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: No PAC found - "
literal|"starting provisioning"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_fast_set_provisioning_ciphers
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
operator|<
literal|0
operator|||
name|eap_fast_clear_pac_opaque_ext
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|data
operator|->
name|provisioning
operator|=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_fast_process
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|)
block|{
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
decl_stmt|;
name|size_t
name|left
decl_stmt|;
name|int
name|res
decl_stmt|;
name|u8
name|flags
decl_stmt|,
name|id
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|pos
operator|=
name|eap_peer_tls_process_init
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|EAP_TYPE_FAST
argument_list|,
name|ret
argument_list|,
name|reqData
argument_list|,
operator|&
name|left
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|req
operator|=
name|wpabuf_head
argument_list|(
name|reqData
argument_list|)
expr_stmt|;
name|id
operator|=
name|req
operator|->
name|identifier
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|EAP_TLS_FLAGS_START
condition|)
block|{
if|if
condition|(
name|eap_fast_process_start
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|flags
argument_list|,
name|pos
argument_list|,
name|left
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|left
operator|=
literal|0
expr_stmt|;
comment|/* A-ID is not used in further packet processing */
block|}
name|resp
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|tls_connection_established
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|)
operator|&&
operator|!
name|data
operator|->
name|resuming
condition|)
block|{
comment|/* Process tunneled (encrypted) phase 2 data. */
name|struct
name|wpabuf
name|msg
decl_stmt|;
name|wpabuf_set
argument_list|(
operator|&
name|msg
argument_list|,
name|pos
argument_list|,
name|left
argument_list|)
expr_stmt|;
name|res
operator|=
name|eap_fast_decrypt
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|req
argument_list|,
operator|&
name|msg
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
comment|/* 			 * Ack possible Alert that may have caused failure in 			 * decryption. 			 */
name|res
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* Continue processing TLS handshake (phase 1). */
name|res
operator|=
name|eap_peer_tls_process_helper
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|EAP_TYPE_FAST
argument_list|,
name|data
operator|->
name|fast_version
argument_list|,
name|id
argument_list|,
name|pos
argument_list|,
name|left
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_connection_established
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|)
condition|)
block|{
name|char
name|cipher
index|[
literal|80
index|]
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: TLS done, proceed to Phase 2"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|provisioning
operator|&&
operator|(
operator|!
operator|(
name|data
operator|->
name|provisioning_allowed
operator|&
name|EAP_FAST_PROV_AUTH
operator|)
operator|||
name|tls_get_cipher
argument_list|(
name|sm
operator|->
name|ssl_ctx
argument_list|,
name|data
operator|->
name|ssl
operator|.
name|conn
argument_list|,
name|cipher
argument_list|,
sizeof|sizeof
argument_list|(
name|cipher
argument_list|)
argument_list|)
operator|<
literal|0
operator|||
name|os_strstr
argument_list|(
name|cipher
argument_list|,
literal|"ADH-"
argument_list|)
operator|||
name|os_strstr
argument_list|(
name|cipher
argument_list|,
literal|"anon"
argument_list|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Using "
literal|"anonymous (unauthenticated) "
literal|"provisioning"
argument_list|)
expr_stmt|;
name|data
operator|->
name|anon_provisioning
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|data
operator|->
name|anon_provisioning
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|resuming
operator|=
literal|0
expr_stmt|;
name|eap_fast_derive_keys
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|==
literal|2
condition|)
block|{
name|struct
name|wpabuf
name|msg
decl_stmt|;
comment|/* 			 * Application data included in the handshake message. 			 */
name|wpabuf_free
argument_list|(
name|data
operator|->
name|pending_phase2_req
argument_list|)
expr_stmt|;
name|data
operator|->
name|pending_phase2_req
operator|=
name|resp
expr_stmt|;
name|resp
operator|=
name|NULL
expr_stmt|;
name|wpabuf_set
argument_list|(
operator|&
name|msg
argument_list|,
name|pos
argument_list|,
name|left
argument_list|)
expr_stmt|;
name|res
operator|=
name|eap_fast_decrypt
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|ret
argument_list|,
name|req
argument_list|,
operator|&
name|msg
argument_list|,
operator|&
name|resp
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|res
operator|==
literal|1
condition|)
block|{
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
name|eap_peer_tls_build_ack
argument_list|(
name|id
argument_list|,
name|EAP_TYPE_FAST
argument_list|,
name|data
operator|->
name|fast_version
argument_list|)
return|;
block|}
return|return
name|resp
return|;
block|}
end_function

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
comment|/* FIX */
end_comment

begin_endif
unit|static Boolean eap_fast_has_reauth_data(struct eap_sm *sm, void *priv) { 	struct eap_fast_data *data = priv; 	return tls_connection_established(sm->ssl_ctx, data->ssl.conn); }   static void eap_fast_deinit_for_reauth(struct eap_sm *sm, void *priv) { 	struct eap_fast_data *data = priv; 	os_free(data->key_block_p); 	data->key_block_p = NULL; 	wpabuf_free(data->pending_phase2_req); 	data->pending_phase2_req = NULL; }   static void * eap_fast_init_for_reauth(struct eap_sm *sm, void *priv) { 	struct eap_fast_data *data = priv; 	if (eap_peer_tls_reauth_init(sm,&data->ssl)) { 		os_free(data); 		return NULL; 	} 	if (data->phase2_priv&& data->phase2_method&& 	    data->phase2_method->init_for_reauth) 		data->phase2_method->init_for_reauth(sm, data->phase2_priv); 	data->phase2_success = 0; 	data->resuming = 1; 	data->provisioning = 0; 	data->anon_provisioning = 0; 	data->simck_idx = 0; 	return priv; }
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|int
name|eap_fast_get_status
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|,
name|int
name|verbose
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|int
name|len
decl_stmt|,
name|ret
decl_stmt|;
name|len
operator|=
name|eap_peer_tls_status
argument_list|(
name|sm
argument_list|,
operator|&
name|data
operator|->
name|ssl
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|,
name|verbose
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|phase2_method
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|buf
operator|+
name|len
argument_list|,
name|buflen
operator|-
name|len
argument_list|,
literal|"EAP-FAST Phase2 method=%s\n"
argument_list|,
name|data
operator|->
name|phase2_method
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|ret
operator|>=
name|buflen
operator|-
name|len
condition|)
return|return
name|len
return|;
name|len
operator|+=
name|ret
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_fast_isKeyAvailable
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|success
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_getKey
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
operator|!
name|data
operator|->
name|success
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|os_malloc
argument_list|(
name|EAP_FAST_KEY_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|len
operator|=
name|EAP_FAST_KEY_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|key_data
argument_list|,
name|EAP_FAST_KEY_LEN
argument_list|)
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_get_emsk
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_fast_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
operator|!
name|data
operator|->
name|success
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|os_malloc
argument_list|(
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|len
operator|=
name|EAP_EMSK_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|emsk
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
name|int
name|eap_peer_fast_register
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|eap_method
modifier|*
name|eap
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|eap
operator|=
name|eap_peer_method_alloc
argument_list|(
name|EAP_PEER_METHOD_INTERFACE_VERSION
argument_list|,
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_FAST
argument_list|,
literal|"FAST"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|eap
operator|->
name|init
operator|=
name|eap_fast_init
expr_stmt|;
name|eap
operator|->
name|deinit
operator|=
name|eap_fast_deinit
expr_stmt|;
name|eap
operator|->
name|process
operator|=
name|eap_fast_process
expr_stmt|;
name|eap
operator|->
name|isKeyAvailable
operator|=
name|eap_fast_isKeyAvailable
expr_stmt|;
name|eap
operator|->
name|getKey
operator|=
name|eap_fast_getKey
expr_stmt|;
name|eap
operator|->
name|get_status
operator|=
name|eap_fast_get_status
expr_stmt|;
if|#
directive|if
literal|0
block|eap->has_reauth_data = eap_fast_has_reauth_data; 	eap->deinit_for_reauth = eap_fast_deinit_for_reauth; 	eap->init_for_reauth = eap_fast_init_for_reauth;
endif|#
directive|endif
name|eap
operator|->
name|get_emsk
operator|=
name|eap_fast_get_emsk
expr_stmt|;
name|ret
operator|=
name|eap_peer_method_register
argument_list|(
name|eap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|eap_peer_method_free
argument_list|(
name|eap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * EAP peer method: EAP-FAST PAC file processing  * Copyright (c) 2004-2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eap_config.h"
end_include

begin_include
include|#
directive|include
file|"eap_i.h"
end_include

begin_include
include|#
directive|include
file|"eap_fast_pac.h"
end_include

begin_comment
comment|/* TODO: encrypt PAC-Key in the PAC file */
end_comment

begin_comment
comment|/* Text data format */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pac_file_hdr
init|=
literal|"wpa_supplicant EAP-FAST PAC file - version 1"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Binary data format  * 4-octet magic value: 6A E4 92 0C  * 2-octet version (big endian)  *<version specific data>  *  * version=0:  * Sequence of PAC entries:  *   2-octet PAC-Type (big endian)  *   32-octet PAC-Key  *   2-octet PAC-Opaque length (big endian)  *<variable len> PAC-Opaque data (length bytes)  *   2-octet PAC-Info length (big endian)  *<variable len> PAC-Info data (length bytes)  */
end_comment

begin_define
define|#
directive|define
name|EAP_FAST_PAC_BINARY_MAGIC
value|0x6ae4920c
end_define

begin_define
define|#
directive|define
name|EAP_FAST_PAC_BINARY_FORMAT_VERSION
value|0
end_define

begin_comment
comment|/**  * eap_fast_free_pac - Free PAC data  * @pac: Pointer to the PAC entry  *  * Note that the PAC entry must not be in a list since this function does not  * remove the list links.  */
end_comment

begin_function
name|void
name|eap_fast_free_pac
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|)
block|{
name|os_free
argument_list|(
name|pac
operator|->
name|pac_opaque
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pac
operator|->
name|pac_info
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pac
operator|->
name|a_id
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pac
operator|->
name|i_id
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pac
operator|->
name|a_id_info
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pac
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * eap_fast_get_pac - Get a PAC entry based on A-ID  * @pac_root: Pointer to root of the PAC list  * @a_id: A-ID to search for  * @a_id_len: Length of A-ID  * @pac_type: PAC-Type to search for  * Returns: Pointer to the PAC entry, or %NULL if A-ID not found  */
end_comment

begin_function
name|struct
name|eap_fast_pac
modifier|*
name|eap_fast_get_pac
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac_root
parameter_list|,
specifier|const
name|u8
modifier|*
name|a_id
parameter_list|,
name|size_t
name|a_id_len
parameter_list|,
name|u16
name|pac_type
parameter_list|)
block|{
name|struct
name|eap_fast_pac
modifier|*
name|pac
init|=
name|pac_root
decl_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
if|if
condition|(
name|pac
operator|->
name|pac_type
operator|==
name|pac_type
operator|&&
name|pac
operator|->
name|a_id_len
operator|==
name|a_id_len
operator|&&
name|os_memcmp
argument_list|(
name|pac
operator|->
name|a_id
argument_list|,
name|a_id
argument_list|,
name|a_id_len
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|pac
return|;
block|}
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_remove_pac
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
modifier|*
name|pac_root
parameter_list|,
name|struct
name|eap_fast_pac
modifier|*
modifier|*
name|pac_current
parameter_list|,
specifier|const
name|u8
modifier|*
name|a_id
parameter_list|,
name|size_t
name|a_id_len
parameter_list|,
name|u16
name|pac_type
parameter_list|)
block|{
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|pac
operator|=
operator|*
name|pac_root
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
if|if
condition|(
name|pac
operator|->
name|pac_type
operator|==
name|pac_type
operator|&&
name|pac
operator|->
name|a_id_len
operator|==
name|a_id_len
operator|&&
name|os_memcmp
argument_list|(
name|pac
operator|->
name|a_id
argument_list|,
name|a_id
argument_list|,
name|a_id_len
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|prev
operator|==
name|NULL
condition|)
operator|*
name|pac_root
operator|=
name|pac
operator|->
name|next
expr_stmt|;
else|else
name|prev
operator|->
name|next
operator|=
name|pac
operator|->
name|next
expr_stmt|;
if|if
condition|(
operator|*
name|pac_current
operator|==
name|pac
condition|)
operator|*
name|pac_current
operator|=
name|NULL
expr_stmt|;
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
break|break;
block|}
name|prev
operator|=
name|pac
expr_stmt|;
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_copy_buf
parameter_list|(
name|u8
modifier|*
modifier|*
name|dst
parameter_list|,
name|size_t
modifier|*
name|dst_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
name|size_t
name|src_len
parameter_list|)
block|{
if|if
condition|(
name|src
condition|)
block|{
operator|*
name|dst
operator|=
name|os_malloc
argument_list|(
name|src_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|dst
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
operator|*
name|dst
argument_list|,
name|src
argument_list|,
name|src_len
argument_list|)
expr_stmt|;
operator|*
name|dst_len
operator|=
name|src_len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * eap_fast_add_pac - Add a copy of a PAC entry to a list  * @pac_root: Pointer to PAC list root pointer  * @pac_current: Pointer to the current PAC pointer  * @entry: New entry to clone and add to the list  * Returns: 0 on success, -1 on failure  *  * This function makes a clone of the given PAC entry and adds this copied  * entry to the list (pac_root). If an old entry for the same A-ID is found,  * it will be removed from the PAC list and in this case, pac_current entry  * is set to %NULL if it was the removed entry.  */
end_comment

begin_function
name|int
name|eap_fast_add_pac
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
modifier|*
name|pac_root
parameter_list|,
name|struct
name|eap_fast_pac
modifier|*
modifier|*
name|pac_current
parameter_list|,
name|struct
name|eap_fast_pac
modifier|*
name|entry
parameter_list|)
block|{
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|;
if|if
condition|(
name|entry
operator|==
name|NULL
operator|||
name|entry
operator|->
name|a_id
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Remove a possible old entry for the matching A-ID. */
name|eap_fast_remove_pac
argument_list|(
name|pac_root
argument_list|,
name|pac_current
argument_list|,
name|entry
operator|->
name|a_id
argument_list|,
name|entry
operator|->
name|a_id_len
argument_list|,
name|entry
operator|->
name|pac_type
argument_list|)
expr_stmt|;
comment|/* Allocate a new entry and add it to the list of PACs. */
name|pac
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pac
operator|->
name|pac_type
operator|=
name|entry
operator|->
name|pac_type
expr_stmt|;
name|os_memcpy
argument_list|(
name|pac
operator|->
name|pac_key
argument_list|,
name|entry
operator|->
name|pac_key
argument_list|,
name|EAP_FAST_PAC_KEY_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_fast_copy_buf
argument_list|(
operator|&
name|pac
operator|->
name|pac_opaque
argument_list|,
operator|&
name|pac
operator|->
name|pac_opaque_len
argument_list|,
name|entry
operator|->
name|pac_opaque
argument_list|,
name|entry
operator|->
name|pac_opaque_len
argument_list|)
operator|<
literal|0
operator|||
name|eap_fast_copy_buf
argument_list|(
operator|&
name|pac
operator|->
name|pac_info
argument_list|,
operator|&
name|pac
operator|->
name|pac_info_len
argument_list|,
name|entry
operator|->
name|pac_info
argument_list|,
name|entry
operator|->
name|pac_info_len
argument_list|)
operator|<
literal|0
operator|||
name|eap_fast_copy_buf
argument_list|(
operator|&
name|pac
operator|->
name|a_id
argument_list|,
operator|&
name|pac
operator|->
name|a_id_len
argument_list|,
name|entry
operator|->
name|a_id
argument_list|,
name|entry
operator|->
name|a_id_len
argument_list|)
operator|<
literal|0
operator|||
name|eap_fast_copy_buf
argument_list|(
operator|&
name|pac
operator|->
name|i_id
argument_list|,
operator|&
name|pac
operator|->
name|i_id_len
argument_list|,
name|entry
operator|->
name|i_id
argument_list|,
name|entry
operator|->
name|i_id_len
argument_list|)
operator|<
literal|0
operator|||
name|eap_fast_copy_buf
argument_list|(
operator|&
name|pac
operator|->
name|a_id_info
argument_list|,
operator|&
name|pac
operator|->
name|a_id_info_len
argument_list|,
name|entry
operator|->
name|a_id_info
argument_list|,
name|entry
operator|->
name|a_id_info_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pac
operator|->
name|next
operator|=
operator|*
name|pac_root
expr_stmt|;
operator|*
name|pac_root
operator|=
name|pac
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_struct
struct|struct
name|eap_fast_read_ctx
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
specifier|const
name|char
modifier|*
name|end
decl_stmt|;
name|int
name|line
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|eap_fast_read_line
parameter_list|(
name|struct
name|eap_fast_read_ctx
modifier|*
name|rc
parameter_list|,
name|char
modifier|*
modifier|*
name|value
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|rc
operator|->
name|line
operator|++
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|f
condition|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|rc
operator|->
name|buf
argument_list|,
name|rc
operator|->
name|buf_len
argument_list|,
name|rc
operator|->
name|f
argument_list|)
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
specifier|const
name|char
modifier|*
name|l_end
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|rc
operator|->
name|pos
operator|>=
name|rc
operator|->
name|end
condition|)
return|return
operator|-
literal|1
return|;
name|l_end
operator|=
name|rc
operator|->
name|pos
expr_stmt|;
while|while
condition|(
name|l_end
operator|<
name|rc
operator|->
name|end
operator|&&
operator|*
name|l_end
operator|!=
literal|'\n'
condition|)
name|l_end
operator|++
expr_stmt|;
name|len
operator|=
name|l_end
operator|-
name|rc
operator|->
name|pos
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|rc
operator|->
name|buf_len
condition|)
name|len
operator|=
name|rc
operator|->
name|buf_len
operator|-
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|rc
operator|->
name|buf
argument_list|,
name|rc
operator|->
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|rc
operator|->
name|buf
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|rc
operator|->
name|pos
operator|=
name|l_end
operator|+
literal|1
expr_stmt|;
block|}
name|rc
operator|->
name|buf
index|[
name|rc
operator|->
name|buf_len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|rc
operator|->
name|buf
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\n'
operator|||
operator|*
name|pos
operator|==
literal|'\r'
condition|)
block|{
operator|*
name|pos
operator|=
literal|'\0'
expr_stmt|;
break|break;
block|}
name|pos
operator|++
expr_stmt|;
block|}
name|pos
operator|=
name|os_strchr
argument_list|(
name|rc
operator|->
name|buf
argument_list|,
literal|'='
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
operator|*
name|pos
operator|++
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|value
operator|=
name|pos
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_fast_parse_hex
parameter_list|(
specifier|const
name|char
modifier|*
name|value
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|int
name|hlen
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|hlen
operator|=
name|os_strlen
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|hlen
operator|&
literal|1
condition|)
return|return
name|NULL
return|;
operator|*
name|len
operator|=
name|hlen
operator|/
literal|2
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
operator|*
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|value
argument_list|,
name|buf
argument_list|,
operator|*
name|len
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_init_pac_data
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|char
modifier|*
name|pac_file
parameter_list|,
name|struct
name|eap_fast_read_ctx
modifier|*
name|rc
parameter_list|)
block|{
name|os_memset
argument_list|(
name|rc
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|rc
argument_list|)
argument_list|)
expr_stmt|;
name|rc
operator|->
name|buf_len
operator|=
literal|2048
expr_stmt|;
name|rc
operator|->
name|buf
operator|=
name|os_malloc
argument_list|(
name|rc
operator|->
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|pac_file
argument_list|,
literal|"blob://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
specifier|const
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|blob
operator|=
name|eap_get_config_blob
argument_list|(
name|sm
argument_list|,
name|pac_file
operator|+
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: No PAC blob '%s' - "
literal|"assume no PAC entries have been "
literal|"provisioned"
argument_list|,
name|pac_file
operator|+
literal|7
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rc
operator|->
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|rc
operator|->
name|pos
operator|=
operator|(
name|char
operator|*
operator|)
name|blob
operator|->
name|data
expr_stmt|;
name|rc
operator|->
name|end
operator|=
operator|(
name|char
operator|*
operator|)
name|blob
operator|->
name|data
operator|+
name|blob
operator|->
name|len
expr_stmt|;
block|}
else|else
block|{
name|rc
operator|->
name|f
operator|=
name|fopen
argument_list|(
name|pac_file
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: No PAC file '%s' - "
literal|"assume no PAC entries have been "
literal|"provisioned"
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|rc
operator|->
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_deinit_pac_data
parameter_list|(
name|struct
name|eap_fast_read_ctx
modifier|*
name|rc
parameter_list|)
block|{
name|os_free
argument_list|(
name|rc
operator|->
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|rc
operator|->
name|f
condition|)
name|fclose
argument_list|(
name|rc
operator|->
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_fast_parse_start
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
modifier|*
name|pac
parameter_list|)
block|{
if|if
condition|(
operator|*
name|pac
condition|)
return|return
literal|"START line without END"
return|;
operator|*
name|pac
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|eap_fast_pac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pac
operator|==
name|NULL
condition|)
return|return
literal|"No memory for PAC entry"
return|;
operator|(
operator|*
name|pac
operator|)
operator|->
name|pac_type
operator|=
name|PAC_TYPE_TUNNEL_PAC
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_fast_parse_end
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
modifier|*
name|pac_root
parameter_list|,
name|struct
name|eap_fast_pac
modifier|*
modifier|*
name|pac
parameter_list|)
block|{
if|if
condition|(
operator|*
name|pac
operator|==
name|NULL
condition|)
return|return
literal|"END line without START"
return|;
if|if
condition|(
operator|*
name|pac_root
condition|)
block|{
name|struct
name|eap_fast_pac
modifier|*
name|end
init|=
operator|*
name|pac_root
decl_stmt|;
while|while
condition|(
name|end
operator|->
name|next
condition|)
name|end
operator|=
name|end
operator|->
name|next
expr_stmt|;
name|end
operator|->
name|next
operator|=
operator|*
name|pac
expr_stmt|;
block|}
else|else
operator|*
name|pac_root
operator|=
operator|*
name|pac
expr_stmt|;
operator|*
name|pac
operator|=
name|NULL
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_fast_parse_pac_type
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|,
name|char
modifier|*
name|pos
parameter_list|)
block|{
name|pac
operator|->
name|pac_type
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|pac_type
operator|!=
name|PAC_TYPE_TUNNEL_PAC
operator|&&
name|pac
operator|->
name|pac_type
operator|!=
name|PAC_TYPE_USER_AUTHORIZATION
operator|&&
name|pac
operator|->
name|pac_type
operator|!=
name|PAC_TYPE_MACHINE_AUTHENTICATION
condition|)
return|return
literal|"Unrecognized PAC-Type"
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_fast_parse_pac_key
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|,
name|char
modifier|*
name|pos
parameter_list|)
block|{
name|u8
modifier|*
name|key
decl_stmt|;
name|size_t
name|key_len
decl_stmt|;
name|key
operator|=
name|eap_fast_parse_hex
argument_list|(
name|pos
argument_list|,
operator|&
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
operator|||
name|key_len
operator|!=
name|EAP_FAST_PAC_KEY_LEN
condition|)
block|{
name|os_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
return|return
literal|"Invalid PAC-Key"
return|;
block|}
name|os_memcpy
argument_list|(
name|pac
operator|->
name|pac_key
argument_list|,
name|key
argument_list|,
name|EAP_FAST_PAC_KEY_LEN
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|key
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_fast_parse_pac_opaque
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|,
name|char
modifier|*
name|pos
parameter_list|)
block|{
name|os_free
argument_list|(
name|pac
operator|->
name|pac_opaque
argument_list|)
expr_stmt|;
name|pac
operator|->
name|pac_opaque
operator|=
name|eap_fast_parse_hex
argument_list|(
name|pos
argument_list|,
operator|&
name|pac
operator|->
name|pac_opaque_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|pac_opaque
operator|==
name|NULL
condition|)
return|return
literal|"Invalid PAC-Opaque"
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_fast_parse_a_id
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|,
name|char
modifier|*
name|pos
parameter_list|)
block|{
name|os_free
argument_list|(
name|pac
operator|->
name|a_id
argument_list|)
expr_stmt|;
name|pac
operator|->
name|a_id
operator|=
name|eap_fast_parse_hex
argument_list|(
name|pos
argument_list|,
operator|&
name|pac
operator|->
name|a_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|a_id
operator|==
name|NULL
condition|)
return|return
literal|"Invalid A-ID"
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_fast_parse_i_id
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|,
name|char
modifier|*
name|pos
parameter_list|)
block|{
name|os_free
argument_list|(
name|pac
operator|->
name|i_id
argument_list|)
expr_stmt|;
name|pac
operator|->
name|i_id
operator|=
name|eap_fast_parse_hex
argument_list|(
name|pos
argument_list|,
operator|&
name|pac
operator|->
name|i_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|i_id
operator|==
name|NULL
condition|)
return|return
literal|"Invalid I-ID"
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_fast_parse_a_id_info
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|,
name|char
modifier|*
name|pos
parameter_list|)
block|{
name|os_free
argument_list|(
name|pac
operator|->
name|a_id_info
argument_list|)
expr_stmt|;
name|pac
operator|->
name|a_id_info
operator|=
name|eap_fast_parse_hex
argument_list|(
name|pos
argument_list|,
operator|&
name|pac
operator|->
name|a_id_info_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|a_id_info
operator|==
name|NULL
condition|)
return|return
literal|"Invalid A-ID-Info"
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * eap_fast_load_pac - Load PAC entries (text format)  * @sm: Pointer to EAP state machine allocated with eap_peer_sm_init()  * @pac_root: Pointer to root of the PAC list (to be filled)  * @pac_file: Name of the PAC file/blob to load  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|eap_fast_load_pac
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_pac
modifier|*
modifier|*
name|pac_root
parameter_list|,
specifier|const
name|char
modifier|*
name|pac_file
parameter_list|)
block|{
name|struct
name|eap_fast_read_ctx
name|rc
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|pac
init|=
name|NULL
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
specifier|const
name|char
modifier|*
name|err
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|pac_file
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|eap_fast_init_pac_data
argument_list|(
name|sm
argument_list|,
name|pac_file
argument_list|,
operator|&
name|rc
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|eap_fast_read_line
argument_list|(
operator|&
name|rc
argument_list|,
operator|&
name|pos
argument_list|)
operator|<
literal|0
operator|||
name|os_strcmp
argument_list|(
name|pac_file_hdr
argument_list|,
name|rc
operator|.
name|buf
argument_list|)
operator|!=
literal|0
condition|)
name|err
operator|=
literal|"Unrecognized header line"
expr_stmt|;
while|while
condition|(
operator|!
name|err
operator|&&
name|eap_fast_read_line
argument_list|(
operator|&
name|rc
argument_list|,
operator|&
name|pos
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|rc
operator|.
name|buf
argument_list|,
literal|"START"
argument_list|)
operator|==
literal|0
condition|)
name|err
operator|=
name|eap_fast_parse_start
argument_list|(
operator|&
name|pac
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|rc
operator|.
name|buf
argument_list|,
literal|"END"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|err
operator|=
name|eap_fast_parse_end
argument_list|(
name|pac_root
argument_list|,
operator|&
name|pac
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|pac
condition|)
name|err
operator|=
literal|"Unexpected line outside START/END block"
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|rc
operator|.
name|buf
argument_list|,
literal|"PAC-Type"
argument_list|)
operator|==
literal|0
condition|)
name|err
operator|=
name|eap_fast_parse_pac_type
argument_list|(
name|pac
argument_list|,
name|pos
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|rc
operator|.
name|buf
argument_list|,
literal|"PAC-Key"
argument_list|)
operator|==
literal|0
condition|)
name|err
operator|=
name|eap_fast_parse_pac_key
argument_list|(
name|pac
argument_list|,
name|pos
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|rc
operator|.
name|buf
argument_list|,
literal|"PAC-Opaque"
argument_list|)
operator|==
literal|0
condition|)
name|err
operator|=
name|eap_fast_parse_pac_opaque
argument_list|(
name|pac
argument_list|,
name|pos
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|rc
operator|.
name|buf
argument_list|,
literal|"A-ID"
argument_list|)
operator|==
literal|0
condition|)
name|err
operator|=
name|eap_fast_parse_a_id
argument_list|(
name|pac
argument_list|,
name|pos
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|rc
operator|.
name|buf
argument_list|,
literal|"I-ID"
argument_list|)
operator|==
literal|0
condition|)
name|err
operator|=
name|eap_fast_parse_i_id
argument_list|(
name|pac
argument_list|,
name|pos
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|rc
operator|.
name|buf
argument_list|,
literal|"A-ID-Info"
argument_list|)
operator|==
literal|0
condition|)
name|err
operator|=
name|eap_fast_parse_a_id_info
argument_list|(
name|pac
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pac
condition|)
block|{
name|err
operator|=
literal|"PAC block not terminated with END"
expr_stmt|;
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
block|}
name|eap_fast_deinit_pac_data
argument_list|(
operator|&
name|rc
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: %s in '%s:%d'"
argument_list|,
name|err
argument_list|,
name|pac_file
argument_list|,
name|rc
operator|.
name|line
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Read %d PAC entries from '%s'"
argument_list|,
name|count
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_write
parameter_list|(
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
modifier|*
name|pos
parameter_list|,
name|size_t
modifier|*
name|buf_len
parameter_list|,
specifier|const
name|char
modifier|*
name|field
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|txt
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|need
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
operator|||
operator|*
name|buf
operator|==
name|NULL
condition|)
return|return;
name|need
operator|=
name|os_strlen
argument_list|(
name|field
argument_list|)
operator|+
name|len
operator|*
literal|2
operator|+
literal|30
expr_stmt|;
if|if
condition|(
name|txt
condition|)
name|need
operator|+=
name|os_strlen
argument_list|(
name|field
argument_list|)
operator|+
name|len
operator|+
literal|20
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|-
operator|*
name|buf
operator|+
name|need
operator|>
operator|*
name|buf_len
condition|)
block|{
name|char
modifier|*
name|nbuf
init|=
name|os_realloc
argument_list|(
operator|*
name|buf
argument_list|,
operator|*
name|buf_len
operator|+
name|need
argument_list|)
decl_stmt|;
if|if
condition|(
name|nbuf
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
operator|*
name|buf
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
operator|*
name|buf
operator|=
name|nbuf
expr_stmt|;
operator|*
name|buf_len
operator|+=
name|need
expr_stmt|;
block|}
name|ret
operator|=
name|os_snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"%s="
argument_list|,
name|field
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
condition|)
return|return;
operator|*
name|pos
operator|+=
name|ret
expr_stmt|;
operator|*
name|pos
operator|+=
name|wpa_snprintf_hex
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
condition|)
return|return;
operator|*
name|pos
operator|+=
name|ret
expr_stmt|;
if|if
condition|(
name|txt
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"%s-txt="
argument_list|,
name|field
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
condition|)
return|return;
operator|*
name|pos
operator|+=
name|ret
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"%c"
argument_list|,
name|data
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
condition|)
return|return;
operator|*
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|ret
operator|=
name|os_snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
condition|)
return|return;
operator|*
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_write_pac
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
specifier|const
name|char
modifier|*
name|pac_file
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|pac_file
argument_list|,
literal|"blob://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|blob
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|blob
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|blob
operator|->
name|data
operator|=
operator|(
name|u8
operator|*
operator|)
name|buf
expr_stmt|;
name|blob
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
name|blob
operator|->
name|name
operator|=
name|os_strdup
argument_list|(
name|pac_file
operator|+
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|->
name|name
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|blob
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eap_set_config_blob
argument_list|(
name|sm
argument_list|,
name|blob
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|pac_file
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to open PAC "
literal|"file '%s' for writing"
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|len
argument_list|,
name|f
argument_list|)
operator|!=
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to write all "
literal|"PACs into '%s'"
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_fast_add_pac_data
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|,
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
modifier|*
name|pos
parameter_list|,
name|size_t
modifier|*
name|buf_len
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"START\nPAC-Type=%d\n"
argument_list|,
name|pac
operator|->
name|pac_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|+=
name|ret
expr_stmt|;
name|eap_fast_write
argument_list|(
name|buf
argument_list|,
name|pos
argument_list|,
name|buf_len
argument_list|,
literal|"PAC-Key"
argument_list|,
name|pac
operator|->
name|pac_key
argument_list|,
name|EAP_FAST_PAC_KEY_LEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
name|buf
argument_list|,
name|pos
argument_list|,
name|buf_len
argument_list|,
literal|"PAC-Opaque"
argument_list|,
name|pac
operator|->
name|pac_opaque
argument_list|,
name|pac
operator|->
name|pac_opaque_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
name|buf
argument_list|,
name|pos
argument_list|,
name|buf_len
argument_list|,
literal|"PAC-Info"
argument_list|,
name|pac
operator|->
name|pac_info
argument_list|,
name|pac
operator|->
name|pac_info_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
name|buf
argument_list|,
name|pos
argument_list|,
name|buf_len
argument_list|,
literal|"A-ID"
argument_list|,
name|pac
operator|->
name|a_id
argument_list|,
name|pac
operator|->
name|a_id_len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
name|buf
argument_list|,
name|pos
argument_list|,
name|buf_len
argument_list|,
literal|"I-ID"
argument_list|,
name|pac
operator|->
name|i_id
argument_list|,
name|pac
operator|->
name|i_id_len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|eap_fast_write
argument_list|(
name|buf
argument_list|,
name|pos
argument_list|,
name|buf_len
argument_list|,
literal|"A-ID-Info"
argument_list|,
name|pac
operator|->
name|a_id_info
argument_list|,
name|pac
operator|->
name|a_id_info_len
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: No memory for PAC "
literal|"data"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|os_snprintf
argument_list|(
operator|*
name|pos
argument_list|,
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
argument_list|,
literal|"END\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
operator|*
name|buf
operator|+
operator|*
name|buf_len
operator|-
operator|*
name|pos
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|pos
operator|+=
name|ret
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * eap_fast_save_pac - Save PAC entries (text format)  * @sm: Pointer to EAP state machine allocated with eap_peer_sm_init()  * @pac_root: Root of the PAC list  * @pac_file: Name of the PAC file/blob  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|eap_fast_save_pac
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_pac
modifier|*
name|pac_root
parameter_list|,
specifier|const
name|char
modifier|*
name|pac_file
parameter_list|)
block|{
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
if|if
condition|(
name|pac_file
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|buf_len
operator|=
literal|1024
expr_stmt|;
name|pos
operator|=
name|buf
operator|=
name|os_malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|buf
operator|+
name|buf_len
operator|-
name|pos
argument_list|,
literal|"%s\n"
argument_list|,
name|pac_file_hdr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|buf
operator|+
name|buf_len
operator|-
name|pos
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
name|ret
expr_stmt|;
name|pac
operator|=
name|pac_root
expr_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
if|if
condition|(
name|eap_fast_add_pac_data
argument_list|(
name|pac
argument_list|,
operator|&
name|buf
argument_list|,
operator|&
name|pos
argument_list|,
operator|&
name|buf_len
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|count
operator|++
expr_stmt|;
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|eap_fast_write_pac
argument_list|(
name|sm
argument_list|,
name|pac_file
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Wrote %d PAC entries into '%s'"
argument_list|,
name|count
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * eap_fast_pac_list_truncate - Truncate a PAC list to the given length  * @pac_root: Root of the PAC list  * @max_len: Maximum length of the list (>= 1)  * Returns: Number of PAC entries removed  */
end_comment

begin_function
name|size_t
name|eap_fast_pac_list_truncate
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac_root
parameter_list|,
name|size_t
name|max_len
parameter_list|)
block|{
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|size_t
name|count
decl_stmt|;
name|pac
operator|=
name|pac_root
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|count
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|>
name|max_len
condition|)
break|break;
name|prev
operator|=
name|pac
expr_stmt|;
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|<=
name|max_len
operator|||
name|prev
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|count
operator|=
literal|0
expr_stmt|;
name|prev
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
name|prev
operator|=
name|pac
expr_stmt|;
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
name|eap_fast_free_pac
argument_list|(
name|prev
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_fast_pac_get_a_id
parameter_list|(
name|struct
name|eap_fast_pac
modifier|*
name|pac
parameter_list|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u16
name|type
decl_stmt|,
name|len
decl_stmt|;
name|pos
operator|=
name|pac
operator|->
name|pac_info
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|pac
operator|->
name|pac_info_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|4
operator|<
name|end
condition|)
block|{
name|type
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|len
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|type
operator|==
name|PAC_TYPE_A_ID
condition|)
block|{
name|os_free
argument_list|(
name|pac
operator|->
name|a_id
argument_list|)
expr_stmt|;
name|pac
operator|->
name|a_id
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|a_id
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|pac
operator|->
name|a_id
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pac
operator|->
name|a_id_len
operator|=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|==
name|PAC_TYPE_A_ID_INFO
condition|)
block|{
name|os_free
argument_list|(
name|pac
operator|->
name|a_id_info
argument_list|)
expr_stmt|;
name|pac
operator|->
name|a_id_info
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|a_id_info
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|pac
operator|->
name|a_id_info
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pac
operator|->
name|a_id_info_len
operator|=
name|len
expr_stmt|;
block|}
name|pos
operator|+=
name|len
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * eap_fast_load_pac_bin - Load PAC entries (binary format)  * @sm: Pointer to EAP state machine allocated with eap_peer_sm_init()  * @pac_root: Pointer to root of the PAC list (to be filled)  * @pac_file: Name of the PAC file/blob to load  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|eap_fast_load_pac_bin
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_pac
modifier|*
modifier|*
name|pac_root
parameter_list|,
specifier|const
name|char
modifier|*
name|pac_file
parameter_list|)
block|{
specifier|const
name|struct
name|wpa_config_blob
modifier|*
name|blob
init|=
name|NULL
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
operator|*
name|pac_root
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|pac_file
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|pac_file
argument_list|,
literal|"blob://"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
name|blob
operator|=
name|eap_get_config_blob
argument_list|(
name|sm
argument_list|,
name|pac_file
operator|+
literal|7
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: No PAC blob '%s' - "
literal|"assume no PAC entries have been "
literal|"provisioned"
argument_list|,
name|pac_file
operator|+
literal|7
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|buf
operator|=
name|blob
operator|->
name|data
expr_stmt|;
name|len
operator|=
name|blob
operator|->
name|len
expr_stmt|;
block|}
else|else
block|{
name|buf
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_readfile
argument_list|(
name|pac_file
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: No PAC file '%s' - "
literal|"assume no PAC entries have been "
literal|"provisioned"
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|len
operator|<
literal|6
operator|||
name|WPA_GET_BE32
argument_list|(
name|buf
argument_list|)
operator|!=
name|EAP_FAST_PAC_BINARY_MAGIC
operator|||
name|WPA_GET_BE16
argument_list|(
name|buf
operator|+
literal|4
argument_list|)
operator|!=
name|EAP_FAST_PAC_BINARY_FORMAT_VERSION
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Invalid PAC file '%s' (bin)"
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pac
operator|=
name|prev
operator|=
name|NULL
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
literal|6
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|len
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
operator|+
literal|32
operator|+
literal|2
operator|+
literal|2
condition|)
goto|goto
name|parse_fail
goto|;
name|pac
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|pac
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|==
name|NULL
condition|)
goto|goto
name|parse_fail
goto|;
name|pac
operator|->
name|pac_type
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pac
operator|->
name|pac_key
argument_list|,
name|pos
argument_list|,
name|EAP_FAST_PAC_KEY_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|EAP_FAST_PAC_KEY_LEN
expr_stmt|;
name|pac
operator|->
name|pac_opaque_len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|pac
operator|->
name|pac_opaque_len
operator|+
literal|2
operator|>
name|end
condition|)
goto|goto
name|parse_fail
goto|;
name|pac
operator|->
name|pac_opaque
operator|=
name|os_malloc
argument_list|(
name|pac
operator|->
name|pac_opaque_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|pac_opaque
operator|==
name|NULL
condition|)
goto|goto
name|parse_fail
goto|;
name|os_memcpy
argument_list|(
name|pac
operator|->
name|pac_opaque
argument_list|,
name|pos
argument_list|,
name|pac
operator|->
name|pac_opaque_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|pac
operator|->
name|pac_opaque_len
expr_stmt|;
name|pac
operator|->
name|pac_info_len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|pac
operator|->
name|pac_info_len
operator|>
name|end
condition|)
goto|goto
name|parse_fail
goto|;
name|pac
operator|->
name|pac_info
operator|=
name|os_malloc
argument_list|(
name|pac
operator|->
name|pac_info_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
operator|->
name|pac_info
operator|==
name|NULL
condition|)
goto|goto
name|parse_fail
goto|;
name|os_memcpy
argument_list|(
name|pac
operator|->
name|pac_info
argument_list|,
name|pos
argument_list|,
name|pac
operator|->
name|pac_info_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|pac
operator|->
name|pac_info_len
expr_stmt|;
name|eap_fast_pac_get_a_id
argument_list|(
name|pac
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|pac
expr_stmt|;
else|else
operator|*
name|pac_root
operator|=
name|pac
expr_stmt|;
name|prev
operator|=
name|pac
expr_stmt|;
block|}
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Read %lu PAC entries from '%s' (bin)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|count
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|parse_fail
label|:
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-FAST: Failed to parse PAC file '%s' (bin)"
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|pac
condition|)
name|eap_fast_free_pac
argument_list|(
name|pac
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * eap_fast_save_pac_bin - Save PAC entries (binary format)  * @sm: Pointer to EAP state machine allocated with eap_peer_sm_init()  * @pac_root: Root of the PAC list  * @pac_file: Name of the PAC file/blob  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|eap_fast_save_pac_bin
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_fast_pac
modifier|*
name|pac_root
parameter_list|,
specifier|const
name|char
modifier|*
name|pac_file
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|,
name|count
init|=
literal|0
decl_stmt|;
name|struct
name|eap_fast_pac
modifier|*
name|pac
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|len
operator|=
literal|6
expr_stmt|;
name|pac
operator|=
name|pac_root
expr_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
if|if
condition|(
name|pac
operator|->
name|pac_opaque_len
operator|>
literal|65535
operator|||
name|pac
operator|->
name|pac_info_len
operator|>
literal|65535
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|+=
literal|2
operator|+
name|EAP_FAST_PAC_KEY_LEN
operator|+
literal|2
operator|+
name|pac
operator|->
name|pac_opaque_len
operator|+
literal|2
operator|+
name|pac
operator|->
name|pac_info_len
expr_stmt|;
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
block|}
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|buf
expr_stmt|;
name|WPA_PUT_BE32
argument_list|(
name|pos
argument_list|,
name|EAP_FAST_PAC_BINARY_MAGIC
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|EAP_FAST_PAC_BINARY_FORMAT_VERSION
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|pac
operator|=
name|pac_root
expr_stmt|;
while|while
condition|(
name|pac
condition|)
block|{
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|pac
operator|->
name|pac_type
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|pac
operator|->
name|pac_key
argument_list|,
name|EAP_FAST_PAC_KEY_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|EAP_FAST_PAC_KEY_LEN
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|pac
operator|->
name|pac_opaque_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|pac
operator|->
name|pac_opaque
argument_list|,
name|pac
operator|->
name|pac_opaque_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|pac
operator|->
name|pac_opaque_len
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|pac
operator|->
name|pac_info_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|pac
operator|->
name|pac_info
argument_list|,
name|pac
operator|->
name|pac_info_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|pac
operator|->
name|pac_info_len
expr_stmt|;
name|pac
operator|=
name|pac
operator|->
name|next
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|eap_fast_write_pac
argument_list|(
name|sm
argument_list|,
name|pac_file
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|len
argument_list|)
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-FAST: Wrote %lu PAC entries into '%s' "
literal|"(bin)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|count
argument_list|,
name|pac_file
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


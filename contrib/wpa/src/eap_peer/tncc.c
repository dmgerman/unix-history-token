begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * EAP-TNC - TNCC (IF-IMC and IF-TNCCS)  * Copyright (c) 2007, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NATIVE_WINDOWS
end_ifndef

begin_include
include|#
directive|include
file|<dlfcn.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"base64.h"
end_include

begin_include
include|#
directive|include
file|"tncc.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_tlv_common.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_defs.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|UNICODE
end_ifdef

begin_define
define|#
directive|define
name|TSTR
value|"%S"
end_define

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* UNICODE */
end_comment

begin_define
define|#
directive|define
name|TSTR
value|"%s"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* UNICODE */
end_comment

begin_define
define|#
directive|define
name|TNC_CONFIG_FILE
value|"/etc/tnc_config"
end_define

begin_define
define|#
directive|define
name|TNC_WINREG_PATH
value|TEXT("SOFTWARE\\Trusted Computing Group\\TNC\\IMCs")
end_define

begin_define
define|#
directive|define
name|IF_TNCCS_START
define|\
value|"<?xml version=\"1.0\"?>\n" \ "<TNCCS-Batch BatchId=\"%d\" Recipient=\"TNCS\" " \ "xmlns=\"http://www.trustedcomputinggroup.org/IWG/TNC/1_0/IF_TNCCS#\" " \ "xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" " \ "xsi:schemaLocation=\"http://www.trustedcomputinggroup.org/IWG/TNC/1_0/" \ "IF_TNCCS# https://www.trustedcomputinggroup.org/XML/SCHEMA/TNCCS_1.0.xsd\">\n"
end_define

begin_define
define|#
directive|define
name|IF_TNCCS_END
value|"\n</TNCCS-Batch>"
end_define

begin_comment
comment|/* TNC IF-IMC */
end_comment

begin_typedef
typedef|typedef
name|unsigned
name|long
name|TNC_UInt32
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|unsigned
name|char
modifier|*
name|TNC_BufferReference
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_IMCID
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_ConnectionID
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_ConnectionState
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_RetryReason
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_MessageType
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_MessageType
modifier|*
name|TNC_MessageTypeList
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_VendorID
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_MessageSubtype
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_Version
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_UInt32
name|TNC_Result
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|TNC_Result
function_decl|(
modifier|*
name|TNC_TNCC_BindFunctionPointer
function_decl|)
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|char
modifier|*
name|functionName
parameter_list|,
name|void
modifier|*
modifier|*
name|pOutfunctionPointer
parameter_list|)
function_decl|;
end_typedef

begin_define
define|#
directive|define
name|TNC_RESULT_SUCCESS
value|0
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_NOT_INITIALIZED
value|1
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_ALREADY_INITIALIZED
value|2
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_NO_COMMON_VERSION
value|3
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_CANT_RETRY
value|4
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_WONT_RETRY
value|5
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_INVALID_PARAMETER
value|6
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_CANT_RESPOND
value|7
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_ILLEGAL_OPERATION
value|8
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_OTHER
value|9
end_define

begin_define
define|#
directive|define
name|TNC_RESULT_FATAL
value|10
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_CREATE
value|0
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_HANDSHAKE
value|1
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_ACCESS_ALLOWED
value|2
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_ACCESS_ISOLATED
value|3
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_ACCESS_NONE
value|4
end_define

begin_define
define|#
directive|define
name|TNC_CONNECTION_STATE_DELETE
value|5
end_define

begin_define
define|#
directive|define
name|TNC_IFIMC_VERSION_1
value|1
end_define

begin_define
define|#
directive|define
name|TNC_VENDORID_ANY
value|((TNC_VendorID) 0xffffff)
end_define

begin_define
define|#
directive|define
name|TNC_SUBTYPE_ANY
value|((TNC_MessageSubtype) 0xff)
end_define

begin_comment
comment|/* TNCC-TNCS Message Types */
end_comment

begin_define
define|#
directive|define
name|TNC_TNCCS_RECOMMENDATION
value|0x00000001
end_define

begin_define
define|#
directive|define
name|TNC_TNCCS_ERROR
value|0x00000002
end_define

begin_define
define|#
directive|define
name|TNC_TNCCS_PREFERREDLANGUAGE
value|0x00000003
end_define

begin_define
define|#
directive|define
name|TNC_TNCCS_REASONSTRINGS
value|0x00000004
end_define

begin_comment
comment|/* IF-TNCCS-SOH - SSoH and SSoHR Attributes */
end_comment

begin_enum
enum|enum
block|{
name|SSOH_MS_MACHINE_INVENTORY
init|=
literal|1
block|,
name|SSOH_MS_QUARANTINE_STATE
init|=
literal|2
block|,
name|SSOH_MS_PACKET_INFO
init|=
literal|3
block|,
name|SSOH_MS_SYSTEMGENERATED_IDS
init|=
literal|4
block|,
name|SSOH_MS_MACHINENAME
init|=
literal|5
block|,
name|SSOH_MS_CORRELATIONID
init|=
literal|6
block|,
name|SSOH_MS_INSTALLED_SHVS
init|=
literal|7
block|,
name|SSOH_MS_MACHINE_INVENTORY_EX
init|=
literal|8
block|}
enum|;
end_enum

begin_struct
struct|struct
name|tnc_if_imc
block|{
name|struct
name|tnc_if_imc
modifier|*
name|next
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|;
name|void
modifier|*
name|dlhandle
decl_stmt|;
comment|/* from dlopen() */
name|TNC_IMCID
name|imcID
decl_stmt|;
name|TNC_ConnectionID
name|connectionID
decl_stmt|;
name|TNC_MessageTypeList
name|supported_types
decl_stmt|;
name|size_t
name|num_supported_types
decl_stmt|;
name|u8
modifier|*
name|imc_send
decl_stmt|;
name|size_t
name|imc_send_len
decl_stmt|;
comment|/* Functions implemented by IMCs (with TNC_IMC_ prefix) */
name|TNC_Result
function_decl|(
modifier|*
name|Initialize
function_decl|)
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_Version
name|minVersion
parameter_list|,
name|TNC_Version
name|maxVersion
parameter_list|,
name|TNC_Version
modifier|*
name|pOutActualVersion
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|NotifyConnectionChange
function_decl|)
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_ConnectionState
name|newState
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|BeginHandshake
function_decl|)
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|ReceiveMessage
function_decl|)
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_BufferReference
name|messageBuffer
parameter_list|,
name|TNC_UInt32
name|messageLength
parameter_list|,
name|TNC_MessageType
name|messageType
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|BatchEnding
function_decl|)
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|Terminate
function_decl|)
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|)
function_decl|;
name|TNC_Result
function_decl|(
modifier|*
name|ProvideBindFunction
function_decl|)
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_TNCC_BindFunctionPointer
name|bindFunction
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|tncc_data
block|{
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|;
name|unsigned
name|int
name|last_batchid
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|TNC_MAX_IMC_ID
value|10
end_define

begin_decl_stmt
specifier|static
name|struct
name|tnc_if_imc
modifier|*
name|tnc_imc
index|[
name|TNC_MAX_IMC_ID
index|]
init|=
block|{
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* TNCC functions that IMCs can call */
end_comment

begin_function
name|TNC_Result
name|TNC_TNCC_ReportMessageTypes
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_MessageTypeList
name|supportedTypes
parameter_list|,
name|TNC_UInt32
name|typeCount
parameter_list|)
block|{
name|TNC_UInt32
name|i
decl_stmt|;
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCC_ReportMessageTypes(imcID=%lu "
literal|"typeCount=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|imcID
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|typeCount
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|typeCount
condition|;
name|i
operator|++
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: supportedTypes[%lu] = %lu"
argument_list|,
name|i
argument_list|,
name|supportedTypes
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|imcID
operator|>=
name|TNC_MAX_IMC_ID
operator|||
name|tnc_imc
index|[
name|imcID
index|]
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
name|imc
operator|=
name|tnc_imc
index|[
name|imcID
index|]
expr_stmt|;
name|os_free
argument_list|(
name|imc
operator|->
name|supported_types
argument_list|)
expr_stmt|;
name|imc
operator|->
name|supported_types
operator|=
name|os_malloc
argument_list|(
name|typeCount
operator|*
sizeof|sizeof
argument_list|(
name|TNC_MessageTypeList
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|imc
operator|->
name|supported_types
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_FATAL
return|;
name|os_memcpy
argument_list|(
name|imc
operator|->
name|supported_types
argument_list|,
name|supportedTypes
argument_list|,
name|typeCount
operator|*
sizeof|sizeof
argument_list|(
name|TNC_MessageTypeList
argument_list|)
argument_list|)
expr_stmt|;
name|imc
operator|->
name|num_supported_types
operator|=
name|typeCount
expr_stmt|;
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_TNCC_SendMessage
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_BufferReference
name|message
parameter_list|,
name|TNC_UInt32
name|messageLength
parameter_list|,
name|TNC_MessageType
name|messageType
parameter_list|)
block|{
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|;
name|unsigned
name|char
modifier|*
name|b64
decl_stmt|;
name|size_t
name|b64len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCC_SendMessage(imcID=%lu "
literal|"connectionID=%lu messageType=%lu)"
argument_list|,
name|imcID
argument_list|,
name|connectionID
argument_list|,
name|messageType
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCC_SendMessage"
argument_list|,
name|message
argument_list|,
name|messageLength
argument_list|)
expr_stmt|;
if|if
condition|(
name|imcID
operator|>=
name|TNC_MAX_IMC_ID
operator|||
name|tnc_imc
index|[
name|imcID
index|]
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
name|b64
operator|=
name|base64_encode
argument_list|(
name|message
argument_list|,
name|messageLength
argument_list|,
operator|&
name|b64len
argument_list|)
expr_stmt|;
if|if
condition|(
name|b64
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_FATAL
return|;
name|imc
operator|=
name|tnc_imc
index|[
name|imcID
index|]
expr_stmt|;
name|os_free
argument_list|(
name|imc
operator|->
name|imc_send
argument_list|)
expr_stmt|;
name|imc
operator|->
name|imc_send_len
operator|=
literal|0
expr_stmt|;
name|imc
operator|->
name|imc_send
operator|=
name|os_zalloc
argument_list|(
name|b64len
operator|+
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|imc
operator|->
name|imc_send
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|b64
argument_list|)
expr_stmt|;
return|return
name|TNC_RESULT_OTHER
return|;
block|}
name|imc
operator|->
name|imc_send_len
operator|=
name|os_snprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|imc
operator|->
name|imc_send
argument_list|,
name|b64len
operator|+
literal|100
argument_list|,
literal|"<IMC-IMV-Message><Type>%08X</Type>"
literal|"<Base64>%s</Base64></IMC-IMV-Message>"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|messageType
argument_list|,
name|b64
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|b64
argument_list|)
expr_stmt|;
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_TNCC_RequestHandshakeRetry
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
name|TNC_RetryReason
name|reason
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCC_RequestHandshakeRetry"
argument_list|)
expr_stmt|;
if|if
condition|(
name|imcID
operator|>=
name|TNC_MAX_IMC_ID
operator|||
name|tnc_imc
index|[
name|imcID
index|]
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
comment|/* 	 * TODO: trigger a call to eapol_sm_request_reauth(). This would 	 * require that the IMC continues to be loaded in memory afer 	 * authentication.. 	 */
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_9048_LogMessage
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_UInt32
name|severity
parameter_list|,
specifier|const
name|char
modifier|*
name|message
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_9048_LogMessage(imcID=%lu "
literal|"severity==%lu message='%s')"
argument_list|,
name|imcID
argument_list|,
name|severity
argument_list|,
name|message
argument_list|)
expr_stmt|;
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_9048_UserMessage
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|TNC_ConnectionID
name|connectionID
parameter_list|,
specifier|const
name|char
modifier|*
name|message
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_9048_UserMessage(imcID=%lu "
literal|"connectionID==%lu message='%s')"
argument_list|,
name|imcID
argument_list|,
name|connectionID
argument_list|,
name|message
argument_list|)
expr_stmt|;
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
name|TNC_Result
name|TNC_TNCC_BindFunction
parameter_list|(
name|TNC_IMCID
name|imcID
parameter_list|,
name|char
modifier|*
name|functionName
parameter_list|,
name|void
modifier|*
modifier|*
name|pOutfunctionPointer
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_TNCC_BindFunction(imcID=%lu, "
literal|"functionName='%s')"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|imcID
argument_list|,
name|functionName
argument_list|)
expr_stmt|;
if|if
condition|(
name|imcID
operator|>=
name|TNC_MAX_IMC_ID
operator|||
name|tnc_imc
index|[
name|imcID
index|]
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
if|if
condition|(
name|pOutfunctionPointer
operator|==
name|NULL
condition|)
return|return
name|TNC_RESULT_INVALID_PARAMETER
return|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_TNCC_ReportMessageTypes"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutfunctionPointer
operator|=
name|TNC_TNCC_ReportMessageTypes
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_TNCC_SendMessage"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutfunctionPointer
operator|=
name|TNC_TNCC_SendMessage
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_TNCC_RequestHandshakeRetry"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutfunctionPointer
operator|=
name|TNC_TNCC_RequestHandshakeRetry
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_9048_LogMessage"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutfunctionPointer
operator|=
name|TNC_9048_LogMessage
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|functionName
argument_list|,
literal|"TNC_9048_UserMessage"
argument_list|)
operator|==
literal|0
condition|)
operator|*
name|pOutfunctionPointer
operator|=
name|TNC_9048_UserMessage
expr_stmt|;
else|else
operator|*
name|pOutfunctionPointer
operator|=
name|NULL
expr_stmt|;
return|return
name|TNC_RESULT_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|tncc_get_sym
parameter_list|(
name|void
modifier|*
name|handle
parameter_list|,
name|char
modifier|*
name|func
parameter_list|)
block|{
name|void
modifier|*
name|fptr
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
ifdef|#
directive|ifdef
name|_WIN32_WCE
name|fptr
operator|=
name|GetProcAddressA
argument_list|(
name|handle
argument_list|,
name|func
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* _WIN32_WCE */
name|fptr
operator|=
name|GetProcAddress
argument_list|(
name|handle
argument_list|,
name|func
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* _WIN32_WCE */
else|#
directive|else
comment|/* CONFIG_NATIVE_WINDOWS */
name|fptr
operator|=
name|dlsym
argument_list|(
name|handle
argument_list|,
name|func
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
return|return
name|fptr
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_imc_resolve_funcs
parameter_list|(
name|struct
name|tnc_if_imc
modifier|*
name|imc
parameter_list|)
block|{
name|void
modifier|*
name|handle
init|=
name|imc
operator|->
name|dlhandle
decl_stmt|;
comment|/* Mandatory IMC functions */
name|imc
operator|->
name|Initialize
operator|=
name|tncc_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMC_Initialize"
argument_list|)
expr_stmt|;
if|if
condition|(
name|imc
operator|->
name|Initialize
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: IMC does not export "
literal|"TNC_IMC_Initialize"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|imc
operator|->
name|BeginHandshake
operator|=
name|tncc_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMC_BeginHandshake"
argument_list|)
expr_stmt|;
if|if
condition|(
name|imc
operator|->
name|BeginHandshake
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: IMC does not export "
literal|"TNC_IMC_BeginHandshake"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|imc
operator|->
name|ProvideBindFunction
operator|=
name|tncc_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMC_ProvideBindFunction"
argument_list|)
expr_stmt|;
if|if
condition|(
name|imc
operator|->
name|ProvideBindFunction
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: IMC does not export "
literal|"TNC_IMC_ProvideBindFunction"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Optional IMC functions */
name|imc
operator|->
name|NotifyConnectionChange
operator|=
name|tncc_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMC_NotifyConnectionChange"
argument_list|)
expr_stmt|;
name|imc
operator|->
name|ReceiveMessage
operator|=
name|tncc_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMC_ReceiveMessage"
argument_list|)
expr_stmt|;
name|imc
operator|->
name|BatchEnding
operator|=
name|tncc_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMC_BatchEnding"
argument_list|)
expr_stmt|;
name|imc
operator|->
name|Terminate
operator|=
name|tncc_get_sym
argument_list|(
name|handle
argument_list|,
literal|"TNC_IMC_Terminate"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_imc_initialize
parameter_list|(
name|struct
name|tnc_if_imc
modifier|*
name|imc
parameter_list|)
block|{
name|TNC_Result
name|res
decl_stmt|;
name|TNC_Version
name|imc_ver
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Calling TNC_IMC_Initialize for IMC '%s'"
argument_list|,
name|imc
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imc
operator|->
name|Initialize
argument_list|(
name|imc
operator|->
name|imcID
argument_list|,
name|TNC_IFIMC_VERSION_1
argument_list|,
name|TNC_IFIMC_VERSION_1
argument_list|,
operator|&
name|imc_ver
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_IMC_Initialize: res=%lu imc_ver=%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|imc_ver
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
name|TNC_RESULT_SUCCESS
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_imc_terminate
parameter_list|(
name|struct
name|tnc_if_imc
modifier|*
name|imc
parameter_list|)
block|{
name|TNC_Result
name|res
decl_stmt|;
if|if
condition|(
name|imc
operator|->
name|Terminate
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Calling TNC_IMC_Terminate for IMC '%s'"
argument_list|,
name|imc
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imc
operator|->
name|Terminate
argument_list|(
name|imc
operator|->
name|imcID
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_IMC_Terminate: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
name|TNC_RESULT_SUCCESS
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_imc_provide_bind_function
parameter_list|(
name|struct
name|tnc_if_imc
modifier|*
name|imc
parameter_list|)
block|{
name|TNC_Result
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Calling TNC_IMC_ProvideBindFunction for "
literal|"IMC '%s'"
argument_list|,
name|imc
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imc
operator|->
name|ProvideBindFunction
argument_list|(
name|imc
operator|->
name|imcID
argument_list|,
name|TNC_TNCC_BindFunction
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_IMC_ProvideBindFunction: res=%lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
name|TNC_RESULT_SUCCESS
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_imc_notify_connection_change
parameter_list|(
name|struct
name|tnc_if_imc
modifier|*
name|imc
parameter_list|,
name|TNC_ConnectionState
name|state
parameter_list|)
block|{
name|TNC_Result
name|res
decl_stmt|;
if|if
condition|(
name|imc
operator|->
name|NotifyConnectionChange
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Calling TNC_IMC_NotifyConnectionChange(%d)"
literal|" for IMC '%s'"
argument_list|,
operator|(
name|int
operator|)
name|state
argument_list|,
name|imc
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imc
operator|->
name|NotifyConnectionChange
argument_list|(
name|imc
operator|->
name|imcID
argument_list|,
name|imc
operator|->
name|connectionID
argument_list|,
name|state
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_IMC_NotifyConnectionChange: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
name|TNC_RESULT_SUCCESS
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_imc_begin_handshake
parameter_list|(
name|struct
name|tnc_if_imc
modifier|*
name|imc
parameter_list|)
block|{
name|TNC_Result
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Calling TNC_IMC_BeginHandshake for IMC "
literal|"'%s'"
argument_list|,
name|imc
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imc
operator|->
name|BeginHandshake
argument_list|(
name|imc
operator|->
name|imcID
argument_list|,
name|imc
operator|->
name|connectionID
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNC_IMC_BeginHandshake: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
name|TNC_RESULT_SUCCESS
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_load_imc
parameter_list|(
name|struct
name|tnc_if_imc
modifier|*
name|imc
parameter_list|)
block|{
if|if
condition|(
name|imc
operator|->
name|path
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: No IMC configured"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Opening IMC: %s (%s)"
argument_list|,
name|imc
operator|->
name|name
argument_list|,
name|imc
operator|->
name|path
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
ifdef|#
directive|ifdef
name|UNICODE
block|{
name|TCHAR
modifier|*
name|lib
init|=
name|wpa_strdup_tchar
argument_list|(
name|imc
operator|->
name|path
argument_list|)
decl_stmt|;
if|if
condition|(
name|lib
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|imc
operator|->
name|dlhandle
operator|=
name|LoadLibrary
argument_list|(
name|lib
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|lib
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* UNICODE */
name|imc
operator|->
name|dlhandle
operator|=
name|LoadLibrary
argument_list|(
name|imc
operator|->
name|path
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* UNICODE */
if|if
condition|(
name|imc
operator|->
name|dlhandle
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to open IMC '%s' (%s): %d"
argument_list|,
name|imc
operator|->
name|name
argument_list|,
name|imc
operator|->
name|path
argument_list|,
operator|(
name|int
operator|)
name|GetLastError
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|#
directive|else
comment|/* CONFIG_NATIVE_WINDOWS */
name|imc
operator|->
name|dlhandle
operator|=
name|dlopen
argument_list|(
name|imc
operator|->
name|path
argument_list|,
name|RTLD_LAZY
argument_list|)
expr_stmt|;
if|if
condition|(
name|imc
operator|->
name|dlhandle
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to open IMC '%s' (%s): %s"
argument_list|,
name|imc
operator|->
name|name
argument_list|,
name|imc
operator|->
name|path
argument_list|,
name|dlerror
argument_list|()
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
if|if
condition|(
name|tncc_imc_resolve_funcs
argument_list|(
name|imc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to resolve IMC functions"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tncc_imc_initialize
argument_list|(
name|imc
argument_list|)
operator|<
literal|0
operator|||
name|tncc_imc_provide_bind_function
argument_list|(
name|imc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to initialize IMC"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tncc_unload_imc
parameter_list|(
name|struct
name|tnc_if_imc
modifier|*
name|imc
parameter_list|)
block|{
name|tncc_imc_terminate
argument_list|(
name|imc
argument_list|)
expr_stmt|;
name|tnc_imc
index|[
name|imc
operator|->
name|imcID
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|imc
operator|->
name|dlhandle
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
name|FreeLibrary
argument_list|(
name|imc
operator|->
name|dlhandle
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* CONFIG_NATIVE_WINDOWS */
name|dlclose
argument_list|(
name|imc
operator|->
name|dlhandle
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NATIVE_WINDOWS */
block|}
name|os_free
argument_list|(
name|imc
operator|->
name|name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imc
operator|->
name|path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imc
operator|->
name|supported_types
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imc
operator|->
name|imc_send
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_supported_type
parameter_list|(
name|struct
name|tnc_if_imc
modifier|*
name|imc
parameter_list|,
name|unsigned
name|int
name|type
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|unsigned
name|int
name|vendor
decl_stmt|,
name|subtype
decl_stmt|;
if|if
condition|(
name|imc
operator|==
name|NULL
operator|||
name|imc
operator|->
name|supported_types
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|vendor
operator|=
name|type
operator|>>
literal|8
expr_stmt|;
name|subtype
operator|=
name|type
operator|&
literal|0xff
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|imc
operator|->
name|num_supported_types
condition|;
name|i
operator|++
control|)
block|{
name|unsigned
name|int
name|svendor
decl_stmt|,
name|ssubtype
decl_stmt|;
name|svendor
operator|=
name|imc
operator|->
name|supported_types
index|[
name|i
index|]
operator|>>
literal|8
expr_stmt|;
name|ssubtype
operator|=
name|imc
operator|->
name|supported_types
index|[
name|i
index|]
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
operator|(
name|vendor
operator|==
name|svendor
operator|||
name|svendor
operator|==
name|TNC_VENDORID_ANY
operator|)
operator|&&
operator|(
name|subtype
operator|==
name|ssubtype
operator|||
name|ssubtype
operator|==
name|TNC_SUBTYPE_ANY
operator|)
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tncc_send_to_imcs
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|,
name|unsigned
name|int
name|type
parameter_list|,
specifier|const
name|u8
modifier|*
name|msg
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|;
name|TNC_Result
name|res
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TNC: Message to IMC(s)"
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|imc
operator|=
name|tncc
operator|->
name|imc
init|;
name|imc
condition|;
name|imc
operator|=
name|imc
operator|->
name|next
control|)
block|{
if|if
condition|(
name|imc
operator|->
name|ReceiveMessage
operator|==
name|NULL
operator|||
operator|!
name|tncc_supported_type
argument_list|(
name|imc
argument_list|,
name|type
argument_list|)
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Call ReceiveMessage for IMC '%s'"
argument_list|,
name|imc
operator|->
name|name
argument_list|)
expr_stmt|;
name|res
operator|=
name|imc
operator|->
name|ReceiveMessage
argument_list|(
name|imc
operator|->
name|imcID
argument_list|,
name|imc
operator|->
name|connectionID
argument_list|,
operator|(
name|TNC_BufferReference
operator|)
name|msg
argument_list|,
name|len
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: ReceiveMessage: %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|tncc_init_connection
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|)
block|{
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|;
for|for
control|(
name|imc
operator|=
name|tncc
operator|->
name|imc
init|;
name|imc
condition|;
name|imc
operator|=
name|imc
operator|->
name|next
control|)
block|{
name|tncc_imc_notify_connection_change
argument_list|(
name|imc
argument_list|,
name|TNC_CONNECTION_STATE_CREATE
argument_list|)
expr_stmt|;
name|tncc_imc_notify_connection_change
argument_list|(
name|imc
argument_list|,
name|TNC_CONNECTION_STATE_HANDSHAKE
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imc
operator|->
name|imc_send
argument_list|)
expr_stmt|;
name|imc
operator|->
name|imc_send
operator|=
name|NULL
expr_stmt|;
name|imc
operator|->
name|imc_send_len
operator|=
literal|0
expr_stmt|;
name|tncc_imc_begin_handshake
argument_list|(
name|imc
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|size_t
name|tncc_total_send_len
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|)
block|{
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|;
name|size_t
name|len
init|=
literal|0
decl_stmt|;
for|for
control|(
name|imc
operator|=
name|tncc
operator|->
name|imc
init|;
name|imc
condition|;
name|imc
operator|=
name|imc
operator|->
name|next
control|)
name|len
operator|+=
name|imc
operator|->
name|imc_send_len
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|tncc_copy_send_buf
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|,
name|u8
modifier|*
name|pos
parameter_list|)
block|{
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|;
for|for
control|(
name|imc
operator|=
name|tncc
operator|->
name|imc
init|;
name|imc
condition|;
name|imc
operator|=
name|imc
operator|->
name|next
control|)
block|{
if|if
condition|(
name|imc
operator|->
name|imc_send
operator|==
name|NULL
condition|)
continue|continue;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|imc
operator|->
name|imc_send
argument_list|,
name|imc
operator|->
name|imc_send_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|imc
operator|->
name|imc_send_len
expr_stmt|;
name|os_free
argument_list|(
name|imc
operator|->
name|imc_send
argument_list|)
expr_stmt|;
name|imc
operator|->
name|imc_send
operator|=
name|NULL
expr_stmt|;
name|imc
operator|->
name|imc_send_len
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|pos
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|tncc_if_tnccs_start
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|)
block|{
name|char
modifier|*
name|buf
init|=
name|os_malloc
argument_list|(
literal|1000
argument_list|)
decl_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|tncc
operator|->
name|last_batchid
operator|++
expr_stmt|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
literal|1000
argument_list|,
name|IF_TNCCS_START
argument_list|,
name|tncc
operator|->
name|last_batchid
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|tncc_if_tnccs_end
parameter_list|(
name|void
parameter_list|)
block|{
name|char
modifier|*
name|buf
init|=
name|os_malloc
argument_list|(
literal|100
argument_list|)
decl_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
literal|100
argument_list|,
name|IF_TNCCS_END
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|tncc_notify_recommendation
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|,
name|enum
name|tncc_process_res
name|res
parameter_list|)
block|{
name|TNC_ConnectionState
name|state
decl_stmt|;
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|;
switch|switch
condition|(
name|res
condition|)
block|{
case|case
name|TNCCS_RECOMMENDATION_ALLOW
case|:
name|state
operator|=
name|TNC_CONNECTION_STATE_ACCESS_ALLOWED
expr_stmt|;
break|break;
case|case
name|TNCCS_RECOMMENDATION_NONE
case|:
name|state
operator|=
name|TNC_CONNECTION_STATE_ACCESS_NONE
expr_stmt|;
break|break;
case|case
name|TNCCS_RECOMMENDATION_ISOLATE
case|:
name|state
operator|=
name|TNC_CONNECTION_STATE_ACCESS_ISOLATED
expr_stmt|;
break|break;
default|default:
name|state
operator|=
name|TNC_CONNECTION_STATE_ACCESS_NONE
expr_stmt|;
break|break;
block|}
for|for
control|(
name|imc
operator|=
name|tncc
operator|->
name|imc
init|;
name|imc
condition|;
name|imc
operator|=
name|imc
operator|->
name|next
control|)
name|tncc_imc_notify_connection_change
argument_list|(
name|imc
argument_list|,
name|state
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_get_type
parameter_list|(
name|char
modifier|*
name|start
parameter_list|,
name|unsigned
name|int
modifier|*
name|type
parameter_list|)
block|{
name|char
modifier|*
name|pos
init|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<Type>"
argument_list|)
decl_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
literal|6
expr_stmt|;
operator|*
name|type
operator|=
name|strtoul
argument_list|(
name|pos
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|char
modifier|*
name|tncc_get_base64
parameter_list|(
name|char
modifier|*
name|start
parameter_list|,
name|size_t
modifier|*
name|decoded_len
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|unsigned
name|char
modifier|*
name|decoded
decl_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<Base64>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|+=
literal|8
expr_stmt|;
name|pos2
operator|=
name|os_strstr
argument_list|(
name|pos
argument_list|,
literal|"</Base64>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
name|decoded
operator|=
name|base64_decode
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|pos
argument_list|,
name|os_strlen
argument_list|(
name|pos
argument_list|)
argument_list|,
name|decoded_len
argument_list|)
expr_stmt|;
operator|*
name|pos2
operator|=
literal|'<'
expr_stmt|;
if|if
condition|(
name|decoded
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Failed to decode Base64 data"
argument_list|)
expr_stmt|;
block|}
return|return
name|decoded
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|tncc_process_res
name|tncc_get_recommendation
parameter_list|(
name|char
modifier|*
name|start
parameter_list|)
block|{
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|,
name|saved
decl_stmt|;
name|int
name|recom
decl_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<TNCCS-Recommendation "
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
name|TNCCS_RECOMMENDATION_ERROR
return|;
name|pos
operator|+=
literal|21
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|pos
argument_list|,
literal|" type="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
name|TNCCS_RECOMMENDATION_ERROR
return|;
name|pos
operator|+=
literal|6
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'"'
condition|)
name|pos
operator|++
expr_stmt|;
name|pos2
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|pos2
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos2
operator|!=
literal|'"'
operator|&&
operator|*
name|pos2
operator|!=
literal|'>'
condition|)
name|pos2
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos2
operator|==
literal|'\0'
condition|)
return|return
name|TNCCS_RECOMMENDATION_ERROR
return|;
name|saved
operator|=
operator|*
name|pos2
expr_stmt|;
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNCCS-Recommendation: '%s'"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|recom
operator|=
name|TNCCS_RECOMMENDATION_ERROR
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|pos
argument_list|,
literal|"allow"
argument_list|)
operator|==
literal|0
condition|)
name|recom
operator|=
name|TNCCS_RECOMMENDATION_ALLOW
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|pos
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
condition|)
name|recom
operator|=
name|TNCCS_RECOMMENDATION_NONE
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|pos
argument_list|,
literal|"isolate"
argument_list|)
operator|==
literal|0
condition|)
name|recom
operator|=
name|TNCCS_RECOMMENDATION_ISOLATE
expr_stmt|;
operator|*
name|pos2
operator|=
name|saved
expr_stmt|;
return|return
name|recom
return|;
block|}
end_function

begin_function
name|enum
name|tncc_process_res
name|tncc_process_if_tnccs
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|,
specifier|const
name|u8
modifier|*
name|msg
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|char
modifier|*
name|buf
decl_stmt|,
modifier|*
name|start
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|,
modifier|*
name|payload
decl_stmt|;
name|unsigned
name|int
name|batch_id
decl_stmt|;
name|unsigned
name|char
modifier|*
name|decoded
decl_stmt|;
name|size_t
name|decoded_len
decl_stmt|;
name|enum
name|tncc_process_res
name|res
init|=
name|TNCCS_PROCESS_OK_NO_RECOMMENDATION
decl_stmt|;
name|int
name|recommendation_msg
init|=
literal|0
decl_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|TNCCS_PROCESS_ERROR
return|;
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|msg
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|start
operator|=
name|os_strstr
argument_list|(
name|buf
argument_list|,
literal|"<TNCCS-Batch "
argument_list|)
expr_stmt|;
name|end
operator|=
name|os_strstr
argument_list|(
name|buf
argument_list|,
literal|"</TNCCS-Batch>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|start
operator|==
name|NULL
operator|||
name|end
operator|==
name|NULL
operator|||
name|start
operator|>
name|end
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|TNCCS_PROCESS_ERROR
return|;
block|}
name|start
operator|+=
literal|13
expr_stmt|;
while|while
condition|(
operator|*
name|start
operator|==
literal|' '
condition|)
name|start
operator|++
expr_stmt|;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"BatchId="
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|TNCCS_PROCESS_ERROR
return|;
block|}
name|pos
operator|+=
literal|8
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'"'
condition|)
name|pos
operator|++
expr_stmt|;
name|batch_id
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Received IF-TNCCS BatchId=%u"
argument_list|,
name|batch_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|batch_id
operator|!=
name|tncc
operator|->
name|last_batchid
operator|+
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Unexpected IF-TNCCS BatchId "
literal|"%u (expected %u)"
argument_list|,
name|batch_id
argument_list|,
name|tncc
operator|->
name|last_batchid
operator|+
literal|1
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|TNCCS_PROCESS_ERROR
return|;
block|}
name|tncc
operator|->
name|last_batchid
operator|=
name|batch_id
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|!=
literal|'\0'
operator|&&
operator|*
name|pos
operator|!=
literal|'>'
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
literal|'\0'
condition|)
block|{
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|TNCCS_PROCESS_ERROR
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|payload
operator|=
name|start
expr_stmt|;
comment|/* 	 *<IMC-IMV-Message> 	 *<Type>01234567</Type> 	 *<Base64>foo==</Base64> 	 *</IMC-IMV-Message> 	 */
while|while
condition|(
operator|*
name|start
condition|)
block|{
name|char
modifier|*
name|endpos
decl_stmt|;
name|unsigned
name|int
name|type
decl_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<IMC-IMV-Message>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
break|break;
name|start
operator|=
name|pos
operator|+
literal|17
expr_stmt|;
name|end
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"</IMC-IMV-Message>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
break|break;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|endpos
operator|=
name|end
expr_stmt|;
name|end
operator|+=
literal|18
expr_stmt|;
if|if
condition|(
name|tncc_get_type
argument_list|(
name|start
argument_list|,
operator|&
name|type
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|*
name|endpos
operator|=
literal|'<'
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: IMC-IMV-Message Type 0x%x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|decoded
operator|=
name|tncc_get_base64
argument_list|(
name|start
argument_list|,
operator|&
name|decoded_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decoded
operator|==
name|NULL
condition|)
block|{
operator|*
name|endpos
operator|=
literal|'<'
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
continue|continue;
block|}
name|tncc_send_to_imcs
argument_list|(
name|tncc
argument_list|,
name|type
argument_list|,
name|decoded
argument_list|,
name|decoded_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decoded
argument_list|)
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
block|}
comment|/* 	 *<TNCC-TNCS-Message> 	 *<Type>01234567</Type> 	 *<XML><TNCCS-Foo type="foo"></TNCCS-Foo></XML> 	 *<Base64>foo==</Base64> 	 *</TNCC-TNCS-Message> 	 */
name|start
operator|=
name|payload
expr_stmt|;
while|while
condition|(
operator|*
name|start
condition|)
block|{
name|unsigned
name|int
name|type
decl_stmt|;
name|char
modifier|*
name|xml
decl_stmt|,
modifier|*
name|xmlend
decl_stmt|,
modifier|*
name|endpos
decl_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<TNCC-TNCS-Message>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
break|break;
name|start
operator|=
name|pos
operator|+
literal|19
expr_stmt|;
name|end
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"</TNCC-TNCS-Message>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
break|break;
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
name|endpos
operator|=
name|end
expr_stmt|;
name|end
operator|+=
literal|20
expr_stmt|;
if|if
condition|(
name|tncc_get_type
argument_list|(
name|start
argument_list|,
operator|&
name|type
argument_list|)
operator|<
literal|0
condition|)
block|{
operator|*
name|endpos
operator|=
literal|'<'
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: TNCC-TNCS-Message Type 0x%x"
argument_list|,
name|type
argument_list|)
expr_stmt|;
comment|/* Base64 OR XML */
name|decoded
operator|=
name|NULL
expr_stmt|;
name|xml
operator|=
name|NULL
expr_stmt|;
name|xmlend
operator|=
name|NULL
expr_stmt|;
name|pos
operator|=
name|os_strstr
argument_list|(
name|start
argument_list|,
literal|"<XML>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|+=
literal|5
expr_stmt|;
name|pos2
operator|=
name|os_strstr
argument_list|(
name|pos
argument_list|,
literal|"</XML>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
operator|==
name|NULL
condition|)
block|{
operator|*
name|endpos
operator|=
literal|'<'
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
continue|continue;
block|}
name|xmlend
operator|=
name|pos2
expr_stmt|;
name|xml
operator|=
name|pos
expr_stmt|;
block|}
else|else
block|{
name|decoded
operator|=
name|tncc_get_base64
argument_list|(
name|start
argument_list|,
operator|&
name|decoded_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|decoded
operator|==
name|NULL
condition|)
block|{
operator|*
name|endpos
operator|=
literal|'<'
expr_stmt|;
name|start
operator|=
name|end
expr_stmt|;
continue|continue;
block|}
block|}
if|if
condition|(
name|decoded
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TNC: TNCC-TNCS-Message Base64"
argument_list|,
name|decoded
argument_list|,
name|decoded_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decoded
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|xml
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TNC: TNCC-TNCS-Message XML"
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|xml
argument_list|,
name|xmlend
operator|-
name|xml
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|==
name|TNC_TNCCS_RECOMMENDATION
operator|&&
name|xml
condition|)
block|{
comment|/* 			 *<TNCCS-Recommendation type="allow"> 			 *</TNCCS-Recommendation> 			 */
operator|*
name|xmlend
operator|=
literal|'\0'
expr_stmt|;
name|res
operator|=
name|tncc_get_recommendation
argument_list|(
name|xml
argument_list|)
expr_stmt|;
operator|*
name|xmlend
operator|=
literal|'<'
expr_stmt|;
name|recommendation_msg
operator|=
literal|1
expr_stmt|;
block|}
name|start
operator|=
name|end
expr_stmt|;
block|}
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|recommendation_msg
condition|)
name|tncc_notify_recommendation
argument_list|(
name|tncc
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_NATIVE_WINDOWS
end_ifdef

begin_function
specifier|static
name|int
name|tncc_read_config_reg
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|,
name|HKEY
name|hive
parameter_list|)
block|{
name|HKEY
name|hk
decl_stmt|,
name|hk2
decl_stmt|;
name|LONG
name|ret
decl_stmt|;
name|DWORD
name|i
decl_stmt|;
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|int
name|j
decl_stmt|;
name|last
operator|=
name|tncc
operator|->
name|imc
expr_stmt|;
while|while
condition|(
name|last
operator|&&
name|last
operator|->
name|next
condition|)
name|last
operator|=
name|last
operator|->
name|next
expr_stmt|;
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|hive
argument_list|,
name|TNC_WINREG_PATH
argument_list|,
literal|0
argument_list|,
name|KEY_ENUMERATE_SUB_KEYS
argument_list|,
operator|&
name|hk
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
condition|;
name|i
operator|++
control|)
block|{
name|TCHAR
name|name
index|[
literal|255
index|]
decl_stmt|,
modifier|*
name|val
decl_stmt|;
name|DWORD
name|namelen
decl_stmt|,
name|buflen
decl_stmt|;
name|namelen
operator|=
literal|255
expr_stmt|;
name|ret
operator|=
name|RegEnumKeyEx
argument_list|(
name|hk
argument_list|,
name|i
argument_list|,
name|name
argument_list|,
operator|&
name|namelen
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ERROR_NO_MORE_ITEMS
condition|)
break|break;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: RegEnumKeyEx failed: 0x%x"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ret
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|namelen
operator|>=
literal|255
condition|)
name|namelen
operator|=
literal|255
operator|-
literal|1
expr_stmt|;
name|name
index|[
name|namelen
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: IMC '"
name|TSTR
literal|"'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|ret
operator|=
name|RegOpenKeyEx
argument_list|(
name|hk
argument_list|,
name|name
argument_list|,
literal|0
argument_list|,
name|KEY_QUERY_VALUE
argument_list|,
operator|&
name|hk2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Could not open IMC key '"
name|TSTR
literal|"'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk2
argument_list|,
name|TEXT
argument_list|(
literal|"Path"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Could not read Path from "
literal|"IMC key '"
name|TSTR
literal|"'"
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|RegCloseKey
argument_list|(
name|hk2
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|val
operator|=
name|os_malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|==
name|NULL
condition|)
block|{
name|RegCloseKey
argument_list|(
name|hk2
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|ret
operator|=
name|RegQueryValueEx
argument_list|(
name|hk2
argument_list|,
name|TEXT
argument_list|(
literal|"Path"
argument_list|)
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|(
name|LPBYTE
operator|)
name|val
argument_list|,
operator|&
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
name|ERROR_SUCCESS
condition|)
block|{
name|os_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|RegCloseKey
argument_list|(
name|hk2
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|RegCloseKey
argument_list|(
name|hk2
argument_list|)
expr_stmt|;
name|wpa_unicode2ascii_inplace
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: IMC Path '%s'"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|val
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|TNC_MAX_IMC_ID
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|tnc_imc
index|[
name|j
index|]
operator|==
name|NULL
condition|)
break|break;
block|}
if|if
condition|(
name|j
operator|>=
name|TNC_MAX_IMC_ID
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Too many IMCs"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|imc
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|imc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|imc
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
break|break;
block|}
name|imc
operator|->
name|imcID
operator|=
name|j
expr_stmt|;
name|wpa_unicode2ascii_inplace
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|imc
operator|->
name|name
operator|=
name|os_strdup
argument_list|(
operator|(
name|char
operator|*
operator|)
name|name
argument_list|)
expr_stmt|;
name|imc
operator|->
name|path
operator|=
name|os_strdup
argument_list|(
operator|(
name|char
operator|*
operator|)
name|val
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|last
operator|==
name|NULL
condition|)
name|tncc
operator|->
name|imc
operator|=
name|imc
expr_stmt|;
else|else
name|last
operator|->
name|next
operator|=
name|imc
expr_stmt|;
name|last
operator|=
name|imc
expr_stmt|;
name|tnc_imc
index|[
name|imc
operator|->
name|imcID
index|]
operator|=
name|imc
expr_stmt|;
block|}
name|RegCloseKey
argument_list|(
name|hk
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_read_config
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|)
block|{
if|if
condition|(
name|tncc_read_config_reg
argument_list|(
name|tncc
argument_list|,
name|HKEY_LOCAL_MACHINE
argument_list|)
operator|<
literal|0
operator|||
name|tncc_read_config_reg
argument_list|(
name|tncc
argument_list|,
name|HKEY_CURRENT_USER
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_function
specifier|static
name|struct
name|tnc_if_imc
modifier|*
name|tncc_parse_imc
parameter_list|(
name|char
modifier|*
name|start
parameter_list|,
name|char
modifier|*
name|end
parameter_list|,
name|int
modifier|*
name|error
parameter_list|)
block|{
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|pos2
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|TNC_MAX_IMC_ID
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|tnc_imc
index|[
name|i
index|]
operator|==
name|NULL
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|TNC_MAX_IMC_ID
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Too many IMCs"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|imc
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|imc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|imc
operator|==
name|NULL
condition|)
block|{
operator|*
name|error
operator|=
literal|1
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|imc
operator|->
name|imcID
operator|=
name|i
expr_stmt|;
name|pos
operator|=
name|start
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Configured IMC: %s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>=
name|end
operator|||
operator|*
name|pos
operator|!=
literal|'"'
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Ignoring invalid IMC line '%s' "
literal|"(no starting quotation mark)"
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|pos2
operator|=
name|pos
expr_stmt|;
while|while
condition|(
name|pos2
operator|<
name|end
operator|&&
operator|*
name|pos2
operator|!=
literal|'"'
condition|)
name|pos2
operator|++
expr_stmt|;
if|if
condition|(
name|pos2
operator|>=
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Ignoring invalid IMC line '%s' "
literal|"(no ending quotation mark)"
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|pos2
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: Name: '%s'"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|imc
operator|->
name|name
operator|=
name|os_strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|=
name|pos2
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|pos
operator|>=
name|end
operator|||
operator|*
name|pos
operator|!=
literal|' '
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Ignoring invalid IMC line '%s' "
literal|"(no space after name)"
argument_list|,
name|start
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|imc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: IMC file: '%s'"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|imc
operator|->
name|path
operator|=
name|os_strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|tnc_imc
index|[
name|imc
operator|->
name|imcID
index|]
operator|=
name|imc
expr_stmt|;
return|return
name|imc
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tncc_read_config
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|)
block|{
name|char
modifier|*
name|config
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|line_end
decl_stmt|;
name|size_t
name|config_len
decl_stmt|;
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|,
modifier|*
name|last
decl_stmt|;
name|last
operator|=
name|NULL
expr_stmt|;
name|config
operator|=
name|os_readfile
argument_list|(
name|TNC_CONFIG_FILE
argument_list|,
operator|&
name|config_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|config
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Could not open TNC configuration "
literal|"file '%s'"
argument_list|,
name|TNC_CONFIG_FILE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|=
name|config
operator|+
name|config_len
expr_stmt|;
for|for
control|(
name|pos
operator|=
name|config
init|;
name|pos
operator|<
name|end
condition|;
name|pos
operator|=
name|line_end
operator|+
literal|1
control|)
block|{
name|line_end
operator|=
name|pos
expr_stmt|;
while|while
condition|(
operator|*
name|line_end
operator|!=
literal|'\n'
operator|&&
operator|*
name|line_end
operator|!=
literal|'\r'
operator|&&
name|line_end
operator|<
name|end
condition|)
name|line_end
operator|++
expr_stmt|;
operator|*
name|line_end
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|pos
argument_list|,
literal|"IMC "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|error
init|=
literal|0
decl_stmt|;
name|imc
operator|=
name|tncc_parse_imc
argument_list|(
name|pos
operator|+
literal|4
argument_list|,
name|line_end
argument_list|,
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|imc
condition|)
block|{
if|if
condition|(
name|last
operator|==
name|NULL
condition|)
name|tncc
operator|->
name|imc
operator|=
name|imc
expr_stmt|;
else|else
name|last
operator|->
name|next
operator|=
name|imc
expr_stmt|;
name|last
operator|=
name|imc
expr_stmt|;
block|}
block|}
block|}
name|os_free
argument_list|(
name|config
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NATIVE_WINDOWS */
end_comment

begin_function
name|struct
name|tncc_data
modifier|*
name|tncc_init
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|tncc_data
modifier|*
name|tncc
decl_stmt|;
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|;
name|tncc
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|tncc
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tncc
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* TODO: 	 * move loading and Initialize() to a location that is not 	 *    re-initialized for every EAP-TNC session (?) 	 */
if|if
condition|(
name|tncc_read_config
argument_list|(
name|tncc
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to read TNC configuration"
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
for|for
control|(
name|imc
operator|=
name|tncc
operator|->
name|imc
init|;
name|imc
condition|;
name|imc
operator|=
name|imc
operator|->
name|next
control|)
block|{
if|if
condition|(
name|tncc_load_imc
argument_list|(
name|imc
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TNC: Failed to load IMC '%s'"
argument_list|,
name|imc
operator|->
name|name
argument_list|)
expr_stmt|;
goto|goto
name|failed
goto|;
block|}
block|}
return|return
name|tncc
return|;
name|failed
label|:
name|tncc_deinit
argument_list|(
name|tncc
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|tncc_deinit
parameter_list|(
name|struct
name|tncc_data
modifier|*
name|tncc
parameter_list|)
block|{
name|struct
name|tnc_if_imc
modifier|*
name|imc
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
name|imc
operator|=
name|tncc
operator|->
name|imc
expr_stmt|;
while|while
condition|(
name|imc
condition|)
block|{
name|tncc_unload_imc
argument_list|(
name|imc
argument_list|)
expr_stmt|;
name|prev
operator|=
name|imc
expr_stmt|;
name|imc
operator|=
name|imc
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|tncc
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|tncc_build_soh
parameter_list|(
name|int
name|ver
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|tlv_len
decl_stmt|,
modifier|*
name|tlv_len2
decl_stmt|,
modifier|*
name|outer_len
decl_stmt|,
modifier|*
name|inner_len
decl_stmt|,
modifier|*
name|ssoh_len
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|correlation_id
index|[
literal|24
index|]
decl_stmt|;
comment|/* TODO: get correct name */
name|char
modifier|*
name|machinename
init|=
literal|"wpa_supplicant@w1.fi"
decl_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|correlation_id
argument_list|,
sizeof|sizeof
argument_list|(
name|correlation_id
argument_list|)
argument_list|)
condition|)
return|return
name|NULL
return|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: SoH Correlation ID"
argument_list|,
name|correlation_id
argument_list|,
sizeof|sizeof
argument_list|(
name|correlation_id
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* Vendor-Specific TLV (Microsoft) - SoH */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|EAP_TLV_VENDOR_SPECIFIC_TLV
argument_list|)
expr_stmt|;
comment|/* TLV Type */
name|tlv_len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Length */
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|EAP_VENDOR_MICROSOFT
argument_list|)
expr_stmt|;
comment|/* Vendor_Id */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
comment|/* TLV Type - SoH TLV */
name|tlv_len2
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Length */
comment|/* SoH Header */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|EAP_TLV_VENDOR_SPECIFIC_TLV
argument_list|)
expr_stmt|;
comment|/* Outer Type */
name|outer_len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|EAP_VENDOR_MICROSOFT
argument_list|)
expr_stmt|;
comment|/* IANA SMI Code */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|ver
argument_list|)
expr_stmt|;
comment|/* Inner Type */
name|inner_len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ver
operator|==
literal|2
condition|)
block|{
comment|/* SoH Mode Sub-Header */
comment|/* Outer Type */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|EAP_TLV_VENDOR_SPECIFIC_TLV
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|4
operator|+
literal|24
operator|+
literal|1
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* Length */
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|EAP_VENDOR_MICROSOFT
argument_list|)
expr_stmt|;
comment|/* IANA SMI Code */
comment|/* Value: */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|correlation_id
argument_list|,
sizeof|sizeof
argument_list|(
name|correlation_id
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
comment|/* Intent Flag - Request */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* Content-Type Flag */
block|}
comment|/* SSoH TLV */
comment|/* System-Health-Id */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|0x0002
argument_list|)
expr_stmt|;
comment|/* Type */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* Length */
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
literal|79616
argument_list|)
expr_stmt|;
comment|/* Vendor-Specific Attribute */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|EAP_TLV_VENDOR_SPECIFIC_TLV
argument_list|)
expr_stmt|;
name|ssoh_len
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
name|EAP_VENDOR_MICROSOFT
argument_list|)
expr_stmt|;
comment|/* IANA SMI Code */
comment|/* MS-Packet-Info */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|SSOH_MS_PACKET_INFO
argument_list|)
expr_stmt|;
comment|/* Note: IF-TNCCS-SOH v1.0 r8 claims this field to be: 	 * Reserved(4 bits) r(1 bit) Vers(3 bits), but Windows XP 	 * SP3 seems to be sending 0x11 for SSoH, i.e., r(request/response) bit 	 * would not be in the specified location. 	 * [MS-SOH] 4.0.2: Reserved(3 bits) r(1 bit) Vers(4 bits) 	 */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0x11
argument_list|)
expr_stmt|;
comment|/* r=request, vers=1 */
comment|/* MS-Machine-Inventory */
comment|/* TODO: get correct values; 0 = not applicable for OS */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|SSOH_MS_MACHINE_INVENTORY
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* osVersionMajor */
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* osVersionMinor */
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* osVersionBuild */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* spVersionMajor */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* spVersionMinor */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* procArch */
comment|/* MS-MachineName */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|SSOH_MS_MACHINENAME
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
name|os_strlen
argument_list|(
name|machinename
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|machinename
argument_list|,
name|os_strlen
argument_list|(
name|machinename
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* MS-CorrelationId */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|SSOH_MS_CORRELATIONID
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|correlation_id
argument_list|,
sizeof|sizeof
argument_list|(
name|correlation_id
argument_list|)
argument_list|)
expr_stmt|;
comment|/* MS-Quarantine-State */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|SSOH_MS_QUARANTINE_STATE
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Flags: ExtState=0, f=0, qState=1 */
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* ProbTime (hi) */
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
comment|/* ProbTime (lo) */
name|wpabuf_put_be16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* urlLenInBytes */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* null termination for the url */
comment|/* MS-Machine-Inventory-Ex */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|SSOH_MS_MACHINE_INVENTORY_EX
argument_list|)
expr_stmt|;
name|wpabuf_put_be32
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved 				  * (note: Windows XP SP3 uses 0xdecafbad) */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* ProductType: Client */
comment|/* Update SSoH Length */
name|end
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|ssoh_len
argument_list|,
name|end
operator|-
name|ssoh_len
operator|-
literal|2
argument_list|)
expr_stmt|;
comment|/* TODO: SoHReportEntry TLV (zero or more) */
comment|/* Update length fields */
name|end
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|tlv_len
argument_list|,
name|end
operator|-
name|tlv_len
operator|-
literal|2
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|tlv_len2
argument_list|,
name|end
operator|-
name|tlv_len2
operator|-
literal|2
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|outer_len
argument_list|,
name|end
operator|-
name|outer_len
operator|-
literal|2
argument_list|)
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|inner_len
argument_list|,
name|end
operator|-
name|inner_len
operator|-
literal|2
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|tncc_process_soh_request
parameter_list|(
name|int
name|ver
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: SoH Request"
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|12
condition|)
return|return
name|NULL
return|;
comment|/* SoH Request */
name|pos
operator|=
name|data
expr_stmt|;
comment|/* TLV Type */
if|if
condition|(
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
operator|!=
name|EAP_TLV_VENDOR_SPECIFIC_TLV
condition|)
return|return
name|NULL
return|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* Length */
if|if
condition|(
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
operator|<
literal|8
condition|)
return|return
name|NULL
return|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* Vendor_Id */
if|if
condition|(
name|WPA_GET_BE32
argument_list|(
name|pos
argument_list|)
operator|!=
name|EAP_VENDOR_MICROSOFT
condition|)
return|return
name|NULL
return|;
name|pos
operator|+=
literal|4
expr_stmt|;
comment|/* TLV Type */
if|if
condition|(
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
operator|!=
literal|0x02
comment|/* SoH request TLV */
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TNC: SoH Request TLV received"
argument_list|)
expr_stmt|;
return|return
name|tncc_build_soh
argument_list|(
literal|2
argument_list|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * EAP peer method: EAP-SIM (RFC 4186)  * Copyright (c) 2004-2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"pcsc_funcs.h"
end_include

begin_include
include|#
directive|include
file|"crypto/milenage.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap_i.h"
end_include

begin_include
include|#
directive|include
file|"eap_config.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_sim_common.h"
end_include

begin_struct
struct|struct
name|eap_sim_data
block|{
name|u8
modifier|*
name|ver_list
decl_stmt|;
name|size_t
name|ver_list_len
decl_stmt|;
name|int
name|selected_version
decl_stmt|;
name|size_t
name|min_num_chal
decl_stmt|,
name|num_chal
decl_stmt|;
name|u8
name|kc
index|[
literal|3
index|]
index|[
name|EAP_SIM_KC_LEN
index|]
decl_stmt|;
name|u8
name|sres
index|[
literal|3
index|]
index|[
name|EAP_SIM_SRES_LEN
index|]
decl_stmt|;
name|u8
name|nonce_mt
index|[
name|EAP_SIM_NONCE_MT_LEN
index|]
decl_stmt|,
name|nonce_s
index|[
name|EAP_SIM_NONCE_S_LEN
index|]
decl_stmt|;
name|u8
name|mk
index|[
name|EAP_SIM_MK_LEN
index|]
decl_stmt|;
name|u8
name|k_aut
index|[
name|EAP_SIM_K_AUT_LEN
index|]
decl_stmt|;
name|u8
name|k_encr
index|[
name|EAP_SIM_K_ENCR_LEN
index|]
decl_stmt|;
name|u8
name|msk
index|[
name|EAP_SIM_KEYING_DATA_LEN
index|]
decl_stmt|;
name|u8
name|emsk
index|[
name|EAP_EMSK_LEN
index|]
decl_stmt|;
name|u8
name|rand
index|[
literal|3
index|]
index|[
name|GSM_RAND_LEN
index|]
decl_stmt|;
name|int
name|num_id_req
decl_stmt|,
name|num_notification
decl_stmt|;
name|u8
modifier|*
name|pseudonym
decl_stmt|;
name|size_t
name|pseudonym_len
decl_stmt|;
name|u8
modifier|*
name|reauth_id
decl_stmt|;
name|size_t
name|reauth_id_len
decl_stmt|;
name|int
name|reauth
decl_stmt|;
name|unsigned
name|int
name|counter
decl_stmt|,
name|counter_too_small
decl_stmt|;
name|u8
modifier|*
name|last_eap_identity
decl_stmt|;
name|size_t
name|last_eap_identity_len
decl_stmt|;
enum|enum
block|{
name|CONTINUE
block|,
name|RESULT_SUCCESS
block|,
name|RESULT_FAILURE
block|,
name|SUCCESS
block|,
name|FAILURE
block|}
name|state
enum|;
name|int
name|result_ind
decl_stmt|,
name|use_result_ind
decl_stmt|;
block|}
struct|;
end_struct

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_STDOUT_DEBUG
end_ifndef

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|eap_sim_state_txt
parameter_list|(
name|int
name|state
parameter_list|)
block|{
switch|switch
condition|(
name|state
condition|)
block|{
case|case
name|CONTINUE
case|:
return|return
literal|"CONTINUE"
return|;
case|case
name|RESULT_SUCCESS
case|:
return|return
literal|"RESULT_SUCCESS"
return|;
case|case
name|RESULT_FAILURE
case|:
return|return
literal|"RESULT_FAILURE"
return|;
case|case
name|SUCCESS
case|:
return|return
literal|"SUCCESS"
return|;
case|case
name|FAILURE
case|:
return|return
literal|"FAILURE"
return|;
default|default:
return|return
literal|"?"
return|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_STDOUT_DEBUG */
end_comment

begin_function
specifier|static
name|void
name|eap_sim_state
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|state
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: %s -> %s"
argument_list|,
name|eap_sim_state_txt
argument_list|(
name|data
operator|->
name|state
argument_list|)
argument_list|,
name|eap_sim_state_txt
argument_list|(
name|state
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|->
name|state
operator|=
name|state
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|eap_sim_init
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
decl_stmt|;
name|struct
name|eap_peer_config
modifier|*
name|config
init|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
decl_stmt|;
name|data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|os_get_random
argument_list|(
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to get random data "
literal|"for NONCE_MT"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|min_num_chal
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|config
operator|&&
name|config
operator|->
name|phase1
condition|)
block|{
name|char
modifier|*
name|pos
init|=
name|os_strstr
argument_list|(
name|config
operator|->
name|phase1
argument_list|,
literal|"sim_min_num_chal="
argument_list|)
decl_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|data
operator|->
name|min_num_chal
operator|=
name|atoi
argument_list|(
name|pos
operator|+
literal|17
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|min_num_chal
operator|<
literal|2
operator|||
name|data
operator|->
name|min_num_chal
operator|>
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Invalid "
literal|"sim_min_num_chal configuration "
literal|"(%lu, expected 2 or 3)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|data
operator|->
name|min_num_chal
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Set minimum number of "
literal|"challenges to %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|data
operator|->
name|min_num_chal
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|result_ind
operator|=
name|os_strstr
argument_list|(
name|config
operator|->
name|phase1
argument_list|,
literal|"result_ind=1"
argument_list|)
operator|!=
name|NULL
expr_stmt|;
block|}
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|CONTINUE
argument_list|)
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_deinit
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|ver_list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|last_eap_identity
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_gsm_auth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|eap_peer_config
modifier|*
name|conf
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: GSM authentication algorithm"
argument_list|)
expr_stmt|;
name|conf
operator|=
name|eap_get_config
argument_list|(
name|sm
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|conf
operator|->
name|pcsc
condition|)
block|{
if|if
condition|(
name|scard_gsm_auth
argument_list|(
name|sm
operator|->
name|scard_ctx
argument_list|,
name|data
operator|->
name|rand
index|[
literal|0
index|]
argument_list|,
name|data
operator|->
name|sres
index|[
literal|0
index|]
argument_list|,
name|data
operator|->
name|kc
index|[
literal|0
index|]
argument_list|)
operator|||
name|scard_gsm_auth
argument_list|(
name|sm
operator|->
name|scard_ctx
argument_list|,
name|data
operator|->
name|rand
index|[
literal|1
index|]
argument_list|,
name|data
operator|->
name|sres
index|[
literal|1
index|]
argument_list|,
name|data
operator|->
name|kc
index|[
literal|1
index|]
argument_list|)
operator|||
operator|(
name|data
operator|->
name|num_chal
operator|>
literal|2
operator|&&
name|scard_gsm_auth
argument_list|(
name|sm
operator|->
name|scard_ctx
argument_list|,
name|data
operator|->
name|rand
index|[
literal|2
index|]
argument_list|,
name|data
operator|->
name|sres
index|[
literal|2
index|]
argument_list|,
name|data
operator|->
name|kc
index|[
literal|2
index|]
argument_list|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: GSM SIM "
literal|"authentication could not be completed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SIM_SIMULATOR
if|if
condition|(
name|conf
operator|->
name|password
condition|)
block|{
name|u8
name|opc
index|[
literal|16
index|]
decl_stmt|,
name|k
index|[
literal|16
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Use internal GSM-Milenage "
literal|"implementation for authentication"
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|password_len
operator|<
literal|65
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: invalid GSM-Milenage "
literal|"password"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
name|conf
operator|->
name|password
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|k
argument_list|,
literal|16
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
literal|32
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
literal|':'
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|opc
argument_list|,
literal|16
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|num_chal
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|gsm_milenage
argument_list|(
name|opc
argument_list|,
name|k
argument_list|,
name|data
operator|->
name|rand
index|[
name|i
index|]
argument_list|,
name|data
operator|->
name|sres
index|[
name|i
index|]
argument_list|,
name|data
operator|->
name|kc
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: "
literal|"GSM-Milenage authentication "
literal|"could not be completed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: RAND"
argument_list|,
name|data
operator|->
name|rand
index|[
name|i
index|]
argument_list|,
name|GSM_RAND_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: SRES"
argument_list|,
name|data
operator|->
name|sres
index|[
name|i
index|]
argument_list|,
name|EAP_SIM_SRES_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Kc"
argument_list|,
name|data
operator|->
name|kc
index|[
name|i
index|]
argument_list|,
name|EAP_SIM_KC_LEN
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_SIM_SIMULATOR */
ifdef|#
directive|ifdef
name|CONFIG_SIM_HARDCODED
comment|/* These hardcoded Kc and SRES values are used for testing. RAND to 	 * KC/SREC mapping is very bogus as far as real authentication is 	 * concerned, but it is quite useful for cases where the AS is rotating 	 * the order of pre-configured values. */
block|{
name|size_t
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Use hardcoded Kc and SRES "
literal|"values for testing"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|num_chal
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|data
operator|->
name|rand
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|0xaa
condition|)
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|kc
index|[
name|i
index|]
argument_list|,
literal|"\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7"
argument_list|,
name|EAP_SIM_KC_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|sres
index|[
name|i
index|]
argument_list|,
literal|"\xd1\xd2\xd3\xd4"
argument_list|,
name|EAP_SIM_SRES_LEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|rand
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|0xbb
condition|)
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|kc
index|[
name|i
index|]
argument_list|,
literal|"\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7"
argument_list|,
name|EAP_SIM_KC_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|sres
index|[
name|i
index|]
argument_list|,
literal|"\xe1\xe2\xe3\xe4"
argument_list|,
name|EAP_SIM_SRES_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|data
operator|->
name|kc
index|[
name|i
index|]
argument_list|,
literal|"\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7"
argument_list|,
name|EAP_SIM_KC_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|sres
index|[
name|i
index|]
argument_list|,
literal|"\xf1\xf2\xf3\xf4"
argument_list|,
name|EAP_SIM_SRES_LEN
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
literal|0
return|;
else|#
directive|else
comment|/* CONFIG_SIM_HARDCODED */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: No GSM authentication algorithm "
literal|"enabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_SIM_HARDCODED */
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_supported_ver
parameter_list|(
name|int
name|version
parameter_list|)
block|{
return|return
name|version
operator|==
name|EAP_SIM_VERSION
return|;
block|}
end_function

begin_define
define|#
directive|define
name|CLEAR_PSEUDONYM
value|0x01
end_define

begin_define
define|#
directive|define
name|CLEAR_REAUTH_ID
value|0x02
end_define

begin_define
define|#
directive|define
name|CLEAR_EAP_ID
value|0x04
end_define

begin_function
specifier|static
name|void
name|eap_sim_clear_identities
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: forgetting old%s%s%s"
argument_list|,
name|id
operator|&
name|CLEAR_PSEUDONYM
condition|?
literal|" pseudonym"
else|:
literal|""
argument_list|,
name|id
operator|&
name|CLEAR_REAUTH_ID
condition|?
literal|" reauth_id"
else|:
literal|""
argument_list|,
name|id
operator|&
name|CLEAR_EAP_ID
condition|?
literal|" eap_id"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|id
operator|&
name|CLEAR_PSEUDONYM
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|)
expr_stmt|;
name|data
operator|->
name|pseudonym
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|pseudonym_len
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|id
operator|&
name|CLEAR_REAUTH_ID
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth_id
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|reauth_id_len
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|id
operator|&
name|CLEAR_EAP_ID
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|last_eap_identity
argument_list|)
expr_stmt|;
name|data
operator|->
name|last_eap_identity
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|last_eap_identity_len
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_learn_ids
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
if|if
condition|(
name|attr
operator|->
name|next_pseudonym
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|)
expr_stmt|;
name|data
operator|->
name|pseudonym
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|next_pseudonym_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|pseudonym
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: (encr) No memory for "
literal|"next pseudonym"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|pseudonym
argument_list|,
name|attr
operator|->
name|next_pseudonym
argument_list|,
name|attr
operator|->
name|next_pseudonym_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|pseudonym_len
operator|=
name|attr
operator|->
name|next_pseudonym_len
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: (encr) AT_NEXT_PSEUDONYM"
argument_list|,
name|data
operator|->
name|pseudonym
argument_list|,
name|data
operator|->
name|pseudonym_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|->
name|next_reauth_id
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth_id
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|next_reauth_id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: (encr) No memory for "
literal|"next reauth_id"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|reauth_id
argument_list|,
name|attr
operator|->
name|next_reauth_id
argument_list|,
name|attr
operator|->
name|next_reauth_id_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth_id_len
operator|=
name|attr
operator|->
name|next_reauth_id_len
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: (encr) AT_NEXT_REAUTH_ID"
argument_list|,
name|data
operator|->
name|reauth_id
argument_list|,
name|data
operator|->
name|reauth_id_len
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_sim_client_error
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|int
name|err
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_CLIENT_ERROR
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_CLIENT_ERROR_CODE
argument_list|,
name|err
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_sim_response_start
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|enum
name|eap_sim_id_req
name|id_req
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|identity
init|=
name|NULL
decl_stmt|;
name|size_t
name|identity_len
init|=
literal|0
decl_stmt|;
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|data
operator|->
name|reauth
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|id_req
operator|==
name|ANY_ID
operator|&&
name|data
operator|->
name|reauth_id
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|reauth_id
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|reauth_id_len
expr_stmt|;
name|data
operator|->
name|reauth
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|id_req
operator|==
name|ANY_ID
operator|||
name|id_req
operator|==
name|FULLAUTH_ID
operator|)
operator|&&
name|data
operator|->
name|pseudonym
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|pseudonym
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|pseudonym_len
expr_stmt|;
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_REAUTH_ID
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|id_req
operator|!=
name|NO_ID_REQ
condition|)
block|{
name|identity
operator|=
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|identity_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|identity
condition|)
block|{
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_PSEUDONYM
operator||
name|CLEAR_REAUTH_ID
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|id_req
operator|!=
name|NO_ID_REQ
condition|)
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-SIM Start (id=%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_START
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
operator|->
name|reauth
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_NONCE_MT"
argument_list|,
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_NONCE_MT
argument_list|,
literal|0
argument_list|,
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_SELECTED_VERSION %d"
argument_list|,
name|data
operator|->
name|selected_version
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_SELECTED_VERSION
argument_list|,
name|data
operator|->
name|selected_version
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|identity
condition|)
block|{
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IDENTITY"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IDENTITY
argument_list|,
name|identity_len
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
block|}
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_sim_response_challenge
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-SIM Challenge (id=%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_CHALLENGE
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|use_result_ind
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_RESULT_IND"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_RESULT_IND
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|data
operator|->
name|sres
argument_list|,
name|data
operator|->
name|num_chal
operator|*
name|EAP_SIM_SRES_LEN
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_sim_response_reauth
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|int
name|counter_too_small
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|unsigned
name|int
name|counter
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-SIM Reauthentication (id=%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_REAUTHENTICATION
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IV"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_encr_start
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IV
argument_list|,
name|EAP_SIM_AT_ENCR_DATA
argument_list|)
expr_stmt|;
if|if
condition|(
name|counter_too_small
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER_TOO_SMALL"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER_TOO_SMALL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|counter
operator|=
name|data
operator|->
name|counter_too_small
expr_stmt|;
block|}
else|else
name|counter
operator|=
name|data
operator|->
name|counter
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER %d"
argument_list|,
name|counter
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER
argument_list|,
name|counter
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_msg_add_encr_end
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|EAP_SIM_AT_PADDING
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to encrypt "
literal|"AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|data
operator|->
name|use_result_ind
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_RESULT_IND"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_RESULT_IND
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_sim_response_notification
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|u16
name|notification
parameter_list|)
block|{
name|struct
name|eap_sim_msg
modifier|*
name|msg
decl_stmt|;
name|u8
modifier|*
name|k_aut
init|=
operator|(
name|notification
operator|&
literal|0x4000
operator|)
operator|==
literal|0
condition|?
name|data
operator|->
name|k_aut
else|:
name|NULL
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Generating EAP-SIM Notification (id=%d)"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|msg
operator|=
name|eap_sim_msg_init
argument_list|(
name|EAP_CODE_RESPONSE
argument_list|,
name|id
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|EAP_SIM_SUBTYPE_NOTIFICATION
argument_list|)
expr_stmt|;
if|if
condition|(
name|k_aut
operator|&&
name|data
operator|->
name|reauth
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_IV"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_encr_start
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_IV
argument_list|,
name|EAP_SIM_AT_ENCR_DATA
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   *AT_COUNTER %d"
argument_list|,
name|data
operator|->
name|counter
argument_list|)
expr_stmt|;
name|eap_sim_msg_add
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_COUNTER
argument_list|,
name|data
operator|->
name|counter
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_msg_add_encr_end
argument_list|(
name|msg
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|EAP_SIM_AT_PADDING
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to encrypt "
literal|"AT_ENCR_DATA"
argument_list|)
expr_stmt|;
name|eap_sim_msg_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|k_aut
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   AT_MAC"
argument_list|)
expr_stmt|;
name|eap_sim_msg_add_mac
argument_list|(
name|msg
argument_list|,
name|EAP_SIM_AT_MAC
argument_list|)
expr_stmt|;
block|}
return|return
name|eap_sim_msg_finish
argument_list|(
name|msg
argument_list|,
name|k_aut
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_sim_process_start
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|int
name|selected_version
init|=
operator|-
literal|1
decl_stmt|,
name|id_error
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: subtype Start"
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|version_list
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: No AT_VERSION_LIST in "
literal|"SIM/Start"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNSUPPORTED_VERSION
argument_list|)
return|;
block|}
name|os_free
argument_list|(
name|data
operator|->
name|ver_list
argument_list|)
expr_stmt|;
name|data
operator|->
name|ver_list
operator|=
name|os_malloc
argument_list|(
name|attr
operator|->
name|version_list_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|ver_list
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Failed to allocate "
literal|"memory for version list"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|ver_list
argument_list|,
name|attr
operator|->
name|version_list
argument_list|,
name|attr
operator|->
name|version_list_len
argument_list|)
expr_stmt|;
name|data
operator|->
name|ver_list_len
operator|=
name|attr
operator|->
name|version_list_len
expr_stmt|;
name|pos
operator|=
name|data
operator|->
name|ver_list
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|->
name|ver_list_len
operator|/
literal|2
condition|;
name|i
operator|++
control|)
block|{
name|int
name|ver
init|=
name|pos
index|[
literal|0
index|]
operator|*
literal|256
operator|+
name|pos
index|[
literal|1
index|]
decl_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|eap_sim_supported_ver
argument_list|(
name|ver
argument_list|)
condition|)
block|{
name|selected_version
operator|=
name|ver
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|selected_version
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Could not find a supported "
literal|"version"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNSUPPORTED_VERSION
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Selected Version %d"
argument_list|,
name|selected_version
argument_list|)
expr_stmt|;
name|data
operator|->
name|selected_version
operator|=
name|selected_version
expr_stmt|;
name|id_error
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|attr
operator|->
name|id_req
condition|)
block|{
case|case
name|NO_ID_REQ
case|:
break|break;
case|case
name|ANY_ID
case|:
if|if
condition|(
name|data
operator|->
name|num_id_req
operator|>
literal|0
condition|)
name|id_error
operator|++
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|++
expr_stmt|;
break|break;
case|case
name|FULLAUTH_ID
case|:
if|if
condition|(
name|data
operator|->
name|num_id_req
operator|>
literal|1
condition|)
name|id_error
operator|++
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|++
expr_stmt|;
break|break;
case|case
name|PERMANENT_ID
case|:
if|if
condition|(
name|data
operator|->
name|num_id_req
operator|>
literal|2
condition|)
name|id_error
operator|++
expr_stmt|;
name|data
operator|->
name|num_id_req
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|id_error
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Too many ID requests "
literal|"used within one authentication"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
return|return
name|eap_sim_response_start
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|attr
operator|->
name|id_req
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_sim_process_challenge
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|identity
decl_stmt|;
name|size_t
name|identity_len
decl_stmt|;
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: subtype Challenge"
argument_list|)
expr_stmt|;
name|data
operator|->
name|reauth
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|attr
operator|->
name|mac
operator|||
operator|!
name|attr
operator|->
name|rand
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Challenge message "
literal|"did not include%s%s"
argument_list|,
operator|!
name|attr
operator|->
name|mac
condition|?
literal|" AT_MAC"
else|:
literal|""
argument_list|,
operator|!
name|attr
operator|->
name|rand
condition|?
literal|" AT_RAND"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: %lu challenges"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|attr
operator|->
name|num_chal
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|num_chal
operator|<
name|data
operator|->
name|min_num_chal
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Insufficient number of "
literal|"challenges (%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|attr
operator|->
name|num_chal
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_INSUFFICIENT_NUM_OF_CHAL
argument_list|)
return|;
block|}
if|if
condition|(
name|attr
operator|->
name|num_chal
operator|>
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Too many challenges "
literal|"(%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|attr
operator|->
name|num_chal
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
comment|/* Verify that RANDs are different */
if|if
condition|(
name|os_memcmp
argument_list|(
name|attr
operator|->
name|rand
argument_list|,
name|attr
operator|->
name|rand
operator|+
name|GSM_RAND_LEN
argument_list|,
name|GSM_RAND_LEN
argument_list|)
operator|==
literal|0
operator|||
operator|(
name|attr
operator|->
name|num_chal
operator|>
literal|2
operator|&&
operator|(
name|os_memcmp
argument_list|(
name|attr
operator|->
name|rand
argument_list|,
name|attr
operator|->
name|rand
operator|+
literal|2
operator|*
name|GSM_RAND_LEN
argument_list|,
name|GSM_RAND_LEN
argument_list|)
operator|==
literal|0
operator|||
name|os_memcmp
argument_list|(
name|attr
operator|->
name|rand
operator|+
name|GSM_RAND_LEN
argument_list|,
name|attr
operator|->
name|rand
operator|+
literal|2
operator|*
name|GSM_RAND_LEN
argument_list|,
name|GSM_RAND_LEN
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Same RAND used multiple times"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_RAND_NOT_FRESH
argument_list|)
return|;
block|}
name|os_memcpy
argument_list|(
name|data
operator|->
name|rand
argument_list|,
name|attr
operator|->
name|rand
argument_list|,
name|attr
operator|->
name|num_chal
operator|*
name|GSM_RAND_LEN
argument_list|)
expr_stmt|;
name|data
operator|->
name|num_chal
operator|=
name|attr
operator|->
name|num_chal
expr_stmt|;
if|if
condition|(
name|eap_sim_gsm_auth
argument_list|(
name|sm
argument_list|,
name|data
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: GSM authentication failed"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|data
operator|->
name|last_eap_identity
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|last_eap_identity
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|last_eap_identity_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|pseudonym
condition|)
block|{
name|identity
operator|=
name|data
operator|->
name|pseudonym
expr_stmt|;
name|identity_len
operator|=
name|data
operator|->
name|pseudonym_len
expr_stmt|;
block|}
else|else
name|identity
operator|=
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|identity_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Selected identity for MK "
literal|"derivation"
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|)
expr_stmt|;
name|eap_sim_derive_mk
argument_list|(
name|identity
argument_list|,
name|identity_len
argument_list|,
name|data
operator|->
name|nonce_mt
argument_list|,
name|data
operator|->
name|selected_version
argument_list|,
name|data
operator|->
name|ver_list
argument_list|,
name|data
operator|->
name|ver_list_len
argument_list|,
name|data
operator|->
name|num_chal
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|data
operator|->
name|kc
argument_list|,
name|data
operator|->
name|mk
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys
argument_list|(
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|k_encr
argument_list|,
name|data
operator|->
name|k_aut
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|reqData
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Challenge message "
literal|"used invalid AT_MAC"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
comment|/* Old reauthentication and pseudonym identities must not be used 	 * anymore. In other words, if no new identities are received, full 	 * authentication will be used on next reauthentication. */
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_PSEUDONYM
operator||
name|CLEAR_REAUTH_ID
operator||
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|encr_data
condition|)
block|{
name|u8
modifier|*
name|decrypted
decl_stmt|;
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|eap_sim_learn_ids
argument_list|(
name|data
argument_list|,
operator|&
name|eattr
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|->
name|result_ind
operator|&&
name|attr
operator|->
name|result_ind
condition|)
name|data
operator|->
name|use_result_ind
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|FAILURE
operator|&&
name|data
operator|->
name|state
operator|!=
name|RESULT_FAILURE
condition|)
block|{
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|data
operator|->
name|use_result_ind
condition|?
name|RESULT_SUCCESS
else|:
name|SUCCESS
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
comment|/* RFC 4186 specifies that counter is initialized to one after 	 * fullauth, but initializing it to zero makes it easier to implement 	 * reauth verification. */
name|data
operator|->
name|counter
operator|=
literal|0
expr_stmt|;
return|return
name|eap_sim_response_challenge
argument_list|(
name|data
argument_list|,
name|id
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_process_notification_reauth
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|u8
modifier|*
name|decrypted
decl_stmt|;
if|if
condition|(
name|attr
operator|->
name|encr_data
operator|==
name|NULL
operator|||
name|attr
operator|->
name|iv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Notification message after "
literal|"reauth did not include encrypted data"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to parse encrypted "
literal|"data from notification message"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|eattr
operator|.
name|counter
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|eattr
operator|.
name|counter
operator|!=
name|data
operator|->
name|counter
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Counter in notification "
literal|"message does not match with counter in reauth "
literal|"message"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|eap_sim_process_notification_auth
parameter_list|(
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
if|if
condition|(
name|attr
operator|->
name|mac
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: no AT_MAC in after_auth "
literal|"Notification message"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|reqData
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Notification message "
literal|"used invalid AT_MAC"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|data
operator|->
name|reauth
operator|&&
name|eap_sim_process_notification_reauth
argument_list|(
name|data
argument_list|,
name|attr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Invalid notification "
literal|"message after reauth"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_sim_process_notification
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: subtype Notification"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|num_notification
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: too many notification "
literal|"rounds (only one allowed)"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|data
operator|->
name|num_notification
operator|++
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|notification
operator|==
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: no AT_NOTIFICATION in "
literal|"Notification message"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
operator|(
name|attr
operator|->
name|notification
operator|&
literal|0x4000
operator|)
operator|==
literal|0
operator|&&
name|eap_sim_process_notification_auth
argument_list|(
name|data
argument_list|,
name|reqData
argument_list|,
name|attr
argument_list|)
condition|)
block|{
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|eap_sim_report_notification
argument_list|(
name|sm
operator|->
name|msg_ctx
argument_list|,
name|attr
operator|->
name|notification
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|->
name|notification
operator|>=
literal|0
operator|&&
name|attr
operator|->
name|notification
operator|<
literal|32768
condition|)
block|{
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|FAILURE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|attr
operator|->
name|notification
operator|==
name|EAP_SIM_SUCCESS
operator|&&
name|data
operator|->
name|state
operator|==
name|RESULT_SUCCESS
condition|)
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|SUCCESS
argument_list|)
expr_stmt|;
return|return
name|eap_sim_response_notification
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|attr
operator|->
name|notification
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_sim_process_reauthentication
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|struct
name|eap_sim_data
modifier|*
name|data
parameter_list|,
name|u8
name|id
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|,
name|struct
name|eap_sim_attrs
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|eap_sim_attrs
name|eattr
decl_stmt|;
name|u8
modifier|*
name|decrypted
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: subtype Reauthentication"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Server is trying "
literal|"reauthentication, but no reauth_id available"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|data
operator|->
name|reauth
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|eap_sim_verify_mac
argument_list|(
name|data
operator|->
name|k_aut
argument_list|,
name|reqData
argument_list|,
name|attr
operator|->
name|mac
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Reauthentication "
literal|"did not have valid AT_MAC"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|attr
operator|->
name|encr_data
operator|==
name|NULL
operator|||
name|attr
operator|->
name|iv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Reauthentication "
literal|"message did not include encrypted data"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
name|decrypted
operator|=
name|eap_sim_parse_encr
argument_list|(
name|data
operator|->
name|k_encr
argument_list|,
name|attr
operator|->
name|encr_data
argument_list|,
name|attr
operator|->
name|encr_data_len
argument_list|,
name|attr
operator|->
name|iv
argument_list|,
operator|&
name|eattr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|decrypted
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to parse encrypted "
literal|"data from reauthentication message"
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|eattr
operator|.
name|nonce_s
operator|==
name|NULL
operator|||
name|eattr
operator|.
name|counter
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: (encr) No%s%s in reauth packet"
argument_list|,
operator|!
name|eattr
operator|.
name|nonce_s
condition|?
literal|" AT_NONCE_S"
else|:
literal|""
argument_list|,
name|eattr
operator|.
name|counter
operator|<
literal|0
condition|?
literal|" AT_COUNTER"
else|:
literal|""
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
return|;
block|}
if|if
condition|(
name|eattr
operator|.
name|counter
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|eattr
operator|.
name|counter
operator|<=
name|data
operator|->
name|counter
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: (encr) Invalid counter "
literal|"(%d<= %d)"
argument_list|,
name|eattr
operator|.
name|counter
argument_list|,
name|data
operator|->
name|counter
argument_list|)
expr_stmt|;
name|data
operator|->
name|counter_too_small
operator|=
name|eattr
operator|.
name|counter
expr_stmt|;
comment|/* Reply using Re-auth w/ AT_COUNTER_TOO_SMALL. The current 		 * reauth_id must not be used to start a new reauthentication. 		 * However, since it was used in the last EAP-Response-Identity 		 * packet, it has to saved for the following fullauth to be 		 * used in MK derivation. */
name|os_free
argument_list|(
name|data
operator|->
name|last_eap_identity
argument_list|)
expr_stmt|;
name|data
operator|->
name|last_eap_identity
operator|=
name|data
operator|->
name|reauth_id
expr_stmt|;
name|data
operator|->
name|last_eap_identity_len
operator|=
name|data
operator|->
name|reauth_id_len
expr_stmt|;
name|data
operator|->
name|reauth_id
operator|=
name|NULL
expr_stmt|;
name|data
operator|->
name|reauth_id_len
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|eap_sim_response_reauth
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
literal|1
argument_list|)
return|;
block|}
name|data
operator|->
name|counter
operator|=
name|eattr
operator|.
name|counter
expr_stmt|;
name|os_memcpy
argument_list|(
name|data
operator|->
name|nonce_s
argument_list|,
name|eattr
operator|.
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: (encr) AT_NONCE_S"
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|EAP_SIM_NONCE_S_LEN
argument_list|)
expr_stmt|;
name|eap_sim_derive_keys_reauth
argument_list|(
name|data
operator|->
name|counter
argument_list|,
name|data
operator|->
name|reauth_id
argument_list|,
name|data
operator|->
name|reauth_id_len
argument_list|,
name|data
operator|->
name|nonce_s
argument_list|,
name|data
operator|->
name|mk
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|data
operator|->
name|emsk
argument_list|)
expr_stmt|;
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_REAUTH_ID
operator||
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
name|eap_sim_learn_ids
argument_list|(
name|data
argument_list|,
operator|&
name|eattr
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|result_ind
operator|&&
name|attr
operator|->
name|result_ind
condition|)
name|data
operator|->
name|use_result_ind
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|FAILURE
operator|&&
name|data
operator|->
name|state
operator|!=
name|RESULT_FAILURE
condition|)
block|{
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|data
operator|->
name|use_result_ind
condition|?
name|RESULT_SUCCESS
else|:
name|SUCCESS
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|counter
operator|>
name|EAP_SIM_MAX_FAST_REAUTHS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Maximum number of "
literal|"fast reauths performed - force fullauth"
argument_list|)
expr_stmt|;
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_REAUTH_ID
operator||
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|decrypted
argument_list|)
expr_stmt|;
return|return
name|eap_sim_response_reauth
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|eap_sim_process
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|eap_method_ret
modifier|*
name|ret
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|reqData
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
specifier|const
name|struct
name|eap_hdr
modifier|*
name|req
decl_stmt|;
name|u8
name|subtype
decl_stmt|,
name|id
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|res
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|eap_sim_attrs
name|attr
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: EAP data"
argument_list|,
name|reqData
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_get_config_identity
argument_list|(
name|sm
argument_list|,
operator|&
name|len
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"EAP-SIM: Identity not configured"
argument_list|)
expr_stmt|;
name|eap_sm_request_identity
argument_list|(
name|sm
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|eap_hdr_validate
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
name|reqData
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
operator|||
name|len
operator|<
literal|1
condition|)
block|{
name|ret
operator|->
name|ignore
operator|=
name|TRUE
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|req
operator|=
name|wpabuf_head
argument_list|(
name|reqData
argument_list|)
expr_stmt|;
name|id
operator|=
name|req
operator|->
name|identifier
expr_stmt|;
name|len
operator|=
name|be_to_host16
argument_list|(
name|req
operator|->
name|length
argument_list|)
expr_stmt|;
name|ret
operator|->
name|ignore
operator|=
name|FALSE
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_MAY_CONT
expr_stmt|;
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|ret
operator|->
name|allowNotifications
operator|=
name|TRUE
expr_stmt|;
name|subtype
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Subtype=%d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* Reserved */
if|if
condition|(
name|eap_sim_parse_attr
argument_list|(
name|pos
argument_list|,
name|wpabuf_head_u8
argument_list|(
name|reqData
argument_list|)
operator|+
name|len
argument_list|,
operator|&
name|attr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|res
operator|=
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
switch|switch
condition|(
name|subtype
condition|)
block|{
case|case
name|EAP_SIM_SUBTYPE_START
case|:
name|res
operator|=
name|eap_sim_process_start
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_SIM_SUBTYPE_CHALLENGE
case|:
name|res
operator|=
name|eap_sim_process_challenge
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_SIM_SUBTYPE_NOTIFICATION
case|:
name|res
operator|=
name|eap_sim_process_notification
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_SIM_SUBTYPE_REAUTHENTICATION
case|:
name|res
operator|=
name|eap_sim_process_reauthentication
argument_list|(
name|sm
argument_list|,
name|data
argument_list|,
name|id
argument_list|,
name|reqData
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_SIM_SUBTYPE_CLIENT_ERROR
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: subtype Client-Error"
argument_list|)
expr_stmt|;
name|res
operator|=
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-SIM: Unknown subtype=%d"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
name|res
operator|=
name|eap_sim_client_error
argument_list|(
name|data
argument_list|,
name|id
argument_list|,
name|EAP_SIM_UNABLE_TO_PROCESS_PACKET
argument_list|)
expr_stmt|;
break|break;
block|}
name|done
label|:
if|if
condition|(
name|data
operator|->
name|state
operator|==
name|FAILURE
condition|)
block|{
name|ret
operator|->
name|decision
operator|=
name|DECISION_FAIL
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|METHOD_DONE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|state
operator|==
name|SUCCESS
condition|)
block|{
name|ret
operator|->
name|decision
operator|=
name|data
operator|->
name|use_result_ind
condition|?
name|DECISION_UNCOND_SUCC
else|:
name|DECISION_COND_SUCC
expr_stmt|;
name|ret
operator|->
name|methodState
operator|=
name|data
operator|->
name|use_result_ind
condition|?
name|METHOD_DONE
else|:
name|METHOD_MAY_CONT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|state
operator|==
name|RESULT_FAILURE
condition|)
name|ret
operator|->
name|methodState
operator|=
name|METHOD_CONT
expr_stmt|;
elseif|else
if|if
condition|(
name|data
operator|->
name|state
operator|==
name|RESULT_SUCCESS
condition|)
name|ret
operator|->
name|methodState
operator|=
name|METHOD_CONT
expr_stmt|;
if|if
condition|(
name|ret
operator|->
name|methodState
operator|==
name|METHOD_DONE
condition|)
block|{
name|ret
operator|->
name|allowNotifications
operator|=
name|FALSE
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_sim_has_reauth_data
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|pseudonym
operator|||
name|data
operator|->
name|reauth_id
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|eap_sim_deinit_for_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|eap_sim_clear_identities
argument_list|(
name|data
argument_list|,
name|CLEAR_EAP_ID
argument_list|)
expr_stmt|;
name|data
operator|->
name|use_result_ind
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|eap_sim_init_for_reauth
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|data
operator|->
name|nonce_mt
argument_list|,
name|EAP_SIM_NONCE_MT_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"EAP-SIM: Failed to get random data "
literal|"for NONCE_MT"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|->
name|num_id_req
operator|=
literal|0
expr_stmt|;
name|data
operator|->
name|num_notification
operator|=
literal|0
expr_stmt|;
name|eap_sim_state
argument_list|(
name|data
argument_list|,
name|CONTINUE
argument_list|)
expr_stmt|;
return|return
name|priv
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|eap_sim_get_identity
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|reauth_id
condition|)
block|{
operator|*
name|len
operator|=
name|data
operator|->
name|reauth_id_len
expr_stmt|;
return|return
name|data
operator|->
name|reauth_id
return|;
block|}
if|if
condition|(
name|data
operator|->
name|pseudonym
condition|)
block|{
operator|*
name|len
operator|=
name|data
operator|->
name|pseudonym_len
expr_stmt|;
return|return
name|data
operator|->
name|pseudonym
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|Boolean
name|eap_sim_isKeyAvailable
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
return|return
name|data
operator|->
name|state
operator|==
name|SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_getKey
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|SUCCESS
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|os_malloc
argument_list|(
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|len
operator|=
name|EAP_SIM_KEYING_DATA_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|msk
argument_list|,
name|EAP_SIM_KEYING_DATA_LEN
argument_list|)
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|eap_sim_get_emsk
parameter_list|(
name|struct
name|eap_sm
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|priv
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|struct
name|eap_sim_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|u8
modifier|*
name|key
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|state
operator|!=
name|SUCCESS
condition|)
return|return
name|NULL
return|;
name|key
operator|=
name|os_malloc
argument_list|(
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|key
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
operator|*
name|len
operator|=
name|EAP_EMSK_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|key
argument_list|,
name|data
operator|->
name|emsk
argument_list|,
name|EAP_EMSK_LEN
argument_list|)
expr_stmt|;
return|return
name|key
return|;
block|}
end_function

begin_function
name|int
name|eap_peer_sim_register
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|eap_method
modifier|*
name|eap
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|eap
operator|=
name|eap_peer_method_alloc
argument_list|(
name|EAP_PEER_METHOD_INTERFACE_VERSION
argument_list|,
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_SIM
argument_list|,
literal|"SIM"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|eap
operator|->
name|init
operator|=
name|eap_sim_init
expr_stmt|;
name|eap
operator|->
name|deinit
operator|=
name|eap_sim_deinit
expr_stmt|;
name|eap
operator|->
name|process
operator|=
name|eap_sim_process
expr_stmt|;
name|eap
operator|->
name|isKeyAvailable
operator|=
name|eap_sim_isKeyAvailable
expr_stmt|;
name|eap
operator|->
name|getKey
operator|=
name|eap_sim_getKey
expr_stmt|;
name|eap
operator|->
name|has_reauth_data
operator|=
name|eap_sim_has_reauth_data
expr_stmt|;
name|eap
operator|->
name|deinit_for_reauth
operator|=
name|eap_sim_deinit_for_reauth
expr_stmt|;
name|eap
operator|->
name|init_for_reauth
operator|=
name|eap_sim_init_for_reauth
expr_stmt|;
name|eap
operator|->
name|get_identity
operator|=
name|eap_sim_get_identity
expr_stmt|;
name|eap
operator|->
name|get_emsk
operator|=
name|eap_sim_get_emsk
expr_stmt|;
name|ret
operator|=
name|eap_peer_method_register
argument_list|(
name|eap
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|eap_peer_method_free
argument_list|(
name|eap
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


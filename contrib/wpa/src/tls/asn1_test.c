begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Testing tool for ASN.1/X.509v3 routines  * Copyright (c) 2006, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"asn1.h"
end_include

begin_include
include|#
directive|include
file|"x509v3.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|asn1_class_str
parameter_list|(
name|int
name|class
parameter_list|)
block|{
switch|switch
condition|(
name|class
condition|)
block|{
case|case
name|ASN1_CLASS_UNIVERSAL
case|:
return|return
literal|"Universal"
return|;
case|case
name|ASN1_CLASS_APPLICATION
case|:
return|return
literal|"Application"
return|;
case|case
name|ASN1_CLASS_CONTEXT_SPECIFIC
case|:
return|return
literal|"Context-specific"
return|;
case|case
name|ASN1_CLASS_PRIVATE
case|:
return|return
literal|"Private"
return|;
default|default:
return|return
literal|"?"
return|;
block|}
block|}
end_function

begin_function
name|int
name|asn1_parse
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|level
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|prev
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|char
name|prefix
index|[
literal|10
index|]
decl_stmt|,
name|str
index|[
literal|100
index|]
decl_stmt|;
name|int
name|_level
decl_stmt|;
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
name|struct
name|asn1_oid
name|oid
decl_stmt|;
name|u8
name|tmp
decl_stmt|;
name|_level
operator|=
name|level
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
name|_level
operator|>
sizeof|sizeof
argument_list|(
name|prefix
argument_list|)
operator|-
literal|1
condition|)
name|_level
operator|=
sizeof|sizeof
argument_list|(
name|prefix
argument_list|)
operator|-
literal|1
expr_stmt|;
name|memset
argument_list|(
name|prefix
argument_list|,
literal|' '
argument_list|,
name|_level
argument_list|)
expr_stmt|;
name|prefix
index|[
name|_level
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|len
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|prev
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1:%s Class %d(%s) P/C %d(%s) "
literal|"Tag %u Length %u"
argument_list|,
name|prefix
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|asn1_class_str
argument_list|(
name|hdr
operator|.
name|class
argument_list|)
argument_list|,
name|hdr
operator|.
name|constructed
argument_list|,
name|hdr
operator|.
name|constructed
condition|?
literal|"Constructed"
else|:
literal|"Primitive"
argument_list|,
name|hdr
operator|.
name|tag
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|class
operator|==
name|ASN1_CLASS_CONTEXT_SPECIFIC
operator|&&
name|hdr
operator|.
name|constructed
condition|)
block|{
if|if
condition|(
name|asn1_parse
argument_list|(
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|,
name|level
operator|+
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
block|}
if|if
condition|(
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
condition|)
continue|continue;
switch|switch
condition|(
name|hdr
operator|.
name|tag
condition|)
block|{
case|case
name|ASN1_TAG_EOC
case|:
if|if
condition|(
name|hdr
operator|.
name|length
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ASN.1: Non-zero "
literal|"end-of-contents length (%u)"
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1:%s EOC"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_BOOLEAN
case|:
if|if
condition|(
name|hdr
operator|.
name|length
operator|!=
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ASN.1: Unexpected "
literal|"Boolean length (%u)"
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tmp
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1:%s Boolean %s"
argument_list|,
name|prefix
argument_list|,
name|tmp
condition|?
literal|"TRUE"
else|:
literal|"FALSE"
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_INTEGER
case|:
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1: INTEGER"
argument_list|,
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_BITSTRING
case|:
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1: BitString"
argument_list|,
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_OCTETSTRING
case|:
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1: OctetString"
argument_list|,
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_NULL
case|:
if|if
condition|(
name|hdr
operator|.
name|length
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ASN.1: Non-zero Null "
literal|"length (%u)"
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1:%s Null"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_OID
case|:
if|if
condition|(
name|asn1_get_oid
argument_list|(
name|prev
argument_list|,
name|end
operator|-
name|prev
argument_list|,
operator|&
name|oid
argument_list|,
operator|&
name|prev
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ASN.1: Invalid OID"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|asn1_oid_to_str
argument_list|(
operator|&
name|oid
argument_list|,
name|str
argument_list|,
sizeof|sizeof
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ASN.1:%s OID %s"
argument_list|,
name|prefix
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|ANS1_TAG_RELATIVE_OID
case|:
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1: Relative OID"
argument_list|,
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_SEQUENCE
case|:
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1:%s SEQUENCE"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|asn1_parse
argument_list|(
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|,
name|level
operator|+
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_SET
case|:
name|wpa_printf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1:%s SET"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
if|if
condition|(
name|asn1_parse
argument_list|(
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|,
name|level
operator|+
literal|1
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_PRINTABLESTRING
case|:
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1: PrintableString"
argument_list|,
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_IA5STRING
case|:
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1: IA5String"
argument_list|,
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_UTCTIME
case|:
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1: UTCTIME"
argument_list|,
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
case|case
name|ASN1_TAG_VISIBLESTRING
case|:
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ASN.1: VisibleString"
argument_list|,
name|pos
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|hdr
operator|.
name|length
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ASN.1: Unknown tag %d"
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|u8
name|buf
index|[
literal|3000
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|x509_certificate
modifier|*
name|cert
decl_stmt|;
name|wpa_debug_level
operator|=
literal|0
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|,
literal|"rb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|len
operator|=
name|fread
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
if|if
condition|(
name|asn1_parse
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|printf
argument_list|(
literal|"Failed to parse DER ASN.1\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
name|cert
operator|=
name|x509_certificate_parse
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
name|printf
argument_list|(
literal|"Failed to parse X.509 certificate\n"
argument_list|)
expr_stmt|;
name|x509_certificate_free
argument_list|(
name|cert
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


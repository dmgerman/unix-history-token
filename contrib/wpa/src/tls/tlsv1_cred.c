begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * TLSv1 credentials  * Copyright (c) 2006-2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"base64.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"x509v3.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_cred.h"
end_include

begin_function
name|struct
name|tlsv1_credentials
modifier|*
name|tlsv1_cred_alloc
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|tlsv1_credentials
modifier|*
name|cred
decl_stmt|;
name|cred
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cred
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|cred
return|;
block|}
end_function

begin_function
name|void
name|tlsv1_cred_free
parameter_list|(
name|struct
name|tlsv1_credentials
modifier|*
name|cred
parameter_list|)
block|{
if|if
condition|(
name|cred
operator|==
name|NULL
condition|)
return|return;
name|x509_certificate_chain_free
argument_list|(
name|cred
operator|->
name|trusted_certs
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|cred
operator|->
name|cert
argument_list|)
expr_stmt|;
name|crypto_private_key_free
argument_list|(
name|cred
operator|->
name|key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cred
operator|->
name|dh_p
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cred
operator|->
name|dh_g
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cred
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|tlsv1_add_cert_der
parameter_list|(
name|struct
name|x509_certificate
modifier|*
modifier|*
name|chain
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|x509_certificate
modifier|*
name|cert
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|char
name|name
index|[
literal|128
index|]
decl_stmt|;
name|cert
operator|=
name|x509_certificate_parse
argument_list|(
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: %s - failed to parse certificate"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p
operator|=
operator|*
name|chain
expr_stmt|;
while|while
condition|(
name|p
operator|&&
name|p
operator|->
name|next
condition|)
name|p
operator|=
name|p
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|p
operator|&&
name|x509_name_compare
argument_list|(
operator|&
name|cert
operator|->
name|subject
argument_list|,
operator|&
name|p
operator|->
name|issuer
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* 		 * The new certificate is the issuer of the last certificate in 		 * the chain - add the new certificate to the end. 		 */
name|p
operator|->
name|next
operator|=
name|cert
expr_stmt|;
block|}
else|else
block|{
comment|/* Add to the beginning of the chain */
name|cert
operator|->
name|next
operator|=
operator|*
name|chain
expr_stmt|;
operator|*
name|chain
operator|=
name|cert
expr_stmt|;
block|}
name|x509_name_string
argument_list|(
operator|&
name|cert
operator|->
name|subject
argument_list|,
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Added certificate: %s"
argument_list|,
name|name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pem_cert_begin
init|=
literal|"-----BEGIN CERTIFICATE-----"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pem_cert_end
init|=
literal|"-----END CERTIFICATE-----"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pem_key_begin
init|=
literal|"-----BEGIN RSA PRIVATE KEY-----"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pem_key_end
init|=
literal|"-----END RSA PRIVATE KEY-----"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pem_key2_begin
init|=
literal|"-----BEGIN PRIVATE KEY-----"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pem_key2_end
init|=
literal|"-----END PRIVATE KEY-----"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pem_key_enc_begin
init|=
literal|"-----BEGIN ENCRYPTED PRIVATE KEY-----"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pem_key_enc_end
init|=
literal|"-----END ENCRYPTED PRIVATE KEY-----"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|search_tag
parameter_list|(
specifier|const
name|char
modifier|*
name|tag
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|plen
decl_stmt|;
name|plen
operator|=
name|os_strlen
argument_list|(
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|<
name|plen
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
operator|-
name|plen
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|buf
operator|+
name|i
argument_list|,
name|tag
argument_list|,
name|plen
argument_list|)
operator|==
literal|0
condition|)
return|return
name|buf
operator|+
name|i
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tlsv1_add_cert
parameter_list|(
name|struct
name|x509_certificate
modifier|*
modifier|*
name|chain
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|unsigned
name|char
modifier|*
name|der
decl_stmt|;
name|size_t
name|der_len
decl_stmt|;
name|pos
operator|=
name|search_tag
argument_list|(
name|pem_cert_begin
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: No PEM certificate tag found - "
literal|"assume DER format"
argument_list|)
expr_stmt|;
return|return
name|tlsv1_add_cert_der
argument_list|(
name|chain
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Converting PEM format certificate into "
literal|"DER format"
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
condition|)
block|{
name|pos
operator|+=
name|os_strlen
argument_list|(
name|pem_cert_begin
argument_list|)
expr_stmt|;
name|end
operator|=
name|search_tag
argument_list|(
name|pem_cert_end
argument_list|,
name|pos
argument_list|,
name|buf
operator|+
name|len
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Could not find PEM "
literal|"certificate end tag (%s)"
argument_list|,
name|pem_cert_end
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|der
operator|=
name|base64_decode
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|der_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|der
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Could not decode PEM "
literal|"certificate"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tlsv1_add_cert_der
argument_list|(
name|chain
argument_list|,
name|der
argument_list|,
name|der_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Failed to parse PEM "
literal|"certificate after DER conversion"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|der
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|der
argument_list|)
expr_stmt|;
name|end
operator|+=
name|os_strlen
argument_list|(
name|pem_cert_end
argument_list|)
expr_stmt|;
name|pos
operator|=
name|search_tag
argument_list|(
name|pem_cert_begin
argument_list|,
name|end
argument_list|,
name|buf
operator|+
name|len
operator|-
name|end
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tlsv1_set_cert_chain
parameter_list|(
name|struct
name|x509_certificate
modifier|*
modifier|*
name|chain
parameter_list|,
specifier|const
name|char
modifier|*
name|cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|cert_blob
parameter_list|,
name|size_t
name|cert_blob_len
parameter_list|)
block|{
if|if
condition|(
name|cert_blob
condition|)
return|return
name|tlsv1_add_cert
argument_list|(
name|chain
argument_list|,
name|cert_blob
argument_list|,
name|cert_blob_len
argument_list|)
return|;
if|if
condition|(
name|cert
condition|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|buf
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_readfile
argument_list|(
name|cert
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Failed to read '%s'"
argument_list|,
name|cert
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|tlsv1_add_cert
argument_list|(
name|chain
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * tlsv1_set_ca_cert - Set trusted CA certificate(s)  * @cred: TLSv1 credentials from tlsv1_cred_alloc()  * @cert: File or reference name for X.509 certificate in PEM or DER format  * @cert_blob: cert as inlined data or %NULL if not used  * @cert_blob_len: ca_cert_blob length  * @path: Path to CA certificates (not yet supported)  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|tlsv1_set_ca_cert
parameter_list|(
name|struct
name|tlsv1_credentials
modifier|*
name|cred
parameter_list|,
specifier|const
name|char
modifier|*
name|cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|cert_blob
parameter_list|,
name|size_t
name|cert_blob_len
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
if|if
condition|(
name|tlsv1_set_cert_chain
argument_list|(
operator|&
name|cred
operator|->
name|trusted_certs
argument_list|,
name|cert
argument_list|,
name|cert_blob
argument_list|,
name|cert_blob_len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|path
condition|)
block|{
comment|/* TODO: add support for reading number of certificate files */
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Use of CA certificate directory "
literal|"not yet supported"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * tlsv1_set_cert - Set certificate  * @cred: TLSv1 credentials from tlsv1_cred_alloc()  * @cert: File or reference name for X.509 certificate in PEM or DER format  * @cert_blob: cert as inlined data or %NULL if not used  * @cert_blob_len: cert_blob length  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|tlsv1_set_cert
parameter_list|(
name|struct
name|tlsv1_credentials
modifier|*
name|cred
parameter_list|,
specifier|const
name|char
modifier|*
name|cert
parameter_list|,
specifier|const
name|u8
modifier|*
name|cert_blob
parameter_list|,
name|size_t
name|cert_blob_len
parameter_list|)
block|{
return|return
name|tlsv1_set_cert_chain
argument_list|(
operator|&
name|cred
operator|->
name|cert
argument_list|,
name|cert
argument_list|,
name|cert_blob
argument_list|,
name|cert_blob_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|crypto_private_key
modifier|*
name|tlsv1_set_key_pem
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|unsigned
name|char
modifier|*
name|der
decl_stmt|;
name|size_t
name|der_len
decl_stmt|;
name|struct
name|crypto_private_key
modifier|*
name|pkey
decl_stmt|;
name|pos
operator|=
name|search_tag
argument_list|(
name|pem_key_begin
argument_list|,
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
block|{
name|pos
operator|=
name|search_tag
argument_list|(
name|pem_key2_begin
argument_list|,
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
return|return
name|NULL
return|;
name|pos
operator|+=
name|os_strlen
argument_list|(
name|pem_key2_begin
argument_list|)
expr_stmt|;
name|end
operator|=
name|search_tag
argument_list|(
name|pem_key2_end
argument_list|,
name|pos
argument_list|,
name|key
operator|+
name|len
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|end
condition|)
return|return
name|NULL
return|;
block|}
else|else
block|{
specifier|const
name|u8
modifier|*
name|pos2
decl_stmt|;
name|pos
operator|+=
name|os_strlen
argument_list|(
name|pem_key_begin
argument_list|)
expr_stmt|;
name|end
operator|=
name|search_tag
argument_list|(
name|pem_key_end
argument_list|,
name|pos
argument_list|,
name|key
operator|+
name|len
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|end
condition|)
return|return
name|NULL
return|;
name|pos2
operator|=
name|search_tag
argument_list|(
literal|"Proc-Type: 4,ENCRYPTED"
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Unsupported private key "
literal|"format (Proc-Type/DEK-Info)"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|der
operator|=
name|base64_decode
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|der_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|der
condition|)
return|return
name|NULL
return|;
name|pkey
operator|=
name|crypto_private_key_import
argument_list|(
name|der
argument_list|,
name|der_len
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|der
argument_list|)
expr_stmt|;
return|return
name|pkey
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|crypto_private_key
modifier|*
name|tlsv1_set_key_enc_pem
parameter_list|(
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|unsigned
name|char
modifier|*
name|der
decl_stmt|;
name|size_t
name|der_len
decl_stmt|;
name|struct
name|crypto_private_key
modifier|*
name|pkey
decl_stmt|;
if|if
condition|(
name|passwd
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|search_tag
argument_list|(
name|pem_key_enc_begin
argument_list|,
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
return|return
name|NULL
return|;
name|pos
operator|+=
name|os_strlen
argument_list|(
name|pem_key_enc_begin
argument_list|)
expr_stmt|;
name|end
operator|=
name|search_tag
argument_list|(
name|pem_key_enc_end
argument_list|,
name|pos
argument_list|,
name|key
operator|+
name|len
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|end
condition|)
return|return
name|NULL
return|;
name|der
operator|=
name|base64_decode
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|der_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|der
condition|)
return|return
name|NULL
return|;
name|pkey
operator|=
name|crypto_private_key_import
argument_list|(
name|der
argument_list|,
name|der_len
argument_list|,
name|passwd
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|der
argument_list|)
expr_stmt|;
return|return
name|pkey
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tlsv1_set_key
parameter_list|(
name|struct
name|tlsv1_credentials
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
name|cred
operator|->
name|key
operator|=
name|crypto_private_key_import
argument_list|(
name|key
argument_list|,
name|len
argument_list|,
name|passwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|key
operator|==
name|NULL
condition|)
name|cred
operator|->
name|key
operator|=
name|tlsv1_set_key_pem
argument_list|(
name|key
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|key
operator|==
name|NULL
condition|)
name|cred
operator|->
name|key
operator|=
name|tlsv1_set_key_enc_pem
argument_list|(
name|key
argument_list|,
name|len
argument_list|,
name|passwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|key
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Failed to parse private key"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * tlsv1_set_private_key - Set private key  * @cred: TLSv1 credentials from tlsv1_cred_alloc()  * @private_key: File or reference name for the key in PEM or DER format  * @private_key_passwd: Passphrase for decrypted private key, %NULL if no  * passphrase is used.  * @private_key_blob: private_key as inlined data or %NULL if not used  * @private_key_blob_len: private_key_blob length  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|tlsv1_set_private_key
parameter_list|(
name|struct
name|tlsv1_credentials
modifier|*
name|cred
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key
parameter_list|,
specifier|const
name|char
modifier|*
name|private_key_passwd
parameter_list|,
specifier|const
name|u8
modifier|*
name|private_key_blob
parameter_list|,
name|size_t
name|private_key_blob_len
parameter_list|)
block|{
name|crypto_private_key_free
argument_list|(
name|cred
operator|->
name|key
argument_list|)
expr_stmt|;
name|cred
operator|->
name|key
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|private_key_blob
condition|)
return|return
name|tlsv1_set_key
argument_list|(
name|cred
argument_list|,
name|private_key_blob
argument_list|,
name|private_key_blob_len
argument_list|,
name|private_key_passwd
argument_list|)
return|;
if|if
condition|(
name|private_key
condition|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|buf
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_readfile
argument_list|(
name|private_key
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Failed to read '%s'"
argument_list|,
name|private_key
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|tlsv1_set_key
argument_list|(
name|cred
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|private_key_passwd
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tlsv1_set_dhparams_der
parameter_list|(
name|struct
name|tlsv1_credentials
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|dh
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|pos
operator|=
name|dh
expr_stmt|;
name|end
operator|=
name|dh
operator|+
name|len
expr_stmt|;
comment|/* 	 * DHParameter ::= SEQUENCE { 	 *   prime INTEGER, -- p 	 *   base INTEGER, -- g 	 *   privateValueLength INTEGER OPTIONAL } 	 */
comment|/* DHParamer ::= SEQUENCE */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DH: DH parameters did not start with a "
literal|"valid SEQUENCE - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
comment|/* prime INTEGER */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_INTEGER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DH: No INTEGER tag found for p; "
literal|"class=%d tag=0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"DH: prime (p)"
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|length
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|os_free
argument_list|(
name|cred
operator|->
name|dh_p
argument_list|)
expr_stmt|;
name|cred
operator|->
name|dh_p
operator|=
name|os_malloc
argument_list|(
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|dh_p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|cred
operator|->
name|dh_p
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|cred
operator|->
name|dh_p_len
operator|=
name|hdr
operator|.
name|length
expr_stmt|;
name|pos
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
comment|/* base INTEGER */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_INTEGER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DH: No INTEGER tag found for g; "
literal|"class=%d tag=0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"DH: base (g)"
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|hdr
operator|.
name|length
operator|==
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|os_free
argument_list|(
name|cred
operator|->
name|dh_g
argument_list|)
expr_stmt|;
name|cred
operator|->
name|dh_g
operator|=
name|os_malloc
argument_list|(
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|dh_g
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|cred
operator|->
name|dh_g
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|cred
operator|->
name|dh_g_len
operator|=
name|hdr
operator|.
name|length
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pem_dhparams_begin
init|=
literal|"-----BEGIN DH PARAMETERS-----"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|pem_dhparams_end
init|=
literal|"-----END DH PARAMETERS-----"
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|tlsv1_set_dhparams_blob
parameter_list|(
name|struct
name|tlsv1_credentials
modifier|*
name|cred
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|unsigned
name|char
modifier|*
name|der
decl_stmt|;
name|size_t
name|der_len
decl_stmt|;
name|pos
operator|=
name|search_tag
argument_list|(
name|pem_dhparams_begin
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: No PEM dhparams tag found - "
literal|"assume DER format"
argument_list|)
expr_stmt|;
return|return
name|tlsv1_set_dhparams_der
argument_list|(
name|cred
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Converting PEM format dhparams into DER "
literal|"format"
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|os_strlen
argument_list|(
name|pem_dhparams_begin
argument_list|)
expr_stmt|;
name|end
operator|=
name|search_tag
argument_list|(
name|pem_dhparams_end
argument_list|,
name|pos
argument_list|,
name|buf
operator|+
name|len
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Could not find PEM dhparams end "
literal|"tag (%s)"
argument_list|,
name|pem_dhparams_end
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|der
operator|=
name|base64_decode
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|der_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|der
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Could not decode PEM dhparams"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tlsv1_set_dhparams_der
argument_list|(
name|cred
argument_list|,
name|der
argument_list|,
name|der_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Failed to parse PEM dhparams "
literal|"DER conversion"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|der
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|der
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * tlsv1_set_dhparams - Set Diffie-Hellman parameters  * @cred: TLSv1 credentials from tlsv1_cred_alloc()  * @dh_file: File or reference name for the DH params in PEM or DER format  * @dh_blob: DH params as inlined data or %NULL if not used  * @dh_blob_len: dh_blob length  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|tlsv1_set_dhparams
parameter_list|(
name|struct
name|tlsv1_credentials
modifier|*
name|cred
parameter_list|,
specifier|const
name|char
modifier|*
name|dh_file
parameter_list|,
specifier|const
name|u8
modifier|*
name|dh_blob
parameter_list|,
name|size_t
name|dh_blob_len
parameter_list|)
block|{
if|if
condition|(
name|dh_blob
condition|)
return|return
name|tlsv1_set_dhparams_blob
argument_list|(
name|cred
argument_list|,
name|dh_blob
argument_list|,
name|dh_blob_len
argument_list|)
return|;
if|if
condition|(
name|dh_file
condition|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|buf
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_readfile
argument_list|(
name|dh_file
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Failed to read '%s'"
argument_list|,
name|dh_file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|tlsv1_set_dhparams_blob
argument_list|(
name|cred
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


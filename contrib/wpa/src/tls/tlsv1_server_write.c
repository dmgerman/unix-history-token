begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * TLSv1 server - write handshake message  * Copyright (c) 2006-2007, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"md5.h"
end_include

begin_include
include|#
directive|include
file|"sha1.h"
end_include

begin_include
include|#
directive|include
file|"x509v3.h"
end_include

begin_include
include|#
directive|include
file|"tls.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_common.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_record.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_server.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_server_i.h"
end_include

begin_function
specifier|static
name|size_t
name|tls_server_cert_chain_der_len
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|)
block|{
name|size_t
name|len
init|=
literal|0
decl_stmt|;
name|struct
name|x509_certificate
modifier|*
name|cert
decl_stmt|;
name|cert
operator|=
name|conn
operator|->
name|cred
operator|->
name|cert
expr_stmt|;
while|while
condition|(
name|cert
condition|)
block|{
name|len
operator|+=
literal|3
operator|+
name|cert
operator|->
name|cert_len
expr_stmt|;
if|if
condition|(
name|x509_certificate_self_signed
argument_list|(
name|cert
argument_list|)
condition|)
break|break;
name|cert
operator|=
name|x509_certificate_get_subject
argument_list|(
name|conn
operator|->
name|cred
operator|->
name|trusted_certs
argument_list|,
operator|&
name|cert
operator|->
name|issuer
argument_list|)
expr_stmt|;
block|}
return|return
name|len
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_write_server_hello
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
modifier|*
modifier|*
name|msgpos
parameter_list|,
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|rhdr
decl_stmt|,
modifier|*
name|hs_start
decl_stmt|,
modifier|*
name|hs_length
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
name|pos
operator|=
operator|*
name|msgpos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Send ServerHello"
argument_list|)
expr_stmt|;
name|rhdr
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|TLS_RECORD_HEADER_LEN
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|WPA_PUT_BE32
argument_list|(
name|conn
operator|->
name|server_random
argument_list|,
name|now
operator|.
name|sec
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|conn
operator|->
name|server_random
operator|+
literal|4
argument_list|,
name|TLS_RANDOM_LEN
operator|-
literal|4
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TLSv1: Could not generate "
literal|"server_random"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: server_random"
argument_list|,
name|conn
operator|->
name|server_random
argument_list|,
name|TLS_RANDOM_LEN
argument_list|)
expr_stmt|;
name|conn
operator|->
name|session_id_len
operator|=
name|TLS_SESSION_ID_MAX_LEN
expr_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|conn
operator|->
name|session_id
argument_list|,
name|conn
operator|->
name|session_id_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"TLSv1: Could not generate "
literal|"session_id"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: session_id"
argument_list|,
name|conn
operator|->
name|session_id
argument_list|,
name|conn
operator|->
name|session_id_len
argument_list|)
expr_stmt|;
comment|/* opaque fragment[TLSPlaintext.length] */
comment|/* Handshake */
name|hs_start
operator|=
name|pos
expr_stmt|;
comment|/* HandshakeType msg_type */
operator|*
name|pos
operator|++
operator|=
name|TLS_HANDSHAKE_TYPE_SERVER_HELLO
expr_stmt|;
comment|/* uint24 length (to be filled) */
name|hs_length
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
comment|/* body - ServerHello */
comment|/* ProtocolVersion server_version */
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|TLS_VERSION
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* Random random: uint32 gmt_unix_time, opaque random_bytes */
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|conn
operator|->
name|server_random
argument_list|,
name|TLS_RANDOM_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|TLS_RANDOM_LEN
expr_stmt|;
comment|/* SessionID session_id */
operator|*
name|pos
operator|++
operator|=
name|conn
operator|->
name|session_id_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|conn
operator|->
name|session_id
argument_list|,
name|conn
operator|->
name|session_id_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|conn
operator|->
name|session_id_len
expr_stmt|;
comment|/* CipherSuite cipher_suite */
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|conn
operator|->
name|cipher_suite
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* CompressionMethod compression_method */
operator|*
name|pos
operator|++
operator|=
name|TLS_COMPRESSION_NULL
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|session_ticket
operator|&&
name|conn
operator|->
name|session_ticket_cb
condition|)
block|{
name|int
name|res
init|=
name|conn
operator|->
name|session_ticket_cb
argument_list|(
name|conn
operator|->
name|session_ticket_cb_ctx
argument_list|,
name|conn
operator|->
name|session_ticket
argument_list|,
name|conn
operator|->
name|session_ticket_len
argument_list|,
name|conn
operator|->
name|client_random
argument_list|,
name|conn
operator|->
name|server_random
argument_list|,
name|conn
operator|->
name|master_secret
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: SessionTicket callback "
literal|"indicated failure"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_HANDSHAKE_FAILURE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|use_session_ticket
operator|=
name|res
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|use_session_ticket
condition|)
block|{
if|if
condition|(
name|tlsv1_server_derive_keys
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to "
literal|"derive keys"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
comment|/* 		 * RFC 4507 specifies that server would include an empty 		 * SessionTicket extension in ServerHello and a 		 * NewSessionTicket message after the ServerHello. However, 		 * EAP-FAST (RFC 4851), i.e., the only user of SessionTicket 		 * extension at the moment, does not use such extensions. 		 * 		 * TODO: Add support for configuring RFC 4507 behavior and make 		 * EAP-FAST disable it. 		 */
block|}
name|WPA_PUT_BE24
argument_list|(
name|hs_length
argument_list|,
name|pos
operator|-
name|hs_length
operator|-
literal|3
argument_list|)
expr_stmt|;
name|tls_verify_hash_add
argument_list|(
operator|&
name|conn
operator|->
name|verify
argument_list|,
name|hs_start
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlsv1_record_send
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|,
name|TLS_CONTENT_TYPE_HANDSHAKE
argument_list|,
name|rhdr
argument_list|,
name|end
operator|-
name|rhdr
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|,
operator|&
name|rlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to create TLS record"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|rhdr
operator|+
name|rlen
expr_stmt|;
operator|*
name|msgpos
operator|=
name|pos
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_write_server_certificate
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
modifier|*
modifier|*
name|msgpos
parameter_list|,
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|rhdr
decl_stmt|,
modifier|*
name|hs_start
decl_stmt|,
modifier|*
name|hs_length
decl_stmt|,
modifier|*
name|cert_start
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
name|struct
name|x509_certificate
modifier|*
name|cert
decl_stmt|;
specifier|const
name|struct
name|tls_cipher_suite
modifier|*
name|suite
decl_stmt|;
name|suite
operator|=
name|tls_get_cipher_suite
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|cipher_suite
argument_list|)
expr_stmt|;
if|if
condition|(
name|suite
operator|&&
name|suite
operator|->
name|key_exchange
operator|==
name|TLS_KEY_X_DH_anon
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Do not send Certificate when "
literal|"using anonymous DH"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pos
operator|=
operator|*
name|msgpos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Send Certificate"
argument_list|)
expr_stmt|;
name|rhdr
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|TLS_RECORD_HEADER_LEN
expr_stmt|;
comment|/* opaque fragment[TLSPlaintext.length] */
comment|/* Handshake */
name|hs_start
operator|=
name|pos
expr_stmt|;
comment|/* HandshakeType msg_type */
operator|*
name|pos
operator|++
operator|=
name|TLS_HANDSHAKE_TYPE_CERTIFICATE
expr_stmt|;
comment|/* uint24 length (to be filled) */
name|hs_length
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
comment|/* body - Certificate */
comment|/* uint24 length (to be filled) */
name|cert_start
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|cert
operator|=
name|conn
operator|->
name|cred
operator|->
name|cert
expr_stmt|;
while|while
condition|(
name|cert
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|3
operator|+
name|cert
operator|->
name|cert_len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Not enough buffer space "
literal|"for Certificate (cert_len=%lu left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cert
operator|->
name|cert_len
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|WPA_PUT_BE24
argument_list|(
name|pos
argument_list|,
name|cert
operator|->
name|cert_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|cert
operator|->
name|cert_start
argument_list|,
name|cert
operator|->
name|cert_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|cert
operator|->
name|cert_len
expr_stmt|;
if|if
condition|(
name|x509_certificate_self_signed
argument_list|(
name|cert
argument_list|)
condition|)
break|break;
name|cert
operator|=
name|x509_certificate_get_subject
argument_list|(
name|conn
operator|->
name|cred
operator|->
name|trusted_certs
argument_list|,
operator|&
name|cert
operator|->
name|issuer
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cert
operator|==
name|conn
operator|->
name|cred
operator|->
name|cert
operator|||
name|cert
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * Server was not configured with all the needed certificates 		 * to form a full certificate chain. The client may fail to 		 * validate the chain unless it is configured with all the 		 * missing CA certificates. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Full server certificate chain "
literal|"not configured - validation may fail"
argument_list|)
expr_stmt|;
block|}
name|WPA_PUT_BE24
argument_list|(
name|cert_start
argument_list|,
name|pos
operator|-
name|cert_start
operator|-
literal|3
argument_list|)
expr_stmt|;
name|WPA_PUT_BE24
argument_list|(
name|hs_length
argument_list|,
name|pos
operator|-
name|hs_length
operator|-
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlsv1_record_send
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|,
name|TLS_CONTENT_TYPE_HANDSHAKE
argument_list|,
name|rhdr
argument_list|,
name|end
operator|-
name|rhdr
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|,
operator|&
name|rlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to generate a record"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|rhdr
operator|+
name|rlen
expr_stmt|;
name|tls_verify_hash_add
argument_list|(
operator|&
name|conn
operator|->
name|verify
argument_list|,
name|hs_start
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|)
expr_stmt|;
operator|*
name|msgpos
operator|=
name|pos
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_write_server_key_exchange
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
modifier|*
modifier|*
name|msgpos
parameter_list|,
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|tls_key_exchange
name|keyx
decl_stmt|;
specifier|const
name|struct
name|tls_cipher_suite
modifier|*
name|suite
decl_stmt|;
ifdef|#
directive|ifdef
name|EAP_FAST
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|rhdr
decl_stmt|,
modifier|*
name|hs_start
decl_stmt|,
modifier|*
name|hs_length
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
name|u8
modifier|*
name|dh_ys
decl_stmt|;
name|size_t
name|dh_ys_len
decl_stmt|;
endif|#
directive|endif
comment|/* EAP_FAST */
name|suite
operator|=
name|tls_get_cipher_suite
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|cipher_suite
argument_list|)
expr_stmt|;
if|if
condition|(
name|suite
operator|==
name|NULL
condition|)
name|keyx
operator|=
name|TLS_KEY_X_NULL
expr_stmt|;
else|else
name|keyx
operator|=
name|suite
operator|->
name|key_exchange
expr_stmt|;
if|if
condition|(
operator|!
name|tls_server_key_exchange_allowed
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|cipher_suite
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: No ServerKeyExchange needed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|keyx
operator|!=
name|TLS_KEY_X_DH_anon
condition|)
block|{
comment|/* TODO? */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: ServerKeyExchange not yet "
literal|"supported with key exchange type %d"
argument_list|,
name|keyx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|EAP_FAST
if|if
condition|(
name|conn
operator|->
name|cred
operator|==
name|NULL
operator|||
name|conn
operator|->
name|cred
operator|->
name|dh_p
operator|==
name|NULL
operator|||
name|conn
operator|->
name|cred
operator|->
name|dh_g
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: No DH parameters available for "
literal|"ServerKeyExhcange"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|conn
operator|->
name|dh_secret
argument_list|)
expr_stmt|;
name|conn
operator|->
name|dh_secret_len
operator|=
name|conn
operator|->
name|cred
operator|->
name|dh_p_len
expr_stmt|;
name|conn
operator|->
name|dh_secret
operator|=
name|os_malloc
argument_list|(
name|conn
operator|->
name|dh_secret_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|dh_secret
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to allocate "
literal|"memory for secret (Diffie-Hellman)"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_get_random
argument_list|(
name|conn
operator|->
name|dh_secret
argument_list|,
name|conn
operator|->
name|dh_secret_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to get random "
literal|"data for Diffie-Hellman"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|conn
operator|->
name|dh_secret
argument_list|)
expr_stmt|;
name|conn
operator|->
name|dh_secret
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|conn
operator|->
name|dh_secret
argument_list|,
name|conn
operator|->
name|cred
operator|->
name|dh_p
argument_list|,
name|conn
operator|->
name|dh_secret_len
argument_list|)
operator|>
literal|0
condition|)
name|conn
operator|->
name|dh_secret
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
comment|/* make sure secret< p */
name|pos
operator|=
name|conn
operator|->
name|dh_secret
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|conn
operator|->
name|dh_secret
operator|+
name|conn
operator|->
name|dh_secret_len
operator|&&
operator|*
name|pos
operator|==
literal|0
condition|)
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|!=
name|conn
operator|->
name|dh_secret
condition|)
block|{
name|os_memmove
argument_list|(
name|conn
operator|->
name|dh_secret
argument_list|,
name|pos
argument_list|,
name|conn
operator|->
name|dh_secret_len
operator|-
operator|(
name|pos
operator|-
name|conn
operator|->
name|dh_secret
operator|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|dh_secret_len
operator|-=
name|pos
operator|-
name|conn
operator|->
name|dh_secret
expr_stmt|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: DH server's secret value"
argument_list|,
name|conn
operator|->
name|dh_secret
argument_list|,
name|conn
operator|->
name|dh_secret_len
argument_list|)
expr_stmt|;
comment|/* Ys = g^secret mod p */
name|dh_ys_len
operator|=
name|conn
operator|->
name|cred
operator|->
name|dh_p_len
expr_stmt|;
name|dh_ys
operator|=
name|os_malloc
argument_list|(
name|dh_ys_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dh_ys
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to allocate memory for "
literal|"Diffie-Hellman"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|crypto_mod_exp
argument_list|(
name|conn
operator|->
name|cred
operator|->
name|dh_g
argument_list|,
name|conn
operator|->
name|cred
operator|->
name|dh_g_len
argument_list|,
name|conn
operator|->
name|dh_secret
argument_list|,
name|conn
operator|->
name|dh_secret_len
argument_list|,
name|conn
operator|->
name|cred
operator|->
name|dh_p
argument_list|,
name|conn
operator|->
name|cred
operator|->
name|dh_p_len
argument_list|,
name|dh_ys
argument_list|,
operator|&
name|dh_ys_len
argument_list|)
condition|)
block|{
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|dh_ys
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: DH Ys (server's public value)"
argument_list|,
name|dh_ys
argument_list|,
name|dh_ys_len
argument_list|)
expr_stmt|;
comment|/* 	 * struct { 	 *    select (KeyExchangeAlgorithm) { 	 *       case diffie_hellman: 	 *          ServerDHParams params; 	 *          Signature signed_params; 	 *       case rsa: 	 *          ServerRSAParams params; 	 *          Signature signed_params; 	 *    }; 	 * } ServerKeyExchange; 	 * 	 * struct { 	 *    opaque dh_p<1..2^16-1>; 	 *    opaque dh_g<1..2^16-1>; 	 *    opaque dh_Ys<1..2^16-1>; 	 * } ServerDHParams; 	 */
name|pos
operator|=
operator|*
name|msgpos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Send ServerKeyExchange"
argument_list|)
expr_stmt|;
name|rhdr
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|TLS_RECORD_HEADER_LEN
expr_stmt|;
comment|/* opaque fragment[TLSPlaintext.length] */
comment|/* Handshake */
name|hs_start
operator|=
name|pos
expr_stmt|;
comment|/* HandshakeType msg_type */
operator|*
name|pos
operator|++
operator|=
name|TLS_HANDSHAKE_TYPE_SERVER_KEY_EXCHANGE
expr_stmt|;
comment|/* uint24 length (to be filled) */
name|hs_length
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
comment|/* body - ServerDHParams */
comment|/* dh_p */
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|conn
operator|->
name|cred
operator|->
name|dh_p_len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Not enough buffer space for "
literal|"dh_p"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|dh_ys
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|conn
operator|->
name|cred
operator|->
name|dh_p_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|conn
operator|->
name|cred
operator|->
name|dh_p
argument_list|,
name|conn
operator|->
name|cred
operator|->
name|dh_p_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|conn
operator|->
name|cred
operator|->
name|dh_p_len
expr_stmt|;
comment|/* dh_g */
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|conn
operator|->
name|cred
operator|->
name|dh_g_len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Not enough buffer space for "
literal|"dh_g"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|dh_ys
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|conn
operator|->
name|cred
operator|->
name|dh_g_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|conn
operator|->
name|cred
operator|->
name|dh_g
argument_list|,
name|conn
operator|->
name|cred
operator|->
name|dh_g_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|conn
operator|->
name|cred
operator|->
name|dh_g_len
expr_stmt|;
comment|/* dh_Ys */
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|dh_ys_len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Not enough buffer space for "
literal|"dh_Ys"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|dh_ys
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|dh_ys_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|dh_ys
argument_list|,
name|dh_ys_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|dh_ys_len
expr_stmt|;
name|os_free
argument_list|(
name|dh_ys
argument_list|)
expr_stmt|;
name|WPA_PUT_BE24
argument_list|(
name|hs_length
argument_list|,
name|pos
operator|-
name|hs_length
operator|-
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlsv1_record_send
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|,
name|TLS_CONTENT_TYPE_HANDSHAKE
argument_list|,
name|rhdr
argument_list|,
name|end
operator|-
name|rhdr
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|,
operator|&
name|rlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to generate a record"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|rhdr
operator|+
name|rlen
expr_stmt|;
name|tls_verify_hash_add
argument_list|(
operator|&
name|conn
operator|->
name|verify
argument_list|,
name|hs_start
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|)
expr_stmt|;
operator|*
name|msgpos
operator|=
name|pos
expr_stmt|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* EAP_FAST */
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* EAP_FAST */
block|}
end_function

begin_function
specifier|static
name|int
name|tls_write_server_certificate_request
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
modifier|*
modifier|*
name|msgpos
parameter_list|,
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|rhdr
decl_stmt|,
modifier|*
name|hs_start
decl_stmt|,
modifier|*
name|hs_length
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
if|if
condition|(
operator|!
name|conn
operator|->
name|verify_peer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: No CertificateRequest needed"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pos
operator|=
operator|*
name|msgpos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Send CertificateRequest"
argument_list|)
expr_stmt|;
name|rhdr
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|TLS_RECORD_HEADER_LEN
expr_stmt|;
comment|/* opaque fragment[TLSPlaintext.length] */
comment|/* Handshake */
name|hs_start
operator|=
name|pos
expr_stmt|;
comment|/* HandshakeType msg_type */
operator|*
name|pos
operator|++
operator|=
name|TLS_HANDSHAKE_TYPE_CERTIFICATE_REQUEST
expr_stmt|;
comment|/* uint24 length (to be filled) */
name|hs_length
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
comment|/* body - CertificateRequest */
comment|/* 	 * enum { 	 *   rsa_sign(1), dss_sign(2), rsa_fixed_dh(3), dss_fixed_dh(4), 	 *   (255) 	 * } ClientCertificateType; 	 * ClientCertificateType certificate_types<1..2^8-1> 	 */
operator|*
name|pos
operator|++
operator|=
literal|1
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
literal|1
expr_stmt|;
comment|/* rsa_sign */
comment|/* 	 * opaque DistinguishedName<1..2^16-1> 	 * DistinguishedName certificate_authorities<3..2^16-1> 	 */
comment|/* TODO: add support for listing DNs for trusted CAs */
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|WPA_PUT_BE24
argument_list|(
name|hs_length
argument_list|,
name|pos
operator|-
name|hs_length
operator|-
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlsv1_record_send
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|,
name|TLS_CONTENT_TYPE_HANDSHAKE
argument_list|,
name|rhdr
argument_list|,
name|end
operator|-
name|rhdr
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|,
operator|&
name|rlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to generate a record"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|rhdr
operator|+
name|rlen
expr_stmt|;
name|tls_verify_hash_add
argument_list|(
operator|&
name|conn
operator|->
name|verify
argument_list|,
name|hs_start
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|)
expr_stmt|;
operator|*
name|msgpos
operator|=
name|pos
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_write_server_hello_done
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
modifier|*
modifier|*
name|msgpos
parameter_list|,
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|rhdr
decl_stmt|,
modifier|*
name|hs_start
decl_stmt|,
modifier|*
name|hs_length
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
name|pos
operator|=
operator|*
name|msgpos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Send ServerHelloDone"
argument_list|)
expr_stmt|;
name|rhdr
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|TLS_RECORD_HEADER_LEN
expr_stmt|;
comment|/* opaque fragment[TLSPlaintext.length] */
comment|/* Handshake */
name|hs_start
operator|=
name|pos
expr_stmt|;
comment|/* HandshakeType msg_type */
operator|*
name|pos
operator|++
operator|=
name|TLS_HANDSHAKE_TYPE_SERVER_HELLO_DONE
expr_stmt|;
comment|/* uint24 length (to be filled) */
name|hs_length
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
comment|/* body - ServerHelloDone (empty) */
name|WPA_PUT_BE24
argument_list|(
name|hs_length
argument_list|,
name|pos
operator|-
name|hs_length
operator|-
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlsv1_record_send
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|,
name|TLS_CONTENT_TYPE_HANDSHAKE
argument_list|,
name|rhdr
argument_list|,
name|end
operator|-
name|rhdr
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|,
operator|&
name|rlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to generate a record"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|rhdr
operator|+
name|rlen
expr_stmt|;
name|tls_verify_hash_add
argument_list|(
operator|&
name|conn
operator|->
name|verify
argument_list|,
name|hs_start
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|)
expr_stmt|;
operator|*
name|msgpos
operator|=
name|pos
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_write_server_change_cipher_spec
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
modifier|*
modifier|*
name|msgpos
parameter_list|,
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|rhdr
decl_stmt|;
name|size_t
name|rlen
decl_stmt|;
name|pos
operator|=
operator|*
name|msgpos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Send ChangeCipherSpec"
argument_list|)
expr_stmt|;
name|rhdr
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|TLS_RECORD_HEADER_LEN
expr_stmt|;
operator|*
name|pos
operator|=
name|TLS_CHANGE_CIPHER_SPEC
expr_stmt|;
if|if
condition|(
name|tlsv1_record_send
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|,
name|TLS_CONTENT_TYPE_CHANGE_CIPHER_SPEC
argument_list|,
name|rhdr
argument_list|,
name|end
operator|-
name|rhdr
argument_list|,
literal|1
argument_list|,
operator|&
name|rlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to create a record"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tlsv1_record_change_write_cipher
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to set write cipher for "
literal|"record layer"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|msgpos
operator|=
name|rhdr
operator|+
name|rlen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_write_server_finished
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
modifier|*
modifier|*
name|msgpos
parameter_list|,
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|rhdr
decl_stmt|,
modifier|*
name|hs_start
decl_stmt|,
modifier|*
name|hs_length
decl_stmt|;
name|size_t
name|rlen
decl_stmt|,
name|hlen
decl_stmt|;
name|u8
name|verify_data
index|[
name|TLS_VERIFY_DATA_LEN
index|]
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
operator|+
name|SHA1_MAC_LEN
index|]
decl_stmt|;
name|pos
operator|=
operator|*
name|msgpos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Send Finished"
argument_list|)
expr_stmt|;
comment|/* Encrypted Handshake Message: Finished */
name|hlen
operator|=
name|MD5_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|md5_server
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|md5_server
argument_list|,
name|hash
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|md5_server
operator|=
name|NULL
expr_stmt|;
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha1_server
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|sha1_server
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|verify
operator|.
name|md5_server
operator|=
name|NULL
expr_stmt|;
name|hlen
operator|=
name|SHA1_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|sha1_server
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha1_server
argument_list|,
name|hash
operator|+
name|MD5_MAC_LEN
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|conn
operator|->
name|verify
operator|.
name|sha1_server
operator|=
name|NULL
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|verify
operator|.
name|sha1_server
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|tls_prf
argument_list|(
name|conn
operator|->
name|master_secret
argument_list|,
name|TLS_MASTER_SECRET_LEN
argument_list|,
literal|"server finished"
argument_list|,
name|hash
argument_list|,
name|MD5_MAC_LEN
operator|+
name|SHA1_MAC_LEN
argument_list|,
name|verify_data
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to generate verify_data"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: verify_data (server)"
argument_list|,
name|verify_data
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
expr_stmt|;
name|rhdr
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|TLS_RECORD_HEADER_LEN
expr_stmt|;
comment|/* Handshake */
name|hs_start
operator|=
name|pos
expr_stmt|;
comment|/* HandshakeType msg_type */
operator|*
name|pos
operator|++
operator|=
name|TLS_HANDSHAKE_TYPE_FINISHED
expr_stmt|;
comment|/* uint24 length (to be filled) */
name|hs_length
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|verify_data
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|TLS_VERIFY_DATA_LEN
expr_stmt|;
name|WPA_PUT_BE24
argument_list|(
name|hs_length
argument_list|,
name|pos
operator|-
name|hs_length
operator|-
literal|3
argument_list|)
expr_stmt|;
name|tls_verify_hash_add
argument_list|(
operator|&
name|conn
operator|->
name|verify
argument_list|,
name|hs_start
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlsv1_record_send
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|,
name|TLS_CONTENT_TYPE_HANDSHAKE
argument_list|,
name|rhdr
argument_list|,
name|end
operator|-
name|rhdr
argument_list|,
name|pos
operator|-
name|hs_start
argument_list|,
operator|&
name|rlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to create a record"
argument_list|)
expr_stmt|;
name|tlsv1_server_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|rhdr
operator|+
name|rlen
expr_stmt|;
operator|*
name|msgpos
operator|=
name|pos
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|tls_send_server_hello
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|size_t
modifier|*
name|out_len
parameter_list|)
block|{
name|u8
modifier|*
name|msg
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|msglen
decl_stmt|;
operator|*
name|out_len
operator|=
literal|0
expr_stmt|;
name|msglen
operator|=
literal|1000
operator|+
name|tls_server_cert_chain_der_len
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|msg
operator|=
name|os_malloc
argument_list|(
name|msglen
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|msg
expr_stmt|;
name|end
operator|=
name|msg
operator|+
name|msglen
expr_stmt|;
if|if
condition|(
name|tls_write_server_hello
argument_list|(
name|conn
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|conn
operator|->
name|use_session_ticket
condition|)
block|{
comment|/* Abbreviated handshake using session ticket; RFC 4507 */
if|if
condition|(
name|tls_write_server_change_cipher_spec
argument_list|(
name|conn
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
operator|||
name|tls_write_server_finished
argument_list|(
name|conn
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|out_len
operator|=
name|pos
operator|-
name|msg
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|CHANGE_CIPHER_SPEC
expr_stmt|;
return|return
name|msg
return|;
block|}
comment|/* Full handshake */
if|if
condition|(
name|tls_write_server_certificate
argument_list|(
name|conn
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
operator|||
name|tls_write_server_key_exchange
argument_list|(
name|conn
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
operator|||
name|tls_write_server_certificate_request
argument_list|(
name|conn
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
operator|||
name|tls_write_server_hello_done
argument_list|(
name|conn
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|out_len
operator|=
name|pos
operator|-
name|msg
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|CLIENT_CERTIFICATE
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
specifier|static
name|u8
modifier|*
name|tls_send_change_cipher_spec
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|size_t
modifier|*
name|out_len
parameter_list|)
block|{
name|u8
modifier|*
name|msg
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
operator|*
name|out_len
operator|=
literal|0
expr_stmt|;
name|msg
operator|=
name|os_malloc
argument_list|(
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|msg
expr_stmt|;
name|end
operator|=
name|msg
operator|+
literal|1000
expr_stmt|;
if|if
condition|(
name|tls_write_server_change_cipher_spec
argument_list|(
name|conn
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
operator|||
name|tls_write_server_finished
argument_list|(
name|conn
argument_list|,
operator|&
name|pos
argument_list|,
name|end
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|msg
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|out_len
operator|=
name|pos
operator|-
name|msg
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Handshake completed successfully"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|ESTABLISHED
expr_stmt|;
return|return
name|msg
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|tlsv1_server_handshake_write
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|size_t
modifier|*
name|out_len
parameter_list|)
block|{
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|SERVER_HELLO
case|:
return|return
name|tls_send_server_hello
argument_list|(
name|conn
argument_list|,
name|out_len
argument_list|)
return|;
case|case
name|SERVER_CHANGE_CIPHER_SPEC
case|:
return|return
name|tls_send_change_cipher_spec
argument_list|(
name|conn
argument_list|,
name|out_len
argument_list|)
return|;
default|default:
if|if
condition|(
name|conn
operator|->
name|state
operator|==
name|ESTABLISHED
operator|&&
name|conn
operator|->
name|use_session_ticket
condition|)
block|{
comment|/* Abbreviated handshake was already completed. */
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Unexpected state %d while "
literal|"generating reply"
argument_list|,
name|conn
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
name|u8
modifier|*
name|tlsv1_server_send_alert
parameter_list|(
name|struct
name|tlsv1_server
modifier|*
name|conn
parameter_list|,
name|u8
name|level
parameter_list|,
name|u8
name|description
parameter_list|,
name|size_t
modifier|*
name|out_len
parameter_list|)
block|{
name|u8
modifier|*
name|alert
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|length
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Send Alert(%d:%d)"
argument_list|,
name|level
argument_list|,
name|description
argument_list|)
expr_stmt|;
operator|*
name|out_len
operator|=
literal|0
expr_stmt|;
name|alert
operator|=
name|os_malloc
argument_list|(
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|alert
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|alert
expr_stmt|;
comment|/* TLSPlaintext */
comment|/* ContentType type */
operator|*
name|pos
operator|++
operator|=
name|TLS_CONTENT_TYPE_ALERT
expr_stmt|;
comment|/* ProtocolVersion version */
name|WPA_PUT_BE16
argument_list|(
name|pos
argument_list|,
name|TLS_VERSION
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* uint16 length (to be filled) */
name|length
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* opaque fragment[TLSPlaintext.length] */
comment|/* Alert */
comment|/* AlertLevel level */
operator|*
name|pos
operator|++
operator|=
name|level
expr_stmt|;
comment|/* AlertDescription description */
operator|*
name|pos
operator|++
operator|=
name|description
expr_stmt|;
name|WPA_PUT_BE16
argument_list|(
name|length
argument_list|,
name|pos
operator|-
name|length
operator|-
literal|2
argument_list|)
expr_stmt|;
operator|*
name|out_len
operator|=
name|pos
operator|-
name|alert
expr_stmt|;
return|return
name|alert
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * PKCS #5 (Password-based Encryption)  * Copyright (c) 2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/crypto.h"
end_include

begin_include
include|#
directive|include
file|"crypto/md5.h"
end_include

begin_include
include|#
directive|include
file|"asn1.h"
end_include

begin_include
include|#
directive|include
file|"pkcs5.h"
end_include

begin_struct
struct|struct
name|pkcs5_params
block|{
enum|enum
name|pkcs5_alg
block|{
name|PKCS5_ALG_UNKNOWN
block|,
name|PKCS5_ALG_MD5_DES_CBC
block|}
name|alg
enum|;
name|u8
name|salt
index|[
literal|8
index|]
decl_stmt|;
name|size_t
name|salt_len
decl_stmt|;
name|unsigned
name|int
name|iter_count
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|enum
name|pkcs5_alg
name|pkcs5_get_alg
parameter_list|(
name|struct
name|asn1_oid
modifier|*
name|oid
parameter_list|)
block|{
if|if
condition|(
name|oid
operator|->
name|len
operator|==
literal|7
operator|&&
name|oid
operator|->
name|oid
index|[
literal|0
index|]
operator|==
literal|1
comment|/* iso */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|1
index|]
operator|==
literal|2
comment|/* member-body */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|2
index|]
operator|==
literal|840
comment|/* us */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|3
index|]
operator|==
literal|113549
comment|/* rsadsi */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|4
index|]
operator|==
literal|1
comment|/* pkcs */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|5
index|]
operator|==
literal|5
comment|/* pkcs-5 */
operator|&&
name|oid
operator|->
name|oid
index|[
literal|6
index|]
operator|==
literal|3
comment|/* pbeWithMD5AndDES-CBC */
condition|)
return|return
name|PKCS5_ALG_MD5_DES_CBC
return|;
return|return
name|PKCS5_ALG_UNKNOWN
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|pkcs5_get_params
parameter_list|(
specifier|const
name|u8
modifier|*
name|enc_alg
parameter_list|,
name|size_t
name|enc_alg_len
parameter_list|,
name|struct
name|pkcs5_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|enc_alg_end
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|struct
name|asn1_oid
name|oid
decl_stmt|;
name|char
name|obuf
index|[
literal|80
index|]
decl_stmt|;
comment|/* AlgorithmIdentifier */
name|enc_alg_end
operator|=
name|enc_alg
operator|+
name|enc_alg_len
expr_stmt|;
name|os_memset
argument_list|(
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|params
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|asn1_get_oid
argument_list|(
name|enc_alg
argument_list|,
name|enc_alg_end
operator|-
name|enc_alg
argument_list|,
operator|&
name|oid
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: Failed to parse OID "
literal|"(algorithm)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|asn1_oid_to_str
argument_list|(
operator|&
name|oid
argument_list|,
name|obuf
argument_list|,
sizeof|sizeof
argument_list|(
name|obuf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: encryption algorithm %s"
argument_list|,
name|obuf
argument_list|)
expr_stmt|;
name|params
operator|->
name|alg
operator|=
name|pkcs5_get_alg
argument_list|(
operator|&
name|oid
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|alg
operator|==
name|PKCS5_ALG_UNKNOWN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PKCS #5: unsupported encryption "
literal|"algorithm %s"
argument_list|,
name|obuf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * PKCS#5, Section 8 	 * PBEParameter ::= SEQUENCE { 	 *   salt OCTET STRING SIZE(8), 	 *   iterationCount INTEGER } 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|enc_alg_end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: Expected SEQUENCE "
literal|"(PBEParameter) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|end
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
comment|/* salt OCTET STRING SIZE(8) */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_OCTETSTRING
operator|||
name|hdr
operator|.
name|length
operator|!=
literal|8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: Expected OCTETSTRING SIZE(8) "
literal|"(salt) - found class %d tag 0x%x size %d"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
name|os_memcpy
argument_list|(
name|params
operator|->
name|salt
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
name|params
operator|->
name|salt_len
operator|=
name|hdr
operator|.
name|length
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: salt"
argument_list|,
name|params
operator|->
name|salt
argument_list|,
name|params
operator|->
name|salt_len
argument_list|)
expr_stmt|;
comment|/* iterationCount INTEGER */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_INTEGER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: Expected INTEGER - found "
literal|"class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hdr
operator|.
name|length
operator|==
literal|1
condition|)
name|params
operator|->
name|iter_count
operator|=
operator|*
name|hdr
operator|.
name|payload
expr_stmt|;
elseif|else
if|if
condition|(
name|hdr
operator|.
name|length
operator|==
literal|2
condition|)
name|params
operator|->
name|iter_count
operator|=
name|WPA_GET_BE16
argument_list|(
name|hdr
operator|.
name|payload
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|hdr
operator|.
name|length
operator|==
literal|4
condition|)
name|params
operator|->
name|iter_count
operator|=
name|WPA_GET_BE32
argument_list|(
name|hdr
operator|.
name|payload
argument_list|)
expr_stmt|;
else|else
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: Unsupported INTEGER value "
literal|" (iterationCount)"
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: iterationCount=0x%x"
argument_list|,
name|params
operator|->
name|iter_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|iter_count
operator|==
literal|0
operator|||
name|params
operator|->
name|iter_count
operator|>
literal|0xffff
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PKCS #5: Unsupported "
literal|"iterationCount=0x%x"
argument_list|,
name|params
operator|->
name|iter_count
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|crypto_cipher
modifier|*
name|pkcs5_crypto_init
parameter_list|(
name|struct
name|pkcs5_params
modifier|*
name|params
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
index|[
literal|2
index|]
decl_stmt|;
name|size_t
name|len
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|params
operator|->
name|alg
operator|!=
name|PKCS5_ALG_MD5_DES_CBC
condition|)
return|return
name|NULL
return|;
name|addr
index|[
literal|0
index|]
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
name|passwd
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|os_strlen
argument_list|(
name|passwd
argument_list|)
expr_stmt|;
name|addr
index|[
literal|1
index|]
operator|=
name|params
operator|->
name|salt
expr_stmt|;
name|len
index|[
literal|1
index|]
operator|=
name|params
operator|->
name|salt_len
expr_stmt|;
if|if
condition|(
name|md5_vector
argument_list|(
literal|2
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|addr
index|[
literal|0
index|]
operator|=
name|hash
expr_stmt|;
name|len
index|[
literal|0
index|]
operator|=
name|MD5_MAC_LEN
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|params
operator|->
name|iter_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|md5_vector
argument_list|(
literal|1
argument_list|,
name|addr
argument_list|,
name|len
argument_list|,
name|hash
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
block|}
comment|/* TODO: DES key parity bits(?) */
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: DES key"
argument_list|,
name|hash
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: DES IV"
argument_list|,
name|hash
operator|+
literal|8
argument_list|,
literal|8
argument_list|)
expr_stmt|;
return|return
name|crypto_cipher_init
argument_list|(
name|CRYPTO_CIPHER_ALG_DES
argument_list|,
name|hash
operator|+
literal|8
argument_list|,
name|hash
argument_list|,
literal|8
argument_list|)
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|pkcs5_decrypt
parameter_list|(
specifier|const
name|u8
modifier|*
name|enc_alg
parameter_list|,
name|size_t
name|enc_alg_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|enc_data
parameter_list|,
name|size_t
name|enc_data_len
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|,
name|size_t
modifier|*
name|data_len
parameter_list|)
block|{
name|struct
name|crypto_cipher
modifier|*
name|ctx
decl_stmt|;
name|u8
modifier|*
name|eb
decl_stmt|,
name|pad
decl_stmt|;
name|struct
name|pkcs5_params
name|params
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|pkcs5_get_params
argument_list|(
name|enc_alg
argument_list|,
name|enc_alg_len
argument_list|,
operator|&
name|params
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: Unsupported parameters"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ctx
operator|=
name|pkcs5_crypto_init
argument_list|(
operator|&
name|params
argument_list|,
name|passwd
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: Failed to initialize crypto"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
comment|/* PKCS #5, Section 7 - Decryption process */
if|if
condition|(
name|enc_data_len
operator|<
literal|16
operator|||
name|enc_data_len
operator|%
literal|8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PKCS #5: invalid length of ciphertext "
literal|"%d"
argument_list|,
operator|(
name|int
operator|)
name|enc_data_len
argument_list|)
expr_stmt|;
name|crypto_cipher_deinit
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|eb
operator|=
name|os_malloc
argument_list|(
name|enc_data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|eb
operator|==
name|NULL
condition|)
block|{
name|crypto_cipher_deinit
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|crypto_cipher_decrypt
argument_list|(
name|ctx
argument_list|,
name|enc_data
argument_list|,
name|eb
argument_list|,
name|enc_data_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #5: Failed to decrypt EB"
argument_list|)
expr_stmt|;
name|crypto_cipher_deinit
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|eb
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|crypto_cipher_deinit
argument_list|(
name|ctx
argument_list|)
expr_stmt|;
name|pad
operator|=
name|eb
index|[
name|enc_data_len
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|pad
operator|>
literal|8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PKCS #5: Invalid PS octet 0x%x"
argument_list|,
name|pad
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|eb
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|i
operator|=
name|enc_data_len
operator|-
name|pad
init|;
name|i
operator|<
name|enc_data_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|eb
index|[
name|i
index|]
operator|!=
name|pad
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_INFO
argument_list|,
literal|"PKCS #5: Invalid PS"
argument_list|,
name|eb
operator|+
name|enc_data_len
operator|-
name|pad
argument_list|,
name|pad
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|eb
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"PKCS #5: message M (encrypted key)"
argument_list|,
name|eb
argument_list|,
name|enc_data_len
operator|-
name|pad
argument_list|)
expr_stmt|;
operator|*
name|data_len
operator|=
name|enc_data_len
operator|-
name|pad
expr_stmt|;
return|return
name|eb
return|;
block|}
end_function

end_unit


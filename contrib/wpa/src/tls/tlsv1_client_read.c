begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * TLSv1 client - read handshake message  * Copyright (c) 2006-2014, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/md5.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha1.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"crypto/tls.h"
end_include

begin_include
include|#
directive|include
file|"x509v3.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_common.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_record.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_client.h"
end_include

begin_include
include|#
directive|include
file|"tlsv1_client_i.h"
end_include

begin_function_decl
specifier|static
name|int
name|tls_process_server_key_exchange
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|tls_process_certificate_request
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|tls_process_server_hello_done
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|tls_process_server_hello
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|,
name|i
decl_stmt|;
name|u16
name|cipher_suite
decl_stmt|;
name|u16
name|tls_version
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected Handshake; "
literal|"received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
goto|goto
name|decode_error
goto|;
comment|/* HandshakeType msg_type */
if|if
condition|(
operator|*
name|pos
operator|!=
name|TLS_HANDSHAKE_TYPE_SERVER_HELLO
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received unexpected handshake "
literal|"message %d (expected ServerHello)"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received ServerHello"
argument_list|)
expr_stmt|;
name|pos
operator|++
expr_stmt|;
comment|/* uint24 length */
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
goto|goto
name|decode_error
goto|;
comment|/* body - ServerHello */
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: ServerHello"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
comment|/* ProtocolVersion server_version */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
goto|goto
name|decode_error
goto|;
name|tls_version
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tls_version_ok
argument_list|(
name|tls_version
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Unexpected protocol version in "
literal|"ServerHello %u.%u"
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_PROTOCOL_VERSION
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Using TLS v%s"
argument_list|,
name|tls_version_str
argument_list|(
name|tls_version
argument_list|)
argument_list|)
expr_stmt|;
name|conn
operator|->
name|rl
operator|.
name|tls_version
operator|=
name|tls_version
expr_stmt|;
comment|/* Random random */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
name|TLS_RANDOM_LEN
condition|)
goto|goto
name|decode_error
goto|;
name|os_memcpy
argument_list|(
name|conn
operator|->
name|server_random
argument_list|,
name|pos
argument_list|,
name|TLS_RANDOM_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|TLS_RANDOM_LEN
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: server_random"
argument_list|,
name|conn
operator|->
name|server_random
argument_list|,
name|TLS_RANDOM_LEN
argument_list|)
expr_stmt|;
comment|/* SessionID session_id */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|1
condition|)
goto|goto
name|decode_error
goto|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|1
operator|+
operator|*
name|pos
operator|||
operator|*
name|pos
operator|>
name|TLS_SESSION_ID_MAX_LEN
condition|)
goto|goto
name|decode_error
goto|;
if|if
condition|(
name|conn
operator|->
name|session_id_len
operator|&&
name|conn
operator|->
name|session_id_len
operator|==
operator|*
name|pos
operator|&&
name|os_memcmp
argument_list|(
name|conn
operator|->
name|session_id
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|conn
operator|->
name|session_id_len
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pos
operator|+=
literal|1
operator|+
name|conn
operator|->
name|session_id_len
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Resuming old session"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|session_resumed
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|conn
operator|->
name|session_id_len
operator|=
operator|*
name|pos
expr_stmt|;
name|pos
operator|++
expr_stmt|;
name|os_memcpy
argument_list|(
name|conn
operator|->
name|session_id
argument_list|,
name|pos
argument_list|,
name|conn
operator|->
name|session_id_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|conn
operator|->
name|session_id_len
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: session_id"
argument_list|,
name|conn
operator|->
name|session_id
argument_list|,
name|conn
operator|->
name|session_id_len
argument_list|)
expr_stmt|;
comment|/* CipherSuite cipher_suite */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
goto|goto
name|decode_error
goto|;
name|cipher_suite
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|conn
operator|->
name|num_cipher_suites
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cipher_suite
operator|==
name|conn
operator|->
name|cipher_suites
index|[
name|i
index|]
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|conn
operator|->
name|num_cipher_suites
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Server selected unexpected "
literal|"cipher suite 0x%04x"
argument_list|,
name|cipher_suite
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_ILLEGAL_PARAMETER
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|conn
operator|->
name|session_resumed
operator|&&
name|cipher_suite
operator|!=
name|conn
operator|->
name|prev_cipher_suite
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Server selected a different "
literal|"cipher suite for a resumed connection (0x%04x != "
literal|"0x%04x)"
argument_list|,
name|cipher_suite
argument_list|,
name|conn
operator|->
name|prev_cipher_suite
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_ILLEGAL_PARAMETER
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tlsv1_record_set_cipher_suite
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|,
name|cipher_suite
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to set CipherSuite for "
literal|"record layer"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|prev_cipher_suite
operator|=
name|cipher_suite
expr_stmt|;
comment|/* CompressionMethod compression_method */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|1
condition|)
goto|goto
name|decode_error
goto|;
if|if
condition|(
operator|*
name|pos
operator|!=
name|TLS_COMPRESSION_NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Server selected unexpected "
literal|"compression 0x%02x"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_ILLEGAL_PARAMETER
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|end
operator|!=
name|pos
condition|)
block|{
comment|/* TODO: ServerHello extensions */
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Unexpected extra data in the "
literal|"end of ServerHello"
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
goto|goto
name|decode_error
goto|;
block|}
if|if
condition|(
name|conn
operator|->
name|session_ticket_included
operator|&&
name|conn
operator|->
name|session_ticket_cb
condition|)
block|{
comment|/* TODO: include SessionTicket extension if one was included in 		 * ServerHello */
name|int
name|res
init|=
name|conn
operator|->
name|session_ticket_cb
argument_list|(
name|conn
operator|->
name|session_ticket_cb_ctx
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|conn
operator|->
name|client_random
argument_list|,
name|conn
operator|->
name|server_random
argument_list|,
name|conn
operator|->
name|master_secret
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: SessionTicket callback "
literal|"indicated failure"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_HANDSHAKE_FAILURE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|use_session_ticket
operator|=
operator|!
operator|!
name|res
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|conn
operator|->
name|session_resumed
operator|||
name|conn
operator|->
name|use_session_ticket
operator|)
operator|&&
name|tls_derive_keys
argument_list|(
name|conn
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to derive keys"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
operator|(
name|conn
operator|->
name|session_resumed
operator|||
name|conn
operator|->
name|use_session_ticket
operator|)
condition|?
name|SERVER_CHANGE_CIPHER_SPEC
else|:
name|SERVER_CERTIFICATE
expr_stmt|;
return|return
literal|0
return|;
name|decode_error
label|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to decode ServerHello"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_certificate
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|,
name|list_len
decl_stmt|,
name|cert_len
decl_stmt|,
name|idx
decl_stmt|;
name|u8
name|type
decl_stmt|;
name|struct
name|x509_certificate
modifier|*
name|chain
init|=
name|NULL
decl_stmt|,
modifier|*
name|last
init|=
name|NULL
decl_stmt|,
modifier|*
name|cert
decl_stmt|;
name|int
name|reason
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected Handshake; "
literal|"received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Too short Certificate message "
literal|"(len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Unexpected Certificate message "
literal|"length (len=%lu != left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|type
operator|==
name|TLS_HANDSHAKE_TYPE_SERVER_KEY_EXCHANGE
condition|)
return|return
name|tls_process_server_key_exchange
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
return|;
if|if
condition|(
name|type
operator|==
name|TLS_HANDSHAKE_TYPE_CERTIFICATE_REQUEST
condition|)
return|return
name|tls_process_certificate_request
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
return|;
if|if
condition|(
name|type
operator|==
name|TLS_HANDSHAKE_TYPE_SERVER_HELLO_DONE
condition|)
return|return
name|tls_process_server_hello_done
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
return|;
if|if
condition|(
name|type
operator|!=
name|TLS_HANDSHAKE_TYPE_CERTIFICATE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received unexpected handshake "
literal|"message %d (expected Certificate/"
literal|"ServerKeyExchange/CertificateRequest/"
literal|"ServerHelloDone)"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received Certificate (certificate_list len %lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
comment|/* 	 * opaque ASN.1Cert<2^24-1>; 	 * 	 * struct { 	 *     ASN.1Cert certificate_list<1..2^24-1>; 	 * } Certificate; 	 */
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Too short Certificate "
literal|"(left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|list_len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
operator|!=
name|list_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Unexpected certificate_list "
literal|"length (len=%lu left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|list_len
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|idx
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to parse "
literal|"certificate_list"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cert_len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
if|if
condition|(
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
operator|<
name|cert_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Unexpected certificate "
literal|"length (len=%lu left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cert_len
argument_list|,
call|(
name|unsigned
name|long
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Certificate %lu (len %lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|idx
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cert_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|idx
operator|==
literal|0
condition|)
block|{
name|crypto_public_key_free
argument_list|(
name|conn
operator|->
name|server_rsa_key
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_parse_cert
argument_list|(
name|pos
argument_list|,
name|cert_len
argument_list|,
operator|&
name|conn
operator|->
name|server_rsa_key
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to parse "
literal|"the certificate"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_BAD_CERTIFICATE
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|cert
operator|=
name|x509_certificate_parse
argument_list|(
name|pos
argument_list|,
name|cert_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|cert
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to parse "
literal|"the certificate"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_BAD_CERTIFICATE
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|last
operator|==
name|NULL
condition|)
name|chain
operator|=
name|cert
expr_stmt|;
else|else
name|last
operator|->
name|next
operator|=
name|cert
expr_stmt|;
name|last
operator|=
name|cert
expr_stmt|;
name|idx
operator|++
expr_stmt|;
name|pos
operator|+=
name|cert_len
expr_stmt|;
block|}
if|if
condition|(
name|conn
operator|->
name|cred
operator|&&
name|x509_certificate_chain_validate
argument_list|(
name|conn
operator|->
name|cred
operator|->
name|trusted_certs
argument_list|,
name|chain
argument_list|,
operator|&
name|reason
argument_list|,
name|conn
operator|->
name|disable_time_checks
argument_list|)
operator|<
literal|0
condition|)
block|{
name|int
name|tls_reason
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Server certificate chain "
literal|"validation failed (reason=%d)"
argument_list|,
name|reason
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|reason
condition|)
block|{
case|case
name|X509_VALIDATE_BAD_CERTIFICATE
case|:
name|tls_reason
operator|=
name|TLS_ALERT_BAD_CERTIFICATE
expr_stmt|;
break|break;
case|case
name|X509_VALIDATE_UNSUPPORTED_CERTIFICATE
case|:
name|tls_reason
operator|=
name|TLS_ALERT_UNSUPPORTED_CERTIFICATE
expr_stmt|;
break|break;
case|case
name|X509_VALIDATE_CERTIFICATE_REVOKED
case|:
name|tls_reason
operator|=
name|TLS_ALERT_CERTIFICATE_REVOKED
expr_stmt|;
break|break;
case|case
name|X509_VALIDATE_CERTIFICATE_EXPIRED
case|:
name|tls_reason
operator|=
name|TLS_ALERT_CERTIFICATE_EXPIRED
expr_stmt|;
break|break;
case|case
name|X509_VALIDATE_CERTIFICATE_UNKNOWN
case|:
name|tls_reason
operator|=
name|TLS_ALERT_CERTIFICATE_UNKNOWN
expr_stmt|;
break|break;
case|case
name|X509_VALIDATE_UNKNOWN_CA
case|:
name|tls_reason
operator|=
name|TLS_ALERT_UNKNOWN_CA
expr_stmt|;
break|break;
default|default:
name|tls_reason
operator|=
name|TLS_ALERT_BAD_CERTIFICATE
expr_stmt|;
break|break;
block|}
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|tls_reason
argument_list|)
expr_stmt|;
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|x509_certificate_chain_free
argument_list|(
name|chain
argument_list|)
expr_stmt|;
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|SERVER_KEY_EXCHANGE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|count_bits
parameter_list|(
specifier|const
name|u8
modifier|*
name|val
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|unsigned
name|int
name|bits
decl_stmt|;
name|u8
name|tmp
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|val
index|[
name|i
index|]
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|len
condition|)
return|return
literal|0
return|;
name|bits
operator|=
operator|(
name|len
operator|-
name|i
operator|-
literal|1
operator|)
operator|*
literal|8
expr_stmt|;
name|tmp
operator|=
name|val
index|[
name|i
index|]
expr_stmt|;
while|while
condition|(
name|tmp
condition|)
block|{
name|bits
operator|++
expr_stmt|;
name|tmp
operator|>>=
literal|1
expr_stmt|;
block|}
return|return
name|bits
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tlsv1_process_diffie_hellman
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|tls_key_exchange
name|key_exchange
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|server_params
decl_stmt|,
modifier|*
name|server_params_end
decl_stmt|;
name|u8
name|alert
decl_stmt|;
name|unsigned
name|int
name|bits
decl_stmt|;
name|u16
name|val
decl_stmt|;
name|tlsv1_client_free_dh
argument_list|(
name|conn
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|3
condition|)
goto|goto
name|fail
goto|;
name|server_params
operator|=
name|pos
expr_stmt|;
name|val
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0
operator|||
name|val
operator|>
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Invalid dh_p length %u"
argument_list|,
name|val
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|conn
operator|->
name|dh_p_len
operator|=
name|val
expr_stmt|;
name|bits
operator|=
name|count_bits
argument_list|(
name|pos
argument_list|,
name|conn
operator|->
name|dh_p_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bits
operator|<
literal|768
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Reject under 768-bit DH prime (insecure; only %u bits)"
argument_list|,
name|bits
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Rejected DH prime"
argument_list|,
name|pos
argument_list|,
name|conn
operator|->
name|dh_p_len
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|conn
operator|->
name|dh_p
operator|=
name|os_malloc
argument_list|(
name|conn
operator|->
name|dh_p_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|dh_p
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_memcpy
argument_list|(
name|conn
operator|->
name|dh_p
argument_list|,
name|pos
argument_list|,
name|conn
operator|->
name|dh_p_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|conn
operator|->
name|dh_p_len
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: DH p (prime)"
argument_list|,
name|conn
operator|->
name|dh_p
argument_list|,
name|conn
operator|->
name|dh_p_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|3
condition|)
goto|goto
name|fail
goto|;
name|val
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0
operator|||
name|val
operator|>
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|conn
operator|->
name|dh_g_len
operator|=
name|val
expr_stmt|;
name|conn
operator|->
name|dh_g
operator|=
name|os_malloc
argument_list|(
name|conn
operator|->
name|dh_g_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|dh_g
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_memcpy
argument_list|(
name|conn
operator|->
name|dh_g
argument_list|,
name|pos
argument_list|,
name|conn
operator|->
name|dh_g_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|conn
operator|->
name|dh_g_len
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: DH g (generator)"
argument_list|,
name|conn
operator|->
name|dh_g
argument_list|,
name|conn
operator|->
name|dh_g_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|dh_g_len
operator|==
literal|1
operator|&&
name|conn
operator|->
name|dh_g
index|[
literal|0
index|]
operator|<
literal|2
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|3
condition|)
goto|goto
name|fail
goto|;
name|val
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|val
operator|==
literal|0
operator|||
name|val
operator|>
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|conn
operator|->
name|dh_ys_len
operator|=
name|val
expr_stmt|;
name|conn
operator|->
name|dh_ys
operator|=
name|os_malloc
argument_list|(
name|conn
operator|->
name|dh_ys_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|dh_ys
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_memcpy
argument_list|(
name|conn
operator|->
name|dh_ys
argument_list|,
name|pos
argument_list|,
name|conn
operator|->
name|dh_ys_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|conn
operator|->
name|dh_ys_len
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: DH Ys (server's public value)"
argument_list|,
name|conn
operator|->
name|dh_ys
argument_list|,
name|conn
operator|->
name|dh_ys_len
argument_list|)
expr_stmt|;
name|server_params_end
operator|=
name|pos
expr_stmt|;
if|if
condition|(
name|key_exchange
operator|==
name|TLS_KEY_X_DHE_RSA
condition|)
block|{
name|u8
name|hash
index|[
name|MD5_MAC_LEN
operator|+
name|SHA1_MAC_LEN
index|]
decl_stmt|;
name|int
name|hlen
decl_stmt|;
if|if
condition|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
operator|==
name|TLS_VERSION_1_2
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_TLSV12
comment|/* 			 * RFC 5246, 4.7: 			 * TLS v1.2 adds explicit indication of the used 			 * signature and hash algorithms. 			 * 			 * struct { 			 *   HashAlgorithm hash; 			 *   SignatureAlgorithm signature; 			 * } SignatureAndHashAlgorithm; 			 */
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|!=
name|TLS_HASH_ALG_SHA256
operator|||
name|pos
index|[
literal|1
index|]
operator|!=
name|TLS_SIGN_ALG_RSA
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1.2: Unsupported hash(%u)/signature(%u) algorithm"
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
name|hlen
operator|=
name|tlsv12_key_x_server_params_hash
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
argument_list|,
name|conn
operator|->
name|client_random
argument_list|,
name|conn
operator|->
name|server_random
argument_list|,
name|server_params
argument_list|,
name|server_params_end
operator|-
name|server_params
argument_list|,
name|hash
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* CONFIG_TLSV12 */
goto|goto
name|fail
goto|;
endif|#
directive|endif
comment|/* CONFIG_TLSV12 */
block|}
else|else
block|{
name|hlen
operator|=
name|tls_key_x_server_params_hash
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
argument_list|,
name|conn
operator|->
name|client_random
argument_list|,
name|conn
operator|->
name|server_random
argument_list|,
name|server_params
argument_list|,
name|server_params_end
operator|-
name|server_params
argument_list|,
name|hash
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hlen
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: ServerKeyExchange hash"
argument_list|,
name|hash
argument_list|,
name|hlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|tls_verify_signature
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
argument_list|,
name|conn
operator|->
name|server_rsa_key
argument_list|,
name|hash
argument_list|,
name|hlen
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|alert
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
block|}
return|return
literal|0
return|;
name|fail
label|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Processing DH params failed"
argument_list|)
expr_stmt|;
name|tlsv1_client_free_dh
argument_list|(
name|conn
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_server_key_exchange
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|;
name|u8
name|type
decl_stmt|;
specifier|const
name|struct
name|tls_cipher_suite
modifier|*
name|suite
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected Handshake; "
literal|"received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Too short ServerKeyExchange "
literal|"(Left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Mismatch in ServerKeyExchange "
literal|"length (len=%lu != left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|TLS_HANDSHAKE_TYPE_CERTIFICATE_REQUEST
condition|)
return|return
name|tls_process_certificate_request
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
return|;
if|if
condition|(
name|type
operator|==
name|TLS_HANDSHAKE_TYPE_SERVER_HELLO_DONE
condition|)
return|return
name|tls_process_server_hello_done
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
return|;
if|if
condition|(
name|type
operator|!=
name|TLS_HANDSHAKE_TYPE_SERVER_KEY_EXCHANGE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received unexpected handshake "
literal|"message %d (expected ServerKeyExchange/"
literal|"CertificateRequest/ServerHelloDone)"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received ServerKeyExchange"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tls_server_key_exchange_allowed
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|cipher_suite
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: ServerKeyExchange not allowed "
literal|"with the selected cipher suite"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: ServerKeyExchange"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|suite
operator|=
name|tls_get_cipher_suite
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|cipher_suite
argument_list|)
expr_stmt|;
if|if
condition|(
name|suite
operator|&&
operator|(
name|suite
operator|->
name|key_exchange
operator|==
name|TLS_KEY_X_DH_anon
operator|||
name|suite
operator|->
name|key_exchange
operator|==
name|TLS_KEY_X_DHE_RSA
operator|)
condition|)
block|{
if|if
condition|(
name|tlsv1_process_diffie_hellman
argument_list|(
name|conn
argument_list|,
name|pos
argument_list|,
name|len
argument_list|,
name|suite
operator|->
name|key_exchange
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: UnexpectedServerKeyExchange"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|SERVER_CERTIFICATE_REQUEST
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_certificate_request
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|;
name|u8
name|type
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected Handshake; "
literal|"received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Too short CertificateRequest "
literal|"(left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Mismatch in CertificateRequest "
literal|"length (len=%lu != left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|TLS_HANDSHAKE_TYPE_SERVER_HELLO_DONE
condition|)
return|return
name|tls_process_server_hello_done
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
return|;
if|if
condition|(
name|type
operator|!=
name|TLS_HANDSHAKE_TYPE_CERTIFICATE_REQUEST
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received unexpected handshake "
literal|"message %d (expected CertificateRequest/"
literal|"ServerHelloDone)"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received CertificateRequest"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|certificate_requested
operator|=
literal|1
expr_stmt|;
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|SERVER_HELLO_DONE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_server_hello_done
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|;
name|u8
name|type
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected Handshake; "
literal|"received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Too short ServerHelloDone "
literal|"(left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|type
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|3
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Mismatch in ServerHelloDone "
literal|"length (len=%lu != left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|TLS_HANDSHAKE_TYPE_SERVER_HELLO_DONE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received unexpected handshake "
literal|"message %d (expected ServerHelloDone)"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received ServerHelloDone"
argument_list|)
expr_stmt|;
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|CLIENT_KEY_EXCHANGE
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_server_change_cipher_spec
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|left
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_CHANGE_CIPHER_SPEC
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected ChangeCipherSpec; "
literal|"received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|use_session_ticket
condition|)
block|{
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Server may have "
literal|"rejected SessionTicket"
argument_list|)
expr_stmt|;
name|conn
operator|->
name|use_session_ticket
operator|=
literal|0
expr_stmt|;
comment|/* Notify upper layers that SessionTicket failed */
name|res
operator|=
name|conn
operator|->
name|session_ticket_cb
argument_list|(
name|conn
operator|->
name|session_ticket_cb_ctx
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: SessionTicket "
literal|"callback indicated failure"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_HANDSHAKE_FAILURE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|state
operator|=
name|SERVER_CERTIFICATE
expr_stmt|;
return|return
name|tls_process_certificate
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|in_data
argument_list|,
name|in_len
argument_list|)
return|;
block|}
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Too short ChangeCipherSpec"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|*
name|pos
operator|!=
name|TLS_CHANGE_CIPHER_SPEC
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected ChangeCipherSpec; "
literal|"received data 0x%x"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received ChangeCipherSpec"
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlsv1_record_change_read_cipher
argument_list|(
operator|&
name|conn
operator|->
name|rl
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to change read cipher "
literal|"for record layer"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|in_len
operator|=
name|pos
operator|+
literal|1
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|SERVER_FINISHED
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_server_finished
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|left
decl_stmt|,
name|len
decl_stmt|,
name|hlen
decl_stmt|;
name|u8
name|verify_data
index|[
name|TLS_VERIFY_DATA_LEN
index|]
decl_stmt|;
name|u8
name|hash
index|[
name|MD5_MAC_LEN
operator|+
name|SHA1_MAC_LEN
index|]
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected Finished; "
literal|"received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Too short record (left=%lu) for "
literal|"Finished"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|!=
name|TLS_HANDSHAKE_TYPE_FINISHED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected Finished; received "
literal|"type 0x%x"
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
name|WPA_GET_BE24
argument_list|(
name|pos
operator|+
literal|1
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Too short buffer for Finished "
literal|"(len=%lu> left=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|left
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|TLS_VERIFY_DATA_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Unexpected verify_data length "
literal|"in Finished: %lu (expected %d)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TLSv1: verify_data in Finished"
argument_list|,
name|pos
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TLSV12
if|if
condition|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
operator|>=
name|TLS_VERSION_1_2
condition|)
block|{
name|hlen
operator|=
name|SHA256_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|sha256_server
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha256_server
argument_list|,
name|hash
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|sha256_server
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|verify
operator|.
name|sha256_server
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
endif|#
directive|endif
comment|/* CONFIG_TLSV12 */
name|hlen
operator|=
name|MD5_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|md5_server
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|md5_server
argument_list|,
name|hash
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|md5_server
operator|=
name|NULL
expr_stmt|;
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha1_server
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|conn
operator|->
name|verify
operator|.
name|sha1_server
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|verify
operator|.
name|md5_server
operator|=
name|NULL
expr_stmt|;
name|hlen
operator|=
name|SHA1_MAC_LEN
expr_stmt|;
if|if
condition|(
name|conn
operator|->
name|verify
operator|.
name|sha1_server
operator|==
name|NULL
operator|||
name|crypto_hash_finish
argument_list|(
name|conn
operator|->
name|verify
operator|.
name|sha1_server
argument_list|,
name|hash
operator|+
name|MD5_MAC_LEN
argument_list|,
operator|&
name|hlen
argument_list|)
operator|<
literal|0
condition|)
block|{
name|conn
operator|->
name|verify
operator|.
name|sha1_server
operator|=
name|NULL
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|conn
operator|->
name|verify
operator|.
name|sha1_server
operator|=
name|NULL
expr_stmt|;
name|hlen
operator|=
name|MD5_MAC_LEN
operator|+
name|SHA1_MAC_LEN
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TLSV12
block|}
endif|#
directive|endif
comment|/* CONFIG_TLSV12 */
if|if
condition|(
name|tls_prf
argument_list|(
name|conn
operator|->
name|rl
operator|.
name|tls_version
argument_list|,
name|conn
operator|->
name|master_secret
argument_list|,
name|TLS_MASTER_SECRET_LEN
argument_list|,
literal|"server finished"
argument_list|,
name|hash
argument_list|,
name|hlen
argument_list|,
name|verify_data
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Failed to derive verify_data"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECRYPT_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: verify_data (server)"
argument_list|,
name|verify_data
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp_const
argument_list|(
name|pos
argument_list|,
name|verify_data
argument_list|,
name|TLS_VERIFY_DATA_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"TLSv1: Mismatch in verify_data"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECRYPT_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received Finished"
argument_list|)
expr_stmt|;
operator|*
name|in_len
operator|=
name|end
operator|-
name|in_data
expr_stmt|;
name|conn
operator|->
name|state
operator|=
operator|(
name|conn
operator|->
name|session_resumed
operator|||
name|conn
operator|->
name|use_session_ticket
operator|)
condition|?
name|CHANGE_CIPHER_SPEC
else|:
name|ACK_FINISHED
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|tls_process_application_data
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|in_data
parameter_list|,
name|size_t
modifier|*
name|in_len
parameter_list|,
name|u8
modifier|*
modifier|*
name|out_data
parameter_list|,
name|size_t
modifier|*
name|out_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|left
decl_stmt|;
if|if
condition|(
name|ct
operator|!=
name|TLS_CONTENT_TYPE_APPLICATION_DATA
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Expected Application Data; "
literal|"received content type 0x%x"
argument_list|,
name|ct
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_UNEXPECTED_MESSAGE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|=
name|in_data
expr_stmt|;
name|left
operator|=
operator|*
name|in_len
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Application Data included in Handshake"
argument_list|,
name|pos
argument_list|,
name|left
argument_list|)
expr_stmt|;
operator|*
name|out_data
operator|=
name|os_malloc
argument_list|(
name|left
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|out_data
condition|)
block|{
name|os_memcpy
argument_list|(
operator|*
name|out_data
argument_list|,
name|pos
argument_list|,
name|left
argument_list|)
expr_stmt|;
operator|*
name|out_len
operator|=
name|left
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|tlsv1_client_process_handshake
parameter_list|(
name|struct
name|tlsv1_client
modifier|*
name|conn
parameter_list|,
name|u8
name|ct
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|u8
modifier|*
modifier|*
name|out_data
parameter_list|,
name|size_t
modifier|*
name|out_len
parameter_list|)
block|{
if|if
condition|(
name|ct
operator|==
name|TLS_CONTENT_TYPE_ALERT
condition|)
block|{
if|if
condition|(
operator|*
name|len
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Alert underflow"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Received alert %d:%d"
argument_list|,
name|buf
index|[
literal|0
index|]
argument_list|,
name|buf
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|2
expr_stmt|;
name|conn
operator|->
name|state
operator|=
name|FAILED
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ct
operator|==
name|TLS_CONTENT_TYPE_HANDSHAKE
operator|&&
operator|*
name|len
operator|>=
literal|4
operator|&&
name|buf
index|[
literal|0
index|]
operator|==
name|TLS_HANDSHAKE_TYPE_HELLO_REQUEST
condition|)
block|{
name|size_t
name|hr_len
init|=
name|WPA_GET_BE24
argument_list|(
name|buf
operator|+
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
name|hr_len
operator|>
operator|*
name|len
operator|-
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: HelloRequest underflow"
argument_list|)
expr_stmt|;
name|tls_alert
argument_list|(
name|conn
argument_list|,
name|TLS_ALERT_LEVEL_FATAL
argument_list|,
name|TLS_ALERT_DECODE_ERROR
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Ignored HelloRequest"
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
literal|4
operator|+
name|hr_len
expr_stmt|;
return|return
literal|0
return|;
block|}
switch|switch
condition|(
name|conn
operator|->
name|state
condition|)
block|{
case|case
name|SERVER_HELLO
case|:
if|if
condition|(
name|tls_process_server_hello
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|SERVER_CERTIFICATE
case|:
if|if
condition|(
name|tls_process_certificate
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|SERVER_KEY_EXCHANGE
case|:
if|if
condition|(
name|tls_process_server_key_exchange
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|SERVER_CERTIFICATE_REQUEST
case|:
if|if
condition|(
name|tls_process_certificate_request
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|SERVER_HELLO_DONE
case|:
if|if
condition|(
name|tls_process_server_hello_done
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|SERVER_CHANGE_CIPHER_SPEC
case|:
if|if
condition|(
name|tls_process_server_change_cipher_spec
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|SERVER_FINISHED
case|:
if|if
condition|(
name|tls_process_server_finished
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
case|case
name|ACK_FINISHED
case|:
if|if
condition|(
name|out_data
operator|&&
name|tls_process_application_data
argument_list|(
name|conn
argument_list|,
name|ct
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|out_data
argument_list|,
name|out_len
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TLSv1: Unexpected state %d "
literal|"while processing received message"
argument_list|,
name|conn
operator|->
name|state
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ct
operator|==
name|TLS_CONTENT_TYPE_HANDSHAKE
condition|)
name|tls_verify_hash_add
argument_list|(
operator|&
name|conn
operator|->
name|verify
argument_list|,
name|buf
argument_list|,
operator|*
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


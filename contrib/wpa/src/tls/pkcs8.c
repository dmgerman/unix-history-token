begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * PKCS #8 (Private-key information syntax)  * Copyright (c) 2006-2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"asn1.h"
end_include

begin_include
include|#
directive|include
file|"bignum.h"
end_include

begin_include
include|#
directive|include
file|"rsa.h"
end_include

begin_include
include|#
directive|include
file|"pkcs5.h"
end_include

begin_include
include|#
directive|include
file|"pkcs8.h"
end_include

begin_function
name|struct
name|crypto_private_key
modifier|*
name|pkcs8_key_import
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|struct
name|bignum
modifier|*
name|zero
decl_stmt|;
name|struct
name|asn1_oid
name|oid
decl_stmt|;
name|char
name|obuf
index|[
literal|80
index|]
decl_stmt|;
comment|/* PKCS #8, Chapter 6 */
comment|/* PrivateKeyInfo ::= SEQUENCE */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Does not start with PKCS #8 "
literal|"header (SEQUENCE); assume PKCS #8 not used"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
comment|/* version Version (Version ::= INTEGER) */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_INTEGER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Expected INTEGER - found "
literal|"class %d tag 0x%x; assume PKCS #8 not used"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|zero
operator|=
name|bignum_init
argument_list|()
expr_stmt|;
if|if
condition|(
name|zero
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|bignum_set_unsigned_bin
argument_list|(
name|zero
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Failed to parse INTEGER"
argument_list|)
expr_stmt|;
name|bignum_deinit
argument_list|(
name|zero
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
if|if
condition|(
name|bignum_cmp_d
argument_list|(
name|zero
argument_list|,
literal|0
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Expected zero INTEGER in the "
literal|"beginning of private key; not found; assume "
literal|"PKCS #8 not used"
argument_list|)
expr_stmt|;
name|bignum_deinit
argument_list|(
name|zero
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bignum_deinit
argument_list|(
name|zero
argument_list|)
expr_stmt|;
comment|/* privateKeyAlgorithm PrivateKeyAlgorithmIdentifier 	 * (PrivateKeyAlgorithmIdentifier ::= AlgorithmIdentifier) */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Expected SEQUENCE "
literal|"(AlgorithmIdentifier) - found class %d tag 0x%x; "
literal|"assume PKCS #8 not used"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|asn1_get_oid
argument_list|(
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|,
operator|&
name|oid
argument_list|,
operator|&
name|pos
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Failed to parse OID "
literal|"(algorithm); assume PKCS #8 not used"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|asn1_oid_to_str
argument_list|(
operator|&
name|oid
argument_list|,
name|obuf
argument_list|,
sizeof|sizeof
argument_list|(
name|obuf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: algorithm=%s"
argument_list|,
name|obuf
argument_list|)
expr_stmt|;
if|if
condition|(
name|oid
operator|.
name|len
operator|!=
literal|7
operator|||
name|oid
operator|.
name|oid
index|[
literal|0
index|]
operator|!=
literal|1
comment|/* iso */
operator|||
name|oid
operator|.
name|oid
index|[
literal|1
index|]
operator|!=
literal|2
comment|/* member-body */
operator|||
name|oid
operator|.
name|oid
index|[
literal|2
index|]
operator|!=
literal|840
comment|/* us */
operator|||
name|oid
operator|.
name|oid
index|[
literal|3
index|]
operator|!=
literal|113549
comment|/* rsadsi */
operator|||
name|oid
operator|.
name|oid
index|[
literal|4
index|]
operator|!=
literal|1
comment|/* pkcs */
operator|||
name|oid
operator|.
name|oid
index|[
literal|5
index|]
operator|!=
literal|1
comment|/* pkcs-1 */
operator|||
name|oid
operator|.
name|oid
index|[
literal|6
index|]
operator|!=
literal|1
comment|/* rsaEncryption */
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Unsupported private key "
literal|"algorithm %s"
argument_list|,
name|obuf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
comment|/* privateKey PrivateKey (PrivateKey ::= OCTET STRING) */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_OCTETSTRING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Expected OCTETSTRING "
literal|"(privateKey) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Try to parse RSAPrivateKey"
argument_list|)
expr_stmt|;
return|return
operator|(
expr|struct
name|crypto_private_key
operator|*
operator|)
name|crypto_rsa_import_private_key
argument_list|(
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|crypto_private_key
modifier|*
name|pkcs8_enc_key_import
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|char
modifier|*
name|passwd
parameter_list|)
block|{
name|struct
name|asn1_hdr
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|enc_alg
decl_stmt|;
name|size_t
name|enc_alg_len
decl_stmt|;
name|u8
modifier|*
name|data
decl_stmt|;
name|size_t
name|data_len
decl_stmt|;
if|if
condition|(
name|passwd
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
comment|/* 	 * PKCS #8, Chapter 7 	 * EncryptedPrivateKeyInfo ::= SEQUENCE { 	 *   encryptionAlgorithm EncryptionAlgorithmIdentifier, 	 *   encryptedData EncryptedData } 	 * EncryptionAlgorithmIdentifier ::= AlgorithmIdentifier 	 * EncryptedData ::= OCTET STRING 	 */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Does not start with PKCS #8 "
literal|"header (SEQUENCE); assume encrypted PKCS #8 not "
literal|"used"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
comment|/* encryptionAlgorithm EncryptionAlgorithmIdentifier */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_SEQUENCE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Expected SEQUENCE "
literal|"(AlgorithmIdentifier) - found class %d tag 0x%x; "
literal|"assume encrypted PKCS #8 not used"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|enc_alg
operator|=
name|hdr
operator|.
name|payload
expr_stmt|;
name|enc_alg_len
operator|=
name|hdr
operator|.
name|length
expr_stmt|;
name|pos
operator|=
name|hdr
operator|.
name|payload
operator|+
name|hdr
operator|.
name|length
expr_stmt|;
comment|/* encryptedData EncryptedData */
if|if
condition|(
name|asn1_get_next
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
operator|&
name|hdr
argument_list|)
operator|<
literal|0
operator|||
name|hdr
operator|.
name|class
operator|!=
name|ASN1_CLASS_UNIVERSAL
operator|||
name|hdr
operator|.
name|tag
operator|!=
name|ASN1_TAG_OCTETSTRING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"PKCS #8: Expected OCTETSTRING "
literal|"(encryptedData) - found class %d tag 0x%x"
argument_list|,
name|hdr
operator|.
name|class
argument_list|,
name|hdr
operator|.
name|tag
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|data
operator|=
name|pkcs5_decrypt
argument_list|(
name|enc_alg
argument_list|,
name|enc_alg_len
argument_list|,
name|hdr
operator|.
name|payload
argument_list|,
name|hdr
operator|.
name|length
argument_list|,
name|passwd
argument_list|,
operator|&
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|struct
name|crypto_private_key
modifier|*
name|key
decl_stmt|;
name|key
operator|=
name|pkcs8_key_import
argument_list|(
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|key
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

end_unit


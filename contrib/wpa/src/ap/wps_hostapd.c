begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / WPS integration  * Copyright (c) 2008-2012, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"utils/uuid.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"eapol_auth/eapol_auth_sm.h"
end_include

begin_include
include|#
directive|include
file|"eapol_auth/eapol_auth_sm_i.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_defs.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_dev_attr.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_attr_parse.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ap_drv_ops.h"
end_include

begin_include
include|#
directive|include
file|"beacon.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"wps_hostapd.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
end_ifdef

begin_include
include|#
directive|include
file|"wps/wps_upnp.h"
end_include

begin_function_decl
specifier|static
name|int
name|hostapd_wps_upnp_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hostapd_wps_upnp_deinit
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_UPNP */
end_comment

begin_function_decl
specifier|static
name|int
name|hostapd_wps_probe_req_rx
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|da
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|int
name|ssi_signal
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hostapd_wps_ap_pin_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|hostapd_wps_nfc_clear
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|wps_for_each_data
block|{
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|h
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
function_decl|;
name|void
modifier|*
name|ctx
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|calling_hapd
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wps_for_each
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wps_for_each_data
modifier|*
name|data
init|=
name|ctx
decl_stmt|;
name|size_t
name|j
decl_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|j
operator|++
control|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|iface
operator|->
name|bss
index|[
name|j
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|hapd
operator|!=
name|data
operator|->
name|calling_hapd
operator|&&
operator|(
name|hapd
operator|->
name|conf
operator|->
name|wps_independent
operator|||
name|data
operator|->
name|calling_hapd
operator|->
name|conf
operator|->
name|wps_independent
operator|)
condition|)
continue|continue;
name|ret
operator|=
name|data
operator|->
name|func
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_for_each
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|h
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|hapd
operator|->
name|iface
decl_stmt|;
name|struct
name|wps_for_each_data
name|data
decl_stmt|;
name|data
operator|.
name|func
operator|=
name|func
expr_stmt|;
name|data
operator|.
name|ctx
operator|=
name|ctx
expr_stmt|;
name|data
operator|.
name|calling_hapd
operator|=
name|hapd
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|interfaces
operator|==
name|NULL
operator|||
name|iface
operator|->
name|interfaces
operator|->
name|for_each_interface
operator|==
name|NULL
condition|)
return|return
name|wps_for_each
argument_list|(
name|iface
argument_list|,
operator|&
name|data
argument_list|)
return|;
return|return
name|iface
operator|->
name|interfaces
operator|->
name|for_each_interface
argument_list|(
name|iface
operator|->
name|interfaces
argument_list|,
name|wps_for_each
argument_list|,
operator|&
name|data
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_new_psk_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|struct
name|hostapd_wpa_psk
modifier|*
name|p
decl_stmt|;
name|struct
name|hostapd_ssid
modifier|*
name|ssid
init|=
operator|&
name|hapd
operator|->
name|conf
operator|->
name|ssid
decl_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|p2p_dev_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Received new WPA/WPA2-PSK from WPS for STA "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Received new WPA/WPA2-PSK from WPS for STA "
name|MACSTR
literal|" P2P Device Addr "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|p2p_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Per-device PSK"
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|psk_len
operator|!=
name|PMK_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unexpected PSK length %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|psk_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* Add the new PSK to runtime PSK list */
name|p
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|addr
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|p2p_dev_addr
argument_list|,
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|psk
argument_list|,
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|new_psk_cb
condition|)
block|{
name|hapd
operator|->
name|new_psk_cb
argument_list|(
name|hapd
operator|->
name|new_psk_cb_ctx
argument_list|,
name|mac_addr
argument_list|,
name|p2p_dev_addr
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
block|}
name|p
operator|->
name|next
operator|=
name|ssid
operator|->
name|wpa_psk
expr_stmt|;
name|ssid
operator|->
name|wpa_psk
operator|=
name|p
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|wpa_psk_file
condition|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|hex
index|[
name|PMK_LEN
operator|*
literal|2
operator|+
literal|1
index|]
decl_stmt|;
comment|/* Add the new PSK to PSK list file */
name|f
operator|=
name|fopen
argument_list|(
name|ssid
operator|->
name|wpa_psk_file
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to add the PSK to "
literal|"'%s'"
argument_list|,
name|ssid
operator|->
name|wpa_psk_file
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_snprintf_hex
argument_list|(
name|hex
argument_list|,
sizeof|sizeof
argument_list|(
name|hex
argument_list|)
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
name|MACSTR
literal|" %s\n"
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|,
name|hex
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_set_ie_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|beacon_ie
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|probe_resp_ie
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|wps_beacon_ie
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_beacon_ie
operator|=
name|beacon_ie
expr_stmt|;
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|wps_probe_resp_ie
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_probe_resp_ie
operator|=
name|probe_resp_ie
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|beacon_set_done
condition|)
name|ieee802_11_set_beacon
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
return|return
name|hostapd_set_ap_wps_ie
argument_list|(
name|hapd
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_pin_needed_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|char
name|uuid
index|[
literal|40
index|]
decl_stmt|,
name|txt
index|[
literal|400
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
if|if
condition|(
name|uuid_bin2str
argument_list|(
name|uuid_e
argument_list|,
name|uuid
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid
argument_list|)
argument_list|)
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN needed for E-UUID %s"
argument_list|,
name|uuid
argument_list|)
expr_stmt|;
name|len
operator|=
name|os_snprintf
argument_list|(
name|txt
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
name|WPS_EVENT_PIN_NEEDED
literal|"%s "
name|MACSTR
literal|" [%s|%s|%s|%s|%s|%s]"
argument_list|,
name|uuid
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|mac_addr
argument_list|)
argument_list|,
name|dev
operator|->
name|device_name
argument_list|,
name|dev
operator|->
name|manufacturer
argument_list|,
name|dev
operator|->
name|model_name
argument_list|,
name|dev
operator|->
name|model_number
argument_list|,
name|dev
operator|->
name|serial_number
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|dev
operator|->
name|pri_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|os_snprintf_error
argument_list|(
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
name|len
argument_list|)
condition|)
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
literal|"%s"
argument_list|,
name|txt
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_pin_requests
condition|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|os_time
name|t
decl_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wps_pin_requests
argument_list|,
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return;
name|os_get_time
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"%ld\t%s\t"
name|MACSTR
literal|"\t%s\t%s\t%s\t%s\t%s"
literal|"\t%s\n"
argument_list|,
name|t
operator|.
name|sec
argument_list|,
name|uuid
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|mac_addr
argument_list|)
argument_list|,
name|dev
operator|->
name|device_name
argument_list|,
name|dev
operator|->
name|manufacturer
argument_list|,
name|dev
operator|->
name|model_name
argument_list|,
name|dev
operator|->
name|model_number
argument_list|,
name|dev
operator|->
name|serial_number
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|dev
operator|->
name|pri_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|wps_stop_reg_data
block|{
name|struct
name|hostapd_data
modifier|*
name|current_hapd
decl_stmt|;
specifier|const
name|u8
modifier|*
name|uuid_e
decl_stmt|;
specifier|const
name|u8
modifier|*
name|dev_pw
decl_stmt|;
name|size_t
name|dev_pw_len
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wps_stop_registrar
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wps_stop_reg_data
modifier|*
name|data
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|hapd
operator|!=
name|data
operator|->
name|current_hapd
operator|&&
name|hapd
operator|->
name|wps
operator|!=
name|NULL
condition|)
name|wps_registrar_complete
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|data
operator|->
name|uuid_e
argument_list|,
name|data
operator|->
name|dev_pw
argument_list|,
name|data
operator|->
name|dev_pw_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_reg_success_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_pw
parameter_list|,
name|size_t
name|dev_pw_len
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|char
name|uuid
index|[
literal|40
index|]
decl_stmt|;
name|struct
name|wps_stop_reg_data
name|data
decl_stmt|;
if|if
condition|(
name|uuid_bin2str
argument_list|(
name|uuid_e
argument_list|,
name|uuid
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid
argument_list|)
argument_list|)
condition|)
return|return;
name|wpa_msg
argument_list|(
argument|hapd->msg_ctx
argument_list|,
argument|MSG_INFO
argument_list|,
argument|WPS_EVENT_REG_SUCCESS MACSTR
literal|" %s"
argument_list|,
argument|MAC2STR(mac_addr)
argument_list|,
argument|uuid
argument_list|)
empty_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps_reg_success_cb
condition|)
name|hapd
operator|->
name|wps_reg_success_cb
argument_list|(
name|hapd
operator|->
name|wps_reg_success_cb_ctx
argument_list|,
name|mac_addr
argument_list|,
name|uuid_e
argument_list|)
expr_stmt|;
name|data
operator|.
name|current_hapd
operator|=
name|hapd
expr_stmt|;
name|data
operator|.
name|uuid_e
operator|=
name|uuid_e
expr_stmt|;
name|data
operator|.
name|dev_pw
operator|=
name|dev_pw
expr_stmt|;
name|data
operator|.
name|dev_pw_len
operator|=
name|dev_pw_len
expr_stmt|;
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_stop_registrar
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_enrollee_seen_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|u8
modifier|*
name|pri_dev_type
parameter_list|,
name|u16
name|config_methods
parameter_list|,
name|u16
name|dev_password_id
parameter_list|,
name|u8
name|request_type
parameter_list|,
specifier|const
name|char
modifier|*
name|dev_name
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|char
name|uuid
index|[
literal|40
index|]
decl_stmt|;
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
if|if
condition|(
name|uuid_bin2str
argument_list|(
name|uuid_e
argument_list|,
name|uuid
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid
argument_list|)
argument_list|)
condition|)
return|return;
if|if
condition|(
name|dev_name
operator|==
name|NULL
condition|)
name|dev_name
operator|=
literal|""
expr_stmt|;
name|wpa_msg_ctrl
argument_list|(
argument|hapd->msg_ctx
argument_list|,
argument|MSG_INFO
argument_list|,
argument|WPS_EVENT_ENROLLEE_SEEN MACSTR
literal|" %s %s 0x%x %u %u [%s]"
argument_list|,
argument|MAC2STR(addr)
argument_list|,
argument|uuid
argument_list|,
argument|wps_dev_type_bin2str(pri_dev_type, devtype, 					  sizeof(devtype))
argument_list|,
argument|config_methods
argument_list|,
argument|dev_password_id
argument_list|,
argument|request_type
argument_list|,
argument|dev_name
argument_list|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|str_starts
parameter_list|(
specifier|const
name|char
modifier|*
name|str
parameter_list|,
specifier|const
name|char
modifier|*
name|start
parameter_list|)
block|{
return|return
name|os_strncmp
argument_list|(
name|str
argument_list|,
name|start
argument_list|,
name|os_strlen
argument_list|(
name|start
argument_list|)
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wps_reload_config
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|eloop_data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reload configuration data"
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|interfaces
operator|==
name|NULL
operator|||
name|iface
operator|->
name|interfaces
operator|->
name|reload_config
argument_list|(
name|iface
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Failed to reload the updated "
literal|"configuration"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|hostapd_wps_eap_completed
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
comment|/* 	 * Reduce race condition of the station trying to reconnect immediately 	 * after AP reconfiguration through WPS by rescheduling the reload 	 * timeout to happen after EAP completion rather than the originally 	 * scheduled 100 ms after new configuration became known. 	 */
if|if
condition|(
name|eloop_deplete_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|wps_reload_config
argument_list|,
name|hapd
operator|->
name|iface
argument_list|,
name|NULL
argument_list|)
operator|==
literal|1
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reschedule immediate configuration reload"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hapd_new_ap_event
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|attr
parameter_list|,
name|size_t
name|attr_len
parameter_list|)
block|{
name|size_t
name|blen
init|=
name|attr_len
operator|*
literal|2
operator|+
literal|1
decl_stmt|;
name|char
modifier|*
name|buf
init|=
name|os_malloc
argument_list|(
name|blen
argument_list|)
decl_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
name|blen
argument_list|,
name|attr
argument_list|,
name|attr_len
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_NEW_AP_SETTINGS
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|hapd_wps_reconfig_in_memory
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|hostapd_bss_config
modifier|*
name|bss
init|=
name|hapd
operator|->
name|conf
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Updating in-memory configuration"
argument_list|)
expr_stmt|;
name|bss
operator|->
name|wps_state
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|ssid_len
operator|<=
name|HOSTAPD_MAX_SSID_LEN
condition|)
block|{
name|os_memcpy
argument_list|(
name|bss
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|ssid_len
operator|=
name|cred
operator|->
name|ssid_len
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|ssid_set
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2
operator||
name|WPS_AUTH_WPA2PSK
operator|)
operator|)
operator|&&
operator|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA
operator||
name|WPS_AUTH_WPAPSK
operator|)
operator|)
condition|)
name|bss
operator|->
name|wpa
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2
operator||
name|WPS_AUTH_WPA2PSK
operator|)
condition|)
name|bss
operator|->
name|wpa
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA
operator||
name|WPS_AUTH_WPAPSK
operator|)
condition|)
name|bss
operator|->
name|wpa
operator|=
literal|1
expr_stmt|;
else|else
name|bss
operator|->
name|wpa
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|wpa
condition|)
block|{
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2
operator||
name|WPS_AUTH_WPA
operator|)
condition|)
name|bss
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2PSK
operator||
name|WPS_AUTH_WPAPSK
operator|)
condition|)
name|bss
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|bss
operator|->
name|wpa_pairwise
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|encr_type
operator|&
name|WPS_ENCR_AES
condition|)
name|bss
operator|->
name|wpa_pairwise
operator||=
name|WPA_CIPHER_CCMP
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|encr_type
operator|&
name|WPS_ENCR_TKIP
condition|)
name|bss
operator|->
name|wpa_pairwise
operator||=
name|WPA_CIPHER_TKIP
expr_stmt|;
name|bss
operator|->
name|rsn_pairwise
operator|=
name|bss
operator|->
name|wpa_pairwise
expr_stmt|;
name|bss
operator|->
name|wpa_group
operator|=
name|wpa_select_ap_group_cipher
argument_list|(
name|bss
operator|->
name|wpa
argument_list|,
name|bss
operator|->
name|wpa_pairwise
argument_list|,
name|bss
operator|->
name|rsn_pairwise
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|key_len
operator|>=
literal|8
operator|&&
name|cred
operator|->
name|key_len
operator|<
literal|64
condition|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|wpa_passphrase
operator|=
name|os_zalloc
argument_list|(
name|cred
operator|->
name|key_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|ssid
operator|.
name|wpa_passphrase
condition|)
name|os_memcpy
argument_list|(
name|bss
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|hostapd_config_clear_wpa_psk
argument_list|(
operator|&
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cred
operator|->
name|key_len
operator|==
literal|64
condition|)
block|{
name|hostapd_config_clear_wpa_psk
argument_list|(
operator|&
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_wpa_psk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
operator|&&
name|hexstr2bin
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|cred
operator|->
name|key
argument_list|,
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|->
name|ssid
operator|.
name|wpa_psk
operator|->
name|group
operator|=
literal|1
expr_stmt|;
name|os_free
argument_list|(
name|bss
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid
operator|.
name|wpa_passphrase
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|bss
operator|->
name|auth_algs
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * WPS 2.0 does not allow WEP to be configured, so no need to 		 * process that option here either. 		 */
name|bss
operator|->
name|auth_algs
operator|=
literal|1
expr_stmt|;
block|}
comment|/* Schedule configuration reload after short period of time to allow 	 * EAP-WSC to be finished. 	 */
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|100000
argument_list|,
name|wps_reload_config
argument_list|,
name|hapd
operator|->
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hapd_wps_cred_cb
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
init|=
name|ctx
decl_stmt|;
name|FILE
modifier|*
name|oconf
decl_stmt|,
modifier|*
name|nconf
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|i
decl_stmt|;
name|char
modifier|*
name|tmp_fname
decl_stmt|;
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|multi_bss
decl_stmt|;
name|int
name|wpa
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received Credential attribute"
argument_list|,
name|cred
operator|->
name|cred_attr
argument_list|,
name|cred
operator|->
name|cred_attr_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received new AP Settings"
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: SSID"
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authentication Type 0x%x"
argument_list|,
name|cred
operator|->
name|auth_type
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Encryption Type 0x%x"
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network Key Index %d"
argument_list|,
name|cred
operator|->
name|key_idx
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network Key"
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MAC Address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|cred
operator|->
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
operator|||
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|2
operator|)
operator|&&
name|cred
operator|->
name|cred_attr
condition|)
block|{
name|hapd_new_ap_event
argument_list|(
name|hapd
argument_list|,
name|cred
operator|->
name|cred_attr
argument_list|,
name|cred
operator|->
name|cred_attr_len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
operator|||
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|2
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|attr
decl_stmt|;
name|attr
operator|=
name|wpabuf_alloc
argument_list|(
literal|200
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|&&
name|wps_build_credential_wrap
argument_list|(
name|attr
argument_list|,
name|cred
argument_list|)
operator|==
literal|0
condition|)
name|hapd_new_ap_event
argument_list|(
name|hapd
argument_list|,
name|wpabuf_head_u8
argument_list|(
name|attr
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|attr
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|attr
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_NEW_AP_SETTINGS
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
condition|)
return|return
literal|0
return|;
name|os_memcpy
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|ssid_len
operator|=
name|cred
operator|->
name|ssid_len
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|encr_types
operator|=
name|cred
operator|->
name|encr_type
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|auth_types
operator|=
name|cred
operator|->
name|auth_type
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|ap_encr_type
operator|=
name|cred
operator|->
name|encr_type
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|ap_auth_type
operator|=
name|cred
operator|->
name|auth_type
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|key_len
operator|==
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|network_key
operator|=
name|NULL
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|network_key_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
operator|==
name|NULL
operator|||
name|hapd
operator|->
name|wps
operator|->
name|network_key_len
operator|<
name|cred
operator|->
name|key_len
condition|)
block|{
name|hapd
operator|->
name|wps
operator|->
name|network_key_len
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|network_key
operator|=
name|os_malloc
argument_list|(
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|hapd
operator|->
name|wps
operator|->
name|network_key_len
operator|=
name|cred
operator|->
name|key_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|network_key
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
block|}
name|hapd
operator|->
name|wps
operator|->
name|wps_state
operator|=
name|WPS_STATE_CONFIGURED
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|iface
operator|->
name|config_fname
operator|==
name|NULL
condition|)
return|return
name|hapd_wps_reconfig_in_memory
argument_list|(
name|hapd
argument_list|,
name|cred
argument_list|)
return|;
name|len
operator|=
name|os_strlen
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|config_fname
argument_list|)
operator|+
literal|5
expr_stmt|;
name|tmp_fname
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp_fname
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_snprintf
argument_list|(
name|tmp_fname
argument_list|,
name|len
argument_list|,
literal|"%s-new"
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|config_fname
argument_list|)
expr_stmt|;
name|oconf
operator|=
name|fopen
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|config_fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|oconf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Could not open current "
literal|"configuration file"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tmp_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|nconf
operator|=
name|fopen
argument_list|(
name|tmp_fname
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|nconf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Could not write updated "
literal|"configuration file"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tmp_fname
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|oconf
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"# WPS configuration - START\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wps_state=2\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_hex
argument_list|(
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"ssid2="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|ssid_len
condition|;
name|i
operator|++
control|)
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"%02x"
argument_list|,
name|cred
operator|->
name|ssid
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"ssid="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|ssid_len
condition|;
name|i
operator|++
control|)
name|fputc
argument_list|(
name|cred
operator|->
name|ssid
index|[
name|i
index|]
argument_list|,
name|nconf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2
operator||
name|WPS_AUTH_WPA2PSK
operator|)
operator|)
operator|&&
operator|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA
operator||
name|WPS_AUTH_WPAPSK
operator|)
operator|)
condition|)
name|wpa
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2
operator||
name|WPS_AUTH_WPA2PSK
operator|)
condition|)
name|wpa
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA
operator||
name|WPS_AUTH_WPAPSK
operator|)
condition|)
name|wpa
operator|=
literal|1
expr_stmt|;
else|else
name|wpa
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa
condition|)
block|{
name|char
modifier|*
name|prefix
decl_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wpa=%d\n"
argument_list|,
name|wpa
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wpa_key_mgmt="
argument_list|)
expr_stmt|;
name|prefix
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2
operator||
name|WPS_AUTH_WPA
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"WPA-EAP"
argument_list|)
expr_stmt|;
name|prefix
operator|=
literal|" "
expr_stmt|;
block|}
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPA2PSK
operator||
name|WPS_AUTH_WPAPSK
operator|)
condition|)
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"%sWPA-PSK"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wpa_pairwise="
argument_list|)
expr_stmt|;
name|prefix
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|encr_type
operator|&
name|WPS_ENCR_AES
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"CCMP"
argument_list|)
expr_stmt|;
name|prefix
operator|=
literal|" "
expr_stmt|;
block|}
if|if
condition|(
name|cred
operator|->
name|encr_type
operator|&
name|WPS_ENCR_TKIP
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"%sTKIP"
argument_list|,
name|prefix
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|key_len
operator|>=
literal|8
operator|&&
name|cred
operator|->
name|key_len
operator|<
literal|64
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wpa_passphrase="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|key_len
condition|;
name|i
operator|++
control|)
name|fputc
argument_list|(
name|cred
operator|->
name|key
index|[
name|i
index|]
argument_list|,
name|nconf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cred
operator|->
name|key_len
operator|==
literal|64
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"wpa_psk="
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|key_len
condition|;
name|i
operator|++
control|)
name|fputc
argument_list|(
name|cred
operator|->
name|key
index|[
name|i
index|]
argument_list|,
name|nconf
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Invalid key length %lu "
literal|"for WPA/WPA2"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"auth_algs=1\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * WPS 2.0 does not allow WEP to be configured, so no need to 		 * process that option here either. 		 */
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"auth_algs=1\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"# WPS configuration - END\n"
argument_list|)
expr_stmt|;
name|multi_bss
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|oconf
argument_list|)
condition|)
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"bss="
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|multi_bss
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|multi_bss
operator|&&
operator|(
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"ssid="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"ssid2="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"auth_algs="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wep_default_key="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wep_key"
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wps_state="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wpa="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wpa_psk="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wpa_pairwise="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"rsn_pairwise="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wpa_key_mgmt="
argument_list|)
operator|||
name|str_starts
argument_list|(
name|buf
argument_list|,
literal|"wpa_passphrase="
argument_list|)
operator|)
condition|)
block|{
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"#WPS# %s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
name|fprintf
argument_list|(
name|nconf
argument_list|,
literal|"%s"
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|nconf
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|oconf
argument_list|)
expr_stmt|;
if|if
condition|(
name|rename
argument_list|(
name|tmp_fname
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|config_fname
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WPS: Failed to rename the updated "
literal|"configuration file: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tmp_fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|tmp_fname
argument_list|)
expr_stmt|;
comment|/* Schedule configuration reload after short period of time to allow 	 * EAP-WSC to be finished. 	 */
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|100000
argument_list|,
name|wps_reload_config
argument_list|,
name|hapd
operator|->
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP configuration updated"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_cred_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
return|return
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|hapd_wps_cred_cb
argument_list|,
operator|(
name|void
operator|*
operator|)
name|cred
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_reenable_ap_pin
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|eloop_data
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ap_setup_locked
condition|)
return|return;
if|if
condition|(
name|hapd
operator|->
name|ap_pin_failures_consecutive
operator|>=
literal|10
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Re-enable AP PIN"
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_SETUP_UNLOCKED
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|ap_setup_locked
operator|=
literal|0
expr_stmt|;
name|wps_registrar_update_ie
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_pwd_auth_fail
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wps_event_pwd_auth_fail
modifier|*
name|data
init|=
name|ctx
decl_stmt|;
if|if
condition|(
operator|!
name|data
operator|->
name|enrollee
operator|||
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
operator|==
name|NULL
operator|||
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* 	 * Registrar failed to prove its knowledge of the AP PIN. Lock AP setup 	 * for some time if this happens multiple times to slow down brute 	 * force attacks. 	 */
name|hapd
operator|->
name|ap_pin_failures
operator|++
expr_stmt|;
name|hapd
operator|->
name|ap_pin_failures_consecutive
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP PIN authentication failure number %u "
literal|"(%u consecutive)"
argument_list|,
name|hapd
operator|->
name|ap_pin_failures
argument_list|,
name|hapd
operator|->
name|ap_pin_failures_consecutive
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|ap_pin_failures
operator|<
literal|3
condition|)
return|return
literal|0
return|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_SETUP_LOCKED
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|ap_setup_locked
operator|=
literal|1
expr_stmt|;
name|wps_registrar_update_ie
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|conf
operator|->
name|ap_setup_locked
operator|&&
name|hapd
operator|->
name|ap_pin_failures_consecutive
operator|>=
literal|10
condition|)
block|{
comment|/* 		 * In indefinite lockdown - disable automatic AP PIN 		 * reenablement. 		 */
name|eloop_cancel_timeout
argument_list|(
name|hostapd_wps_reenable_ap_pin
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP PIN disabled indefinitely"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|hapd
operator|->
name|conf
operator|->
name|ap_setup_locked
condition|)
block|{
if|if
condition|(
name|hapd
operator|->
name|ap_pin_lockout_time
operator|==
literal|0
condition|)
name|hapd
operator|->
name|ap_pin_lockout_time
operator|=
literal|60
expr_stmt|;
elseif|else
if|if
condition|(
name|hapd
operator|->
name|ap_pin_lockout_time
operator|<
literal|365
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60
operator|&&
operator|(
name|hapd
operator|->
name|ap_pin_failures
operator|%
literal|3
operator|)
operator|==
literal|0
condition|)
name|hapd
operator|->
name|ap_pin_lockout_time
operator|*=
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Disable AP PIN for %u seconds"
argument_list|,
name|hapd
operator|->
name|ap_pin_lockout_time
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|hostapd_wps_reenable_ap_pin
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|hapd
operator|->
name|ap_pin_lockout_time
argument_list|,
literal|0
argument_list|,
name|hostapd_wps_reenable_ap_pin
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_pwd_auth_fail
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wps_event_pwd_auth_fail
modifier|*
name|data
parameter_list|)
block|{
comment|/* Update WPS Status - Authentication Failure */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authentication failure update"
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_stats
operator|.
name|status
operator|=
name|WPS_STATUS_FAILURE
expr_stmt|;
name|hapd
operator|->
name|wps_stats
operator|.
name|failure_reason
operator|=
name|WPS_EI_AUTH_FAILURE
expr_stmt|;
name|os_memcpy
argument_list|(
name|hapd
operator|->
name|wps_stats
operator|.
name|peer_addr
argument_list|,
name|data
operator|->
name|peer_macaddr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_pwd_auth_fail
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_ap_pin_success
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
operator|==
name|NULL
operator|||
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|hapd
operator|->
name|ap_pin_failures_consecutive
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Clear consecutive AP PIN failure counter "
literal|"- total validation failures %u (%u consecutive)"
argument_list|,
name|hapd
operator|->
name|ap_pin_failures
argument_list|,
name|hapd
operator|->
name|ap_pin_failures_consecutive
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|ap_pin_failures_consecutive
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_ap_pin_success
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_ap_pin_success
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_event_pbc_overlap
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
comment|/* Update WPS Status - PBC Overlap */
name|hapd
operator|->
name|wps_stats
operator|.
name|pbc_status
operator|=
name|WPS_PBC_STATUS_OVERLAP
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_event_pbc_timeout
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
comment|/* Update WPS PBC Status:PBC Timeout */
name|hapd
operator|->
name|wps_stats
operator|.
name|pbc_status
operator|=
name|WPS_PBC_STATUS_TIMEOUT
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_event_pbc_active
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
comment|/* Update WPS PBC status - Active */
name|hapd
operator|->
name|wps_stats
operator|.
name|pbc_status
operator|=
name|WPS_PBC_STATUS_ACTIVE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_event_pbc_disable
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
comment|/* Update WPS PBC status - Active */
name|hapd
operator|->
name|wps_stats
operator|.
name|pbc_status
operator|=
name|WPS_PBC_STATUS_DISABLE
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_event_success
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wps_event_success
modifier|*
name|success
parameter_list|)
block|{
comment|/* Update WPS status - Success */
name|hapd
operator|->
name|wps_stats
operator|.
name|pbc_status
operator|=
name|WPS_PBC_STATUS_DISABLE
expr_stmt|;
name|hapd
operator|->
name|wps_stats
operator|.
name|status
operator|=
name|WPS_STATUS_SUCCESS
expr_stmt|;
name|os_memcpy
argument_list|(
name|hapd
operator|->
name|wps_stats
operator|.
name|peer_addr
argument_list|,
name|success
operator|->
name|peer_macaddr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_event_fail
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wps_event_fail
modifier|*
name|fail
parameter_list|)
block|{
comment|/* Update WPS status - Failure */
name|hapd
operator|->
name|wps_stats
operator|.
name|status
operator|=
name|WPS_STATUS_FAILURE
expr_stmt|;
name|os_memcpy
argument_list|(
name|hapd
operator|->
name|wps_stats
operator|.
name|peer_addr
argument_list|,
name|fail
operator|->
name|peer_macaddr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_stats
operator|.
name|failure_reason
operator|=
name|fail
operator|->
name|error_indication
expr_stmt|;
if|if
condition|(
name|fail
operator|->
name|error_indication
operator|>
literal|0
operator|&&
name|fail
operator|->
name|error_indication
operator|<
name|NUM_WPS_EI_VALUES
condition|)
block|{
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_FAIL
literal|"msg=%d config_error=%d reason=%d (%s)"
argument_list|,
name|fail
operator|->
name|msg
argument_list|,
name|fail
operator|->
name|config_error
argument_list|,
name|fail
operator|->
name|error_indication
argument_list|,
name|wps_ei_str
argument_list|(
name|fail
operator|->
name|error_indication
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_FAIL
literal|"msg=%d config_error=%d"
argument_list|,
name|fail
operator|->
name|msg
argument_list|,
name|fail
operator|->
name|config_error
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_event_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|wps_event
name|event
parameter_list|,
name|union
name|wps_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|WPS_EV_M2D
case|:
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_M2D
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_FAIL
case|:
name|hostapd_wps_event_fail
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|fail
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_SUCCESS
case|:
name|hostapd_wps_event_success
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|success
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_SUCCESS
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_PWD_AUTH_FAIL
case|:
name|hostapd_pwd_auth_fail
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|pwd_auth_fail
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_PBC_OVERLAP
case|:
name|hostapd_wps_event_pbc_overlap
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_OVERLAP
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_PBC_TIMEOUT
case|:
name|hostapd_wps_event_pbc_timeout
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_TIMEOUT
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_PBC_ACTIVE
case|:
name|hostapd_wps_event_pbc_active
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_ACTIVE
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_PBC_DISABLE
case|:
name|hostapd_wps_event_pbc_disable
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_DISABLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_ER_AP_ADD
case|:
break|break;
case|case
name|WPS_EV_ER_AP_REMOVE
case|:
break|break;
case|case
name|WPS_EV_ER_ENROLLEE_ADD
case|:
break|break;
case|case
name|WPS_EV_ER_ENROLLEE_REMOVE
case|:
break|break;
case|case
name|WPS_EV_ER_AP_SETTINGS
case|:
break|break;
case|case
name|WPS_EV_ER_SET_SELECTED_REGISTRAR
case|:
break|break;
case|case
name|WPS_EV_AP_PIN_SUCCESS
case|:
name|hostapd_wps_ap_pin_success
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|hapd
operator|->
name|wps_event_cb
condition|)
name|hapd
operator|->
name|wps_event_cb
argument_list|(
name|hapd
operator|->
name|wps_event_cb_ctx
argument_list|,
name|event
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_rf_band_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
return|return
name|hapd
operator|->
name|iconf
operator|->
name|hw_mode
operator|==
name|HOSTAPD_MODE_IEEE80211A
condition|?
name|WPS_RF_50GHZ
else|:
name|WPS_RF_24GHZ
return|;
comment|/* FIX: dualband AP */
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_clear_ies
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
name|deinit_only
parameter_list|)
block|{
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|wps_beacon_ie
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_beacon_ie
operator|=
name|NULL
expr_stmt|;
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|wps_probe_resp_ie
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_probe_resp_ie
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|deinit_only
condition|)
return|return;
name|hostapd_set_ap_wps_ie
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|get_uuid_cb
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
modifier|*
name|uuid
init|=
name|ctx
decl_stmt|;
name|size_t
name|j
decl_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|j
operator|++
control|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|iface
operator|->
name|bss
index|[
name|j
index|]
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|&&
operator|!
name|hapd
operator|->
name|conf
operator|->
name|wps_independent
operator|&&
operator|!
name|is_nil_uuid
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|uuid
argument_list|)
condition|)
block|{
operator|*
name|uuid
operator|=
name|hapd
operator|->
name|wps
operator|->
name|uuid
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|get_own_uuid
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|uuid
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|interfaces
operator|==
name|NULL
operator|||
name|iface
operator|->
name|interfaces
operator|->
name|for_each_interface
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|uuid
operator|=
name|NULL
expr_stmt|;
name|iface
operator|->
name|interfaces
operator|->
name|for_each_interface
argument_list|(
name|iface
operator|->
name|interfaces
argument_list|,
name|get_uuid_cb
argument_list|,
operator|&
name|uuid
argument_list|)
expr_stmt|;
return|return
name|uuid
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|count_interface_cb
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|int
modifier|*
name|count
init|=
name|ctx
decl_stmt|;
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|interface_count
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|)
block|{
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|interfaces
operator|==
name|NULL
operator|||
name|iface
operator|->
name|interfaces
operator|->
name|for_each_interface
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|iface
operator|->
name|interfaces
operator|->
name|for_each_interface
argument_list|(
name|iface
operator|->
name|interfaces
argument_list|,
name|count_interface_cb
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
return|return
name|count
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_set_vendor_ext
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_WPS_VENDOR_EXTENSIONS
condition|;
name|i
operator|++
control|)
block|{
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|vendor_ext
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|wps
operator|->
name|dev
operator|.
name|vendor_ext
index|[
name|i
index|]
operator|=
name|wpabuf_dup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dev
operator|.
name|vendor_ext
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
while|while
condition|(
operator|--
name|i
operator|>=
literal|0
condition|)
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_free_wps
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_WPS_VENDOR_EXTENSIONS
condition|;
name|i
operator|++
control|)
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|wps_device_data_free
argument_list|(
operator|&
name|wps
operator|->
name|dev
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
operator|->
name|network_key
argument_list|)
expr_stmt|;
name|hostapd_wps_nfc_clear
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_pubkey
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_privkey
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|hostapd_init_wps
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|hostapd_bss_config
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|wps_context
modifier|*
name|wps
decl_stmt|;
name|struct
name|wps_registrar_config
name|cfg
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|wps_state
operator|==
literal|0
condition|)
block|{
name|hostapd_wps_clear_ies
argument_list|(
name|hapd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wps
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wps
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wps
operator|->
name|cred_cb
operator|=
name|hostapd_wps_cred_cb
expr_stmt|;
name|wps
operator|->
name|event_cb
operator|=
name|hostapd_wps_event_cb
expr_stmt|;
name|wps
operator|->
name|rf_band_cb
operator|=
name|hostapd_wps_rf_band_cb
expr_stmt|;
name|wps
operator|->
name|cb_ctx
operator|=
name|hapd
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
name|wps
operator|->
name|wps_state
operator|=
name|hapd
operator|->
name|conf
operator|->
name|wps_state
expr_stmt|;
name|wps
operator|->
name|ap_setup_locked
operator|=
name|hapd
operator|->
name|conf
operator|->
name|ap_setup_locked
expr_stmt|;
if|if
condition|(
name|is_nil_uuid
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|uuid
argument_list|)
condition|)
block|{
specifier|const
name|u8
modifier|*
name|uuid
decl_stmt|;
name|uuid
operator|=
name|get_own_uuid
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
expr_stmt|;
if|if
condition|(
name|uuid
operator|&&
operator|!
name|conf
operator|->
name|wps_independent
condition|)
block|{
name|os_memcpy
argument_list|(
name|wps
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Clone UUID from another "
literal|"interface"
argument_list|,
name|wps
operator|->
name|uuid
argument_list|,
name|UUID_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|uuid_gen_mac_addr
argument_list|(
name|hapd
operator|->
name|own_addr
argument_list|,
name|wps
operator|->
name|uuid
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID based on MAC "
literal|"address"
argument_list|,
name|wps
operator|->
name|uuid
argument_list|,
name|UUID_LEN
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|wps
operator|->
name|uuid
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|uuid
argument_list|,
name|UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Use configured UUID"
argument_list|,
name|wps
operator|->
name|uuid
argument_list|,
name|UUID_LEN
argument_list|)
expr_stmt|;
block|}
name|wps
operator|->
name|ssid_len
operator|=
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|ssid
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|wps
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|,
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|device_name
operator|=
name|hapd
operator|->
name|conf
operator|->
name|device_name
condition|?
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|device_name
argument_list|)
else|:
name|NULL
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|manufacturer
operator|=
name|hapd
operator|->
name|conf
operator|->
name|manufacturer
condition|?
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|manufacturer
argument_list|)
else|:
name|NULL
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|model_name
operator|=
name|hapd
operator|->
name|conf
operator|->
name|model_name
condition|?
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|model_name
argument_list|)
else|:
name|NULL
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|model_number
operator|=
name|hapd
operator|->
name|conf
operator|->
name|model_number
condition|?
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|model_number
argument_list|)
else|:
name|NULL
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|serial_number
operator|=
name|hapd
operator|->
name|conf
operator|->
name|serial_number
condition|?
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|serial_number
argument_list|)
else|:
name|NULL
expr_stmt|;
name|wps
operator|->
name|config_methods
operator|=
name|wps_config_methods_str2bin
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|config_methods
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wps
operator|->
name|config_methods
operator|&
operator|(
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_VIRT_DISPLAY
operator||
name|WPS_CONFIG_PHY_DISPLAY
operator|)
operator|)
operator|==
name|WPS_CONFIG_DISPLAY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Converting display to "
literal|"virtual_display for WPS 2.0 compliance"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_methods
operator||=
name|WPS_CONFIG_VIRT_DISPLAY
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|wps
operator|->
name|config_methods
operator|&
operator|(
name|WPS_CONFIG_PUSHBUTTON
operator||
name|WPS_CONFIG_VIRT_PUSHBUTTON
operator||
name|WPS_CONFIG_PHY_PUSHBUTTON
operator|)
operator|)
operator|==
name|WPS_CONFIG_PUSHBUTTON
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Converting push_button to "
literal|"virtual_push_button for WPS 2.0 compliance"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_methods
operator||=
name|WPS_CONFIG_VIRT_PUSHBUTTON
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|pri_dev_type
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|device_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_wps_set_vendor_ext
argument_list|(
name|hapd
argument_list|,
name|wps
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|wps
operator|->
name|dev
operator|.
name|os_version
operator|=
name|WPA_GET_BE32
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|os_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wps_rf_bands
condition|)
block|{
name|wps
operator|->
name|dev
operator|.
name|rf_bands
operator|=
name|conf
operator|->
name|wps_rf_bands
expr_stmt|;
block|}
else|else
block|{
name|wps
operator|->
name|dev
operator|.
name|rf_bands
operator|=
name|hapd
operator|->
name|iconf
operator|->
name|hw_mode
operator|==
name|HOSTAPD_MODE_IEEE80211A
condition|?
name|WPS_RF_50GHZ
else|:
name|WPS_RF_24GHZ
expr_stmt|;
comment|/* FIX: dualband AP */
block|}
if|if
condition|(
name|conf
operator|->
name|wpa
operator|&
name|WPA_PROTO_RSN
condition|)
block|{
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_WPA2
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|rsn_pairwise
operator|&
operator|(
name|WPA_CIPHER_CCMP
operator||
name|WPA_CIPHER_GCMP
operator|)
condition|)
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_AES
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|rsn_pairwise
operator|&
name|WPA_CIPHER_TKIP
condition|)
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_TKIP
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|wpa
operator|&
name|WPA_PROTO_WPA
condition|)
block|{
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_WPAPSK
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_WPA
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wpa_pairwise
operator|&
name|WPA_CIPHER_CCMP
condition|)
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_AES
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wpa_pairwise
operator|&
name|WPA_CIPHER_TKIP
condition|)
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_TKIP
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|security_policy
operator|==
name|SECURITY_PLAINTEXT
condition|)
block|{
name|wps
operator|->
name|encr_types
operator||=
name|WPS_ENCR_NONE
expr_stmt|;
name|wps
operator|->
name|auth_types
operator||=
name|WPS_AUTH_OPEN
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk_file
condition|)
block|{
comment|/* Use per-device PSKs */
block|}
elseif|else
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
condition|)
block|{
name|wps
operator|->
name|network_key
operator|=
operator|(
name|u8
operator|*
operator|)
name|os_strdup
argument_list|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|)
expr_stmt|;
name|wps
operator|->
name|network_key_len
operator|=
name|os_strlen
argument_list|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
condition|)
block|{
name|wps
operator|->
name|network_key
operator|=
name|os_malloc
argument_list|(
literal|2
operator|*
name|PMK_LEN
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|network_key
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|wpa_snprintf_hex
argument_list|(
operator|(
name|char
operator|*
operator|)
name|wps
operator|->
name|network_key
argument_list|,
literal|2
operator|*
name|PMK_LEN
operator|+
literal|1
argument_list|,
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wps
operator|->
name|network_key_len
operator|=
literal|2
operator|*
name|PMK_LEN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|keys_set
operator|&&
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|key
index|[
literal|0
index|]
condition|)
block|{
name|wps
operator|->
name|network_key
operator|=
name|os_malloc
argument_list|(
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|len
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|network_key
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|network_key
argument_list|,
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|key
index|[
literal|0
index|]
argument_list|,
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|len
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|wps
operator|->
name|network_key_len
operator|=
name|conf
operator|->
name|ssid
operator|.
name|wep
operator|.
name|len
index|[
literal|0
index|]
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
condition|)
block|{
name|os_memcpy
argument_list|(
name|wps
operator|->
name|psk
argument_list|,
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wps
operator|->
name|psk_set
operator|=
literal|1
expr_stmt|;
block|}
name|wps
operator|->
name|ap_auth_type
operator|=
name|wps
operator|->
name|auth_types
expr_stmt|;
name|wps
operator|->
name|ap_encr_type
operator|=
name|wps
operator|->
name|encr_types
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wps_state
operator|==
name|WPS_STATE_NOT_CONFIGURED
condition|)
block|{
comment|/* Override parameters to enable security by default */
name|wps
operator|->
name|auth_types
operator|=
name|WPS_AUTH_WPA2PSK
operator||
name|WPS_AUTH_WPAPSK
expr_stmt|;
name|wps
operator|->
name|encr_types
operator|=
name|WPS_ENCR_AES
operator||
name|WPS_ENCR_TKIP
expr_stmt|;
block|}
name|wps
operator|->
name|ap_settings
operator|=
name|conf
operator|->
name|ap_settings
expr_stmt|;
name|wps
operator|->
name|ap_settings_len
operator|=
name|conf
operator|->
name|ap_settings_len
expr_stmt|;
name|cfg
operator|.
name|new_psk_cb
operator|=
name|hostapd_wps_new_psk_cb
expr_stmt|;
name|cfg
operator|.
name|set_ie_cb
operator|=
name|hostapd_wps_set_ie_cb
expr_stmt|;
name|cfg
operator|.
name|pin_needed_cb
operator|=
name|hostapd_wps_pin_needed_cb
expr_stmt|;
name|cfg
operator|.
name|reg_success_cb
operator|=
name|hostapd_wps_reg_success_cb
expr_stmt|;
name|cfg
operator|.
name|enrollee_seen_cb
operator|=
name|hostapd_wps_enrollee_seen_cb
expr_stmt|;
name|cfg
operator|.
name|cb_ctx
operator|=
name|hapd
expr_stmt|;
name|cfg
operator|.
name|skip_cred_build
operator|=
name|conf
operator|->
name|skip_cred_build
expr_stmt|;
name|cfg
operator|.
name|extra_cred
operator|=
name|conf
operator|->
name|extra_cred
expr_stmt|;
name|cfg
operator|.
name|extra_cred_len
operator|=
name|conf
operator|->
name|extra_cred_len
expr_stmt|;
name|cfg
operator|.
name|disable_auto_conf
operator|=
operator|(
name|hapd
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
operator|)
operator|&&
name|conf
operator|->
name|skip_cred_build
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|ssid
operator|.
name|security_policy
operator|==
name|SECURITY_STATIC_WEP
condition|)
name|cfg
operator|.
name|static_wep_only
operator|=
literal|1
expr_stmt|;
name|cfg
operator|.
name|dualband
operator|=
name|interface_count
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
operator|>
literal|1
expr_stmt|;
if|if
condition|(
operator|(
name|wps
operator|->
name|dev
operator|.
name|rf_bands
operator|&
operator|(
name|WPS_RF_50GHZ
operator||
name|WPS_RF_24GHZ
operator|)
operator|)
operator|==
operator|(
name|WPS_RF_50GHZ
operator||
name|WPS_RF_24GHZ
operator|)
condition|)
name|cfg
operator|.
name|dualband
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|cfg
operator|.
name|dualband
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Dualband AP"
argument_list|)
expr_stmt|;
name|cfg
operator|.
name|force_per_enrollee_psk
operator|=
name|conf
operator|->
name|force_per_enrollee_psk
expr_stmt|;
name|wps
operator|->
name|registrar
operator|=
name|wps_registrar_init
argument_list|(
name|wps
argument_list|,
operator|&
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|registrar
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize WPS Registrar"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
name|wps
operator|->
name|friendly_name
operator|=
name|hapd
operator|->
name|conf
operator|->
name|friendly_name
expr_stmt|;
name|wps
operator|->
name|manufacturer_url
operator|=
name|hapd
operator|->
name|conf
operator|->
name|manufacturer_url
expr_stmt|;
name|wps
operator|->
name|model_description
operator|=
name|hapd
operator|->
name|conf
operator|->
name|model_description
expr_stmt|;
name|wps
operator|->
name|model_url
operator|=
name|hapd
operator|->
name|conf
operator|->
name|model_url
expr_stmt|;
name|wps
operator|->
name|upc
operator|=
name|hapd
operator|->
name|conf
operator|->
name|upc
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|hostapd_register_probereq_cb
argument_list|(
name|hapd
argument_list|,
name|hostapd_wps_probe_req_rx
argument_list|,
name|hapd
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|=
name|wps
expr_stmt|;
return|return
literal|0
return|;
name|fail
label|:
name|hostapd_free_wps
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|hostapd_init_wps_complete
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|struct
name|wps_context
modifier|*
name|wps
init|=
name|hapd
operator|->
name|wps
decl_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
if|if
condition|(
name|hostapd_wps_upnp_init
argument_list|(
name|hapd
argument_list|,
name|wps
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize WPS UPnP"
argument_list|)
expr_stmt|;
name|wps_registrar_deinit
argument_list|(
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
name|hostapd_free_wps
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_nfc_clear
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Clear NFC Tag context %p"
argument_list|,
name|wps
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dev_pw_id
operator|=
literal|0
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|ap_nfc_dh_pubkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dh_pubkey
operator|=
name|NULL
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|ap_nfc_dh_privkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dh_privkey
operator|=
name|NULL
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|ap_nfc_dev_pw
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dev_pw
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
block|}
end_function

begin_function
name|void
name|hostapd_deinit_wps
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|hostapd_wps_reenable_ap_pin
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|hostapd_wps_ap_pin_timeout
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wps_reload_config
argument_list|,
name|hapd
operator|->
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
block|{
name|hostapd_wps_clear_ies
argument_list|(
name|hapd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
name|hostapd_wps_upnp_deinit
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|wps_registrar_deinit
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
name|wps_free_pending_msgs
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|upnp_msgs
argument_list|)
expr_stmt|;
name|hostapd_free_wps
argument_list|(
name|hapd
operator|->
name|wps
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
name|hostapd_wps_clear_ies
argument_list|(
name|hapd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hostapd_update_wps
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
name|hapd
operator|->
name|wps
operator|->
name|friendly_name
operator|=
name|hapd
operator|->
name|conf
operator|->
name|friendly_name
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|manufacturer_url
operator|=
name|hapd
operator|->
name|conf
operator|->
name|manufacturer_url
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|model_description
operator|=
name|hapd
operator|->
name|conf
operator|->
name|model_description
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|model_url
operator|=
name|hapd
operator|->
name|conf
operator|->
name|model_url
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|upc
operator|=
name|hapd
operator|->
name|conf
operator|->
name|upc
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|hostapd_wps_set_vendor_ext
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_state
condition|)
name|wps_registrar_update_ie
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
else|else
name|hostapd_deinit_wps
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|wps_add_pin_data
block|{
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|uuid
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pin
decl_stmt|;
name|size_t
name|pin_len
decl_stmt|;
name|int
name|timeout
decl_stmt|;
name|int
name|added
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wps_add_pin
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wps_add_pin_data
modifier|*
name|data
init|=
name|ctx
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|wps_registrar_add_pin
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|data
operator|->
name|addr
argument_list|,
name|data
operator|->
name|uuid
argument_list|,
name|data
operator|->
name|pin
argument_list|,
name|data
operator|->
name|pin_len
argument_list|,
name|data
operator|->
name|timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|data
operator|->
name|added
operator|++
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|hostapd_wps_add_pin
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|u8
name|u
index|[
name|UUID_LEN
index|]
decl_stmt|;
name|struct
name|wps_add_pin_data
name|data
decl_stmt|;
name|data
operator|.
name|addr
operator|=
name|addr
expr_stmt|;
name|data
operator|.
name|uuid
operator|=
name|u
expr_stmt|;
name|data
operator|.
name|pin
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
name|pin
expr_stmt|;
name|data
operator|.
name|pin_len
operator|=
name|os_strlen
argument_list|(
name|pin
argument_list|)
expr_stmt|;
name|data
operator|.
name|timeout
operator|=
name|timeout
expr_stmt|;
name|data
operator|.
name|added
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|uuid
argument_list|,
literal|"any"
argument_list|)
operator|==
literal|0
condition|)
name|data
operator|.
name|uuid
operator|=
name|NULL
expr_stmt|;
else|else
block|{
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|uuid
argument_list|,
name|u
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|data
operator|.
name|uuid
operator|=
name|u
expr_stmt|;
block|}
if|if
condition|(
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_add_pin
argument_list|,
operator|&
name|data
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|data
operator|.
name|added
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_button_pushed
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wps_registrar_button_pushed
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|p2p_dev_addr
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|hostapd_wps_button_pushed
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
parameter_list|)
block|{
return|return
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_button_pushed
argument_list|,
operator|(
name|void
operator|*
operator|)
name|p2p_dev_addr
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_cancel
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wps_registrar_wps_cancel
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
name|ap_for_each_sta
argument_list|(
name|hapd
argument_list|,
name|ap_sta_wps_cancel
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|hostapd_wps_cancel
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
return|return
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_cancel
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_probe_req_rx
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|da
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|int
name|ssi_signal
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|ie
argument_list|,
name|ie_len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|==
name|ParseFailed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Could not parse ProbeReq from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|elems
operator|.
name|ssid
operator|&&
name|elems
operator|.
name|ssid_len
operator|>
literal|0
operator|&&
operator|(
name|elems
operator|.
name|ssid_len
operator|!=
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|elems
operator|.
name|ssid
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|ssid
argument_list|,
name|elems
operator|.
name|ssid_len
argument_list|)
operator|!=
literal|0
operator|)
condition|)
return|return
literal|0
return|;
comment|/* Not for us */
name|wps_ie
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|ie
argument_list|,
name|ie_len
argument_list|,
name|WPS_DEV_OUI_WFA
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wps_validate_probe_req
argument_list|(
name|wps_ie
argument_list|,
name|addr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
operator|>
literal|0
condition|)
block|{
name|int
name|p2p_wildcard
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|elems
operator|.
name|ssid
operator|&&
name|elems
operator|.
name|ssid_len
operator|==
name|P2P_WILDCARD_SSID_LEN
operator|&&
name|os_memcmp
argument_list|(
name|elems
operator|.
name|ssid
argument_list|,
name|P2P_WILDCARD_SSID
argument_list|,
name|P2P_WILDCARD_SSID_LEN
argument_list|)
operator|==
literal|0
condition|)
name|p2p_wildcard
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|wps_registrar_probe_req_rx
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|addr
argument_list|,
name|wps_ie
argument_list|,
name|p2p_wildcard
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
comment|/* FIX: what exactly should be included in the WLANEvent? 		 * WPS attributes? Full ProbeReq frame? */
if|if
condition|(
operator|!
name|p2p_wildcard
condition|)
name|upnp_wps_device_send_wlan_event
argument_list|(
name|hapd
operator|->
name|wps_upnp
argument_list|,
name|addr
argument_list|,
name|UPNP_WPS_WLANEVENT_TYPE_PROBE
argument_list|,
name|wps_ie
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
block|}
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_rx_req_put_wlan_response
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|enum
name|upnp_wps_wlanevent_type
name|ev_type
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|msg
parameter_list|,
name|enum
name|wps_msg_type
name|msg_type
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|priv
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|struct
name|upnp_pending_message
modifier|*
name|p
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: PutWLANResponse ev_type=%d mac_addr="
name|MACSTR
argument_list|,
name|ev_type
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WPS UPnP: PutWLANResponse NewMessage"
argument_list|,
name|wpabuf_head
argument_list|(
name|msg
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev_type
operator|!=
name|UPNP_WPS_WLANEVENT_TYPE_EAP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Ignored unexpected "
literal|"PutWLANResponse WLANEventType %d"
argument_list|,
name|ev_type
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * EAP response to ongoing to WPS Registration. Send it to EAP-WSC 	 * server implementation for delivery to the peer. 	 */
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|mac_addr
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_WPS_STRICT
if|if
condition|(
operator|!
name|sta
condition|)
block|{
comment|/* 		 * Workaround - Intel wsccmd uses bogus NewWLANEventMAC: 		 * Pick STA that is in an ongoing WPS registration without 		 * checking the MAC address. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: No matching STA found based "
literal|"on NewWLANEventMAC; try wildcard match"
argument_list|)
expr_stmt|;
for|for
control|(
name|sta
operator|=
name|hapd
operator|->
name|sta_list
init|;
name|sta
condition|;
name|sta
operator|=
name|sta
operator|->
name|next
control|)
block|{
if|if
condition|(
name|sta
operator|->
name|eapol_sm
operator|&&
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_WPS
operator|)
condition|)
break|break;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
if|if
condition|(
operator|!
name|sta
operator|||
operator|!
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_WPS
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: No matching STA found"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|sta
operator|->
name|eapol_sm
condition|)
block|{
comment|/* 		 * This can happen, e.g., if an ER sends an extra message after 		 * the station has disassociated (but not fully 		 * deauthenticated). 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS UPnP: Matching STA did not have EAPOL state machine initialized"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|p
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|addr
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|p
operator|->
name|msg
operator|=
name|wpabuf_dup
argument_list|(
name|msg
argument_list|)
expr_stmt|;
name|p
operator|->
name|type
operator|=
name|msg_type
expr_stmt|;
name|p
operator|->
name|next
operator|=
name|hapd
operator|->
name|wps
operator|->
name|upnp_msgs
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|upnp_msgs
operator|=
name|p
expr_stmt|;
return|return
name|eapol_auth_eap_pending_cb
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
name|sta
operator|->
name|eapol_sm
operator|->
name|eap
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_upnp_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|upnp_wps_device_ctx
modifier|*
name|ctx
decl_stmt|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|conf
operator|->
name|upnp_iface
condition|)
return|return
literal|0
return|;
name|ctx
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ctx
operator|->
name|rx_req_put_wlan_response
operator|=
name|hostapd_rx_req_put_wlan_response
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
condition|)
name|ctx
operator|->
name|ap_pin
operator|=
name|os_strdup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps_upnp
operator|=
name|upnp_wps_device_init
argument_list|(
name|ctx
argument_list|,
name|wps
argument_list|,
name|hapd
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|upnp_iface
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps_upnp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wps
operator|->
name|wps_upnp
operator|=
name|hapd
operator|->
name|wps_upnp
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_upnp_deinit
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|upnp_wps_device_deinit
argument_list|(
name|hapd
operator|->
name|wps_upnp
argument_list|,
name|hapd
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_UPNP */
end_comment

begin_function
name|int
name|hostapd_wps_get_mib_sta
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
name|wps_registrar_get_info
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|addr
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_ap_pin_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|eloop_data
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP PIN timed out"
argument_list|)
expr_stmt|;
name|hostapd_wps_ap_pin_disable
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_PIN_DISABLED
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_wps_ap_pin_enable
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enabling AP PIN (timeout=%d)"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|ap_pin_failures
operator|=
literal|0
expr_stmt|;
name|hapd
operator|->
name|ap_pin_failures_consecutive
operator|=
literal|0
expr_stmt|;
name|hapd
operator|->
name|conf
operator|->
name|ap_setup_locked
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|->
name|ap_setup_locked
condition|)
block|{
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_SETUP_UNLOCKED
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|wps
operator|->
name|ap_setup_locked
operator|=
literal|0
expr_stmt|;
name|wps_registrar_update_ie
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|hostapd_wps_ap_pin_timeout
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|>
literal|0
condition|)
name|eloop_register_timeout
argument_list|(
name|timeout
argument_list|,
literal|0
argument_list|,
name|hostapd_wps_ap_pin_timeout
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_ap_pin_disable
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|os_free
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
name|upnp_wps_set_ap_pin
argument_list|(
name|hapd
operator|->
name|wps_upnp
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|eloop_cancel_timeout
argument_list|(
name|hostapd_wps_ap_pin_timeout
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|hostapd_wps_ap_pin_disable
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Disabling AP PIN"
argument_list|)
expr_stmt|;
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_ap_pin_disable
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|wps_ap_pin_data
block|{
name|char
name|pin_txt
index|[
literal|9
index|]
decl_stmt|;
name|int
name|timeout
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wps_ap_pin_set
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wps_ap_pin_data
modifier|*
name|data
init|=
name|ctx
decl_stmt|;
name|os_free
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
operator|=
name|os_strdup
argument_list|(
name|data
operator|->
name|pin_txt
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_UPNP
name|upnp_wps_set_ap_pin
argument_list|(
name|hapd
operator|->
name|wps_upnp
argument_list|,
name|data
operator|->
name|pin_txt
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_UPNP */
name|hostapd_wps_ap_pin_enable
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|timeout
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|hostapd_wps_ap_pin_random
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|unsigned
name|int
name|pin
decl_stmt|;
name|struct
name|wps_ap_pin_data
name|data
decl_stmt|;
name|pin
operator|=
name|wps_generate_pin
argument_list|()
expr_stmt|;
name|os_snprintf
argument_list|(
name|data
operator|.
name|pin_txt
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|.
name|pin_txt
argument_list|)
argument_list|,
literal|"%08u"
argument_list|,
name|pin
argument_list|)
expr_stmt|;
name|data
operator|.
name|timeout
operator|=
name|timeout
expr_stmt|;
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_ap_pin_set
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
return|return
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
return|;
block|}
end_function

begin_function
specifier|const
name|char
modifier|*
name|hostapd_wps_ap_pin_get
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
return|return
name|hapd
operator|->
name|conf
operator|->
name|ap_pin
return|;
block|}
end_function

begin_function
name|int
name|hostapd_wps_ap_pin_set
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|struct
name|wps_ap_pin_data
name|data
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|data
operator|.
name|pin_txt
argument_list|,
sizeof|sizeof
argument_list|(
name|data
operator|.
name|pin_txt
argument_list|)
argument_list|,
literal|"%s"
argument_list|,
name|pin
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
sizeof|sizeof
argument_list|(
name|data
operator|.
name|pin_txt
argument_list|)
argument_list|,
name|ret
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|data
operator|.
name|timeout
operator|=
name|timeout
expr_stmt|;
return|return
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_ap_pin_set
argument_list|,
operator|&
name|data
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wps_update_ie
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|wps
condition|)
name|wps_registrar_update_ie
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|hostapd_wps_update_ie
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_update_ie
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|hostapd_wps_config_ap
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|char
modifier|*
name|ssid
parameter_list|,
specifier|const
name|char
modifier|*
name|auth
parameter_list|,
specifier|const
name|char
modifier|*
name|encr
parameter_list|,
specifier|const
name|char
modifier|*
name|key
parameter_list|)
block|{
name|struct
name|wps_credential
name|cred
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|&
literal|1
operator|)
operator|||
name|len
operator|>
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|cred
operator|.
name|ssid
argument_list|)
operator|||
name|hexstr2bin
argument_list|(
name|ssid
argument_list|,
name|cred
operator|.
name|ssid
argument_list|,
name|len
operator|/
literal|2
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|cred
operator|.
name|ssid_len
operator|=
name|len
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|auth
argument_list|,
literal|"OPEN"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_OPEN
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|auth
argument_list|,
literal|"WPAPSK"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPAPSK
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|auth
argument_list|,
literal|"WPA2PSK"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|encr
condition|)
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|encr
argument_list|,
literal|"NONE"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_NONE
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|encr
argument_list|,
literal|"TKIP"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_TKIP
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|encr
argument_list|,
literal|"CCMP"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_AES
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
block|}
else|else
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_NONE
expr_stmt|;
if|if
condition|(
name|key
condition|)
block|{
name|len
operator|=
name|os_strlen
argument_list|(
name|key
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|&
literal|1
operator|)
operator|||
name|len
operator|>
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|cred
operator|.
name|key
argument_list|)
operator|||
name|hexstr2bin
argument_list|(
name|key
argument_list|,
name|cred
operator|.
name|key
argument_list|,
name|len
operator|/
literal|2
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|cred
operator|.
name|key_len
operator|=
name|len
operator|/
literal|2
expr_stmt|;
block|}
return|return
name|wps_registrar_config_ap
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
operator|&
name|cred
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
end_ifdef

begin_struct
struct|struct
name|wps_nfc_password_token_data
block|{
specifier|const
name|u8
modifier|*
name|oob_dev_pw
decl_stmt|;
name|size_t
name|oob_dev_pw_len
decl_stmt|;
name|int
name|added
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wps_add_nfc_password_token
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wps_nfc_password_token_data
modifier|*
name|data
init|=
name|ctx
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|wps_registrar_add_nfc_password_token
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|data
operator|->
name|oob_dev_pw
argument_list|,
name|data
operator|->
name|oob_dev_pw_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|data
operator|->
name|added
operator|++
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_add_nfc_password_token
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
name|struct
name|wps_nfc_password_token_data
name|data
decl_stmt|;
name|data
operator|.
name|oob_dev_pw
operator|=
name|attr
operator|->
name|oob_dev_password
expr_stmt|;
name|data
operator|.
name|oob_dev_pw_len
operator|=
name|attr
operator|->
name|oob_dev_password_len
expr_stmt|;
name|data
operator|.
name|added
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|hostapd_wps_for_each
argument_list|(
name|hapd
argument_list|,
name|wps_add_nfc_password_token
argument_list|,
operator|&
name|data
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|data
operator|.
name|added
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_wps_nfc_tag_process
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received NFC tag payload"
argument_list|,
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|wps
argument_list|,
operator|&
name|attr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Ignore invalid data from NFC tag"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|oob_dev_password
condition|)
return|return
name|hostapd_wps_add_nfc_password_token
argument_list|(
name|hapd
argument_list|,
operator|&
name|attr
argument_list|)
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Ignore unrecognized NFC tag"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|hostapd_wps_nfc_tag_read
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|data
parameter_list|)
block|{
specifier|const
name|struct
name|wpabuf
modifier|*
name|wps
init|=
name|data
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|tmp
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|data
argument_list|)
operator|<
literal|4
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|*
name|wpabuf_head_u8
argument_list|(
name|data
argument_list|)
operator|!=
literal|0x10
condition|)
block|{
comment|/* Assume this contains full NDEF record */
name|tmp
operator|=
name|ndef_parse_wifi
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Could not parse NDEF"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|=
name|tmp
expr_stmt|;
block|}
name|ret
operator|=
name|hostapd_wps_nfc_tag_process
argument_list|(
name|hapd
argument_list|,
name|wps
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|hostapd_wps_nfc_config_token
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
name|ndef
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ret
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|wps_get_oob_cred
argument_list|(
name|hapd
operator|->
name|wps
argument_list|,
name|hostapd_wps_rf_band_cb
argument_list|(
name|hapd
argument_list|)
argument_list|,
name|hapd
operator|->
name|iconf
operator|->
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndef
operator|&&
name|ret
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ndef_build_wifi
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|tmp
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|hostapd_wps_nfc_hs_cr
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
name|ndef
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ret
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
operator|==
name|NULL
condition|)
block|{
name|struct
name|wps_context
modifier|*
name|wps
init|=
name|hapd
operator|->
name|wps
decl_stmt|;
if|if
condition|(
name|wps_nfc_gen_dh
argument_list|(
operator|&
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
operator|&
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|hostapd_wps_nfc_clear
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dev_pw_id
operator|=
name|DEV_PW_NFC_CONNECTION_HANDOVER
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dh_pubkey
operator|=
name|wpabuf_dup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dh_privkey
operator|=
name|wpabuf_dup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wps
operator|->
name|ap_nfc_dh_pubkey
operator|||
operator|!
name|wps
operator|->
name|ap_nfc_dh_privkey
condition|)
block|{
name|hostapd_wps_nfc_clear
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
name|ret
operator|=
name|wps_build_nfc_handover_sel
argument_list|(
name|hapd
operator|->
name|wps
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
name|hapd
operator|->
name|own_addr
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndef
operator|&&
name|ret
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ndef_build_wifi
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|tmp
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|hostapd_wps_nfc_report_handover
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|req
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|sel
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|u16
name|wsc_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|wpabuf
name|msg
decl_stmt|;
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|u16
name|dev_pw_id
decl_stmt|;
comment|/* 	 * Enrollee/station is always initiator of the NFC connection handover, 	 * so use the request message here to find Enrollee public key hash. 	 */
name|wps
operator|=
name|ndef_parse_wifi
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received application/vnd.wfa.wsc "
literal|"payload from NFC connection handover"
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: NFC payload"
argument_list|,
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Too short Wi-Fi Handover Request "
literal|"Message"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|wsc_len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|wsc_len
operator|>
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|-
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid WSC attribute length (%u) "
literal|"in rt Wi-Fi Handover Request Message"
argument_list|,
name|wsc_len
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: WSC attributes in Wi-Fi Handover Request Message"
argument_list|,
name|pos
argument_list|,
name|wsc_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wsc_len
operator|<
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|-
literal|2
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Ignore extra data after WSC attributes"
argument_list|,
name|pos
operator|+
name|wsc_len
argument_list|,
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|-
literal|2
operator|-
name|wsc_len
argument_list|)
expr_stmt|;
block|}
name|wpabuf_set
argument_list|(
operator|&
name|msg
argument_list|,
name|pos
argument_list|,
name|wsc_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wps_parse_msg
argument_list|(
operator|&
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Could not parse WSC attributes in "
literal|"Wi-Fi Handover Request Message"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|attr
operator|.
name|oob_dev_password
operator|==
name|NULL
operator|||
name|attr
operator|.
name|oob_dev_password_len
operator|<
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Out-of-Band Device Password "
literal|"included in Wi-Fi Handover Request Message"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|attr
operator|.
name|uuid_e
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No UUID-E included in Wi-Fi "
literal|"Handover Request Message"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID-E"
argument_list|,
name|attr
operator|.
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Out-of-Band Device Password"
argument_list|,
name|attr
operator|.
name|oob_dev_password
argument_list|,
name|attr
operator|.
name|oob_dev_password_len
argument_list|)
expr_stmt|;
name|dev_pw_id
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|oob_dev_password
operator|+
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_pw_id
operator|!=
name|DEV_PW_NFC_CONNECTION_HANDOVER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected OOB Device Password ID "
literal|"%u in Wi-Fi Handover Request Message"
argument_list|,
name|dev_pw_id
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Public Key hash"
argument_list|,
name|attr
operator|.
name|oob_dev_password
argument_list|,
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wps_registrar_add_nfc_pw_token
argument_list|(
name|hapd
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|attr
operator|.
name|oob_dev_password
argument_list|,
name|DEV_PW_NFC_CONNECTION_HANDOVER
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|out
label|:
name|wpabuf_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|hostapd_wps_nfc_token_gen
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
name|ndef
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_pw_from_config
condition|)
block|{
return|return
name|wps_nfc_token_build
argument_list|(
name|ndef
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
argument_list|)
return|;
block|}
return|return
name|wps_nfc_token_gen
argument_list|(
name|ndef
argument_list|,
operator|&
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
argument_list|,
operator|&
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
operator|&
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|,
operator|&
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|hostapd_wps_nfc_token_enable
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|struct
name|wps_context
modifier|*
name|wps
init|=
name|hapd
operator|->
name|wps
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|pw
decl_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
operator|||
operator|!
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
operator|||
operator|!
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
operator|||
operator|!
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
condition|)
return|return
operator|-
literal|1
return|;
name|hostapd_wps_nfc_clear
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enable NFC Tag (Dev Pw Id %u) for AP interface %s (context %p)"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|wps
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dev_pw_id
operator|=
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dh_pubkey
operator|=
name|wpabuf_dup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dh_privkey
operator|=
name|wpabuf_dup
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
expr_stmt|;
name|pw
operator|=
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dev_pw
operator|=
name|wpabuf_alloc
argument_list|(
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
operator|*
literal|2
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|ap_nfc_dev_pw
condition|)
block|{
name|wpa_snprintf_hex_uppercase
argument_list|(
operator|(
name|char
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|wps
operator|->
name|ap_nfc_dev_pw
argument_list|,
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
operator|*
literal|2
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
operator|*
literal|2
operator|+
literal|1
argument_list|,
name|wpabuf_head
argument_list|(
name|pw
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|pw
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wps
operator|->
name|ap_nfc_dh_pubkey
operator|||
operator|!
name|wps
operator|->
name|ap_nfc_dh_privkey
operator|||
operator|!
name|wps
operator|->
name|ap_nfc_dev_pw
condition|)
block|{
name|hostapd_wps_nfc_clear
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|hostapd_wps_nfc_token_disable
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Disable NFC token for AP interface %s"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
expr_stmt|;
name|hostapd_wps_nfc_clear
argument_list|(
name|hapd
operator|->
name|wps
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_NFC */
end_comment

end_unit


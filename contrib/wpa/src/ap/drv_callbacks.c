begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / Callback functions for driver wrappers  * Copyright (c) 2002-2013, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"radius/radius.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"p2p/p2p.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps.h"
end_include

begin_include
include|#
directive|include
file|"fst/fst.h"
end_include

begin_include
include|#
directive|include
file|"wnm_ap.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"accounting.h"
end_include

begin_include
include|#
directive|include
file|"tkip_countermeasures.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth.h"
end_include

begin_include
include|#
directive|include
file|"wps_hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap_drv_ops.h"
end_include

begin_include
include|#
directive|include
file|"ap_config.h"
end_include

begin_include
include|#
directive|include
file|"hw_features.h"
end_include

begin_include
include|#
directive|include
file|"dfs.h"
end_include

begin_include
include|#
directive|include
file|"beacon.h"
end_include

begin_function
name|int
name|hostapd_notif_assoc
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_ies
parameter_list|,
name|size_t
name|req_ies_len
parameter_list|,
name|int
name|reassoc
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|new_assoc
decl_stmt|,
name|res
decl_stmt|;
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|size_t
name|ielen
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|CONFIG_IEEE80211R
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_IEEE80211W
argument_list|)
name|u8
name|buf
index|[
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_mgmt
argument_list|)
operator|+
literal|1024
index|]
decl_stmt|;
name|u8
modifier|*
name|p
init|=
name|buf
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R || CONFIG_IEEE80211W */
name|u16
name|reason
init|=
name|WLAN_REASON_UNSPECIFIED
decl_stmt|;
name|u16
name|status
init|=
name|WLAN_STATUS_SUCCESS
decl_stmt|;
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * This could potentially happen with unexpected event from the 		 * driver wrapper. This was seen at least in one case where the 		 * driver ended up being set to station mode while hostapd was 		 * running, so better make sure we stop processing such an 		 * event here. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"hostapd_notif_assoc: Skip event with no address"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|random_add_randomness
argument_list|(
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"associated"
argument_list|)
expr_stmt|;
name|ieee802_11_parse_elems
argument_list|(
name|req_ies
argument_list|,
name|req_ies_len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|elems
operator|.
name|wps_ie
condition|)
block|{
name|ie
operator|=
name|elems
operator|.
name|wps_ie
operator|-
literal|2
expr_stmt|;
name|ielen
operator|=
name|elems
operator|.
name|wps_ie_len
operator|+
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA included WPS IE in (Re)AssocReq"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|elems
operator|.
name|rsn_ie
condition|)
block|{
name|ie
operator|=
name|elems
operator|.
name|rsn_ie
operator|-
literal|2
expr_stmt|;
name|ielen
operator|=
name|elems
operator|.
name|rsn_ie_len
operator|+
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA included RSN IE in (Re)AssocReq"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|elems
operator|.
name|wpa_ie
condition|)
block|{
name|ie
operator|=
name|elems
operator|.
name|wpa_ie
operator|-
literal|2
expr_stmt|;
name|ielen
operator|=
name|elems
operator|.
name|wpa_ie_len
operator|+
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA included WPA IE in (Re)AssocReq"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HS20
block|}
elseif|else
if|if
condition|(
name|elems
operator|.
name|osen
condition|)
block|{
name|ie
operator|=
name|elems
operator|.
name|osen
operator|-
literal|2
expr_stmt|;
name|ielen
operator|=
name|elems
operator|.
name|osen_len
operator|+
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA included OSEN IE in (Re)AssocReq"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
block|}
else|else
block|{
name|ie
operator|=
name|NULL
expr_stmt|;
name|ielen
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA did not include WPS/RSN/WPA IE in (Re)AssocReq"
argument_list|)
expr_stmt|;
block|}
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
condition|)
block|{
name|ap_sta_no_session_timeout
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|accounting_sta_stop
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
comment|/* 		 * Make sure that the previously registered inactivity timer 		 * will not remove the STA immediately. 		 */
name|sta
operator|->
name|timeout_next
operator|=
name|STA_NULLFUNC
expr_stmt|;
block|}
else|else
block|{
name|sta
operator|=
name|ap_sta_add
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
name|hostapd_drv_sta_disassoc
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|WLAN_REASON_DISASSOC_AP_BUSY
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|sta
operator|->
name|flags
operator|&=
operator|~
operator|(
name|WLAN_STA_WPS
operator||
name|WLAN_STA_MAYBE_WPS
operator||
name|WLAN_STA_WPS2
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|elems
operator|.
name|p2p
condition|)
block|{
name|wpabuf_free
argument_list|(
name|sta
operator|->
name|p2p_ie
argument_list|)
expr_stmt|;
name|sta
operator|->
name|p2p_ie
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|req_ies
argument_list|,
name|req_ies_len
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|p2p_ie
condition|)
name|p2p_dev_addr
operator|=
name|p2p_get_go_dev_addr
argument_list|(
name|sta
operator|->
name|p2p_ie
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211N
ifdef|#
directive|ifdef
name|NEED_AP_MLME
if|if
condition|(
name|elems
operator|.
name|ht_capabilities
operator|&&
operator|(
name|hapd
operator|->
name|iface
operator|->
name|conf
operator|->
name|ht_capab
operator|&
name|HT_CAP_INFO_SUPP_CHANNEL_WIDTH_SET
operator|)
condition|)
block|{
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|ht_cap
init|=
operator|(
expr|struct
name|ieee80211_ht_capabilities
operator|*
operator|)
name|elems
operator|.
name|ht_capabilities
decl_stmt|;
if|if
condition|(
name|le_to_host16
argument_list|(
name|ht_cap
operator|->
name|ht_capabilities_info
argument_list|)
operator|&
name|HT_CAP_INFO_40MHZ_INTOLERANT
condition|)
name|ht40_intolerant_add
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* NEED_AP_MLME */
endif|#
directive|endif
comment|/* CONFIG_IEEE80211N */
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
if|if
condition|(
name|elems
operator|.
name|ext_capab
operator|&&
name|elems
operator|.
name|ext_capab_len
operator|>
literal|4
condition|)
block|{
if|if
condition|(
name|elems
operator|.
name|ext_capab
index|[
literal|4
index|]
operator|&
literal|0x01
condition|)
name|sta
operator|->
name|qos_map_enabled
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
ifdef|#
directive|ifdef
name|CONFIG_HS20
name|wpabuf_free
argument_list|(
name|sta
operator|->
name|hs20_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|elems
operator|.
name|hs20
operator|&&
name|elems
operator|.
name|hs20_len
operator|>
literal|4
condition|)
block|{
name|sta
operator|->
name|hs20_ie
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|elems
operator|.
name|hs20
operator|+
literal|4
argument_list|,
name|elems
operator|.
name|hs20_len
operator|-
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
name|sta
operator|->
name|hs20_ie
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
ifdef|#
directive|ifdef
name|CONFIG_FST
name|wpabuf_free
argument_list|(
name|sta
operator|->
name|mb_ies
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|iface
operator|->
name|fst
condition|)
name|sta
operator|->
name|mb_ies
operator|=
name|mb_ies_by_info
argument_list|(
operator|&
name|elems
operator|.
name|mb_ies
argument_list|)
expr_stmt|;
else|else
name|sta
operator|->
name|mb_ies
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_FST */
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa
condition|)
block|{
if|if
condition|(
name|ie
operator|==
name|NULL
operator|||
name|ielen
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_state
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA did not include WPA/RSN IE in (Re)Association Request - possible WPS use"
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_MAYBE_WPS
expr_stmt|;
goto|goto
name|skip_wpa_check
goto|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No WPA/RSN IE from STA"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_state
operator|&&
name|ie
index|[
literal|0
index|]
operator|==
literal|0xdd
operator|&&
name|ie
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|os_memcmp
argument_list|(
name|ie
operator|+
literal|2
argument_list|,
literal|"\x00\x50\xf2\x04"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps
decl_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_WPS
expr_stmt|;
name|wps
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|ie
argument_list|,
name|ielen
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
condition|)
block|{
if|if
condition|(
name|wps_is_20
argument_list|(
name|wps
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: STA supports WPS 2.0"
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_WPS2
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
block|}
goto|goto
name|skip_wpa_check
goto|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS */
if|if
condition|(
name|sta
operator|->
name|wpa_sm
operator|==
name|NULL
condition|)
name|sta
operator|->
name|wpa_sm
operator|=
name|wpa_auth_sta_init
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|p2p_dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|wpa_sm
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize WPA state machine"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res
operator|=
name|wpa_validate_wpa_ie
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|sta
operator|->
name|wpa_sm
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|,
name|elems
operator|.
name|mdie
argument_list|,
name|elems
operator|.
name|mdie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|WPA_IE_OK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA/RSN information element rejected? (res %u)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IE"
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|WPA_INVALID_GROUP
condition|)
block|{
name|reason
operator|=
name|WLAN_REASON_GROUP_CIPHER_NOT_VALID
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_GROUP_CIPHER_NOT_VALID
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|res
operator|==
name|WPA_INVALID_PAIRWISE
condition|)
block|{
name|reason
operator|=
name|WLAN_REASON_PAIRWISE_CIPHER_NOT_VALID
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_PAIRWISE_CIPHER_NOT_VALID
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|res
operator|==
name|WPA_INVALID_AKMP
condition|)
block|{
name|reason
operator|=
name|WLAN_REASON_AKMP_NOT_VALID
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_AKMP_NOT_VALID
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
elseif|else
if|if
condition|(
name|res
operator|==
name|WPA_MGMT_FRAME_PROTECTION_VIOLATION
condition|)
block|{
name|reason
operator|=
name|WLAN_REASON_INVALID_IE
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_IE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|res
operator|==
name|WPA_INVALID_MGMT_GROUP_CIPHER
condition|)
block|{
name|reason
operator|=
name|WLAN_REASON_GROUP_CIPHER_NOT_VALID
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_GROUP_CIPHER_NOT_VALID
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
else|else
block|{
name|reason
operator|=
name|WLAN_REASON_INVALID_IE
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_IE
expr_stmt|;
block|}
goto|goto
name|fail
goto|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_MFP
operator|)
operator|&&
operator|!
name|sta
operator|->
name|sa_query_timed_out
operator|&&
name|sta
operator|->
name|sa_query_count
operator|>
literal|0
condition|)
name|ap_check_sa_query_timeout
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_MFP
operator|)
operator|&&
operator|!
name|sta
operator|->
name|sa_query_timed_out
operator|&&
operator|(
name|sta
operator|->
name|auth_alg
operator|!=
name|WLAN_AUTH_FT
operator|)
condition|)
block|{
comment|/* 			 * STA has already been associated with MFP and SA 			 * Query timeout has not been reached. Reject the 			 * association attempt temporarily and start SA Query, 			 * if one is not pending. 			 */
if|if
condition|(
name|sta
operator|->
name|sa_query_count
operator|==
literal|0
condition|)
name|ap_sta_start_sa_query
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_ASSOC_REJECTED_TEMPORARILY
expr_stmt|;
name|p
operator|=
name|hostapd_eid_assoc_comeback_time
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|hostapd_sta_assoc
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|reassoc
argument_list|,
name|status
argument_list|,
name|buf
argument_list|,
name|p
operator|-
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|wpa_auth_uses_mfp
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|)
condition|)
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_MFP
expr_stmt|;
else|else
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WLAN_STA_MFP
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|sta
operator|->
name|auth_alg
operator|==
name|WLAN_AUTH_FT
condition|)
block|{
name|status
operator|=
name|wpa_ft_validate_reassoc
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|req_ies
argument_list|,
name|req_ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|WLAN_STATUS_INVALID_PMKID
condition|)
name|reason
operator|=
name|WLAN_REASON_INVALID_IE
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|WLAN_STATUS_INVALID_MDIE
condition|)
name|reason
operator|=
name|WLAN_REASON_INVALID_IE
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|WLAN_STATUS_INVALID_FTIE
condition|)
name|reason
operator|=
name|WLAN_REASON_INVALID_IE
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
block|}
elseif|else
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_state
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS
name|struct
name|wpabuf
modifier|*
name|wps
decl_stmt|;
if|if
condition|(
name|req_ies
condition|)
name|wps
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|req_ies
argument_list|,
name|req_ies_len
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
else|else
name|wps
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_STRICT
if|if
condition|(
name|wps
operator|&&
name|wps_validate_assoc_req
argument_list|(
name|wps
argument_list|)
operator|<
literal|0
condition|)
block|{
name|reason
operator|=
name|WLAN_REASON_INVALID_IE
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_INVALID_IE
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
if|if
condition|(
name|wps
condition|)
block|{
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_WPS
expr_stmt|;
if|if
condition|(
name|wps_is_20
argument_list|(
name|wps
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: STA supports WPS 2.0"
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_WPS2
expr_stmt|;
block|}
block|}
else|else
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_MAYBE_WPS
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
ifdef|#
directive|ifdef
name|CONFIG_HS20
block|}
elseif|else
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|osen
condition|)
block|{
if|if
condition|(
name|elems
operator|.
name|osen
operator|==
name|NULL
condition|)
block|{
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"No HS 2.0 OSEN element in association request"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_INVALID_IE
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: OSEN association"
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|wpa_sm
operator|==
name|NULL
condition|)
name|sta
operator|->
name|wpa_sm
operator|=
name|wpa_auth_sta_init
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|wpa_sm
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to initialize WPA state machine"
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
if|if
condition|(
name|wpa_validate_osen
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|sta
operator|->
name|wpa_sm
argument_list|,
name|elems
operator|.
name|osen
operator|-
literal|2
argument_list|,
name|elems
operator|.
name|osen_len
operator|+
literal|2
argument_list|)
operator|<
literal|0
condition|)
return|return
name|WLAN_STATUS_INVALID_IE
return|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS
name|skip_wpa_check
label|:
endif|#
directive|endif
comment|/* CONFIG_WPS */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
name|p
operator|=
name|wpa_sm_write_assoc_resp_ies
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|sta
operator|->
name|auth_alg
argument_list|,
name|req_ies
argument_list|,
name|req_ies_len
argument_list|)
expr_stmt|;
name|hostapd_sta_assoc
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|reassoc
argument_list|,
name|status
argument_list|,
name|buf
argument_list|,
name|p
operator|-
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|auth_alg
operator|==
name|WLAN_AUTH_FT
condition|)
name|ap_sta_set_authorized
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* CONFIG_IEEE80211R */
comment|/* Keep compiler silent about unused variables */
if|if
condition|(
name|status
condition|)
block|{ 	}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|new_assoc
operator|=
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_ASSOC
operator|)
operator|==
literal|0
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_AUTH
operator||
name|WLAN_STA_ASSOC
expr_stmt|;
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WLAN_STA_WNM_SLEEP_MODE
expr_stmt|;
name|hostapd_set_sta_flags
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
if|if
condition|(
name|reassoc
operator|&&
operator|(
name|sta
operator|->
name|auth_alg
operator|==
name|WLAN_AUTH_FT
operator|)
condition|)
name|wpa_auth_sm_event
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|WPA_ASSOC_FT
argument_list|)
expr_stmt|;
else|else
name|wpa_auth_sm_event
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|WPA_ASSOC
argument_list|)
expr_stmt|;
name|hostapd_new_assoc_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
operator|!
name|new_assoc
argument_list|)
expr_stmt|;
name|ieee802_1x_notify_port_enabled
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|req_ies
condition|)
block|{
name|p2p_group_notif_assoc
argument_list|(
name|hapd
operator|->
name|p2p_group
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|req_ies
argument_list|,
name|req_ies_len
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
return|return
literal|0
return|;
name|fail
label|:
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
name|hostapd_sta_assoc
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|reassoc
argument_list|,
name|status
argument_list|,
name|buf
argument_list|,
name|p
operator|-
name|buf
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|hostapd_drv_sta_disassoc
argument_list|(
name|hapd
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|ap_free_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|void
name|hostapd_notif_disassoc
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * This could potentially happen with unexpected event from the 		 * driver wrapper. This was seen at least in one case where the 		 * driver ended up reporting a station mode event while hostapd 		 * was running, so better make sure we stop processing such an 		 * event here. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"hostapd_notif_disassoc: Skip event with no address"
argument_list|)
expr_stmt|;
return|return;
block|}
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"disassociated"
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Disassociation notification for unknown STA "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|ap_sta_set_authorized
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator|&=
operator|~
operator|(
name|WLAN_STA_AUTH
operator||
name|WLAN_STA_ASSOC
operator|)
expr_stmt|;
name|wpa_auth_sm_event
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|WPA_DISASSOC
argument_list|)
expr_stmt|;
name|sta
operator|->
name|acct_terminate_cause
operator|=
name|RADIUS_ACCT_TERMINATE_CAUSE_USER_REQUEST
expr_stmt|;
name|ieee802_1x_notify_port_enabled
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ap_free_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hostapd_event_sta_low_ack
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
init|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|sta
operator|||
operator|!
name|hapd
operator|->
name|conf
operator|->
name|disassoc_low_ack
condition|)
return|return;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"disconnected due to excessive missing ACKs"
argument_list|)
expr_stmt|;
name|hostapd_drv_sta_disassoc
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|WLAN_REASON_DISASSOC_LOW_ACK
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
condition|)
name|ap_sta_disassociate
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|WLAN_REASON_DISASSOC_LOW_ACK
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hostapd_event_ch_switch
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|ht
parameter_list|,
name|int
name|offset
parameter_list|,
name|int
name|width
parameter_list|,
name|int
name|cf1
parameter_list|,
name|int
name|cf2
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|NEED_AP_MLME
name|int
name|channel
decl_stmt|,
name|chwidth
decl_stmt|,
name|seg0_idx
init|=
literal|0
decl_stmt|,
name|seg1_idx
init|=
literal|0
decl_stmt|,
name|is_dfs
decl_stmt|;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"driver had channel switch: freq=%d, ht=%d, offset=%d, width=%d (%s), cf1=%d, cf2=%d"
argument_list|,
name|freq
argument_list|,
name|ht
argument_list|,
name|offset
argument_list|,
name|width
argument_list|,
name|channel_width_to_string
argument_list|(
name|width
argument_list|)
argument_list|,
name|cf1
argument_list|,
name|cf2
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|iface
operator|->
name|freq
operator|=
name|freq
expr_stmt|;
name|channel
operator|=
name|hostapd_hw_get_channel
argument_list|(
name|hapd
argument_list|,
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|channel
condition|)
block|{
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_WARNING
argument_list|,
literal|"driver switched to bad channel!"
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|width
condition|)
block|{
case|case
name|CHAN_WIDTH_80
case|:
name|chwidth
operator|=
name|VHT_CHANWIDTH_80MHZ
expr_stmt|;
break|break;
case|case
name|CHAN_WIDTH_80P80
case|:
name|chwidth
operator|=
name|VHT_CHANWIDTH_80P80MHZ
expr_stmt|;
break|break;
case|case
name|CHAN_WIDTH_160
case|:
name|chwidth
operator|=
name|VHT_CHANWIDTH_160MHZ
expr_stmt|;
break|break;
case|case
name|CHAN_WIDTH_20_NOHT
case|:
case|case
name|CHAN_WIDTH_20
case|:
case|case
name|CHAN_WIDTH_40
case|:
default|default:
name|chwidth
operator|=
name|VHT_CHANWIDTH_USE_HT
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|->
name|mode
condition|)
block|{
case|case
name|HOSTAPD_MODE_IEEE80211A
case|:
if|if
condition|(
name|cf1
operator|>
literal|5000
condition|)
name|seg0_idx
operator|=
operator|(
name|cf1
operator|-
literal|5000
operator|)
operator|/
literal|5
expr_stmt|;
if|if
condition|(
name|cf2
operator|>
literal|5000
condition|)
name|seg1_idx
operator|=
operator|(
name|cf2
operator|-
literal|5000
operator|)
operator|/
literal|5
expr_stmt|;
break|break;
default|default:
name|seg0_idx
operator|=
name|hostapd_hw_get_channel
argument_list|(
name|hapd
argument_list|,
name|cf1
argument_list|)
expr_stmt|;
name|seg1_idx
operator|=
name|hostapd_hw_get_channel
argument_list|(
name|hapd
argument_list|,
name|cf2
argument_list|)
expr_stmt|;
break|break;
block|}
name|hapd
operator|->
name|iconf
operator|->
name|channel
operator|=
name|channel
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|ieee80211n
operator|=
name|ht
expr_stmt|;
if|if
condition|(
operator|!
name|ht
condition|)
name|hapd
operator|->
name|iconf
operator|->
name|ieee80211ac
operator|=
literal|0
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|secondary_channel
operator|=
name|offset
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_chwidth
operator|=
name|chwidth
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_centr_freq_seg0_idx
operator|=
name|seg0_idx
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_centr_freq_seg1_idx
operator|=
name|seg1_idx
expr_stmt|;
name|is_dfs
operator|=
name|ieee80211_is_dfs
argument_list|(
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|csa_in_progress
operator|&&
name|freq
operator|==
name|hapd
operator|->
name|cs_freq_params
operator|.
name|freq
condition|)
block|{
name|hostapd_cleanup_cs_params
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
name|ieee802_11_set_beacon
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|AP_CSA_FINISHED
literal|"freq=%d dfs=%d"
argument_list|,
name|freq
argument_list|,
name|is_dfs
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hapd
operator|->
name|iface
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_DFS_OFFLOAD
condition|)
block|{
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|AP_CSA_FINISHED
literal|"freq=%d dfs=%d"
argument_list|,
name|freq
argument_list|,
name|is_dfs
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* NEED_AP_MLME */
block|}
end_function

begin_function
name|void
name|hostapd_event_connect_failed_reason
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|reason_code
parameter_list|)
block|{
switch|switch
condition|(
name|reason_code
condition|)
block|{
case|case
name|MAX_CLIENT_REACHED
case|:
name|wpa_msg
argument_list|(
argument|hapd->msg_ctx
argument_list|,
argument|MSG_INFO
argument_list|,
argument|AP_REJECTED_MAX_STA MACSTR
argument_list|,
argument|MAC2STR(addr)
argument_list|)
empty_stmt|;
break|break;
case|case
name|BLOCKED_CLIENT
case|:
name|wpa_msg
argument_list|(
argument|hapd->msg_ctx
argument_list|,
argument|MSG_INFO
argument_list|,
argument|AP_REJECTED_BLOCKED_STA MACSTR
argument_list|,
argument|MAC2STR(addr)
argument_list|)
empty_stmt|;
break|break;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_ACS
end_ifdef

begin_function
specifier|static
name|void
name|hostapd_acs_channel_selected
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|acs_selected_channels
modifier|*
name|acs_res
parameter_list|)
block|{
name|int
name|ret
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|hapd
operator|->
name|iconf
operator|->
name|channel
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"ACS: Channel was already set to %d"
argument_list|,
name|hapd
operator|->
name|iconf
operator|->
name|channel
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|hapd
operator|->
name|iface
operator|->
name|current_mode
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|hapd
operator|->
name|iface
operator|->
name|num_hw_features
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
init|=
operator|&
name|hapd
operator|->
name|iface
operator|->
name|hw_features
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|mode
operator|->
name|mode
operator|==
name|acs_res
operator|->
name|hw_mode
condition|)
block|{
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|=
name|mode
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|hapd
operator|->
name|iface
operator|->
name|current_mode
condition|)
block|{
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_WARNING
argument_list|,
literal|"driver selected to bad hw_mode"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|hapd
operator|->
name|iface
operator|->
name|freq
operator|=
name|hostapd_hw_get_freq
argument_list|(
name|hapd
argument_list|,
name|acs_res
operator|->
name|pri_channel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|acs_res
operator|->
name|pri_channel
condition|)
block|{
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_WARNING
argument_list|,
literal|"driver switched to bad channel"
argument_list|)
expr_stmt|;
return|return;
block|}
name|hapd
operator|->
name|iconf
operator|->
name|channel
operator|=
name|acs_res
operator|->
name|pri_channel
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|acs
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|acs_res
operator|->
name|sec_channel
operator|==
literal|0
condition|)
name|hapd
operator|->
name|iconf
operator|->
name|secondary_channel
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|acs_res
operator|->
name|sec_channel
operator|<
name|acs_res
operator|->
name|pri_channel
condition|)
name|hapd
operator|->
name|iconf
operator|->
name|secondary_channel
operator|=
operator|-
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|acs_res
operator|->
name|sec_channel
operator|>
name|acs_res
operator|->
name|pri_channel
condition|)
name|hapd
operator|->
name|iconf
operator|->
name|secondary_channel
operator|=
literal|1
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Invalid secondary channel!"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|hapd
operator|->
name|iface
operator|->
name|conf
operator|->
name|ieee80211ac
condition|)
block|{
comment|/* set defaults for backwards compatibility */
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_centr_freq_seg1_idx
operator|=
literal|0
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_centr_freq_seg0_idx
operator|=
literal|0
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_chwidth
operator|=
name|VHT_CHANWIDTH_USE_HT
expr_stmt|;
if|if
condition|(
name|acs_res
operator|->
name|ch_width
operator|==
literal|80
condition|)
block|{
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_centr_freq_seg0_idx
operator|=
name|acs_res
operator|->
name|vht_seg0_center_ch
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_chwidth
operator|=
name|VHT_CHANWIDTH_80MHZ
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|acs_res
operator|->
name|ch_width
operator|==
literal|160
condition|)
block|{
if|if
condition|(
name|acs_res
operator|->
name|vht_seg1_center_ch
operator|==
literal|0
condition|)
block|{
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_centr_freq_seg0_idx
operator|=
name|acs_res
operator|->
name|vht_seg0_center_ch
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_chwidth
operator|=
name|VHT_CHANWIDTH_160MHZ
expr_stmt|;
block|}
else|else
block|{
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_centr_freq_seg0_idx
operator|=
name|acs_res
operator|->
name|vht_seg0_center_ch
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_centr_freq_seg1_idx
operator|=
name|acs_res
operator|->
name|vht_seg1_center_ch
expr_stmt|;
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_chwidth
operator|=
name|VHT_CHANWIDTH_80P80MHZ
expr_stmt|;
block|}
block|}
block|}
name|ret
operator|=
name|hostapd_acs_completed
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"ACS: Possibly channel configuration is invalid"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_ACS */
end_comment

begin_function
name|int
name|hostapd_probe_req_rx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|da
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|int
name|ssi_signal
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|sa
operator|==
name|NULL
operator|||
name|ie
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|random_add_randomness
argument_list|(
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|hapd
operator|->
name|probereq_cb
operator|&&
name|i
operator|<
name|hapd
operator|->
name|num_probereq_cb
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|hapd
operator|->
name|probereq_cb
index|[
name|i
index|]
operator|.
name|cb
argument_list|(
name|hapd
operator|->
name|probereq_cb
index|[
name|i
index|]
operator|.
name|ctx
argument_list|,
name|sa
argument_list|,
name|da
argument_list|,
name|bssid
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|,
name|ssi_signal
argument_list|)
operator|>
literal|0
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HOSTAPD
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
end_ifdef

begin_function
specifier|static
name|void
name|hostapd_notify_auth_ft_finish
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u16
name|auth_transaction
parameter_list|,
name|u16
name|status
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
return|return;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|dst
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_DEBUG
argument_list|,
literal|"authentication OK (FT)"
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_AUTH
expr_stmt|;
name|hostapd_sta_auth
argument_list|(
name|hapd
argument_list|,
name|dst
argument_list|,
name|auth_transaction
argument_list|,
name|status
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211R */
end_comment

begin_function
specifier|static
name|void
name|hostapd_notif_auth
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|auth_info
modifier|*
name|rx_auth
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|u16
name|status
init|=
name|WLAN_STATUS_SUCCESS
decl_stmt|;
name|u8
name|resp_ies
index|[
literal|2
operator|+
name|WLAN_AUTH_CHALLENGE_LEN
index|]
decl_stmt|;
name|size_t
name|resp_ies_len
init|=
literal|0
decl_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|rx_auth
operator|->
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
block|{
name|sta
operator|=
name|ap_sta_add
argument_list|(
name|hapd
argument_list|,
name|rx_auth
operator|->
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
name|status
operator|=
name|WLAN_STATUS_AP_UNABLE_TO_HANDLE_NEW_STA
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WLAN_STA_PREAUTH
expr_stmt|;
name|ieee802_1x_notify_pre_auth
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|rx_auth
operator|->
name|auth_type
operator|==
name|WLAN_AUTH_FT
operator|&&
name|hapd
operator|->
name|wpa_auth
condition|)
block|{
name|sta
operator|->
name|auth_alg
operator|=
name|WLAN_AUTH_FT
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|wpa_sm
operator|==
name|NULL
condition|)
name|sta
operator|->
name|wpa_sm
operator|=
name|wpa_auth_sta_init
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|wpa_sm
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"FT: Failed to initialize WPA state machine"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WLAN_STATUS_UNSPECIFIED_FAILURE
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_ft_process_auth
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|rx_auth
operator|->
name|bssid
argument_list|,
name|rx_auth
operator|->
name|auth_transaction
argument_list|,
name|rx_auth
operator|->
name|ies
argument_list|,
name|rx_auth
operator|->
name|ies_len
argument_list|,
name|hostapd_notify_auth_ft_finish
argument_list|,
name|hapd
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|fail
label|:
name|hostapd_sta_auth
argument_list|(
name|hapd
argument_list|,
name|rx_auth
operator|->
name|peer
argument_list|,
name|rx_auth
operator|->
name|auth_transaction
operator|+
literal|1
argument_list|,
name|status
argument_list|,
name|resp_ies
argument_list|,
name|resp_ies_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_action_rx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|rx_mgmt
modifier|*
name|drv_mgmt
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|size_t
name|plen
name|__maybe_unused
decl_stmt|;
name|u16
name|fc
decl_stmt|;
if|if
condition|(
name|drv_mgmt
operator|->
name|frame_len
operator|<
literal|24
operator|+
literal|1
condition|)
return|return;
name|plen
operator|=
name|drv_mgmt
operator|->
name|frame_len
operator|-
literal|24
operator|-
literal|1
expr_stmt|;
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|drv_mgmt
operator|->
name|frame
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|frame_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|!=
name|WLAN_FC_STYPE_ACTION
condition|)
return|return;
comment|/* handled by the driver */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RX_ACTION cat %d action plen %d"
argument_list|,
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
argument_list|,
operator|(
name|int
operator|)
name|plen
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: station not found"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|==
name|WLAN_ACTION_FT
condition|)
block|{
specifier|const
name|u8
modifier|*
name|payload
init|=
name|drv_mgmt
operator|->
name|frame
operator|+
literal|24
operator|+
literal|1
decl_stmt|;
name|wpa_ft_action_rx
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|payload
argument_list|,
name|plen
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|==
name|WLAN_ACTION_SA_QUERY
operator|&&
name|plen
operator|>=
literal|4
condition|)
block|{
name|ieee802_11_sa_query_action
argument_list|(
name|hapd
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|sa_query_resp
operator|.
name|action
argument_list|,
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|sa_query_resp
operator|.
name|trans_id
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_WNM
if|if
condition|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|==
name|WLAN_ACTION_WNM
condition|)
block|{
name|ieee802_11_rx_wnm_action_ap
argument_list|(
name|hapd
argument_list|,
name|mgmt
argument_list|,
name|drv_mgmt
operator|->
name|frame_len
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WNM */
ifdef|#
directive|ifdef
name|CONFIG_FST
if|if
condition|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|==
name|WLAN_ACTION_FST
operator|&&
name|hapd
operator|->
name|iface
operator|->
name|fst
condition|)
block|{
name|fst_rx_action
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|fst
argument_list|,
name|mgmt
argument_list|,
name|drv_mgmt
operator|->
name|frame_len
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_FST */
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|NEED_AP_MLME
end_ifdef

begin_define
define|#
directive|define
name|HAPD_BROADCAST
value|((struct hostapd_data *) -1)
end_define

begin_function
specifier|static
name|struct
name|hostapd_data
modifier|*
name|get_hapd_bssid
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|bssid
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|bssid
index|[
literal|0
index|]
operator|==
literal|0xff
operator|&&
name|bssid
index|[
literal|1
index|]
operator|==
literal|0xff
operator|&&
name|bssid
index|[
literal|2
index|]
operator|==
literal|0xff
operator|&&
name|bssid
index|[
literal|3
index|]
operator|==
literal|0xff
operator|&&
name|bssid
index|[
literal|4
index|]
operator|==
literal|0xff
operator|&&
name|bssid
index|[
literal|5
index|]
operator|==
literal|0xff
condition|)
return|return
name|HAPD_BROADCAST
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|iface
operator|->
name|bss
index|[
name|i
index|]
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|iface
operator|->
name|bss
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_rx_from_unknown_sta
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|wds
parameter_list|)
block|{
name|hapd
operator|=
name|get_hapd_bssid
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
operator|||
name|hapd
operator|==
name|HAPD_BROADCAST
condition|)
return|return;
name|ieee802_11_rx_from_unknown
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|wds
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_mgmt_rx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|rx_mgmt
modifier|*
name|rx_mgmt
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|hapd
operator|->
name|iface
decl_stmt|;
specifier|const
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|bssid
decl_stmt|;
name|struct
name|hostapd_frame_info
name|fi
decl_stmt|;
name|int
name|ret
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
if|if
condition|(
name|hapd
operator|->
name|ext_mgmt_frame_handling
condition|)
block|{
name|size_t
name|hex_len
init|=
literal|2
operator|*
name|rx_mgmt
operator|->
name|frame_len
operator|+
literal|1
decl_stmt|;
name|char
modifier|*
name|hex
init|=
name|os_malloc
argument_list|(
name|hex_len
argument_list|)
decl_stmt|;
if|if
condition|(
name|hex
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|hex
argument_list|,
name|hex_len
argument_list|,
name|rx_mgmt
operator|->
name|frame
argument_list|,
name|rx_mgmt
operator|->
name|frame_len
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
literal|"MGMT-RX %s"
argument_list|,
name|hex
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|hex
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|rx_mgmt
operator|->
name|frame
expr_stmt|;
name|bssid
operator|=
name|get_hdr_bssid
argument_list|(
name|hdr
argument_list|,
name|rx_mgmt
operator|->
name|frame_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bssid
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|hapd
operator|=
name|get_hapd_bssid
argument_list|(
name|iface
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
condition|)
block|{
name|u16
name|fc
init|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
decl_stmt|;
comment|/* 		 * Drop frames to unknown BSSIDs except for Beacon frames which 		 * could be used to update neighbor information. 		 */
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_BEACON
condition|)
name|hapd
operator|=
name|iface
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
else|else
return|return
literal|0
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|fi
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fi
argument_list|)
argument_list|)
expr_stmt|;
name|fi
operator|.
name|datarate
operator|=
name|rx_mgmt
operator|->
name|datarate
expr_stmt|;
name|fi
operator|.
name|ssi_signal
operator|=
name|rx_mgmt
operator|->
name|ssi_signal
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|HAPD_BROADCAST
condition|)
block|{
name|size_t
name|i
decl_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
comment|/* if bss is set, driver will call this function for 			 * each bss individually. */
if|if
condition|(
name|rx_mgmt
operator|->
name|drv_priv
operator|&&
operator|(
name|iface
operator|->
name|bss
index|[
name|i
index|]
operator|->
name|drv_priv
operator|!=
name|rx_mgmt
operator|->
name|drv_priv
operator|)
condition|)
continue|continue;
if|if
condition|(
name|ieee802_11_mgmt
argument_list|(
name|iface
operator|->
name|bss
index|[
name|i
index|]
argument_list|,
name|rx_mgmt
operator|->
name|frame
argument_list|,
name|rx_mgmt
operator|->
name|frame_len
argument_list|,
operator|&
name|fi
argument_list|)
operator|>
literal|0
condition|)
name|ret
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|ret
operator|=
name|ieee802_11_mgmt
argument_list|(
name|hapd
argument_list|,
name|rx_mgmt
operator|->
name|frame
argument_list|,
name|rx_mgmt
operator|->
name|frame_len
argument_list|,
operator|&
name|fi
argument_list|)
expr_stmt|;
name|random_add_randomness
argument_list|(
operator|&
name|fi
argument_list|,
sizeof|sizeof
argument_list|(
name|fi
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_mgmt_tx_cb
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|u16
name|stype
parameter_list|,
name|int
name|ok
parameter_list|)
block|{
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|hapd
operator|=
name|get_hapd_bssid
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|get_hdr_bssid
argument_list|(
name|hdr
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
operator|||
name|hapd
operator|==
name|HAPD_BROADCAST
condition|)
return|return;
name|ieee802_11_mgmt_cb
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|stype
argument_list|,
name|ok
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NEED_AP_MLME */
end_comment

begin_function
specifier|static
name|int
name|hostapd_event_new_sta
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
init|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|sta
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Data frame from unknown STA "
name|MACSTR
literal|" - adding a new STA"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_sta_add
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
condition|)
block|{
name|hostapd_new_assoc_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to add STA entry for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_event_eapol_rx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|hapd
operator|->
name|iface
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|size_t
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|j
operator|++
control|)
block|{
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|iface
operator|->
name|bss
index|[
name|j
index|]
argument_list|,
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|&&
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_ASSOC
condition|)
block|{
name|hapd
operator|=
name|iface
operator|->
name|bss
index|[
name|j
index|]
expr_stmt|;
break|break;
block|}
block|}
name|ieee802_1x_receive
argument_list|(
name|hapd
argument_list|,
name|src
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_channel_data
modifier|*
name|hostapd_get_mode_channel
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|struct
name|hostapd_channel_data
modifier|*
name|chan
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|current_mode
operator|->
name|num_channels
condition|;
name|i
operator|++
control|)
block|{
name|chan
operator|=
operator|&
name|iface
operator|->
name|current_mode
operator|->
name|channels
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|chan
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|(
name|unsigned
name|int
operator|)
name|chan
operator|->
name|freq
operator|==
name|freq
condition|)
return|return
name|chan
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_update_nf
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|struct
name|hostapd_channel_data
modifier|*
name|chan
parameter_list|,
name|struct
name|freq_survey
modifier|*
name|survey
parameter_list|)
block|{
if|if
condition|(
operator|!
name|iface
operator|->
name|chans_surveyed
condition|)
block|{
name|chan
operator|->
name|min_nf
operator|=
name|survey
operator|->
name|nf
expr_stmt|;
name|iface
operator|->
name|lowest_nf
operator|=
name|survey
operator|->
name|nf
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|chan
operator|->
name|survey_list
argument_list|)
condition|)
name|chan
operator|->
name|min_nf
operator|=
name|survey
operator|->
name|nf
expr_stmt|;
elseif|else
if|if
condition|(
name|survey
operator|->
name|nf
operator|<
name|chan
operator|->
name|min_nf
condition|)
name|chan
operator|->
name|min_nf
operator|=
name|survey
operator|->
name|nf
expr_stmt|;
if|if
condition|(
name|survey
operator|->
name|nf
operator|<
name|iface
operator|->
name|lowest_nf
condition|)
name|iface
operator|->
name|lowest_nf
operator|=
name|survey
operator|->
name|nf
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_single_channel_get_survey
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
name|struct
name|survey_results
modifier|*
name|survey_res
parameter_list|)
block|{
name|struct
name|hostapd_channel_data
modifier|*
name|chan
decl_stmt|;
name|struct
name|freq_survey
modifier|*
name|survey
decl_stmt|;
name|u64
name|divisor
decl_stmt|,
name|dividend
decl_stmt|;
name|survey
operator|=
name|dl_list_first
argument_list|(
operator|&
name|survey_res
operator|->
name|survey_list
argument_list|,
expr|struct
name|freq_survey
argument_list|,
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|survey
operator|||
operator|!
name|survey
operator|->
name|freq
condition|)
return|return;
name|chan
operator|=
name|hostapd_get_mode_channel
argument_list|(
name|iface
argument_list|,
name|survey
operator|->
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|chan
operator|||
name|chan
operator|->
name|flag
operator|&
name|HOSTAPD_CHAN_DISABLED
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Single Channel Survey: (freq=%d channel_time=%ld channel_time_busy=%ld)"
argument_list|,
name|survey
operator|->
name|freq
argument_list|,
operator|(
name|unsigned
name|long
name|int
operator|)
name|survey
operator|->
name|channel_time
argument_list|,
operator|(
name|unsigned
name|long
name|int
operator|)
name|survey
operator|->
name|channel_time_busy
argument_list|)
expr_stmt|;
if|if
condition|(
name|survey
operator|->
name|channel_time
operator|>
name|iface
operator|->
name|last_channel_time
operator|&&
name|survey
operator|->
name|channel_time
operator|>
name|survey
operator|->
name|channel_time_busy
condition|)
block|{
name|dividend
operator|=
name|survey
operator|->
name|channel_time_busy
operator|-
name|iface
operator|->
name|last_channel_time_busy
expr_stmt|;
name|divisor
operator|=
name|survey
operator|->
name|channel_time
operator|-
name|iface
operator|->
name|last_channel_time
expr_stmt|;
name|iface
operator|->
name|channel_utilization
operator|=
name|dividend
operator|*
literal|255
operator|/
name|divisor
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Channel Utilization: %d"
argument_list|,
name|iface
operator|->
name|channel_utilization
argument_list|)
expr_stmt|;
block|}
name|iface
operator|->
name|last_channel_time
operator|=
name|survey
operator|->
name|channel_time
expr_stmt|;
name|iface
operator|->
name|last_channel_time_busy
operator|=
name|survey
operator|->
name|channel_time_busy
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_event_get_survey
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|survey_results
modifier|*
name|survey_results
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|hapd
operator|->
name|iface
decl_stmt|;
name|struct
name|freq_survey
modifier|*
name|survey
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|struct
name|hostapd_channel_data
modifier|*
name|chan
decl_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|survey_results
operator|->
name|survey_list
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No survey data received"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|survey_results
operator|->
name|freq_filter
condition|)
block|{
name|hostapd_single_channel_get_survey
argument_list|(
name|iface
argument_list|,
name|survey_results
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each_safe
argument_list|(
argument|survey
argument_list|,
argument|tmp
argument_list|,
argument|&survey_results->survey_list
argument_list|,
argument|struct freq_survey
argument_list|,
argument|list
argument_list|)
block|{
name|chan
operator|=
name|hostapd_get_mode_channel
argument_list|(
name|iface
argument_list|,
name|survey
operator|->
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|chan
condition|)
continue|continue;
if|if
condition|(
name|chan
operator|->
name|flag
operator|&
name|HOSTAPD_CHAN_DISABLED
condition|)
continue|continue;
name|dl_list_del
argument_list|(
operator|&
name|survey
operator|->
name|list
argument_list|)
expr_stmt|;
name|dl_list_add_tail
argument_list|(
operator|&
name|chan
operator|->
name|survey_list
argument_list|,
operator|&
name|survey
operator|->
name|list
argument_list|)
expr_stmt|;
name|hostapd_update_nf
argument_list|(
name|iface
argument_list|,
name|chan
argument_list|,
name|survey
argument_list|)
expr_stmt|;
name|iface
operator|->
name|chans_surveyed
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|NEED_AP_MLME
end_ifdef

begin_function
specifier|static
name|void
name|hostapd_event_iface_unavailable
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interface %s is unavailable -- stopped"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|csa_in_progress
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"CSA failed (%s was stopped)"
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|iface
argument_list|)
expr_stmt|;
name|hostapd_switch_channel_fallback
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
operator|&
name|hapd
operator|->
name|cs_freq_params
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_event_dfs_radar_detected
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|dfs_event
modifier|*
name|radar
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DFS radar detected on %d MHz"
argument_list|,
name|radar
operator|->
name|freq
argument_list|)
expr_stmt|;
name|hostapd_dfs_radar_detected
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|radar
operator|->
name|freq
argument_list|,
name|radar
operator|->
name|ht_enabled
argument_list|,
name|radar
operator|->
name|chan_offset
argument_list|,
name|radar
operator|->
name|chan_width
argument_list|,
name|radar
operator|->
name|cf1
argument_list|,
name|radar
operator|->
name|cf2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_event_dfs_cac_finished
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|dfs_event
modifier|*
name|radar
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DFS CAC finished on %d MHz"
argument_list|,
name|radar
operator|->
name|freq
argument_list|)
expr_stmt|;
name|hostapd_dfs_complete_cac
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
literal|1
argument_list|,
name|radar
operator|->
name|freq
argument_list|,
name|radar
operator|->
name|ht_enabled
argument_list|,
name|radar
operator|->
name|chan_offset
argument_list|,
name|radar
operator|->
name|chan_width
argument_list|,
name|radar
operator|->
name|cf1
argument_list|,
name|radar
operator|->
name|cf2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_event_dfs_cac_aborted
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|dfs_event
modifier|*
name|radar
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DFS CAC aborted on %d MHz"
argument_list|,
name|radar
operator|->
name|freq
argument_list|)
expr_stmt|;
name|hostapd_dfs_complete_cac
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
literal|0
argument_list|,
name|radar
operator|->
name|freq
argument_list|,
name|radar
operator|->
name|ht_enabled
argument_list|,
name|radar
operator|->
name|chan_offset
argument_list|,
name|radar
operator|->
name|chan_width
argument_list|,
name|radar
operator|->
name|cf1
argument_list|,
name|radar
operator|->
name|cf2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_event_dfs_nop_finished
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|dfs_event
modifier|*
name|radar
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DFS NOP finished on %d MHz"
argument_list|,
name|radar
operator|->
name|freq
argument_list|)
expr_stmt|;
name|hostapd_dfs_nop_finished
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|radar
operator|->
name|freq
argument_list|,
name|radar
operator|->
name|ht_enabled
argument_list|,
name|radar
operator|->
name|chan_offset
argument_list|,
name|radar
operator|->
name|chan_width
argument_list|,
name|radar
operator|->
name|cf1
argument_list|,
name|radar
operator|->
name|cf2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_event_dfs_cac_started
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|dfs_event
modifier|*
name|radar
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"DFS offload CAC started on %d MHz"
argument_list|,
name|radar
operator|->
name|freq
argument_list|)
expr_stmt|;
name|hostapd_dfs_start_cac
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|radar
operator|->
name|freq
argument_list|,
name|radar
operator|->
name|ht_enabled
argument_list|,
name|radar
operator|->
name|chan_offset
argument_list|,
name|radar
operator|->
name|chan_width
argument_list|,
name|radar
operator|->
name|cf1
argument_list|,
name|radar
operator|->
name|cf2
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NEED_AP_MLME */
end_comment

begin_function
name|void
name|wpa_supplicant_event
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|wpa_event_type
name|event
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NO_STDOUT_DEBUG
name|int
name|level
init|=
name|MSG_DEBUG
decl_stmt|;
if|if
condition|(
name|event
operator|==
name|EVENT_RX_MGMT
operator|&&
name|data
operator|->
name|rx_mgmt
operator|.
name|frame
operator|&&
name|data
operator|->
name|rx_mgmt
operator|.
name|frame_len
operator|>=
literal|24
condition|)
block|{
specifier|const
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|data
operator|->
name|rx_mgmt
operator|.
name|frame
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_BEACON
condition|)
name|level
operator|=
name|MSG_EXCESSIVE
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_PROBE_REQ
condition|)
name|level
operator|=
name|MSG_EXCESSIVE
expr_stmt|;
block|}
name|wpa_dbg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|level
argument_list|,
literal|"Event %s (%d) received"
argument_list|,
name|event_to_string
argument_list|(
name|event
argument_list|)
argument_list|,
name|event
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_STDOUT_DEBUG */
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|EVENT_MICHAEL_MIC_FAILURE
case|:
name|michael_mic_failure
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|michael_mic_failure
operator|.
name|src
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_SCAN_RESULTS
case|:
if|if
condition|(
name|hapd
operator|->
name|iface
operator|->
name|scan_cb
condition|)
name|hapd
operator|->
name|iface
operator|->
name|scan_cb
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_WPS_BUTTON_PUSHED
case|:
name|hostapd_wps_button_pushed
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|NEED_AP_MLME
case|case
name|EVENT_TX_STATUS
case|:
switch|switch
condition|(
name|data
operator|->
name|tx_status
operator|.
name|type
condition|)
block|{
case|case
name|WLAN_FC_TYPE_MGMT
case|:
name|hostapd_mgmt_tx_cb
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data_len
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|stype
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|ack
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_TYPE_DATA
case|:
name|hostapd_tx_status
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|dst
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data_len
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|ack
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|EVENT_EAPOL_TX_STATUS
case|:
name|hostapd_eapol_tx_status
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|eapol_tx_status
operator|.
name|dst
argument_list|,
name|data
operator|->
name|eapol_tx_status
operator|.
name|data
argument_list|,
name|data
operator|->
name|eapol_tx_status
operator|.
name|data_len
argument_list|,
name|data
operator|->
name|eapol_tx_status
operator|.
name|ack
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DRIVER_CLIENT_POLL_OK
case|:
name|hostapd_client_poll_ok
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|client_poll
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_RX_FROM_UNKNOWN
case|:
name|hostapd_rx_from_unknown_sta
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|rx_from_unknown
operator|.
name|bssid
argument_list|,
name|data
operator|->
name|rx_from_unknown
operator|.
name|addr
argument_list|,
name|data
operator|->
name|rx_from_unknown
operator|.
name|wds
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* NEED_AP_MLME */
case|case
name|EVENT_RX_MGMT
case|:
if|if
condition|(
operator|!
name|data
operator|->
name|rx_mgmt
operator|.
name|frame
condition|)
break|break;
ifdef|#
directive|ifdef
name|NEED_AP_MLME
if|if
condition|(
name|hostapd_mgmt_rx
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|rx_mgmt
argument_list|)
operator|>
literal|0
condition|)
break|break;
endif|#
directive|endif
comment|/* NEED_AP_MLME */
name|hostapd_action_rx
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|rx_mgmt
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_RX_PROBE_REQ
case|:
if|if
condition|(
name|data
operator|->
name|rx_probe_req
operator|.
name|sa
operator|==
name|NULL
operator|||
name|data
operator|->
name|rx_probe_req
operator|.
name|ie
operator|==
name|NULL
condition|)
break|break;
name|hostapd_probe_req_rx
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|sa
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|da
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|bssid
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ie
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ie_len
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ssi_signal
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_NEW_STA
case|:
name|hostapd_event_new_sta
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|new_sta
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_EAPOL_RX
case|:
name|hostapd_event_eapol_rx
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|eapol_rx
operator|.
name|src
argument_list|,
name|data
operator|->
name|eapol_rx
operator|.
name|data
argument_list|,
name|data
operator|->
name|eapol_rx
operator|.
name|data_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_ASSOC
case|:
if|if
condition|(
operator|!
name|data
condition|)
return|return;
name|hostapd_notif_assoc
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|addr
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|reassoc
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DISASSOC
case|:
if|if
condition|(
name|data
condition|)
name|hostapd_notif_disassoc
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|disassoc_info
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DEAUTH
case|:
if|if
condition|(
name|data
condition|)
name|hostapd_notif_disassoc
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|deauth_info
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_STATION_LOW_ACK
case|:
if|if
condition|(
operator|!
name|data
condition|)
break|break;
name|hostapd_event_sta_low_ack
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|low_ack
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_AUTH
case|:
name|hostapd_notif_auth
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|auth
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_CH_SWITCH
case|:
if|if
condition|(
operator|!
name|data
condition|)
break|break;
name|hostapd_event_ch_switch
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|ch_switch
operator|.
name|freq
argument_list|,
name|data
operator|->
name|ch_switch
operator|.
name|ht_enabled
argument_list|,
name|data
operator|->
name|ch_switch
operator|.
name|ch_offset
argument_list|,
name|data
operator|->
name|ch_switch
operator|.
name|ch_width
argument_list|,
name|data
operator|->
name|ch_switch
operator|.
name|cf1
argument_list|,
name|data
operator|->
name|ch_switch
operator|.
name|cf2
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_CONNECT_FAILED_REASON
case|:
if|if
condition|(
operator|!
name|data
condition|)
break|break;
name|hostapd_event_connect_failed_reason
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|connect_failed_reason
operator|.
name|addr
argument_list|,
name|data
operator|->
name|connect_failed_reason
operator|.
name|code
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_SURVEY
case|:
name|hostapd_event_get_survey
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|survey_results
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|NEED_AP_MLME
case|case
name|EVENT_INTERFACE_UNAVAILABLE
case|:
name|hostapd_event_iface_unavailable
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DFS_RADAR_DETECTED
case|:
if|if
condition|(
operator|!
name|data
condition|)
break|break;
name|hostapd_event_dfs_radar_detected
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|dfs_event
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DFS_CAC_FINISHED
case|:
if|if
condition|(
operator|!
name|data
condition|)
break|break;
name|hostapd_event_dfs_cac_finished
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|dfs_event
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DFS_CAC_ABORTED
case|:
if|if
condition|(
operator|!
name|data
condition|)
break|break;
name|hostapd_event_dfs_cac_aborted
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|dfs_event
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DFS_NOP_FINISHED
case|:
if|if
condition|(
operator|!
name|data
condition|)
break|break;
name|hostapd_event_dfs_nop_finished
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|dfs_event
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_CHANNEL_LIST_CHANGED
case|:
comment|/* channel list changed (regulatory?), update channel list */
comment|/* TODO: check this. hostapd_get_hw_features() initializes 		 * too much stuff. */
comment|/* hostapd_get_hw_features(hapd->iface); */
name|hostapd_channel_list_updated
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|data
operator|->
name|channel_list_changed
operator|.
name|initiator
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DFS_CAC_STARTED
case|:
if|if
condition|(
operator|!
name|data
condition|)
break|break;
name|hostapd_event_dfs_cac_started
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|dfs_event
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* NEED_AP_MLME */
case|case
name|EVENT_INTERFACE_ENABLED
case|:
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|INTERFACE_ENABLED
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|disabled
operator|&&
name|hapd
operator|->
name|started
condition|)
block|{
name|hapd
operator|->
name|disabled
operator|=
literal|0
expr_stmt|;
comment|/* 			 * Try to re-enable interface if the driver stopped it 			 * when the interface got disabled. 			 */
name|wpa_auth_reconfig_group_keys
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|reenable_beacon
operator|=
literal|1
expr_stmt|;
name|ieee802_11_set_beacon
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|EVENT_INTERFACE_DISABLED
case|:
name|hostapd_free_stas
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|hapd
operator|->
name|msg_ctx
argument_list|,
name|MSG_INFO
argument_list|,
name|INTERFACE_DISABLED
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|disabled
operator|=
literal|1
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_ACS
case|case
name|EVENT_ACS_CHANNEL_SELECTED
case|:
name|hostapd_acs_channel_selected
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|acs_selected_channels
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_ACS */
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unknown event %d"
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HOSTAPD */
end_comment

end_unit


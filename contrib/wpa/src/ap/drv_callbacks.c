begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / Callback functions for driver wrappers  * Copyright (c) 2002-2009, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"radius/radius.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"accounting.h"
end_include

begin_include
include|#
directive|include
file|"tkip_countermeasures.h"
end_include

begin_include
include|#
directive|include
file|"iapp.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_1x.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth.h"
end_include

begin_include
include|#
directive|include
file|"wmm.h"
end_include

begin_include
include|#
directive|include
file|"wps_hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap_config.h"
end_include

begin_function
name|int
name|hostapd_notif_assoc
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ielen
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|new_assoc
decl_stmt|,
name|res
decl_stmt|;
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * This could potentially happen with unexpected event from the 		 * driver wrapper. This was seen at least in one case where the 		 * driver ended up being set to station mode while hostapd was 		 * running, so better make sure we stop processing such an 		 * event here. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"hostapd_notif_assoc: Skip event with "
literal|"no address"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"associated"
argument_list|)
expr_stmt|;
name|ieee802_11_parse_elems
argument_list|(
name|ie
argument_list|,
name|ielen
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|elems
operator|.
name|wps_ie
condition|)
block|{
name|ie
operator|=
name|elems
operator|.
name|wps_ie
operator|-
literal|2
expr_stmt|;
name|ielen
operator|=
name|elems
operator|.
name|wps_ie_len
operator|+
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA included WPS IE in (Re)AssocReq"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|elems
operator|.
name|rsn_ie
condition|)
block|{
name|ie
operator|=
name|elems
operator|.
name|rsn_ie
operator|-
literal|2
expr_stmt|;
name|ielen
operator|=
name|elems
operator|.
name|rsn_ie_len
operator|+
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA included RSN IE in (Re)AssocReq"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|elems
operator|.
name|wpa_ie
condition|)
block|{
name|ie
operator|=
name|elems
operator|.
name|wpa_ie
operator|-
literal|2
expr_stmt|;
name|ielen
operator|=
name|elems
operator|.
name|wpa_ie_len
operator|+
literal|2
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA included WPA IE in (Re)AssocReq"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ie
operator|=
name|NULL
expr_stmt|;
name|ielen
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA did not include WPS/RSN/WPA IE in "
literal|"(Re)AssocReq"
argument_list|)
expr_stmt|;
block|}
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
condition|)
block|{
name|accounting_sta_stop
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|sta
operator|=
name|ap_sta_add
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|sta
operator|->
name|flags
operator|&=
operator|~
operator|(
name|WLAN_STA_WPS
operator||
name|WLAN_STA_MAYBE_WPS
operator|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wpa
condition|)
block|{
if|if
condition|(
name|ie
operator|==
name|NULL
operator|||
name|ielen
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_state
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"STA did not include "
literal|"WPA/RSN IE in (Re)Association "
literal|"Request - possible WPS use"
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_MAYBE_WPS
expr_stmt|;
goto|goto
name|skip_wpa_check
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No WPA/RSN IE from STA"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_state
operator|&&
name|ie
index|[
literal|0
index|]
operator|==
literal|0xdd
operator|&&
name|ie
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|os_memcmp
argument_list|(
name|ie
operator|+
literal|2
argument_list|,
literal|"\x00\x50\xf2\x04"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_WPS
expr_stmt|;
goto|goto
name|skip_wpa_check
goto|;
block|}
if|if
condition|(
name|sta
operator|->
name|wpa_sm
operator|==
name|NULL
condition|)
name|sta
operator|->
name|wpa_sm
operator|=
name|wpa_auth_sta_init
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|sta
operator|->
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|wpa_sm
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize WPA state "
literal|"machine"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res
operator|=
name|wpa_validate_wpa_ie
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|sta
operator|->
name|wpa_sm
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|!=
name|WPA_IE_OK
condition|)
block|{
name|int
name|resp
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA/RSN information element "
literal|"rejected? (res %u)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IE"
argument_list|,
name|ie
argument_list|,
name|ielen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|WPA_INVALID_GROUP
condition|)
name|resp
operator|=
name|WLAN_REASON_GROUP_CIPHER_NOT_VALID
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
name|WPA_INVALID_PAIRWISE
condition|)
name|resp
operator|=
name|WLAN_REASON_PAIRWISE_CIPHER_NOT_VALID
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
name|WPA_INVALID_AKMP
condition|)
name|resp
operator|=
name|WLAN_REASON_AKMP_NOT_VALID
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
elseif|else
if|if
condition|(
name|res
operator|==
name|WPA_MGMT_FRAME_PROTECTION_VIOLATION
condition|)
name|resp
operator|=
name|WLAN_REASON_INVALID_IE
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
name|WPA_INVALID_MGMT_GROUP_CIPHER
condition|)
name|resp
operator|=
name|WLAN_REASON_GROUP_CIPHER_NOT_VALID
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
else|else
name|resp
operator|=
name|WLAN_REASON_INVALID_IE
expr_stmt|;
name|hapd
operator|->
name|drv
operator|.
name|sta_disassoc
argument_list|(
name|hapd
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|ap_free_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_state
condition|)
block|{
if|if
condition|(
name|ie
operator|&&
name|ielen
operator|>
literal|4
operator|&&
name|ie
index|[
literal|0
index|]
operator|==
literal|0xdd
operator|&&
name|ie
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|os_memcmp
argument_list|(
name|ie
operator|+
literal|2
argument_list|,
literal|"\x00\x50\xf2\x04"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_WPS
expr_stmt|;
block|}
else|else
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_MAYBE_WPS
expr_stmt|;
block|}
name|skip_wpa_check
label|:
name|new_assoc
operator|=
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_ASSOC
operator|)
operator|==
literal|0
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_AUTH
operator||
name|WLAN_STA_ASSOC
expr_stmt|;
name|wpa_auth_sm_event
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|WPA_ASSOC
argument_list|)
expr_stmt|;
name|hostapd_new_assoc_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
operator|!
name|new_assoc
argument_list|)
expr_stmt|;
name|ieee802_1x_notify_port_enabled
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|hostapd_notif_disassoc
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"disassociated"
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Disassociation notification for "
literal|"unknown STA "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|sta
operator|->
name|flags
operator|&=
operator|~
operator|(
name|WLAN_STA_AUTH
operator||
name|WLAN_STA_ASSOC
operator|)
expr_stmt|;
name|wpa_msg
argument_list|(
argument|hapd->msg_ctx
argument_list|,
argument|MSG_INFO
argument_list|,
argument|AP_STA_DISCONNECTED MACSTR
argument_list|,
argument|MAC2STR(sta->addr)
argument_list|)
empty_stmt|;
name|wpa_auth_sm_event
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|WPA_DISASSOC
argument_list|)
expr_stmt|;
name|sta
operator|->
name|acct_terminate_cause
operator|=
name|RADIUS_ACCT_TERMINATE_CAUSE_USER_REQUEST
expr_stmt|;
name|ieee802_1x_notify_port_enabled
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ap_free_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HOSTAPD
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|NEED_AP_MLME
end_ifdef

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|get_hdr_bssid
parameter_list|(
specifier|const
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u16
name|fc
decl_stmt|,
name|type
decl_stmt|,
name|stype
decl_stmt|;
comment|/* 	 * PS-Poll frames are 16 bytes. All other frames are 	 * 24 bytes or longer. 	 */
if|if
condition|(
name|len
operator|<
literal|16
condition|)
return|return
name|NULL
return|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|type
operator|=
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
name|stype
operator|=
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|WLAN_FC_TYPE_DATA
case|:
if|if
condition|(
name|len
operator|<
literal|24
condition|)
return|return
name|NULL
return|;
switch|switch
condition|(
name|fc
operator|&
operator|(
name|WLAN_FC_FROMDS
operator||
name|WLAN_FC_TODS
operator|)
condition|)
block|{
case|case
name|WLAN_FC_FROMDS
operator||
name|WLAN_FC_TODS
case|:
case|case
name|WLAN_FC_TODS
case|:
return|return
name|hdr
operator|->
name|addr1
return|;
case|case
name|WLAN_FC_FROMDS
case|:
return|return
name|hdr
operator|->
name|addr2
return|;
default|default:
return|return
name|NULL
return|;
block|}
case|case
name|WLAN_FC_TYPE_CTRL
case|:
if|if
condition|(
name|stype
operator|!=
name|WLAN_FC_STYPE_PSPOLL
condition|)
return|return
name|NULL
return|;
return|return
name|hdr
operator|->
name|addr1
return|;
case|case
name|WLAN_FC_TYPE_MGMT
case|:
return|return
name|hdr
operator|->
name|addr3
return|;
default|default:
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_define
define|#
directive|define
name|HAPD_BROADCAST
value|((struct hostapd_data *) -1)
end_define

begin_function
specifier|static
name|struct
name|hostapd_data
modifier|*
name|get_hapd_bssid
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|bssid
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|bssid
index|[
literal|0
index|]
operator|==
literal|0xff
operator|&&
name|bssid
index|[
literal|1
index|]
operator|==
literal|0xff
operator|&&
name|bssid
index|[
literal|2
index|]
operator|==
literal|0xff
operator|&&
name|bssid
index|[
literal|3
index|]
operator|==
literal|0xff
operator|&&
name|bssid
index|[
literal|4
index|]
operator|==
literal|0xff
operator|&&
name|bssid
index|[
literal|5
index|]
operator|==
literal|0xff
condition|)
return|return
name|HAPD_BROADCAST
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|iface
operator|->
name|bss
index|[
name|i
index|]
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|iface
operator|->
name|bss
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_rx_from_unknown_sta
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|frame
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
init|=
operator|(
specifier|const
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|frame
decl_stmt|;
name|u16
name|fc
init|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
decl_stmt|;
name|hapd
operator|=
name|get_hapd_bssid
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|get_hdr_bssid
argument_list|(
name|hdr
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
operator|||
name|hapd
operator|==
name|HAPD_BROADCAST
condition|)
return|return;
name|ieee802_11_rx_from_unknown
argument_list|(
name|hapd
argument_list|,
name|hdr
operator|->
name|addr2
argument_list|,
operator|(
name|fc
operator|&
operator|(
name|WLAN_FC_TODS
operator||
name|WLAN_FC_FROMDS
operator|)
operator|)
operator|==
operator|(
name|WLAN_FC_TODS
operator||
name|WLAN_FC_FROMDS
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_mgmt_rx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|rx_mgmt
modifier|*
name|rx_mgmt
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|hapd
operator|->
name|iface
decl_stmt|;
specifier|const
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
specifier|const
name|u8
modifier|*
name|bssid
decl_stmt|;
name|struct
name|hostapd_frame_info
name|fi
decl_stmt|;
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|rx_mgmt
operator|->
name|frame
expr_stmt|;
name|bssid
operator|=
name|get_hdr_bssid
argument_list|(
name|hdr
argument_list|,
name|rx_mgmt
operator|->
name|frame_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bssid
operator|==
name|NULL
condition|)
return|return;
name|hapd
operator|=
name|get_hapd_bssid
argument_list|(
name|iface
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
condition|)
block|{
name|u16
name|fc
decl_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
comment|/* 		 * Drop frames to unknown BSSIDs except for Beacon frames which 		 * could be used to update neighbor information. 		 */
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_BEACON
condition|)
name|hapd
operator|=
name|iface
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
else|else
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|fi
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fi
argument_list|)
argument_list|)
expr_stmt|;
name|fi
operator|.
name|datarate
operator|=
name|rx_mgmt
operator|->
name|datarate
expr_stmt|;
name|fi
operator|.
name|ssi_signal
operator|=
name|rx_mgmt
operator|->
name|ssi_signal
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|HAPD_BROADCAST
condition|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|i
operator|++
control|)
name|ieee802_11_mgmt
argument_list|(
name|iface
operator|->
name|bss
index|[
name|i
index|]
argument_list|,
name|rx_mgmt
operator|->
name|frame
argument_list|,
name|rx_mgmt
operator|->
name|frame_len
argument_list|,
operator|&
name|fi
argument_list|)
expr_stmt|;
block|}
else|else
name|ieee802_11_mgmt
argument_list|(
name|hapd
argument_list|,
name|rx_mgmt
operator|->
name|frame
argument_list|,
name|rx_mgmt
operator|->
name|frame_len
argument_list|,
operator|&
name|fi
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_mgmt_tx_cb
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|u16
name|stype
parameter_list|,
name|int
name|ok
parameter_list|)
block|{
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|hapd
operator|=
name|get_hapd_bssid
argument_list|(
name|hapd
operator|->
name|iface
argument_list|,
name|get_hdr_bssid
argument_list|(
name|hdr
argument_list|,
name|len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|==
name|NULL
operator|||
name|hapd
operator|==
name|HAPD_BROADCAST
condition|)
return|return;
name|ieee802_11_mgmt_cb
argument_list|(
name|hapd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|stype
argument_list|,
name|ok
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* NEED_AP_MLME */
end_comment

begin_function
specifier|static
name|int
name|hostapd_probe_req_rx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|hapd
operator|->
name|probereq_cb
operator|&&
name|i
operator|<
name|hapd
operator|->
name|num_probereq_cb
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|hapd
operator|->
name|probereq_cb
index|[
name|i
index|]
operator|.
name|cb
argument_list|(
name|hapd
operator|->
name|probereq_cb
index|[
name|i
index|]
operator|.
name|ctx
argument_list|,
name|sa
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
operator|>
literal|0
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_event_new_sta
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
init|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|sta
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Data frame from unknown STA "
name|MACSTR
literal|" - adding a new STA"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_sta_add
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
condition|)
block|{
name|hostapd_new_assoc_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to add STA entry for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_event_eapol_rx
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|iface
init|=
name|hapd
operator|->
name|iface
decl_stmt|;
name|size_t
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|iface
operator|->
name|num_bss
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|ap_get_sta
argument_list|(
name|iface
operator|->
name|bss
index|[
name|j
index|]
argument_list|,
name|src
argument_list|)
condition|)
block|{
name|hapd
operator|=
name|iface
operator|->
name|bss
index|[
name|j
index|]
expr_stmt|;
break|break;
block|}
block|}
name|ieee802_1x_receive
argument_list|(
name|hapd
argument_list|,
name|src
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_event
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|wpa_event_type
name|event
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|EVENT_MICHAEL_MIC_FAILURE
case|:
name|michael_mic_failure
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|michael_mic_failure
operator|.
name|src
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_SCAN_RESULTS
case|:
if|if
condition|(
name|hapd
operator|->
name|iface
operator|->
name|scan_cb
condition|)
name|hapd
operator|->
name|iface
operator|->
name|scan_cb
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
case|case
name|EVENT_FT_RRB_RX
case|:
name|wpa_ft_rrb_rx
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|,
name|data
operator|->
name|ft_rrb_rx
operator|.
name|src
argument_list|,
name|data
operator|->
name|ft_rrb_rx
operator|.
name|data
argument_list|,
name|data
operator|->
name|ft_rrb_rx
operator|.
name|data_len
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
case|case
name|EVENT_WPS_BUTTON_PUSHED
case|:
name|hostapd_wps_button_pushed
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|NEED_AP_MLME
case|case
name|EVENT_TX_STATUS
case|:
switch|switch
condition|(
name|data
operator|->
name|tx_status
operator|.
name|type
condition|)
block|{
case|case
name|WLAN_FC_TYPE_MGMT
case|:
name|hostapd_mgmt_tx_cb
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data_len
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|stype
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|ack
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_TYPE_DATA
case|:
name|hostapd_tx_status
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|dst
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data_len
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|ack
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|EVENT_RX_FROM_UNKNOWN
case|:
name|hostapd_rx_from_unknown_sta
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|rx_from_unknown
operator|.
name|frame
argument_list|,
name|data
operator|->
name|rx_from_unknown
operator|.
name|len
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_RX_MGMT
case|:
name|hostapd_mgmt_rx
argument_list|(
name|hapd
argument_list|,
operator|&
name|data
operator|->
name|rx_mgmt
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* NEED_AP_MLME */
case|case
name|EVENT_RX_PROBE_REQ
case|:
name|hostapd_probe_req_rx
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|sa
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ie
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ie_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_NEW_STA
case|:
name|hostapd_event_new_sta
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|new_sta
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_EAPOL_RX
case|:
name|hostapd_event_eapol_rx
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|eapol_rx
operator|.
name|src
argument_list|,
name|data
operator|->
name|eapol_rx
operator|.
name|data
argument_list|,
name|data
operator|->
name|eapol_rx
operator|.
name|data_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_ASSOC
case|:
name|hostapd_notif_assoc
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|addr
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DISASSOC
case|:
if|if
condition|(
name|data
condition|)
name|hostapd_notif_disassoc
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|disassoc_info
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DEAUTH
case|:
if|if
condition|(
name|data
condition|)
name|hostapd_notif_disassoc
argument_list|(
name|hapd
argument_list|,
name|data
operator|->
name|deauth_info
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unknown event %d"
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HOSTAPD */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Authentication server setup  * Copyright (c) 2002-2009, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/tls.h"
end_include

begin_include
include|#
directive|include
file|"eap_server/eap.h"
end_include

begin_include
include|#
directive|include
file|"eap_server/eap_sim_db.h"
end_include

begin_include
include|#
directive|include
file|"eapol_auth/eapol_auth_sm.h"
end_include

begin_include
include|#
directive|include
file|"radius/radius_server.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap_config.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"authsrv.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|EAP_SERVER_SIM
argument_list|)
operator|||
name|defined
argument_list|(
name|EAP_SERVER_AKA
argument_list|)
end_if

begin_define
define|#
directive|define
name|EAP_SIM_DB
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_SERVER_SIM || EAP_SERVER_AKA */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|EAP_SIM_DB
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_sim_db_cb_sta
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
if|if
condition|(
name|eapol_auth_eap_pending_cb
argument_list|(
name|sta
operator|->
name|eapol_sm
argument_list|,
name|ctx
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hostapd_sim_db_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|session_ctx
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|ap_for_each_sta
argument_list|(
name|hapd
argument_list|,
name|hostapd_sim_db_cb_sta
argument_list|,
name|session_ctx
argument_list|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|RADIUS_SERVER
name|radius_server_eap_pending_cb
argument_list|(
name|hapd
operator|->
name|radius_srv
argument_list|,
name|session_ctx
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* RADIUS_SERVER */
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* EAP_SIM_DB */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|RADIUS_SERVER
end_ifdef

begin_function
specifier|static
name|int
name|hostapd_radius_get_eap_user
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|identity
parameter_list|,
name|size_t
name|identity_len
parameter_list|,
name|int
name|phase2
parameter_list|,
name|struct
name|eap_user
modifier|*
name|user
parameter_list|)
block|{
specifier|const
name|struct
name|hostapd_eap_user
modifier|*
name|eap_user
decl_stmt|;
name|int
name|i
decl_stmt|,
name|count
decl_stmt|;
name|eap_user
operator|=
name|hostapd_get_eap_user
argument_list|(
name|ctx
argument_list|,
name|identity
argument_list|,
name|identity_len
argument_list|,
name|phase2
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_user
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|user
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|os_memset
argument_list|(
name|user
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|user
argument_list|)
argument_list|)
expr_stmt|;
name|count
operator|=
name|EAP_USER_MAX_METHODS
expr_stmt|;
if|if
condition|(
name|count
operator|>
name|EAP_MAX_METHODS
condition|)
name|count
operator|=
name|EAP_MAX_METHODS
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|vendor
operator|=
name|eap_user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|vendor
expr_stmt|;
name|user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|method
operator|=
name|eap_user
operator|->
name|methods
index|[
name|i
index|]
operator|.
name|method
expr_stmt|;
block|}
if|if
condition|(
name|eap_user
operator|->
name|password
condition|)
block|{
name|user
operator|->
name|password
operator|=
name|os_malloc
argument_list|(
name|eap_user
operator|->
name|password_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|user
operator|->
name|password
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|user
operator|->
name|password
argument_list|,
name|eap_user
operator|->
name|password
argument_list|,
name|eap_user
operator|->
name|password_len
argument_list|)
expr_stmt|;
name|user
operator|->
name|password_len
operator|=
name|eap_user
operator|->
name|password_len
expr_stmt|;
name|user
operator|->
name|password_hash
operator|=
name|eap_user
operator|->
name|password_hash
expr_stmt|;
block|}
name|user
operator|->
name|force_version
operator|=
name|eap_user
operator|->
name|force_version
expr_stmt|;
name|user
operator|->
name|ttls_auth
operator|=
name|eap_user
operator|->
name|ttls_auth
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|hostapd_setup_radius_srv
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|struct
name|radius_server_conf
name|srv
decl_stmt|;
name|struct
name|hostapd_bss_config
modifier|*
name|conf
init|=
name|hapd
operator|->
name|conf
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|srv
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|srv
argument_list|)
argument_list|)
expr_stmt|;
name|srv
operator|.
name|client_file
operator|=
name|conf
operator|->
name|radius_server_clients
expr_stmt|;
name|srv
operator|.
name|auth_port
operator|=
name|conf
operator|->
name|radius_server_auth_port
expr_stmt|;
name|srv
operator|.
name|conf_ctx
operator|=
name|conf
expr_stmt|;
name|srv
operator|.
name|eap_sim_db_priv
operator|=
name|hapd
operator|->
name|eap_sim_db_priv
expr_stmt|;
name|srv
operator|.
name|ssl_ctx
operator|=
name|hapd
operator|->
name|ssl_ctx
expr_stmt|;
name|srv
operator|.
name|msg_ctx
operator|=
name|hapd
operator|->
name|msg_ctx
expr_stmt|;
name|srv
operator|.
name|pac_opaque_encr_key
operator|=
name|conf
operator|->
name|pac_opaque_encr_key
expr_stmt|;
name|srv
operator|.
name|eap_fast_a_id
operator|=
name|conf
operator|->
name|eap_fast_a_id
expr_stmt|;
name|srv
operator|.
name|eap_fast_a_id_len
operator|=
name|conf
operator|->
name|eap_fast_a_id_len
expr_stmt|;
name|srv
operator|.
name|eap_fast_a_id_info
operator|=
name|conf
operator|->
name|eap_fast_a_id_info
expr_stmt|;
name|srv
operator|.
name|eap_fast_prov
operator|=
name|conf
operator|->
name|eap_fast_prov
expr_stmt|;
name|srv
operator|.
name|pac_key_lifetime
operator|=
name|conf
operator|->
name|pac_key_lifetime
expr_stmt|;
name|srv
operator|.
name|pac_key_refresh_time
operator|=
name|conf
operator|->
name|pac_key_refresh_time
expr_stmt|;
name|srv
operator|.
name|eap_sim_aka_result_ind
operator|=
name|conf
operator|->
name|eap_sim_aka_result_ind
expr_stmt|;
name|srv
operator|.
name|tnc
operator|=
name|conf
operator|->
name|tnc
expr_stmt|;
name|srv
operator|.
name|wps
operator|=
name|hapd
operator|->
name|wps
expr_stmt|;
name|srv
operator|.
name|ipv6
operator|=
name|conf
operator|->
name|radius_server_ipv6
expr_stmt|;
name|srv
operator|.
name|get_eap_user
operator|=
name|hostapd_radius_get_eap_user
expr_stmt|;
name|srv
operator|.
name|eap_req_id_text
operator|=
name|conf
operator|->
name|eap_req_id_text
expr_stmt|;
name|srv
operator|.
name|eap_req_id_text_len
operator|=
name|conf
operator|->
name|eap_req_id_text_len
expr_stmt|;
name|hapd
operator|->
name|radius_srv
operator|=
name|radius_server_init
argument_list|(
operator|&
name|srv
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|radius_srv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"RADIUS server initialization failed."
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* RADIUS_SERVER */
end_comment

begin_function
name|int
name|authsrv_init
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|EAP_TLS_FUNCS
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|eap_server
operator|&&
operator|(
name|hapd
operator|->
name|conf
operator|->
name|ca_cert
operator|||
name|hapd
operator|->
name|conf
operator|->
name|server_cert
operator|||
name|hapd
operator|->
name|conf
operator|->
name|dh_file
operator|)
condition|)
block|{
name|struct
name|tls_connection_params
name|params
decl_stmt|;
name|hapd
operator|->
name|ssl_ctx
operator|=
name|tls_init
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|ssl_ctx
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize TLS"
argument_list|)
expr_stmt|;
name|authsrv_deinit
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|ca_cert
operator|=
name|hapd
operator|->
name|conf
operator|->
name|ca_cert
expr_stmt|;
name|params
operator|.
name|client_cert
operator|=
name|hapd
operator|->
name|conf
operator|->
name|server_cert
expr_stmt|;
name|params
operator|.
name|private_key
operator|=
name|hapd
operator|->
name|conf
operator|->
name|private_key
expr_stmt|;
name|params
operator|.
name|private_key_passwd
operator|=
name|hapd
operator|->
name|conf
operator|->
name|private_key_passwd
expr_stmt|;
name|params
operator|.
name|dh_file
operator|=
name|hapd
operator|->
name|conf
operator|->
name|dh_file
expr_stmt|;
if|if
condition|(
name|tls_global_set_params
argument_list|(
name|hapd
operator|->
name|ssl_ctx
argument_list|,
operator|&
name|params
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to set TLS parameters"
argument_list|)
expr_stmt|;
name|authsrv_deinit
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|tls_global_set_verify
argument_list|(
name|hapd
operator|->
name|ssl_ctx
argument_list|,
name|hapd
operator|->
name|conf
operator|->
name|check_crl
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to enable check_crl"
argument_list|)
expr_stmt|;
name|authsrv_deinit
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
endif|#
directive|endif
comment|/* EAP_TLS_FUNCS */
ifdef|#
directive|ifdef
name|EAP_SIM_DB
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|eap_sim_db
condition|)
block|{
name|hapd
operator|->
name|eap_sim_db_priv
operator|=
name|eap_sim_db_init
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|eap_sim_db
argument_list|,
name|hostapd_sim_db_cb
argument_list|,
name|hapd
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|eap_sim_db_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize EAP-SIM "
literal|"database interface"
argument_list|)
expr_stmt|;
name|authsrv_deinit
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
endif|#
directive|endif
comment|/* EAP_SIM_DB */
ifdef|#
directive|ifdef
name|RADIUS_SERVER
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|radius_server_clients
operator|&&
name|hostapd_setup_radius_srv
argument_list|(
name|hapd
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* RADIUS_SERVER */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|authsrv_deinit
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|RADIUS_SERVER
name|radius_server_deinit
argument_list|(
name|hapd
operator|->
name|radius_srv
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|radius_srv
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* RADIUS_SERVER */
ifdef|#
directive|ifdef
name|EAP_TLS_FUNCS
if|if
condition|(
name|hapd
operator|->
name|ssl_ctx
condition|)
block|{
name|tls_deinit
argument_list|(
name|hapd
operator|->
name|ssl_ctx
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|ssl_ctx
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* EAP_TLS_FUNCS */
ifdef|#
directive|ifdef
name|EAP_SIM_DB
if|if
condition|(
name|hapd
operator|->
name|eap_sim_db_priv
condition|)
block|{
name|eap_sim_db_deinit
argument_list|(
name|hapd
operator|->
name|eap_sim_db_priv
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|eap_sim_db_priv
operator|=
name|NULL
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* EAP_SIM_DB */
block|}
end_function

end_unit


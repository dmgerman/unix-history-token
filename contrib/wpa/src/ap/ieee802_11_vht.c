begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / IEEE 802.11ac VHT  * Copyright (c) 2002-2009, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of BSD license  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap_config.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"beacon.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_function
name|u8
modifier|*
name|hostapd_eid_vht_capabilities
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
modifier|*
name|eid
parameter_list|)
block|{
name|struct
name|ieee80211_vht_capabilities
modifier|*
name|cap
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
name|eid
decl_stmt|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|iconf
operator|->
name|ieee80211ac
operator|||
operator|!
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|||
name|hapd
operator|->
name|conf
operator|->
name|disable_11ac
condition|)
return|return
name|eid
return|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_VHT_CAP
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|cap
argument_list|)
expr_stmt|;
name|cap
operator|=
operator|(
expr|struct
name|ieee80211_vht_capabilities
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memset
argument_list|(
name|cap
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cap
argument_list|)
argument_list|)
expr_stmt|;
name|cap
operator|->
name|vht_capabilities_info
operator|=
name|host_to_le32
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|->
name|vht_capab
argument_list|)
expr_stmt|;
comment|/* Supported MCS set comes from hw */
name|os_memcpy
argument_list|(
name|cap
operator|->
name|vht_supported_mcs_set
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|->
name|vht_mcs_set
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|cap
argument_list|)
expr_stmt|;
return|return
name|pos
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|hostapd_eid_vht_operation
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
modifier|*
name|eid
parameter_list|)
block|{
name|struct
name|ieee80211_vht_operation
modifier|*
name|oper
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
name|eid
decl_stmt|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|iconf
operator|->
name|ieee80211ac
operator|||
name|hapd
operator|->
name|conf
operator|->
name|disable_11ac
condition|)
return|return
name|eid
return|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_VHT_OPERATION
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|oper
argument_list|)
expr_stmt|;
name|oper
operator|=
operator|(
expr|struct
name|ieee80211_vht_operation
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memset
argument_list|(
name|oper
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|oper
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 	 * center freq = 5 GHz + (5 * index) 	 * So index 42 gives center freq 5.210 GHz 	 * which is channel 42 in 5G band 	 */
name|oper
operator|->
name|vht_op_info_chan_center_freq_seg0_idx
operator|=
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_centr_freq_seg0_idx
expr_stmt|;
name|oper
operator|->
name|vht_op_info_chan_center_freq_seg1_idx
operator|=
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_centr_freq_seg1_idx
expr_stmt|;
name|oper
operator|->
name|vht_op_info_chwidth
operator|=
name|hapd
operator|->
name|iconf
operator|->
name|vht_oper_chwidth
expr_stmt|;
comment|/* VHT Basic MCS set comes from hw */
comment|/* Hard code 1 stream, MCS0-7 is a min Basic VHT MCS rates */
name|oper
operator|->
name|vht_basic_mcs_set
operator|=
name|host_to_le16
argument_list|(
literal|0xfffc
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|oper
argument_list|)
expr_stmt|;
return|return
name|pos
return|;
block|}
end_function

begin_function
name|u16
name|copy_sta_vht_capab
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
specifier|const
name|u8
modifier|*
name|vht_capab
parameter_list|,
name|size_t
name|vht_capab_len
parameter_list|)
block|{
comment|/* Disable VHT caps for STAs associated to no-VHT BSSes. */
if|if
condition|(
operator|!
name|vht_capab
operator|||
name|vht_capab_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_vht_capabilities
argument_list|)
operator|||
name|hapd
operator|->
name|conf
operator|->
name|disable_11ac
condition|)
block|{
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WLAN_STA_VHT
expr_stmt|;
name|os_free
argument_list|(
name|sta
operator|->
name|vht_capabilities
argument_list|)
expr_stmt|;
name|sta
operator|->
name|vht_capabilities
operator|=
name|NULL
expr_stmt|;
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
if|if
condition|(
name|sta
operator|->
name|vht_capabilities
operator|==
name|NULL
condition|)
block|{
name|sta
operator|->
name|vht_capabilities
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_vht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|vht_capabilities
operator|==
name|NULL
condition|)
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_VHT
expr_stmt|;
name|os_memcpy
argument_list|(
name|sta
operator|->
name|vht_capabilities
argument_list|,
name|vht_capab
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_vht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
end_function

end_unit


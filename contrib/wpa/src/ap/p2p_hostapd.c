begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / P2P integration  * Copyright (c) 2009-2010, Atheros Communications  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"p2p/p2p.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ap_drv_ops.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"p2p_hostapd.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_P2P
end_ifdef

begin_function
name|int
name|hostapd_p2p_get_mib_sta
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
if|if
condition|(
name|sta
operator|->
name|p2p_ie
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
name|p2p_ie_text
argument_list|(
name|sta
operator|->
name|p2p_ie
argument_list|,
name|buf
argument_list|,
name|buf
operator|+
name|buflen
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|hostapd_p2p_set_noa
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
name|count
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|duration
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set NoA parameters: count=%u start=%d "
literal|"duration=%d"
argument_list|,
name|count
argument_list|,
name|start
argument_list|,
name|duration
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|hapd
operator|->
name|noa_enabled
operator|=
literal|0
expr_stmt|;
name|hapd
operator|->
name|noa_start
operator|=
literal|0
expr_stmt|;
name|hapd
operator|->
name|noa_duration
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|!=
literal|255
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Non-periodic NoA - set "
literal|"NoA parameters"
argument_list|)
expr_stmt|;
return|return
name|hostapd_driver_set_noa
argument_list|(
name|hapd
argument_list|,
name|count
argument_list|,
name|start
argument_list|,
name|duration
argument_list|)
return|;
block|}
name|hapd
operator|->
name|noa_enabled
operator|=
literal|1
expr_stmt|;
name|hapd
operator|->
name|noa_start
operator|=
name|start
expr_stmt|;
name|hapd
operator|->
name|noa_duration
operator|=
name|duration
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|num_sta_no_p2p
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No legacy STAs connected - update "
literal|"periodic NoA parameters"
argument_list|)
expr_stmt|;
return|return
name|hostapd_driver_set_noa
argument_list|(
name|hapd
argument_list|,
name|count
argument_list|,
name|start
argument_list|,
name|duration
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Legacy STA(s) connected - do not enable "
literal|"periodic NoA"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|hostapd_p2p_non_p2p_sta_connected
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: First non-P2P device connected"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|noa_enabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Disable periodic NoA"
argument_list|)
expr_stmt|;
name|hostapd_driver_set_noa
argument_list|(
name|hapd
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|hostapd_p2p_non_p2p_sta_disconnected
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Last non-P2P device disconnected"
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|noa_enabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Enable periodic NoA"
argument_list|)
expr_stmt|;
name|hostapd_driver_set_noa
argument_list|(
name|hapd
argument_list|,
literal|255
argument_list|,
name|hapd
operator|->
name|noa_start
argument_list|,
name|hapd
operator|->
name|noa_duration
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_P2P */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_P2P_MANAGER
end_ifdef

begin_function
name|u8
modifier|*
name|hostapd_eid_p2p_manage
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
modifier|*
name|eid
parameter_list|)
block|{
name|u8
name|bitmap
decl_stmt|;
operator|*
name|eid
operator|++
operator|=
name|WLAN_EID_VENDOR_SPECIFIC
expr_stmt|;
operator|*
name|eid
operator|++
operator|=
literal|4
operator|+
literal|3
operator|+
literal|1
expr_stmt|;
name|WPA_PUT_BE24
argument_list|(
name|eid
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|eid
operator|+=
literal|3
expr_stmt|;
operator|*
name|eid
operator|++
operator|=
name|P2P_OUI_TYPE
expr_stmt|;
operator|*
name|eid
operator|++
operator|=
name|P2P_ATTR_MANAGEABILITY
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|eid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|eid
operator|+=
literal|2
expr_stmt|;
name|bitmap
operator|=
name|P2P_MAN_DEVICE_MANAGEMENT
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|p2p
operator|&
name|P2P_ALLOW_CROSS_CONNECTION
condition|)
name|bitmap
operator||=
name|P2P_MAN_CROSS_CONNECTION_PERMITTED
expr_stmt|;
name|bitmap
operator||=
name|P2P_MAN_COEXISTENCE_OPTIONAL
expr_stmt|;
operator|*
name|eid
operator|++
operator|=
name|bitmap
expr_stmt|;
return|return
name|eid
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_P2P_MANAGER */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd - WNM  * Copyright (c) 2011-2012, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/sta_info.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_drv_ops.h"
end_include

begin_include
include|#
directive|include
file|"ap/wpa_auth.h"
end_include

begin_include
include|#
directive|include
file|"wnm_ap.h"
end_include

begin_define
define|#
directive|define
name|MAX_TFS_IE_LEN
value|1024
end_define

begin_comment
comment|/* get the TFS IE from driver */
end_comment

begin_function
specifier|static
name|int
name|ieee80211_11_get_tfs_ie
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|u16
modifier|*
name|buf_len
parameter_list|,
name|enum
name|wnm_oper
name|oper
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: TFS get operation %d"
argument_list|,
name|__func__
argument_list|,
name|oper
argument_list|)
expr_stmt|;
return|return
name|hostapd_drv_wnm_oper
argument_list|(
name|hapd
argument_list|,
name|oper
argument_list|,
name|addr
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* set the TFS IE to driver */
end_comment

begin_function
specifier|static
name|int
name|ieee80211_11_set_tfs_ie
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|u16
modifier|*
name|buf_len
parameter_list|,
name|enum
name|wnm_oper
name|oper
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: TFS set operation %d"
argument_list|,
name|__func__
argument_list|,
name|oper
argument_list|)
expr_stmt|;
return|return
name|hostapd_drv_wnm_oper
argument_list|(
name|hapd
argument_list|,
name|oper
argument_list|,
name|addr
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* MLME-SLEEPMODE.response */
end_comment

begin_function
specifier|static
name|int
name|ieee802_11_send_wnmsleep_resp
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|u8
name|action_type
parameter_list|,
name|u16
name|intval
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|size_t
name|gtk_elem_len
init|=
literal|0
decl_stmt|;
name|size_t
name|igtk_elem_len
init|=
literal|0
decl_stmt|;
name|struct
name|wnm_sleep_element
name|wnmsleep_ie
decl_stmt|;
name|u8
modifier|*
name|wnmtfs_ie
decl_stmt|;
name|u8
name|wnmsleep_ie_len
decl_stmt|;
name|u16
name|wnmtfs_ie_len
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|enum
name|wnm_oper
name|tfs_oper
init|=
name|action_type
operator|==
name|WNM_SLEEP_MODE_ENTER
condition|?
name|WNM_SLEEP_TFS_RESP_IE_ADD
else|:
name|WNM_SLEEP_TFS_RESP_IE_NONE
decl_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: station not found"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
comment|/* WNM-Sleep Mode IE */
name|os_memset
argument_list|(
operator|&
name|wnmsleep_ie
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wnm_sleep_element
argument_list|)
argument_list|)
expr_stmt|;
name|wnmsleep_ie_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|wnm_sleep_element
argument_list|)
expr_stmt|;
name|wnmsleep_ie
operator|.
name|eid
operator|=
name|WLAN_EID_WNMSLEEP
expr_stmt|;
name|wnmsleep_ie
operator|.
name|len
operator|=
name|wnmsleep_ie_len
operator|-
literal|2
expr_stmt|;
name|wnmsleep_ie
operator|.
name|action_type
operator|=
name|action_type
expr_stmt|;
name|wnmsleep_ie
operator|.
name|status
operator|=
name|WNM_STATUS_SLEEP_ACCEPT
expr_stmt|;
name|wnmsleep_ie
operator|.
name|intval
operator|=
name|intval
expr_stmt|;
comment|/* TFS IE(s) */
name|wnmtfs_ie
operator|=
name|os_zalloc
argument_list|(
name|MAX_TFS_IE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmtfs_ie
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|ieee80211_11_get_tfs_ie
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|wnmtfs_ie
argument_list|,
operator|&
name|wnmtfs_ie_len
argument_list|,
name|tfs_oper
argument_list|)
condition|)
block|{
name|wnmtfs_ie_len
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|wnmtfs_ie
argument_list|)
expr_stmt|;
name|wnmtfs_ie
operator|=
name|NULL
expr_stmt|;
block|}
define|#
directive|define
name|MAX_GTK_SUBELEM_LEN
value|45
define|#
directive|define
name|MAX_IGTK_SUBELEM_LEN
value|26
name|mgmt
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mgmt
argument_list|)
operator|+
name|wnmsleep_ie_len
operator|+
name|MAX_GTK_SUBELEM_LEN
operator|+
name|MAX_IGTK_SUBELEM_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgmt
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Failed to allocate buffer for "
literal|"WNM-Sleep Response action frame"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|hapd
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ACTION
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|=
name|WLAN_ACTION_WNM
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_resp
operator|.
name|action
operator|=
name|WNM_SLEEP_MODE_RESP
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_resp
operator|.
name|dialogtoken
operator|=
name|dialog_token
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_resp
operator|.
name|variable
expr_stmt|;
comment|/* add key data if MFP is enabled */
if|if
condition|(
operator|!
name|wpa_auth_uses_mfp
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|)
operator|||
name|action_type
operator|!=
name|WNM_SLEEP_MODE_EXIT
condition|)
block|{
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_resp
operator|.
name|keydata_len
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|gtk_elem_len
operator|=
name|wpa_wnmsleep_gtk_subelem
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|gtk_elem_len
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Pass 4, gtk_len = %d"
argument_list|,
operator|(
name|int
operator|)
name|gtk_elem_len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|res
operator|=
name|wpa_wnmsleep_igtk_subelem
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|wnmtfs_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|mgmt
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|igtk_elem_len
operator|=
name|res
expr_stmt|;
name|pos
operator|+=
name|igtk_elem_len
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Pass 4 igtk_len = %d"
argument_list|,
operator|(
name|int
operator|)
name|igtk_elem_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|WPA_PUT_LE16
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_resp
operator|.
name|keydata_len
argument_list|,
name|gtk_elem_len
operator|+
name|igtk_elem_len
argument_list|)
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|wnmsleep_ie
argument_list|,
name|wnmsleep_ie_len
argument_list|)
expr_stmt|;
comment|/* copy TFS IE here */
name|pos
operator|+=
name|wnmsleep_ie_len
expr_stmt|;
if|if
condition|(
name|wnmtfs_ie
condition|)
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|wnmtfs_ie
argument_list|,
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
name|len
operator|=
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_resp
argument_list|)
operator|+
name|gtk_elem_len
operator|+
name|igtk_elem_len
operator|+
name|wnmsleep_ie_len
operator|+
name|wnmtfs_ie_len
expr_stmt|;
comment|/* In driver, response frame should be forced to sent when STA is in 	 * PS mode */
name|res
operator|=
name|hostapd_drv_send_action
argument_list|(
name|hapd
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|freq
argument_list|,
literal|0
argument_list|,
name|mgmt
operator|->
name|da
argument_list|,
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Successfully send WNM-Sleep Response "
literal|"frame"
argument_list|)
expr_stmt|;
comment|/* when entering wnmsleep 		 * 1. pause the node in driver 		 * 2. mark the node so that AP won't update GTK/IGTK during 		 * WNM Sleep 		 */
if|if
condition|(
name|wnmsleep_ie
operator|.
name|status
operator|==
name|WNM_STATUS_SLEEP_ACCEPT
operator|&&
name|wnmsleep_ie
operator|.
name|action_type
operator|==
name|WNM_SLEEP_MODE_ENTER
condition|)
block|{
name|hostapd_drv_wnm_oper
argument_list|(
name|hapd
argument_list|,
name|WNM_SLEEP_ENTER_CONFIRM
argument_list|,
name|addr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_set_wnmsleep
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* when exiting wnmsleep 		 * 1. unmark the node 		 * 2. start GTK/IGTK update if MFP is not used 		 * 3. unpause the node in driver 		 */
if|if
condition|(
operator|(
name|wnmsleep_ie
operator|.
name|status
operator|==
name|WNM_STATUS_SLEEP_ACCEPT
operator|||
name|wnmsleep_ie
operator|.
name|status
operator|==
name|WNM_STATUS_SLEEP_EXIT_ACCEPT_GTK_UPDATE
operator|)
operator|&&
name|wnmsleep_ie
operator|.
name|action_type
operator|==
name|WNM_SLEEP_MODE_EXIT
condition|)
block|{
name|wpa_set_wnmsleep
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hostapd_drv_wnm_oper
argument_list|(
name|hapd
argument_list|,
name|WNM_SLEEP_EXIT_CONFIRM
argument_list|,
name|addr
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_auth_uses_mfp
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|)
condition|)
name|wpa_wnmsleep_rekey_gtk
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Fail to send WNM-Sleep Response frame"
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|MAX_GTK_SUBELEM_LEN
undef|#
directive|undef
name|MAX_IGTK_SUBELEM_LEN
name|os_free
argument_list|(
name|wnmtfs_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|mgmt
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee802_11_rx_wnmsleep_req
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|frm
parameter_list|,
name|int
name|len
parameter_list|)
block|{
comment|/* Dialog Token [1] | WNM-Sleep Mode IE | TFS Response IE */
specifier|const
name|u8
modifier|*
name|pos
init|=
name|frm
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|struct
name|wnm_sleep_element
modifier|*
name|wnmsleep_ie
init|=
name|NULL
decl_stmt|;
comment|/* multiple TFS Req IE (assuming consecutive) */
name|u8
modifier|*
name|tfsreq_ie_start
init|=
name|NULL
decl_stmt|;
name|u8
modifier|*
name|tfsreq_ie_end
init|=
name|NULL
decl_stmt|;
name|u16
name|tfsreq_ie_len
init|=
literal|0
decl_stmt|;
name|dialog_token
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|frm
operator|+
name|len
condition|)
block|{
name|u8
name|ie_len
init|=
name|pos
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|ie_len
operator|>
name|frm
operator|+
name|len
condition|)
break|break;
if|if
condition|(
operator|*
name|pos
operator|==
name|WLAN_EID_WNMSLEEP
condition|)
name|wnmsleep_ie
operator|=
operator|(
expr|struct
name|wnm_sleep_element
operator|*
operator|)
name|pos
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|pos
operator|==
name|WLAN_EID_TFS_REQ
condition|)
block|{
if|if
condition|(
operator|!
name|tfsreq_ie_start
condition|)
name|tfsreq_ie_start
operator|=
operator|(
name|u8
operator|*
operator|)
name|pos
expr_stmt|;
name|tfsreq_ie_end
operator|=
operator|(
name|u8
operator|*
operator|)
name|pos
expr_stmt|;
block|}
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: EID %d not recognized"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ie_len
operator|+
literal|2
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wnmsleep_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No WNM-Sleep IE found"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wnmsleep_ie
operator|->
name|action_type
operator|==
name|WNM_SLEEP_MODE_ENTER
operator|&&
name|tfsreq_ie_start
operator|&&
name|tfsreq_ie_end
operator|&&
name|tfsreq_ie_end
operator|-
name|tfsreq_ie_start
operator|>=
literal|0
condition|)
block|{
name|tfsreq_ie_len
operator|=
operator|(
name|tfsreq_ie_end
operator|+
name|tfsreq_ie_end
index|[
literal|1
index|]
operator|+
literal|2
operator|)
operator|-
name|tfsreq_ie_start
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TFS Req IE(s) found"
argument_list|)
expr_stmt|;
comment|/* pass the TFS Req IE(s) to driver for processing */
if|if
condition|(
name|ieee80211_11_set_tfs_ie
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|tfsreq_ie_start
argument_list|,
operator|&
name|tfsreq_ie_len
argument_list|,
name|WNM_SLEEP_TFS_REQ_IE_SET
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Fail to set TFS Req IE"
argument_list|)
expr_stmt|;
block|}
name|ieee802_11_send_wnmsleep_resp
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|dialog_token
argument_list|,
name|wnmsleep_ie
operator|->
name|action_type
argument_list|,
name|wnmsleep_ie
operator|->
name|intval
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmsleep_ie
operator|->
name|action_type
operator|==
name|WNM_SLEEP_MODE_EXIT
condition|)
block|{
comment|/* clear the tfs after sending the resp frame */
name|ieee80211_11_set_tfs_ie
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|tfsreq_ie_start
argument_list|,
operator|&
name|tfsreq_ie_len
argument_list|,
name|WNM_SLEEP_TFS_IE_DEL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|ieee802_11_rx_wnm_action_ap
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|rx_action
modifier|*
name|action
parameter_list|)
block|{
if|if
condition|(
name|action
operator|->
name|len
operator|<
literal|1
operator|||
name|action
operator|->
name|data
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
switch|switch
condition|(
name|action
operator|->
name|data
index|[
literal|0
index|]
condition|)
block|{
case|case
name|WNM_BSS_TRANS_MGMT_QUERY
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: BSS Transition Management Query"
argument_list|)
expr_stmt|;
comment|/* TODO */
return|return
operator|-
literal|1
return|;
case|case
name|WNM_BSS_TRANS_MGMT_RESP
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: BSS Transition Management "
literal|"Response"
argument_list|)
expr_stmt|;
comment|/* TODO */
return|return
operator|-
literal|1
return|;
case|case
name|WNM_SLEEP_MODE_REQ
case|:
name|ieee802_11_rx_wnmsleep_req
argument_list|(
name|hapd
argument_list|,
name|action
operator|->
name|sa
argument_list|,
name|action
operator|->
name|data
operator|+
literal|1
argument_list|,
name|action
operator|->
name|len
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Unsupported WNM Action %u from "
name|MACSTR
argument_list|,
name|action
operator|->
name|data
index|[
literal|0
index|]
argument_list|,
name|MAC2STR
argument_list|(
name|action
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

end_unit


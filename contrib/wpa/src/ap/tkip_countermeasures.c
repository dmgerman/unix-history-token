begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / TKIP countermeasures  * Copyright (c) 2002-2009, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"ap_mlme.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth.h"
end_include

begin_include
include|#
directive|include
file|"tkip_countermeasures.h"
end_include

begin_function
specifier|static
name|void
name|ieee80211_tkip_countermeasures_stop
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|eloop_ctx
decl_stmt|;
name|hapd
operator|->
name|tkip_countermeasures
operator|=
literal|0
expr_stmt|;
name|hapd
operator|->
name|drv
operator|.
name|set_countermeasures
argument_list|(
name|hapd
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"TKIP countermeasures ended"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee80211_tkip_countermeasures_start
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|NULL
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"TKIP countermeasures initiated"
argument_list|)
expr_stmt|;
name|wpa_auth_countermeasures_start
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|tkip_countermeasures
operator|=
literal|1
expr_stmt|;
name|hapd
operator|->
name|drv
operator|.
name|set_countermeasures
argument_list|(
name|hapd
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_gtk_rekey
argument_list|(
name|hapd
operator|->
name|wpa_auth
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|ieee80211_tkip_countermeasures_stop
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|60
argument_list|,
literal|0
argument_list|,
name|ieee80211_tkip_countermeasures_stop
argument_list|,
name|hapd
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|sta
operator|=
name|hapd
operator|->
name|sta_list
init|;
name|sta
operator|!=
name|NULL
condition|;
name|sta
operator|=
name|sta
operator|->
name|next
control|)
block|{
name|hapd
operator|->
name|drv
operator|.
name|sta_deauth
argument_list|(
name|hapd
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|WLAN_REASON_MICHAEL_MIC_FAILURE
argument_list|)
expr_stmt|;
name|sta
operator|->
name|flags
operator|&=
operator|~
operator|(
name|WLAN_STA_AUTH
operator||
name|WLAN_STA_ASSOC
operator||
name|WLAN_STA_AUTHORIZED
operator|)
expr_stmt|;
name|hapd
operator|->
name|drv
operator|.
name|sta_remove
argument_list|(
name|hapd
argument_list|,
name|sta
operator|->
name|addr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|michael_mic_failure
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|local
parameter_list|)
block|{
name|time_t
name|now
decl_stmt|;
if|if
condition|(
name|addr
operator|&&
name|local
condition|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
init|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|sta
operator|!=
name|NULL
condition|)
block|{
name|wpa_auth_sta_local_mic_failure_report
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|)
expr_stmt|;
name|hostapd_logger
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|,
name|HOSTAPD_MODULE_IEEE80211
argument_list|,
name|HOSTAPD_LEVEL_INFO
argument_list|,
literal|"Michael MIC failure detected in "
literal|"received frame"
argument_list|)
expr_stmt|;
name|mlme_michaelmicfailure_indication
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME-MICHAELMICFAILURE.indication "
literal|"for not associated STA ("
name|MACSTR
literal|") ignored"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|>
name|hapd
operator|->
name|michael_mic_failure
operator|+
literal|60
condition|)
block|{
name|hapd
operator|->
name|michael_mic_failures
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|hapd
operator|->
name|michael_mic_failures
operator|++
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|michael_mic_failures
operator|>
literal|1
condition|)
name|ieee80211_tkip_countermeasures_start
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
block|}
name|hapd
operator|->
name|michael_mic_failure
operator|=
name|now
expr_stmt|;
block|}
end_function

end_unit


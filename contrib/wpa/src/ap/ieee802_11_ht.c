begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd / IEEE 802.11n HT  * Copyright (c) 2002-2009, Jouni Malinen<j@w1.fi>  * Copyright (c) 2007-2008, Intel Corporation  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap_config.h"
end_include

begin_include
include|#
directive|include
file|"sta_info.h"
end_include

begin_include
include|#
directive|include
file|"beacon.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_function
name|u8
modifier|*
name|hostapd_eid_ht_capabilities
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
modifier|*
name|eid
parameter_list|)
block|{
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|cap
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
name|eid
decl_stmt|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|iconf
operator|->
name|ieee80211n
operator|||
operator|!
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|||
name|hapd
operator|->
name|conf
operator|->
name|disable_11n
condition|)
return|return
name|eid
return|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_HT_CAP
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|cap
argument_list|)
expr_stmt|;
name|cap
operator|=
operator|(
expr|struct
name|ieee80211_ht_capabilities
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memset
argument_list|(
name|cap
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cap
argument_list|)
argument_list|)
expr_stmt|;
name|cap
operator|->
name|ht_capabilities_info
operator|=
name|host_to_le16
argument_list|(
name|hapd
operator|->
name|iconf
operator|->
name|ht_capab
argument_list|)
expr_stmt|;
name|cap
operator|->
name|a_mpdu_params
operator|=
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|->
name|a_mpdu_params
expr_stmt|;
name|os_memcpy
argument_list|(
name|cap
operator|->
name|supported_mcs_set
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|current_mode
operator|->
name|mcs_set
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/* TODO: ht_extended_capabilities (now fully disabled) */
comment|/* TODO: tx_bf_capability_info (now fully disabled) */
comment|/* TODO: asel_capabilities (now fully disabled) */
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|cap
argument_list|)
expr_stmt|;
return|return
name|pos
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|hostapd_eid_ht_operation
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|u8
modifier|*
name|eid
parameter_list|)
block|{
name|struct
name|ieee80211_ht_operation
modifier|*
name|oper
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
name|eid
decl_stmt|;
if|if
condition|(
operator|!
name|hapd
operator|->
name|iconf
operator|->
name|ieee80211n
operator|||
name|hapd
operator|->
name|conf
operator|->
name|disable_11n
condition|)
return|return
name|eid
return|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_HT_OPERATION
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|oper
argument_list|)
expr_stmt|;
name|oper
operator|=
operator|(
expr|struct
name|ieee80211_ht_operation
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memset
argument_list|(
name|oper
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|oper
argument_list|)
argument_list|)
expr_stmt|;
name|oper
operator|->
name|control_chan
operator|=
name|hapd
operator|->
name|iconf
operator|->
name|channel
expr_stmt|;
name|oper
operator|->
name|operation_mode
operator|=
name|host_to_le16
argument_list|(
name|hapd
operator|->
name|iface
operator|->
name|ht_op_mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|iconf
operator|->
name|secondary_channel
operator|==
literal|1
condition|)
name|oper
operator|->
name|ht_param
operator||=
name|HT_INFO_HT_PARAM_SECONDARY_CHNL_ABOVE
operator||
name|HT_INFO_HT_PARAM_REC_TRANS_CHNL_WIDTH
expr_stmt|;
if|if
condition|(
name|hapd
operator|->
name|iconf
operator|->
name|secondary_channel
operator|==
operator|-
literal|1
condition|)
name|oper
operator|->
name|ht_param
operator||=
name|HT_INFO_HT_PARAM_SECONDARY_CHNL_BELOW
operator||
name|HT_INFO_HT_PARAM_REC_TRANS_CHNL_WIDTH
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
operator|*
name|oper
argument_list|)
expr_stmt|;
return|return
name|pos
return|;
block|}
end_function

begin_comment
comment|/* op_mode Set to 0 (HT pure) under the followign conditions 	- all STAs in the BSS are 20/40 MHz HT in 20/40 MHz BSS or 	- all STAs in the BSS are 20 MHz HT in 20 MHz BSS Set to 1 (HT non-member protection) if there may be non-HT STAs 	in both the primary and the secondary channel Set to 2 if only HT STAs are associated in BSS, 	however and at least one 20 MHz HT STA is associated Set to 3 (HT mixed mode) when one or more non-HT STAs are associated */
end_comment

begin_function
name|int
name|hostapd_ht_operation_update
parameter_list|(
name|struct
name|hostapd_iface
modifier|*
name|iface
parameter_list|)
block|{
name|u16
name|cur_op_mode
decl_stmt|,
name|new_op_mode
decl_stmt|;
name|int
name|op_mode_changes
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|iface
operator|->
name|conf
operator|->
name|ieee80211n
operator|||
name|iface
operator|->
name|conf
operator|->
name|ht_op_mode_fixed
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s current operation mode=0x%X"
argument_list|,
name|__func__
argument_list|,
name|iface
operator|->
name|ht_op_mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|iface
operator|->
name|ht_op_mode
operator|&
name|HT_INFO_OPERATION_MODE_NON_GF_DEVS_PRESENT
operator|)
operator|&&
name|iface
operator|->
name|num_sta_ht_no_gf
condition|)
block|{
name|iface
operator|->
name|ht_op_mode
operator||=
name|HT_INFO_OPERATION_MODE_NON_GF_DEVS_PRESENT
expr_stmt|;
name|op_mode_changes
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|iface
operator|->
name|ht_op_mode
operator|&
name|HT_INFO_OPERATION_MODE_NON_GF_DEVS_PRESENT
operator|)
operator|&&
name|iface
operator|->
name|num_sta_ht_no_gf
operator|==
literal|0
condition|)
block|{
name|iface
operator|->
name|ht_op_mode
operator|&=
operator|~
name|HT_INFO_OPERATION_MODE_NON_GF_DEVS_PRESENT
expr_stmt|;
name|op_mode_changes
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|iface
operator|->
name|ht_op_mode
operator|&
name|HT_INFO_OPERATION_MODE_NON_HT_STA_PRESENT
operator|)
operator|&&
operator|(
name|iface
operator|->
name|num_sta_no_ht
operator|||
name|iface
operator|->
name|olbc_ht
operator|)
condition|)
block|{
name|iface
operator|->
name|ht_op_mode
operator||=
name|HT_INFO_OPERATION_MODE_NON_HT_STA_PRESENT
expr_stmt|;
name|op_mode_changes
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|iface
operator|->
name|ht_op_mode
operator|&
name|HT_INFO_OPERATION_MODE_NON_HT_STA_PRESENT
operator|)
operator|&&
operator|(
name|iface
operator|->
name|num_sta_no_ht
operator|==
literal|0
operator|&&
operator|!
name|iface
operator|->
name|olbc_ht
operator|)
condition|)
block|{
name|iface
operator|->
name|ht_op_mode
operator|&=
operator|~
name|HT_INFO_OPERATION_MODE_NON_HT_STA_PRESENT
expr_stmt|;
name|op_mode_changes
operator|++
expr_stmt|;
block|}
name|new_op_mode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|num_sta_no_ht
condition|)
name|new_op_mode
operator|=
name|OP_MODE_MIXED
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|iface
operator|->
name|conf
operator|->
name|ht_capab
operator|&
name|HT_CAP_INFO_SUPP_CHANNEL_WIDTH_SET
operator|)
operator|&&
name|iface
operator|->
name|num_sta_ht_20mhz
condition|)
name|new_op_mode
operator|=
name|OP_MODE_20MHZ_HT_STA_ASSOCED
expr_stmt|;
elseif|else
if|if
condition|(
name|iface
operator|->
name|olbc_ht
condition|)
name|new_op_mode
operator|=
name|OP_MODE_MAY_BE_LEGACY_STAS
expr_stmt|;
else|else
name|new_op_mode
operator|=
name|OP_MODE_PURE
expr_stmt|;
name|cur_op_mode
operator|=
name|iface
operator|->
name|ht_op_mode
operator|&
name|HT_INFO_OPERATION_MODE_OP_MODE_MASK
expr_stmt|;
if|if
condition|(
name|cur_op_mode
operator|!=
name|new_op_mode
condition|)
block|{
name|iface
operator|->
name|ht_op_mode
operator|&=
operator|~
name|HT_INFO_OPERATION_MODE_OP_MODE_MASK
expr_stmt|;
name|iface
operator|->
name|ht_op_mode
operator||=
name|new_op_mode
expr_stmt|;
name|op_mode_changes
operator|++
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s new operation mode=0x%X changes=%d"
argument_list|,
name|__func__
argument_list|,
name|iface
operator|->
name|ht_op_mode
argument_list|,
name|op_mode_changes
argument_list|)
expr_stmt|;
return|return
name|op_mode_changes
return|;
block|}
end_function

begin_function
name|u16
name|copy_sta_ht_capab
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
specifier|const
name|u8
modifier|*
name|ht_capab
parameter_list|,
name|size_t
name|ht_capab_len
parameter_list|)
block|{
comment|/* Disable HT caps for STAs associated to no-HT BSSes. */
if|if
condition|(
operator|!
name|ht_capab
operator|||
name|ht_capab_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_ht_capabilities
argument_list|)
operator|||
name|hapd
operator|->
name|conf
operator|->
name|disable_11n
condition|)
block|{
name|sta
operator|->
name|flags
operator|&=
operator|~
name|WLAN_STA_HT
expr_stmt|;
name|os_free
argument_list|(
name|sta
operator|->
name|ht_capabilities
argument_list|)
expr_stmt|;
name|sta
operator|->
name|ht_capabilities
operator|=
name|NULL
expr_stmt|;
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
if|if
condition|(
name|sta
operator|->
name|ht_capabilities
operator|==
name|NULL
condition|)
block|{
name|sta
operator|->
name|ht_capabilities
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_ht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|ht_capabilities
operator|==
name|NULL
condition|)
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_HT
expr_stmt|;
name|os_memcpy
argument_list|(
name|sta
operator|->
name|ht_capabilities
argument_list|,
name|ht_capab
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_ht_capabilities
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|update_sta_ht
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|u16
name|ht_capab
decl_stmt|;
name|ht_capab
operator|=
name|le_to_host16
argument_list|(
name|sta
operator|->
name|ht_capabilities
operator|->
name|ht_capabilities_info
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HT: STA "
name|MACSTR
literal|" HT Capabilities Info: "
literal|"0x%04x"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|ht_capab
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ht_capab
operator|&
name|HT_CAP_INFO_GREEN_FIELD
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|sta
operator|->
name|no_ht_gf_set
condition|)
block|{
name|sta
operator|->
name|no_ht_gf_set
operator|=
literal|1
expr_stmt|;
name|hapd
operator|->
name|iface
operator|->
name|num_sta_ht_no_gf
operator|++
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s STA "
name|MACSTR
literal|" - no greenfield, num "
literal|"of non-gf stations %d"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|num_sta_ht_no_gf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ht_capab
operator|&
name|HT_CAP_INFO_SUPP_CHANNEL_WIDTH_SET
operator|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|sta
operator|->
name|ht_20mhz_set
condition|)
block|{
name|sta
operator|->
name|ht_20mhz_set
operator|=
literal|1
expr_stmt|;
name|hapd
operator|->
name|iface
operator|->
name|num_sta_ht_20mhz
operator|++
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s STA "
name|MACSTR
literal|" - 20 MHz HT, num of "
literal|"20MHz HT STAs %d"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|num_sta_ht_20mhz
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|update_sta_no_ht
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
if|if
condition|(
operator|!
name|sta
operator|->
name|no_ht_set
condition|)
block|{
name|sta
operator|->
name|no_ht_set
operator|=
literal|1
expr_stmt|;
name|hapd
operator|->
name|iface
operator|->
name|num_sta_no_ht
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|hapd
operator|->
name|iconf
operator|->
name|ieee80211n
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s STA "
name|MACSTR
literal|" - no HT, num of "
literal|"non-HT stations %d"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|hapd
operator|->
name|iface
operator|->
name|num_sta_no_ht
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|update_ht_state
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
if|if
condition|(
operator|(
name|sta
operator|->
name|flags
operator|&
name|WLAN_STA_HT
operator|)
operator|&&
name|sta
operator|->
name|ht_capabilities
condition|)
name|update_sta_ht
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
else|else
name|update_sta_no_ht
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
if|if
condition|(
name|hostapd_ht_operation_update
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
operator|>
literal|0
condition|)
name|ieee802_11_set_beacons
argument_list|(
name|hapd
operator|->
name|iface
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hostapd_get_ht_capab
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|ht_cap
parameter_list|,
name|struct
name|ieee80211_ht_capabilities
modifier|*
name|neg_ht_cap
parameter_list|)
block|{
name|u16
name|cap
decl_stmt|;
if|if
condition|(
name|ht_cap
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|neg_ht_cap
argument_list|,
name|ht_cap
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|neg_ht_cap
argument_list|)
argument_list|)
expr_stmt|;
name|cap
operator|=
name|le_to_host16
argument_list|(
name|neg_ht_cap
operator|->
name|ht_capabilities_info
argument_list|)
expr_stmt|;
comment|/* 	 * Mask out HT features we don't support, but don't overwrite 	 * non-symmetric features like STBC and SMPS. Just because 	 * we're not in dynamic SMPS mode the STA might still be. 	 */
name|cap
operator|&=
operator|(
name|hapd
operator|->
name|iconf
operator|->
name|ht_capab
operator||
name|HT_CAP_INFO_RX_STBC_MASK
operator||
name|HT_CAP_INFO_TX_STBC
operator||
name|HT_CAP_INFO_SMPS_MASK
operator|)
expr_stmt|;
comment|/* 	 * STBC needs to be handled specially 	 * if we don't support RX STBC, mask out TX STBC in the STA's HT caps 	 * if we don't support TX STBC, mask out RX STBC in the STA's HT caps 	 */
if|if
condition|(
operator|!
operator|(
name|hapd
operator|->
name|iconf
operator|->
name|ht_capab
operator|&
name|HT_CAP_INFO_RX_STBC_MASK
operator|)
condition|)
name|cap
operator|&=
operator|~
name|HT_CAP_INFO_TX_STBC
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|hapd
operator|->
name|iconf
operator|->
name|ht_capab
operator|&
name|HT_CAP_INFO_TX_STBC
operator|)
condition|)
name|cap
operator|&=
operator|~
name|HT_CAP_INFO_RX_STBC_MASK
expr_stmt|;
name|neg_ht_cap
operator|->
name|ht_capabilities_info
operator|=
name|host_to_le16
argument_list|(
name|cap
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd - WPA/RSN IE and KDE definitions  * Copyright (c) 2004-2008, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"eapol_auth/eapol_auth_sm.h"
end_include

begin_include
include|#
directive|include
file|"ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth.h"
end_include

begin_include
include|#
directive|include
file|"pmksa_cache_auth.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth_ie.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth_i.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_RSN_TESTING
end_ifdef

begin_decl_stmt
name|int
name|rsn_testing
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_RSN_TESTING */
end_comment

begin_function
specifier|static
name|int
name|wpa_write_wpa_ie
parameter_list|(
name|struct
name|wpa_auth_config
modifier|*
name|conf
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_ie_hdr
modifier|*
name|hdr
decl_stmt|;
name|int
name|num_suites
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|count
decl_stmt|;
name|u32
name|suite
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|wpa_ie_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|hdr
operator|->
name|elem_id
operator|=
name|WLAN_EID_VENDOR_SPECIFIC
expr_stmt|;
name|RSN_SELECTOR_PUT
argument_list|(
name|hdr
operator|->
name|oui
argument_list|,
name|WPA_OUI_TYPE
argument_list|)
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|hdr
operator|->
name|version
argument_list|,
name|WPA_VERSION
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
name|suite
operator|=
name|wpa_cipher_to_suite
argument_list|(
name|WPA_PROTO_WPA
argument_list|,
name|conf
operator|->
name|wpa_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|suite
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid group cipher (%d)."
argument_list|,
name|conf
operator|->
name|wpa_group
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|suite
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|WPA_SELECTOR_LEN
expr_stmt|;
name|count
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|num_suites
operator|=
name|wpa_cipher_put_suites
argument_list|(
name|pos
argument_list|,
name|conf
operator|->
name|wpa_pairwise
argument_list|)
expr_stmt|;
if|if
condition|(
name|num_suites
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid pairwise cipher (%d)."
argument_list|,
name|conf
operator|->
name|wpa_pairwise
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|+=
name|num_suites
operator|*
name|WPA_SELECTOR_LEN
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|count
argument_list|,
name|num_suites
argument_list|)
expr_stmt|;
name|num_suites
operator|=
literal|0
expr_stmt|;
name|count
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|WPA_AUTH_KEY_MGMT_UNSPEC_802_1X
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|WPA_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|WPA_AUTH_KEY_MGMT_PSK_OVER_802_1X
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|WPA_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|num_suites
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid key management type (%d)."
argument_list|,
name|conf
operator|->
name|wpa_key_mgmt
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|count
argument_list|,
name|num_suites
argument_list|)
expr_stmt|;
comment|/* WPA Capabilities; use defaults, so no need to include it */
name|hdr
operator|->
name|len
operator|=
operator|(
name|pos
operator|-
name|buf
operator|)
operator|-
literal|2
expr_stmt|;
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_function
name|int
name|wpa_write_rsn_ie
parameter_list|(
name|struct
name|wpa_auth_config
modifier|*
name|conf
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
specifier|const
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
name|struct
name|rsn_ie_hdr
modifier|*
name|hdr
decl_stmt|;
name|int
name|num_suites
decl_stmt|,
name|res
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|count
decl_stmt|;
name|u16
name|capab
decl_stmt|;
name|u32
name|suite
decl_stmt|;
name|hdr
operator|=
operator|(
expr|struct
name|rsn_ie_hdr
operator|*
operator|)
name|buf
expr_stmt|;
name|hdr
operator|->
name|elem_id
operator|=
name|WLAN_EID_RSN
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|hdr
operator|->
name|version
argument_list|,
name|RSN_VERSION
argument_list|)
expr_stmt|;
name|pos
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|hdr
operator|+
literal|1
operator|)
expr_stmt|;
name|suite
operator|=
name|wpa_cipher_to_suite
argument_list|(
name|WPA_PROTO_RSN
argument_list|,
name|conf
operator|->
name|wpa_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|suite
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid group cipher (%d)."
argument_list|,
name|conf
operator|->
name|wpa_group
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|suite
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|=
literal|0
expr_stmt|;
name|count
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_RSN_TESTING
if|if
condition|(
name|rsn_testing
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_SELECTOR
argument_list|(
literal|0x12
argument_list|,
literal|0x34
argument_list|,
literal|0x56
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_RSN_TESTING */
name|res
operator|=
name|rsn_cipher_put_suites
argument_list|(
name|pos
argument_list|,
name|conf
operator|->
name|rsn_pairwise
argument_list|)
expr_stmt|;
name|num_suites
operator|+=
name|res
expr_stmt|;
name|pos
operator|+=
name|res
operator|*
name|RSN_SELECTOR_LEN
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_RSN_TESTING
if|if
condition|(
name|rsn_testing
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_SELECTOR
argument_list|(
literal|0x12
argument_list|,
literal|0x34
argument_list|,
literal|0x56
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_RSN_TESTING */
if|if
condition|(
name|num_suites
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid pairwise cipher (%d)."
argument_list|,
name|conf
operator|->
name|rsn_pairwise
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|count
argument_list|,
name|num_suites
argument_list|)
expr_stmt|;
name|num_suites
operator|=
literal|0
expr_stmt|;
name|count
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_RSN_TESTING
if|if
condition|(
name|rsn_testing
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_SELECTOR
argument_list|(
literal|0x12
argument_list|,
literal|0x34
argument_list|,
literal|0x56
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_RSN_TESTING */
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_AUTH_KEY_MGMT_UNSPEC_802_1X
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_AUTH_KEY_MGMT_PSK_OVER_802_1X
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_IEEE8021X
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_AUTH_KEY_MGMT_FT_802_1X
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_PSK
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_AUTH_KEY_MGMT_FT_PSK
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_SHA256
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_AUTH_KEY_MGMT_802_1X_SHA256
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK_SHA256
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_AUTH_KEY_MGMT_PSK_SHA256
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_SAE
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_SAE
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_AUTH_KEY_MGMT_SAE
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|wpa_key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_SAE
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_AUTH_KEY_MGMT_FT_SAE
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_SAE */
ifdef|#
directive|ifdef
name|CONFIG_RSN_TESTING
if|if
condition|(
name|rsn_testing
condition|)
block|{
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_SELECTOR
argument_list|(
literal|0x12
argument_list|,
literal|0x34
argument_list|,
literal|0x56
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|num_suites
operator|++
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_RSN_TESTING */
if|if
condition|(
name|num_suites
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid key management type (%d)."
argument_list|,
name|conf
operator|->
name|wpa_key_mgmt
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|count
argument_list|,
name|num_suites
argument_list|)
expr_stmt|;
comment|/* RSN Capabilities */
name|capab
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|rsn_preauth
condition|)
name|capab
operator||=
name|WPA_CAPABILITY_PREAUTH
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|peerkey
condition|)
name|capab
operator||=
name|WPA_CAPABILITY_PEERKEY_ENABLED
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|wmm_enabled
condition|)
block|{
comment|/* 4 PTKSA replay counters when using WMM */
name|capab
operator||=
operator|(
name|RSN_NUM_REPLAY_COUNTERS_16
operator|<<
literal|2
operator|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|conf
operator|->
name|ieee80211w
operator|!=
name|NO_MGMT_FRAME_PROTECTION
condition|)
block|{
name|capab
operator||=
name|WPA_CAPABILITY_MFPC
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|ieee80211w
operator|==
name|MGMT_FRAME_PROTECTION_REQUIRED
condition|)
name|capab
operator||=
name|WPA_CAPABILITY_MFPR
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_RSN_TESTING
if|if
condition|(
name|rsn_testing
condition|)
name|capab
operator||=
name|BIT
argument_list|(
literal|8
argument_list|)
operator||
name|BIT
argument_list|(
literal|14
argument_list|)
operator||
name|BIT
argument_list|(
literal|15
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_RSN_TESTING */
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
name|capab
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pmkid
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|PMKID_LEN
operator|>
name|buf
operator|+
name|len
condition|)
return|return
operator|-
literal|1
return|;
comment|/* PMKID Count */
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|PMKID_LEN
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|conf
operator|->
name|ieee80211w
operator|!=
name|NO_MGMT_FRAME_PROTECTION
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
literal|4
operator|>
name|buf
operator|+
name|len
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|pmkid
operator|==
name|NULL
condition|)
block|{
comment|/* PMKID Count */
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
block|}
comment|/* Management Group Cipher Suite */
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_AES_128_CMAC
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_RSN_TESTING
if|if
condition|(
name|rsn_testing
condition|)
block|{
comment|/* 		 * Fill in any defined fields and add extra data to the end of 		 * the element. 		 */
name|int
name|pmkid_count_set
init|=
name|pmkid
operator|!=
name|NULL
decl_stmt|;
if|if
condition|(
name|conf
operator|->
name|ieee80211w
operator|!=
name|NO_MGMT_FRAME_PROTECTION
condition|)
name|pmkid_count_set
operator|=
literal|1
expr_stmt|;
comment|/* PMKID Count */
name|WPA_PUT_LE16
argument_list|(
name|pos
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|ieee80211w
operator|==
name|NO_MGMT_FRAME_PROTECTION
condition|)
block|{
comment|/* Management Group Cipher Suite */
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|RSN_CIPHER_SUITE_AES_128_CMAC
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
block|}
name|os_memset
argument_list|(
name|pos
argument_list|,
literal|0x12
argument_list|,
literal|17
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|17
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_RSN_TESTING */
name|hdr
operator|->
name|len
operator|=
operator|(
name|pos
operator|-
name|buf
operator|)
operator|-
literal|2
expr_stmt|;
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_function
name|int
name|wpa_auth_gen_wpa_ie
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|,
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|pos
operator|=
name|buf
expr_stmt|;
if|if
condition|(
name|wpa_auth
operator|->
name|conf
operator|.
name|wpa
operator|&
name|WPA_PROTO_RSN
condition|)
block|{
name|res
operator|=
name|wpa_write_rsn_ie
argument_list|(
operator|&
name|wpa_auth
operator|->
name|conf
argument_list|,
name|pos
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|pos
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
name|res
return|;
name|pos
operator|+=
name|res
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|wpa_key_mgmt_ft
argument_list|(
name|wpa_auth
operator|->
name|conf
operator|.
name|wpa_key_mgmt
argument_list|)
condition|)
block|{
name|res
operator|=
name|wpa_write_mdie
argument_list|(
operator|&
name|wpa_auth
operator|->
name|conf
argument_list|,
name|pos
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
name|res
return|;
name|pos
operator|+=
name|res
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
if|if
condition|(
name|wpa_auth
operator|->
name|conf
operator|.
name|wpa
operator|&
name|WPA_PROTO_WPA
condition|)
block|{
name|res
operator|=
name|wpa_write_wpa_ie
argument_list|(
operator|&
name|wpa_auth
operator|->
name|conf
argument_list|,
name|pos
argument_list|,
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
return|return
name|res
return|;
name|pos
operator|+=
name|res
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wpa_auth
operator|->
name|wpa_ie
argument_list|)
expr_stmt|;
name|wpa_auth
operator|->
name|wpa_ie
operator|=
name|os_malloc
argument_list|(
name|pos
operator|-
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_auth
operator|->
name|wpa_ie
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|wpa_auth
operator|->
name|wpa_ie
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|)
expr_stmt|;
name|wpa_auth
operator|->
name|wpa_ie_len
operator|=
name|pos
operator|-
name|buf
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|u8
modifier|*
name|wpa_add_kde
parameter_list|(
name|u8
modifier|*
name|pos
parameter_list|,
name|u32
name|kde
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|data2
parameter_list|,
name|size_t
name|data2_len
parameter_list|)
block|{
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_VENDOR_SPECIFIC
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|RSN_SELECTOR_LEN
operator|+
name|data_len
operator|+
name|data2_len
expr_stmt|;
name|RSN_SELECTOR_PUT
argument_list|(
name|pos
argument_list|,
name|kde
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|RSN_SELECTOR_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|data_len
expr_stmt|;
if|if
condition|(
name|data2
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|data2
argument_list|,
name|data2_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|data2_len
expr_stmt|;
block|}
return|return
name|pos
return|;
block|}
end_function

begin_struct
struct|struct
name|wpa_auth_okc_iter_data
block|{
name|struct
name|rsn_pmksa_cache_entry
modifier|*
name|pmksa
decl_stmt|;
specifier|const
name|u8
modifier|*
name|aa
decl_stmt|;
specifier|const
name|u8
modifier|*
name|spa
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pmkid
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wpa_auth_okc_iter
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|a
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_auth_okc_iter_data
modifier|*
name|data
init|=
name|ctx
decl_stmt|;
name|data
operator|->
name|pmksa
operator|=
name|pmksa_cache_get_okc
argument_list|(
name|a
operator|->
name|pmksa
argument_list|,
name|data
operator|->
name|aa
argument_list|,
name|data
operator|->
name|spa
argument_list|,
name|data
operator|->
name|pmkid
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|pmksa
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpa_validate_wpa_ie
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|wpa_ie
parameter_list|,
name|size_t
name|wpa_ie_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|mdie
parameter_list|,
name|size_t
name|mdie_len
parameter_list|)
block|{
name|struct
name|wpa_ie_data
name|data
decl_stmt|;
name|int
name|ciphers
decl_stmt|,
name|key_mgmt
decl_stmt|,
name|res
decl_stmt|,
name|version
decl_stmt|;
name|u32
name|selector
decl_stmt|;
name|size_t
name|i
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pmkid
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|wpa_auth
operator|==
name|NULL
operator|||
name|sm
operator|==
name|NULL
condition|)
return|return
name|WPA_NOT_ENABLED
return|;
if|if
condition|(
name|wpa_ie
operator|==
name|NULL
operator|||
name|wpa_ie_len
operator|<
literal|1
condition|)
return|return
name|WPA_INVALID_IE
return|;
if|if
condition|(
name|wpa_ie
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
condition|)
name|version
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
else|else
name|version
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|wpa_auth
operator|->
name|conf
operator|.
name|wpa
operator|&
name|version
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid WPA proto (%d) from "
name|MACSTR
argument_list|,
name|version
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|WPA_INVALID_PROTO
return|;
block|}
if|if
condition|(
name|version
operator|==
name|WPA_PROTO_RSN
condition|)
block|{
name|res
operator|=
name|wpa_parse_wpa_ie_rsn
argument_list|(
name|wpa_ie
argument_list|,
name|wpa_ie_len
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|selector
operator|=
name|RSN_AUTH_KEY_MGMT_UNSPEC_802_1X
expr_stmt|;
if|if
condition|(
literal|0
condition|)
block|{ 		}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
elseif|else
if|if
condition|(
name|data
operator|.
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_IEEE8021X
condition|)
name|selector
operator|=
name|RSN_AUTH_KEY_MGMT_FT_802_1X
expr_stmt|;
elseif|else
if|if
condition|(
name|data
operator|.
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_PSK
condition|)
name|selector
operator|=
name|RSN_AUTH_KEY_MGMT_FT_PSK
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
elseif|else
if|if
condition|(
name|data
operator|.
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_SHA256
condition|)
name|selector
operator|=
name|RSN_AUTH_KEY_MGMT_802_1X_SHA256
expr_stmt|;
elseif|else
if|if
condition|(
name|data
operator|.
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK_SHA256
condition|)
name|selector
operator|=
name|RSN_AUTH_KEY_MGMT_PSK_SHA256
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_SAE
elseif|else
if|if
condition|(
name|data
operator|.
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_SAE
condition|)
name|selector
operator|=
name|RSN_AUTH_KEY_MGMT_SAE
expr_stmt|;
elseif|else
if|if
condition|(
name|data
operator|.
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_SAE
condition|)
name|selector
operator|=
name|RSN_AUTH_KEY_MGMT_FT_SAE
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SAE */
elseif|else
if|if
condition|(
name|data
operator|.
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
name|selector
operator|=
name|RSN_AUTH_KEY_MGMT_UNSPEC_802_1X
expr_stmt|;
elseif|else
if|if
condition|(
name|data
operator|.
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
name|selector
operator|=
name|RSN_AUTH_KEY_MGMT_PSK_OVER_802_1X
expr_stmt|;
name|wpa_auth
operator|->
name|dot11RSNAAuthenticationSuiteSelected
operator|=
name|selector
expr_stmt|;
name|selector
operator|=
name|wpa_cipher_to_suite
argument_list|(
name|WPA_PROTO_RSN
argument_list|,
name|data
operator|.
name|pairwise_cipher
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|selector
condition|)
name|selector
operator|=
name|RSN_CIPHER_SUITE_CCMP
expr_stmt|;
name|wpa_auth
operator|->
name|dot11RSNAPairwiseCipherSelected
operator|=
name|selector
expr_stmt|;
name|selector
operator|=
name|wpa_cipher_to_suite
argument_list|(
name|WPA_PROTO_RSN
argument_list|,
name|data
operator|.
name|group_cipher
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|selector
condition|)
name|selector
operator|=
name|RSN_CIPHER_SUITE_CCMP
expr_stmt|;
name|wpa_auth
operator|->
name|dot11RSNAGroupCipherSelected
operator|=
name|selector
expr_stmt|;
block|}
else|else
block|{
name|res
operator|=
name|wpa_parse_wpa_ie_wpa
argument_list|(
name|wpa_ie
argument_list|,
name|wpa_ie_len
argument_list|,
operator|&
name|data
argument_list|)
expr_stmt|;
name|selector
operator|=
name|WPA_AUTH_KEY_MGMT_UNSPEC_802_1X
expr_stmt|;
if|if
condition|(
name|data
operator|.
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
name|selector
operator|=
name|WPA_AUTH_KEY_MGMT_UNSPEC_802_1X
expr_stmt|;
elseif|else
if|if
condition|(
name|data
operator|.
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
name|selector
operator|=
name|WPA_AUTH_KEY_MGMT_PSK_OVER_802_1X
expr_stmt|;
name|wpa_auth
operator|->
name|dot11RSNAAuthenticationSuiteSelected
operator|=
name|selector
expr_stmt|;
name|selector
operator|=
name|wpa_cipher_to_suite
argument_list|(
name|WPA_PROTO_WPA
argument_list|,
name|data
operator|.
name|pairwise_cipher
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|selector
condition|)
name|selector
operator|=
name|RSN_CIPHER_SUITE_TKIP
expr_stmt|;
name|wpa_auth
operator|->
name|dot11RSNAPairwiseCipherSelected
operator|=
name|selector
expr_stmt|;
name|selector
operator|=
name|wpa_cipher_to_suite
argument_list|(
name|WPA_PROTO_WPA
argument_list|,
name|data
operator|.
name|group_cipher
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|selector
condition|)
name|selector
operator|=
name|WPA_CIPHER_SUITE_TKIP
expr_stmt|;
name|wpa_auth
operator|->
name|dot11RSNAGroupCipherSelected
operator|=
name|selector
expr_stmt|;
block|}
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to parse WPA/RSN IE from "
name|MACSTR
literal|" (res=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|addr
argument_list|)
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA/RSN IE"
argument_list|,
name|wpa_ie
argument_list|,
name|wpa_ie_len
argument_list|)
expr_stmt|;
return|return
name|WPA_INVALID_IE
return|;
block|}
if|if
condition|(
name|data
operator|.
name|group_cipher
operator|!=
name|wpa_auth
operator|->
name|conf
operator|.
name|wpa_group
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid WPA group cipher (0x%x) from "
name|MACSTR
argument_list|,
name|data
operator|.
name|group_cipher
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|WPA_INVALID_GROUP
return|;
block|}
name|key_mgmt
operator|=
name|data
operator|.
name|key_mgmt
operator|&
name|wpa_auth
operator|->
name|conf
operator|.
name|wpa_key_mgmt
expr_stmt|;
if|if
condition|(
operator|!
name|key_mgmt
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid WPA key mgmt (0x%x) from "
name|MACSTR
argument_list|,
name|data
operator|.
name|key_mgmt
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|WPA_INVALID_AKMP
return|;
block|}
if|if
condition|(
literal|0
condition|)
block|{ 	}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
elseif|else
if|if
condition|(
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_IEEE8021X
condition|)
name|sm
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_FT_IEEE8021X
expr_stmt|;
elseif|else
if|if
condition|(
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_PSK
condition|)
name|sm
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_FT_PSK
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
elseif|else
if|if
condition|(
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_SHA256
condition|)
name|sm
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X_SHA256
expr_stmt|;
elseif|else
if|if
condition|(
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK_SHA256
condition|)
name|sm
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK_SHA256
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_SAE
elseif|else
if|if
condition|(
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_SAE
condition|)
name|sm
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_SAE
expr_stmt|;
elseif|else
if|if
condition|(
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_SAE
condition|)
name|sm
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_FT_SAE
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SAE */
elseif|else
if|if
condition|(
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
name|sm
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X
expr_stmt|;
else|else
name|sm
operator|->
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
if|if
condition|(
name|version
operator|==
name|WPA_PROTO_RSN
condition|)
name|ciphers
operator|=
name|data
operator|.
name|pairwise_cipher
operator|&
name|wpa_auth
operator|->
name|conf
operator|.
name|rsn_pairwise
expr_stmt|;
else|else
name|ciphers
operator|=
name|data
operator|.
name|pairwise_cipher
operator|&
name|wpa_auth
operator|->
name|conf
operator|.
name|wpa_pairwise
expr_stmt|;
if|if
condition|(
operator|!
name|ciphers
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid %s pairwise cipher (0x%x) "
literal|"from "
name|MACSTR
argument_list|,
name|version
operator|==
name|WPA_PROTO_RSN
condition|?
literal|"RSN"
else|:
literal|"WPA"
argument_list|,
name|data
operator|.
name|pairwise_cipher
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|WPA_INVALID_PAIRWISE
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|wpa_auth
operator|->
name|conf
operator|.
name|ieee80211w
operator|==
name|MGMT_FRAME_PROTECTION_REQUIRED
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|data
operator|.
name|capabilities
operator|&
name|WPA_CAPABILITY_MFPC
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Management frame protection "
literal|"required, but client did not enable it"
argument_list|)
expr_stmt|;
return|return
name|WPA_MGMT_FRAME_PROTECTION_VIOLATION
return|;
block|}
if|if
condition|(
name|ciphers
operator|&
name|WPA_CIPHER_TKIP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Management frame protection "
literal|"cannot use TKIP"
argument_list|)
expr_stmt|;
return|return
name|WPA_MGMT_FRAME_PROTECTION_VIOLATION
return|;
block|}
if|if
condition|(
name|data
operator|.
name|mgmt_group_cipher
operator|!=
name|WPA_CIPHER_AES_128_CMAC
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unsupported management group "
literal|"cipher %d"
argument_list|,
name|data
operator|.
name|mgmt_group_cipher
argument_list|)
expr_stmt|;
return|return
name|WPA_INVALID_MGMT_GROUP_CIPHER
return|;
block|}
block|}
if|if
condition|(
name|wpa_auth
operator|->
name|conf
operator|.
name|ieee80211w
operator|==
name|NO_MGMT_FRAME_PROTECTION
operator|||
operator|!
operator|(
name|data
operator|.
name|capabilities
operator|&
name|WPA_CAPABILITY_MFPC
operator|)
condition|)
name|sm
operator|->
name|mgmt_frame_prot
operator|=
literal|0
expr_stmt|;
else|else
name|sm
operator|->
name|mgmt_frame_prot
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|wpa_key_mgmt_ft
argument_list|(
name|sm
operator|->
name|wpa_key_mgmt
argument_list|)
condition|)
block|{
if|if
condition|(
name|mdie
operator|==
name|NULL
operator|||
name|mdie_len
operator|<
name|MOBILITY_DOMAIN_ID_LEN
operator|+
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Trying to use FT, but "
literal|"MDIE not included"
argument_list|)
expr_stmt|;
return|return
name|WPA_INVALID_MDIE
return|;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|mdie
argument_list|,
name|wpa_auth
operator|->
name|conf
operator|.
name|mobility_domain
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Attempted to use unknown "
literal|"MDIE"
argument_list|,
name|mdie
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
expr_stmt|;
return|return
name|WPA_INVALID_MDIE
return|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
if|if
condition|(
name|ciphers
operator|&
name|WPA_CIPHER_CCMP
condition|)
name|sm
operator|->
name|pairwise
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
elseif|else
if|if
condition|(
name|ciphers
operator|&
name|WPA_CIPHER_GCMP
condition|)
name|sm
operator|->
name|pairwise
operator|=
name|WPA_CIPHER_GCMP
expr_stmt|;
else|else
name|sm
operator|->
name|pairwise
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
comment|/* TODO: clear WPA/WPA2 state if STA changes from one to another */
if|if
condition|(
name|wpa_ie
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
condition|)
name|sm
operator|->
name|wpa
operator|=
name|WPA_VERSION_WPA2
expr_stmt|;
else|else
name|sm
operator|->
name|wpa
operator|=
name|WPA_VERSION_WPA
expr_stmt|;
name|sm
operator|->
name|pmksa
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|data
operator|.
name|num_pmkid
condition|;
name|i
operator|++
control|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN IE: STA PMKID"
argument_list|,
operator|&
name|data
operator|.
name|pmkid
index|[
name|i
operator|*
name|PMKID_LEN
index|]
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
name|sm
operator|->
name|pmksa
operator|=
name|pmksa_cache_auth_get
argument_list|(
name|wpa_auth
operator|->
name|pmksa
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
operator|&
name|data
operator|.
name|pmkid
index|[
name|i
operator|*
name|PMKID_LEN
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|pmksa
condition|)
block|{
name|pmkid
operator|=
name|sm
operator|->
name|pmksa
operator|->
name|pmkid
expr_stmt|;
break|break;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|sm
operator|->
name|pmksa
operator|==
name|NULL
operator|&&
name|wpa_auth
operator|->
name|conf
operator|.
name|okc
operator|&&
name|i
operator|<
name|data
operator|.
name|num_pmkid
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_auth_okc_iter_data
name|idata
decl_stmt|;
name|idata
operator|.
name|pmksa
operator|=
name|NULL
expr_stmt|;
name|idata
operator|.
name|aa
operator|=
name|wpa_auth
operator|->
name|addr
expr_stmt|;
name|idata
operator|.
name|spa
operator|=
name|sm
operator|->
name|addr
expr_stmt|;
name|idata
operator|.
name|pmkid
operator|=
operator|&
name|data
operator|.
name|pmkid
index|[
name|i
operator|*
name|PMKID_LEN
index|]
expr_stmt|;
name|wpa_auth_for_each_auth
argument_list|(
name|wpa_auth
argument_list|,
name|wpa_auth_okc_iter
argument_list|,
operator|&
name|idata
argument_list|)
expr_stmt|;
if|if
condition|(
name|idata
operator|.
name|pmksa
condition|)
block|{
name|wpa_auth_vlogger
argument_list|(
name|wpa_auth
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|LOGGER_DEBUG
argument_list|,
literal|"OKC match for PMKID"
argument_list|)
expr_stmt|;
name|sm
operator|->
name|pmksa
operator|=
name|pmksa_cache_add_okc
argument_list|(
name|wpa_auth
operator|->
name|pmksa
argument_list|,
name|idata
operator|.
name|pmksa
argument_list|,
name|wpa_auth
operator|->
name|addr
argument_list|,
name|idata
operator|.
name|pmkid
argument_list|)
expr_stmt|;
name|pmkid
operator|=
name|idata
operator|.
name|pmkid
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|sm
operator|->
name|pmksa
condition|)
block|{
name|wpa_auth_vlogger
argument_list|(
name|wpa_auth
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|LOGGER_DEBUG
argument_list|,
literal|"PMKID found from PMKSA cache "
literal|"eap_type=%d vlan_id=%d"
argument_list|,
name|sm
operator|->
name|pmksa
operator|->
name|eap_type_authsrv
argument_list|,
name|sm
operator|->
name|pmksa
operator|->
name|vlan_id
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_auth
operator|->
name|dot11RSNAPMKIDUsed
argument_list|,
name|pmkid
argument_list|,
name|PMKID_LEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sm
operator|->
name|wpa_ie
operator|==
name|NULL
operator|||
name|sm
operator|->
name|wpa_ie_len
operator|<
name|wpa_ie_len
condition|)
block|{
name|os_free
argument_list|(
name|sm
operator|->
name|wpa_ie
argument_list|)
expr_stmt|;
name|sm
operator|->
name|wpa_ie
operator|=
name|os_malloc
argument_list|(
name|wpa_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|sm
operator|->
name|wpa_ie
operator|==
name|NULL
condition|)
return|return
name|WPA_ALLOC_FAIL
return|;
block|}
name|os_memcpy
argument_list|(
name|sm
operator|->
name|wpa_ie
argument_list|,
name|wpa_ie
argument_list|,
name|wpa_ie_len
argument_list|)
expr_stmt|;
name|sm
operator|->
name|wpa_ie_len
operator|=
name|wpa_ie_len
expr_stmt|;
return|return
name|WPA_IE_OK
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_parse_generic - Parse EAPOL-Key Key Data Generic IEs  * @pos: Pointer to the IE header  * @end: Pointer to the end of the Key Data buffer  * @ie: Pointer to parsed IE data  * Returns: 0 on success, 1 if end mark is found, -1 on failure  */
end_comment

begin_function
specifier|static
name|int
name|wpa_parse_generic
parameter_list|(
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|,
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|ie
parameter_list|)
block|{
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|==
literal|0
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|>=
literal|6
operator|&&
name|RSN_SELECTOR_GET
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
operator|==
name|WPA_OUI_TYPE
operator|&&
name|pos
index|[
literal|2
operator|+
name|WPA_SELECTOR_LEN
index|]
operator|==
literal|1
operator|&&
name|pos
index|[
literal|2
operator|+
name|WPA_SELECTOR_LEN
operator|+
literal|1
index|]
operator|==
literal|0
condition|)
block|{
name|ie
operator|->
name|wpa_ie
operator|=
name|pos
expr_stmt|;
name|ie
operator|->
name|wpa_ie_len
operator|=
name|pos
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|pos
operator|+
literal|1
operator|+
name|RSN_SELECTOR_LEN
operator|<
name|end
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
name|RSN_SELECTOR_LEN
operator|+
name|PMKID_LEN
operator|&&
name|RSN_SELECTOR_GET
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
operator|==
name|RSN_KEY_DATA_PMKID
condition|)
block|{
name|ie
operator|->
name|pmkid
operator|=
name|pos
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|>
name|RSN_SELECTOR_LEN
operator|+
literal|2
operator|&&
name|RSN_SELECTOR_GET
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
operator|==
name|RSN_KEY_DATA_GROUPKEY
condition|)
block|{
name|ie
operator|->
name|gtk
operator|=
name|pos
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
expr_stmt|;
name|ie
operator|->
name|gtk_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
name|RSN_SELECTOR_LEN
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|>
name|RSN_SELECTOR_LEN
operator|+
literal|2
operator|&&
name|RSN_SELECTOR_GET
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
operator|==
name|RSN_KEY_DATA_MAC_ADDR
condition|)
block|{
name|ie
operator|->
name|mac_addr
operator|=
name|pos
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
expr_stmt|;
name|ie
operator|->
name|mac_addr_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
name|RSN_SELECTOR_LEN
expr_stmt|;
return|return
literal|0
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_PEERKEY
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|>
name|RSN_SELECTOR_LEN
operator|+
literal|2
operator|&&
name|RSN_SELECTOR_GET
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
operator|==
name|RSN_KEY_DATA_SMK
condition|)
block|{
name|ie
operator|->
name|smk
operator|=
name|pos
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
expr_stmt|;
name|ie
operator|->
name|smk_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
name|RSN_SELECTOR_LEN
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|>
name|RSN_SELECTOR_LEN
operator|+
literal|2
operator|&&
name|RSN_SELECTOR_GET
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
operator|==
name|RSN_KEY_DATA_NONCE
condition|)
block|{
name|ie
operator|->
name|nonce
operator|=
name|pos
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
expr_stmt|;
name|ie
operator|->
name|nonce_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
name|RSN_SELECTOR_LEN
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|>
name|RSN_SELECTOR_LEN
operator|+
literal|2
operator|&&
name|RSN_SELECTOR_GET
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
operator|==
name|RSN_KEY_DATA_LIFETIME
condition|)
block|{
name|ie
operator|->
name|lifetime
operator|=
name|pos
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
expr_stmt|;
name|ie
operator|->
name|lifetime_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
name|RSN_SELECTOR_LEN
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|>
name|RSN_SELECTOR_LEN
operator|+
literal|2
operator|&&
name|RSN_SELECTOR_GET
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
operator|==
name|RSN_KEY_DATA_ERROR
condition|)
block|{
name|ie
operator|->
name|error
operator|=
name|pos
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
expr_stmt|;
name|ie
operator|->
name|error_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
name|RSN_SELECTOR_LEN
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_PEERKEY */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
name|pos
index|[
literal|1
index|]
operator|>
name|RSN_SELECTOR_LEN
operator|+
literal|2
operator|&&
name|RSN_SELECTOR_GET
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
operator|==
name|RSN_KEY_DATA_IGTK
condition|)
block|{
name|ie
operator|->
name|igtk
operator|=
name|pos
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
expr_stmt|;
name|ie
operator|->
name|igtk_len
operator|=
name|pos
index|[
literal|1
index|]
operator|-
name|RSN_SELECTOR_LEN
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_parse_kde_ies - Parse EAPOL-Key Key Data IEs  * @buf: Pointer to the Key Data buffer  * @len: Key Data Length  * @ie: Pointer to parsed IE data  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|wpa_parse_kde_ies
parameter_list|(
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|ie
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|os_memset
argument_list|(
name|ie
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ie
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|pos
operator|=
name|buf
operator|,
name|end
operator|=
name|pos
operator|+
name|len
init|;
name|pos
operator|+
literal|1
operator|<
name|end
condition|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
control|)
block|{
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
literal|0xdd
operator|&&
operator|(
operator|(
name|pos
operator|==
name|buf
operator|+
name|len
operator|-
literal|1
operator|)
operator|||
name|pos
index|[
literal|1
index|]
operator|==
literal|0
operator|)
condition|)
block|{
comment|/* Ignore padding */
break|break;
block|}
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: EAPOL-Key Key Data "
literal|"underflow (ie=%d len=%d pos=%d)"
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|,
name|pos
index|[
literal|1
index|]
argument_list|,
call|(
name|int
call|)
argument_list|(
name|pos
operator|-
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Key Data"
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|*
name|pos
operator|==
name|WLAN_EID_RSN
condition|)
block|{
name|ie
operator|->
name|rsn_ie
operator|=
name|pos
expr_stmt|;
name|ie
operator|->
name|rsn_ie_len
operator|=
name|pos
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
block|}
elseif|else
if|if
condition|(
operator|*
name|pos
operator|==
name|WLAN_EID_MOBILITY_DOMAIN
condition|)
block|{
name|ie
operator|->
name|mdie
operator|=
name|pos
expr_stmt|;
name|ie
operator|->
name|mdie_len
operator|=
name|pos
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|*
name|pos
operator|==
name|WLAN_EID_FAST_BSS_TRANSITION
condition|)
block|{
name|ie
operator|->
name|ftie
operator|=
name|pos
expr_stmt|;
name|ie
operator|->
name|ftie_len
operator|=
name|pos
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
block|}
elseif|else
if|if
condition|(
operator|*
name|pos
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
condition|)
block|{
name|ret
operator|=
name|wpa_parse_generic
argument_list|(
name|pos
argument_list|,
name|end
argument_list|,
name|ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
break|break;
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Unrecognized EAPOL-Key "
literal|"Key Data IE"
argument_list|,
name|pos
argument_list|,
literal|2
operator|+
name|pos
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpa_auth_uses_mfp
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|)
block|{
return|return
name|sm
condition|?
name|sm
operator|->
name|mgmt_frame_prot
else|:
literal|0
return|;
block|}
end_function

end_unit


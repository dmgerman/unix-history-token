begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * hostapd - PeerKey for Direct Link Setup (DLS)  * Copyright (c) 2006-2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha1.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth_i.h"
end_include

begin_include
include|#
directive|include
file|"wpa_auth_ie.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_PEERKEY
end_ifdef

begin_function
specifier|static
name|void
name|wpa_stsl_step
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
if|#
directive|if
literal|0
block|struct wpa_authenticator *wpa_auth = eloop_ctx; 	struct wpa_stsl_negotiation *neg = timeout_ctx;
endif|#
directive|endif
comment|/* TODO: ? */
block|}
end_function

begin_struct
struct|struct
name|wpa_stsl_search
block|{
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
name|struct
name|wpa_state_machine
modifier|*
name|sm
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wpa_stsl_select_sta
parameter_list|(
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_stsl_search
modifier|*
name|search
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|search
operator|->
name|addr
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|search
operator|->
name|sm
operator|=
name|sm
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_smk_send_error
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|u16
name|mui
parameter_list|,
name|u16
name|error_type
parameter_list|)
block|{
name|u8
name|kde
index|[
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|ETH_ALEN
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|rsn_error_kde
argument_list|)
index|]
decl_stmt|;
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|rsn_error_kde
name|error
decl_stmt|;
name|wpa_auth_logger
argument_list|(
name|wpa_auth
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|LOGGER_DEBUG
argument_list|,
literal|"Sending SMK Error"
argument_list|)
expr_stmt|;
name|pos
operator|=
name|kde
expr_stmt|;
if|if
condition|(
name|peer
condition|)
block|{
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_MAC_ADDR
argument_list|,
name|peer
argument_list|,
name|ETH_ALEN
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|error
operator|.
name|mui
operator|=
name|host_to_be16
argument_list|(
name|mui
argument_list|)
expr_stmt|;
name|error
operator|.
name|error_type
operator|=
name|host_to_be16
argument_list|(
name|error_type
argument_list|)
expr_stmt|;
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_ERROR
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|error
argument_list|,
sizeof|sizeof
argument_list|(
name|error
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|__wpa_send_eapol
argument_list|(
name|wpa_auth
argument_list|,
name|sm
argument_list|,
name|WPA_KEY_INFO_SECURE
operator||
name|WPA_KEY_INFO_MIC
operator||
name|WPA_KEY_INFO_SMK_MESSAGE
operator||
name|WPA_KEY_INFO_ERROR
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|kde
argument_list|,
name|pos
operator|-
name|kde
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_smk_m1
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|)
block|{
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
name|struct
name|wpa_stsl_search
name|search
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
if|if
condition|(
name|wpa_parse_kde_ies
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|key
operator|+
literal|1
operator|)
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|key
operator|->
name|key_data_length
argument_list|)
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Failed to parse KDEs in SMK M1"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|kde
operator|.
name|rsn_ie
operator|==
name|NULL
operator|||
name|kde
operator|.
name|mac_addr
operator|==
name|NULL
operator|||
name|kde
operator|.
name|mac_addr_len
operator|<
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: No RSN IE or MAC address KDE in "
literal|"SMK M1"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Initiator = sm->addr; Peer = kde.mac_addr */
name|search
operator|.
name|addr
operator|=
name|kde
operator|.
name|mac_addr
expr_stmt|;
name|search
operator|.
name|sm
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|wpa_auth_for_each_sta
argument_list|(
name|wpa_auth
argument_list|,
name|wpa_stsl_select_sta
argument_list|,
operator|&
name|search
argument_list|)
operator|==
literal|0
operator|||
name|search
operator|.
name|sm
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: SMK handshake with "
name|MACSTR
literal|" aborted - STA not associated anymore"
argument_list|,
name|MAC2STR
argument_list|(
name|kde
operator|.
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_smk_send_error
argument_list|(
name|wpa_auth
argument_list|,
name|sm
argument_list|,
name|kde
operator|.
name|mac_addr
argument_list|,
name|STK_MUI_SMK
argument_list|,
name|STK_ERR_STA_NR
argument_list|)
expr_stmt|;
comment|/* FIX: wpa_stsl_remove(wpa_auth, neg); */
return|return;
block|}
name|buf_len
operator|=
name|kde
operator|.
name|rsn_ie_len
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|ETH_ALEN
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
comment|/* Initiator RSN IE */
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|kde
operator|.
name|rsn_ie
argument_list|,
name|kde
operator|.
name|rsn_ie_len
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
name|kde
operator|.
name|rsn_ie_len
expr_stmt|;
comment|/* Initiator MAC Address */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_MAC_ADDR
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* SMK M2: 	 * EAPOL-Key(S=1, M=1, A=1, I=0, K=0, SM=1, KeyRSC=0, Nonce=INonce, 	 *           MIC=MIC, DataKDs=(RSNIE_I, MAC_I KDE) 	 */
name|wpa_auth_logger
argument_list|(
name|wpa_auth
argument_list|,
name|search
operator|.
name|sm
operator|->
name|addr
argument_list|,
name|LOGGER_DEBUG
argument_list|,
literal|"Sending SMK M2"
argument_list|)
expr_stmt|;
name|__wpa_send_eapol
argument_list|(
name|wpa_auth
argument_list|,
name|search
operator|.
name|sm
argument_list|,
name|WPA_KEY_INFO_SECURE
operator||
name|WPA_KEY_INFO_MIC
operator||
name|WPA_KEY_INFO_ACK
operator||
name|WPA_KEY_INFO_SMK_MESSAGE
argument_list|,
name|NULL
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_send_smk_m4
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|,
specifier|const
name|u8
modifier|*
name|smk
parameter_list|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|u32
name|lifetime
decl_stmt|;
comment|/* SMK M4: 	 * EAPOL-Key(S=1, M=1, A=0, I=1, K=0, SM=1, KeyRSC=0, Nonce=PNonce, 	 *           MIC=MIC, DataKDs=(MAC_I KDE, INonce KDE, SMK KDE, 	 *           Lifetime KDE) 	 */
name|buf_len
operator|=
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|ETH_ALEN
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|WPA_NONCE_LEN
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|PMK_LEN
operator|+
name|WPA_NONCE_LEN
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
sizeof|sizeof
argument_list|(
name|lifetime
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
operator|=
name|os_malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
comment|/* Initiator MAC Address */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_MAC_ADDR
argument_list|,
name|kde
operator|->
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Initiator Nonce */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_NONCE
argument_list|,
name|kde
operator|->
name|nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* SMK with PNonce */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_SMK
argument_list|,
name|smk
argument_list|,
name|PMK_LEN
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
comment|/* Lifetime */
name|lifetime
operator|=
name|htonl
argument_list|(
literal|43200
argument_list|)
expr_stmt|;
comment|/* dot11RSNAConfigSMKLifetime */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_LIFETIME
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|lifetime
argument_list|,
sizeof|sizeof
argument_list|(
name|lifetime
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_auth_logger
argument_list|(
name|sm
operator|->
name|wpa_auth
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|LOGGER_DEBUG
argument_list|,
literal|"Sending SMK M4"
argument_list|)
expr_stmt|;
name|__wpa_send_eapol
argument_list|(
name|wpa_auth
argument_list|,
name|sm
argument_list|,
name|WPA_KEY_INFO_SECURE
operator||
name|WPA_KEY_INFO_MIC
operator||
name|WPA_KEY_INFO_INSTALL
operator||
name|WPA_KEY_INFO_SMK_MESSAGE
argument_list|,
name|NULL
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_send_smk_m5
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|,
name|struct
name|wpa_eapol_ie_parse
modifier|*
name|kde
parameter_list|,
specifier|const
name|u8
modifier|*
name|smk
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|)
block|{
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|u32
name|lifetime
decl_stmt|;
comment|/* SMK M5: 	 * EAPOL-Key(S=1, M=1, A=0, I=0, K=0, SM=1, KeyRSC=0, Nonce=INonce, 	 *           MIC=MIC, DataKDs=(RSNIE_P, MAC_P KDE, PNonce, SMK KDE, 	 *                             Lifetime KDE)) 	 */
name|buf_len
operator|=
name|kde
operator|->
name|rsn_ie_len
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|ETH_ALEN
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|WPA_NONCE_LEN
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
name|PMK_LEN
operator|+
name|WPA_NONCE_LEN
operator|+
literal|2
operator|+
name|RSN_SELECTOR_LEN
operator|+
sizeof|sizeof
argument_list|(
name|lifetime
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
operator|=
name|os_malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
comment|/* Peer RSN IE */
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|kde
operator|->
name|rsn_ie
argument_list|,
name|kde
operator|->
name|rsn_ie_len
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
name|kde
operator|->
name|rsn_ie_len
expr_stmt|;
comment|/* Peer MAC Address */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_MAC_ADDR
argument_list|,
name|peer
argument_list|,
name|ETH_ALEN
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* PNonce */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_NONCE
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* SMK and INonce */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_SMK
argument_list|,
name|smk
argument_list|,
name|PMK_LEN
argument_list|,
name|kde
operator|->
name|nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
comment|/* Lifetime */
name|lifetime
operator|=
name|htonl
argument_list|(
literal|43200
argument_list|)
expr_stmt|;
comment|/* dot11RSNAConfigSMKLifetime */
name|pos
operator|=
name|wpa_add_kde
argument_list|(
name|pos
argument_list|,
name|RSN_KEY_DATA_LIFETIME
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|&
name|lifetime
argument_list|,
sizeof|sizeof
argument_list|(
name|lifetime
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_auth_logger
argument_list|(
name|sm
operator|->
name|wpa_auth
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|LOGGER_DEBUG
argument_list|,
literal|"Sending SMK M5"
argument_list|)
expr_stmt|;
name|__wpa_send_eapol
argument_list|(
name|wpa_auth
argument_list|,
name|sm
argument_list|,
name|WPA_KEY_INFO_SECURE
operator||
name|WPA_KEY_INFO_MIC
operator||
name|WPA_KEY_INFO_SMK_MESSAGE
argument_list|,
name|NULL
argument_list|,
name|kde
operator|->
name|nonce
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_smk_m3
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|)
block|{
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
name|struct
name|wpa_stsl_search
name|search
decl_stmt|;
name|u8
name|smk
index|[
literal|32
index|]
decl_stmt|,
name|buf
index|[
name|ETH_ALEN
operator|+
literal|8
operator|+
literal|2
operator|*
name|WPA_NONCE_LEN
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|wpa_parse_kde_ies
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|key
operator|+
literal|1
operator|)
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|key
operator|->
name|key_data_length
argument_list|)
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Failed to parse KDEs in SMK M3"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|kde
operator|.
name|rsn_ie
operator|==
name|NULL
operator|||
name|kde
operator|.
name|mac_addr
operator|==
name|NULL
operator|||
name|kde
operator|.
name|mac_addr_len
operator|<
name|ETH_ALEN
operator|||
name|kde
operator|.
name|nonce
operator|==
name|NULL
operator|||
name|kde
operator|.
name|nonce_len
operator|<
name|WPA_NONCE_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: No RSN IE, MAC address KDE, or "
literal|"Nonce KDE in SMK M3"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Peer = sm->addr; Initiator = kde.mac_addr; 	 * Peer Nonce = key->key_nonce; Initiator Nonce = kde.nonce */
name|search
operator|.
name|addr
operator|=
name|kde
operator|.
name|mac_addr
expr_stmt|;
name|search
operator|.
name|sm
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|wpa_auth_for_each_sta
argument_list|(
name|wpa_auth
argument_list|,
name|wpa_stsl_select_sta
argument_list|,
operator|&
name|search
argument_list|)
operator|==
literal|0
operator|||
name|search
operator|.
name|sm
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: SMK handshake with "
name|MACSTR
literal|" aborted - STA not associated anymore"
argument_list|,
name|MAC2STR
argument_list|(
name|kde
operator|.
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_smk_send_error
argument_list|(
name|wpa_auth
argument_list|,
name|sm
argument_list|,
name|kde
operator|.
name|mac_addr
argument_list|,
name|STK_MUI_SMK
argument_list|,
name|STK_ERR_STA_NR
argument_list|)
expr_stmt|;
comment|/* FIX: wpa_stsl_remove(wpa_auth, neg); */
return|return;
block|}
if|if
condition|(
name|random_get_bytes
argument_list|(
name|smk
argument_list|,
name|PMK_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Failed to generate SMK"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* SMK = PRF-256(Random number, "SMK Derivation", 	 *               AA || Time || INonce || PNonce) 	 */
name|os_memcpy
argument_list|(
name|buf
argument_list|,
name|wpa_auth
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|=
name|buf
operator|+
name|ETH_ALEN
expr_stmt|;
name|wpa_get_ntp_timestamp
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|8
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|kde
operator|.
name|nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|WPA_NONCE_LEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|key
operator|->
name|key_nonce
argument_list|,
name|WPA_NONCE_LEN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|sha256_prf
argument_list|(
name|smk
argument_list|,
name|PMK_LEN
argument_list|,
literal|"SMK Derivation"
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|smk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* CONFIG_IEEE80211W */
name|sha1_prf
argument_list|(
name|smk
argument_list|,
name|PMK_LEN
argument_list|,
literal|"SMK Derivation"
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|smk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: SMK"
argument_list|,
name|smk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
name|wpa_send_smk_m4
argument_list|(
name|wpa_auth
argument_list|,
name|sm
argument_list|,
name|key
argument_list|,
operator|&
name|kde
argument_list|,
name|smk
argument_list|)
expr_stmt|;
name|wpa_send_smk_m5
argument_list|(
name|wpa_auth
argument_list|,
name|search
operator|.
name|sm
argument_list|,
name|key
argument_list|,
operator|&
name|kde
argument_list|,
name|smk
argument_list|,
name|sm
operator|->
name|addr
argument_list|)
expr_stmt|;
comment|/* Authenticator does not need SMK anymore and it is required to forget 	 * it. */
name|os_memset
argument_list|(
name|smk
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|smk
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_smk_error
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
name|struct
name|wpa_state_machine
modifier|*
name|sm
parameter_list|,
name|struct
name|wpa_eapol_key
modifier|*
name|key
parameter_list|)
block|{
name|struct
name|wpa_eapol_ie_parse
name|kde
decl_stmt|;
name|struct
name|wpa_stsl_search
name|search
decl_stmt|;
name|struct
name|rsn_error_kde
name|error
decl_stmt|;
name|u16
name|mui
decl_stmt|,
name|error_type
decl_stmt|;
if|if
condition|(
name|wpa_parse_kde_ies
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|key
operator|+
literal|1
operator|)
argument_list|,
name|WPA_GET_BE16
argument_list|(
name|key
operator|->
name|key_data_length
argument_list|)
argument_list|,
operator|&
name|kde
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: Failed to parse KDEs in SMK Error"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|kde
operator|.
name|mac_addr
operator|==
name|NULL
operator|||
name|kde
operator|.
name|mac_addr_len
operator|<
name|ETH_ALEN
operator|||
name|kde
operator|.
name|error
operator|==
name|NULL
operator|||
name|kde
operator|.
name|error_len
operator|<
sizeof|sizeof
argument_list|(
name|error
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"RSN: No MAC address or Error KDE in "
literal|"SMK Error"
argument_list|)
expr_stmt|;
return|return;
block|}
name|search
operator|.
name|addr
operator|=
name|kde
operator|.
name|mac_addr
expr_stmt|;
name|search
operator|.
name|sm
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|wpa_auth_for_each_sta
argument_list|(
name|wpa_auth
argument_list|,
name|wpa_stsl_select_sta
argument_list|,
operator|&
name|search
argument_list|)
operator|==
literal|0
operator|||
name|search
operator|.
name|sm
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RSN: Peer STA "
name|MACSTR
literal|" not "
literal|"associated for SMK Error message from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|kde
operator|.
name|mac_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|sm
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
operator|&
name|error
argument_list|,
name|kde
operator|.
name|error
argument_list|,
sizeof|sizeof
argument_list|(
name|error
argument_list|)
argument_list|)
expr_stmt|;
name|mui
operator|=
name|be_to_host16
argument_list|(
name|error
operator|.
name|mui
argument_list|)
expr_stmt|;
name|error_type
operator|=
name|be_to_host16
argument_list|(
name|error
operator|.
name|error_type
argument_list|)
expr_stmt|;
name|wpa_auth_vlogger
argument_list|(
name|wpa_auth
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|LOGGER_INFO
argument_list|,
literal|"STA reported SMK Error: Peer "
name|MACSTR
literal|" MUI %d Error Type %d"
argument_list|,
name|MAC2STR
argument_list|(
name|kde
operator|.
name|mac_addr
argument_list|)
argument_list|,
name|mui
argument_list|,
name|error_type
argument_list|)
expr_stmt|;
name|wpa_smk_send_error
argument_list|(
name|wpa_auth
argument_list|,
name|search
operator|.
name|sm
argument_list|,
name|sm
operator|->
name|addr
argument_list|,
name|mui
argument_list|,
name|error_type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpa_stsl_remove
parameter_list|(
name|struct
name|wpa_authenticator
modifier|*
name|wpa_auth
parameter_list|,
name|struct
name|wpa_stsl_negotiation
modifier|*
name|neg
parameter_list|)
block|{
name|struct
name|wpa_stsl_negotiation
modifier|*
name|pos
decl_stmt|,
modifier|*
name|prev
decl_stmt|;
if|if
condition|(
name|wpa_auth
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|wpa_auth
operator|->
name|stsl_negotiations
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
name|pos
condition|)
block|{
if|if
condition|(
name|pos
operator|==
name|neg
condition|)
block|{
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|pos
operator|->
name|next
expr_stmt|;
else|else
name|wpa_auth
operator|->
name|stsl_negotiations
operator|=
name|pos
operator|->
name|next
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_stsl_step
argument_list|,
name|wpa_auth
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pos
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|prev
operator|=
name|pos
expr_stmt|;
name|pos
operator|=
name|pos
operator|->
name|next
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_PEERKEY */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * BSS table  * Copyright (c) 2009-2015, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_comment
comment|/**  * WPA_BSS_EXPIRATION_PERIOD - Period of expiration run in seconds  */
end_comment

begin_define
define|#
directive|define
name|WPA_BSS_EXPIRATION_PERIOD
value|10
end_define

begin_define
define|#
directive|define
name|WPA_BSS_FREQ_CHANGED_FLAG
value|BIT(0)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_SIGNAL_CHANGED_FLAG
value|BIT(1)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_PRIVACY_CHANGED_FLAG
value|BIT(2)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_MODE_CHANGED_FLAG
value|BIT(3)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_WPAIE_CHANGED_FLAG
value|BIT(4)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_RSNIE_CHANGED_FLAG
value|BIT(5)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_WPS_CHANGED_FLAG
value|BIT(6)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_RATES_CHANGED_FLAG
value|BIT(7)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_IES_CHANGED_FLAG
value|BIT(8)
end_define

begin_function
specifier|static
name|void
name|wpa_bss_set_hessid
parameter_list|(
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
specifier|const
name|u8
modifier|*
name|ie
init|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_INTERWORKING
argument_list|)
decl_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
operator|||
operator|(
name|ie
index|[
literal|1
index|]
operator|!=
literal|7
operator|&&
name|ie
index|[
literal|1
index|]
operator|!=
literal|9
operator|)
condition|)
block|{
name|os_memset
argument_list|(
name|bss
operator|->
name|hessid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ie
index|[
literal|1
index|]
operator|==
literal|7
condition|)
name|os_memcpy
argument_list|(
name|bss
operator|->
name|hessid
argument_list|,
name|ie
operator|+
literal|3
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|os_memcpy
argument_list|(
name|bss
operator|->
name|hessid
argument_list|,
name|ie
operator|+
literal|5
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
block|}
end_function

begin_comment
comment|/**  * wpa_bss_anqp_alloc - Allocate ANQP data structure for a BSS entry  * Returns: Allocated ANQP data structure or %NULL on failure  *  * The allocated ANQP data structure has its users count set to 1. It may be  * shared by multiple BSS entries and each shared entry is freed with  * wpa_bss_anqp_free().  */
end_comment

begin_function
name|struct
name|wpa_bss_anqp
modifier|*
name|wpa_bss_anqp_alloc
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|wpa_bss_anqp
modifier|*
name|anqp
decl_stmt|;
name|anqp
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|anqp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|anqp
operator|->
name|users
operator|=
literal|1
expr_stmt|;
return|return
name|anqp
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_anqp_clone - Clone an ANQP data structure  * @anqp: ANQP data structure from wpa_bss_anqp_alloc()  * Returns: Cloned ANQP data structure or %NULL on failure  */
end_comment

begin_function
specifier|static
name|struct
name|wpa_bss_anqp
modifier|*
name|wpa_bss_anqp_clone
parameter_list|(
name|struct
name|wpa_bss_anqp
modifier|*
name|anqp
parameter_list|)
block|{
name|struct
name|wpa_bss_anqp
modifier|*
name|n
decl_stmt|;
name|n
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|n
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
define|#
directive|define
name|ANQP_DUP
parameter_list|(
name|f
parameter_list|)
value|if (anqp->f) n->f = wpabuf_dup(anqp->f)
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
name|ANQP_DUP
argument_list|(
name|capability_list
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|venue_name
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|network_auth_type
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|roaming_consortium
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|ip_addr_type_availability
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|nai_realm
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|anqp_3gpp
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|domain_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
ifdef|#
directive|ifdef
name|CONFIG_HS20
name|ANQP_DUP
argument_list|(
name|hs20_capability_list
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|hs20_operator_friendly_name
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|hs20_wan_metrics
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|hs20_connection_capability
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|hs20_operating_class
argument_list|)
expr_stmt|;
name|ANQP_DUP
argument_list|(
name|hs20_osu_providers_list
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
undef|#
directive|undef
name|ANQP_DUP
return|return
name|n
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_anqp_unshare_alloc - Unshare ANQP data (if shared) in a BSS entry  * @bss: BSS entry  * Returns: 0 on success, -1 on failure  *  * This function ensures the specific BSS entry has an ANQP data structure that  * is not shared with any other BSS entry.  */
end_comment

begin_function
name|int
name|wpa_bss_anqp_unshare_alloc
parameter_list|(
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_bss_anqp
modifier|*
name|anqp
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|anqp
operator|&&
name|bss
operator|->
name|anqp
operator|->
name|users
operator|>
literal|1
condition|)
block|{
comment|/* allocated, but shared - clone an unshared copy */
name|anqp
operator|=
name|wpa_bss_anqp_clone
argument_list|(
name|bss
operator|->
name|anqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|anqp
operator|->
name|users
operator|=
literal|1
expr_stmt|;
name|bss
operator|->
name|anqp
operator|->
name|users
operator|--
expr_stmt|;
name|bss
operator|->
name|anqp
operator|=
name|anqp
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|bss
operator|->
name|anqp
condition|)
return|return
literal|0
return|;
comment|/* already allocated and not shared */
comment|/* not allocated - allocate a new storage area */
name|bss
operator|->
name|anqp
operator|=
name|wpa_bss_anqp_alloc
argument_list|()
expr_stmt|;
return|return
name|bss
operator|->
name|anqp
condition|?
literal|0
else|:
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_anqp_free - Free an ANQP data structure  * @anqp: ANQP data structure from wpa_bss_anqp_alloc() or wpa_bss_anqp_clone()  */
end_comment

begin_function
specifier|static
name|void
name|wpa_bss_anqp_free
parameter_list|(
name|struct
name|wpa_bss_anqp
modifier|*
name|anqp
parameter_list|)
block|{
if|if
condition|(
name|anqp
operator|==
name|NULL
condition|)
return|return;
name|anqp
operator|->
name|users
operator|--
expr_stmt|;
if|if
condition|(
name|anqp
operator|->
name|users
operator|>
literal|0
condition|)
block|{
comment|/* Another BSS entry holds a pointer to this ANQP info */
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|capability_list
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|venue_name
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|network_auth_type
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|roaming_consortium
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|ip_addr_type_availability
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|nai_realm
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|anqp_3gpp
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|domain_name
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
ifdef|#
directive|ifdef
name|CONFIG_HS20
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_capability_list
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_operator_friendly_name
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_wan_metrics
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_connection_capability
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_operating_class
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_osu_providers_list
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
name|os_free
argument_list|(
name|anqp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_bss_update_pending_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|old_bss
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|new_bss
parameter_list|)
block|{
name|struct
name|wpa_radio_work
modifier|*
name|work
decl_stmt|;
name|struct
name|wpa_connect_work
modifier|*
name|cwork
decl_stmt|;
name|work
operator|=
name|radio_work_pending
argument_list|(
name|wpa_s
argument_list|,
literal|"sme-connect"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|work
condition|)
name|work
operator|=
name|radio_work_pending
argument_list|(
name|wpa_s
argument_list|,
literal|"connect"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|work
condition|)
return|return;
name|cwork
operator|=
name|work
operator|->
name|ctx
expr_stmt|;
if|if
condition|(
name|cwork
operator|->
name|bss
operator|!=
name|old_bss
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Update BSS pointer for the pending connect radio work"
argument_list|)
expr_stmt|;
name|cwork
operator|->
name|bss
operator|=
name|new_bss
expr_stmt|;
if|if
condition|(
operator|!
name|new_bss
condition|)
name|cwork
operator|->
name|bss_removed
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_bss_remove
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|char
modifier|*
name|reason
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|last_scan_res
condition|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|last_scan_res_used
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|last_scan_res
index|[
name|i
index|]
operator|==
name|bss
condition|)
block|{
name|os_memmove
argument_list|(
operator|&
name|wpa_s
operator|->
name|last_scan_res
index|[
name|i
index|]
argument_list|,
operator|&
name|wpa_s
operator|->
name|last_scan_res
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
operator|(
name|wpa_s
operator|->
name|last_scan_res_used
operator|-
name|i
operator|-
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_bss
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|last_scan_res_used
operator|--
expr_stmt|;
break|break;
block|}
block|}
block|}
name|wpa_bss_update_pending_connect
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list_id
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|num_bss
operator|--
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"BSS: Remove id %u BSSID "
name|MACSTR
literal|" SSID '%s' due to %s"
argument_list|,
name|bss
operator|->
name|id
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|wpas_notify_bss_removed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
name|wpa_bss_anqp_free
argument_list|(
name|bss
operator|->
name|anqp
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get - Fetch a BSS table entry based on BSSID and SSID  * @wpa_s: Pointer to wpa_supplicant data  * @bssid: BSSID  * @ssid: SSID  * @ssid_len: Length of @ssid  * Returns: Pointer to the BSS entry or %NULL if not found  */
end_comment

begin_function
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_get
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_supplicant_filter_bssid_match
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
condition|)
return|return
name|NULL
return|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|bss
operator|->
name|ssid_len
operator|==
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|calculate_update_time
parameter_list|(
specifier|const
name|struct
name|os_reltime
modifier|*
name|fetch_time
parameter_list|,
name|unsigned
name|int
name|age_ms
parameter_list|,
name|struct
name|os_reltime
modifier|*
name|update_time
parameter_list|)
block|{
name|os_time_t
name|usec
decl_stmt|;
name|update_time
operator|->
name|sec
operator|=
name|fetch_time
operator|->
name|sec
expr_stmt|;
name|update_time
operator|->
name|usec
operator|=
name|fetch_time
operator|->
name|usec
expr_stmt|;
name|update_time
operator|->
name|sec
operator|-=
name|age_ms
operator|/
literal|1000
expr_stmt|;
name|usec
operator|=
operator|(
name|age_ms
operator|%
literal|1000
operator|)
operator|*
literal|1000
expr_stmt|;
if|if
condition|(
name|update_time
operator|->
name|usec
operator|<
name|usec
condition|)
block|{
name|update_time
operator|->
name|sec
operator|--
expr_stmt|;
name|update_time
operator|->
name|usec
operator|+=
literal|1000000
expr_stmt|;
block|}
name|update_time
operator|->
name|usec
operator|-=
name|usec
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_bss_copy_res
parameter_list|(
name|struct
name|wpa_bss
modifier|*
name|dst
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|src
parameter_list|,
name|struct
name|os_reltime
modifier|*
name|fetch_time
parameter_list|)
block|{
name|dst
operator|->
name|flags
operator|=
name|src
operator|->
name|flags
expr_stmt|;
name|os_memcpy
argument_list|(
name|dst
operator|->
name|bssid
argument_list|,
name|src
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|dst
operator|->
name|freq
operator|=
name|src
operator|->
name|freq
expr_stmt|;
name|dst
operator|->
name|beacon_int
operator|=
name|src
operator|->
name|beacon_int
expr_stmt|;
name|dst
operator|->
name|caps
operator|=
name|src
operator|->
name|caps
expr_stmt|;
name|dst
operator|->
name|qual
operator|=
name|src
operator|->
name|qual
expr_stmt|;
name|dst
operator|->
name|noise
operator|=
name|src
operator|->
name|noise
expr_stmt|;
name|dst
operator|->
name|level
operator|=
name|src
operator|->
name|level
expr_stmt|;
name|dst
operator|->
name|tsf
operator|=
name|src
operator|->
name|tsf
expr_stmt|;
name|dst
operator|->
name|est_throughput
operator|=
name|src
operator|->
name|est_throughput
expr_stmt|;
name|dst
operator|->
name|snr
operator|=
name|src
operator|->
name|snr
expr_stmt|;
name|calculate_update_time
argument_list|(
name|fetch_time
argument_list|,
name|src
operator|->
name|age
argument_list|,
operator|&
name|dst
operator|->
name|last_update
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_bss_known
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|ssid_len
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|->
name|ssid_len
operator|==
name|bss
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_bss_in_use
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
return|return
name|bss
operator|==
name|wpa_s
operator|->
name|current_bss
operator|||
operator|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
operator|&&
operator|(
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|||
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_bss_remove_oldest_unknown
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|wpa_bss_known
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
condition|)
block|{
name|wpa_bss_remove
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_bss_remove_oldest
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
comment|/* 	 * Remove the oldest entry that does not match with any configured 	 * network. 	 */
if|if
condition|(
name|wpa_bss_remove_oldest_unknown
argument_list|(
name|wpa_s
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* 	 * Remove the oldest entry that isn't currently in use. 	 */
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|wpa_bss_in_use
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
condition|)
block|{
name|wpa_bss_remove
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_add
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|,
name|struct
name|os_reltime
modifier|*
name|fetch_time
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|bss
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
operator|+
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|bss
operator|->
name|id
operator|=
name|wpa_s
operator|->
name|bss_next_id
operator|++
expr_stmt|;
name|bss
operator|->
name|last_update_idx
operator|=
name|wpa_s
operator|->
name|bss_update_idx
expr_stmt|;
name|wpa_bss_copy_res
argument_list|(
name|bss
argument_list|,
name|res
argument_list|,
name|fetch_time
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid_len
operator|=
name|ssid_len
expr_stmt|;
name|bss
operator|->
name|ie_len
operator|=
name|res
operator|->
name|ie_len
expr_stmt|;
name|bss
operator|->
name|beacon_ie_len
operator|=
name|res
operator|->
name|beacon_ie_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|+
literal|1
argument_list|,
name|res
operator|+
literal|1
argument_list|,
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
name|wpa_bss_set_hessid
argument_list|(
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|num_bss
operator|+
literal|1
operator|>
name|wpa_s
operator|->
name|conf
operator|->
name|bss_max_count
operator|&&
name|wpa_bss_remove_oldest
argument_list|(
name|wpa_s
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Increasing the MAX BSS count to %d "
literal|"because all BSSes are in use. We should normally "
literal|"not get here!"
argument_list|,
operator|(
name|int
operator|)
name|wpa_s
operator|->
name|num_bss
operator|+
literal|1
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|bss_max_count
operator|=
name|wpa_s
operator|->
name|num_bss
operator|+
literal|1
expr_stmt|;
block|}
name|dl_list_add_tail
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss
argument_list|,
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|dl_list_add_tail
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss_id
argument_list|,
operator|&
name|bss
operator|->
name|list_id
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|num_bss
operator|++
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"BSS: Add new id %u BSSID "
name|MACSTR
literal|" SSID '%s'"
argument_list|,
name|bss
operator|->
name|id
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
argument_list|,
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
name|wpas_notify_bss_added
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
name|bss
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|are_ies_equal
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|old
parameter_list|,
specifier|const
name|struct
name|wpa_scan_res
modifier|*
name|new
parameter_list|,
name|u32
name|ie
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|old_ie
decl_stmt|,
modifier|*
name|new_ie
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|old_ie_buff
init|=
name|NULL
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|new_ie_buff
init|=
name|NULL
decl_stmt|;
name|int
name|new_ie_len
decl_stmt|,
name|old_ie_len
decl_stmt|,
name|ret
decl_stmt|,
name|is_multi
decl_stmt|;
switch|switch
condition|(
name|ie
condition|)
block|{
case|case
name|WPA_IE_VENDOR_TYPE
case|:
name|old_ie
operator|=
name|wpa_bss_get_vendor_ie
argument_list|(
name|old
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|new_ie
operator|=
name|wpa_scan_get_vendor_ie
argument_list|(
name|new
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|is_multi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|WPS_IE_VENDOR_TYPE
case|:
name|old_ie_buff
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|old
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|new_ie_buff
operator|=
name|wpa_scan_get_vendor_ie_multi
argument_list|(
name|new
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|is_multi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WLAN_EID_RSN
case|:
case|case
name|WLAN_EID_SUPP_RATES
case|:
case|case
name|WLAN_EID_EXT_SUPP_RATES
case|:
name|old_ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|old
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|new_ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|new
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|is_multi
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bss: %s: cannot compare IEs"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|is_multi
condition|)
block|{
comment|/* in case of multiple IEs stored in buffer */
name|old_ie
operator|=
name|old_ie_buff
condition|?
name|wpabuf_head_u8
argument_list|(
name|old_ie_buff
argument_list|)
else|:
name|NULL
expr_stmt|;
name|new_ie
operator|=
name|new_ie_buff
condition|?
name|wpabuf_head_u8
argument_list|(
name|new_ie_buff
argument_list|)
else|:
name|NULL
expr_stmt|;
name|old_ie_len
operator|=
name|old_ie_buff
condition|?
name|wpabuf_len
argument_list|(
name|old_ie_buff
argument_list|)
else|:
literal|0
expr_stmt|;
name|new_ie_len
operator|=
name|new_ie_buff
condition|?
name|wpabuf_len
argument_list|(
name|new_ie_buff
argument_list|)
else|:
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* in case of single IE */
name|old_ie_len
operator|=
name|old_ie
condition|?
name|old_ie
index|[
literal|1
index|]
operator|+
literal|2
else|:
literal|0
expr_stmt|;
name|new_ie_len
operator|=
name|new_ie
condition|?
name|new_ie
index|[
literal|1
index|]
operator|+
literal|2
else|:
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|old_ie
operator|||
operator|!
name|new_ie
condition|)
name|ret
operator|=
operator|!
name|old_ie
operator|&&
operator|!
name|new_ie
expr_stmt|;
else|else
name|ret
operator|=
operator|(
name|old_ie_len
operator|==
name|new_ie_len
operator|&&
name|os_memcmp
argument_list|(
name|old_ie
argument_list|,
name|new_ie
argument_list|,
name|old_ie_len
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|old_ie_buff
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|new_ie_buff
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|wpa_bss_compare_res
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|old
parameter_list|,
specifier|const
name|struct
name|wpa_scan_res
modifier|*
name|new
parameter_list|)
block|{
name|u32
name|changes
init|=
literal|0
decl_stmt|;
name|int
name|caps_diff
init|=
name|old
operator|->
name|caps
operator|^
name|new
operator|->
name|caps
decl_stmt|;
if|if
condition|(
name|old
operator|->
name|freq
operator|!=
name|new
operator|->
name|freq
condition|)
name|changes
operator||=
name|WPA_BSS_FREQ_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
name|old
operator|->
name|level
operator|!=
name|new
operator|->
name|level
condition|)
name|changes
operator||=
name|WPA_BSS_SIGNAL_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
name|caps_diff
operator|&
name|IEEE80211_CAP_PRIVACY
condition|)
name|changes
operator||=
name|WPA_BSS_PRIVACY_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
name|caps_diff
operator|&
name|IEEE80211_CAP_IBSS
condition|)
name|changes
operator||=
name|WPA_BSS_MODE_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
name|old
operator|->
name|ie_len
operator|==
name|new
operator|->
name|ie_len
operator|&&
name|os_memcmp
argument_list|(
name|old
operator|+
literal|1
argument_list|,
name|new
operator|+
literal|1
argument_list|,
name|old
operator|->
name|ie_len
argument_list|)
operator|==
literal|0
condition|)
return|return
name|changes
return|;
name|changes
operator||=
name|WPA_BSS_IES_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
operator|!
name|are_ies_equal
argument_list|(
name|old
argument_list|,
name|new
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
condition|)
name|changes
operator||=
name|WPA_BSS_WPAIE_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
operator|!
name|are_ies_equal
argument_list|(
name|old
argument_list|,
name|new
argument_list|,
name|WLAN_EID_RSN
argument_list|)
condition|)
name|changes
operator||=
name|WPA_BSS_RSNIE_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
operator|!
name|are_ies_equal
argument_list|(
name|old
argument_list|,
name|new
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
condition|)
name|changes
operator||=
name|WPA_BSS_WPS_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
operator|!
name|are_ies_equal
argument_list|(
name|old
argument_list|,
name|new
argument_list|,
name|WLAN_EID_SUPP_RATES
argument_list|)
operator|||
operator|!
name|are_ies_equal
argument_list|(
name|old
argument_list|,
name|new
argument_list|,
name|WLAN_EID_EXT_SUPP_RATES
argument_list|)
condition|)
name|changes
operator||=
name|WPA_BSS_RATES_CHANGED_FLAG
expr_stmt|;
return|return
name|changes
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|notify_bss_changes
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|changes
parameter_list|,
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_FREQ_CHANGED_FLAG
condition|)
name|wpas_notify_bss_freq_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_SIGNAL_CHANGED_FLAG
condition|)
name|wpas_notify_bss_signal_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_PRIVACY_CHANGED_FLAG
condition|)
name|wpas_notify_bss_privacy_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_MODE_CHANGED_FLAG
condition|)
name|wpas_notify_bss_mode_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_WPAIE_CHANGED_FLAG
condition|)
name|wpas_notify_bss_wpaie_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_RSNIE_CHANGED_FLAG
condition|)
name|wpas_notify_bss_rsnie_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_WPS_CHANGED_FLAG
condition|)
name|wpas_notify_bss_wps_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_IES_CHANGED_FLAG
condition|)
name|wpas_notify_bss_ies_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_RATES_CHANGED_FLAG
condition|)
name|wpas_notify_bss_rates_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
name|wpas_notify_bss_seen
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_update
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|,
name|struct
name|os_reltime
modifier|*
name|fetch_time
parameter_list|)
block|{
name|u32
name|changes
decl_stmt|;
name|changes
operator|=
name|wpa_bss_compare_res
argument_list|(
name|bss
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|bss
operator|->
name|scan_miss_count
operator|=
literal|0
expr_stmt|;
name|bss
operator|->
name|last_update_idx
operator|=
name|wpa_s
operator|->
name|bss_update_idx
expr_stmt|;
name|wpa_bss_copy_res
argument_list|(
name|bss
argument_list|,
name|res
argument_list|,
name|fetch_time
argument_list|)
expr_stmt|;
comment|/* Move the entry to the end of the list */
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
operator|&&
operator|!
name|wpa_scan_get_vendor_ie
argument_list|(
name|res
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
condition|)
block|{
comment|/* 		 * This can happen when non-P2P station interface runs a scan 		 * without P2P IE in the Probe Request frame. P2P GO would reply 		 * to that with a Probe Response that does not include P2P IE. 		 * Do not update the IEs in this BSS entry to avoid such loss of 		 * information that may be needed for P2P operations to 		 * determine group information. 		 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"BSS: Do not update scan IEs for "
name|MACSTR
literal|" since that would remove P2P IE information"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|bss
operator|->
name|ie_len
operator|+
name|bss
operator|->
name|beacon_ie_len
operator|>=
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
condition|)
block|{
name|os_memcpy
argument_list|(
name|bss
operator|+
literal|1
argument_list|,
name|res
operator|+
literal|1
argument_list|,
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ie_len
operator|=
name|res
operator|->
name|ie_len
expr_stmt|;
name|bss
operator|->
name|beacon_ie_len
operator|=
name|res
operator|->
name|beacon_ie_len
expr_stmt|;
block|}
else|else
block|{
name|struct
name|wpa_bss
modifier|*
name|nbss
decl_stmt|;
name|struct
name|dl_list
modifier|*
name|prev
init|=
name|bss
operator|->
name|list_id
operator|.
name|prev
decl_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list_id
argument_list|)
expr_stmt|;
name|nbss
operator|=
name|os_realloc
argument_list|(
name|bss
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
operator|+
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbss
condition|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|last_scan_res_used
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|last_scan_res
index|[
name|i
index|]
operator|==
name|bss
condition|)
block|{
name|wpa_s
operator|->
name|last_scan_res
index|[
name|i
index|]
operator|=
name|nbss
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|current_bss
operator|==
name|bss
condition|)
name|wpa_s
operator|->
name|current_bss
operator|=
name|nbss
expr_stmt|;
name|wpa_bss_update_pending_connect
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|nbss
argument_list|)
expr_stmt|;
name|bss
operator|=
name|nbss
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|+
literal|1
argument_list|,
name|res
operator|+
literal|1
argument_list|,
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ie_len
operator|=
name|res
operator|->
name|ie_len
expr_stmt|;
name|bss
operator|->
name|beacon_ie_len
operator|=
name|res
operator|->
name|beacon_ie_len
expr_stmt|;
block|}
name|dl_list_add
argument_list|(
name|prev
argument_list|,
operator|&
name|bss
operator|->
name|list_id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_IES_CHANGED_FLAG
condition|)
name|wpa_bss_set_hessid
argument_list|(
name|bss
argument_list|)
expr_stmt|;
name|dl_list_add_tail
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss
argument_list|,
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|notify_bss_changes
argument_list|(
name|wpa_s
argument_list|,
name|changes
argument_list|,
name|bss
argument_list|)
expr_stmt|;
return|return
name|bss
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_update_start - Start a BSS table update from scan results  * @wpa_s: Pointer to wpa_supplicant data  *  * This function is called at the start of each BSS table update round for new  * scan results. The actual scan result entries are indicated with calls to  * wpa_bss_update_scan_res() and the update round is finished with a call to  * wpa_bss_update_end().  */
end_comment

begin_function
name|void
name|wpa_bss_update_start
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|bss_update_idx
operator|++
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"BSS: Start scan result update %u"
argument_list|,
name|wpa_s
operator|->
name|bss_update_idx
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|last_scan_res_used
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_update_scan_res - Update a BSS table entry based on a scan result  * @wpa_s: Pointer to wpa_supplicant data  * @res: Scan result  * @fetch_time: Time when the result was fetched from the driver  *  * This function updates a BSS table entry (or adds one) based on a scan result.  * This is called separately for each scan result between the calls to  * wpa_bss_update_start() and wpa_bss_update_end().  */
end_comment

begin_function
name|void
name|wpa_bss_update_scan_res
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|,
name|struct
name|os_reltime
modifier|*
name|fetch_time
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|p2p
decl_stmt|,
modifier|*
name|mesh
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ignore_old_scan_res
condition|)
block|{
name|struct
name|os_reltime
name|update
decl_stmt|;
name|calculate_update_time
argument_list|(
name|fetch_time
argument_list|,
name|res
operator|->
name|age
argument_list|,
operator|&
name|update
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_reltime_before
argument_list|(
operator|&
name|update
argument_list|,
operator|&
name|wpa_s
operator|->
name|scan_trigger_time
argument_list|)
condition|)
block|{
name|struct
name|os_reltime
name|age
decl_stmt|;
name|os_reltime_sub
argument_list|(
operator|&
name|wpa_s
operator|->
name|scan_trigger_time
argument_list|,
operator|&
name|update
argument_list|,
operator|&
name|age
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"BSS: Ignore driver BSS "
literal|"table entry that is %u.%06u seconds older "
literal|"than our scan trigger"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|age
operator|.
name|sec
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|age
operator|.
name|usec
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|ssid
operator|=
name|wpa_scan_get_ie
argument_list|(
name|res
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"BSS: No SSID IE included for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ssid
index|[
literal|1
index|]
operator|>
literal|32
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"BSS: Too long SSID IE included for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|p2p
operator|=
name|wpa_scan_get_vendor_ie
argument_list|(
name|res
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|p2p
operator|==
name|NULL
operator|&&
name|wpa_s
operator|->
name|p2p_group_interface
operator|!=
name|NOT_P2P_GROUP_INTERFACE
condition|)
block|{
comment|/* 		 * If it's a P2P specific interface, then don't update 		 * the scan result without a P2P IE. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSS: No P2P IE - skipping BSS "
name|MACSTR
literal|" update for P2P interface"
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|p2p
operator|&&
name|ssid
index|[
literal|1
index|]
operator|==
name|P2P_WILDCARD_SSID_LEN
operator|&&
name|os_memcmp
argument_list|(
name|ssid
operator|+
literal|2
argument_list|,
name|P2P_WILDCARD_SSID
argument_list|,
name|P2P_WILDCARD_SSID_LEN
argument_list|)
operator|==
literal|0
condition|)
return|return;
comment|/* Skip P2P listen discovery results here */
comment|/* TODO: add option for ignoring BSSes we are not interested in 	 * (to save memory) */
name|mesh
operator|=
name|wpa_scan_get_ie
argument_list|(
name|res
argument_list|,
name|WLAN_EID_MESH_ID
argument_list|)
expr_stmt|;
if|if
condition|(
name|mesh
operator|&&
name|mesh
index|[
literal|1
index|]
operator|<=
literal|32
condition|)
name|ssid
operator|=
name|mesh
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|res
operator|->
name|bssid
argument_list|,
name|ssid
operator|+
literal|2
argument_list|,
name|ssid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
name|bss
operator|=
name|wpa_bss_add
argument_list|(
name|wpa_s
argument_list|,
name|ssid
operator|+
literal|2
argument_list|,
name|ssid
index|[
literal|1
index|]
argument_list|,
name|res
argument_list|,
name|fetch_time
argument_list|)
expr_stmt|;
else|else
block|{
name|bss
operator|=
name|wpa_bss_update
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|res
argument_list|,
name|fetch_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|last_scan_res
condition|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|last_scan_res_used
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bss
operator|==
name|wpa_s
operator|->
name|last_scan_res
index|[
name|i
index|]
condition|)
block|{
comment|/* Already in the list */
return|return;
block|}
block|}
block|}
block|}
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|last_scan_res_used
operator|>=
name|wpa_s
operator|->
name|last_scan_res_size
condition|)
block|{
name|struct
name|wpa_bss
modifier|*
modifier|*
name|n
decl_stmt|;
name|unsigned
name|int
name|siz
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|last_scan_res_size
operator|==
literal|0
condition|)
name|siz
operator|=
literal|32
expr_stmt|;
else|else
name|siz
operator|=
name|wpa_s
operator|->
name|last_scan_res_size
operator|*
literal|2
expr_stmt|;
name|n
operator|=
name|os_realloc_array
argument_list|(
name|wpa_s
operator|->
name|last_scan_res
argument_list|,
name|siz
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_bss
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return;
name|wpa_s
operator|->
name|last_scan_res
operator|=
name|n
expr_stmt|;
name|wpa_s
operator|->
name|last_scan_res_size
operator|=
name|siz
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|last_scan_res
condition|)
name|wpa_s
operator|->
name|last_scan_res
index|[
name|wpa_s
operator|->
name|last_scan_res_used
operator|++
index|]
operator|=
name|bss
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_bss_included_in_scan
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|struct
name|scan_info
modifier|*
name|info
parameter_list|)
block|{
name|int
name|found
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|info
operator|->
name|num_freqs
condition|)
block|{
name|found
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|info
operator|->
name|num_freqs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bss
operator|->
name|freq
operator|==
name|info
operator|->
name|freqs
index|[
name|i
index|]
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
name|info
operator|->
name|num_ssids
condition|)
block|{
name|found
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|info
operator|->
name|num_ssids
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|struct
name|wpa_driver_scan_ssid
modifier|*
name|s
init|=
operator|&
name|info
operator|->
name|ssids
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|s
operator|->
name|ssid
operator|==
name|NULL
operator|||
name|s
operator|->
name|ssid_len
operator|==
literal|0
operator|)
operator|||
operator|(
name|s
operator|->
name|ssid_len
operator|==
name|bss
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|s
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_update_end - End a BSS table update from scan results  * @wpa_s: Pointer to wpa_supplicant data  * @info: Information about scan parameters  * @new_scan: Whether this update round was based on a new scan  *  * This function is called at the end of each BSS table update round for new  * scan results. The start of the update was indicated with a call to  * wpa_bss_update_start().  */
end_comment

begin_function
name|void
name|wpa_bss_update_end
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|scan_info
modifier|*
name|info
parameter_list|,
name|int
name|new_scan
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|wpa_s
operator|->
name|last_scan
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_scan
condition|)
return|return;
comment|/* do not expire entries without new scan */
name|dl_list_for_each_safe
argument_list|(
argument|bss
argument_list|,
argument|n
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpa_bss_in_use
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|wpa_bss_included_in_scan
argument_list|(
name|bss
argument_list|,
name|info
argument_list|)
condition|)
continue|continue;
comment|/* expire only BSSes that were scanned */
if|if
condition|(
name|bss
operator|->
name|last_update_idx
operator|<
name|wpa_s
operator|->
name|bss_update_idx
condition|)
name|bss
operator|->
name|scan_miss_count
operator|++
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|scan_miss_count
operator|>=
name|wpa_s
operator|->
name|conf
operator|->
name|bss_expiration_scan_count
condition|)
block|{
name|wpa_bss_remove
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
literal|"no match in scan"
argument_list|)
expr_stmt|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSS: last_scan_res_used=%u/%u"
argument_list|,
name|wpa_s
operator|->
name|last_scan_res_used
argument_list|,
name|wpa_s
operator|->
name|last_scan_res_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_flush_by_age - Flush old BSS entries  * @wpa_s: Pointer to wpa_supplicant data  * @age: Maximum entry age in seconds  *  * Remove BSS entries that have not been updated during the last @age seconds.  */
end_comment

begin_function
name|void
name|wpa_bss_flush_by_age
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|age
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|struct
name|os_reltime
name|t
decl_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss
argument_list|)
condition|)
return|return;
name|os_get_reltime
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
name|t
operator|.
name|sec
operator|-=
name|age
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|bss
argument_list|,
argument|n
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpa_bss_in_use
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|os_reltime_before
argument_list|(
operator|&
name|bss
operator|->
name|last_update
argument_list|,
operator|&
name|t
argument_list|)
condition|)
block|{
name|wpa_bss_remove
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
else|else
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_bss_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_bss_flush_by_age
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|bss_expiration_age
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPA_BSS_EXPIRATION_PERIOD
argument_list|,
literal|0
argument_list|,
name|wpa_bss_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_init - Initialize BSS table  * @wpa_s: Pointer to wpa_supplicant data  * Returns: 0 on success, -1 on failure  *  * This prepares BSS table lists and timer for periodic updates. The BSS table  * is deinitialized with wpa_bss_deinit() once not needed anymore.  */
end_comment

begin_function
name|int
name|wpa_bss_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|dl_list_init
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss
argument_list|)
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss_id
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPA_BSS_EXPIRATION_PERIOD
argument_list|,
literal|0
argument_list|,
name|wpa_bss_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_flush - Flush all unused BSS entries  * @wpa_s: Pointer to wpa_supplicant data  */
end_comment

begin_function
name|void
name|wpa_bss_flush
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|wpa_s
operator|->
name|clear_driver_scan_cache
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|bss
operator|.
name|next
operator|==
name|NULL
condition|)
return|return;
comment|/* BSS table not yet initialized */
name|dl_list_for_each_safe
argument_list|(
argument|bss
argument_list|,
argument|n
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpa_bss_in_use
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
name|wpa_bss_remove
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpa_bss_deinit - Deinitialize BSS table  * @wpa_s: Pointer to wpa_supplicant data  */
end_comment

begin_function
name|void
name|wpa_bss_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpa_bss_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_bss_flush
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get_bssid - Fetch a BSS table entry based on BSSID  * @wpa_s: Pointer to wpa_supplicant data  * @bssid: BSSID  * Returns: Pointer to the BSS entry or %NULL if not found  */
end_comment

begin_function
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_get_bssid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_supplicant_filter_bssid_match
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
condition|)
return|return
name|NULL
return|;
name|dl_list_for_each_reverse
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get_bssid_latest - Fetch the latest BSS table entry based on BSSID  * @wpa_s: Pointer to wpa_supplicant data  * @bssid: BSSID  * Returns: Pointer to the BSS entry or %NULL if not found  *  * This function is like wpa_bss_get_bssid(), but full BSS table is iterated to  * find the entry that has the most recent update. This can help in finding the  * correct entry in cases where the SSID of the AP may have changed recently  * (e.g., in WPS reconfiguration cases).  */
end_comment

begin_function
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_get_bssid_latest
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|found
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_supplicant_filter_bssid_match
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
condition|)
return|return
name|NULL
return|;
name|dl_list_for_each_reverse
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|found
operator|==
name|NULL
operator|||
name|os_reltime_before
argument_list|(
operator|&
name|found
operator|->
name|last_update
argument_list|,
operator|&
name|bss
operator|->
name|last_update
argument_list|)
condition|)
name|found
operator|=
name|bss
expr_stmt|;
block|}
return|return
name|found
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_P2P
end_ifdef

begin_comment
comment|/**  * wpa_bss_get_p2p_dev_addr - Fetch a BSS table entry based on P2P Device Addr  * @wpa_s: Pointer to wpa_supplicant data  * @dev_addr: P2P Device Address of the GO  * Returns: Pointer to the BSS entry or %NULL if not found  */
end_comment

begin_function
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_get_p2p_dev_addr
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|dl_list_for_each_reverse
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|p2p_parse_dev_addr
argument_list|(
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
argument_list|,
name|bss
operator|->
name|ie_len
argument_list|,
name|addr
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|addr
argument_list|,
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_P2P */
end_comment

begin_comment
comment|/**  * wpa_bss_get_id - Fetch a BSS table entry based on identifier  * @wpa_s: Pointer to wpa_supplicant data  * @id: Unique identifier (struct wpa_bss::id) assigned for the entry  * Returns: Pointer to the BSS entry or %NULL if not found  */
end_comment

begin_function
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_get_id
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|id
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|bss
operator|->
name|id
operator|==
name|id
condition|)
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get_id_range - Fetch a BSS table entry based on identifier range  * @wpa_s: Pointer to wpa_supplicant data  * @idf: Smallest allowed identifier assigned for the entry  * @idf: Largest allowed identifier assigned for the entry  * Returns: Pointer to the BSS entry or %NULL if not found  *  * This function is similar to wpa_bss_get_id() but allows a BSS entry with the  * smallest id value to be fetched within the specified range without the  * caller having to know the exact id.  */
end_comment

begin_function
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_get_id_range
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|idf
parameter_list|,
name|unsigned
name|int
name|idl
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss_id
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list_id
argument_list|)
block|{
if|if
condition|(
name|bss
operator|->
name|id
operator|>=
name|idf
operator|&&
name|bss
operator|->
name|id
operator|<=
name|idl
condition|)
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get_ie - Fetch a specified information element from a BSS entry  * @bss: BSS table entry  * @ie: Information element identitifier (WLAN_EID_*)  * Returns: Pointer to the information element (id field) or %NULL if not found  *  * This function returns the first matching information element in the BSS  * entry.  */
end_comment

begin_function
specifier|const
name|u8
modifier|*
name|wpa_bss_get_ie
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u8
name|ie
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|bss
operator|->
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|ie
condition|)
return|return
name|pos
return|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get_vendor_ie - Fetch a vendor information element from a BSS entry  * @bss: BSS table entry  * @vendor_type: Vendor type (four octets starting the IE payload)  * Returns: Pointer to the information element (id field) or %NULL if not found  *  * This function returns the first matching information element in the BSS  * entry.  */
end_comment

begin_function
specifier|const
name|u8
modifier|*
name|wpa_bss_get_vendor_ie
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u32
name|vendor_type
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|bss
operator|->
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|vendor_type
operator|==
name|WPA_GET_BE32
argument_list|(
operator|&
name|pos
index|[
literal|2
index|]
argument_list|)
condition|)
return|return
name|pos
return|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get_vendor_ie_beacon - Fetch a vendor information from a BSS entry  * @bss: BSS table entry  * @vendor_type: Vendor type (four octets starting the IE payload)  * Returns: Pointer to the information element (id field) or %NULL if not found  *  * This function returns the first matching information element in the BSS  * entry.  *  * This function is like wpa_bss_get_vendor_ie(), but uses IE buffer only  * from Beacon frames instead of either Beacon or Probe Response frames.  */
end_comment

begin_function
specifier|const
name|u8
modifier|*
name|wpa_bss_get_vendor_ie_beacon
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u32
name|vendor_type
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|beacon_ie_len
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
expr_stmt|;
name|pos
operator|+=
name|bss
operator|->
name|ie_len
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|bss
operator|->
name|beacon_ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|vendor_type
operator|==
name|WPA_GET_BE32
argument_list|(
operator|&
name|pos
index|[
literal|2
index|]
argument_list|)
condition|)
return|return
name|pos
return|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get_vendor_ie_multi - Fetch vendor IE data from a BSS entry  * @bss: BSS table entry  * @vendor_type: Vendor type (four octets starting the IE payload)  * Returns: Pointer to the information element payload or %NULL if not found  *  * This function returns concatenated payload of possibly fragmented vendor  * specific information elements in the BSS entry. The caller is responsible for  * freeing the returned buffer.  */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wpa_bss_get_vendor_ie_multi
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u32
name|vendor_type
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|bss
operator|->
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|bss
operator|->
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|vendor_type
operator|==
name|WPA_GET_BE32
argument_list|(
operator|&
name|pos
index|[
literal|2
index|]
argument_list|)
condition|)
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|pos
operator|+
literal|2
operator|+
literal|4
argument_list|,
name|pos
index|[
literal|1
index|]
operator|-
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get_vendor_ie_multi_beacon - Fetch vendor IE data from a BSS entry  * @bss: BSS table entry  * @vendor_type: Vendor type (four octets starting the IE payload)  * Returns: Pointer to the information element payload or %NULL if not found  *  * This function returns concatenated payload of possibly fragmented vendor  * specific information elements in the BSS entry. The caller is responsible for  * freeing the returned buffer.  *  * This function is like wpa_bss_get_vendor_ie_multi(), but uses IE buffer only  * from Beacon frames instead of either Beacon or Probe Response frames.  */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wpa_bss_get_vendor_ie_multi_beacon
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u32
name|vendor_type
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|bss
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
expr_stmt|;
name|pos
operator|+=
name|bss
operator|->
name|ie_len
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|bss
operator|->
name|beacon_ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|vendor_type
operator|==
name|WPA_GET_BE32
argument_list|(
operator|&
name|pos
index|[
literal|2
index|]
argument_list|)
condition|)
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|pos
operator|+
literal|2
operator|+
literal|4
argument_list|,
name|pos
index|[
literal|1
index|]
operator|-
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get_max_rate - Get maximum legacy TX rate supported in a BSS  * @bss: BSS table entry  * Returns: Maximum legacy rate in units of 500 kbps  */
end_comment

begin_function
name|int
name|wpa_bss_get_max_rate
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|int
name|rate
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_SUPP_RATES
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ie
operator|&&
name|i
operator|<
name|ie
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
operator|)
operator|>
name|rate
condition|)
name|rate
operator|=
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
expr_stmt|;
block|}
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_EXT_SUPP_RATES
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ie
operator|&&
name|i
operator|<
name|ie
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
operator|)
operator|>
name|rate
condition|)
name|rate
operator|=
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
expr_stmt|;
block|}
return|return
name|rate
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_bss_get_bit_rates - Get legacy TX rates supported in a BSS  * @bss: BSS table entry  * @rates: Buffer for returning a pointer to the rates list (units of 500 kbps)  * Returns: number of legacy TX rates or -1 on failure  *  * The caller is responsible for freeing the returned buffer with os_free() in  * case of success.  */
end_comment

begin_function
name|int
name|wpa_bss_get_bit_rates
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u8
modifier|*
modifier|*
name|rates
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|,
modifier|*
name|ie2
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|;
name|u8
modifier|*
name|r
decl_stmt|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_SUPP_RATES
argument_list|)
expr_stmt|;
name|ie2
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_EXT_SUPP_RATES
argument_list|)
expr_stmt|;
name|len
operator|=
operator|(
name|ie
condition|?
name|ie
index|[
literal|1
index|]
else|:
literal|0
operator|)
operator|+
operator|(
name|ie2
condition|?
name|ie2
index|[
literal|1
index|]
else|:
literal|0
operator|)
expr_stmt|;
name|r
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ie
operator|&&
name|i
operator|<
name|ie
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
name|r
index|[
name|i
index|]
operator|=
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|ie2
operator|&&
name|j
operator|<
name|ie2
index|[
literal|1
index|]
condition|;
name|j
operator|++
control|)
name|r
index|[
name|i
operator|+
name|j
index|]
operator|=
name|ie2
index|[
name|j
operator|+
literal|2
index|]
operator|&
literal|0x7f
expr_stmt|;
operator|*
name|rates
operator|=
name|r
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

end_unit


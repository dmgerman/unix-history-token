begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * BSS table  * Copyright (c) 2009-2010, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_comment
comment|/**  * WPA_BSS_EXPIRATION_PERIOD - Period of expiration run in seconds  */
end_comment

begin_define
define|#
directive|define
name|WPA_BSS_EXPIRATION_PERIOD
value|10
end_define

begin_comment
comment|/**  * WPA_BSS_EXPIRATION_AGE - BSS entry age after which it can be expired  *  * This value control the time in seconds after which a BSS entry gets removed  * if it has not been updated or is not in use.  */
end_comment

begin_define
define|#
directive|define
name|WPA_BSS_EXPIRATION_AGE
value|180
end_define

begin_comment
comment|/**  * WPA_BSS_EXPIRATION_SCAN_COUNT - Expire BSS after number of scans  *  * If the BSS entry has not been seen in this many scans, it will be removed.  * Value 1 means that the entry is removed after the first scan without the  * BSSID being seen. Larger values can be used to avoid BSS entries  * disappearing if they are not visible in every scan (e.g., low signal quality  * or interference).  */
end_comment

begin_define
define|#
directive|define
name|WPA_BSS_EXPIRATION_SCAN_COUNT
value|2
end_define

begin_define
define|#
directive|define
name|WPA_BSS_FREQ_CHANGED_FLAG
value|BIT(0)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_SIGNAL_CHANGED_FLAG
value|BIT(1)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_PRIVACY_CHANGED_FLAG
value|BIT(2)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_MODE_CHANGED_FLAG
value|BIT(3)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_WPAIE_CHANGED_FLAG
value|BIT(4)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_RSNIE_CHANGED_FLAG
value|BIT(5)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_WPS_CHANGED_FLAG
value|BIT(6)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_RATES_CHANGED_FLAG
value|BIT(7)
end_define

begin_define
define|#
directive|define
name|WPA_BSS_IES_CHANGED_FLAG
value|BIT(8)
end_define

begin_function
specifier|static
name|void
name|wpa_bss_remove
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list_id
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|num_bss
operator|--
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSS: Remove id %u BSSID "
name|MACSTR
literal|" SSID '%s'"
argument_list|,
name|bss
operator|->
name|id
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
name|wpas_notify_bss_removed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_get
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|bss
operator|->
name|ssid_len
operator|==
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_bss_copy_res
parameter_list|(
name|struct
name|wpa_bss
modifier|*
name|dst
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|src
parameter_list|)
block|{
name|os_time_t
name|usec
decl_stmt|;
name|dst
operator|->
name|flags
operator|=
name|src
operator|->
name|flags
expr_stmt|;
name|os_memcpy
argument_list|(
name|dst
operator|->
name|bssid
argument_list|,
name|src
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|dst
operator|->
name|freq
operator|=
name|src
operator|->
name|freq
expr_stmt|;
name|dst
operator|->
name|beacon_int
operator|=
name|src
operator|->
name|beacon_int
expr_stmt|;
name|dst
operator|->
name|caps
operator|=
name|src
operator|->
name|caps
expr_stmt|;
name|dst
operator|->
name|qual
operator|=
name|src
operator|->
name|qual
expr_stmt|;
name|dst
operator|->
name|noise
operator|=
name|src
operator|->
name|noise
expr_stmt|;
name|dst
operator|->
name|level
operator|=
name|src
operator|->
name|level
expr_stmt|;
name|dst
operator|->
name|tsf
operator|=
name|src
operator|->
name|tsf
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|dst
operator|->
name|last_update
argument_list|)
expr_stmt|;
name|dst
operator|->
name|last_update
operator|.
name|sec
operator|-=
name|src
operator|->
name|age
operator|/
literal|1000
expr_stmt|;
name|usec
operator|=
operator|(
name|src
operator|->
name|age
operator|%
literal|1000
operator|)
operator|*
literal|1000
expr_stmt|;
if|if
condition|(
name|dst
operator|->
name|last_update
operator|.
name|usec
operator|<
name|usec
condition|)
block|{
name|dst
operator|->
name|last_update
operator|.
name|sec
operator|--
expr_stmt|;
name|dst
operator|->
name|last_update
operator|.
name|usec
operator|+=
literal|1000000
expr_stmt|;
block|}
name|dst
operator|->
name|last_update
operator|.
name|usec
operator|-=
name|usec
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_bss_add
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|bss
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
operator|+
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return;
name|bss
operator|->
name|id
operator|=
name|wpa_s
operator|->
name|bss_next_id
operator|++
expr_stmt|;
name|bss
operator|->
name|last_update_idx
operator|=
name|wpa_s
operator|->
name|bss_update_idx
expr_stmt|;
name|wpa_bss_copy_res
argument_list|(
name|bss
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ssid_len
operator|=
name|ssid_len
expr_stmt|;
name|bss
operator|->
name|ie_len
operator|=
name|res
operator|->
name|ie_len
expr_stmt|;
name|bss
operator|->
name|beacon_ie_len
operator|=
name|res
operator|->
name|beacon_ie_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|+
literal|1
argument_list|,
name|res
operator|+
literal|1
argument_list|,
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
name|dl_list_add_tail
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss
argument_list|,
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|dl_list_add_tail
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss_id
argument_list|,
operator|&
name|bss
operator|->
name|list_id
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|num_bss
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSS: Add new id %u BSSID "
name|MACSTR
literal|" SSID '%s'"
argument_list|,
name|bss
operator|->
name|id
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
argument_list|,
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
name|wpas_notify_bss_added
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|num_bss
operator|>
name|wpa_s
operator|->
name|conf
operator|->
name|bss_max_count
condition|)
block|{
comment|/* Remove the oldest entry */
name|wpa_bss_remove
argument_list|(
name|wpa_s
argument_list|,
name|dl_list_first
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss
argument_list|,
expr|struct
name|wpa_bss
argument_list|,
name|list
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|are_ies_equal
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|old
parameter_list|,
specifier|const
name|struct
name|wpa_scan_res
modifier|*
name|new
parameter_list|,
name|u32
name|ie
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|old_ie
decl_stmt|,
modifier|*
name|new_ie
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|old_ie_buff
init|=
name|NULL
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|new_ie_buff
init|=
name|NULL
decl_stmt|;
name|int
name|new_ie_len
decl_stmt|,
name|old_ie_len
decl_stmt|,
name|ret
decl_stmt|,
name|is_multi
decl_stmt|;
switch|switch
condition|(
name|ie
condition|)
block|{
case|case
name|WPA_IE_VENDOR_TYPE
case|:
name|old_ie
operator|=
name|wpa_bss_get_vendor_ie
argument_list|(
name|old
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|new_ie
operator|=
name|wpa_scan_get_vendor_ie
argument_list|(
name|new
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|is_multi
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|WPS_IE_VENDOR_TYPE
case|:
name|old_ie_buff
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|old
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|new_ie_buff
operator|=
name|wpa_scan_get_vendor_ie_multi
argument_list|(
name|new
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|is_multi
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WLAN_EID_RSN
case|:
case|case
name|WLAN_EID_SUPP_RATES
case|:
case|case
name|WLAN_EID_EXT_SUPP_RATES
case|:
name|old_ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|old
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|new_ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|new
argument_list|,
name|ie
argument_list|)
expr_stmt|;
name|is_multi
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bss: %s: cannot compare IEs"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|is_multi
condition|)
block|{
comment|/* in case of multiple IEs stored in buffer */
name|old_ie
operator|=
name|old_ie_buff
condition|?
name|wpabuf_head_u8
argument_list|(
name|old_ie_buff
argument_list|)
else|:
name|NULL
expr_stmt|;
name|new_ie
operator|=
name|new_ie_buff
condition|?
name|wpabuf_head_u8
argument_list|(
name|new_ie_buff
argument_list|)
else|:
name|NULL
expr_stmt|;
name|old_ie_len
operator|=
name|old_ie_buff
condition|?
name|wpabuf_len
argument_list|(
name|old_ie_buff
argument_list|)
else|:
literal|0
expr_stmt|;
name|new_ie_len
operator|=
name|new_ie_buff
condition|?
name|wpabuf_len
argument_list|(
name|new_ie_buff
argument_list|)
else|:
literal|0
expr_stmt|;
block|}
else|else
block|{
comment|/* in case of single IE */
name|old_ie_len
operator|=
name|old_ie
condition|?
name|old_ie
index|[
literal|1
index|]
operator|+
literal|2
else|:
literal|0
expr_stmt|;
name|new_ie_len
operator|=
name|new_ie
condition|?
name|new_ie
index|[
literal|1
index|]
operator|+
literal|2
else|:
literal|0
expr_stmt|;
block|}
name|ret
operator|=
operator|(
name|old_ie_len
operator|==
name|new_ie_len
operator|&&
name|os_memcmp
argument_list|(
name|old_ie
argument_list|,
name|new_ie
argument_list|,
name|old_ie_len
argument_list|)
operator|==
literal|0
operator|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|old_ie_buff
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|new_ie_buff
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|u32
name|wpa_bss_compare_res
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|old
parameter_list|,
specifier|const
name|struct
name|wpa_scan_res
modifier|*
name|new
parameter_list|)
block|{
name|u32
name|changes
init|=
literal|0
decl_stmt|;
name|int
name|caps_diff
init|=
name|old
operator|->
name|caps
operator|^
name|new
operator|->
name|caps
decl_stmt|;
if|if
condition|(
name|old
operator|->
name|freq
operator|!=
name|new
operator|->
name|freq
condition|)
name|changes
operator||=
name|WPA_BSS_FREQ_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
name|old
operator|->
name|level
operator|!=
name|new
operator|->
name|level
condition|)
name|changes
operator||=
name|WPA_BSS_SIGNAL_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
name|caps_diff
operator|&
name|IEEE80211_CAP_PRIVACY
condition|)
name|changes
operator||=
name|WPA_BSS_PRIVACY_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
name|caps_diff
operator|&
name|IEEE80211_CAP_IBSS
condition|)
name|changes
operator||=
name|WPA_BSS_MODE_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
name|old
operator|->
name|ie_len
operator|==
name|new
operator|->
name|ie_len
operator|&&
name|os_memcmp
argument_list|(
name|old
operator|+
literal|1
argument_list|,
name|new
operator|+
literal|1
argument_list|,
name|old
operator|->
name|ie_len
argument_list|)
operator|==
literal|0
condition|)
return|return
name|changes
return|;
name|changes
operator||=
name|WPA_BSS_IES_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
operator|!
name|are_ies_equal
argument_list|(
name|old
argument_list|,
name|new
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
condition|)
name|changes
operator||=
name|WPA_BSS_WPAIE_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
operator|!
name|are_ies_equal
argument_list|(
name|old
argument_list|,
name|new
argument_list|,
name|WLAN_EID_RSN
argument_list|)
condition|)
name|changes
operator||=
name|WPA_BSS_RSNIE_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
operator|!
name|are_ies_equal
argument_list|(
name|old
argument_list|,
name|new
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
condition|)
name|changes
operator||=
name|WPA_BSS_WPS_CHANGED_FLAG
expr_stmt|;
if|if
condition|(
operator|!
name|are_ies_equal
argument_list|(
name|old
argument_list|,
name|new
argument_list|,
name|WLAN_EID_SUPP_RATES
argument_list|)
operator|||
operator|!
name|are_ies_equal
argument_list|(
name|old
argument_list|,
name|new
argument_list|,
name|WLAN_EID_EXT_SUPP_RATES
argument_list|)
condition|)
name|changes
operator||=
name|WPA_BSS_RATES_CHANGED_FLAG
expr_stmt|;
return|return
name|changes
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|notify_bss_changes
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|changes
parameter_list|,
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_FREQ_CHANGED_FLAG
condition|)
name|wpas_notify_bss_freq_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_SIGNAL_CHANGED_FLAG
condition|)
name|wpas_notify_bss_signal_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_PRIVACY_CHANGED_FLAG
condition|)
name|wpas_notify_bss_privacy_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_MODE_CHANGED_FLAG
condition|)
name|wpas_notify_bss_mode_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_WPAIE_CHANGED_FLAG
condition|)
name|wpas_notify_bss_wpaie_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_RSNIE_CHANGED_FLAG
condition|)
name|wpas_notify_bss_rsnie_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_WPS_CHANGED_FLAG
condition|)
name|wpas_notify_bss_wps_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_IES_CHANGED_FLAG
condition|)
name|wpas_notify_bss_ies_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|changes
operator|&
name|WPA_BSS_RATES_CHANGED_FLAG
condition|)
name|wpas_notify_bss_rates_changed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_bss_update
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|)
block|{
name|u32
name|changes
decl_stmt|;
name|changes
operator|=
name|wpa_bss_compare_res
argument_list|(
name|bss
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|bss
operator|->
name|scan_miss_count
operator|=
literal|0
expr_stmt|;
name|bss
operator|->
name|last_update_idx
operator|=
name|wpa_s
operator|->
name|bss_update_idx
expr_stmt|;
name|wpa_bss_copy_res
argument_list|(
name|bss
argument_list|,
name|res
argument_list|)
expr_stmt|;
comment|/* Move the entry to the end of the list */
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|ie_len
operator|+
name|bss
operator|->
name|beacon_ie_len
operator|>=
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
condition|)
block|{
name|os_memcpy
argument_list|(
name|bss
operator|+
literal|1
argument_list|,
name|res
operator|+
literal|1
argument_list|,
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ie_len
operator|=
name|res
operator|->
name|ie_len
expr_stmt|;
name|bss
operator|->
name|beacon_ie_len
operator|=
name|res
operator|->
name|beacon_ie_len
expr_stmt|;
block|}
else|else
block|{
name|struct
name|wpa_bss
modifier|*
name|nbss
decl_stmt|;
name|struct
name|dl_list
modifier|*
name|prev
init|=
name|bss
operator|->
name|list_id
operator|.
name|prev
decl_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list_id
argument_list|)
expr_stmt|;
name|nbss
operator|=
name|os_realloc
argument_list|(
name|bss
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
operator|+
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbss
condition|)
block|{
name|bss
operator|=
name|nbss
expr_stmt|;
name|os_memcpy
argument_list|(
name|bss
operator|+
literal|1
argument_list|,
name|res
operator|+
literal|1
argument_list|,
name|res
operator|->
name|ie_len
operator|+
name|res
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
name|bss
operator|->
name|ie_len
operator|=
name|res
operator|->
name|ie_len
expr_stmt|;
name|bss
operator|->
name|beacon_ie_len
operator|=
name|res
operator|->
name|beacon_ie_len
expr_stmt|;
block|}
name|dl_list_add
argument_list|(
name|prev
argument_list|,
operator|&
name|bss
operator|->
name|list_id
argument_list|)
expr_stmt|;
block|}
name|dl_list_add_tail
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss
argument_list|,
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|notify_bss_changes
argument_list|(
name|wpa_s
argument_list|,
name|changes
argument_list|,
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_bss_in_use
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
return|return
name|bss
operator|==
name|wpa_s
operator|->
name|current_bss
operator|||
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|||
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpa_bss_update_start
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|bss_update_idx
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSS: Start scan result update %u"
argument_list|,
name|wpa_s
operator|->
name|bss_update_idx
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_bss_update_scan_res
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|ssid
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|ssid
operator|=
name|wpa_scan_get_ie
argument_list|(
name|res
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSS: No SSID IE included for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ssid
index|[
literal|1
index|]
operator|>
literal|32
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSS: Too long SSID IE included for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* TODO: add option for ignoring BSSes we are not interested in 	 * (to save memory) */
name|bss
operator|=
name|wpa_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|res
operator|->
name|bssid
argument_list|,
name|ssid
operator|+
literal|2
argument_list|,
name|ssid
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
name|wpa_bss_add
argument_list|(
name|wpa_s
argument_list|,
name|ssid
operator|+
literal|2
argument_list|,
name|ssid
index|[
literal|1
index|]
argument_list|,
name|res
argument_list|)
expr_stmt|;
else|else
name|wpa_bss_update
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_bss_included_in_scan
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|struct
name|scan_info
modifier|*
name|info
parameter_list|)
block|{
name|int
name|found
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|info
operator|->
name|num_freqs
condition|)
block|{
name|found
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|info
operator|->
name|num_freqs
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|bss
operator|->
name|freq
operator|==
name|info
operator|->
name|freqs
index|[
name|i
index|]
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
return|return
literal|0
return|;
block|}
if|if
condition|(
name|info
operator|->
name|num_ssids
condition|)
block|{
name|found
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|info
operator|->
name|num_ssids
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|struct
name|wpa_driver_scan_ssid
modifier|*
name|s
init|=
operator|&
name|info
operator|->
name|ssids
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|(
name|s
operator|->
name|ssid
operator|==
name|NULL
operator|||
name|s
operator|->
name|ssid_len
operator|==
literal|0
operator|)
operator|||
operator|(
name|s
operator|->
name|ssid_len
operator|==
name|bss
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|s
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|wpa_bss_update_end
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|scan_info
modifier|*
name|info
parameter_list|,
name|int
name|new_scan
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|n
decl_stmt|;
if|if
condition|(
operator|!
name|new_scan
condition|)
return|return;
comment|/* do not expire entries without new scan */
name|dl_list_for_each_safe
argument_list|(
argument|bss
argument_list|,
argument|n
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpa_bss_in_use
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|wpa_bss_included_in_scan
argument_list|(
name|bss
argument_list|,
name|info
argument_list|)
condition|)
continue|continue;
comment|/* expire only BSSes that were scanned */
if|if
condition|(
name|bss
operator|->
name|last_update_idx
operator|<
name|wpa_s
operator|->
name|bss_update_idx
condition|)
name|bss
operator|->
name|scan_miss_count
operator|++
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|scan_miss_count
operator|>=
name|WPA_BSS_EXPIRATION_SCAN_COUNT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSS: Expire BSS %u due to no "
literal|"match in scan"
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
name|wpa_bss_remove
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_bss_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|struct
name|os_time
name|t
decl_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss
argument_list|)
condition|)
return|return;
name|os_get_time
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
name|t
operator|.
name|sec
operator|-=
name|WPA_BSS_EXPIRATION_AGE
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|bss
argument_list|,
argument|n
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpa_bss_in_use
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|os_time_before
argument_list|(
operator|&
name|bss
operator|->
name|last_update
argument_list|,
operator|&
name|t
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"BSS: Expire BSS %u due to age"
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
name|wpa_bss_remove
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
expr_stmt|;
block|}
else|else
break|break;
block|}
name|eloop_register_timeout
argument_list|(
name|WPA_BSS_EXPIRATION_PERIOD
argument_list|,
literal|0
argument_list|,
name|wpa_bss_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpa_bss_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|dl_list_init
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss
argument_list|)
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|wpa_s
operator|->
name|bss_id
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPA_BSS_EXPIRATION_PERIOD
argument_list|,
literal|0
argument_list|,
name|wpa_bss_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpa_bss_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_bss_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|bss
operator|.
name|next
operator|==
name|NULL
condition|)
return|return;
comment|/* BSS table not yet initialized */
name|dl_list_for_each_safe
argument_list|(
argument|bss
argument_list|,
argument|n
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
name|wpa_bss_remove
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_get_bssid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|wpa_bss
modifier|*
name|wpa_bss_get_id
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|id
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|bss
operator|->
name|id
operator|==
name|id
condition|)
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|u8
modifier|*
name|wpa_bss_get_ie
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u8
name|ie
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|bss
operator|->
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|ie
condition|)
return|return
name|pos
return|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|const
name|u8
modifier|*
name|wpa_bss_get_vendor_ie
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u32
name|vendor_type
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|bss
operator|->
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|vendor_type
operator|==
name|WPA_GET_BE32
argument_list|(
operator|&
name|pos
index|[
literal|2
index|]
argument_list|)
condition|)
return|return
name|pos
return|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wpa_bss_get_vendor_ie_multi
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u32
name|vendor_type
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|bss
operator|->
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|bss
operator|->
name|ie_len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|pos
index|[
literal|1
index|]
operator|>=
literal|4
operator|&&
name|vendor_type
operator|==
name|WPA_GET_BE32
argument_list|(
operator|&
name|pos
index|[
literal|2
index|]
argument_list|)
condition|)
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|pos
operator|+
literal|2
operator|+
literal|4
argument_list|,
name|pos
index|[
literal|1
index|]
operator|-
literal|4
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
block|}
if|if
condition|(
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|=
name|NULL
expr_stmt|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
name|int
name|wpa_bss_get_max_rate
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|int
name|rate
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_SUPP_RATES
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ie
operator|&&
name|i
operator|<
name|ie
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
operator|)
operator|>
name|rate
condition|)
name|rate
operator|=
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
expr_stmt|;
block|}
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_EXT_SUPP_RATES
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ie
operator|&&
name|i
operator|<
name|ie
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|(
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
operator|)
operator|>
name|rate
condition|)
name|rate
operator|=
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
expr_stmt|;
block|}
return|return
name|rate
return|;
block|}
end_function

begin_function
name|int
name|wpa_bss_get_bit_rates
parameter_list|(
specifier|const
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u8
modifier|*
modifier|*
name|rates
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|,
modifier|*
name|ie2
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|unsigned
name|int
name|len
decl_stmt|;
name|u8
modifier|*
name|r
decl_stmt|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_SUPP_RATES
argument_list|)
expr_stmt|;
name|ie2
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_EXT_SUPP_RATES
argument_list|)
expr_stmt|;
name|len
operator|=
operator|(
name|ie
condition|?
name|ie
index|[
literal|1
index|]
else|:
literal|0
operator|)
operator|+
operator|(
name|ie2
condition|?
name|ie2
index|[
literal|1
index|]
else|:
literal|0
operator|)
expr_stmt|;
name|r
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ie
operator|&&
name|i
operator|<
name|ie
index|[
literal|1
index|]
condition|;
name|i
operator|++
control|)
name|r
index|[
name|i
index|]
operator|=
name|ie
index|[
name|i
operator|+
literal|2
index|]
operator|&
literal|0x7f
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|ie2
operator|&&
name|j
operator|<
name|ie2
index|[
literal|1
index|]
condition|;
name|j
operator|++
control|)
name|r
index|[
name|i
operator|+
name|j
index|]
operator|=
name|ie2
index|[
name|j
operator|+
literal|2
index|]
operator|&
literal|0x7f
expr_stmt|;
operator|*
name|rates
operator|=
name|r
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

end_unit


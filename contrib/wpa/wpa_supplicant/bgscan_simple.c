begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - background scan and roaming module: simple  * Copyright (c) 2009-2010, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"bgscan.h"
end_include

begin_struct
struct|struct
name|bgscan_simple_data
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
specifier|const
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|scan_interval
decl_stmt|;
name|int
name|signal_threshold
decl_stmt|;
name|int
name|short_scan_count
decl_stmt|;
comment|/* counter for scans using short scan interval */
name|int
name|max_short_scans
decl_stmt|;
comment|/* maximum times we short-scan before back-off */
name|int
name|short_interval
decl_stmt|;
comment|/* use if signal< threshold */
name|int
name|long_interval
decl_stmt|;
comment|/* use if signal> threshold */
name|struct
name|os_time
name|last_bgscan
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|bgscan_simple_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|bgscan_simple_data
modifier|*
name|data
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|data
operator|->
name|wpa_s
decl_stmt|;
name|struct
name|wpa_driver_scan_params
name|params
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|num_ssids
operator|=
literal|1
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
operator|=
name|data
operator|->
name|ssid
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
operator|=
name|data
operator|->
name|ssid
operator|->
name|ssid_len
expr_stmt|;
name|params
operator|.
name|freqs
operator|=
name|data
operator|->
name|ssid
operator|->
name|scan_freq
expr_stmt|;
comment|/* 	 * A more advanced bgscan module would learn about most like channels 	 * over time and request scans only for some channels (probing others 	 * every now and then) to reduce effect on the data connection. 	 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: Request a background scan"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_trigger_scan
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: Failed to trigger scan"
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|data
operator|->
name|scan_interval
argument_list|,
literal|0
argument_list|,
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|data
operator|->
name|scan_interval
operator|==
name|data
operator|->
name|short_interval
condition|)
block|{
name|data
operator|->
name|short_scan_count
operator|++
expr_stmt|;
comment|/* 			 * Spend at most the duration of a long scan interval 			 * scanning at the short scan interval. After that, 			 * revert to the long scan interval. 			 */
if|if
condition|(
name|data
operator|->
name|short_scan_count
operator|>
name|data
operator|->
name|max_short_scans
condition|)
block|{
name|data
operator|->
name|scan_interval
operator|=
name|data
operator|->
name|long_interval
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: Backing "
literal|"off to long scan interval"
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|short_scan_count
operator|>
literal|0
condition|)
block|{
comment|/* 			 * If we lasted a long scan interval without any 			 * CQM triggers, decrease the short-scan count, 			 * which allows 1 more short-scan interval to 			 * occur in the future when CQM triggers. 			 */
name|data
operator|->
name|short_scan_count
operator|--
expr_stmt|;
block|}
name|os_get_time
argument_list|(
operator|&
name|data
operator|->
name|last_bgscan
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|bgscan_simple_get_params
parameter_list|(
name|struct
name|bgscan_simple_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|params
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|data
operator|->
name|short_interval
operator|=
name|atoi
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|params
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|pos
operator|++
expr_stmt|;
name|data
operator|->
name|signal_threshold
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"bgscan simple: Missing scan interval "
literal|"for high signal"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|data
operator|->
name|long_interval
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|bgscan_simple_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|,
specifier|const
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|bgscan_simple_data
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|data
operator|->
name|wpa_s
operator|=
name|wpa_s
expr_stmt|;
name|data
operator|->
name|ssid
operator|=
name|ssid
expr_stmt|;
if|if
condition|(
name|bgscan_simple_get_params
argument_list|(
name|data
argument_list|,
name|params
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|data
operator|->
name|short_interval
operator|<=
literal|0
condition|)
name|data
operator|->
name|short_interval
operator|=
literal|30
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|long_interval
operator|<=
literal|0
condition|)
name|data
operator|->
name|long_interval
operator|=
literal|30
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: Signal strength threshold %d  "
literal|"Short bgscan interval %d  Long bgscan interval %d"
argument_list|,
name|data
operator|->
name|signal_threshold
argument_list|,
name|data
operator|->
name|short_interval
argument_list|,
name|data
operator|->
name|long_interval
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|signal_threshold
operator|&&
name|wpa_drv_signal_monitor
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|signal_threshold
argument_list|,
literal|4
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"bgscan simple: Failed to enable "
literal|"signal strength monitoring"
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|scan_interval
operator|=
name|data
operator|->
name|short_interval
expr_stmt|;
name|data
operator|->
name|max_short_scans
operator|=
name|data
operator|->
name|long_interval
operator|/
name|data
operator|->
name|short_interval
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|signal_threshold
condition|)
block|{
comment|/* Poll for signal info to set initial scan interval */
name|struct
name|wpa_signal_info
name|siginfo
decl_stmt|;
if|if
condition|(
name|wpa_drv_signal_poll
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|siginfo
argument_list|)
operator|==
literal|0
operator|&&
name|siginfo
operator|.
name|current_signal
operator|>=
name|data
operator|->
name|signal_threshold
condition|)
name|data
operator|->
name|scan_interval
operator|=
name|data
operator|->
name|long_interval
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: Init scan interval: %d"
argument_list|,
name|data
operator|->
name|scan_interval
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|data
operator|->
name|scan_interval
argument_list|,
literal|0
argument_list|,
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * This function is called immediately after an association, so it is 	 * reasonable to assume that a scan was completed recently. This makes 	 * us skip an immediate new scan in cases where the current signal 	 * level is below the bgscan threshold. 	 */
name|os_get_time
argument_list|(
operator|&
name|data
operator|->
name|last_bgscan
argument_list|)
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgscan_simple_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|bgscan_simple_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|signal_threshold
condition|)
name|wpa_drv_signal_monitor
argument_list|(
name|data
operator|->
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bgscan_simple_notify_scan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|struct
name|bgscan_simple_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: scan result notification"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|data
operator|->
name|scan_interval
argument_list|,
literal|0
argument_list|,
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * A more advanced bgscan could process scan results internally, select 	 * the BSS and request roam if needed. This sample uses the existing 	 * BSS/ESS selection routine. Change this to return 1 if selection is 	 * done inside the bgscan module. 	 */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgscan_simple_notify_beacon_loss
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: beacon loss"
argument_list|)
expr_stmt|;
comment|/* TODO: speed up background scanning */
block|}
end_function

begin_function
specifier|static
name|void
name|bgscan_simple_notify_signal_change
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|above
parameter_list|,
name|int
name|current_signal
parameter_list|,
name|int
name|current_noise
parameter_list|,
name|int
name|current_txrate
parameter_list|)
block|{
name|struct
name|bgscan_simple_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|int
name|scan
init|=
literal|0
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|short_interval
operator|==
name|data
operator|->
name|long_interval
operator|||
name|data
operator|->
name|signal_threshold
operator|==
literal|0
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: signal level changed "
literal|"(above=%d current_signal=%d current_noise=%d "
literal|"current_txrate=%d))"
argument_list|,
name|above
argument_list|,
name|current_signal
argument_list|,
name|current_noise
argument_list|,
name|current_txrate
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|scan_interval
operator|==
name|data
operator|->
name|long_interval
operator|&&
operator|!
name|above
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: Start using short "
literal|"bgscan interval"
argument_list|)
expr_stmt|;
name|data
operator|->
name|scan_interval
operator|=
name|data
operator|->
name|short_interval
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|.
name|sec
operator|>
name|data
operator|->
name|last_bgscan
operator|.
name|sec
operator|+
literal|1
operator|&&
name|data
operator|->
name|short_scan_count
operator|<=
name|data
operator|->
name|max_short_scans
condition|)
comment|/* 			 * If we haven't just previously (<1 second ago) 			 * performed a scan, and we haven't depleted our 			 * budget for short-scans, perform a scan 			 * immediately. 			 */
name|scan
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|data
operator|->
name|last_bgscan
operator|.
name|sec
operator|+
name|data
operator|->
name|long_interval
operator|>
name|now
operator|.
name|sec
operator|+
name|data
operator|->
name|scan_interval
condition|)
block|{
comment|/* 			 * Restart scan interval timer if currently scheduled 			 * scan is too far in the future. 			 */
name|eloop_cancel_timeout
argument_list|(
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|data
operator|->
name|scan_interval
argument_list|,
literal|0
argument_list|,
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|scan_interval
operator|==
name|data
operator|->
name|short_interval
operator|&&
name|above
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: Start using long bgscan "
literal|"interval"
argument_list|)
expr_stmt|;
name|data
operator|->
name|scan_interval
operator|=
name|data
operator|->
name|long_interval
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|data
operator|->
name|scan_interval
argument_list|,
literal|0
argument_list|,
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|above
condition|)
block|{
comment|/* 		 * Signal dropped further 4 dB. Request a new scan if we have 		 * not yet scanned in a while. 		 */
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|.
name|sec
operator|>
name|data
operator|->
name|last_bgscan
operator|.
name|sec
operator|+
literal|10
condition|)
name|scan
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|scan
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan simple: Trigger immediate scan"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|bgscan_simple_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|bgscan_ops
name|bgscan_simple_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"simple"
block|,
operator|.
name|init
operator|=
name|bgscan_simple_init
block|,
operator|.
name|deinit
operator|=
name|bgscan_simple_deinit
block|,
operator|.
name|notify_scan
operator|=
name|bgscan_simple_notify_scan
block|,
operator|.
name|notify_beacon_loss
operator|=
name|bgscan_simple_notify_beacon_loss
block|,
operator|.
name|notify_signal_change
operator|=
name|bgscan_simple_notify_signal_change
block|, }
decl_stmt|;
end_decl_stmt

end_unit


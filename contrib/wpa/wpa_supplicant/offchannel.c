begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant - Off-channel Action frame TX/RX  * Copyright (c) 2009-2010, Atheros Communications  * Copyright (c) 2011, Qualcomm Atheros  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"p2p_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"offchannel.h"
end_include

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpas_get_tx_interface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|src
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|wpa_s
return|;
comment|/* 	 * Try to find a group interface that matches with the source address. 	 */
name|iface
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
expr_stmt|;
while|while
condition|(
name|iface
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|src
argument_list|,
name|iface
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
name|iface
operator|=
name|iface
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|iface
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use group interface %s "
literal|"instead of interface %s for Action TX"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
return|return
name|iface
return|;
block|}
return|return
name|wpa_s
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_send_action_cb
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
name|int
name|res
decl_stmt|;
name|int
name|without_roc
decl_stmt|;
name|without_roc
operator|=
name|wpa_s
operator|->
name|pending_action_without_roc
expr_stmt|;
name|wpa_s
operator|->
name|pending_action_without_roc
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Send Action callback (without_roc=%d pending_action_tx=%p pending_action_tx_done=%d)"
argument_list|,
name|without_roc
argument_list|,
name|wpa_s
operator|->
name|pending_action_tx
argument_list|,
operator|!
operator|!
name|wpa_s
operator|->
name|pending_action_tx_done
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_action_tx
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|pending_action_tx_done
condition|)
return|return;
comment|/* 	 * This call is likely going to be on the P2P device instance if the 	 * driver uses a separate interface for that purpose. However, some 	 * Action frames are actually sent within a P2P Group and when that is 	 * the case, we need to follow power saving (e.g., GO buffering the 	 * frame for a client in PS mode or a client following the advertised 	 * NoA from its GO). To make that easier for the driver, select the 	 * correct group interface here. 	 */
name|iface
operator|=
name|wpas_get_tx_interface
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_action_src
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|!=
name|wpa_s
operator|->
name|pending_action_freq
operator|&&
name|wpa_s
operator|->
name|pending_action_freq
operator|!=
literal|0
operator|&&
name|wpa_s
operator|->
name|pending_action_freq
operator|!=
name|iface
operator|->
name|assoc_freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Pending Action frame TX "
literal|"waiting for another freq=%u (off_channel_freq=%u "
literal|"assoc_freq=%u)"
argument_list|,
name|wpa_s
operator|->
name|pending_action_freq
argument_list|,
name|wpa_s
operator|->
name|off_channel_freq
argument_list|,
name|iface
operator|->
name|assoc_freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|without_roc
operator|&&
name|wpa_s
operator|->
name|off_channel_freq
operator|==
literal|0
condition|)
block|{
name|unsigned
name|int
name|duration
init|=
literal|200
decl_stmt|;
comment|/* 			 * We may get here if wpas_send_action() found us to be 			 * on the correct channel, but remain-on-channel cancel 			 * event was received before getting here. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Schedule "
literal|"remain-on-channel to send Action frame"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
if|if
condition|(
name|wpa_s
operator|->
name|extra_roc_dur
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TESTING: Increase ROC duration %u -> %u"
argument_list|,
name|duration
argument_list|,
name|duration
operator|+
name|wpa_s
operator|->
name|extra_roc_dur
argument_list|)
expr_stmt|;
name|duration
operator|+=
name|wpa_s
operator|->
name|extra_roc_dur
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
if|if
condition|(
name|wpa_drv_remain_on_channel
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_action_freq
argument_list|,
name|duration
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Failed to "
literal|"request driver to remain on "
literal|"channel (%u MHz) for Action Frame "
literal|"TX"
argument_list|,
name|wpa_s
operator|->
name|pending_action_freq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
name|wpa_s
operator|->
name|pending_action_freq
expr_stmt|;
block|}
block|}
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Sending pending Action frame to "
name|MACSTR
literal|" using interface %s"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_action_dst
argument_list|)
argument_list|,
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|res
operator|=
name|wpa_drv_send_action
argument_list|(
name|iface
argument_list|,
name|wpa_s
operator|->
name|pending_action_freq
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|pending_action_dst
argument_list|,
name|wpa_s
operator|->
name|pending_action_src
argument_list|,
name|wpa_s
operator|->
name|pending_action_bssid
argument_list|,
name|wpabuf_head
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
argument_list|,
name|wpa_s
operator|->
name|pending_action_no_cck
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Failed to send the "
literal|"pending Action frame"
argument_list|)
expr_stmt|;
comment|/* 		 * Use fake TX status event to allow state machines to 		 * continue. 		 */
name|offchannel_send_action_tx_status
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_action_dst
argument_list|,
name|wpabuf_head
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
argument_list|,
name|OFFCHANNEL_SEND_ACTION_FAILED
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * offchannel_send_action_tx_status - TX status callback  * @wpa_s: Pointer to wpa_supplicant data  * @dst: Destination MAC address of the transmitted Action frame  * @data: Transmitted frame payload  * @data_len: Length of @data in bytes  * @result: TX status  *  * This function is called whenever the driver indicates a TX status event for  * a frame sent by offchannel_send_action() using wpa_drv_send_action().  */
end_comment

begin_function
name|void
name|offchannel_send_action_tx_status
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|enum
name|offchannel_send_action_result
name|result
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|pending_action_tx
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Ignore Action TX status - "
literal|"no pending operation"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|dst
argument_list|,
name|wpa_s
operator|->
name|pending_action_dst
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Ignore Action TX status - "
literal|"unknown destination address"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Accept report only if the contents of the frame matches */
if|if
condition|(
name|data_len
operator|-
name|wpabuf_len
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
operator|!=
literal|24
operator|||
name|os_memcmp
argument_list|(
name|data
operator|+
literal|24
argument_list|,
name|wpabuf_head
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Ignore Action TX status - "
literal|"mismatching contents with pending frame"
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"TX status frame data"
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"Pending TX frame"
argument_list|,
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Delete matching pending action frame"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_action_tx
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: TX status result=%d cb=%p"
argument_list|,
name|result
argument_list|,
name|wpa_s
operator|->
name|pending_action_tx_status_cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_action_tx_status_cb
condition|)
block|{
name|wpa_s
operator|->
name|pending_action_tx_status_cb
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_action_freq
argument_list|,
name|wpa_s
operator|->
name|pending_action_dst
argument_list|,
name|wpa_s
operator|->
name|pending_action_src
argument_list|,
name|wpa_s
operator|->
name|pending_action_bssid
argument_list|,
name|data
argument_list|,
name|data_len
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpa_s
operator|->
name|p2p_long_listen
operator|>
literal|0
condition|)
block|{
comment|/* Continue the listen */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Continuing long Listen state"
argument_list|)
expr_stmt|;
name|wpas_p2p_listen_start
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|p2p_long_listen
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
block|}
end_function

begin_comment
comment|/**  * offchannel_send_action - Request off-channel Action frame TX  * @wpa_s: Pointer to wpa_supplicant data  * @freq: The frequency in MHz indicating the channel on which the frame is to  *	transmitted or 0 for the current channel (only if associated)  * @dst: Action frame destination MAC address  * @src: Action frame source MAC address  * @bssid: Action frame BSSID  * @buf: Frame to transmit starting from the Category field  * @len: Length of @buf in bytes  * @wait_time: Wait time for response in milliseconds  * @tx_cb: Callback function for indicating TX status or %NULL for now callback  * @no_cck: Whether CCK rates are to be disallowed for TX rate selection  * Returns: 0 on success or -1 on failure  *  * This function is used to request an Action frame to be transmitted on the  * current operating channel or on another channel (off-channel). The actual  * frame transmission will be delayed until the driver is ready on the specified  * channel. The @wait_time parameter can be used to request the driver to remain  * awake on the channel to wait for a response.  */
end_comment

begin_function
name|int
name|offchannel_send_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|unsigned
name|int
name|wait_time
parameter_list|,
name|void
function_decl|(
modifier|*
name|tx_cb
function_decl|)
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|enum
name|offchannel_send_action_result
name|result
parameter_list|)
parameter_list|,
name|int
name|no_cck
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Send action frame: freq=%d dst="
name|MACSTR
literal|" src="
name|MACSTR
literal|" bssid="
name|MACSTR
literal|" len=%d"
argument_list|,
name|freq
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|src
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|,
operator|(
name|int
operator|)
name|len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_action_tx_status_cb
operator|=
name|tx_cb
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_action_tx
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Dropped pending Action "
literal|"frame TX to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_action_dst
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|pending_action_tx_done
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|pending_action_tx
operator|=
name|wpabuf_alloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_action_tx
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Failed to allocate Action "
literal|"frame TX buffer (len=%llu)"
argument_list|,
operator|(
name|unsigned
name|long
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_put_data
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_action_src
argument_list|,
name|src
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_action_dst
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_action_bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_action_freq
operator|=
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|pending_action_no_cck
operator|=
name|no_cck
expr_stmt|;
if|if
condition|(
name|freq
operator|!=
literal|0
operator|&&
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_OFFCHANNEL_TX
condition|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|iface
operator|=
name|wpas_get_tx_interface
argument_list|(
name|wpa_s
argument_list|,
name|src
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|action_tx_wait_time
operator|=
name|wait_time
expr_stmt|;
name|ret
operator|=
name|wpa_drv_send_action
argument_list|(
name|iface
argument_list|,
name|wpa_s
operator|->
name|pending_action_freq
argument_list|,
name|wait_time
argument_list|,
name|wpa_s
operator|->
name|pending_action_dst
argument_list|,
name|wpa_s
operator|->
name|pending_action_src
argument_list|,
name|wpa_s
operator|->
name|pending_action_bssid
argument_list|,
name|wpabuf_head
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
argument_list|,
name|wpa_s
operator|->
name|pending_action_no_cck
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|wpa_s
operator|->
name|pending_action_tx_done
operator|=
literal|1
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|freq
condition|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|tx_iface
decl_stmt|;
name|tx_iface
operator|=
name|wpas_get_tx_interface
argument_list|(
name|wpa_s
argument_list|,
name|src
argument_list|)
expr_stmt|;
if|if
condition|(
name|tx_iface
operator|->
name|assoc_freq
operator|==
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Already on "
literal|"requested channel (TX interface operating "
literal|"channel)"
argument_list|)
expr_stmt|;
name|freq
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|==
name|freq
operator|||
name|freq
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Already on requested "
literal|"channel; send Action frame immediately"
argument_list|)
expr_stmt|;
comment|/* TODO: Would there ever be need to extend the current 		 * duration on the channel? */
name|wpa_s
operator|->
name|pending_action_without_roc
operator|=
literal|1
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_send_action_cb
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|wpas_send_action_cb
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_s
operator|->
name|pending_action_without_roc
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|==
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Already waiting for "
literal|"driver to get to frequency %u MHz; continue "
literal|"waiting to send the Action frame"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Schedule Action frame to be "
literal|"transmitted once the driver gets to the requested "
literal|"channel"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wait_time
operator|>
name|wpa_s
operator|->
name|max_remain_on_chan
condition|)
name|wait_time
operator|=
name|wpa_s
operator|->
name|max_remain_on_chan
expr_stmt|;
elseif|else
if|if
condition|(
name|wait_time
operator|==
literal|0
condition|)
name|wait_time
operator|=
literal|20
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
if|if
condition|(
name|wpa_s
operator|->
name|extra_roc_dur
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TESTING: Increase ROC duration %u -> %u"
argument_list|,
name|wait_time
argument_list|,
name|wait_time
operator|+
name|wpa_s
operator|->
name|extra_roc_dur
argument_list|)
expr_stmt|;
name|wait_time
operator|+=
name|wpa_s
operator|->
name|extra_roc_dur
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
if|if
condition|(
name|wpa_drv_remain_on_channel
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|wait_time
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Failed to request driver "
literal|"to remain on channel (%u MHz) for Action "
literal|"Frame TX"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
name|freq
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * offchannel_send_send_action_done - Notify completion of Action frame sequence  * @wpa_s: Pointer to wpa_supplicant data  *  * This function can be used to cancel a wait for additional response frames on  * the channel that was used with offchannel_send_action().  */
end_comment

begin_function
name|void
name|offchannel_send_action_done
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Off-channel: Action frame sequence done notification: pending_action_tx=%p drv_offchan_tx=%d action_tx_wait_time=%d off_channel_freq=%d roc_waiting_drv_freq=%d"
argument_list|,
name|wpa_s
operator|->
name|pending_action_tx
argument_list|,
operator|!
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_OFFCHANNEL_TX
operator|)
argument_list|,
name|wpa_s
operator|->
name|action_tx_wait_time
argument_list|,
name|wpa_s
operator|->
name|off_channel_freq
argument_list|,
name|wpa_s
operator|->
name|roc_waiting_drv_freq
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_action_tx
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_OFFCHANNEL_TX
operator|&&
name|wpa_s
operator|->
name|action_tx_wait_time
condition|)
name|wpa_drv_send_action_cancel_wait
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|||
name|wpa_s
operator|->
name|roc_waiting_drv_freq
condition|)
block|{
name|wpa_drv_cancel_remain_on_channel
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * offchannel_remain_on_channel_cb - Remain-on-channel callback function  * @wpa_s: Pointer to wpa_supplicant data  * @freq: Frequency (in MHz) of the selected channel  * @duration: Duration of the remain-on-channel operation in milliseconds  *  * This function is called whenever the driver notifies beginning of a  * remain-on-channel operation.  */
end_comment

begin_function
name|void
name|offchannel_remain_on_channel_cb
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|duration
parameter_list|)
block|{
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|off_channel_freq
operator|=
name|freq
expr_stmt|;
name|wpas_send_action_cb
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * offchannel_cancel_remain_on_channel_cb - Remain-on-channel stopped callback  * @wpa_s: Pointer to wpa_supplicant data  * @freq: Frequency (in MHz) of the selected channel  *  * This function is called whenever the driver notifies termination of a  * remain-on-channel operation.  */
end_comment

begin_function
name|void
name|offchannel_cancel_remain_on_channel_cb
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|)
block|{
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * offchannel_pending_action_tx - Check whether there is a pending Action TX  * @wpa_s: Pointer to wpa_supplicant data  * Returns: Pointer to pending frame or %NULL if no pending operation  *  * This function can be used to check whether there is a pending Action frame TX  * operation. The returned pointer should be used only for checking whether it  * is %NULL (no pending frame) or to print the pointer value in debug  * information (i.e., the pointer should not be dereferenced).  */
end_comment

begin_function
specifier|const
name|void
modifier|*
name|offchannel_pending_action_tx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
return|return
name|wpa_s
operator|->
name|pending_action_tx
return|;
block|}
end_function

begin_comment
comment|/**  * offchannel_clear_pending_action_tx - Clear pending Action frame TX  * @wpa_s: Pointer to wpa_supplicant data  */
end_comment

begin_function
name|void
name|offchannel_clear_pending_action_tx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|pending_action_tx
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_action_tx
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * offchannel_deinit - Deinit off-channel operations  * @wpa_s: Pointer to wpa_supplicant data  *  * This function is used to free up any allocated resources for off-channel  * operations.  */
end_comment

begin_function
name|void
name|offchannel_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|offchannel_clear_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_send_action_cb
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - Driver event processing  * Copyright (c) 2003-2012, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"pcsc_funcs.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/preauth.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/pmksa_cache.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"p2p/p2p.h"
end_include

begin_include
include|#
directive|include
file|"wnm_sta.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"blacklist.h"
end_include

begin_include
include|#
directive|include
file|"wpas_glue.h"
end_include

begin_include
include|#
directive|include
file|"wps_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"ibss_rsn.h"
end_include

begin_include
include|#
directive|include
file|"sme.h"
end_include

begin_include
include|#
directive|include
file|"gas_query.h"
end_include

begin_include
include|#
directive|include
file|"p2p_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"bgscan.h"
end_include

begin_include
include|#
directive|include
file|"autoscan.h"
end_include

begin_include
include|#
directive|include
file|"ap.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"offchannel.h"
end_include

begin_include
include|#
directive|include
file|"interworking.h"
end_include

begin_function
specifier|static
name|int
name|wpas_temp_disabled
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|os_time
name|now
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|disabled_until
operator|.
name|sec
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|disabled_until
operator|.
name|sec
operator|>
name|now
operator|.
name|sec
condition|)
return|return
name|ssid
operator|->
name|disabled_until
operator|.
name|sec
operator|-
name|now
operator|.
name|sec
return|;
name|wpas_clear_temp_disabled
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_select_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|old_ssid
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
operator|&&
name|wpa_s
operator|->
name|current_ssid
condition|)
return|return
literal|0
return|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Select network based on association "
literal|"information"
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_supplicant_get_ssid
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"No network configuration found for the current AP"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpas_network_disabled
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Selected network is disabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|disallowed_bssid
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
operator|||
name|disallowed_ssid
argument_list|(
name|wpa_s
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Selected BSS is disallowed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res
operator|=
name|wpas_temp_disabled
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Selected network is temporarily "
literal|"disabled for %d second(s)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Network configuration found for the "
literal|"current AP"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_key_mgmt_wpa_any
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
name|u8
name|wpa_ie
index|[
literal|80
index|]
decl_stmt|;
name|size_t
name|wpa_ie_len
init|=
sizeof|sizeof
argument_list|(
name|wpa_ie
argument_list|)
decl_stmt|;
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|,
name|wpa_ie
argument_list|,
operator|&
name|wpa_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|!=
name|ssid
condition|)
name|eapol_sm_invalidate_cached_session
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
name|old_ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_supplicant_rsn_supp_set_config
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_initiate_eapol
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_ssid
operator|!=
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpas_notify_network_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_stop_countermeasures
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|countermeasures
condition|)
block|{
name|wpa_s
operator|->
name|countermeasures
operator|=
literal|0
expr_stmt|;
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: TKIP countermeasures stopped"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpa_supplicant_mark_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|bssid_changed
decl_stmt|;
name|wnm_bss_keep_alive_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
name|ibss_rsn_deinit
argument_list|(
name|wpa_s
operator|->
name|ibss_rsn
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ibss_rsn
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
ifdef|#
directive|ifdef
name|CONFIG_AP
name|wpa_supplicant_ap_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_INTERFACE_DISABLED
condition|)
return|return;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
name|bssid_changed
operator|=
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_SME
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid_set
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SME */
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|go_dev_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|wpa_s
operator|->
name|current_bss
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|assoc_freq
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
ifdef|#
directive|ifdef
name|CONFIG_SME
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
condition|)
name|sme_update_ft_ies
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SME */
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
if|if
condition|(
name|bssid_changed
condition|)
name|wpas_notify_bssid_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
condition|)
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ap_ies_from_associnfo
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|key_mgmt
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|wnmsleep_used
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_find_assoc_pmkid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|pmksa_set
init|=
operator|-
literal|1
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|wpa_sm_parse_own_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
operator|&
name|ie
argument_list|)
operator|<
literal|0
operator|||
name|ie
operator|.
name|pmkid
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ie
operator|.
name|num_pmkid
condition|;
name|i
operator|++
control|)
block|{
name|pmksa_set
operator|=
name|pmksa_cache_set_current
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ie
operator|.
name|pmkid
operator|+
name|i
operator|*
name|PMKID_LEN
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pmksa_set
operator|==
literal|0
condition|)
block|{
name|eapol_sm_notify_pmkid_attempt
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKID from assoc IE %sfound from "
literal|"PMKSA cache"
argument_list|,
name|pmksa_set
operator|==
literal|0
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_pmkid_candidate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: No data in PMKID candidate "
literal|"event"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"RSN: PMKID candidate event - bssid="
name|MACSTR
literal|" index=%d preauth=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|pmkid_candidate
operator|.
name|bssid
argument_list|)
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|index
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|preauth
argument_list|)
expr_stmt|;
name|pmksa_candidate_add
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|bssid
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|index
argument_list|,
name|data
operator|->
name|pmkid_candidate
operator|.
name|preauth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_dynamic_keys
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
return|return
literal|0
return|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
operator|!
operator|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|eapol_flags
operator|&
operator|(
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
operator||
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
operator|)
operator|)
condition|)
block|{
comment|/* IEEE 802.1X, but not using dynamic WEP keys (i.e., either 		 * plaintext or static WEP keys). */
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wpa_supplicant_scard_init - Initialize SIM/USIM access with PC/SC  * @wpa_s: pointer to wpa_supplicant data  * @ssid: Configuration data for the network  * Returns: 0 on success, -1 on failure  *  * This function is called when starting authentication with a network that is  * configured to use PC/SC for SIM/USIM access (EAP-SIM or EAP-AKA).  */
end_comment

begin_function
name|int
name|wpa_supplicant_scard_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
ifdef|#
directive|ifdef
name|PCSC_FUNCS
name|int
name|aka
init|=
literal|0
decl_stmt|,
name|sim
init|=
literal|0
decl_stmt|,
name|type
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|eap
operator|.
name|pcsc
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|scard
operator|!=
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
operator|==
name|NULL
condition|)
block|{
name|sim
operator|=
literal|1
expr_stmt|;
name|aka
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|struct
name|eap_method_type
modifier|*
name|eap
init|=
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
decl_stmt|;
while|while
condition|(
name|eap
operator|->
name|vendor
operator|!=
name|EAP_VENDOR_IETF
operator|||
name|eap
operator|->
name|method
operator|!=
name|EAP_TYPE_NONE
condition|)
block|{
if|if
condition|(
name|eap
operator|->
name|vendor
operator|==
name|EAP_VENDOR_IETF
condition|)
block|{
if|if
condition|(
name|eap
operator|->
name|method
operator|==
name|EAP_TYPE_SIM
condition|)
name|sim
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|eap
operator|->
name|method
operator|==
name|EAP_TYPE_AKA
operator|||
name|eap
operator|->
name|method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
name|aka
operator|=
literal|1
expr_stmt|;
block|}
name|eap
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|eap_peer_get_eap_method
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_SIM
argument_list|)
operator|==
name|NULL
condition|)
name|sim
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|eap_peer_get_eap_method
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_AKA
argument_list|)
operator|==
name|NULL
operator|&&
name|eap_peer_get_eap_method
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_AKA_PRIME
argument_list|)
operator|==
name|NULL
condition|)
name|aka
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|sim
operator|&&
operator|!
name|aka
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Selected network is configured to "
literal|"use SIM, but neither EAP-SIM nor EAP-AKA are "
literal|"enabled"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Selected network is configured to use SIM "
literal|"(sim=%d aka=%d) - initialize PCSC"
argument_list|,
name|sim
argument_list|,
name|aka
argument_list|)
expr_stmt|;
if|if
condition|(
name|sim
operator|&&
name|aka
condition|)
name|type
operator|=
name|SCARD_TRY_BOTH
expr_stmt|;
elseif|else
if|if
condition|(
name|aka
condition|)
name|type
operator|=
name|SCARD_USIM_ONLY
expr_stmt|;
else|else
name|type
operator|=
name|SCARD_GSM_SIM_ONLY
expr_stmt|;
name|wpa_s
operator|->
name|scard
operator|=
name|scard_init
argument_list|(
name|type
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|scard
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"Failed to initialize SIM "
literal|"(pcsc-lite)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_sm_set_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|eapol_sm_register_scard_ctx
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* PCSC_FUNCS */
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
return|return
literal|0
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|CONFIG_NO_SCAN_PROCESSING
end_ifndef

begin_function
specifier|static
name|int
name|wpa_supplicant_match_privacy
parameter_list|(
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|privacy
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mixed_cell
condition|)
return|return
literal|1
return|;
ifdef|#
directive|ifdef
name|CONFIG_WPS
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
condition|)
return|return
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
condition|)
block|{
name|privacy
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
operator|&&
name|ssid
operator|->
name|eapol_flags
operator|&
operator|(
name|EAPOL_FLAG_REQUIRE_KEY_UNICAST
operator||
name|EAPOL_FLAG_REQUIRE_KEY_BROADCAST
operator|)
condition|)
name|privacy
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
if|if
condition|(
name|wpa_key_mgmt_wpa
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
name|privacy
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|caps
operator|&
name|IEEE80211_CAP_PRIVACY
condition|)
return|return
name|privacy
return|;
return|return
operator|!
name|privacy
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_ssid_bss_match
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_ie_data
name|ie
decl_stmt|;
name|int
name|proto_match
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|rsn_ie
decl_stmt|,
modifier|*
name|wpa_ie
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|wep_ok
decl_stmt|;
name|ret
operator|=
name|wpas_wps_ssid_bss_match
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>=
literal|0
condition|)
return|return
name|ret
return|;
comment|/* Allow TSN if local configuration accepts WEP use without WPA/WPA2 */
name|wep_ok
operator|=
operator|!
name|wpa_key_mgmt_wpa
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
operator|&&
operator|(
operator|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_NONE
operator|)
operator|&&
name|ssid
operator|->
name|wep_key_len
index|[
name|ssid
operator|->
name|wep_tx_keyidx
index|]
operator|>
literal|0
operator|)
operator|||
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
operator|)
expr_stmt|;
name|rsn_ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
operator|&&
name|rsn_ie
condition|)
block|{
name|proto_match
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_parse_wpa_ie
argument_list|(
name|rsn_ie
argument_list|,
literal|2
operator|+
name|rsn_ie
index|[
literal|1
index|]
argument_list|,
operator|&
name|ie
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - parse "
literal|"failed"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wep_ok
operator|&&
operator|(
name|ie
operator|.
name|group_cipher
operator|&
operator|(
name|WPA_CIPHER_WEP40
operator||
name|WPA_CIPHER_WEP104
operator|)
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   selected based on TSN "
literal|"in RSN IE"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|proto
operator|&
name|ssid
operator|->
name|proto
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - proto "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - PTK "
literal|"cipher mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - GTK "
literal|"cipher mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - key mgmt "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|capabilities
operator|&
name|WPA_CAPABILITY_MFPC
operator|)
operator|&&
operator|(
name|ssid
operator|->
name|ieee80211w
operator|==
name|MGMT_FRAME_PROTECTION_DEFAULT
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|pmf
else|:
name|ssid
operator|->
name|ieee80211w
operator|)
operator|==
name|MGMT_FRAME_PROTECTION_REQUIRED
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip RSN IE - no mgmt "
literal|"frame protection"
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   selected based on RSN IE"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|wpa_ie
operator|=
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_WPA
operator|)
operator|&&
name|wpa_ie
condition|)
block|{
name|proto_match
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_parse_wpa_ie
argument_list|(
name|wpa_ie
argument_list|,
literal|2
operator|+
name|wpa_ie
index|[
literal|1
index|]
argument_list|,
operator|&
name|ie
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip WPA IE - parse "
literal|"failed"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wep_ok
operator|&&
operator|(
name|ie
operator|.
name|group_cipher
operator|&
operator|(
name|WPA_CIPHER_WEP40
operator||
name|WPA_CIPHER_WEP104
operator|)
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   selected based on TSN "
literal|"in WPA IE"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|proto
operator|&
name|ssid
operator|->
name|proto
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip WPA IE - proto "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|pairwise_cipher
operator|&
name|ssid
operator|->
name|pairwise_cipher
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip WPA IE - PTK "
literal|"cipher mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|group_cipher
operator|&
name|ssid
operator|->
name|group_cipher
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip WPA IE - GTK "
literal|"cipher mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
operator|(
name|ie
operator|.
name|key_mgmt
operator|&
name|ssid
operator|->
name|key_mgmt
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip WPA IE - key mgmt "
literal|"mismatch"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   selected based on WPA IE"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
operator|&&
operator|!
name|wpa_ie
operator|&&
operator|!
name|rsn_ie
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   allow for non-WPA IEEE 802.1X"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|(
name|ssid
operator|->
name|proto
operator|&
operator|(
name|WPA_PROTO_WPA
operator||
name|WPA_PROTO_RSN
operator|)
operator|)
operator|&&
name|wpa_key_mgmt_wpa
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
operator|&&
name|proto_match
operator|==
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - no WPA/RSN proto match"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|wpa_key_mgmt_wpa
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   allow in non-WPA/WPA2"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   reject due to mismatch with "
literal|"WPA/WPA2"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|freq_allowed
parameter_list|(
name|int
modifier|*
name|freqs
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|freqs
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|freqs
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|freqs
index|[
name|i
index|]
operator|==
name|freq
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ht_supported
parameter_list|(
specifier|const
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|mode
operator|->
name|flags
operator|&
name|HOSTAPD_MODE_FLAG_HT_INFO_KNOWN
operator|)
condition|)
block|{
comment|/* 		 * The driver did not indicate whether it supports HT. Assume 		 * it does to avoid connection issues. 		 */
return|return
literal|1
return|;
block|}
comment|/* 	 * IEEE Std 802.11n-2009 20.1.1: 	 * An HT non-AP STA shall support all EQM rates for one spatial stream. 	 */
return|return
name|mode
operator|->
name|mcs_set
index|[
literal|0
index|]
operator|==
literal|0xff
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|rate_match
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
specifier|const
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
init|=
name|NULL
decl_stmt|,
modifier|*
name|modes
decl_stmt|;
specifier|const
name|u8
name|scan_ie
index|[
literal|2
index|]
init|=
block|{
name|WLAN_EID_SUPP_RATES
block|,
name|WLAN_EID_EXT_SUPP_RATES
block|}
decl_stmt|;
specifier|const
name|u8
modifier|*
name|rate_ie
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
name|k
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|freq
operator|==
literal|0
condition|)
return|return
literal|1
return|;
comment|/* Cannot do matching without knowing band */
name|modes
operator|=
name|wpa_s
operator|->
name|hw
operator|.
name|modes
expr_stmt|;
if|if
condition|(
name|modes
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * The driver does not provide any additional information 		 * about the utilized hardware, so allow the connection attempt 		 * to continue. 		 */
return|return
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|modes
index|[
name|i
index|]
operator|.
name|num_channels
condition|;
name|j
operator|++
control|)
block|{
name|int
name|freq
init|=
name|modes
index|[
name|i
index|]
operator|.
name|channels
index|[
name|j
index|]
operator|.
name|freq
decl_stmt|;
if|if
condition|(
name|freq
operator|==
name|bss
operator|->
name|freq
condition|)
block|{
if|if
condition|(
name|mode
operator|&&
name|mode
operator|->
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211G
condition|)
break|break;
comment|/* do not allow 802.11b replace 						* 802.11g */
name|mode
operator|=
operator|&
name|modes
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
block|}
if|if
condition|(
name|mode
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|scan_ie
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|rate_ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|scan_ie
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|rate_ie
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
name|j
operator|=
literal|2
init|;
name|j
operator|<
name|rate_ie
index|[
literal|1
index|]
operator|+
literal|2
condition|;
name|j
operator|++
control|)
block|{
name|int
name|flagged
init|=
operator|!
operator|!
operator|(
name|rate_ie
index|[
name|j
index|]
operator|&
literal|0x80
operator|)
decl_stmt|;
name|int
name|r
init|=
operator|(
name|rate_ie
index|[
name|j
index|]
operator|&
literal|0x7f
operator|)
operator|*
literal|5
decl_stmt|;
comment|/* 			 * IEEE Std 802.11n-2009 7.3.2.2: 			 * The new BSS Membership selector value is encoded 			 * like a legacy basic rate, but it is not a rate and 			 * only indicates if the BSS members are required to 			 * support the mandatory features of Clause 20 [HT PHY] 			 * in order to join the BSS. 			 */
if|if
condition|(
name|flagged
operator|&&
operator|(
operator|(
name|rate_ie
index|[
name|j
index|]
operator|&
literal|0x7f
operator|)
operator|==
name|BSS_MEMBERSHIP_SELECTOR_HT_PHY
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|ht_supported
argument_list|(
name|mode
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   hardware does not support "
literal|"HT PHY"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
continue|continue;
block|}
if|if
condition|(
operator|!
name|flagged
condition|)
continue|continue;
comment|/* check for legacy basic rates */
for|for
control|(
name|k
operator|=
literal|0
init|;
name|k
operator|<
name|mode
operator|->
name|num_rates
condition|;
name|k
operator|++
control|)
block|{
if|if
condition|(
name|mode
operator|->
name|rates
index|[
name|k
index|]
operator|==
name|r
condition|)
break|break;
block|}
if|if
condition|(
name|k
operator|==
name|mode
operator|->
name|num_rates
condition|)
block|{
comment|/* 				 * IEEE Std 802.11-2007 7.3.2.2 demands that in 				 * order to join a BSS all required rates 				 * have to be supported by the hardware. 				 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   hardware does "
literal|"not support required rate %d.%d Mbps"
argument_list|,
name|r
operator|/
literal|10
argument_list|,
name|r
operator|%
literal|10
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|wpa_scan_res_match
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|i
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|group
parameter_list|)
block|{
name|u8
name|wpa_ie_len
decl_stmt|,
name|rsn_ie_len
decl_stmt|;
name|int
name|wpa
decl_stmt|;
name|struct
name|wpa_blacklist
modifier|*
name|e
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|ie
operator|=
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|wpa_ie_len
operator|=
name|ie
condition|?
name|ie
index|[
literal|1
index|]
else|:
literal|0
expr_stmt|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
name|rsn_ie_len
operator|=
name|ie
condition|?
name|ie
index|[
literal|1
index|]
else|:
literal|0
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"%d: "
name|MACSTR
literal|" ssid='%s' "
literal|"wpa_ie_len=%u rsn_ie_len=%u caps=0x%x level=%d%s"
argument_list|,
name|i
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
argument_list|,
name|wpa_ie_len
argument_list|,
name|rsn_ie_len
argument_list|,
name|bss
operator|->
name|caps
argument_list|,
name|bss
operator|->
name|level
argument_list|,
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
condition|?
literal|" wps"
else|:
literal|""
argument_list|)
expr_stmt|;
name|e
operator|=
name|wpa_blacklist_get
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|e
condition|)
block|{
name|int
name|limit
init|=
literal|1
decl_stmt|;
if|if
condition|(
name|wpa_supplicant_enabled_networks
argument_list|(
name|wpa_s
argument_list|)
operator|==
literal|1
condition|)
block|{
comment|/* 			 * When only a single network is enabled, we can 			 * trigger blacklisting on the first failure. This 			 * should not be done with multiple enabled networks to 			 * avoid getting forced to move into a worse ESS on 			 * single error if there are no other BSSes of the 			 * current ESS. 			 */
name|limit
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|e
operator|->
name|count
operator|>
name|limit
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - blacklisted "
literal|"(count=%d limit=%d)"
argument_list|,
name|e
operator|->
name|count
argument_list|,
name|limit
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
name|bss
operator|->
name|ssid_len
operator|==
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - SSID not known"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|disallowed_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - BSSID disallowed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|disallowed_ssid
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - SSID disallowed"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa
operator|=
name|wpa_ie_len
operator|>
literal|0
operator|||
name|rsn_ie_len
operator|>
literal|0
expr_stmt|;
for|for
control|(
name|ssid
operator|=
name|group
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|pnext
control|)
block|{
name|int
name|check_ssid
init|=
name|wpa
condition|?
literal|1
else|:
operator|(
name|ssid
operator|->
name|ssid_len
operator|!=
literal|0
operator|)
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|wpas_network_disabled
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - disabled"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|res
operator|=
name|wpas_temp_disabled
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - disabled "
literal|"temporarily for %d second(s)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
operator|&&
name|e
operator|&&
name|e
operator|->
name|count
operator|>
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - blacklisted "
literal|"(WPS)"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|wpa
operator|&&
name|ssid
operator|->
name|ssid_len
operator|==
literal|0
operator|&&
name|wpas_wps_ssid_wildcard_ok
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bss
argument_list|)
condition|)
name|check_ssid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|wpa
operator|&&
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
condition|)
block|{
comment|/* Only allow wildcard SSID match if an AP 			 * advertises active WPS operation that matches 			 * with our mode. */
name|check_ssid
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid_len
operator|==
literal|0
operator|&&
name|wpas_wps_ssid_wildcard_ok
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bss
argument_list|)
condition|)
name|check_ssid
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS */
if|if
condition|(
name|ssid
operator|->
name|bssid_set
operator|&&
name|ssid
operator|->
name|ssid_len
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|ssid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
name|check_ssid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|check_ssid
operator|&&
operator|(
name|bss
operator|->
name|ssid_len
operator|!=
name|ssid
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - SSID mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ssid
operator|->
name|bssid_set
operator|&&
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|ssid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - BSSID mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|wpa_supplicant_ssid_bss_match
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|wpa
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_NONE
operator|)
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - non-WPA network "
literal|"not allowed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|wpa_supplicant_match_privacy
argument_list|(
name|bss
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - privacy "
literal|"mismatch"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|bss
operator|->
name|caps
operator|&
name|IEEE80211_CAP_IBSS
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - IBSS (adhoc) "
literal|"network"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|freq_allowed
argument_list|(
name|ssid
operator|->
name|freq_list
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - frequency not "
literal|"allowed"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|rate_match
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   skip - rate sets do "
literal|"not match"
argument_list|)
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|CONFIG_P2P
comment|/* 		 * TODO: skip the AP if its P2P IE has Group Formation 		 * bit set in the P2P Group Capability Bitmap and we 		 * are not in Group Formation with that device. 		 */
endif|#
directive|endif
comment|/* CONFIG_P2P */
comment|/* Matching configuration found */
return|return
name|ssid
return|;
block|}
comment|/* No matching configuration found */
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_bss
modifier|*
name|wpa_supplicant_select_bss
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|group
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
modifier|*
name|selected_ssid
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Selecting BSS from priority group %d"
argument_list|,
name|group
operator|->
name|priority
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|last_scan_res_used
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
init|=
name|wpa_s
operator|->
name|last_scan_res
index|[
name|i
index|]
decl_stmt|;
operator|*
name|selected_ssid
operator|=
name|wpa_scan_res_match
argument_list|(
name|wpa_s
argument_list|,
name|i
argument_list|,
name|bss
argument_list|,
name|group
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|selected_ssid
condition|)
continue|continue;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"   selected BSS "
name|MACSTR
literal|" ssid='%s'"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_bss
modifier|*
name|wpa_supplicant_pick_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
modifier|*
name|selected_ssid
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|selected
init|=
name|NULL
decl_stmt|;
name|int
name|prio
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|last_scan_res
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|last_scan_res_used
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
comment|/* no scan results from last update */
while|while
condition|(
name|selected
operator|==
name|NULL
condition|)
block|{
for|for
control|(
name|prio
operator|=
literal|0
init|;
name|prio
operator|<
name|wpa_s
operator|->
name|conf
operator|->
name|num_prio
condition|;
name|prio
operator|++
control|)
block|{
name|selected
operator|=
name|wpa_supplicant_select_bss
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|pssid
index|[
name|prio
index|]
argument_list|,
name|selected_ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|selected
condition|)
break|break;
block|}
if|if
condition|(
name|selected
operator|==
name|NULL
operator|&&
name|wpa_s
operator|->
name|blacklist
operator|&&
operator|!
name|wpa_s
operator|->
name|countermeasures
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"No APs found - clear "
literal|"blacklist and try again"
argument_list|)
expr_stmt|;
name|wpa_blacklist_clear
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|blacklist_cleared
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|selected
operator|==
name|NULL
condition|)
break|break;
block|}
return|return
name|selected
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_req_new_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|timeout_sec
parameter_list|,
name|int
name|timeout_usec
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_supplicant_enabled_networks
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
comment|/* 		 * No networks are enabled; short-circuit request so 		 * we don't wait timeout seconds before transitioning 		 * to INACTIVE state. 		 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Short-circuit new scan request "
literal|"since there are no enabled networks"
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_INACTIVE
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpa_s
operator|->
name|sta_scan_pending
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
return|return;
block|}
name|wpa_s
operator|->
name|scan_for_connection
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|timeout_sec
argument_list|,
name|timeout_usec
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpa_supplicant_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|selected
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
if|if
condition|(
name|wpas_wps_scan_pbc_overlap
argument_list|(
name|wpa_s
argument_list|,
name|selected
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_OVERLAP
literal|"PBC session overlap"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpas_p2p_notif_pbc_overlap
argument_list|(
name|wpa_s
argument_list|)
operator|==
literal|1
condition|)
return|return
operator|-
literal|1
return|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
ifdef|#
directive|ifdef
name|CONFIG_WPS
name|wpas_wps_cancel
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * Do not trigger new association unless the BSSID has changed or if 	 * reassociation is requested. If we are in process of associating with 	 * the selected BSSID, do not trigger new attempt. 	 */
if|if
condition|(
name|wpa_s
operator|->
name|reassociate
operator|||
operator|(
name|os_memcmp
argument_list|(
name|selected
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
operator|(
operator|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_ASSOCIATING
operator|&&
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_AUTHENTICATING
operator|)
operator|||
name|os_memcmp
argument_list|(
name|selected
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|wpa_supplicant_scard_init
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_supplicant_req_new_scan
argument_list|(
name|wpa_s
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Request association: "
literal|"reassociate: %d  selected: "
name|MACSTR
literal|"  bssid: "
name|MACSTR
literal|"  pending: "
name|MACSTR
literal|"  wpa_state: %s"
argument_list|,
name|wpa_s
operator|->
name|reassociate
argument_list|,
name|MAC2STR
argument_list|(
name|selected
operator|->
name|bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
argument_list|,
name|wpa_supplicant_state_txt
argument_list|(
name|wpa_s
operator|->
name|wpa_state
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_associate
argument_list|(
name|wpa_s
argument_list|,
name|selected
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Already associated with the "
literal|"selected AP"
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|wpa_supplicant_pick_new_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|prio
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
for|for
control|(
name|prio
operator|=
literal|0
init|;
name|prio
operator|<
name|wpa_s
operator|->
name|conf
operator|->
name|num_prio
condition|;
name|prio
operator|++
control|)
block|{
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|pssid
index|[
name|prio
index|]
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|pnext
control|)
block|{
if|if
condition|(
name|wpas_network_disabled
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|IEEE80211_MODE_IBSS
operator|||
name|ssid
operator|->
name|mode
operator|==
name|IEEE80211_MODE_AP
condition|)
return|return
name|ssid
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* TODO: move the rsn_preauth_scan_result*() to be called from notify.c based  * on BSS added and BSS changed events */
end_comment

begin_function
specifier|static
name|void
name|wpa_supplicant_rsn_preauth_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
if|if
condition|(
name|rsn_preauth_scan_results
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
operator|<
literal|0
condition|)
return|return;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
specifier|const
name|u8
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|rsn
decl_stmt|;
name|ssid
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
continue|continue;
name|rsn
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsn
operator|==
name|NULL
condition|)
continue|continue;
name|rsn_preauth_scan_result
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ssid
argument_list|,
name|rsn
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_need_to_roam
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|selected
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|current_bss
init|=
name|NULL
decl_stmt|;
name|int
name|min_diff
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|reassociate
condition|)
return|return
literal|1
return|;
comment|/* explicit request to reassociate */
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
condition|)
return|return
literal|1
return|;
comment|/* we are not associated; continue */
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
comment|/* unknown current SSID */
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|!=
name|ssid
condition|)
return|return
literal|1
return|;
comment|/* different network block */
if|if
condition|(
name|wpas_driver_bss_selection
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Driver-based roaming */
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|ssid
condition|)
name|current_bss
operator|=
name|wpa_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|current_ssid
operator|->
name|ssid
argument_list|,
name|wpa_s
operator|->
name|current_ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|current_bss
condition|)
name|current_bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|current_bss
condition|)
return|return
literal|1
return|;
comment|/* current BSS not seen in scan results */
if|if
condition|(
name|current_bss
operator|==
name|selected
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|selected
operator|->
name|last_update_idx
operator|>
name|current_bss
operator|->
name|last_update_idx
condition|)
return|return
literal|1
return|;
comment|/* current BSS not seen in the last scan */
ifndef|#
directive|ifndef
name|CONFIG_NO_ROAMING
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Considering within-ESS reassociation"
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Current BSS: "
name|MACSTR
literal|" level=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|current_bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|current_bss
operator|->
name|level
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Selected BSS: "
name|MACSTR
literal|" level=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|selected
operator|->
name|bssid
argument_list|)
argument_list|,
name|selected
operator|->
name|level
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|bssid_set
operator|&&
name|os_memcmp
argument_list|(
name|selected
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|current_ssid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Allow reassociation - selected BSS "
literal|"has preferred BSSID"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|current_bss
operator|->
name|level
operator|<
literal|0
operator|&&
name|current_bss
operator|->
name|level
operator|>
name|selected
operator|->
name|level
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Skip roam - Current BSS has better "
literal|"signal level"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|min_diff
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|current_bss
operator|->
name|level
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|current_bss
operator|->
name|level
operator|<
operator|-
literal|85
condition|)
name|min_diff
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|current_bss
operator|->
name|level
operator|<
operator|-
literal|80
condition|)
name|min_diff
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|current_bss
operator|->
name|level
operator|<
operator|-
literal|75
condition|)
name|min_diff
operator|=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|current_bss
operator|->
name|level
operator|<
operator|-
literal|70
condition|)
name|min_diff
operator|=
literal|4
expr_stmt|;
else|else
name|min_diff
operator|=
literal|5
expr_stmt|;
block|}
if|if
condition|(
name|abs
argument_list|(
name|current_bss
operator|->
name|level
operator|-
name|selected
operator|->
name|level
argument_list|)
operator|<
name|min_diff
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Skip roam - too small difference "
literal|"in signal level"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
else|#
directive|else
comment|/* CONFIG_NO_ROAMING */
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* CONFIG_NO_ROAMING */
block|}
end_function

begin_comment
comment|/* Return != 0 if no scan results could be fetched or if scan results should not  * be shared with other virtual interfaces. */
end_comment

begin_function
specifier|static
name|int
name|_wpa_supplicant_event_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
decl_stmt|;
name|int
name|ap
init|=
literal|0
decl_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NO_RANDOM_POOL
name|size_t
name|i
decl_stmt|,
name|num
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_RANDOM_POOL */
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
name|ap
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
name|wpa_supplicant_notify_scanning
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|&&
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|!=
name|NULL
operator|&&
operator|!
name|wpa_s
operator|->
name|sta_scan_pending
operator|&&
operator|!
name|wpa_s
operator|->
name|scan_res_handler
condition|)
block|{
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p2p_other_scan_completed
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Pending P2P operation "
literal|"stopped scan processing"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sta_scan_pending
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|wpa_s
operator|->
name|sta_scan_pending
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|scan_res
operator|=
name|wpa_supplicant_get_scan_results
argument_list|(
name|wpa_s
argument_list|,
name|data
condition|?
operator|&
name|data
operator|->
name|scan_info
else|:
name|NULL
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|scan_res
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|2
operator|||
name|ap
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Failed to get scan results - try "
literal|"scanning again"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_new_scan
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
ifndef|#
directive|ifndef
name|CONFIG_NO_RANDOM_POOL
name|num
operator|=
name|scan_res
operator|->
name|num
expr_stmt|;
if|if
condition|(
name|num
operator|>
literal|10
condition|)
name|num
operator|=
literal|10
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|u8
name|buf
index|[
literal|5
index|]
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|res
init|=
name|scan_res
operator|->
name|res
index|[
name|i
index|]
decl_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|res
operator|->
name|bssid
index|[
literal|5
index|]
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
name|res
operator|->
name|qual
operator|&
literal|0xff
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
name|res
operator|->
name|noise
operator|&
literal|0xff
expr_stmt|;
name|buf
index|[
literal|3
index|]
operator|=
name|res
operator|->
name|level
operator|&
literal|0xff
expr_stmt|;
name|buf
index|[
literal|4
index|]
operator|=
name|res
operator|->
name|tsf
operator|&
literal|0xff
expr_stmt|;
name|random_add_randomness
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_RANDOM_POOL */
if|if
condition|(
name|wpa_s
operator|->
name|scan_res_handler
condition|)
block|{
name|void
function_decl|(
modifier|*
name|scan_res_handler
function_decl|)
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
function_decl|;
name|scan_res_handler
operator|=
name|wpa_s
operator|->
name|scan_res_handler
expr_stmt|;
name|wpa_s
operator|->
name|scan_res_handler
operator|=
name|NULL
expr_stmt|;
name|scan_res_handler
argument_list|(
name|wpa_s
argument_list|,
name|scan_res
argument_list|)
expr_stmt|;
name|wpa_scan_results_free
argument_list|(
name|scan_res
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
if|if
condition|(
name|ap
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Ignore scan results in AP mode"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|->
name|scan_cb
condition|)
name|wpa_s
operator|->
name|ap_iface
operator|->
name|scan_cb
argument_list|(
name|wpa_s
operator|->
name|ap_iface
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
name|wpa_scan_results_free
argument_list|(
name|scan_res
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"New scan results available"
argument_list|)
expr_stmt|;
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_SCAN_RESULTS
argument_list|)
expr_stmt|;
name|wpas_notify_scan_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_notify_scan_done
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|sme_proc_obss_scan
argument_list|(
name|wpa_s
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_scan_results_free
argument_list|(
name|scan_res
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|2
operator|&&
operator|!
name|wpas_wps_searching
argument_list|(
name|wpa_s
argument_list|)
operator|)
condition|)
block|{
name|wpa_scan_results_free
argument_list|(
name|scan_res
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|autoscan_notify_scan
argument_list|(
name|wpa_s
argument_list|,
name|scan_res
argument_list|)
condition|)
block|{
name|wpa_scan_results_free
argument_list|(
name|scan_res
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|disconnected
condition|)
block|{
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
name|wpa_scan_results_free
argument_list|(
name|scan_res
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|wpas_driver_bss_selection
argument_list|(
name|wpa_s
argument_list|)
operator|&&
name|bgscan_notify_scan
argument_list|(
name|wpa_s
argument_list|,
name|scan_res
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_scan_results_free
argument_list|(
name|scan_res
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpas_wps_update_ap_info
argument_list|(
name|wpa_s
argument_list|,
name|scan_res
argument_list|)
expr_stmt|;
name|wpa_scan_results_free
argument_list|(
name|scan_res
argument_list|)
expr_stmt|;
return|return
name|wpas_select_network_from_last_scan
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_select_network_from_last_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|selected
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|NULL
decl_stmt|;
name|selected
operator|=
name|wpa_supplicant_pick_network
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|selected
condition|)
block|{
name|int
name|skip
decl_stmt|;
name|skip
operator|=
operator|!
name|wpa_supplicant_need_to_roam
argument_list|(
name|wpa_s
argument_list|,
name|selected
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|skip
condition|)
block|{
name|wpa_supplicant_rsn_preauth_scan_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|wpa_supplicant_connect
argument_list|(
name|wpa_s
argument_list|,
name|selected
argument_list|,
name|ssid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Connect failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_supplicant_rsn_preauth_scan_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
comment|/* 		 * Do not notify other virtual radios of scan results since we do not 		 * want them to start other associations at the same time. 		 */
return|return
literal|1
return|;
block|}
else|else
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"No suitable network found"
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_supplicant_pick_new_network
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Setup a new network"
argument_list|)
expr_stmt|;
name|wpa_supplicant_associate
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_rsn_preauth_scan_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|int
name|timeout_sec
init|=
name|wpa_s
operator|->
name|scan_interval
decl_stmt|;
name|int
name|timeout_usec
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpas_p2p_scan_no_go_seen
argument_list|(
name|wpa_s
argument_list|)
operator|==
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
block|{
comment|/* 				 * Use shorter wait during P2P Provisioning 				 * state to speed up group formation. 				 */
name|timeout_sec
operator|=
literal|0
expr_stmt|;
name|timeout_usec
operator|=
literal|250000
expr_stmt|;
name|wpa_supplicant_req_new_scan
argument_list|(
name|wpa_s
argument_list|,
name|timeout_sec
argument_list|,
name|timeout_usec
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|auto_interworking
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|interworking
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|cred
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: "
literal|"start ANQP fetch since no matching "
literal|"networks found"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|network_select
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|auto_network_select
operator|=
literal|1
expr_stmt|;
name|interworking_start_fetch_anqp
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
if|if
condition|(
name|wpa_supplicant_req_sched_scan
argument_list|(
name|wpa_s
argument_list|)
condition|)
name|wpa_supplicant_req_new_scan
argument_list|(
name|wpa_s
argument_list|,
name|timeout_sec
argument_list|,
name|timeout_usec
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|rn
decl_stmt|,
modifier|*
name|rn2
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|ifs
decl_stmt|;
if|if
condition|(
name|_wpa_supplicant_event_scan_results
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* 		 * If no scan results could be fetched, then no need to 		 * notify those interfaces that did not actually request 		 * this scan. Similarly, if scan results started a new operation on this 		 * interface, do not notify other interfaces to avoid concurrent 		 * operations during a connection attempt. 		 */
return|return;
block|}
comment|/* 	 * Check other interfaces to see if they have the same radio-name. If 	 * so, they get updated with this same scan info. 	 */
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|driver
operator|->
name|get_radio_name
condition|)
return|return;
name|rn
operator|=
name|wpa_s
operator|->
name|driver
operator|->
name|get_radio_name
argument_list|(
name|wpa_s
operator|->
name|drv_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|rn
operator|==
name|NULL
operator|||
name|rn
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
return|return;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Checking for other virtual interfaces "
literal|"sharing same radio (%s) in event_scan_results"
argument_list|,
name|rn
argument_list|)
expr_stmt|;
for|for
control|(
name|ifs
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|ifs
condition|;
name|ifs
operator|=
name|ifs
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ifs
operator|==
name|wpa_s
operator|||
operator|!
name|ifs
operator|->
name|driver
operator|->
name|get_radio_name
condition|)
continue|continue;
name|rn2
operator|=
name|ifs
operator|->
name|driver
operator|->
name|get_radio_name
argument_list|(
name|ifs
operator|->
name|drv_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|rn2
operator|&&
name|os_strcmp
argument_list|(
name|rn
argument_list|,
name|rn2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: Updating scan results from "
literal|"sibling"
argument_list|,
name|ifs
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|_wpa_supplicant_event_scan_results
argument_list|(
name|ifs
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_NO_SCAN_PROCESSING */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WNM
end_ifdef

begin_function
specifier|static
name|void
name|wnm_bss_keep_alive
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
condition|)
return|return;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|no_keep_alive
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Send keep-alive to AP "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* TODO: could skip this if normal data traffic has been sent */
comment|/* TODO: Consider using some more appropriate data frame for 		 * this */
if|if
condition|(
name|wpa_s
operator|->
name|l2
condition|)
name|l2_packet_send
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0x0800
argument_list|,
operator|(
name|u8
operator|*
operator|)
literal|""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SME
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|bss_max_idle_period
condition|)
block|{
name|unsigned
name|int
name|msec
decl_stmt|;
name|msec
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|bss_max_idle_period
operator|*
literal|1024
expr_stmt|;
comment|/* times 1000 */
if|if
condition|(
name|msec
operator|>
literal|100
condition|)
name|msec
operator|-=
literal|100
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|msec
operator|/
literal|1000
argument_list|,
name|msec
operator|%
literal|1000
operator|*
literal|1000
argument_list|,
name|wnm_bss_keep_alive
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_SME */
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_process_assoc_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
block|{
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|ies
argument_list|,
name|ies_len
argument_list|,
operator|&
name|elems
argument_list|,
literal|1
argument_list|)
operator|==
name|ParseFailed
condition|)
return|return;
ifdef|#
directive|ifdef
name|CONFIG_SME
if|if
condition|(
name|elems
operator|.
name|bss_max_idle_period
condition|)
block|{
name|unsigned
name|int
name|msec
decl_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|bss_max_idle_period
operator|=
name|WPA_GET_LE16
argument_list|(
name|elems
operator|.
name|bss_max_idle_period
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: BSS Max Idle Period: %u (* 1000 "
literal|"TU)%s"
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|bss_max_idle_period
argument_list|,
operator|(
name|elems
operator|.
name|bss_max_idle_period
index|[
literal|2
index|]
operator|&
literal|0x01
operator|)
condition|?
literal|" (protected keep-live required)"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|bss_max_idle_period
operator|==
literal|0
condition|)
name|wpa_s
operator|->
name|sme
operator|.
name|bss_max_idle_period
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SME
condition|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wnm_bss_keep_alive
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* msec times 1000 */
name|msec
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|bss_max_idle_period
operator|*
literal|1024
expr_stmt|;
if|if
condition|(
name|msec
operator|>
literal|100
condition|)
name|msec
operator|-=
literal|100
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|msec
operator|/
literal|1000
argument_list|,
name|msec
operator|%
literal|1000
operator|*
literal|1000
argument_list|,
name|wnm_bss_keep_alive
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_SME */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WNM */
end_comment

begin_function
name|void
name|wnm_bss_keep_alive_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WNM
name|eloop_cancel_timeout
argument_list|(
name|wnm_bss_keep_alive
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WNM */
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_event_associnfo
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|int
name|l
decl_stmt|,
name|len
decl_stmt|,
name|found
init|=
literal|0
decl_stmt|,
name|wpa_found
decl_stmt|,
name|rsn_found
decl_stmt|;
specifier|const
name|u8
modifier|*
name|p
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Association info event"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
condition|)
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"req_ies"
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"resp_ies"
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies_len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TDLS
name|wpa_tdls_assoc_resp_ies
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TDLS */
ifdef|#
directive|ifdef
name|CONFIG_WNM
name|wnm_process_assoc_resp
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WNM */
block|}
if|if
condition|(
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
condition|)
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"beacon_ies"
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|assoc_info
operator|.
name|freq
condition|)
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"freq=%u MHz"
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|freq
argument_list|)
expr_stmt|;
name|p
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
expr_stmt|;
name|l
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
expr_stmt|;
comment|/* Go through the IEs and make a copy of the WPA/RSN IE, if present. */
while|while
condition|(
name|p
operator|&&
name|l
operator|>=
literal|2
condition|)
block|{
name|len
operator|=
name|p
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|l
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Truncated IE in assoc_info"
argument_list|,
name|p
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|p
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|6
operator|&&
operator|(
name|os_memcmp
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|,
literal|"\x00\x50\xF2\x01\x01\x00"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
operator|)
operator|)
operator|||
operator|(
name|p
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|2
operator|)
condition|)
block|{
if|if
condition|(
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
condition|)
break|break;
name|found
operator|=
literal|1
expr_stmt|;
name|wpa_find_assoc_pmkid
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
block|}
name|l
operator|-=
name|len
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|found
operator|&&
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
condition|)
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
ifdef|#
directive|ifdef
name|CONFIG_SME
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|auth_alg
operator|==
name|WPA_AUTH_ALG_FT
condition|)
block|{
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|<
literal|0
operator|||
name|wpa_ft_validate_reassoc_resp
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies_len
argument_list|,
name|bssid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"FT: Validation of "
literal|"Reassociation Response failed"
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_INVALID_IE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|p
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
expr_stmt|;
name|l
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies_len
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_STRICT
if|if
condition|(
name|p
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps
decl_stmt|;
name|wps
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|p
argument_list|,
name|l
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPS-STRICT: AP did not "
literal|"include WPS IE in (Re)Association Response"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wps_validate_assoc_resp
argument_list|(
name|wps
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpabuf_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_INVALID_IE
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
comment|/* Go through the IEs and make a copy of the MDIE, if present. */
while|while
condition|(
name|p
operator|&&
name|l
operator|>=
literal|2
condition|)
block|{
name|len
operator|=
name|p
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|l
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Truncated IE in assoc_info"
argument_list|,
name|p
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|p
index|[
literal|0
index|]
operator|==
name|WLAN_EID_MOBILITY_DOMAIN
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
name|MOBILITY_DOMAIN_ID_LEN
condition|)
block|{
name|wpa_s
operator|->
name|sme
operator|.
name|ft_used
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|mobility_domain
argument_list|,
name|p
operator|+
literal|2
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
expr_stmt|;
break|break;
block|}
name|l
operator|-=
name|len
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_SME */
name|wpa_sm_set_ft_params
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies_len
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
comment|/* WPA/RSN IE from Beacon/ProbeResp */
name|p
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
expr_stmt|;
name|l
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies_len
expr_stmt|;
comment|/* Go through the IEs and make a copy of the WPA/RSN IEs, if present. 	 */
name|wpa_found
operator|=
name|rsn_found
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|p
operator|&&
name|l
operator|>=
literal|2
condition|)
block|{
name|len
operator|=
name|p
index|[
literal|1
index|]
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|l
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Truncated IE in beacon_ies"
argument_list|,
name|p
argument_list|,
name|l
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|wpa_found
operator|&&
name|p
index|[
literal|0
index|]
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|6
operator|&&
name|os_memcmp
argument_list|(
operator|&
name|p
index|[
literal|2
index|]
argument_list|,
literal|"\x00\x50\xF2\x01\x01\x00"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_found
operator|=
literal|1
expr_stmt|;
name|wpa_sm_set_ap_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|rsn_found
operator|&&
name|p
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
operator|&&
name|p
index|[
literal|1
index|]
operator|>=
literal|2
condition|)
block|{
name|rsn_found
operator|=
literal|1
expr_stmt|;
name|wpa_sm_set_ap_rsn_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|p
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
name|l
operator|-=
name|len
expr_stmt|;
name|p
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wpa_found
operator|&&
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
condition|)
name|wpa_sm_set_ap_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rsn_found
operator|&&
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
condition|)
name|wpa_sm_set_ap_rsn_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_found
operator|||
name|rsn_found
condition|)
name|wpa_s
operator|->
name|ap_ies_from_associnfo
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|assoc_freq
operator|&&
name|data
operator|->
name|assoc_info
operator|.
name|freq
operator|&&
name|wpa_s
operator|->
name|assoc_freq
operator|!=
name|data
operator|->
name|assoc_info
operator|.
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Operating frequency changed from "
literal|"%u to %u MHz"
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|freq
argument_list|)
expr_stmt|;
name|wpa_supplicant_update_scan_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|assoc_freq
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|freq
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_bss
modifier|*
name|wpa_supplicant_get_new_bss
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid_len
operator|>
literal|0
condition|)
name|bss
operator|=
name|wpa_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
condition|)
name|bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
return|return
name|bss
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_assoc_update_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|bss_wpa
init|=
name|NULL
decl_stmt|,
modifier|*
name|bss_rsn
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|current_bss
operator|||
operator|!
name|wpa_s
operator|->
name|current_ssid
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|wpa_key_mgmt_wpa_any
argument_list|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
return|return
literal|0
return|;
name|bss_wpa
operator|=
name|wpa_bss_get_vendor_ie
argument_list|(
name|wpa_s
operator|->
name|current_bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|bss_rsn
operator|=
name|wpa_bss_get_ie
argument_list|(
name|wpa_s
operator|->
name|current_bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_sm_set_ap_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|bss_wpa
argument_list|,
name|bss_wpa
condition|?
literal|2
operator|+
name|bss_wpa
index|[
literal|1
index|]
else|:
literal|0
argument_list|)
operator|||
name|wpa_sm_set_ap_rsn_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|bss_rsn
argument_list|,
name|bss_rsn
condition|?
literal|2
operator|+
name|bss_rsn
index|[
literal|1
index|]
else|:
literal|0
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_assoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|ft_completed
decl_stmt|;
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|hostapd_notif_assoc
argument_list|(
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|addr
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|reassoc
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
name|ft_completed
operator|=
name|wpa_ft_is_completed
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|&&
name|wpa_supplicant_event_associnfo
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
name|wpa_drv_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to get BSSID"
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ASSOCIATED
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Associated to a new BSS: BSSID="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|random_add_randomness
argument_list|(
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpas_notify_bssid_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_dynamic_keys
argument_list|(
name|wpa_s
argument_list|)
operator|&&
operator|!
name|ft_completed
condition|)
block|{
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_supplicant_select_config
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
init|=
name|NULL
decl_stmt|;
name|bss
operator|=
name|wpa_supplicant_get_new_bss
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
condition|)
block|{
name|wpa_supplicant_update_scan_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
comment|/* Get the BSS from the new scan results */
name|bss
operator|=
name|wpa_supplicant_get_new_bss
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bss
condition|)
name|wpa_s
operator|->
name|current_bss
operator|=
name|bss
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
operator|&&
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_BSS_SELECTION
condition|)
block|{
if|if
condition|(
name|wpa_supplicant_assoc_update_ie
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"WPA/RSN IEs not updated"
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|CONFIG_SME
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid_set
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_SME */
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Associated with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
comment|/* When using scanning (ap_scan=1), SIM PC/SC interface can be 		 * initialized before association, but for other modes, 		 * initialize PC/SC here, if the current configuration needs 		 * smartcard or SIM/USIM. */
name|wpa_supplicant_scard_init
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
block|}
name|wpa_sm_notify_assoc
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|l2
condition|)
name|l2_packet_notify_auth_start
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|)
expr_stmt|;
comment|/* 	 * Set portEnabled first to FALSE in order to get EAP state machine out 	 * of the SUCCESS state and eapSuccess cleared. Without this, EAPOL PAE 	 * state machine may transit to AUTHENTICATING state based on obsolete 	 * eapSuccess and then trigger BE_AUTH to SUCCESS and PAE to 	 * AUTHENTICATED without ever giving chance to EAP state machine to 	 * reset the state. 	 */
if|if
condition|(
operator|!
name|ft_completed
condition|)
block|{
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
operator|||
name|ft_completed
condition|)
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
comment|/* 802.1X::portControl = Auto */
name|eapol_sm_notify_portEnabled
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|eapol_received
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
operator|||
operator|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|IEEE80211_MODE_IBSS
operator|)
condition|)
block|{
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_COMPLETED
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|ft_completed
condition|)
block|{
comment|/* Timeout for receiving the first EAPOL packet */
name|wpa_supplicant_req_auth_timeout
argument_list|(
name|wpa_s
argument_list|,
literal|10
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_cancel_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_4WAY_HANDSHAKE
operator|)
operator|&&
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
comment|/* 		 * We are done; the driver will take care of RSN 4-way 		 * handshake. 		 */
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_COMPLETED
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_4WAY_HANDSHAKE
operator|)
operator|&&
name|wpa_key_mgmt_wpa_ieee8021x
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
comment|/* 		 * The driver will take care of RSN 4-way handshake, so we need 		 * to allow EAPOL supplicant to complete its work without 		 * waiting for WPA supplicant. 		 */
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ft_completed
condition|)
block|{
comment|/* 		 * FT protocol completed - make sure EAPOL state machine ends 		 * up in authenticated. 		 */
name|wpa_supplicant_cancel_auth_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_COMPLETED
argument_list|)
expr_stmt|;
name|eapol_sm_notify_portValid
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|eapol_sm_notify_eap_success
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|last_eapol_matches_bssid
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_eapol_rx
condition|)
block|{
name|struct
name|os_time
name|now
decl_stmt|,
name|age
decl_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|os_time_sub
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|wpa_s
operator|->
name|pending_eapol_rx_time
argument_list|,
operator|&
name|age
argument_list|)
expr_stmt|;
if|if
condition|(
name|age
operator|.
name|sec
operator|==
literal|0
operator|&&
name|age
operator|.
name|usec
operator|<
literal|100000
operator|&&
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|pending_eapol_rx_src
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Process pending EAPOL "
literal|"frame that was received just before "
literal|"association notification"
argument_list|)
expr_stmt|;
name|wpa_supplicant_rx_eapol
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_eapol_rx_src
argument_list|,
name|wpabuf_head
argument_list|(
name|wpa_s
operator|->
name|pending_eapol_rx
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|wpa_s
operator|->
name|pending_eapol_rx
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|pending_eapol_rx
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_eapol_rx
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_NONE
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
operator|==
literal|0
operator|&&
name|capa
operator|.
name|flags
operator|&
name|WPA_DRIVER_FLAGS_SET_KEYS_AFTER_ASSOC_DONE
condition|)
block|{
comment|/* Set static WEP keys again */
name|wpa_set_wep_keys
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_IBSS
operator|&&
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_NONE
operator|&&
name|wpa_s
operator|->
name|key_mgmt
operator|!=
name|WPA_KEY_MGMT_WPA_NONE
operator|&&
name|wpa_s
operator|->
name|ibss_rsn
operator|==
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|ibss_rsn
operator|=
name|ibss_rsn_init
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ibss_rsn
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Failed to init IBSS RSN"
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
return|return;
block|}
name|ibss_rsn_set_psk
argument_list|(
name|wpa_s
operator|->
name|ibss_rsn
argument_list|,
name|wpa_s
operator|->
name|current_ssid
operator|->
name|psk
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
name|wpas_wps_notify_assoc
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|disconnect_reason_recoverable
parameter_list|(
name|u16
name|reason_code
parameter_list|)
block|{
return|return
name|reason_code
operator|==
name|WLAN_REASON_DISASSOC_DUE_TO_INACTIVITY
operator|||
name|reason_code
operator|==
name|WLAN_REASON_CLASS2_FRAME_FROM_NONAUTH_STA
operator|||
name|reason_code
operator|==
name|WLAN_REASON_CLASS3_FRAME_FROM_NONASSOC_STA
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u16
name|reason_code
parameter_list|,
name|int
name|locally_generated
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|bssid
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* 		 * At least Host AP driver and a Prism3 card seemed to be 		 * generating streams of disconnected events when configuring 		 * IBSS for WPA-None. Ignore them for now. 		 */
return|return;
block|}
name|bssid
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|bssid
argument_list|)
condition|)
name|bssid
operator|=
name|wpa_s
operator|->
name|pending_bssid
expr_stmt|;
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|bssid
argument_list|)
operator|||
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_AUTHENTICATING
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_DISCONNECTED
literal|"bssid="
name|MACSTR
literal|" reason=%d%s"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|,
name|reason_code
argument_list|,
name|locally_generated
condition|?
literal|" locally_generated=1"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|could_be_psk_mismatch
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u16
name|reason_code
parameter_list|,
name|int
name|locally_generated
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_4WAY_HANDSHAKE
operator|||
operator|!
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Not in 4-way handshake with PSK */
comment|/* 	 * It looks like connection was lost while trying to go through PSK 	 * 4-way handshake. Filter out known disconnection cases that are caused 	 * by something else than PSK mismatch to avoid confusing reports. 	 */
if|if
condition|(
name|locally_generated
condition|)
block|{
if|if
condition|(
name|reason_code
operator|==
name|WLAN_REASON_IE_IN_4WAY_DIFFERS
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_disassoc_finish
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u16
name|reason_code
parameter_list|,
name|int
name|locally_generated
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|bssid
decl_stmt|;
name|int
name|authenticating
decl_stmt|;
name|u8
name|prev_pending_bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|fast_reconnect
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|fast_reconnect_ssid
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|last_ssid
decl_stmt|;
name|authenticating
operator|=
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_AUTHENTICATING
expr_stmt|;
name|os_memcpy
argument_list|(
name|prev_pending_bssid
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPA_NONE
condition|)
block|{
comment|/* 		 * At least Host AP driver and a Prism3 card seemed to be 		 * generating streams of disconnected events when configuring 		 * IBSS for WPA-None. Ignore them for now. 		 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Disconnect event - ignore in "
literal|"IBSS/WPA-None mode"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|could_be_psk_mismatch
argument_list|(
name|wpa_s
argument_list|,
name|reason_code
argument_list|,
name|locally_generated
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPA: 4-Way Handshake failed - "
literal|"pre-shared key may be incorrect"
argument_list|)
expr_stmt|;
name|wpas_auth_failed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|auto_reconnect_disabled
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Auto connect enabled: try to "
literal|"reconnect (wps=%d wpa_state=%d)"
argument_list|,
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
argument_list|,
name|wpa_s
operator|->
name|wpa_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_COMPLETED
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
operator|&&
operator|!
name|locally_generated
operator|&&
name|disconnect_reason_recoverable
argument_list|(
name|reason_code
argument_list|)
condition|)
block|{
comment|/* 			 * It looks like the AP has dropped association with 			 * us, but could allow us to get back in. Try to 			 * reconnect to the same BSS without full scan to save 			 * time for some common cases. 			 */
name|fast_reconnect
operator|=
name|wpa_s
operator|->
name|current_bss
expr_stmt|;
name|fast_reconnect_ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_ASSOCIATING
condition|)
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|100000
argument_list|)
expr_stmt|;
else|else
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Do not request new "
literal|"immediate scan"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Auto connect disabled: do not "
literal|"try to re-connect"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|disconnected
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
name|bssid
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|bssid
argument_list|)
condition|)
name|bssid
operator|=
name|wpa_s
operator|->
name|pending_bssid
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_AUTHENTICATING
condition|)
name|wpas_connection_failed
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
name|wpa_sm_notify_disassoc
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
expr_stmt|;
if|if
condition|(
name|locally_generated
condition|)
name|wpa_s
operator|->
name|disconnect_reason
operator|=
operator|-
name|reason_code
expr_stmt|;
else|else
name|wpa_s
operator|->
name|disconnect_reason
operator|=
name|reason_code
expr_stmt|;
name|wpas_notify_disconnect_reason
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_dynamic_keys
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Disconnect event - remove keys"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|keys_cleared
operator|=
literal|0
expr_stmt|;
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
block|}
name|last_ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|authenticating
operator|&&
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SME
operator|)
condition|)
block|{
name|sme_disassoc_while_authenticating
argument_list|(
name|wpa_s
argument_list|,
name|prev_pending_bssid
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|last_ssid
expr_stmt|;
block|}
if|if
condition|(
name|fast_reconnect
condition|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_NO_SCAN_PROCESSING
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Try to reconnect to the same BSS"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_connect
argument_list|(
name|wpa_s
argument_list|,
name|fast_reconnect
argument_list|,
name|fast_reconnect_ssid
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* Recover through full scan */
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|100000
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_SCAN_PROCESSING */
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_DELAYED_MIC_ERROR_REPORT
end_ifdef

begin_function
name|void
name|wpa_supplicant_delayed_mic_error_report
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|pending_mic_error_report
condition|)
return|return;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: Sending pending MIC error report"
argument_list|)
expr_stmt|;
name|wpa_sm_key_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
literal|1
argument_list|,
name|wpa_s
operator|->
name|pending_mic_error_pairwise
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_mic_error_report
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_DELAYED_MIC_ERROR_REPORT */
end_comment

begin_function
specifier|static
name|void
name|wpa_supplicant_event_michael_mic_failure
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|int
name|pairwise
decl_stmt|;
name|struct
name|os_time
name|t
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"Michael MIC failure detected"
argument_list|)
expr_stmt|;
name|pairwise
operator|=
operator|(
name|data
operator|&&
name|data
operator|->
name|michael_mic_failure
operator|.
name|unicast
operator|)
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|t
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|last_michael_mic_error
operator|&&
name|t
operator|.
name|sec
operator|-
name|wpa_s
operator|->
name|last_michael_mic_error
operator|<=
literal|60
operator|)
operator|||
name|wpa_s
operator|->
name|pending_mic_error_report
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|pending_mic_error_report
condition|)
block|{
comment|/* 			 * Send the pending MIC error report immediately since 			 * we are going to start countermeasures and AP better 			 * do the same. 			 */
name|wpa_sm_key_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
literal|1
argument_list|,
name|wpa_s
operator|->
name|pending_mic_error_pairwise
argument_list|)
expr_stmt|;
block|}
comment|/* Send the new MIC error report immediately since we are going 		 * to start countermeasures and AP better do the same. 		 */
name|wpa_sm_key_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
literal|1
argument_list|,
name|pairwise
argument_list|)
expr_stmt|;
comment|/* initialize countermeasures */
name|wpa_s
operator|->
name|countermeasures
operator|=
literal|1
expr_stmt|;
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"TKIP countermeasures started"
argument_list|)
expr_stmt|;
comment|/* 		 * Need to wait for completion of request frame. We do not get 		 * any callback for the message completion, so just wait a 		 * short while and hope for the best. */
name|os_sleep
argument_list|(
literal|0
argument_list|,
literal|10000
argument_list|)
expr_stmt|;
name|wpa_drv_set_countermeasures
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_MICHAEL_MIC_FAILURE
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_stop_countermeasures
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|60
argument_list|,
literal|0
argument_list|,
name|wpa_supplicant_stop_countermeasures
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* TODO: mark the AP rejected for 60 second. STA is 		 * allowed to associate with another AP.. */
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|CONFIG_DELAYED_MIC_ERROR_REPORT
if|if
condition|(
name|wpa_s
operator|->
name|mic_errors_seen
condition|)
block|{
comment|/* 			 * Reduce the effectiveness of Michael MIC error 			 * reports as a means for attacking against TKIP if 			 * more than one MIC failure is noticed with the same 			 * PTK. We delay the transmission of the reports by a 			 * random time between 0 and 60 seconds in order to 			 * force the attacker wait 60 seconds before getting 			 * the information on whether a frame resulted in a MIC 			 * failure. 			 */
name|u8
name|rval
index|[
literal|4
index|]
decl_stmt|;
name|int
name|sec
decl_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
name|rval
argument_list|,
sizeof|sizeof
argument_list|(
name|rval
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|sec
operator|=
name|os_random
argument_list|()
operator|%
literal|60
expr_stmt|;
else|else
name|sec
operator|=
name|WPA_GET_BE32
argument_list|(
name|rval
argument_list|)
operator|%
literal|60
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPA: Delay MIC error "
literal|"report %d seconds"
argument_list|,
name|sec
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_mic_error_report
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|pending_mic_error_pairwise
operator|=
name|pairwise
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpa_supplicant_delayed_mic_error_report
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
argument_list|,
name|os_random
argument_list|()
operator|%
literal|1000000
argument_list|,
name|wpa_supplicant_delayed_mic_error_report
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_sm_key_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
literal|1
argument_list|,
name|pairwise
argument_list|)
expr_stmt|;
block|}
else|#
directive|else
comment|/* CONFIG_DELAYED_MIC_ERROR_REPORT */
name|wpa_sm_key_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
literal|1
argument_list|,
name|pairwise
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_DELAYED_MIC_ERROR_REPORT */
block|}
name|wpa_s
operator|->
name|last_michael_mic_error
operator|=
name|t
operator|.
name|sec
expr_stmt|;
name|wpa_s
operator|->
name|mic_errors_seen
operator|++
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_TERMINATE_ONLASTIF
end_ifdef

begin_function
specifier|static
name|int
name|any_interfaces
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|head
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|head
init|;
name|wpa_s
operator|!=
name|NULL
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|interface_removed
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_TERMINATE_ONLASTIF */
end_comment

begin_function
specifier|static
name|void
name|wpa_supplicant_event_interface_status
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|data
operator|->
name|interface_status
operator|.
name|ifname
argument_list|)
operator|!=
literal|0
condition|)
return|return;
switch|switch
condition|(
name|data
operator|->
name|interface_status
operator|.
name|ievent
condition|)
block|{
case|case
name|EVENT_INTERFACE_ADDED
case|:
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|interface_removed
condition|)
break|break;
name|wpa_s
operator|->
name|interface_removed
operator|=
literal|0
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Configured interface was added"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_driver_init
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Failed to initialize the "
literal|"driver after interface was added"
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_INTERFACE_REMOVED
case|:
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Configured interface was removed"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|interface_removed
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_INTERFACE_DISABLED
argument_list|)
expr_stmt|;
name|l2_packet_deinit
argument_list|(
name|wpa_s
operator|->
name|l2
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|l2
operator|=
name|NULL
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
name|ibss_rsn_deinit
argument_list|(
name|wpa_s
operator|->
name|ibss_rsn
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ibss_rsn
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
ifdef|#
directive|ifdef
name|CONFIG_TERMINATE_ONLASTIF
comment|/* check if last interface */
if|if
condition|(
operator|!
name|any_interfaces
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
argument_list|)
condition|)
name|eloop_terminate
argument_list|()
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TERMINATE_ONLASTIF */
break|break;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_PEERKEY
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_event_stkstart
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
name|wpa_sm_stkstart
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|stkstart
operator|.
name|peer
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_PEERKEY */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_TDLS
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_event_tdls
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
switch|switch
condition|(
name|data
operator|->
name|tdls
operator|.
name|oper
condition|)
block|{
case|case
name|TDLS_REQUEST_SETUP
case|:
name|wpa_tdls_start
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|tdls
operator|.
name|peer
argument_list|)
expr_stmt|;
break|break;
case|case
name|TDLS_REQUEST_TEARDOWN
case|:
name|wpa_tdls_send_teardown
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|tdls
operator|.
name|peer
argument_list|,
name|data
operator|->
name|tdls
operator|.
name|reason_code
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_TDLS */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WNM
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_event_wnm
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
switch|switch
condition|(
name|data
operator|->
name|wnm
operator|.
name|oper
condition|)
block|{
case|case
name|WNM_OPER_SLEEP
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Start sending WNM-Sleep Request "
literal|"(action=%d, intval=%d)"
argument_list|,
name|data
operator|->
name|wnm
operator|.
name|sleep_action
argument_list|,
name|data
operator|->
name|wnm
operator|.
name|sleep_intval
argument_list|)
expr_stmt|;
name|ieee802_11_send_wnmsleep_req
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|wnm
operator|.
name|sleep_action
argument_list|,
name|data
operator|->
name|wnm
operator|.
name|sleep_intval
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WNM */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_event_ft_response
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_ft_process_response
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|ies
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|ies_len
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|ft_action
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|target_ap
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|ric_ies
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|ric_ies_len
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* TODO: prevent MLME/driver from trying to associate? */
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211R */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
end_ifdef

begin_function
specifier|static
name|void
name|wpa_supplicant_event_ibss_rsn_start
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
condition|)
return|return;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_IBSS
operator|||
operator|!
name|wpa_key_mgmt_wpa
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
return|return;
name|ibss_rsn_start
argument_list|(
name|wpa_s
operator|->
name|ibss_rsn
argument_list|,
name|data
operator|->
name|ibss_rsn_start
operator|.
name|peer
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IBSS_RSN */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
end_ifdef

begin_function
specifier|static
name|void
name|ft_rx_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|sta_addr
decl_stmt|,
modifier|*
name|target_ap_addr
decl_stmt|;
name|u16
name|status
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"FT: RX Action"
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SME
operator|)
condition|)
return|return;
comment|/* only SME case supported for now */
if|if
condition|(
name|len
operator|<
literal|1
operator|+
literal|2
operator|*
name|ETH_ALEN
operator|+
literal|2
condition|)
return|return;
if|if
condition|(
name|data
index|[
literal|0
index|]
operator|!=
literal|2
condition|)
return|return;
comment|/* Only FT Action Response is supported for now */
name|sta_addr
operator|=
name|data
operator|+
literal|1
expr_stmt|;
name|target_ap_addr
operator|=
name|data
operator|+
literal|1
operator|+
name|ETH_ALEN
expr_stmt|;
name|status
operator|=
name|WPA_GET_LE16
argument_list|(
name|data
operator|+
literal|1
operator|+
literal|2
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"FT: Received FT Action Response: STA "
name|MACSTR
literal|" TargetAP "
name|MACSTR
literal|" status %u"
argument_list|,
name|MAC2STR
argument_list|(
name|sta_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|target_ap_addr
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sta_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"FT: Foreign STA Address "
name|MACSTR
literal|" in FT Action Response"
argument_list|,
name|MAC2STR
argument_list|(
name|sta_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"FT: FT Action Response indicates "
literal|"failure (status code %d)"
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* TODO: report error to FT code(?) */
return|return;
block|}
if|if
condition|(
name|wpa_ft_process_response
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|+
literal|1
operator|+
literal|2
operator|*
name|ETH_ALEN
operator|+
literal|2
argument_list|,
name|len
operator|-
operator|(
literal|1
operator|+
literal|2
operator|*
name|ETH_ALEN
operator|+
literal|2
operator|)
argument_list|,
literal|1
argument_list|,
name|target_ap_addr
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return;
ifdef|#
directive|ifdef
name|CONFIG_SME
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|target_ap_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
name|wpa_s
operator|->
name|sme
operator|.
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|auth_alg
operator|=
name|WPA_AUTH_ALG_FT
expr_stmt|;
name|sme_associate
argument_list|(
name|wpa_s
argument_list|,
name|WPAS_MODE_INFRA
argument_list|,
name|target_ap_addr
argument_list|,
name|WLAN_AUTH_FT
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_SME */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211R */
end_comment

begin_function
specifier|static
name|void
name|wpa_supplicant_event_unprot_deauth
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|unprot_deauth
modifier|*
name|e
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unprotected Deauthentication frame "
literal|"dropped: "
name|MACSTR
literal|" -> "
name|MACSTR
literal|" (reason code %u)"
argument_list|,
name|MAC2STR
argument_list|(
name|e
operator|->
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|e
operator|->
name|da
argument_list|)
argument_list|,
name|e
operator|->
name|reason_code
argument_list|)
expr_stmt|;
name|sme_event_unprot_disconnect
argument_list|(
name|wpa_s
argument_list|,
name|e
operator|->
name|sa
argument_list|,
name|e
operator|->
name|da
argument_list|,
name|e
operator|->
name|reason_code
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_event_unprot_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|unprot_disassoc
modifier|*
name|e
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unprotected Disassociation frame "
literal|"dropped: "
name|MACSTR
literal|" -> "
name|MACSTR
literal|" (reason code %u)"
argument_list|,
name|MAC2STR
argument_list|(
name|e
operator|->
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|e
operator|->
name|da
argument_list|)
argument_list|,
name|e
operator|->
name|reason_code
argument_list|)
expr_stmt|;
name|sme_event_unprot_disconnect
argument_list|(
name|wpa_s
argument_list|,
name|e
operator|->
name|sa
argument_list|,
name|e
operator|->
name|da
argument_list|,
name|e
operator|->
name|reason_code
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
block|}
end_function

begin_function
name|void
name|wpa_supplicant_event
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|wpa_event_type
name|event
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|u16
name|reason_code
init|=
literal|0
decl_stmt|;
name|int
name|locally_generated
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_INTERFACE_DISABLED
operator|&&
name|event
operator|!=
name|EVENT_INTERFACE_ENABLED
operator|&&
name|event
operator|!=
name|EVENT_INTERFACE_STATUS
operator|&&
name|event
operator|!=
name|EVENT_SCHED_SCAN_STOPPED
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Ignore event %s (%d) while interface is disabled"
argument_list|,
name|event_to_string
argument_list|(
name|event
argument_list|)
argument_list|,
name|event
argument_list|)
expr_stmt|;
return|return;
block|}
ifndef|#
directive|ifndef
name|CONFIG_NO_STDOUT_DEBUG
block|{
name|int
name|level
init|=
name|MSG_DEBUG
decl_stmt|;
if|if
condition|(
name|event
operator|==
name|EVENT_RX_MGMT
operator|&&
name|data
operator|->
name|rx_mgmt
operator|.
name|frame_len
operator|>=
literal|24
condition|)
block|{
specifier|const
name|struct
name|ieee80211_hdr
modifier|*
name|hdr
decl_stmt|;
name|u16
name|fc
decl_stmt|;
name|hdr
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_hdr
operator|*
operator|)
name|data
operator|->
name|rx_mgmt
operator|.
name|frame
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|hdr
operator|->
name|frame_control
argument_list|)
expr_stmt|;
if|if
condition|(
name|WLAN_FC_GET_TYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
operator|==
name|WLAN_FC_STYPE_BEACON
condition|)
name|level
operator|=
name|MSG_EXCESSIVE
expr_stmt|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|level
argument_list|,
literal|"Event %s (%d) received"
argument_list|,
name|event_to_string
argument_list|(
name|event
argument_list|)
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_STDOUT_DEBUG */
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|EVENT_AUTH
case|:
name|sme_event_auth
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_ASSOC
case|:
name|wpa_supplicant_event_assoc
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DISASSOC
case|:
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Disassociation notification"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|" * reason %u%s"
argument_list|,
name|data
operator|->
name|disassoc_info
operator|.
name|reason_code
argument_list|,
name|data
operator|->
name|disassoc_info
operator|.
name|locally_generated
condition|?
literal|" (locally generated)"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|disassoc_info
operator|.
name|addr
condition|)
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|" * address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|disassoc_info
operator|.
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|&&
name|data
operator|&&
name|data
operator|->
name|disassoc_info
operator|.
name|addr
condition|)
block|{
name|hostapd_notif_disassoc
argument_list|(
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|,
name|data
operator|->
name|disassoc_info
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Ignore disassoc event in "
literal|"AP mode"
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
if|if
condition|(
name|data
condition|)
block|{
name|reason_code
operator|=
name|data
operator|->
name|disassoc_info
operator|.
name|reason_code
expr_stmt|;
name|locally_generated
operator|=
name|data
operator|->
name|disassoc_info
operator|.
name|locally_generated
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Disassociation frame IE(s)"
argument_list|,
name|data
operator|->
name|disassoc_info
operator|.
name|ie
argument_list|,
name|data
operator|->
name|disassoc_info
operator|.
name|ie_len
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_disassoc_notif
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|disassoc_info
operator|.
name|addr
argument_list|,
name|reason_code
argument_list|,
name|data
operator|->
name|disassoc_info
operator|.
name|ie
argument_list|,
name|data
operator|->
name|disassoc_info
operator|.
name|ie_len
argument_list|,
name|locally_generated
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
block|}
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SME
condition|)
name|sme_event_disassoc
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
comment|/* fall through */
case|case
name|EVENT_DEAUTH
case|:
if|if
condition|(
name|event
operator|==
name|EVENT_DEAUTH
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Deauthentication notification"
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|reason_code
operator|=
name|data
operator|->
name|deauth_info
operator|.
name|reason_code
expr_stmt|;
name|locally_generated
operator|=
name|data
operator|->
name|deauth_info
operator|.
name|locally_generated
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|" * reason %u%s"
argument_list|,
name|data
operator|->
name|deauth_info
operator|.
name|reason_code
argument_list|,
name|data
operator|->
name|deauth_info
operator|.
name|locally_generated
condition|?
literal|" (locally generated)"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|deauth_info
operator|.
name|addr
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|" * address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|deauth_info
operator|.
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Deauthentication frame IE(s)"
argument_list|,
name|data
operator|->
name|deauth_info
operator|.
name|ie
argument_list|,
name|data
operator|->
name|deauth_info
operator|.
name|ie_len
argument_list|)
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|&&
name|data
operator|&&
name|data
operator|->
name|deauth_info
operator|.
name|addr
condition|)
block|{
name|hostapd_notif_disassoc
argument_list|(
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|,
name|data
operator|->
name|deauth_info
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Ignore deauth event in "
literal|"AP mode"
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
name|wpa_supplicant_event_disassoc
argument_list|(
name|wpa_s
argument_list|,
name|reason_code
argument_list|,
name|locally_generated
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason_code
operator|==
name|WLAN_REASON_IEEE_802_1X_AUTH_FAILED
operator|||
operator|(
operator|(
name|wpa_key_mgmt_wpa_ieee8021x
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|)
operator|||
operator|(
name|wpa_s
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
operator|)
operator|&&
name|eapol_sm_failed
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
operator|)
condition|)
name|wpas_auth_failed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|event
operator|==
name|EVENT_DEAUTH
operator|&&
name|data
condition|)
block|{
if|if
condition|(
name|wpas_p2p_deauth_notif
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|deauth_info
operator|.
name|addr
argument_list|,
name|reason_code
argument_list|,
name|data
operator|->
name|deauth_info
operator|.
name|ie
argument_list|,
name|data
operator|->
name|deauth_info
operator|.
name|ie_len
argument_list|,
name|locally_generated
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/* 				 * The interface was removed, so cannot 				 * continue processing any additional 				 * operations after this. 				 */
break|break;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|wpa_supplicant_event_disassoc_finish
argument_list|(
name|wpa_s
argument_list|,
name|reason_code
argument_list|,
name|locally_generated
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_MICHAEL_MIC_FAILURE
case|:
name|wpa_supplicant_event_michael_mic_failure
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
ifndef|#
directive|ifndef
name|CONFIG_NO_SCAN_PROCESSING
case|case
name|EVENT_SCAN_RESULTS
case|:
name|wpa_supplicant_event_scan_results
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|&&
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|!=
name|NULL
operator|&&
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_AUTHENTICATING
operator|&&
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_ASSOCIATING
condition|)
block|{
name|wpa_s
operator|->
name|global
operator|->
name|p2p_cb_on_scan_complete
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|p2p_other_scan_completed
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
operator|==
literal|1
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Pending P2P operation "
literal|"continued after scan result processing"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
break|break;
endif|#
directive|endif
comment|/* CONFIG_NO_SCAN_PROCESSING */
case|case
name|EVENT_ASSOCINFO
case|:
name|wpa_supplicant_event_associnfo
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_INTERFACE_STATUS
case|:
name|wpa_supplicant_event_interface_status
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_PMKID_CANDIDATE
case|:
name|wpa_supplicant_event_pmkid_candidate
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_PEERKEY
case|case
name|EVENT_STKSTART
case|:
name|wpa_supplicant_event_stkstart
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_PEERKEY */
ifdef|#
directive|ifdef
name|CONFIG_TDLS
case|case
name|EVENT_TDLS
case|:
name|wpa_supplicant_event_tdls
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_TDLS */
ifdef|#
directive|ifdef
name|CONFIG_WNM
case|case
name|EVENT_WNM
case|:
name|wpa_supplicant_event_wnm
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_WNM */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
case|case
name|EVENT_FT_RESPONSE
case|:
name|wpa_supplicant_event_ft_response
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
case|case
name|EVENT_IBSS_RSN_START
case|:
name|wpa_supplicant_event_ibss_rsn_start
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
case|case
name|EVENT_ASSOC_REJECT
case|:
if|if
condition|(
name|data
operator|->
name|assoc_reject
operator|.
name|bssid
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_ASSOC_REJECT
literal|"bssid="
name|MACSTR
literal|" status_code=%u"
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|assoc_reject
operator|.
name|bssid
argument_list|)
argument_list|,
name|data
operator|->
name|assoc_reject
operator|.
name|status_code
argument_list|)
expr_stmt|;
else|else
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_ASSOC_REJECT
literal|"status_code=%u"
argument_list|,
name|data
operator|->
name|assoc_reject
operator|.
name|status_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SME
condition|)
name|sme_event_assoc_reject
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
else|else
block|{
specifier|const
name|u8
modifier|*
name|bssid
init|=
name|data
operator|->
name|assoc_reject
operator|.
name|bssid
decl_stmt|;
if|if
condition|(
name|bssid
operator|==
name|NULL
operator|||
name|is_zero_ether_addr
argument_list|(
name|bssid
argument_list|)
condition|)
name|bssid
operator|=
name|wpa_s
operator|->
name|pending_bssid
expr_stmt|;
name|wpas_connection_failed
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|EVENT_AUTH_TIMED_OUT
case|:
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SME
condition|)
name|sme_event_auth_timed_out
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_ASSOC_TIMED_OUT
case|:
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SME
condition|)
name|sme_event_assoc_timed_out
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_TX_STATUS
case|:
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"EVENT_TX_STATUS dst="
name|MACSTR
literal|" type=%d stype=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|tx_status
operator|.
name|dst
argument_list|)
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|type
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|stype
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|==
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_OFFCHANNEL
if|if
condition|(
name|data
operator|->
name|tx_status
operator|.
name|type
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|data
operator|->
name|tx_status
operator|.
name|stype
operator|==
name|WLAN_FC_STYPE_ACTION
condition|)
name|offchannel_send_action_tx_status
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|dst
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data_len
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|ack
condition|?
name|OFFCHANNEL_SEND_ACTION_SUCCESS
else|:
name|OFFCHANNEL_SEND_ACTION_NO_ACK
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_OFFCHANNEL */
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
ifdef|#
directive|ifdef
name|CONFIG_OFFCHANNEL
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"EVENT_TX_STATUS pending_dst="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|parent
operator|->
name|pending_action_dst
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 		 * Catch TX status events for Action frames we sent via group 		 * interface in GO mode. 		 */
if|if
condition|(
name|data
operator|->
name|tx_status
operator|.
name|type
operator|==
name|WLAN_FC_TYPE_MGMT
operator|&&
name|data
operator|->
name|tx_status
operator|.
name|stype
operator|==
name|WLAN_FC_STYPE_ACTION
operator|&&
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|parent
operator|->
name|pending_action_dst
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|offchannel_send_action_tx_status
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|dst
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data_len
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|ack
condition|?
name|OFFCHANNEL_SEND_ACTION_SUCCESS
else|:
name|OFFCHANNEL_SEND_ACTION_NO_ACK
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_OFFCHANNEL */
ifdef|#
directive|ifdef
name|CONFIG_AP
switch|switch
condition|(
name|data
operator|->
name|tx_status
operator|.
name|type
condition|)
block|{
case|case
name|WLAN_FC_TYPE_MGMT
case|:
name|ap_mgmt_tx_cb
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data_len
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|stype
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|ack
argument_list|)
expr_stmt|;
break|break;
case|case
name|WLAN_FC_TYPE_DATA
case|:
name|ap_tx_status
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|dst
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|data_len
argument_list|,
name|data
operator|->
name|tx_status
operator|.
name|ack
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
break|break;
ifdef|#
directive|ifdef
name|CONFIG_AP
case|case
name|EVENT_EAPOL_TX_STATUS
case|:
name|ap_eapol_tx_status
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|eapol_tx_status
operator|.
name|dst
argument_list|,
name|data
operator|->
name|eapol_tx_status
operator|.
name|data
argument_list|,
name|data
operator|->
name|eapol_tx_status
operator|.
name|data_len
argument_list|,
name|data
operator|->
name|eapol_tx_status
operator|.
name|ack
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DRIVER_CLIENT_POLL_OK
case|:
name|ap_client_poll_ok
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|client_poll
operator|.
name|addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_RX_FROM_UNKNOWN
case|:
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|==
name|NULL
condition|)
break|break;
name|ap_rx_from_unknown_sta
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|rx_from_unknown
operator|.
name|addr
argument_list|,
name|data
operator|->
name|rx_from_unknown
operator|.
name|wds
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_CH_SWITCH
case|:
if|if
condition|(
operator|!
name|data
condition|)
break|break;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"AP: Ignore channel switch "
literal|"event in non-AP mode"
argument_list|)
expr_stmt|;
break|break;
block|}
ifdef|#
directive|ifdef
name|CONFIG_AP
name|wpas_ap_ch_switch
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|ch_switch
operator|.
name|freq
argument_list|,
name|data
operator|->
name|ch_switch
operator|.
name|ht_enabled
argument_list|,
name|data
operator|->
name|ch_switch
operator|.
name|ch_offset
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
break|break;
case|case
name|EVENT_RX_MGMT
case|:
block|{
name|u16
name|fc
decl_stmt|,
name|stype
decl_stmt|;
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|mgmt
operator|=
operator|(
specifier|const
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|data
operator|->
name|rx_mgmt
operator|.
name|frame
expr_stmt|;
name|fc
operator|=
name|le_to_host16
argument_list|(
name|mgmt
operator|->
name|frame_control
argument_list|)
expr_stmt|;
name|stype
operator|=
name|WLAN_FC_GET_STYPE
argument_list|(
name|fc
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|==
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|stype
operator|==
name|WLAN_FC_STYPE_PROBE_REQ
operator|&&
name|data
operator|->
name|rx_mgmt
operator|.
name|frame_len
operator|>
literal|24
condition|)
block|{
specifier|const
name|u8
modifier|*
name|src
init|=
name|mgmt
operator|->
name|sa
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
init|=
name|mgmt
operator|->
name|u
operator|.
name|probe_req
operator|.
name|variable
decl_stmt|;
name|size_t
name|ie_len
init|=
name|data
operator|->
name|rx_mgmt
operator|.
name|frame_len
operator|-
operator|(
name|mgmt
operator|->
name|u
operator|.
name|probe_req
operator|.
name|variable
operator|-
name|data
operator|->
name|rx_mgmt
operator|.
name|frame
operator|)
decl_stmt|;
name|wpas_p2p_probe_req_rx
argument_list|(
name|wpa_s
argument_list|,
name|src
argument_list|,
name|mgmt
operator|->
name|da
argument_list|,
name|mgmt
operator|->
name|bssid
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|,
name|data
operator|->
name|rx_mgmt
operator|.
name|ssi_signal
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"AP: ignore received "
literal|"management frame in non-AP mode"
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|stype
operator|==
name|WLAN_FC_STYPE_PROBE_REQ
operator|&&
name|data
operator|->
name|rx_mgmt
operator|.
name|frame_len
operator|>
literal|24
condition|)
block|{
specifier|const
name|u8
modifier|*
name|ie
init|=
name|mgmt
operator|->
name|u
operator|.
name|probe_req
operator|.
name|variable
decl_stmt|;
name|size_t
name|ie_len
init|=
name|data
operator|->
name|rx_mgmt
operator|.
name|frame_len
operator|-
operator|(
name|mgmt
operator|->
name|u
operator|.
name|probe_req
operator|.
name|variable
operator|-
name|data
operator|->
name|rx_mgmt
operator|.
name|frame
operator|)
decl_stmt|;
name|wpas_notify_preq
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|mgmt
operator|->
name|da
argument_list|,
name|mgmt
operator|->
name|bssid
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|,
name|data
operator|->
name|rx_mgmt
operator|.
name|ssi_signal
argument_list|)
expr_stmt|;
block|}
name|ap_mgmt_rx
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|rx_mgmt
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
case|case
name|EVENT_RX_ACTION
case|:
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Received Action frame: SA="
name|MACSTR
literal|" Category=%u DataLen=%d freq=%d MHz"
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|rx_action
operator|.
name|sa
argument_list|)
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|category
argument_list|,
operator|(
name|int
operator|)
name|data
operator|->
name|rx_action
operator|.
name|len
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|freq
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|data
operator|->
name|rx_action
operator|.
name|category
operator|==
name|WLAN_ACTION_FT
condition|)
block|{
name|ft_rx_action
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|data
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
ifdef|#
directive|ifdef
name|CONFIG_SME
if|if
condition|(
name|data
operator|->
name|rx_action
operator|.
name|category
operator|==
name|WLAN_ACTION_SA_QUERY
condition|)
block|{
name|sme_sa_query_rx
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|sa
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|data
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_SME */
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_WNM
if|if
condition|(
name|data
operator|->
name|rx_action
operator|.
name|category
operator|==
name|WLAN_ACTION_WNM
condition|)
block|{
name|ieee802_11_rx_wnm_action
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|rx_action
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_WNM */
ifdef|#
directive|ifdef
name|CONFIG_GAS
if|if
condition|(
name|data
operator|->
name|rx_action
operator|.
name|category
operator|==
name|WLAN_ACTION_PUBLIC
operator|&&
name|gas_query_rx
argument_list|(
name|wpa_s
operator|->
name|gas
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|da
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|sa
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|bssid
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|data
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|len
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|freq
argument_list|)
operator|==
literal|0
condition|)
break|break;
endif|#
directive|endif
comment|/* CONFIG_GAS */
ifdef|#
directive|ifdef
name|CONFIG_TDLS
if|if
condition|(
name|data
operator|->
name|rx_action
operator|.
name|category
operator|==
name|WLAN_ACTION_PUBLIC
operator|&&
name|data
operator|->
name|rx_action
operator|.
name|len
operator|>=
literal|4
operator|&&
name|data
operator|->
name|rx_action
operator|.
name|data
index|[
literal|0
index|]
operator|==
name|WLAN_TDLS_DISCOVERY_RESPONSE
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"TDLS: Received Discovery "
literal|"Response from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|rx_action
operator|.
name|sa
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_TDLS */
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_rx_action
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|da
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|sa
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|bssid
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|category
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|data
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|len
argument_list|,
name|data
operator|->
name|rx_action
operator|.
name|freq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
break|break;
case|case
name|EVENT_RX_PROBE_REQ
case|:
if|if
condition|(
name|data
operator|->
name|rx_probe_req
operator|.
name|sa
operator|==
name|NULL
operator|||
name|data
operator|->
name|rx_probe_req
operator|.
name|ie
operator|==
name|NULL
condition|)
break|break;
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|hostapd_probe_req_rx
argument_list|(
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|sa
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|da
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|bssid
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ie
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ie_len
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ssi_signal
argument_list|)
expr_stmt|;
break|break;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_probe_req_rx
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|sa
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|da
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|bssid
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ie
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ie_len
argument_list|,
name|data
operator|->
name|rx_probe_req
operator|.
name|ssi_signal
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
break|break;
case|case
name|EVENT_REMAIN_ON_CHANNEL
case|:
ifdef|#
directive|ifdef
name|CONFIG_OFFCHANNEL
name|offchannel_remain_on_channel_cb
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|remain_on_channel
operator|.
name|freq
argument_list|,
name|data
operator|->
name|remain_on_channel
operator|.
name|duration
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_OFFCHANNEL */
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_remain_on_channel_cb
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|remain_on_channel
operator|.
name|freq
argument_list|,
name|data
operator|->
name|remain_on_channel
operator|.
name|duration
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
break|break;
case|case
name|EVENT_CANCEL_REMAIN_ON_CHANNEL
case|:
ifdef|#
directive|ifdef
name|CONFIG_OFFCHANNEL
name|offchannel_cancel_remain_on_channel_cb
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|remain_on_channel
operator|.
name|freq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_OFFCHANNEL */
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_cancel_remain_on_channel_cb
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|remain_on_channel
operator|.
name|freq
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
break|break;
ifdef|#
directive|ifdef
name|CONFIG_P2P
case|case
name|EVENT_P2P_DEV_FOUND
case|:
block|{
name|struct
name|p2p_peer_info
name|peer_info
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|peer_info
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|peer_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|p2p_dev_found
operator|.
name|dev_addr
condition|)
name|os_memcpy
argument_list|(
name|peer_info
operator|.
name|p2p_device_addr
argument_list|,
name|data
operator|->
name|p2p_dev_found
operator|.
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|p2p_dev_found
operator|.
name|pri_dev_type
condition|)
name|os_memcpy
argument_list|(
name|peer_info
operator|.
name|pri_dev_type
argument_list|,
name|data
operator|->
name|p2p_dev_found
operator|.
name|pri_dev_type
argument_list|,
sizeof|sizeof
argument_list|(
name|peer_info
operator|.
name|pri_dev_type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|p2p_dev_found
operator|.
name|dev_name
condition|)
name|os_strlcpy
argument_list|(
name|peer_info
operator|.
name|device_name
argument_list|,
name|data
operator|->
name|p2p_dev_found
operator|.
name|dev_name
argument_list|,
sizeof|sizeof
argument_list|(
name|peer_info
operator|.
name|device_name
argument_list|)
argument_list|)
expr_stmt|;
name|peer_info
operator|.
name|config_methods
operator|=
name|data
operator|->
name|p2p_dev_found
operator|.
name|config_methods
expr_stmt|;
name|peer_info
operator|.
name|dev_capab
operator|=
name|data
operator|->
name|p2p_dev_found
operator|.
name|dev_capab
expr_stmt|;
name|peer_info
operator|.
name|group_capab
operator|=
name|data
operator|->
name|p2p_dev_found
operator|.
name|group_capab
expr_stmt|;
comment|/* 		 * FIX: new_device=1 is not necessarily correct. We should 		 * maintain a P2P peer database in wpa_supplicant and update 		 * this information based on whether the peer is truly new. 		 */
name|wpas_dev_found
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|p2p_dev_found
operator|.
name|addr
argument_list|,
operator|&
name|peer_info
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|EVENT_P2P_GO_NEG_REQ_RX
case|:
name|wpas_go_neg_req_rx
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|p2p_go_neg_req_rx
operator|.
name|src
argument_list|,
name|data
operator|->
name|p2p_go_neg_req_rx
operator|.
name|dev_passwd_id
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_P2P_GO_NEG_COMPLETED
case|:
name|wpas_go_neg_completed
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|p2p_go_neg_completed
operator|.
name|res
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_P2P_PROV_DISC_REQUEST
case|:
name|wpas_prov_disc_req
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|p2p_prov_disc_req
operator|.
name|peer
argument_list|,
name|data
operator|->
name|p2p_prov_disc_req
operator|.
name|config_methods
argument_list|,
name|data
operator|->
name|p2p_prov_disc_req
operator|.
name|dev_addr
argument_list|,
name|data
operator|->
name|p2p_prov_disc_req
operator|.
name|pri_dev_type
argument_list|,
name|data
operator|->
name|p2p_prov_disc_req
operator|.
name|dev_name
argument_list|,
name|data
operator|->
name|p2p_prov_disc_req
operator|.
name|supp_config_methods
argument_list|,
name|data
operator|->
name|p2p_prov_disc_req
operator|.
name|dev_capab
argument_list|,
name|data
operator|->
name|p2p_prov_disc_req
operator|.
name|group_capab
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_P2P_PROV_DISC_RESPONSE
case|:
name|wpas_prov_disc_resp
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|p2p_prov_disc_resp
operator|.
name|peer
argument_list|,
name|data
operator|->
name|p2p_prov_disc_resp
operator|.
name|config_methods
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_P2P_SD_REQUEST
case|:
name|wpas_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|p2p_sd_req
operator|.
name|freq
argument_list|,
name|data
operator|->
name|p2p_sd_req
operator|.
name|sa
argument_list|,
name|data
operator|->
name|p2p_sd_req
operator|.
name|dialog_token
argument_list|,
name|data
operator|->
name|p2p_sd_req
operator|.
name|update_indic
argument_list|,
name|data
operator|->
name|p2p_sd_req
operator|.
name|tlvs
argument_list|,
name|data
operator|->
name|p2p_sd_req
operator|.
name|tlvs_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_P2P_SD_RESPONSE
case|:
name|wpas_sd_response
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|p2p_sd_resp
operator|.
name|sa
argument_list|,
name|data
operator|->
name|p2p_sd_resp
operator|.
name|update_indic
argument_list|,
name|data
operator|->
name|p2p_sd_resp
operator|.
name|tlvs
argument_list|,
name|data
operator|->
name|p2p_sd_resp
operator|.
name|tlvs_len
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_P2P */
case|case
name|EVENT_EAPOL_RX
case|:
name|wpa_supplicant_rx_eapol
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|eapol_rx
operator|.
name|src
argument_list|,
name|data
operator|->
name|eapol_rx
operator|.
name|data
argument_list|,
name|data
operator|->
name|eapol_rx
operator|.
name|data_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_SIGNAL_CHANGE
case|:
name|bgscan_notify_signal_change
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|signal_change
operator|.
name|above_threshold
argument_list|,
name|data
operator|->
name|signal_change
operator|.
name|current_signal
argument_list|,
name|data
operator|->
name|signal_change
operator|.
name|current_noise
argument_list|,
name|data
operator|->
name|signal_change
operator|.
name|current_txrate
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_INTERFACE_ENABLED
case|:
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interface was enabled"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_INTERFACE_DISABLED
condition|)
block|{
name|wpa_supplicant_update_mac_addr
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_COMPLETED
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* CONFIG_AP */
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
block|}
break|break;
case|case
name|EVENT_INTERFACE_DISABLED
case|:
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interface was disabled"
argument_list|)
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_INTERFACE_DISABLED
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_CHANNEL_LIST_CHANGED
case|:
if|if
condition|(
name|wpa_s
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
break|break;
comment|/* Ignore event during drv initialization */
name|free_hw_features
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|hw
operator|.
name|modes
operator|=
name|wpa_drv_get_hw_feature_data
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
argument_list|,
operator|&
name|wpa_s
operator|->
name|hw
operator|.
name|flags
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_update_channel_list
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
break|break;
case|case
name|EVENT_INTERFACE_UNAVAILABLE
case|:
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_interface_unavailable
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
break|break;
case|case
name|EVENT_BEST_CHANNEL
case|:
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Best channel event received "
literal|"(%d %d %d)"
argument_list|,
name|data
operator|->
name|best_chan
operator|.
name|freq_24
argument_list|,
name|data
operator|->
name|best_chan
operator|.
name|freq_5
argument_list|,
name|data
operator|->
name|best_chan
operator|.
name|freq_overall
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|best_24_freq
operator|=
name|data
operator|->
name|best_chan
operator|.
name|freq_24
expr_stmt|;
name|wpa_s
operator|->
name|best_5_freq
operator|=
name|data
operator|->
name|best_chan
operator|.
name|freq_5
expr_stmt|;
name|wpa_s
operator|->
name|best_overall_freq
operator|=
name|data
operator|->
name|best_chan
operator|.
name|freq_overall
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|wpas_p2p_update_best_channels
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|best_chan
operator|.
name|freq_24
argument_list|,
name|data
operator|->
name|best_chan
operator|.
name|freq_5
argument_list|,
name|data
operator|->
name|best_chan
operator|.
name|freq_overall
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
break|break;
case|case
name|EVENT_UNPROT_DEAUTH
case|:
name|wpa_supplicant_event_unprot_deauth
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|unprot_deauth
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_UNPROT_DISASSOC
case|:
name|wpa_supplicant_event_unprot_disassoc
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|unprot_disassoc
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_STATION_LOW_ACK
case|:
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|&&
name|data
condition|)
name|hostapd_event_sta_low_ack
argument_list|(
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|,
name|data
operator|->
name|low_ack
operator|.
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
ifdef|#
directive|ifdef
name|CONFIG_TDLS
if|if
condition|(
name|data
condition|)
name|wpa_tdls_disable_link
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|low_ack
operator|.
name|addr
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TDLS */
break|break;
case|case
name|EVENT_IBSS_PEER_LOST
case|:
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
name|ibss_rsn_stop
argument_list|(
name|wpa_s
operator|->
name|ibss_rsn
argument_list|,
name|data
operator|->
name|ibss_peer_lost
operator|.
name|peer
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
break|break;
case|case
name|EVENT_DRIVER_GTK_REKEY
case|:
if|if
condition|(
name|os_memcmp
argument_list|(
name|data
operator|->
name|driver_gtk_rekey
operator|.
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
condition|)
break|break;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wpa
condition|)
break|break;
name|wpa_sm_update_replay_ctr
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|data
operator|->
name|driver_gtk_rekey
operator|.
name|replay_ctr
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_SCHED_SCAN_STOPPED
case|:
name|wpa_s
operator|->
name|sched_scanning
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_notify_scanning
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_INTERFACE_DISABLED
condition|)
break|break;
comment|/* 		 * If we timed out, start a new sched scan to continue 		 * searching for more SSIDs. 		 */
if|if
condition|(
name|wpa_s
operator|->
name|sched_scan_timed_out
condition|)
name|wpa_supplicant_req_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_WPS_BUTTON_PUSHED
case|:
ifdef|#
directive|ifdef
name|CONFIG_WPS
name|wpas_wps_start_pbc
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
break|break;
default|default:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Unknown event %d"
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Interworking (IEEE 802.11u)  * Copyright (c) 2011-2013, Qualcomm Atheros, Inc.  * Copyright (c) 2011-2014, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/gas.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"utils/pcsc_funcs.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_defs.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap_methods.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"gas_query.h"
end_include

begin_include
include|#
directive|include
file|"hs20_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"interworking.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|EAP_SIM
argument_list|)
operator||
name|defined
argument_list|(
name|EAP_SIM_DYNAMIC
argument_list|)
end_if

begin_define
define|#
directive|define
name|INTERWORKING_3GPP
end_define

begin_else
else|#
directive|else
end_else

begin_if
if|#
directive|if
name|defined
argument_list|(
name|EAP_AKA
argument_list|)
operator||
name|defined
argument_list|(
name|EAP_AKA_DYNAMIC
argument_list|)
end_if

begin_define
define|#
directive|define
name|INTERWORKING_3GPP
end_define

begin_else
else|#
directive|else
end_else

begin_if
if|#
directive|if
name|defined
argument_list|(
name|EAP_AKA_PRIME
argument_list|)
operator||
name|defined
argument_list|(
name|EAP_AKA_PRIME_DYNAMIC
argument_list|)
end_if

begin_define
define|#
directive|define
name|INTERWORKING_3GPP
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|interworking_next_anqp_fetch
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|wpa_cred
modifier|*
name|interworking_credentials_available_realm
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
name|ignore_bw
parameter_list|,
name|int
modifier|*
name|excluded
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|wpa_cred
modifier|*
name|interworking_credentials_available_3gpp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
name|ignore_bw
parameter_list|,
name|int
modifier|*
name|excluded
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|int
name|cred_prio_cmp
parameter_list|(
specifier|const
name|struct
name|wpa_cred
modifier|*
name|a
parameter_list|,
specifier|const
name|struct
name|wpa_cred
modifier|*
name|b
parameter_list|)
block|{
if|if
condition|(
name|a
operator|->
name|priority
operator|>
name|b
operator|->
name|priority
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|a
operator|->
name|priority
operator|<
name|b
operator|->
name|priority
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|a
operator|->
name|provisioning_sp
operator|==
name|NULL
operator|||
name|b
operator|->
name|provisioning_sp
operator|==
name|NULL
operator|||
name|os_strcmp
argument_list|(
name|a
operator|->
name|provisioning_sp
argument_list|,
name|b
operator|->
name|provisioning_sp
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|a
operator|->
name|sp_priority
operator|<
name|b
operator|->
name|sp_priority
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|a
operator|->
name|sp_priority
operator|>
name|b
operator|->
name|sp_priority
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|interworking_reconnect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|unsigned
name|int
name|tried
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_AUTHENTICATING
condition|)
block|{
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|own_disconnect_req
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|disconnected
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|tried
operator|=
name|wpa_s
operator|->
name|interworking_fast_assoc_tried
expr_stmt|;
name|wpa_s
operator|->
name|interworking_fast_assoc_tried
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|tried
operator|&&
name|wpa_supplicant_fast_associate
argument_list|(
name|wpa_s
argument_list|)
operator|>=
literal|0
condition|)
return|return;
name|wpa_s
operator|->
name|interworking_fast_assoc_tried
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|anqp_build_req
parameter_list|(
name|u16
name|info_ids
index|[]
parameter_list|,
name|size_t
name|num_ids
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|extra
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|buf
operator|=
name|gas_anqp_build_initial_req
argument_list|(
literal|0
argument_list|,
literal|4
operator|+
name|num_ids
operator|*
literal|2
operator|+
operator|(
name|extra
condition|?
name|wpabuf_len
argument_list|(
name|extra
argument_list|)
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|len_pos
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_QUERY_LIST
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_ids
condition|;
name|i
operator|++
control|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|info_ids
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len_pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|extra
condition|)
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|extra
argument_list|)
expr_stmt|;
name|gas_anqp_set_len
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|interworking_anqp_resp_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|enum
name|gas_query_result
name|result
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|adv_proto
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u16
name|status_code
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Response callback dst="
name|MACSTR
literal|" dialog_token=%u result=%d status_code=%u"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
name|dialog_token
argument_list|,
name|result
argument_list|,
name|status_code
argument_list|)
expr_stmt|;
name|anqp_resp_cb
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|dialog_token
argument_list|,
name|result
argument_list|,
name|adv_proto
argument_list|,
name|resp
argument_list|,
name|status_code
argument_list|)
expr_stmt|;
name|interworking_next_anqp_fetch
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|cred_with_roaming_consortium
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cred
operator|->
name|roaming_consortium_len
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|cred
operator|->
name|required_roaming_consortium_len
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cred_with_3gpp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cred
operator|->
name|pcsc
operator|||
name|cred
operator|->
name|imsi
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cred_with_nai_realm
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cred
operator|->
name|pcsc
operator|||
name|cred
operator|->
name|imsi
condition|)
continue|continue;
if|if
condition|(
operator|!
name|cred
operator|->
name|eap_method
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|cred
operator|->
name|realm
operator|&&
name|cred
operator|->
name|roaming_consortium_len
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cred_with_domain
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cred
operator|->
name|domain
operator|||
name|cred
operator|->
name|pcsc
operator|||
name|cred
operator|->
name|imsi
operator|||
name|cred
operator|->
name|roaming_partner
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_HS20
end_ifdef

begin_function
specifier|static
name|int
name|cred_with_min_backhaul
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cred
operator|->
name|min_dl_bandwidth_home
operator|||
name|cred
operator|->
name|min_ul_bandwidth_home
operator|||
name|cred
operator|->
name|min_dl_bandwidth_roaming
operator|||
name|cred
operator|->
name|min_ul_bandwidth_roaming
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cred_with_conn_capab
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cred
operator|->
name|num_req_conn_capab
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_HS20 */
end_comment

begin_function
specifier|static
name|int
name|additional_roaming_consortiums
parameter_list|(
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_ROAMING_CONSORTIUM
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
operator|||
name|ie
index|[
literal|1
index|]
operator|==
literal|0
condition|)
return|return
literal|0
return|;
return|return
name|ie
index|[
literal|2
index|]
return|;
comment|/* Number of ANQP OIs */
block|}
end_function

begin_function
specifier|static
name|void
name|interworking_continue_anqp
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|interworking_next_anqp_fetch
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|interworking_anqp_send_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|res
decl_stmt|;
name|u16
name|info_ids
index|[
literal|8
index|]
decl_stmt|;
name|size_t
name|num_info_ids
init|=
literal|0
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|extra
init|=
name|NULL
decl_stmt|;
name|int
name|all
init|=
name|wpa_s
operator|->
name|fetch_all_anqp
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: ANQP Query Request to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|interworking_gas_bss
operator|=
name|bss
expr_stmt|;
name|info_ids
index|[
name|num_info_ids
operator|++
index|]
operator|=
name|ANQP_CAPABILITY_LIST
expr_stmt|;
if|if
condition|(
name|all
condition|)
block|{
name|info_ids
index|[
name|num_info_ids
operator|++
index|]
operator|=
name|ANQP_VENUE_NAME
expr_stmt|;
name|info_ids
index|[
name|num_info_ids
operator|++
index|]
operator|=
name|ANQP_NETWORK_AUTH_TYPE
expr_stmt|;
block|}
if|if
condition|(
name|all
operator|||
operator|(
name|cred_with_roaming_consortium
argument_list|(
name|wpa_s
argument_list|)
operator|&&
name|additional_roaming_consortiums
argument_list|(
name|bss
argument_list|)
operator|)
condition|)
name|info_ids
index|[
name|num_info_ids
operator|++
index|]
operator|=
name|ANQP_ROAMING_CONSORTIUM
expr_stmt|;
if|if
condition|(
name|all
condition|)
name|info_ids
index|[
name|num_info_ids
operator|++
index|]
operator|=
name|ANQP_IP_ADDR_TYPE_AVAILABILITY
expr_stmt|;
if|if
condition|(
name|all
operator|||
name|cred_with_nai_realm
argument_list|(
name|wpa_s
argument_list|)
condition|)
name|info_ids
index|[
name|num_info_ids
operator|++
index|]
operator|=
name|ANQP_NAI_REALM
expr_stmt|;
if|if
condition|(
name|all
operator|||
name|cred_with_3gpp
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|info_ids
index|[
name|num_info_ids
operator|++
index|]
operator|=
name|ANQP_3GPP_CELLULAR_NETWORK
expr_stmt|;
name|wpa_supplicant_scard_init
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|all
operator|||
name|cred_with_domain
argument_list|(
name|wpa_s
argument_list|)
condition|)
name|info_ids
index|[
name|num_info_ids
operator|++
index|]
operator|=
name|ANQP_DOMAIN_NAME
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: ANQP Query info"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|info_ids
argument_list|,
name|num_info_ids
operator|*
literal|2
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HS20
if|if
condition|(
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|HS20_IE_VENDOR_TYPE
argument_list|)
condition|)
block|{
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|extra
operator|=
name|wpabuf_alloc
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|extra
condition|)
return|return
operator|-
literal|1
return|;
name|len_pos
operator|=
name|gas_anqp_add_element
argument_list|(
name|extra
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_be24
argument_list|(
name|extra
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|extra
argument_list|,
name|HS20_ANQP_OUI_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|extra
argument_list|,
name|HS20_STYPE_QUERY_LIST
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|extra
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
name|wpabuf_put_u8
argument_list|(
name|extra
argument_list|,
name|HS20_STYPE_CAPABILITY_LIST
argument_list|)
expr_stmt|;
if|if
condition|(
name|all
condition|)
name|wpabuf_put_u8
argument_list|(
name|extra
argument_list|,
name|HS20_STYPE_OPERATOR_FRIENDLY_NAME
argument_list|)
expr_stmt|;
if|if
condition|(
name|all
operator|||
name|cred_with_min_backhaul
argument_list|(
name|wpa_s
argument_list|)
condition|)
name|wpabuf_put_u8
argument_list|(
name|extra
argument_list|,
name|HS20_STYPE_WAN_METRICS
argument_list|)
expr_stmt|;
if|if
condition|(
name|all
operator|||
name|cred_with_conn_capab
argument_list|(
name|wpa_s
argument_list|)
condition|)
name|wpabuf_put_u8
argument_list|(
name|extra
argument_list|,
name|HS20_STYPE_CONNECTION_CAPABILITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|all
condition|)
name|wpabuf_put_u8
argument_list|(
name|extra
argument_list|,
name|HS20_STYPE_OPERATING_CLASS
argument_list|)
expr_stmt|;
if|if
condition|(
name|all
condition|)
name|wpabuf_put_u8
argument_list|(
name|extra
argument_list|,
name|HS20_STYPE_OSU_PROVIDERS_LIST
argument_list|)
expr_stmt|;
name|gas_anqp_set_element_len
argument_list|(
name|extra
argument_list|,
name|len_pos
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_HS20 */
name|buf
operator|=
name|anqp_build_req
argument_list|(
name|info_ids
argument_list|,
name|num_info_ids
argument_list|,
name|extra
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|extra
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|gas_query_req
argument_list|(
name|wpa_s
operator|->
name|gas
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|freq
argument_list|,
name|buf
argument_list|,
name|interworking_anqp_resp_cb
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Failed to send Query Request"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|interworking_continue_anqp
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Query started with dialog token %u"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_struct
struct|struct
name|nai_realm_eap
block|{
name|u8
name|method
decl_stmt|;
name|u8
name|inner_method
decl_stmt|;
name|enum
name|nai_realm_eap_auth_inner_non_eap
name|inner_non_eap
decl_stmt|;
name|u8
name|cred_type
decl_stmt|;
name|u8
name|tunneled_cred_type
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|nai_realm
block|{
name|u8
name|encoding
decl_stmt|;
name|char
modifier|*
name|realm
decl_stmt|;
name|u8
name|eap_count
decl_stmt|;
name|struct
name|nai_realm_eap
modifier|*
name|eap
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|nai_realm_free
parameter_list|(
name|struct
name|nai_realm
modifier|*
name|realms
parameter_list|,
name|u16
name|count
parameter_list|)
block|{
name|u16
name|i
decl_stmt|;
if|if
condition|(
name|realms
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
name|os_free
argument_list|(
name|realms
index|[
name|i
index|]
operator|.
name|eap
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|realms
index|[
name|i
index|]
operator|.
name|realm
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|realms
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|nai_realm_parse_eap
parameter_list|(
name|struct
name|nai_realm_eap
modifier|*
name|e
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|u8
name|elen
decl_stmt|,
name|auth_count
decl_stmt|,
name|a
decl_stmt|;
specifier|const
name|u8
modifier|*
name|e_end
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|3
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No room for EAP Method fixed fields"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|elen
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|elen
operator|>
name|end
operator|||
name|elen
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No room for EAP Method subfield"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|e_end
operator|=
name|pos
operator|+
name|elen
expr_stmt|;
name|e
operator|->
name|method
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|auth_count
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP Method: len=%u method=%u auth_count=%u"
argument_list|,
name|elen
argument_list|,
name|e
operator|->
name|method
argument_list|,
name|auth_count
argument_list|)
expr_stmt|;
for|for
control|(
name|a
operator|=
literal|0
init|;
name|a
operator|<
name|auth_count
condition|;
name|a
operator|++
control|)
block|{
name|u8
name|id
decl_stmt|,
name|len
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
operator|||
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No room for Authentication "
literal|"Parameter subfield"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|id
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|NAI_REALM_EAP_AUTH_NON_EAP_INNER_AUTH
case|:
if|if
condition|(
name|len
operator|<
literal|1
condition|)
break|break;
name|e
operator|->
name|inner_non_eap
operator|=
operator|*
name|pos
expr_stmt|;
if|if
condition|(
name|e
operator|->
name|method
operator|!=
name|EAP_TYPE_TTLS
condition|)
break|break;
switch|switch
condition|(
operator|*
name|pos
condition|)
block|{
case|case
name|NAI_REALM_INNER_NON_EAP_PAP
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-TTLS/PAP"
argument_list|)
expr_stmt|;
break|break;
case|case
name|NAI_REALM_INNER_NON_EAP_CHAP
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-TTLS/CHAP"
argument_list|)
expr_stmt|;
break|break;
case|case
name|NAI_REALM_INNER_NON_EAP_MSCHAP
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-TTLS/MSCHAP"
argument_list|)
expr_stmt|;
break|break;
case|case
name|NAI_REALM_INNER_NON_EAP_MSCHAPV2
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP-TTLS/MSCHAPV2"
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
name|NAI_REALM_EAP_AUTH_INNER_AUTH_EAP_METHOD
case|:
if|if
condition|(
name|len
operator|<
literal|1
condition|)
break|break;
name|e
operator|->
name|inner_method
operator|=
operator|*
name|pos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Inner EAP method: %u"
argument_list|,
name|e
operator|->
name|inner_method
argument_list|)
expr_stmt|;
break|break;
case|case
name|NAI_REALM_EAP_AUTH_CRED_TYPE
case|:
if|if
condition|(
name|len
operator|<
literal|1
condition|)
break|break;
name|e
operator|->
name|cred_type
operator|=
operator|*
name|pos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Credential Type: %u"
argument_list|,
name|e
operator|->
name|cred_type
argument_list|)
expr_stmt|;
break|break;
case|case
name|NAI_REALM_EAP_AUTH_TUNNELED_CRED_TYPE
case|:
if|if
condition|(
name|len
operator|<
literal|1
condition|)
break|break;
name|e
operator|->
name|tunneled_cred_type
operator|=
operator|*
name|pos
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Tunneled EAP Method Credential "
literal|"Type: %u"
argument_list|,
name|e
operator|->
name|tunneled_cred_type
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unsupported Authentication "
literal|"Parameter: id=%u len=%u"
argument_list|,
name|id
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Authentication Parameter "
literal|"Value"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|+=
name|len
expr_stmt|;
block|}
return|return
name|e_end
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|nai_realm_parse_realm
parameter_list|(
name|struct
name|nai_realm
modifier|*
name|r
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
name|u16
name|len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|f_end
decl_stmt|;
name|u8
name|realm_len
decl_stmt|,
name|e
decl_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|4
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No room for NAI Realm Data "
literal|"fixed fields"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|len
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
comment|/* NAI Realm Data field Length */
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|len
operator|>
name|end
operator|||
name|len
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No room for NAI Realm Data "
literal|"(len=%u; left=%u)"
argument_list|,
name|len
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|f_end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
name|r
operator|->
name|encoding
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|realm_len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|realm_len
operator|>
name|f_end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No room for NAI Realm "
literal|"(len=%u; left=%u)"
argument_list|,
name|realm_len
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|f_end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NAI Realm"
argument_list|,
name|pos
argument_list|,
name|realm_len
argument_list|)
expr_stmt|;
name|r
operator|->
name|realm
operator|=
name|dup_binstr
argument_list|(
name|pos
argument_list|,
name|realm_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|realm
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|pos
operator|+=
name|realm_len
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>
name|f_end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No room for EAP Method Count"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|r
operator|->
name|eap_count
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP Count: %u"
argument_list|,
name|r
operator|->
name|eap_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|r
operator|->
name|eap_count
operator|*
literal|3
operator|>
name|f_end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No room for EAP Methods"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|r
operator|->
name|eap
operator|=
name|os_calloc
argument_list|(
name|r
operator|->
name|eap_count
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nai_realm_eap
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|->
name|eap
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|e
operator|=
literal|0
init|;
name|e
operator|<
name|r
operator|->
name|eap_count
condition|;
name|e
operator|++
control|)
block|{
name|pos
operator|=
name|nai_realm_parse_eap
argument_list|(
operator|&
name|r
operator|->
name|eap
index|[
name|e
index|]
argument_list|,
name|pos
argument_list|,
name|f_end
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
block|}
return|return
name|f_end
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|nai_realm
modifier|*
name|nai_realm_parse
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|anqp
parameter_list|,
name|u16
modifier|*
name|count
parameter_list|)
block|{
name|struct
name|nai_realm
modifier|*
name|realm
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u16
name|i
decl_stmt|,
name|num
decl_stmt|;
name|size_t
name|left
decl_stmt|;
if|if
condition|(
name|anqp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|left
operator|=
name|wpabuf_len
argument_list|(
name|anqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|left
operator|<
literal|2
condition|)
return|return
name|NULL
return|;
name|pos
operator|=
name|wpabuf_head_u8
argument_list|(
name|anqp
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|left
expr_stmt|;
name|num
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NAI Realm Count: %u"
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|left
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|num
operator|>
name|left
operator|/
literal|5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid NAI Realm Count %u - not "
literal|"enough data (%u octets) for that many realms"
argument_list|,
name|num
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|left
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|realm
operator|=
name|os_calloc
argument_list|(
name|num
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|nai_realm
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|pos
operator|=
name|nai_realm_parse_realm
argument_list|(
operator|&
name|realm
index|[
name|i
index|]
argument_list|,
name|pos
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|nai_realm_free
argument_list|(
name|realm
argument_list|,
name|num
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
block|}
operator|*
name|count
operator|=
name|num
expr_stmt|;
return|return
name|realm
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nai_realm_match
parameter_list|(
name|struct
name|nai_realm
modifier|*
name|realm
parameter_list|,
specifier|const
name|char
modifier|*
name|home_realm
parameter_list|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|match
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|realm
operator|->
name|realm
operator|==
name|NULL
operator|||
name|home_realm
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|os_strchr
argument_list|(
name|realm
operator|->
name|realm
argument_list|,
literal|';'
argument_list|)
operator|==
name|NULL
condition|)
return|return
name|os_strcasecmp
argument_list|(
name|realm
operator|->
name|realm
argument_list|,
name|home_realm
argument_list|)
operator|==
literal|0
return|;
name|tmp
operator|=
name|os_strdup
argument_list|(
name|realm
operator|->
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|pos
operator|=
name|tmp
expr_stmt|;
while|while
condition|(
operator|*
name|pos
condition|)
block|{
name|end
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|';'
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
condition|)
operator|*
name|end
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|os_strcasecmp
argument_list|(
name|pos
argument_list|,
name|home_realm
argument_list|)
operator|==
literal|0
condition|)
block|{
name|match
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|end
operator|==
name|NULL
condition|)
break|break;
name|pos
operator|=
name|end
operator|+
literal|1
expr_stmt|;
block|}
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|match
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nai_realm_cred_username
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|nai_realm_eap
modifier|*
name|eap
parameter_list|)
block|{
if|if
condition|(
name|eap_get_name
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|eap
operator|->
name|method
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nai-realm-cred-username: EAP method not supported: %d"
argument_list|,
name|eap
operator|->
name|method
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
comment|/* method not supported */
block|}
if|if
condition|(
name|eap
operator|->
name|method
operator|!=
name|EAP_TYPE_TTLS
operator|&&
name|eap
operator|->
name|method
operator|!=
name|EAP_TYPE_PEAP
operator|&&
name|eap
operator|->
name|method
operator|!=
name|EAP_TYPE_FAST
condition|)
block|{
comment|/* Only tunneled methods with username/password supported */
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nai-realm-cred-username: Method: %d is not TTLS, PEAP, or FAST"
argument_list|,
name|eap
operator|->
name|method
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|eap
operator|->
name|method
operator|==
name|EAP_TYPE_PEAP
operator|||
name|eap
operator|->
name|method
operator|==
name|EAP_TYPE_FAST
condition|)
block|{
if|if
condition|(
name|eap
operator|->
name|inner_method
operator|&&
name|eap_get_name
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|eap
operator|->
name|inner_method
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nai-realm-cred-username: PEAP/FAST: Inner method not supported: %d"
argument_list|,
name|eap
operator|->
name|inner_method
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|eap
operator|->
name|inner_method
operator|&&
name|eap_get_name
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|EAP_TYPE_MSCHAPV2
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nai-realm-cred-username: MSCHAPv2 not supported"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|eap
operator|->
name|method
operator|==
name|EAP_TYPE_TTLS
condition|)
block|{
if|if
condition|(
name|eap
operator|->
name|inner_method
operator|==
literal|0
operator|&&
name|eap
operator|->
name|inner_non_eap
operator|==
literal|0
condition|)
return|return
literal|1
return|;
comment|/* Assume TTLS/MSCHAPv2 is used */
if|if
condition|(
name|eap
operator|->
name|inner_method
operator|&&
name|eap_get_name
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|eap
operator|->
name|inner_method
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nai-realm-cred-username: TTLS, but inner not supported: %d"
argument_list|,
name|eap
operator|->
name|inner_method
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|eap
operator|->
name|inner_non_eap
operator|&&
name|eap
operator|->
name|inner_non_eap
operator|!=
name|NAI_REALM_INNER_NON_EAP_PAP
operator|&&
name|eap
operator|->
name|inner_non_eap
operator|!=
name|NAI_REALM_INNER_NON_EAP_CHAP
operator|&&
name|eap
operator|->
name|inner_non_eap
operator|!=
name|NAI_REALM_INNER_NON_EAP_MSCHAP
operator|&&
name|eap
operator|->
name|inner_non_eap
operator|!=
name|NAI_REALM_INNER_NON_EAP_MSCHAPV2
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nai-realm-cred-username: TTLS, inner-non-eap not supported: %d"
argument_list|,
name|eap
operator|->
name|inner_non_eap
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
if|if
condition|(
name|eap
operator|->
name|inner_method
operator|&&
name|eap
operator|->
name|inner_method
operator|!=
name|EAP_TYPE_GTC
operator|&&
name|eap
operator|->
name|inner_method
operator|!=
name|EAP_TYPE_MSCHAPV2
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nai-realm-cred-username: inner-method not GTC or MSCHAPv2: %d"
argument_list|,
name|eap
operator|->
name|inner_method
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|nai_realm_cred_cert
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|nai_realm_eap
modifier|*
name|eap
parameter_list|)
block|{
if|if
condition|(
name|eap_get_name
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|eap
operator|->
name|method
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nai-realm-cred-cert: Method not supported: %d"
argument_list|,
name|eap
operator|->
name|method
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
comment|/* method not supported */
block|}
if|if
condition|(
name|eap
operator|->
name|method
operator|!=
name|EAP_TYPE_TLS
condition|)
block|{
comment|/* Only EAP-TLS supported for credential authentication */
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nai-realm-cred-cert: Method not TLS: %d"
argument_list|,
name|eap
operator|->
name|method
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|nai_realm_eap
modifier|*
name|nai_realm_find_eap
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|nai_realm
modifier|*
name|realm
parameter_list|)
block|{
name|u8
name|e
decl_stmt|;
if|if
condition|(
name|cred
operator|->
name|username
operator|==
name|NULL
operator|||
name|cred
operator|->
name|username
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|||
operator|(
operator|(
name|cred
operator|->
name|password
operator|==
name|NULL
operator|||
name|cred
operator|->
name|password
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|)
operator|&&
operator|(
name|cred
operator|->
name|private_key
operator|==
name|NULL
operator|||
name|cred
operator|->
name|private_key
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|)
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"nai-realm-find-eap: incomplete cred info: username: %s  password: %s private_key: %s"
argument_list|,
name|cred
operator|->
name|username
condition|?
name|cred
operator|->
name|username
else|:
literal|"NULL"
argument_list|,
name|cred
operator|->
name|password
condition|?
name|cred
operator|->
name|password
else|:
literal|"NULL"
argument_list|,
name|cred
operator|->
name|private_key
condition|?
name|cred
operator|->
name|private_key
else|:
literal|"NULL"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|e
operator|=
literal|0
init|;
name|e
operator|<
name|realm
operator|->
name|eap_count
condition|;
name|e
operator|++
control|)
block|{
name|struct
name|nai_realm_eap
modifier|*
name|eap
init|=
operator|&
name|realm
operator|->
name|eap
index|[
name|e
index|]
decl_stmt|;
if|if
condition|(
name|cred
operator|->
name|password
operator|&&
name|cred
operator|->
name|password
index|[
literal|0
index|]
operator|&&
name|nai_realm_cred_username
argument_list|(
name|wpa_s
argument_list|,
name|eap
argument_list|)
condition|)
return|return
name|eap
return|;
if|if
condition|(
name|cred
operator|->
name|private_key
operator|&&
name|cred
operator|->
name|private_key
index|[
literal|0
index|]
operator|&&
name|nai_realm_cred_cert
argument_list|(
name|wpa_s
argument_list|,
name|eap
argument_list|)
condition|)
return|return
name|eap
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INTERWORKING_3GPP
end_ifdef

begin_function
specifier|static
name|int
name|plmn_id_match
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|anqp
parameter_list|,
specifier|const
name|char
modifier|*
name|imsi
parameter_list|,
name|int
name|mnc_len
parameter_list|)
block|{
name|u8
name|plmn
index|[
literal|3
index|]
decl_stmt|,
name|plmn2
index|[
literal|3
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|udhl
decl_stmt|;
comment|/* 	 * See Annex A of 3GPP TS 24.234 v8.1.0 for description. The network 	 * operator is allowed to include only two digits of the MNC, so allow 	 * matches based on both two and three digit MNC assumptions. Since some 	 * SIM/USIM cards may not expose MNC length conveniently, we may be 	 * provided the default MNC length 3 here and as such, checking with MNC 	 * length 2 is justifiable even though 3GPP TS 24.234 does not mention 	 * that case. Anyway, MCC/MNC pair where both 2 and 3 digit MNC is used 	 * with otherwise matching values would not be good idea in general, so 	 * this should not result in selecting incorrect networks. 	 */
comment|/* Match with 3 digit MNC */
name|plmn
index|[
literal|0
index|]
operator|=
operator|(
name|imsi
index|[
literal|0
index|]
operator|-
literal|'0'
operator|)
operator||
operator|(
operator|(
name|imsi
index|[
literal|1
index|]
operator|-
literal|'0'
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|plmn
index|[
literal|1
index|]
operator|=
operator|(
name|imsi
index|[
literal|2
index|]
operator|-
literal|'0'
operator|)
operator||
operator|(
operator|(
name|imsi
index|[
literal|5
index|]
operator|-
literal|'0'
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|plmn
index|[
literal|2
index|]
operator|=
operator|(
name|imsi
index|[
literal|3
index|]
operator|-
literal|'0'
operator|)
operator||
operator|(
operator|(
name|imsi
index|[
literal|4
index|]
operator|-
literal|'0'
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
comment|/* Match with 2 digit MNC */
name|plmn2
index|[
literal|0
index|]
operator|=
operator|(
name|imsi
index|[
literal|0
index|]
operator|-
literal|'0'
operator|)
operator||
operator|(
operator|(
name|imsi
index|[
literal|1
index|]
operator|-
literal|'0'
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|plmn2
index|[
literal|1
index|]
operator|=
operator|(
name|imsi
index|[
literal|2
index|]
operator|-
literal|'0'
operator|)
operator||
literal|0xf0
expr_stmt|;
name|plmn2
index|[
literal|2
index|]
operator|=
operator|(
name|imsi
index|[
literal|3
index|]
operator|-
literal|'0'
operator|)
operator||
operator|(
operator|(
name|imsi
index|[
literal|4
index|]
operator|-
literal|'0'
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|anqp
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|pos
operator|=
name|wpabuf_head_u8
argument_list|(
name|anqp
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|anqp
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|*
name|pos
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unsupported GUD version 0x%x"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|udhl
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|udhl
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid UDHL"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|end
operator|=
name|pos
operator|+
name|udhl
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Matching against MCC/MNC alternatives: %02x:%02x:%02x or %02x:%02x:%02x (IMSI %s, MNC length %d)"
argument_list|,
name|plmn
index|[
literal|0
index|]
argument_list|,
name|plmn
index|[
literal|1
index|]
argument_list|,
name|plmn
index|[
literal|2
index|]
argument_list|,
name|plmn2
index|[
literal|0
index|]
argument_list|,
name|plmn2
index|[
literal|1
index|]
argument_list|,
name|plmn2
index|[
literal|2
index|]
argument_list|,
name|imsi
argument_list|,
name|mnc_len
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|2
operator|<=
name|end
condition|)
block|{
name|u8
name|iei
decl_stmt|,
name|len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|l_end
decl_stmt|;
name|iei
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|len
operator|=
operator|*
name|pos
operator|++
operator|&
literal|0x7f
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|len
operator|>
name|end
condition|)
break|break;
name|l_end
operator|=
name|pos
operator|+
name|len
expr_stmt|;
if|if
condition|(
name|iei
operator|==
literal|0
operator|&&
name|len
operator|>
literal|0
condition|)
block|{
comment|/* PLMN List */
name|u8
name|num
decl_stmt|,
name|i
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: PLMN List information element"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|num
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pos
operator|+
literal|3
operator|>
name|l_end
condition|)
break|break;
if|if
condition|(
name|os_memcmp
argument_list|(
name|pos
argument_list|,
name|plmn
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|||
name|os_memcmp
argument_list|(
name|pos
argument_list|,
name|plmn2
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
comment|/* Found matching PLMN */
name|pos
operator|+=
literal|3
expr_stmt|;
block|}
block|}
else|else
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Unrecognized 3GPP information element"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
name|l_end
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|build_root_nai
parameter_list|(
name|char
modifier|*
name|nai
parameter_list|,
name|size_t
name|nai_len
parameter_list|,
specifier|const
name|char
modifier|*
name|imsi
parameter_list|,
name|size_t
name|mnc_len
parameter_list|,
name|char
name|prefix
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|sep
decl_stmt|,
modifier|*
name|msin
decl_stmt|;
name|char
modifier|*
name|end
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|size_t
name|msin_len
decl_stmt|,
name|plmn_len
decl_stmt|;
comment|/* 	 * TS 23.003, Clause 14 (3GPP to WLAN Interworking) 	 * Root NAI: 	 *<aka:0|sim:1><IMSI>@wlan.mnc<MNC>.mcc<MCC>.3gppnetwork.org 	 *<MNC> is zero-padded to three digits in case two-digit MNC is used 	 */
if|if
condition|(
name|imsi
operator|==
name|NULL
operator|||
name|os_strlen
argument_list|(
name|imsi
argument_list|)
operator|>
literal|16
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No valid IMSI available"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|sep
operator|=
name|os_strchr
argument_list|(
name|imsi
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|sep
condition|)
block|{
name|plmn_len
operator|=
name|sep
operator|-
name|imsi
expr_stmt|;
name|msin
operator|=
name|sep
operator|+
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mnc_len
operator|&&
name|os_strlen
argument_list|(
name|imsi
argument_list|)
operator|>=
literal|3
operator|+
name|mnc_len
condition|)
block|{
name|plmn_len
operator|=
literal|3
operator|+
name|mnc_len
expr_stmt|;
name|msin
operator|=
name|imsi
operator|+
name|plmn_len
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|plmn_len
operator|!=
literal|5
operator|&&
name|plmn_len
operator|!=
literal|6
condition|)
return|return
operator|-
literal|1
return|;
name|msin_len
operator|=
name|os_strlen
argument_list|(
name|msin
argument_list|)
expr_stmt|;
name|pos
operator|=
name|nai
expr_stmt|;
name|end
operator|=
name|nai
operator|+
name|nai_len
expr_stmt|;
if|if
condition|(
name|prefix
condition|)
operator|*
name|pos
operator|++
operator|=
name|prefix
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|imsi
argument_list|,
name|plmn_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|plmn_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|msin
argument_list|,
name|msin_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|msin_len
expr_stmt|;
name|pos
operator|+=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"@wlan.mnc"
argument_list|)
expr_stmt|;
if|if
condition|(
name|plmn_len
operator|==
literal|5
condition|)
block|{
operator|*
name|pos
operator|++
operator|=
literal|'0'
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|imsi
index|[
literal|3
index|]
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|imsi
index|[
literal|4
index|]
expr_stmt|;
block|}
else|else
block|{
operator|*
name|pos
operator|++
operator|=
name|imsi
index|[
literal|3
index|]
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|imsi
index|[
literal|4
index|]
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
name|imsi
index|[
literal|5
index|]
expr_stmt|;
block|}
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|".mcc%c%c%c.3gppnetwork.org"
argument_list|,
name|imsi
index|[
literal|0
index|]
argument_list|,
name|imsi
index|[
literal|1
index|]
argument_list|,
name|imsi
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|set_root_nai
parameter_list|(
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
specifier|const
name|char
modifier|*
name|imsi
parameter_list|,
name|char
name|prefix
parameter_list|)
block|{
name|char
name|nai
index|[
literal|100
index|]
decl_stmt|;
if|if
condition|(
name|build_root_nai
argument_list|(
name|nai
argument_list|,
sizeof|sizeof
argument_list|(
name|nai
argument_list|)
argument_list|,
name|imsi
argument_list|,
literal|0
argument_list|,
name|prefix
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"identity"
argument_list|,
name|nai
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* INTERWORKING_3GPP */
end_comment

begin_function
specifier|static
name|int
name|already_connected
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|sel_ssid
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|selected
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|parent_cred
operator|!=
name|cred
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ssid
operator|->
name|ssid_len
operator|!=
name|bss
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
name|sel_ssid
operator|=
name|NULL
expr_stmt|;
name|selected
operator|=
name|wpa_supplicant_pick_network
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|sel_ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|selected
operator|&&
name|sel_ssid
operator|&&
name|sel_ssid
operator|->
name|priority
operator|>
name|ssid
operator|->
name|priority
condition|)
return|return
literal|0
return|;
comment|/* higher priority network in scan results */
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|remove_duplicate_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|parent_cred
operator|!=
name|cred
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|->
name|ssid_len
operator|!=
name|bss
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
break|break;
block|}
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Remove duplicate network entry for the same credential"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|wpa_sm_set_config
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|own_disconnect_req
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|interworking_set_hs20_params
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|key_mgmt
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
name|int
name|res
decl_stmt|;
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
name|res
operator|=
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
operator|&&
name|capa
operator|.
name|key_mgmt
operator|&
name|WPA_DRIVER_CAPA_KEY_MGMT_FT
condition|)
block|{
name|key_mgmt
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|pmf
operator|!=
name|NO_MGMT_FRAME_PROTECTION
condition|?
literal|"WPA-EAP WPA-EAP-SHA256 FT-EAP"
else|:
literal|"WPA-EAP FT-EAP"
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
if|if
condition|(
operator|!
name|key_mgmt
condition|)
name|key_mgmt
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|pmf
operator|!=
name|NO_MGMT_FRAME_PROTECTION
condition|?
literal|"WPA-EAP WPA-EAP-SHA256"
else|:
literal|"WPA-EAP"
expr_stmt|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"key_mgmt"
argument_list|,
name|key_mgmt
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"proto"
argument_list|,
literal|"RSN"
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"pairwise"
argument_list|,
literal|"CCMP"
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|interworking_connect_3gpp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
name|only_add
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|INTERWORKING_3GPP
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|eap_type
decl_stmt|;
name|int
name|res
decl_stmt|;
name|char
name|prefix
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
operator|||
name|bss
operator|->
name|anqp
operator|->
name|anqp_3gpp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Connect with "
name|MACSTR
literal|" (3GPP)"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|already_connected
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|INTERWORKING_ALREADY_CONNECTED MACSTR
argument_list|,
argument|MAC2STR(bss->bssid)
argument_list|)
empty_stmt|;
return|return
name|wpa_s
operator|->
name|current_ssid
operator|->
name|id
return|;
block|}
name|remove_duplicate_network
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ssid
operator|->
name|parent_cred
operator|=
name|cred
expr_stmt|;
name|wpas_notify_network_added
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|priority
operator|=
name|cred
operator|->
name|priority
expr_stmt|;
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_zalloc
argument_list|(
name|bss
operator|->
name|ssid_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|sim_num
operator|=
name|cred
operator|->
name|sim_num
expr_stmt|;
if|if
condition|(
name|interworking_set_hs20_params
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|eap_type
operator|=
name|EAP_TYPE_SIM
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|pcsc
operator|&&
name|wpa_s
operator|->
name|scard
operator|&&
name|scard_supports_umts
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|)
condition|)
name|eap_type
operator|=
name|EAP_TYPE_AKA
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|eap_method
operator|&&
name|cred
operator|->
name|eap_method
index|[
literal|0
index|]
operator|.
name|vendor
operator|==
name|EAP_VENDOR_IETF
condition|)
block|{
if|if
condition|(
name|cred
operator|->
name|eap_method
index|[
literal|0
index|]
operator|.
name|method
operator|==
name|EAP_TYPE_SIM
operator|||
name|cred
operator|->
name|eap_method
index|[
literal|0
index|]
operator|.
name|method
operator|==
name|EAP_TYPE_AKA
operator|||
name|cred
operator|->
name|eap_method
index|[
literal|0
index|]
operator|.
name|method
operator|==
name|EAP_TYPE_AKA_PRIME
condition|)
name|eap_type
operator|=
name|cred
operator|->
name|eap_method
index|[
literal|0
index|]
operator|.
name|method
expr_stmt|;
block|}
switch|switch
condition|(
name|eap_type
condition|)
block|{
case|case
name|EAP_TYPE_SIM
case|:
name|prefix
operator|=
literal|'1'
expr_stmt|;
name|res
operator|=
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"eap"
argument_list|,
literal|"SIM"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_TYPE_AKA
case|:
name|prefix
operator|=
literal|'0'
expr_stmt|;
name|res
operator|=
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"eap"
argument_list|,
literal|"AKA"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|EAP_TYPE_AKA_PRIME
case|:
name|prefix
operator|=
literal|'6'
expr_stmt|;
name|res
operator|=
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"eap"
argument_list|,
literal|"AKA'"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
name|res
operator|=
operator|-
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Selected EAP method (%d) not supported"
argument_list|,
name|eap_type
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
operator|!
name|cred
operator|->
name|pcsc
operator|&&
name|set_root_nai
argument_list|(
name|ssid
argument_list|,
name|cred
operator|->
name|imsi
argument_list|,
name|prefix
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Failed to set Root NAI"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|cred
operator|->
name|milenage
operator|&&
name|cred
operator|->
name|milenage
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"password"
argument_list|,
name|cred
operator|->
name|milenage
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
block|}
elseif|else
if|if
condition|(
name|cred
operator|->
name|pcsc
condition|)
block|{
if|if
condition|(
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"pcsc"
argument_list|,
literal|""
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|pcsc_pin
operator|&&
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"pin"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|pcsc_pin
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
block|}
name|wpa_s
operator|->
name|next_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_config_update_prio_list
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|only_add
condition|)
name|interworking_reconnect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|ssid
operator|->
name|id
return|;
name|fail
label|:
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* INTERWORKING_3GPP */
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|roaming_consortium_element_match
parameter_list|(
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
specifier|const
name|u8
modifier|*
name|rc_id
parameter_list|,
name|size_t
name|rc_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|lens
decl_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|pos
operator|=
name|ie
operator|+
literal|2
expr_stmt|;
name|end
operator|=
name|ie
operator|+
literal|2
operator|+
name|ie
index|[
literal|1
index|]
expr_stmt|;
comment|/* Roaming Consortium element: 	 * Number of ANQP OIs 	 * OI #1 and #2 lengths 	 * OI #1, [OI #2], [OI #3] 	 */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
return|return
literal|0
return|;
name|pos
operator|++
expr_stmt|;
comment|/* skip Number of ANQP OIs */
name|lens
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
operator|(
name|lens
operator|&
literal|0x0f
operator|)
operator|+
operator|(
name|lens
operator|>>
literal|4
operator|)
operator|>
name|end
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|(
name|lens
operator|&
literal|0x0f
operator|)
operator|==
name|rc_len
operator|&&
name|os_memcmp
argument_list|(
name|pos
argument_list|,
name|rc_id
argument_list|,
name|rc_len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|pos
operator|+=
name|lens
operator|&
literal|0x0f
expr_stmt|;
if|if
condition|(
operator|(
name|lens
operator|>>
literal|4
operator|)
operator|==
name|rc_len
operator|&&
name|os_memcmp
argument_list|(
name|pos
argument_list|,
name|rc_id
argument_list|,
name|rc_len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|pos
operator|+=
name|lens
operator|>>
literal|4
expr_stmt|;
if|if
condition|(
name|pos
operator|<
name|end
operator|&&
call|(
name|size_t
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
operator|==
name|rc_len
operator|&&
name|os_memcmp
argument_list|(
name|pos
argument_list|,
name|rc_id
argument_list|,
name|rc_len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|roaming_consortium_anqp_match
parameter_list|(
specifier|const
name|struct
name|wpabuf
modifier|*
name|anqp
parameter_list|,
specifier|const
name|u8
modifier|*
name|rc_id
parameter_list|,
name|size_t
name|rc_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|len
decl_stmt|;
if|if
condition|(
name|anqp
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|anqp
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|anqp
argument_list|)
expr_stmt|;
comment|/* Set of<OI Length, OI> duples */
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|len
operator|>
name|end
condition|)
break|break;
if|if
condition|(
name|len
operator|==
name|rc_len
operator|&&
name|os_memcmp
argument_list|(
name|pos
argument_list|,
name|rc_id
argument_list|,
name|rc_len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
name|pos
operator|+=
name|len
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|roaming_consortium_match
parameter_list|(
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|anqp
parameter_list|,
specifier|const
name|u8
modifier|*
name|rc_id
parameter_list|,
name|size_t
name|rc_len
parameter_list|)
block|{
return|return
name|roaming_consortium_element_match
argument_list|(
name|ie
argument_list|,
name|rc_id
argument_list|,
name|rc_len
argument_list|)
operator|||
name|roaming_consortium_anqp_match
argument_list|(
name|anqp
argument_list|,
name|rc_id
argument_list|,
name|rc_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cred_no_required_oi_match
parameter_list|(
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
if|if
condition|(
name|cred
operator|->
name|required_roaming_consortium_len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_ROAMING_CONSORTIUM
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
operator|&&
operator|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
operator|||
name|bss
operator|->
name|anqp
operator|->
name|roaming_consortium
operator|==
name|NULL
operator|)
condition|)
return|return
literal|1
return|;
return|return
operator|!
name|roaming_consortium_match
argument_list|(
name|ie
argument_list|,
name|bss
operator|->
name|anqp
condition|?
name|bss
operator|->
name|anqp
operator|->
name|roaming_consortium
else|:
name|NULL
argument_list|,
name|cred
operator|->
name|required_roaming_consortium
argument_list|,
name|cred
operator|->
name|required_roaming_consortium_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cred_excluded_ssid
parameter_list|(
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|cred
operator|->
name|excluded_ssid
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|num_excluded_ssid
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|excluded_ssid
modifier|*
name|e
init|=
operator|&
name|cred
operator|->
name|excluded_ssid
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|ssid_len
operator|==
name|e
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|e
operator|->
name|ssid
argument_list|,
name|e
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cred_below_min_backhaul
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|unsigned
name|int
name|dl_bandwidth
decl_stmt|,
name|ul_bandwidth
decl_stmt|;
specifier|const
name|u8
modifier|*
name|wan
decl_stmt|;
name|u8
name|wan_info
decl_stmt|,
name|dl_load
decl_stmt|,
name|ul_load
decl_stmt|;
name|u16
name|lmd
decl_stmt|;
name|u32
name|ul_speed
decl_stmt|,
name|dl_speed
decl_stmt|;
if|if
condition|(
operator|!
name|cred
operator|->
name|min_dl_bandwidth_home
operator|&&
operator|!
name|cred
operator|->
name|min_ul_bandwidth_home
operator|&&
operator|!
name|cred
operator|->
name|min_dl_bandwidth_roaming
operator|&&
operator|!
name|cred
operator|->
name|min_ul_bandwidth_roaming
condition|)
return|return
literal|0
return|;
comment|/* No bandwidth constraint specified */
if|if
condition|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
operator|||
name|bss
operator|->
name|anqp
operator|->
name|hs20_wan_metrics
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* No WAN Metrics known - ignore constraint */
name|wan
operator|=
name|wpabuf_head
argument_list|(
name|bss
operator|->
name|anqp
operator|->
name|hs20_wan_metrics
argument_list|)
expr_stmt|;
name|wan_info
operator|=
name|wan
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|wan_info
operator|&
name|BIT
argument_list|(
literal|3
argument_list|)
condition|)
return|return
literal|1
return|;
comment|/* WAN link at capacity */
name|lmd
operator|=
name|WPA_GET_LE16
argument_list|(
name|wan
operator|+
literal|11
argument_list|)
expr_stmt|;
if|if
condition|(
name|lmd
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Downlink/Uplink Load was not measured */
name|dl_speed
operator|=
name|WPA_GET_LE32
argument_list|(
name|wan
operator|+
literal|1
argument_list|)
expr_stmt|;
name|ul_speed
operator|=
name|WPA_GET_LE32
argument_list|(
name|wan
operator|+
literal|5
argument_list|)
expr_stmt|;
name|dl_load
operator|=
name|wan
index|[
literal|9
index|]
expr_stmt|;
name|ul_load
operator|=
name|wan
index|[
literal|10
index|]
expr_stmt|;
if|if
condition|(
name|dl_speed
operator|>=
literal|0xffffff
condition|)
name|dl_bandwidth
operator|=
name|dl_speed
operator|/
literal|255
operator|*
operator|(
literal|255
operator|-
name|dl_load
operator|)
expr_stmt|;
else|else
name|dl_bandwidth
operator|=
name|dl_speed
operator|*
operator|(
literal|255
operator|-
name|dl_load
operator|)
operator|/
literal|255
expr_stmt|;
if|if
condition|(
name|ul_speed
operator|>=
literal|0xffffff
condition|)
name|ul_bandwidth
operator|=
name|ul_speed
operator|/
literal|255
operator|*
operator|(
literal|255
operator|-
name|ul_load
operator|)
expr_stmt|;
else|else
name|ul_bandwidth
operator|=
name|ul_speed
operator|*
operator|(
literal|255
operator|-
name|ul_load
operator|)
operator|/
literal|255
expr_stmt|;
name|res
operator|=
name|interworking_home_sp_cred
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
operator|->
name|anqp
condition|?
name|bss
operator|->
name|anqp
operator|->
name|domain_name
else|:
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|cred
operator|->
name|min_dl_bandwidth_home
operator|>
name|dl_bandwidth
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|cred
operator|->
name|min_ul_bandwidth_home
operator|>
name|ul_bandwidth
condition|)
return|return
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|cred
operator|->
name|min_dl_bandwidth_roaming
operator|>
name|dl_bandwidth
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|cred
operator|->
name|min_ul_bandwidth_roaming
operator|>
name|ul_bandwidth
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cred_over_max_bss_load
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
operator|!
name|cred
operator|->
name|max_bss_load
condition|)
return|return
literal|0
return|;
comment|/* No BSS Load constraint specified */
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_BSS_LOAD
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
operator|||
name|ie
index|[
literal|1
index|]
operator|<
literal|3
condition|)
return|return
literal|0
return|;
comment|/* No BSS Load advertised */
name|res
operator|=
name|interworking_home_sp_cred
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
operator|->
name|anqp
condition|?
name|bss
operator|->
name|anqp
operator|->
name|domain_name
else|:
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Not a home network */
return|return
name|ie
index|[
literal|4
index|]
operator|>
name|cred
operator|->
name|max_bss_load
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|has_proto_match
parameter_list|(
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|,
name|u8
name|proto
parameter_list|)
block|{
while|while
condition|(
name|pos
operator|+
literal|4
operator|<=
name|end
condition|)
block|{
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|proto
operator|&&
name|pos
index|[
literal|3
index|]
operator|==
literal|1
comment|/* Open */
condition|)
return|return
literal|1
return|;
name|pos
operator|+=
literal|4
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|has_proto_port_match
parameter_list|(
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|,
name|u8
name|proto
parameter_list|,
name|u16
name|port
parameter_list|)
block|{
while|while
condition|(
name|pos
operator|+
literal|4
operator|<=
name|end
condition|)
block|{
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|proto
operator|&&
name|WPA_GET_LE16
argument_list|(
operator|&
name|pos
index|[
literal|1
index|]
argument_list|)
operator|==
name|port
operator|&&
name|pos
index|[
literal|3
index|]
operator|==
literal|1
comment|/* Open */
condition|)
return|return
literal|1
return|;
name|pos
operator|+=
literal|4
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cred_conn_capab_missing
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
specifier|const
name|u8
modifier|*
name|capab
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
name|int
modifier|*
name|ports
decl_stmt|;
if|if
condition|(
operator|!
name|cred
operator|->
name|num_req_conn_capab
condition|)
return|return
literal|0
return|;
comment|/* No connection capability constraint specified */
if|if
condition|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
operator|||
name|bss
operator|->
name|anqp
operator|->
name|hs20_connection_capability
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
comment|/* No Connection Capability known - ignore constraint 			   */
name|res
operator|=
name|interworking_home_sp_cred
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
operator|->
name|anqp
condition|?
name|bss
operator|->
name|anqp
operator|->
name|domain_name
else|:
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
return|return
literal|0
return|;
comment|/* No constraint in home network */
name|capab
operator|=
name|wpabuf_head
argument_list|(
name|bss
operator|->
name|anqp
operator|->
name|hs20_connection_capability
argument_list|)
expr_stmt|;
name|end
operator|=
name|capab
operator|+
name|wpabuf_len
argument_list|(
name|bss
operator|->
name|anqp
operator|->
name|hs20_connection_capability
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|num_req_conn_capab
condition|;
name|i
operator|++
control|)
block|{
name|ports
operator|=
name|cred
operator|->
name|req_conn_capab_port
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|ports
condition|)
block|{
if|if
condition|(
operator|!
name|has_proto_match
argument_list|(
name|capab
argument_list|,
name|end
argument_list|,
name|cred
operator|->
name|req_conn_capab_proto
index|[
name|i
index|]
argument_list|)
condition|)
return|return
literal|1
return|;
block|}
else|else
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|ports
index|[
name|j
index|]
operator|>
operator|-
literal|1
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|has_proto_port_match
argument_list|(
name|capab
argument_list|,
name|end
argument_list|,
name|cred
operator|->
name|req_conn_capab_proto
index|[
name|i
index|]
argument_list|,
name|ports
index|[
name|j
index|]
argument_list|)
condition|)
return|return
literal|1
return|;
block|}
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_cred
modifier|*
name|interworking_credentials_available_roaming_consortium
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
name|ignore_bw
parameter_list|,
name|int
modifier|*
name|excluded
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|,
modifier|*
name|selected
init|=
name|NULL
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|int
name|is_excluded
init|=
literal|0
decl_stmt|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_ROAMING_CONSORTIUM
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
operator|&&
operator|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
operator|||
name|bss
operator|->
name|anqp
operator|->
name|roaming_consortium
operator|==
name|NULL
operator|)
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|cred
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cred
operator|->
name|roaming_consortium_len
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|!
name|roaming_consortium_match
argument_list|(
name|ie
argument_list|,
name|bss
operator|->
name|anqp
condition|?
name|bss
operator|->
name|anqp
operator|->
name|roaming_consortium
else|:
name|NULL
argument_list|,
name|cred
operator|->
name|roaming_consortium
argument_list|,
name|cred
operator|->
name|roaming_consortium_len
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|cred_no_required_oi_match
argument_list|(
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|ignore_bw
operator|&&
name|cred_below_min_backhaul
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|ignore_bw
operator|&&
name|cred_over_max_bss_load
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|ignore_bw
operator|&&
name|cred_conn_capab_missing
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|cred_excluded_ssid
argument_list|(
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
block|{
if|if
condition|(
name|excluded
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|selected
operator|==
name|NULL
condition|)
block|{
name|selected
operator|=
name|cred
expr_stmt|;
name|is_excluded
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|selected
operator|==
name|NULL
operator|||
name|is_excluded
operator|||
name|cred_prio_cmp
argument_list|(
name|selected
argument_list|,
name|cred
argument_list|)
operator|<
literal|0
condition|)
block|{
name|selected
operator|=
name|cred
expr_stmt|;
name|is_excluded
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|excluded
condition|)
operator|*
name|excluded
operator|=
name|is_excluded
expr_stmt|;
return|return
name|selected
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|interworking_set_eap_params
parameter_list|(
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|int
name|ttls
parameter_list|)
block|{
if|if
condition|(
name|cred
operator|->
name|eap_method
condition|)
block|{
name|ttls
operator|=
name|cred
operator|->
name|eap_method
operator|->
name|vendor
operator|==
name|EAP_VENDOR_IETF
operator|&&
name|cred
operator|->
name|eap_method
operator|->
name|method
operator|==
name|EAP_TYPE_TTLS
expr_stmt|;
name|os_free
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|eap_method_type
argument_list|)
operator|*
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
argument_list|,
name|cred
operator|->
name|eap_method
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cred
operator|->
name|eap_method
argument_list|)
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
index|[
literal|1
index|]
operator|.
name|vendor
operator|=
name|EAP_VENDOR_IETF
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
index|[
literal|1
index|]
operator|.
name|method
operator|=
name|EAP_TYPE_NONE
expr_stmt|;
block|}
if|if
condition|(
name|ttls
operator|&&
name|cred
operator|->
name|username
operator|&&
name|cred
operator|->
name|username
index|[
literal|0
index|]
condition|)
block|{
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|char
modifier|*
name|anon
decl_stmt|;
comment|/* Use anonymous NAI in Phase 1 */
name|pos
operator|=
name|os_strchr
argument_list|(
name|cred
operator|->
name|username
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|size_t
name|buflen
init|=
literal|9
operator|+
name|os_strlen
argument_list|(
name|pos
argument_list|)
operator|+
literal|1
decl_stmt|;
name|anon
operator|=
name|os_malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anon
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_snprintf
argument_list|(
name|anon
argument_list|,
name|buflen
argument_list|,
literal|"anonymous%s"
argument_list|,
name|pos
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cred
operator|->
name|realm
condition|)
block|{
name|size_t
name|buflen
init|=
literal|10
operator|+
name|os_strlen
argument_list|(
name|cred
operator|->
name|realm
argument_list|)
operator|+
literal|1
decl_stmt|;
name|anon
operator|=
name|os_malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anon
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_snprintf
argument_list|(
name|anon
argument_list|,
name|buflen
argument_list|,
literal|"anonymous@%s"
argument_list|,
name|cred
operator|->
name|realm
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|anon
operator|=
name|os_strdup
argument_list|(
literal|"anonymous"
argument_list|)
expr_stmt|;
if|if
condition|(
name|anon
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"anonymous_identity"
argument_list|,
name|anon
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|anon
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|anon
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cred
operator|->
name|username
operator|&&
name|cred
operator|->
name|username
index|[
literal|0
index|]
operator|&&
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"identity"
argument_list|,
name|cred
operator|->
name|username
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|cred
operator|->
name|password
operator|&&
name|cred
operator|->
name|password
index|[
literal|0
index|]
condition|)
block|{
if|if
condition|(
name|cred
operator|->
name|ext_password
operator|&&
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"password"
argument_list|,
name|cred
operator|->
name|password
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|cred
operator|->
name|ext_password
operator|&&
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"password"
argument_list|,
name|cred
operator|->
name|password
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|cred
operator|->
name|client_cert
operator|&&
name|cred
operator|->
name|client_cert
index|[
literal|0
index|]
operator|&&
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"client_cert"
argument_list|,
name|cred
operator|->
name|client_cert
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
ifdef|#
directive|ifdef
name|ANDROID
if|if
condition|(
name|cred
operator|->
name|private_key
operator|&&
name|os_strncmp
argument_list|(
name|cred
operator|->
name|private_key
argument_list|,
literal|"keystore://"
argument_list|,
literal|11
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Use OpenSSL engine configuration for Android keystore */
if|if
condition|(
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"engine_id"
argument_list|,
literal|"keystore"
argument_list|)
operator|<
literal|0
operator|||
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"key_id"
argument_list|,
name|cred
operator|->
name|private_key
operator|+
literal|11
argument_list|)
operator|<
literal|0
operator|||
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"engine"
argument_list|,
literal|"1"
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
elseif|else
endif|#
directive|endif
comment|/* ANDROID */
if|if
condition|(
name|cred
operator|->
name|private_key
operator|&&
name|cred
operator|->
name|private_key
index|[
literal|0
index|]
operator|&&
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"private_key"
argument_list|,
name|cred
operator|->
name|private_key
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|cred
operator|->
name|private_key_passwd
operator|&&
name|cred
operator|->
name|private_key_passwd
index|[
literal|0
index|]
operator|&&
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"private_key_passwd"
argument_list|,
name|cred
operator|->
name|private_key_passwd
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|cred
operator|->
name|phase1
condition|)
block|{
name|os_free
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|phase1
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|phase1
operator|=
name|os_strdup
argument_list|(
name|cred
operator|->
name|phase1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cred
operator|->
name|phase2
condition|)
block|{
name|os_free
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|phase2
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|phase2
operator|=
name|os_strdup
argument_list|(
name|cred
operator|->
name|phase2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cred
operator|->
name|ca_cert
operator|&&
name|cred
operator|->
name|ca_cert
index|[
literal|0
index|]
operator|&&
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"ca_cert"
argument_list|,
name|cred
operator|->
name|ca_cert
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|cred
operator|->
name|domain_suffix_match
operator|&&
name|cred
operator|->
name|domain_suffix_match
index|[
literal|0
index|]
operator|&&
name|wpa_config_set_quoted
argument_list|(
name|ssid
argument_list|,
literal|"domain_suffix_match"
argument_list|,
name|cred
operator|->
name|domain_suffix_match
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ssid
operator|->
name|eap
operator|.
name|ocsp
operator|=
name|cred
operator|->
name|ocsp
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|interworking_connect_roaming_consortium
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
name|only_add
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Connect with "
name|MACSTR
literal|" based on roaming consortium match"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|already_connected
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|INTERWORKING_ALREADY_CONNECTED MACSTR
argument_list|,
argument|MAC2STR(bss->bssid)
argument_list|)
empty_stmt|;
return|return
name|wpa_s
operator|->
name|current_ssid
operator|->
name|id
return|;
block|}
name|remove_duplicate_network
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ssid
operator|->
name|parent_cred
operator|=
name|cred
expr_stmt|;
name|wpas_notify_network_added
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|priority
operator|=
name|cred
operator|->
name|priority
expr_stmt|;
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_zalloc
argument_list|(
name|bss
operator|->
name|ssid_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
if|if
condition|(
name|interworking_set_hs20_params
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|cred
operator|->
name|eap_method
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: No EAP method set for credential using roaming consortium"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|interworking_set_eap_params
argument_list|(
name|ssid
argument_list|,
name|cred
argument_list|,
name|cred
operator|->
name|eap_method
operator|->
name|vendor
operator|==
name|EAP_VENDOR_IETF
operator|&&
name|cred
operator|->
name|eap_method
operator|->
name|method
operator|==
name|EAP_TYPE_TTLS
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|wpa_s
operator|->
name|next_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_config_update_prio_list
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|only_add
condition|)
name|interworking_reconnect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|ssid
operator|->
name|id
return|;
name|fail
label|:
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|interworking_connect_helper
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
name|allow_excluded
parameter_list|,
name|int
name|only_add
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|,
modifier|*
name|cred_rc
decl_stmt|,
modifier|*
name|cred_3gpp
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|struct
name|nai_realm
modifier|*
name|realm
decl_stmt|;
name|struct
name|nai_realm_eap
modifier|*
name|eap
init|=
name|NULL
decl_stmt|;
name|u16
name|count
decl_stmt|,
name|i
decl_stmt|;
name|char
name|buf
index|[
literal|100
index|]
decl_stmt|;
name|int
name|excluded
init|=
literal|0
decl_stmt|,
modifier|*
name|excl
init|=
name|allow_excluded
condition|?
operator|&
name|excluded
else|:
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|cred
operator|==
name|NULL
operator|||
name|bss
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|disallowed_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
operator|||
name|disallowed_ssid
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Reject connection to disallowed BSS "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Considering BSS "
name|MACSTR
literal|" for connection (allow_excluded=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|allow_excluded
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
condition|)
block|{
comment|/* 		 * We currently support only HS 2.0 networks and those are 		 * required to use WPA2-Enterprise. 		 */
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Network does not use RSN"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|cred_rc
operator|=
name|interworking_credentials_available_roaming_consortium
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
literal|0
argument_list|,
name|excl
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred_rc
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Highest roaming consortium matching credential priority %d sp_priority %d"
argument_list|,
name|cred_rc
operator|->
name|priority
argument_list|,
name|cred_rc
operator|->
name|sp_priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|allow_excluded
operator|&&
name|excl
operator|&&
operator|!
operator|(
operator|*
name|excl
operator|)
condition|)
name|excl
operator|=
name|NULL
expr_stmt|;
block|}
name|cred
operator|=
name|interworking_credentials_available_realm
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
literal|0
argument_list|,
name|excl
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Highest NAI Realm list matching credential priority %d sp_priority %d"
argument_list|,
name|cred
operator|->
name|priority
argument_list|,
name|cred
operator|->
name|sp_priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|allow_excluded
operator|&&
name|excl
operator|&&
operator|!
operator|(
operator|*
name|excl
operator|)
condition|)
name|excl
operator|=
name|NULL
expr_stmt|;
block|}
name|cred_3gpp
operator|=
name|interworking_credentials_available_3gpp
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
literal|0
argument_list|,
name|excl
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred_3gpp
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Highest 3GPP matching credential priority %d sp_priority %d"
argument_list|,
name|cred_3gpp
operator|->
name|priority
argument_list|,
name|cred_3gpp
operator|->
name|sp_priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|allow_excluded
operator|&&
name|excl
operator|&&
operator|!
operator|(
operator|*
name|excl
operator|)
condition|)
name|excl
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cred_rc
operator|&&
operator|!
name|cred
operator|&&
operator|!
name|cred_3gpp
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: No full credential matches - consider options without BW(etc.) limits"
argument_list|)
expr_stmt|;
name|cred_rc
operator|=
name|interworking_credentials_available_roaming_consortium
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
literal|1
argument_list|,
name|excl
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred_rc
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Highest roaming consortium matching credential priority %d sp_priority %d (ignore BW)"
argument_list|,
name|cred_rc
operator|->
name|priority
argument_list|,
name|cred_rc
operator|->
name|sp_priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|allow_excluded
operator|&&
name|excl
operator|&&
operator|!
operator|(
operator|*
name|excl
operator|)
condition|)
name|excl
operator|=
name|NULL
expr_stmt|;
block|}
name|cred
operator|=
name|interworking_credentials_available_realm
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
literal|1
argument_list|,
name|excl
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Highest NAI Realm list matching credential priority %d sp_priority %d (ignore BW)"
argument_list|,
name|cred
operator|->
name|priority
argument_list|,
name|cred
operator|->
name|sp_priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|allow_excluded
operator|&&
name|excl
operator|&&
operator|!
operator|(
operator|*
name|excl
operator|)
condition|)
name|excl
operator|=
name|NULL
expr_stmt|;
block|}
name|cred_3gpp
operator|=
name|interworking_credentials_available_3gpp
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
literal|1
argument_list|,
name|excl
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred_3gpp
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Highest 3GPP matching credential priority %d sp_priority %d (ignore BW)"
argument_list|,
name|cred_3gpp
operator|->
name|priority
argument_list|,
name|cred_3gpp
operator|->
name|sp_priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|allow_excluded
operator|&&
name|excl
operator|&&
operator|!
operator|(
operator|*
name|excl
operator|)
condition|)
name|excl
operator|=
name|NULL
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cred_rc
operator|&&
operator|(
name|cred
operator|==
name|NULL
operator|||
name|cred_prio_cmp
argument_list|(
name|cred_rc
argument_list|,
name|cred
argument_list|)
operator|>=
literal|0
operator|)
operator|&&
operator|(
name|cred_3gpp
operator|==
name|NULL
operator|||
name|cred_prio_cmp
argument_list|(
name|cred_rc
argument_list|,
name|cred_3gpp
argument_list|)
operator|>=
literal|0
operator|)
condition|)
return|return
name|interworking_connect_roaming_consortium
argument_list|(
name|wpa_s
argument_list|,
name|cred_rc
argument_list|,
name|bss
argument_list|,
name|only_add
argument_list|)
return|;
if|if
condition|(
name|cred_3gpp
operator|&&
operator|(
name|cred
operator|==
name|NULL
operator|||
name|cred_prio_cmp
argument_list|(
name|cred_3gpp
argument_list|,
name|cred
argument_list|)
operator|>=
literal|0
operator|)
condition|)
block|{
return|return
name|interworking_connect_3gpp
argument_list|(
name|wpa_s
argument_list|,
name|cred_3gpp
argument_list|,
name|bss
argument_list|,
name|only_add
argument_list|)
return|;
block|}
if|if
condition|(
name|cred
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: No matching credentials found for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|realm
operator|=
name|nai_realm_parse
argument_list|(
name|bss
operator|->
name|anqp
condition|?
name|bss
operator|->
name|anqp
operator|->
name|nai_realm
else|:
name|NULL
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Could not parse NAI Realm list from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|nai_realm_match
argument_list|(
operator|&
name|realm
index|[
name|i
index|]
argument_list|,
name|cred
operator|->
name|realm
argument_list|)
condition|)
continue|continue;
name|eap
operator|=
name|nai_realm_find_eap
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
operator|&
name|realm
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|eap
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: No matching credentials and EAP method found for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|nai_realm_free
argument_list|(
name|realm
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Connect with "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|already_connected
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|INTERWORKING_ALREADY_CONNECTED MACSTR
argument_list|,
argument|MAC2STR(bss->bssid)
argument_list|)
empty_stmt|;
name|nai_realm_free
argument_list|(
name|realm
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|remove_duplicate_network
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|nai_realm_free
argument_list|(
name|realm
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ssid
operator|->
name|parent_cred
operator|=
name|cred
expr_stmt|;
name|wpas_notify_network_added
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|priority
operator|=
name|cred
operator|->
name|priority
expr_stmt|;
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_zalloc
argument_list|(
name|bss
operator|->
name|ssid_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
if|if
condition|(
name|interworking_set_hs20_params
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"eap"
argument_list|,
name|eap_get_name
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|eap
operator|->
name|method
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
switch|switch
condition|(
name|eap
operator|->
name|method
condition|)
block|{
case|case
name|EAP_TYPE_TTLS
case|:
if|if
condition|(
name|eap
operator|->
name|inner_method
condition|)
block|{
name|os_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"\"autheap=%s\""
argument_list|,
name|eap_get_name
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|eap
operator|->
name|inner_method
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase2"
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
break|break;
block|}
switch|switch
condition|(
name|eap
operator|->
name|inner_non_eap
condition|)
block|{
case|case
name|NAI_REALM_INNER_NON_EAP_PAP
case|:
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase2"
argument_list|,
literal|"\"auth=PAP\""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
name|NAI_REALM_INNER_NON_EAP_CHAP
case|:
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase2"
argument_list|,
literal|"\"auth=CHAP\""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
name|NAI_REALM_INNER_NON_EAP_MSCHAP
case|:
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase2"
argument_list|,
literal|"\"auth=MSCHAP\""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
name|NAI_REALM_INNER_NON_EAP_MSCHAPV2
case|:
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase2"
argument_list|,
literal|"\"auth=MSCHAPV2\""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
break|break;
default|default:
comment|/* EAP params were not set - assume TTLS/MSCHAPv2 */
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase2"
argument_list|,
literal|"\"auth=MSCHAPV2\""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
break|break;
block|}
break|break;
case|case
name|EAP_TYPE_PEAP
case|:
case|case
name|EAP_TYPE_FAST
case|:
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase1"
argument_list|,
literal|"\"fast_provisioning=2\""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"pac_file"
argument_list|,
literal|"\"blob://pac_interworking\""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|name
operator|=
name|eap_get_name
argument_list|(
name|EAP_VENDOR_IETF
argument_list|,
name|eap
operator|->
name|inner_method
condition|?
name|eap
operator|->
name|inner_method
else|:
name|EAP_TYPE_MSCHAPV2
argument_list|)
expr_stmt|;
if|if
condition|(
name|name
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_snprintf
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"\"auth=%s\""
argument_list|,
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase2"
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
break|break;
case|case
name|EAP_TYPE_TLS
case|:
break|break;
block|}
if|if
condition|(
name|interworking_set_eap_params
argument_list|(
name|ssid
argument_list|,
name|cred
argument_list|,
name|eap
operator|->
name|method
operator|==
name|EAP_TYPE_TTLS
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|nai_realm_free
argument_list|(
name|realm
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|next_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_config_update_prio_list
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|only_add
condition|)
name|interworking_reconnect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|ssid
operator|->
name|id
return|;
name|fail
label|:
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
name|nai_realm_free
argument_list|(
name|realm
argument_list|,
name|count
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|interworking_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
name|only_add
parameter_list|)
block|{
return|return
name|interworking_connect_helper
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
literal|1
argument_list|,
name|only_add
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|PCSC_FUNCS
end_ifdef

begin_function
specifier|static
name|int
name|interworking_pcsc_read_imsi
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|imsi
index|[
literal|0
index|]
operator|&&
name|wpa_s
operator|->
name|mnc_len
condition|)
return|return
literal|0
return|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|imsi
argument_list|)
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|scard_get_imsi
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|,
name|wpa_s
operator|->
name|imsi
argument_list|,
operator|&
name|len
argument_list|)
condition|)
block|{
name|scard_deinit
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scard
operator|=
name|NULL
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Could not read IMSI"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|imsi
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_s
operator|->
name|mnc_len
operator|=
name|scard_get_mnc_len
argument_list|(
name|wpa_s
operator|->
name|scard
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SCARD: IMSI %s (MNC length %d)"
argument_list|,
name|wpa_s
operator|->
name|imsi
argument_list|,
name|wpa_s
operator|->
name|mnc_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* PCSC_FUNCS */
end_comment

begin_function
specifier|static
name|struct
name|wpa_cred
modifier|*
name|interworking_credentials_available_3gpp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
name|ignore_bw
parameter_list|,
name|int
modifier|*
name|excluded
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|selected
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|INTERWORKING_3GPP
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|is_excluded
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
operator|||
name|bss
operator|->
name|anqp
operator|->
name|anqp_3gpp
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"interworking-avail-3gpp: not avail, anqp: %p  anqp_3gpp: %p"
argument_list|,
name|bss
operator|->
name|anqp
argument_list|,
name|bss
operator|->
name|anqp
condition|?
name|bss
operator|->
name|anqp
operator|->
name|anqp_3gpp
else|:
name|NULL
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_EAP_PROXY
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|imsi
index|[
literal|0
index|]
condition|)
block|{
name|size_t
name|len
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: IMSI not available - try to read again through eap_proxy"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mnc_len
operator|=
name|eapol_sm_get_eap_proxy_imsi
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|wpa_s
operator|->
name|imsi
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mnc_len
operator|>
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|imsi
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"eap_proxy: IMSI %s (MNC length %d)"
argument_list|,
name|wpa_s
operator|->
name|imsi
argument_list|,
name|wpa_s
operator|->
name|mnc_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"eap_proxy: IMSI not available"
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_EAP_PROXY */
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
name|char
modifier|*
name|sep
decl_stmt|;
specifier|const
name|char
modifier|*
name|imsi
decl_stmt|;
name|int
name|mnc_len
decl_stmt|;
name|char
name|imsi_buf
index|[
literal|16
index|]
decl_stmt|;
name|size_t
name|msin_len
decl_stmt|;
ifdef|#
directive|ifdef
name|PCSC_FUNCS
if|if
condition|(
name|cred
operator|->
name|pcsc
operator|&&
name|wpa_s
operator|->
name|scard
condition|)
block|{
if|if
condition|(
name|interworking_pcsc_read_imsi
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
name|imsi
operator|=
name|wpa_s
operator|->
name|imsi
expr_stmt|;
name|mnc_len
operator|=
name|wpa_s
operator|->
name|mnc_len
expr_stmt|;
goto|goto
name|compare
goto|;
block|}
endif|#
directive|endif
comment|/* PCSC_FUNCS */
ifdef|#
directive|ifdef
name|CONFIG_EAP_PROXY
if|if
condition|(
name|cred
operator|->
name|pcsc
operator|&&
name|wpa_s
operator|->
name|mnc_len
operator|>
literal|0
operator|&&
name|wpa_s
operator|->
name|imsi
index|[
literal|0
index|]
condition|)
block|{
name|imsi
operator|=
name|wpa_s
operator|->
name|imsi
expr_stmt|;
name|mnc_len
operator|=
name|wpa_s
operator|->
name|mnc_len
expr_stmt|;
goto|goto
name|compare
goto|;
block|}
endif|#
directive|endif
comment|/* CONFIG_EAP_PROXY */
if|if
condition|(
name|cred
operator|->
name|imsi
operator|==
name|NULL
operator|||
operator|!
name|cred
operator|->
name|imsi
index|[
literal|0
index|]
operator|||
operator|(
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|external_sim
operator|&&
operator|(
name|cred
operator|->
name|milenage
operator|==
name|NULL
operator|||
operator|!
name|cred
operator|->
name|milenage
index|[
literal|0
index|]
operator|)
operator|)
condition|)
continue|continue;
name|sep
operator|=
name|os_strchr
argument_list|(
name|cred
operator|->
name|imsi
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|sep
operator|==
name|NULL
operator|||
operator|(
name|sep
operator|-
name|cred
operator|->
name|imsi
operator|!=
literal|5
operator|&&
name|sep
operator|-
name|cred
operator|->
name|imsi
operator|!=
literal|6
operator|)
condition|)
continue|continue;
name|mnc_len
operator|=
name|sep
operator|-
name|cred
operator|->
name|imsi
operator|-
literal|3
expr_stmt|;
name|os_memcpy
argument_list|(
name|imsi_buf
argument_list|,
name|cred
operator|->
name|imsi
argument_list|,
literal|3
operator|+
name|mnc_len
argument_list|)
expr_stmt|;
name|sep
operator|++
expr_stmt|;
name|msin_len
operator|=
name|os_strlen
argument_list|(
name|cred
operator|->
name|imsi
argument_list|)
expr_stmt|;
if|if
condition|(
literal|3
operator|+
name|mnc_len
operator|+
name|msin_len
operator|>=
sizeof|sizeof
argument_list|(
name|imsi_buf
argument_list|)
operator|-
literal|1
condition|)
name|msin_len
operator|=
sizeof|sizeof
argument_list|(
name|imsi_buf
argument_list|)
operator|-
literal|3
operator|-
name|mnc_len
operator|-
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|imsi_buf
index|[
literal|3
operator|+
name|mnc_len
index|]
argument_list|,
name|sep
argument_list|,
name|msin_len
argument_list|)
expr_stmt|;
name|imsi_buf
index|[
literal|3
operator|+
name|mnc_len
operator|+
name|msin_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|imsi
operator|=
name|imsi_buf
expr_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|PCSC_FUNCS
argument_list|)
operator|||
name|defined
argument_list|(
name|CONFIG_EAP_PROXY
argument_list|)
name|compare
label|:
endif|#
directive|endif
comment|/* PCSC_FUNCS || CONFIG_EAP_PROXY */
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Parsing 3GPP info from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|plmn_id_match
argument_list|(
name|bss
operator|->
name|anqp
operator|->
name|anqp_3gpp
argument_list|,
name|imsi
argument_list|,
name|mnc_len
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"PLMN match %sfound"
argument_list|,
name|ret
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
if|if
condition|(
name|cred_no_required_oi_match
argument_list|(
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|ignore_bw
operator|&&
name|cred_below_min_backhaul
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|ignore_bw
operator|&&
name|cred_over_max_bss_load
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|ignore_bw
operator|&&
name|cred_conn_capab_missing
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|cred_excluded_ssid
argument_list|(
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
block|{
if|if
condition|(
name|excluded
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|selected
operator|==
name|NULL
condition|)
block|{
name|selected
operator|=
name|cred
expr_stmt|;
name|is_excluded
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|selected
operator|==
name|NULL
operator|||
name|is_excluded
operator|||
name|cred_prio_cmp
argument_list|(
name|selected
argument_list|,
name|cred
argument_list|)
operator|<
literal|0
condition|)
block|{
name|selected
operator|=
name|cred
expr_stmt|;
name|is_excluded
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|excluded
condition|)
operator|*
name|excluded
operator|=
name|is_excluded
expr_stmt|;
endif|#
directive|endif
comment|/* INTERWORKING_3GPP */
return|return
name|selected
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_cred
modifier|*
name|interworking_credentials_available_realm
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
name|ignore_bw
parameter_list|,
name|int
modifier|*
name|excluded
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|,
modifier|*
name|selected
init|=
name|NULL
decl_stmt|;
name|struct
name|nai_realm
modifier|*
name|realm
decl_stmt|;
name|u16
name|count
decl_stmt|,
name|i
decl_stmt|;
name|int
name|is_excluded
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
operator|||
name|bss
operator|->
name|anqp
operator|->
name|nai_realm
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|cred
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Parsing NAI Realm list from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|realm
operator|=
name|nai_realm_parse
argument_list|(
name|bss
operator|->
name|anqp
operator|->
name|nai_realm
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Could not parse NAI Realm list from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
if|if
condition|(
name|cred
operator|->
name|realm
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|nai_realm_match
argument_list|(
operator|&
name|realm
index|[
name|i
index|]
argument_list|,
name|cred
operator|->
name|realm
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|nai_realm_find_eap
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
operator|&
name|realm
index|[
name|i
index|]
argument_list|)
condition|)
block|{
if|if
condition|(
name|cred_no_required_oi_match
argument_list|(
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|ignore_bw
operator|&&
name|cred_below_min_backhaul
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|ignore_bw
operator|&&
name|cred_over_max_bss_load
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|!
name|ignore_bw
operator|&&
name|cred_conn_capab_missing
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|cred_excluded_ssid
argument_list|(
name|cred
argument_list|,
name|bss
argument_list|)
condition|)
block|{
if|if
condition|(
name|excluded
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|selected
operator|==
name|NULL
condition|)
block|{
name|selected
operator|=
name|cred
expr_stmt|;
name|is_excluded
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|selected
operator|==
name|NULL
operator|||
name|is_excluded
operator|||
name|cred_prio_cmp
argument_list|(
name|selected
argument_list|,
name|cred
argument_list|)
operator|<
literal|0
condition|)
block|{
name|selected
operator|=
name|cred
expr_stmt|;
name|is_excluded
operator|=
literal|0
expr_stmt|;
block|}
block|}
break|break;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: realm-find-eap returned false"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|nai_realm_free
argument_list|(
name|realm
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|excluded
condition|)
operator|*
name|excluded
operator|=
name|is_excluded
expr_stmt|;
return|return
name|selected
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_cred
modifier|*
name|interworking_credentials_available_helper
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
name|ignore_bw
parameter_list|,
name|int
modifier|*
name|excluded
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|,
modifier|*
name|cred2
decl_stmt|;
name|int
name|excluded1
decl_stmt|,
name|excluded2
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|disallowed_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
operator|||
name|disallowed_ssid
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Ignore disallowed BSS "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|cred
operator|=
name|interworking_credentials_available_realm
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ignore_bw
argument_list|,
operator|&
name|excluded1
argument_list|)
expr_stmt|;
name|cred2
operator|=
name|interworking_credentials_available_3gpp
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ignore_bw
argument_list|,
operator|&
name|excluded2
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|&&
name|cred2
operator|&&
operator|(
name|cred_prio_cmp
argument_list|(
name|cred2
argument_list|,
name|cred
argument_list|)
operator|>=
literal|0
operator|||
operator|(
operator|!
name|excluded2
operator|&&
name|excluded1
operator|)
operator|)
condition|)
block|{
name|cred
operator|=
name|cred2
expr_stmt|;
name|excluded1
operator|=
name|excluded2
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cred
condition|)
block|{
name|cred
operator|=
name|cred2
expr_stmt|;
name|excluded1
operator|=
name|excluded2
expr_stmt|;
block|}
name|cred2
operator|=
name|interworking_credentials_available_roaming_consortium
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ignore_bw
argument_list|,
operator|&
name|excluded2
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|&&
name|cred2
operator|&&
operator|(
name|cred_prio_cmp
argument_list|(
name|cred2
argument_list|,
name|cred
argument_list|)
operator|>=
literal|0
operator|||
operator|(
operator|!
name|excluded2
operator|&&
name|excluded1
operator|)
operator|)
condition|)
block|{
name|cred
operator|=
name|cred2
expr_stmt|;
name|excluded1
operator|=
name|excluded2
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cred
condition|)
block|{
name|cred
operator|=
name|cred2
expr_stmt|;
name|excluded1
operator|=
name|excluded2
expr_stmt|;
block|}
if|if
condition|(
name|excluded
condition|)
operator|*
name|excluded
operator|=
name|excluded1
expr_stmt|;
return|return
name|cred
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_cred
modifier|*
name|interworking_credentials_available
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|int
modifier|*
name|excluded
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
if|if
condition|(
name|excluded
condition|)
operator|*
name|excluded
operator|=
literal|0
expr_stmt|;
name|cred
operator|=
name|interworking_credentials_available_helper
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
literal|0
argument_list|,
name|excluded
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
condition|)
return|return
name|cred
return|;
return|return
name|interworking_credentials_available_helper
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
literal|1
argument_list|,
name|excluded
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|domain_name_list_contains
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|domain_names
parameter_list|,
specifier|const
name|char
modifier|*
name|domain
parameter_list|,
name|int
name|exact_match
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|domain
argument_list|)
expr_stmt|;
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|domain_names
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|domain_names
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|1
operator|+
name|pos
index|[
literal|0
index|]
operator|>
name|end
condition|)
break|break;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: AP domain name"
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
index|[
literal|0
index|]
operator|==
name|len
operator|&&
name|os_strncasecmp
argument_list|(
name|domain
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
operator|(
name|pos
operator|+
literal|1
operator|)
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|exact_match
operator|&&
name|pos
index|[
literal|0
index|]
operator|>
name|len
operator|&&
name|pos
index|[
name|pos
index|[
literal|0
index|]
operator|-
name|len
index|]
operator|==
literal|'.'
condition|)
block|{
specifier|const
name|char
modifier|*
name|ap
init|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|(
name|pos
operator|+
literal|1
operator|)
decl_stmt|;
name|int
name|offset
init|=
name|pos
index|[
literal|0
index|]
operator|-
name|len
decl_stmt|;
if|if
condition|(
name|os_strncasecmp
argument_list|(
name|domain
argument_list|,
name|ap
operator|+
name|offset
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
name|pos
operator|+=
literal|1
operator|+
name|pos
index|[
literal|0
index|]
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|interworking_home_sp_cred
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|domain_names
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
ifdef|#
directive|ifdef
name|INTERWORKING_3GPP
name|char
name|nai
index|[
literal|100
index|]
decl_stmt|,
modifier|*
name|realm
decl_stmt|;
name|char
modifier|*
name|imsi
init|=
name|NULL
decl_stmt|;
name|int
name|mnc_len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|cred
operator|->
name|imsi
condition|)
name|imsi
operator|=
name|cred
operator|->
name|imsi
expr_stmt|;
ifdef|#
directive|ifdef
name|PCSC_FUNCS
elseif|else
if|if
condition|(
name|cred
operator|->
name|pcsc
operator|&&
name|wpa_s
operator|->
name|scard
condition|)
block|{
if|if
condition|(
name|interworking_pcsc_read_imsi
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|imsi
operator|=
name|wpa_s
operator|->
name|imsi
expr_stmt|;
name|mnc_len
operator|=
name|wpa_s
operator|->
name|mnc_len
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* PCSC_FUNCS */
ifdef|#
directive|ifdef
name|CONFIG_EAP_PROXY
elseif|else
if|if
condition|(
name|cred
operator|->
name|pcsc
operator|&&
name|wpa_s
operator|->
name|mnc_len
operator|>
literal|0
operator|&&
name|wpa_s
operator|->
name|imsi
index|[
literal|0
index|]
condition|)
block|{
name|imsi
operator|=
name|wpa_s
operator|->
name|imsi
expr_stmt|;
name|mnc_len
operator|=
name|wpa_s
operator|->
name|mnc_len
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_EAP_PROXY */
if|if
condition|(
name|domain_names
operator|&&
name|imsi
operator|&&
name|build_root_nai
argument_list|(
name|nai
argument_list|,
sizeof|sizeof
argument_list|(
name|nai
argument_list|)
argument_list|,
name|imsi
argument_list|,
name|mnc_len
argument_list|,
literal|0
argument_list|)
operator|==
literal|0
condition|)
block|{
name|realm
operator|=
name|os_strchr
argument_list|(
name|nai
argument_list|,
literal|'@'
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
condition|)
name|realm
operator|++
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Search for match with SIM/USIM domain %s"
argument_list|,
name|realm
argument_list|)
expr_stmt|;
if|if
condition|(
name|realm
operator|&&
name|domain_name_list_contains
argument_list|(
name|domain_names
argument_list|,
name|realm
argument_list|,
literal|1
argument_list|)
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|realm
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* INTERWORKING_3GPP */
if|if
condition|(
name|domain_names
operator|==
name|NULL
operator|||
name|cred
operator|->
name|domain
operator|==
name|NULL
condition|)
return|return
name|ret
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|num_domain
condition|;
name|i
operator|++
control|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Search for match with home SP FQDN %s"
argument_list|,
name|cred
operator|->
name|domain
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|domain_name_list_contains
argument_list|(
name|domain_names
argument_list|,
name|cred
operator|->
name|domain
index|[
name|i
index|]
argument_list|,
literal|1
argument_list|)
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|interworking_home_sp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|domain_names
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
if|if
condition|(
name|domain_names
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|cred
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
name|int
name|res
init|=
name|interworking_home_sp_cred
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|domain_names
argument_list|)
decl_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|interworking_find_network_match
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpas_network_disabled
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
operator|||
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|->
name|ssid_len
operator|!=
name|bss
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
comment|/* 			 * TODO: Consider more accurate matching of security 			 * configuration similarly to what is done in events.c 			 */
return|return
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|roaming_partner_match
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|roaming_partner
modifier|*
name|partner
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|domain_names
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Comparing roaming_partner info fqdn='%s' exact_match=%d priority=%u country='%s'"
argument_list|,
name|partner
operator|->
name|fqdn
argument_list|,
name|partner
operator|->
name|exact_match
argument_list|,
name|partner
operator|->
name|priority
argument_list|,
name|partner
operator|->
name|country
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Domain names"
argument_list|,
name|wpabuf_head
argument_list|(
name|domain_names
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|domain_names
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|domain_name_list_contains
argument_list|(
name|domain_names
argument_list|,
name|partner
operator|->
name|fqdn
argument_list|,
name|partner
operator|->
name|exact_match
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* TODO: match Country */
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|u8
name|roaming_prio
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
operator|||
name|bss
operator|->
name|anqp
operator|->
name|domain_name
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: No ANQP domain name info -> use default roaming partner priority 128"
argument_list|)
expr_stmt|;
return|return
literal|128
return|;
comment|/* cannot check preference with domain name */
block|}
if|if
condition|(
name|interworking_home_sp_cred
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
operator|->
name|anqp
operator|->
name|domain_name
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Determined to be home SP -> use maximum preference 0 as roaming partner priority"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
comment|/* max preference for home SP network */
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|cred
operator|->
name|num_roaming_partner
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|roaming_partner_match
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|cred
operator|->
name|roaming_partner
index|[
name|i
index|]
argument_list|,
name|bss
operator|->
name|anqp
operator|->
name|domain_name
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Roaming partner preference match - priority %u"
argument_list|,
name|cred
operator|->
name|roaming_partner
index|[
name|i
index|]
operator|.
name|priority
argument_list|)
expr_stmt|;
return|return
name|cred
operator|->
name|roaming_partner
index|[
name|i
index|]
operator|.
name|priority
return|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: No roaming partner preference match - use default roaming partner priority 128"
argument_list|)
expr_stmt|;
return|return
literal|128
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_bss
modifier|*
name|pick_best_roaming_partner
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|selected
parameter_list|,
name|struct
name|wpa_cred
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|u8
name|best_prio
decl_stmt|,
name|prio
decl_stmt|;
name|struct
name|wpa_cred
modifier|*
name|cred2
decl_stmt|;
comment|/* 	 * Check if any other BSS is operated by a more preferred roaming 	 * partner. 	 */
name|best_prio
operator|=
name|roaming_prio
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|selected
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: roaming_prio=%u for selected BSS "
name|MACSTR
literal|" (cred=%d)"
argument_list|,
name|best_prio
argument_list|,
name|MAC2STR
argument_list|(
name|selected
operator|->
name|bssid
argument_list|)
argument_list|,
name|cred
operator|->
name|id
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|bss
operator|==
name|selected
condition|)
continue|continue;
name|cred2
operator|=
name|interworking_credentials_available
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cred2
condition|)
continue|continue;
if|if
condition|(
operator|!
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
condition|)
continue|continue;
name|prio
operator|=
name|roaming_prio
argument_list|(
name|wpa_s
argument_list|,
name|cred2
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: roaming_prio=%u for BSS "
name|MACSTR
literal|" (cred=%d)"
argument_list|,
name|prio
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|cred2
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|prio
operator|<
name|best_prio
condition|)
block|{
name|int
name|bh1
decl_stmt|,
name|bh2
decl_stmt|,
name|load1
decl_stmt|,
name|load2
decl_stmt|,
name|conn1
decl_stmt|,
name|conn2
decl_stmt|;
name|bh1
operator|=
name|cred_below_min_backhaul
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|selected
argument_list|)
expr_stmt|;
name|load1
operator|=
name|cred_over_max_bss_load
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|selected
argument_list|)
expr_stmt|;
name|conn1
operator|=
name|cred_conn_capab_missing
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|selected
argument_list|)
expr_stmt|;
name|bh2
operator|=
name|cred_below_min_backhaul
argument_list|(
name|wpa_s
argument_list|,
name|cred2
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|load2
operator|=
name|cred_over_max_bss_load
argument_list|(
name|wpa_s
argument_list|,
name|cred2
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|conn2
operator|=
name|cred_conn_capab_missing
argument_list|(
name|wpa_s
argument_list|,
name|cred2
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: old: %d %d %d  new: %d %d %d"
argument_list|,
name|bh1
argument_list|,
name|load1
argument_list|,
name|conn1
argument_list|,
name|bh2
argument_list|,
name|load2
argument_list|,
name|conn2
argument_list|)
expr_stmt|;
if|if
condition|(
name|bh1
operator|||
name|load1
operator|||
name|conn1
operator|||
operator|!
operator|(
name|bh2
operator|||
name|load2
operator|||
name|conn2
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Better roaming partner "
name|MACSTR
literal|" selected"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|best_prio
operator|=
name|prio
expr_stmt|;
name|selected
operator|=
name|bss
expr_stmt|;
block|}
block|}
block|}
return|return
name|selected
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|interworking_select_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|selected
init|=
name|NULL
decl_stmt|,
modifier|*
name|selected_home
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|selected2
init|=
name|NULL
decl_stmt|,
modifier|*
name|selected2_home
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|count
init|=
literal|0
decl_stmt|;
specifier|const
name|char
modifier|*
name|type
decl_stmt|;
name|int
name|res
decl_stmt|;
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|,
modifier|*
name|selected_cred
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_cred
modifier|*
name|selected_home_cred
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_cred
modifier|*
name|selected2_cred
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_cred
modifier|*
name|selected2_home_cred
init|=
name|NULL
decl_stmt|;
name|wpa_s
operator|->
name|network_select
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Select network (auto_select=%d)"
argument_list|,
name|wpa_s
operator|->
name|auto_select
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
name|int
name|excluded
init|=
literal|0
decl_stmt|;
name|int
name|bh
decl_stmt|,
name|bss_load
decl_stmt|,
name|conn_capab
decl_stmt|;
name|cred
operator|=
name|interworking_credentials_available
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
operator|&
name|excluded
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cred
condition|)
continue|continue;
if|if
condition|(
operator|!
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
condition|)
block|{
comment|/* 			 * We currently support only HS 2.0 networks and those 			 * are required to use WPA2-Enterprise. 			 */
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Credential match with "
name|MACSTR
literal|" but network does not use RSN"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|excluded
condition|)
name|count
operator|++
expr_stmt|;
name|res
operator|=
name|interworking_home_sp
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|anqp
condition|?
name|bss
operator|->
name|anqp
operator|->
name|domain_name
else|:
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
condition|)
name|type
operator|=
literal|"home"
expr_stmt|;
elseif|else
if|if
condition|(
name|res
operator|==
literal|0
condition|)
name|type
operator|=
literal|"roaming"
expr_stmt|;
else|else
name|type
operator|=
literal|"unknown"
expr_stmt|;
name|bh
operator|=
name|cred_below_min_backhaul
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|bss_load
operator|=
name|cred_over_max_bss_load
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|conn_capab
operator|=
name|cred_conn_capab_missing
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|,
name|bss
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"%s"
name|MACSTR
literal|" type=%s%s%s%s id=%d priority=%d sp_priority=%d"
argument_list|,
name|excluded
condition|?
name|INTERWORKING_BLACKLISTED
else|:
name|INTERWORKING_AP
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|type
argument_list|,
name|bh
condition|?
literal|" below_min_backhaul=1"
else|:
literal|""
argument_list|,
name|bss_load
condition|?
literal|" over_max_bss_load=1"
else|:
literal|""
argument_list|,
name|conn_capab
condition|?
literal|" conn_capab_missing=1"
else|:
literal|""
argument_list|,
name|cred
operator|->
name|id
argument_list|,
name|cred
operator|->
name|priority
argument_list|,
name|cred
operator|->
name|sp_priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|excluded
condition|)
continue|continue;
if|if
condition|(
name|wpa_s
operator|->
name|auto_select
operator|||
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|auto_interworking
operator|&&
name|wpa_s
operator|->
name|auto_network_select
operator|)
condition|)
block|{
if|if
condition|(
name|bh
operator|||
name|bss_load
operator|||
name|conn_capab
condition|)
block|{
if|if
condition|(
name|selected2_cred
operator|==
name|NULL
operator|||
name|cred_prio_cmp
argument_list|(
name|cred
argument_list|,
name|selected2_cred
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Mark as selected2"
argument_list|)
expr_stmt|;
name|selected2
operator|=
name|bss
expr_stmt|;
name|selected2_cred
operator|=
name|cred
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|>
literal|0
operator|&&
operator|(
name|selected2_home_cred
operator|==
name|NULL
operator|||
name|cred_prio_cmp
argument_list|(
name|cred
argument_list|,
name|selected2_home_cred
argument_list|)
operator|>
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Mark as selected2_home"
argument_list|)
expr_stmt|;
name|selected2_home
operator|=
name|bss
expr_stmt|;
name|selected2_home_cred
operator|=
name|cred
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|selected_cred
operator|==
name|NULL
operator|||
name|cred_prio_cmp
argument_list|(
name|cred
argument_list|,
name|selected_cred
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Mark as selected"
argument_list|)
expr_stmt|;
name|selected
operator|=
name|bss
expr_stmt|;
name|selected_cred
operator|=
name|cred
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|>
literal|0
operator|&&
operator|(
name|selected_home_cred
operator|==
name|NULL
operator|||
name|cred_prio_cmp
argument_list|(
name|cred
argument_list|,
name|selected_home_cred
argument_list|)
operator|>
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Mark as selected_home"
argument_list|)
expr_stmt|;
name|selected_home
operator|=
name|bss
expr_stmt|;
name|selected_home_cred
operator|=
name|cred
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|selected_home
operator|&&
name|selected_home
operator|!=
name|selected
operator|&&
name|selected_home_cred
operator|&&
operator|(
name|selected_cred
operator|==
name|NULL
operator|||
name|cred_prio_cmp
argument_list|(
name|selected_home_cred
argument_list|,
name|selected_cred
argument_list|)
operator|>=
literal|0
operator|)
condition|)
block|{
comment|/* Prefer network operated by the Home SP */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Overrided selected with selected_home"
argument_list|)
expr_stmt|;
name|selected
operator|=
name|selected_home
expr_stmt|;
name|selected_cred
operator|=
name|selected_home_cred
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|selected
condition|)
block|{
if|if
condition|(
name|selected2_home
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Use home BSS with BW limit mismatch since no other network could be selected"
argument_list|)
expr_stmt|;
name|selected
operator|=
name|selected2_home
expr_stmt|;
name|selected_cred
operator|=
name|selected2_home_cred
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|selected2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Use visited BSS with BW limit mismatch since no other network could be selected"
argument_list|)
expr_stmt|;
name|selected
operator|=
name|selected2
expr_stmt|;
name|selected_cred
operator|=
name|selected2_cred
expr_stmt|;
block|}
block|}
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
comment|/* 		 * No matching network was found based on configured 		 * credentials. Check whether any of the enabled network blocks 		 * have matching APs. 		 */
if|if
condition|(
name|interworking_find_network_match
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Possible BSS match for enabled network configurations"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|auto_select
condition|)
block|{
name|interworking_reconnect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|auto_network_select
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Continue scanning after ANQP fetch"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|scan_interval
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|INTERWORKING_NO_MATCH
literal|"No network "
literal|"with matching credentials found"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_SCANNING
condition|)
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|selected
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Selected "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|selected
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|selected
operator|=
name|pick_best_roaming_partner
argument_list|(
name|wpa_s
argument_list|,
name|selected
argument_list|,
name|selected_cred
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Selected "
name|MACSTR
literal|" (after best roaming partner selection)"
argument_list|,
name|MAC2STR
argument_list|(
name|selected
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|INTERWORKING_SELECTED MACSTR
argument_list|,
argument|MAC2STR(selected->bssid)
argument_list|)
empty_stmt|;
name|interworking_connect
argument_list|(
name|wpa_s
argument_list|,
name|selected
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_bss_anqp
modifier|*
name|interworking_match_anqp_info
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|other
decl_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|bss
operator|->
name|hessid
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* Cannot be in the same homegenous ESS */
name|dl_list_for_each
argument_list|(
argument|other
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|other
operator|==
name|bss
condition|)
continue|continue;
if|if
condition|(
name|other
operator|->
name|anqp
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|other
operator|->
name|anqp
operator|->
name|roaming_consortium
operator|==
name|NULL
operator|&&
name|other
operator|->
name|anqp
operator|->
name|nai_realm
operator|==
name|NULL
operator|&&
name|other
operator|->
name|anqp
operator|->
name|anqp_3gpp
operator|==
name|NULL
operator|&&
name|other
operator|->
name|anqp
operator|->
name|domain_name
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
operator|!
operator|(
name|other
operator|->
name|flags
operator|&
name|WPA_BSS_ANQP_FETCH_TRIED
operator|)
condition|)
continue|continue;
if|if
condition|(
name|os_memcmp
argument_list|(
name|bss
operator|->
name|hessid
argument_list|,
name|other
operator|->
name|hessid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|bss
operator|->
name|ssid_len
operator|!=
name|other
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|other
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Share ANQP data with already fetched BSSID "
name|MACSTR
literal|" and "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|other
operator|->
name|bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|other
operator|->
name|anqp
operator|->
name|users
operator|++
expr_stmt|;
return|return
name|other
operator|->
name|anqp
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|interworking_next_anqp_fetch
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: next_anqp_fetch - "
literal|"fetch_anqp_in_progress=%d fetch_osu_icon_in_progress=%d"
argument_list|,
name|wpa_s
operator|->
name|fetch_anqp_in_progress
argument_list|,
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
argument_list|)
expr_stmt|;
if|if
condition|(
name|eloop_terminated
argument_list|()
operator|||
operator|!
name|wpa_s
operator|->
name|fetch_anqp_in_progress
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Stop next-ANQP-fetch"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Next icon (in progress)"
argument_list|)
expr_stmt|;
name|hs20_next_osu_icon
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|bss
operator|->
name|caps
operator|&
name|IEEE80211_CAP_ESS
operator|)
condition|)
continue|continue;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_EXT_CAPAB
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
operator|||
name|ie
index|[
literal|1
index|]
operator|<
literal|4
operator|||
operator|!
operator|(
name|ie
index|[
literal|5
index|]
operator|&
literal|0x80
operator|)
condition|)
continue|continue;
comment|/* AP does not support Interworking */
if|if
condition|(
name|disallowed_bssid
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
operator|||
name|disallowed_ssid
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
condition|)
continue|continue;
comment|/* Disallowed BSS */
if|if
condition|(
operator|!
operator|(
name|bss
operator|->
name|flags
operator|&
name|WPA_BSS_ANQP_FETCH_TRIED
operator|)
condition|)
block|{
if|if
condition|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
condition|)
block|{
name|bss
operator|->
name|anqp
operator|=
name|interworking_match_anqp_info
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|anqp
condition|)
block|{
comment|/* Shared data already fetched */
continue|continue;
block|}
name|bss
operator|->
name|anqp
operator|=
name|wpa_bss_anqp_alloc
argument_list|()
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
condition|)
break|break;
block|}
name|found
operator|++
expr_stmt|;
name|bss
operator|->
name|flags
operator||=
name|WPA_BSS_ANQP_FETCH_TRIED
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Starting ANQP fetch for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|interworking_anqp_send_req
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|found
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|fetch_osu_info
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|num_prov_found
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|fetch_osu_waiting_scan
operator|&&
name|wpa_s
operator|->
name|num_osu_scans
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: No OSU providers seen - try to scan again"
argument_list|)
expr_stmt|;
name|hs20_start_osu_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Next icon"
argument_list|)
expr_stmt|;
name|hs20_osu_icon_fetch
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"ANQP fetch completed"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|fetch_anqp_in_progress
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|network_select
condition|)
name|interworking_select_network
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|interworking_start_fetch_anqp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
name|bss
operator|->
name|flags
operator|&=
operator|~
name|WPA_BSS_ANQP_FETCH_TRIED
expr_stmt|;
name|wpa_s
operator|->
name|fetch_anqp_in_progress
operator|=
literal|1
expr_stmt|;
comment|/* 	 * Start actual ANQP operation from eloop call to make sure the loop 	 * does not end up using excessive recursion. 	 */
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|interworking_continue_anqp
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|interworking_fetch_anqp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|fetch_anqp_in_progress
operator|||
name|wpa_s
operator|->
name|network_select
condition|)
return|return
literal|0
return|;
name|wpa_s
operator|->
name|network_select
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|fetch_all_anqp
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|fetch_osu_info
operator|=
literal|0
expr_stmt|;
name|interworking_start_fetch_anqp
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|interworking_stop_fetch_anqp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|fetch_anqp_in_progress
condition|)
return|return;
name|wpa_s
operator|->
name|fetch_anqp_in_progress
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|anqp_send_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u16
name|info_ids
index|[]
parameter_list|,
name|size_t
name|num_ids
parameter_list|,
name|u32
name|subtypes
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|hs20_buf
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|res
decl_stmt|;
name|bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"ANQP: Cannot send query to unknown BSS "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_bss_anqp_unshare_alloc
argument_list|(
name|bss
argument_list|)
expr_stmt|;
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Query Request to "
name|MACSTR
literal|" for %u id(s)"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|num_ids
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HS20
if|if
condition|(
name|subtypes
operator|!=
literal|0
condition|)
block|{
name|hs20_buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|100
argument_list|)
expr_stmt|;
if|if
condition|(
name|hs20_buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|hs20_put_anqp_req
argument_list|(
name|subtypes
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|hs20_buf
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_HS20 */
name|buf
operator|=
name|anqp_build_req
argument_list|(
name|info_ids
argument_list|,
name|num_ids
argument_list|,
name|hs20_buf
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|hs20_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|gas_query_req
argument_list|(
name|wpa_s
operator|->
name|gas
argument_list|,
name|dst
argument_list|,
name|freq
argument_list|,
name|buf
argument_list|,
name|anqp_resp_cb
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Failed to send Query Request"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Query started with dialog token %u"
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|interworking_parse_rx_anqp_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
name|u16
name|info_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|slen
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|data
decl_stmt|;
name|struct
name|wpa_bss_anqp
modifier|*
name|anqp
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HS20
name|u8
name|type
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
if|if
condition|(
name|bss
condition|)
name|anqp
operator|=
name|bss
operator|->
name|anqp
expr_stmt|;
switch|switch
condition|(
name|info_id
condition|)
block|{
case|case
name|ANQP_CAPABILITY_LIST
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-ANQP "
name|MACSTR
literal|" ANQP Capability list"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Capability list"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|capability_list
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|capability_list
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ANQP_VENUE_NAME
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-ANQP "
name|MACSTR
literal|" Venue Name"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Venue Name"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|venue_name
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|venue_name
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ANQP_NETWORK_AUTH_TYPE
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-ANQP "
name|MACSTR
literal|" Network Authentication Type information"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Network Authentication "
literal|"Type"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|network_auth_type
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|network_auth_type
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ANQP_ROAMING_CONSORTIUM
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-ANQP "
name|MACSTR
literal|" Roaming Consortium list"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Roaming Consortium"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|roaming_consortium
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|roaming_consortium
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ANQP_IP_ADDR_TYPE_AVAILABILITY
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-ANQP "
name|MACSTR
literal|" IP Address Type Availability information"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ANQP: IP Address Availability"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|ip_addr_type_availability
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|ip_addr_type_availability
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ANQP_NAI_REALM
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-ANQP "
name|MACSTR
literal|" NAI Realm list"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: NAI Realm"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|nai_realm
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|nai_realm
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ANQP_3GPP_CELLULAR_NETWORK
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-ANQP "
name|MACSTR
literal|" 3GPP Cellular Network information"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: 3GPP Cellular Network"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|anqp_3gpp
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|anqp_3gpp
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ANQP_DOMAIN_NAME
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-ANQP "
name|MACSTR
literal|" Domain Name list"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"ANQP: Domain Name"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|domain_name
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|domain_name
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ANQP_VENDOR_SPECIFIC
case|:
if|if
condition|(
name|slen
operator|<
literal|3
condition|)
return|return;
switch|switch
condition|(
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_HS20
case|case
name|OUI_WFA
case|:
name|pos
operator|+=
literal|3
expr_stmt|;
name|slen
operator|-=
literal|3
expr_stmt|;
if|if
condition|(
name|slen
operator|<
literal|1
condition|)
return|return;
name|type
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|slen
operator|--
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|HS20_ANQP_OUI_TYPE
case|:
name|hs20_parse_rx_hs20_anqp_resp
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|sa
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"HS20: Unsupported ANQP vendor type %u"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
endif|#
directive|endif
comment|/* CONFIG_HS20 */
default|default:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Unsupported vendor-specific ANQP OUI %06x"
argument_list|,
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
default|default:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Unsupported ANQP Info ID %u"
argument_list|,
name|info_id
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|anqp_resp_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|enum
name|gas_query_result
name|result
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|adv_proto
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u16
name|status_code
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
decl_stmt|;
name|u16
name|info_id
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
init|=
name|NULL
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
specifier|const
name|char
modifier|*
name|anqp_result
init|=
literal|"SUCCESS"
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Interworking: anqp_resp_cb dst="
name|MACSTR
literal|" dialog_token=%u result=%d status_code=%u"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
name|dialog_token
argument_list|,
name|result
argument_list|,
name|status_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|GAS_QUERY_SUCCESS
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
condition|)
name|hs20_icon_fetch_failed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|anqp_result
operator|=
literal|"FAILURE"
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|adv_proto
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|adv_proto
argument_list|)
operator|<
literal|4
operator|||
name|pos
index|[
literal|0
index|]
operator|!=
name|WLAN_EID_ADV_PROTO
operator|||
name|pos
index|[
literal|1
index|]
operator|<
literal|2
operator|||
name|pos
index|[
literal|3
index|]
operator|!=
name|ACCESS_NETWORK_QUERY_PROTOCOL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Unexpected Advertisement Protocol in response"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
condition|)
name|hs20_icon_fetch_failed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|anqp_result
operator|=
literal|"INVALID_FRAME"
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* 	 * If possible, select the BSS entry based on which BSS entry was used 	 * for the request. This can help in cases where multiple BSS entries 	 * may exist for the same AP. 	 */
name|dl_list_for_each_reverse
argument_list|(
argument|tmp
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|tmp
operator|==
name|wpa_s
operator|->
name|interworking_gas_bss
operator|&&
name|os_memcmp
argument_list|(
name|tmp
operator|->
name|bssid
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|=
name|tmp
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
name|bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|)
expr_stmt|;
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
expr_stmt|;
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|unsigned
name|int
name|left
init|=
name|end
operator|-
name|pos
decl_stmt|;
if|if
condition|(
name|left
operator|<
literal|4
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Invalid element"
argument_list|)
expr_stmt|;
name|anqp_result
operator|=
literal|"INVALID_FRAME"
expr_stmt|;
goto|goto
name|out_parse_done
goto|;
block|}
name|info_id
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|left
operator|-=
literal|4
expr_stmt|;
if|if
condition|(
name|left
operator|<
name|slen
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Invalid element length for Info ID %u"
argument_list|,
name|info_id
argument_list|)
expr_stmt|;
name|anqp_result
operator|=
literal|"INVALID_FRAME"
expr_stmt|;
goto|goto
name|out_parse_done
goto|;
block|}
name|interworking_parse_rx_anqp_resp
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|dst
argument_list|,
name|info_id
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|slen
expr_stmt|;
block|}
name|out_parse_done
label|:
name|hs20_notify_parse_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|out
label|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|ANQP_QUERY_DONE
literal|"addr="
name|MACSTR
literal|" result=%s"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
name|anqp_result
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|interworking_scan_res_handler
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Scan results available - start ANQP fetch"
argument_list|)
expr_stmt|;
name|interworking_start_fetch_anqp
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|interworking_select
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|auto_select
parameter_list|,
name|int
modifier|*
name|freqs
parameter_list|)
block|{
name|interworking_stop_fetch_anqp
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|network_select
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|auto_network_select
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|auto_select
operator|=
operator|!
operator|!
name|auto_select
expr_stmt|;
name|wpa_s
operator|->
name|fetch_all_anqp
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|fetch_osu_info
operator|=
literal|0
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Interworking: Start scan for network selection"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_res_handler
operator|=
name|interworking_scan_res_handler
expr_stmt|;
name|wpa_s
operator|->
name|normal_scans
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|scan_req
operator|=
name|MANUAL_SCAN_REQ
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|manual_scan_freqs
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|manual_scan_freqs
operator|=
name|freqs
expr_stmt|;
name|wpa_s
operator|->
name|after_wps
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|known_wps_freq
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_resp_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|enum
name|gas_query_result
name|result
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|adv_proto
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u16
name|status_code
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|n
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|GAS_RESPONSE_INFO
literal|"addr="
name|MACSTR
literal|" dialog_token=%d status_code=%d resp_len=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|dialog_token
argument_list|,
name|status_code
argument_list|,
name|resp
condition|?
operator|(
name|int
operator|)
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
else|:
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resp
condition|)
return|return;
name|n
operator|=
name|wpabuf_dup
argument_list|(
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|prev_gas_resp
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|prev_gas_resp
operator|=
name|wpa_s
operator|->
name|last_gas_resp
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|prev_gas_addr
argument_list|,
name|wpa_s
operator|->
name|last_gas_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|prev_gas_dialog_token
operator|=
name|wpa_s
operator|->
name|last_gas_dialog_token
expr_stmt|;
name|wpa_s
operator|->
name|last_gas_resp
operator|=
name|n
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|last_gas_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|last_gas_dialog_token
operator|=
name|dialog_token
expr_stmt|;
block|}
end_function

begin_function
name|int
name|gas_send_request
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|adv_proto
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|u8
name|query_resp_len_limit
init|=
literal|0
decl_stmt|;
name|freq
operator|=
name|wpa_s
operator|->
name|assoc_freq
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
if|if
condition|(
name|freq
operator|<=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS request to "
name|MACSTR
literal|" (freq %d MHz)"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Advertisement Protocol ID"
argument_list|,
name|adv_proto
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS Query"
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|len
operator|=
literal|3
operator|+
name|wpabuf_len
argument_list|(
name|adv_proto
argument_list|)
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|query
condition|)
name|len
operator|+=
name|wpabuf_len
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|buf
operator|=
name|gas_build_initial_req
argument_list|(
literal|0
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Advertisement Protocol IE */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_EID_ADV_PROTO
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|1
operator|+
name|wpabuf_len
argument_list|(
name|adv_proto
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Length */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|query_resp_len_limit
operator|&
literal|0x7f
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|adv_proto
argument_list|)
expr_stmt|;
comment|/* GAS Query */
if|if
condition|(
name|query
condition|)
block|{
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|wpabuf_len
argument_list|(
name|query
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|buf
argument_list|,
name|query
argument_list|)
expr_stmt|;
block|}
else|else
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|res
operator|=
name|gas_query_req
argument_list|(
name|wpa_s
operator|->
name|gas
argument_list|,
name|dst
argument_list|,
name|freq
argument_list|,
name|buf
argument_list|,
name|gas_resp_cb
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: Failed to send Query Request"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"GAS: Query started with dialog token %u"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - background scan and roaming module: learn  * Copyright (c) 2009-2010, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"list.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"bgscan.h"
end_include

begin_struct
struct|struct
name|bgscan_learn_bss
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|u8
modifier|*
name|neigh
decl_stmt|;
comment|/* num_neigh * ETH_ALEN buffer */
name|size_t
name|num_neigh
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|bgscan_learn_data
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
specifier|const
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|scan_interval
decl_stmt|;
name|int
name|signal_threshold
decl_stmt|;
name|int
name|short_interval
decl_stmt|;
comment|/* use if signal< threshold */
name|int
name|long_interval
decl_stmt|;
comment|/* use if signal> threshold */
name|struct
name|os_time
name|last_bgscan
decl_stmt|;
name|char
modifier|*
name|fname
decl_stmt|;
name|struct
name|dl_list
name|bss
decl_stmt|;
name|int
modifier|*
name|supp_freqs
decl_stmt|;
name|int
name|probe_idx
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|bss_free
parameter_list|(
name|struct
name|bgscan_learn_bss
modifier|*
name|bss
parameter_list|)
block|{
name|os_free
argument_list|(
name|bss
operator|->
name|neigh
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bssid_in_array
parameter_list|(
name|u8
modifier|*
name|array
parameter_list|,
name|size_t
name|array_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|array
operator|==
name|NULL
operator|||
name|array_len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|array_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|array
operator|+
name|i
operator|*
name|ETH_ALEN
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgscan_learn_add_neighbor
parameter_list|(
name|struct
name|bgscan_learn_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|u8
modifier|*
name|n
decl_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|bssid_in_array
argument_list|(
name|bss
operator|->
name|neigh
argument_list|,
name|bss
operator|->
name|num_neigh
argument_list|,
name|bssid
argument_list|)
condition|)
return|return;
name|n
operator|=
name|os_realloc_array
argument_list|(
name|bss
operator|->
name|neigh
argument_list|,
name|bss
operator|->
name|num_neigh
operator|+
literal|1
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|n
operator|+
name|bss
operator|->
name|num_neigh
operator|*
name|ETH_ALEN
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|bss
operator|->
name|neigh
operator|=
name|n
expr_stmt|;
name|bss
operator|->
name|num_neigh
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|bgscan_learn_bss
modifier|*
name|bgscan_learn_get_bss
parameter_list|(
name|struct
name|bgscan_learn_data
modifier|*
name|data
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|bgscan_learn_bss
modifier|*
name|bss
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&data->bss
argument_list|,
argument|struct bgscan_learn_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|bss
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bgscan_learn_load
parameter_list|(
name|struct
name|bgscan_learn_data
modifier|*
name|data
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|char
name|buf
index|[
literal|128
index|]
decl_stmt|;
name|struct
name|bgscan_learn_bss
modifier|*
name|bss
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|fname
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|f
operator|=
name|fopen
argument_list|(
name|data
operator|->
name|fname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Loading data from %s"
argument_list|,
name|data
operator|->
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
operator|==
name|NULL
operator|||
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"wpa_supplicant-bgscan-learn\n"
argument_list|,
literal|28
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"bgscan learn: Invalid data file %s"
argument_list|,
name|data
operator|->
name|fname
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|f
argument_list|)
condition|)
block|{
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"BSS "
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|bss
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
condition|)
continue|continue;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|buf
operator|+
literal|4
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|bss_free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|bss
operator|->
name|freq
operator|=
name|atoi
argument_list|(
name|buf
operator|+
literal|4
operator|+
literal|18
argument_list|)
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|data
operator|->
name|bss
argument_list|,
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Loaded BSS "
literal|"entry: "
name|MACSTR
literal|" freq=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|os_strncmp
argument_list|(
name|buf
argument_list|,
literal|"NEIGHBOR "
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|buf
operator|+
literal|9
argument_list|,
name|addr
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
name|bss
operator|=
name|bgscan_learn_get_bss
argument_list|(
name|data
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|buf
operator|+
literal|9
operator|+
literal|18
argument_list|,
name|addr
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
name|bgscan_learn_add_neighbor
argument_list|(
name|bss
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgscan_learn_save
parameter_list|(
name|struct
name|bgscan_learn_data
modifier|*
name|data
parameter_list|)
block|{
name|FILE
modifier|*
name|f
decl_stmt|;
name|struct
name|bgscan_learn_bss
modifier|*
name|bss
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|fname
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Saving data to %s"
argument_list|,
name|data
operator|->
name|fname
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|data
operator|->
name|fname
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"wpa_supplicant-bgscan-learn\n"
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&data->bss
argument_list|,
argument|struct bgscan_learn_bss
argument_list|,
argument|list
argument_list|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"BSS "
name|MACSTR
literal|" %d\n"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&data->bss
argument_list|,
argument|struct bgscan_learn_bss
argument_list|,
argument|list
argument_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bss
operator|->
name|num_neigh
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"NEIGHBOR "
name|MACSTR
literal|" "
name|MACSTR
literal|"\n"
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|neigh
operator|+
name|i
operator|*
name|ETH_ALEN
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|in_array
parameter_list|(
name|int
modifier|*
name|array
parameter_list|,
name|int
name|val
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|array
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|array
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|array
index|[
name|i
index|]
operator|==
name|val
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
modifier|*
name|bgscan_learn_get_freqs
parameter_list|(
name|struct
name|bgscan_learn_data
modifier|*
name|data
parameter_list|,
name|size_t
modifier|*
name|count
parameter_list|)
block|{
name|struct
name|bgscan_learn_bss
modifier|*
name|bss
decl_stmt|;
name|int
modifier|*
name|freqs
init|=
name|NULL
decl_stmt|,
modifier|*
name|n
decl_stmt|;
operator|*
name|count
operator|=
literal|0
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&data->bss
argument_list|,
argument|struct bgscan_learn_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|in_array
argument_list|(
name|freqs
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
condition|)
continue|continue;
name|n
operator|=
name|os_realloc_array
argument_list|(
name|freqs
argument_list|,
operator|*
name|count
operator|+
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return
name|freqs
return|;
name|freqs
operator|=
name|n
expr_stmt|;
name|freqs
index|[
operator|*
name|count
index|]
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
operator|(
operator|*
name|count
operator|)
operator|++
expr_stmt|;
name|freqs
index|[
operator|*
name|count
index|]
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|freqs
return|;
block|}
end_function

begin_function
specifier|static
name|int
modifier|*
name|bgscan_learn_get_probe_freq
parameter_list|(
name|struct
name|bgscan_learn_data
modifier|*
name|data
parameter_list|,
name|int
modifier|*
name|freqs
parameter_list|,
name|size_t
name|count
parameter_list|)
block|{
name|int
name|idx
decl_stmt|,
modifier|*
name|n
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|supp_freqs
operator|==
name|NULL
condition|)
return|return
name|freqs
return|;
name|idx
operator|=
name|data
operator|->
name|probe_idx
operator|+
literal|1
expr_stmt|;
while|while
condition|(
name|idx
operator|!=
name|data
operator|->
name|probe_idx
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|supp_freqs
index|[
name|idx
index|]
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|data
operator|->
name|probe_idx
operator|==
literal|0
condition|)
break|break;
name|idx
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|in_array
argument_list|(
name|freqs
argument_list|,
name|data
operator|->
name|supp_freqs
index|[
name|idx
index|]
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Probe new freq "
literal|"%u"
argument_list|,
name|data
operator|->
name|supp_freqs
index|[
name|idx
index|]
argument_list|)
expr_stmt|;
name|data
operator|->
name|probe_idx
operator|=
name|idx
expr_stmt|;
name|n
operator|=
name|os_realloc_array
argument_list|(
name|freqs
argument_list|,
name|count
operator|+
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return
name|freqs
return|;
name|freqs
operator|=
name|n
expr_stmt|;
name|freqs
index|[
name|count
index|]
operator|=
name|data
operator|->
name|supp_freqs
index|[
name|idx
index|]
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|freqs
index|[
name|count
index|]
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|idx
operator|++
expr_stmt|;
block|}
return|return
name|freqs
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgscan_learn_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|bgscan_learn_data
modifier|*
name|data
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|data
operator|->
name|wpa_s
decl_stmt|;
name|struct
name|wpa_driver_scan_params
name|params
decl_stmt|;
name|int
modifier|*
name|freqs
init|=
name|NULL
decl_stmt|;
name|size_t
name|count
decl_stmt|,
name|i
decl_stmt|;
name|char
name|msg
index|[
literal|100
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|num_ssids
operator|=
literal|1
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
operator|=
name|data
operator|->
name|ssid
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
operator|=
name|data
operator|->
name|ssid
operator|->
name|ssid_len
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|ssid
operator|->
name|scan_freq
condition|)
name|params
operator|.
name|freqs
operator|=
name|data
operator|->
name|ssid
operator|->
name|scan_freq
expr_stmt|;
else|else
block|{
name|freqs
operator|=
name|bgscan_learn_get_freqs
argument_list|(
name|data
argument_list|,
operator|&
name|count
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: BSSes in this ESS have "
literal|"been seen on %u channels"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|count
argument_list|)
expr_stmt|;
name|freqs
operator|=
name|bgscan_learn_get_probe_freq
argument_list|(
name|data
argument_list|,
name|freqs
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|msg
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|=
name|msg
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|freqs
operator|&&
name|freqs
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|msg
operator|+
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
operator|-
name|pos
argument_list|,
literal|" %d"
argument_list|,
name|freqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
name|ret
operator|>=
name|msg
operator|+
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
operator|-
name|pos
condition|)
break|break;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|pos
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Scanning frequencies:%s"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|params
operator|.
name|freqs
operator|=
name|freqs
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Request a background scan"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_trigger_scan
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Failed to trigger scan"
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|data
operator|->
name|scan_interval
argument_list|,
literal|0
argument_list|,
name|bgscan_learn_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|os_get_time
argument_list|(
operator|&
name|data
operator|->
name|last_bgscan
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bgscan_learn_get_params
parameter_list|(
name|struct
name|bgscan_learn_data
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|params
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|data
operator|->
name|short_interval
operator|=
name|atoi
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|params
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|pos
operator|++
expr_stmt|;
name|data
operator|->
name|signal_threshold
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"bgscan learn: Missing scan interval "
literal|"for high signal"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|data
operator|->
name|long_interval
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
condition|)
block|{
name|pos
operator|++
expr_stmt|;
name|data
operator|->
name|fname
operator|=
name|os_strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
modifier|*
name|bgscan_learn_get_supp_freqs
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|hostapd_hw_modes
modifier|*
name|modes
decl_stmt|;
name|int
name|i
decl_stmt|,
name|j
decl_stmt|,
modifier|*
name|freqs
init|=
name|NULL
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|size_t
name|count
init|=
literal|0
decl_stmt|;
name|modes
operator|=
name|wpa_s
operator|->
name|hw
operator|.
name|modes
expr_stmt|;
if|if
condition|(
name|modes
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|modes
index|[
name|i
index|]
operator|.
name|num_channels
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|modes
index|[
name|i
index|]
operator|.
name|channels
index|[
name|j
index|]
operator|.
name|flag
operator|&
name|HOSTAPD_CHAN_DISABLED
condition|)
continue|continue;
name|n
operator|=
name|os_realloc_array
argument_list|(
name|freqs
argument_list|,
name|count
operator|+
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
continue|continue;
name|freqs
operator|=
name|n
expr_stmt|;
name|freqs
index|[
name|count
index|]
operator|=
name|modes
index|[
name|i
index|]
operator|.
name|channels
index|[
name|j
index|]
operator|.
name|freq
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|freqs
index|[
name|count
index|]
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
name|freqs
return|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|bgscan_learn_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|,
specifier|const
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|bgscan_learn_data
modifier|*
name|data
decl_stmt|;
name|data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|dl_list_init
argument_list|(
operator|&
name|data
operator|->
name|bss
argument_list|)
expr_stmt|;
name|data
operator|->
name|wpa_s
operator|=
name|wpa_s
expr_stmt|;
name|data
operator|->
name|ssid
operator|=
name|ssid
expr_stmt|;
if|if
condition|(
name|bgscan_learn_get_params
argument_list|(
name|data
argument_list|,
name|params
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|fname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|data
operator|->
name|short_interval
operator|<=
literal|0
condition|)
name|data
operator|->
name|short_interval
operator|=
literal|30
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|long_interval
operator|<=
literal|0
condition|)
name|data
operator|->
name|long_interval
operator|=
literal|30
expr_stmt|;
if|if
condition|(
name|bgscan_learn_load
argument_list|(
name|data
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|data
operator|->
name|fname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Signal strength threshold %d  "
literal|"Short bgscan interval %d  Long bgscan interval %d"
argument_list|,
name|data
operator|->
name|signal_threshold
argument_list|,
name|data
operator|->
name|short_interval
argument_list|,
name|data
operator|->
name|long_interval
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|signal_threshold
operator|&&
name|wpa_drv_signal_monitor
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|signal_threshold
argument_list|,
literal|4
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"bgscan learn: Failed to enable "
literal|"signal strength monitoring"
argument_list|)
expr_stmt|;
block|}
name|data
operator|->
name|supp_freqs
operator|=
name|bgscan_learn_get_supp_freqs
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|data
operator|->
name|scan_interval
operator|=
name|data
operator|->
name|short_interval
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|data
operator|->
name|scan_interval
argument_list|,
literal|0
argument_list|,
name|bgscan_learn_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * This function is called immediately after an association, so it is 	 * reasonable to assume that a scan was completed recently. This makes 	 * us skip an immediate new scan in cases where the current signal 	 * level is below the bgscan threshold. 	 */
name|os_get_time
argument_list|(
operator|&
name|data
operator|->
name|last_bgscan
argument_list|)
expr_stmt|;
return|return
name|data
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgscan_learn_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|struct
name|bgscan_learn_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|struct
name|bgscan_learn_bss
modifier|*
name|bss
decl_stmt|,
modifier|*
name|n
decl_stmt|;
name|bgscan_learn_save
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|bgscan_learn_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|signal_threshold
condition|)
name|wpa_drv_signal_monitor
argument_list|(
name|data
operator|->
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
operator|->
name|fname
argument_list|)
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|bss
argument_list|,
argument|n
argument_list|,
argument|&data->bss
argument_list|,
argument|struct bgscan_learn_bss
argument_list|,
argument|list
argument_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
name|bss_free
argument_list|(
name|bss
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|data
operator|->
name|supp_freqs
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|data
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|bgscan_learn_bss_match
parameter_list|(
name|struct
name|bgscan_learn_data
modifier|*
name|data
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|bss
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|data
operator|->
name|ssid
operator|->
name|ssid_len
operator|!=
name|ie
index|[
literal|1
index|]
operator|||
name|os_memcmp
argument_list|(
name|data
operator|->
name|ssid
operator|->
name|ssid
argument_list|,
name|ie
operator|+
literal|2
argument_list|,
name|ie
index|[
literal|1
index|]
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* SSID mismatch */
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|bgscan_learn_notify_scan
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|struct
name|bgscan_learn_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
define|#
directive|define
name|MAX_BSS
value|50
name|u8
name|bssid
index|[
name|MAX_BSS
operator|*
name|ETH_ALEN
index|]
decl_stmt|;
name|size_t
name|num_bssid
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: scan result notification"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|bgscan_learn_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|data
operator|->
name|scan_interval
argument_list|,
literal|0
argument_list|,
name|bgscan_learn_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scan_res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|res
init|=
name|scan_res
operator|->
name|res
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|bgscan_learn_bss_match
argument_list|(
name|data
argument_list|,
name|res
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|num_bssid
operator|<
name|MAX_BSS
condition|)
block|{
name|os_memcpy
argument_list|(
name|bssid
operator|+
name|num_bssid
operator|*
name|ETH_ALEN
argument_list|,
name|res
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|num_bssid
operator|++
expr_stmt|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: %u matching BSSes in scan "
literal|"results"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|num_bssid
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scan_res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|res
init|=
name|scan_res
operator|->
name|res
index|[
name|i
index|]
decl_stmt|;
name|struct
name|bgscan_learn_bss
modifier|*
name|bss
decl_stmt|;
if|if
condition|(
operator|!
name|bgscan_learn_bss_match
argument_list|(
name|data
argument_list|,
name|res
argument_list|)
condition|)
continue|continue;
name|bss
operator|=
name|bgscan_learn_get_bss
argument_list|(
name|data
argument_list|,
name|res
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|&&
name|bss
operator|->
name|freq
operator|!=
name|res
operator|->
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Update BSS "
name|MACSTR
literal|" freq %d -> %d"
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|bssid
argument_list|)
argument_list|,
name|bss
operator|->
name|freq
argument_list|,
name|res
operator|->
name|freq
argument_list|)
expr_stmt|;
name|bss
operator|->
name|freq
operator|=
name|res
operator|->
name|freq
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|bss
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Add BSS "
name|MACSTR
literal|" freq=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|bssid
argument_list|)
argument_list|,
name|res
operator|->
name|freq
argument_list|)
expr_stmt|;
name|bss
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bss
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
condition|)
continue|continue;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|bssid
argument_list|,
name|res
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|bss
operator|->
name|freq
operator|=
name|res
operator|->
name|freq
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|data
operator|->
name|bss
argument_list|,
operator|&
name|bss
operator|->
name|list
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|num_bssid
condition|;
name|j
operator|++
control|)
block|{
name|u8
modifier|*
name|addr
init|=
name|bssid
operator|+
name|j
operator|*
name|ETH_ALEN
decl_stmt|;
name|bgscan_learn_add_neighbor
argument_list|(
name|bss
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* 	 * A more advanced bgscan could process scan results internally, select 	 * the BSS and request roam if needed. This sample uses the existing 	 * BSS/ESS selection routine. Change this to return 1 if selection is 	 * done inside the bgscan module. 	 */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|bgscan_learn_notify_beacon_loss
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: beacon loss"
argument_list|)
expr_stmt|;
comment|/* TODO: speed up background scanning */
block|}
end_function

begin_function
specifier|static
name|void
name|bgscan_learn_notify_signal_change
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|int
name|above
parameter_list|,
name|int
name|current_signal
parameter_list|,
name|int
name|current_noise
parameter_list|,
name|int
name|current_txrate
parameter_list|)
block|{
name|struct
name|bgscan_learn_data
modifier|*
name|data
init|=
name|priv
decl_stmt|;
name|int
name|scan
init|=
literal|0
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|;
if|if
condition|(
name|data
operator|->
name|short_interval
operator|==
name|data
operator|->
name|long_interval
operator|||
name|data
operator|->
name|signal_threshold
operator|==
literal|0
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: signal level changed "
literal|"(above=%d current_signal=%d current_noise=%d "
literal|"current_txrate=%d)"
argument_list|,
name|above
argument_list|,
name|current_signal
argument_list|,
name|current_noise
argument_list|,
name|current_txrate
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|scan_interval
operator|==
name|data
operator|->
name|long_interval
operator|&&
operator|!
name|above
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Start using short bgscan "
literal|"interval"
argument_list|)
expr_stmt|;
name|data
operator|->
name|scan_interval
operator|=
name|data
operator|->
name|short_interval
expr_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|.
name|sec
operator|>
name|data
operator|->
name|last_bgscan
operator|.
name|sec
operator|+
literal|1
condition|)
name|scan
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|data
operator|->
name|scan_interval
operator|==
name|data
operator|->
name|short_interval
operator|&&
name|above
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Start using long bgscan "
literal|"interval"
argument_list|)
expr_stmt|;
name|data
operator|->
name|scan_interval
operator|=
name|data
operator|->
name|long_interval
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|bgscan_learn_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|data
operator|->
name|scan_interval
argument_list|,
literal|0
argument_list|,
name|bgscan_learn_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|above
condition|)
block|{
comment|/* 		 * Signal dropped further 4 dB. Request a new scan if we have 		 * not yet scanned in a while. 		 */
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|.
name|sec
operator|>
name|data
operator|->
name|last_bgscan
operator|.
name|sec
operator|+
literal|10
condition|)
name|scan
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|scan
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bgscan learn: Trigger immediate scan"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|bgscan_learn_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|bgscan_learn_timeout
argument_list|,
name|data
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|const
name|struct
name|bgscan_ops
name|bgscan_learn_ops
init|=
block|{
operator|.
name|name
operator|=
literal|"learn"
block|,
operator|.
name|init
operator|=
name|bgscan_learn_init
block|,
operator|.
name|deinit
operator|=
name|bgscan_learn_deinit
block|,
operator|.
name|notify_scan
operator|=
name|bgscan_learn_notify_scan
block|,
operator|.
name|notify_beacon_loss
operator|=
name|bgscan_learn_notify_beacon_loss
block|,
operator|.
name|notify_signal_change
operator|=
name|bgscan_learn_notify_signal_change
block|, }
decl_stmt|;
end_decl_stmt

end_unit


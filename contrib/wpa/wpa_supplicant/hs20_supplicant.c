begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2009, Atheros Communications, Inc.  * Copyright (c) 2011-2013, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/gas.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"blacklist.h"
end_include

begin_include
include|#
directive|include
file|"gas_query.h"
end_include

begin_include
include|#
directive|include
file|"interworking.h"
end_include

begin_include
include|#
directive|include
file|"hs20_supplicant.h"
end_include

begin_define
define|#
directive|define
name|OSU_MAX_ITEMS
value|10
end_define

begin_struct
struct|struct
name|osu_lang_string
block|{
name|char
name|lang
index|[
literal|4
index|]
decl_stmt|;
name|char
name|text
index|[
literal|253
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|osu_icon
block|{
name|u16
name|width
decl_stmt|;
name|u16
name|height
decl_stmt|;
name|char
name|lang
index|[
literal|4
index|]
decl_stmt|;
name|char
name|icon_type
index|[
literal|256
index|]
decl_stmt|;
name|char
name|filename
index|[
literal|256
index|]
decl_stmt|;
name|unsigned
name|int
name|id
decl_stmt|;
name|unsigned
name|int
name|failed
range|:
literal|1
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|osu_provider
block|{
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|osu_ssid
index|[
literal|32
index|]
decl_stmt|;
name|u8
name|osu_ssid_len
decl_stmt|;
name|char
name|server_uri
index|[
literal|256
index|]
decl_stmt|;
name|u32
name|osu_methods
decl_stmt|;
comment|/* bit 0 = OMA-DM, bit 1 = SOAP-XML SPP */
name|char
name|osu_nai
index|[
literal|256
index|]
decl_stmt|;
name|struct
name|osu_lang_string
name|friendly_name
index|[
name|OSU_MAX_ITEMS
index|]
decl_stmt|;
name|size_t
name|friendly_name_count
decl_stmt|;
name|struct
name|osu_lang_string
name|serv_desc
index|[
name|OSU_MAX_ITEMS
index|]
decl_stmt|;
name|size_t
name|serv_desc_count
decl_stmt|;
name|struct
name|osu_icon
name|icon
index|[
name|OSU_MAX_ITEMS
index|]
decl_stmt|;
name|size_t
name|icon_count
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|void
name|wpas_hs20_add_indication
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|,
name|int
name|pps_mo_id
parameter_list|)
block|{
name|u8
name|conf
decl_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_EID_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|pps_mo_id
operator|>=
literal|0
condition|?
literal|7
else|:
literal|5
argument_list|)
expr_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_INDICATION_OUI_TYPE
argument_list|)
expr_stmt|;
name|conf
operator|=
name|HS20_VERSION
expr_stmt|;
if|if
condition|(
name|pps_mo_id
operator|>=
literal|0
condition|)
name|conf
operator||=
name|HS20_PPS_MO_ID_PRESENT
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|pps_mo_id
operator|>=
literal|0
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|pps_mo_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|is_hs20_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|hs20
operator|||
operator|!
name|ssid
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ssid
operator|->
name|parent_cred
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bss
operator|&&
operator|!
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|HS20_IE_VENDOR_TYPE
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* 	 * This may catch some non-Hotspot 2.0 cases, but it is safer to do that 	 * than cause Hotspot 2.0 connections without indication element getting 	 * added. Non-Hotspot 2.0 APs should ignore the unknown vendor element. 	 */
if|if
condition|(
operator|!
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
name|ssid
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_CCMP
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ssid
operator|->
name|proto
operator|!=
name|WPA_PROTO_RSN
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|hs20_get_pps_mo_id
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_cred
modifier|*
name|cred
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|ssid
operator|->
name|update_identifier
condition|)
return|return
name|ssid
operator|->
name|update_identifier
return|;
if|if
condition|(
name|ssid
operator|->
name|parent_cred
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
for|for
control|(
name|cred
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|cred
init|;
name|cred
condition|;
name|cred
operator|=
name|cred
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|parent_cred
operator|==
name|cred
condition|)
return|return
name|cred
operator|->
name|update_identifier
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|hs20_put_anqp_req
parameter_list|(
name|u32
name|stypes
parameter_list|,
specifier|const
name|u8
modifier|*
name|payload
parameter_list|,
name|size_t
name|payload_len
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|u8
modifier|*
name|len_pos
decl_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|len_pos
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_ANQP_OUI_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|stypes
operator|==
name|BIT
argument_list|(
name|HS20_STYPE_NAI_HOME_REALM_QUERY
argument_list|)
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_NAI_HOME_REALM_QUERY
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
if|if
condition|(
name|payload
condition|)
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|payload
argument_list|,
name|payload_len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|stypes
operator|==
name|BIT
argument_list|(
name|HS20_STYPE_ICON_REQUEST
argument_list|)
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_ICON_REQUEST
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
if|if
condition|(
name|payload
condition|)
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|payload
argument_list|,
name|payload_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u8
name|i
decl_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_QUERY_LIST
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|stypes
operator|&
name|BIT
argument_list|(
name|i
argument_list|)
condition|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len_pos
argument_list|)
expr_stmt|;
name|gas_anqp_set_len
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|hs20_build_anqp_req
parameter_list|(
name|u32
name|stypes
parameter_list|,
specifier|const
name|u8
modifier|*
name|payload
parameter_list|,
name|size_t
name|payload_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|gas_anqp_build_initial_req
argument_list|(
literal|0
argument_list|,
literal|100
operator|+
name|payload_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|hs20_put_anqp_req
argument_list|(
name|stypes
argument_list|,
name|payload
argument_list|,
name|payload_len
argument_list|,
name|buf
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|int
name|hs20_anqp_send_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u32
name|stypes
parameter_list|,
specifier|const
name|u8
modifier|*
name|payload
parameter_list|,
name|size_t
name|payload_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|res
decl_stmt|;
name|freq
operator|=
name|wpa_s
operator|->
name|assoc_freq
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|wpa_bss_anqp_unshare_alloc
argument_list|(
name|bss
argument_list|)
expr_stmt|;
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
block|}
if|if
condition|(
name|freq
operator|<=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS20: ANQP Query Request to "
name|MACSTR
literal|" for "
literal|"subtypes 0x%x"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
name|stypes
argument_list|)
expr_stmt|;
name|buf
operator|=
name|hs20_build_anqp_req
argument_list|(
name|stypes
argument_list|,
name|payload
argument_list|,
name|payload_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|gas_query_req
argument_list|(
name|wpa_s
operator|->
name|gas
argument_list|,
name|dst
argument_list|,
name|freq
argument_list|,
name|buf
argument_list|,
name|anqp_resp_cb
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Failed to send Query Request"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Query started with dialog token "
literal|"%u"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hs20_set_osu_access_permission
parameter_list|(
specifier|const
name|char
modifier|*
name|osu_dir
parameter_list|,
specifier|const
name|char
modifier|*
name|fname
parameter_list|)
block|{
name|struct
name|stat
name|statbuf
decl_stmt|;
comment|/* Get OSU directory information */
if|if
condition|(
name|stat
argument_list|(
name|osu_dir
argument_list|,
operator|&
name|statbuf
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Cannot stat the OSU directory %s"
argument_list|,
name|osu_dir
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|chmod
argument_list|(
name|fname
argument_list|,
name|statbuf
operator|.
name|st_mode
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Cannot change the permissions for %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|chown
argument_list|(
name|fname
argument_list|,
name|statbuf
operator|.
name|st_uid
argument_list|,
name|statbuf
operator|.
name|st_gid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Cannot change the ownership for %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|hs20_process_icon_binary_file
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|slen
parameter_list|)
block|{
name|char
name|fname
index|[
literal|256
index|]
decl_stmt|;
name|int
name|png
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|u16
name|data_len
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" Icon Binary File"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|slen
operator|<
literal|4
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Too short Icon Binary File "
literal|"value from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Download Status Code %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|!=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|++
expr_stmt|;
name|slen
operator|--
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
literal|1
operator|+
name|pos
index|[
literal|0
index|]
operator|>
name|slen
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Too short Icon Binary File "
literal|"value from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Icon Type"
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|png
operator|=
name|os_strncasecmp
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pos
operator|+
literal|1
argument_list|,
literal|"image/png"
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
expr_stmt|;
name|slen
operator|-=
literal|1
operator|+
name|pos
index|[
literal|0
index|]
expr_stmt|;
name|pos
operator|+=
literal|1
operator|+
name|pos
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|slen
operator|<
literal|2
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Too short Icon Binary File "
literal|"value from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|data_len
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|slen
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|data_len
operator|>
name|slen
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Too short Icon Binary File "
literal|"value from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Icon Binary Data: %u bytes"
argument_list|,
name|data_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|osu_dir
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_s
operator|->
name|osu_icon_id
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|osu_icon_id
operator|==
literal|0
condition|)
name|wpa_s
operator|->
name|osu_icon_id
operator|++
expr_stmt|;
name|snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"%s/osu-icon-%u.%s"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|osu_dir
argument_list|,
name|wpa_s
operator|->
name|osu_icon_id
argument_list|,
name|png
condition|?
literal|"png"
else|:
literal|"icon"
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"wb"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|hs20_set_osu_access_permission
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|osu_dir
argument_list|,
name|fname
argument_list|)
expr_stmt|;
if|if
condition|(
name|fwrite
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|,
literal|1
argument_list|,
name|f
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|fname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP-ICON %s"
argument_list|,
name|fname
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|hs20_continue_icon_fetch
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
condition|)
name|hs20_next_osu_icon
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hs20_osu_icon_fetch_result
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|res
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|struct
name|os_reltime
name|now
decl_stmt|,
name|tmp
decl_stmt|;
name|int
name|dur
decl_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|os_reltime_sub
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|wpa_s
operator|->
name|osu_icon_fetch_start
argument_list|,
operator|&
name|tmp
argument_list|)
expr_stmt|;
name|dur
operator|=
name|tmp
operator|.
name|sec
operator|*
literal|1000
operator|+
name|tmp
operator|.
name|usec
operator|/
literal|1000
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Icon fetch dur=%d ms res=%d"
argument_list|,
name|dur
argument_list|,
name|res
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|osu_prov_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|osu_provider
modifier|*
name|osu
init|=
operator|&
name|wpa_s
operator|->
name|osu_prov
index|[
name|i
index|]
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|osu
operator|->
name|icon_count
condition|;
name|j
operator|++
control|)
block|{
name|struct
name|osu_icon
modifier|*
name|icon
init|=
operator|&
name|osu
operator|->
name|icon
index|[
name|j
index|]
decl_stmt|;
if|if
condition|(
name|icon
operator|->
name|id
operator|||
name|icon
operator|->
name|failed
condition|)
continue|continue;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|icon
operator|->
name|failed
operator|=
literal|1
expr_stmt|;
else|else
name|icon
operator|->
name|id
operator|=
name|wpa_s
operator|->
name|osu_icon_id
expr_stmt|;
return|return;
block|}
block|}
block|}
end_function

begin_function
name|void
name|hs20_parse_rx_hs20_anqp_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|slen
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|data
decl_stmt|;
name|u8
name|subtype
decl_stmt|;
name|struct
name|wpa_bss_anqp
modifier|*
name|anqp
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|slen
operator|<
literal|2
condition|)
return|return;
if|if
condition|(
name|bss
condition|)
name|anqp
operator|=
name|bss
operator|->
name|anqp
expr_stmt|;
name|subtype
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|slen
operator|--
expr_stmt|;
name|pos
operator|++
expr_stmt|;
comment|/* Reserved */
name|slen
operator|--
expr_stmt|;
switch|switch
condition|(
name|subtype
condition|)
block|{
case|case
name|HS20_STYPE_CAPABILITY_LIST
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" HS Capability List"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS Capability List"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_capability_list
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|hs20_capability_list
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HS20_STYPE_OPERATOR_FRIENDLY_NAME
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" Operator Friendly Name"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"oper friendly name"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_operator_friendly_name
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|hs20_operator_friendly_name
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HS20_STYPE_WAN_METRICS
case|:
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WAN Metrics"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|slen
operator|<
literal|13
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Too short WAN "
literal|"Metrics value from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" WAN Metrics %02x:%u:%u:%u:%u:%u"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|,
name|WPA_GET_LE32
argument_list|(
name|pos
operator|+
literal|1
argument_list|)
argument_list|,
name|WPA_GET_LE32
argument_list|(
name|pos
operator|+
literal|5
argument_list|)
argument_list|,
name|pos
index|[
literal|9
index|]
argument_list|,
name|pos
index|[
literal|10
index|]
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|pos
operator|+
literal|11
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_wan_metrics
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|hs20_wan_metrics
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HS20_STYPE_CONNECTION_CAPABILITY
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" Connection Capability"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"conn capability"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_connection_capability
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|hs20_connection_capability
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HS20_STYPE_OPERATING_CLASS
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" Operating Class"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Operating Class"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_operating_class
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|hs20_operating_class
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HS20_STYPE_OSU_PROVIDERS_LIST
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" OSU Providers list"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|num_prov_found
operator|++
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_osu_providers_list
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|hs20_osu_providers_list
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HS20_STYPE_ICON_BINARY_FILE
case|:
name|ret
operator|=
name|hs20_process_icon_binary_file
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
condition|)
block|{
name|hs20_osu_icon_fetch_result
argument_list|(
name|wpa_s
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|hs20_continue_icon_fetch
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|hs20_continue_icon_fetch
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS20: Unsupported subtype %u"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|hs20_notify_parse_done
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
condition|)
return|return;
if|if
condition|(
name|eloop_is_timeout_registered
argument_list|(
name|hs20_continue_icon_fetch
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
condition|)
return|return;
comment|/* 	 * We are going through icon fetch, but no icon response was received. 	 * Assume this means the current AP could not provide an answer to avoid 	 * getting stuck in fetch iteration. 	 */
name|hs20_icon_fetch_failed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hs20_free_osu_prov_entry
parameter_list|(
name|struct
name|osu_provider
modifier|*
name|prov
parameter_list|)
block|{ }
end_function

begin_function
name|void
name|hs20_free_osu_prov
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|osu_prov_count
condition|;
name|i
operator|++
control|)
name|hs20_free_osu_prov_entry
argument_list|(
operator|&
name|wpa_s
operator|->
name|osu_prov
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|osu_prov
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|osu_prov
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|osu_prov_count
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hs20_osu_fetch_done
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|char
name|fname
index|[
literal|256
index|]
decl_stmt|;
name|FILE
modifier|*
name|f
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|wpa_s
operator|->
name|fetch_osu_info
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|osu_dir
operator|==
name|NULL
condition|)
block|{
name|hs20_free_osu_prov
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|fetch_anqp_in_progress
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|snprintf
argument_list|(
name|fname
argument_list|,
sizeof|sizeof
argument_list|(
name|fname
argument_list|)
argument_list|,
literal|"%s/osu-providers.txt"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|osu_dir
argument_list|)
expr_stmt|;
name|f
operator|=
name|fopen
argument_list|(
name|fname
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|NULL
condition|)
block|{
name|hs20_free_osu_prov
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
name|hs20_set_osu_access_permission
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|osu_dir
argument_list|,
name|fname
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|osu_prov_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|osu_provider
modifier|*
name|osu
init|=
operator|&
name|wpa_s
operator|->
name|osu_prov
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|i
operator|>
literal|0
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"OSU-PROVIDER "
name|MACSTR
literal|"\n"
literal|"uri=%s\n"
literal|"methods=%08x\n"
argument_list|,
name|MAC2STR
argument_list|(
name|osu
operator|->
name|bssid
argument_list|)
argument_list|,
name|osu
operator|->
name|server_uri
argument_list|,
name|osu
operator|->
name|osu_methods
argument_list|)
expr_stmt|;
if|if
condition|(
name|osu
operator|->
name|osu_ssid_len
condition|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"osu_ssid=%s\n"
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|osu
operator|->
name|osu_ssid
argument_list|,
name|osu
operator|->
name|osu_ssid_len
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|osu
operator|->
name|osu_nai
index|[
literal|0
index|]
condition|)
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"osu_nai=%s\n"
argument_list|,
name|osu
operator|->
name|osu_nai
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|osu
operator|->
name|friendly_name_count
condition|;
name|j
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"friendly_name=%s:%s\n"
argument_list|,
name|osu
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|lang
argument_list|,
name|osu
operator|->
name|friendly_name
index|[
name|j
index|]
operator|.
name|text
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|osu
operator|->
name|serv_desc_count
condition|;
name|j
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"desc=%s:%s\n"
argument_list|,
name|osu
operator|->
name|serv_desc
index|[
name|j
index|]
operator|.
name|lang
argument_list|,
name|osu
operator|->
name|serv_desc
index|[
name|j
index|]
operator|.
name|text
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|osu
operator|->
name|icon_count
condition|;
name|j
operator|++
control|)
block|{
name|struct
name|osu_icon
modifier|*
name|icon
init|=
operator|&
name|osu
operator|->
name|icon
index|[
name|j
index|]
decl_stmt|;
if|if
condition|(
name|icon
operator|->
name|failed
condition|)
continue|continue;
comment|/* could not fetch icon */
name|fprintf
argument_list|(
name|f
argument_list|,
literal|"icon=%u:%u:%u:%s:%s:%s\n"
argument_list|,
name|icon
operator|->
name|id
argument_list|,
name|icon
operator|->
name|width
argument_list|,
name|icon
operator|->
name|height
argument_list|,
name|icon
operator|->
name|lang
argument_list|,
name|icon
operator|->
name|icon_type
argument_list|,
name|icon
operator|->
name|filename
argument_list|)
expr_stmt|;
block|}
block|}
name|fclose
argument_list|(
name|f
argument_list|)
expr_stmt|;
name|hs20_free_osu_prov
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"OSU provider fetch completed"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|fetch_anqp_in_progress
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hs20_next_osu_icon
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Ready to fetch next icon"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|osu_prov_count
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|osu_provider
modifier|*
name|osu
init|=
operator|&
name|wpa_s
operator|->
name|osu_prov
index|[
name|i
index|]
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|osu
operator|->
name|icon_count
condition|;
name|j
operator|++
control|)
block|{
name|struct
name|osu_icon
modifier|*
name|icon
init|=
operator|&
name|osu
operator|->
name|icon
index|[
name|j
index|]
decl_stmt|;
if|if
condition|(
name|icon
operator|->
name|id
operator|||
name|icon
operator|->
name|failed
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Try to fetch icon '%s' "
literal|"from "
name|MACSTR
argument_list|,
name|icon
operator|->
name|filename
argument_list|,
name|MAC2STR
argument_list|(
name|osu
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|wpa_s
operator|->
name|osu_icon_fetch_start
argument_list|)
expr_stmt|;
if|if
condition|(
name|hs20_anqp_send_req
argument_list|(
name|wpa_s
argument_list|,
name|osu
operator|->
name|bssid
argument_list|,
name|BIT
argument_list|(
name|HS20_STYPE_ICON_REQUEST
argument_list|)
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|icon
operator|->
name|filename
argument_list|,
name|os_strlen
argument_list|(
name|icon
operator|->
name|filename
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|icon
operator|->
name|failed
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
return|return;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: No more icons to fetch"
argument_list|)
expr_stmt|;
name|hs20_osu_fetch_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hs20_osu_add_prov
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
specifier|const
name|u8
modifier|*
name|osu_ssid
parameter_list|,
name|u8
name|osu_ssid_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|osu_provider
modifier|*
name|prov
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|pos
operator|+
name|len
decl_stmt|;
name|u16
name|len2
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos2
decl_stmt|;
name|u8
name|uri_len
decl_stmt|,
name|osu_method_len
decl_stmt|,
name|osu_nai_len
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Parsing OSU Provider"
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|prov
operator|=
name|os_realloc_array
argument_list|(
name|wpa_s
operator|->
name|osu_prov
argument_list|,
name|wpa_s
operator|->
name|osu_prov_count
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|prov
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|prov
operator|==
name|NULL
condition|)
return|return;
name|wpa_s
operator|->
name|osu_prov
operator|=
name|prov
expr_stmt|;
name|prov
operator|=
operator|&
name|prov
index|[
name|wpa_s
operator|->
name|osu_prov_count
index|]
expr_stmt|;
name|os_memset
argument_list|(
name|prov
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|prov
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|prov
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|prov
operator|->
name|osu_ssid
argument_list|,
name|osu_ssid
argument_list|,
name|osu_ssid_len
argument_list|)
expr_stmt|;
name|prov
operator|->
name|osu_ssid_len
operator|=
name|osu_ssid_len
expr_stmt|;
comment|/* OSU Friendly Name Length */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for OSU "
literal|"Friendly Name Length"
argument_list|)
expr_stmt|;
return|return;
block|}
name|len2
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|len2
operator|>
name|end
operator|-
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for OSU "
literal|"Friendly Name Duples"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos2
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|len2
expr_stmt|;
comment|/* OSU Friendly Name Duples */
while|while
condition|(
name|pos2
operator|+
literal|4
operator|<=
name|pos
operator|&&
name|prov
operator|->
name|friendly_name_count
operator|<
name|OSU_MAX_ITEMS
condition|)
block|{
name|struct
name|osu_lang_string
modifier|*
name|f
decl_stmt|;
if|if
condition|(
name|pos2
operator|+
literal|1
operator|+
name|pos2
index|[
literal|0
index|]
operator|>
name|pos
operator|||
name|pos2
index|[
literal|0
index|]
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid OSU Friendly Name"
argument_list|)
expr_stmt|;
break|break;
block|}
name|f
operator|=
operator|&
name|prov
operator|->
name|friendly_name
index|[
name|prov
operator|->
name|friendly_name_count
operator|++
index|]
expr_stmt|;
name|os_memcpy
argument_list|(
name|f
operator|->
name|lang
argument_list|,
name|pos2
operator|+
literal|1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|f
operator|->
name|text
argument_list|,
name|pos2
operator|+
literal|1
operator|+
literal|3
argument_list|,
name|pos2
index|[
literal|0
index|]
operator|-
literal|3
argument_list|)
expr_stmt|;
name|pos2
operator|+=
literal|1
operator|+
name|pos2
index|[
literal|0
index|]
expr_stmt|;
block|}
comment|/* OSU Server URI */
if|if
condition|(
name|pos
operator|+
literal|1
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for OSU Server URI length"
argument_list|)
expr_stmt|;
return|return;
block|}
name|uri_len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|uri_len
operator|>
name|end
operator|-
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for OSU Server "
literal|"URI"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|prov
operator|->
name|server_uri
argument_list|,
name|pos
argument_list|,
name|uri_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|uri_len
expr_stmt|;
comment|/* OSU Method list */
if|if
condition|(
name|pos
operator|+
literal|1
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for OSU Method "
literal|"list length"
argument_list|)
expr_stmt|;
return|return;
block|}
name|osu_method_len
operator|=
name|pos
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|osu_method_len
operator|>
name|end
operator|-
name|pos
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for OSU Method "
literal|"list"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos2
operator|=
name|pos
operator|+
literal|1
expr_stmt|;
name|pos
operator|+=
literal|1
operator|+
name|osu_method_len
expr_stmt|;
while|while
condition|(
name|pos2
operator|<
name|pos
condition|)
block|{
if|if
condition|(
operator|*
name|pos2
operator|<
literal|32
condition|)
name|prov
operator|->
name|osu_methods
operator||=
name|BIT
argument_list|(
operator|*
name|pos2
argument_list|)
expr_stmt|;
name|pos2
operator|++
expr_stmt|;
block|}
comment|/* Icons Available Length */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for Icons "
literal|"Available Length"
argument_list|)
expr_stmt|;
return|return;
block|}
name|len2
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|len2
operator|>
name|end
operator|-
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for Icons "
literal|"Available"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos2
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|len2
expr_stmt|;
comment|/* Icons Available */
while|while
condition|(
name|pos2
operator|<
name|pos
condition|)
block|{
name|struct
name|osu_icon
modifier|*
name|icon
init|=
operator|&
name|prov
operator|->
name|icon
index|[
name|prov
operator|->
name|icon_count
index|]
decl_stmt|;
name|u8
name|flen
decl_stmt|;
if|if
condition|(
name|pos2
operator|+
literal|2
operator|+
literal|2
operator|+
literal|3
operator|+
literal|1
operator|+
literal|1
operator|>
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Invalid Icon Metadata"
argument_list|)
expr_stmt|;
break|break;
block|}
name|icon
operator|->
name|width
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos2
argument_list|)
expr_stmt|;
name|pos2
operator|+=
literal|2
expr_stmt|;
name|icon
operator|->
name|height
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos2
argument_list|)
expr_stmt|;
name|pos2
operator|+=
literal|2
expr_stmt|;
name|os_memcpy
argument_list|(
name|icon
operator|->
name|lang
argument_list|,
name|pos2
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|pos2
operator|+=
literal|3
expr_stmt|;
name|flen
operator|=
name|pos2
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|flen
operator|>
name|pos
operator|-
name|pos2
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not room for Icon Type"
argument_list|)
expr_stmt|;
break|break;
block|}
name|os_memcpy
argument_list|(
name|icon
operator|->
name|icon_type
argument_list|,
name|pos2
operator|+
literal|1
argument_list|,
name|flen
argument_list|)
expr_stmt|;
name|pos2
operator|+=
literal|1
operator|+
name|flen
expr_stmt|;
if|if
condition|(
name|pos2
operator|+
literal|1
operator|>
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not room for Icon "
literal|"Filename length"
argument_list|)
expr_stmt|;
break|break;
block|}
name|flen
operator|=
name|pos2
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|flen
operator|>
name|pos
operator|-
name|pos2
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not room for Icon "
literal|"Filename"
argument_list|)
expr_stmt|;
break|break;
block|}
name|os_memcpy
argument_list|(
name|icon
operator|->
name|filename
argument_list|,
name|pos2
operator|+
literal|1
argument_list|,
name|flen
argument_list|)
expr_stmt|;
name|pos2
operator|+=
literal|1
operator|+
name|flen
expr_stmt|;
name|prov
operator|->
name|icon_count
operator|++
expr_stmt|;
block|}
comment|/* OSU_NAI */
if|if
condition|(
name|pos
operator|+
literal|1
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for OSU_NAI"
argument_list|)
expr_stmt|;
return|return;
block|}
name|osu_nai_len
operator|=
name|pos
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|osu_nai_len
operator|>
name|end
operator|-
name|pos
operator|-
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for OSU_NAI"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|prov
operator|->
name|osu_nai
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|osu_nai_len
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|1
operator|+
name|osu_nai_len
expr_stmt|;
comment|/* OSU Service Description Length */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for OSU "
literal|"Service Description Length"
argument_list|)
expr_stmt|;
return|return;
block|}
name|len2
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|len2
operator|>
name|end
operator|-
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for OSU "
literal|"Service Description Duples"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos2
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|len2
expr_stmt|;
comment|/* OSU Service Description Duples */
while|while
condition|(
name|pos2
operator|+
literal|4
operator|<=
name|pos
operator|&&
name|prov
operator|->
name|serv_desc_count
operator|<
name|OSU_MAX_ITEMS
condition|)
block|{
name|struct
name|osu_lang_string
modifier|*
name|f
decl_stmt|;
name|u8
name|descr_len
decl_stmt|;
name|descr_len
operator|=
name|pos2
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|descr_len
operator|>
name|pos
operator|-
name|pos2
operator|-
literal|1
operator|||
name|descr_len
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid OSU Service "
literal|"Description"
argument_list|)
expr_stmt|;
break|break;
block|}
name|f
operator|=
operator|&
name|prov
operator|->
name|serv_desc
index|[
name|prov
operator|->
name|serv_desc_count
operator|++
index|]
expr_stmt|;
name|os_memcpy
argument_list|(
name|f
operator|->
name|lang
argument_list|,
name|pos2
operator|+
literal|1
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|f
operator|->
name|text
argument_list|,
name|pos2
operator|+
literal|1
operator|+
literal|3
argument_list|,
name|descr_len
operator|-
literal|3
argument_list|)
expr_stmt|;
name|pos2
operator|+=
literal|1
operator|+
name|descr_len
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Added OSU Provider through "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|osu_prov_count
operator|++
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hs20_osu_icon_fetch
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|prov_anqp
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u16
name|len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|osu_ssid
decl_stmt|;
name|u8
name|osu_ssid_len
decl_stmt|;
name|u8
name|num_providers
decl_stmt|;
name|hs20_free_osu_prov
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|bss
operator|->
name|anqp
operator|==
name|NULL
condition|)
continue|continue;
name|prov_anqp
operator|=
name|bss
operator|->
name|anqp
operator|->
name|hs20_osu_providers_list
expr_stmt|;
if|if
condition|(
name|prov_anqp
operator|==
name|NULL
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Parsing OSU Providers list from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: OSU Providers list"
argument_list|,
name|prov_anqp
argument_list|)
expr_stmt|;
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|prov_anqp
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|prov_anqp
argument_list|)
expr_stmt|;
comment|/* OSU SSID */
if|if
condition|(
name|pos
operator|+
literal|1
operator|>
name|end
condition|)
continue|continue;
if|if
condition|(
name|pos
operator|+
literal|1
operator|+
name|pos
index|[
literal|0
index|]
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for "
literal|"OSU SSID"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|osu_ssid_len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|osu_ssid_len
operator|>
literal|32
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Invalid OSU SSID "
literal|"Length %u"
argument_list|,
name|osu_ssid_len
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|osu_ssid
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
name|osu_ssid_len
expr_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Not enough room for "
literal|"Number of OSU Providers"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|num_providers
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Number of OSU Providers: %u"
argument_list|,
name|num_providers
argument_list|)
expr_stmt|;
comment|/* OSU Providers */
while|while
condition|(
name|pos
operator|+
literal|2
operator|<
name|end
operator|&&
name|num_providers
operator|>
literal|0
condition|)
block|{
name|num_providers
operator|--
expr_stmt|;
name|len
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
call|(
name|unsigned
name|int
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
condition|)
break|break;
name|hs20_osu_add_prov
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|osu_ssid
argument_list|,
name|osu_ssid_len
argument_list|,
name|pos
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|len
expr_stmt|;
block|}
if|if
condition|(
name|pos
operator|!=
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Ignored %d bytes of "
literal|"extra data after OSU Providers"
argument_list|,
call|(
name|int
call|)
argument_list|(
name|end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
operator|=
literal|1
expr_stmt|;
name|hs20_next_osu_icon
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|hs20_osu_scan_res_handler
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OSU provisioning fetch scan completed"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|fetch_osu_waiting_scan
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"OSU fetch have been canceled"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|network_select
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|fetch_all_anqp
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|fetch_osu_info
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
operator|=
literal|0
expr_stmt|;
name|interworking_start_fetch_anqp
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|hs20_fetch_osu
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_INTERFACE_DISABLED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Cannot start fetch_osu - "
literal|"interface disabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|scanning
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Cannot start fetch_osu - "
literal|"scanning"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|osu_dir
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Cannot start fetch_osu - "
literal|"osu_dir not configured"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|fetch_anqp_in_progress
operator|||
name|wpa_s
operator|->
name|network_select
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Cannot start fetch_osu - "
literal|"fetch in progress (%d, %d)"
argument_list|,
name|wpa_s
operator|->
name|fetch_anqp_in_progress
argument_list|,
name|wpa_s
operator|->
name|network_select
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Starting OSU provisioning information fetch"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|num_osu_scans
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|num_prov_found
operator|=
literal|0
expr_stmt|;
name|hs20_start_osu_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|hs20_start_osu_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|fetch_osu_waiting_scan
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|num_osu_scans
operator|++
expr_stmt|;
name|wpa_s
operator|->
name|scan_req
operator|=
name|MANUAL_SCAN_REQ
expr_stmt|;
name|wpa_s
operator|->
name|scan_res_handler
operator|=
name|hs20_osu_scan_res_handler
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hs20_cancel_fetch_osu
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Cancel OSU fetch"
argument_list|)
expr_stmt|;
name|interworking_stop_fetch_anqp
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|fetch_osu_waiting_scan
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|network_select
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|fetch_osu_info
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|fetch_osu_icon_in_progress
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hs20_icon_fetch_failed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|hs20_osu_icon_fetch_result
argument_list|(
name|wpa_s
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|hs20_continue_icon_fetch
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|hs20_continue_icon_fetch
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hs20_rx_subscription_remediation
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|,
name|u8
name|osu_method
parameter_list|)
block|{
if|if
condition|(
name|url
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|HS20_SUBSCRIPTION_REMEDIATION
literal|"%u %s"
argument_list|,
name|osu_method
argument_list|,
name|url
argument_list|)
expr_stmt|;
else|else
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|HS20_SUBSCRIPTION_REMEDIATION
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hs20_rx_deauth_imminent_notice
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|code
parameter_list|,
name|u16
name|reauth_delay
parameter_list|,
specifier|const
name|char
modifier|*
name|url
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_sm_pmf_enabled
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Ignore deauthentication imminent notice since PMF was not enabled"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|HS20_DEAUTH_IMMINENT_NOTICE
literal|"%u %u %s"
argument_list|,
name|code
argument_list|,
name|reauth_delay
argument_list|,
name|url
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
name|HS20_DEAUTH_REASON_CODE_BSS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Add BSS to blacklist"
argument_list|)
expr_stmt|;
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
comment|/* TODO: For now, disable full ESS since some drivers may not 		 * support disabling per BSS. */
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|struct
name|os_reltime
name|now
decl_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|.
name|sec
operator|+
name|reauth_delay
operator|<=
name|wpa_s
operator|->
name|current_ssid
operator|->
name|disabled_until
operator|.
name|sec
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Disable network for %u seconds (BSS)"
argument_list|,
name|reauth_delay
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|->
name|disabled_until
operator|.
name|sec
operator|=
name|now
operator|.
name|sec
operator|+
name|reauth_delay
expr_stmt|;
block|}
block|}
if|if
condition|(
name|code
operator|==
name|HS20_DEAUTH_REASON_CODE_ESS
operator|&&
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|struct
name|os_reltime
name|now
decl_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|.
name|sec
operator|+
name|reauth_delay
operator|<=
name|wpa_s
operator|->
name|current_ssid
operator|->
name|disabled_until
operator|.
name|sec
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Disable network for %u seconds"
argument_list|,
name|reauth_delay
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|->
name|disabled_until
operator|.
name|sec
operator|=
name|now
operator|.
name|sec
operator|+
name|reauth_delay
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|hs20_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|hs20_continue_icon_fetch
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|hs20_free_osu_prov
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


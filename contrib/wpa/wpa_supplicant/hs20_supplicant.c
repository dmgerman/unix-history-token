begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2009, Atheros Communications, Inc.  * Copyright (c) 2011-2012, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/gas.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"gas_query.h"
end_include

begin_include
include|#
directive|include
file|"interworking.h"
end_include

begin_include
include|#
directive|include
file|"hs20_supplicant.h"
end_include

begin_function
name|void
name|wpas_hs20_add_indication
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_EID_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_INDICATION_OUI_TYPE
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
comment|/* Hotspot Configuration */
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|hs20_build_anqp_req
parameter_list|(
name|u32
name|stypes
parameter_list|,
specifier|const
name|u8
modifier|*
name|payload
parameter_list|,
name|size_t
name|payload_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|buf
operator|=
name|gas_anqp_build_initial_req
argument_list|(
literal|0
argument_list|,
literal|100
operator|+
name|payload_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|len_pos
operator|=
name|gas_anqp_add_element
argument_list|(
name|buf
argument_list|,
name|ANQP_VENDOR_SPECIFIC
argument_list|)
expr_stmt|;
name|wpabuf_put_be24
argument_list|(
name|buf
argument_list|,
name|OUI_WFA
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_ANQP_OUI_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|stypes
operator|==
name|BIT
argument_list|(
name|HS20_STYPE_NAI_HOME_REALM_QUERY
argument_list|)
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_NAI_HOME_REALM_QUERY
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
if|if
condition|(
name|payload
condition|)
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|payload
argument_list|,
name|payload_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|u8
name|i
decl_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|HS20_STYPE_QUERY_LIST
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Reserved */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|stypes
operator|&
name|BIT
argument_list|(
name|i
argument_list|)
condition|)
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|gas_anqp_set_element_len
argument_list|(
name|buf
argument_list|,
name|len_pos
argument_list|)
expr_stmt|;
name|gas_anqp_set_len
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|int
name|hs20_anqp_send_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u32
name|stypes
parameter_list|,
specifier|const
name|u8
modifier|*
name|payload
parameter_list|,
name|size_t
name|payload_len
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|res
decl_stmt|;
name|freq
operator|=
name|wpa_s
operator|->
name|assoc_freq
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|wpa_bss_anqp_unshare_alloc
argument_list|(
name|bss
argument_list|)
expr_stmt|;
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
block|}
if|if
condition|(
name|freq
operator|<=
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS20: ANQP Query Request to "
name|MACSTR
literal|" for "
literal|"subtypes 0x%x"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
name|stypes
argument_list|)
expr_stmt|;
name|buf
operator|=
name|hs20_build_anqp_req
argument_list|(
name|stypes
argument_list|,
name|payload
argument_list|,
name|payload_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|gas_query_req
argument_list|(
name|wpa_s
operator|->
name|gas
argument_list|,
name|dst
argument_list|,
name|freq
argument_list|,
name|buf
argument_list|,
name|anqp_resp_cb
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Failed to send Query Request"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ANQP: Query started with dialog token "
literal|"%u"
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|hs20_parse_rx_hs20_anqp_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|slen
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
init|=
name|data
decl_stmt|;
name|u8
name|subtype
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
init|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|)
decl_stmt|;
name|struct
name|wpa_bss_anqp
modifier|*
name|anqp
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|slen
operator|<
literal|2
condition|)
return|return;
if|if
condition|(
name|bss
condition|)
name|anqp
operator|=
name|bss
operator|->
name|anqp
expr_stmt|;
name|subtype
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|slen
operator|--
expr_stmt|;
name|pos
operator|++
expr_stmt|;
comment|/* Reserved */
name|slen
operator|--
expr_stmt|;
switch|switch
condition|(
name|subtype
condition|)
block|{
case|case
name|HS20_STYPE_CAPABILITY_LIST
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" HS Capability List"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS Capability List"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
break|break;
case|case
name|HS20_STYPE_OPERATOR_FRIENDLY_NAME
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" Operator Friendly Name"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"oper friendly name"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_operator_friendly_name
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|hs20_operator_friendly_name
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HS20_STYPE_WAN_METRICS
case|:
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WAN Metrics"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|slen
operator|<
literal|13
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"HS 2.0: Too short WAN "
literal|"Metrics value from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" WAN Metrics %02x:%u:%u:%u:%u:%u"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|,
name|WPA_GET_LE32
argument_list|(
name|pos
operator|+
literal|1
argument_list|)
argument_list|,
name|WPA_GET_LE32
argument_list|(
name|pos
operator|+
literal|5
argument_list|)
argument_list|,
name|pos
index|[
literal|9
index|]
argument_list|,
name|pos
index|[
literal|10
index|]
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|pos
operator|+
literal|11
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_wan_metrics
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|hs20_wan_metrics
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HS20_STYPE_CONNECTION_CAPABILITY
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" Connection Capability"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"conn capability"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_connection_capability
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|hs20_connection_capability
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|HS20_STYPE_OPERATING_CLASS
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"RX-HS20-ANQP "
name|MACSTR
literal|" Operating Class"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Operating Class"
argument_list|,
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
if|if
condition|(
name|anqp
condition|)
block|{
name|wpabuf_free
argument_list|(
name|anqp
operator|->
name|hs20_operating_class
argument_list|)
expr_stmt|;
name|anqp
operator|->
name|hs20_operating_class
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|pos
argument_list|,
name|slen
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"HS20: Unsupported subtype %u"
argument_list|,
name|subtype
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

end_unit


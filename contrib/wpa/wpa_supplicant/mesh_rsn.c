begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - Mesh RSN routines  * Copyright (c) 2013-2014, cozybit, Inc.  All rights reserved.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"crypto/sha256.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"crypto/aes.h"
end_include

begin_include
include|#
directive|include
file|"crypto/aes_siv.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/wpa_auth.h"
end_include

begin_include
include|#
directive|include
file|"ap/sta_info.h"
end_include

begin_include
include|#
directive|include
file|"ap/ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"wpas_glue.h"
end_include

begin_include
include|#
directive|include
file|"mesh_mpm.h"
end_include

begin_include
include|#
directive|include
file|"mesh_rsn.h"
end_include

begin_define
define|#
directive|define
name|MESH_AUTH_TIMEOUT
value|10
end_define

begin_define
define|#
directive|define
name|MESH_AUTH_RETRY
value|3
end_define

begin_define
define|#
directive|define
name|MESH_AUTH_BLOCK_DURATION
value|3600
end_define

begin_function
name|void
name|mesh_auth_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
init|=
name|user_data
decl_stmt|;
if|if
condition|(
name|sta
operator|->
name|sae
operator|->
name|state
operator|!=
name|SAE_ACCEPTED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"AUTH: Re-authenticate with "
name|MACSTR
literal|" (attempt %d) "
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|sta
operator|->
name|sae_auth_retry
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|MESH_SAE_AUTH_FAILURE
literal|"addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|sae_auth_retry
operator|<
name|MESH_AUTH_RETRY
condition|)
block|{
name|mesh_rsn_auth_sae_sta
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|sta
operator|->
name|sae_auth_retry
operator|>
name|MESH_AUTH_RETRY
condition|)
block|{
name|ap_free_sta
argument_list|(
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
argument_list|,
name|sta
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* block the STA if exceeded the number of attempts */
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_BLOCKED
argument_list|)
expr_stmt|;
name|sta
operator|->
name|sae
operator|->
name|state
operator|=
name|SAE_NOTHING
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|mesh_auth_block_duration
operator|<
name|MESH_AUTH_BLOCK_DURATION
condition|)
name|wpa_s
operator|->
name|mesh_auth_block_duration
operator|+=
literal|60
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|wpa_s
operator|->
name|mesh_auth_block_duration
argument_list|,
literal|0
argument_list|,
name|mesh_auth_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|MESH_SAE_AUTH_BLOCKED
literal|"addr="
name|MACSTR
literal|" duration=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|wpa_s
operator|->
name|mesh_auth_block_duration
argument_list|)
expr_stmt|;
block|}
name|sta
operator|->
name|sae_auth_retry
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|auth_logger
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|logger_level
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|txt
parameter_list|)
block|{
if|if
condition|(
name|addr
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"AUTH: "
name|MACSTR
literal|" - %s"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|txt
argument_list|)
expr_stmt|;
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"AUTH: %s"
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|u8
modifier|*
name|auth_get_psk
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|prev_psk
parameter_list|)
block|{
name|struct
name|mesh_rsn
modifier|*
name|mesh_rsn
init|=
name|ctx
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|mesh_rsn
operator|->
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
init|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"AUTH: %s (addr="
name|MACSTR
literal|" prev_psk=%p)"
argument_list|,
name|__func__
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|prev_psk
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|&&
name|sta
operator|->
name|auth_alg
operator|==
name|WLAN_AUTH_SAE
condition|)
block|{
if|if
condition|(
operator|!
name|sta
operator|->
name|sae
operator|||
name|prev_psk
condition|)
return|return
name|NULL
return|;
return|return
name|sta
operator|->
name|sae
operator|->
name|pmk
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|auth_set_key
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|vlan_id
parameter_list|,
name|enum
name|wpa_alg
name|alg
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|idx
parameter_list|,
name|u8
modifier|*
name|key
parameter_list|,
name|size_t
name|key_len
parameter_list|)
block|{
name|struct
name|mesh_rsn
modifier|*
name|mesh_rsn
init|=
name|ctx
decl_stmt|;
name|u8
name|seq
index|[
literal|6
index|]
decl_stmt|;
name|os_memset
argument_list|(
name|seq
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|seq
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"AUTH: %s(alg=%d addr="
name|MACSTR
literal|" key_idx=%d)"
argument_list|,
name|__func__
argument_list|,
name|alg
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|idx
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"AUTH: %s(alg=%d key_idx=%d)"
argument_list|,
name|__func__
argument_list|,
name|alg
argument_list|,
name|idx
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"AUTH: set_key - key"
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
expr_stmt|;
return|return
name|wpa_drv_set_key
argument_list|(
name|mesh_rsn
operator|->
name|wpa_s
argument_list|,
name|alg
argument_list|,
name|addr
argument_list|,
name|idx
argument_list|,
literal|1
argument_list|,
name|seq
argument_list|,
literal|6
argument_list|,
name|key
argument_list|,
name|key_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|auth_start_ampe
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|mesh_rsn
modifier|*
name|mesh_rsn
init|=
name|ctx
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
if|if
condition|(
name|mesh_rsn
operator|->
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_MESH
condition|)
return|return
operator|-
literal|1
return|;
name|hapd
operator|=
name|mesh_rsn
operator|->
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
condition|)
name|eloop_cancel_timeout
argument_list|(
name|mesh_auth_timer
argument_list|,
name|mesh_rsn
operator|->
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|mesh_mpm_auth_peer
argument_list|(
name|mesh_rsn
operator|->
name|wpa_s
argument_list|,
name|addr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|__mesh_rsn_auth_init
parameter_list|(
name|struct
name|mesh_rsn
modifier|*
name|rsn
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_auth_config
name|conf
decl_stmt|;
name|struct
name|wpa_auth_callbacks
name|cb
decl_stmt|;
name|u8
name|seq
index|[
literal|6
index|]
init|=
block|{}
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"AUTH: Initializing group state machine"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|conf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|conf
argument_list|)
argument_list|)
expr_stmt|;
name|conf
operator|.
name|wpa
operator|=
literal|2
expr_stmt|;
name|conf
operator|.
name|wpa_key_mgmt
operator|=
name|WPA_KEY_MGMT_SAE
expr_stmt|;
name|conf
operator|.
name|wpa_pairwise
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|conf
operator|.
name|rsn_pairwise
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|conf
operator|.
name|wpa_group
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|conf
operator|.
name|eapol_version
operator|=
literal|0
expr_stmt|;
name|conf
operator|.
name|wpa_group_rekey
operator|=
operator|-
literal|1
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cb
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cb
argument_list|)
argument_list|)
expr_stmt|;
name|cb
operator|.
name|ctx
operator|=
name|rsn
expr_stmt|;
name|cb
operator|.
name|logger
operator|=
name|auth_logger
expr_stmt|;
name|cb
operator|.
name|get_psk
operator|=
name|auth_get_psk
expr_stmt|;
name|cb
operator|.
name|set_key
operator|=
name|auth_set_key
expr_stmt|;
name|cb
operator|.
name|start_ampe
operator|=
name|auth_start_ampe
expr_stmt|;
name|rsn
operator|->
name|auth
operator|=
name|wpa_init
argument_list|(
name|addr
argument_list|,
operator|&
name|conf
argument_list|,
operator|&
name|cb
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsn
operator|->
name|auth
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"AUTH: wpa_init() failed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO: support rekeying */
if|if
condition|(
name|random_get_bytes
argument_list|(
name|rsn
operator|->
name|mgtk
argument_list|,
literal|16
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_deinit
argument_list|(
name|rsn
operator|->
name|auth
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* group mgmt */
name|wpa_drv_set_key
argument_list|(
name|rsn
operator|->
name|wpa_s
argument_list|,
name|WPA_ALG_IGTK
argument_list|,
name|NULL
argument_list|,
literal|4
argument_list|,
literal|1
argument_list|,
name|seq
argument_list|,
sizeof|sizeof
argument_list|(
name|seq
argument_list|)
argument_list|,
name|rsn
operator|->
name|mgtk
argument_list|,
sizeof|sizeof
argument_list|(
name|rsn
operator|->
name|mgtk
argument_list|)
argument_list|)
expr_stmt|;
comment|/* group privacy / data frames */
name|wpa_drv_set_key
argument_list|(
name|rsn
operator|->
name|wpa_s
argument_list|,
name|WPA_ALG_CCMP
argument_list|,
name|NULL
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|seq
argument_list|,
sizeof|sizeof
argument_list|(
name|seq
argument_list|)
argument_list|,
name|rsn
operator|->
name|mgtk
argument_list|,
sizeof|sizeof
argument_list|(
name|rsn
operator|->
name|mgtk
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mesh_rsn_deinit
parameter_list|(
name|struct
name|mesh_rsn
modifier|*
name|rsn
parameter_list|)
block|{
name|os_memset
argument_list|(
name|rsn
operator|->
name|mgtk
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rsn
operator|->
name|mgtk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsn
operator|->
name|auth
condition|)
name|wpa_deinit
argument_list|(
name|rsn
operator|->
name|auth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|mesh_rsn
modifier|*
name|mesh_rsn_auth_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|mesh_conf
modifier|*
name|conf
parameter_list|)
block|{
name|struct
name|mesh_rsn
modifier|*
name|mesh_rsn
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|bss
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|size_t
name|ie_len
decl_stmt|;
name|mesh_rsn
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mesh_rsn
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|mesh_rsn
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|mesh_rsn
operator|->
name|wpa_s
operator|=
name|wpa_s
expr_stmt|;
if|if
condition|(
name|__mesh_rsn_auth_init
argument_list|(
name|mesh_rsn
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|mesh_rsn_deinit
argument_list|(
name|mesh_rsn
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|mesh_rsn
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|bss
operator|->
name|wpa_auth
operator|=
name|mesh_rsn
operator|->
name|auth
expr_stmt|;
name|ie
operator|=
name|wpa_auth_get_wpa_ie
argument_list|(
name|mesh_rsn
operator|->
name|auth
argument_list|,
operator|&
name|ie_len
argument_list|)
expr_stmt|;
name|conf
operator|->
name|rsn_ie
operator|=
operator|(
name|u8
operator|*
operator|)
name|ie
expr_stmt|;
name|conf
operator|->
name|rsn_ie_len
operator|=
name|ie_len
expr_stmt|;
name|wpa_supplicant_rsn_supp_set_config
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
return|return
name|mesh_rsn
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|index_within_array
parameter_list|(
specifier|const
name|int
modifier|*
name|array
parameter_list|,
name|int
name|idx
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|idx
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|array
index|[
name|i
index|]
operator|==
operator|-
literal|1
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mesh_rsn_sae_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sae_data
modifier|*
name|sae
parameter_list|)
block|{
name|int
modifier|*
name|groups
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|conf
operator|->
name|sae_groups
decl_stmt|;
comment|/* Configuration may have changed, so validate current index */
if|if
condition|(
operator|!
name|index_within_array
argument_list|(
name|groups
argument_list|,
name|wpa_s
operator|->
name|mesh_rsn
operator|->
name|sae_group_index
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|int
name|group
init|=
name|groups
index|[
name|wpa_s
operator|->
name|mesh_rsn
operator|->
name|sae_group_index
index|]
decl_stmt|;
if|if
condition|(
name|group
operator|<=
literal|0
condition|)
break|break;
if|if
condition|(
name|sae_set_group
argument_list|(
name|sae
argument_list|,
name|group
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Selected SAE group %d"
argument_list|,
name|sae
operator|->
name|group
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_s
operator|->
name|mesh_rsn
operator|->
name|sae_group_index
operator|++
expr_stmt|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mesh_rsn_build_sae_commit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SAE: No password available"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|mesh_rsn_sae_group
argument_list|(
name|wpa_s
argument_list|,
name|sta
operator|->
name|sae
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SAE: Failed to select group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|sae_prepare_commit
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|ssid
operator|->
name|passphrase
argument_list|,
name|os_strlen
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
argument_list|,
name|sta
operator|->
name|sae
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* initiate new SAE authentication with sta */
end_comment

begin_function
name|int
name|mesh_rsn_auth_sae_sta
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|unsigned
name|int
name|rnd
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|ssid
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"AUTH: No current_ssid known to initiate new SAE"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|sta
operator|->
name|sae
condition|)
block|{
name|sta
operator|->
name|sae
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|sta
operator|->
name|sae
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|sae
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|mesh_rsn_build_sae_commit
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|sta
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"AUTH: started authentication with SAE peer: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_AUTHENTICATING
argument_list|)
expr_stmt|;
name|ret
operator|=
name|auth_sae_init_committed
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
name|eloop_cancel_timeout
argument_list|(
name|mesh_auth_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|rnd
operator|=
name|rand
argument_list|()
operator|%
name|MESH_AUTH_TIMEOUT
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|MESH_AUTH_TIMEOUT
operator|+
name|rnd
argument_list|,
literal|0
argument_list|,
name|mesh_auth_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|mesh_rsn_get_pmkid
parameter_list|(
name|struct
name|mesh_rsn
modifier|*
name|rsn
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|u8
modifier|*
name|pmkid
parameter_list|)
block|{
comment|/* don't expect wpa auth to cache the pmkid for now */
name|rsn_pmkid
argument_list|(
name|sta
operator|->
name|sae
operator|->
name|pmk
argument_list|,
name|PMK_LEN
argument_list|,
name|rsn
operator|->
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|pmkid
argument_list|,
name|wpa_key_mgmt_sha256
argument_list|(
name|wpa_auth_sta_key_mgmt
argument_list|(
name|sta
operator|->
name|wpa_sm
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mesh_rsn_derive_aek
parameter_list|(
name|struct
name|mesh_rsn
modifier|*
name|rsn
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|u8
modifier|*
name|myaddr
init|=
name|rsn
operator|->
name|wpa_s
operator|->
name|own_addr
decl_stmt|;
name|u8
modifier|*
name|peer
init|=
name|sta
operator|->
name|addr
decl_stmt|;
name|u8
modifier|*
name|addr1
init|=
name|peer
decl_stmt|,
modifier|*
name|addr2
init|=
name|myaddr
decl_stmt|;
name|u8
name|context
index|[
name|AES_BLOCK_SIZE
index|]
decl_stmt|;
comment|/* SAE */
name|RSN_SELECTOR_PUT
argument_list|(
name|context
argument_list|,
name|wpa_cipher_to_suite
argument_list|(
literal|0
argument_list|,
name|WPA_CIPHER_GCMP
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|myaddr
argument_list|,
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|addr1
operator|=
name|myaddr
expr_stmt|;
name|addr2
operator|=
name|peer
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|context
operator|+
literal|4
argument_list|,
name|addr1
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|context
operator|+
literal|10
argument_list|,
name|addr2
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|sha256_prf
argument_list|(
name|sta
operator|->
name|sae
operator|->
name|pmk
argument_list|,
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|sae
operator|->
name|pmk
argument_list|)
argument_list|,
literal|"AEK Derivation"
argument_list|,
name|context
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|,
name|sta
operator|->
name|aek
argument_list|,
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|aek
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* derive mesh temporal key from pmk */
end_comment

begin_function
name|int
name|mesh_rsn_derive_mtk
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|u8
modifier|*
name|ptr
decl_stmt|;
name|u8
modifier|*
name|min
decl_stmt|,
modifier|*
name|max
decl_stmt|;
name|u16
name|min_lid
decl_stmt|,
name|max_lid
decl_stmt|;
name|size_t
name|nonce_len
init|=
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|my_nonce
argument_list|)
decl_stmt|;
name|size_t
name|lid_len
init|=
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|my_lid
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|myaddr
init|=
name|wpa_s
operator|->
name|own_addr
decl_stmt|;
name|u8
modifier|*
name|peer
init|=
name|sta
operator|->
name|addr
decl_stmt|;
comment|/* 2 nonces, 2 linkids, akm suite, 2 mac addrs */
name|u8
name|context
index|[
literal|64
operator|+
literal|4
operator|+
literal|4
operator|+
literal|12
index|]
decl_stmt|;
name|ptr
operator|=
name|context
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sta
operator|->
name|my_nonce
argument_list|,
name|sta
operator|->
name|peer_nonce
argument_list|,
name|nonce_len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|min
operator|=
name|sta
operator|->
name|my_nonce
expr_stmt|;
name|max
operator|=
name|sta
operator|->
name|peer_nonce
expr_stmt|;
block|}
else|else
block|{
name|min
operator|=
name|sta
operator|->
name|peer_nonce
expr_stmt|;
name|max
operator|=
name|sta
operator|->
name|my_nonce
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|ptr
argument_list|,
name|min
argument_list|,
name|nonce_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ptr
operator|+
name|nonce_len
argument_list|,
name|max
argument_list|,
name|nonce_len
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|2
operator|*
name|nonce_len
expr_stmt|;
if|if
condition|(
name|sta
operator|->
name|my_lid
operator|<
name|sta
operator|->
name|peer_lid
condition|)
block|{
name|min_lid
operator|=
name|host_to_le16
argument_list|(
name|sta
operator|->
name|my_lid
argument_list|)
expr_stmt|;
name|max_lid
operator|=
name|host_to_le16
argument_list|(
name|sta
operator|->
name|peer_lid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|min_lid
operator|=
name|host_to_le16
argument_list|(
name|sta
operator|->
name|peer_lid
argument_list|)
expr_stmt|;
name|max_lid
operator|=
name|host_to_le16
argument_list|(
name|sta
operator|->
name|my_lid
argument_list|)
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|ptr
argument_list|,
operator|&
name|min_lid
argument_list|,
name|lid_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ptr
operator|+
name|lid_len
argument_list|,
operator|&
name|max_lid
argument_list|,
name|lid_len
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|2
operator|*
name|lid_len
expr_stmt|;
comment|/* SAE */
name|RSN_SELECTOR_PUT
argument_list|(
name|ptr
argument_list|,
name|wpa_cipher_to_suite
argument_list|(
literal|0
argument_list|,
name|WPA_CIPHER_GCMP
argument_list|)
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|4
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|myaddr
argument_list|,
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
operator|<
literal|0
condition|)
block|{
name|min
operator|=
name|myaddr
expr_stmt|;
name|max
operator|=
name|peer
expr_stmt|;
block|}
else|else
block|{
name|min
operator|=
name|peer
expr_stmt|;
name|max
operator|=
name|myaddr
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|ptr
argument_list|,
name|min
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ptr
operator|+
name|ETH_ALEN
argument_list|,
name|max
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|sha256_prf
argument_list|(
name|sta
operator|->
name|sae
operator|->
name|pmk
argument_list|,
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|sae
operator|->
name|pmk
argument_list|)
argument_list|,
literal|"Temporal Key Derivation"
argument_list|,
name|context
argument_list|,
sizeof|sizeof
argument_list|(
name|context
argument_list|)
argument_list|,
name|sta
operator|->
name|mtk
argument_list|,
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|mtk
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|mesh_rsn_init_ampe_sta
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
if|if
condition|(
name|random_get_bytes
argument_list|(
name|sta
operator|->
name|my_nonce
argument_list|,
literal|32
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"mesh: Failed to derive random nonce"
argument_list|)
expr_stmt|;
comment|/* TODO: How to handle this more cleanly? */
block|}
name|os_memset
argument_list|(
name|sta
operator|->
name|peer_nonce
argument_list|,
literal|0
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|mesh_rsn_derive_aek
argument_list|(
name|wpa_s
operator|->
name|mesh_rsn
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* insert AMPE and encrypted MIC at @ie.  * @mesh_rsn: mesh RSN context  * @sta: STA we're sending to  * @cat: pointer to category code in frame header.  * @buf: wpabuf to add encrypted AMPE and MIC to.  * */
end_comment

begin_function
name|int
name|mesh_rsn_protect_frame
parameter_list|(
name|struct
name|mesh_rsn
modifier|*
name|rsn
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
specifier|const
name|u8
modifier|*
name|cat
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|ieee80211_ampe_ie
modifier|*
name|ampe
decl_stmt|;
name|u8
specifier|const
modifier|*
name|ie
init|=
name|wpabuf_head_u8
argument_list|(
name|buf
argument_list|)
operator|+
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|ampe_ie
init|=
name|NULL
decl_stmt|,
modifier|*
name|mic_ie
init|=
name|NULL
decl_stmt|,
modifier|*
name|mic_payload
decl_stmt|;
specifier|const
name|u8
modifier|*
name|aad
index|[]
init|=
block|{
name|rsn
operator|->
name|wpa_s
operator|->
name|own_addr
block|,
name|sta
operator|->
name|addr
block|,
name|cat
block|}
decl_stmt|;
specifier|const
name|size_t
name|aad_len
index|[]
init|=
block|{
name|ETH_ALEN
block|,
name|ETH_ALEN
block|,
name|ie
operator|-
name|cat
block|}
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|AES_BLOCK_SIZE
operator|+
literal|2
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ampe
argument_list|)
operator|+
literal|2
operator|>
name|wpabuf_tailroom
argument_list|(
name|buf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"protect frame: buffer too small"
argument_list|)
expr_stmt|;
return|return
operator|-
name|EINVAL
return|;
block|}
name|ampe_ie
operator|=
name|os_zalloc
argument_list|(
literal|2
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ampe
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ampe_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"protect frame: out of memory"
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
name|mic_ie
operator|=
name|os_zalloc
argument_list|(
literal|2
operator|+
name|AES_BLOCK_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mic_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"protect frame: out of memory"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|free
goto|;
block|}
comment|/*  IE: AMPE */
name|ampe_ie
index|[
literal|0
index|]
operator|=
name|WLAN_EID_AMPE
expr_stmt|;
name|ampe_ie
index|[
literal|1
index|]
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|ampe
argument_list|)
expr_stmt|;
name|ampe
operator|=
operator|(
expr|struct
name|ieee80211_ampe_ie
operator|*
operator|)
operator|(
name|ampe_ie
operator|+
literal|2
operator|)
expr_stmt|;
name|RSN_SELECTOR_PUT
argument_list|(
name|ampe
operator|->
name|selected_pairwise_suite
argument_list|,
name|wpa_cipher_to_suite
argument_list|(
name|WPA_PROTO_RSN
argument_list|,
name|WPA_CIPHER_CCMP
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ampe
operator|->
name|local_nonce
argument_list|,
name|sta
operator|->
name|my_nonce
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ampe
operator|->
name|peer_nonce
argument_list|,
name|sta
operator|->
name|peer_nonce
argument_list|,
literal|32
argument_list|)
expr_stmt|;
comment|/* incomplete: see 13.5.4 */
comment|/* TODO: static mgtk for now since we don't support rekeying! */
name|os_memcpy
argument_list|(
name|ampe
operator|->
name|mgtk
argument_list|,
name|rsn
operator|->
name|mgtk
argument_list|,
literal|16
argument_list|)
expr_stmt|;
comment|/*  TODO: Populate Key RSC */
comment|/*  expire in 13 decades or so */
name|os_memset
argument_list|(
name|ampe
operator|->
name|key_expiration
argument_list|,
literal|0xff
argument_list|,
literal|4
argument_list|)
expr_stmt|;
comment|/* IE: MIC */
name|mic_ie
index|[
literal|0
index|]
operator|=
name|WLAN_EID_MIC
expr_stmt|;
name|mic_ie
index|[
literal|1
index|]
operator|=
name|AES_BLOCK_SIZE
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|mic_ie
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* MIC field is output ciphertext */
comment|/* encrypt after MIC */
name|mic_payload
operator|=
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
literal|2
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ampe
argument_list|)
operator|+
name|AES_BLOCK_SIZE
argument_list|)
expr_stmt|;
if|if
condition|(
name|aes_siv_encrypt
argument_list|(
name|sta
operator|->
name|aek
argument_list|,
name|ampe_ie
argument_list|,
literal|2
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|ampe
argument_list|)
argument_list|,
literal|3
argument_list|,
name|aad
argument_list|,
name|aad_len
argument_list|,
name|mic_payload
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"protect frame: failed to encrypt"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|free
goto|;
block|}
name|free
label|:
name|os_free
argument_list|(
name|ampe_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|mic_ie
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|mesh_rsn_process_ampe
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|struct
name|ieee802_11_elems
modifier|*
name|elems
parameter_list|,
specifier|const
name|u8
modifier|*
name|cat
parameter_list|,
specifier|const
name|u8
modifier|*
name|start
parameter_list|,
name|size_t
name|elems_len
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|struct
name|ieee80211_ampe_ie
modifier|*
name|ampe
decl_stmt|;
name|u8
name|null_nonce
index|[
literal|32
index|]
init|=
block|{}
decl_stmt|;
name|u8
name|ampe_eid
decl_stmt|;
name|u8
name|ampe_ie_len
decl_stmt|;
name|u8
modifier|*
name|ampe_buf
decl_stmt|,
modifier|*
name|crypt
init|=
name|NULL
decl_stmt|;
name|size_t
name|crypt_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|aad
index|[]
init|=
block|{
name|sta
operator|->
name|addr
block|,
name|wpa_s
operator|->
name|own_addr
block|,
name|cat
block|}
decl_stmt|;
specifier|const
name|size_t
name|aad_len
index|[]
init|=
block|{
name|ETH_ALEN
block|,
name|ETH_ALEN
block|,
operator|(
name|elems
operator|->
name|mic
operator|-
literal|2
operator|)
operator|-
name|cat
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|elems
operator|->
name|mic
operator|||
name|elems
operator|->
name|mic_len
operator|<
name|AES_BLOCK_SIZE
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Mesh RSN: missing mic ie"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ampe_buf
operator|=
operator|(
name|u8
operator|*
operator|)
name|elems
operator|->
name|mic
operator|+
name|elems
operator|->
name|mic_len
expr_stmt|;
if|if
condition|(
operator|(
name|int
operator|)
name|elems_len
operator|<
name|ampe_buf
operator|-
name|start
condition|)
return|return
operator|-
literal|1
return|;
name|crypt_len
operator|=
name|elems_len
operator|-
operator|(
name|elems
operator|->
name|mic
operator|-
name|start
operator|)
expr_stmt|;
if|if
condition|(
name|crypt_len
operator|<
literal|2
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Mesh RSN: missing ampe ie"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* crypt is modified by siv_decrypt */
name|crypt
operator|=
name|os_zalloc
argument_list|(
name|crypt_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|crypt
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Mesh RSN: out of memory"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
name|ENOMEM
expr_stmt|;
goto|goto
name|free
goto|;
block|}
name|os_memcpy
argument_list|(
name|crypt
argument_list|,
name|elems
operator|->
name|mic
argument_list|,
name|crypt_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|aes_siv_decrypt
argument_list|(
name|sta
operator|->
name|aek
argument_list|,
name|crypt
argument_list|,
name|crypt_len
argument_list|,
literal|3
argument_list|,
name|aad
argument_list|,
name|aad_len
argument_list|,
name|ampe_buf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Mesh RSN: frame verification failed!"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|free
goto|;
block|}
name|ampe_eid
operator|=
operator|*
name|ampe_buf
operator|++
expr_stmt|;
name|ampe_ie_len
operator|=
operator|*
name|ampe_buf
operator|++
expr_stmt|;
if|if
condition|(
name|ampe_eid
operator|!=
name|WLAN_EID_AMPE
operator|||
name|ampe_ie_len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_ampe_ie
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Mesh RSN: invalid ampe ie"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|free
goto|;
block|}
name|ampe
operator|=
operator|(
expr|struct
name|ieee80211_ampe_ie
operator|*
operator|)
name|ampe_buf
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|ampe
operator|->
name|peer_nonce
argument_list|,
name|null_nonce
argument_list|,
literal|32
argument_list|)
operator|!=
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|ampe
operator|->
name|peer_nonce
argument_list|,
name|sta
operator|->
name|my_nonce
argument_list|,
literal|32
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Mesh RSN: invalid peer nonce"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|free
goto|;
block|}
name|os_memcpy
argument_list|(
name|sta
operator|->
name|peer_nonce
argument_list|,
name|ampe
operator|->
name|local_nonce
argument_list|,
sizeof|sizeof
argument_list|(
name|ampe
operator|->
name|local_nonce
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|sta
operator|->
name|mgtk
argument_list|,
name|ampe
operator|->
name|mgtk
argument_list|,
sizeof|sizeof
argument_list|(
name|ampe
operator|->
name|mgtk
argument_list|)
argument_list|)
expr_stmt|;
comment|/* todo parse mgtk expiration */
name|free
label|:
name|os_free
argument_list|(
name|crypt
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


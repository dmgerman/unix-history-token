begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Wi-Fi Multimedia Admission Control (WMM-AC)  * Copyright(c) 2014, Intel Mobile Communication GmbH.  * Copyright(c) 2014, Intel Corporation. All rights reserved.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/list.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"wmm_ac.h"
end_include

begin_function_decl
specifier|static
name|void
name|wmm_ac_addts_req_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
specifier|const
name|enum
name|wmm_ac
name|up_to_ac
index|[
literal|8
index|]
init|=
block|{
name|WMM_AC_BK
block|,
name|WMM_AC_BE
block|,
name|WMM_AC_BE
block|,
name|WMM_AC_BK
block|,
name|WMM_AC_VI
block|,
name|WMM_AC_VI
block|,
name|WMM_AC_VO
block|,
name|WMM_AC_VO
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|inline
name|u8
name|wmm_ac_get_tsid
parameter_list|(
specifier|const
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
parameter_list|)
block|{
return|return
operator|(
name|tspec
operator|->
name|ts_info
index|[
literal|0
index|]
operator|>>
literal|1
operator|)
operator|&
literal|0x0f
return|;
block|}
end_function

begin_function
specifier|static
name|u8
name|wmm_ac_get_direction
parameter_list|(
specifier|const
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
parameter_list|)
block|{
return|return
operator|(
name|tspec
operator|->
name|ts_info
index|[
literal|0
index|]
operator|>>
literal|5
operator|)
operator|&
literal|0x03
return|;
block|}
end_function

begin_function
specifier|static
name|u8
name|wmm_ac_get_user_priority
parameter_list|(
specifier|const
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
parameter_list|)
block|{
return|return
operator|(
name|tspec
operator|->
name|ts_info
index|[
literal|1
index|]
operator|>>
literal|3
operator|)
operator|&
literal|0x07
return|;
block|}
end_function

begin_function
specifier|static
name|u8
name|wmm_ac_direction_to_idx
parameter_list|(
name|u8
name|direction
parameter_list|)
block|{
switch|switch
condition|(
name|direction
condition|)
block|{
case|case
name|WMM_AC_DIR_UPLINK
case|:
return|return
name|TS_DIR_IDX_UPLINK
return|;
case|case
name|WMM_AC_DIR_DOWNLINK
case|:
return|return
name|TS_DIR_IDX_DOWNLINK
return|;
case|case
name|WMM_AC_DIR_BIDIRECTIONAL
case|:
return|return
name|TS_DIR_IDX_BIDI
return|;
default|default:
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Invalid direction: %d"
argument_list|,
name|direction
argument_list|)
expr_stmt|;
return|return
name|WMM_AC_DIR_UPLINK
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wmm_ac_add_ts
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
parameter_list|)
block|{
name|struct
name|wmm_tspec_element
modifier|*
name|_tspec
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|u16
name|admitted_time
init|=
name|le_to_host16
argument_list|(
name|tspec
operator|->
name|medium_time
argument_list|)
decl_stmt|;
name|u8
name|up
init|=
name|wmm_ac_get_user_priority
argument_list|(
name|tspec
argument_list|)
decl_stmt|;
name|u8
name|ac
init|=
name|up_to_ac
index|[
name|up
index|]
decl_stmt|;
name|u8
name|dir
init|=
name|wmm_ac_get_direction
argument_list|(
name|tspec
argument_list|)
decl_stmt|;
name|u8
name|tsid
init|=
name|wmm_ac_get_tsid
argument_list|(
name|tspec
argument_list|)
decl_stmt|;
name|enum
name|ts_dir_idx
name|idx
init|=
name|wmm_ac_direction_to_idx
argument_list|(
name|dir
argument_list|)
decl_stmt|;
comment|/* should have been verified before, but double-check here */
if|if
condition|(
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|idx
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WMM AC: tspec (ac=%d, dir=%d) already exists!"
argument_list|,
name|ac
argument_list|,
name|dir
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* copy tspec */
name|_tspec
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|_tspec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|_tspec
condition|)
return|return
operator|-
literal|1
return|;
comment|/* store the admitted TSPEC */
name|os_memcpy
argument_list|(
name|_tspec
argument_list|,
name|tspec
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|_tspec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|!=
name|WMM_AC_DIR_DOWNLINK
condition|)
block|{
name|ret
operator|=
name|wpa_drv_add_ts
argument_list|(
name|wpa_s
argument_list|,
name|tsid
argument_list|,
name|addr
argument_list|,
name|up
argument_list|,
name|admitted_time
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Add TS: addr="
name|MACSTR
literal|" TSID=%u admitted time=%u, ret=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|tsid
argument_list|,
name|admitted_time
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|_tspec
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|idx
index|]
operator|=
name|_tspec
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Traffic stream was created successfully"
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WMM_AC_EVENT_TSPEC_ADDED
literal|"tsid=%d addr="
name|MACSTR
literal|" admitted_time=%d"
argument_list|,
name|tsid
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|admitted_time
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wmm_ac_del_ts_idx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|ac
parameter_list|,
name|enum
name|ts_dir_idx
name|dir
parameter_list|)
block|{
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
init|=
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|dir
index|]
decl_stmt|;
name|u8
name|tsid
decl_stmt|;
if|if
condition|(
operator|!
name|tspec
condition|)
return|return;
name|tsid
operator|=
name|wmm_ac_get_tsid
argument_list|(
name|tspec
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Del TS ac=%d tsid=%d"
argument_list|,
name|ac
argument_list|,
name|tsid
argument_list|)
expr_stmt|;
comment|/* update the driver in case of uplink/bidi */
if|if
condition|(
name|wmm_ac_get_direction
argument_list|(
name|tspec
argument_list|)
operator|!=
name|WMM_AC_DIR_DOWNLINK
condition|)
name|wpa_drv_del_ts
argument_list|(
name|wpa_s
argument_list|,
name|tsid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WMM_AC_EVENT_TSPEC_REMOVED
literal|"tsid=%d addr="
name|MACSTR
argument_list|,
name|tsid
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|dir
index|]
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|dir
index|]
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wmm_ac_del_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|failed
parameter_list|)
block|{
name|struct
name|wmm_ac_addts_request
modifier|*
name|req
init|=
name|wpa_s
operator|->
name|addts_request
decl_stmt|;
if|if
condition|(
operator|!
name|req
condition|)
return|return;
if|if
condition|(
name|failed
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WMM_AC_EVENT_TSPEC_REQ_FAILED
literal|"tsid=%u"
argument_list|,
name|wmm_ac_get_tsid
argument_list|(
operator|&
name|req
operator|->
name|tspec
argument_list|)
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wmm_ac_addts_req_timeout
argument_list|,
name|wpa_s
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|addts_request
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wmm_ac_addts_req_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wmm_ac_addts_request
modifier|*
name|addts_req
init|=
name|timeout_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Timeout getting ADDTS response (tsid=%d up=%d)"
argument_list|,
name|wmm_ac_get_tsid
argument_list|(
operator|&
name|addts_req
operator|->
name|tspec
argument_list|)
argument_list|,
name|wmm_ac_get_user_priority
argument_list|(
operator|&
name|addts_req
operator|->
name|tspec
argument_list|)
argument_list|)
expr_stmt|;
name|wmm_ac_del_req
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wmm_ac_send_addts_request
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wmm_ac_addts_request
modifier|*
name|req
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Sending ADDTS Request to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|req
operator|->
name|address
argument_list|)
argument_list|)
expr_stmt|;
comment|/* category + action code + dialog token + status + sizeof(tspec) */
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|4
operator|+
sizeof|sizeof
argument_list|(
name|req
operator|->
name|tspec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WMM AC: Allocation error"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_ACTION_WMM
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WMM_ACTION_CODE_ADDTS_REQ
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|req
operator|->
name|dialog_token
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* status code */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
operator|&
name|req
operator|->
name|tspec
argument_list|,
sizeof|sizeof
argument_list|(
name|req
operator|->
name|tspec
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_drv_send_action
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
literal|0
argument_list|,
name|req
operator|->
name|address
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"WMM AC: Failed to send ADDTS Request"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wmm_ac_send_delts
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
parameter_list|,
specifier|const
name|u8
modifier|*
name|address
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|int
name|ret
decl_stmt|;
comment|/* category + action code + dialog token + status + sizeof(tspec) */
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|4
operator|+
sizeof|sizeof
argument_list|(
operator|*
name|tspec
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Sending DELTS to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|address
argument_list|)
argument_list|)
expr_stmt|;
comment|/* category + action code + dialog token + status + sizeof(tspec) */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_ACTION_WMM
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WMM_ACTION_CODE_DELTS
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Dialog Token (not used) */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* Status Code (not used) */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|tspec
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|tspec
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_drv_send_action
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
literal|0
argument_list|,
name|address
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"Failed to send DELTS frame"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* return the AC using the given TSPEC tid */
end_comment

begin_function
specifier|static
name|int
name|wmm_ac_find_tsid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|tsid
parameter_list|,
name|enum
name|ts_dir_idx
modifier|*
name|dir
parameter_list|)
block|{
name|int
name|ac
decl_stmt|;
name|enum
name|ts_dir_idx
name|idx
decl_stmt|;
for|for
control|(
name|ac
operator|=
literal|0
init|;
name|ac
operator|<
name|WMM_AC_NUM
condition|;
name|ac
operator|++
control|)
block|{
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|TS_DIR_IDX_COUNT
condition|;
name|idx
operator|++
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|idx
index|]
operator|&&
name|wmm_ac_get_tsid
argument_list|(
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|idx
index|]
argument_list|)
operator|==
name|tsid
condition|)
block|{
if|if
condition|(
name|dir
condition|)
operator|*
name|dir
operator|=
name|idx
expr_stmt|;
return|return
name|ac
return|;
block|}
block|}
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wmm_ac_addts_request
modifier|*
name|wmm_ac_build_addts_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wmm_ac_ts_setup_params
modifier|*
name|params
parameter_list|,
specifier|const
name|u8
modifier|*
name|address
parameter_list|)
block|{
name|struct
name|wmm_ac_addts_request
modifier|*
name|addts_req
decl_stmt|;
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
decl_stmt|;
name|u8
name|ac
init|=
name|up_to_ac
index|[
name|params
operator|->
name|user_priority
index|]
decl_stmt|;
name|u8
name|uapsd
init|=
name|wpa_s
operator|->
name|wmm_ac_assoc_info
operator|->
name|ac_params
index|[
name|ac
index|]
operator|.
name|uapsd
decl_stmt|;
name|addts_req
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|addts_req
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|addts_req
condition|)
return|return
name|NULL
return|;
name|tspec
operator|=
operator|&
name|addts_req
operator|->
name|tspec
expr_stmt|;
name|os_memcpy
argument_list|(
name|addts_req
operator|->
name|address
argument_list|,
name|address
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* The dialog token cannot be zero */
if|if
condition|(
operator|++
name|wpa_s
operator|->
name|wmm_ac_last_dialog_token
operator|==
literal|0
condition|)
name|wpa_s
operator|->
name|wmm_ac_last_dialog_token
operator|++
expr_stmt|;
name|addts_req
operator|->
name|dialog_token
operator|=
name|wpa_s
operator|->
name|wmm_ac_last_dialog_token
expr_stmt|;
name|tspec
operator|->
name|eid
operator|=
name|WLAN_EID_VENDOR_SPECIFIC
expr_stmt|;
name|tspec
operator|->
name|length
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|tspec
argument_list|)
operator|-
literal|2
expr_stmt|;
comment|/* reduce eid and length */
name|tspec
operator|->
name|oui
index|[
literal|0
index|]
operator|=
literal|0x00
expr_stmt|;
name|tspec
operator|->
name|oui
index|[
literal|1
index|]
operator|=
literal|0x50
expr_stmt|;
name|tspec
operator|->
name|oui
index|[
literal|2
index|]
operator|=
literal|0xf2
expr_stmt|;
name|tspec
operator|->
name|oui_type
operator|=
name|WMM_OUI_TYPE
expr_stmt|;
name|tspec
operator|->
name|oui_subtype
operator|=
name|WMM_OUI_SUBTYPE_TSPEC_ELEMENT
expr_stmt|;
name|tspec
operator|->
name|version
operator|=
name|WMM_VERSION
expr_stmt|;
name|tspec
operator|->
name|ts_info
index|[
literal|0
index|]
operator|=
name|params
operator|->
name|tsid
operator|<<
literal|1
expr_stmt|;
name|tspec
operator|->
name|ts_info
index|[
literal|0
index|]
operator||=
name|params
operator|->
name|direction
operator|<<
literal|5
expr_stmt|;
name|tspec
operator|->
name|ts_info
index|[
literal|0
index|]
operator||=
name|WMM_AC_ACCESS_POLICY_EDCA
operator|<<
literal|7
expr_stmt|;
name|tspec
operator|->
name|ts_info
index|[
literal|1
index|]
operator|=
name|uapsd
operator|<<
literal|2
expr_stmt|;
name|tspec
operator|->
name|ts_info
index|[
literal|1
index|]
operator||=
name|params
operator|->
name|user_priority
operator|<<
literal|3
expr_stmt|;
name|tspec
operator|->
name|ts_info
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
name|tspec
operator|->
name|nominal_msdu_size
operator|=
name|host_to_le16
argument_list|(
name|params
operator|->
name|nominal_msdu_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|fixed_nominal_msdu
condition|)
name|tspec
operator|->
name|nominal_msdu_size
operator||=
name|host_to_le16
argument_list|(
name|WMM_AC_FIXED_MSDU_SIZE
argument_list|)
expr_stmt|;
name|tspec
operator|->
name|mean_data_rate
operator|=
name|host_to_le32
argument_list|(
name|params
operator|->
name|mean_data_rate
argument_list|)
expr_stmt|;
name|tspec
operator|->
name|minimum_phy_rate
operator|=
name|host_to_le32
argument_list|(
name|params
operator|->
name|minimum_phy_rate
argument_list|)
expr_stmt|;
name|tspec
operator|->
name|surplus_bandwidth_allowance
operator|=
name|host_to_le16
argument_list|(
name|params
operator|->
name|surplus_bandwidth_allowance
argument_list|)
expr_stmt|;
return|return
name|addts_req
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|param_in_range
parameter_list|(
specifier|const
name|char
modifier|*
name|name
parameter_list|,
name|long
name|value
parameter_list|,
name|long
name|min_val
parameter_list|,
name|long
name|max_val
parameter_list|)
block|{
if|if
condition|(
name|value
operator|<
name|min_val
operator|||
operator|(
name|max_val
operator|>=
literal|0
operator|&&
name|value
operator|>
name|max_val
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: param %s (%ld) is out of range (%ld-%ld)"
argument_list|,
name|name
argument_list|,
name|value
argument_list|,
name|min_val
argument_list|,
name|max_val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wmm_ac_should_replace_ts
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|tsid
parameter_list|,
name|u8
name|ac
parameter_list|,
name|u8
name|dir
parameter_list|)
block|{
name|enum
name|ts_dir_idx
name|idx
decl_stmt|;
name|int
name|cur_ac
decl_stmt|,
name|existing_ts
init|=
literal|0
decl_stmt|,
name|replace_ts
init|=
literal|0
decl_stmt|;
name|cur_ac
operator|=
name|wmm_ac_find_tsid
argument_list|(
name|wpa_s
argument_list|,
name|tsid
argument_list|,
operator|&
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_ac
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|cur_ac
operator|!=
name|ac
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: TSID %i already exists on different ac (%d)"
argument_list|,
name|tsid
argument_list|,
name|cur_ac
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* same tsid - this tspec will replace the current one */
name|replace_ts
operator||=
name|BIT
argument_list|(
name|idx
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|TS_DIR_IDX_COUNT
condition|;
name|idx
operator|++
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|idx
index|]
condition|)
name|existing_ts
operator||=
name|BIT
argument_list|(
name|idx
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|dir
condition|)
block|{
case|case
name|WMM_AC_DIR_UPLINK
case|:
comment|/* replace existing uplink/bidi tspecs */
name|replace_ts
operator||=
name|existing_ts
operator|&
operator|(
name|BIT
argument_list|(
name|TS_DIR_IDX_UPLINK
argument_list|)
operator||
name|BIT
argument_list|(
name|TS_DIR_IDX_BIDI
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|WMM_AC_DIR_DOWNLINK
case|:
comment|/* replace existing downlink/bidi tspecs */
name|replace_ts
operator||=
name|existing_ts
operator|&
operator|(
name|BIT
argument_list|(
name|TS_DIR_IDX_DOWNLINK
argument_list|)
operator||
name|BIT
argument_list|(
name|TS_DIR_IDX_BIDI
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|WMM_AC_DIR_BIDIRECTIONAL
case|:
comment|/* replace all existing tspecs */
name|replace_ts
operator||=
name|existing_ts
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
name|replace_ts
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wmm_ac_ts_req_is_valid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wmm_ac_ts_setup_params
modifier|*
name|params
parameter_list|)
block|{
name|enum
name|wmm_ac
name|req_ac
decl_stmt|;
define|#
directive|define
name|PARAM_IN_RANGE
parameter_list|(
name|field
parameter_list|,
name|min_value
parameter_list|,
name|max_value
parameter_list|)
define|\
value|param_in_range(#field, params->field, min_value, max_value)
if|if
condition|(
operator|!
name|PARAM_IN_RANGE
argument_list|(
name|tsid
argument_list|,
literal|0
argument_list|,
name|WMM_AC_MAX_TID
argument_list|)
operator|||
operator|!
name|PARAM_IN_RANGE
argument_list|(
name|user_priority
argument_list|,
literal|0
argument_list|,
name|WMM_AC_MAX_USER_PRIORITY
argument_list|)
operator|||
operator|!
name|PARAM_IN_RANGE
argument_list|(
name|nominal_msdu_size
argument_list|,
literal|1
argument_list|,
name|WMM_AC_MAX_NOMINAL_MSDU
argument_list|)
operator|||
operator|!
name|PARAM_IN_RANGE
argument_list|(
name|mean_data_rate
argument_list|,
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
operator|||
operator|!
name|PARAM_IN_RANGE
argument_list|(
name|minimum_phy_rate
argument_list|,
literal|1
argument_list|,
operator|-
literal|1
argument_list|)
operator|||
operator|!
name|PARAM_IN_RANGE
argument_list|(
name|surplus_bandwidth_allowance
argument_list|,
name|WMM_AC_MIN_SBA_UNITY
argument_list|,
operator|-
literal|1
argument_list|)
condition|)
return|return
literal|0
return|;
undef|#
directive|undef
name|PARAM_IN_RANGE
if|if
condition|(
operator|!
operator|(
name|params
operator|->
name|direction
operator|==
name|WMM_TSPEC_DIRECTION_UPLINK
operator|||
name|params
operator|->
name|direction
operator|==
name|WMM_TSPEC_DIRECTION_DOWNLINK
operator|||
name|params
operator|->
name|direction
operator|==
name|WMM_TSPEC_DIRECTION_BI_DIRECTIONAL
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: invalid TS direction: %d"
argument_list|,
name|params
operator|->
name|direction
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|req_ac
operator|=
name|up_to_ac
index|[
name|params
operator|->
name|user_priority
index|]
expr_stmt|;
comment|/* Requested accesss category must have acm */
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wmm_ac_assoc_info
operator|->
name|ac_params
index|[
name|req_ac
index|]
operator|.
name|acm
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: AC %d is not ACM"
argument_list|,
name|req_ac
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|wmm_ac_should_replace_ts
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|tsid
argument_list|,
name|req_ac
argument_list|,
name|params
operator|->
name|direction
argument_list|)
operator|<
literal|0
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wmm_ac_assoc_data
modifier|*
name|wmm_ac_process_param_elem
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
block|{
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|struct
name|wmm_parameter_element
modifier|*
name|wmm_params
decl_stmt|;
name|struct
name|wmm_ac_assoc_data
modifier|*
name|assoc_data
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Parsing WMM Parameter Element */
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|ies
argument_list|,
name|ies_len
argument_list|,
operator|&
name|elems
argument_list|,
literal|1
argument_list|)
operator|==
name|ParseFailed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: could not parse assoc ies"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|elems
operator|.
name|wmm
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: No WMM IE"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|elems
operator|.
name|wmm_len
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|wmm_params
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Invalid WMM ie length"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wmm_params
operator|=
operator|(
expr|struct
name|wmm_parameter_element
operator|*
operator|)
operator|(
name|elems
operator|.
name|wmm
operator|)
expr_stmt|;
name|assoc_data
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|assoc_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|assoc_data
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|WMM_AC_NUM
condition|;
name|i
operator|++
control|)
name|assoc_data
operator|->
name|ac_params
index|[
name|i
index|]
operator|.
name|acm
operator|=
operator|!
operator|!
operator|(
name|wmm_params
operator|->
name|ac
index|[
name|i
index|]
operator|.
name|aci_aifsn
operator|&
name|WMM_AC_ACM
operator|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: AC mandatory: AC_BE=%u AC_BK=%u AC_VI=%u AC_VO=%u"
argument_list|,
name|assoc_data
operator|->
name|ac_params
index|[
name|WMM_AC_BE
index|]
operator|.
name|acm
argument_list|,
name|assoc_data
operator|->
name|ac_params
index|[
name|WMM_AC_BK
index|]
operator|.
name|acm
argument_list|,
name|assoc_data
operator|->
name|ac_params
index|[
name|WMM_AC_VI
index|]
operator|.
name|acm
argument_list|,
name|assoc_data
operator|->
name|ac_params
index|[
name|WMM_AC_VO
index|]
operator|.
name|acm
argument_list|)
expr_stmt|;
return|return
name|assoc_data
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wmm_ac_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
specifier|const
name|struct
name|wmm_params
modifier|*
name|wmm_params
parameter_list|)
block|{
name|struct
name|wmm_ac_assoc_data
modifier|*
name|assoc_data
decl_stmt|;
name|u8
name|ac
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wmm_ac_assoc_info
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WMM AC: Already initialized"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|ies
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WMM AC: Missing IEs"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|wmm_params
operator|->
name|info_bitmap
operator|&
name|WMM_PARAMS_UAPSD_QUEUES_INFO
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Missing U-APSD configuration"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|tspecs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|tspecs
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wmm_ac_last_dialog_token
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|addts_request
operator|=
name|NULL
expr_stmt|;
name|assoc_data
operator|=
name|wmm_ac_process_param_elem
argument_list|(
name|wpa_s
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|assoc_data
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: U-APSD queues=0x%x"
argument_list|,
name|wmm_params
operator|->
name|uapsd_queues
argument_list|)
expr_stmt|;
for|for
control|(
name|ac
operator|=
literal|0
init|;
name|ac
operator|<
name|WMM_AC_NUM
condition|;
name|ac
operator|++
control|)
block|{
name|assoc_data
operator|->
name|ac_params
index|[
name|ac
index|]
operator|.
name|uapsd
operator|=
operator|!
operator|!
operator|(
name|wmm_params
operator|->
name|uapsd_queues
operator|&
name|BIT
argument_list|(
name|ac
argument_list|)
operator|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|wmm_ac_assoc_info
operator|=
name|assoc_data
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wmm_ac_del_ts
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|ac
parameter_list|,
name|int
name|dir_bitmap
parameter_list|)
block|{
name|enum
name|ts_dir_idx
name|idx
decl_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|TS_DIR_IDX_COUNT
condition|;
name|idx
operator|++
control|)
block|{
if|if
condition|(
operator|!
operator|(
name|dir_bitmap
operator|&
name|BIT
argument_list|(
name|idx
argument_list|)
operator|)
condition|)
continue|continue;
name|wmm_ac_del_ts_idx
argument_list|(
name|wpa_s
argument_list|,
name|ac
argument_list|,
name|idx
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wmm_ac_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|WMM_AC_NUM
condition|;
name|i
operator|++
control|)
name|wmm_ac_del_ts
argument_list|(
name|wpa_s
argument_list|,
name|i
argument_list|,
name|TS_DIR_IDX_ALL
argument_list|)
expr_stmt|;
comment|/* delete pending add_ts requset */
name|wmm_ac_del_req
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|wmm_ac_assoc_info
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wmm_ac_assoc_info
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wmm_ac_notify_assoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
specifier|const
name|struct
name|wmm_params
modifier|*
name|wmm_params
parameter_list|)
block|{
if|if
condition|(
name|wmm_ac_init
argument_list|(
name|wpa_s
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|,
name|wmm_params
argument_list|)
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Valid WMM association, WMM AC is enabled"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wmm_ac_notify_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wmm_ac_assoc_info
condition|)
return|return;
name|wmm_ac_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: WMM AC is disabled"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_wmm_ac_delts
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|tsid
parameter_list|)
block|{
name|struct
name|wmm_tspec_element
name|tspec
decl_stmt|;
name|int
name|ac
decl_stmt|;
name|enum
name|ts_dir_idx
name|dir
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wmm_ac_assoc_info
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Failed to delete TS, WMM AC is disabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ac
operator|=
name|wmm_ac_find_tsid
argument_list|(
name|wpa_s
argument_list|,
name|tsid
argument_list|,
operator|&
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|ac
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: TS does not exist"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|tspec
operator|=
operator|*
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|dir
index|]
expr_stmt|;
name|wmm_ac_del_ts_idx
argument_list|(
name|wpa_s
argument_list|,
name|ac
argument_list|,
name|dir
argument_list|)
expr_stmt|;
name|wmm_ac_send_delts
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|tspec
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_wmm_ac_addts
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wmm_ac_ts_setup_params
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wmm_ac_addts_request
modifier|*
name|addts_req
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wmm_ac_assoc_info
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Cannot add TS - missing assoc data"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|addts_request
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: can't add TS - ADDTS request is already pending"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* 	 * we can setup downlink TS even without driver support. 	 * however, we need driver support for the other directions. 	 */
if|if
condition|(
name|params
operator|->
name|direction
operator|!=
name|WMM_AC_DIR_DOWNLINK
operator|&&
operator|!
name|wpa_s
operator|->
name|wmm_ac_supported
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Cannot set uplink/bidi TS without driver support"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|wmm_ac_ts_req_is_valid
argument_list|(
name|wpa_s
argument_list|,
name|params
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: TS setup request (addr="
name|MACSTR
literal|" tsid=%u user priority=%u direction=%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|,
name|params
operator|->
name|tsid
argument_list|,
name|params
operator|->
name|user_priority
argument_list|,
name|params
operator|->
name|direction
argument_list|)
expr_stmt|;
name|addts_req
operator|=
name|wmm_ac_build_addts_req
argument_list|(
name|wpa_s
argument_list|,
name|params
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|addts_req
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wmm_ac_send_addts_request
argument_list|(
name|wpa_s
argument_list|,
name|addts_req
argument_list|)
condition|)
goto|goto
name|err
goto|;
comment|/* save as pending and set ADDTS resp timeout to 1 second */
name|wpa_s
operator|->
name|addts_request
operator|=
name|addts_req
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wmm_ac_addts_req_timeout
argument_list|,
name|wpa_s
argument_list|,
name|addts_req
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|err
label|:
name|os_free
argument_list|(
name|addts_req
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wmm_ac_handle_delts
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
parameter_list|)
block|{
name|int
name|ac
decl_stmt|;
name|u8
name|tsid
decl_stmt|;
name|enum
name|ts_dir_idx
name|idx
decl_stmt|;
name|tsid
operator|=
name|wmm_ac_get_tsid
argument_list|(
name|tspec
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: DELTS frame has been received TSID=%u addr="
name|MACSTR
argument_list|,
name|tsid
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|ac
operator|=
name|wmm_ac_find_tsid
argument_list|(
name|wpa_s
argument_list|,
name|tsid
argument_list|,
operator|&
name|idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|ac
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Ignoring DELTS frame - TSID does not exist"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wmm_ac_del_ts_idx
argument_list|(
name|wpa_s
argument_list|,
name|ac
argument_list|,
name|idx
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TS was deleted successfully (tsid=%u address="
name|MACSTR
literal|")"
argument_list|,
name|tsid
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wmm_ac_handle_addts_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
name|resp_dialog_token
parameter_list|,
specifier|const
name|u8
name|status_code
parameter_list|,
specifier|const
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
parameter_list|)
block|{
name|struct
name|wmm_ac_addts_request
modifier|*
name|req
init|=
name|wpa_s
operator|->
name|addts_request
decl_stmt|;
name|u8
name|ac
decl_stmt|,
name|tsid
decl_stmt|,
name|up
decl_stmt|,
name|dir
decl_stmt|;
name|int
name|replace_tspecs
decl_stmt|;
name|tsid
operator|=
name|wmm_ac_get_tsid
argument_list|(
name|tspec
argument_list|)
expr_stmt|;
name|dir
operator|=
name|wmm_ac_get_direction
argument_list|(
name|tspec
argument_list|)
expr_stmt|;
name|up
operator|=
name|wmm_ac_get_user_priority
argument_list|(
name|tspec
argument_list|)
expr_stmt|;
name|ac
operator|=
name|up_to_ac
index|[
name|up
index|]
expr_stmt|;
comment|/* make sure we have a matching addts request */
if|if
condition|(
operator|!
name|req
operator|||
name|req
operator|->
name|dialog_token
operator|!=
name|resp_dialog_token
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: no req with dialog=%u, ignoring frame"
argument_list|,
name|resp_dialog_token
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* make sure the params are the same */
if|if
condition|(
name|os_memcmp
argument_list|(
name|req
operator|->
name|address
argument_list|,
name|sa
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|||
name|tsid
operator|!=
name|wmm_ac_get_tsid
argument_list|(
operator|&
name|req
operator|->
name|tspec
argument_list|)
operator|||
name|up
operator|!=
name|wmm_ac_get_user_priority
argument_list|(
operator|&
name|req
operator|->
name|tspec
argument_list|)
operator|||
name|dir
operator|!=
name|wmm_ac_get_direction
argument_list|(
operator|&
name|req
operator|->
name|tspec
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: ADDTS params do not match, ignoring frame"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* delete pending request */
name|wmm_ac_del_req
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ADDTS response status=%d tsid=%u up=%u direction=%u"
argument_list|,
name|status_code
argument_list|,
name|tsid
argument_list|,
name|up
argument_list|,
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|status_code
operator|!=
name|WMM_ADDTS_STATUS_ADMISSION_ACCEPTED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WMM AC: ADDTS request was rejected"
argument_list|)
expr_stmt|;
goto|goto
name|err_msg
goto|;
block|}
name|replace_tspecs
operator|=
name|wmm_ac_should_replace_ts
argument_list|(
name|wpa_s
argument_list|,
name|tsid
argument_list|,
name|ac
argument_list|,
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|replace_tspecs
operator|<
literal|0
condition|)
goto|goto
name|err_delts
goto|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"ts idx replace bitmap: 0x%x"
argument_list|,
name|replace_tspecs
argument_list|)
expr_stmt|;
comment|/* when replacing tspecs - delete first */
name|wmm_ac_del_ts
argument_list|(
name|wpa_s
argument_list|,
name|ac
argument_list|,
name|replace_tspecs
argument_list|)
expr_stmt|;
comment|/* Creating a new traffic stream */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: adding a new TS with TSID=%u address="
name|MACSTR
literal|" medium time=%u access category=%d dir=%d "
argument_list|,
name|tsid
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|le_to_host16
argument_list|(
name|tspec
operator|->
name|medium_time
argument_list|)
argument_list|,
name|ac
argument_list|,
name|dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|wmm_ac_add_ts
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|,
name|tspec
argument_list|)
condition|)
goto|goto
name|err_delts
goto|;
return|return;
name|err_delts
label|:
comment|/* ask the ap to delete the tspec */
name|wmm_ac_send_delts
argument_list|(
name|wpa_s
argument_list|,
name|tspec
argument_list|,
name|sa
argument_list|)
expr_stmt|;
name|err_msg
label|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WMM_AC_EVENT_TSPEC_REQ_FAILED
literal|"tsid=%u"
argument_list|,
name|tsid
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wmm_ac_rx_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|da
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u8
name|action
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|u8
name|status_code
decl_stmt|;
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wmm_ac_assoc_info
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: WMM AC is disabled, ignoring action frame"
argument_list|)
expr_stmt|;
return|return;
block|}
name|action
operator|=
name|data
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|action
operator|!=
name|WMM_ACTION_CODE_ADDTS_RESP
operator|&&
name|action
operator|!=
name|WMM_ACTION_CODE_DELTS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Unknown action (%d), ignoring action frame"
argument_list|,
name|action
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* WMM AC action frame */
if|if
condition|(
name|os_memcmp
argument_list|(
name|da
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: frame destination addr="
name|MACSTR
literal|" is other than ours, ignoring frame"
argument_list|,
name|MAC2STR
argument_list|(
name|da
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: ignore frame with sa "
name|MACSTR
literal|" different other than our bssid"
argument_list|,
name|MAC2STR
argument_list|(
name|da
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|<
literal|2
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|wmm_tspec_element
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Short ADDTS response ignored (len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|data
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
name|dialog_token
operator|=
name|data
index|[
literal|0
index|]
expr_stmt|;
name|status_code
operator|=
name|data
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|data
operator|+
literal|2
argument_list|,
name|len
operator|-
literal|2
argument_list|,
operator|&
name|elems
argument_list|,
literal|1
argument_list|)
operator|!=
name|ParseOK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Could not parse WMM AC action from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* the struct also contains the type and value, so decrease it */
if|if
condition|(
name|elems
operator|.
name|wmm_tspec_len
operator|!=
sizeof|sizeof
argument_list|(
expr|struct
name|wmm_tspec_element
argument_list|)
operator|-
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: missing or wrong length TSPEC"
argument_list|)
expr_stmt|;
return|return;
block|}
name|tspec
operator|=
operator|(
expr|struct
name|wmm_tspec_element
operator|*
operator|)
operator|(
name|elems
operator|.
name|wmm_tspec
operator|-
literal|2
operator|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: RX WMM AC Action from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"WMM AC: WMM AC Action content"
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|action
condition|)
block|{
case|case
name|WMM_ACTION_CODE_ADDTS_RESP
case|:
name|wmm_ac_handle_addts_resp
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|status_code
argument_list|,
name|tspec
argument_list|)
expr_stmt|;
break|break;
case|case
name|WMM_ACTION_CODE_DELTS
case|:
name|wmm_ac_handle_delts
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|,
name|tspec
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_ac_str
parameter_list|(
name|u8
name|ac
parameter_list|)
block|{
switch|switch
condition|(
name|ac
condition|)
block|{
case|case
name|WMM_AC_BE
case|:
return|return
literal|"BE"
return|;
case|case
name|WMM_AC_BK
case|:
return|return
literal|"BK"
return|;
case|case
name|WMM_AC_VI
case|:
return|return
literal|"VI"
return|;
case|case
name|WMM_AC_VO
case|:
return|return
literal|"VO"
return|;
default|default:
return|return
literal|"N/A"
return|;
block|}
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_direction_str
parameter_list|(
name|u8
name|direction
parameter_list|)
block|{
switch|switch
condition|(
name|direction
condition|)
block|{
case|case
name|WMM_AC_DIR_DOWNLINK
case|:
return|return
literal|"Downlink"
return|;
case|case
name|WMM_AC_DIR_UPLINK
case|:
return|return
literal|"Uplink"
return|;
case|case
name|WMM_AC_DIR_BIDIRECTIONAL
case|:
return|return
literal|"Bi-directional"
return|;
default|default:
return|return
literal|"N/A"
return|;
block|}
block|}
end_function

begin_function
name|int
name|wpas_wmm_ac_status
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buflen
parameter_list|)
block|{
name|struct
name|wmm_ac_assoc_data
modifier|*
name|assoc_info
init|=
name|wpa_s
operator|->
name|wmm_ac_assoc_info
decl_stmt|;
name|enum
name|ts_dir_idx
name|idx
decl_stmt|;
name|int
name|pos
init|=
literal|0
decl_stmt|;
name|u8
name|ac
decl_stmt|,
name|up
decl_stmt|;
if|if
condition|(
operator|!
name|assoc_info
condition|)
block|{
return|return
name|wpa_scnprintf
argument_list|(
name|buf
argument_list|,
name|buflen
operator|-
name|pos
argument_list|,
literal|"Not associated to a WMM AP, WMM AC is Disabled\n"
argument_list|)
return|;
block|}
name|pos
operator|+=
name|wpa_scnprintf
argument_list|(
name|buf
operator|+
name|pos
argument_list|,
name|buflen
operator|-
name|pos
argument_list|,
literal|"WMM AC is Enabled\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|ac
operator|=
literal|0
init|;
name|ac
operator|<
name|WMM_AC_NUM
condition|;
name|ac
operator|++
control|)
block|{
name|int
name|ts_count
init|=
literal|0
decl_stmt|;
name|pos
operator|+=
name|wpa_scnprintf
argument_list|(
name|buf
operator|+
name|pos
argument_list|,
name|buflen
operator|-
name|pos
argument_list|,
literal|"%s: acm=%d uapsd=%d\n"
argument_list|,
name|get_ac_str
argument_list|(
name|ac
argument_list|)
argument_list|,
name|assoc_info
operator|->
name|ac_params
index|[
name|ac
index|]
operator|.
name|acm
argument_list|,
name|assoc_info
operator|->
name|ac_params
index|[
name|ac
index|]
operator|.
name|uapsd
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|idx
operator|<
name|TS_DIR_IDX_COUNT
condition|;
name|idx
operator|++
control|)
block|{
name|struct
name|wmm_tspec_element
modifier|*
name|tspec
decl_stmt|;
name|u8
name|dir
decl_stmt|,
name|tsid
decl_stmt|;
specifier|const
name|char
modifier|*
name|dir_str
decl_stmt|;
name|tspec
operator|=
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|idx
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|tspec
condition|)
continue|continue;
name|ts_count
operator|++
expr_stmt|;
name|dir
operator|=
name|wmm_ac_get_direction
argument_list|(
name|tspec
argument_list|)
expr_stmt|;
name|dir_str
operator|=
name|get_direction_str
argument_list|(
name|dir
argument_list|)
expr_stmt|;
name|tsid
operator|=
name|wmm_ac_get_tsid
argument_list|(
name|tspec
argument_list|)
expr_stmt|;
name|up
operator|=
name|wmm_ac_get_user_priority
argument_list|(
name|tspec
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|wpa_scnprintf
argument_list|(
name|buf
operator|+
name|pos
argument_list|,
name|buflen
operator|-
name|pos
argument_list|,
literal|"\tTSID=%u UP=%u\n"
literal|"\tAddress = "
name|MACSTR
literal|"\n"
literal|"\tWMM AC dir = %s\n"
literal|"\tTotal admitted time = %u\n\n"
argument_list|,
name|tsid
argument_list|,
name|up
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|,
name|dir_str
argument_list|,
name|le_to_host16
argument_list|(
name|tspec
operator|->
name|medium_time
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|ts_count
condition|)
block|{
name|pos
operator|+=
name|wpa_scnprintf
argument_list|(
name|buf
operator|+
name|pos
argument_list|,
name|buflen
operator|-
name|pos
argument_list|,
literal|"\t(No Traffic Stream)\n\n"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|pos
return|;
block|}
end_function

begin_function
specifier|static
name|u8
name|wmm_ac_get_tspecs_count
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|ac
decl_stmt|,
name|dir
decl_stmt|,
name|tspecs_count
init|=
literal|0
decl_stmt|;
for|for
control|(
name|ac
operator|=
literal|0
init|;
name|ac
operator|<
name|WMM_AC_NUM
condition|;
name|ac
operator|++
control|)
block|{
for|for
control|(
name|dir
operator|=
literal|0
init|;
name|dir
operator|<
name|TS_DIR_IDX_COUNT
condition|;
name|dir
operator|++
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|dir
index|]
condition|)
name|tspecs_count
operator|++
expr_stmt|;
block|}
block|}
return|return
name|tspecs_count
return|;
block|}
end_function

begin_function
name|void
name|wmm_ac_save_tspecs
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|ac
decl_stmt|,
name|dir
decl_stmt|,
name|tspecs_count
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Save last configured tspecs"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wmm_ac_assoc_info
condition|)
return|return;
name|tspecs_count
operator|=
name|wmm_ac_get_tspecs_count
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tspecs_count
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: No configured TSPECs"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Saving tspecs"
argument_list|)
expr_stmt|;
name|wmm_ac_clear_saved_tspecs
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|last_tspecs
operator|=
name|os_calloc
argument_list|(
name|tspecs_count
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|wpa_s
operator|->
name|last_tspecs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|last_tspecs
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WMM AC: Failed to save tspecs!"
argument_list|)
expr_stmt|;
return|return;
block|}
for|for
control|(
name|ac
operator|=
literal|0
init|;
name|ac
operator|<
name|WMM_AC_NUM
condition|;
name|ac
operator|++
control|)
block|{
for|for
control|(
name|dir
operator|=
literal|0
init|;
name|dir
operator|<
name|TS_DIR_IDX_COUNT
condition|;
name|dir
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|dir
index|]
condition|)
continue|continue;
name|wpa_s
operator|->
name|last_tspecs
index|[
name|wpa_s
operator|->
name|last_tspecs_count
operator|++
index|]
operator|=
operator|*
name|wpa_s
operator|->
name|tspecs
index|[
name|ac
index|]
index|[
name|dir
index|]
expr_stmt|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Successfully saved %d TSPECs"
argument_list|,
name|wpa_s
operator|->
name|last_tspecs_count
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wmm_ac_clear_saved_tspecs
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|last_tspecs
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Clear saved tspecs"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|last_tspecs
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|last_tspecs
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|last_tspecs_count
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wmm_ac_restore_tspecs
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wmm_ac_assoc_info
operator|||
operator|!
name|wpa_s
operator|->
name|last_tspecs_count
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WMM AC: Restore %u saved tspecs"
argument_list|,
name|wpa_s
operator|->
name|last_tspecs_count
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|last_tspecs_count
condition|;
name|i
operator|++
control|)
name|wmm_ac_add_ts
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
operator|&
name|wpa_s
operator|->
name|last_tspecs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


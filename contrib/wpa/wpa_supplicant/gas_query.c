begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Generic advertisement service (GAS) query  * Copyright (c) 2009, Atheros Communications  * Copyright (c) 2011, Qualcomm Atheros  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/gas.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"offchannel.h"
end_include

begin_include
include|#
directive|include
file|"gas_query.h"
end_include

begin_comment
comment|/** GAS query timeout in seconds */
end_comment

begin_define
define|#
directive|define
name|GAS_QUERY_TIMEOUT_PERIOD
value|5
end_define

begin_comment
comment|/**  * struct gas_query_pending - Pending GAS query  */
end_comment

begin_struct
struct|struct
name|gas_query_pending
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|;
name|u8
name|next_frag_id
decl_stmt|;
name|unsigned
name|int
name|wait_comeback
range|:
literal|1
decl_stmt|;
name|unsigned
name|int
name|offchannel_tx_started
range|:
literal|1
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|u16
name|status_code
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|adv_proto
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
name|void
function_decl|(
modifier|*
name|cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|enum
name|gas_query_result
name|result
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|adv_proto
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u16
name|status_code
parameter_list|)
function_decl|;
name|void
modifier|*
name|ctx
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/**  * struct gas_query - Internal GAS query data  */
end_comment

begin_struct
struct|struct
name|gas_query
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|struct
name|dl_list
name|pending
decl_stmt|;
comment|/* struct gas_query_pending */
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|gas_query_tx_comeback_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gas_query_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**  * gas_query_init - Initialize GAS query component  * @wpa_s: Pointer to wpa_supplicant data  * Returns: Pointer to GAS query data or %NULL on failure  */
end_comment

begin_function
name|struct
name|gas_query
modifier|*
name|gas_query_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|gas_query
modifier|*
name|gas
decl_stmt|;
name|gas
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|gas
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|gas
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|gas
operator|->
name|wpa_s
operator|=
name|wpa_s
expr_stmt|;
name|dl_list_init
argument_list|(
operator|&
name|gas
operator|->
name|pending
argument_list|)
expr_stmt|;
return|return
name|gas
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_query_done
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
name|struct
name|gas_query_pending
modifier|*
name|query
parameter_list|,
name|enum
name|gas_query_result
name|result
parameter_list|)
block|{
if|if
condition|(
name|query
operator|->
name|offchannel_tx_started
condition|)
name|offchannel_send_action_done
argument_list|(
name|gas
operator|->
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|gas_query_tx_comeback_timeout
argument_list|,
name|gas
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|gas_query_timeout
argument_list|,
name|gas
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|query
operator|->
name|list
argument_list|)
expr_stmt|;
name|query
operator|->
name|cb
argument_list|(
name|query
operator|->
name|ctx
argument_list|,
name|query
operator|->
name|addr
argument_list|,
name|query
operator|->
name|dialog_token
argument_list|,
name|result
argument_list|,
name|query
operator|->
name|adv_proto
argument_list|,
name|query
operator|->
name|resp
argument_list|,
name|query
operator|->
name|status_code
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|query
operator|->
name|adv_proto
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|query
operator|->
name|resp
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|query
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * gas_query_deinit - Deinitialize GAS query component  * @gas: GAS query data from gas_query_init()  */
end_comment

begin_function
name|void
name|gas_query_deinit
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|)
block|{
name|struct
name|gas_query_pending
modifier|*
name|query
decl_stmt|,
modifier|*
name|next
decl_stmt|;
if|if
condition|(
name|gas
operator|==
name|NULL
condition|)
return|return;
name|dl_list_for_each_safe
argument_list|(
argument|query
argument_list|,
argument|next
argument_list|,
argument|&gas->pending
argument_list|,
argument|struct gas_query_pending
argument_list|,
argument|list
argument_list|)
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_DELETED_AT_DEINIT
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|gas
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|gas_query_pending
modifier|*
name|gas_query_get_pending
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
name|dialog_token
parameter_list|)
block|{
name|struct
name|gas_query_pending
modifier|*
name|q
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|q
argument_list|,
argument|&gas->pending
argument_list|,
argument|struct gas_query_pending
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|q
operator|->
name|addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|q
operator|->
name|dialog_token
operator|==
name|dialog_token
condition|)
return|return
name|q
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gas_query_append
parameter_list|(
name|struct
name|gas_query_pending
modifier|*
name|query
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
if|if
condition|(
name|wpabuf_resize
argument_list|(
operator|&
name|query
operator|->
name|resp
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: No memory to store the response"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpabuf_put_data
argument_list|(
name|query
operator|->
name|resp
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|gas_query_tx
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
name|struct
name|gas_query_pending
modifier|*
name|query
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|req
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Send action frame to "
name|MACSTR
literal|" len=%u "
literal|"freq=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|wpabuf_len
argument_list|(
name|req
argument_list|)
argument_list|,
name|query
operator|->
name|freq
argument_list|)
expr_stmt|;
name|res
operator|=
name|offchannel_send_action
argument_list|(
name|gas
operator|->
name|wpa_s
argument_list|,
name|query
operator|->
name|freq
argument_list|,
name|query
operator|->
name|addr
argument_list|,
name|gas
operator|->
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|query
operator|->
name|addr
argument_list|,
name|wpabuf_head
argument_list|(
name|req
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|req
argument_list|)
argument_list|,
literal|1000
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
condition|)
name|query
operator|->
name|offchannel_tx_started
operator|=
literal|1
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_query_tx_comeback_req
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
name|struct
name|gas_query_pending
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|req
decl_stmt|;
name|req
operator|=
name|gas_build_comeback_req
argument_list|(
name|query
operator|->
name|dialog_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
name|NULL
condition|)
block|{
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|gas_query_tx
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|req
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Failed to send Action frame to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_INTERNAL_ERROR
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|req
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_query_tx_comeback_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|gas_query
modifier|*
name|gas
init|=
name|eloop_data
decl_stmt|;
name|struct
name|gas_query_pending
modifier|*
name|query
init|=
name|user_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Comeback timeout for request to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|gas_query_tx_comeback_req
argument_list|(
name|gas
argument_list|,
name|query
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_query_tx_comeback_req_delay
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
name|struct
name|gas_query_pending
modifier|*
name|query
parameter_list|,
name|u16
name|comeback_delay
parameter_list|)
block|{
name|unsigned
name|int
name|secs
decl_stmt|,
name|usecs
decl_stmt|;
name|secs
operator|=
operator|(
name|comeback_delay
operator|*
literal|1024
operator|)
operator|/
literal|1000000
expr_stmt|;
name|usecs
operator|=
name|comeback_delay
operator|*
literal|1024
operator|-
name|secs
operator|*
literal|1000000
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Send comeback request to "
name|MACSTR
literal|" in %u secs %u usecs"
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|,
name|secs
argument_list|,
name|usecs
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|gas_query_tx_comeback_timeout
argument_list|,
name|gas
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|secs
argument_list|,
name|usecs
argument_list|,
name|gas_query_tx_comeback_timeout
argument_list|,
name|gas
argument_list|,
name|query
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_query_rx_initial
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
name|struct
name|gas_query_pending
modifier|*
name|query
parameter_list|,
specifier|const
name|u8
modifier|*
name|adv_proto
parameter_list|,
specifier|const
name|u8
modifier|*
name|resp
parameter_list|,
name|size_t
name|len
parameter_list|,
name|u16
name|comeback_delay
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Received initial response from "
name|MACSTR
literal|" (dialog_token=%u comeback_delay=%u)"
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|,
name|query
operator|->
name|dialog_token
argument_list|,
name|comeback_delay
argument_list|)
expr_stmt|;
name|query
operator|->
name|adv_proto
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|adv_proto
argument_list|,
literal|2
operator|+
name|adv_proto
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|query
operator|->
name|adv_proto
operator|==
name|NULL
condition|)
block|{
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|comeback_delay
condition|)
block|{
name|query
operator|->
name|wait_comeback
operator|=
literal|1
expr_stmt|;
name|gas_query_tx_comeback_req_delay
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|comeback_delay
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Query was completed without comeback mechanism */
if|if
condition|(
name|gas_query_append
argument_list|(
name|query
argument_list|,
name|resp
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_SUCCESS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_query_rx_comeback
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
name|struct
name|gas_query_pending
modifier|*
name|query
parameter_list|,
specifier|const
name|u8
modifier|*
name|adv_proto
parameter_list|,
specifier|const
name|u8
modifier|*
name|resp
parameter_list|,
name|size_t
name|len
parameter_list|,
name|u8
name|frag_id
parameter_list|,
name|u8
name|more_frags
parameter_list|,
name|u16
name|comeback_delay
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Received comeback response from "
name|MACSTR
literal|" (dialog_token=%u frag_id=%u more_frags=%u "
literal|"comeback_delay=%u)"
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|,
name|query
operator|->
name|dialog_token
argument_list|,
name|frag_id
argument_list|,
name|more_frags
argument_list|,
name|comeback_delay
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|size_t
operator|)
literal|2
operator|+
name|adv_proto
index|[
literal|1
index|]
operator|!=
name|wpabuf_len
argument_list|(
name|query
operator|->
name|adv_proto
argument_list|)
operator|||
name|os_memcmp
argument_list|(
name|adv_proto
argument_list|,
name|wpabuf_head
argument_list|(
name|query
operator|->
name|adv_proto
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|query
operator|->
name|adv_proto
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Advertisement Protocol changed "
literal|"between initial and comeback response from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_PEER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|comeback_delay
condition|)
block|{
if|if
condition|(
name|frag_id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Invalid comeback response "
literal|"with non-zero frag_id and comeback_delay "
literal|"from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_PEER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|gas_query_tx_comeback_req_delay
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|comeback_delay
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|frag_id
operator|!=
name|query
operator|->
name|next_frag_id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Unexpected frag_id in response "
literal|"from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_PEER_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
name|query
operator|->
name|next_frag_id
operator|++
expr_stmt|;
if|if
condition|(
name|gas_query_append
argument_list|(
name|query
argument_list|,
name|resp
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
block|{
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_INTERNAL_ERROR
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|more_frags
condition|)
block|{
name|gas_query_tx_comeback_req
argument_list|(
name|gas
argument_list|,
name|query
argument_list|)
expr_stmt|;
return|return;
block|}
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_SUCCESS
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * gas_query_rx - Indicate reception of a Public Action frame  * @gas: GAS query data from gas_query_init()  * @da: Destination MAC address of the Action frame  * @sa: Source MAC address of the Action frame  * @bssid: BSSID of the Action frame  * @data: Payload of the Action frame  * @len: Length of @data  * @freq: Frequency (in MHz) on which the frame was received  * Returns: 0 if the Public Action frame was a GAS frame or -1 if not  */
end_comment

begin_function
name|int
name|gas_query_rx
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
specifier|const
name|u8
modifier|*
name|da
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|struct
name|gas_query_pending
modifier|*
name|query
decl_stmt|;
name|u8
name|action
decl_stmt|,
name|dialog_token
decl_stmt|,
name|frag_id
init|=
literal|0
decl_stmt|,
name|more_frags
init|=
literal|0
decl_stmt|;
name|u16
name|comeback_delay
decl_stmt|,
name|resp_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|adv_proto
decl_stmt|;
if|if
condition|(
name|gas
operator|==
name|NULL
operator|||
name|len
operator|<
literal|4
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|=
name|data
expr_stmt|;
name|action
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|dialog_token
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|action
operator|!=
name|WLAN_PA_GAS_INITIAL_RESP
operator|&&
name|action
operator|!=
name|WLAN_PA_GAS_COMEBACK_RESP
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Not a GAS response */
name|query
operator|=
name|gas_query_get_pending
argument_list|(
name|gas
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|query
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: No pending query found for "
name|MACSTR
literal|" dialog token %u"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|query
operator|->
name|wait_comeback
operator|&&
name|action
operator|==
name|WLAN_PA_GAS_INITIAL_RESP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Unexpected initial response from "
name|MACSTR
literal|" dialog token %u when waiting for comeback "
literal|"response"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|query
operator|->
name|wait_comeback
operator|&&
name|action
operator|==
name|WLAN_PA_GAS_COMEBACK_RESP
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Unexpected comeback response from "
name|MACSTR
literal|" dialog token %u when waiting for initial "
literal|"response"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|query
operator|->
name|status_code
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|query
operator|->
name|status_code
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Query to "
name|MACSTR
literal|" dialog token "
literal|"%u failed - status code %u"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|,
name|query
operator|->
name|status_code
argument_list|)
expr_stmt|;
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_FAILURE
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|action
operator|==
name|WLAN_PA_GAS_COMEBACK_RESP
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|1
operator|>
name|data
operator|+
name|len
condition|)
return|return
literal|0
return|;
name|frag_id
operator|=
operator|*
name|pos
operator|&
literal|0x7f
expr_stmt|;
name|more_frags
operator|=
operator|(
operator|*
name|pos
operator|&
literal|0x80
operator|)
operator|>>
literal|7
expr_stmt|;
name|pos
operator|++
expr_stmt|;
block|}
comment|/* Comeback Delay */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|data
operator|+
name|len
condition|)
return|return
literal|0
return|;
name|comeback_delay
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
comment|/* Advertisement Protocol element */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|data
operator|+
name|len
operator|||
name|pos
operator|+
literal|2
operator|+
name|pos
index|[
literal|1
index|]
operator|>
name|data
operator|+
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: No room for Advertisement "
literal|"Protocol element in the response from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|*
name|pos
operator|!=
name|WLAN_EID_ADV_PROTO
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Unexpected Advertisement "
literal|"Protocol element ID %u in response from "
name|MACSTR
argument_list|,
operator|*
name|pos
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|adv_proto
operator|=
name|pos
expr_stmt|;
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
comment|/* Query Response Length */
if|if
condition|(
name|pos
operator|+
literal|2
operator|>
name|data
operator|+
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: No room for GAS Response Length"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|resp_len
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|resp_len
operator|>
name|data
operator|+
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Truncated Query Response in "
literal|"response from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|pos
operator|+
name|resp_len
operator|<
name|data
operator|+
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Ignore %u octets of extra data "
literal|"after Query Response from "
name|MACSTR
argument_list|,
call|(
name|unsigned
name|int
call|)
argument_list|(
name|data
operator|+
name|len
operator|-
name|pos
operator|-
name|resp_len
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|action
operator|==
name|WLAN_PA_GAS_COMEBACK_RESP
condition|)
name|gas_query_rx_comeback
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|adv_proto
argument_list|,
name|pos
argument_list|,
name|resp_len
argument_list|,
name|frag_id
argument_list|,
name|more_frags
argument_list|,
name|comeback_delay
argument_list|)
expr_stmt|;
else|else
name|gas_query_rx_initial
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|adv_proto
argument_list|,
name|pos
argument_list|,
name|resp_len
argument_list|,
name|comeback_delay
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|gas_query_timeout
parameter_list|(
name|void
modifier|*
name|eloop_data
parameter_list|,
name|void
modifier|*
name|user_ctx
parameter_list|)
block|{
name|struct
name|gas_query
modifier|*
name|gas
init|=
name|eloop_data
decl_stmt|;
name|struct
name|gas_query_pending
modifier|*
name|query
init|=
name|user_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: No response received for query to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|gas_query_dialog_token_available
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|)
block|{
name|struct
name|gas_query_pending
modifier|*
name|q
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|q
argument_list|,
argument|&gas->pending
argument_list|,
argument|struct gas_query_pending
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|dst
argument_list|,
name|q
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|dialog_token
operator|==
name|q
operator|->
name|dialog_token
condition|)
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * gas_query_req - Request a GAS query  * @gas: GAS query data from gas_query_init()  * @dst: Destination MAC address for the query  * @freq: Frequency (in MHz) for the channel on which to send the query  * @req: GAS query payload  * @cb: Callback function for reporting GAS query result and response  * @ctx: Context pointer to use with the @cb call  * Returns: dialog token (>= 0) on success or -1 on failure  */
end_comment

begin_function
name|int
name|gas_query_req
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|int
name|freq
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|req
parameter_list|,
name|void
function_decl|(
modifier|*
name|cb
function_decl|)
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|enum
name|gas_query_result
name|result
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|adv_proto
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u16
name|status_code
parameter_list|)
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|gas_query_pending
modifier|*
name|query
decl_stmt|;
name|int
name|dialog_token
decl_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|req
argument_list|)
operator|<
literal|3
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|dialog_token
operator|=
literal|0
init|;
name|dialog_token
operator|<
literal|256
condition|;
name|dialog_token
operator|++
control|)
block|{
if|if
condition|(
name|gas_query_dialog_token_available
argument_list|(
name|gas
argument_list|,
name|dst
argument_list|,
name|dialog_token
argument_list|)
condition|)
break|break;
block|}
if|if
condition|(
name|dialog_token
operator|==
literal|256
condition|)
return|return
operator|-
literal|1
return|;
comment|/* Too many pending queries */
name|query
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|query
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|query
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|query
operator|->
name|addr
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|query
operator|->
name|dialog_token
operator|=
name|dialog_token
expr_stmt|;
name|query
operator|->
name|freq
operator|=
name|freq
expr_stmt|;
name|query
operator|->
name|cb
operator|=
name|cb
expr_stmt|;
name|query
operator|->
name|ctx
operator|=
name|ctx
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|gas
operator|->
name|pending
argument_list|,
operator|&
name|query
operator|->
name|list
argument_list|)
expr_stmt|;
operator|*
operator|(
name|wpabuf_mhead_u8
argument_list|(
name|req
argument_list|)
operator|+
literal|2
operator|)
operator|=
name|dialog_token
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Starting request for "
name|MACSTR
literal|" dialog_token %u"
argument_list|,
name|MAC2STR
argument_list|(
name|dst
argument_list|)
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|gas_query_tx
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|req
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"GAS: Failed to send Action frame to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|query
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|query
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|query
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|eloop_register_timeout
argument_list|(
name|GAS_QUERY_TIMEOUT_PERIOD
argument_list|,
literal|0
argument_list|,
name|gas_query_timeout
argument_list|,
name|gas
argument_list|,
name|query
argument_list|)
expr_stmt|;
return|return
name|dialog_token
return|;
block|}
end_function

begin_comment
comment|/**  * gas_query_cancel - Cancel a pending GAS query  * @gas: GAS query data from gas_query_init()  * @dst: Destination MAC address for the query  * @dialog_token: Dialog token from gas_query_req()  */
end_comment

begin_function
name|void
name|gas_query_cancel
parameter_list|(
name|struct
name|gas_query
modifier|*
name|gas
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|)
block|{
name|struct
name|gas_query_pending
modifier|*
name|query
decl_stmt|;
name|query
operator|=
name|gas_query_get_pending
argument_list|(
name|gas
argument_list|,
name|dst
argument_list|,
name|dialog_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|query
condition|)
name|gas_query_done
argument_list|(
name|gas
argument_list|,
name|query
argument_list|,
name|GAS_QUERY_CANCELLED
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


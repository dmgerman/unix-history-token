begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / privileged helper program  * Copyright (c) 2007-2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__linux__
end_ifdef

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* __linux__ */
end_comment

begin_include
include|#
directive|include
file|<sys/un.h>
end_include

begin_include
include|#
directive|include
file|<sys/stat.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/version.h"
end_include

begin_include
include|#
directive|include
file|"drivers/driver.h"
end_include

begin_include
include|#
directive|include
file|"l2_packet/l2_packet.h"
end_include

begin_include
include|#
directive|include
file|"common/privsep_commands.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_struct
struct|struct
name|wpa_priv_interface
block|{
name|struct
name|wpa_priv_interface
modifier|*
name|next
decl_stmt|;
name|char
modifier|*
name|driver_name
decl_stmt|;
name|char
modifier|*
name|ifname
decl_stmt|;
name|char
modifier|*
name|sock_name
decl_stmt|;
name|int
name|fd
decl_stmt|;
name|struct
name|wpa_driver_ops
modifier|*
name|driver
decl_stmt|;
name|void
modifier|*
name|drv_priv
decl_stmt|;
name|struct
name|sockaddr_un
name|drv_addr
decl_stmt|;
name|int
name|wpas_registered
decl_stmt|;
comment|/* TODO: add support for multiple l2 connections */
name|struct
name|l2_packet_data
modifier|*
name|l2
decl_stmt|;
name|struct
name|sockaddr_un
name|l2_addr
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|wpa_priv_cmd_register
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|)
block|{
if|if
condition|(
name|iface
operator|->
name|drv_priv
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Cleaning up forgotten driver instance"
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|driver
operator|->
name|deinit
condition|)
name|iface
operator|->
name|driver
operator|->
name|deinit
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|)
expr_stmt|;
name|iface
operator|->
name|drv_priv
operator|=
name|NULL
expr_stmt|;
name|iface
operator|->
name|wpas_registered
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|iface
operator|->
name|l2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Cleaning up forgotten l2_packet "
literal|"instance"
argument_list|)
expr_stmt|;
name|l2_packet_deinit
argument_list|(
name|iface
operator|->
name|l2
argument_list|)
expr_stmt|;
name|iface
operator|->
name|l2
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|iface
operator|->
name|driver
operator|->
name|init
operator|==
name|NULL
condition|)
return|return;
name|iface
operator|->
name|drv_priv
operator|=
name|iface
operator|->
name|driver
operator|->
name|init
argument_list|(
name|iface
argument_list|,
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to initialize driver wrapper"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Driver wrapper '%s' initialized for interface "
literal|"'%s'"
argument_list|,
name|iface
operator|->
name|driver_name
argument_list|,
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|iface
operator|->
name|drv_addr
argument_list|,
name|from
argument_list|,
sizeof|sizeof
argument_list|(
name|iface
operator|->
name|drv_addr
argument_list|)
argument_list|)
expr_stmt|;
name|iface
operator|->
name|wpas_registered
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|driver
operator|->
name|set_param
operator|&&
name|iface
operator|->
name|driver
operator|->
name|set_param
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Driver interface rejected param"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_unregister
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|)
block|{
if|if
condition|(
name|iface
operator|->
name|drv_priv
condition|)
block|{
if|if
condition|(
name|iface
operator|->
name|driver
operator|->
name|deinit
condition|)
name|iface
operator|->
name|driver
operator|->
name|deinit
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|)
expr_stmt|;
name|iface
operator|->
name|drv_priv
operator|=
name|NULL
expr_stmt|;
name|iface
operator|->
name|wpas_registered
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_scan
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_driver_scan_params
name|params
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
operator|=
operator|(
name|u8
operator|*
operator|)
name|buf
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
operator|=
name|len
expr_stmt|;
name|params
operator|.
name|num_ssids
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|iface
operator|->
name|driver
operator|->
name|scan2
condition|)
name|iface
operator|->
name|driver
operator|->
name|scan2
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_get_scan_results2
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|)
block|{
name|struct
name|wpa_scan_results
modifier|*
name|res
decl_stmt|;
name|u8
modifier|*
name|buf
init|=
name|NULL
decl_stmt|,
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|val
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|res
operator|=
name|iface
operator|->
name|driver
operator|->
name|get_scan_results2
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|buf
operator|=
name|os_malloc
argument_list|(
literal|60000
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|pos
operator|=
name|buf
expr_stmt|;
name|end
operator|=
name|buf
operator|+
literal|60000
expr_stmt|;
name|val
operator|=
name|res
operator|->
name|num
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|r
init|=
name|res
operator|->
name|res
index|[
name|i
index|]
decl_stmt|;
name|val
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|r
argument_list|)
operator|+
name|r
operator|->
name|ie_len
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
name|val
condition|)
break|break;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|r
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|val
expr_stmt|;
block|}
name|sendto
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
name|buf
argument_list|,
name|pos
operator|-
name|buf
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpa_scan_results_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return;
name|fail
label|:
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpa_scan_results_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|sendto
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_get_scan_results
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|)
block|{
if|if
condition|(
name|iface
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|iface
operator|->
name|driver
operator|->
name|get_scan_results2
condition|)
name|wpa_priv_get_scan_results2
argument_list|(
name|iface
argument_list|,
name|from
argument_list|)
expr_stmt|;
else|else
name|sendto
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_associate
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_driver_associate_params
name|params
decl_stmt|;
name|struct
name|privsep_cmd_associate
modifier|*
name|assoc
decl_stmt|;
name|u8
modifier|*
name|bssid
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|drv_priv
operator|==
name|NULL
operator|||
name|iface
operator|->
name|driver
operator|->
name|associate
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|assoc
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid association request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|assoc
operator|=
name|buf
expr_stmt|;
if|if
condition|(
sizeof|sizeof
argument_list|(
operator|*
name|assoc
argument_list|)
operator|+
name|assoc
operator|->
name|wpa_ie_len
operator|>
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Association request overflow"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|bssid
operator|=
name|assoc
operator|->
name|bssid
expr_stmt|;
if|if
condition|(
name|bssid
index|[
literal|0
index|]
operator||
name|bssid
index|[
literal|1
index|]
operator||
name|bssid
index|[
literal|2
index|]
operator||
name|bssid
index|[
literal|3
index|]
operator||
name|bssid
index|[
literal|4
index|]
operator||
name|bssid
index|[
literal|5
index|]
condition|)
name|params
operator|.
name|bssid
operator|=
name|bssid
expr_stmt|;
name|params
operator|.
name|ssid
operator|=
name|assoc
operator|->
name|ssid
expr_stmt|;
if|if
condition|(
name|assoc
operator|->
name|ssid_len
operator|>
literal|32
condition|)
return|return;
name|params
operator|.
name|ssid_len
operator|=
name|assoc
operator|->
name|ssid_len
expr_stmt|;
name|params
operator|.
name|freq
operator|=
name|assoc
operator|->
name|freq
expr_stmt|;
if|if
condition|(
name|assoc
operator|->
name|wpa_ie_len
condition|)
block|{
name|params
operator|.
name|wpa_ie
operator|=
operator|(
name|u8
operator|*
operator|)
operator|(
name|assoc
operator|+
literal|1
operator|)
expr_stmt|;
name|params
operator|.
name|wpa_ie_len
operator|=
name|assoc
operator|->
name|wpa_ie_len
expr_stmt|;
block|}
name|params
operator|.
name|pairwise_suite
operator|=
name|assoc
operator|->
name|pairwise_suite
expr_stmt|;
name|params
operator|.
name|group_suite
operator|=
name|assoc
operator|->
name|group_suite
expr_stmt|;
name|params
operator|.
name|key_mgmt_suite
operator|=
name|assoc
operator|->
name|key_mgmt_suite
expr_stmt|;
name|params
operator|.
name|auth_alg
operator|=
name|assoc
operator|->
name|auth_alg
expr_stmt|;
name|params
operator|.
name|mode
operator|=
name|assoc
operator|->
name|mode
expr_stmt|;
name|res
operator|=
name|iface
operator|->
name|driver
operator|->
name|associate
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"drv->associate: res=%d"
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_get_bssid
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|)
block|{
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|iface
operator|->
name|driver
operator|->
name|get_bssid
operator|==
name|NULL
operator|||
name|iface
operator|->
name|driver
operator|->
name|get_bssid
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|,
name|bssid
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sendto
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
return|return;
name|fail
label|:
name|sendto
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_get_ssid
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|)
block|{
name|u8
name|ssid
index|[
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
literal|32
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|iface
operator|->
name|driver
operator|->
name|get_ssid
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|res
operator|=
name|iface
operator|->
name|driver
operator|->
name|get_ssid
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|,
operator|&
name|ssid
index|[
sizeof|sizeof
argument_list|(
name|int
argument_list|)
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
operator|||
name|res
operator|>
literal|32
condition|)
goto|goto
name|fail
goto|;
name|os_memcpy
argument_list|(
name|ssid
argument_list|,
operator|&
name|res
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|sendto
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
name|ssid
argument_list|,
sizeof|sizeof
argument_list|(
name|ssid
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
return|return;
name|fail
label|:
name|sendto
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_set_key
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|privsep_cmd_set_key
modifier|*
name|params
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|drv_priv
operator|==
name|NULL
operator|||
name|iface
operator|->
name|driver
operator|->
name|set_key
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|len
operator|!=
sizeof|sizeof
argument_list|(
operator|*
name|params
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid set_key request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|params
operator|=
name|buf
expr_stmt|;
name|res
operator|=
name|iface
operator|->
name|driver
operator|->
name|set_key
argument_list|(
name|iface
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|drv_priv
argument_list|,
name|params
operator|->
name|alg
argument_list|,
name|params
operator|->
name|addr
argument_list|,
name|params
operator|->
name|key_idx
argument_list|,
name|params
operator|->
name|set_tx
argument_list|,
name|params
operator|->
name|seq_len
condition|?
name|params
operator|->
name|seq
else|:
name|NULL
argument_list|,
name|params
operator|->
name|seq_len
argument_list|,
name|params
operator|->
name|key_len
condition|?
name|params
operator|->
name|key
else|:
name|NULL
argument_list|,
name|params
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"drv->set_key: res=%d"
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_get_capa
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|)
block|{
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|drv_priv
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|iface
operator|->
name|driver
operator|->
name|get_capa
operator|==
name|NULL
operator|||
name|iface
operator|->
name|driver
operator|->
name|get_capa
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|,
operator|&
name|capa
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
name|sendto
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
operator|&
name|capa
argument_list|,
sizeof|sizeof
argument_list|(
name|capa
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
return|return;
name|fail
label|:
name|sendto
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
literal|""
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_l2_rx
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_priv_interface
modifier|*
name|iface
init|=
name|ctx
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|2
index|]
decl_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
operator|(
name|u8
operator|*
operator|)
name|src_addr
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
name|ETH_ALEN
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|u8
operator|*
operator|)
name|buf
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|2
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|iface
operator|->
name|l2_addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|iface
operator|->
name|l2_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendmsg
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendmsg(l2 rx)"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_l2_register
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|int
modifier|*
name|reg_cmd
init|=
name|buf
decl_stmt|;
name|u8
name|own_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|res
decl_stmt|;
name|u16
name|proto
decl_stmt|;
if|if
condition|(
name|len
operator|!=
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Invalid l2_register length %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|proto
operator|=
name|reg_cmd
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|proto
operator|!=
name|ETH_P_EAPOL
operator|&&
name|proto
operator|!=
name|ETH_P_RSN_PREAUTH
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Refused l2_packet connection for "
literal|"ethertype 0x%x"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|iface
operator|->
name|l2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Cleaning up forgotten l2_packet "
literal|"instance"
argument_list|)
expr_stmt|;
name|l2_packet_deinit
argument_list|(
name|iface
operator|->
name|l2
argument_list|)
expr_stmt|;
name|iface
operator|->
name|l2
operator|=
name|NULL
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
operator|&
name|iface
operator|->
name|l2_addr
argument_list|,
name|from
argument_list|,
sizeof|sizeof
argument_list|(
name|iface
operator|->
name|l2_addr
argument_list|)
argument_list|)
expr_stmt|;
name|iface
operator|->
name|l2
operator|=
name|l2_packet_init
argument_list|(
name|iface
operator|->
name|ifname
argument_list|,
name|NULL
argument_list|,
name|proto
argument_list|,
name|wpa_priv_l2_rx
argument_list|,
name|iface
argument_list|,
name|reg_cmd
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|l2
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to initialize l2_packet "
literal|"instance for protocol %d"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|l2_packet_get_own_addr
argument_list|(
name|iface
operator|->
name|l2
argument_list|,
name|own_addr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to get own address from "
literal|"l2_packet"
argument_list|)
expr_stmt|;
name|l2_packet_deinit
argument_list|(
name|iface
operator|->
name|l2
argument_list|)
expr_stmt|;
name|iface
operator|->
name|l2
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|sendto
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|from
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|from
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"L2 registration: res=%d"
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_l2_unregister
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|)
block|{
if|if
condition|(
name|iface
operator|->
name|l2
condition|)
block|{
name|l2_packet_deinit
argument_list|(
name|iface
operator|->
name|l2
argument_list|)
expr_stmt|;
name|iface
operator|->
name|l2
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_l2_notify_auth_start
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|)
block|{
if|if
condition|(
name|iface
operator|->
name|l2
condition|)
name|l2_packet_notify_auth_start
argument_list|(
name|iface
operator|->
name|l2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_l2_send
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|struct
name|sockaddr_un
modifier|*
name|from
parameter_list|,
name|void
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u8
modifier|*
name|dst_addr
decl_stmt|;
name|u16
name|proto
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|l2
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|len
operator|<
name|ETH_ALEN
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Too short L2 send packet (len=%lu)"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|len
argument_list|)
expr_stmt|;
return|return;
block|}
name|dst_addr
operator|=
name|buf
expr_stmt|;
name|os_memcpy
argument_list|(
operator|&
name|proto
argument_list|,
name|buf
operator|+
name|ETH_ALEN
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|proto
operator|!=
name|ETH_P_EAPOL
operator|&&
name|proto
operator|!=
name|ETH_P_RSN_PREAUTH
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Refused l2_packet send for ethertype "
literal|"0x%x"
argument_list|,
name|proto
argument_list|)
expr_stmt|;
return|return;
block|}
name|res
operator|=
name|l2_packet_send
argument_list|(
name|iface
operator|->
name|l2
argument_list|,
name|dst_addr
argument_list|,
name|proto
argument_list|,
name|buf
operator|+
name|ETH_ALEN
operator|+
literal|2
argument_list|,
name|len
operator|-
name|ETH_ALEN
operator|-
literal|2
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"L2 send: res=%d"
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_cmd_set_country
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|)
block|{
if|if
condition|(
name|iface
operator|->
name|drv_priv
operator|==
name|NULL
operator|||
name|iface
operator|->
name|driver
operator|->
name|set_country
operator|==
name|NULL
operator|||
operator|*
name|buf
operator|==
literal|'\0'
condition|)
return|return;
name|iface
operator|->
name|driver
operator|->
name|set_country
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_receive
parameter_list|(
name|int
name|sock
parameter_list|,
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|sock_ctx
parameter_list|)
block|{
name|struct
name|wpa_priv_interface
modifier|*
name|iface
init|=
name|eloop_ctx
decl_stmt|;
name|char
name|buf
index|[
literal|2000
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|void
modifier|*
name|cmd_buf
decl_stmt|;
name|size_t
name|cmd_len
decl_stmt|;
name|int
name|res
decl_stmt|,
name|cmd
decl_stmt|;
name|struct
name|sockaddr_un
name|from
decl_stmt|;
name|socklen_t
name|fromlen
init|=
sizeof|sizeof
argument_list|(
name|from
argument_list|)
decl_stmt|;
name|res
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|from
argument_list|,
operator|&
name|fromlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"recvfrom"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|res
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|int
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Too short command (len=%d)"
argument_list|,
name|res
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
operator|&
name|cmd
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Command %d for interface %s"
argument_list|,
name|cmd
argument_list|,
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|cmd_buf
operator|=
operator|&
name|buf
index|[
sizeof|sizeof
argument_list|(
name|int
argument_list|)
index|]
expr_stmt|;
name|cmd_len
operator|=
name|res
operator|-
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|cmd
condition|)
block|{
case|case
name|PRIVSEP_CMD_REGISTER
case|:
name|wpa_priv_cmd_register
argument_list|(
name|iface
argument_list|,
operator|&
name|from
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_UNREGISTER
case|:
name|wpa_priv_cmd_unregister
argument_list|(
name|iface
argument_list|,
operator|&
name|from
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_SCAN
case|:
name|wpa_priv_cmd_scan
argument_list|(
name|iface
argument_list|,
name|cmd_buf
argument_list|,
name|cmd_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_GET_SCAN_RESULTS
case|:
name|wpa_priv_cmd_get_scan_results
argument_list|(
name|iface
argument_list|,
operator|&
name|from
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_ASSOCIATE
case|:
name|wpa_priv_cmd_associate
argument_list|(
name|iface
argument_list|,
name|cmd_buf
argument_list|,
name|cmd_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_GET_BSSID
case|:
name|wpa_priv_cmd_get_bssid
argument_list|(
name|iface
argument_list|,
operator|&
name|from
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_GET_SSID
case|:
name|wpa_priv_cmd_get_ssid
argument_list|(
name|iface
argument_list|,
operator|&
name|from
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_SET_KEY
case|:
name|wpa_priv_cmd_set_key
argument_list|(
name|iface
argument_list|,
name|cmd_buf
argument_list|,
name|cmd_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_GET_CAPA
case|:
name|wpa_priv_cmd_get_capa
argument_list|(
name|iface
argument_list|,
operator|&
name|from
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_L2_REGISTER
case|:
name|wpa_priv_cmd_l2_register
argument_list|(
name|iface
argument_list|,
operator|&
name|from
argument_list|,
name|cmd_buf
argument_list|,
name|cmd_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_L2_UNREGISTER
case|:
name|wpa_priv_cmd_l2_unregister
argument_list|(
name|iface
argument_list|,
operator|&
name|from
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_L2_NOTIFY_AUTH_START
case|:
name|wpa_priv_cmd_l2_notify_auth_start
argument_list|(
name|iface
argument_list|,
operator|&
name|from
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_L2_SEND
case|:
name|wpa_priv_cmd_l2_send
argument_list|(
name|iface
argument_list|,
operator|&
name|from
argument_list|,
name|cmd_buf
argument_list|,
name|cmd_len
argument_list|)
expr_stmt|;
break|break;
case|case
name|PRIVSEP_CMD_SET_COUNTRY
case|:
name|pos
operator|=
name|cmd_buf
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|cmd_len
operator|>=
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
break|break;
name|pos
index|[
name|cmd_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_priv_cmd_set_country
argument_list|(
name|iface
argument_list|,
name|pos
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_interface_deinit
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|)
block|{
if|if
condition|(
name|iface
operator|->
name|drv_priv
operator|&&
name|iface
operator|->
name|driver
operator|->
name|deinit
condition|)
name|iface
operator|->
name|driver
operator|->
name|deinit
argument_list|(
name|iface
operator|->
name|drv_priv
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|fd
operator|>=
literal|0
condition|)
block|{
name|eloop_unregister_read_sock
argument_list|(
name|iface
operator|->
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|iface
operator|->
name|fd
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|iface
operator|->
name|sock_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|iface
operator|->
name|l2
condition|)
name|l2_packet_deinit
argument_list|(
name|iface
operator|->
name|l2
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|iface
operator|->
name|driver_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|iface
operator|->
name|sock_name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|iface
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|extern
name|struct
name|wpa_driver_ops
modifier|*
name|wpa_drivers
index|[]
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|struct
name|wpa_priv_interface
modifier|*
name|wpa_priv_interface_init
parameter_list|(
specifier|const
name|char
modifier|*
name|dir
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|)
block|{
name|struct
name|wpa_priv_interface
modifier|*
name|iface
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|sockaddr_un
name|addr
decl_stmt|;
name|int
name|i
decl_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|params
argument_list|,
literal|':'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|iface
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|iface
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|iface
operator|->
name|fd
operator|=
operator|-
literal|1
expr_stmt|;
name|len
operator|=
name|pos
operator|-
name|params
expr_stmt|;
name|iface
operator|->
name|driver_name
operator|=
name|os_malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|driver_name
operator|==
name|NULL
condition|)
block|{
name|wpa_priv_interface_deinit
argument_list|(
name|iface
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memcpy
argument_list|(
name|iface
operator|->
name|driver_name
argument_list|,
name|params
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|iface
operator|->
name|driver_name
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|wpa_drivers
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|iface
operator|->
name|driver_name
argument_list|,
name|wpa_drivers
index|[
name|i
index|]
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|iface
operator|->
name|driver
operator|=
name|wpa_drivers
index|[
name|i
index|]
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|iface
operator|->
name|driver
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Unsupported driver '%s'"
argument_list|,
name|iface
operator|->
name|driver_name
argument_list|)
expr_stmt|;
name|wpa_priv_interface_deinit
argument_list|(
name|iface
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|iface
operator|->
name|ifname
operator|=
name|os_strdup
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|ifname
operator|==
name|NULL
condition|)
block|{
name|wpa_priv_interface_deinit
argument_list|(
name|iface
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|len
operator|=
name|os_strlen
argument_list|(
name|dir
argument_list|)
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|iface
operator|->
name|sock_name
operator|=
name|os_malloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|sock_name
operator|==
name|NULL
condition|)
block|{
name|wpa_priv_interface_deinit
argument_list|(
name|iface
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_snprintf
argument_list|(
name|iface
operator|->
name|sock_name
argument_list|,
name|len
operator|+
literal|1
argument_list|,
literal|"%s/%s"
argument_list|,
name|dir
argument_list|,
name|iface
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strlen
argument_list|(
name|iface
operator|->
name|sock_name
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
condition|)
block|{
name|wpa_priv_interface_deinit
argument_list|(
name|iface
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|iface
operator|->
name|fd
operator|=
name|socket
argument_list|(
name|PF_UNIX
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|fd
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"socket(PF_UNIX)"
argument_list|)
expr_stmt|;
name|wpa_priv_interface_deinit
argument_list|(
name|iface
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|addr
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sun_family
operator|=
name|AF_UNIX
expr_stmt|;
name|os_strlcpy
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|,
name|iface
operator|->
name|sock_name
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
operator|.
name|sun_path
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bind
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"bind(PF_UNIX) failed: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|connect
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Socket exists, but does not "
literal|"allow connections - assuming it was "
literal|"leftover from forced program termination"
argument_list|)
expr_stmt|;
if|if
condition|(
name|unlink
argument_list|(
name|iface
operator|->
name|sock_name
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"unlink[ctrl_iface]"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Could not unlink "
literal|"existing ctrl_iface socket '%s'"
argument_list|,
name|iface
operator|->
name|sock_name
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|bind
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"wpa-priv-iface-init: bind(PF_UNIX)"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Successfully replaced leftover "
literal|"socket '%s'"
argument_list|,
name|iface
operator|->
name|sock_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Socket exists and seems to be "
literal|"in use - cannot override it"
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"Delete '%s' manually if it is "
literal|"not used anymore"
argument_list|,
name|iface
operator|->
name|sock_name
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
block|}
if|if
condition|(
name|chmod
argument_list|(
name|iface
operator|->
name|sock_name
argument_list|,
name|S_IRWXU
operator||
name|S_IRWXG
operator||
name|S_IRWXO
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"chmod"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|eloop_register_read_sock
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
name|wpa_priv_receive
argument_list|,
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|iface
return|;
name|fail
label|:
name|wpa_priv_interface_deinit
argument_list|(
name|iface
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_priv_send_event
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|int
name|event
parameter_list|,
specifier|const
name|void
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|)
block|{
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|2
index|]
decl_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
operator|&
name|event
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|u8
operator|*
operator|)
name|data
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|data_len
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
name|data
condition|?
literal|2
else|:
literal|1
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|iface
operator|->
name|drv_addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|iface
operator|->
name|drv_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendmsg
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"sendmsg(wpas_socket)"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_send_assoc
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|int
name|event
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|size_t
name|buflen
init|=
literal|3
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|data
condition|)
block|{
name|buflen
operator|+=
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
operator|+
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies_len
operator|+
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies_len
expr_stmt|;
block|}
name|buf
operator|=
name|os_malloc
argument_list|(
name|buflen
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|pos
operator|=
name|buf
expr_stmt|;
if|if
condition|(
name|data
operator|&&
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
condition|)
block|{
name|len
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|req_ies_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|req_ies
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|&&
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
condition|)
block|{
name|len
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|resp_ies
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|data
operator|&&
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
condition|)
block|{
name|len
operator|=
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|data
operator|->
name|assoc_info
operator|.
name|beacon_ies
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|len
expr_stmt|;
block|}
else|else
block|{
name|len
operator|=
literal|0
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
block|}
name|wpa_priv_send_event
argument_list|(
name|iface
argument_list|,
name|event
argument_list|,
name|buf
argument_list|,
name|buflen
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_send_interface_status
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|int
name|ievent
decl_stmt|;
name|size_t
name|len
decl_stmt|,
name|maxlen
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|;
name|char
modifier|*
name|ifname
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
name|ievent
operator|=
name|data
operator|->
name|interface_status
operator|.
name|ievent
expr_stmt|;
name|maxlen
operator|=
sizeof|sizeof
argument_list|(
name|data
operator|->
name|interface_status
operator|.
name|ifname
argument_list|)
expr_stmt|;
name|ifname
operator|=
name|data
operator|->
name|interface_status
operator|.
name|ifname
expr_stmt|;
for|for
control|(
name|len
operator|=
literal|0
init|;
name|len
operator|<
name|maxlen
operator|&&
name|ifname
index|[
name|len
index|]
condition|;
name|len
operator|++
control|)
empty_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|buf
argument_list|,
operator|&
name|ievent
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|buf
operator|+
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|,
name|ifname
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_priv_send_event
argument_list|(
name|iface
argument_list|,
name|PRIVSEP_EVENT_INTERFACE_STATUS
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_send_ft_response
parameter_list|(
name|struct
name|wpa_priv_interface
modifier|*
name|iface
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|size_t
name|len
decl_stmt|;
name|u8
modifier|*
name|buf
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
if|if
condition|(
name|data
operator|==
name|NULL
operator|||
name|data
operator|->
name|ft_ies
operator|.
name|ies
operator|==
name|NULL
condition|)
return|return;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
operator|+
name|ETH_ALEN
operator|+
name|data
operator|->
name|ft_ies
operator|.
name|ies_len
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|pos
operator|=
name|buf
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
operator|&
name|data
operator|->
name|ft_ies
operator|.
name|ft_action
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|target_ap
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|ies
argument_list|,
name|data
operator|->
name|ft_ies
operator|.
name|ies_len
argument_list|)
expr_stmt|;
name|wpa_priv_send_event
argument_list|(
name|iface
argument_list|,
name|PRIVSEP_EVENT_FT_RESPONSE
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_event
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|wpa_event_type
name|event
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_priv_interface
modifier|*
name|iface
init|=
name|ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s - event=%d"
argument_list|,
name|__func__
argument_list|,
name|event
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|iface
operator|->
name|wpas_registered
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Driver event received, but "
literal|"wpa_supplicant not registered"
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|EVENT_ASSOC
case|:
name|wpa_priv_send_assoc
argument_list|(
name|iface
argument_list|,
name|PRIVSEP_EVENT_ASSOC
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_DISASSOC
case|:
name|wpa_priv_send_event
argument_list|(
name|iface
argument_list|,
name|PRIVSEP_EVENT_DISASSOC
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_ASSOCINFO
case|:
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
name|wpa_priv_send_assoc
argument_list|(
name|iface
argument_list|,
name|PRIVSEP_EVENT_ASSOCINFO
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_MICHAEL_MIC_FAILURE
case|:
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
name|wpa_priv_send_event
argument_list|(
name|iface
argument_list|,
name|PRIVSEP_EVENT_MICHAEL_MIC_FAILURE
argument_list|,
operator|&
name|data
operator|->
name|michael_mic_failure
operator|.
name|unicast
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_SCAN_RESULTS
case|:
name|wpa_priv_send_event
argument_list|(
name|iface
argument_list|,
name|PRIVSEP_EVENT_SCAN_RESULTS
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_INTERFACE_STATUS
case|:
name|wpa_priv_send_interface_status
argument_list|(
name|iface
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_PMKID_CANDIDATE
case|:
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
name|wpa_priv_send_event
argument_list|(
name|iface
argument_list|,
name|PRIVSEP_EVENT_PMKID_CANDIDATE
argument_list|,
operator|&
name|data
operator|->
name|pmkid_candidate
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|pmkid_candidate
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_STKSTART
case|:
if|if
condition|(
name|data
operator|==
name|NULL
condition|)
return|return;
name|wpa_priv_send_event
argument_list|(
name|iface
argument_list|,
name|PRIVSEP_EVENT_STKSTART
argument_list|,
operator|&
name|data
operator|->
name|stkstart
operator|.
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
break|break;
case|case
name|EVENT_FT_RESPONSE
case|:
name|wpa_priv_send_ft_response
argument_list|(
name|iface
argument_list|,
name|data
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Unsupported driver event %d - TODO"
argument_list|,
name|event
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|wpa_supplicant_rx_eapol
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_priv_interface
modifier|*
name|iface
init|=
name|ctx
decl_stmt|;
name|struct
name|msghdr
name|msg
decl_stmt|;
name|struct
name|iovec
name|io
index|[
literal|3
index|]
decl_stmt|;
name|int
name|event
init|=
name|PRIVSEP_EVENT_RX_EAPOL
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"RX EAPOL from driver"
argument_list|)
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_base
operator|=
operator|&
name|event
expr_stmt|;
name|io
index|[
literal|0
index|]
operator|.
name|iov_len
operator|=
sizeof|sizeof
argument_list|(
name|event
argument_list|)
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_base
operator|=
operator|(
name|u8
operator|*
operator|)
name|src_addr
expr_stmt|;
name|io
index|[
literal|1
index|]
operator|.
name|iov_len
operator|=
name|ETH_ALEN
expr_stmt|;
name|io
index|[
literal|2
index|]
operator|.
name|iov_base
operator|=
operator|(
name|u8
operator|*
operator|)
name|buf
expr_stmt|;
name|io
index|[
literal|2
index|]
operator|.
name|iov_len
operator|=
name|len
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|msg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|msg
argument_list|)
argument_list|)
expr_stmt|;
name|msg
operator|.
name|msg_iov
operator|=
name|io
expr_stmt|;
name|msg
operator|.
name|msg_iovlen
operator|=
literal|3
expr_stmt|;
name|msg
operator|.
name|msg_name
operator|=
operator|&
name|iface
operator|->
name|drv_addr
expr_stmt|;
name|msg
operator|.
name|msg_namelen
operator|=
sizeof|sizeof
argument_list|(
name|iface
operator|->
name|drv_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|sendmsg
argument_list|(
name|iface
operator|->
name|fd
argument_list|,
operator|&
name|msg
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|perror
argument_list|(
literal|"sendmsg(wpas_socket)"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_terminate
parameter_list|(
name|int
name|sig
parameter_list|,
name|void
modifier|*
name|signal_ctx
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpa_priv termination requested"
argument_list|)
expr_stmt|;
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_priv_fd_workaround
parameter_list|(
name|void
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|__linux__
name|int
name|s
decl_stmt|,
name|i
decl_stmt|;
comment|/* When started from pcmcia-cs scripts, wpa_supplicant might start with 	 * fd 0, 1, and 2 closed. This will cause some issues because many 	 * places in wpa_supplicant are still printing out to stdout. As a 	 * workaround, make sure that fd's 0, 1, and 2 are not used for other 	 * sockets. */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|s
operator|=
name|open
argument_list|(
literal|"/dev/null"
argument_list|,
name|O_RDWR
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|>
literal|2
condition|)
block|{
name|close
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
endif|#
directive|endif
comment|/* __linux__ */
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|void
parameter_list|)
block|{
name|printf
argument_list|(
literal|"wpa_priv v"
name|VERSION_STR
literal|"\n"
literal|"Copyright (c) 2007-2009, Jouni Malinen<j@w1.fi> and "
literal|"contributors\n"
literal|"\n"
literal|"usage:\n"
literal|"  wpa_priv [-Bdd] [-P<pid file>]<driver:ifname> "
literal|"[driver:ifname ...]\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|c
decl_stmt|,
name|i
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|char
modifier|*
name|pid_file
init|=
name|NULL
decl_stmt|;
name|int
name|daemonize
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|ctrl_dir
init|=
literal|"/var/run/wpa_priv"
decl_stmt|;
name|struct
name|wpa_priv_interface
modifier|*
name|interfaces
init|=
name|NULL
decl_stmt|,
modifier|*
name|iface
decl_stmt|;
if|if
condition|(
name|os_program_init
argument_list|()
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_priv_fd_workaround
argument_list|()
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"Bc:dP:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|<
literal|0
condition|)
break|break;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'B'
case|:
name|daemonize
operator|++
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|ctrl_dir
operator|=
name|optarg
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|wpa_debug_level
operator|--
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|pid_file
operator|=
name|os_rel2abs_path
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
if|if
condition|(
name|optind
operator|>=
name|argc
condition|)
block|{
name|usage
argument_list|()
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpa_priv control directory: '%s'"
argument_list|,
name|ctrl_dir
argument_list|)
expr_stmt|;
if|if
condition|(
name|eloop_init
argument_list|()
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize event loop"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
for|for
control|(
name|i
operator|=
name|optind
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Adding driver:interface %s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|iface
operator|=
name|wpa_priv_interface_init
argument_list|(
name|ctrl_dir
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|iface
operator|->
name|next
operator|=
name|interfaces
expr_stmt|;
name|interfaces
operator|=
name|iface
expr_stmt|;
block|}
if|if
condition|(
name|daemonize
operator|&&
name|os_daemonize
argument_list|(
name|pid_file
argument_list|)
condition|)
goto|goto
name|out
goto|;
name|eloop_register_signal_terminate
argument_list|(
name|wpa_priv_terminate
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_run
argument_list|()
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
name|out
label|:
name|iface
operator|=
name|interfaces
expr_stmt|;
while|while
condition|(
name|iface
condition|)
block|{
name|struct
name|wpa_priv_interface
modifier|*
name|prev
init|=
name|iface
decl_stmt|;
name|iface
operator|=
name|iface
operator|->
name|next
expr_stmt|;
name|wpa_priv_interface_deinit
argument_list|(
name|prev
argument_list|)
expr_stmt|;
block|}
name|eloop_destroy
argument_list|()
expr_stmt|;
name|os_daemonize_terminate
argument_list|(
name|pid_file
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pid_file
argument_list|)
expr_stmt|;
name|os_program_deinit
argument_list|()
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

end_unit


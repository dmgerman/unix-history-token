begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - Basic mesh mode routines  * Copyright (c) 2013-2014, cozybit, Inc.  All rights reserved.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"utils/uuid.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"ap/sta_info.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"ap.h"
end_include

begin_include
include|#
directive|include
file|"mesh_mpm.h"
end_include

begin_include
include|#
directive|include
file|"mesh_rsn.h"
end_include

begin_include
include|#
directive|include
file|"mesh.h"
end_include

begin_function
specifier|static
name|void
name|wpa_supplicant_mesh_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_supplicant_mesh_iface_deinit
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|ifmsh
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|ifmsh
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|mesh_rsn
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mesh_rsn
operator|=
name|NULL
expr_stmt|;
comment|/* TODO: leave mesh (stop beacon). This will happen on link down 	 * anyway, so it's not urgent */
block|}
end_function

begin_function
name|void
name|wpa_supplicant_mesh_iface_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|hostapd_iface
modifier|*
name|ifmsh
parameter_list|)
block|{
if|if
condition|(
operator|!
name|ifmsh
condition|)
return|return;
if|if
condition|(
name|ifmsh
operator|->
name|mconf
condition|)
block|{
name|mesh_mpm_deinit
argument_list|(
name|wpa_s
argument_list|,
name|ifmsh
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifmsh
operator|->
name|mconf
operator|->
name|rsn_ie
condition|)
block|{
name|ifmsh
operator|->
name|mconf
operator|->
name|rsn_ie
operator|=
name|NULL
expr_stmt|;
comment|/* We cannot free this struct 			 * because wpa_authenticator on 			 * hostapd side is also using it 			 * for now just set to NULL and 			 * let hostapd code free it. 			 */
block|}
name|os_free
argument_list|(
name|ifmsh
operator|->
name|mconf
argument_list|)
expr_stmt|;
name|ifmsh
operator|->
name|mconf
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* take care of shared data */
name|hostapd_interface_deinit
argument_list|(
name|ifmsh
argument_list|)
expr_stmt|;
name|hostapd_interface_free
argument_list|(
name|ifmsh
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|mesh_conf
modifier|*
name|mesh_config_create
parameter_list|(
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|mesh_conf
modifier|*
name|conf
decl_stmt|;
name|conf
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|mesh_conf
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conf
condition|)
return|return
name|NULL
return|;
name|os_memcpy
argument_list|(
name|conf
operator|->
name|meshid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|conf
operator|->
name|meshid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_SAE
condition|)
name|conf
operator|->
name|security
operator||=
name|MESH_CONF_SEC_AUTH
operator||
name|MESH_CONF_SEC_AMPE
expr_stmt|;
else|else
name|conf
operator|->
name|security
operator||=
name|MESH_CONF_SEC_NONE
expr_stmt|;
comment|/* defaults */
name|conf
operator|->
name|mesh_pp_id
operator|=
name|MESH_PATH_PROTOCOL_HWMP
expr_stmt|;
name|conf
operator|->
name|mesh_pm_id
operator|=
name|MESH_PATH_METRIC_AIRTIME
expr_stmt|;
name|conf
operator|->
name|mesh_cc_id
operator|=
literal|0
expr_stmt|;
name|conf
operator|->
name|mesh_sp_id
operator|=
name|MESH_SYNC_METHOD_NEIGHBOR_OFFSET
expr_stmt|;
name|conf
operator|->
name|mesh_auth_id
operator|=
operator|(
name|conf
operator|->
name|security
operator|&
name|MESH_CONF_SEC_AUTH
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
name|conf
operator|->
name|dot11MeshMaxRetries
operator|=
name|ssid
operator|->
name|dot11MeshMaxRetries
expr_stmt|;
name|conf
operator|->
name|dot11MeshRetryTimeout
operator|=
name|ssid
operator|->
name|dot11MeshRetryTimeout
expr_stmt|;
name|conf
operator|->
name|dot11MeshConfirmTimeout
operator|=
name|ssid
operator|->
name|dot11MeshConfirmTimeout
expr_stmt|;
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|=
name|ssid
operator|->
name|dot11MeshHoldingTimeout
expr_stmt|;
return|return
name|conf
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_mesh_copy_groups
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|num_groups
decl_stmt|;
name|size_t
name|groups_size
decl_stmt|;
for|for
control|(
name|num_groups
operator|=
literal|0
init|;
name|wpa_s
operator|->
name|conf
operator|->
name|sae_groups
index|[
name|num_groups
index|]
operator|>
literal|0
condition|;
name|num_groups
operator|++
control|)
empty_stmt|;
name|groups_size
operator|=
operator|(
name|num_groups
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|sae_groups
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|bss
operator|->
name|conf
operator|->
name|sae_groups
operator|=
name|os_malloc
argument_list|(
name|groups_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|conf
operator|->
name|sae_groups
condition|)
name|os_memcpy
argument_list|(
name|bss
operator|->
name|conf
operator|->
name|sae_groups
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|sae_groups
argument_list|,
name|groups_size
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_mesh_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|hostapd_iface
modifier|*
name|ifmsh
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|bss
decl_stmt|;
name|struct
name|hostapd_config
modifier|*
name|conf
decl_stmt|;
name|struct
name|mesh_conf
modifier|*
name|mconf
decl_stmt|;
name|int
name|basic_rates_erp
index|[]
init|=
block|{
literal|10
block|,
literal|20
block|,
literal|55
block|,
literal|60
block|,
literal|110
block|,
literal|120
block|,
literal|240
block|,
operator|-
literal|1
block|}
decl_stmt|;
specifier|static
name|int
name|default_groups
index|[]
init|=
block|{
literal|19
block|,
literal|20
block|,
literal|21
block|,
literal|25
block|,
literal|26
block|,
operator|-
literal|1
block|}
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|rate_len
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|user_mpm
condition|)
block|{
comment|/* not much for us to do here */
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"user_mpm is not enabled in configuration"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_s
operator|->
name|ifmsh
operator|=
name|ifmsh
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wpa_s
operator|->
name|ifmsh
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ifmsh
condition|)
return|return
operator|-
name|ENOMEM
return|;
name|ifmsh
operator|->
name|drv_flags
operator|=
name|wpa_s
operator|->
name|drv_flags
expr_stmt|;
name|ifmsh
operator|->
name|num_bss
operator|=
literal|1
expr_stmt|;
name|ifmsh
operator|->
name|bss
operator|=
name|os_calloc
argument_list|(
name|wpa_s
operator|->
name|ifmsh
operator|->
name|num_bss
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_data
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ifmsh
operator|->
name|bss
condition|)
goto|goto
name|out_free
goto|;
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
operator|=
name|bss
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|hostapd_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
condition|)
goto|goto
name|out_free
goto|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|bss
operator|->
name|driver
operator|=
name|wpa_s
operator|->
name|driver
expr_stmt|;
name|bss
operator|->
name|drv_priv
operator|=
name|wpa_s
operator|->
name|drv_priv
expr_stmt|;
name|bss
operator|->
name|iface
operator|=
name|ifmsh
expr_stmt|;
name|bss
operator|->
name|mesh_sta_free_cb
operator|=
name|mesh_mpm_free_sta
expr_stmt|;
name|wpa_s
operator|->
name|assoc_freq
operator|=
name|ssid
operator|->
name|frequency
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
comment|/* setup an AP config for auth processing */
name|conf
operator|=
name|hostapd_config_defaults
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|conf
condition|)
goto|goto
name|out_free
goto|;
name|bss
operator|->
name|conf
operator|=
operator|*
name|conf
operator|->
name|bss
expr_stmt|;
name|bss
operator|->
name|conf
operator|->
name|start_disabled
operator|=
literal|1
expr_stmt|;
name|bss
operator|->
name|conf
operator|->
name|mesh
operator|=
name|MESH_ENABLED
expr_stmt|;
name|bss
operator|->
name|conf
operator|->
name|ap_max_inactivity
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|mesh_max_inactivity
expr_stmt|;
name|bss
operator|->
name|iconf
operator|=
name|conf
expr_stmt|;
name|ifmsh
operator|->
name|conf
operator|=
name|conf
expr_stmt|;
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|max_plinks
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|max_peer_links
expr_stmt|;
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|dot11RSNASAERetransPeriod
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|dot11RSNASAERetransPeriod
expr_stmt|;
name|os_strlcpy
argument_list|(
name|bss
operator|->
name|conf
operator|->
name|iface
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|bss
operator|->
name|conf
operator|->
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|mconf
operator|=
name|mesh_config_create
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mconf
condition|)
goto|goto
name|out_free
goto|;
name|ifmsh
operator|->
name|mconf
operator|=
name|mconf
expr_stmt|;
comment|/* need conf->hw_mode for supported rates. */
if|if
condition|(
name|ssid
operator|->
name|frequency
operator|==
literal|0
condition|)
block|{
name|conf
operator|->
name|hw_mode
operator|=
name|HOSTAPD_MODE_IEEE80211G
expr_stmt|;
name|conf
operator|->
name|channel
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|conf
operator|->
name|hw_mode
operator|=
name|ieee80211_freq_to_chan
argument_list|(
name|ssid
operator|->
name|frequency
argument_list|,
operator|&
name|conf
operator|->
name|channel
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|conf
operator|->
name|hw_mode
operator|==
name|NUM_HOSTAPD_MODES
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Unsupported mesh mode frequency: %d MHz"
argument_list|,
name|ssid
operator|->
name|frequency
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
if|if
condition|(
name|ssid
operator|->
name|mesh_basic_rates
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * XXX: Hack! This is so an MPM which correctly sets the ERP 		 * mandatory rates as BSSBasicRateSet doesn't reject us. We 		 * could add a new hw_mode HOSTAPD_MODE_IEEE80211G_ERP, but 		 * this is way easier. This also makes our BSSBasicRateSet 		 * advertised in beacons match the one in peering frames, sigh. 		 */
if|if
condition|(
name|conf
operator|->
name|hw_mode
operator|==
name|HOSTAPD_MODE_IEEE80211G
condition|)
block|{
name|conf
operator|->
name|basic_rates
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|basic_rates_erp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|conf
operator|->
name|basic_rates
condition|)
goto|goto
name|out_free
goto|;
name|os_memcpy
argument_list|(
name|conf
operator|->
name|basic_rates
argument_list|,
name|basic_rates_erp
argument_list|,
sizeof|sizeof
argument_list|(
name|basic_rates_erp
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|rate_len
operator|=
literal|0
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|mesh_basic_rates
index|[
name|rate_len
index|]
operator|<
literal|1
condition|)
break|break;
name|rate_len
operator|++
expr_stmt|;
block|}
name|conf
operator|->
name|basic_rates
operator|=
name|os_calloc
argument_list|(
name|rate_len
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|basic_rates
operator|==
name|NULL
condition|)
goto|goto
name|out_free
goto|;
name|os_memcpy
argument_list|(
name|conf
operator|->
name|basic_rates
argument_list|,
name|ssid
operator|->
name|mesh_basic_rates
argument_list|,
name|rate_len
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|conf
operator|->
name|basic_rates
index|[
name|rate_len
index|]
operator|=
operator|-
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|hostapd_setup_interface
argument_list|(
name|ifmsh
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"Failed to initialize hostapd interface for mesh"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_drv_init_mesh
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to init mesh in driver"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|mconf
operator|->
name|security
operator|!=
name|MESH_CONF_SEC_NONE
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"mesh: Passphrase for SAE not configured"
argument_list|)
expr_stmt|;
goto|goto
name|out_free
goto|;
block|}
name|bss
operator|->
name|conf
operator|->
name|wpa
operator|=
name|ssid
operator|->
name|proto
expr_stmt|;
name|bss
operator|->
name|conf
operator|->
name|wpa_key_mgmt
operator|=
name|ssid
operator|->
name|key_mgmt
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|sae_groups
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|sae_groups
index|[
literal|0
index|]
operator|>
literal|0
condition|)
block|{
name|wpas_mesh_copy_groups
argument_list|(
name|bss
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bss
operator|->
name|conf
operator|->
name|sae_groups
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|default_groups
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
operator|->
name|conf
operator|->
name|sae_groups
condition|)
goto|goto
name|out_free
goto|;
name|os_memcpy
argument_list|(
name|bss
operator|->
name|conf
operator|->
name|sae_groups
argument_list|,
name|default_groups
argument_list|,
sizeof|sizeof
argument_list|(
name|default_groups
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
name|os_strlen
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
expr_stmt|;
name|bss
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_passphrase
operator|=
name|dup_binstr
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mesh_rsn
operator|=
name|mesh_rsn_auth_init
argument_list|(
name|wpa_s
argument_list|,
name|mconf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|mesh_rsn
condition|)
goto|goto
name|out_free
goto|;
block|}
name|wpa_supplicant_conf_ap_ht
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|conf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
name|out_free
label|:
name|wpa_supplicant_mesh_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
operator|-
name|ENOMEM
return|;
block|}
end_function

begin_function
name|void
name|wpa_mesh_notify_peer
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ie_len
parameter_list|)
block|{
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"new peer notification for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|ies
argument_list|,
name|ie_len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|==
name|ParseFailed
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Could not parse beacon from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_mesh_new_mesh_peer
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
operator|&
name|elems
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpa_supplicant_mesh_add_scan_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|extra_ie
parameter_list|)
block|{
comment|/* EID + 0-length (wildcard) mesh-id */
name|size_t
name|ielen
init|=
literal|2
decl_stmt|;
if|if
condition|(
name|wpabuf_resize
argument_list|(
name|extra_ie
argument_list|,
name|ielen
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
operator|*
name|extra_ie
argument_list|,
name|WLAN_EID_MESH_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
operator|*
name|extra_ie
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wpa_supplicant_join_mesh
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_driver_mesh_join_params
name|params
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|ssid
operator|||
operator|!
name|ssid
operator|->
name|ssid
operator|||
operator|!
name|ssid
operator|->
name|ssid_len
operator|||
operator|!
name|ssid
operator|->
name|frequency
condition|)
block|{
name|ret
operator|=
operator|-
name|ENOENT
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_supplicant_mesh_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|meshid
operator|=
name|ssid
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|meshid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
name|ibss_mesh_setup_freq
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
operator|&
name|params
operator|.
name|freq
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|mesh_ht_enabled
operator|=
operator|!
operator|!
name|params
operator|.
name|freq
operator|.
name|ht_enabled
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|beacon_int
operator|>
literal|0
condition|)
name|params
operator|.
name|beacon_int
operator|=
name|ssid
operator|->
name|beacon_int
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|beacon_int
operator|>
literal|0
condition|)
name|params
operator|.
name|beacon_int
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|beacon_int
expr_stmt|;
name|params
operator|.
name|max_peer_links
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|max_peer_links
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_SAE
condition|)
block|{
name|params
operator|.
name|flags
operator||=
name|WPA_DRIVER_MESH_FLAG_SAE_AUTH
expr_stmt|;
name|params
operator|.
name|flags
operator||=
name|WPA_DRIVER_MESH_FLAG_AMPE
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|user_mpm
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|user_mpm
condition|)
block|{
name|params
operator|.
name|flags
operator||=
name|WPA_DRIVER_MESH_FLAG_USER_MPM
expr_stmt|;
name|params
operator|.
name|conf
operator|.
name|flags
operator|&=
operator|~
name|WPA_DRIVER_MESH_CONF_FLAG_AUTO_PLINKS
expr_stmt|;
block|}
else|else
block|{
name|params
operator|.
name|flags
operator||=
name|WPA_DRIVER_MESH_FLAG_DRIVER_MPM
expr_stmt|;
name|params
operator|.
name|conf
operator|.
name|flags
operator||=
name|WPA_DRIVER_MESH_CONF_FLAG_AUTO_PLINKS
expr_stmt|;
block|}
name|params
operator|.
name|conf
operator|.
name|peer_link_timeout
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|mesh_max_inactivity
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_mesh_init
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Failed to init mesh"
argument_list|)
expr_stmt|;
name|wpa_drv_leave_mesh
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|ifmsh
condition|)
block|{
name|params
operator|.
name|ies
operator|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|mconf
operator|->
name|rsn_ie
expr_stmt|;
name|params
operator|.
name|ie_len
operator|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|mconf
operator|->
name|rsn_ie_len
expr_stmt|;
name|params
operator|.
name|basic_rates
operator|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|basic_rates
expr_stmt|;
block|}
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"joining mesh %s"
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_drv_join_mesh
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"mesh join error=%d\n"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
comment|/* hostapd sets the interface down until we associate */
name|wpa_drv_set_operstate
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpa_supplicant_leave_mesh
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"leaving mesh"
argument_list|)
expr_stmt|;
comment|/* Need to send peering close messages first */
name|wpa_supplicant_mesh_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_drv_leave_mesh
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"mesh leave error=%d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|wpa_drv_set_operstate
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mesh_attr_text
parameter_list|(
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
name|end
parameter_list|)
block|{
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|char
modifier|*
name|mesh_id
decl_stmt|,
modifier|*
name|pos
init|=
name|buf
decl_stmt|;
name|u8
modifier|*
name|bss_basic_rate_set
decl_stmt|;
name|int
name|bss_basic_rate_set_len
decl_stmt|,
name|ret
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|ies
argument_list|,
name|ies_len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|==
name|ParseFailed
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|elems
operator|.
name|mesh_id_len
operator|<
literal|1
condition|)
return|return
literal|0
return|;
name|mesh_id
operator|=
name|os_malloc
argument_list|(
name|elems
operator|.
name|mesh_id_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|mesh_id
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|mesh_id
argument_list|,
name|elems
operator|.
name|mesh_id
argument_list|,
name|elems
operator|.
name|mesh_id_len
argument_list|)
expr_stmt|;
name|mesh_id
index|[
name|elems
operator|.
name|mesh_id_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"mesh_id=%s\n"
argument_list|,
name|mesh_id
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|mesh_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
if|if
condition|(
name|elems
operator|.
name|mesh_config_len
operator|>
literal|6
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"active_path_selection_protocol_id=0x%02x\n"
literal|"active_path_selection_metric_id=0x%02x\n"
literal|"congestion_control_mode_id=0x%02x\n"
literal|"synchronization_method_id=0x%02x\n"
literal|"authentication_protocol_id=0x%02x\n"
literal|"mesh_formation_info=0x%02x\n"
literal|"mesh_capability=0x%02x\n"
argument_list|,
name|elems
operator|.
name|mesh_config
index|[
literal|0
index|]
argument_list|,
name|elems
operator|.
name|mesh_config
index|[
literal|1
index|]
argument_list|,
name|elems
operator|.
name|mesh_config
index|[
literal|2
index|]
argument_list|,
name|elems
operator|.
name|mesh_config
index|[
literal|3
index|]
argument_list|,
name|elems
operator|.
name|mesh_config
index|[
literal|4
index|]
argument_list|,
name|elems
operator|.
name|mesh_config
index|[
literal|5
index|]
argument_list|,
name|elems
operator|.
name|mesh_config
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
return|return
name|pos
operator|-
name|buf
return|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|bss_basic_rate_set
operator|=
name|os_malloc
argument_list|(
name|elems
operator|.
name|supp_rates_len
operator|+
name|elems
operator|.
name|ext_supp_rates_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss_basic_rate_set
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bss_basic_rate_set_len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|elems
operator|.
name|supp_rates_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|elems
operator|.
name|supp_rates
index|[
name|i
index|]
operator|&
literal|0x80
condition|)
block|{
name|bss_basic_rate_set
index|[
name|bss_basic_rate_set_len
operator|++
index|]
operator|=
operator|(
name|elems
operator|.
name|supp_rates
index|[
name|i
index|]
operator|&
literal|0x7f
operator|)
operator|*
literal|5
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|elems
operator|.
name|ext_supp_rates_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|elems
operator|.
name|ext_supp_rates
index|[
name|i
index|]
operator|&
literal|0x80
condition|)
block|{
name|bss_basic_rate_set
index|[
name|bss_basic_rate_set_len
operator|++
index|]
operator|=
operator|(
name|elems
operator|.
name|ext_supp_rates
index|[
name|i
index|]
operator|&
literal|0x7f
operator|)
operator|*
literal|5
expr_stmt|;
block|}
block|}
if|if
condition|(
name|bss_basic_rate_set_len
operator|>
literal|0
condition|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"bss_basic_rate_set=%d"
argument_list|,
name|bss_basic_rate_set
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|pos
operator|+=
name|ret
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|bss_basic_rate_set_len
condition|;
name|i
operator|++
control|)
block|{
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" %d"
argument_list|,
name|bss_basic_rate_set
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|ret
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|ret
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|pos
operator|+=
name|ret
expr_stmt|;
block|}
name|fail
label|:
name|os_free
argument_list|(
name|bss_basic_rate_set
argument_list|)
expr_stmt|;
return|return
name|pos
operator|-
name|buf
return|;
block|}
end_function

begin_function
name|int
name|wpas_mesh_scan_result_text
parameter_list|(
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
name|end
parameter_list|)
block|{
return|return
name|mesh_attr_text
argument_list|(
name|ies
argument_list|,
name|ies_len
argument_list|,
name|buf
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_mesh_get_ifname
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|char
modifier|*
name|ifname
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|char
modifier|*
name|ifname_ptr
init|=
name|wpa_s
operator|->
name|ifname
decl_stmt|;
name|int
name|res
decl_stmt|;
name|res
operator|=
name|os_snprintf
argument_list|(
name|ifname
argument_list|,
name|len
argument_list|,
literal|"mesh-%s-%d"
argument_list|,
name|ifname_ptr
argument_list|,
name|wpa_s
operator|->
name|mesh_if_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|len
argument_list|,
name|res
argument_list|)
operator|||
operator|(
name|os_strlen
argument_list|(
name|ifname
argument_list|)
operator|>=
name|IFNAMSIZ
operator|&&
name|os_strlen
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
operator|<
name|IFNAMSIZ
operator|)
condition|)
block|{
comment|/* Try to avoid going over the IFNAMSIZ length limit */
name|res
operator|=
name|os_snprintf
argument_list|(
name|ifname
argument_list|,
name|len
argument_list|,
literal|"mesh-%d"
argument_list|,
name|wpa_s
operator|->
name|mesh_if_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|len
argument_list|,
name|res
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|mesh_if_idx
operator|++
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_mesh_add_interface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|char
modifier|*
name|ifname
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|struct
name|wpa_interface
name|iface
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|mesh_wpa_s
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|ifname
index|[
literal|0
index|]
operator|==
literal|'\0'
operator|&&
name|wpas_mesh_get_ifname
argument_list|(
name|wpa_s
argument_list|,
name|ifname
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_drv_if_add
argument_list|(
name|wpa_s
argument_list|,
name|WPA_IF_MESH
argument_list|,
name|ifname
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|addr
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"mesh: Failed to create new mesh interface"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"mesh: Created virtual interface %s addr "
name|MACSTR
argument_list|,
name|ifname
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|iface
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|iface
operator|.
name|ifname
operator|=
name|ifname
expr_stmt|;
name|iface
operator|.
name|driver
operator|=
name|wpa_s
operator|->
name|driver
operator|->
name|name
expr_stmt|;
name|iface
operator|.
name|driver_param
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
expr_stmt|;
name|iface
operator|.
name|ctrl_interface
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
expr_stmt|;
name|mesh_wpa_s
operator|=
name|wpa_supplicant_add_iface
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
operator|&
name|iface
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mesh_wpa_s
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"mesh: Failed to create new wpa_supplicant interface"
argument_list|)
expr_stmt|;
name|wpa_supplicant_remove_iface
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|mesh_wpa_s
operator|->
name|mesh_if_created
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


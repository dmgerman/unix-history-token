begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant - SME  * Copyright (c) 2009-2010, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_common.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/pmksa_cache.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"wpas_glue.h"
end_include

begin_include
include|#
directive|include
file|"wps_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"blacklist.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"sme.h"
end_include

begin_function
name|void
name|sme_authenticate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_driver_auth_params
name|params
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|old_ssid
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
specifier|const
name|u8
modifier|*
name|md
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|int
name|i
decl_stmt|,
name|bssid_changed
decl_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"SME: No scan result available for the "
literal|"network"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|current_bss
operator|=
name|bss
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|0
expr_stmt|;
name|params
operator|.
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|params
operator|.
name|bssid
operator|=
name|bss
operator|->
name|bssid
expr_stmt|;
name|params
operator|.
name|ssid
operator|=
name|bss
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|ssid_len
operator|!=
name|params
operator|.
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid_set
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|freq
operator|=
name|params
operator|.
name|freq
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ssid_len
operator|=
name|params
operator|.
name|ssid_len
expr_stmt|;
name|params
operator|.
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|leap
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|non_leap
operator|==
literal|0
condition|)
name|params
operator|.
name|auth_alg
operator|=
name|WPA_AUTH_ALG_LEAP
expr_stmt|;
else|else
name|params
operator|.
name|auth_alg
operator||=
name|WPA_AUTH_ALG_LEAP
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Automatic auth_alg selection: 0x%x"
argument_list|,
name|params
operator|.
name|auth_alg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
condition|)
block|{
name|params
operator|.
name|auth_alg
operator|=
name|ssid
operator|->
name|auth_alg
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Overriding auth_alg selection: 0x%x"
argument_list|,
name|params
operator|.
name|auth_alg
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
condition|)
name|params
operator|.
name|wep_key
index|[
name|i
index|]
operator|=
name|ssid
operator|->
name|wep_key
index|[
name|i
index|]
expr_stmt|;
name|params
operator|.
name|wep_key_len
index|[
name|i
index|]
operator|=
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
expr_stmt|;
block|}
name|params
operator|.
name|wep_tx_keyidx
operator|=
name|ssid
operator|->
name|wep_tx_keyidx
expr_stmt|;
name|bssid_changed
operator|=
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|bssid_changed
condition|)
name|wpas_notify_bssid_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
operator|||
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
operator|)
operator|&&
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_IEEE8021X
operator||
name|WPA_KEY_MGMT_PSK
operator||
name|WPA_KEY_MGMT_FT_IEEE8021X
operator||
name|WPA_KEY_MGMT_FT_PSK
operator||
name|WPA_KEY_MGMT_IEEE8021X_SHA256
operator||
name|WPA_KEY_MGMT_PSK_SHA256
operator|)
operator|)
condition|)
block|{
name|int
name|try_opportunistic
decl_stmt|;
name|try_opportunistic
operator|=
name|ssid
operator|->
name|proactive_key_caching
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
expr_stmt|;
if|if
condition|(
name|pmksa_cache_set_current
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|,
name|try_opportunistic
argument_list|)
operator|==
literal|0
condition|)
name|eapol_sm_notify_pmkid_attempt
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ssid
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|,
operator|&
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SME: Failed to set WPA key "
literal|"management and encryption suites"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_PSK
operator||
name|WPA_KEY_MGMT_IEEE8021X
operator||
name|WPA_KEY_MGMT_WPA_NONE
operator||
name|WPA_KEY_MGMT_FT_PSK
operator||
name|WPA_KEY_MGMT_FT_IEEE8021X
operator||
name|WPA_KEY_MGMT_PSK_SHA256
operator||
name|WPA_KEY_MGMT_IEEE8021X_SHA256
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|,
operator|&
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_WARNING
argument_list|,
literal|"SME: Failed to set WPA key "
literal|"management and encryption suites (no scan "
literal|"results)"
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
name|wps_ie
operator|=
name|wps_build_assoc_req_ie
argument_list|(
name|wpas_wps_get_req_type
argument_list|(
name|ssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|&&
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
operator|<=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|)
condition|)
block|{
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|,
name|wpabuf_head
argument_list|(
name|wps_ie
argument_list|)
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
literal|0
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
block|}
else|else
block|{
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_MOBILITY_DOMAIN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|&&
name|ie
index|[
literal|1
index|]
operator|>=
name|MOBILITY_DOMAIN_ID_LEN
condition|)
name|md
operator|=
name|ie
operator|+
literal|2
expr_stmt|;
name|wpa_sm_set_ft_params
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ie
argument_list|,
name|ie
condition|?
literal|2
operator|+
name|ie
index|[
literal|1
index|]
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|md
condition|)
block|{
comment|/* Prepare for the next transition */
name|wpa_ft_prepare_auth_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|md
operator|&&
name|ssid
operator|->
name|key_mgmt
operator|&
operator|(
name|WPA_KEY_MGMT_FT_PSK
operator||
name|WPA_KEY_MGMT_FT_IEEE8021X
operator|)
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|+
literal|5
operator|<
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|)
condition|)
block|{
name|struct
name|rsn_mdie
modifier|*
name|mdie
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
operator|+
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
decl_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_MOBILITY_DOMAIN
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|mdie
argument_list|)
expr_stmt|;
name|mdie
operator|=
operator|(
expr|struct
name|rsn_mdie
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memcpy
argument_list|(
name|mdie
operator|->
name|mobility_domain
argument_list|,
name|md
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
expr_stmt|;
name|mdie
operator|->
name|ft_capab
operator|=
name|md
index|[
name|MOBILITY_DOMAIN_ID_LEN
index|]
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|+=
literal|5
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_used
operator|&&
name|os_memcmp
argument_list|(
name|md
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|mobility_domain
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|&&
name|wpa_sm_has_ptk
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Trying to use FT "
literal|"over-the-air"
argument_list|)
expr_stmt|;
name|params
operator|.
name|auth_alg
operator|=
name|WPA_AUTH_ALG_FT
expr_stmt|;
name|params
operator|.
name|ie
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
expr_stmt|;
name|params
operator|.
name|ie_len
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies_len
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|wpa_s
operator|->
name|sme
operator|.
name|mfp
operator|=
name|ssid
operator|->
name|ieee80211w
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ieee80211w
operator|!=
name|NO_MGMT_FRAME_PROTECTION
condition|)
block|{
specifier|const
name|u8
modifier|*
name|rsn
init|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
decl_stmt|;
name|struct
name|wpa_ie_data
name|_ie
decl_stmt|;
if|if
condition|(
name|rsn
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|rsn
argument_list|,
literal|2
operator|+
name|rsn
index|[
literal|1
index|]
argument_list|,
operator|&
name|_ie
argument_list|)
operator|==
literal|0
operator|&&
name|_ie
operator|.
name|capabilities
operator|&
operator|(
name|WPA_CAPABILITY_MFPC
operator||
name|WPA_CAPABILITY_MFPR
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPA: Selected AP supports MFP: "
literal|"require MFP"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|mfp
operator|=
name|MGMT_FRAME_PROTECTION_REQUIRED
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|wpa_supplicant_cancel_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Trying to authenticate with "
name|MACSTR
literal|" (SSID='%s' freq=%d MHz)"
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|.
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|params
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid_len
argument_list|)
argument_list|,
name|params
operator|.
name|freq
argument_list|)
expr_stmt|;
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_AUTHENTICATING
argument_list|)
expr_stmt|;
name|old_ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_supplicant_rsn_supp_set_config
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_initiate_eapol
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_ssid
operator|!=
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpas_notify_network_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|auth_alg
operator|=
name|params
operator|.
name|auth_alg
expr_stmt|;
if|if
condition|(
name|wpa_drv_authenticate
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Authentication request to the "
literal|"driver failed"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* TODO: add timeout on authentication */
comment|/* 	 * Association will be started based on the authentication event from 	 * the driver. 	 */
block|}
end_function

begin_function
name|void
name|sme_event_auth
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Ignore authentication event when "
literal|"network is not selected"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_AUTHENTICATING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Ignore authentication event when "
literal|"not in authenticating state"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|data
operator|->
name|auth
operator|.
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Ignore authentication with "
literal|"unexpected peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|auth
operator|.
name|peer
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Authentication response: peer="
name|MACSTR
literal|" auth_type=%d status_code=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|auth
operator|.
name|peer
argument_list|)
argument_list|,
name|data
operator|->
name|auth
operator|.
name|auth_type
argument_list|,
name|data
operator|->
name|auth
operator|.
name|status_code
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"SME: Authentication response IEs"
argument_list|,
name|data
operator|->
name|auth
operator|.
name|ies
argument_list|,
name|data
operator|->
name|auth
operator|.
name|ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|auth
operator|.
name|status_code
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Authentication failed (status "
literal|"code %d)"
argument_list|,
name|data
operator|->
name|auth
operator|.
name|status_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|auth
operator|.
name|status_code
operator|!=
name|WLAN_STATUS_NOT_SUPPORTED_AUTH_ALG
operator|||
name|wpa_s
operator|->
name|sme
operator|.
name|auth_alg
operator|==
name|data
operator|->
name|auth
operator|.
name|auth_type
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|->
name|auth_alg
operator|==
name|WPA_AUTH_ALG_LEAP
condition|)
return|return;
switch|switch
condition|(
name|data
operator|->
name|auth
operator|.
name|auth_type
condition|)
block|{
case|case
name|WLAN_AUTH_OPEN
case|:
name|wpa_s
operator|->
name|current_ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_SHARED
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Trying SHARED auth"
argument_list|)
expr_stmt|;
name|wpa_supplicant_associate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_bss
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
return|return;
case|case
name|WLAN_AUTH_SHARED_KEY
case|:
name|wpa_s
operator|->
name|current_ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_LEAP
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Trying LEAP auth"
argument_list|)
expr_stmt|;
name|wpa_supplicant_associate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_bss
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
return|return;
default|default:
return|return;
block|}
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|data
operator|->
name|auth
operator|.
name|auth_type
operator|==
name|WLAN_AUTH_FT
condition|)
block|{
name|union
name|wpa_event_data
name|edata
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|edata
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|edata
argument_list|)
argument_list|)
expr_stmt|;
name|edata
operator|.
name|ft_ies
operator|.
name|ies
operator|=
name|data
operator|->
name|auth
operator|.
name|ies
expr_stmt|;
name|edata
operator|.
name|ft_ies
operator|.
name|ies_len
operator|=
name|data
operator|->
name|auth
operator|.
name|ies_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|edata
operator|.
name|ft_ies
operator|.
name|target_ap
argument_list|,
name|data
operator|->
name|auth
operator|.
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_FT_RESPONSE
argument_list|,
operator|&
name|edata
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|sme_associate
argument_list|(
name|wpa_s
argument_list|,
name|ssid
operator|->
name|mode
argument_list|,
name|data
operator|->
name|auth
operator|.
name|peer
argument_list|,
name|data
operator|->
name|auth
operator|.
name|auth_type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_associate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|enum
name|wpas_mode
name|mode
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u16
name|auth_type
parameter_list|)
block|{
name|struct
name|wpa_driver_associate_params
name|params
decl_stmt|;
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|bssid
operator|=
name|bssid
expr_stmt|;
name|params
operator|.
name|ssid
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ssid_len
expr_stmt|;
name|params
operator|.
name|freq
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|freq
expr_stmt|;
name|params
operator|.
name|wpa_ie
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
condition|?
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
else|:
name|NULL
expr_stmt|;
name|params
operator|.
name|wpa_ie_len
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|auth_type
operator|==
name|WLAN_AUTH_FT
operator|&&
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
condition|)
block|{
name|params
operator|.
name|wpa_ie
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
expr_stmt|;
name|params
operator|.
name|wpa_ie_len
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies_len
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|params
operator|.
name|mode
operator|=
name|mode
expr_stmt|;
name|params
operator|.
name|mgmt_frame_protection
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|mfp
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid_set
condition|)
name|params
operator|.
name|prev_bssid
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Trying to associate with "
name|MACSTR
literal|" (SSID='%s' freq=%d MHz)"
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|.
name|bssid
argument_list|)
argument_list|,
name|params
operator|.
name|ssid
condition|?
name|wpa_ssid_txt
argument_list|(
name|params
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid_len
argument_list|)
else|:
literal|""
argument_list|,
name|params
operator|.
name|freq
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ASSOCIATING
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|.
name|wpa_ie
operator|==
name|NULL
operator|||
name|ieee802_11_parse_elems
argument_list|(
name|params
operator|.
name|wpa_ie
argument_list|,
name|params
operator|.
name|wpa_ie_len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Could not parse own IEs?!"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|elems
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|elems
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|elems
operator|.
name|rsn_ie
condition|)
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|elems
operator|.
name|rsn_ie
operator|-
literal|2
argument_list|,
name|elems
operator|.
name|rsn_ie_len
operator|+
literal|2
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|elems
operator|.
name|wpa_ie
condition|)
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|elems
operator|.
name|wpa_ie
operator|-
literal|2
argument_list|,
name|elems
operator|.
name|wpa_ie_len
operator|+
literal|2
argument_list|)
expr_stmt|;
else|else
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_associate
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Association request to the driver "
literal|"failed"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* TODO: add timeout on association */
block|}
end_function

begin_function
name|int
name|sme_update_ft_ies
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|md
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
block|{
if|if
condition|(
name|md
operator|==
name|NULL
operator|||
name|ies
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Remove mobility domain"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies_len
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_used
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|mobility_domain
argument_list|,
name|md
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: FT IEs"
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
operator|=
name|os_malloc
argument_list|(
name|ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies_len
operator|=
name|ies_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|sme_event_assoc_reject
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|int
name|bssid_changed
decl_stmt|;
name|int
name|timeout
init|=
literal|5000
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Association with "
name|MACSTR
literal|" failed: "
literal|"status code %d"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
argument_list|,
name|data
operator|->
name|assoc_reject
operator|.
name|status_code
argument_list|)
expr_stmt|;
name|bssid_changed
operator|=
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
comment|/* 	 * For now, unconditionally terminate the previous authentication. In 	 * theory, this should not be needed, but mac80211 gets quite confused 	 * if the authentication is left pending.. Some roaming cases might 	 * benefit from using the previous authentication, so this could be 	 * optimized in the future. 	 */
if|if
condition|(
name|wpa_drv_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Deauth request to the driver failed"
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid_set
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|wpa_blacklist
modifier|*
name|b
decl_stmt|;
name|b
operator|=
name|wpa_blacklist_get
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|&&
name|b
operator|->
name|count
operator|<
literal|3
condition|)
block|{
comment|/* 			 * Speed up next attempt if there could be other APs 			 * that could accept association. 			 */
name|timeout
operator|=
literal|100
expr_stmt|;
block|}
block|}
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|bssid_changed
condition|)
name|wpas_notify_bssid_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
comment|/* 	 * TODO: if more than one possible AP is available in scan results, 	 * could try the other ones before requesting a new scan. 	 */
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|timeout
operator|/
literal|1000
argument_list|,
literal|1000
operator|*
operator|(
name|timeout
operator|%
literal|1000
operator|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_event_auth_timed_out
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Authentication timed out"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_event_assoc_timed_out
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Association timed out"
argument_list|)
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|5
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_event_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Disassociation event received"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid_set
operator|&&
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_USER_SPACE_MLME
operator|)
condition|)
block|{
comment|/* 		 * cfg80211/mac80211 can get into somewhat confused state if 		 * the AP only disassociates us and leaves us in authenticated 		 * state. For now, force the state to be cleared to avoid 		 * confusing errors if we try to associate with the AP again. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Deauthenticate to clear driver "
literal|"state"
argument_list|)
expr_stmt|;
name|wpa_drv_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant - SME  * Copyright (c) 2009-2010, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_common.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/pmksa_cache.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"wpas_glue.h"
end_include

begin_include
include|#
directive|include
file|"wps_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"p2p_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"sme.h"
end_include

begin_include
include|#
directive|include
file|"hs20_supplicant.h"
end_include

begin_define
define|#
directive|define
name|SME_AUTH_TIMEOUT
value|5
end_define

begin_define
define|#
directive|define
name|SME_ASSOC_TIMEOUT
value|5
end_define

begin_function_decl
specifier|static
name|void
name|sme_auth_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sme_assoc_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sme_obss_scan_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
end_ifdef

begin_function_decl
specifier|static
name|void
name|sme_stop_sa_query
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211W */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_SAE
end_ifdef

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|sme_auth_build_sae_commit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|4
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Transaction seq# */
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|WLAN_STATUS_SUCCESS
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|19
argument_list|)
expr_stmt|;
comment|/* Finite Cyclic Group */
comment|/* TODO: Anti-Clogging Token (if requested) */
comment|/* TODO: Scalar */
comment|/* TODO: Element */
return|return
name|buf
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|sme_auth_build_sae_confirm
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|4
operator|+
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Transaction seq# */
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|WLAN_STATUS_SUCCESS
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|sae_send_confirm
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|sae_send_confirm
operator|++
expr_stmt|;
comment|/* TODO: Confirm */
return|return
name|buf
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_SAE */
end_comment

begin_function
specifier|static
name|void
name|sme_send_authentication
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|int
name|start
parameter_list|)
block|{
name|struct
name|wpa_driver_auth_params
name|params
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|old_ssid
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
specifier|const
name|u8
modifier|*
name|md
init|=
name|NULL
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|int
name|i
decl_stmt|,
name|bssid_changed
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|resp
init|=
name|NULL
decl_stmt|;
name|u8
name|ext_capab
index|[
literal|10
index|]
decl_stmt|;
name|int
name|ext_capab_len
decl_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"SME: No scan result available for "
literal|"the network"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|current_bss
operator|=
name|bss
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|0
expr_stmt|;
name|params
operator|.
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|params
operator|.
name|bssid
operator|=
name|bss
operator|->
name|bssid
expr_stmt|;
name|params
operator|.
name|ssid
operator|=
name|bss
operator|->
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
name|params
operator|.
name|p2p
operator|=
name|ssid
operator|->
name|p2p_group
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|ssid_len
operator|!=
name|params
operator|.
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid_set
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|freq
operator|=
name|params
operator|.
name|freq
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ssid_len
operator|=
name|params
operator|.
name|ssid_len
expr_stmt|;
name|params
operator|.
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|leap
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|non_leap
operator|==
literal|0
condition|)
name|params
operator|.
name|auth_alg
operator|=
name|WPA_AUTH_ALG_LEAP
expr_stmt|;
else|else
name|params
operator|.
name|auth_alg
operator||=
name|WPA_AUTH_ALG_LEAP
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Automatic auth_alg selection: 0x%x"
argument_list|,
name|params
operator|.
name|auth_alg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|auth_alg
condition|)
block|{
name|params
operator|.
name|auth_alg
operator|=
name|ssid
operator|->
name|auth_alg
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Overriding auth_alg selection: "
literal|"0x%x"
argument_list|,
name|params
operator|.
name|auth_alg
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SAE
if|if
condition|(
name|wpa_key_mgmt_sae
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
specifier|const
name|u8
modifier|*
name|rsn
decl_stmt|;
name|struct
name|wpa_ie_data
name|ied
decl_stmt|;
name|rsn
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
if|if
condition|(
name|rsn
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|rsn
argument_list|,
literal|2
operator|+
name|rsn
index|[
literal|1
index|]
argument_list|,
operator|&
name|ied
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_key_mgmt_sae
argument_list|(
name|ied
operator|.
name|key_mgmt
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Using SAE auth_alg"
argument_list|)
expr_stmt|;
name|params
operator|.
name|auth_alg
operator|=
name|WPA_AUTH_ALG_SAE
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_SAE */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NUM_WEP_KEYS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
condition|)
name|params
operator|.
name|wep_key
index|[
name|i
index|]
operator|=
name|ssid
operator|->
name|wep_key
index|[
name|i
index|]
expr_stmt|;
name|params
operator|.
name|wep_key_len
index|[
name|i
index|]
operator|=
name|ssid
operator|->
name|wep_key_len
index|[
name|i
index|]
expr_stmt|;
block|}
name|params
operator|.
name|wep_tx_keyidx
operator|=
name|ssid
operator|->
name|wep_tx_keyidx
expr_stmt|;
name|bssid_changed
operator|=
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|bssid_changed
condition|)
name|wpas_notify_bssid_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
operator|||
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
operator|)
operator|&&
name|wpa_key_mgmt_wpa
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
name|int
name|try_opportunistic
decl_stmt|;
name|try_opportunistic
operator|=
operator|(
name|ssid
operator|->
name|proactive_key_caching
operator|<
literal|0
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|okc
else|:
name|ssid
operator|->
name|proactive_key_caching
operator|)
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
expr_stmt|;
if|if
condition|(
name|pmksa_cache_set_current
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|,
name|try_opportunistic
argument_list|)
operator|==
literal|0
condition|)
name|eapol_sm_notify_pmkid_attempt
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ssid
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|,
operator|&
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"SME: Failed to set WPA "
literal|"key management and encryption suites"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
operator|)
operator|&&
name|wpa_key_mgmt_wpa_ieee8021x
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
comment|/* 		 * Both WPA and non-WPA IEEE 802.1X enabled in configuration - 		 * use non-WPA since the scan results did not indicate that the 		 * AP is using WPA or WPA2. 		 */
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_key_mgmt_wpa_any
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_set_suites
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|ssid
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|,
operator|&
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_WARNING
argument_list|,
literal|"SME: Failed to set WPA "
literal|"key management and encryption suites (no "
literal|"scan results)"
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
name|wps_ie
operator|=
name|wps_build_assoc_req_ie
argument_list|(
name|wpas_wps_get_req_type
argument_list|(
name|ssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|&&
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
operator|<=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|)
condition|)
block|{
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|,
name|wpabuf_head
argument_list|(
name|wps_ie
argument_list|)
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
literal|0
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
block|}
else|else
block|{
name|wpa_supplicant_set_non_wpa_policy
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_MOBILITY_DOMAIN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|&&
name|ie
index|[
literal|1
index|]
operator|>=
name|MOBILITY_DOMAIN_ID_LEN
condition|)
name|md
operator|=
name|ie
operator|+
literal|2
expr_stmt|;
name|wpa_sm_set_ft_params
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ie
argument_list|,
name|ie
condition|?
literal|2
operator|+
name|ie
index|[
literal|1
index|]
else|:
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|md
condition|)
block|{
comment|/* Prepare for the next transition */
name|wpa_ft_prepare_auth_request
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ie
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|md
operator|&&
name|wpa_key_mgmt_ft
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|+
literal|5
operator|<
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|)
condition|)
block|{
name|struct
name|rsn_mdie
modifier|*
name|mdie
decl_stmt|;
name|u8
modifier|*
name|pos
init|=
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
operator|+
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
decl_stmt|;
operator|*
name|pos
operator|++
operator|=
name|WLAN_EID_MOBILITY_DOMAIN
expr_stmt|;
operator|*
name|pos
operator|++
operator|=
sizeof|sizeof
argument_list|(
operator|*
name|mdie
argument_list|)
expr_stmt|;
name|mdie
operator|=
operator|(
expr|struct
name|rsn_mdie
operator|*
operator|)
name|pos
expr_stmt|;
name|os_memcpy
argument_list|(
name|mdie
operator|->
name|mobility_domain
argument_list|,
name|md
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
expr_stmt|;
name|mdie
operator|->
name|ft_capab
operator|=
name|md
index|[
name|MOBILITY_DOMAIN_ID_LEN
index|]
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|+=
literal|5
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_used
operator|&&
name|os_memcmp
argument_list|(
name|md
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|mobility_domain
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
operator|&&
name|wpa_sm_has_ptk
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Trying to use FT "
literal|"over-the-air"
argument_list|)
expr_stmt|;
name|params
operator|.
name|auth_alg
operator|=
name|WPA_AUTH_ALG_FT
expr_stmt|;
name|params
operator|.
name|ie
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
expr_stmt|;
name|params
operator|.
name|ie_len
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies_len
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|wpa_s
operator|->
name|sme
operator|.
name|mfp
operator|=
name|ssid
operator|->
name|ieee80211w
operator|==
name|MGMT_FRAME_PROTECTION_DEFAULT
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|pmf
else|:
name|ssid
operator|->
name|ieee80211w
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|mfp
operator|!=
name|NO_MGMT_FRAME_PROTECTION
condition|)
block|{
specifier|const
name|u8
modifier|*
name|rsn
init|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
decl_stmt|;
name|struct
name|wpa_ie_data
name|_ie
decl_stmt|;
if|if
condition|(
name|rsn
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|rsn
argument_list|,
literal|2
operator|+
name|rsn
index|[
literal|1
index|]
argument_list|,
operator|&
name|_ie
argument_list|)
operator|==
literal|0
operator|&&
name|_ie
operator|.
name|capabilities
operator|&
operator|(
name|WPA_CAPABILITY_MFPC
operator||
name|WPA_CAPABILITY_MFPR
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Selected AP supports "
literal|"MFP: require MFP"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|mfp
operator|=
name|MGMT_FRAME_PROTECTION_REQUIRED
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
block|{
name|u8
modifier|*
name|pos
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|res
decl_stmt|;
name|pos
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
operator|+
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
expr_stmt|;
name|len
operator|=
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
argument_list|)
operator|-
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
expr_stmt|;
name|res
operator|=
name|wpas_p2p_assoc_req_ie
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|pos
argument_list|,
name|len
argument_list|,
name|ssid
operator|->
name|p2p_group
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>=
literal|0
condition|)
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|+=
name|res
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
ifdef|#
directive|ifdef
name|CONFIG_HS20
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|hs20
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|hs20
decl_stmt|;
name|hs20
operator|=
name|wpabuf_alloc
argument_list|(
literal|20
argument_list|)
expr_stmt|;
if|if
condition|(
name|hs20
condition|)
block|{
name|wpas_hs20_add_indication
argument_list|(
name|hs20
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
operator|+
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
argument_list|,
name|wpabuf_head
argument_list|(
name|hs20
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|hs20
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|+=
name|wpabuf_len
argument_list|(
name|hs20
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|hs20
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_HS20 */
name|ext_capab_len
operator|=
name|wpas_build_ext_capab
argument_list|(
name|wpa_s
argument_list|,
name|ext_capab
argument_list|)
expr_stmt|;
if|if
condition|(
name|ext_capab_len
operator|>
literal|0
condition|)
block|{
name|u8
modifier|*
name|pos
init|=
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|>
literal|0
operator|&&
name|pos
index|[
literal|0
index|]
operator|==
name|WLAN_EID_RSN
condition|)
name|pos
operator|+=
literal|2
operator|+
name|pos
index|[
literal|1
index|]
expr_stmt|;
name|os_memmove
argument_list|(
name|pos
operator|+
name|ext_capab_len
argument_list|,
name|pos
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|-
operator|(
name|pos
operator|-
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
operator|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
operator|+=
name|ext_capab_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|ext_capab
argument_list|,
name|ext_capab_len
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SAE
if|if
condition|(
name|params
operator|.
name|auth_alg
operator|==
name|WPA_AUTH_ALG_SAE
condition|)
block|{
if|if
condition|(
name|start
condition|)
name|resp
operator|=
name|sme_auth_build_sae_commit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
else|else
name|resp
operator|=
name|sme_auth_build_sae_confirm
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
name|params
operator|.
name|sae_data
operator|=
name|wpabuf_head
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|params
operator|.
name|sae_data_len
operator|=
name|wpabuf_len
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|sae_state
operator|=
name|start
condition|?
name|SME_SAE_COMMIT
else|:
name|SME_SAE_CONFIRM
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_SAE */
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_cancel_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"SME: Trying to authenticate with "
name|MACSTR
literal|" (SSID='%s' freq=%d MHz)"
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|.
name|bssid
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|params
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid_len
argument_list|)
argument_list|,
name|params
operator|.
name|freq
argument_list|)
expr_stmt|;
name|wpa_clear_keys
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_AUTHENTICATING
argument_list|)
expr_stmt|;
name|old_ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|ssid
expr_stmt|;
name|wpa_supplicant_rsn_supp_set_config
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_initiate_eapol
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|old_ssid
operator|!=
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpas_notify_network_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|auth_alg
operator|=
name|params
operator|.
name|auth_alg
expr_stmt|;
if|if
condition|(
name|wpa_drv_authenticate
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"SME: Authentication request to the "
literal|"driver failed"
argument_list|)
expr_stmt|;
name|wpas_connection_failed
argument_list|(
name|wpa_s
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return;
block|}
name|eloop_register_timeout
argument_list|(
name|SME_AUTH_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|sme_auth_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * Association will be started based on the authentication event from 	 * the driver. 	 */
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_authenticate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|wpa_s
operator|->
name|sme
operator|.
name|sae_state
operator|=
name|SME_SAE_INIT
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|sae_send_confirm
operator|=
literal|0
expr_stmt|;
name|sme_send_authentication
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ssid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_SAE
end_ifdef

begin_function
specifier|static
name|int
name|sme_sae_process_commit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
comment|/* Check Finite Cyclic Group */
if|if
condition|(
name|len
operator|<
literal|2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|WPA_GET_LE16
argument_list|(
name|data
argument_list|)
operator|!=
literal|19
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: Unsupported Finite Cyclic Group %u"
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* TODO */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sme_sae_process_confirm
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u16
name|rc
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
return|return
operator|-
literal|1
return|;
name|rc
operator|=
name|WPA_GET_LE16
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SAE: peer-send-confirm %u"
argument_list|,
name|rc
argument_list|)
expr_stmt|;
comment|/* TODO */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|sme_sae_auth
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u16
name|auth_transaction
parameter_list|,
name|u16
name|status_code
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: SAE authentication transaction %u "
literal|"status code %u"
argument_list|,
name|auth_transaction
argument_list|,
name|status_code
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: SAE fields"
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|status_code
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|auth_transaction
operator|==
literal|1
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME SAE commit"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_bss
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|sae_state
operator|!=
name|SME_SAE_COMMIT
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|sme_sae_process_commit
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|sme_send_authentication
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_bss
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|auth_transaction
operator|==
literal|2
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME SAE confirm"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|sae_state
operator|!=
name|SME_SAE_CONFIRM
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|sme_sae_process_confirm
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|,
name|len
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|1
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_SAE */
end_comment

begin_function
name|void
name|sme_event_auth
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Ignore authentication event "
literal|"when network is not selected"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_AUTHENTICATING
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Ignore authentication event "
literal|"when not in authenticating state"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|data
operator|->
name|auth
operator|.
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Ignore authentication with "
literal|"unexpected peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|auth
operator|.
name|peer
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Authentication response: peer="
name|MACSTR
literal|" auth_type=%d auth_transaction=%d status_code=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|data
operator|->
name|auth
operator|.
name|peer
argument_list|)
argument_list|,
name|data
operator|->
name|auth
operator|.
name|auth_type
argument_list|,
name|data
operator|->
name|auth
operator|.
name|auth_transaction
argument_list|,
name|data
operator|->
name|auth
operator|.
name|status_code
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"SME: Authentication response IEs"
argument_list|,
name|data
operator|->
name|auth
operator|.
name|ies
argument_list|,
name|data
operator|->
name|auth
operator|.
name|ies_len
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|sme_auth_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_SAE
if|if
condition|(
name|data
operator|->
name|auth
operator|.
name|auth_type
operator|==
name|WLAN_AUTH_SAE
condition|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|sme_sae_auth
argument_list|(
name|wpa_s
argument_list|,
name|data
operator|->
name|auth
operator|.
name|auth_transaction
argument_list|,
name|data
operator|->
name|auth
operator|.
name|status_code
argument_list|,
name|data
operator|->
name|auth
operator|.
name|ies
argument_list|,
name|data
operator|->
name|auth
operator|.
name|ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpas_connection_failed
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|!=
literal|1
condition|)
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_SAE */
if|if
condition|(
name|data
operator|->
name|auth
operator|.
name|status_code
operator|!=
name|WLAN_STATUS_SUCCESS
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Authentication failed (status "
literal|"code %d)"
argument_list|,
name|data
operator|->
name|auth
operator|.
name|status_code
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|auth
operator|.
name|status_code
operator|!=
name|WLAN_STATUS_NOT_SUPPORTED_AUTH_ALG
operator|||
name|wpa_s
operator|->
name|sme
operator|.
name|auth_alg
operator|==
name|data
operator|->
name|auth
operator|.
name|auth_type
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|->
name|auth_alg
operator|==
name|WPA_AUTH_ALG_LEAP
condition|)
block|{
name|wpas_connection_failed
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|data
operator|->
name|auth
operator|.
name|auth_type
condition|)
block|{
case|case
name|WLAN_AUTH_OPEN
case|:
name|wpa_s
operator|->
name|current_ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_SHARED
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Trying SHARED auth"
argument_list|)
expr_stmt|;
name|wpa_supplicant_associate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_bss
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
return|return;
case|case
name|WLAN_AUTH_SHARED_KEY
case|:
name|wpa_s
operator|->
name|current_ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_LEAP
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Trying LEAP auth"
argument_list|)
expr_stmt|;
name|wpa_supplicant_associate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_bss
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|)
expr_stmt|;
return|return;
default|default:
return|return;
block|}
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|data
operator|->
name|auth
operator|.
name|auth_type
operator|==
name|WLAN_AUTH_FT
condition|)
block|{
name|union
name|wpa_event_data
name|edata
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|edata
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|edata
argument_list|)
argument_list|)
expr_stmt|;
name|edata
operator|.
name|ft_ies
operator|.
name|ies
operator|=
name|data
operator|->
name|auth
operator|.
name|ies
expr_stmt|;
name|edata
operator|.
name|ft_ies
operator|.
name|ies_len
operator|=
name|data
operator|->
name|auth
operator|.
name|ies_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|edata
operator|.
name|ft_ies
operator|.
name|target_ap
argument_list|,
name|data
operator|->
name|auth
operator|.
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_supplicant_event
argument_list|(
name|wpa_s
argument_list|,
name|EVENT_FT_RESPONSE
argument_list|,
operator|&
name|edata
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|sme_associate
argument_list|(
name|wpa_s
argument_list|,
name|ssid
operator|->
name|mode
argument_list|,
name|data
operator|->
name|auth
operator|.
name|peer
argument_list|,
name|data
operator|->
name|auth
operator|.
name|auth_type
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_associate
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|enum
name|wpas_mode
name|mode
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u16
name|auth_type
parameter_list|)
block|{
name|struct
name|wpa_driver_associate_params
name|params
decl_stmt|;
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HT_OVERRIDES
name|struct
name|ieee80211_ht_capabilities
name|htcaps
decl_stmt|;
name|struct
name|ieee80211_ht_capabilities
name|htcaps_mask
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HT_OVERRIDES */
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|bssid
operator|=
name|bssid
expr_stmt|;
name|params
operator|.
name|ssid
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ssid
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ssid_len
expr_stmt|;
name|params
operator|.
name|freq
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|freq
expr_stmt|;
name|params
operator|.
name|bg_scan_period
operator|=
name|wpa_s
operator|->
name|current_ssid
condition|?
name|wpa_s
operator|->
name|current_ssid
operator|->
name|bg_scan_period
else|:
operator|-
literal|1
expr_stmt|;
name|params
operator|.
name|wpa_ie
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
condition|?
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie
else|:
name|NULL
expr_stmt|;
name|params
operator|.
name|wpa_ie_len
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|assoc_req_ie_len
expr_stmt|;
name|params
operator|.
name|pairwise_suite
operator|=
name|cipher_suite2driver
argument_list|(
name|wpa_s
operator|->
name|pairwise_cipher
argument_list|)
expr_stmt|;
name|params
operator|.
name|group_suite
operator|=
name|cipher_suite2driver
argument_list|(
name|wpa_s
operator|->
name|group_cipher
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HT_OVERRIDES
name|os_memset
argument_list|(
operator|&
name|htcaps
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|htcaps
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|htcaps_mask
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|htcaps_mask
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|htcaps
operator|=
operator|(
name|u8
operator|*
operator|)
operator|&
name|htcaps
expr_stmt|;
name|params
operator|.
name|htcaps_mask
operator|=
operator|(
name|u8
operator|*
operator|)
operator|&
name|htcaps_mask
expr_stmt|;
name|wpa_supplicant_apply_ht_overrides
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_HT_OVERRIDES */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211R
if|if
condition|(
name|auth_type
operator|==
name|WLAN_AUTH_FT
operator|&&
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
condition|)
block|{
name|params
operator|.
name|wpa_ie
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
expr_stmt|;
name|params
operator|.
name|wpa_ie_len
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies_len
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211R */
name|params
operator|.
name|mode
operator|=
name|mode
expr_stmt|;
name|params
operator|.
name|mgmt_frame_protection
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|mfp
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid_set
condition|)
name|params
operator|.
name|prev_bssid
operator|=
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Trying to associate with "
name|MACSTR
literal|" (SSID='%s' freq=%d MHz)"
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|.
name|bssid
argument_list|)
argument_list|,
name|params
operator|.
name|ssid
condition|?
name|wpa_ssid_txt
argument_list|(
name|params
operator|.
name|ssid
argument_list|,
name|params
operator|.
name|ssid_len
argument_list|)
else|:
literal|""
argument_list|,
name|params
operator|.
name|freq
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ASSOCIATING
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|.
name|wpa_ie
operator|==
name|NULL
operator|||
name|ieee802_11_parse_elems
argument_list|(
name|params
operator|.
name|wpa_ie
argument_list|,
name|params
operator|.
name|wpa_ie_len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Could not parse own IEs?!"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|elems
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|elems
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|elems
operator|.
name|rsn_ie
condition|)
block|{
name|params
operator|.
name|wpa_proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|elems
operator|.
name|rsn_ie
operator|-
literal|2
argument_list|,
name|elems
operator|.
name|rsn_ie_len
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|elems
operator|.
name|wpa_ie
condition|)
block|{
name|params
operator|.
name|wpa_proto
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|elems
operator|.
name|wpa_ie
operator|-
literal|2
argument_list|,
name|elems
operator|.
name|wpa_ie_len
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_sm_set_assoc_wpa_ie
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|p2p_group
condition|)
name|params
operator|.
name|p2p
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|set_sta_uapsd
condition|)
name|params
operator|.
name|uapsd
operator|=
name|wpa_s
operator|->
name|parent
operator|->
name|sta_uapsd
expr_stmt|;
else|else
name|params
operator|.
name|uapsd
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_drv_associate
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"SME: Association request to the "
literal|"driver failed"
argument_list|)
expr_stmt|;
name|wpas_connection_failed
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return;
block|}
name|eloop_register_timeout
argument_list|(
name|SME_ASSOC_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|sme_assoc_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|sme_update_ft_ies
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|md
parameter_list|,
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|)
block|{
if|if
condition|(
name|md
operator|==
name|NULL
operator|||
name|ies
operator|==
name|NULL
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Remove mobility domain"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies_len
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_used
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|mobility_domain
argument_list|,
name|md
argument_list|,
name|MOBILITY_DOMAIN_ID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: FT IEs"
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
operator|=
name|os_malloc
argument_list|(
name|ies_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies_len
operator|=
name|ies_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sme_deauth
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|bssid_changed
decl_stmt|;
name|bssid_changed
operator|=
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"SME: Deauth request to the driver "
literal|"failed"
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid_set
operator|=
literal|0
expr_stmt|;
name|wpas_connection_failed
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_DISCONNECTED
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|bssid_changed
condition|)
name|wpas_notify_bssid_changed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_event_assoc_reject
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Association with "
name|MACSTR
literal|" failed: "
literal|"status code %d"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
argument_list|,
name|data
operator|->
name|assoc_reject
operator|.
name|status_code
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|sme_assoc_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 	 * For now, unconditionally terminate the previous authentication. In 	 * theory, this should not be needed, but mac80211 gets quite confused 	 * if the authentication is left pending.. Some roaming cases might 	 * benefit from using the previous authentication, so this could be 	 * optimized in the future. 	 */
name|sme_deauth
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_event_auth_timed_out
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Authentication timed out"
argument_list|)
expr_stmt|;
name|wpas_connection_failed
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_event_assoc_timed_out
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Association timed out"
argument_list|)
expr_stmt|;
name|wpas_connection_failed
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_mark_disassoc
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_event_disassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|union
name|wpa_event_data
modifier|*
name|data
parameter_list|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Disassociation event received"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid_set
condition|)
block|{
comment|/* 		 * cfg80211/mac80211 can get into somewhat confused state if 		 * the AP only disassociates us and leaves us in authenticated 		 * state. For now, force the state to be cleared to avoid 		 * confusing errors if we try to associate with the AP again. 		 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Deauthenticate to clear "
literal|"driver state"
argument_list|)
expr_stmt|;
name|wpa_drv_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|prev_bssid
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sme_auth_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_AUTHENTICATING
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Authentication timeout"
argument_list|)
expr_stmt|;
name|sme_deauth
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sme_assoc_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_ASSOCIATING
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Association timeout"
argument_list|)
expr_stmt|;
name|sme_deauth
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|sme_state_changed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
comment|/* Make sure timers are cleaned up appropriately. */
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_ASSOCIATING
condition|)
name|eloop_cancel_timeout
argument_list|(
name|sme_assoc_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_AUTHENTICATING
condition|)
name|eloop_cancel_timeout
argument_list|(
name|sme_auth_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_disassoc_while_authenticating
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|prev_pending_bssid
parameter_list|)
block|{
comment|/* 	 * mac80211-workaround to force deauth on failed auth cmd, 	 * requires us to remain in authenticating state to allow the 	 * second authentication attempt to be continued properly. 	 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Allow pending authentication "
literal|"to proceed after disconnection event"
argument_list|)
expr_stmt|;
name|wpa_supplicant_set_state
argument_list|(
name|wpa_s
argument_list|,
name|WPA_AUTHENTICATING
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_bssid
argument_list|,
name|prev_pending_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* 	 * Re-arm authentication timer in case auth fails for whatever reason. 	 */
name|eloop_cancel_timeout
argument_list|(
name|sme_auth_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|SME_AUTH_TIMEOUT
argument_list|,
literal|0
argument_list|,
name|sme_auth_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|ft_ies_len
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
name|sme_stop_sa_query
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
name|eloop_cancel_timeout
argument_list|(
name|sme_assoc_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|sme_auth_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|sme_obss_scan_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sme_send_2040_bss_coex
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|chan_list
parameter_list|,
name|u8
name|num_channels
parameter_list|,
name|u8
name|num_intol
parameter_list|)
block|{
name|struct
name|ieee80211_2040_bss_coex_ie
modifier|*
name|bc_ie
decl_stmt|;
name|struct
name|ieee80211_2040_intol_chan_report
modifier|*
name|ic_report
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Send 20/40 BSS Coexistence to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
literal|2
operator|+
comment|/* action.category + action_code */
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_2040_bss_coex_ie
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
expr|struct
name|ieee80211_2040_intol_chan_report
argument_list|)
operator|+
name|num_channels
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
operator|==
name|NULL
condition|)
return|return;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_ACTION_PUBLIC
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_PA_20_40_BSS_COEX
argument_list|)
expr_stmt|;
name|bc_ie
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|bc_ie
argument_list|)
argument_list|)
expr_stmt|;
name|bc_ie
operator|->
name|element_id
operator|=
name|WLAN_EID_20_40_BSS_COEXISTENCE
expr_stmt|;
name|bc_ie
operator|->
name|length
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|num_intol
condition|)
name|bc_ie
operator|->
name|coex_param
operator||=
name|WLAN_20_40_BSS_COEX_20MHZ_WIDTH_REQ
expr_stmt|;
if|if
condition|(
name|num_channels
operator|>
literal|0
condition|)
block|{
name|ic_report
operator|=
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ic_report
argument_list|)
argument_list|)
expr_stmt|;
name|ic_report
operator|->
name|element_id
operator|=
name|WLAN_EID_20_40_BSS_INTOLERANT
expr_stmt|;
name|ic_report
operator|->
name|length
operator|=
name|num_channels
operator|+
literal|1
expr_stmt|;
name|ic_report
operator|->
name|op_class
operator|=
literal|0
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|num_channels
argument_list|)
argument_list|,
name|chan_list
argument_list|,
name|num_channels
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_drv_send_action
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"SME: Failed to send 20/40 BSS Coexistence frame"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * enum wpas_band - Frequency band  * @WPAS_BAND_2GHZ: 2.4 GHz ISM band  * @WPAS_BAND_5GHZ: around 5 GHz band (4.9 - 5.7 GHz)  */
end_comment

begin_enum
enum|enum
name|wpas_band
block|{
name|WPAS_BAND_2GHZ
block|,
name|WPAS_BAND_5GHZ
block|,
name|WPAS_BAND_INVALID
block|}
enum|;
end_enum

begin_comment
comment|/**  * freq_to_channel - Convert frequency into channel info  * @channel: Buffer for returning channel number  * Returns: Band (2 or 5 GHz)  */
end_comment

begin_function
specifier|static
name|enum
name|wpas_band
name|freq_to_channel
parameter_list|(
name|int
name|freq
parameter_list|,
name|u8
modifier|*
name|channel
parameter_list|)
block|{
name|enum
name|wpas_band
name|band
init|=
operator|(
name|freq
operator|<=
literal|2484
operator|)
condition|?
name|WPAS_BAND_2GHZ
else|:
name|WPAS_BAND_5GHZ
decl_stmt|;
name|u8
name|chan
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|freq
operator|>=
literal|2412
operator|&&
name|freq
operator|<=
literal|2472
condition|)
name|chan
operator|=
operator|(
name|freq
operator|-
literal|2407
operator|)
operator|/
literal|5
expr_stmt|;
elseif|else
if|if
condition|(
name|freq
operator|==
literal|2484
condition|)
name|chan
operator|=
literal|14
expr_stmt|;
elseif|else
if|if
condition|(
name|freq
operator|>=
literal|5180
operator|&&
name|freq
operator|<=
literal|5805
condition|)
name|chan
operator|=
operator|(
name|freq
operator|-
literal|5000
operator|)
operator|/
literal|5
expr_stmt|;
operator|*
name|channel
operator|=
name|chan
expr_stmt|;
return|return
name|band
return|;
block|}
end_function

begin_function
name|int
name|sme_proc_obss_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|u16
name|ht_cap
decl_stmt|;
name|u8
name|chan_list
index|[
name|P2P_MAX_CHANNELS
index|]
decl_stmt|,
name|channel
decl_stmt|;
name|u8
name|num_channels
init|=
literal|0
decl_stmt|,
name|num_intol
init|=
literal|0
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|sme
operator|.
name|sched_obss_scan
condition|)
return|return
literal|0
return|;
name|wpa_s
operator|->
name|sme
operator|.
name|sched_obss_scan
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|current_bss
operator|||
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
condition|)
return|return
literal|1
return|;
comment|/* 	 * Check whether AP uses regulatory triplet or channel triplet in 	 * country info. Right now the operating class of the BSS channel 	 * width trigger event is "unknown" (IEEE Std 802.11-2012 10.15.12), 	 * based on the assumption that operating class triplet is not used in 	 * beacon frame. If the First Channel Number/Operating Extension 	 * Identifier octet has a positive integer value of 201 or greater, 	 * then its operating class triplet. 	 * 	 * TODO: If Supported Operating Classes element is present in beacon 	 * frame, have to lookup operating class in Annex E and fill them in 	 * 2040 coex frame. 	 */
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|wpa_s
operator|->
name|current_bss
argument_list|,
name|WLAN_EID_COUNTRY
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|&&
operator|(
name|ie
index|[
literal|1
index|]
operator|>=
literal|6
operator|)
operator|&&
operator|(
name|ie
index|[
literal|5
index|]
operator|>=
literal|201
operator|)
condition|)
return|return
literal|1
return|;
name|os_memset
argument_list|(
name|chan_list
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|chan_list
argument_list|)
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
comment|/* Skip other band bss */
if|if
condition|(
name|freq_to_channel
argument_list|(
name|bss
operator|->
name|freq
argument_list|,
operator|&
name|channel
argument_list|)
operator|!=
name|WPAS_BAND_2GHZ
condition|)
continue|continue;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_HT_CAP
argument_list|)
expr_stmt|;
name|ht_cap
operator|=
operator|(
name|ie
operator|&&
operator|(
name|ie
index|[
literal|1
index|]
operator|==
literal|26
operator|)
operator|)
condition|?
name|WPA_GET_LE16
argument_list|(
name|ie
operator|+
literal|2
argument_list|)
else|:
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|ht_cap
operator|||
operator|(
name|ht_cap
operator|&
name|HT_CAP_INFO_40MHZ_INTOLERANT
operator|)
condition|)
block|{
comment|/* Check whether the channel is already considered */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_channels
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|channel
operator|==
name|chan_list
index|[
name|i
index|]
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|!=
name|num_channels
condition|)
continue|continue;
if|if
condition|(
name|ht_cap
operator|&
name|HT_CAP_INFO_40MHZ_INTOLERANT
condition|)
name|num_intol
operator|++
expr_stmt|;
name|chan_list
index|[
name|num_channels
operator|++
index|]
operator|=
name|channel
expr_stmt|;
block|}
block|}
name|sme_send_2040_bss_coex
argument_list|(
name|wpa_s
argument_list|,
name|chan_list
argument_list|,
name|num_channels
argument_list|,
name|num_intol
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_hw_modes
modifier|*
name|get_mode
parameter_list|(
name|struct
name|hostapd_hw_modes
modifier|*
name|modes
parameter_list|,
name|u16
name|num_modes
parameter_list|,
name|enum
name|hostapd_hw_mode
name|mode
parameter_list|)
block|{
name|u16
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|modes
index|[
name|i
index|]
operator|.
name|mode
operator|==
name|mode
condition|)
return|return
operator|&
name|modes
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_setband_scan_freqs_list
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|enum
name|hostapd_hw_mode
name|band
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|)
block|{
comment|/* Include only supported channels for the specified band */
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
decl_stmt|;
name|int
name|count
decl_stmt|,
name|i
decl_stmt|;
name|mode
operator|=
name|get_mode
argument_list|(
name|wpa_s
operator|->
name|hw
operator|.
name|modes
argument_list|,
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
argument_list|,
name|band
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|NULL
condition|)
block|{
comment|/* No channels supported in this band - use empty list */
name|params
operator|->
name|freqs
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|params
operator|->
name|freqs
operator|=
name|os_calloc
argument_list|(
name|mode
operator|->
name|num_channels
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|freqs
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|count
operator|=
literal|0
operator|,
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mode
operator|->
name|num_channels
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mode
operator|->
name|channels
index|[
name|i
index|]
operator|.
name|flag
operator|&
name|HOSTAPD_CHAN_DISABLED
condition|)
continue|continue;
name|params
operator|->
name|freqs
index|[
name|count
operator|++
index|]
operator|=
name|mode
operator|->
name|channels
index|[
name|i
index|]
operator|.
name|freq
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sme_obss_scan_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|wpa_driver_scan_params
name|params
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|current_bss
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME OBSS: Ignore scan request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_setband_scan_freqs_list
argument_list|(
name|wpa_s
argument_list|,
name|HOSTAPD_MODE_IEEE80211G
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME OBSS: Request an OBSS scan"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_trigger_scan
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME OBSS: Failed to trigger scan"
argument_list|)
expr_stmt|;
else|else
name|wpa_s
operator|->
name|sme
operator|.
name|sched_obss_scan
operator|=
literal|1
expr_stmt|;
name|os_free
argument_list|(
name|params
operator|.
name|freqs
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|obss_scan_int
argument_list|,
literal|0
argument_list|,
name|sme_obss_scan_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_sched_obss_scan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|enable
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
init|=
name|wpa_s
operator|->
name|current_bss
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|struct
name|hostapd_hw_modes
modifier|*
name|hw_mode
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|sme_obss_scan_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|sched_obss_scan
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|enable
condition|)
return|return;
comment|/* 	 * Schedule OBSS scan if driver is using station SME in wpa_supplicant 	 * or it expects OBSS scan to be performed by wpa_supplicant. 	 */
if|if
condition|(
operator|!
operator|(
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SME
operator|)
operator|||
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_OBSS_SCAN
operator|)
operator|)
operator|||
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|mode
operator|!=
name|IEEE80211_MODE_INFRA
condition|)
return|return;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|hw
operator|.
name|modes
condition|)
return|return;
comment|/* only HT caps in 11g mode are relevant */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
name|hw_mode
operator|=
operator|&
name|wpa_s
operator|->
name|hw
operator|.
name|modes
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|hw_mode
operator|->
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211G
condition|)
break|break;
block|}
comment|/* Driver does not support HT40 for 11g or doesn't have 11g. */
if|if
condition|(
name|i
operator|==
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
operator|||
operator|!
name|hw_mode
operator|||
operator|!
operator|(
name|hw_mode
operator|->
name|ht_capab
operator|&
name|HT_CAP_INFO_SUPP_CHANNEL_WIDTH_SET
operator|)
condition|)
return|return;
if|if
condition|(
name|bss
operator|==
name|NULL
operator|||
name|bss
operator|->
name|freq
operator|<
literal|2400
operator|||
name|bss
operator|->
name|freq
operator|>
literal|2500
condition|)
return|return;
comment|/* Not associated on 2.4 GHz band */
comment|/* Check whether AP supports HT40 */
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|wpa_s
operator|->
name|current_bss
argument_list|,
name|WLAN_EID_HT_CAP
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ie
operator|||
name|ie
index|[
literal|1
index|]
operator|<
literal|2
operator|||
operator|!
operator|(
name|WPA_GET_LE16
argument_list|(
name|ie
operator|+
literal|2
argument_list|)
operator|&
name|HT_CAP_INFO_SUPP_CHANNEL_WIDTH_SET
operator|)
condition|)
return|return;
comment|/* AP does not support HT40 */
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|wpa_s
operator|->
name|current_bss
argument_list|,
name|WLAN_EID_OVERLAPPING_BSS_SCAN_PARAMS
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ie
operator|||
name|ie
index|[
literal|1
index|]
operator|<
literal|14
condition|)
return|return;
comment|/* AP does not request OBSS scans */
name|wpa_s
operator|->
name|sme
operator|.
name|obss_scan_int
operator|=
name|WPA_GET_LE16
argument_list|(
name|ie
operator|+
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|obss_scan_int
operator|<
literal|10
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: Invalid OBSS Scan Interval %u "
literal|"replaced with the minimum 10 sec"
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|obss_scan_int
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|obss_scan_int
operator|=
literal|10
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: OBSS Scan Interval %u sec"
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|obss_scan_int
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|obss_scan_int
argument_list|,
literal|0
argument_list|,
name|sme_obss_scan_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
end_ifdef

begin_decl_stmt
specifier|static
specifier|const
name|unsigned
name|int
name|sa_query_max_timeout
init|=
literal|1000
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|unsigned
name|int
name|sa_query_retry_timeout
init|=
literal|201
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|sme_check_sa_query_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|u32
name|tu
decl_stmt|;
name|struct
name|os_time
name|now
decl_stmt|,
name|passed
decl_stmt|;
name|os_get_time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|os_time_sub
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_start
argument_list|,
operator|&
name|passed
argument_list|)
expr_stmt|;
name|tu
operator|=
operator|(
name|passed
operator|.
name|sec
operator|*
literal|1000000
operator|+
name|passed
operator|.
name|usec
operator|)
operator|/
literal|1024
expr_stmt|;
if|if
condition|(
name|sa_query_max_timeout
operator|<
name|tu
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: SA Query timed out"
argument_list|)
expr_stmt|;
name|sme_stop_sa_query
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_PREV_AUTH_NOT_VALID
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sme_send_sa_query_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|trans_id
parameter_list|)
block|{
name|u8
name|req
index|[
literal|2
operator|+
name|WLAN_SA_QUERY_TR_ID_LEN
index|]
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Sending SA Query Request to "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"SME: SA Query Transaction ID"
argument_list|,
name|trans_id
argument_list|,
name|WLAN_SA_QUERY_TR_ID_LEN
argument_list|)
expr_stmt|;
name|req
index|[
literal|0
index|]
operator|=
name|WLAN_ACTION_SA_QUERY
expr_stmt|;
name|req
index|[
literal|1
index|]
operator|=
name|WLAN_SA_QUERY_REQUEST
expr_stmt|;
name|os_memcpy
argument_list|(
name|req
operator|+
literal|2
argument_list|,
name|trans_id
argument_list|,
name|WLAN_SA_QUERY_TR_ID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_send_action
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|req
argument_list|,
sizeof|sizeof
argument_list|(
name|req
argument_list|)
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"SME: Failed to send SA Query "
literal|"Request"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sme_sa_query_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|unsigned
name|int
name|timeout
decl_stmt|,
name|sec
decl_stmt|,
name|usec
decl_stmt|;
name|u8
modifier|*
name|trans_id
decl_stmt|,
modifier|*
name|nbuf
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_count
operator|>
literal|0
operator|&&
name|sme_check_sa_query_timeout
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return;
name|nbuf
operator|=
name|os_realloc_array
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_trans_id
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_count
operator|+
literal|1
argument_list|,
name|WLAN_SA_QUERY_TR_ID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|nbuf
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_count
operator|==
literal|0
condition|)
block|{
comment|/* Starting a new SA Query procedure */
name|os_get_time
argument_list|(
operator|&
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_start
argument_list|)
expr_stmt|;
block|}
name|trans_id
operator|=
name|nbuf
operator|+
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_count
operator|*
name|WLAN_SA_QUERY_TR_ID_LEN
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_trans_id
operator|=
name|nbuf
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_count
operator|++
expr_stmt|;
name|os_get_random
argument_list|(
name|trans_id
argument_list|,
name|WLAN_SA_QUERY_TR_ID_LEN
argument_list|)
expr_stmt|;
name|timeout
operator|=
name|sa_query_retry_timeout
expr_stmt|;
name|sec
operator|=
operator|(
operator|(
name|timeout
operator|/
literal|1000
operator|)
operator|*
literal|1024
operator|)
operator|/
literal|1000
expr_stmt|;
name|usec
operator|=
operator|(
name|timeout
operator|%
literal|1000
operator|)
operator|*
literal|1024
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|sec
argument_list|,
name|usec
argument_list|,
name|sme_sa_query_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Association SA Query attempt %d"
argument_list|,
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_count
argument_list|)
expr_stmt|;
name|sme_send_sa_query_req
argument_list|(
name|wpa_s
argument_list|,
name|trans_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sme_start_sa_query
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|sme_sa_query_timer
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sme_stop_sa_query
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|sme_sa_query_timer
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_trans_id
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_trans_id
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_count
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_event_unprot_disconnect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|da
parameter_list|,
name|u16
name|reason_code
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_SME
operator|)
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
condition|)
return|return;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
operator|(
name|ssid
operator|->
name|ieee80211w
operator|==
name|MGMT_FRAME_PROTECTION_DEFAULT
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|pmf
else|:
name|ssid
operator|->
name|ieee80211w
operator|)
operator|==
name|NO_MGMT_FRAME_PROTECTION
condition|)
return|return;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
return|return;
if|if
condition|(
name|reason_code
operator|!=
name|WLAN_REASON_CLASS2_FRAME_FROM_NONAUTH_STA
operator|&&
name|reason_code
operator|!=
name|WLAN_REASON_CLASS3_FRAME_FROM_NONASSOC_STA
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_count
operator|>
literal|0
condition|)
return|return;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Unprotected disconnect dropped - "
literal|"possible AP/STA state mismatch - trigger SA Query"
argument_list|)
expr_stmt|;
name|sme_start_sa_query
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|sme_sa_query_rx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_trans_id
operator|==
name|NULL
operator|||
name|len
operator|<
literal|1
operator|+
name|WLAN_SA_QUERY_TR_ID_LEN
operator|||
name|data
index|[
literal|0
index|]
operator|!=
name|WLAN_SA_QUERY_RESPONSE
condition|)
return|return;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Received SA Query response from "
name|MACSTR
literal|" (trans_id %02x%02x)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|data
index|[
literal|1
index|]
argument_list|,
name|data
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_trans_id
operator|+
name|i
operator|*
name|WLAN_SA_QUERY_TR_ID_LEN
argument_list|,
name|data
operator|+
literal|1
argument_list|,
name|WLAN_SA_QUERY_TR_ID_LEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|wpa_s
operator|->
name|sme
operator|.
name|sa_query_count
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: No matching SA Query "
literal|"transaction identifier found"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"SME: Reply to pending SA Query received "
literal|"from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|sme_stop_sa_query
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_IEEE80211W */
end_comment

end_unit


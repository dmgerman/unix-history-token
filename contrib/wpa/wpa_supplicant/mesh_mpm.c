begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant - Basic mesh peer management  * Copyright (c) 2013-2014, cozybit, Inc.  All rights reserved.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"utils/eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/sta_info.h"
end_include

begin_include
include|#
directive|include
file|"ap/ieee802_11.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"mesh_mpm.h"
end_include

begin_include
include|#
directive|include
file|"mesh_rsn.h"
end_include

begin_struct
struct|struct
name|mesh_peer_mgmt_ie
block|{
specifier|const
name|u8
modifier|*
name|proto_id
decl_stmt|;
specifier|const
name|u8
modifier|*
name|llid
decl_stmt|;
specifier|const
name|u8
modifier|*
name|plid
decl_stmt|;
specifier|const
name|u8
modifier|*
name|reason
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pmk
decl_stmt|;
block|}
struct|;
end_struct

begin_function_decl
specifier|static
name|void
name|plink_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
function_decl|;
end_function_decl

begin_enum
enum|enum
name|plink_event
block|{
name|PLINK_UNDEFINED
block|,
name|OPN_ACPT
block|,
name|OPN_RJCT
block|,
name|OPN_IGNR
block|,
name|CNF_ACPT
block|,
name|CNF_RJCT
block|,
name|CNF_IGNR
block|,
name|CLS_ACPT
block|,
name|CLS_IGNR
block|}
enum|;
end_enum

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|mplstate
index|[]
init|=
block|{
index|[
name|PLINK_LISTEN
index|]
operator|=
literal|"LISTEN"
block|,
index|[
name|PLINK_OPEN_SENT
index|]
operator|=
literal|"OPEN_SENT"
block|,
index|[
name|PLINK_OPEN_RCVD
index|]
operator|=
literal|"OPEN_RCVD"
block|,
index|[
name|PLINK_CNF_RCVD
index|]
operator|=
literal|"CNF_RCVD"
block|,
index|[
name|PLINK_ESTAB
index|]
operator|=
literal|"ESTAB"
block|,
index|[
name|PLINK_HOLDING
index|]
operator|=
literal|"HOLDING"
block|,
index|[
name|PLINK_BLOCKED
index|]
operator|=
literal|"BLOCKED"
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
specifier|const
name|mplevent
index|[]
init|=
block|{
index|[
name|PLINK_UNDEFINED
index|]
operator|=
literal|"UNDEFINED"
block|,
index|[
name|OPN_ACPT
index|]
operator|=
literal|"OPN_ACPT"
block|,
index|[
name|OPN_RJCT
index|]
operator|=
literal|"OPN_RJCT"
block|,
index|[
name|OPN_IGNR
index|]
operator|=
literal|"OPN_IGNR"
block|,
index|[
name|CNF_ACPT
index|]
operator|=
literal|"CNF_ACPT"
block|,
index|[
name|CNF_RJCT
index|]
operator|=
literal|"CNF_RJCT"
block|,
index|[
name|CNF_IGNR
index|]
operator|=
literal|"CNF_IGNR"
block|,
index|[
name|CLS_ACPT
index|]
operator|=
literal|"CLS_ACPT"
block|,
index|[
name|CLS_IGNR
index|]
operator|=
literal|"CLS_IGNR"
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mesh_mpm_parse_peer_mgmt
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|action_field
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|len
parameter_list|,
name|struct
name|mesh_peer_mgmt_ie
modifier|*
name|mpm_ie
parameter_list|)
block|{
name|os_memset
argument_list|(
name|mpm_ie
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|mpm_ie
argument_list|)
argument_list|)
expr_stmt|;
comment|/* remove optional PMK at end */
if|if
condition|(
name|len
operator|>=
literal|16
condition|)
block|{
name|len
operator|-=
literal|16
expr_stmt|;
name|mpm_ie
operator|->
name|pmk
operator|=
name|ie
operator|+
name|len
operator|-
literal|16
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|action_field
operator|==
name|PLINK_OPEN
operator|&&
name|len
operator|!=
literal|4
operator|)
operator|||
operator|(
name|action_field
operator|==
name|PLINK_CONFIRM
operator|&&
name|len
operator|!=
literal|6
operator|)
operator|||
operator|(
name|action_field
operator|==
name|PLINK_CLOSE
operator|&&
name|len
operator|!=
literal|6
operator|&&
name|len
operator|!=
literal|8
operator|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"MPM: Invalid peer mgmt ie"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
comment|/* required fields */
if|if
condition|(
name|len
operator|<
literal|4
condition|)
return|return
operator|-
literal|1
return|;
name|mpm_ie
operator|->
name|proto_id
operator|=
name|ie
expr_stmt|;
name|mpm_ie
operator|->
name|llid
operator|=
name|ie
operator|+
literal|2
expr_stmt|;
name|ie
operator|+=
literal|4
expr_stmt|;
name|len
operator|-=
literal|4
expr_stmt|;
comment|/* close reason is always present at end for close */
if|if
condition|(
name|action_field
operator|==
name|PLINK_CLOSE
condition|)
block|{
if|if
condition|(
name|len
operator|<
literal|2
condition|)
return|return
operator|-
literal|1
return|;
name|mpm_ie
operator|->
name|reason
operator|=
name|ie
operator|+
name|len
operator|-
literal|2
expr_stmt|;
name|len
operator|-=
literal|2
expr_stmt|;
block|}
comment|/* plid, present for confirm, and possibly close */
if|if
condition|(
name|len
condition|)
name|mpm_ie
operator|->
name|plid
operator|=
name|ie
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|plink_free_count
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|)
block|{
if|if
condition|(
name|hapd
operator|->
name|max_plinks
operator|>
name|hapd
operator|->
name|num_plinks
condition|)
return|return
name|hapd
operator|->
name|max_plinks
operator|-
name|hapd
operator|->
name|num_plinks
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|u16
name|copy_supp_rates
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|struct
name|ieee802_11_elems
modifier|*
name|elems
parameter_list|)
block|{
if|if
condition|(
operator|!
name|elems
operator|->
name|supp_rates
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"no supported rates from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
if|if
condition|(
name|elems
operator|->
name|supp_rates_len
operator|+
name|elems
operator|->
name|ext_supp_rates_len
operator|>
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|supported_rates
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Invalid supported rates element length "
name|MACSTR
literal|" %d+%d"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|elems
operator|->
name|supp_rates_len
argument_list|,
name|elems
operator|->
name|ext_supp_rates_len
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_UNSPECIFIED_FAILURE
return|;
block|}
name|sta
operator|->
name|supported_rates_len
operator|=
name|merge_byte_arrays
argument_list|(
name|sta
operator|->
name|supported_rates
argument_list|,
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|supported_rates
argument_list|)
argument_list|,
name|elems
operator|->
name|supp_rates
argument_list|,
name|elems
operator|->
name|supp_rates_len
argument_list|,
name|elems
operator|->
name|ext_supp_rates
argument_list|,
name|elems
operator|->
name|ext_supp_rates_len
argument_list|)
expr_stmt|;
return|return
name|WLAN_STATUS_SUCCESS
return|;
block|}
end_function

begin_comment
comment|/* return true if elems from a neighbor match this MBSS */
end_comment

begin_function
specifier|static
name|Boolean
name|matches_local
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|ieee802_11_elems
modifier|*
name|elems
parameter_list|)
block|{
name|struct
name|mesh_conf
modifier|*
name|mconf
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|mconf
decl_stmt|;
if|if
condition|(
name|elems
operator|->
name|mesh_config_len
operator|<
literal|5
condition|)
return|return
name|FALSE
return|;
return|return
operator|(
name|mconf
operator|->
name|meshid_len
operator|==
name|elems
operator|->
name|mesh_id_len
operator|&&
name|os_memcmp
argument_list|(
name|mconf
operator|->
name|meshid
argument_list|,
name|elems
operator|->
name|mesh_id
argument_list|,
name|elems
operator|->
name|mesh_id_len
argument_list|)
operator|==
literal|0
operator|&&
name|mconf
operator|->
name|mesh_pp_id
operator|==
name|elems
operator|->
name|mesh_config
index|[
literal|0
index|]
operator|&&
name|mconf
operator|->
name|mesh_pm_id
operator|==
name|elems
operator|->
name|mesh_config
index|[
literal|1
index|]
operator|&&
name|mconf
operator|->
name|mesh_cc_id
operator|==
name|elems
operator|->
name|mesh_config
index|[
literal|2
index|]
operator|&&
name|mconf
operator|->
name|mesh_sp_id
operator|==
name|elems
operator|->
name|mesh_config
index|[
literal|3
index|]
operator|&&
name|mconf
operator|->
name|mesh_auth_id
operator|==
name|elems
operator|->
name|mesh_config
index|[
literal|4
index|]
operator|)
return|;
block|}
end_function

begin_comment
comment|/* check if local link id is already used with another peer */
end_comment

begin_function
specifier|static
name|Boolean
name|llid_in_use
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u16
name|llid
parameter_list|)
block|{
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
for|for
control|(
name|sta
operator|=
name|hapd
operator|->
name|sta_list
init|;
name|sta
condition|;
name|sta
operator|=
name|sta
operator|->
name|next
control|)
block|{
if|if
condition|(
name|sta
operator|->
name|my_lid
operator|==
name|llid
condition|)
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/* generate an llid for a link and set to initial state */
end_comment

begin_function
specifier|static
name|void
name|mesh_mpm_init_link
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|u16
name|llid
decl_stmt|;
do|do
block|{
if|if
condition|(
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|llid
argument_list|,
sizeof|sizeof
argument_list|(
name|llid
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
continue|continue;
block|}
do|while
condition|(
operator|!
name|llid
operator|||
name|llid_in_use
argument_list|(
name|wpa_s
argument_list|,
name|llid
argument_list|)
condition|)
do|;
name|sta
operator|->
name|my_lid
operator|=
name|llid
expr_stmt|;
name|sta
operator|->
name|peer_lid
operator|=
literal|0
expr_stmt|;
comment|/* 	 * We do not use wpa_mesh_set_plink_state() here because there is no 	 * entry in kernel yet. 	 */
name|sta
operator|->
name|plink_state
operator|=
name|PLINK_LISTEN
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mesh_mpm_send_plink_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|enum
name|plink_action_field
name|type
parameter_list|,
name|u16
name|close_reason
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|buf
decl_stmt|;
name|struct
name|hostapd_iface
modifier|*
name|ifmsh
init|=
name|wpa_s
operator|->
name|ifmsh
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|bss
init|=
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|mesh_conf
modifier|*
name|conf
init|=
name|ifmsh
operator|->
name|mconf
decl_stmt|;
name|u8
name|supp_rates
index|[
literal|2
operator|+
literal|2
operator|+
literal|32
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211N
name|u8
name|ht_capa_oper
index|[
literal|2
operator|+
literal|26
operator|+
literal|2
operator|+
literal|22
index|]
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211N */
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|cat
decl_stmt|;
name|u8
name|ie_len
decl_stmt|,
name|add_plid
init|=
literal|0
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|int
name|ampe
init|=
name|conf
operator|->
name|security
operator|&
name|MESH_CONF_SEC_AMPE
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
return|return;
name|buf_len
operator|=
literal|2
operator|+
comment|/* capability info */
literal|2
operator|+
comment|/* AID */
literal|2
operator|+
literal|8
operator|+
comment|/* supported rates */
literal|2
operator|+
operator|(
literal|32
operator|-
literal|8
operator|)
operator|+
literal|2
operator|+
literal|32
operator|+
comment|/* mesh ID */
literal|2
operator|+
literal|7
operator|+
comment|/* mesh config */
literal|2
operator|+
literal|23
operator|+
comment|/* peering management */
literal|2
operator|+
literal|96
operator|+
comment|/* AMPE */
literal|2
operator|+
literal|16
expr_stmt|;
comment|/* MIC */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211N
if|if
condition|(
name|type
operator|!=
name|PLINK_CLOSE
operator|&&
name|wpa_s
operator|->
name|mesh_ht_enabled
condition|)
block|{
name|buf_len
operator|+=
literal|2
operator|+
literal|26
operator|+
comment|/* HT capabilities */
literal|2
operator|+
literal|22
expr_stmt|;
comment|/* HT operation */
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211N */
if|if
condition|(
name|type
operator|!=
name|PLINK_CLOSE
condition|)
name|buf_len
operator|+=
name|conf
operator|->
name|rsn_ie_len
expr_stmt|;
comment|/* RSN IE */
name|buf
operator|=
name|wpabuf_alloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|buf
condition|)
return|return;
name|cat
operator|=
name|wpabuf_mhead_u8
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_ACTION_SELF_PROTECTED
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|PLINK_CLOSE
condition|)
block|{
name|u8
name|info
decl_stmt|;
comment|/* capability info */
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|ampe
condition|?
name|IEEE80211_CAP_PRIVACY
else|:
literal|0
argument_list|)
expr_stmt|;
comment|/* aid */
if|if
condition|(
name|type
operator|==
name|PLINK_CONFIRM
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|sta
operator|->
name|peer_lid
argument_list|)
expr_stmt|;
comment|/* IE: supp + ext. supp rates */
name|pos
operator|=
name|hostapd_eid_supp_rates
argument_list|(
name|bss
argument_list|,
name|supp_rates
argument_list|)
expr_stmt|;
name|pos
operator|=
name|hostapd_eid_ext_supp_rates
argument_list|(
name|bss
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|supp_rates
argument_list|,
name|pos
operator|-
name|supp_rates
argument_list|)
expr_stmt|;
comment|/* IE: RSN IE */
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|conf
operator|->
name|rsn_ie
argument_list|,
name|conf
operator|->
name|rsn_ie_len
argument_list|)
expr_stmt|;
comment|/* IE: Mesh ID */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_EID_MESH_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|conf
operator|->
name|meshid_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|conf
operator|->
name|meshid
argument_list|,
name|conf
operator|->
name|meshid_len
argument_list|)
expr_stmt|;
comment|/* IE: mesh conf */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_EID_MESH_CONFIG
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|7
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|conf
operator|->
name|mesh_pp_id
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|conf
operator|->
name|mesh_pm_id
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|conf
operator|->
name|mesh_cc_id
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|conf
operator|->
name|mesh_sp_id
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|conf
operator|->
name|mesh_auth_id
argument_list|)
expr_stmt|;
name|info
operator|=
operator|(
name|bss
operator|->
name|num_plinks
operator|>
literal|63
condition|?
literal|63
else|:
name|bss
operator|->
name|num_plinks
operator|)
operator|<<
literal|1
expr_stmt|;
comment|/* TODO: Add Connected to Mesh Gate/AS subfields */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|info
argument_list|)
expr_stmt|;
comment|/* always forwarding& accepting plinks for now */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
literal|0x1
operator||
literal|0x8
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Peer closing frame */
comment|/* IE: Mesh ID */
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_EID_MESH_ID
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|conf
operator|->
name|meshid_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|conf
operator|->
name|meshid
argument_list|,
name|conf
operator|->
name|meshid_len
argument_list|)
expr_stmt|;
block|}
comment|/* IE: Mesh Peering Management element */
name|ie_len
operator|=
literal|4
expr_stmt|;
if|if
condition|(
name|ampe
condition|)
name|ie_len
operator|+=
name|PMKID_LEN
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|PLINK_OPEN
case|:
break|break;
case|case
name|PLINK_CONFIRM
case|:
name|ie_len
operator|+=
literal|2
expr_stmt|;
name|add_plid
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|PLINK_CLOSE
case|:
name|ie_len
operator|+=
literal|2
expr_stmt|;
name|add_plid
operator|=
literal|1
expr_stmt|;
name|ie_len
operator|+=
literal|2
expr_stmt|;
comment|/* reason code */
break|break;
block|}
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|WLAN_EID_PEER_MGMT
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|buf
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
comment|/* peering protocol */
if|if
condition|(
name|ampe
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|sta
operator|->
name|my_lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|add_plid
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|sta
operator|->
name|peer_lid
argument_list|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
name|PLINK_CLOSE
condition|)
name|wpabuf_put_le16
argument_list|(
name|buf
argument_list|,
name|close_reason
argument_list|)
expr_stmt|;
if|if
condition|(
name|ampe
condition|)
block|{
if|if
condition|(
name|sta
operator|->
name|sae
operator|==
name|NULL
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Mesh MPM: no SAE session"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|mesh_rsn_get_pmkid
argument_list|(
name|wpa_s
operator|->
name|mesh_rsn
argument_list|,
name|sta
argument_list|,
name|wpabuf_put
argument_list|(
name|buf
argument_list|,
name|PMKID_LEN
argument_list|)
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211N
if|if
condition|(
name|type
operator|!=
name|PLINK_CLOSE
operator|&&
name|wpa_s
operator|->
name|mesh_ht_enabled
condition|)
block|{
name|pos
operator|=
name|hostapd_eid_ht_capabilities
argument_list|(
name|bss
argument_list|,
name|ht_capa_oper
argument_list|)
expr_stmt|;
name|pos
operator|=
name|hostapd_eid_ht_operation
argument_list|(
name|bss
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|buf
argument_list|,
name|ht_capa_oper
argument_list|,
name|pos
operator|-
name|ht_capa_oper
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_IEEE80211N */
if|if
condition|(
name|ampe
operator|&&
name|mesh_rsn_protect_frame
argument_list|(
name|wpa_s
operator|->
name|mesh_rsn
argument_list|,
name|sta
argument_list|,
name|cat
argument_list|,
name|buf
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Mesh MPM: failed to add AMPE and MIC IE"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|ret
operator|=
name|wpa_drv_send_action
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
literal|0
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"Mesh MPM: failed to send peering frame"
argument_list|)
expr_stmt|;
name|fail
label|:
name|wpabuf_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* configure peering state in ours and driver's station entry */
end_comment

begin_function
name|void
name|wpa_mesh_set_plink_state
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|enum
name|mesh_plink_state
name|state
parameter_list|)
block|{
name|struct
name|hostapd_sta_add_params
name|params
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|sta
operator|->
name|plink_state
operator|=
name|state
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|addr
operator|=
name|sta
operator|->
name|addr
expr_stmt|;
name|params
operator|.
name|plink_state
operator|=
name|state
expr_stmt|;
name|params
operator|.
name|set
operator|=
literal|1
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"MPM set "
name|MACSTR
literal|" into %s"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|mplstate
index|[
name|state
index|]
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_drv_sta_add
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Driver failed to set "
name|MACSTR
literal|": %d"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|mesh_mpm_fsm_restart
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|ap_free_sta
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|plink_timer
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
init|=
name|user_data
decl_stmt|;
name|u16
name|reason
init|=
literal|0
decl_stmt|;
name|struct
name|mesh_conf
modifier|*
name|conf
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|mconf
decl_stmt|;
switch|switch
condition|(
name|sta
operator|->
name|plink_state
condition|)
block|{
case|case
name|PLINK_OPEN_RCVD
case|:
case|case
name|PLINK_OPEN_SENT
case|:
comment|/* retry timer */
if|if
condition|(
name|sta
operator|->
name|mpm_retries
operator|<
name|conf
operator|->
name|dot11MeshMaxRetries
condition|)
block|{
name|eloop_register_timeout
argument_list|(
name|conf
operator|->
name|dot11MeshRetryTimeout
operator|/
literal|1000
argument_list|,
operator|(
name|conf
operator|->
name|dot11MeshRetryTimeout
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_OPEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sta
operator|->
name|mpm_retries
operator|++
expr_stmt|;
break|break;
block|}
name|reason
operator|=
name|WLAN_REASON_MESH_MAX_RETRIES
expr_stmt|;
comment|/* fall through on else */
case|case
name|PLINK_CNF_RCVD
case|:
comment|/* confirm timer */
if|if
condition|(
operator|!
name|reason
condition|)
name|reason
operator|=
name|WLAN_REASON_MESH_CONFIRM_TIMEOUT
expr_stmt|;
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_HOLDING
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|/
literal|1000
argument_list|,
operator|(
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CLOSE
argument_list|,
name|reason
argument_list|)
expr_stmt|;
break|break;
case|case
name|PLINK_HOLDING
case|:
comment|/* holding timer */
name|mesh_mpm_fsm_restart
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

begin_comment
comment|/* initiate peering with station */
end_comment

begin_function
specifier|static
name|void
name|mesh_mpm_plink_open
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|enum
name|mesh_plink_state
name|next_state
parameter_list|)
block|{
name|struct
name|mesh_conf
modifier|*
name|conf
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|mconf
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|conf
operator|->
name|dot11MeshRetryTimeout
operator|/
literal|1000
argument_list|,
operator|(
name|conf
operator|->
name|dot11MeshRetryTimeout
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_OPEN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|next_state
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|mesh_mpm_plink_close
parameter_list|(
name|struct
name|hostapd_data
modifier|*
name|hapd
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|int
name|reason
init|=
name|WLAN_REASON_MESH_PEERING_CANCELLED
decl_stmt|;
if|if
condition|(
name|sta
condition|)
block|{
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_HOLDING
argument_list|)
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CLOSE
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM closing plink sta="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|mesh_mpm_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|hostapd_iface
modifier|*
name|ifmsh
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
comment|/* notify peers we're leaving */
name|ap_for_each_sta
argument_list|(
name|hapd
argument_list|,
name|mesh_mpm_plink_close
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|num_plinks
operator|=
literal|0
expr_stmt|;
name|hostapd_free_stas
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* for mesh_rsn to indicate this peer has completed authentication, and we're  * ready to start AMPE */
end_comment

begin_function
name|void
name|mesh_mpm_auth_peer
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|data
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|hostapd_sta_add_params
name|params
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|data
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"no such mesh peer"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* TODO: Should do nothing if this STA is already authenticated, but 	 * the AP code already sets this flag. */
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_AUTH
expr_stmt|;
name|mesh_rsn_init_ampe_sta
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|addr
operator|=
name|sta
operator|->
name|addr
expr_stmt|;
name|params
operator|.
name|flags
operator|=
name|WPA_STA_AUTHENTICATED
operator||
name|WPA_STA_AUTHORIZED
expr_stmt|;
name|params
operator|.
name|set
operator|=
literal|1
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"MPM authenticating "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpa_drv_sta_add
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Driver failed to set "
name|MACSTR
literal|": %d"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|sta
operator|->
name|my_lid
condition|)
name|mesh_mpm_init_link
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|mesh_mpm_plink_open
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_OPEN_SENT
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Initialize a sta_info structure for a peer and upload it into the driver  * in preparation for beginning authentication or peering. This is done when a  * Beacon (secure or open mesh) or a peering open frame (for open mesh) is  * received from the peer for the first time.  */
end_comment

begin_function
specifier|static
name|struct
name|sta_info
modifier|*
name|mesh_mpm_add_peer
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|struct
name|ieee802_11_elems
modifier|*
name|elems
parameter_list|)
block|{
name|struct
name|hostapd_sta_add_params
name|params
decl_stmt|;
name|struct
name|mesh_conf
modifier|*
name|conf
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|mconf
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|data
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|data
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
block|{
name|sta
operator|=
name|ap_sta_add
argument_list|(
name|data
argument_list|,
name|addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
return|return
name|NULL
return|;
block|}
comment|/* initialize sta */
if|if
condition|(
name|copy_supp_rates
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|elems
argument_list|)
condition|)
block|{
name|ap_free_sta
argument_list|(
name|data
argument_list|,
name|sta
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|mesh_mpm_init_link
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211N
name|copy_sta_ht_capab
argument_list|(
name|data
argument_list|,
name|sta
argument_list|,
name|elems
operator|->
name|ht_capabilities
argument_list|)
expr_stmt|;
name|update_ht_state
argument_list|(
name|data
argument_list|,
name|sta
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211N */
comment|/* insert into driver */
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|supp_rates
operator|=
name|sta
operator|->
name|supported_rates
expr_stmt|;
name|params
operator|.
name|supp_rates_len
operator|=
name|sta
operator|->
name|supported_rates_len
expr_stmt|;
name|params
operator|.
name|addr
operator|=
name|addr
expr_stmt|;
name|params
operator|.
name|plink_state
operator|=
name|sta
operator|->
name|plink_state
expr_stmt|;
name|params
operator|.
name|aid
operator|=
name|sta
operator|->
name|peer_lid
expr_stmt|;
name|params
operator|.
name|listen_interval
operator|=
literal|100
expr_stmt|;
name|params
operator|.
name|ht_capabilities
operator|=
name|sta
operator|->
name|ht_capabilities
expr_stmt|;
name|params
operator|.
name|flags
operator||=
name|WPA_STA_WMM
expr_stmt|;
name|params
operator|.
name|flags_mask
operator||=
name|WPA_STA_AUTHENTICATED
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|security
operator|==
name|MESH_CONF_SEC_NONE
condition|)
block|{
name|params
operator|.
name|flags
operator||=
name|WPA_STA_AUTHORIZED
expr_stmt|;
name|params
operator|.
name|flags
operator||=
name|WPA_STA_AUTHENTICATED
expr_stmt|;
block|}
else|else
block|{
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_MFP
expr_stmt|;
name|params
operator|.
name|flags
operator||=
name|WPA_STA_MFP
expr_stmt|;
block|}
name|ret
operator|=
name|wpa_drv_sta_add
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"Driver failed to insert "
name|MACSTR
literal|": %d"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|ap_free_sta
argument_list|(
name|data
argument_list|,
name|sta
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|sta
return|;
block|}
end_function

begin_function
name|void
name|wpa_mesh_new_mesh_peer
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|struct
name|ieee802_11_elems
modifier|*
name|elems
parameter_list|)
block|{
name|struct
name|mesh_conf
modifier|*
name|conf
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|mconf
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|data
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|sta
operator|=
name|mesh_mpm_add_peer
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|elems
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
return|return;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|no_auto_peer
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"will not initiate new peer link with "
name|MACSTR
literal|" because of no_auto_peer"
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|data
operator|->
name|mesh_pending_auth
condition|)
block|{
name|struct
name|os_reltime
name|age
decl_stmt|;
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|struct
name|hostapd_frame_info
name|fi
decl_stmt|;
name|mgmt
operator|=
name|wpabuf_head
argument_list|(
name|data
operator|->
name|mesh_pending_auth
argument_list|)
expr_stmt|;
name|os_reltime_age
argument_list|(
operator|&
name|data
operator|->
name|mesh_pending_auth_time
argument_list|,
operator|&
name|age
argument_list|)
expr_stmt|;
if|if
condition|(
name|age
operator|.
name|sec
operator|<
literal|2
operator|&&
name|os_memcmp
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"mesh: Process pending Authentication frame from %u.%06u seconds ago"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|age
operator|.
name|sec
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|age
operator|.
name|usec
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|fi
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fi
argument_list|)
argument_list|)
expr_stmt|;
name|ieee802_11_mgmt
argument_list|(
name|data
argument_list|,
name|wpabuf_head
argument_list|(
name|data
operator|->
name|mesh_pending_auth
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|data
operator|->
name|mesh_pending_auth
argument_list|)
argument_list|,
operator|&
name|fi
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|data
operator|->
name|mesh_pending_auth
argument_list|)
expr_stmt|;
name|data
operator|->
name|mesh_pending_auth
operator|=
name|NULL
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|conf
operator|->
name|security
operator|==
name|MESH_CONF_SEC_NONE
condition|)
name|mesh_mpm_plink_open
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_OPEN_SENT
argument_list|)
expr_stmt|;
else|else
name|mesh_rsn_auth_sae_sta
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|mesh_mpm_mgmt_rx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|rx_mgmt
modifier|*
name|rx_mgmt
parameter_list|)
block|{
name|struct
name|hostapd_frame_info
name|fi
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|fi
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|fi
argument_list|)
argument_list|)
expr_stmt|;
name|fi
operator|.
name|datarate
operator|=
name|rx_mgmt
operator|->
name|datarate
expr_stmt|;
name|fi
operator|.
name|ssi_signal
operator|=
name|rx_mgmt
operator|->
name|ssi_signal
expr_stmt|;
name|ieee802_11_mgmt
argument_list|(
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
argument_list|,
name|rx_mgmt
operator|->
name|frame
argument_list|,
name|rx_mgmt
operator|->
name|frame_len
argument_list|,
operator|&
name|fi
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mesh_mpm_plink_estab
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|mesh_conf
modifier|*
name|conf
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|mconf
decl_stmt|;
name|u8
name|seq
index|[
literal|6
index|]
init|=
block|{}
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"mesh plink with "
name|MACSTR
literal|" established"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|conf
operator|->
name|security
operator|&
name|MESH_CONF_SEC_AMPE
condition|)
block|{
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_CCMP
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|seq
argument_list|,
sizeof|sizeof
argument_list|(
name|seq
argument_list|)
argument_list|,
name|sta
operator|->
name|mtk
argument_list|,
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|mtk
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_CCMP
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|seq
argument_list|,
sizeof|sizeof
argument_list|(
name|seq
argument_list|)
argument_list|,
name|sta
operator|->
name|mgtk
argument_list|,
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|mgtk
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_drv_set_key
argument_list|(
name|wpa_s
argument_list|,
name|WPA_ALG_IGTK
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|,
name|seq
argument_list|,
sizeof|sizeof
argument_list|(
name|seq
argument_list|)
argument_list|,
name|sta
operator|->
name|mgtk
argument_list|,
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|mgtk
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"mtk:"
argument_list|,
name|sta
operator|->
name|mtk
argument_list|,
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|mtk
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"mgtk:"
argument_list|,
name|sta
operator|->
name|mgtk
argument_list|,
sizeof|sizeof
argument_list|(
name|sta
operator|->
name|mgtk
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_ESTAB
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|num_plinks
operator|++
expr_stmt|;
name|sta
operator|->
name|flags
operator||=
name|WLAN_STA_ASSOC
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
comment|/* Send ctrl event */
name|wpa_msg_ctrl
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|MESH_PEER_CONNECTED MACSTR
argument_list|,
argument|MAC2STR(sta->addr)
argument_list|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|mesh_mpm_fsm
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|,
name|enum
name|plink_event
name|event
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|mesh_conf
modifier|*
name|conf
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|mconf
decl_stmt|;
name|u16
name|reason
init|=
literal|0
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"MPM "
name|MACSTR
literal|" state %s event %s"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|mplstate
index|[
name|sta
operator|->
name|plink_state
index|]
argument_list|,
name|mplevent
index|[
name|event
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|sta
operator|->
name|plink_state
condition|)
block|{
case|case
name|PLINK_LISTEN
case|:
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|CLS_ACPT
case|:
name|mesh_mpm_fsm_restart
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPN_ACPT
case|:
name|mesh_mpm_plink_open
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_OPEN_RCVD
argument_list|)
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CONFIRM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|PLINK_OPEN_SENT
case|:
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|OPN_RJCT
case|:
case|case
name|CNF_RJCT
case|:
name|reason
operator|=
name|WLAN_REASON_MESH_CONFIG_POLICY_VIOLATION
expr_stmt|;
comment|/* fall-through */
case|case
name|CLS_ACPT
case|:
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_HOLDING
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reason
condition|)
name|reason
operator|=
name|WLAN_REASON_MESH_CLOSE_RCVD
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|/
literal|1000
argument_list|,
operator|(
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CLOSE
argument_list|,
name|reason
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPN_ACPT
case|:
comment|/* retry timer is left untouched */
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_OPEN_RCVD
argument_list|)
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CONFIRM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CNF_ACPT
case|:
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CNF_RCVD
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|conf
operator|->
name|dot11MeshConfirmTimeout
operator|/
literal|1000
argument_list|,
operator|(
name|conf
operator|->
name|dot11MeshConfirmTimeout
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|PLINK_OPEN_RCVD
case|:
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|OPN_RJCT
case|:
case|case
name|CNF_RJCT
case|:
name|reason
operator|=
name|WLAN_REASON_MESH_CONFIG_POLICY_VIOLATION
expr_stmt|;
comment|/* fall-through */
case|case
name|CLS_ACPT
case|:
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_HOLDING
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reason
condition|)
name|reason
operator|=
name|WLAN_REASON_MESH_CLOSE_RCVD
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|/
literal|1000
argument_list|,
operator|(
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|sta
operator|->
name|mpm_close_reason
operator|=
name|reason
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CLOSE
argument_list|,
name|reason
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPN_ACPT
case|:
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CONFIRM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
name|CNF_ACPT
case|:
if|if
condition|(
name|conf
operator|->
name|security
operator|&
name|MESH_CONF_SEC_AMPE
condition|)
name|mesh_rsn_derive_mtk
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|mesh_mpm_plink_estab
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|PLINK_CNF_RCVD
case|:
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|OPN_RJCT
case|:
case|case
name|CNF_RJCT
case|:
name|reason
operator|=
name|WLAN_REASON_MESH_CONFIG_POLICY_VIOLATION
expr_stmt|;
comment|/* fall-through */
case|case
name|CLS_ACPT
case|:
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_HOLDING
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reason
condition|)
name|reason
operator|=
name|WLAN_REASON_MESH_CLOSE_RCVD
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|/
literal|1000
argument_list|,
operator|(
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|sta
operator|->
name|mpm_close_reason
operator|=
name|reason
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CLOSE
argument_list|,
name|reason
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPN_ACPT
case|:
name|mesh_mpm_plink_estab
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CONFIRM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|PLINK_ESTAB
case|:
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|CLS_ACPT
case|:
name|wpa_mesh_set_plink_state
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_HOLDING
argument_list|)
expr_stmt|;
name|reason
operator|=
name|WLAN_REASON_MESH_CLOSE_RCVD
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|/
literal|1000
argument_list|,
operator|(
name|conf
operator|->
name|dot11MeshHoldingTimeout
operator|%
literal|1000
operator|)
operator|*
literal|1000
argument_list|,
name|plink_timer
argument_list|,
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|sta
operator|->
name|mpm_close_reason
operator|=
name|reason
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"mesh plink with "
name|MACSTR
literal|" closed with reason %d"
argument_list|,
name|MAC2STR
argument_list|(
name|sta
operator|->
name|addr
argument_list|)
argument_list|,
name|reason
argument_list|)
expr_stmt|;
name|wpa_msg_ctrl
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|MESH_PEER_DISCONNECTED MACSTR
argument_list|,
argument|MAC2STR(sta->addr)
argument_list|)
empty_stmt|;
name|hapd
operator|->
name|num_plinks
operator|--
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CLOSE
argument_list|,
name|reason
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPN_ACPT
case|:
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CONFIRM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
case|case
name|PLINK_HOLDING
case|:
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|CLS_ACPT
case|:
name|mesh_mpm_fsm_restart
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
break|break;
case|case
name|OPN_ACPT
case|:
case|case
name|CNF_ACPT
case|:
case|case
name|OPN_RJCT
case|:
case|case
name|CNF_RJCT
case|:
name|reason
operator|=
name|sta
operator|->
name|mpm_close_reason
expr_stmt|;
name|mesh_mpm_send_plink_action
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|PLINK_CLOSE
argument_list|,
name|reason
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
default|default:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"Unsupported MPM event %s for state %s"
argument_list|,
name|mplevent
index|[
name|event
index|]
argument_list|,
name|mplstate
index|[
name|sta
operator|->
name|plink_state
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|mesh_mpm_action_rx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|u8
name|action_field
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
name|struct
name|mesh_conf
modifier|*
name|mconf
init|=
name|wpa_s
operator|->
name|ifmsh
operator|->
name|mconf
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
name|u16
name|plid
init|=
literal|0
decl_stmt|,
name|llid
init|=
literal|0
decl_stmt|;
name|enum
name|plink_event
name|event
decl_stmt|;
name|struct
name|ieee802_11_elems
name|elems
decl_stmt|;
name|struct
name|mesh_peer_mgmt_ie
name|peer_mgmt_ie
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ies
decl_stmt|;
name|size_t
name|ie_len
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|!=
name|WLAN_ACTION_SELF_PROTECTED
condition|)
return|return;
name|action_field
operator|=
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|slf_prot_action
operator|.
name|action
expr_stmt|;
if|if
condition|(
name|action_field
operator|!=
name|PLINK_OPEN
operator|&&
name|action_field
operator|!=
name|PLINK_CONFIRM
operator|&&
name|action_field
operator|!=
name|PLINK_CLOSE
condition|)
return|return;
name|ies
operator|=
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|slf_prot_action
operator|.
name|variable
expr_stmt|;
name|ie_len
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
name|mgmt
operator|+
name|len
operator|-
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|slf_prot_action
operator|.
name|variable
expr_stmt|;
comment|/* at least expect mesh id and peering mgmt */
if|if
condition|(
name|ie_len
operator|<
literal|2
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: Ignore too short action frame %u ie_len %u"
argument_list|,
name|action_field
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ie_len
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: Received PLINK action %u"
argument_list|,
name|action_field
argument_list|)
expr_stmt|;
if|if
condition|(
name|action_field
operator|==
name|PLINK_OPEN
operator|||
name|action_field
operator|==
name|PLINK_CONFIRM
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: Capability 0x%x"
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|ies
argument_list|)
argument_list|)
expr_stmt|;
name|ies
operator|+=
literal|2
expr_stmt|;
comment|/* capability */
name|ie_len
operator|-=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|action_field
operator|==
name|PLINK_CONFIRM
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: AID 0x%x"
argument_list|,
name|WPA_GET_LE16
argument_list|(
name|ies
argument_list|)
argument_list|)
expr_stmt|;
name|ies
operator|+=
literal|2
expr_stmt|;
comment|/* aid */
name|ie_len
operator|-=
literal|2
expr_stmt|;
block|}
comment|/* check for mesh peering, mesh id and mesh config IEs */
if|if
condition|(
name|ieee802_11_parse_elems
argument_list|(
name|ies
argument_list|,
name|ie_len
argument_list|,
operator|&
name|elems
argument_list|,
literal|0
argument_list|)
operator|==
name|ParseFailed
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: Failed to parse PLINK IEs"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|elems
operator|.
name|peer_mgmt
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: No Mesh Peering Management element"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|action_field
operator|!=
name|PLINK_CLOSE
condition|)
block|{
if|if
condition|(
operator|!
name|elems
operator|.
name|mesh_id
operator|||
operator|!
name|elems
operator|.
name|mesh_config
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: No Mesh ID or Mesh Configuration element"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|matches_local
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|elems
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: Mesh ID or Mesh Configuration element do not match local MBSS"
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|ret
operator|=
name|mesh_mpm_parse_peer_mgmt
argument_list|(
name|wpa_s
argument_list|,
name|action_field
argument_list|,
name|elems
operator|.
name|peer_mgmt
argument_list|,
name|elems
operator|.
name|peer_mgmt_len
argument_list|,
operator|&
name|peer_mgmt_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: Mesh parsing rejected frame"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* the sender's llid is our plid and vice-versa */
name|plid
operator|=
name|WPA_GET_LE16
argument_list|(
name|peer_mgmt_ie
operator|.
name|llid
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer_mgmt_ie
operator|.
name|plid
condition|)
name|llid
operator|=
name|WPA_GET_LE16
argument_list|(
name|peer_mgmt_ie
operator|.
name|plid
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: plid=0x%x llid=0x%x"
argument_list|,
name|plid
argument_list|,
name|llid
argument_list|)
expr_stmt|;
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|)
expr_stmt|;
comment|/* 	 * If this is an open frame from an unknown STA, and this is an 	 * open mesh, then go ahead and add the peer before proceeding. 	 */
if|if
condition|(
operator|!
name|sta
operator|&&
name|action_field
operator|==
name|PLINK_OPEN
operator|&&
operator|!
operator|(
name|mconf
operator|->
name|security
operator|&
name|MESH_CONF_SEC_AMPE
operator|)
condition|)
name|sta
operator|=
name|mesh_mpm_add_peer
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
operator|&
name|elems
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sta
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: No STA entry for peer"
argument_list|)
expr_stmt|;
return|return;
block|}
ifdef|#
directive|ifdef
name|CONFIG_SAE
comment|/* peer is in sae_accepted? */
if|if
condition|(
name|sta
operator|->
name|sae
operator|&&
name|sta
operator|->
name|sae
operator|->
name|state
operator|!=
name|SAE_ACCEPTED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: SAE not yet accepted for peer"
argument_list|)
expr_stmt|;
return|return;
block|}
endif|#
directive|endif
comment|/* CONFIG_SAE */
if|if
condition|(
operator|!
name|sta
operator|->
name|my_lid
condition|)
name|mesh_mpm_init_link
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|mconf
operator|->
name|security
operator|&
name|MESH_CONF_SEC_AMPE
operator|)
operator|&&
name|mesh_rsn_process_ampe
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
operator|&
name|elems
argument_list|,
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
argument_list|,
name|ies
argument_list|,
name|ie_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: RSN process rejected frame"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|sta
operator|->
name|plink_state
operator|==
name|PLINK_BLOCKED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MPM: PLINK_BLOCKED"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Now we will figure out the appropriate event... */
switch|switch
condition|(
name|action_field
condition|)
block|{
case|case
name|PLINK_OPEN
case|:
if|if
condition|(
name|plink_free_count
argument_list|(
name|hapd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|event
operator|=
name|OPN_IGNR
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"MPM: Peer link num over quota(%d)"
argument_list|,
name|hapd
operator|->
name|max_plinks
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sta
operator|->
name|peer_lid
operator|&&
name|sta
operator|->
name|peer_lid
operator|!=
name|plid
condition|)
block|{
name|event
operator|=
name|OPN_IGNR
expr_stmt|;
block|}
else|else
block|{
name|sta
operator|->
name|peer_lid
operator|=
name|plid
expr_stmt|;
name|event
operator|=
name|OPN_ACPT
expr_stmt|;
block|}
break|break;
case|case
name|PLINK_CONFIRM
case|:
if|if
condition|(
name|plink_free_count
argument_list|(
name|hapd
argument_list|)
operator|==
literal|0
condition|)
block|{
name|event
operator|=
name|CNF_IGNR
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"MPM: Peer link num over quota(%d)"
argument_list|,
name|hapd
operator|->
name|max_plinks
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sta
operator|->
name|my_lid
operator|!=
name|llid
operator|||
operator|(
name|sta
operator|->
name|peer_lid
operator|&&
name|sta
operator|->
name|peer_lid
operator|!=
name|plid
operator|)
condition|)
block|{
name|event
operator|=
name|CNF_IGNR
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|sta
operator|->
name|peer_lid
condition|)
name|sta
operator|->
name|peer_lid
operator|=
name|plid
expr_stmt|;
name|event
operator|=
name|CNF_ACPT
expr_stmt|;
block|}
break|break;
case|case
name|PLINK_CLOSE
case|:
if|if
condition|(
name|sta
operator|->
name|plink_state
operator|==
name|PLINK_ESTAB
condition|)
comment|/* Do not check for llid or plid. This does not 			 * follow the standard but since multiple plinks 			 * per cand are not supported, it is necessary in 			 * order to avoid a livelock when MP A sees an 			 * establish peer link to MP B but MP B does not 			 * see it. This can be caused by a timeout in 			 * B's peer link establishment or B being 			 * restarted. 			 */
name|event
operator|=
name|CLS_ACPT
expr_stmt|;
elseif|else
if|if
condition|(
name|sta
operator|->
name|peer_lid
operator|!=
name|plid
condition|)
name|event
operator|=
name|CLS_IGNR
expr_stmt|;
elseif|else
if|if
condition|(
name|peer_mgmt_ie
operator|.
name|plid
operator|&&
name|sta
operator|->
name|my_lid
operator|!=
name|llid
condition|)
name|event
operator|=
name|CLS_IGNR
expr_stmt|;
else|else
name|event
operator|=
name|CLS_ACPT
expr_stmt|;
break|break;
default|default:
comment|/* 		 * This cannot be hit due to the action_field check above, but 		 * compilers may not be able to figure that out and can warn 		 * about uninitialized event below. 		 */
return|return;
block|}
name|mesh_mpm_fsm
argument_list|(
name|wpa_s
argument_list|,
name|sta
argument_list|,
name|event
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* called by ap_free_sta */
end_comment

begin_function
name|void
name|mesh_mpm_free_sta
parameter_list|(
name|struct
name|sta_info
modifier|*
name|sta
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|plink_timer
argument_list|,
name|ELOOP_ALL_CTX
argument_list|,
name|sta
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|mesh_auth_timer
argument_list|,
name|ELOOP_ALL_CTX
argument_list|,
name|sta
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


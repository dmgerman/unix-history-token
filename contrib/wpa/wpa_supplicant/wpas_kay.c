begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * IEEE 802.1X-2010 KaY Interface  * Copyright (c) 2013-2014, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap_i.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"pae/ieee802_1x_key.h"
end_include

begin_include
include|#
directive|include
file|"pae/ieee802_1x_kay.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"wpas_kay.h"
end_include

begin_define
define|#
directive|define
name|DEFAULT_KEY_LEN
value|16
end_define

begin_comment
comment|/* secure Connectivity Association Key Name (CKN) */
end_comment

begin_define
define|#
directive|define
name|DEFAULT_CKN_LEN
value|16
end_define

begin_function
specifier|static
name|int
name|wpas_macsec_init
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|,
name|struct
name|macsec_init_params
modifier|*
name|params
parameter_list|)
block|{
return|return
name|wpa_drv_macsec_init
argument_list|(
name|priv
argument_list|,
name|params
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_macsec_deinit
parameter_list|(
name|void
modifier|*
name|priv
parameter_list|)
block|{
return|return
name|wpa_drv_macsec_deinit
argument_list|(
name|priv
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_enable_protect_frames
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|Boolean
name|enabled
parameter_list|)
block|{
return|return
name|wpa_drv_enable_protect_frames
argument_list|(
name|wpa_s
argument_list|,
name|enabled
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_set_replay_protect
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|Boolean
name|enabled
parameter_list|,
name|u32
name|window
parameter_list|)
block|{
return|return
name|wpa_drv_set_replay_protect
argument_list|(
name|wpa_s
argument_list|,
name|enabled
argument_list|,
name|window
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_set_current_cipher_suite
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|cs
parameter_list|,
name|size_t
name|cs_len
parameter_list|)
block|{
return|return
name|wpa_drv_set_current_cipher_suite
argument_list|(
name|wpa_s
argument_list|,
name|cs
argument_list|,
name|cs_len
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_enable_controlled_port
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|Boolean
name|enabled
parameter_list|)
block|{
return|return
name|wpa_drv_enable_controlled_port
argument_list|(
name|wpa_s
argument_list|,
name|enabled
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_get_receive_lowest_pn
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
modifier|*
name|lowest_pn
parameter_list|)
block|{
return|return
name|wpa_drv_get_receive_lowest_pn
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|lowest_pn
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_get_transmit_next_pn
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
modifier|*
name|next_pn
parameter_list|)
block|{
return|return
name|wpa_drv_get_transmit_next_pn
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|next_pn
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_set_transmit_next_pn
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
name|next_pn
parameter_list|)
block|{
return|return
name|wpa_drv_set_transmit_next_pn
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|next_pn
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_get_available_receive_sc
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
modifier|*
name|channel
parameter_list|)
block|{
return|return
name|wpa_drv_get_available_receive_sc
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|conf_offset_val
parameter_list|(
name|enum
name|confidentiality_offset
name|co
parameter_list|)
block|{
switch|switch
condition|(
name|co
condition|)
block|{
case|case
name|CONFIDENTIALITY_OFFSET_30
case|:
return|return
literal|30
return|;
break|break;
case|case
name|CONFIDENTIALITY_OFFSET_50
case|:
return|return
literal|50
return|;
default|default:
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_create_receive_sc
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
name|struct
name|ieee802_1x_mka_sci
modifier|*
name|sci
parameter_list|,
name|enum
name|validate_frames
name|vf
parameter_list|,
name|enum
name|confidentiality_offset
name|co
parameter_list|)
block|{
return|return
name|wpa_drv_create_receive_sc
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|sci
operator|->
name|addr
argument_list|,
name|sci
operator|->
name|port
argument_list|,
name|conf_offset_val
argument_list|(
name|co
argument_list|)
argument_list|,
name|vf
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_delete_receive_sc
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|)
block|{
return|return
name|wpa_drv_delete_receive_sc
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_create_receive_sa
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
name|lowest_pn
parameter_list|,
specifier|const
name|u8
modifier|*
name|sak
parameter_list|)
block|{
return|return
name|wpa_drv_create_receive_sa
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|lowest_pn
argument_list|,
name|sak
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_enable_receive_sa
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|)
block|{
return|return
name|wpa_drv_enable_receive_sa
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|an
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_disable_receive_sa
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|)
block|{
return|return
name|wpa_drv_disable_receive_sa
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|an
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_get_available_transmit_sc
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
modifier|*
name|channel
parameter_list|)
block|{
return|return
name|wpa_drv_get_available_transmit_sc
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_create_transmit_sc
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
specifier|const
name|struct
name|ieee802_1x_mka_sci
modifier|*
name|sci
parameter_list|,
name|enum
name|confidentiality_offset
name|co
parameter_list|)
block|{
return|return
name|wpa_drv_create_transmit_sc
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|sci
operator|->
name|addr
argument_list|,
name|sci
operator|->
name|port
argument_list|,
name|conf_offset_val
argument_list|(
name|co
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_delete_transmit_sc
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|)
block|{
return|return
name|wpa_drv_delete_transmit_sc
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_create_transmit_sa
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|,
name|u32
name|next_pn
parameter_list|,
name|Boolean
name|confidentiality
parameter_list|,
specifier|const
name|u8
modifier|*
name|sak
parameter_list|)
block|{
return|return
name|wpa_drv_create_transmit_sa
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|an
argument_list|,
name|next_pn
argument_list|,
name|confidentiality
argument_list|,
name|sak
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_enable_transmit_sa
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|)
block|{
return|return
name|wpa_drv_enable_transmit_sa
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|an
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_disable_transmit_sa
parameter_list|(
name|void
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|channel
parameter_list|,
name|u8
name|an
parameter_list|)
block|{
return|return
name|wpa_drv_disable_transmit_sa
argument_list|(
name|wpa_s
argument_list|,
name|channel
argument_list|,
name|an
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|ieee802_1x_alloc_kay_sm
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|ieee802_1x_kay_ctx
modifier|*
name|kay_ctx
decl_stmt|;
name|struct
name|ieee802_1x_kay
modifier|*
name|res
init|=
name|NULL
decl_stmt|;
name|enum
name|macsec_policy
name|policy
decl_stmt|;
name|ieee802_1x_dealloc_kay_sm
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ssid
operator|||
name|ssid
operator|->
name|macsec_policy
operator|==
literal|0
condition|)
return|return
literal|0
return|;
name|policy
operator|=
name|ssid
operator|->
name|macsec_policy
operator|==
literal|1
condition|?
name|SHOULD_SECURE
else|:
name|DO_NOT_SECURE
expr_stmt|;
name|kay_ctx
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|kay_ctx
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|kay_ctx
condition|)
return|return
operator|-
literal|1
return|;
name|kay_ctx
operator|->
name|ctx
operator|=
name|wpa_s
expr_stmt|;
name|kay_ctx
operator|->
name|macsec_init
operator|=
name|wpas_macsec_init
expr_stmt|;
name|kay_ctx
operator|->
name|macsec_deinit
operator|=
name|wpas_macsec_deinit
expr_stmt|;
name|kay_ctx
operator|->
name|enable_protect_frames
operator|=
name|wpas_enable_protect_frames
expr_stmt|;
name|kay_ctx
operator|->
name|set_replay_protect
operator|=
name|wpas_set_replay_protect
expr_stmt|;
name|kay_ctx
operator|->
name|set_current_cipher_suite
operator|=
name|wpas_set_current_cipher_suite
expr_stmt|;
name|kay_ctx
operator|->
name|enable_controlled_port
operator|=
name|wpas_enable_controlled_port
expr_stmt|;
name|kay_ctx
operator|->
name|get_receive_lowest_pn
operator|=
name|wpas_get_receive_lowest_pn
expr_stmt|;
name|kay_ctx
operator|->
name|get_transmit_next_pn
operator|=
name|wpas_get_transmit_next_pn
expr_stmt|;
name|kay_ctx
operator|->
name|set_transmit_next_pn
operator|=
name|wpas_set_transmit_next_pn
expr_stmt|;
name|kay_ctx
operator|->
name|get_available_receive_sc
operator|=
name|wpas_get_available_receive_sc
expr_stmt|;
name|kay_ctx
operator|->
name|create_receive_sc
operator|=
name|wpas_create_receive_sc
expr_stmt|;
name|kay_ctx
operator|->
name|delete_receive_sc
operator|=
name|wpas_delete_receive_sc
expr_stmt|;
name|kay_ctx
operator|->
name|create_receive_sa
operator|=
name|wpas_create_receive_sa
expr_stmt|;
name|kay_ctx
operator|->
name|enable_receive_sa
operator|=
name|wpas_enable_receive_sa
expr_stmt|;
name|kay_ctx
operator|->
name|disable_receive_sa
operator|=
name|wpas_disable_receive_sa
expr_stmt|;
name|kay_ctx
operator|->
name|get_available_transmit_sc
operator|=
name|wpas_get_available_transmit_sc
expr_stmt|;
name|kay_ctx
operator|->
name|create_transmit_sc
operator|=
name|wpas_create_transmit_sc
expr_stmt|;
name|kay_ctx
operator|->
name|delete_transmit_sc
operator|=
name|wpas_delete_transmit_sc
expr_stmt|;
name|kay_ctx
operator|->
name|create_transmit_sa
operator|=
name|wpas_create_transmit_sa
expr_stmt|;
name|kay_ctx
operator|->
name|enable_transmit_sa
operator|=
name|wpas_enable_transmit_sa
expr_stmt|;
name|kay_ctx
operator|->
name|disable_transmit_sa
operator|=
name|wpas_disable_transmit_sa
expr_stmt|;
name|res
operator|=
name|ieee802_1x_kay_init
argument_list|(
name|kay_ctx
argument_list|,
name|policy
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|kay_ctx
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|kay
operator|=
name|res
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|ieee802_1x_dealloc_kay_sm
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|kay
condition|)
return|return;
name|ieee802_1x_kay_deinit
argument_list|(
name|wpa_s
operator|->
name|kay
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|kay
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|ieee802_1x_auth_get_session_id
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
modifier|*
name|sid
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|session_id
decl_stmt|;
name|size_t
name|id_len
decl_stmt|,
name|need_len
decl_stmt|;
name|session_id
operator|=
name|eapol_sm_get_session_id
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
operator|&
name|id_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|session_id
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to get SessionID from EAPOL state machines"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|need_len
operator|=
literal|1
operator|+
literal|2
operator|*
name|SSL3_RANDOM_SIZE
expr_stmt|;
if|if
condition|(
name|need_len
operator|>
name|id_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EAP Session-Id not long enough"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|sid
argument_list|,
name|session_id
argument_list|,
name|need_len
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|need_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|ieee802_1x_auth_get_msk
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
modifier|*
name|msk
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|u8
name|key
index|[
name|EAP_MSK_LEN
index|]
decl_stmt|;
name|size_t
name|keylen
decl_stmt|;
name|struct
name|eapol_sm
modifier|*
name|sm
decl_stmt|;
name|int
name|res
decl_stmt|;
name|sm
operator|=
name|wpa_s
operator|->
name|eapol
expr_stmt|;
if|if
condition|(
name|sm
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|keylen
operator|=
name|EAP_MSK_LEN
expr_stmt|;
name|res
operator|=
name|eapol_sm_get_key
argument_list|(
name|sm
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to get MSK from EAPOL state machines"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|keylen
operator|>
operator|*
name|len
condition|)
name|keylen
operator|=
operator|*
name|len
expr_stmt|;
name|os_memcpy
argument_list|(
name|msk
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
expr_stmt|;
operator|*
name|len
operator|=
name|keylen
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
modifier|*
name|ieee802_1x_notify_create_actor
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|)
block|{
name|u8
modifier|*
name|sid
decl_stmt|;
name|size_t
name|sid_len
init|=
literal|128
decl_stmt|;
name|struct
name|mka_key_name
modifier|*
name|ckn
decl_stmt|;
name|struct
name|mka_key
modifier|*
name|cak
decl_stmt|;
name|struct
name|mka_key
modifier|*
name|msk
decl_stmt|;
name|void
modifier|*
name|res
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|kay
operator|||
name|wpa_s
operator|->
name|kay
operator|->
name|policy
operator|==
name|DO_NOT_SECURE
condition|)
return|return
name|NULL
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"IEEE 802.1X: External notification - Create MKA for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peer_addr
argument_list|)
argument_list|)
expr_stmt|;
name|msk
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|msk
argument_list|)
argument_list|)
expr_stmt|;
name|sid
operator|=
name|os_zalloc
argument_list|(
name|sid_len
argument_list|)
expr_stmt|;
name|ckn
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|ckn
argument_list|)
argument_list|)
expr_stmt|;
name|cak
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cak
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|msk
operator|||
operator|!
name|sid
operator|||
operator|!
name|ckn
operator|||
operator|!
name|cak
condition|)
goto|goto
name|fail
goto|;
name|msk
operator|->
name|len
operator|=
name|DEFAULT_KEY_LEN
expr_stmt|;
if|if
condition|(
name|ieee802_1x_auth_get_msk
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|msk
operator|->
name|key
argument_list|,
operator|&
name|msk
operator|->
name|len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"IEEE 802.1X: Could not get MSK"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
if|if
condition|(
name|ieee802_1x_auth_get_session_id
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|sid
argument_list|,
operator|&
name|sid_len
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"IEEE 802.1X: Could not get EAP Session Id"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
comment|/* Derive CAK from MSK */
name|cak
operator|->
name|len
operator|=
name|DEFAULT_KEY_LEN
expr_stmt|;
if|if
condition|(
name|ieee802_1x_cak_128bits_aes_cmac
argument_list|(
name|msk
operator|->
name|key
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|peer_addr
argument_list|,
name|cak
operator|->
name|key
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"IEEE 802.1X: Deriving CAK failed"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Derived CAK"
argument_list|,
name|cak
operator|->
name|key
argument_list|,
name|cak
operator|->
name|len
argument_list|)
expr_stmt|;
comment|/* Derive CKN from MSK */
name|ckn
operator|->
name|len
operator|=
name|DEFAULT_CKN_LEN
expr_stmt|;
if|if
condition|(
name|ieee802_1x_ckn_128bits_aes_cmac
argument_list|(
name|msk
operator|->
name|key
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|peer_addr
argument_list|,
name|sid
argument_list|,
name|sid_len
argument_list|,
name|ckn
operator|->
name|name
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"IEEE 802.1X: Deriving CKN failed"
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Derived CKN"
argument_list|,
name|ckn
operator|->
name|name
argument_list|,
name|ckn
operator|->
name|len
argument_list|)
expr_stmt|;
name|res
operator|=
name|ieee802_1x_kay_create_mka
argument_list|(
name|wpa_s
operator|->
name|kay
argument_list|,
name|ckn
argument_list|,
name|cak
argument_list|,
literal|0
argument_list|,
name|EAP_EXCHANGE
argument_list|,
name|FALSE
argument_list|)
expr_stmt|;
name|fail
label|:
if|if
condition|(
name|msk
condition|)
block|{
name|os_memset
argument_list|(
name|msk
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|msk
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|msk
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|sid
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ckn
argument_list|)
expr_stmt|;
if|if
condition|(
name|cak
condition|)
block|{
name|os_memset
argument_list|(
name|cak
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cak
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|cak
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

end_unit


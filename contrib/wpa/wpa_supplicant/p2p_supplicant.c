begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant - P2P  * Copyright (c) 2009-2010, Atheros Communications  * Copyright (c) 2010-2014, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_i.h"
end_include

begin_include
include|#
directive|include
file|"p2p/p2p.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ap/sta_info.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_drv_ops.h"
end_include

begin_include
include|#
directive|include
file|"ap/wps_hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/p2p_hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/dfs.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"ap.h"
end_include

begin_include
include|#
directive|include
file|"config_ssid.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"offchannel.h"
end_include

begin_include
include|#
directive|include
file|"wps_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"p2p_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"wifi_display.h"
end_include

begin_comment
comment|/*  * How many times to try to scan to find the GO before giving up on join  * request.  */
end_comment

begin_define
define|#
directive|define
name|P2P_MAX_JOIN_SCAN_ATTEMPTS
value|10
end_define

begin_define
define|#
directive|define
name|P2P_AUTO_PD_SCAN_ATTEMPTS
value|5
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|P2P_MAX_CLIENT_IDLE
end_ifndef

begin_comment
comment|/*  * How many seconds to try to reconnect to the GO when connection in P2P client  * role has been lost.  */
end_comment

begin_define
define|#
directive|define
name|P2P_MAX_CLIENT_IDLE
value|10
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* P2P_MAX_CLIENT_IDLE */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|P2P_MAX_INITIAL_CONN_WAIT
end_ifndef

begin_comment
comment|/*  * How many seconds to wait for initial 4-way handshake to get completed after  * WPS provisioning step or after the re-invocation of a persistent group on a  * P2P Client.  */
end_comment

begin_define
define|#
directive|define
name|P2P_MAX_INITIAL_CONN_WAIT
value|10
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* P2P_MAX_INITIAL_CONN_WAIT */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|P2P_MAX_INITIAL_CONN_WAIT_GO
end_ifndef

begin_comment
comment|/*  * How many seconds to wait for initial 4-way handshake to get completed after  * WPS provisioning step on the GO. This controls the extra time the P2P  * operation is considered to be in progress (e.g., to delay other scans) after  * WPS provisioning has been completed on the GO during group formation.  */
end_comment

begin_define
define|#
directive|define
name|P2P_MAX_INITIAL_CONN_WAIT_GO
value|10
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* P2P_MAX_INITIAL_CONN_WAIT_GO */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|P2P_MAX_INITIAL_CONN_WAIT_GO_REINVOKE
end_ifndef

begin_comment
comment|/*  * How many seconds to wait for initial 4-way handshake to get completed after  * re-invocation of a persistent group on the GO when the client is expected  * to connect automatically (no user interaction).  */
end_comment

begin_define
define|#
directive|define
name|P2P_MAX_INITIAL_CONN_WAIT_GO_REINVOKE
value|15
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* P2P_MAX_INITIAL_CONN_WAIT_GO_REINVOKE */
end_comment

begin_define
define|#
directive|define
name|P2P_MGMT_DEVICE_PREFIX
value|"p2p-dev-"
end_define

begin_enum
enum|enum
name|p2p_group_removal_reason
block|{
name|P2P_GROUP_REMOVAL_UNKNOWN
block|,
name|P2P_GROUP_REMOVAL_SILENT
block|,
name|P2P_GROUP_REMOVAL_FORMATION_FAILED
block|,
name|P2P_GROUP_REMOVAL_REQUESTED
block|,
name|P2P_GROUP_REMOVAL_IDLE_TIMEOUT
block|,
name|P2P_GROUP_REMOVAL_UNAVAILABLE
block|,
name|P2P_GROUP_REMOVAL_GO_ENDING_SESSION
block|,
name|P2P_GROUP_REMOVAL_PSK_FAILURE
block|,
name|P2P_GROUP_REMOVAL_FREQ_CONFLICT
block|}
enum|;
end_enum

begin_function_decl
specifier|static
name|void
name|wpas_p2p_long_listen_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpas_p2p_get_group_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|addr_allocated
parameter_list|,
name|int
name|go
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpas_p2p_join_start
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_join_scan_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_join_scan
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpas_p2p_join
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|iface_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|,
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|,
name|int
name|auto_join
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpas_p2p_create_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_cross_connect_setup
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_group_idle_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_set_group_idle_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_group_formation_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_group_freq_conflict
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpas_p2p_fallback_to_go_neg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|group_added
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_stop_find_oper
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_stop_listen
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_psk_failure_removal
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_p2p_group_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|wpas_p2p_add_group_interface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|enum
name|wpa_driver_if_type
name|type
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/*  * Get the number of concurrent channels that the HW can operate, but that are  * currently not in use by any of the wpa_supplicant interfaces.  */
end_comment

begin_function
specifier|static
name|int
name|wpas_p2p_num_unused_channels
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
modifier|*
name|freqs
decl_stmt|;
name|int
name|num
decl_stmt|,
name|unused
decl_stmt|;
name|freqs
operator|=
name|os_calloc
argument_list|(
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|freqs
condition|)
return|return
operator|-
literal|1
return|;
name|num
operator|=
name|get_shared_radio_freqs
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
name|unused
operator|=
name|wpa_s
operator|->
name|num_multichan_concurrent
operator|-
name|num
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: num_unused_channels: %d"
argument_list|,
name|unused
argument_list|)
expr_stmt|;
return|return
name|unused
return|;
block|}
end_function

begin_comment
comment|/*  * Get the frequencies that are currently in use by one or more of the virtual  * interfaces, and that are also valid for P2P operation.  */
end_comment

begin_function
specifier|static
name|unsigned
name|int
name|wpas_p2p_valid_oper_freqs
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_used_freq_data
modifier|*
name|p2p_freqs
parameter_list|,
name|unsigned
name|int
name|len
parameter_list|)
block|{
name|struct
name|wpa_used_freq_data
modifier|*
name|freqs
decl_stmt|;
name|unsigned
name|int
name|num
decl_stmt|,
name|i
decl_stmt|,
name|j
decl_stmt|;
name|freqs
operator|=
name|os_calloc
argument_list|(
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_used_freq_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|freqs
condition|)
return|return
literal|0
return|;
name|num
operator|=
name|get_shared_radio_freqs_data
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|p2p_freqs
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_used_freq_data
argument_list|)
operator|*
name|len
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|j
operator|=
literal|0
init|;
name|i
operator|<
name|num
operator|&&
name|j
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freqs
index|[
name|i
index|]
operator|.
name|freq
argument_list|)
condition|)
name|p2p_freqs
index|[
name|j
operator|++
index|]
operator|=
name|freqs
index|[
name|i
index|]
expr_stmt|;
block|}
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
name|dump_freq_data
argument_list|(
name|wpa_s
argument_list|,
literal|"valid for P2P"
argument_list|,
name|p2p_freqs
argument_list|,
name|j
argument_list|)
expr_stmt|;
return|return
name|j
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_set_own_freq_preference
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|p2p_ignore_shared_freq
operator|&&
name|freq
operator|>
literal|0
operator|&&
name|wpa_s
operator|->
name|num_multichan_concurrent
operator|>
literal|1
operator|&&
name|wpas_p2p_num_unused_channels
argument_list|(
name|wpa_s
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore own channel preference %d MHz due to p2p_ignore_shared_freq=1 configuration"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|freq
operator|=
literal|0
expr_stmt|;
block|}
name|p2p_set_own_freq_preference
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_scan_res_handler
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_scan_work
condition|)
block|{
name|struct
name|wpa_radio_work
modifier|*
name|work
init|=
name|wpa_s
operator|->
name|p2p_scan_work
decl_stmt|;
name|wpa_s
operator|->
name|p2p_scan_work
operator|=
name|NULL
expr_stmt|;
name|radio_work_done
argument_list|(
name|work
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Scan results received (%d BSS)"
argument_list|,
operator|(
name|int
operator|)
name|scan_res
operator|->
name|num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scan_res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|bss
init|=
name|scan_res
operator|->
name|res
index|[
name|i
index|]
decl_stmt|;
name|struct
name|os_reltime
name|time_tmp_age
decl_stmt|,
name|entry_ts
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ies
decl_stmt|;
name|size_t
name|ies_len
decl_stmt|;
name|time_tmp_age
operator|.
name|sec
operator|=
name|bss
operator|->
name|age
operator|/
literal|1000
expr_stmt|;
name|time_tmp_age
operator|.
name|usec
operator|=
operator|(
name|bss
operator|->
name|age
operator|%
literal|1000
operator|)
operator|*
literal|1000
expr_stmt|;
name|os_reltime_sub
argument_list|(
operator|&
name|scan_res
operator|->
name|fetch_time
argument_list|,
operator|&
name|time_tmp_age
argument_list|,
operator|&
name|entry_ts
argument_list|)
expr_stmt|;
name|ies
operator|=
operator|(
specifier|const
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
expr_stmt|;
name|ies_len
operator|=
name|bss
operator|->
name|ie_len
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|beacon_ie_len
operator|>
literal|0
operator|&&
operator|!
name|wpa_scan_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
operator|&&
name|wpa_scan_get_vendor_ie_beacon
argument_list|(
name|bss
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use P2P IE(s) from Beacon frame since no P2P IE(s) in Probe Response frames received for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|ies
operator|=
name|ies
operator|+
name|ies_len
expr_stmt|;
name|ies_len
operator|=
name|bss
operator|->
name|beacon_ie_len
expr_stmt|;
block|}
if|if
condition|(
name|p2p_scan_res_handler
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|freq
argument_list|,
operator|&
name|entry_ts
argument_list|,
name|bss
operator|->
name|level
argument_list|,
name|ies
argument_list|,
name|ies_len
argument_list|)
operator|>
literal|0
condition|)
break|break;
block|}
name|p2p_scan_res_handled
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_trigger_scan_cb
parameter_list|(
name|struct
name|wpa_radio_work
modifier|*
name|work
parameter_list|,
name|int
name|deinit
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|work
operator|->
name|wpa_s
decl_stmt|;
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
init|=
name|work
operator|->
name|ctx
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|deinit
condition|)
block|{
if|if
condition|(
operator|!
name|work
operator|->
name|started
condition|)
block|{
name|wpa_scan_free_params
argument_list|(
name|params
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|p2p_scan_work
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
name|ret
operator|=
name|wpa_drv_scan
argument_list|(
name|wpa_s
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|wpa_scan_free_params
argument_list|(
name|params
argument_list|)
expr_stmt|;
name|work
operator|->
name|ctx
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|radio_work_done
argument_list|(
name|work
argument_list|)
expr_stmt|;
name|p2p_notify_scan_trigger_status
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return;
block|}
name|p2p_notify_scan_trigger_status
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|wpa_s
operator|->
name|scan_trigger_time
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_res_handler
operator|=
name|wpas_p2p_scan_res_handler
expr_stmt|;
name|wpa_s
operator|->
name|own_scan_requested
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|p2p_scan_work
operator|=
name|work
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_search_social_channel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_24ghz_social_channels
operator|&&
operator|(
name|freq
operator|==
literal|2412
operator|||
name|freq
operator|==
literal|2437
operator|||
name|freq
operator|==
literal|2462
operator|)
condition|)
block|{
comment|/* 		 * Search all social channels regardless of whether these have 		 * been disabled for P2P operating channel use to avoid missing 		 * peers. 		 */
return|return
literal|1
return|;
block|}
return|return
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_scan
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|p2p_scan_type
name|type
parameter_list|,
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|num_req_dev_types
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_dev_types
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_id
parameter_list|,
name|u16
name|pw_id
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
init|=
name|NULL
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|,
modifier|*
name|ies
decl_stmt|;
name|unsigned
name|int
name|num_channels
init|=
literal|0
decl_stmt|;
name|int
name|social_channels_freq
index|[]
init|=
block|{
literal|2412
block|,
literal|2437
block|,
literal|2462
block|,
literal|60480
block|}
decl_stmt|;
name|size_t
name|ielen
decl_stmt|;
name|u8
modifier|*
name|n
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_scan_work
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"P2P: Reject scan trigger since one is already pending"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|params
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|params
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* P2P Wildcard SSID */
name|params
operator|->
name|num_ssids
operator|=
literal|1
expr_stmt|;
name|n
operator|=
name|os_malloc
argument_list|(
name|P2P_WILDCARD_SSID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|os_memcpy
argument_list|(
name|n
argument_list|,
name|P2P_WILDCARD_SSID
argument_list|,
name|P2P_WILDCARD_SSID_LEN
argument_list|)
expr_stmt|;
name|params
operator|->
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
operator|=
name|n
expr_stmt|;
name|params
operator|->
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
operator|=
name|P2P_WILDCARD_SSID_LEN
expr_stmt|;
name|wpa_s
operator|->
name|wps
operator|->
name|dev
operator|.
name|p2p
operator|=
literal|1
expr_stmt|;
name|wps_ie
operator|=
name|wps_build_probe_req_ie
argument_list|(
name|pw_id
argument_list|,
operator|&
name|wpa_s
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|wpa_s
operator|->
name|wps
operator|->
name|uuid
argument_list|,
name|WPS_REQ_ENROLLEE
argument_list|,
name|num_req_dev_types
argument_list|,
name|req_dev_types
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|ielen
operator|=
name|p2p_scan_ie_buf_len
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|ies
operator|=
name|wpabuf_alloc
argument_list|(
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
operator|+
name|ielen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|wpabuf_put_buf
argument_list|(
name|ies
argument_list|,
name|wps_ie
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|p2p_scan_ie
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|ies
argument_list|,
name|dev_id
argument_list|)
expr_stmt|;
name|params
operator|->
name|p2p_probe
operator|=
literal|1
expr_stmt|;
name|n
operator|=
name|os_malloc
argument_list|(
name|wpabuf_len
argument_list|(
name|ies
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|ies
argument_list|)
expr_stmt|;
goto|goto
name|fail
goto|;
block|}
name|os_memcpy
argument_list|(
name|n
argument_list|,
name|wpabuf_head
argument_list|(
name|ies
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|ies
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|->
name|extra_ies
operator|=
name|n
expr_stmt|;
name|params
operator|->
name|extra_ies_len
operator|=
name|wpabuf_len
argument_list|(
name|ies
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ies
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|P2P_SCAN_SOCIAL
case|:
name|params
operator|->
name|freqs
operator|=
name|os_calloc
argument_list|(
name|ARRAY_SIZE
argument_list|(
name|social_channels_freq
argument_list|)
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|freqs
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|social_channels_freq
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpas_p2p_search_social_channel
argument_list|(
name|wpa_s
argument_list|,
name|social_channels_freq
index|[
name|i
index|]
argument_list|)
condition|)
name|params
operator|->
name|freqs
index|[
name|num_channels
operator|++
index|]
operator|=
name|social_channels_freq
index|[
name|i
index|]
expr_stmt|;
block|}
name|params
operator|->
name|freqs
index|[
name|num_channels
operator|++
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|P2P_SCAN_FULL
case|:
break|break;
case|case
name|P2P_SCAN_SPECIFIC
case|:
name|params
operator|->
name|freqs
operator|=
name|os_calloc
argument_list|(
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|freqs
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
name|params
operator|->
name|freqs
index|[
literal|0
index|]
operator|=
name|freq
expr_stmt|;
name|params
operator|->
name|freqs
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|P2P_SCAN_SOCIAL_PLUS_ONE
case|:
name|params
operator|->
name|freqs
operator|=
name|os_calloc
argument_list|(
name|ARRAY_SIZE
argument_list|(
name|social_channels_freq
argument_list|)
operator|+
literal|2
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|freqs
operator|==
name|NULL
condition|)
goto|goto
name|fail
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|social_channels_freq
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpas_p2p_search_social_channel
argument_list|(
name|wpa_s
argument_list|,
name|social_channels_freq
index|[
name|i
index|]
argument_list|)
condition|)
name|params
operator|->
name|freqs
index|[
name|num_channels
operator|++
index|]
operator|=
name|social_channels_freq
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
condition|)
name|params
operator|->
name|freqs
index|[
name|num_channels
operator|++
index|]
operator|=
name|freq
expr_stmt|;
name|params
operator|->
name|freqs
index|[
name|num_channels
operator|++
index|]
operator|=
literal|0
expr_stmt|;
break|break;
block|}
name|radio_remove_works
argument_list|(
name|wpa_s
argument_list|,
literal|"p2p-scan"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|radio_add_work
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|"p2p-scan"
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_trigger_scan_cb
argument_list|,
name|params
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|fail
goto|;
return|return
literal|0
return|;
name|fail
label|:
name|wpa_scan_free_params
argument_list|(
name|params
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|wpa_driver_if_type
name|wpas_p2p_if_type
parameter_list|(
name|int
name|p2p_group_interface
parameter_list|)
block|{
switch|switch
condition|(
name|p2p_group_interface
condition|)
block|{
case|case
name|P2P_GROUP_INTERFACE_PENDING
case|:
return|return
name|WPA_IF_P2P_GROUP
return|;
case|case
name|P2P_GROUP_INTERFACE_GO
case|:
return|return
name|WPA_IF_P2P_GO
return|;
case|case
name|P2P_GROUP_INTERFACE_CLIENT
case|:
return|return
name|WPA_IF_P2P_CLIENT
return|;
block|}
return|return
name|WPA_IF_P2P_GROUP
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpas_get_p2p_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
name|int
modifier|*
name|go
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|!=
literal|0
operator|||
operator|!
name|s
operator|->
name|p2p_group
operator|||
name|s
operator|->
name|ssid_len
operator|!=
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
name|s
operator|!=
name|wpa_s
operator|->
name|current_ssid
condition|)
continue|continue;
if|if
condition|(
name|go
condition|)
operator|*
name|go
operator|=
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
expr_stmt|;
return|return
name|wpa_s
return|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|run_wpas_p2p_disconnect
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Complete previously requested removal of %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|wpas_p2p_disconnect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_disconnect_safely
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|calling_wpa_s
parameter_list|)
block|{
if|if
condition|(
name|calling_wpa_s
operator|==
name|wpa_s
operator|&&
name|wpa_s
operator|&&
name|wpa_s
operator|->
name|p2p_group_interface
operator|!=
name|NOT_P2P_GROUP_INTERFACE
condition|)
block|{
comment|/* 		 * The calling wpa_s instance is going to be removed. Do that 		 * from an eloop callback to keep the instance available until 		 * the caller has returned. This my be needed, e.g., to provide 		 * control interface responses on the per-interface socket. 		 */
if|if
condition|(
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|run_wpas_p2p_disconnect
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
return|return
name|wpas_p2p_disconnect
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Determine total number of clients in active groups where we are the GO */
end_comment

begin_function
specifier|static
name|unsigned
name|int
name|p2p_group_go_member_count
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|unsigned
name|int
name|count
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: sup:%p ssid:%p disabled:%d p2p:%d mode:%d"
argument_list|,
name|wpa_s
argument_list|,
name|s
argument_list|,
name|s
operator|->
name|disabled
argument_list|,
name|s
operator|->
name|p2p_group
argument_list|,
name|s
operator|->
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s
operator|->
name|disabled
operator|&&
name|s
operator|->
name|p2p_group
operator|&&
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
name|count
operator|+=
name|p2p_get_group_num_members
argument_list|(
name|wpa_s
operator|->
name|p2p_group
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|count
return|;
block|}
end_function

begin_comment
comment|/* Find an interface for a P2P group where we are the GO */
end_comment

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpas_p2p_get_go_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|save
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|||
operator|!
name|s
operator|->
name|p2p_group
operator|||
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
continue|continue;
comment|/* Prefer a group with connected clients */
if|if
condition|(
name|p2p_get_group_num_members
argument_list|(
name|wpa_s
operator|->
name|p2p_group
argument_list|)
condition|)
return|return
name|wpa_s
return|;
name|save
operator|=
name|wpa_s
expr_stmt|;
block|}
block|}
comment|/* No group with connected clients, so pick the one without (if any) */
return|return
name|save
return|;
block|}
end_function

begin_comment
comment|/* Find an active P2P group where we are the GO */
end_comment

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|wpas_p2p_group_go_ssid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|,
modifier|*
name|empty
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
condition|)
return|return
literal|0
return|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|||
operator|!
name|s
operator|->
name|p2p_group
operator|||
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
continue|continue;
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_get_group_num_members
argument_list|(
name|wpa_s
operator|->
name|p2p_group
argument_list|)
condition|)
return|return
name|s
return|;
name|empty
operator|=
name|s
expr_stmt|;
block|}
block|}
return|return
name|empty
return|;
block|}
end_function

begin_comment
comment|/* Find a persistent group where we are the GO */
end_comment

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|wpas_p2p_get_persistent_go
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|==
literal|2
operator|&&
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
return|return
name|s
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|u8
name|p2ps_group_capability
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
name|incoming
parameter_list|,
name|u8
name|role
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|,
modifier|*
name|tmp_wpa_s
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|u8
name|conncap
init|=
name|P2PS_SETUP_NONE
decl_stmt|;
name|unsigned
name|int
name|owned_members
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|owner
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|client
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|go_wpa_s
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|persistent_go
decl_stmt|;
name|int
name|p2p_no_group_iface
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Conncap - in:%d role:%d"
argument_list|,
name|incoming
argument_list|,
name|role
argument_list|)
expr_stmt|;
comment|/* 	 * For non-concurrent capable devices: 	 * If persistent_go, then no new. 	 * If GO, then no client. 	 * If client, then no GO. 	 */
name|go_wpa_s
operator|=
name|wpas_p2p_get_go_group
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|persistent_go
operator|=
name|wpas_p2p_get_persistent_go
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|p2p_no_group_iface
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_no_group_iface
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO(iface)=%p persistent(ssid)=%p"
argument_list|,
name|go_wpa_s
argument_list|,
name|persistent_go
argument_list|)
expr_stmt|;
for|for
control|(
name|tmp_wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|tmp_wpa_s
condition|;
name|tmp_wpa_s
operator|=
name|tmp_wpa_s
operator|->
name|next
control|)
block|{
for|for
control|(
name|s
operator|=
name|tmp_wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: sup:%p ssid:%p disabled:%d p2p:%d mode:%d"
argument_list|,
name|tmp_wpa_s
argument_list|,
name|s
argument_list|,
name|s
operator|->
name|disabled
argument_list|,
name|s
operator|->
name|p2p_group
argument_list|,
name|s
operator|->
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s
operator|->
name|disabled
operator|&&
name|s
operator|->
name|p2p_group
condition|)
block|{
if|if
condition|(
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
name|owned_members
operator|+=
name|p2p_get_group_num_members
argument_list|(
name|tmp_wpa_s
operator|->
name|p2p_group
argument_list|)
expr_stmt|;
name|owner
operator|++
expr_stmt|;
block|}
else|else
name|client
operator|++
expr_stmt|;
block|}
block|}
block|}
comment|/* If not concurrent, restrict our choices */
if|if
condition|(
name|p2p_no_group_iface
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: p2p_no_group_iface"
argument_list|)
expr_stmt|;
if|if
condition|(
name|client
condition|)
return|return
name|P2PS_SETUP_NONE
return|;
if|if
condition|(
name|go_wpa_s
condition|)
block|{
if|if
condition|(
name|role
operator|==
name|P2PS_SETUP_CLIENT
operator|||
name|incoming
operator|==
name|P2PS_SETUP_GROUP_OWNER
operator|||
name|p2p_client_limit_reached
argument_list|(
name|go_wpa_s
operator|->
name|p2p_group
argument_list|)
condition|)
return|return
name|P2PS_SETUP_NONE
return|;
return|return
name|P2PS_SETUP_GROUP_OWNER
return|;
block|}
if|if
condition|(
name|persistent_go
condition|)
block|{
if|if
condition|(
name|role
operator|==
name|P2PS_SETUP_NONE
operator|||
name|role
operator|==
name|P2PS_SETUP_NEW
condition|)
block|{
if|if
condition|(
operator|!
name|incoming
condition|)
return|return
name|P2PS_SETUP_GROUP_OWNER
operator||
name|P2PS_SETUP_CLIENT
return|;
if|if
condition|(
name|incoming
operator|==
name|P2PS_SETUP_NEW
condition|)
block|{
name|u8
name|r
decl_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|r
operator|&
literal|1
operator|)
condition|)
return|return
name|P2PS_SETUP_CLIENT
return|;
return|return
name|P2PS_SETUP_GROUP_OWNER
return|;
block|}
block|}
block|}
block|}
comment|/* If a required role has been specified, handle it here */
if|if
condition|(
name|role
operator|&&
name|role
operator|!=
name|P2PS_SETUP_NEW
condition|)
block|{
switch|switch
condition|(
name|incoming
condition|)
block|{
case|case
name|P2PS_SETUP_NONE
case|:
case|case
name|P2PS_SETUP_NEW
case|:
case|case
name|P2PS_SETUP_GROUP_OWNER
operator||
name|P2PS_SETUP_CLIENT
case|:
case|case
name|P2PS_SETUP_GROUP_OWNER
operator||
name|P2PS_SETUP_NEW
case|:
name|conncap
operator|=
name|role
expr_stmt|;
goto|goto
name|grp_owner
goto|;
case|case
name|P2PS_SETUP_GROUP_OWNER
case|:
comment|/* 			 * Must be a complimentary role - cannot be a client to 			 * more than one peer. 			 */
if|if
condition|(
name|incoming
operator|==
name|role
operator|||
name|client
condition|)
return|return
name|P2PS_SETUP_NONE
return|;
return|return
name|P2PS_SETUP_CLIENT
return|;
case|case
name|P2PS_SETUP_CLIENT
case|:
comment|/* Must be a complimentary role */
if|if
condition|(
name|incoming
operator|!=
name|role
condition|)
block|{
name|conncap
operator|=
name|P2PS_SETUP_GROUP_OWNER
expr_stmt|;
goto|goto
name|grp_owner
goto|;
block|}
default|default:
return|return
name|P2PS_SETUP_NONE
return|;
block|}
block|}
comment|/* 	 * For now, we only will support ownership of one group, and being a 	 * client of one group. Therefore, if we have either an existing GO 	 * group, or an existing client group, we will not do a new GO 	 * negotiation, but rather try to re-use the existing groups. 	 */
switch|switch
condition|(
name|incoming
condition|)
block|{
case|case
name|P2PS_SETUP_NONE
case|:
case|case
name|P2PS_SETUP_NEW
case|:
if|if
condition|(
name|client
condition|)
name|conncap
operator|=
name|P2PS_SETUP_GROUP_OWNER
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|owned_members
condition|)
name|conncap
operator|=
name|P2PS_SETUP_NEW
expr_stmt|;
elseif|else
if|if
condition|(
name|incoming
operator|==
name|P2PS_SETUP_NONE
condition|)
name|conncap
operator|=
name|P2PS_SETUP_GROUP_OWNER
operator||
name|P2PS_SETUP_CLIENT
expr_stmt|;
else|else
name|conncap
operator|=
name|P2PS_SETUP_CLIENT
expr_stmt|;
break|break;
case|case
name|P2PS_SETUP_CLIENT
case|:
name|conncap
operator|=
name|P2PS_SETUP_GROUP_OWNER
expr_stmt|;
break|break;
case|case
name|P2PS_SETUP_GROUP_OWNER
case|:
if|if
condition|(
operator|!
name|client
condition|)
name|conncap
operator|=
name|P2PS_SETUP_CLIENT
expr_stmt|;
break|break;
case|case
name|P2PS_SETUP_GROUP_OWNER
operator||
name|P2PS_SETUP_NEW
case|:
case|case
name|P2PS_SETUP_GROUP_OWNER
operator||
name|P2PS_SETUP_CLIENT
case|:
if|if
condition|(
name|client
condition|)
name|conncap
operator|=
name|P2PS_SETUP_GROUP_OWNER
expr_stmt|;
else|else
block|{
name|u8
name|r
decl_stmt|;
if|if
condition|(
name|os_get_random
argument_list|(
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
operator|||
operator|(
name|r
operator|&
literal|1
operator|)
condition|)
name|conncap
operator|=
name|P2PS_SETUP_CLIENT
expr_stmt|;
else|else
name|conncap
operator|=
name|P2PS_SETUP_GROUP_OWNER
expr_stmt|;
block|}
break|break;
default|default:
return|return
name|P2PS_SETUP_NONE
return|;
block|}
name|grp_owner
label|:
if|if
condition|(
operator|(
name|conncap
operator|&
name|P2PS_SETUP_GROUP_OWNER
operator|)
operator|||
operator|(
operator|!
name|incoming
operator|&&
operator|(
name|conncap
operator|&
name|P2PS_SETUP_NEW
operator|)
operator|)
condition|)
block|{
if|if
condition|(
name|go_wpa_s
operator|&&
name|p2p_client_limit_reached
argument_list|(
name|go_wpa_s
operator|->
name|p2p_group
argument_list|)
condition|)
name|conncap
operator|&=
operator|~
name|P2PS_SETUP_GROUP_OWNER
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: GOs:%d members:%d conncap:%d"
argument_list|,
name|owner
argument_list|,
name|owned_members
argument_list|,
name|conncap
argument_list|)
expr_stmt|;
name|s
operator|=
name|wpas_p2p_get_persistent_go
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s
operator|&&
operator|!
name|owner
operator|&&
name|p2p_no_group_iface
condition|)
block|{
name|p2p_set_intended_addr
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|s
operator|&&
operator|!
name|owner
condition|)
block|{
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|WPA_IF_P2P_GO
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to allocate a new interface for the group"
argument_list|)
expr_stmt|;
return|return
name|P2PS_SETUP_NONE
return|;
block|}
name|wpa_s
operator|->
name|global
operator|->
name|pending_group_iface_for_p2ps
operator|=
literal|1
expr_stmt|;
name|p2p_set_intended_addr
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|conncap
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_group_delete
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|enum
name|p2p_group_removal_reason
name|removal_reason
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|char
modifier|*
name|gtype
decl_stmt|;
specifier|const
name|char
modifier|*
name|reason
decl_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * The current SSID was not known, but there may still be a 		 * pending P2P group interface waiting for provisioning or a 		 * P2P group that is trying to reconnect. 		 */
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
while|while
condition|(
name|ssid
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|p2p_group
operator|&&
name|ssid
operator|->
name|disabled
operator|!=
literal|2
condition|)
break|break;
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|&&
name|wpa_s
operator|->
name|p2p_group_interface
operator|==
name|NOT_P2P_GROUP_INTERFACE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: P2P group interface "
literal|"not found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_group_interface
operator|==
name|P2P_GROUP_INTERFACE_GO
condition|)
name|gtype
operator|=
literal|"GO"
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|p2p_group_interface
operator|==
name|P2P_GROUP_INTERFACE_CLIENT
operator|||
operator|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|reassociate
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|disconnected
operator|=
literal|1
expr_stmt|;
name|gtype
operator|=
literal|"client"
expr_stmt|;
block|}
else|else
name|gtype
operator|=
literal|"GO"
expr_stmt|;
if|if
condition|(
name|removal_reason
operator|!=
name|P2P_GROUP_REMOVAL_SILENT
operator|&&
name|ssid
condition|)
name|wpas_notify_p2p_group_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|gtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|gtype
argument_list|,
literal|"client"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
if|if
condition|(
name|eloop_is_timeout_registered
argument_list|(
name|wpas_p2p_psk_failure_removal
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: PSK failure removal was scheduled, so use PSK failure as reason for group removal"
argument_list|)
expr_stmt|;
name|removal_reason
operator|=
name|P2P_GROUP_REMOVAL_PSK_FAILURE
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_psk_failure_removal
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|cross_connect_in_use
condition|)
block|{
name|wpa_s
operator|->
name|cross_connect_in_use
operator|=
literal|0
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_CROSS_CONNECT_DISABLE
literal|"%s %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|removal_reason
condition|)
block|{
case|case
name|P2P_GROUP_REMOVAL_REQUESTED
case|:
name|reason
operator|=
literal|" reason=REQUESTED"
expr_stmt|;
break|break;
case|case
name|P2P_GROUP_REMOVAL_FORMATION_FAILED
case|:
name|reason
operator|=
literal|" reason=FORMATION_FAILED"
expr_stmt|;
break|break;
case|case
name|P2P_GROUP_REMOVAL_IDLE_TIMEOUT
case|:
name|reason
operator|=
literal|" reason=IDLE"
expr_stmt|;
break|break;
case|case
name|P2P_GROUP_REMOVAL_UNAVAILABLE
case|:
name|reason
operator|=
literal|" reason=UNAVAILABLE"
expr_stmt|;
break|break;
case|case
name|P2P_GROUP_REMOVAL_GO_ENDING_SESSION
case|:
name|reason
operator|=
literal|" reason=GO_ENDING_SESSION"
expr_stmt|;
break|break;
case|case
name|P2P_GROUP_REMOVAL_PSK_FAILURE
case|:
name|reason
operator|=
literal|" reason=PSK_FAILURE"
expr_stmt|;
break|break;
case|case
name|P2P_GROUP_REMOVAL_FREQ_CONFLICT
case|:
name|reason
operator|=
literal|" reason=FREQ_CONFLICT"
expr_stmt|;
break|break;
default|default:
name|reason
operator|=
literal|""
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|removal_reason
operator|!=
name|P2P_GROUP_REMOVAL_SILENT
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_REMOVED
literal|"%s %s%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|gtype
argument_list|,
name|reason
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_freq_conflict
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancelled P2P group freq_conflict timeout"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancelled P2P group idle timeout"
argument_list|)
expr_stmt|;
if|if
condition|(
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancelled P2P group formation "
literal|"timeout"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_s
operator|->
name|p2p_in_invitation
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Make sure wait for the first client does not remain active after the 	 * group has been removed. 	 */
name|wpa_s
operator|->
name|global
operator|->
name|p2p_go_wait_client
operator|.
name|sec
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_group_interface
operator|!=
name|NOT_P2P_GROUP_INTERFACE
condition|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
decl_stmt|;
name|char
modifier|*
name|ifname
decl_stmt|;
name|enum
name|wpa_driver_if_type
name|type
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove group interface %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|global
operator|=
name|wpa_s
operator|->
name|global
expr_stmt|;
name|ifname
operator|=
name|os_strdup
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|type
operator|=
name|wpas_p2p_if_type
argument_list|(
name|wpa_s
operator|->
name|p2p_group_interface
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|run_wpas_p2p_disconnect
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_supplicant_remove_iface
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|&&
name|ifname
condition|)
name|wpa_drv_if_remove
argument_list|(
name|wpa_s
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_go_group_formation_completed
condition|)
block|{
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|go_params
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|go_params
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|p2p_group_common_freqs
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group_common_freqs
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group_common_freqs_num
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|waiting_presence_resp
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove temporary group network"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
operator|(
name|ssid
operator|->
name|p2p_group
operator|||
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GROUP_FORMATION
operator|||
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
operator|)
condition|)
block|{
name|int
name|id
init|=
name|ssid
operator|->
name|id
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|wpa_sm_set_config
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* 		 * Networks objects created during any P2P activities are not 		 * exposed out as they might/will confuse certain non-P2P aware 		 * applications since these network objects won't behave like 		 * regular ones. 		 * 		 * Likewise, we don't send out network removed signals for such 		 * network objects. 		 */
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpa_supplicant_clear_status
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Temporary group network not "
literal|"found"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
name|wpa_supplicant_ap_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
else|else
name|wpa_drv_deinit_p2p_cli
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_persistent_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
specifier|const
name|u8
modifier|*
name|bssid
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|p2p
decl_stmt|;
name|u8
name|group_capab
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|go_params
condition|)
name|bssid
operator|=
name|wpa_s
operator|->
name|go_params
operator|->
name|peer_interface_addr
expr_stmt|;
else|else
name|bssid
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
operator|&&
name|wpa_s
operator|->
name|go_params
operator|&&
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|go_params
operator|->
name|peer_device_addr
argument_list|)
condition|)
name|bss
operator|=
name|wpa_bss_get_p2p_dev_addr
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|go_params
operator|->
name|peer_device_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|u8
name|iface_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|p2p_get_interface_addr
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|bssid
argument_list|,
name|iface_addr
argument_list|)
operator|==
literal|0
condition|)
name|bss
operator|=
name|wpa_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|iface_addr
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not figure out whether "
literal|"group is persistent - BSS "
name|MACSTR
literal|" not found"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|p2p
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
condition|)
name|p2p
operator|=
name|wpa_bss_get_vendor_ie_multi_beacon
argument_list|(
name|bss
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not figure out whether "
literal|"group is persistent - BSS "
name|MACSTR
literal|" did not include P2P IE"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Probe Response IEs"
argument_list|,
operator|(
name|u8
operator|*
operator|)
operator|(
name|bss
operator|+
literal|1
operator|)
argument_list|,
name|bss
operator|->
name|ie_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Beacon IEs"
argument_list|,
operator|(
operator|(
name|u8
operator|*
operator|)
name|bss
operator|+
literal|1
operator|)
operator|+
name|bss
operator|->
name|ie_len
argument_list|,
name|bss
operator|->
name|beacon_ie_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|group_capab
operator|=
name|p2p_get_group_capab
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|addr
operator|=
name|p2p_get_go_dev_addr
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Checking whether group is persistent: "
literal|"group_capab=0x%x"
argument_list|,
name|group_capab
argument_list|)
expr_stmt|;
if|if
condition|(
name|addr
condition|)
block|{
name|os_memcpy
argument_list|(
name|go_dev_addr
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO Device Address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|os_memset
argument_list|(
name|go_dev_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: BSS "
name|MACSTR
literal|" group_capab=0x%x "
literal|"go_dev_addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|,
name|group_capab
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|group_capab
operator|&
name|P2P_GROUP_CAPAB_PERSISTENT_GROUP
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_store_persistent_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|int
name|changed
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Storing credentials for a persistent "
literal|"group (GO Dev Addr "
name|MACSTR
literal|")"
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|==
literal|2
operator|&&
name|os_memcmp
argument_list|(
name|go_dev_addr
argument_list|,
name|s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|s
operator|->
name|ssid_len
operator|==
name|ssid
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|s
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Update existing persistent group "
literal|"entry"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|&&
operator|!
name|s
operator|->
name|passphrase
condition|)
name|changed
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|&&
name|s
operator|->
name|passphrase
operator|&&
name|os_strcmp
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|,
name|s
operator|->
name|passphrase
argument_list|)
operator|!=
literal|0
condition|)
name|changed
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Create a new persistent group "
literal|"entry"
argument_list|)
expr_stmt|;
name|changed
operator|=
literal|1
expr_stmt|;
name|s
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
comment|/* 		 * Instead of network_added we emit persistent_group_added 		 * notification. Also to keep the defense checks in 		 * persistent_group obj registration method, we set the 		 * relevant flags in s to designate it as a persistent group. 		 */
name|s
operator|->
name|p2p_group
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|p2p_persistent_group
operator|=
literal|1
expr_stmt|;
name|wpas_notify_persistent_group_added
argument_list|(
name|wpa_s
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|s
operator|->
name|p2p_group
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|p2p_persistent_group
operator|=
literal|1
expr_stmt|;
name|s
operator|->
name|disabled
operator|=
literal|2
expr_stmt|;
name|s
operator|->
name|bssid_set
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|bssid
argument_list|,
name|go_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|s
operator|->
name|mode
operator|=
name|ssid
operator|->
name|mode
expr_stmt|;
name|s
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|s
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|s
operator|->
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
name|s
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|s
operator|->
name|export_keys
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
condition|)
block|{
name|os_free
argument_list|(
name|s
operator|->
name|passphrase
argument_list|)
expr_stmt|;
name|s
operator|->
name|passphrase
operator|=
name|os_strdup
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|s
operator|->
name|psk_set
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|psk
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|->
name|passphrase
operator|&&
operator|!
name|s
operator|->
name|psk_set
condition|)
name|wpa_config_update_psk
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|ssid
operator|==
name|NULL
operator|||
name|s
operator|->
name|ssid_len
operator|<
name|ssid
operator|->
name|ssid_len
condition|)
block|{
name|os_free
argument_list|(
name|s
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|s
operator|->
name|ssid
operator|=
name|os_malloc
argument_list|(
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|->
name|ssid
condition|)
block|{
name|s
operator|->
name|ssid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
condition|)
block|{
name|dl_list_add
argument_list|(
operator|&
name|s
operator|->
name|psk_list
argument_list|,
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
operator|=
name|NULL
expr_stmt|;
name|changed
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|changed
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|conf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to update configuration"
argument_list|)
expr_stmt|;
block|}
return|return
name|s
operator|->
name|id
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_add_persistent_group_client
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|u8
modifier|*
name|n
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|||
operator|!
name|ssid
operator|->
name|p2p_persistent_group
condition|)
return|return;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|!=
literal|2
operator|||
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
continue|continue;
if|if
condition|(
name|s
operator|->
name|ssid_len
operator|==
name|ssid
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|s
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|s
operator|->
name|p2p_client_list
operator|&&
name|i
operator|<
name|s
operator|->
name|num_p2p_clients
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|i
operator|==
name|s
operator|->
name|num_p2p_clients
operator|-
literal|1
condition|)
return|return;
comment|/* already the most recent entry */
comment|/* move the entry to mark it most recent */
name|os_memmove
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|s
operator|->
name|p2p_client_list
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
name|i
operator|-
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
operator|+
name|ETH_ALEN
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|found
operator|&&
name|s
operator|->
name|num_p2p_clients
operator|<
name|P2P_MAX_STORED_CLIENTS
condition|)
block|{
name|n
operator|=
name|os_realloc_array
argument_list|(
name|s
operator|->
name|p2p_client_list
argument_list|,
name|s
operator|->
name|num_p2p_clients
operator|+
literal|1
argument_list|,
literal|2
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|n
operator|+
name|s
operator|->
name|num_p2p_clients
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|n
operator|+
name|s
operator|->
name|num_p2p_clients
operator|*
literal|2
operator|*
name|ETH_ALEN
operator|+
name|ETH_ALEN
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|s
operator|->
name|p2p_client_list
operator|=
name|n
expr_stmt|;
name|s
operator|->
name|num_p2p_clients
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|found
operator|&&
name|s
operator|->
name|p2p_client_list
condition|)
block|{
comment|/* Not enough room for an additional entry - drop the oldest 		 * entry */
name|os_memmove
argument_list|(
name|s
operator|->
name|p2p_client_list
argument_list|,
name|s
operator|->
name|p2p_client_list
operator|+
literal|2
operator|*
name|ETH_ALEN
argument_list|,
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
operator|+
name|ETH_ALEN
argument_list|,
literal|0xff
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|parent
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|conf
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to update configuration"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_group_started
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|go
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
specifier|const
name|char
modifier|*
name|passphrase
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
name|int
name|persistent
parameter_list|,
specifier|const
name|char
modifier|*
name|extra
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|ssid_txt
decl_stmt|;
name|char
name|psk_txt
index|[
literal|65
index|]
decl_stmt|;
if|if
condition|(
name|psk
condition|)
name|wpa_snprintf_hex
argument_list|(
name|psk_txt
argument_list|,
sizeof|sizeof
argument_list|(
name|psk_txt
argument_list|)
argument_list|,
name|psk
argument_list|,
literal|32
argument_list|)
expr_stmt|;
else|else
name|psk_txt
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|ssid
condition|)
name|ssid_txt
operator|=
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
else|else
name|ssid_txt
operator|=
literal|""
expr_stmt|;
if|if
condition|(
name|passphrase
operator|&&
name|passphrase
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|passphrase
operator|=
name|NULL
expr_stmt|;
comment|/* 	 * Include PSK/passphrase only in the control interface message and 	 * leave it out from the debug log entry. 	 */
name|wpa_msg_global_ctrl
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_STARTED
literal|"%s %s ssid=\"%s\" freq=%d%s%s%s%s%s go_dev_addr="
name|MACSTR
literal|"%s%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|go
condition|?
literal|"GO"
else|:
literal|"client"
argument_list|,
name|ssid_txt
argument_list|,
name|freq
argument_list|,
name|psk
condition|?
literal|" psk="
else|:
literal|""
argument_list|,
name|psk_txt
argument_list|,
name|passphrase
condition|?
literal|" passphrase=\""
else|:
literal|""
argument_list|,
name|passphrase
condition|?
name|passphrase
else|:
literal|""
argument_list|,
name|passphrase
condition|?
literal|"\""
else|:
literal|""
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|,
name|persistent
condition|?
literal|" [PERSISTENT]"
else|:
literal|""
argument_list|,
name|extra
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_STARTED
literal|"%s %s ssid=\"%s\" freq=%d go_dev_addr="
name|MACSTR
literal|"%s%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|go
condition|?
literal|"GO"
else|:
literal|"client"
argument_list|,
name|ssid_txt
argument_list|,
name|freq
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|,
name|persistent
condition|?
literal|" [PERSISTENT]"
else|:
literal|""
argument_list|,
name|extra
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_group_formation_completed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|success
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|client
decl_stmt|;
name|int
name|persistent
decl_stmt|;
name|u8
name|go_dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|network_id
init|=
operator|-
literal|1
decl_stmt|;
comment|/* 	 * This callback is likely called for the main interface. Update wpa_s 	 * to use the group interface if a new interface was created for the 	 * group. 	 */
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
condition|)
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_go_group_formation_completed
condition|)
block|{
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_s
operator|->
name|p2p_in_invitation
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|group_formation_reported
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|success
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_FORMATION_FAILURE
argument_list|)
expr_stmt|;
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_FORMATION_FAILED
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_FORMATION_SUCCESS
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GROUP_FORMATION
condition|)
block|{
name|ssid
operator|->
name|mode
operator|=
name|WPAS_MODE_P2P_GO
expr_stmt|;
name|p2p_group_notif_formation_done
argument_list|(
name|wpa_s
operator|->
name|p2p_group
argument_list|)
expr_stmt|;
name|wpa_supplicant_ap_mac_addr_filter
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|persistent
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
condition|)
block|{
name|client
operator|=
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
name|persistent
operator|=
name|ssid
operator|->
name|p2p_persistent_group
expr_stmt|;
name|os_memcpy
argument_list|(
name|go_dev_addr
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
name|persistent
operator|=
name|wpas_p2p_persistent_group
argument_list|(
name|wpa_s
argument_list|,
name|go_dev_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|client
operator|=
name|wpa_s
operator|->
name|p2p_group_interface
operator|==
name|P2P_GROUP_INTERFACE_CLIENT
expr_stmt|;
name|os_memset
argument_list|(
name|go_dev_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|client
condition|)
block|{
comment|/* 		 * Indicate event only after successfully completed 4-way 		 * handshake, i.e., when the interface is ready for data 		 * packets. 		 */
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpas_p2p_group_started
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
name|ssid
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|frequency
else|:
literal|0
argument_list|,
name|ssid
operator|&&
name|ssid
operator|->
name|passphrase
operator|==
name|NULL
operator|&&
name|ssid
operator|->
name|psk_set
condition|?
name|ssid
operator|->
name|psk
else|:
name|NULL
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|passphrase
else|:
name|NULL
argument_list|,
name|go_dev_addr
argument_list|,
name|persistent
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|wpas_p2p_cross_connect_setup
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_p2p_set_group_idle_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|persistent
condition|)
name|network_id
operator|=
name|wpas_p2p_store_persistent_group
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|ssid
argument_list|,
name|go_dev_addr
argument_list|)
expr_stmt|;
else|else
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|network_id
operator|<
literal|0
operator|&&
name|ssid
condition|)
name|network_id
operator|=
name|ssid
operator|->
name|id
expr_stmt|;
if|if
condition|(
operator|!
name|client
condition|)
block|{
name|wpas_notify_p2p_group_started
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|network_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_go_wait_client
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|send_action_work
block|{
name|unsigned
name|int
name|freq
decl_stmt|;
name|u8
name|dst
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|src
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|unsigned
name|int
name|wait_time
decl_stmt|;
name|u8
name|buf
index|[
literal|0
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|wpas_p2p_send_action_work_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_send_action_work
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Send Action frame radio work timed out"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|p2p_send_action_work
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|radio_work_done
argument_list|(
name|wpa_s
operator|->
name|p2p_send_action_work
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_send_action_work
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_action_tx_clear
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|p2p_send_action_work
condition|)
block|{
name|struct
name|send_action_work
modifier|*
name|awork
decl_stmt|;
name|awork
operator|=
name|wpa_s
operator|->
name|p2p_send_action_work
operator|->
name|ctx
expr_stmt|;
if|if
condition|(
name|awork
operator|->
name|wait_time
operator|==
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|awork
argument_list|)
expr_stmt|;
name|radio_work_done
argument_list|(
name|wpa_s
operator|->
name|p2p_send_action_work
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_send_action_work
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * In theory, this should not be needed, but number of 			 * places in the P2P code is still using non-zero wait 			 * time for the last Action frame in the sequence and 			 * some of these do not call send_action_done(). 			 */
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_send_action_work_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
name|awork
operator|->
name|wait_time
operator|*
literal|1000
argument_list|,
name|wpas_p2p_send_action_work_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_send_action_tx_status
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|data_len
parameter_list|,
name|enum
name|offchannel_send_action_result
name|result
parameter_list|)
block|{
name|enum
name|p2p_send_action_result
name|res
init|=
name|P2P_SEND_ACTION_SUCCESS
decl_stmt|;
name|wpas_p2p_action_tx_clear
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return;
switch|switch
condition|(
name|result
condition|)
block|{
case|case
name|OFFCHANNEL_SEND_ACTION_SUCCESS
case|:
name|res
operator|=
name|P2P_SEND_ACTION_SUCCESS
expr_stmt|;
break|break;
case|case
name|OFFCHANNEL_SEND_ACTION_NO_ACK
case|:
name|res
operator|=
name|P2P_SEND_ACTION_NO_ACK
expr_stmt|;
break|break;
case|case
name|OFFCHANNEL_SEND_ACTION_FAILED
case|:
name|res
operator|=
name|P2P_SEND_ACTION_FAILED
expr_stmt|;
break|break;
block|}
name|p2p_send_action_cb
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|src
argument_list|,
name|bssid
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|OFFCHANNEL_SEND_ACTION_SUCCESS
operator|&&
name|wpa_s
operator|->
name|pending_pd_before_join
operator|&&
operator|(
name|os_memcmp
argument_list|(
name|dst
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|||
name|os_memcmp
argument_list|(
name|dst
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
operator|&&
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
condition|)
block|{
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: No ACK for PD Req "
literal|"during p2p_connect-auto"
argument_list|)
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_FALLBACK_TO_GO_NEG
literal|"reason=no-ACK-to-PD-Req"
argument_list|)
expr_stmt|;
name|wpas_p2p_fallback_to_go_neg
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_send_action_cb
parameter_list|(
name|struct
name|wpa_radio_work
modifier|*
name|work
parameter_list|,
name|int
name|deinit
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|work
operator|->
name|wpa_s
decl_stmt|;
name|struct
name|send_action_work
modifier|*
name|awork
init|=
name|work
operator|->
name|ctx
decl_stmt|;
if|if
condition|(
name|deinit
condition|)
block|{
if|if
condition|(
name|work
operator|->
name|started
condition|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_send_action_work_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_send_action_work
operator|=
name|NULL
expr_stmt|;
name|offchannel_send_action_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|awork
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|offchannel_send_action
argument_list|(
name|wpa_s
argument_list|,
name|awork
operator|->
name|freq
argument_list|,
name|awork
operator|->
name|dst
argument_list|,
name|awork
operator|->
name|src
argument_list|,
name|awork
operator|->
name|bssid
argument_list|,
name|awork
operator|->
name|buf
argument_list|,
name|awork
operator|->
name|len
argument_list|,
name|awork
operator|->
name|wait_time
argument_list|,
name|wpas_p2p_send_action_tx_status
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|awork
argument_list|)
expr_stmt|;
name|radio_work_done
argument_list|(
name|work
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|p2p_send_action_work
operator|=
name|work
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_send_action_work
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|unsigned
name|int
name|wait_time
parameter_list|)
block|{
name|struct
name|send_action_work
modifier|*
name|awork
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_send_action_work
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cannot schedule new p2p-send-action work since one is already pending"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|awork
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|awork
argument_list|)
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|awork
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|awork
operator|->
name|freq
operator|=
name|freq
expr_stmt|;
name|os_memcpy
argument_list|(
name|awork
operator|->
name|dst
argument_list|,
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|awork
operator|->
name|src
argument_list|,
name|src
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|awork
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|awork
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|awork
operator|->
name|wait_time
operator|=
name|wait_time
expr_stmt|;
name|os_memcpy
argument_list|(
name|awork
operator|->
name|buf
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|radio_add_work
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
literal|"p2p-send-action"
argument_list|,
literal|0
argument_list|,
name|wpas_send_action_cb
argument_list|,
name|awork
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|awork
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_send_action
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|unsigned
name|int
name|wait_time
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|int
name|listen_freq
init|=
operator|-
literal|1
decl_stmt|,
name|send_freq
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_listen_work
condition|)
name|listen_freq
operator|=
name|wpa_s
operator|->
name|p2p_listen_work
operator|->
name|freq
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_send_action_work
condition|)
name|send_freq
operator|=
name|wpa_s
operator|->
name|p2p_send_action_work
operator|->
name|freq
expr_stmt|;
if|if
condition|(
name|listen_freq
operator|!=
operator|(
name|int
operator|)
name|freq
operator|&&
name|send_freq
operator|!=
operator|(
name|int
operator|)
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Schedule new radio work for Action frame TX (listen_freq=%d send_freq=%d)"
argument_list|,
name|listen_freq
argument_list|,
name|send_freq
argument_list|)
expr_stmt|;
return|return
name|wpas_send_action_work
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|src
argument_list|,
name|bssid
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|wait_time
argument_list|)
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use ongoing radio work for Action frame TX"
argument_list|)
expr_stmt|;
return|return
name|offchannel_send_action
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|src
argument_list|,
name|bssid
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|wait_time
argument_list|,
name|wpas_p2p_send_action_tx_status
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_send_action_done
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_send_action_work
condition|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_send_action_work_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|p2p_send_action_work
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|radio_work_done
argument_list|(
name|wpa_s
operator|->
name|p2p_send_action_work
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_send_action_work
operator|=
name|NULL
expr_stmt|;
block|}
name|offchannel_send_action_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_copy_go_neg_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|params
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|go_params
operator|==
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|go_params
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|params
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|go_params
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|go_params
argument_list|,
name|params
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|params
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_start_wps_enrollee
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|res
parameter_list|)
block|{
name|wpa_s
operator|->
name|group_formation_reported
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Start WPS Enrollee for peer "
name|MACSTR
literal|" dev_addr "
name|MACSTR
literal|" wps_method %d"
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|peer_interface_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|peer_device_addr
argument_list|)
argument_list|,
name|res
operator|->
name|wps_method
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Start WPS Enrollee for SSID"
argument_list|,
name|res
operator|->
name|ssid
argument_list|,
name|res
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_supplicant_ap_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_copy_go_neg_results
argument_list|(
name|wpa_s
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|wps_method
operator|==
name|WPS_PBC
condition|)
block|{
name|wpas_wps_start_pbc
argument_list|(
name|wpa_s
argument_list|,
name|res
operator|->
name|peer_interface_addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
block|}
elseif|else
if|if
condition|(
name|res
operator|->
name|wps_method
operator|==
name|WPS_NFC
condition|)
block|{
name|wpas_wps_start_nfc
argument_list|(
name|wpa_s
argument_list|,
name|res
operator|->
name|peer_device_addr
argument_list|,
name|res
operator|->
name|peer_interface_addr
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw_id
argument_list|,
literal|1
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw_id
operator|==
name|DEV_PW_NFC_CONNECTION_HANDOVER
condition|?
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_peer_oob_pubkey_hash
else|:
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
block|}
else|else
block|{
name|u16
name|dev_pw_id
init|=
name|DEV_PW_DEFAULT
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_wps_method
operator|==
name|WPS_P2PS
condition|)
name|dev_pw_id
operator|=
name|DEV_PW_P2PS_DEFAULT
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_wps_method
operator|==
name|WPS_PIN_KEYPAD
condition|)
name|dev_pw_id
operator|=
name|DEV_PW_REGISTRAR_SPECIFIED
expr_stmt|;
name|wpas_wps_start_pin
argument_list|(
name|wpa_s
argument_list|,
name|res
operator|->
name|peer_interface_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
literal|1
argument_list|,
name|dev_pw_id
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_add_psk_list
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|persistent
decl_stmt|;
name|struct
name|psk_list_entry
modifier|*
name|psk
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
condition|)
return|return;
name|persistent
operator|=
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|persistent
operator|==
name|NULL
condition|)
return|return;
name|hapd
operator|=
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|psk
argument_list|,
argument|&persistent->psk_list
argument_list|,
argument|struct psk_list_entry
argument_list|,
argument|list
argument_list|)
block|{
name|struct
name|hostapd_wpa_psk
modifier|*
name|hpsk
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add persistent group PSK entry for "
name|MACSTR
literal|" psk=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|psk
operator|->
name|addr
argument_list|)
argument_list|,
name|psk
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|hpsk
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|hpsk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|hpsk
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|hpsk
operator|->
name|psk
argument_list|,
name|psk
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|psk
operator|->
name|p2p
condition|)
name|os_memcpy
argument_list|(
name|hpsk
operator|->
name|p2p_dev_addr
argument_list|,
name|psk
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|os_memcpy
argument_list|(
name|hpsk
operator|->
name|addr
argument_list|,
name|psk
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|hpsk
operator|->
name|next
operator|=
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
expr_stmt|;
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
operator|=
name|hpsk
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_go_dump_common_freqs
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Common group frequencies (len=%u):"
argument_list|,
name|wpa_s
operator|->
name|p2p_group_common_freqs_num
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|p2p_group_common_freqs_num
condition|;
name|i
operator|++
control|)
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"freq[%u]: %d"
argument_list|,
name|i
argument_list|,
name|wpa_s
operator|->
name|p2p_group_common_freqs
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_go_save_group_common_freqs
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|params
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|len
init|=
name|int_array_len
argument_list|(
name|wpa_s
operator|->
name|go_params
operator|->
name|freq_list
argument_list|)
decl_stmt|;
name|wpa_s
operator|->
name|p2p_group_common_freqs_num
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|p2p_group_common_freqs
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group_common_freqs
operator|=
name|os_calloc
argument_list|(
name|len
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_group_common_freqs
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|go_params
operator|->
name|freq_list
index|[
name|i
index|]
condition|)
break|break;
name|wpa_s
operator|->
name|p2p_group_common_freqs
index|[
name|i
index|]
operator|=
name|wpa_s
operator|->
name|go_params
operator|->
name|freq_list
index|[
name|i
index|]
expr_stmt|;
block|}
name|wpa_s
operator|->
name|p2p_group_common_freqs_num
operator|=
name|i
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_config_write
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_WRITE
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|parent
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|conf
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to update configuration"
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_CONFIG_WRITE */
block|}
end_function

begin_function
specifier|static
name|void
name|p2p_go_configured
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|p2p_go_neg_results
modifier|*
name|params
init|=
name|data
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|network_id
init|=
operator|-
literal|1
decl_stmt|;
name|p2p_go_save_group_common_freqs
argument_list|(
name|wpa_s
argument_list|,
name|params
argument_list|)
expr_stmt|;
name|p2p_go_dump_common_freqs
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Group setup without provisioning"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|==
name|wpa_s
condition|)
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|NULL
expr_stmt|;
name|wpas_p2p_group_started
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
name|ssid
argument_list|,
name|ssid
operator|->
name|frequency
argument_list|,
name|params
operator|->
name|passphrase
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|?
name|params
operator|->
name|psk
else|:
name|NULL
argument_list|,
name|params
operator|->
name|passphrase
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|,
name|params
operator|->
name|persistent_group
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|group_formation_reported
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|p2ps_join_addr_valid
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2PS: Setting default PIN for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|parent
operator|->
name|p2ps_join_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_ap_wps_pin
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2ps_join_addr
argument_list|,
literal|"12345670"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|parent
operator|->
name|p2ps_join_addr_valid
operator|=
literal|0
expr_stmt|;
block|}
name|os_get_reltime
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_go_wait_client
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|persistent_group
condition|)
block|{
name|network_id
operator|=
name|wpas_p2p_store_persistent_group
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|ssid
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|)
expr_stmt|;
name|wpas_p2p_add_psk_list
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|network_id
operator|<
literal|0
condition|)
name|network_id
operator|=
name|ssid
operator|->
name|id
expr_stmt|;
name|wpas_notify_p2p_group_started
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|network_id
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpas_p2p_cross_connect_setup
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_p2p_set_group_idle_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_first_connection_timeout
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Start group formation timeout of %d seconds until first data connection on GO"
argument_list|,
name|wpa_s
operator|->
name|p2p_first_connection_timeout
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_group_formation_completed
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|wpa_s
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|wpa_s
operator|->
name|p2p_first_connection_timeout
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Setting up WPS for GO provisioning"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_supplicant_ap_mac_addr_filter
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|peer_interface_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to setup MAC address "
literal|"filtering"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|params
operator|->
name|wps_method
operator|==
name|WPS_PBC
condition|)
block|{
name|wpa_supplicant_ap_wps_pbc
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|peer_interface_addr
argument_list|,
name|params
operator|->
name|peer_device_addr
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
block|}
elseif|else
if|if
condition|(
name|params
operator|->
name|wps_method
operator|==
name|WPS_NFC
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw_id
operator|!=
name|DEV_PW_NFC_CONNECTION_HANDOVER
operator|&&
operator|!
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No NFC Dev Pw known"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpas_ap_wps_add_nfc_pw
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw_id
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_peer_oob_pk_hash_known
condition|?
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_peer_oob_pubkey_hash
else|:
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|p2p_pin
index|[
literal|0
index|]
condition|)
name|wpa_supplicant_ap_wps_pin
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|peer_interface_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|go_params
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|go_params
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_start_wps_go
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|params
parameter_list|,
name|int
name|group_formation
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Starting GO"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpas_copy_go_neg_results
argument_list|(
name|wpa_s
argument_list|,
name|params
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not copy GO Negotiation "
literal|"results"
argument_list|)
expr_stmt|;
return|return;
block|}
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not add network for GO"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_group_formation_completed
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|group_formation_reported
operator|=
literal|0
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|p2p_group
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|p2p_persistent_group
operator|=
name|params
operator|->
name|persistent_group
expr_stmt|;
name|ssid
operator|->
name|mode
operator|=
name|group_formation
condition|?
name|WPAS_MODE_P2P_GROUP_FORMATION
else|:
name|WPAS_MODE_P2P_GO
expr_stmt|;
name|ssid
operator|->
name|frequency
operator|=
name|params
operator|->
name|freq
expr_stmt|;
name|ssid
operator|->
name|ht40
operator|=
name|params
operator|->
name|ht40
expr_stmt|;
name|ssid
operator|->
name|vht
operator|=
name|params
operator|->
name|vht
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_zalloc
argument_list|(
name|params
operator|->
name|ssid_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
condition|)
block|{
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
block|}
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
name|ssid
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|ssid
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|freq
operator|>
literal|56160
condition|)
block|{
comment|/* 		 * Enable GCMP instead of CCMP as pairwise_cipher and 		 * group_cipher in 60 GHz. 		 */
name|ssid
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_GCMP
expr_stmt|;
name|ssid
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_GCMP
expr_stmt|;
block|}
if|if
condition|(
name|os_strlen
argument_list|(
name|params
operator|->
name|passphrase
argument_list|)
operator|>
literal|0
condition|)
block|{
name|ssid
operator|->
name|passphrase
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|passphrase
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|==
name|NULL
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to copy passphrase for GO"
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
else|else
name|ssid
operator|->
name|passphrase
operator|=
name|NULL
expr_stmt|;
name|ssid
operator|->
name|psk_set
operator|=
name|params
operator|->
name|psk_set
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|psk_set
condition|)
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|psk
argument_list|,
name|params
operator|->
name|psk
argument_list|,
sizeof|sizeof
argument_list|(
name|ssid
operator|->
name|psk
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|passphrase
condition|)
name|wpa_config_update_psk
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ap_max_inactivity
operator|=
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|p2p_go_max_inactivity
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb
operator|=
name|p2p_go_configured
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb_ctx
operator|=
name|wpa_s
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb_data
operator|=
name|wpa_s
operator|->
name|go_params
expr_stmt|;
name|wpa_s
operator|->
name|scan_req
operator|=
name|NORMAL_SCAN_REQ
expr_stmt|;
name|wpa_s
operator|->
name|connect_without_scan
operator|=
name|ssid
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|disconnected
operator|=
literal|0
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Request scan (that will be skipped) to "
literal|"start GO)"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_clone_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpa_supplicant
modifier|*
name|src
parameter_list|)
block|{
name|struct
name|wpa_config
modifier|*
name|d
decl_stmt|;
specifier|const
name|struct
name|wpa_config
modifier|*
name|s
decl_stmt|;
name|d
operator|=
name|dst
operator|->
name|conf
expr_stmt|;
name|s
operator|=
name|src
operator|->
name|conf
expr_stmt|;
define|#
directive|define
name|C
parameter_list|(
name|n
parameter_list|)
value|if (s->n) d->n = os_strdup(s->n)
name|C
argument_list|(
name|device_name
argument_list|)
expr_stmt|;
name|C
argument_list|(
name|manufacturer
argument_list|)
expr_stmt|;
name|C
argument_list|(
name|model_name
argument_list|)
expr_stmt|;
name|C
argument_list|(
name|model_number
argument_list|)
expr_stmt|;
name|C
argument_list|(
name|serial_number
argument_list|)
expr_stmt|;
name|C
argument_list|(
name|config_methods
argument_list|)
expr_stmt|;
undef|#
directive|undef
name|C
name|os_memcpy
argument_list|(
name|d
operator|->
name|device_type
argument_list|,
name|s
operator|->
name|device_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|d
operator|->
name|sec_device_type
argument_list|,
name|s
operator|->
name|sec_device_type
argument_list|,
sizeof|sizeof
argument_list|(
name|d
operator|->
name|sec_device_type
argument_list|)
argument_list|)
expr_stmt|;
name|d
operator|->
name|num_sec_device_types
operator|=
name|s
operator|->
name|num_sec_device_types
expr_stmt|;
name|d
operator|->
name|p2p_group_idle
operator|=
name|s
operator|->
name|p2p_group_idle
expr_stmt|;
name|d
operator|->
name|p2p_intra_bss
operator|=
name|s
operator|->
name|p2p_intra_bss
expr_stmt|;
name|d
operator|->
name|persistent_reconnect
operator|=
name|s
operator|->
name|persistent_reconnect
expr_stmt|;
name|d
operator|->
name|max_num_sta
operator|=
name|s
operator|->
name|max_num_sta
expr_stmt|;
name|d
operator|->
name|pbc_in_m1
operator|=
name|s
operator|->
name|pbc_in_m1
expr_stmt|;
name|d
operator|->
name|ignore_old_scan_res
operator|=
name|s
operator|->
name|ignore_old_scan_res
expr_stmt|;
name|d
operator|->
name|beacon_int
operator|=
name|s
operator|->
name|beacon_int
expr_stmt|;
name|d
operator|->
name|dtim_period
operator|=
name|s
operator|->
name|dtim_period
expr_stmt|;
name|d
operator|->
name|p2p_go_ctwindow
operator|=
name|s
operator|->
name|p2p_go_ctwindow
expr_stmt|;
name|d
operator|->
name|disassoc_low_ack
operator|=
name|s
operator|->
name|disassoc_low_ack
expr_stmt|;
name|d
operator|->
name|disable_scan_offload
operator|=
name|s
operator|->
name|disable_scan_offload
expr_stmt|;
name|d
operator|->
name|passive_scan
operator|=
name|s
operator|->
name|passive_scan
expr_stmt|;
if|if
condition|(
name|s
operator|->
name|wps_nfc_dh_privkey
operator|&&
name|s
operator|->
name|wps_nfc_dh_pubkey
condition|)
block|{
name|d
operator|->
name|wps_nfc_dh_privkey
operator|=
name|wpabuf_dup
argument_list|(
name|s
operator|->
name|wps_nfc_dh_privkey
argument_list|)
expr_stmt|;
name|d
operator|->
name|wps_nfc_dh_pubkey
operator|=
name|wpabuf_dup
argument_list|(
name|s
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_get_group_ifname
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|char
modifier|*
name|ifname
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
name|char
modifier|*
name|ifname_ptr
init|=
name|wpa_s
operator|->
name|ifname
decl_stmt|;
if|if
condition|(
name|os_strncmp
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|P2P_MGMT_DEVICE_PREFIX
argument_list|,
name|os_strlen
argument_list|(
name|P2P_MGMT_DEVICE_PREFIX
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ifname_ptr
operator|=
name|os_strrchr
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
literal|'-'
argument_list|)
operator|+
literal|1
expr_stmt|;
block|}
name|os_snprintf
argument_list|(
name|ifname
argument_list|,
name|len
argument_list|,
literal|"p2p-%s-%d"
argument_list|,
name|ifname_ptr
argument_list|,
name|wpa_s
operator|->
name|p2p_group_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strlen
argument_list|(
name|ifname
argument_list|)
operator|>=
name|IFNAMSIZ
operator|&&
name|os_strlen
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|)
operator|<
name|IFNAMSIZ
condition|)
block|{
name|int
name|res
decl_stmt|;
comment|/* Try to avoid going over the IFNAMSIZ length limit */
name|res
operator|=
name|os_snprintf
argument_list|(
name|ifname
argument_list|,
name|len
argument_list|,
literal|"p2p-%d"
argument_list|,
name|wpa_s
operator|->
name|p2p_group_idx
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|len
argument_list|,
name|res
argument_list|)
operator|&&
name|len
condition|)
name|ifname
index|[
name|len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_add_group_interface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|enum
name|wpa_driver_if_type
name|type
parameter_list|)
block|{
name|char
name|ifname
index|[
literal|120
index|]
decl_stmt|,
name|force_ifname
index|[
literal|120
index|]
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Pending virtual interface exists "
literal|"- skip creation of a new one"
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Pending virtual address "
literal|"unknown?! ifname='%s'"
argument_list|,
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
name|wpas_p2p_get_group_ifname
argument_list|(
name|wpa_s
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
argument_list|)
expr_stmt|;
name|force_ifname
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Create a new interface %s for the group"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group_idx
operator|++
expr_stmt|;
name|wpa_s
operator|->
name|pending_interface_type
operator|=
name|type
expr_stmt|;
if|if
condition|(
name|wpa_drv_if_add
argument_list|(
name|wpa_s
argument_list|,
name|type
argument_list|,
name|ifname
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|force_ifname
argument_list|,
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|,
name|NULL
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to create new group "
literal|"interface"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|force_ifname
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Driver forced interface name %s"
argument_list|,
name|force_ifname
argument_list|)
expr_stmt|;
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|pending_interface_name
argument_list|,
name|force_ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|pending_interface_name
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Created pending virtual interface %s addr "
name|MACSTR
argument_list|,
name|wpa_s
operator|->
name|pending_interface_name
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_remove_pending_group_interface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|||
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|)
condition|)
return|return;
comment|/* No pending virtual interface */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Removing pending group interface %s"
argument_list|,
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
expr_stmt|;
name|wpa_drv_if_remove
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_interface_type
argument_list|,
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|pending_group_iface_for_p2ps
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpas_p2p_init_group_interface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|wpa_interface
name|iface
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|group_wpa_s
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: No pending group interface"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* 		 * Something has forced us to remove the pending interface; try 		 * to create a new one and hope for the best that we will get 		 * the same local address. 		 */
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|go
condition|?
name|WPA_IF_P2P_GO
else|:
name|WPA_IF_P2P_CLIENT
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
block|}
name|os_memset
argument_list|(
operator|&
name|iface
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|iface
operator|.
name|ifname
operator|=
name|wpa_s
operator|->
name|pending_interface_name
expr_stmt|;
name|iface
operator|.
name|driver
operator|=
name|wpa_s
operator|->
name|driver
operator|->
name|name
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
operator|==
name|NULL
operator|&&
name|wpa_s
operator|->
name|parent
operator|!=
name|wpa_s
operator|&&
name|wpa_s
operator|->
name|p2p_mgmt
operator|&&
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_DEDICATED_P2P_DEVICE
operator|)
condition|)
name|iface
operator|.
name|ctrl_interface
operator|=
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|ctrl_interface
expr_stmt|;
else|else
name|iface
operator|.
name|ctrl_interface
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
expr_stmt|;
name|iface
operator|.
name|driver_param
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
expr_stmt|;
name|group_wpa_s
operator|=
name|wpa_supplicant_add_iface
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
operator|&
name|iface
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|group_wpa_s
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to create new "
literal|"wpa_supplicant interface"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|group_wpa_s
operator|->
name|p2p_group_interface
operator|=
name|go
condition|?
name|P2P_GROUP_INTERFACE_GO
else|:
name|P2P_GROUP_INTERFACE_CLIENT
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|group_wpa_s
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|pending_group_iface_for_p2ps
operator|=
literal|0
expr_stmt|;
name|wpas_p2p_clone_config
argument_list|(
name|group_wpa_s
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|group_wpa_s
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_group_formation_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Group Formation timed out"
argument_list|)
expr_stmt|;
name|wpas_p2p_group_formation_failed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_group_formation_failed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_group_formation_failed
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|wpas_group_formation_completed
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_grpform_fail_after_wps
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Reject group formation due to WPS provisioning failure"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_fail_on_wps_complete
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_ap_setup_failed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|!=
name|wpa_s
condition|)
return|return;
comment|/* Speed up group formation timeout since this cannot succeed */
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_go_neg_completed
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|res
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|||
name|wpa_s
operator|->
name|roc_waiting_drv_freq
condition|)
block|{
name|wpa_drv_cancel_remain_on_channel
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|->
name|status
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GO_NEG_FAILURE
literal|"status=%d"
argument_list|,
name|res
operator|->
name|status
argument_list|)
expr_stmt|;
name|wpas_notify_p2p_go_neg_completed
argument_list|(
name|wpa_s
argument_list|,
name|res
argument_list|)
expr_stmt|;
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_go_ht40
condition|)
name|res
operator|->
name|ht40
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_go_vht
condition|)
name|res
operator|->
name|vht
operator|=
literal|1
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GO_NEG_SUCCESS
literal|"role=%s "
literal|"freq=%d ht40=%d peer_dev="
name|MACSTR
literal|" peer_iface="
name|MACSTR
literal|" wps_method=%s"
argument_list|,
name|res
operator|->
name|role_go
condition|?
literal|"GO"
else|:
literal|"client"
argument_list|,
name|res
operator|->
name|freq
argument_list|,
name|res
operator|->
name|ht40
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|peer_device_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|peer_interface_addr
argument_list|)
argument_list|,
name|p2p_wps_method_text
argument_list|(
name|res
operator|->
name|wps_method
argument_list|)
argument_list|)
expr_stmt|;
name|wpas_notify_p2p_go_neg_completed
argument_list|(
name|wpa_s
argument_list|,
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|role_go
operator|&&
name|wpa_s
operator|->
name|p2p_persistent_id
operator|>=
literal|0
condition|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|disabled
operator|==
literal|2
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
name|ssid
operator|->
name|passphrase
condition|)
block|{
name|size_t
name|len
init|=
name|os_strlen
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Override passphrase based "
literal|"on requested persistent group"
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|res
operator|->
name|passphrase
argument_list|,
name|ssid
operator|->
name|passphrase
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|res
operator|->
name|passphrase
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|create_p2p_iface
condition|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|group_wpa_s
init|=
name|wpas_p2p_init_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|res
operator|->
name|role_go
argument_list|)
decl_stmt|;
if|if
condition|(
name|group_wpa_s
operator|==
name|NULL
condition|)
block|{
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_p2p_group_formation_failed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|group_wpa_s
operator|!=
name|wpa_s
condition|)
block|{
name|os_memcpy
argument_list|(
name|group_wpa_s
operator|->
name|p2p_pin
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
sizeof|sizeof
argument_list|(
name|group_wpa_s
operator|->
name|p2p_pin
argument_list|)
argument_list|)
expr_stmt|;
name|group_wpa_s
operator|->
name|p2p_wps_method
operator|=
name|wpa_s
operator|->
name|p2p_wps_method
expr_stmt|;
block|}
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|group_wpa_s
operator|->
name|p2p_in_provisioning
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|role_go
condition|)
name|wpas_start_wps_go
argument_list|(
name|group_wpa_s
argument_list|,
name|res
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|wpas_start_wps_enrollee
argument_list|(
name|group_wpa_s
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|wpa_s
expr_stmt|;
if|if
condition|(
name|res
operator|->
name|role_go
condition|)
name|wpas_start_wps_go
argument_list|(
name|wpa_s
argument_list|,
name|res
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|wpas_start_wps_enrollee
argument_list|(
name|ctx
argument_list|,
name|res
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|15
operator|+
name|res
operator|->
name|peer_config_timeout
operator|/
literal|100
argument_list|,
operator|(
name|res
operator|->
name|peer_config_timeout
operator|%
literal|100
operator|)
operator|*
literal|10000
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_go_neg_req_rx
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
name|u16
name|dev_passwd_id
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_GO_NEG_REQUEST MACSTR
literal|" dev_passwd_id=%u"
argument_list|,
argument|MAC2STR(src)
argument_list|,
argument|dev_passwd_id
argument_list|)
empty_stmt|;
name|wpas_notify_p2p_go_neg_req
argument_list|(
name|wpa_s
argument_list|,
name|src
argument_list|,
name|dev_passwd_id
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_dev_found
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|info
parameter_list|,
name|int
name|new_device
parameter_list|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_NO_STDOUT_DEBUG
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|char
modifier|*
name|wfd_dev_info_hex
init|=
name|NULL
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
name|wfd_dev_info_hex
operator|=
name|wifi_display_subelem_hex
argument_list|(
name|info
operator|->
name|wfd_subelems
argument_list|,
name|WFD_SUBELEM_DEVICE_INFO
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
if|if
condition|(
name|info
operator|->
name|p2ps_instance
condition|)
block|{
name|char
name|str
index|[
literal|256
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|buf
init|=
name|wpabuf_head
argument_list|(
name|info
operator|->
name|p2ps_instance
argument_list|)
decl_stmt|;
name|size_t
name|len
init|=
name|wpabuf_len
argument_list|(
name|info
operator|->
name|p2ps_instance
argument_list|)
decl_stmt|;
while|while
condition|(
name|len
condition|)
block|{
name|u32
name|id
decl_stmt|;
name|u16
name|methods
decl_stmt|;
name|u8
name|str_len
decl_stmt|;
if|if
condition|(
name|len
operator|<
literal|4
operator|+
literal|2
operator|+
literal|1
condition|)
break|break;
name|id
operator|=
name|WPA_GET_LE32
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|+=
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
name|methods
operator|=
name|WPA_GET_BE16
argument_list|(
name|buf
argument_list|)
expr_stmt|;
name|buf
operator|+=
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
name|str_len
operator|=
operator|*
name|buf
operator|++
expr_stmt|;
if|if
condition|(
name|str_len
operator|>
name|len
operator|-
literal|4
operator|-
literal|2
operator|-
literal|1
condition|)
break|break;
name|os_memcpy
argument_list|(
name|str
argument_list|,
name|buf
argument_list|,
name|str_len
argument_list|)
expr_stmt|;
name|str
index|[
name|str_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|buf
operator|+=
name|str_len
expr_stmt|;
name|len
operator|-=
name|str_len
operator|+
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
name|u8
argument_list|)
expr_stmt|;
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_DEVICE_FOUND MACSTR
literal|" p2p_dev_addr="
argument|MACSTR
literal|" pri_dev_type=%s name='%s'"
literal|" config_methods=0x%x"
literal|" dev_capab=0x%x"
literal|" group_capab=0x%x"
literal|" adv_id=%x asp_svc=%s%s"
argument_list|,
argument|MAC2STR(addr)
argument_list|,
argument|MAC2STR(info->p2p_device_addr)
argument_list|,
argument|wps_dev_type_bin2str( 					       info->pri_dev_type, 					       devtype, sizeof(devtype))
argument_list|,
argument|info->device_name
argument_list|,
argument|methods
argument_list|,
argument|info->dev_capab
argument_list|,
argument|info->group_capab
argument_list|,
argument|id
argument_list|,
argument|str
argument_list|,
argument|info->vendor_elems ?
literal|" vendor_elems=1"
argument|:
literal|""
argument_list|)
empty_stmt|;
block|}
goto|goto
name|done
goto|;
block|}
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_DEVICE_FOUND MACSTR
literal|" p2p_dev_addr="
argument|MACSTR
literal|" pri_dev_type=%s name='%s' config_methods=0x%x "
literal|"dev_capab=0x%x group_capab=0x%x%s%s%s new=%d"
argument_list|,
argument|MAC2STR(addr)
argument_list|,
argument|MAC2STR(info->p2p_device_addr)
argument_list|,
argument|wps_dev_type_bin2str(info->pri_dev_type, devtype, 					    sizeof(devtype))
argument_list|,
argument|info->device_name
argument_list|,
argument|info->config_methods
argument_list|,
argument|info->dev_capab
argument_list|,
argument|info->group_capab
argument_list|,
argument|wfd_dev_info_hex ?
literal|" wfd_dev_info=0x"
argument|:
literal|""
argument_list|,
argument|wfd_dev_info_hex ? wfd_dev_info_hex :
literal|""
argument_list|,
argument|info->vendor_elems ?
literal|" vendor_elems=1"
argument|:
literal|""
argument_list|,
argument|new_device
argument_list|)
empty_stmt|;
name|done
label|:
name|os_free
argument_list|(
name|wfd_dev_info_hex
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_NO_STDOUT_DEBUG */
name|wpas_notify_p2p_device_found
argument_list|(
name|ctx
argument_list|,
name|info
operator|->
name|p2p_device_addr
argument_list|,
name|new_device
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_dev_lost
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_DEVICE_LOST
literal|"p2p_dev_addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpas_notify_p2p_device_lost
argument_list|(
name|wpa_s
argument_list|,
name|dev_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_find_stopped
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_FIND_STOPPED
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
struct|struct
name|wpas_p2p_listen_work
block|{
name|unsigned
name|int
name|freq
decl_stmt|;
name|unsigned
name|int
name|duration
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|probe_resp_ie
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|void
name|wpas_p2p_listen_work_free
parameter_list|(
name|struct
name|wpas_p2p_listen_work
modifier|*
name|lwork
parameter_list|)
block|{
if|if
condition|(
name|lwork
operator|==
name|NULL
condition|)
return|return;
name|wpabuf_free
argument_list|(
name|lwork
operator|->
name|probe_resp_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|lwork
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_listen_work_done
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpas_p2p_listen_work
modifier|*
name|lwork
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_listen_work
condition|)
return|return;
name|lwork
operator|=
name|wpa_s
operator|->
name|p2p_listen_work
operator|->
name|ctx
expr_stmt|;
name|wpas_p2p_listen_work_free
argument_list|(
name|lwork
argument_list|)
expr_stmt|;
name|radio_work_done
argument_list|(
name|wpa_s
operator|->
name|p2p_listen_work
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_listen_work
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_start_listen_cb
parameter_list|(
name|struct
name|wpa_radio_work
modifier|*
name|work
parameter_list|,
name|int
name|deinit
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|work
operator|->
name|wpa_s
decl_stmt|;
name|struct
name|wpas_p2p_listen_work
modifier|*
name|lwork
init|=
name|work
operator|->
name|ctx
decl_stmt|;
name|unsigned
name|int
name|duration
decl_stmt|;
if|if
condition|(
name|deinit
condition|)
block|{
if|if
condition|(
name|work
operator|->
name|started
condition|)
block|{
name|wpa_s
operator|->
name|p2p_listen_work
operator|=
name|NULL
expr_stmt|;
name|wpas_stop_listen
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
name|wpas_p2p_listen_work_free
argument_list|(
name|lwork
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|p2p_listen_work
operator|=
name|work
expr_stmt|;
name|wpa_drv_set_ap_wps_ie
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|lwork
operator|->
name|probe_resp_ie
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_drv_probe_req_report
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to request the driver to "
literal|"report received Probe Request frames"
argument_list|)
expr_stmt|;
name|wpas_p2p_listen_work_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|pending_listen_freq
operator|=
name|lwork
operator|->
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|pending_listen_duration
operator|=
name|lwork
operator|->
name|duration
expr_stmt|;
name|duration
operator|=
name|lwork
operator|->
name|duration
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
if|if
condition|(
name|wpa_s
operator|->
name|extra_roc_dur
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TESTING: Increase ROC duration %u -> %u"
argument_list|,
name|duration
argument_list|,
name|duration
operator|+
name|wpa_s
operator|->
name|extra_roc_dur
argument_list|)
expr_stmt|;
name|duration
operator|+=
name|wpa_s
operator|->
name|extra_roc_dur
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
if|if
condition|(
name|wpa_drv_remain_on_channel
argument_list|(
name|wpa_s
argument_list|,
name|lwork
operator|->
name|freq
argument_list|,
name|duration
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to request the driver "
literal|"to remain on channel (%u MHz) for Listen "
literal|"state"
argument_list|,
name|lwork
operator|->
name|freq
argument_list|)
expr_stmt|;
name|wpas_p2p_listen_work_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_listen_freq
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
name|lwork
operator|->
name|freq
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_start_listen
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|duration
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|probe_resp_ie
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpas_p2p_listen_work
modifier|*
name|lwork
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_listen_work
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Reject start_listen since p2p_listen_work already exists"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|lwork
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|lwork
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwork
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|lwork
operator|->
name|freq
operator|=
name|freq
expr_stmt|;
name|lwork
operator|->
name|duration
operator|=
name|duration
expr_stmt|;
if|if
condition|(
name|probe_resp_ie
condition|)
block|{
name|lwork
operator|->
name|probe_resp_ie
operator|=
name|wpabuf_dup
argument_list|(
name|probe_resp_ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|lwork
operator|->
name|probe_resp_ie
operator|==
name|NULL
condition|)
block|{
name|wpas_p2p_listen_work_free
argument_list|(
name|lwork
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|radio_add_work
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
literal|"p2p-listen"
argument_list|,
literal|0
argument_list|,
name|wpas_start_listen_cb
argument_list|,
name|lwork
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpas_p2p_listen_work_free
argument_list|(
name|lwork
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_stop_listen
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|||
name|wpa_s
operator|->
name|roc_waiting_drv_freq
condition|)
block|{
name|wpa_drv_cancel_remain_on_channel
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_drv_set_ap_wps_ie
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_drv_probe_req_report
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpas_p2p_listen_work_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_send_probe_resp
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|buf
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
return|return
name|wpa_drv_send_mlme
argument_list|(
name|wpa_s
argument_list|,
name|wpabuf_head
argument_list|(
name|buf
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * DNS Header section is used only to calculate compression pointers, so the  * contents of this data does not matter, but the length needs to be reserved  * in the virtual packet.  */
end_comment

begin_define
define|#
directive|define
name|DNS_HEADER_LEN
value|12
end_define

begin_comment
comment|/*  * 27-octet in-memory packet from P2P specification containing two implied  * queries for _tcp.lcoal. PTR IN and _udp.local. PTR IN  */
end_comment

begin_define
define|#
directive|define
name|P2P_SD_IN_MEMORY_LEN
value|27
end_define

begin_function
specifier|static
name|int
name|p2p_sd_dns_uncompress_label
parameter_list|(
name|char
modifier|*
modifier|*
name|upos
parameter_list|,
name|char
modifier|*
name|uend
parameter_list|,
name|u8
modifier|*
name|start
parameter_list|,
name|u8
modifier|*
modifier|*
name|spos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
while|while
condition|(
operator|*
name|spos
operator|<
name|end
condition|)
block|{
name|u8
name|val
init|=
operator|(
operator|(
operator|*
name|spos
operator|)
index|[
literal|0
index|]
operator|&
literal|0xc0
operator|)
operator|>>
literal|6
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|val
operator|==
literal|1
operator|||
name|val
operator|==
literal|2
condition|)
block|{
comment|/* These are reserved values in RFC 1035 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid domain name "
literal|"sequence starting with 0x%x"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|val
operator|==
literal|3
condition|)
block|{
name|u16
name|offset
decl_stmt|;
name|u8
modifier|*
name|spos_tmp
decl_stmt|;
comment|/* Offset */
if|if
condition|(
operator|*
name|spos
operator|+
literal|2
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No room for full "
literal|"DNS offset field"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|offset
operator|=
operator|(
operator|(
operator|(
operator|*
name|spos
operator|)
index|[
literal|0
index|]
operator|&
literal|0x3f
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|*
name|spos
operator|)
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|offset
operator|>=
operator|*
name|spos
operator|-
name|start
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid DNS "
literal|"pointer offset %u"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
operator|*
name|spos
operator|)
operator|+=
literal|2
expr_stmt|;
name|spos_tmp
operator|=
name|start
operator|+
name|offset
expr_stmt|;
return|return
name|p2p_sd_dns_uncompress_label
argument_list|(
name|upos
argument_list|,
name|uend
argument_list|,
name|start
argument_list|,
operator|&
name|spos_tmp
argument_list|,
operator|*
name|spos
operator|-
literal|2
argument_list|)
return|;
block|}
comment|/* Label */
name|len
operator|=
operator|(
operator|*
name|spos
operator|)
index|[
literal|0
index|]
operator|&
literal|0x3f
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
operator|(
operator|*
name|spos
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|spos
operator|+
name|len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid domain name "
literal|"sequence - no room for label with length "
literal|"%u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|*
name|upos
operator|+
name|len
operator|+
literal|2
operator|>
name|uend
condition|)
return|return
operator|-
literal|2
return|;
name|os_memcpy
argument_list|(
operator|*
name|upos
argument_list|,
operator|*
name|spos
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|spos
operator|+=
name|len
expr_stmt|;
operator|*
name|upos
operator|+=
name|len
expr_stmt|;
operator|(
operator|*
name|upos
operator|)
index|[
literal|0
index|]
operator|=
literal|'.'
expr_stmt|;
operator|(
operator|*
name|upos
operator|)
operator|++
expr_stmt|;
operator|(
operator|*
name|upos
operator|)
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Uncompress domain names per RFC 1035 using the P2P SD in-memory packet.  * Returns -1 on parsing error (invalid input sequence), -2 if output buffer is  * not large enough */
end_comment

begin_function
specifier|static
name|int
name|p2p_sd_dns_uncompress
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|,
name|size_t
name|offset
parameter_list|)
block|{
comment|/* 27-octet in-memory packet from P2P specification */
specifier|const
name|char
modifier|*
name|prefix
init|=
literal|"\x04_tcp\x05local\x00\x00\x0C\x00\x01"
literal|"\x04_udp\xC0\x11\x00\x0C\x00\x01"
decl_stmt|;
name|u8
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|spos
decl_stmt|;
name|char
modifier|*
name|upos
decl_stmt|,
modifier|*
name|uend
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|buf_len
operator|<
literal|2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|offset
operator|>
name|msg_len
condition|)
return|return
operator|-
literal|1
return|;
name|tmp
operator|=
name|os_malloc
argument_list|(
name|DNS_HEADER_LEN
operator|+
name|P2P_SD_IN_MEMORY_LEN
operator|+
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|spos
operator|=
name|tmp
operator|+
name|DNS_HEADER_LEN
operator|+
name|P2P_SD_IN_MEMORY_LEN
expr_stmt|;
name|end
operator|=
name|spos
operator|+
name|msg_len
expr_stmt|;
name|spos
operator|+=
name|offset
expr_stmt|;
name|os_memset
argument_list|(
name|tmp
argument_list|,
literal|0
argument_list|,
name|DNS_HEADER_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|tmp
operator|+
name|DNS_HEADER_LEN
argument_list|,
name|prefix
argument_list|,
name|P2P_SD_IN_MEMORY_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|tmp
operator|+
name|DNS_HEADER_LEN
operator|+
name|P2P_SD_IN_MEMORY_LEN
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|upos
operator|=
name|buf
expr_stmt|;
name|uend
operator|=
name|buf
operator|+
name|buf_len
expr_stmt|;
name|ret
operator|=
name|p2p_sd_dns_uncompress_label
argument_list|(
operator|&
name|upos
argument_list|,
name|uend
argument_list|,
name|tmp
argument_list|,
operator|&
name|spos
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|upos
operator|==
name|buf
condition|)
block|{
name|upos
index|[
literal|0
index|]
operator|=
literal|'.'
expr_stmt|;
name|upos
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|upos
index|[
operator|-
literal|1
index|]
operator|==
literal|'.'
condition|)
name|upos
index|[
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|p2p_srv_bonjour
modifier|*
name|wpas_p2p_service_get_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|len
operator|=
name|wpabuf_len
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bsrv
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|len
operator|==
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|&&
name|os_memcmp
argument_list|(
name|wpabuf_head
argument_list|(
name|query
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
name|bsrv
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|p2p_srv_upnp
modifier|*
name|wpas_p2p_service_get_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|usrv
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|version
operator|==
name|usrv
operator|->
name|version
operator|&&
name|os_strcmp
argument_list|(
name|service
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
operator|==
literal|0
condition|)
return|return
name|usrv
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_add_empty
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_proto
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
name|u8
name|status
parameter_list|)
block|{
name|u8
modifier|*
name|len_pos
decl_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* Response Data: empty */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_add_proto_not_avail
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_proto
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|wpas_sd_add_empty
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|,
name|srv_trans_id
argument_list|,
name|P2P_SD_PROTO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_add_bad_request
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_proto
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|wpas_sd_add_empty
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|,
name|srv_trans_id
argument_list|,
name|P2P_SD_BAD_REQUEST
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_add_not_found
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_proto
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|wpas_sd_add_empty
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|,
name|srv_trans_id
argument_list|,
name|P2P_SD_REQUESTED_INFO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_all_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for all Bonjour services"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Bonjour protocol not available"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|bsrv
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching Bonjour service"
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|bsrv
operator|->
name|query
argument_list|)
expr_stmt|;
comment|/* Key */
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|bsrv
operator|->
name|resp
argument_list|)
expr_stmt|;
comment|/* Value */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|match_bonjour_query
parameter_list|(
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|char
name|str_rx
index|[
literal|256
index|]
decl_stmt|,
name|str_srv
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|query_len
operator|<
literal|3
operator|||
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|<
literal|3
condition|)
return|return
literal|0
return|;
comment|/* Too short to include DNS Type and Version */
if|if
condition|(
name|os_memcmp
argument_list|(
name|query
operator|+
name|query_len
operator|-
literal|3
argument_list|,
name|wpabuf_head_u8
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|-
literal|3
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Mismatch in DNS Type or Version */
if|if
condition|(
name|query_len
operator|==
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|&&
name|os_memcmp
argument_list|(
name|query
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
argument_list|,
name|query_len
operator|-
literal|3
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
comment|/* Binary match */
if|if
condition|(
name|p2p_sd_dns_uncompress
argument_list|(
name|str_rx
argument_list|,
sizeof|sizeof
argument_list|(
name|str_rx
argument_list|)
argument_list|,
name|query
argument_list|,
name|query_len
operator|-
literal|3
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Failed to uncompress query */
if|if
condition|(
name|p2p_sd_dns_uncompress
argument_list|(
name|str_srv
argument_list|,
sizeof|sizeof
argument_list|(
name|str_srv
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|-
literal|3
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Failed to uncompress service */
return|return
name|os_strcmp
argument_list|(
name|str_rx
argument_list|,
name|str_srv
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_req_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|int
name|matches
init|=
literal|0
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for Bonjour"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Bonjour protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|query_len
operator|==
literal|0
condition|)
block|{
name|wpas_sd_all_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|bsrv
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|match_bonjour_query
argument_list|(
name|bsrv
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
operator|+
name|query_len
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
condition|)
return|return;
name|matches
operator|++
expr_stmt|;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching Bonjour service"
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_data
argument_list|(
name|resp
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
comment|/* Key */
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|bsrv
operator|->
name|resp
argument_list|)
expr_stmt|;
comment|/* Value */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|matches
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested Bonjour service not "
literal|"available"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_REQUESTED_INFO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
comment|/* Response Data: empty */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_all_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for all UPnP services"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: UPnP protocol not available"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|usrv
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|usrv
operator|->
name|service
argument_list|)
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_UPNP
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|usrv
operator|->
name|version
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching UPnP Service: %s"
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|resp
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_req_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|u8
name|version
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for UPnP"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: UPnP protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_UPNP
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|query_len
operator|==
literal|0
condition|)
block|{
name|wpas_sd_all_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_UPNP
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|version
operator|=
name|query
index|[
literal|0
index|]
expr_stmt|;
name|str
operator|=
name|os_malloc
argument_list|(
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|str
argument_list|,
name|query
operator|+
literal|1
argument_list|,
name|query_len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|str
index|[
name|query_len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|usrv
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|version
operator|!=
name|usrv
operator|->
name|version
condition|)
continue|continue;
if|if
condition|(
name|os_strcmp
argument_list|(
name|str
argument_list|,
literal|"ssdp:all"
argument_list|)
operator|!=
literal|0
operator|&&
name|os_strstr
argument_list|(
name|usrv
operator|->
name|service
argument_list|,
name|str
argument_list|)
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|2
condition|)
break|break;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|version
argument_list|)
expr_stmt|;
block|}
else|else
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
literal|','
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching UPnP Service: %s"
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
name|os_strlen
argument_list|(
name|usrv
operator|->
name|service
argument_list|)
condition|)
break|break;
name|wpabuf_put_str
argument_list|(
name|resp
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested UPnP service not "
literal|"available"
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_REQUESTED_INFO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
comment|/* Response Data: empty */
block|}
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
end_ifdef

begin_function
specifier|static
name|void
name|wpas_sd_req_wfd
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|u8
name|role
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for WFD"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|wifi_display
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: WFD protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_WIFI_DISPLAY
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|query_len
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Missing WFD Requested Device "
literal|"Role"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
name|pos
operator|=
name|query
expr_stmt|;
name|role
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: WSD for device role 0x%x"
argument_list|,
name|role
argument_list|)
expr_stmt|;
comment|/* TODO: role specific handling */
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_WIFI_DISPLAY
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Status Code */
while|while
condition|(
name|pos
operator|<
name|query
operator|+
name|query_len
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|<
name|MAX_WFD_SUBELEMS
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|wfd_subelem
index|[
operator|*
name|pos
index|]
operator|&&
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|>=
name|wpabuf_len
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|wfd_subelem
index|[
operator|*
name|pos
index|]
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add WSD response "
literal|"subelement %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|wfd_subelem
index|[
operator|*
name|pos
index|]
argument_list|)
expr_stmt|;
block|}
name|pos
operator|++
expr_stmt|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WIFI_DISPLAY */
end_comment

begin_function
specifier|static
name|int
name|find_p2ps_substr
parameter_list|(
name|struct
name|p2ps_advertisement
modifier|*
name|adv_data
parameter_list|,
specifier|const
name|u8
modifier|*
name|needle
parameter_list|,
name|size_t
name|needle_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|haystack
init|=
operator|(
specifier|const
name|u8
operator|*
operator|)
name|adv_data
operator|->
name|svc_info
decl_stmt|;
name|size_t
name|haystack_len
decl_stmt|,
name|i
decl_stmt|;
comment|/* Allow search term to be empty */
if|if
condition|(
operator|!
name|needle
operator|||
operator|!
name|needle_len
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|haystack
condition|)
return|return
literal|0
return|;
name|haystack_len
operator|=
name|os_strlen
argument_list|(
name|adv_data
operator|->
name|svc_info
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|haystack_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|haystack_len
operator|-
name|i
operator|<
name|needle_len
condition|)
break|break;
if|if
condition|(
name|os_memcmp
argument_list|(
name|haystack
operator|+
name|i
argument_list|,
name|needle
argument_list|,
name|needle_len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_req_asp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|struct
name|p2ps_advertisement
modifier|*
name|adv_data
decl_stmt|;
specifier|const
name|u8
modifier|*
name|svc
init|=
operator|&
name|query
index|[
literal|1
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|info
init|=
name|NULL
decl_stmt|;
name|size_t
name|svc_len
init|=
name|query
index|[
literal|0
index|]
decl_stmt|;
name|size_t
name|info_len
init|=
literal|0
decl_stmt|;
name|int
name|prefix
init|=
literal|0
decl_stmt|;
name|u8
modifier|*
name|count_pos
init|=
name|NULL
decl_stmt|;
name|u8
modifier|*
name|len_pos
init|=
name|NULL
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for ASP"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: ASP protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_P2PS
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Info block is optional */
if|if
condition|(
name|svc_len
operator|+
literal|1
operator|<
name|query_len
condition|)
block|{
name|info
operator|=
operator|&
name|svc
index|[
name|svc_len
index|]
expr_stmt|;
name|info_len
operator|=
operator|*
name|info
operator|++
expr_stmt|;
block|}
comment|/* Range check length of svc string and info block */
if|if
condition|(
name|svc_len
operator|+
operator|(
name|info_len
condition|?
name|info_len
operator|+
literal|2
else|:
literal|1
operator|)
operator|>
name|query_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: ASP bad request"
argument_list|)
expr_stmt|;
name|wpas_sd_add_bad_request
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_P2PS
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Detect and correct for prefix search */
if|if
condition|(
name|svc_len
operator|&&
name|svc
index|[
name|svc_len
operator|-
literal|1
index|]
operator|==
literal|'*'
condition|)
block|{
name|prefix
operator|=
literal|1
expr_stmt|;
name|svc_len
operator|--
expr_stmt|;
block|}
for|for
control|(
name|adv_data
operator|=
name|p2p_get_p2ps_adv_list
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
init|;
name|adv_data
condition|;
name|adv_data
operator|=
name|adv_data
operator|->
name|next
control|)
block|{
comment|/* If not a prefix match, reject length mismatches */
if|if
condition|(
operator|!
name|prefix
operator|&&
name|svc_len
operator|!=
name|os_strlen
argument_list|(
name|adv_data
operator|->
name|svc_name
argument_list|)
condition|)
continue|continue;
comment|/* Search each service for request */
if|if
condition|(
name|os_memcmp
argument_list|(
name|adv_data
operator|->
name|svc_name
argument_list|,
name|svc
argument_list|,
name|svc_len
argument_list|)
operator|==
literal|0
operator|&&
name|find_p2ps_substr
argument_list|(
name|adv_data
argument_list|,
name|info
argument_list|,
name|info_len
argument_list|)
condition|)
block|{
name|size_t
name|len
init|=
name|os_strlen
argument_list|(
name|adv_data
operator|->
name|svc_name
argument_list|)
decl_stmt|;
name|size_t
name|svc_info_len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|adv_data
operator|->
name|svc_info
condition|)
name|svc_info_len
operator|=
name|os_strlen
argument_list|(
name|adv_data
operator|->
name|svc_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0xff
operator|||
name|svc_info_len
operator|>
literal|0xffff
condition|)
return|return;
comment|/* Length& Count to be filled as we go */
if|if
condition|(
operator|!
name|len_pos
operator|&&
operator|!
name|count_pos
condition|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
name|len
operator|+
name|svc_info_len
operator|+
literal|16
condition|)
return|return;
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_P2PS
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
name|count_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|count_pos
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
name|len
operator|+
name|svc_info_len
operator|+
literal|10
condition|)
return|return;
if|if
condition|(
name|svc_info_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add Svc: %s info: %s"
argument_list|,
name|adv_data
operator|->
name|svc_name
argument_list|,
name|adv_data
operator|->
name|svc_info
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add Svc: %s"
argument_list|,
name|adv_data
operator|->
name|svc_name
argument_list|)
expr_stmt|;
block|}
comment|/* Advertisement ID */
name|wpabuf_put_le32
argument_list|(
name|resp
argument_list|,
name|adv_data
operator|->
name|id
argument_list|)
expr_stmt|;
comment|/* Config Methods */
name|wpabuf_put_be16
argument_list|(
name|resp
argument_list|,
name|adv_data
operator|->
name|config_methods
argument_list|)
expr_stmt|;
comment|/* Service Name */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
operator|(
name|u8
operator|)
name|len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|resp
argument_list|,
name|adv_data
operator|->
name|svc_name
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Service State */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|adv_data
operator|->
name|state
argument_list|)
expr_stmt|;
comment|/* Service Information */
name|wpabuf_put_le16
argument_list|(
name|resp
argument_list|,
operator|(
name|u16
operator|)
name|svc_info_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|resp
argument_list|,
name|adv_data
operator|->
name|svc_info
argument_list|,
name|svc_info_len
argument_list|)
expr_stmt|;
comment|/* Update length and count */
operator|(
operator|*
name|count_pos
operator|)
operator|++
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Return error if no matching svc found */
if|if
condition|(
name|count_pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: ASP service not found"
argument_list|)
expr_stmt|;
name|wpas_sd_add_not_found
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_P2PS
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_request
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|u16
name|update_indic
parameter_list|,
specifier|const
name|u8
modifier|*
name|tlvs
parameter_list|,
name|size_t
name|tlvs_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
init|=
name|tlvs
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|tlvs
operator|+
name|tlvs_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|tlv_end
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
name|u8
name|srv_proto
decl_stmt|,
name|srv_trans_id
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Service Discovery Request TLVs"
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|buf_len
operator|=
literal|2
operator|*
name|tlvs_len
operator|+
literal|1
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_SERV_DISC_REQ
literal|"%d "
name|MACSTR
literal|" %u %u %s"
argument_list|,
name|freq
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|,
name|update_indic
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_sd_over_ctrl_iface
condition|)
block|{
name|wpas_notify_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|update_indic
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
return|return;
comment|/* to be processed by an external program */
block|}
name|resp
operator|=
name|wpabuf_alloc
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Request TLV"
argument_list|)
expr_stmt|;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
operator|||
name|slen
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unexpected Query Data "
literal|"length"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return;
block|}
name|tlv_end
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
name|srv_proto
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Protocol Type %u"
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|srv_trans_id
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Transaction ID %u"
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Query Data"
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|force_long_sd
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD test - force long "
literal|"response"
argument_list|)
expr_stmt|;
name|wpas_sd_all_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpas_sd_all_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
switch|switch
condition|(
name|srv_proto
condition|)
block|{
case|case
name|P2P_SERV_ALL_SERVICES
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Discovery Request "
literal|"for all services"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|)
operator|&&
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No service "
literal|"discovery protocols available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_ALL_SERVICES
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpas_sd_all_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpas_sd_all_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_SERV_BONJOUR
case|:
name|wpas_sd_req_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_SERV_UPNP
case|:
name|wpas_sd_req_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
case|case
name|P2P_SERV_WIFI_DISPLAY
case|:
name|wpas_sd_req_wfd
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
case|case
name|P2P_SERV_P2PS
case|:
name|wpas_sd_req_asp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unavailable service "
literal|"protocol %u"
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|tlv_end
expr_stmt|;
block|}
name|done
label|:
name|wpas_notify_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|update_indic
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_response
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_p2ps_serv_response
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|tlv_end
parameter_list|)
block|{
name|u8
name|left
init|=
operator|*
name|pos
operator|++
decl_stmt|;
name|u32
name|adv_id
decl_stmt|;
name|u8
name|svc_status
decl_stmt|;
name|u16
name|config_methods
decl_stmt|;
name|char
name|svc_str
index|[
literal|256
index|]
decl_stmt|;
while|while
condition|(
name|left
operator|--
operator|&&
name|pos
operator|<
name|tlv_end
condition|)
block|{
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|u8
name|svc_len
decl_stmt|;
comment|/* Sanity check fixed length+svc_str */
if|if
condition|(
name|pos
operator|+
literal|6
operator|>=
name|tlv_end
condition|)
break|break;
name|svc_len
operator|=
name|pos
index|[
literal|6
index|]
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|svc_len
operator|+
literal|10
operator|>
name|tlv_end
condition|)
break|break;
comment|/* Advertisement ID */
name|adv_id
operator|=
name|WPA_GET_LE32
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
comment|/* Config Methods */
name|config_methods
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
comment|/* Service Name */
name|pos
operator|++
expr_stmt|;
comment|/* svc_len */
name|os_memcpy
argument_list|(
name|svc_str
argument_list|,
name|pos
argument_list|,
name|svc_len
argument_list|)
expr_stmt|;
name|svc_str
index|[
name|svc_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|+=
name|svc_len
expr_stmt|;
comment|/* Service Status */
name|svc_status
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
comment|/* Service Information Length */
name|buf_len
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
comment|/* Sanity check buffer length */
if|if
condition|(
name|buf_len
operator|>
call|(
name|unsigned
name|int
call|)
argument_list|(
name|tlv_end
operator|-
name|pos
argument_list|)
condition|)
break|break;
if|if
condition|(
name|buf_len
condition|)
block|{
name|buf
operator|=
name|os_zalloc
argument_list|(
literal|2
operator|*
name|buf_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|utf8_escape
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|pos
argument_list|,
name|buf_len
argument_list|,
name|buf
argument_list|,
literal|2
operator|*
name|buf_len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|pos
operator|+=
name|buf_len
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_SERV_ASP_RESP 				       MACSTR
literal|" %x %x %x %x %s '%s'"
argument_list|,
argument|MAC2STR(sa)
argument_list|,
argument|srv_trans_id
argument_list|,
argument|adv_id
argument_list|,
argument|svc_status
argument_list|,
argument|config_methods
argument_list|,
argument|svc_str
argument_list|,
argument|buf
argument_list|)
empty_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_SERV_ASP_RESP 				       MACSTR
literal|" %x %x %x %x %s"
argument_list|,
argument|MAC2STR(sa)
argument_list|,
argument|srv_trans_id
argument_list|,
argument|adv_id
argument_list|,
argument|svc_status
argument_list|,
argument|config_methods
argument_list|,
argument|svc_str
argument_list|)
empty_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_response
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
name|u16
name|update_indic
parameter_list|,
specifier|const
name|u8
modifier|*
name|tlvs
parameter_list|,
name|size_t
name|tlvs_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
init|=
name|tlvs
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|tlvs
operator|+
name|tlvs_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|tlv_end
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Service Discovery Response TLVs"
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs_len
operator|>
literal|1500
condition|)
block|{
comment|/* TODO: better way for handling this */
name|wpa_msg_ctrl
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_SERV_DISC_RESP MACSTR
literal|" %u<long response: %u bytes>"
argument_list|,
argument|MAC2STR(sa)
argument_list|,
argument|update_indic
argument_list|,
argument|(unsigned int) tlvs_len
argument_list|)
empty_stmt|;
block|}
else|else
block|{
name|buf_len
operator|=
literal|2
operator|*
name|tlvs_len
operator|+
literal|1
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|wpa_msg_ctrl
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_SERV_DISC_RESP MACSTR
literal|" %u %s"
argument_list|,
argument|MAC2STR(sa)
argument_list|,
argument|update_indic
argument_list|,
argument|buf
argument_list|)
empty_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|u8
name|srv_proto
decl_stmt|,
name|srv_trans_id
decl_stmt|,
name|status
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Response TLV"
argument_list|)
expr_stmt|;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
operator|||
name|slen
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unexpected Response Data "
literal|"length"
argument_list|)
expr_stmt|;
return|return;
block|}
name|tlv_end
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
name|srv_proto
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Protocol Type %u"
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|srv_trans_id
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Transaction ID %u"
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|status
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Status Code ID %u"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Response Data"
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|srv_proto
operator|==
name|P2P_SERV_P2PS
operator|&&
name|pos
operator|<
name|tlv_end
condition|)
block|{
name|wpas_sd_p2ps_serv_response
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
name|tlv_end
expr_stmt|;
block|}
name|wpas_notify_p2p_sd_response
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|,
name|update_indic
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|uintptr_t
operator|)
name|p2p_sd_request
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
return|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|tlvs
decl_stmt|;
name|u64
name|ret
decl_stmt|;
name|tlvs
operator|=
name|wpabuf_alloc
argument_list|(
literal|2
operator|+
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|query
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpabuf_put_le16
argument_list|(
name|tlvs
argument_list|,
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|query
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|P2P_SERV_UPNP
argument_list|)
expr_stmt|;
comment|/* Service Protocol Type */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Service Transaction ID */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|tlvs
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpas_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tlvs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request_asp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|id
parameter_list|,
specifier|const
name|char
modifier|*
name|svc_str
parameter_list|,
specifier|const
name|char
modifier|*
name|info_substr
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|tlvs
decl_stmt|;
name|size_t
name|plen
decl_stmt|,
name|svc_len
decl_stmt|,
name|substr_len
init|=
literal|0
decl_stmt|;
name|u64
name|ret
decl_stmt|;
name|svc_len
operator|=
name|os_strlen
argument_list|(
name|svc_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|info_substr
condition|)
name|substr_len
operator|=
name|os_strlen
argument_list|(
name|info_substr
argument_list|)
expr_stmt|;
if|if
condition|(
name|svc_len
operator|>
literal|0xff
operator|||
name|substr_len
operator|>
literal|0xff
condition|)
return|return
literal|0
return|;
name|plen
operator|=
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|svc_len
operator|+
literal|1
operator|+
name|substr_len
expr_stmt|;
name|tlvs
operator|=
name|wpabuf_alloc
argument_list|(
literal|2
operator|+
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpabuf_put_le16
argument_list|(
name|tlvs
argument_list|,
name|plen
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|P2P_SERV_P2PS
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|id
argument_list|)
expr_stmt|;
comment|/* Service Transaction ID */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
operator|(
name|u8
operator|)
name|svc_len
argument_list|)
expr_stmt|;
comment|/* Service String Length */
name|wpabuf_put_data
argument_list|(
name|tlvs
argument_list|,
name|svc_str
argument_list|,
name|svc_len
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
operator|(
name|u8
operator|)
name|substr_len
argument_list|)
expr_stmt|;
comment|/* Info Substring Length */
name|wpabuf_put_data
argument_list|(
name|tlvs
argument_list|,
name|info_substr
argument_list|,
name|substr_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpas_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tlvs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
end_ifdef

begin_function
specifier|static
name|u64
name|wpas_p2p_sd_request_wfd
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|uintptr_t
operator|)
name|p2p_sd_request_wfd
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|MAX_WFD_SD_SUBELEMS
value|20
end_define

begin_function
specifier|static
name|void
name|wfd_add_sd_req_role
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|,
name|u8
name|id
parameter_list|,
name|u8
name|role
parameter_list|,
specifier|const
name|char
modifier|*
name|subelems
parameter_list|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|tlvs
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|P2P_SERV_WIFI_DISPLAY
argument_list|)
expr_stmt|;
comment|/* Service Protocol Type */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|id
argument_list|)
expr_stmt|;
comment|/* Service Transaction ID */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|role
argument_list|)
expr_stmt|;
name|pos
operator|=
name|subelems
expr_stmt|;
while|while
condition|(
operator|*
name|pos
condition|)
block|{
name|val
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>=
literal|0
operator|&&
name|val
operator|<
literal|256
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|==
name|MAX_WFD_SD_SUBELEMS
condition|)
break|break;
block|}
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
operator|+
literal|1
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
break|break;
name|pos
operator|++
expr_stmt|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|len
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|tlvs
argument_list|,
literal|0
argument_list|)
operator|-
name|len
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request_wifi_display
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|char
modifier|*
name|role
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|tlvs
decl_stmt|;
name|u64
name|ret
decl_stmt|;
specifier|const
name|char
modifier|*
name|subelems
decl_stmt|;
name|u8
name|id
init|=
literal|1
decl_stmt|;
name|subelems
operator|=
name|os_strchr
argument_list|(
name|role
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|subelems
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|subelems
operator|++
expr_stmt|;
name|tlvs
operator|=
name|wpabuf_alloc
argument_list|(
literal|4
operator|*
operator|(
literal|2
operator|+
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|MAX_WFD_SD_SUBELEMS
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[source]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x00
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[pri-sink]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x01
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[sec-sink]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x02
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[source+sink]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x03
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpas_p2p_sd_request_wfd
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tlvs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WIFI_DISPLAY */
end_comment

begin_function
name|int
name|wpas_p2p_sd_cancel_request
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u64
name|req
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_sd_cancel_request
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|req
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_sd_response
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|resp_tlvs
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|p2p_sd_response
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|dialog_token
argument_list|,
name|resp_tlvs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_sd_service_update
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_sd_service_update
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_srv_bonjour_free
parameter_list|(
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
parameter_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|bsrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bsrv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_srv_upnp_free
parameter_list|(
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
parameter_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|usrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_service_flush
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|,
modifier|*
name|bn
decl_stmt|;
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|,
modifier|*
name|un
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|bsrv
argument_list|,
argument|bn
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
name|wpas_p2p_srv_bonjour_free
argument_list|(
name|bsrv
argument_list|)
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|usrv
argument_list|,
argument|un
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
name|wpas_p2p_srv_upnp_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_p2ps_id_exists
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|adv_id
parameter_list|)
block|{
if|if
condition|(
name|adv_id
operator|==
literal|0
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|p2p_service_p2ps_id
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|adv_id
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_del_asp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|adv_id
parameter_list|)
block|{
return|return
name|p2p_service_del_asp
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|adv_id
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_add_asp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|auto_accept
parameter_list|,
name|u32
name|adv_id
parameter_list|,
specifier|const
name|char
modifier|*
name|adv_str
parameter_list|,
name|u8
name|svc_state
parameter_list|,
name|u16
name|config_methods
parameter_list|,
specifier|const
name|char
modifier|*
name|svc_info
parameter_list|)
block|{
return|return
name|p2p_service_add_asp
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|auto_accept
argument_list|,
name|adv_id
argument_list|,
name|adv_str
argument_list|,
name|svc_state
argument_list|,
name|config_methods
argument_list|,
name|svc_info
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_add_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|query
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|bsrv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bsrv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bsrv
operator|->
name|query
operator|=
name|query
expr_stmt|;
name|bsrv
operator|->
name|resp
operator|=
name|resp
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|,
operator|&
name|bsrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_del_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|bsrv
operator|=
name|wpas_p2p_service_get_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_p2p_srv_bonjour_free
argument_list|(
name|bsrv
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_add_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
if|if
condition|(
name|wpas_p2p_service_get_upnp
argument_list|(
name|wpa_s
argument_list|,
name|version
argument_list|,
name|service
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Already listed */
name|usrv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|usrv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|usrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|usrv
operator|->
name|version
operator|=
name|version
expr_stmt|;
name|usrv
operator|->
name|service
operator|=
name|os_strdup
argument_list|(
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|usrv
operator|->
name|service
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dl_list_add
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|,
operator|&
name|usrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_del_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|usrv
operator|=
name|wpas_p2p_service_get_upnp
argument_list|(
name|wpa_s
argument_list|,
name|version
argument_list|,
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|usrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_p2p_srv_upnp_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_prov_disc_local_display
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|,
name|unsigned
name|int
name|generated_pin
parameter_list|)
block|{
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_PROV_DISC_SHOW_PIN MACSTR
literal|" %08d%s"
argument_list|,
argument|MAC2STR(peer)
argument_list|,
argument|generated_pin
argument_list|,
argument|params
argument_list|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_prov_disc_local_keypad
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
specifier|const
name|char
modifier|*
name|params
parameter_list|)
block|{
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_PROV_DISC_ENTER_PIN MACSTR
literal|"%s"
argument_list|,
argument|MAC2STR(peer)
argument_list|,
argument|params
argument_list|)
empty_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_prov_disc_req
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|u16
name|config_methods
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|pri_dev_type
parameter_list|,
specifier|const
name|char
modifier|*
name|dev_name
parameter_list|,
name|u16
name|supp_config_methods
parameter_list|,
name|u8
name|dev_capab
parameter_list|,
name|u8
name|group_capab
parameter_list|,
specifier|const
name|u8
modifier|*
name|group_id
parameter_list|,
name|size_t
name|group_id_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|char
name|params
index|[
literal|300
index|]
decl_stmt|;
name|u8
name|empty_dev_type
index|[
literal|8
index|]
decl_stmt|;
name|unsigned
name|int
name|generated_pin
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|group
init|=
name|NULL
decl_stmt|;
name|int
name|res
decl_stmt|;
if|if
condition|(
name|group_id
condition|)
block|{
for|for
control|(
name|group
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|group
condition|;
name|group
operator|=
name|group
operator|->
name|next
control|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
init|=
name|group
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|s
operator|!=
name|NULL
operator|&&
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
name|group_id_len
operator|-
name|ETH_ALEN
operator|==
name|s
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|group_id
operator|+
name|ETH_ALEN
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
block|}
if|if
condition|(
name|pri_dev_type
operator|==
name|NULL
condition|)
block|{
name|os_memset
argument_list|(
name|empty_dev_type
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|empty_dev_type
argument_list|)
argument_list|)
expr_stmt|;
name|pri_dev_type
operator|=
name|empty_dev_type
expr_stmt|;
block|}
name|res
operator|=
name|os_snprintf
argument_list|(
name|params
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|,
literal|" p2p_dev_addr="
name|MACSTR
literal|" pri_dev_type=%s name='%s' config_methods=0x%x "
literal|"dev_capab=0x%x group_capab=0x%x%s%s"
argument_list|,
name|MAC2STR
argument_list|(
name|dev_addr
argument_list|)
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|pri_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|,
name|dev_name
argument_list|,
name|supp_config_methods
argument_list|,
name|dev_capab
argument_list|,
name|group_capab
argument_list|,
name|group
condition|?
literal|" group="
else|:
literal|""
argument_list|,
name|group
condition|?
name|group
operator|->
name|ifname
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|,
name|res
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: PD Request event truncated"
argument_list|)
expr_stmt|;
name|params
index|[
sizeof|sizeof
argument_list|(
name|params
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_DISPLAY
condition|)
block|{
name|generated_pin
operator|=
name|wps_generate_pin
argument_list|()
expr_stmt|;
name|wpas_prov_disc_local_display
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
name|params
argument_list|,
name|generated_pin
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_KEYPAD
condition|)
name|wpas_prov_disc_local_keypad
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
name|params
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_PUSHBUTTON
condition|)
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_PROV_DISC_PBC_REQ 			       MACSTR
literal|"%s"
argument_list|,
argument|MAC2STR(peer)
argument_list|,
argument|params
argument_list|)
empty_stmt|;
name|wpas_notify_p2p_provision_discovery
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
literal|1
comment|/* request */
argument_list|,
name|P2P_PROV_DISC_SUCCESS
argument_list|,
name|config_methods
argument_list|,
name|generated_pin
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_prov_disc_resp
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|u16
name|config_methods
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|unsigned
name|int
name|generated_pin
init|=
literal|0
decl_stmt|;
name|char
name|params
index|[
literal|20
index|]
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_pd_before_join
operator|&&
operator|(
name|os_memcmp
argument_list|(
name|peer
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|||
name|os_memcmp
argument_list|(
name|peer
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Starting pending "
literal|"join-existing-group operation"
argument_list|)
expr_stmt|;
name|wpas_p2p_join_start
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|pending_pd_use
operator|==
name|AUTO_PD_JOIN
operator|||
name|wpa_s
operator|->
name|pending_pd_use
operator|==
name|AUTO_PD_GO_NEG
condition|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|os_snprintf
argument_list|(
name|params
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|,
literal|" peer_go=%d"
argument_list|,
name|wpa_s
operator|->
name|pending_pd_use
operator|==
name|AUTO_PD_JOIN
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|,
name|res
argument_list|)
condition|)
name|params
index|[
sizeof|sizeof
argument_list|(
name|params
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
name|params
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_DISPLAY
condition|)
name|wpas_prov_disc_local_keypad
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
name|params
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_KEYPAD
condition|)
block|{
name|generated_pin
operator|=
name|wps_generate_pin
argument_list|()
expr_stmt|;
name|wpas_prov_disc_local_display
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
name|params
argument_list|,
name|generated_pin
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|config_methods
operator|&
name|WPS_CONFIG_PUSHBUTTON
condition|)
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_PROV_DISC_PBC_RESP 			       MACSTR
literal|"%s"
argument_list|,
argument|MAC2STR(peer)
argument_list|,
argument|params
argument_list|)
empty_stmt|;
name|wpas_notify_p2p_provision_discovery
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
literal|0
comment|/* response */
argument_list|,
name|P2P_PROV_DISC_SUCCESS
argument_list|,
name|config_methods
argument_list|,
name|generated_pin
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_prov_disc_fail
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|enum
name|p2p_prov_disc_status
name|status
parameter_list|,
name|u32
name|adv_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|adv_mac
parameter_list|,
specifier|const
name|char
modifier|*
name|deferred_session_resp
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: PD for p2p_connect-auto "
literal|"failed - fall back to GO Negotiation"
argument_list|)
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_FALLBACK_TO_GO_NEG
literal|"reason=PD-failed"
argument_list|)
expr_stmt|;
name|wpas_p2p_fallback_to_go_neg
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|status
operator|==
name|P2P_PROV_DISC_TIMEOUT_JOIN
condition|)
block|{
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Starting pending "
literal|"join-existing-group operation (no ACK for PD "
literal|"Req attempts)"
argument_list|)
expr_stmt|;
name|wpas_p2p_join_start
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|adv_id
operator|&&
name|adv_mac
operator|&&
name|deferred_session_resp
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_PROV_DISC_FAILURE
literal|" p2p_dev_addr="
name|MACSTR
literal|" status=%d adv_id=%x"
literal|" deferred_session_resp='%s'"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|,
name|status
argument_list|,
name|adv_id
argument_list|,
name|deferred_session_resp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|adv_id
operator|&&
name|adv_mac
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_PROV_DISC_FAILURE
literal|" p2p_dev_addr="
name|MACSTR
literal|" status=%d adv_id=%x"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|,
name|status
argument_list|,
name|adv_id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_PROV_DISC_FAILURE
literal|" p2p_dev_addr="
name|MACSTR
literal|" status=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
name|wpas_notify_p2p_provision_discovery
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
literal|0
comment|/* response */
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|freq_included
parameter_list|(
specifier|const
name|struct
name|p2p_channels
modifier|*
name|channels
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|)
block|{
if|if
condition|(
name|channels
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
comment|/* Assume no restrictions */
return|return
name|p2p_channels_includes_freq
argument_list|(
name|channels
argument_list|,
name|freq
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * Pick the best frequency to use from all the currently used frequencies.  */
end_comment

begin_function
specifier|static
name|int
name|wpas_p2p_pick_best_used_freq
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_used_freq_data
modifier|*
name|freqs
parameter_list|,
name|unsigned
name|int
name|num
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|c
decl_stmt|;
comment|/* find a candidate freq that is supported by P2P */
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
name|num
condition|;
name|c
operator|++
control|)
if|if
condition|(
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freqs
index|[
name|c
index|]
operator|.
name|freq
argument_list|)
condition|)
break|break;
if|if
condition|(
name|c
operator|==
name|num
condition|)
return|return
literal|0
return|;
comment|/* once we have a candidate, try to find a 'better' one */
for|for
control|(
name|i
operator|=
name|c
operator|+
literal|1
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freqs
index|[
name|i
index|]
operator|.
name|freq
argument_list|)
condition|)
continue|continue;
comment|/* 		 * 1. Infrastructure station interfaces have higher preference. 		 * 2. P2P Clients have higher preference. 		 * 3. All others. 		 */
if|if
condition|(
name|freqs
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|WPA_FREQ_USED_BY_INFRA_STATION
condition|)
block|{
name|c
operator|=
name|i
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|freqs
index|[
name|i
index|]
operator|.
name|flags
operator|&
name|WPA_FREQ_USED_BY_P2P_CLIENT
operator|)
condition|)
name|c
operator|=
name|i
expr_stmt|;
block|}
return|return
name|freqs
index|[
name|c
index|]
operator|.
name|freq
return|;
block|}
end_function

begin_function
specifier|static
name|u8
name|wpas_invitation_process
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
name|int
modifier|*
name|go
parameter_list|,
name|u8
modifier|*
name|group_bssid
parameter_list|,
name|int
modifier|*
name|force_freq
parameter_list|,
name|int
name|persistent_group
parameter_list|,
specifier|const
name|struct
name|p2p_channels
modifier|*
name|channels
parameter_list|,
name|int
name|dev_pw_id
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|struct
name|wpa_used_freq_data
modifier|*
name|freqs
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|grp
decl_stmt|;
name|int
name|best_freq
decl_stmt|;
if|if
condition|(
operator|!
name|persistent_group
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invitation from "
name|MACSTR
literal|" to join an active group (SSID: %s)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
argument_list|,
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|)
operator|&&
operator|(
name|os_memcmp
argument_list|(
name|go_dev_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|||
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Accept previously "
literal|"authorized invitation"
argument_list|)
expr_stmt|;
goto|goto
name|accept_inv
goto|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
if|if
condition|(
name|dev_pw_id
operator|>=
literal|0
operator|&&
name|wpa_s
operator|->
name|p2p_nfc_tag_enabled
operator|&&
name|dev_pw_id
operator|==
name|wpa_s
operator|->
name|p2p_oob_dev_pw_id
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Accept invitation based on local enabled NFC Tag"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_wps_method
operator|=
name|WPS_NFC
expr_stmt|;
name|wpa_s
operator|->
name|pending_join_wps_method
operator|=
name|WPS_NFC
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|go_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
goto|goto
name|accept_inv
goto|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_NFC */
comment|/* 		 * Do not accept the invitation automatically; notify user and 		 * request approval. 		 */
return|return
name|P2P_SC_FAIL_INFO_CURRENTLY_UNAVAILABLE
return|;
block|}
name|grp
operator|=
name|wpas_get_p2p_group
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|,
name|go
argument_list|)
expr_stmt|;
if|if
condition|(
name|grp
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Accept invitation to already "
literal|"running persistent group"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|go
condition|)
name|os_memcpy
argument_list|(
name|group_bssid
argument_list|,
name|grp
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
goto|goto
name|accept_inv
goto|;
block|}
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|)
operator|&&
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Accept previously initiated "
literal|"invitation to re-invoke a persistent group"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|persistent_reconnect
condition|)
return|return
name|P2P_SC_FAIL_INFO_CURRENTLY_UNAVAILABLE
return|;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|==
literal|2
operator|&&
name|os_memcmp
argument_list|(
name|s
operator|->
name|bssid
argument_list|,
name|go_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|s
operator|->
name|ssid_len
operator|==
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|s
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invitation from "
name|MACSTR
literal|" requested reinvocation of an unknown group"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|P2P_SC_FAIL_UNKNOWN_GROUP
return|;
block|}
if|if
condition|(
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
operator|!
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
operator|*
name|go
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_AUTHENTICATING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: The only available "
literal|"interface is already in use - reject "
literal|"invitation"
argument_list|)
expr_stmt|;
return|return
name|P2P_SC_FAIL_UNABLE_TO_ACCOMMODATE
return|;
block|}
name|os_memcpy
argument_list|(
name|group_bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
operator|*
name|go
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|WPA_IF_P2P_GO
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to allocate a new "
literal|"interface address for the group"
argument_list|)
expr_stmt|;
return|return
name|P2P_SC_FAIL_UNABLE_TO_ACCOMMODATE
return|;
block|}
name|os_memcpy
argument_list|(
name|group_bssid
argument_list|,
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|accept_inv
label|:
name|wpas_p2p_set_own_freq_preference
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|best_freq
operator|=
literal|0
expr_stmt|;
name|freqs
operator|=
name|os_calloc
argument_list|(
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_used_freq_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|freqs
condition|)
block|{
name|int
name|num_channels
init|=
name|wpa_s
operator|->
name|num_multichan_concurrent
decl_stmt|;
name|int
name|num
init|=
name|wpas_p2p_valid_oper_freqs
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|num_channels
argument_list|)
decl_stmt|;
name|best_freq
operator|=
name|wpas_p2p_pick_best_used_freq
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
block|}
comment|/* Get one of the frequencies currently in use */
if|if
condition|(
name|best_freq
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Trying to prefer a channel already used by one of the interfaces"
argument_list|)
expr_stmt|;
name|wpas_p2p_set_own_freq_preference
argument_list|(
name|wpa_s
argument_list|,
name|best_freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|num_multichan_concurrent
operator|<
literal|2
operator|||
name|wpas_p2p_num_unused_channels
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No extra channels available - trying to force channel to match a channel already used by one of the interfaces"
argument_list|)
expr_stmt|;
operator|*
name|force_freq
operator|=
name|best_freq
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|*
name|force_freq
operator|>
literal|0
operator|&&
name|wpa_s
operator|->
name|num_multichan_concurrent
operator|>
literal|1
operator|&&
name|wpas_p2p_num_unused_channels
argument_list|(
name|wpa_s
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|go
operator|==
literal|0
condition|)
block|{
comment|/* We are the client */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer was found to be "
literal|"running a GO but we are capable of MCC, "
literal|"figure out the best channel to use"
argument_list|)
expr_stmt|;
operator|*
name|force_freq
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|freq_included
argument_list|(
name|channels
argument_list|,
operator|*
name|force_freq
argument_list|)
condition|)
block|{
comment|/* We are the GO, and *force_freq is not in the 			 * intersection */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Forced GO freq %d MHz not "
literal|"in intersection but we are capable of MCC, "
literal|"figure out the best channel to use"
argument_list|,
operator|*
name|force_freq
argument_list|)
expr_stmt|;
operator|*
name|force_freq
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
name|P2P_SC_SUCCESS
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_invitation_received
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
name|u8
name|status
parameter_list|,
name|int
name|op_freq
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|==
literal|2
operator|&&
name|s
operator|->
name|ssid_len
operator|==
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|status
operator|==
name|P2P_SC_SUCCESS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invitation from peer "
name|MACSTR
literal|" was accepted; op_freq=%d MHz, SSID=%s"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|op_freq
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
argument_list|,
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
name|int
name|go
init|=
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
decl_stmt|;
name|wpas_p2p_group_add_persistent
argument_list|(
name|wpa_s
argument_list|,
name|s
argument_list|,
name|go
argument_list|,
literal|0
argument_list|,
name|op_freq
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|go
condition|?
name|P2P_MAX_INITIAL_CONN_WAIT_GO_REINVOKE
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bssid
condition|)
block|{
name|wpa_s
operator|->
name|user_initiated_pd
operator|=
literal|0
expr_stmt|;
name|wpas_p2p_join
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|,
name|go_dev_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_wps_method
argument_list|,
literal|0
argument_list|,
name|op_freq
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|status
operator|!=
name|P2P_SC_FAIL_INFO_CURRENTLY_UNAVAILABLE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invitation from peer "
name|MACSTR
literal|" was rejected (status %u)"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|s
condition|)
block|{
if|if
condition|(
name|bssid
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RECEIVED
literal|"sa="
name|MACSTR
literal|" go_dev_addr="
name|MACSTR
literal|" bssid="
name|MACSTR
literal|" unknown-network"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RECEIVED
literal|"sa="
name|MACSTR
literal|" go_dev_addr="
name|MACSTR
literal|" unknown-network"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
name|op_freq
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RECEIVED
literal|"sa="
name|MACSTR
literal|" persistent=%d freq=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|s
operator|->
name|id
argument_list|,
name|op_freq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RECEIVED
literal|"sa="
name|MACSTR
literal|" persistent=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|s
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_remove_persistent_peer
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|int
name|inv
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|ssid
operator|->
name|p2p_client_list
operator|&&
name|i
operator|<
name|ssid
operator|->
name|num_p2p_clients
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|>=
name|ssid
operator|->
name|num_p2p_clients
operator|||
operator|!
name|ssid
operator|->
name|p2p_client_list
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|&&
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|bssid
argument_list|,
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove persistent group %d "
literal|"due to invitation result"
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
return|return;
block|}
return|return;
comment|/* Peer not found in client list */
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove peer "
name|MACSTR
literal|" from persistent "
literal|"group %d client list%s"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|,
name|ssid
operator|->
name|id
argument_list|,
name|inv
condition|?
literal|" due to invitation result"
else|:
literal|""
argument_list|)
expr_stmt|;
name|os_memmove
argument_list|(
name|ssid
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|ssid
operator|->
name|p2p_client_list
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
operator|(
name|ssid
operator|->
name|num_p2p_clients
operator|-
name|i
operator|-
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|num_p2p_clients
operator|--
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|parent
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|conf
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to update configuration"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_remove_persistent_client
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p_invite_group
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return;
comment|/* No known invitation group */
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|||
operator|!
name|ssid
operator|->
name|p2p_persistent_group
condition|)
return|return;
comment|/* Not operating as a GO in persistent group */
name|ssid
operator|=
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|peer
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpas_remove_persistent_peer
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|peer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_invitation_result
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|status
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|struct
name|p2p_channels
modifier|*
name|channels
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|int
name|neg_freq
parameter_list|,
name|int
name|peer_oper_freq
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|freq
decl_stmt|;
if|if
condition|(
name|bssid
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RESULT
literal|"status=%d "
name|MACSTR
argument_list|,
name|status
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_INVITATION_RESULT
literal|"status=%d "
argument_list|,
name|status
argument_list|)
expr_stmt|;
block|}
name|wpas_notify_p2p_invitation_result
argument_list|(
name|wpa_s
argument_list|,
name|status
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invitation result - status=%d peer="
name|MACSTR
argument_list|,
name|status
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_invite_ssid_id
operator|==
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|P2P_SC_FAIL_UNKNOWN_GROUP
condition|)
name|wpas_remove_persistent_client
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|)
expr_stmt|;
return|return;
comment|/* Invitation to active group */
block|}
if|if
condition|(
name|status
operator|==
name|P2P_SC_FAIL_INFO_CURRENTLY_UNAVAILABLE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Waiting for peer to start another "
literal|"invitation exchange to indicate readiness for "
literal|"re-invocation"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|P2P_SC_SUCCESS
condition|)
block|{
if|if
condition|(
name|status
operator|==
name|P2P_SC_FAIL_UNKNOWN_GROUP
condition|)
block|{
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|wpa_s
operator|->
name|pending_invite_ssid_id
argument_list|)
expr_stmt|;
name|wpas_remove_persistent_peer
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|peer
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|wpa_s
operator|->
name|pending_invite_ssid_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Could not find persistent group "
literal|"data matching with invitation"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 	 * The peer could have missed our ctrl::ack frame for Invitation 	 * Response and continue retransmitting the frame. To reduce the 	 * likelihood of the peer not getting successful TX status for the 	 * Invitation Response frame, wait a short time here before starting 	 * the persistent group so that we will remain on the current channel to 	 * acknowledge any possible retransmission from the peer. 	 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: 50 ms wait on current channel before "
literal|"starting persistent group"
argument_list|)
expr_stmt|;
name|os_sleep
argument_list|(
literal|0
argument_list|,
literal|50000
argument_list|)
expr_stmt|;
if|if
condition|(
name|neg_freq
operator|>
literal|0
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|neg_freq
argument_list|)
condition|)
name|freq
operator|=
name|neg_freq
expr_stmt|;
elseif|else
if|if
condition|(
name|peer_oper_freq
operator|>
literal|0
operator|&&
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|peer_oper_freq
argument_list|)
condition|)
name|freq
operator|=
name|peer_oper_freq
expr_stmt|;
else|else
name|freq
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Persistent group invitation success - op_freq=%d MHz SSID=%s"
argument_list|,
name|freq
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
name|wpas_p2p_group_add_persistent
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_go_freq
argument_list|,
name|freq
argument_list|,
name|wpa_s
operator|->
name|p2p_go_ht40
argument_list|,
name|wpa_s
operator|->
name|p2p_go_vht
argument_list|,
name|channels
argument_list|,
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|?
name|P2P_MAX_INITIAL_CONN_WAIT_GO_REINVOKE
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_disallowed_freq
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|)
block|{
if|if
condition|(
name|freq_range_list_includes
argument_list|(
operator|&
name|global
operator|->
name|p2p_go_avoid_freq
argument_list|,
name|freq
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
name|freq_range_list_includes
argument_list|(
operator|&
name|global
operator|->
name|p2p_disallow_freq
argument_list|,
name|freq
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_add_chan
parameter_list|(
name|struct
name|p2p_reg_class
modifier|*
name|reg
parameter_list|,
name|u8
name|chan
parameter_list|)
block|{
name|reg
operator|->
name|channel
index|[
name|reg
operator|->
name|channels
index|]
operator|=
name|chan
expr_stmt|;
name|reg
operator|->
name|channels
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_default_channels
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_channels
modifier|*
name|chan
parameter_list|,
name|struct
name|p2p_channels
modifier|*
name|cli_chan
parameter_list|)
block|{
name|int
name|i
decl_stmt|,
name|cla
init|=
literal|0
decl_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_24ghz_social_channels
operator|=
literal|1
expr_stmt|;
name|os_memset
argument_list|(
name|cli_chan
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cli_chan
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Enable operating classes for 2.4 GHz "
literal|"band"
argument_list|)
expr_stmt|;
comment|/* Operating class 81 - 2.4 GHz band channels 1..13 */
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|reg_class
operator|=
literal|81
expr_stmt|;
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|11
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|2412
operator|+
name|i
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
name|i
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
condition|)
name|cla
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Enable operating classes for lower 5 GHz "
literal|"band"
argument_list|)
expr_stmt|;
comment|/* Operating class 115 - 5 GHz, channels 36-48 */
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|reg_class
operator|=
literal|115
expr_stmt|;
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|36
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|36
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|40
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|40
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|44
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|44
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|48
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|48
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
condition|)
name|cla
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Enable operating classes for higher 5 GHz "
literal|"band"
argument_list|)
expr_stmt|;
comment|/* Operating class 124 - 5 GHz, channels 149,153,157,161 */
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|reg_class
operator|=
literal|124
expr_stmt|;
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|149
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|149
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|153
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|153
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|156
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|157
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
literal|5000
operator|+
literal|161
operator|*
literal|5
argument_list|)
condition|)
name|wpas_p2p_add_chan
argument_list|(
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
argument_list|,
literal|161
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
operator|.
name|channels
condition|)
name|cla
operator|++
expr_stmt|;
name|chan
operator|->
name|reg_classes
operator|=
name|cla
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|hostapd_hw_modes
modifier|*
name|get_mode
parameter_list|(
name|struct
name|hostapd_hw_modes
modifier|*
name|modes
parameter_list|,
name|u16
name|num_modes
parameter_list|,
name|enum
name|hostapd_hw_mode
name|mode
parameter_list|)
block|{
name|u16
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|modes
index|[
name|i
index|]
operator|.
name|mode
operator|==
name|mode
condition|)
return|return
operator|&
name|modes
index|[
name|i
index|]
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_enum
enum|enum
name|chan_allowed
block|{
name|NOT_ALLOWED
block|,
name|NO_IR
block|,
name|ALLOWED
block|}
enum|;
end_enum

begin_function
specifier|static
name|int
name|has_channel
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|,
name|u8
name|chan
parameter_list|,
name|int
modifier|*
name|flags
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|unsigned
name|int
name|freq
decl_stmt|;
name|freq
operator|=
operator|(
name|mode
operator|->
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211A
condition|?
literal|5000
else|:
literal|2407
operator|)
operator|+
name|chan
operator|*
literal|5
expr_stmt|;
if|if
condition|(
name|wpas_p2p_disallowed_freq
argument_list|(
name|global
argument_list|,
name|freq
argument_list|)
condition|)
return|return
name|NOT_ALLOWED
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mode
operator|->
name|num_channels
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|mode
operator|->
name|channels
index|[
name|i
index|]
operator|.
name|chan
operator|==
name|chan
condition|)
block|{
if|if
condition|(
name|flags
condition|)
operator|*
name|flags
operator|=
name|mode
operator|->
name|channels
index|[
name|i
index|]
operator|.
name|flag
expr_stmt|;
if|if
condition|(
name|mode
operator|->
name|channels
index|[
name|i
index|]
operator|.
name|flag
operator|&
operator|(
name|HOSTAPD_CHAN_DISABLED
operator||
name|HOSTAPD_CHAN_RADAR
operator|)
condition|)
return|return
name|NOT_ALLOWED
return|;
if|if
condition|(
name|mode
operator|->
name|channels
index|[
name|i
index|]
operator|.
name|flag
operator|&
name|HOSTAPD_CHAN_NO_IR
condition|)
return|return
name|NO_IR
return|;
return|return
name|ALLOWED
return|;
block|}
block|}
return|return
name|NOT_ALLOWED
return|;
block|}
end_function

begin_struct
struct|struct
name|p2p_oper_class_map
block|{
name|enum
name|hostapd_hw_mode
name|mode
decl_stmt|;
name|u8
name|op_class
decl_stmt|;
name|u8
name|min_chan
decl_stmt|;
name|u8
name|max_chan
decl_stmt|;
name|u8
name|inc
decl_stmt|;
enum|enum
block|{
name|BW20
block|,
name|BW40PLUS
block|,
name|BW40MINUS
block|,
name|BW80
block|,
name|BW2160
block|}
name|bw
enum|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|p2p_oper_class_map
name|op_class
index|[]
init|=
block|{
block|{
name|HOSTAPD_MODE_IEEE80211G
block|,
literal|81
block|,
literal|1
block|,
literal|13
block|,
literal|1
block|,
name|BW20
block|}
block|,
if|#
directive|if
literal|0
comment|/* Do not enable HT40 on 2 GHz for now */
block|{ HOSTAPD_MODE_IEEE80211G, 83, 1, 9, 1, BW40PLUS }, 	{ HOSTAPD_MODE_IEEE80211G, 84, 5, 13, 1, BW40MINUS },
endif|#
directive|endif
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|115
block|,
literal|36
block|,
literal|48
block|,
literal|4
block|,
name|BW20
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|124
block|,
literal|149
block|,
literal|161
block|,
literal|4
block|,
name|BW20
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|116
block|,
literal|36
block|,
literal|44
block|,
literal|8
block|,
name|BW40PLUS
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|117
block|,
literal|40
block|,
literal|48
block|,
literal|8
block|,
name|BW40MINUS
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|126
block|,
literal|149
block|,
literal|157
block|,
literal|8
block|,
name|BW40PLUS
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|127
block|,
literal|153
block|,
literal|161
block|,
literal|8
block|,
name|BW40MINUS
block|}
block|,
comment|/* 	 * IEEE P802.11ac/D7.0 Table E-4 actually talks about channel center 	 * frequency index 42, 58, 106, 122, 138, 155 with channel spacing of 	 * 80 MHz, but currently use the following definition for simplicity 	 * (these center frequencies are not actual channels, which makes 	 * has_channel() fail). wpas_p2p_verify_80mhz() should take care of 	 * removing invalid channels. 	 */
block|{
name|HOSTAPD_MODE_IEEE80211A
block|,
literal|128
block|,
literal|36
block|,
literal|161
block|,
literal|4
block|,
name|BW80
block|}
block|,
block|{
name|HOSTAPD_MODE_IEEE80211AD
block|,
literal|180
block|,
literal|1
block|,
literal|4
block|,
literal|1
block|,
name|BW2160
block|}
block|,
block|{
operator|-
literal|1
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
name|BW20
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|wpas_p2p_get_center_80mhz
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|,
name|u8
name|channel
parameter_list|)
block|{
name|u8
name|center_channels
index|[]
init|=
block|{
literal|42
block|,
literal|58
block|,
literal|106
block|,
literal|122
block|,
literal|138
block|,
literal|155
block|}
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
name|mode
operator|->
name|mode
operator|!=
name|HOSTAPD_MODE_IEEE80211A
condition|)
return|return
literal|0
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ARRAY_SIZE
argument_list|(
name|center_channels
argument_list|)
condition|;
name|i
operator|++
control|)
comment|/* 		 * In 80 MHz, the bandwidth "spans" 12 channels (e.g., 36-48), 		 * so the center channel is 6 channels away from the start/end. 		 */
if|if
condition|(
name|channel
operator|>=
name|center_channels
index|[
name|i
index|]
operator|-
literal|6
operator|&&
name|channel
operator|<=
name|center_channels
index|[
name|i
index|]
operator|+
literal|6
condition|)
return|return
name|center_channels
index|[
name|i
index|]
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|chan_allowed
name|wpas_p2p_verify_80mhz
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|,
name|u8
name|channel
parameter_list|,
name|u8
name|bw
parameter_list|)
block|{
name|u8
name|center_chan
decl_stmt|;
name|int
name|i
decl_stmt|,
name|flags
decl_stmt|;
name|enum
name|chan_allowed
name|res
decl_stmt|,
name|ret
init|=
name|ALLOWED
decl_stmt|;
name|center_chan
operator|=
name|wpas_p2p_get_center_80mhz
argument_list|(
name|wpa_s
argument_list|,
name|mode
argument_list|,
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|center_chan
condition|)
return|return
name|NOT_ALLOWED
return|;
if|if
condition|(
name|center_chan
operator|>=
literal|58
operator|&&
name|center_chan
operator|<=
literal|138
condition|)
return|return
name|NOT_ALLOWED
return|;
comment|/* Do not allow DFS channels for P2P */
comment|/* check all the channels are available */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|int
name|adj_chan
init|=
name|center_chan
operator|-
literal|6
operator|+
name|i
operator|*
literal|4
decl_stmt|;
name|res
operator|=
name|has_channel
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|mode
argument_list|,
name|adj_chan
argument_list|,
operator|&
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|NOT_ALLOWED
condition|)
return|return
name|NOT_ALLOWED
return|;
if|if
condition|(
name|res
operator|==
name|NO_IR
condition|)
name|ret
operator|=
name|NO_IR
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
operator|&&
operator|!
operator|(
name|flags
operator|&
name|HOSTAPD_CHAN_VHT_10_70
operator|)
condition|)
return|return
name|NOT_ALLOWED
return|;
if|if
condition|(
name|i
operator|==
literal|1
operator|&&
operator|!
operator|(
name|flags
operator|&
name|HOSTAPD_CHAN_VHT_30_50
operator|)
condition|)
return|return
name|NOT_ALLOWED
return|;
if|if
condition|(
name|i
operator|==
literal|2
operator|&&
operator|!
operator|(
name|flags
operator|&
name|HOSTAPD_CHAN_VHT_50_30
operator|)
condition|)
return|return
name|NOT_ALLOWED
return|;
if|if
condition|(
name|i
operator|==
literal|3
operator|&&
operator|!
operator|(
name|flags
operator|&
name|HOSTAPD_CHAN_VHT_70_10
operator|)
condition|)
return|return
name|NOT_ALLOWED
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|chan_allowed
name|wpas_p2p_verify_channel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|,
name|u8
name|channel
parameter_list|,
name|u8
name|bw
parameter_list|)
block|{
name|int
name|flag
init|=
literal|0
decl_stmt|;
name|enum
name|chan_allowed
name|res
decl_stmt|,
name|res2
decl_stmt|;
name|res2
operator|=
name|res
operator|=
name|has_channel
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|mode
argument_list|,
name|channel
argument_list|,
operator|&
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|bw
operator|==
name|BW40MINUS
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|flag
operator|&
name|HOSTAPD_CHAN_HT40MINUS
operator|)
condition|)
return|return
name|NOT_ALLOWED
return|;
name|res2
operator|=
name|has_channel
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|mode
argument_list|,
name|channel
operator|-
literal|4
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bw
operator|==
name|BW40PLUS
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|flag
operator|&
name|HOSTAPD_CHAN_HT40PLUS
operator|)
condition|)
return|return
name|NOT_ALLOWED
return|;
name|res2
operator|=
name|has_channel
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|mode
argument_list|,
name|channel
operator|+
literal|4
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bw
operator|==
name|BW80
condition|)
block|{
name|res2
operator|=
name|wpas_p2p_verify_80mhz
argument_list|(
name|wpa_s
argument_list|,
name|mode
argument_list|,
name|channel
argument_list|,
name|bw
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|==
name|NOT_ALLOWED
operator|||
name|res2
operator|==
name|NOT_ALLOWED
condition|)
return|return
name|NOT_ALLOWED
return|;
if|if
condition|(
name|res
operator|==
name|NO_IR
operator|||
name|res2
operator|==
name|NO_IR
condition|)
return|return
name|NO_IR
return|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_setup_channels
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_channels
modifier|*
name|chan
parameter_list|,
name|struct
name|p2p_channels
modifier|*
name|cli_chan
parameter_list|)
block|{
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
decl_stmt|;
name|int
name|cla
decl_stmt|,
name|op
decl_stmt|,
name|cli_cla
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|hw
operator|.
name|modes
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Driver did not support fetching "
literal|"of all supported channels; assume dualband "
literal|"support"
argument_list|)
expr_stmt|;
return|return
name|wpas_p2p_default_channels
argument_list|(
name|wpa_s
argument_list|,
name|chan
argument_list|,
name|cli_chan
argument_list|)
return|;
block|}
name|cla
operator|=
name|cli_cla
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|op
operator|=
literal|0
init|;
name|op_class
index|[
name|op
index|]
operator|.
name|op_class
condition|;
name|op
operator|++
control|)
block|{
name|struct
name|p2p_oper_class_map
modifier|*
name|o
init|=
operator|&
name|op_class
index|[
name|op
index|]
decl_stmt|;
name|u8
name|ch
decl_stmt|;
name|struct
name|p2p_reg_class
modifier|*
name|reg
init|=
name|NULL
decl_stmt|,
modifier|*
name|cli_reg
init|=
name|NULL
decl_stmt|;
name|mode
operator|=
name|get_mode
argument_list|(
name|wpa_s
operator|->
name|hw
operator|.
name|modes
argument_list|,
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
argument_list|,
name|o
operator|->
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|mode
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|mode
operator|->
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211G
condition|)
name|wpa_s
operator|->
name|global
operator|->
name|p2p_24ghz_social_channels
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|ch
operator|=
name|o
operator|->
name|min_chan
init|;
name|ch
operator|<=
name|o
operator|->
name|max_chan
condition|;
name|ch
operator|+=
name|o
operator|->
name|inc
control|)
block|{
name|enum
name|chan_allowed
name|res
decl_stmt|;
name|res
operator|=
name|wpas_p2p_verify_channel
argument_list|(
name|wpa_s
argument_list|,
name|mode
argument_list|,
name|ch
argument_list|,
name|o
operator|->
name|bw
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
name|ALLOWED
condition|)
block|{
if|if
condition|(
name|reg
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add operating class %u"
argument_list|,
name|o
operator|->
name|op_class
argument_list|)
expr_stmt|;
name|reg
operator|=
operator|&
name|chan
operator|->
name|reg_class
index|[
name|cla
index|]
expr_stmt|;
name|cla
operator|++
expr_stmt|;
name|reg
operator|->
name|reg_class
operator|=
name|o
operator|->
name|op_class
expr_stmt|;
block|}
name|reg
operator|->
name|channel
index|[
name|reg
operator|->
name|channels
index|]
operator|=
name|ch
expr_stmt|;
name|reg
operator|->
name|channels
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|res
operator|==
name|NO_IR
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_add_cli_chan
condition|)
block|{
if|if
condition|(
name|cli_reg
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add operating class %u (client only)"
argument_list|,
name|o
operator|->
name|op_class
argument_list|)
expr_stmt|;
name|cli_reg
operator|=
operator|&
name|cli_chan
operator|->
name|reg_class
index|[
name|cli_cla
index|]
expr_stmt|;
name|cli_cla
operator|++
expr_stmt|;
name|cli_reg
operator|->
name|reg_class
operator|=
name|o
operator|->
name|op_class
expr_stmt|;
block|}
name|cli_reg
operator|->
name|channel
index|[
name|cli_reg
operator|->
name|channels
index|]
operator|=
name|ch
expr_stmt|;
name|cli_reg
operator|->
name|channels
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|reg
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Channels"
argument_list|,
name|reg
operator|->
name|channel
argument_list|,
name|reg
operator|->
name|channels
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cli_reg
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Channels (client only)"
argument_list|,
name|cli_reg
operator|->
name|channel
argument_list|,
name|cli_reg
operator|->
name|channels
argument_list|)
expr_stmt|;
block|}
block|}
name|chan
operator|->
name|reg_classes
operator|=
name|cla
expr_stmt|;
name|cli_chan
operator|->
name|reg_classes
operator|=
name|cli_cla
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_get_ht40_mode
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|,
name|u8
name|channel
parameter_list|)
block|{
name|int
name|op
decl_stmt|;
name|enum
name|chan_allowed
name|ret
decl_stmt|;
for|for
control|(
name|op
operator|=
literal|0
init|;
name|op_class
index|[
name|op
index|]
operator|.
name|op_class
condition|;
name|op
operator|++
control|)
block|{
name|struct
name|p2p_oper_class_map
modifier|*
name|o
init|=
operator|&
name|op_class
index|[
name|op
index|]
decl_stmt|;
name|u8
name|ch
decl_stmt|;
for|for
control|(
name|ch
operator|=
name|o
operator|->
name|min_chan
init|;
name|ch
operator|<=
name|o
operator|->
name|max_chan
condition|;
name|ch
operator|+=
name|o
operator|->
name|inc
control|)
block|{
if|if
condition|(
name|o
operator|->
name|mode
operator|!=
name|HOSTAPD_MODE_IEEE80211A
operator|||
name|o
operator|->
name|bw
operator|==
name|BW20
operator|||
name|ch
operator|!=
name|channel
condition|)
continue|continue;
name|ret
operator|=
name|wpas_p2p_verify_channel
argument_list|(
name|wpa_s
argument_list|,
name|mode
argument_list|,
name|ch
argument_list|,
name|o
operator|->
name|bw
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|ALLOWED
condition|)
return|return
operator|(
name|o
operator|->
name|bw
operator|==
name|BW40MINUS
operator|)
condition|?
operator|-
literal|1
else|:
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_get_vht80_center
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
parameter_list|,
name|u8
name|channel
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpas_p2p_verify_channel
argument_list|(
name|wpa_s
argument_list|,
name|mode
argument_list|,
name|channel
argument_list|,
name|BW80
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
name|wpas_p2p_get_center_80mhz
argument_list|(
name|wpa_s
argument_list|,
name|mode
argument_list|,
name|channel
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_get_noa
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|interface_addr
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|interface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpa_drv_get_noa
argument_list|(
name|wpa_s
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|wpa_supplicant
modifier|*
name|wpas_get_p2p_go_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|s
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|&&
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_AP
operator|&&
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GROUP_FORMATION
condition|)
continue|continue;
if|if
condition|(
name|s
operator|->
name|ssid_len
operator|!=
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
return|return
name|wpa_s
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|wpa_supplicant
modifier|*
name|wpas_get_p2p_client_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_dev_addr
parameter_list|)
block|{
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
condition|)
continue|continue;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
operator|&&
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_GROUP_HANDSHAKE
condition|)
continue|continue;
if|if
condition|(
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|go_dev_addr
argument_list|,
name|peer_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|wpa_s
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_go_connected
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
return|return
name|wpas_get_p2p_client_iface
argument_list|(
name|wpa_s
argument_list|,
name|dev_addr
argument_list|)
operator|!=
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_is_concurrent_session_active
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|ifs
decl_stmt|;
for|for
control|(
name|ifs
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|ifs
condition|;
name|ifs
operator|=
name|ifs
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ifs
operator|==
name|wpa_s
condition|)
continue|continue;
if|if
condition|(
name|ifs
operator|->
name|wpa_state
operator|>
name|WPA_ASSOCIATED
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_debug_print
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|msg
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|level
argument_list|,
literal|"P2P: %s"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_add_p2pdev_interface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|conf_p2p_dev
parameter_list|)
block|{
name|struct
name|wpa_interface
name|iface
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|p2pdev_wpa_s
decl_stmt|;
name|char
name|ifname
index|[
literal|100
index|]
decl_stmt|;
name|char
name|force_name
index|[
literal|100
index|]
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
argument_list|,
name|P2P_MGMT_DEVICE_PREFIX
literal|"%s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
sizeof|sizeof
argument_list|(
name|ifname
argument_list|)
argument_list|,
name|ret
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|force_name
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_s
operator|->
name|pending_interface_type
operator|=
name|WPA_IF_P2P_DEVICE
expr_stmt|;
name|ret
operator|=
name|wpa_drv_if_add
argument_list|(
name|wpa_s
argument_list|,
name|WPA_IF_P2P_DEVICE
argument_list|,
name|ifname
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|force_name
argument_list|,
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to create P2P Device interface"
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|pending_interface_name
argument_list|,
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|pending_interface_name
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|iface
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|iface
operator|.
name|p2p_mgmt
operator|=
literal|1
expr_stmt|;
name|iface
operator|.
name|ifname
operator|=
name|wpa_s
operator|->
name|pending_interface_name
expr_stmt|;
name|iface
operator|.
name|driver
operator|=
name|wpa_s
operator|->
name|driver
operator|->
name|name
expr_stmt|;
name|iface
operator|.
name|driver_param
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|driver_param
expr_stmt|;
comment|/* 	 * If a P2P Device configuration file was given, use it as the interface 	 * configuration file (instead of using parent's configuration file. 	 */
if|if
condition|(
name|conf_p2p_dev
condition|)
block|{
name|iface
operator|.
name|confname
operator|=
name|conf_p2p_dev
expr_stmt|;
name|iface
operator|.
name|ctrl_interface
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|iface
operator|.
name|confname
operator|=
name|wpa_s
operator|->
name|confname
expr_stmt|;
name|iface
operator|.
name|ctrl_interface
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ctrl_interface
expr_stmt|;
block|}
name|iface
operator|.
name|conf_p2p_dev
operator|=
name|NULL
expr_stmt|;
name|p2pdev_wpa_s
operator|=
name|wpa_supplicant_add_iface
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
operator|&
name|iface
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p2pdev_wpa_s
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to add P2P Device interface"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|p2p_dev
operator|=
name|p2pdev_wpa_s
expr_stmt|;
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_presence_resp
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|src
parameter_list|,
name|u8
name|status
parameter_list|,
specifier|const
name|u8
modifier|*
name|noa
parameter_list|,
name|size_t
name|noa_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|,
modifier|*
name|intf
init|=
name|ctx
decl_stmt|;
name|char
name|hex
index|[
literal|100
index|]
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|intf
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|waiting_presence_resp
condition|)
break|break;
block|}
if|if
condition|(
operator|!
name|wpa_s
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: No group interface was waiting for presence response"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|waiting_presence_resp
operator|=
literal|0
expr_stmt|;
name|wpa_snprintf_hex
argument_list|(
name|hex
argument_list|,
sizeof|sizeof
argument_list|(
name|hex
argument_list|)
argument_list|,
name|noa
argument_list|,
name|noa_len
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_PRESENCE_RESPONSE
literal|"src="
name|MACSTR
literal|" status=%u noa=%s"
argument_list|,
name|MAC2STR
argument_list|(
name|src
argument_list|)
argument_list|,
name|status
argument_list|,
name|hex
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_get_persistent_group
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
name|u8
modifier|*
name|ret_ssid
parameter_list|,
name|size_t
modifier|*
name|ret_ssid_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|s
operator|=
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
name|os_memcpy
argument_list|(
name|ret_ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
operator|*
name|ret_ssid_len
operator|=
name|s
operator|->
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|go_dev_addr
argument_list|,
name|s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_get_go_info
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
modifier|*
name|intended_addr
parameter_list|,
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
modifier|*
name|ssid_len
parameter_list|,
name|int
modifier|*
name|group_iface
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|s
operator|=
name|wpas_p2p_group_go_ssid
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s
condition|)
block|{
name|s
operator|=
name|wpas_p2p_get_persistent_go
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
name|os_memcpy
argument_list|(
name|bssid
argument_list|,
name|s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
operator|*
name|group_iface
operator|=
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|s
condition|)
return|return
literal|0
return|;
name|os_memcpy
argument_list|(
name|intended_addr
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
operator|*
name|ssid_len
operator|=
name|s
operator|->
name|ssid_len
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_remove_stale_groups
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
specifier|const
name|u8
modifier|*
name|go
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|int
name|save_config
init|=
literal|0
decl_stmt|;
name|size_t
name|i
decl_stmt|;
comment|/* Start with our first choice of Persistent Groups */
while|while
condition|(
operator|(
name|s
operator|=
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
argument_list|,
name|peer
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|go
operator|&&
name|ssid
operator|&&
name|ssid_len
operator|&&
name|s
operator|->
name|ssid_len
operator|==
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|go
argument_list|,
name|s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
comment|/* Remove stale persistent group */
if|if
condition|(
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|||
name|s
operator|->
name|num_p2p_clients
operator|<=
literal|1
condition|)
block|{
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|s
operator|->
name|id
argument_list|)
expr_stmt|;
name|save_config
operator|=
literal|1
expr_stmt|;
continue|continue;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|s
operator|->
name|num_p2p_clients
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|peer
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|os_memmove
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|s
operator|->
name|p2p_client_list
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
operator|(
name|s
operator|->
name|num_p2p_clients
operator|-
name|i
operator|-
literal|1
operator|)
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
break|break;
block|}
name|s
operator|->
name|num_p2p_clients
operator|--
expr_stmt|;
name|save_config
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|save_config
condition|)
name|p2p_config_write
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
comment|/* Return TRUE if valid SSID remains */
return|return
name|s
operator|!=
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2ps_prov_complete
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|u8
name|status
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev
parameter_list|,
specifier|const
name|u8
modifier|*
name|adv_mac
parameter_list|,
specifier|const
name|u8
modifier|*
name|ses_mac
parameter_list|,
specifier|const
name|u8
modifier|*
name|grp_mac
parameter_list|,
name|u32
name|adv_id
parameter_list|,
name|u32
name|ses_id
parameter_list|,
name|u8
name|conncap
parameter_list|,
name|int
name|passwd_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|persist_ssid
parameter_list|,
name|size_t
name|persist_ssid_size
parameter_list|,
name|int
name|response_done
parameter_list|,
name|int
name|prov_start
parameter_list|,
specifier|const
name|char
modifier|*
name|session_info
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|u8
name|mac
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|persistent_go
decl_stmt|,
modifier|*
name|stale
decl_stmt|,
modifier|*
name|s
decl_stmt|;
name|int
name|save_config
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|go_wpa_s
decl_stmt|;
if|if
condition|(
operator|!
name|dev
condition|)
return|return;
name|os_memset
argument_list|(
name|mac
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|adv_mac
condition|)
name|adv_mac
operator|=
name|mac
expr_stmt|;
if|if
condition|(
operator|!
name|ses_mac
condition|)
name|ses_mac
operator|=
name|mac
expr_stmt|;
if|if
condition|(
operator|!
name|grp_mac
condition|)
name|grp_mac
operator|=
name|mac
expr_stmt|;
if|if
condition|(
name|prov_start
condition|)
block|{
if|if
condition|(
name|session_info
operator|==
name|NULL
condition|)
block|{
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_P2PS_PROVISION_START MACSTR
literal|" adv_id=%x conncap=%x"
literal|" adv_mac="
argument|MACSTR
literal|" session=%x mac="
argument|MACSTR
literal|" dev_passwd_id=%d"
argument_list|,
argument|MAC2STR(dev)
argument_list|,
argument|adv_id
argument_list|,
argument|conncap
argument_list|,
argument|MAC2STR(adv_mac)
argument_list|,
argument|ses_id
argument_list|,
argument|MAC2STR(ses_mac)
argument_list|,
argument|passwd_id
argument_list|)
empty_stmt|;
block|}
else|else
block|{
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_P2PS_PROVISION_START MACSTR
literal|" adv_id=%x conncap=%x"
literal|" adv_mac="
argument|MACSTR
literal|" session=%x mac="
argument|MACSTR
literal|" dev_passwd_id=%d info='%s'"
argument_list|,
argument|MAC2STR(dev)
argument_list|,
argument|adv_id
argument_list|,
argument|conncap
argument_list|,
argument|MAC2STR(adv_mac)
argument_list|,
argument|ses_id
argument_list|,
argument|MAC2STR(ses_mac)
argument_list|,
argument|passwd_id
argument_list|,
argument|session_info
argument_list|)
empty_stmt|;
block|}
return|return;
block|}
name|go_wpa_s
operator|=
name|wpas_p2p_get_go_group
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|persistent_go
operator|=
name|wpas_p2p_get_persistent_go
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|&&
name|status
operator|!=
name|P2P_SC_SUCCESS_DEFERRED
condition|)
block|{
if|if
condition|(
name|go_wpa_s
operator|&&
operator|!
name|p2p_group_go_member_count
argument_list|(
name|wpa_s
argument_list|)
condition|)
name|wpas_p2p_group_remove
argument_list|(
name|wpa_s
argument_list|,
name|go_wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|persistent_go
operator|&&
operator|!
name|persistent_go
operator|->
name|num_p2p_clients
condition|)
block|{
comment|/* remove empty persistent GO */
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|persistent_go
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_P2PS_PROVISION_DONE MACSTR
literal|" status=%d"
literal|" adv_id=%x adv_mac="
argument|MACSTR
literal|" session=%x mac="
argument|MACSTR
argument_list|,
argument|MAC2STR(dev)
argument_list|,
argument|status
argument_list|,
argument|adv_id
argument_list|,
argument|MAC2STR(adv_mac)
argument_list|,
argument|ses_id
argument_list|,
argument|MAC2STR(ses_mac)
argument_list|)
empty_stmt|;
return|return;
block|}
comment|/* Clean up stale persistent groups with this device */
name|s
operator|=
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
argument_list|,
name|dev
argument_list|,
name|persist_ssid
argument_list|,
name|persist_ssid_size
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|stale
operator|=
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
argument_list|,
name|dev
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|stale
condition|)
break|break;
if|if
condition|(
name|s
operator|&&
name|s
operator|->
name|ssid_len
operator|==
name|stale
operator|->
name|ssid_len
operator|&&
name|os_memcmp
argument_list|(
name|stale
operator|->
name|bssid
argument_list|,
name|s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|stale
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|s
operator|->
name|ssid_len
argument_list|)
operator|==
literal|0
condition|)
break|break;
comment|/* Remove stale persistent group */
if|if
condition|(
name|stale
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|||
name|stale
operator|->
name|num_p2p_clients
operator|<=
literal|1
condition|)
block|{
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|stale
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|stale
operator|->
name|num_p2p_clients
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|stale
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
name|ETH_ALEN
argument_list|,
name|dev
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_memmove
argument_list|(
name|stale
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
name|ETH_ALEN
argument_list|,
name|stale
operator|->
name|p2p_client_list
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
operator|*
name|ETH_ALEN
argument_list|,
operator|(
name|stale
operator|->
name|num_p2p_clients
operator|-
name|i
operator|-
literal|1
operator|)
operator|*
name|ETH_ALEN
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|stale
operator|->
name|num_p2p_clients
operator|--
expr_stmt|;
block|}
name|save_config
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|save_config
condition|)
name|p2p_config_write
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
condition|)
block|{
if|if
condition|(
name|go_wpa_s
operator|&&
operator|!
name|p2p_group_go_member_count
argument_list|(
name|wpa_s
argument_list|)
condition|)
name|wpas_p2p_group_remove
argument_list|(
name|wpa_s
argument_list|,
name|go_wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|persistent_go
operator|&&
name|s
operator|!=
name|persistent_go
operator|&&
operator|!
name|persistent_go
operator|->
name|num_p2p_clients
condition|)
block|{
comment|/* remove empty persistent GO */
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|persistent_go
operator|->
name|id
argument_list|)
expr_stmt|;
comment|/* Save config */
block|}
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_P2PS_PROVISION_DONE MACSTR
literal|" status=%d"
literal|" adv_id=%x adv_mac="
argument|MACSTR
literal|" session=%x mac="
argument|MACSTR
literal|" persist=%d"
argument_list|,
argument|MAC2STR(dev)
argument_list|,
argument|status
argument_list|,
argument|adv_id
argument_list|,
argument|MAC2STR(adv_mac)
argument_list|,
argument|ses_id
argument_list|,
argument|MAC2STR(ses_mac)
argument_list|,
argument|s->id
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|conncap
operator|==
name|P2PS_SETUP_GROUP_OWNER
condition|)
block|{
specifier|const
name|char
modifier|*
name|go_ifname
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|go_wpa_s
condition|)
block|{
name|wpa_s
operator|->
name|global
operator|->
name|pending_p2ps_group
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_no_group_iface
condition|)
name|go_ifname
operator|=
name|wpa_s
operator|->
name|ifname
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
condition|)
name|go_ifname
operator|=
name|wpa_s
operator|->
name|pending_interface_name
expr_stmt|;
if|if
condition|(
operator|!
name|go_ifname
condition|)
block|{
name|wpas_p2ps_prov_complete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_SC_FAIL_UNKNOWN_GROUP
argument_list|,
name|dev
argument_list|,
name|adv_mac
argument_list|,
name|ses_mac
argument_list|,
name|NULL
argument_list|,
name|adv_id
argument_list|,
name|ses_id
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* If PD Resp complete, start up the GO */
if|if
condition|(
name|response_done
operator|&&
name|persistent_go
condition|)
block|{
name|wpas_p2p_group_add_persistent
argument_list|(
name|wpa_s
argument_list|,
name|persistent_go
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|persistent_go
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|?
name|P2P_MAX_INITIAL_CONN_WAIT_GO_REINVOKE
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|response_done
condition|)
block|{
name|wpas_p2p_group_add
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|passwd_id
operator|==
name|DEV_PW_P2PS_DEFAULT
condition|)
block|{
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|p2ps_join_addr
argument_list|,
name|dev
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2ps_join_addr_valid
operator|=
literal|1
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2PS: Saving PIN for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|passwd_id
operator|==
name|DEV_PW_P2PS_DEFAULT
condition|)
block|{
name|go_ifname
operator|=
name|go_wpa_s
operator|->
name|ifname
expr_stmt|;
name|wpa_dbg
argument_list|(
name|go_wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Setting PIN-1 For "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_supplicant_ap_wps_pin
argument_list|(
name|go_wpa_s
argument_list|,
name|dev
argument_list|,
literal|"12345670"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|p2ps_join_addr
argument_list|,
name|dev
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2ps_join_addr_valid
operator|=
literal|1
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2PS: Saving PIN for "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|dev
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_P2PS_PROVISION_DONE MACSTR
literal|" status=%d conncap=%x"
literal|" adv_id=%x adv_mac="
argument|MACSTR
literal|" session=%x mac="
argument|MACSTR
literal|" dev_passwd_id=%d go=%s"
argument_list|,
argument|MAC2STR(dev)
argument_list|,
argument|status
argument_list|,
argument|conncap
argument_list|,
argument|adv_id
argument_list|,
argument|MAC2STR(adv_mac)
argument_list|,
argument|ses_id
argument_list|,
argument|MAC2STR(ses_mac)
argument_list|,
argument|passwd_id
argument_list|,
argument|go_ifname
argument_list|)
empty_stmt|;
return|return;
block|}
if|if
condition|(
name|go_wpa_s
operator|&&
operator|!
name|p2p_group_go_member_count
argument_list|(
name|wpa_s
argument_list|)
condition|)
name|wpas_p2p_group_remove
argument_list|(
name|wpa_s
argument_list|,
name|go_wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|persistent_go
operator|&&
operator|!
name|persistent_go
operator|->
name|num_p2p_clients
condition|)
block|{
comment|/* remove empty persistent GO */
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|persistent_go
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|conncap
operator|==
name|P2PS_SETUP_CLIENT
condition|)
block|{
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_P2PS_PROVISION_DONE MACSTR
literal|" status=%d conncap=%x"
literal|" adv_id=%x adv_mac="
argument|MACSTR
literal|" session=%x mac="
argument|MACSTR
literal|" dev_passwd_id=%d join="
argument|MACSTR
argument_list|,
argument|MAC2STR(dev)
argument_list|,
argument|status
argument_list|,
argument|conncap
argument_list|,
argument|adv_id
argument_list|,
argument|MAC2STR(adv_mac)
argument_list|,
argument|ses_id
argument_list|,
argument|MAC2STR(ses_mac)
argument_list|,
argument|passwd_id
argument_list|,
argument|MAC2STR(grp_mac)
argument_list|)
empty_stmt|;
block|}
else|else
block|{
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_P2PS_PROVISION_DONE MACSTR
literal|" status=%d conncap=%x"
literal|" adv_id=%x adv_mac="
argument|MACSTR
literal|" session=%x mac="
argument|MACSTR
literal|" dev_passwd_id=%d"
argument_list|,
argument|MAC2STR(dev)
argument_list|,
argument|status
argument_list|,
argument|conncap
argument_list|,
argument|adv_id
argument_list|,
argument|MAC2STR(adv_mac)
argument_list|,
argument|ses_id
argument_list|,
argument|MAC2STR(ses_mac)
argument_list|,
argument|passwd_id
argument_list|)
empty_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|_wpas_p2p_in_progress
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
return|return
name|wpas_p2p_in_progress
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_prov_disc_resp_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|persistent_go
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|pending_p2ps_group
condition|)
return|return
literal|0
return|;
name|wpa_s
operator|->
name|global
operator|->
name|pending_p2ps_group
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpas_p2p_get_go_group
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return
literal|0
return|;
name|persistent_go
operator|=
name|wpas_p2p_get_persistent_go
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|persistent_go
condition|)
block|{
name|wpas_p2p_group_add_persistent
argument_list|(
name|wpa_s
argument_list|,
name|persistent_go
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|persistent_go
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|?
name|P2P_MAX_INITIAL_CONN_WAIT_GO_REINVOKE
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpas_p2p_group_add
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_init - Initialize P2P module for %wpa_supplicant  * @global: Pointer to global data from wpa_supplicant_init()  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * Returns: 0 on success, -1 on failure  */
end_comment

begin_function
name|int
name|wpas_p2p_init
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|p2p_config
name|p2p
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_disabled
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_CAPABLE
operator|)
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|global
operator|->
name|p2p
condition|)
return|return
literal|0
return|;
name|os_memset
argument_list|(
operator|&
name|p2p
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|p2p
argument_list|)
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|cb_ctx
operator|=
name|wpa_s
expr_stmt|;
name|p2p
operator|.
name|debug_print
operator|=
name|wpas_p2p_debug_print
expr_stmt|;
name|p2p
operator|.
name|p2p_scan
operator|=
name|wpas_p2p_scan
expr_stmt|;
name|p2p
operator|.
name|send_action
operator|=
name|wpas_send_action
expr_stmt|;
name|p2p
operator|.
name|send_action_done
operator|=
name|wpas_send_action_done
expr_stmt|;
name|p2p
operator|.
name|go_neg_completed
operator|=
name|wpas_go_neg_completed
expr_stmt|;
name|p2p
operator|.
name|go_neg_req_rx
operator|=
name|wpas_go_neg_req_rx
expr_stmt|;
name|p2p
operator|.
name|dev_found
operator|=
name|wpas_dev_found
expr_stmt|;
name|p2p
operator|.
name|dev_lost
operator|=
name|wpas_dev_lost
expr_stmt|;
name|p2p
operator|.
name|find_stopped
operator|=
name|wpas_find_stopped
expr_stmt|;
name|p2p
operator|.
name|start_listen
operator|=
name|wpas_start_listen
expr_stmt|;
name|p2p
operator|.
name|stop_listen
operator|=
name|wpas_stop_listen
expr_stmt|;
name|p2p
operator|.
name|send_probe_resp
operator|=
name|wpas_send_probe_resp
expr_stmt|;
name|p2p
operator|.
name|sd_request
operator|=
name|wpas_sd_request
expr_stmt|;
name|p2p
operator|.
name|sd_response
operator|=
name|wpas_sd_response
expr_stmt|;
name|p2p
operator|.
name|prov_disc_req
operator|=
name|wpas_prov_disc_req
expr_stmt|;
name|p2p
operator|.
name|prov_disc_resp
operator|=
name|wpas_prov_disc_resp
expr_stmt|;
name|p2p
operator|.
name|prov_disc_fail
operator|=
name|wpas_prov_disc_fail
expr_stmt|;
name|p2p
operator|.
name|invitation_process
operator|=
name|wpas_invitation_process
expr_stmt|;
name|p2p
operator|.
name|invitation_received
operator|=
name|wpas_invitation_received
expr_stmt|;
name|p2p
operator|.
name|invitation_result
operator|=
name|wpas_invitation_result
expr_stmt|;
name|p2p
operator|.
name|get_noa
operator|=
name|wpas_get_noa
expr_stmt|;
name|p2p
operator|.
name|go_connected
operator|=
name|wpas_go_connected
expr_stmt|;
name|p2p
operator|.
name|presence_resp
operator|=
name|wpas_presence_resp
expr_stmt|;
name|p2p
operator|.
name|is_concurrent_session_active
operator|=
name|wpas_is_concurrent_session_active
expr_stmt|;
name|p2p
operator|.
name|is_p2p_in_progress
operator|=
name|_wpas_p2p_in_progress
expr_stmt|;
name|p2p
operator|.
name|get_persistent_group
operator|=
name|wpas_get_persistent_group
expr_stmt|;
name|p2p
operator|.
name|get_go_info
operator|=
name|wpas_get_go_info
expr_stmt|;
name|p2p
operator|.
name|remove_stale_groups
operator|=
name|wpas_remove_stale_groups
expr_stmt|;
name|p2p
operator|.
name|p2ps_prov_complete
operator|=
name|wpas_p2ps_prov_complete
expr_stmt|;
name|p2p
operator|.
name|prov_disc_resp_cb
operator|=
name|wpas_prov_disc_resp_cb
expr_stmt|;
name|p2p
operator|.
name|p2ps_group_capability
operator|=
name|p2ps_group_capability
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|dev_addr
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|dev_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
expr_stmt|;
name|p2p
operator|.
name|manufacturer
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|manufacturer
expr_stmt|;
name|p2p
operator|.
name|model_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|model_name
expr_stmt|;
name|p2p
operator|.
name|model_number
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|model_number
expr_stmt|;
name|p2p
operator|.
name|serial_number
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|serial_number
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps
condition|)
block|{
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|uuid
argument_list|,
name|wpa_s
operator|->
name|wps
operator|->
name|uuid
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|config_methods
operator|=
name|wpa_s
operator|->
name|wps
operator|->
name|config_methods
expr_stmt|;
block|}
if|if
condition|(
name|wpas_p2p_setup_channels
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|p2p
operator|.
name|channels
argument_list|,
operator|&
name|p2p
operator|.
name|cli_channels
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to configure supported channel list"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_reg_class
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_channel
condition|)
block|{
name|p2p
operator|.
name|reg_class
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_reg_class
expr_stmt|;
name|p2p
operator|.
name|channel
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_channel
expr_stmt|;
name|p2p
operator|.
name|channel_forced
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Pick one of the social channels randomly as the listen 		 * channel. 		 */
if|if
condition|(
name|p2p_config_get_random_social
argument_list|(
operator|&
name|p2p
argument_list|,
operator|&
name|p2p
operator|.
name|reg_class
argument_list|,
operator|&
name|p2p
operator|.
name|channel
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to select random social channel as listen channel"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p2p
operator|.
name|channel_forced
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Own listen channel: %d:%d"
argument_list|,
name|p2p
operator|.
name|reg_class
argument_list|,
name|p2p
operator|.
name|channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
condition|)
block|{
name|p2p
operator|.
name|op_reg_class
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
expr_stmt|;
name|p2p
operator|.
name|op_channel
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
expr_stmt|;
name|p2p
operator|.
name|cfg_op_channel
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Configured operating channel: "
literal|"%d:%d"
argument_list|,
name|p2p
operator|.
name|op_reg_class
argument_list|,
name|p2p
operator|.
name|op_channel
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Use random operation channel from 2.4 GHz band social 		 * channels (1, 6, 11) or band 60 GHz social channel (2) if no 		 * other preference is indicated. 		 */
if|if
condition|(
name|p2p_config_get_random_social
argument_list|(
operator|&
name|p2p
argument_list|,
operator|&
name|p2p
operator|.
name|op_reg_class
argument_list|,
operator|&
name|p2p
operator|.
name|op_channel
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to select random social channel as operation channel"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|p2p
operator|.
name|cfg_op_channel
operator|=
literal|0
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Random operating channel: "
literal|"%d:%d"
argument_list|,
name|p2p
operator|.
name|op_reg_class
argument_list|,
name|p2p
operator|.
name|op_channel
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_pref_chan
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|num_p2p_pref_chan
condition|)
block|{
name|p2p
operator|.
name|pref_chan
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_pref_chan
expr_stmt|;
name|p2p
operator|.
name|num_pref_chan
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|num_p2p_pref_chan
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
condition|)
block|{
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|country
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|country
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|country
index|[
literal|2
index|]
operator|=
literal|0x04
expr_stmt|;
block|}
else|else
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|country
argument_list|,
literal|"XX\x04"
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|pri_dev_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|num_sec_dev_types
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|num_sec_device_types
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|sec_dev_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|sec_device_type
argument_list|,
name|p2p
operator|.
name|num_sec_dev_types
operator|*
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|p2p
operator|.
name|concurrent_operations
operator|=
operator|!
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_CONCURRENT
operator|)
expr_stmt|;
name|p2p
operator|.
name|max_peers
operator|=
literal|100
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
condition|)
block|{
name|p2p
operator|.
name|ssid_postfix_len
operator|=
name|os_strlen
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p
operator|.
name|ssid_postfix_len
operator|>
sizeof|sizeof
argument_list|(
name|p2p
operator|.
name|ssid_postfix
argument_list|)
condition|)
name|p2p
operator|.
name|ssid_postfix_len
operator|=
sizeof|sizeof
argument_list|(
name|p2p
operator|.
name|ssid_postfix
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|p2p
operator|.
name|ssid_postfix
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
argument_list|,
name|p2p
operator|.
name|ssid_postfix_len
argument_list|)
expr_stmt|;
block|}
name|p2p
operator|.
name|p2p_intra_bss
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_intra_bss
expr_stmt|;
name|p2p
operator|.
name|max_listen
operator|=
name|wpa_s
operator|->
name|max_remain_on_chan
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_passphrase_len
operator|>=
literal|8
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_passphrase_len
operator|<=
literal|63
condition|)
name|p2p
operator|.
name|passphrase_len
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_passphrase_len
expr_stmt|;
else|else
name|p2p
operator|.
name|passphrase_len
operator|=
literal|8
expr_stmt|;
name|global
operator|->
name|p2p
operator|=
name|p2p_init
argument_list|(
operator|&
name|p2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|global
operator|->
name|p2p_init_wpa_s
operator|=
name|wpa_s
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_WPS_VENDOR_EXT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|p2p_add_wps_vendor_extension
argument_list|(
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|p2p_set_no_go_freq
argument_list|(
name|global
operator|->
name|p2p
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_no_go_freq
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_deinit - Deinitialize per-interface P2P data  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  *  * This function deinitialize per-interface P2P data.  */
end_comment

begin_function
name|void
name|wpas_p2p_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|driver
operator|&&
name|wpa_s
operator|->
name|drv_priv
condition|)
name|wpa_drv_probe_req_report
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|go_params
condition|)
block|{
comment|/* Clear any stored provisioning info */
name|p2p_clear_provisioning_info
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|go_params
operator|->
name|peer_device_addr
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wpa_s
operator|->
name|go_params
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|go_params
operator|=
name|NULL
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_psk_failure_removal
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_freq_conflict
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_p2p_listen_work_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_send_action_work
condition|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|p2p_send_action_work
operator|->
name|ctx
argument_list|)
expr_stmt|;
name|radio_work_done
argument_list|(
name|wpa_s
operator|->
name|p2p_send_action_work
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_send_action_work
operator|=
name|NULL
expr_stmt|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_send_action_work_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|p2p_oob_dev_pw
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_oob_dev_pw
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|p2p_group_common_freqs
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group_common_freqs
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group_common_freqs_num
operator|=
literal|0
expr_stmt|;
comment|/* TODO: remove group interface from the driver if this wpa_s instance 	 * is on top of a P2P group interface */
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_deinit_global - Deinitialize global P2P module  * @global: Pointer to global data from wpa_supplicant_init()  *  * This function deinitializes the global (per device) P2P module.  */
end_comment

begin_function
specifier|static
name|void
name|wpas_p2p_deinit_global
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
name|wpas_p2p_service_flush
argument_list|(
name|global
operator|->
name|p2p_init_wpa_s
argument_list|)
expr_stmt|;
comment|/* Remove remaining P2P group interfaces */
while|while
condition|(
name|wpa_s
operator|&&
name|wpa_s
operator|->
name|p2p_group_interface
operator|!=
name|NOT_P2P_GROUP_INTERFACE
condition|)
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
while|while
condition|(
name|wpa_s
condition|)
block|{
name|tmp
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
while|while
condition|(
name|tmp
operator|&&
operator|(
name|tmp
operator|==
name|wpa_s
operator|||
name|tmp
operator|->
name|p2p_group_interface
operator|==
name|NOT_P2P_GROUP_INTERFACE
operator|)
condition|)
block|{
name|tmp
operator|=
name|tmp
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
break|break;
comment|/* Disconnect from the P2P group and deinit the interface */
name|wpas_p2p_disconnect
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Deinit GO data on any possibly remaining interface (if main 	 * interface is used as GO). 	 */
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
name|wpas_p2p_group_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
name|p2p_deinit
argument_list|(
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|global
operator|->
name|p2p
operator|=
name|NULL
expr_stmt|;
name|global
operator|->
name|p2p_init_wpa_s
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_create_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_DEDICATED_P2P_DEVICE
operator|)
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_no_group_iface
condition|)
return|return
literal|0
return|;
comment|/* separate interface disabled per configuration */
if|if
condition|(
name|wpa_s
operator|->
name|drv_flags
operator|&
operator|(
name|WPA_DRIVER_FLAGS_P2P_DEDICATED_INTERFACE
operator||
name|WPA_DRIVER_FLAGS_P2P_MGMT_AND_NON_P2P
operator|)
condition|)
return|return
literal|1
return|;
comment|/* P2P group requires a new interface in every case 			   */
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_CONCURRENT
operator|)
condition|)
return|return
literal|0
return|;
comment|/* driver does not support concurrent operations */
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
operator|->
name|next
condition|)
return|return
literal|1
return|;
comment|/* more that one interface already in use */
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_AUTHENTICATING
condition|)
return|return
literal|1
return|;
comment|/* this interface is already in use */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_start_go_neg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|,
name|int
name|go_intent
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_interface_addr
parameter_list|,
name|unsigned
name|int
name|force_freq
parameter_list|,
name|int
name|persistent_group
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|unsigned
name|int
name|pref_freq
parameter_list|)
block|{
if|if
condition|(
name|persistent_group
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|persistent_reconnect
condition|)
name|persistent_group
operator|=
literal|2
expr_stmt|;
comment|/* 	 * Increase GO config timeout if HT40 is used since it takes some time 	 * to scan channels for coex purposes before the BSS can be started. 	 */
name|p2p_set_config_timeout
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|p2p_go_ht40
condition|?
literal|255
else|:
literal|100
argument_list|,
literal|20
argument_list|)
expr_stmt|;
return|return
name|p2p_connect
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|wps_method
argument_list|,
name|go_intent
argument_list|,
name|own_interface_addr
argument_list|,
name|force_freq
argument_list|,
name|persistent_group
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid
else|:
name|NULL
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid_len
else|:
literal|0
argument_list|,
name|wpa_s
operator|->
name|p2p_pd_before_go_neg
argument_list|,
name|pref_freq
argument_list|,
name|wps_method
operator|==
name|WPS_NFC
condition|?
name|wpa_s
operator|->
name|p2p_oob_dev_pw_id
else|:
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_auth_go_neg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|,
name|int
name|go_intent
parameter_list|,
specifier|const
name|u8
modifier|*
name|own_interface_addr
parameter_list|,
name|unsigned
name|int
name|force_freq
parameter_list|,
name|int
name|persistent_group
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|unsigned
name|int
name|pref_freq
parameter_list|)
block|{
if|if
condition|(
name|persistent_group
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|persistent_reconnect
condition|)
name|persistent_group
operator|=
literal|2
expr_stmt|;
return|return
name|p2p_authorize
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|wps_method
argument_list|,
name|go_intent
argument_list|,
name|own_interface_addr
argument_list|,
name|force_freq
argument_list|,
name|persistent_group
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid
else|:
name|NULL
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid_len
else|:
literal|0
argument_list|,
name|pref_freq
argument_list|,
name|wps_method
operator|==
name|WPS_NFC
condition|?
name|wpa_s
operator|->
name|p2p_oob_dev_pw_id
else|:
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_check_join_scan_limit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|p2p_join_scan_count
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Join scan attempt %d"
argument_list|,
name|wpa_s
operator|->
name|p2p_join_scan_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_join_scan_count
operator|>
name|P2P_MAX_JOIN_SCAN_ATTEMPTS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to find GO "
name|MACSTR
literal|" for join operationg - stop join attempt"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_auto_pd
condition|)
block|{
name|wpa_s
operator|->
name|p2p_auto_pd
operator|=
literal|0
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_PROV_DISC_FAILURE
literal|" p2p_dev_addr="
name|MACSTR
literal|" status=N/A"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_FORMATION_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_check_freq_conflict
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|unsigned
name|int
name|num
decl_stmt|,
name|i
decl_stmt|;
name|struct
name|wpa_used_freq_data
modifier|*
name|freqs
decl_stmt|;
if|if
condition|(
name|wpas_p2p_num_unused_channels
argument_list|(
name|wpa_s
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/* Multiple channels are supported and not all are in use */
return|return
literal|0
return|;
block|}
name|freqs
operator|=
name|os_calloc
argument_list|(
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_used_freq_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|freqs
condition|)
return|return
literal|1
return|;
name|num
operator|=
name|wpas_p2p_valid_oper_freqs
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|freqs
index|[
name|i
index|]
operator|.
name|freq
operator|==
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Frequency %d MHz in use by another virtual interface and can be used"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|res
operator|=
literal|0
expr_stmt|;
goto|goto
name|exit_free
goto|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No valid operating frequencies"
argument_list|)
expr_stmt|;
name|res
operator|=
literal|1
expr_stmt|;
name|exit_free
label|:
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_peer_go
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_dev_addr
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|updated
decl_stmt|;
name|bss
operator|=
name|wpa_bss_get_p2p_dev_addr
argument_list|(
name|wpa_s
argument_list|,
name|peer_dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bss
operator|->
name|last_update_idx
operator|<
name|wpa_s
operator|->
name|bss_update_idx
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer BSS entry not updated in the "
literal|"last scan"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|updated
operator|=
name|os_reltime_before
argument_list|(
operator|&
name|wpa_s
operator|->
name|p2p_auto_started
argument_list|,
operator|&
name|bss
operator|->
name|last_update
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Current BSS entry for peer updated at "
literal|"%ld.%06ld (%supdated in last scan)"
argument_list|,
name|bss
operator|->
name|last_update
operator|.
name|sec
argument_list|,
name|bss
operator|->
name|last_update
operator|.
name|usec
argument_list|,
name|updated
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
return|return
name|updated
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_scan_res_join
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
init|=
name|NULL
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|u8
name|iface_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Scan results received (%d BSS) for %sjoin"
argument_list|,
name|scan_res
condition|?
operator|(
name|int
operator|)
name|scan_res
operator|->
name|num
else|:
operator|-
literal|1
argument_list|,
name|wpa_s
operator|->
name|p2p_auto_join
condition|?
literal|"auto_"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|scan_res
condition|)
name|wpas_p2p_scan_res_handler
argument_list|(
name|wpa_s
argument_list|,
name|scan_res
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_auto_pd
condition|)
block|{
name|int
name|join
init|=
name|wpas_p2p_peer_go
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|join
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|auto_pd_scan_retry
operator|<
name|P2P_AUTO_PD_SCAN_ATTEMPTS
condition|)
block|{
name|wpa_s
operator|->
name|auto_pd_scan_retry
operator|++
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get_bssid_latest
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Scan retry %d for "
literal|"the peer "
name|MACSTR
literal|" at %d MHz"
argument_list|,
name|wpa_s
operator|->
name|auto_pd_scan_retry
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|wpas_p2p_join_scan_req
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
name|join
operator|<
literal|0
condition|)
name|join
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_auto_pd
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_use
operator|=
name|join
condition|?
name|AUTO_PD_JOIN
else|:
name|AUTO_PD_GO_NEG
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Auto PD with "
name|MACSTR
literal|" join=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|,
name|join
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_prov_disc_req
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|NULL
argument_list|,
name|wpa_s
operator|->
name|pending_pd_config_methods
argument_list|,
name|join
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|user_initiated_pd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|p2p_auto_pd
operator|=
literal|0
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_PROV_DISC_FAILURE
literal|" p2p_dev_addr="
name|MACSTR
literal|" status=N/A"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_auto_join
condition|)
block|{
name|int
name|join
init|=
name|wpas_p2p_peer_go
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|join
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer was not found to be "
literal|"running a GO -> use GO Negotiation"
argument_list|)
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_FALLBACK_TO_GO_NEG
literal|"reason=peer-not-running-GO"
argument_list|)
expr_stmt|;
name|wpas_p2p_connect
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
name|wpa_s
operator|->
name|p2p_wps_method
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_group
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|p2p_go_intent
argument_list|,
name|wpa_s
operator|->
name|p2p_connect_freq
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_id
argument_list|,
name|wpa_s
operator|->
name|p2p_pd_before_go_neg
argument_list|,
name|wpa_s
operator|->
name|p2p_go_ht40
argument_list|,
name|wpa_s
operator|->
name|p2p_go_vht
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer was found running GO%s -> "
literal|"try to join the group"
argument_list|,
name|join
condition|?
literal|""
else|:
literal|" in older scan"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|join
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_FALLBACK_TO_GO_NEG_ENABLED
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
operator|=
literal|1
expr_stmt|;
block|}
block|}
name|freq
operator|=
name|p2p_get_oper_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|<
literal|0
operator|&&
name|p2p_get_interface_addr
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|iface_addr
argument_list|)
operator|==
literal|0
operator|&&
name|os_memcmp
argument_list|(
name|iface_addr
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
operator|&&
operator|!
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Overwrite pending interface "
literal|"address for join from "
name|MACSTR
literal|" to "
name|MACSTR
literal|" based on newly discovered P2P peer entry"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|iface_addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|iface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|freq
operator|=
name|p2p_get_oper_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|freq
operator|>=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Target GO operating frequency "
literal|"from P2P peer table: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_join_ssid_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Trying to find target GO BSS entry based on BSSID "
name|MACSTR
literal|" and SSID %s"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|wpa_s
operator|->
name|p2p_join_ssid
argument_list|,
name|wpa_s
operator|->
name|p2p_join_ssid_len
argument_list|)
argument_list|)
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_join_ssid
argument_list|,
name|wpa_s
operator|->
name|p2p_join_ssid_len
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|bss
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Trying to find target GO BSS entry based on BSSID "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
argument_list|)
expr_stmt|;
name|bss
operator|=
name|wpa_bss_get_bssid_latest
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bss
condition|)
block|{
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Target GO operating frequency "
literal|"from BSS table: %d MHz (SSID %s)"
argument_list|,
name|freq
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|freq
operator|>
literal|0
condition|)
block|{
name|u16
name|method
decl_stmt|;
if|if
condition|(
name|wpas_check_freq_conflict
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_GROUP_FORMATION_FAILURE
literal|"reason=FREQ_CONFLICT"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Send Provision Discovery Request "
literal|"prior to joining an existing group (GO "
name|MACSTR
literal|" freq=%u MHz)"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|wpa_s
operator|->
name|pending_join_wps_method
condition|)
block|{
case|case
name|WPS_PIN_DISPLAY
case|:
name|method
operator|=
name|WPS_CONFIG_KEYPAD
expr_stmt|;
break|break;
case|case
name|WPS_PIN_KEYPAD
case|:
name|method
operator|=
name|WPS_CONFIG_DISPLAY
expr_stmt|;
break|break;
case|case
name|WPS_PBC
case|:
name|method
operator|=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
break|break;
default|default:
name|method
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|p2p_get_provisioning_info
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
operator|==
name|method
operator|)
condition|)
block|{
comment|/* 			 * We have already performed provision discovery for 			 * joining the group. Proceed directly to join 			 * operation without duplicated provision discovery. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Provision discovery "
literal|"with "
name|MACSTR
literal|" already done - proceed to "
literal|"join"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
goto|goto
name|start
goto|;
block|}
if|if
condition|(
name|p2p_prov_disc_req
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|NULL
argument_list|,
name|method
argument_list|,
literal|1
argument_list|,
name|freq
argument_list|,
name|wpa_s
operator|->
name|user_initiated_pd
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to send Provision "
literal|"Discovery Request before joining an "
literal|"existing group"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
goto|goto
name|start
goto|;
block|}
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to find BSS/GO - try again later"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_p2p_check_join_scan_limit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
name|start
label|:
comment|/* Start join operation immediately */
name|wpas_p2p_join_start
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_join_scan_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|struct
name|wpa_driver_scan_params
name|params
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|,
modifier|*
name|ies
decl_stmt|;
name|size_t
name|ielen
decl_stmt|;
name|int
name|freqs
index|[
literal|2
index|]
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
comment|/* P2P Wildcard SSID */
name|params
operator|.
name|num_ssids
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid_len
condition|)
block|{
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
operator|=
name|ssid
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
operator|=
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|p2p_join_ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_join_ssid_len
operator|=
name|ssid_len
expr_stmt|;
block|}
else|else
block|{
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid
operator|=
operator|(
name|u8
operator|*
operator|)
name|P2P_WILDCARD_SSID
expr_stmt|;
name|params
operator|.
name|ssids
index|[
literal|0
index|]
operator|.
name|ssid_len
operator|=
name|P2P_WILDCARD_SSID_LEN
expr_stmt|;
name|wpa_s
operator|->
name|p2p_join_ssid_len
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_s
operator|->
name|wps
operator|->
name|dev
operator|.
name|p2p
operator|=
literal|1
expr_stmt|;
name|wps_ie
operator|=
name|wps_build_probe_req_ie
argument_list|(
name|DEV_PW_DEFAULT
argument_list|,
operator|&
name|wpa_s
operator|->
name|wps
operator|->
name|dev
argument_list|,
name|wpa_s
operator|->
name|wps
operator|->
name|uuid
argument_list|,
name|WPS_REQ_ENROLLEE
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|==
name|NULL
condition|)
block|{
name|wpas_p2p_scan_res_join
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
name|ielen
operator|=
name|p2p_scan_ie_buf_len
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|ies
operator|=
name|wpabuf_alloc
argument_list|(
name|wpabuf_len
argument_list|(
name|wps_ie
argument_list|)
operator|+
name|ielen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ies
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|wpas_p2p_scan_res_join
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpabuf_put_buf
argument_list|(
name|ies
argument_list|,
name|wps_ie
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|p2p_scan_ie
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|ies
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|params
operator|.
name|p2p_probe
operator|=
literal|1
expr_stmt|;
name|params
operator|.
name|extra_ies
operator|=
name|wpabuf_head
argument_list|(
name|ies
argument_list|)
expr_stmt|;
name|params
operator|.
name|extra_ies_len
operator|=
name|wpabuf_len
argument_list|(
name|ies
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|freq
condition|)
block|{
name|int
name|oper_freq
decl_stmt|;
comment|/* 		 * If freq is not provided, check the operating freq of the GO 		 * and use a single channel scan on if possible. 		 */
name|oper_freq
operator|=
name|p2p_get_oper_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|oper_freq
operator|>
literal|0
condition|)
name|freq
operator|=
name|oper_freq
expr_stmt|;
block|}
if|if
condition|(
name|freq
operator|>
literal|0
condition|)
block|{
name|freqs
index|[
literal|0
index|]
operator|=
name|freq
expr_stmt|;
name|params
operator|.
name|freqs
operator|=
name|freqs
expr_stmt|;
block|}
comment|/* 	 * Run a scan to update BSS table and start Provision Discovery once 	 * the new scan results become available. 	 */
name|ret
operator|=
name|wpa_drv_scan
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|os_get_reltime
argument_list|(
operator|&
name|wpa_s
operator|->
name|scan_trigger_time
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_res_handler
operator|=
name|wpas_p2p_scan_res_join
expr_stmt|;
name|wpa_s
operator|->
name|own_scan_requested
operator|=
literal|1
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|ies
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to start scan for join - "
literal|"try again later"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_p2p_check_join_scan_limit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_join_scan
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpas_p2p_join_scan_req
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_join
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|iface_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|,
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|,
name|int
name|auto_join
parameter_list|,
name|int
name|op_freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Request to join existing group (iface "
name|MACSTR
literal|" dev "
name|MACSTR
literal|" op_freq=%d)%s"
argument_list|,
name|MAC2STR
argument_list|(
name|iface_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|dev_addr
argument_list|)
argument_list|,
name|op_freq
argument_list|,
name|auto_join
condition|?
literal|" (auto_join)"
else|:
literal|""
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Group SSID specified: %s"
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|ssid
argument_list|,
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|p2p_auto_pd
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_auto_join
operator|=
operator|!
operator|!
name|auto_join
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|iface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_join_wps_method
operator|=
name|wps_method
expr_stmt|;
comment|/* Make sure we are not running find during connection establishment */
name|wpas_p2p_stop_find
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_join_scan_count
operator|=
literal|0
expr_stmt|;
name|wpas_p2p_join_scan_req
argument_list|(
name|wpa_s
argument_list|,
name|op_freq
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_join_start
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|group
decl_stmt|;
name|struct
name|p2p_go_neg_results
name|res
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|group
operator|=
name|wpas_p2p_get_group_iface
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|group
operator|!=
name|wpa_s
condition|)
block|{
name|os_memcpy
argument_list|(
name|group
operator|->
name|p2p_pin
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
sizeof|sizeof
argument_list|(
name|group
operator|->
name|p2p_pin
argument_list|)
argument_list|)
expr_stmt|;
name|group
operator|->
name|p2p_wps_method
operator|=
name|wpa_s
operator|->
name|p2p_wps_method
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * Need to mark the current interface for p2p_group_formation 		 * when a separate group interface is not used. This is needed 		 * to allow p2p_cancel stop a pending p2p_connect-join. 		 * wpas_p2p_init_group_interface() addresses this for the case 		 * where a separate group interface is used. 		 */
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|wpa_s
expr_stmt|;
block|}
name|group
operator|->
name|p2p_in_provisioning
operator|=
literal|1
expr_stmt|;
name|group
operator|->
name|p2p_fallback_to_go_neg
operator|=
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|res
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|res
operator|.
name|peer_device_addr
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|res
operator|.
name|peer_interface_addr
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|res
operator|.
name|wps_method
operator|=
name|wpa_s
operator|->
name|pending_join_wps_method
expr_stmt|;
if|if
condition|(
name|freq
operator|&&
name|ssid
operator|&&
name|ssid_len
condition|)
block|{
name|res
operator|.
name|freq
operator|=
name|freq
expr_stmt|;
name|res
operator|.
name|ssid_len
operator|=
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|res
operator|.
name|ssid
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bss
operator|=
name|wpa_bss_get_bssid_latest
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|res
operator|.
name|freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
name|res
operator|.
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|res
operator|.
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Join target GO operating frequency from BSS table: %d MHz (SSID %s)"
argument_list|,
name|bss
operator|->
name|freq
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|||
name|wpa_s
operator|->
name|roc_waiting_drv_freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancel remain-on-channel prior to "
literal|"starting client"
argument_list|)
expr_stmt|;
name|wpa_drv_cancel_remain_on_channel
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|off_channel_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|roc_waiting_drv_freq
operator|=
literal|0
expr_stmt|;
block|}
name|wpas_start_wps_enrollee
argument_list|(
name|group
argument_list|,
operator|&
name|res
argument_list|)
expr_stmt|;
comment|/* 	 * Allow a longer timeout for join-a-running-group than normal 15 	 * second group formation timeout since the GO may not have authorized 	 * our connection yet. 	 */
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|60
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_setup_freqs
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
modifier|*
name|force_freq
parameter_list|,
name|int
modifier|*
name|pref_freq
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|wpa_used_freq_data
modifier|*
name|freqs
decl_stmt|;
name|int
name|res
decl_stmt|,
name|best_freq
decl_stmt|,
name|num_unused
decl_stmt|;
name|unsigned
name|int
name|freq_in_use
init|=
literal|0
decl_stmt|,
name|num
decl_stmt|,
name|i
decl_stmt|;
name|freqs
operator|=
name|os_calloc
argument_list|(
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_used_freq_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|freqs
condition|)
return|return
operator|-
literal|1
return|;
name|num
operator|=
name|wpas_p2p_valid_oper_freqs
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|)
expr_stmt|;
comment|/* 	 * It is possible that the total number of used frequencies is bigger 	 * than the number of frequencies used for P2P, so get the system wide 	 * number of unused frequencies. 	 */
name|num_unused
operator|=
name|wpas_p2p_num_unused_channels
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Setup freqs: freq=%d num_MCC=%d shared_freqs=%u num_unused=%d"
argument_list|,
name|freq
argument_list|,
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|,
name|num
argument_list|,
name|num_unused
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|>
literal|0
condition|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|go
condition|)
name|ret
operator|=
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|p2p_supported_freq_cli
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_DFS_OFFLOAD
operator|)
operator|&&
name|ieee80211_is_dfs
argument_list|(
name|freq
argument_list|)
condition|)
block|{
comment|/* 				 * If freq is a DFS channel and DFS is offloaded 				 * to the driver, allow P2P GO to use it. 				 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: The forced channel for GO (%u MHz) is DFS, and DFS is offloaded to the driver"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: The forced channel (%u MHz) is not supported for P2P uses"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|res
operator|=
operator|-
literal|3
expr_stmt|;
goto|goto
name|exit_free
goto|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|freqs
index|[
name|i
index|]
operator|.
name|freq
operator|==
name|freq
condition|)
name|freq_in_use
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|num_unused
operator|<=
literal|0
operator|&&
operator|!
name|freq_in_use
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cannot start P2P group on %u MHz as there are no available channels"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|res
operator|=
operator|-
literal|2
expr_stmt|;
goto|goto
name|exit_free
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Trying to force us to use the "
literal|"requested channel (%u MHz)"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
operator|*
name|force_freq
operator|=
name|freq
expr_stmt|;
goto|goto
name|exit_ok
goto|;
block|}
name|best_freq
operator|=
name|wpas_p2p_pick_best_used_freq
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|num
argument_list|)
expr_stmt|;
comment|/* We have a candidate frequency to use */
if|if
condition|(
name|best_freq
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|pref_freq
operator|==
literal|0
operator|&&
name|num_unused
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Try to prefer a frequency (%u MHz) we are already using"
argument_list|,
name|best_freq
argument_list|)
expr_stmt|;
operator|*
name|pref_freq
operator|=
name|best_freq
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Try to force us to use frequency (%u MHz) which is already in use"
argument_list|,
name|best_freq
argument_list|)
expr_stmt|;
operator|*
name|force_freq
operator|=
name|best_freq
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|num_unused
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Current operating channels are not available for P2P. Try to use another channel"
argument_list|)
expr_stmt|;
operator|*
name|force_freq
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: All channels are in use and none of them are P2P enabled. Cannot start P2P group"
argument_list|)
expr_stmt|;
name|res
operator|=
operator|-
literal|2
expr_stmt|;
goto|goto
name|exit_free
goto|;
block|}
name|exit_ok
label|:
name|res
operator|=
literal|0
expr_stmt|;
name|exit_free
label|:
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_connect - Request P2P Group Formation to be started  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * @peer_addr: Address of the peer P2P Device  * @pin: PIN to use during provisioning or %NULL to indicate PBC mode  * @persistent_group: Whether to create a persistent group  * @auto_join: Whether to select join vs. GO Negotiation automatically  * @join: Whether to join an existing group (as a client) instead of starting  *	Group Owner negotiation; @peer_addr is BSSID in that case  * @auth: Whether to only authorize the connection instead of doing that and  *	initiating Group Owner negotiation  * @go_intent: GO Intent or -1 to use default  * @freq: Frequency for the group or 0 for auto-selection  * @persistent_id: Persistent group credentials to use for forcing GO  *	parameters or -1 to generate new values (SSID/passphrase)  * @pd: Whether to send Provision Discovery prior to GO Negotiation as an  *	interoperability workaround when initiating group formation  * @ht40: Start GO with 40 MHz channel width  * @vht:  Start GO with VHT support  * Returns: 0 or new PIN (if pin was %NULL) on success, -1 on unspecified  *	failure, -2 on failure due to channel not currently available,  *	-3 if forced channel is not supported  */
end_comment

begin_function
name|int
name|wpas_p2p_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
name|enum
name|p2p_wps_method
name|wps_method
parameter_list|,
name|int
name|persistent_group
parameter_list|,
name|int
name|auto_join
parameter_list|,
name|int
name|join
parameter_list|,
name|int
name|auth
parameter_list|,
name|int
name|go_intent
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|persistent_id
parameter_list|,
name|int
name|pd
parameter_list|,
name|int
name|ht40
parameter_list|,
name|int
name|vht
parameter_list|)
block|{
name|int
name|force_freq
init|=
literal|0
decl_stmt|,
name|pref_freq
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|res
decl_stmt|;
name|enum
name|wpa_driver_if_type
name|iftype
decl_stmt|;
specifier|const
name|u8
modifier|*
name|if_addr
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|persistent_id
operator|>=
literal|0
condition|)
block|{
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|persistent_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|disabled
operator|!=
literal|2
operator|||
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|os_free
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_fail_on_wps_complete
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|pending_p2ps_group
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|go_intent
operator|<
literal|0
condition|)
name|go_intent
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_go_intent
expr_stmt|;
if|if
condition|(
operator|!
name|auth
condition|)
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_wps_method
operator|=
name|wps_method
expr_stmt|;
name|wpa_s
operator|->
name|p2p_persistent_group
operator|=
operator|!
operator|!
name|persistent_group
expr_stmt|;
name|wpa_s
operator|->
name|p2p_persistent_id
operator|=
name|persistent_id
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_intent
operator|=
name|go_intent
expr_stmt|;
name|wpa_s
operator|->
name|p2p_connect_freq
operator|=
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_pd_before_go_neg
operator|=
operator|!
operator|!
name|pd
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_ht40
operator|=
operator|!
operator|!
name|ht40
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_vht
operator|=
operator|!
operator|!
name|vht
expr_stmt|;
if|if
condition|(
name|pin
condition|)
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
name|pin
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|p2p_pin
argument_list|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wps_method
operator|==
name|WPS_PIN_DISPLAY
condition|)
block|{
name|ret
operator|=
name|wps_generate_pin
argument_list|()
expr_stmt|;
name|res
operator|=
name|os_snprintf
argument_list|(
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|p2p_pin
argument_list|)
argument_list|,
literal|"%08d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|p2p_pin
argument_list|)
argument_list|,
name|res
argument_list|)
condition|)
name|wpa_s
operator|->
name|p2p_pin
index|[
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|p2p_pin
argument_list|)
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Randomly generated PIN: %s"
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_s
operator|->
name|p2p_pin
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|join
operator|||
name|auto_join
condition|)
block|{
name|u8
name|iface_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|,
name|dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|auth
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Authorize invitation to "
literal|"connect a running group from "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peer_addr
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
name|peer_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
name|os_memcpy
argument_list|(
name|dev_addr
argument_list|,
name|peer_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_get_interface_addr
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|iface_addr
argument_list|)
operator|<
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|iface_addr
argument_list|,
name|peer_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|p2p_get_dev_addr
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|dev_addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|auto_join
condition|)
block|{
name|os_get_reltime
argument_list|(
operator|&
name|wpa_s
operator|->
name|p2p_auto_started
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Auto join started at "
literal|"%ld.%06ld"
argument_list|,
name|wpa_s
operator|->
name|p2p_auto_started
operator|.
name|sec
argument_list|,
name|wpa_s
operator|->
name|p2p_auto_started
operator|.
name|usec
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|user_initiated_pd
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpas_p2p_join
argument_list|(
name|wpa_s
argument_list|,
name|iface_addr
argument_list|,
name|dev_addr
argument_list|,
name|wps_method
argument_list|,
name|auto_join
argument_list|,
name|freq
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ret
return|;
block|}
name|res
operator|=
name|wpas_p2p_setup_freqs
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
operator|&
name|force_freq
argument_list|,
operator|&
name|pref_freq
argument_list|,
name|go_intent
operator|==
literal|15
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
name|wpas_p2p_set_own_freq_preference
argument_list|(
name|wpa_s
argument_list|,
name|force_freq
condition|?
name|force_freq
else|:
name|pref_freq
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|create_p2p_iface
operator|=
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|create_p2p_iface
condition|)
block|{
comment|/* Prepare to add a new interface for the group */
name|iftype
operator|=
name|WPA_IF_P2P_GROUP
expr_stmt|;
if|if
condition|(
name|go_intent
operator|==
literal|15
condition|)
name|iftype
operator|=
name|WPA_IF_P2P_GO
expr_stmt|;
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|iftype
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to allocate a new "
literal|"interface for the group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|if_addr
operator|=
name|wpa_s
operator|->
name|pending_interface_addr
expr_stmt|;
block|}
else|else
name|if_addr
operator|=
name|wpa_s
operator|->
name|own_addr
expr_stmt|;
if|if
condition|(
name|auth
condition|)
block|{
if|if
condition|(
name|wpas_p2p_auth_go_neg
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|,
name|wps_method
argument_list|,
name|go_intent
argument_list|,
name|if_addr
argument_list|,
name|force_freq
argument_list|,
name|persistent_group
argument_list|,
name|ssid
argument_list|,
name|pref_freq
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|wpas_p2p_start_go_neg
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|,
name|wps_method
argument_list|,
name|go_intent
argument_list|,
name|if_addr
argument_list|,
name|force_freq
argument_list|,
name|persistent_group
argument_list|,
name|ssid
argument_list|,
name|pref_freq
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|create_p2p_iface
condition|)
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_remain_on_channel_cb - Indication of remain-on-channel start  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * @freq: Frequency of the channel in MHz  * @duration: Duration of the stay on the channel in milliseconds  *  * This callback is called when the driver indicates that it has started the  * requested remain-on-channel duration.  */
end_comment

begin_function
name|void
name|wpas_p2p_remain_on_channel_cb
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|,
name|unsigned
name|int
name|duration
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: remain-on-channel callback (off_channel_freq=%u pending_listen_freq=%d roc_waiting_drv_freq=%d freq=%u duration=%u)"
argument_list|,
name|wpa_s
operator|->
name|off_channel_freq
argument_list|,
name|wpa_s
operator|->
name|pending_listen_freq
argument_list|,
name|wpa_s
operator|->
name|roc_waiting_drv_freq
argument_list|,
name|freq
argument_list|,
name|duration
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|off_channel_freq
operator|&&
name|wpa_s
operator|->
name|off_channel_freq
operator|==
name|wpa_s
operator|->
name|pending_listen_freq
condition|)
block|{
name|p2p_listen_cb
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|pending_listen_freq
argument_list|,
name|wpa_s
operator|->
name|pending_listen_duration
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_listen_freq
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore remain-on-channel callback (off_channel_freq=%u pending_listen_freq=%d freq=%u duration=%u)"
argument_list|,
name|wpa_s
operator|->
name|off_channel_freq
argument_list|,
name|wpa_s
operator|->
name|pending_listen_freq
argument_list|,
name|freq
argument_list|,
name|duration
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wpas_p2p_listen_start
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|)
block|{
comment|/* Limit maximum Listen state time based on driver limitation. */
if|if
condition|(
name|timeout
operator|>
name|wpa_s
operator|->
name|max_remain_on_chan
condition|)
name|timeout
operator|=
name|wpa_s
operator|->
name|max_remain_on_chan
expr_stmt|;
return|return
name|p2p_listen
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|timeout
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_cancel_remain_on_channel_cb - Remain-on-channel timeout  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * @freq: Frequency of the channel in MHz  *  * This callback is called when the driver indicates that a remain-on-channel  * operation has been completed, i.e., the duration on the requested channel  * has timed out.  */
end_comment

begin_function
name|void
name|wpas_p2p_cancel_remain_on_channel_cb
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|freq
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancel remain-on-channel callback "
literal|"(p2p_long_listen=%d ms pending_action_tx=%p)"
argument_list|,
name|wpa_s
operator|->
name|p2p_long_listen
argument_list|,
name|offchannel_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
argument_list|)
expr_stmt|;
name|wpas_p2p_listen_work_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_long_listen
operator|>
literal|0
condition|)
name|wpa_s
operator|->
name|p2p_long_listen
operator|-=
name|wpa_s
operator|->
name|max_remain_on_chan
expr_stmt|;
if|if
condition|(
name|p2p_listen_end
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
operator|>
literal|0
condition|)
return|return;
comment|/* P2P module started a new operation */
if|if
condition|(
name|offchannel_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_long_listen
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Continuing long Listen state"
argument_list|)
expr_stmt|;
name|wpas_p2p_listen_start
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|p2p_long_listen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* 		 * When listen duration is over, stop listen& update p2p_state 		 * to IDLE. 		 */
name|p2p_stop_listen
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_group_remove - Remove a P2P group  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * @ifname: Network interface name of the group interface or "*" to remove all  *	groups  * Returns: 0 on success, -1 on failure  *  * This function is used to remove a P2P group. This can be used to disconnect  * from a group in which the local end is a P2P Client or to end a P2P Group in  * case the local end is the Group Owner. If a virtual network interface was  * created for this group, that interface will be removed. Otherwise, only the  * configured P2P group network will be removed from the interface.  */
end_comment

begin_function
name|int
name|wpas_p2p_group_remove
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|wpa_s
operator|->
name|global
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|calling_wpa_s
init|=
name|wpa_s
decl_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|ifname
argument_list|,
literal|"*"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|prev
decl_stmt|;
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
expr_stmt|;
while|while
condition|(
name|wpa_s
condition|)
block|{
name|prev
operator|=
name|wpa_s
expr_stmt|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|prev
operator|->
name|p2p_group_interface
operator|!=
name|NOT_P2P_GROUP_INTERFACE
operator|||
operator|(
name|prev
operator|->
name|current_ssid
operator|&&
name|prev
operator|->
name|current_ssid
operator|->
name|p2p_group
operator|)
condition|)
name|wpas_p2p_disconnect_safely
argument_list|(
name|prev
argument_list|,
name|calling_wpa_s
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
return|return
name|wpas_p2p_disconnect_safely
argument_list|(
name|wpa_s
argument_list|,
name|calling_wpa_s
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_select_go_freq
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|unsigned
name|int
name|r
decl_stmt|;
if|if
condition|(
name|freq
operator|==
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Request to start GO on 2.4 GHz "
literal|"band"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|best_24_freq
operator|>
literal|0
operator|&&
name|p2p_supported_freq_go
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|best_24_freq
argument_list|)
condition|)
block|{
name|freq
operator|=
name|wpa_s
operator|->
name|best_24_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use best 2.4 GHz band "
literal|"channel: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|freq
operator|=
literal|2412
operator|+
operator|(
name|r
operator|%
literal|3
operator|)
operator|*
literal|25
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use random 2.4 GHz band "
literal|"channel: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|freq
operator|==
literal|5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Request to start GO on 5 GHz "
literal|"band"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|best_5_freq
operator|>
literal|0
operator|&&
name|p2p_supported_freq_go
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|best_5_freq
argument_list|)
condition|)
block|{
name|freq
operator|=
name|wpa_s
operator|->
name|best_5_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use best 5 GHz band "
literal|"channel: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|freq
operator|=
literal|5180
operator|+
operator|(
name|r
operator|%
literal|4
operator|)
operator|*
literal|20
expr_stmt|;
if|if
condition|(
operator|!
name|p2p_supported_freq_go
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not select "
literal|"5 GHz channel for P2P group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use random 5 GHz band "
literal|"channel: %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|freq
operator|>
literal|0
operator|&&
operator|!
name|p2p_supported_freq_go
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_DFS_OFFLOAD
operator|)
operator|&&
name|ieee80211_is_dfs
argument_list|(
name|freq
argument_list|)
condition|)
block|{
comment|/* 			 * If freq is a DFS channel and DFS is offloaded to the 			 * driver, allow P2P GO to use it. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: "
literal|"%s: The forced channel for GO (%u MHz) is DFS, and DFS is offloaded"
argument_list|,
name|__func__
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
name|freq
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: The forced channel for GO "
literal|"(%u MHz) is not supported for P2P uses"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|freq
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_select_freq_no_pref
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|params
parameter_list|,
specifier|const
name|struct
name|p2p_channels
modifier|*
name|channels
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|,
name|r
decl_stmt|;
comment|/* first try some random selection of the social channels */
if|if
condition|(
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|3
condition|;
name|i
operator|++
control|)
block|{
name|params
operator|->
name|freq
operator|=
literal|2412
operator|+
operator|(
operator|(
name|r
operator|+
name|i
operator|)
operator|%
literal|3
operator|)
operator|*
literal|25
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|params
operator|->
name|freq
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* try all channels in reg. class 81 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|11
condition|;
name|i
operator|++
control|)
block|{
name|params
operator|->
name|freq
operator|=
literal|2412
operator|+
name|i
operator|*
literal|5
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|params
operator|->
name|freq
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* try all channels in operating class 115 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|params
operator|->
name|freq
operator|=
literal|5180
operator|+
name|i
operator|*
literal|20
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|params
operator|->
name|freq
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* try all channels in operating class 124 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|params
operator|->
name|freq
operator|=
literal|5745
operator|+
name|i
operator|*
literal|20
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|params
operator|->
name|freq
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
comment|/* try social channel class 180 channel 2 */
name|params
operator|->
name|freq
operator|=
literal|58320
operator|+
literal|1
operator|*
literal|2160
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|params
operator|->
name|freq
argument_list|)
condition|)
goto|goto
name|out
goto|;
comment|/* try all channels in reg. class 180 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|params
operator|->
name|freq
operator|=
literal|58320
operator|+
name|i
operator|*
literal|2160
expr_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_disallowed_freq
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|params
operator|->
name|freq
argument_list|)
operator|&&
name|p2p_supported_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|params
operator|->
name|freq
argument_list|)
condition|)
goto|goto
name|out
goto|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No 2.4, 5, or 60 GHz channel allowed"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
name|out
label|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq %d MHz (no preference known)"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_init_go_params
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_go_neg_results
modifier|*
name|params
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|ht40
parameter_list|,
name|int
name|vht
parameter_list|,
specifier|const
name|struct
name|p2p_channels
modifier|*
name|channels
parameter_list|)
block|{
name|struct
name|wpa_used_freq_data
modifier|*
name|freqs
decl_stmt|;
name|unsigned
name|int
name|pref_freq
decl_stmt|,
name|cand_freq
decl_stmt|;
name|unsigned
name|int
name|num
decl_stmt|,
name|i
decl_stmt|;
name|os_memset
argument_list|(
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|->
name|role_go
operator|=
literal|1
expr_stmt|;
name|params
operator|->
name|ht40
operator|=
name|ht40
expr_stmt|;
name|params
operator|->
name|vht
operator|=
name|vht
expr_stmt|;
if|if
condition|(
name|freq
condition|)
block|{
if|if
condition|(
operator|!
name|freq_included
argument_list|(
name|channels
argument_list|,
name|freq
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Forced GO freq %d MHz not "
literal|"accepted"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on forced "
literal|"frequency %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|params
operator|->
name|freq
operator|=
name|freq
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|==
literal|81
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|>=
literal|1
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|<=
literal|11
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
literal|2407
operator|+
literal|5
operator|*
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
argument_list|)
condition|)
block|{
name|params
operator|->
name|freq
operator|=
literal|2407
operator|+
literal|5
operator|*
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on configured "
literal|"frequency %d MHz"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|==
literal|115
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|==
literal|116
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|==
literal|117
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|==
literal|124
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|==
literal|126
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|==
literal|127
operator|)
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
literal|5000
operator|+
literal|5
operator|*
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
argument_list|)
condition|)
block|{
name|params
operator|->
name|freq
operator|=
literal|5000
operator|+
literal|5
operator|*
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on configured "
literal|"frequency %d MHz"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|best_overall_freq
operator|>
literal|0
operator|&&
name|p2p_supported_freq_go
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|best_overall_freq
argument_list|)
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|wpa_s
operator|->
name|best_overall_freq
argument_list|)
condition|)
block|{
name|params
operator|->
name|freq
operator|=
name|wpa_s
operator|->
name|best_overall_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on best overall "
literal|"channel %d MHz"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|best_24_freq
operator|>
literal|0
operator|&&
name|p2p_supported_freq_go
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|best_24_freq
argument_list|)
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|wpa_s
operator|->
name|best_24_freq
argument_list|)
condition|)
block|{
name|params
operator|->
name|freq
operator|=
name|wpa_s
operator|->
name|best_24_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on best 2.4 GHz "
literal|"channel %d MHz"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|==
literal|0
operator|&&
name|wpa_s
operator|->
name|best_5_freq
operator|>
literal|0
operator|&&
name|p2p_supported_freq_go
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|best_5_freq
argument_list|)
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|wpa_s
operator|->
name|best_5_freq
argument_list|)
condition|)
block|{
name|params
operator|->
name|freq
operator|=
name|wpa_s
operator|->
name|best_5_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq based on best 5 GHz "
literal|"channel %d MHz"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|pref_freq
operator|=
name|p2p_get_pref_freq
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|channels
argument_list|)
operator|)
condition|)
block|{
name|params
operator|->
name|freq
operator|=
name|pref_freq
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set GO freq %d MHz from preferred "
literal|"channels"
argument_list|,
name|params
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no preference, select some channel */
if|if
condition|(
name|wpas_p2p_select_freq_no_pref
argument_list|(
name|wpa_s
argument_list|,
name|params
argument_list|,
name|channels
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|freqs
operator|=
name|os_calloc
argument_list|(
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_used_freq_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|freqs
condition|)
return|return
operator|-
literal|1
return|;
name|num
operator|=
name|wpas_p2p_valid_oper_freqs
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|wpa_s
operator|->
name|num_multichan_concurrent
argument_list|)
expr_stmt|;
name|cand_freq
operator|=
name|wpas_p2p_pick_best_used_freq
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|num
argument_list|)
expr_stmt|;
comment|/* First try the best used frequency if possible */
if|if
condition|(
operator|!
name|freq
operator|&&
name|cand_freq
operator|>
literal|0
operator|&&
name|freq_included
argument_list|(
name|channels
argument_list|,
name|cand_freq
argument_list|)
condition|)
block|{
name|params
operator|->
name|freq
operator|=
name|cand_freq
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|freq
condition|)
block|{
comment|/* Try any of the used frequencies */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|freq_included
argument_list|(
name|channels
argument_list|,
name|freqs
index|[
name|i
index|]
operator|.
name|freq
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Force GO on a channel we are already using (%u MHz)"
argument_list|,
name|freqs
index|[
name|i
index|]
operator|.
name|freq
argument_list|)
expr_stmt|;
name|params
operator|->
name|freq
operator|=
name|freqs
index|[
name|i
index|]
operator|.
name|freq
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|i
operator|==
name|num
condition|)
block|{
if|if
condition|(
name|wpas_p2p_num_unused_channels
argument_list|(
name|wpa_s
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cannot force GO on any of the channels we are already using"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cannot force GO on any of the channels we are already using. Use one of the free channels"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|freqs
index|[
name|i
index|]
operator|.
name|freq
operator|==
name|freq
condition|)
break|break;
block|}
if|if
condition|(
name|i
operator|==
name|num
condition|)
block|{
if|if
condition|(
name|wpas_p2p_num_unused_channels
argument_list|(
name|wpa_s
argument_list|)
operator|<=
literal|0
condition|)
block|{
if|if
condition|(
name|freq
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cannot force GO on freq (%u MHz) as all the channels are in use"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use one of the free channels"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|wpas_p2p_get_group_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|addr_allocated
parameter_list|,
name|int
name|go
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|group_wpa_s
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use same interface for group "
literal|"operations"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_first_connection_timeout
operator|=
literal|0
expr_stmt|;
return|return
name|wpa_s
return|;
block|}
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|go
condition|?
name|WPA_IF_P2P_GO
else|:
name|WPA_IF_P2P_CLIENT
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to add group interface"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|group_wpa_s
operator|=
name|wpas_p2p_init_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|go
argument_list|)
expr_stmt|;
if|if
condition|(
name|group_wpa_s
operator|==
name|NULL
condition|)
block|{
name|wpa_msg_global
argument_list|(
name|wpa_s
argument_list|,
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to initialize group interface"
argument_list|)
expr_stmt|;
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use separate group interface %s"
argument_list|,
name|group_wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|group_wpa_s
operator|->
name|p2p_first_connection_timeout
operator|=
literal|0
expr_stmt|;
return|return
name|group_wpa_s
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_group_add - Add a new P2P group with local end as Group Owner  * @wpa_s: Pointer to wpa_supplicant data from wpa_supplicant_add_iface()  * @persistent_group: Whether to create a persistent group  * @freq: Frequency for the group or 0 to indicate no hardcoding  * @ht40: Start GO with 40 MHz channel width  * @vht:  Start GO with VHT support  * Returns: 0 on success, -1 on failure  *  * This function creates a new P2P group with the local end as the Group Owner,  * i.e., without using Group Owner Negotiation.  */
end_comment

begin_function
name|int
name|wpas_p2p_group_add
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|persistent_group
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|ht40
parameter_list|,
name|int
name|vht
parameter_list|)
block|{
name|struct
name|p2p_go_neg_results
name|params
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
operator|=
name|NULL
expr_stmt|;
comment|/* Make sure we are not running find during connection establishment */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Stop any on-going P2P FIND"
argument_list|)
expr_stmt|;
name|wpas_p2p_stop_find_oper
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|freq
operator|=
name|wpas_p2p_select_go_freq
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpas_p2p_init_go_params
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
name|freq
argument_list|,
name|ht40
argument_list|,
name|vht
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|params
operator|.
name|freq
operator|&&
operator|!
name|p2p_supported_freq_go
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|params
operator|.
name|freq
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_DFS_OFFLOAD
operator|)
operator|&&
name|ieee80211_is_dfs
argument_list|(
name|params
operator|.
name|freq
argument_list|)
condition|)
block|{
comment|/* 			 * If freq is a DFS channel and DFS is offloaded to the 			 * driver, allow P2P GO to use it. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: %s: The forced channel for GO (%u MHz) is DFS, and DFS is offloaded to driver"
argument_list|,
name|__func__
argument_list|,
name|params
operator|.
name|freq
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: The selected channel for GO (%u MHz) is not supported for P2P uses"
argument_list|,
name|params
operator|.
name|freq
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|p2p_go_params
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
name|params
operator|.
name|persistent_group
operator|=
name|persistent_group
expr_stmt|;
name|wpa_s
operator|=
name|wpas_p2p_get_group_iface
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_start_wps_go
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_start_p2p_client
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|params
parameter_list|,
name|int
name|addr_allocated
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|wpa_s
operator|=
name|wpas_p2p_get_group_iface
argument_list|(
name|wpa_s
argument_list|,
name|addr_allocated
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_s
operator|->
name|p2p_last_4way_hs_fail
operator|=
name|NULL
expr_stmt|;
name|wpa_supplicant_ap_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
name|ssid
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|ssid
operator|->
name|group_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_malloc
argument_list|(
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid
argument_list|,
name|params
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|params
operator|->
name|ssid_len
expr_stmt|;
name|ssid
operator|->
name|p2p_group
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|export_keys
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|psk_set
condition|)
block|{
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|psk
argument_list|,
name|params
operator|->
name|psk
argument_list|,
literal|32
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|psk_set
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|params
operator|->
name|passphrase
condition|)
name|ssid
operator|->
name|passphrase
operator|=
name|os_strdup
argument_list|(
name|params
operator|->
name|passphrase
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|p2p_in_invitation
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|p2p_invite_go_freq
operator|=
name|freq
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|P2P_MAX_INITIAL_CONN_WAIT
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_supplicant_select_network
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_group_add_persistent
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|int
name|addr_allocated
parameter_list|,
name|int
name|force_freq
parameter_list|,
name|int
name|neg_freq
parameter_list|,
name|int
name|ht40
parameter_list|,
name|int
name|vht
parameter_list|,
specifier|const
name|struct
name|p2p_channels
modifier|*
name|channels
parameter_list|,
name|int
name|connection_timeout
parameter_list|)
block|{
name|struct
name|p2p_go_neg_results
name|params
decl_stmt|;
name|int
name|go
init|=
literal|0
decl_stmt|,
name|freq
decl_stmt|;
if|if
condition|(
name|ssid
operator|->
name|disabled
operator|!=
literal|2
operator|||
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpas_get_p2p_group
argument_list|(
name|wpa_s
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
operator|&
name|go
argument_list|)
operator|&&
name|go
operator|==
operator|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested persistent group is "
literal|"already running"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|os_free
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
operator|=
name|NULL
expr_stmt|;
comment|/* Make sure we are not running find during connection establishment */
name|wpas_p2p_stop_find_oper
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
if|if
condition|(
name|force_freq
operator|>
literal|0
condition|)
block|{
name|freq
operator|=
name|wpas_p2p_select_go_freq
argument_list|(
name|wpa_s
argument_list|,
name|force_freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|freq
operator|=
name|wpas_p2p_select_go_freq
argument_list|(
name|wpa_s
argument_list|,
name|neg_freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|freq
operator|<
literal|0
operator|||
operator|(
name|freq
operator|>
literal|0
operator|&&
operator|!
name|freq_included
argument_list|(
name|channels
argument_list|,
name|freq
argument_list|)
operator|)
condition|)
name|freq
operator|=
literal|0
expr_stmt|;
block|}
block|}
else|else
block|{
name|freq
operator|=
name|neg_freq
expr_stmt|;
if|if
condition|(
name|freq
operator|<
literal|0
operator|||
operator|(
name|freq
operator|>
literal|0
operator|&&
operator|!
name|freq_included
argument_list|(
name|channels
argument_list|,
name|freq
argument_list|)
operator|)
condition|)
name|freq
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
condition|)
return|return
name|wpas_start_p2p_client
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|addr_allocated
argument_list|,
name|freq
argument_list|)
return|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpas_p2p_init_go_params
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
name|freq
argument_list|,
name|ht40
argument_list|,
name|vht
argument_list|,
name|channels
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|params
operator|.
name|role_go
operator|=
literal|1
expr_stmt|;
name|params
operator|.
name|psk_set
operator|=
name|ssid
operator|->
name|psk_set
expr_stmt|;
if|if
condition|(
name|params
operator|.
name|psk_set
condition|)
name|os_memcpy
argument_list|(
name|params
operator|.
name|psk
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
sizeof|sizeof
argument_list|(
name|params
operator|.
name|psk
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
condition|)
block|{
if|if
condition|(
name|os_strlen
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
operator|>=
sizeof|sizeof
argument_list|(
name|params
operator|.
name|passphrase
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Invalid passphrase in "
literal|"persistent group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_strlcpy
argument_list|(
name|params
operator|.
name|passphrase
argument_list|,
name|ssid
operator|->
name|passphrase
argument_list|,
sizeof|sizeof
argument_list|(
name|params
operator|.
name|passphrase
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|params
operator|.
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|params
operator|.
name|ssid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
name|params
operator|.
name|persistent_group
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|=
name|wpas_p2p_get_group_iface
argument_list|(
name|wpa_s
argument_list|,
name|addr_allocated
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p2p_channels_to_freqs
argument_list|(
name|channels
argument_list|,
name|params
operator|.
name|freq_list
argument_list|,
name|P2P_MAX_CHANNELS
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_first_connection_timeout
operator|=
name|connection_timeout
expr_stmt|;
name|wpas_start_wps_go
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_ie_update
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|beacon_ies
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|proberesp_ies
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|hapd
operator|->
name|conf
operator|->
name|p2p
operator|&
name|P2P_GROUP_OWNER
operator|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|beacon_ies
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|proberesp_ies
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|beacon_ies
condition|)
block|{
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|p2p_beacon_ie
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|p2p_beacon_ie
operator|=
name|beacon_ies
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|p2p_probe_resp_ie
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|p2p_probe_resp_ie
operator|=
name|proberesp_ies
expr_stmt|;
block|}
else|else
block|{
name|wpabuf_free
argument_list|(
name|beacon_ies
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|proberesp_ies
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_ap_update_beacon
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_idle_update
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|idle
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO - group %sidle"
argument_list|,
name|idle
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
if|if
condition|(
name|idle
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_fail_on_wps_complete
operator|&&
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
block|{
name|wpas_p2p_grpform_fail_after_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpas_p2p_set_group_idle_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
else|else
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|struct
name|p2p_group
modifier|*
name|wpas_p2p_group_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|p2p_group
modifier|*
name|group
decl_stmt|;
name|struct
name|p2p_group_config
modifier|*
name|cfg
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|cfg
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|cfg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|cfg
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ssid
operator|->
name|p2p_persistent_group
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|persistent_reconnect
condition|)
name|cfg
operator|->
name|persistent_group
operator|=
literal|2
expr_stmt|;
elseif|else
if|if
condition|(
name|ssid
operator|->
name|p2p_persistent_group
condition|)
name|cfg
operator|->
name|persistent_group
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|cfg
operator|->
name|interface_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|max_stations
operator|&&
name|wpa_s
operator|->
name|max_stations
operator|<
name|wpa_s
operator|->
name|conf
operator|->
name|max_num_sta
condition|)
name|cfg
operator|->
name|max_clients
operator|=
name|wpa_s
operator|->
name|max_stations
expr_stmt|;
else|else
name|cfg
operator|->
name|max_clients
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|max_num_sta
expr_stmt|;
name|os_memcpy
argument_list|(
name|cfg
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|cfg
operator|->
name|ssid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
name|cfg
operator|->
name|freq
operator|=
name|ssid
operator|->
name|frequency
expr_stmt|;
name|cfg
operator|->
name|cb_ctx
operator|=
name|wpa_s
expr_stmt|;
name|cfg
operator|->
name|ie_update
operator|=
name|wpas_p2p_ie_update
expr_stmt|;
name|cfg
operator|->
name|idle_update
operator|=
name|wpas_p2p_idle_update
expr_stmt|;
name|group
operator|=
name|p2p_group_init
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|group
operator|==
name|NULL
condition|)
name|os_free
argument_list|(
name|cfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GROUP_FORMATION
condition|)
name|p2p_group_notif_formation_done
argument_list|(
name|group
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group
operator|=
name|group
expr_stmt|;
return|return
name|group
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_wps_success
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
name|int
name|registrar
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore WPS success event - P2P "
literal|"provisioning not in progress"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
condition|)
block|{
name|u8
name|go_dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|os_memcpy
argument_list|(
name|go_dev_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpas_p2p_persistent_group
argument_list|(
name|wpa_s
argument_list|,
name|go_dev_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
comment|/* Clear any stored provisioning info */
name|p2p_clear_provisioning_info
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|go_dev_addr
argument_list|)
expr_stmt|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_group_formation_completed
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ssid
operator|&&
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
condition|)
block|{
comment|/* 		 * Use a separate timeout for initial data connection to 		 * complete to allow the group to be removed automatically if 		 * something goes wrong in this step before the P2P group idle 		 * timeout mechanism is taken into use. 		 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Re-start group formation timeout (%d seconds) as client for initial connection"
argument_list|,
name|P2P_MAX_INITIAL_CONN_WAIT
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|P2P_MAX_INITIAL_CONN_WAIT
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ssid
condition|)
block|{
comment|/* 		 * Use a separate timeout for initial data connection to 		 * complete to allow the group to be removed automatically if 		 * the client does not complete data connection successfully. 		 */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Re-start group formation timeout (%d seconds) as GO for initial connection"
argument_list|,
name|P2P_MAX_INITIAL_CONN_WAIT_GO
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|P2P_MAX_INITIAL_CONN_WAIT_GO
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* 		 * Complete group formation on first successful data connection 		 */
name|wpa_s
operator|->
name|p2p_go_group_formation_completed
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_wps_success_cb
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|)
expr_stmt|;
name|wpas_group_formation_completed
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_wps_failed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_fail
modifier|*
name|fail
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore WPS fail event - P2P "
literal|"provisioning not in progress"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|go_params
condition|)
block|{
name|p2p_clear_provisioning_info
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|go_params
operator|->
name|peer_device_addr
argument_list|)
expr_stmt|;
block|}
name|wpas_notify_p2p_wps_failed
argument_list|(
name|wpa_s
argument_list|,
name|fail
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
condition|)
block|{
comment|/* 		 * Allow some time for the failed WPS negotiation exchange to 		 * complete, but remove the group since group formation cannot 		 * succeed after provisioning failure. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: WPS step failed during group formation - reject connection from timeout"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_fail_on_wps_complete
operator|=
literal|1
expr_stmt|;
name|eloop_deplete_timeout
argument_list|(
literal|0
argument_list|,
literal|50000
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wpas_p2p_wps_eapol_cb
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|p2p_fail_on_wps_complete
operator|||
operator|!
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
return|return
literal|0
return|;
name|wpas_p2p_grpform_fail_after_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_prov_disc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
specifier|const
name|char
modifier|*
name|config_method
parameter_list|,
name|enum
name|wpas_p2p_prov_disc_use
name|use
parameter_list|,
name|struct
name|p2ps_provision
modifier|*
name|p2ps_prov
parameter_list|)
block|{
name|u16
name|config_methods
decl_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|pending_p2ps_group
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_use
operator|=
name|NORMAL_PD
expr_stmt|;
if|if
condition|(
name|p2ps_prov
operator|&&
name|use
operator|==
name|WPAS_P2P_PD_FOR_ASP
condition|)
block|{
name|p2ps_prov
operator|->
name|conncap
operator|=
name|p2ps_group_capability
argument_list|(
name|wpa_s
argument_list|,
name|P2PS_SETUP_NONE
argument_list|,
name|p2ps_prov
operator|->
name|role
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: %s conncap: %d - ASP parsed: %x %x %d %s"
argument_list|,
name|__func__
argument_list|,
name|p2ps_prov
operator|->
name|conncap
argument_list|,
name|p2ps_prov
operator|->
name|adv_id
argument_list|,
name|p2ps_prov
operator|->
name|conncap
argument_list|,
name|p2ps_prov
operator|->
name|status
argument_list|,
name|p2ps_prov
operator|->
name|info
argument_list|)
expr_stmt|;
name|config_methods
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|config_method
argument_list|,
literal|"display"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
name|config_methods
operator|=
name|WPS_CONFIG_DISPLAY
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|config_method
argument_list|,
literal|"keypad"
argument_list|,
literal|6
argument_list|)
operator|==
literal|0
condition|)
name|config_methods
operator|=
name|WPS_CONFIG_KEYPAD
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strncmp
argument_list|(
name|config_method
argument_list|,
literal|"pbc"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
operator|||
name|os_strncmp
argument_list|(
name|config_method
argument_list|,
literal|"pushbutton"
argument_list|,
literal|10
argument_list|)
operator|==
literal|0
condition|)
name|config_methods
operator|=
name|WPS_CONFIG_PUSHBUTTON
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unknown config method"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|p2ps_prov
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|use
operator|==
name|WPAS_P2P_PD_AUTO
condition|)
block|{
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|peer_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_config_methods
operator|=
name|config_methods
expr_stmt|;
name|wpa_s
operator|->
name|p2p_auto_pd
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|p2p_auto_join
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|auto_pd_scan_retry
operator|=
literal|0
expr_stmt|;
name|wpas_p2p_stop_find
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_join_scan_count
operator|=
literal|0
expr_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|wpa_s
operator|->
name|p2p_auto_started
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Auto PD started at %ld.%06ld"
argument_list|,
name|wpa_s
operator|->
name|p2p_auto_started
operator|.
name|sec
argument_list|,
name|wpa_s
operator|->
name|p2p_auto_started
operator|.
name|usec
argument_list|)
expr_stmt|;
name|wpas_p2p_join_scan
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
block|{
name|os_free
argument_list|(
name|p2ps_prov
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
name|p2p_prov_disc_req
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|p2ps_prov
argument_list|,
name|config_methods
argument_list|,
name|use
operator|==
name|WPAS_P2P_PD_FOR_JOIN
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_scan_result_text
parameter_list|(
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
name|end
parameter_list|)
block|{
return|return
name|p2p_scan_result_text
argument_list|(
name|ies
argument_list|,
name|ies_len
argument_list|,
name|buf
argument_list|,
name|end
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_clear_pending_action_tx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|offchannel_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return;
name|wpas_p2p_action_tx_clear
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Drop pending Action TX due to new "
literal|"operation request"
argument_list|)
expr_stmt|;
name|offchannel_clear_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_find
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|,
name|enum
name|p2p_discovery_type
name|type
parameter_list|,
name|unsigned
name|int
name|num_req_dev_types
parameter_list|,
specifier|const
name|u8
modifier|*
name|req_dev_types
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_id
parameter_list|,
name|unsigned
name|int
name|search_delay
parameter_list|,
name|u8
name|seek_cnt
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|seek_string
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|wpas_p2p_clear_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|p2p_find
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|timeout
argument_list|,
name|type
argument_list|,
name|num_req_dev_types
argument_list|,
name|req_dev_types
argument_list|,
name|dev_id
argument_list|,
name|search_delay
argument_list|,
name|seek_cnt
argument_list|,
name|seek_string
argument_list|,
name|freq
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_scan_res_ignore_search
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore scan results"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_scan_work
condition|)
block|{
name|struct
name|wpa_radio_work
modifier|*
name|work
init|=
name|wpa_s
operator|->
name|p2p_scan_work
decl_stmt|;
name|wpa_s
operator|->
name|p2p_scan_work
operator|=
name|NULL
expr_stmt|;
name|radio_work_done
argument_list|(
name|work
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
comment|/* 	 * Indicate that results have been processed so that the P2P module can 	 * continue pending tasks. 	 */
name|p2p_scan_res_handled
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_stop_find_oper
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpas_p2p_clear_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_join_scan
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_stop_find
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|scan_res_handler
operator|==
name|wpas_p2p_scan_res_handler
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Do not consider the scan results after stop_find"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_res_handler
operator|=
name|wpas_p2p_scan_res_ignore_search
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpas_p2p_stop_find
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpas_p2p_stop_find_oper
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|pending_group_iface_for_p2ps
condition|)
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_long_listen_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_listen
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|timeout
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_p2p_clear_pending_action_tx
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|==
literal|0
condition|)
block|{
comment|/* 		 * This is a request for unlimited Listen state. However, at 		 * least for now, this is mapped to a Listen state for one 		 * hour. 		 */
name|timeout
operator|=
literal|3600
expr_stmt|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Stop previous find/listen operation to avoid trying to request a new 	 * remain-on-channel operation while the driver is still running the 	 * previous one. 	 */
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_stop_find
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|res
operator|=
name|wpas_p2p_listen_start
argument_list|(
name|wpa_s
argument_list|,
name|timeout
operator|*
literal|1000
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|0
operator|&&
name|timeout
operator|*
literal|1000
operator|>
name|wpa_s
operator|->
name|max_remain_on_chan
condition|)
block|{
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
name|timeout
operator|*
literal|1000
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|timeout
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_long_listen_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_assoc_req_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|p2p_group
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|p2p_ie
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_disabled
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|p2p_ie
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|P2P_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
name|ret
operator|=
name|p2p_assoc_req_ie
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
name|p2p_group
argument_list|,
name|p2p_ie
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p_ie
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_probe_req_rx
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|int
name|ssi_signal
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|p2p_probe_req_rx
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|addr
argument_list|,
name|dst
argument_list|,
name|bssid
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
condition|)
block|{
case|case
name|P2P_PREQ_NOT_P2P
case|:
name|wpas_notify_preq
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|dst
argument_list|,
name|bssid
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|,
name|ssi_signal
argument_list|)
expr_stmt|;
comment|/* fall through */
case|case
name|P2P_PREQ_MALFORMED
case|:
case|case
name|P2P_PREQ_NOT_LISTEN
case|:
case|case
name|P2P_PREQ_NOT_PROCESSED
case|:
default|default:
comment|/* make gcc happy */
return|return
literal|0
return|;
case|case
name|P2P_PREQ_PROCESSED
case|:
return|return
literal|1
return|;
block|}
block|}
end_function

begin_function
name|void
name|wpas_p2p_rx_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|da
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u8
name|category
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|size_t
name|len
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|p2p_rx_action
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|da
argument_list|,
name|sa
argument_list|,
name|bssid
argument_list|,
name|category
argument_list|,
name|data
argument_list|,
name|len
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_scan_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|ies
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|p2p_scan_ie
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|ies
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_group_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|p2p_group_deinit
argument_list|(
name|wpa_s
operator|->
name|p2p_group
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_group
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb_ctx
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|ap_configured_cb_data
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|connect_without_scan
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_reject
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
name|wpa_s
operator|->
name|p2p_long_listen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_reject
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|addr
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Invite to reinvoke a persistent group */
end_comment

begin_function
name|int
name|wpas_p2p_invite
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
name|int
name|freq
parameter_list|,
name|int
name|ht40
parameter_list|,
name|int
name|vht
parameter_list|,
name|int
name|pref_freq
parameter_list|)
block|{
name|enum
name|p2p_invite_role
name|role
decl_stmt|;
name|u8
modifier|*
name|bssid
init|=
name|NULL
decl_stmt|;
name|int
name|force_freq
init|=
literal|0
decl_stmt|;
name|int
name|res
decl_stmt|;
name|int
name|no_pref_freq_given
init|=
name|pref_freq
operator|==
literal|0
decl_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_invite_group
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|peer_addr
condition|)
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
name|peer_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
else|else
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_persistent_go_freq
operator|=
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_ht40
operator|=
operator|!
operator|!
name|ht40
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
name|role
operator|=
name|P2P_INVITE_ROLE_GO
expr_stmt|;
if|if
condition|(
name|peer_addr
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Missing peer "
literal|"address in invitation command"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|WPA_IF_P2P_GO
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to "
literal|"allocate a new interface for the "
literal|"group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|bssid
operator|=
name|wpa_s
operator|->
name|pending_interface_addr
expr_stmt|;
block|}
else|else
name|bssid
operator|=
name|wpa_s
operator|->
name|own_addr
expr_stmt|;
block|}
else|else
block|{
name|role
operator|=
name|P2P_INVITE_ROLE_CLIENT
expr_stmt|;
name|peer_addr
operator|=
name|ssid
operator|->
name|bssid
expr_stmt|;
block|}
name|wpa_s
operator|->
name|pending_invite_ssid_id
operator|=
name|ssid
operator|->
name|id
expr_stmt|;
name|res
operator|=
name|wpas_p2p_setup_freqs
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
operator|&
name|force_freq
argument_list|,
operator|&
name|pref_freq
argument_list|,
name|role
operator|==
name|P2P_INVITE_ROLE_GO
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|p2p_ignore_shared_freq
operator|&&
name|no_pref_freq_given
operator|&&
name|pref_freq
operator|>
literal|0
operator|&&
name|wpa_s
operator|->
name|num_multichan_concurrent
operator|>
literal|1
operator|&&
name|wpas_p2p_num_unused_channels
argument_list|(
name|wpa_s
argument_list|)
operator|>
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore own channel preference %d MHz for invitation due to p2p_ignore_shared_freq=1 configuration"
argument_list|,
name|pref_freq
argument_list|)
expr_stmt|;
name|pref_freq
operator|=
literal|0
expr_stmt|;
block|}
comment|/* 	 * Stop any find/listen operations before invitation and possibly 	 * connection establishment. 	 */
name|wpas_p2p_stop_find_oper
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|p2p_invite
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|role
argument_list|,
name|bssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
name|force_freq
argument_list|,
name|go_dev_addr
argument_list|,
literal|1
argument_list|,
name|pref_freq
argument_list|,
operator|-
literal|1
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Invite to join an active group */
end_comment

begin_function
name|int
name|wpas_p2p_invite_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|ifname
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|wpa_s
operator|->
name|global
decl_stmt|;
name|enum
name|p2p_invite_role
name|role
decl_stmt|;
name|u8
modifier|*
name|bssid
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|persistent
decl_stmt|;
name|int
name|freq
init|=
literal|0
decl_stmt|,
name|force_freq
init|=
literal|0
decl_stmt|,
name|pref_freq
init|=
literal|0
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_s
operator|->
name|p2p_persistent_go_freq
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_ht40
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_vht
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|ifname
argument_list|,
name|ifname
argument_list|)
operator|==
literal|0
condition|)
break|break;
block|}
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Interface '%s' not found"
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No current SSID to use for "
literal|"invitation"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|global
operator|->
name|p2p_invite_group
operator|=
name|wpa_s
expr_stmt|;
name|persistent
operator|=
name|ssid
operator|->
name|p2p_persistent_group
operator|&&
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|peer_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
block|{
name|role
operator|=
name|P2P_INVITE_ROLE_ACTIVE_GO
expr_stmt|;
name|bssid
operator|=
name|wpa_s
operator|->
name|own_addr
expr_stmt|;
if|if
condition|(
name|go_dev_addr
operator|==
name|NULL
condition|)
name|go_dev_addr
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
expr_stmt|;
name|freq
operator|=
name|ssid
operator|->
name|frequency
expr_stmt|;
block|}
else|else
block|{
name|role
operator|=
name|P2P_INVITE_ROLE_CLIENT
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Not associated - cannot "
literal|"invite to current group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|bssid
operator|=
name|wpa_s
operator|->
name|bssid
expr_stmt|;
if|if
condition|(
name|go_dev_addr
operator|==
name|NULL
operator|&&
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|go_dev_addr
argument_list|)
condition|)
name|go_dev_addr
operator|=
name|wpa_s
operator|->
name|go_dev_addr
expr_stmt|;
name|freq
operator|=
name|wpa_s
operator|->
name|current_bss
condition|?
name|wpa_s
operator|->
name|current_bss
operator|->
name|freq
else|:
operator|(
name|int
operator|)
name|wpa_s
operator|->
name|assoc_freq
expr_stmt|;
block|}
name|wpa_s
operator|->
name|parent
operator|->
name|pending_invite_ssid_id
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|res
operator|=
name|wpas_p2p_setup_freqs
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
operator|&
name|force_freq
argument_list|,
operator|&
name|pref_freq
argument_list|,
name|role
operator|==
name|P2P_INVITE_ROLE_ACTIVE_GO
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
name|wpas_p2p_set_own_freq_preference
argument_list|(
name|wpa_s
argument_list|,
name|force_freq
argument_list|)
expr_stmt|;
return|return
name|p2p_invite
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|,
name|role
argument_list|,
name|bssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
name|force_freq
argument_list|,
name|go_dev_addr
argument_list|,
name|persistent
argument_list|,
name|pref_freq
argument_list|,
operator|-
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_completed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|u8
name|go_dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|network_id
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|persistent
decl_stmt|;
name|int
name|freq
decl_stmt|;
name|u8
name|ip
index|[
literal|3
operator|*
literal|4
index|]
decl_stmt|;
name|char
name|ip_addr
index|[
literal|100
index|]
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GROUP_FORMATION
condition|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|show_group_started
operator|||
operator|!
name|ssid
condition|)
return|return;
name|wpa_s
operator|->
name|show_group_started
operator|=
literal|0
expr_stmt|;
name|os_memset
argument_list|(
name|go_dev_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|bssid_set
condition|)
name|os_memcpy
argument_list|(
name|go_dev_addr
argument_list|,
name|ssid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|persistent
operator|=
name|wpas_p2p_persistent_group
argument_list|(
name|wpa_s
argument_list|,
name|go_dev_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|go_dev_addr
argument_list|,
name|go_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|==
name|wpa_s
condition|)
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|NULL
expr_stmt|;
name|freq
operator|=
name|wpa_s
operator|->
name|current_bss
condition|?
name|wpa_s
operator|->
name|current_bss
operator|->
name|freq
else|:
operator|(
name|int
operator|)
name|wpa_s
operator|->
name|assoc_freq
expr_stmt|;
name|ip_addr
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|wpa_sm_get_p2p_ip_addr
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|ip
argument_list|)
operator|==
literal|0
condition|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|os_snprintf
argument_list|(
name|ip_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|ip_addr
argument_list|)
argument_list|,
literal|" ip_addr=%u.%u.%u.%u "
literal|"ip_mask=%u.%u.%u.%u go_ip_addr=%u.%u.%u.%u"
argument_list|,
name|ip
index|[
literal|0
index|]
argument_list|,
name|ip
index|[
literal|1
index|]
argument_list|,
name|ip
index|[
literal|2
index|]
argument_list|,
name|ip
index|[
literal|3
index|]
argument_list|,
name|ip
index|[
literal|4
index|]
argument_list|,
name|ip
index|[
literal|5
index|]
argument_list|,
name|ip
index|[
literal|6
index|]
argument_list|,
name|ip
index|[
literal|7
index|]
argument_list|,
name|ip
index|[
literal|8
index|]
argument_list|,
name|ip
index|[
literal|9
index|]
argument_list|,
name|ip
index|[
literal|10
index|]
argument_list|,
name|ip
index|[
literal|11
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
sizeof|sizeof
argument_list|(
name|ip_addr
argument_list|)
argument_list|,
name|res
argument_list|)
condition|)
name|ip_addr
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
name|wpas_p2p_group_started
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
name|ssid
argument_list|,
name|freq
argument_list|,
name|ssid
operator|->
name|passphrase
operator|==
name|NULL
operator|&&
name|ssid
operator|->
name|psk_set
condition|?
name|ssid
operator|->
name|psk
else|:
name|NULL
argument_list|,
name|ssid
operator|->
name|passphrase
argument_list|,
name|go_dev_addr
argument_list|,
name|persistent
argument_list|,
name|ip_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|persistent
condition|)
name|network_id
operator|=
name|wpas_p2p_store_persistent_group
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|ssid
argument_list|,
name|go_dev_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|network_id
operator|<
literal|0
condition|)
name|network_id
operator|=
name|ssid
operator|->
name|id
expr_stmt|;
name|wpas_notify_p2p_group_started
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|network_id
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_presence_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|duration1
parameter_list|,
name|u32
name|interval1
parameter_list|,
name|u32
name|duration2
parameter_list|,
name|u32
name|interval2
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|p2p_presence_req
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
name|duration1
argument_list|,
name|interval1
argument_list|,
name|duration2
argument_list|,
name|interval2
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|wpa_s
operator|->
name|waiting_presence_resp
operator|=
literal|1
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_ext_listen
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|unsigned
name|int
name|period
parameter_list|,
name|unsigned
name|int
name|interval
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_ext_listen
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|period
argument_list|,
name|interval
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_is_client
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
block|{
comment|/* 		 * current_ssid can be cleared when P2P client interface gets 		 * disconnected, so assume this interface was used as P2P 		 * client. 		 */
return|return
literal|1
return|;
block|}
return|return
name|wpa_s
operator|->
name|current_ssid
operator|->
name|p2p_group
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_group_idle_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_group_idle
operator|==
literal|0
operator|&&
operator|!
name|wpas_p2p_is_client
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore group idle timeout - "
literal|"disabled"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Group idle timeout reached - terminate "
literal|"group"
argument_list|)
expr_stmt|;
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_IDLE_TIMEOUT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_set_group_idle_timeout
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|timeout
decl_stmt|;
if|if
condition|(
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancelled P2P group idle timeout"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
operator|!
name|wpa_s
operator|->
name|current_ssid
operator|->
name|p2p_group
condition|)
return|return;
name|timeout
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_group_idle
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
operator|&&
operator|(
name|timeout
operator|==
literal|0
operator|||
name|timeout
operator|>
name|P2P_MAX_CLIENT_IDLE
operator|)
condition|)
name|timeout
operator|=
name|P2P_MAX_CLIENT_IDLE
expr_stmt|;
if|if
condition|(
name|timeout
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|timeout
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
condition|)
name|timeout
operator|=
literal|0
expr_stmt|;
comment|/* special client mode no-timeout */
else|else
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
block|{
comment|/* 		 * Use the normal group formation timeout during the 		 * provisioning phase to avoid terminating this process too 		 * early due to group idle timeout. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Do not use P2P group idle timeout "
literal|"during provisioning"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|show_group_started
condition|)
block|{
comment|/* 		 * Use the normal group formation timeout between the end of 		 * the provisioning phase and completion of 4-way handshake to 		 * avoid terminating this process too early due to group idle 		 * timeout. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Do not use P2P group idle timeout "
literal|"while waiting for initial 4-way handshake to "
literal|"complete"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Set P2P group idle timeout to %u seconds"
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|timeout
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Returns 1 if the interface was removed */
end_comment

begin_function
name|int
name|wpas_p2p_deauth_notif
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u16
name|reason_code
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|int
name|locally_generated
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|locally_generated
condition|)
name|p2p_deauth_notif
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|bssid
argument_list|,
name|reason_code
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|reason_code
operator|==
name|WLAN_REASON_DEAUTH_LEAVING
operator|&&
operator|!
name|locally_generated
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|p2p_group
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_INFRA
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO indicated that the P2P Group "
literal|"session is ending"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_GO_ENDING_SESSION
argument_list|)
operator|>
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_disassoc_notif
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|u16
name|reason_code
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|int
name|locally_generated
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|!
name|locally_generated
condition|)
name|p2p_disassoc_notif
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|bssid
argument_list|,
name|reason_code
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_update_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|p2p_data
modifier|*
name|p2p
init|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p
decl_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
operator|!
operator|(
name|wpa_s
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_CAPABLE
operator|)
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_DEVICE_NAME
condition|)
name|p2p_set_dev_name
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_DEVICE_TYPE
condition|)
name|p2p_set_pri_dev_type
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps
operator|&&
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_CONFIG_METHODS
operator|)
condition|)
name|p2p_set_config_methods
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|wps
operator|->
name|config_methods
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps
operator|&&
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_UUID
operator|)
condition|)
name|p2p_set_uuid
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|wps
operator|->
name|uuid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_WPS_STRING
condition|)
block|{
name|p2p_set_manufacturer
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|manufacturer
argument_list|)
expr_stmt|;
name|p2p_set_model_name
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|model_name
argument_list|)
expr_stmt|;
name|p2p_set_model_number
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|model_number
argument_list|)
expr_stmt|;
name|p2p_set_serial_number
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|serial_number
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_SEC_DEVICE_TYPE
condition|)
name|p2p_set_sec_dev_types
argument_list|(
name|p2p
argument_list|,
operator|(
name|void
operator|*
operator|)
name|wpa_s
operator|->
name|conf
operator|->
name|sec_device_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|num_sec_device_types
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_VENDOR_EXTENSION
condition|)
block|{
name|int
name|i
decl_stmt|;
name|p2p_remove_wps_vendor_extensions
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_WPS_VENDOR_EXT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|p2p_add_wps_vendor_extension
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_COUNTRY
operator|)
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
condition|)
block|{
name|char
name|country
index|[
literal|3
index|]
decl_stmt|;
name|country
index|[
literal|0
index|]
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
expr_stmt|;
name|country
index|[
literal|1
index|]
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
expr_stmt|;
name|country
index|[
literal|2
index|]
operator|=
literal|0x04
expr_stmt|;
name|p2p_set_country
argument_list|(
name|p2p
argument_list|,
name|country
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_SSID_POSTFIX
condition|)
block|{
name|p2p_set_ssid_postfix
argument_list|(
name|p2p
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
condition|?
name|os_strlen
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
argument_list|)
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_INTRA_BSS
condition|)
name|p2p_set_intra_bss_dist
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_intra_bss
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_LISTEN_CHANNEL
condition|)
block|{
name|u8
name|reg_class
decl_stmt|,
name|channel
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|unsigned
name|int
name|r
decl_stmt|;
name|u8
name|channel_forced
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_reg_class
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_channel
condition|)
block|{
name|reg_class
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_reg_class
expr_stmt|;
name|channel
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_channel
expr_stmt|;
name|channel_forced
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|reg_class
operator|=
literal|81
expr_stmt|;
comment|/* 			 * Pick one of the social channels randomly as the 			 * listen channel. 			 */
if|if
condition|(
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|channel
operator|=
literal|1
expr_stmt|;
else|else
name|channel
operator|=
literal|1
operator|+
operator|(
name|r
operator|%
literal|3
operator|)
operator|*
literal|5
expr_stmt|;
name|channel_forced
operator|=
literal|0
expr_stmt|;
block|}
name|ret
operator|=
name|p2p_set_listen_channel
argument_list|(
name|p2p
argument_list|,
name|reg_class
argument_list|,
name|channel
argument_list|,
name|channel_forced
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Own listen channel update "
literal|"failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_OPER_CHANNEL
condition|)
block|{
name|u8
name|op_reg_class
decl_stmt|,
name|op_channel
decl_stmt|,
name|cfg_op_channel
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|r
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
condition|)
block|{
name|op_reg_class
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
expr_stmt|;
name|op_channel
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
expr_stmt|;
name|cfg_op_channel
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|op_reg_class
operator|=
literal|81
expr_stmt|;
comment|/* 			 * Use random operation channel from (1, 6, 11) 			 *if no other preference is indicated. 			 */
if|if
condition|(
name|os_get_random
argument_list|(
operator|(
name|u8
operator|*
operator|)
operator|&
name|r
argument_list|,
sizeof|sizeof
argument_list|(
name|r
argument_list|)
argument_list|)
operator|<
literal|0
condition|)
name|op_channel
operator|=
literal|1
expr_stmt|;
else|else
name|op_channel
operator|=
literal|1
operator|+
operator|(
name|r
operator|%
literal|3
operator|)
operator|*
literal|5
expr_stmt|;
name|cfg_op_channel
operator|=
literal|0
expr_stmt|;
block|}
name|ret
operator|=
name|p2p_set_oper_channel
argument_list|(
name|p2p
argument_list|,
name|op_reg_class
argument_list|,
name|op_channel
argument_list|,
name|cfg_op_channel
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Own oper channel update "
literal|"failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_PREF_CHAN
condition|)
block|{
if|if
condition|(
name|p2p_set_pref_chan
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|num_p2p_pref_chan
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_pref_chan
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Preferred channel list "
literal|"update failed"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|p2p_set_no_go_freq
argument_list|(
name|p2p
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_no_go_freq
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: No GO channel list "
literal|"update failed"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_P2P_PASSPHRASE_LEN
condition|)
name|p2p_set_passphrase_len
argument_list|(
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_passphrase_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_set_noa
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|count
parameter_list|,
name|int
name|start
parameter_list|,
name|int
name|duration
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|hostapd_p2p_set_noa
argument_list|(
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|,
name|count
argument_list|,
name|start
argument_list|,
name|duration
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_set_cross_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_s
operator|->
name|global
operator|->
name|cross_connection
operator|=
name|enabled
expr_stmt|;
name|p2p_set_cross_connect
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|enabled
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|enabled
condition|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
for|for
control|(
name|iface
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
name|iface
operator|->
name|cross_connect_enabled
operator|==
literal|0
condition|)
continue|continue;
name|iface
operator|->
name|cross_connect_enabled
operator|=
literal|0
expr_stmt|;
name|iface
operator|->
name|cross_connect_in_use
operator|=
literal|0
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|iface
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_CROSS_CONNECT_DISABLE
literal|"%s %s"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_enable_cross_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|uplink
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
if|if
condition|(
operator|!
name|uplink
operator|->
name|global
operator|->
name|cross_connection
condition|)
return|return;
for|for
control|(
name|iface
operator|=
name|uplink
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
name|iface
operator|->
name|cross_connect_enabled
condition|)
continue|continue;
if|if
condition|(
name|os_strcmp
argument_list|(
name|uplink
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|cross_connect_uplink
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|iface
operator|->
name|ap_iface
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|iface
operator|->
name|cross_connect_in_use
condition|)
continue|continue;
name|iface
operator|->
name|cross_connect_in_use
operator|=
literal|1
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|iface
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_CROSS_CONNECT_ENABLE
literal|"%s %s"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_disable_cross_connect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|uplink
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
for|for
control|(
name|iface
operator|=
name|uplink
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
name|iface
operator|->
name|cross_connect_enabled
condition|)
continue|continue;
if|if
condition|(
name|os_strcmp
argument_list|(
name|uplink
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|cross_connect_uplink
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
operator|!
name|iface
operator|->
name|cross_connect_in_use
condition|)
continue|continue;
name|wpa_msg_global
argument_list|(
name|iface
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_CROSS_CONNECT_DISABLE
literal|"%s %s"
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
name|iface
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
name|iface
operator|->
name|cross_connect_in_use
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpas_p2p_notif_connected
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
operator|||
name|wpa_s
operator|->
name|cross_connect_disallowed
condition|)
name|wpas_p2p_disable_cross_connect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
else|else
name|wpas_p2p_enable_cross_connect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
operator|&&
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Cancelled P2P group idle timeout"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_notif_disconnected
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpas_p2p_disable_cross_connect
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|ap_iface
operator|&&
operator|!
name|eloop_is_timeout_registered
argument_list|(
name|wpas_p2p_group_idle_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
condition|)
name|wpas_p2p_set_group_idle_timeout
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_cross_connect_setup
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|cross_connection
condition|)
return|return;
for|for
control|(
name|iface
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
name|iface
operator|==
name|wpa_s
condition|)
continue|continue;
if|if
condition|(
name|iface
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_DEDICATED_INTERFACE
condition|)
continue|continue;
if|if
condition|(
operator|(
name|iface
operator|->
name|drv_flags
operator|&
name|WPA_DRIVER_FLAGS_P2P_CAPABLE
operator|)
operator|&&
name|iface
operator|!=
name|wpa_s
operator|->
name|parent
condition|)
continue|continue;
name|wpa_s
operator|->
name|cross_connect_enabled
operator|=
literal|1
expr_stmt|;
name|os_strlcpy
argument_list|(
name|wpa_s
operator|->
name|cross_connect_uplink
argument_list|,
name|iface
operator|->
name|ifname
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_s
operator|->
name|cross_connect_uplink
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Enable cross connection from "
literal|"%s to %s whenever uplink is available"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|->
name|ap_iface
operator|||
name|iface
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
name|iface
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
operator|||
name|iface
operator|->
name|cross_connect_disallowed
operator|||
name|iface
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
condition|)
break|break;
name|wpa_s
operator|->
name|cross_connect_in_use
operator|=
literal|1
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_CROSS_CONNECT_ENABLE
literal|"%s %s"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|wpa_s
operator|->
name|cross_connect_uplink
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|wpas_p2p_notif_pbc_overlap
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|p2p_group_interface
operator|!=
name|P2P_GROUP_INTERFACE_CLIENT
operator|&&
operator|!
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
return|return
literal|0
return|;
comment|/* not P2P client operation */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Terminate connection due to WPS PBC "
literal|"session overlap"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|!=
name|wpa_s
operator|->
name|parent
condition|)
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_OVERLAP
argument_list|)
expr_stmt|;
name|wpas_p2p_group_formation_failed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_pbc_overlap_cb
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpas_p2p_notif_pbc_overlap
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_update_channel_list
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|p2p_channels
name|chan
decl_stmt|,
name|cli_chan
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|ifs
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|os_memset
argument_list|(
operator|&
name|chan
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|chan
argument_list|)
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cli_chan
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cli_chan
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpas_p2p_setup_channels
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|chan
argument_list|,
operator|&
name|cli_chan
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to update supported "
literal|"channel list"
argument_list|)
expr_stmt|;
return|return;
block|}
name|p2p_update_channel_list
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
operator|&
name|chan
argument_list|,
operator|&
name|cli_chan
argument_list|)
expr_stmt|;
for|for
control|(
name|ifs
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|ifs
condition|;
name|ifs
operator|=
name|ifs
operator|->
name|next
control|)
block|{
name|int
name|freq
decl_stmt|;
if|if
condition|(
operator|!
name|ifs
operator|->
name|current_ssid
operator|||
operator|!
name|ifs
operator|->
name|current_ssid
operator|->
name|p2p_group
operator|||
operator|(
name|ifs
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|&&
name|ifs
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GROUP_FORMATION
operator|)
condition|)
continue|continue;
name|freq
operator|=
name|ifs
operator|->
name|current_ssid
operator|->
name|frequency
expr_stmt|;
if|if
condition|(
name|freq_included
argument_list|(
operator|&
name|chan
argument_list|,
name|freq
argument_list|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|ifs
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P GO operating frequency %d MHz in valid range"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|wpa_dbg
argument_list|(
name|ifs
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P GO operating in invalid frequency %d MHz"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
comment|/* TODO: Consider using CSA or removing the group within 		 * wpa_supplicant */
name|wpa_msg
argument_list|(
name|ifs
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_REMOVE_AND_REFORM_GROUP
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_scan_res_ignore
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore scan results"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_cancel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|wpa_s
operator|->
name|global
decl_stmt|;
name|int
name|found
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|peer
decl_stmt|;
if|if
condition|(
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Request to cancel group formation"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|pending_interface_name
index|[
literal|0
index|]
operator|&&
operator|!
name|is_zero_ether_addr
argument_list|(
name|wpa_s
operator|->
name|pending_interface_addr
argument_list|)
condition|)
name|found
operator|=
literal|1
expr_stmt|;
name|peer
operator|=
name|p2p_get_go_neg_peer
argument_list|(
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|peer
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unauthorize pending GO Neg peer "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
name|p2p_unauthorize
argument_list|(
name|global
operator|->
name|p2p
argument_list|,
name|peer
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|scan_res_handler
operator|==
name|wpas_p2p_scan_res_join
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Stop pending scan for join"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|scan_res_handler
operator|=
name|wpas_p2p_scan_res_ignore
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|pending_pd_before_join
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Stop pending PD before join"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|pending_pd_before_join
operator|=
literal|0
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
block|}
name|wpas_p2p_stop_find
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|wpa_s
operator|==
name|global
operator|->
name|p2p_group_formation
operator|&&
operator|(
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|||
name|wpa_s
operator|->
name|parent
operator|->
name|pending_interface_type
operator|==
name|WPA_IF_P2P_CLIENT
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Interface %s in group "
literal|"formation found - cancelling"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_in_provisioning
condition|)
block|{
name|wpas_group_formation_completed
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_REQUESTED
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|p2p_in_invitation
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Interface %s in invitation found - cancelling"
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|found
operator|=
literal|1
expr_stmt|;
name|wpas_p2p_group_formation_failed
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|found
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No ongoing group formation found"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_interface_unavailable
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
operator|!
name|wpa_s
operator|->
name|current_ssid
operator|->
name|p2p_group
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove group due to driver resource not "
literal|"being available anymore"
argument_list|)
expr_stmt|;
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_UNAVAILABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_update_best_channels
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq_24
parameter_list|,
name|int
name|freq_5
parameter_list|,
name|int
name|freq_overall
parameter_list|)
block|{
name|struct
name|p2p_data
modifier|*
name|p2p
init|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p
decl_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|p2p_set_best_channels
argument_list|(
name|p2p
argument_list|,
name|freq_24
argument_list|,
name|freq_5
argument_list|,
name|freq_overall
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_unauthorize
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|addr
parameter_list|)
block|{
name|u8
name|peer
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|p2p_data
modifier|*
name|p2p
init|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p
decl_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|addr
argument_list|,
name|peer
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_unauthorize
argument_list|(
name|p2p
argument_list|,
name|peer
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_p2p_disconnect - Disconnect from a P2P Group  * @wpa_s: Pointer to wpa_supplicant data  * Returns: 0 on success, -1 on failure  *  * This can be used to disconnect from a group in which the local end is a P2P  * Client or to end a P2P Group in case the local end is the Group Owner. If a  * virtual network interface was created for this group, that interface will be  * removed. Otherwise, only the configured P2P group network will be removed  * from the interface.  */
end_comment

begin_function
name|int
name|wpas_p2p_disconnect
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_REQUESTED
argument_list|)
operator|<
literal|0
condition|?
operator|-
literal|1
else|:
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_in_progress
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|p2p_in_progress
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Check whether there is an ongoing WPS provisioning step (or 		 * other parts of group formation) on another interface since 		 * p2p_in_progress() does not report this to avoid issues for 		 * scans during such provisioning step. 		 */
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|!=
name|wpa_s
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Another interface (%s) "
literal|"in group formation"
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|->
name|ifname
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|ret
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_go_wait_client
operator|.
name|sec
condition|)
block|{
name|struct
name|os_reltime
name|now
decl_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_reltime_expired
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_go_wait_client
argument_list|,
name|P2P_MAX_INITIAL_CONN_WAIT_GO
argument_list|)
condition|)
block|{
comment|/* Wait for the first client has expired */
name|wpa_s
operator|->
name|global
operator|->
name|p2p_go_wait_client
operator|.
name|sec
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Waiting for initial client connection during group formation"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|1
expr_stmt|;
block|}
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_network_removed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|&&
name|ssid
operator|->
name|p2p_group
operator|&&
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/** 		 * Remove the network by scheduling the group formation 		 * timeout to happen immediately. The teardown code 		 * needs to be scheduled to run asynch later so that we 		 * don't delete data from under ourselves unexpectedly. 		 * Calling wpas_p2p_group_formation_timeout directly 		 * causes a series of crashes in WPS failure scenarios. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Canceled group formation due to "
literal|"P2P group network getting removed"
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|struct
name|wpa_ssid
modifier|*
name|wpas_p2p_get_persistent
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|!=
literal|2
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|&&
operator|(
name|ssid_len
operator|!=
name|s
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|ssid
argument_list|,
name|s
operator|->
name|ssid
argument_list|,
name|ssid_len
argument_list|)
operator|!=
literal|0
operator|)
condition|)
continue|continue;
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|s
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GO
condition|)
return|return
name|s
return|;
continue|continue;
block|}
if|if
condition|(
name|os_memcmp
argument_list|(
name|s
operator|->
name|bssid
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|s
return|;
comment|/* peer is GO in the persistent group */
if|if
condition|(
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|||
name|s
operator|->
name|p2p_client_list
operator|==
name|NULL
condition|)
continue|continue;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|s
operator|->
name|num_p2p_clients
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|s
operator|->
name|p2p_client_list
operator|+
name|i
operator|*
literal|2
operator|*
name|ETH_ALEN
argument_list|,
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|s
return|;
comment|/* peer is P2P client in persistent 					   * group */
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_notify_ap_sta_authorized
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|)
block|{
if|if
condition|(
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_group_formation_timeout
argument_list|,
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/* 		 * This can happen if WPS provisioning step is not terminated 		 * cleanly (e.g., P2P Client does not send WSC_Done). Since the 		 * peer was able to connect, there is no need to time out group 		 * formation after this, though. In addition, this is used with 		 * the initial connection wait on the GO as a separate formation 		 * timeout and as such, expected to be hit after the initial WPS 		 * provisioning step. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Canceled P2P group formation timeout on data connection"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_go_group_formation_completed
operator|&&
operator|!
name|wpa_s
operator|->
name|group_formation_reported
condition|)
block|{
comment|/* 			 * GO has not yet notified group formation success since 			 * the WPS step was not completed cleanly. Do that 			 * notification now since the P2P Client was able to 			 * connect and as such, must have received the 			 * credential from the WPS step. 			 */
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_wps_success_cb
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|wpas_group_formation_completed
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_go_group_formation_completed
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Marking group formation completed on GO on first data connection"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_go_group_formation_completed
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|p2p_in_invitation
operator|=
literal|0
expr_stmt|;
block|}
name|wpa_s
operator|->
name|global
operator|->
name|p2p_go_wait_client
operator|.
name|sec
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|addr
operator|==
name|NULL
condition|)
return|return;
name|wpas_p2p_add_persistent_group_client
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_fallback_to_go_neg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|group_added
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|group
init|=
name|wpa_s
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
condition|)
name|group
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p_group_formation
expr_stmt|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|parent
expr_stmt|;
name|offchannel_send_action_done
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|group_added
condition|)
name|ret
operator|=
name|wpas_p2p_group_delete
argument_list|(
name|group
argument_list|,
name|P2P_GROUP_REMOVAL_SILENT
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Fall back to GO Negotiation"
argument_list|)
expr_stmt|;
name|wpas_p2p_connect
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|wpa_s
operator|->
name|p2p_pin
argument_list|,
name|wpa_s
operator|->
name|p2p_wps_method
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_group
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|p2p_go_intent
argument_list|,
name|wpa_s
operator|->
name|p2p_connect_freq
argument_list|,
name|wpa_s
operator|->
name|p2p_persistent_id
argument_list|,
name|wpa_s
operator|->
name|p2p_pd_before_go_neg
argument_list|,
name|wpa_s
operator|->
name|p2p_go_ht40
argument_list|,
name|wpa_s
operator|->
name|p2p_go_vht
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_scan_no_go_seen
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|p2p_fallback_to_go_neg
operator|||
name|wpa_s
operator|->
name|p2p_in_provisioning
operator|<=
literal|5
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wpas_p2p_peer_go
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|)
operator|>
literal|0
condition|)
return|return
literal|0
return|;
comment|/* peer operating as a GO */
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: GO not found for p2p_connect-auto - "
literal|"fallback to GO Negotiation"
argument_list|)
expr_stmt|;
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_FALLBACK_TO_GO_NEG
literal|"reason=GO-not-found"
argument_list|)
expr_stmt|;
name|res
operator|=
name|wpas_p2p_fallback_to_go_neg
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|res
operator|==
literal|1
condition|?
literal|2
else|:
literal|1
return|;
block|}
end_function

begin_function
name|unsigned
name|int
name|wpas_p2p_search_delay
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|ifs
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>
name|WPA_SCANNING
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use %u ms search delay due to "
literal|"concurrent operation"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_search_delay
argument_list|)
expr_stmt|;
return|return
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_search_delay
return|;
block|}
name|dl_list_for_each
argument_list|(
argument|ifs
argument_list|,
argument|&wpa_s->radio->ifaces
argument_list|,
argument|struct wpa_supplicant
argument_list|,
argument|radio_list
argument_list|)
block|{
if|if
condition|(
name|ifs
operator|!=
name|wpa_s
operator|&&
name|ifs
operator|->
name|wpa_state
operator|>
name|WPA_SCANNING
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Use %u ms search "
literal|"delay due to concurrent operation on "
literal|"interface %s"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_search_delay
argument_list|,
name|ifs
operator|->
name|ifname
argument_list|)
expr_stmt|;
return|return
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_search_delay
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_remove_psk_entry
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|iface_addr
parameter_list|)
block|{
name|struct
name|psk_list_entry
modifier|*
name|psk
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|int
name|changed
init|=
literal|0
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|psk
argument_list|,
argument|tmp
argument_list|,
argument|&s->psk_list
argument_list|,
argument|struct psk_list_entry
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|(
name|iface_addr
operator|&&
operator|!
name|psk
operator|->
name|p2p
operator|&&
name|os_memcmp
argument_list|(
name|addr
argument_list|,
name|psk
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|!
name|iface_addr
operator|&&
name|psk
operator|->
name|p2p
operator|&&
name|os_memcmp
argument_list|(
name|addr
argument_list|,
name|psk
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove persistent group PSK list entry for "
name|MACSTR
literal|" p2p=%u"
argument_list|,
name|MAC2STR
argument_list|(
name|psk
operator|->
name|addr
argument_list|)
argument_list|,
name|psk
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|psk
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|psk
argument_list|)
expr_stmt|;
name|changed
operator|++
expr_stmt|;
block|}
block|}
return|return
name|changed
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_new_psk_cb
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|persistent
decl_stmt|;
name|struct
name|psk_list_entry
modifier|*
name|p
decl_stmt|,
modifier|*
name|last
decl_stmt|;
if|if
condition|(
name|psk_len
operator|!=
sizeof|sizeof
argument_list|(
name|p
operator|->
name|psk
argument_list|)
condition|)
return|return;
if|if
condition|(
name|p2p_dev_addr
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: New PSK for addr="
name|MACSTR
literal|" p2p_dev_addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|p2p_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|p2p_dev_addr
argument_list|)
condition|)
name|p2p_dev_addr
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: New PSK for addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ssid
operator|->
name|mode
operator|==
name|WPAS_MODE_P2P_GROUP_FORMATION
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: new_psk_cb during group formation"
argument_list|)
expr_stmt|;
comment|/* To be added to persistent group once created */
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
operator|==
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
operator|==
name|NULL
condition|)
return|return;
block|}
name|p
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|add_psk
expr_stmt|;
if|if
condition|(
name|p2p_dev_addr
condition|)
block|{
name|p
operator|->
name|p2p
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|addr
argument_list|,
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|p2p
operator|=
literal|0
expr_stmt|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|addr
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|p
operator|->
name|psk
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|||
operator|!
name|ssid
operator|->
name|p2p_persistent_group
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignore new_psk_cb on not-persistent GO"
argument_list|)
expr_stmt|;
return|return;
block|}
name|persistent
operator|=
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|NULL
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|persistent
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not find persistent group information to store the new PSK"
argument_list|)
expr_stmt|;
return|return;
block|}
name|p
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|p2p_dev_addr
condition|)
block|{
name|p
operator|->
name|p2p
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|addr
argument_list|,
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p
operator|->
name|p2p
operator|=
literal|0
expr_stmt|;
name|os_memcpy
argument_list|(
name|p
operator|->
name|addr
argument_list|,
name|mac_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|p
operator|->
name|psk
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_len
argument_list|(
operator|&
name|persistent
operator|->
name|psk_list
argument_list|)
operator|>
name|P2P_MAX_STORED_CLIENTS
operator|&&
operator|(
name|last
operator|=
name|dl_list_last
argument_list|(
operator|&
name|persistent
operator|->
name|psk_list
argument_list|,
expr|struct
name|psk_list_entry
argument_list|,
name|list
argument_list|)
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove oldest PSK entry for "
name|MACSTR
literal|" (p2p=%u) to make room for a new one"
argument_list|,
name|MAC2STR
argument_list|(
name|last
operator|->
name|addr
argument_list|)
argument_list|,
name|last
operator|->
name|p2p
argument_list|)
expr_stmt|;
name|dl_list_del
argument_list|(
operator|&
name|last
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|last
argument_list|)
expr_stmt|;
block|}
name|wpas_p2p_remove_psk_entry
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|persistent
argument_list|,
name|p2p_dev_addr
condition|?
name|p2p_dev_addr
else|:
name|mac_addr
argument_list|,
name|p2p_dev_addr
operator|==
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|p2p_dev_addr
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add new PSK for p2p_dev_addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|p2p_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add new PSK for addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|dl_list_add
argument_list|(
operator|&
name|persistent
operator|->
name|psk_list
argument_list|,
operator|&
name|p
operator|->
name|list
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|parent
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|conf
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to update configuration"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_remove_psk
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|int
name|iface_addr
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|res
operator|=
name|wpas_p2p_remove_psk_entry
argument_list|(
name|wpa_s
argument_list|,
name|s
argument_list|,
name|addr
argument_list|,
name|iface_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|>
literal|0
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|conf
argument_list|)
condition|)
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to update configuration"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_remove_client_go
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|int
name|iface_addr
parameter_list|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|struct
name|hostapd_wpa_psk
modifier|*
name|psk
decl_stmt|,
modifier|*
name|prev
decl_stmt|,
modifier|*
name|rem
decl_stmt|;
name|struct
name|sta_info
modifier|*
name|sta
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
return|return;
comment|/* Remove per-station PSK entry */
name|hapd
operator|=
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
name|prev
operator|=
name|NULL
expr_stmt|;
name|psk
operator|=
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
expr_stmt|;
while|while
condition|(
name|psk
condition|)
block|{
if|if
condition|(
operator|(
name|iface_addr
operator|&&
name|os_memcmp
argument_list|(
name|peer
argument_list|,
name|psk
operator|->
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|!
name|iface_addr
operator|&&
name|os_memcmp
argument_list|(
name|peer
argument_list|,
name|psk
operator|->
name|p2p_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
operator|)
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove operating group PSK entry for "
name|MACSTR
literal|" iface_addr=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|,
name|iface_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|prev
condition|)
name|prev
operator|->
name|next
operator|=
name|psk
operator|->
name|next
expr_stmt|;
else|else
name|hapd
operator|->
name|conf
operator|->
name|ssid
operator|.
name|wpa_psk
operator|=
name|psk
operator|->
name|next
expr_stmt|;
name|rem
operator|=
name|psk
expr_stmt|;
name|psk
operator|=
name|psk
operator|->
name|next
expr_stmt|;
name|os_free
argument_list|(
name|rem
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|prev
operator|=
name|psk
expr_stmt|;
name|psk
operator|=
name|psk
operator|->
name|next
expr_stmt|;
block|}
block|}
comment|/* Disconnect from group */
if|if
condition|(
name|iface_addr
condition|)
name|sta
operator|=
name|ap_get_sta
argument_list|(
name|hapd
argument_list|,
name|peer
argument_list|)
expr_stmt|;
else|else
name|sta
operator|=
name|ap_get_sta_p2p
argument_list|(
name|hapd
argument_list|,
name|peer
argument_list|)
expr_stmt|;
if|if
condition|(
name|sta
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Disconnect peer "
name|MACSTR
literal|" (iface_addr=%d) from group"
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|,
name|iface_addr
argument_list|)
expr_stmt|;
name|hostapd_drv_sta_deauth
argument_list|(
name|hapd
argument_list|,
name|sta
operator|->
name|addr
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|ap_sta_deauthenticate
argument_list|(
name|hapd
argument_list|,
name|sta
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpas_p2p_remove_client
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer
parameter_list|,
name|int
name|iface_addr
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|s
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|w
decl_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Remove client "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|peer
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Remove from any persistent group */
for|for
control|(
name|s
operator|=
name|wpa_s
operator|->
name|parent
operator|->
name|conf
operator|->
name|ssid
init|;
name|s
condition|;
name|s
operator|=
name|s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|s
operator|->
name|disabled
operator|!=
literal|2
operator|||
name|s
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
continue|continue;
if|if
condition|(
operator|!
name|iface_addr
condition|)
name|wpas_remove_persistent_peer
argument_list|(
name|wpa_s
argument_list|,
name|s
argument_list|,
name|peer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpas_p2p_remove_psk
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|s
argument_list|,
name|peer
argument_list|,
name|iface_addr
argument_list|)
expr_stmt|;
block|}
comment|/* Remove from any operating group */
for|for
control|(
name|w
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|w
condition|;
name|w
operator|=
name|w
operator|->
name|next
control|)
name|wpas_p2p_remove_client_go
argument_list|(
name|w
argument_list|,
name|peer
argument_list|,
name|iface_addr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_psk_failure_removal
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_PSK_FAILURE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_group_freq_conflict
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Frequency conflict - terminate group"
argument_list|)
expr_stmt|;
name|wpas_p2p_group_delete
argument_list|(
name|wpa_s
argument_list|,
name|P2P_GROUP_REMOVAL_FREQ_CONFLICT
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_handle_frequency_conflicts
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
for|for
control|(
name|iface
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
name|iface
operator|->
name|current_ssid
operator|||
name|iface
operator|->
name|current_ssid
operator|->
name|frequency
operator|==
name|freq
operator|||
operator|(
name|iface
operator|->
name|p2p_group_interface
operator|==
name|NOT_P2P_GROUP_INTERFACE
operator|&&
operator|!
name|iface
operator|->
name|current_ssid
operator|->
name|p2p_group
operator|)
condition|)
continue|continue;
comment|/* Remove the connection with least priority */
if|if
condition|(
operator|!
name|wpas_is_p2p_prioritized
argument_list|(
name|iface
argument_list|)
condition|)
block|{
comment|/* STA connection has priority over existing 			 * P2P connection, so remove the interface. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Removing P2P connection due to single channel concurrent mode frequency conflict"
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_group_freq_conflict
argument_list|,
name|iface
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* If connection in progress is P2P connection, do not 			 * proceed for the connection. */
if|if
condition|(
name|wpa_s
operator|==
name|iface
condition|)
return|return
operator|-
literal|1
return|;
else|else
return|return
literal|0
return|;
block|}
else|else
block|{
comment|/* P2P connection has priority, disable the STA network 			 */
name|wpa_supplicant_disable_network
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
argument_list|,
name|MSG_INFO
argument_list|,
name|WPA_EVENT_FREQ_CONFLICT
literal|" id=%d"
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
operator|->
name|pending_bssid
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
comment|/* If P2P connection is in progress, continue 			 * connecting...*/
if|if
condition|(
name|wpa_s
operator|==
name|iface
condition|)
return|return
literal|0
return|;
else|else
return|return
operator|-
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_4way_hs_failed
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
operator|!
name|ssid
operator|->
name|p2p_group
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_last_4way_hs_fail
operator|&&
name|wpa_s
operator|->
name|p2p_last_4way_hs_fail
operator|==
name|ssid
condition|)
block|{
name|u8
name|go_dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|persistent
decl_stmt|;
if|if
condition|(
name|wpas_p2p_persistent_group
argument_list|(
name|wpa_s
argument_list|,
name|go_dev_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not determine whether 4-way handshake failures were for a persistent group"
argument_list|)
expr_stmt|;
goto|goto
name|disconnect
goto|;
block|}
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Two 4-way handshake failures for a P2P group - go_dev_addr="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|go_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
name|persistent
operator|=
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|go_dev_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|persistent
operator|==
name|NULL
operator|||
name|persistent
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: No matching persistent group stored"
argument_list|)
expr_stmt|;
goto|goto
name|disconnect
goto|;
block|}
name|wpa_msg_global
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_PERSISTENT_PSK_FAIL
literal|"%d"
argument_list|,
name|persistent
operator|->
name|id
argument_list|)
expr_stmt|;
name|disconnect
label|:
name|wpa_s
operator|->
name|p2p_last_4way_hs_fail
operator|=
name|NULL
expr_stmt|;
comment|/* 		 * Remove the group from a timeout to avoid issues with caller 		 * continuing to use the interface if this is on a P2P group 		 * interface. 		 */
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_psk_failure_removal
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|wpa_s
operator|->
name|p2p_last_4way_hs_fail
operator|=
name|ssid
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
end_ifdef

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wpas_p2p_nfc_handover
parameter_list|(
name|int
name|ndef
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|wsc
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|p2p
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ret
decl_stmt|;
name|size_t
name|wsc_len
decl_stmt|;
if|if
condition|(
name|p2p
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|wsc
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No p2p buffer for handover"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wsc_len
operator|=
name|wsc
condition|?
name|wpabuf_len
argument_list|(
name|wsc
argument_list|)
else|:
literal|0
expr_stmt|;
name|ret
operator|=
name|wpabuf_alloc
argument_list|(
literal|2
operator|+
name|wsc_len
operator|+
literal|2
operator|+
name|wpabuf_len
argument_list|(
name|p2p
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|wsc
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|wpabuf_put_be16
argument_list|(
name|ret
argument_list|,
name|wsc_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wsc
condition|)
name|wpabuf_put_buf
argument_list|(
name|ret
argument_list|,
name|wsc
argument_list|)
expr_stmt|;
name|wpabuf_put_be16
argument_list|(
name|ret
argument_list|,
name|wpabuf_len
argument_list|(
name|p2p
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|ret
argument_list|,
name|p2p
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wsc
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|p2p
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Generated NFC connection handover message"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndef
operator|&&
name|ret
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ndef_build_p2p
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to NDEF encapsulate handover request"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ret
operator|=
name|tmp
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_cli_freq
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
modifier|*
name|ssid
parameter_list|,
name|u8
modifier|*
name|go_dev_addr
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
if|if
condition|(
name|go_dev_addr
condition|)
name|os_memset
argument_list|(
name|go_dev_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
condition|)
operator|*
name|ssid
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|iface
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
name|iface
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATING
operator|||
name|iface
operator|->
name|current_ssid
operator|==
name|NULL
operator|||
name|iface
operator|->
name|assoc_freq
operator|==
literal|0
operator|||
operator|!
name|iface
operator|->
name|current_ssid
operator|->
name|p2p_group
operator|||
name|iface
operator|->
name|current_ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_INFRA
condition|)
continue|continue;
if|if
condition|(
name|ssid
condition|)
operator|*
name|ssid
operator|=
name|iface
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|go_dev_addr
condition|)
name|os_memcpy
argument_list|(
name|go_dev_addr
argument_list|,
name|iface
operator|->
name|go_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
name|iface
operator|->
name|assoc_freq
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wpas_p2p_nfc_handover_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ndef
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wsc
decl_stmt|,
modifier|*
name|p2p
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|u8
name|go_dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|cli_freq
init|=
name|wpas_p2p_cli_freq
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|ssid
argument_list|,
name|go_dev_addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: P2P disabled - cannot build handover request"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
operator|==
name|NULL
operator|&&
name|wps_nfc_gen_dh
argument_list|(
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: No DH key available for handover request"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|cli_freq
operator|==
literal|0
condition|)
block|{
name|wsc
operator|=
name|wps_build_nfc_handover_req_p2p
argument_list|(
name|wpa_s
operator|->
name|parent
operator|->
name|wps
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
block|}
else|else
name|wsc
operator|=
name|NULL
expr_stmt|;
name|p2p
operator|=
name|p2p_build_nfc_handover_req
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|cli_freq
argument_list|,
name|go_dev_addr
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid
else|:
name|NULL
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid_len
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
name|wpas_p2p_nfc_handover
argument_list|(
name|ndef
argument_list|,
name|wsc
argument_list|,
name|p2p
argument_list|)
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wpas_p2p_nfc_handover_sel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ndef
parameter_list|,
name|int
name|tag
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wsc
decl_stmt|,
modifier|*
name|p2p
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|u8
name|go_dev_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|cli_freq
init|=
name|wpas_p2p_cli_freq
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|ssid
argument_list|,
name|go_dev_addr
argument_list|)
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
operator|!
name|tag
operator|&&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
operator|==
name|NULL
operator|&&
name|wps_nfc_gen_dh
argument_list|(
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|cli_freq
operator|==
literal|0
condition|)
block|{
name|wsc
operator|=
name|wps_build_nfc_handover_sel_p2p
argument_list|(
name|wpa_s
operator|->
name|parent
operator|->
name|wps
argument_list|,
name|tag
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
else|:
name|DEV_PW_NFC_CONNECTION_HANDOVER
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
name|tag
condition|?
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
else|:
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
name|wsc
operator|=
name|NULL
expr_stmt|;
name|p2p
operator|=
name|p2p_build_nfc_handover_sel
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|cli_freq
argument_list|,
name|go_dev_addr
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid
else|:
name|NULL
argument_list|,
name|ssid
condition|?
name|ssid
operator|->
name|ssid_len
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
name|wpas_p2p_nfc_handover
argument_list|(
name|ndef
argument_list|,
name|wsc
argument_list|,
name|p2p
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_nfc_join_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_nfc_params
modifier|*
name|params
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Initiate join-group based on NFC "
literal|"connection handover (freq=%d)"
argument_list|,
name|params
operator|->
name|go_freq
argument_list|)
expr_stmt|;
if|if
condition|(
name|params
operator|->
name|go_freq
operator|&&
name|params
operator|->
name|go_ssid_len
condition|)
block|{
name|wpa_s
operator|->
name|p2p_wps_method
operator|=
name|WPS_NFC
expr_stmt|;
name|wpa_s
operator|->
name|pending_join_wps_method
operator|=
name|WPS_NFC
expr_stmt|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|pending_join_iface_addr
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|pending_join_dev_addr
argument_list|,
name|params
operator|->
name|go_dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
return|return
name|wpas_p2p_join_start
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|go_freq
argument_list|,
name|params
operator|->
name|go_ssid
argument_list|,
name|params
operator|->
name|go_ssid_len
argument_list|)
return|;
block|}
return|return
name|wpas_p2p_connect
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|peer
operator|->
name|p2p_device_addr
argument_list|,
name|NULL
argument_list|,
name|WPS_NFC
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_go_intent
argument_list|,
name|params
operator|->
name|go_freq
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_nfc_auth_join
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_nfc_params
modifier|*
name|params
parameter_list|,
name|int
name|tag
parameter_list|)
block|{
name|int
name|res
decl_stmt|,
name|persistent
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Authorize join-group based on NFC "
literal|"connection handover"
argument_list|)
expr_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
name|ssid
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
condition|)
continue|continue;
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|==
name|NULL
condition|)
continue|continue;
break|break;
block|}
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not find GO interface"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw_id
operator|!=
name|DEV_PW_NFC_CONNECTION_HANDOVER
operator|&&
operator|!
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No NFC Dev Pw known"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|res
operator|=
name|wpas_ap_wps_add_nfc_pw
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw_id
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_peer_oob_pk_hash_known
condition|?
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_peer_oob_pubkey_hash
else|:
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
if|if
condition|(
operator|!
name|tag
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Negotiated handover - wait for peer to join without invitation"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|params
operator|->
name|peer
operator|||
operator|!
operator|(
name|params
operator|->
name|peer
operator|->
name|dev_capab
operator|&
name|P2P_DEV_CAPAB_INVITATION_PROCEDURE
operator|)
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Static handover - invite peer "
name|MACSTR
literal|" to join"
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|->
name|peer
operator|->
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|global
operator|->
name|p2p_invite_group
operator|=
name|wpa_s
expr_stmt|;
name|persistent
operator|=
name|ssid
operator|->
name|p2p_persistent_group
operator|&&
name|wpas_p2p_get_persistent
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|params
operator|->
name|peer
operator|->
name|p2p_device_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|parent
operator|->
name|pending_invite_ssid_id
operator|=
operator|-
literal|1
expr_stmt|;
return|return
name|p2p_invite
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|params
operator|->
name|peer
operator|->
name|p2p_device_addr
argument_list|,
name|P2P_INVITE_ROLE_ACTIVE_GO
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|,
name|ssid
operator|->
name|frequency
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|p2p_dev_addr
argument_list|,
name|persistent
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|parent
operator|->
name|p2p_oob_dev_pw_id
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_nfc_init_go_neg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_nfc_params
modifier|*
name|params
parameter_list|,
name|int
name|forced_freq
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Initiate GO Negotiation based on NFC "
literal|"connection handover"
argument_list|)
expr_stmt|;
return|return
name|wpas_p2p_connect
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|peer
operator|->
name|p2p_device_addr
argument_list|,
name|NULL
argument_list|,
name|WPS_NFC
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_go_intent
argument_list|,
name|forced_freq
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_nfc_resp_go_neg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|p2p_nfc_params
modifier|*
name|params
parameter_list|,
name|int
name|forced_freq
parameter_list|)
block|{
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Authorize GO Negotiation based on NFC "
literal|"connection handover"
argument_list|)
expr_stmt|;
name|res
operator|=
name|wpas_p2p_connect
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|->
name|peer
operator|->
name|p2p_device_addr
argument_list|,
name|NULL
argument_list|,
name|WPS_NFC
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_go_intent
argument_list|,
name|forced_freq
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
name|res
operator|=
name|wpas_p2p_listen
argument_list|(
name|wpa_s
argument_list|,
literal|60
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
block|{
name|p2p_unauthorize
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|params
operator|->
name|peer
operator|->
name|p2p_device_addr
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_p2p_nfc_connection_handover
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|data
parameter_list|,
name|int
name|sel
parameter_list|,
name|int
name|tag
parameter_list|,
name|int
name|forced_freq
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u16
name|len
decl_stmt|,
name|id
decl_stmt|;
name|struct
name|p2p_nfc_params
name|params
decl_stmt|;
name|int
name|res
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|params
operator|.
name|sel
operator|=
name|sel
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Received NFC tag payload"
argument_list|,
name|data
argument_list|)
expr_stmt|;
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|data
argument_list|)
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|wpabuf_len
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Not enough data for Length of WSC "
literal|"attributes"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|end
operator|-
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Not enough data for WSC "
literal|"attributes"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|params
operator|.
name|wsc_attr
operator|=
name|pos
expr_stmt|;
name|params
operator|.
name|wsc_len
operator|=
name|len
expr_stmt|;
name|pos
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|end
operator|-
name|pos
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Not enough data for Length of P2P "
literal|"attributes"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|end
operator|-
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Not enough data for P2P "
literal|"attributes"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|params
operator|.
name|p2p_attr
operator|=
name|pos
expr_stmt|;
name|params
operator|.
name|p2p_len
operator|=
name|len
expr_stmt|;
name|pos
operator|+=
name|len
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: WSC attributes"
argument_list|,
name|params
operator|.
name|wsc_attr
argument_list|,
name|params
operator|.
name|wsc_len
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: P2P attributes"
argument_list|,
name|params
operator|.
name|p2p_attr
argument_list|,
name|params
operator|.
name|p2p_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Ignored extra data after P2P attributes"
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
block|}
name|res
operator|=
name|p2p_process_nfc_connection_handover
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
condition|)
return|return
name|res
return|;
if|if
condition|(
name|params
operator|.
name|next_step
operator|==
name|NO_ACTION
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|params
operator|.
name|next_step
operator|==
name|BOTH_GO
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_NFC_BOTH_GO
literal|"peer="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|.
name|peer
operator|->
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|params
operator|.
name|next_step
operator|==
name|PEER_CLIENT
condition|)
block|{
if|if
condition|(
operator|!
name|is_zero_ether_addr
argument_list|(
name|params
operator|.
name|go_dev_addr
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_NFC_PEER_CLIENT
literal|"peer="
name|MACSTR
literal|" freq=%d go_dev_addr="
name|MACSTR
literal|" ssid=\"%s\""
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|.
name|peer
operator|->
name|p2p_device_addr
argument_list|)
argument_list|,
name|params
operator|.
name|go_freq
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|.
name|go_dev_addr
argument_list|)
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|params
operator|.
name|go_ssid
argument_list|,
name|params
operator|.
name|go_ssid_len
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_NFC_PEER_CLIENT
literal|"peer="
name|MACSTR
literal|" freq=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|.
name|peer
operator|->
name|p2p_device_addr
argument_list|)
argument_list|,
name|params
operator|.
name|go_freq
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
if|if
condition|(
name|wpas_p2p_cli_freq
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_NFC_WHILE_CLIENT
literal|"peer="
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|params
operator|.
name|peer
operator|->
name|p2p_device_addr
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|p2p_oob_dev_pw
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_oob_dev_pw
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|params
operator|.
name|oob_dev_pw_len
operator|<
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No peer OOB Dev Pw "
literal|"received"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|id
operator|=
name|WPA_GET_BE16
argument_list|(
name|params
operator|.
name|oob_dev_pw
operator|+
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer OOB Dev Pw %u"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer OOB Public Key hash"
argument_list|,
name|params
operator|.
name|oob_dev_pw
argument_list|,
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|p2p_peer_oob_pubkey_hash
argument_list|,
name|params
operator|.
name|oob_dev_pw
argument_list|,
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_peer_oob_pk_hash_known
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|tag
condition|)
block|{
if|if
condition|(
name|id
operator|<
literal|0x10
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Static handover - invalid "
literal|"peer OOB Device Password Id %u"
argument_list|,
name|id
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Static handover - use peer OOB "
literal|"Device Password Id %u"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Peer OOB Device Password"
argument_list|,
name|params
operator|.
name|oob_dev_pw
operator|+
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|2
argument_list|,
name|params
operator|.
name|oob_dev_pw_len
operator|-
name|WPS_OOB_PUBKEY_HASH_LEN
operator|-
literal|2
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_oob_dev_pw_id
operator|=
name|id
expr_stmt|;
name|wpa_s
operator|->
name|p2p_oob_dev_pw
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|params
operator|.
name|oob_dev_pw
operator|+
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|2
argument_list|,
name|params
operator|.
name|oob_dev_pw_len
operator|-
name|WPS_OOB_PUBKEY_HASH_LEN
operator|-
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_oob_dev_pw
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
operator|==
name|NULL
operator|&&
name|wps_nfc_gen_dh
argument_list|(
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Using abbreviated WPS handshake "
literal|"without Device Password"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_oob_dev_pw_id
operator|=
name|DEV_PW_NFC_CONNECTION_HANDOVER
expr_stmt|;
block|}
switch|switch
condition|(
name|params
operator|.
name|next_step
condition|)
block|{
case|case
name|NO_ACTION
case|:
case|case
name|BOTH_GO
case|:
case|case
name|PEER_CLIENT
case|:
comment|/* already covered above */
return|return
literal|0
return|;
case|case
name|JOIN_GROUP
case|:
return|return
name|wpas_p2p_nfc_join_group
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
return|;
case|case
name|AUTH_JOIN
case|:
return|return
name|wpas_p2p_nfc_auth_join
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
name|tag
argument_list|)
return|;
case|case
name|INIT_GO_NEG
case|:
return|return
name|wpas_p2p_nfc_init_go_neg
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
name|forced_freq
argument_list|)
return|;
case|case
name|RESP_GO_NEG
case|:
comment|/* TODO: use own OOB Dev Pw */
return|return
name|wpas_p2p_nfc_resp_go_neg
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|,
name|forced_freq
argument_list|)
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_nfc_tag_process
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|data
parameter_list|,
name|int
name|forced_freq
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|wpas_p2p_nfc_connection_handover
argument_list|(
name|wpa_s
argument_list|,
name|data
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|,
name|forced_freq
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_nfc_report_handover
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|init
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|req
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|sel
parameter_list|,
name|int
name|forced_freq
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|tmp
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NFC: P2P connection handover reported"
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NFC: Req"
argument_list|,
name|wpabuf_head
argument_list|(
name|req
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|req
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NFC: Sel"
argument_list|,
name|wpabuf_head
argument_list|(
name|sel
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|sel
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|forced_freq
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NFC: Forced freq %d"
argument_list|,
name|forced_freq
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ndef_parse_p2p
argument_list|(
name|init
condition|?
name|sel
else|:
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Could not parse NDEF"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ret
operator|=
name|wpas_p2p_nfc_connection_handover
argument_list|(
name|wpa_s
argument_list|,
name|tmp
argument_list|,
name|init
argument_list|,
literal|0
argument_list|,
name|forced_freq
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_nfc_tag_enabled
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|enabled
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|if_addr
decl_stmt|;
name|int
name|go_intent
init|=
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_go_intent
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|iface
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|!
name|enabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Disable use of own NFC Tag"
argument_list|)
expr_stmt|;
for|for
control|(
name|iface
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
name|iface
operator|->
name|ap_iface
condition|)
continue|continue;
name|hostapd_wps_nfc_token_disable
argument_list|(
name|iface
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
block|}
name|p2p_set_authorized_oob_dev_pw_id
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_nfc_tag_enabled
condition|)
name|wpas_p2p_remove_pending_group_interface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_nfc_tag_enabled
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
operator|<
literal|0x10
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: NFC password token not configured "
literal|"to allow static handover cases"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Enable use of own NFC Tag"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_oob_dev_pw_id
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|p2p_oob_dev_pw
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_oob_dev_pw
operator|=
name|wpabuf_dup
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_oob_dev_pw
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_s
operator|->
name|p2p_peer_oob_pk_hash_known
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|p2p_group_interface
operator|==
name|P2P_GROUP_INTERFACE_GO
operator|||
name|wpa_s
operator|->
name|p2p_group_interface
operator|==
name|P2P_GROUP_INTERFACE_CLIENT
condition|)
block|{
comment|/* 		 * P2P Group Interface present and the command came on group 		 * interface, so enable the token for the current interface. 		 */
name|wpa_s
operator|->
name|create_p2p_iface
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|wpa_s
operator|->
name|create_p2p_iface
operator|=
name|wpas_p2p_create_iface
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|create_p2p_iface
condition|)
block|{
name|enum
name|wpa_driver_if_type
name|iftype
decl_stmt|;
comment|/* Prepare to add a new interface for the group */
name|iftype
operator|=
name|WPA_IF_P2P_GROUP
expr_stmt|;
if|if
condition|(
name|go_intent
operator|==
literal|15
condition|)
name|iftype
operator|=
name|WPA_IF_P2P_GO
expr_stmt|;
if|if
condition|(
name|wpas_p2p_add_group_interface
argument_list|(
name|wpa_s
argument_list|,
name|iftype
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"P2P: Failed to allocate a new "
literal|"interface for the group"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|if_addr
operator|=
name|wpa_s
operator|->
name|pending_interface_addr
expr_stmt|;
block|}
else|else
name|if_addr
operator|=
name|wpa_s
operator|->
name|own_addr
expr_stmt|;
name|wpa_s
operator|->
name|p2p_nfc_tag_enabled
operator|=
name|enabled
expr_stmt|;
for|for
control|(
name|iface
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
init|;
name|iface
condition|;
name|iface
operator|=
name|iface
operator|->
name|next
control|)
block|{
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
if|if
condition|(
name|iface
operator|->
name|ap_iface
operator|==
name|NULL
condition|)
continue|continue;
name|hapd
operator|=
name|iface
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
operator|=
name|wpabuf_dup
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
operator|=
name|wpabuf_dup
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
operator|=
name|wpabuf_dup
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
argument_list|)
expr_stmt|;
name|hapd
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
expr_stmt|;
if|if
condition|(
name|hostapd_wps_nfc_token_enable
argument_list|(
name|iface
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|iface
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Failed to enable NFC Tag for GO"
argument_list|)
expr_stmt|;
block|}
block|}
name|p2p_set_authorized_oob_dev_pw_id
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
argument_list|,
name|go_intent
argument_list|,
name|if_addr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_NFC */
end_comment

begin_function
specifier|static
name|void
name|wpas_p2p_optimize_listen_channel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_used_freq_data
modifier|*
name|freqs
parameter_list|,
name|unsigned
name|int
name|num
parameter_list|)
block|{
name|u8
name|curr_chan
decl_stmt|,
name|cand
decl_stmt|,
name|chan
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|curr_chan
operator|=
name|p2p_get_listen_channel
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|cand
operator|=
literal|0
init|;
name|i
operator|<
name|num
condition|;
name|i
operator|++
control|)
block|{
name|ieee80211_freq_to_chan
argument_list|(
name|freqs
index|[
name|i
index|]
operator|.
name|freq
argument_list|,
operator|&
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr_chan
operator|==
name|chan
condition|)
block|{
name|cand
operator|=
literal|0
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|chan
operator|==
literal|1
operator|||
name|chan
operator|==
literal|6
operator|||
name|chan
operator|==
literal|11
condition|)
name|cand
operator|=
name|chan
expr_stmt|;
block|}
if|if
condition|(
name|cand
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Update Listen channel to %u based on operating channel"
argument_list|,
name|cand
argument_list|)
expr_stmt|;
name|p2p_set_listen_channel
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
literal|81
argument_list|,
name|cand
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpas_p2p_indicate_state_change
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_used_freq_data
modifier|*
name|freqs
decl_stmt|;
name|unsigned
name|int
name|num
init|=
name|wpa_s
operator|->
name|num_multichan_concurrent
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
comment|/* 	 * If possible, optimize the Listen channel to be a channel that is 	 * already used by one of the other interfaces. 	 */
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_optimize_listen_chan
condition|)
return|return;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|current_ssid
operator|||
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
condition|)
return|return;
name|freqs
operator|=
name|os_calloc
argument_list|(
name|num
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wpa_used_freq_data
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|freqs
condition|)
return|return;
name|num
operator|=
name|get_shared_radio_freqs_data
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|wpas_p2p_optimize_listen_channel
argument_list|(
name|wpa_s
argument_list|,
name|freqs
argument_list|,
name|num
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_deinit_iface
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|==
name|wpa_s
operator|->
name|global
operator|->
name|p2p_init_wpa_s
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"P2P: Disable P2P since removing "
literal|"the management interface is being removed"
argument_list|)
expr_stmt|;
name|wpas_p2p_deinit_global
argument_list|(
name|wpa_s
operator|->
name|global
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wpas_p2p_ap_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
condition|)
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|p2p_group
operator|=
name|NULL
expr_stmt|;
name|wpas_p2p_group_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


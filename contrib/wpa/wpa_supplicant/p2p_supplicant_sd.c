begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant - P2P service discovery  * Copyright (c) 2009-2010, Atheros Communications  * Copyright (c) 2010-2014, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"p2p/p2p.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"p2p_supplicant.h"
end_include

begin_comment
comment|/*  * DNS Header section is used only to calculate compression pointers, so the  * contents of this data does not matter, but the length needs to be reserved  * in the virtual packet.  */
end_comment

begin_define
define|#
directive|define
name|DNS_HEADER_LEN
value|12
end_define

begin_comment
comment|/*  * 27-octet in-memory packet from P2P specification containing two implied  * queries for _tcp.lcoal. PTR IN and _udp.local. PTR IN  */
end_comment

begin_define
define|#
directive|define
name|P2P_SD_IN_MEMORY_LEN
value|27
end_define

begin_function
specifier|static
name|int
name|p2p_sd_dns_uncompress_label
parameter_list|(
name|char
modifier|*
modifier|*
name|upos
parameter_list|,
name|char
modifier|*
name|uend
parameter_list|,
name|u8
modifier|*
name|start
parameter_list|,
name|u8
modifier|*
modifier|*
name|spos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|)
block|{
while|while
condition|(
operator|*
name|spos
operator|<
name|end
condition|)
block|{
name|u8
name|val
init|=
operator|(
operator|(
operator|*
name|spos
operator|)
index|[
literal|0
index|]
operator|&
literal|0xc0
operator|)
operator|>>
literal|6
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|val
operator|==
literal|1
operator|||
name|val
operator|==
literal|2
condition|)
block|{
comment|/* These are reserved values in RFC 1035 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid domain name "
literal|"sequence starting with 0x%x"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|val
operator|==
literal|3
condition|)
block|{
name|u16
name|offset
decl_stmt|;
name|u8
modifier|*
name|spos_tmp
decl_stmt|;
comment|/* Offset */
if|if
condition|(
operator|*
name|spos
operator|+
literal|2
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No room for full "
literal|"DNS offset field"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|offset
operator|=
operator|(
operator|(
operator|(
operator|*
name|spos
operator|)
index|[
literal|0
index|]
operator|&
literal|0x3f
operator|)
operator|<<
literal|8
operator|)
operator||
operator|(
operator|*
name|spos
operator|)
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|offset
operator|>=
operator|*
name|spos
operator|-
name|start
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid DNS "
literal|"pointer offset %u"
argument_list|,
name|offset
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
operator|(
operator|*
name|spos
operator|)
operator|+=
literal|2
expr_stmt|;
name|spos_tmp
operator|=
name|start
operator|+
name|offset
expr_stmt|;
return|return
name|p2p_sd_dns_uncompress_label
argument_list|(
name|upos
argument_list|,
name|uend
argument_list|,
name|start
argument_list|,
operator|&
name|spos_tmp
argument_list|,
operator|*
name|spos
operator|-
literal|2
argument_list|)
return|;
block|}
comment|/* Label */
name|len
operator|=
operator|(
operator|*
name|spos
operator|)
index|[
literal|0
index|]
operator|&
literal|0x3f
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
return|return
literal|0
return|;
operator|(
operator|*
name|spos
operator|)
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|spos
operator|+
name|len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Invalid domain name "
literal|"sequence - no room for label with length "
literal|"%u"
argument_list|,
name|len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
operator|*
name|upos
operator|+
name|len
operator|+
literal|2
operator|>
name|uend
condition|)
return|return
operator|-
literal|2
return|;
name|os_memcpy
argument_list|(
operator|*
name|upos
argument_list|,
operator|*
name|spos
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|spos
operator|+=
name|len
expr_stmt|;
operator|*
name|upos
operator|+=
name|len
expr_stmt|;
operator|(
operator|*
name|upos
operator|)
index|[
literal|0
index|]
operator|=
literal|'.'
expr_stmt|;
operator|(
operator|*
name|upos
operator|)
operator|++
expr_stmt|;
operator|(
operator|*
name|upos
operator|)
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Uncompress domain names per RFC 1035 using the P2P SD in-memory packet.  * Returns -1 on parsing error (invalid input sequence), -2 if output buffer is  * not large enough */
end_comment

begin_function
specifier|static
name|int
name|p2p_sd_dns_uncompress
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|size_t
name|buf_len
parameter_list|,
specifier|const
name|u8
modifier|*
name|msg
parameter_list|,
name|size_t
name|msg_len
parameter_list|,
name|size_t
name|offset
parameter_list|)
block|{
comment|/* 27-octet in-memory packet from P2P specification */
specifier|const
name|char
modifier|*
name|prefix
init|=
literal|"\x04_tcp\x05local\x00\x00\x0C\x00\x01"
literal|"\x04_udp\xC0\x11\x00\x0C\x00\x01"
decl_stmt|;
name|u8
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|spos
decl_stmt|;
name|char
modifier|*
name|upos
decl_stmt|,
modifier|*
name|uend
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|buf_len
operator|<
literal|2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|offset
operator|>
name|msg_len
condition|)
return|return
operator|-
literal|1
return|;
name|tmp
operator|=
name|os_malloc
argument_list|(
name|DNS_HEADER_LEN
operator|+
name|P2P_SD_IN_MEMORY_LEN
operator|+
name|msg_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|spos
operator|=
name|tmp
operator|+
name|DNS_HEADER_LEN
operator|+
name|P2P_SD_IN_MEMORY_LEN
expr_stmt|;
name|end
operator|=
name|spos
operator|+
name|msg_len
expr_stmt|;
name|spos
operator|+=
name|offset
expr_stmt|;
name|os_memset
argument_list|(
name|tmp
argument_list|,
literal|0
argument_list|,
name|DNS_HEADER_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|tmp
operator|+
name|DNS_HEADER_LEN
argument_list|,
name|prefix
argument_list|,
name|P2P_SD_IN_MEMORY_LEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|tmp
operator|+
name|DNS_HEADER_LEN
operator|+
name|P2P_SD_IN_MEMORY_LEN
argument_list|,
name|msg
argument_list|,
name|msg_len
argument_list|)
expr_stmt|;
name|upos
operator|=
name|buf
expr_stmt|;
name|uend
operator|=
name|buf
operator|+
name|buf_len
expr_stmt|;
name|ret
operator|=
name|p2p_sd_dns_uncompress_label
argument_list|(
operator|&
name|upos
argument_list|,
name|uend
argument_list|,
name|tmp
argument_list|,
operator|&
name|spos
argument_list|,
name|end
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
if|if
condition|(
name|upos
operator|==
name|buf
condition|)
block|{
name|upos
index|[
literal|0
index|]
operator|=
literal|'.'
expr_stmt|;
name|upos
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|upos
index|[
operator|-
literal|1
index|]
operator|==
literal|'.'
condition|)
name|upos
index|[
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|p2p_srv_bonjour
modifier|*
name|wpas_p2p_service_get_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|len
operator|=
name|wpabuf_len
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|bsrv
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|len
operator|==
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|&&
name|os_memcmp
argument_list|(
name|wpabuf_head
argument_list|(
name|query
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
argument_list|,
name|len
argument_list|)
operator|==
literal|0
condition|)
return|return
name|bsrv
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|p2p_srv_upnp
modifier|*
name|wpas_p2p_service_get_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|dl_list_for_each
argument_list|(
argument|usrv
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|version
operator|==
name|usrv
operator|->
name|version
operator|&&
name|os_strcmp
argument_list|(
name|service
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
operator|==
literal|0
condition|)
return|return
name|usrv
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_add_empty
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_proto
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
name|u8
name|status
parameter_list|)
block|{
name|u8
modifier|*
name|len_pos
decl_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|status
argument_list|)
expr_stmt|;
comment|/* Response Data: empty */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_add_proto_not_avail
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_proto
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|wpas_sd_add_empty
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|,
name|srv_trans_id
argument_list|,
name|P2P_SD_PROTO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_add_bad_request
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_proto
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|wpas_sd_add_empty
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|,
name|srv_trans_id
argument_list|,
name|P2P_SD_BAD_REQUEST
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_add_not_found
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_proto
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|wpas_sd_add_empty
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|,
name|srv_trans_id
argument_list|,
name|P2P_SD_REQUESTED_INFO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_all_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for all Bonjour services"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Bonjour protocol not available"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|bsrv
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching Bonjour service"
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|bsrv
operator|->
name|query
argument_list|)
expr_stmt|;
comment|/* Key */
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|bsrv
operator|->
name|resp
argument_list|)
expr_stmt|;
comment|/* Value */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|match_bonjour_query
parameter_list|(
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|char
name|str_rx
index|[
literal|256
index|]
decl_stmt|,
name|str_srv
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|query_len
operator|<
literal|3
operator|||
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|<
literal|3
condition|)
return|return
literal|0
return|;
comment|/* Too short to include DNS Type and Version */
if|if
condition|(
name|os_memcmp
argument_list|(
name|query
operator|+
name|query_len
operator|-
literal|3
argument_list|,
name|wpabuf_head_u8
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|-
literal|3
argument_list|,
literal|3
argument_list|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
comment|/* Mismatch in DNS Type or Version */
if|if
condition|(
name|query_len
operator|==
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|&&
name|os_memcmp
argument_list|(
name|query
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
argument_list|,
name|query_len
operator|-
literal|3
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
comment|/* Binary match */
if|if
condition|(
name|p2p_sd_dns_uncompress
argument_list|(
name|str_rx
argument_list|,
sizeof|sizeof
argument_list|(
name|str_rx
argument_list|)
argument_list|,
name|query
argument_list|,
name|query_len
operator|-
literal|3
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Failed to uncompress query */
if|if
condition|(
name|p2p_sd_dns_uncompress
argument_list|(
name|str_srv
argument_list|,
sizeof|sizeof
argument_list|(
name|str_srv
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
operator|-
literal|3
argument_list|,
literal|0
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Failed to uncompress service */
return|return
name|os_strcmp
argument_list|(
name|str_rx
argument_list|,
name|str_srv
argument_list|)
operator|==
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_req_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|int
name|matches
init|=
literal|0
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for Bonjour"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Bonjour protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|query_len
operator|==
literal|0
condition|)
block|{
name|wpas_sd_all_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|bsrv
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
operator|!
name|match_bonjour_query
argument_list|(
name|bsrv
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
operator|+
name|query_len
operator|+
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
condition|)
return|return;
name|matches
operator|++
expr_stmt|;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching Bonjour service"
argument_list|,
name|wpabuf_head
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_data
argument_list|(
name|resp
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
comment|/* Key */
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|bsrv
operator|->
name|resp
argument_list|)
expr_stmt|;
comment|/* Value */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|matches
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested Bonjour service not "
literal|"available"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_BONJOUR
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_REQUESTED_INFO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
comment|/* Response Data: empty */
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_all_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for all UPnP services"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: UPnP protocol not available"
argument_list|)
expr_stmt|;
return|return;
block|}
name|dl_list_for_each
argument_list|(
argument|usrv
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|usrv
operator|->
name|service
argument_list|)
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_UPNP
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|usrv
operator|->
name|version
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching UPnP Service: %s"
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|resp
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_req_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|u8
name|version
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for UPnP"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: UPnP protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_UPNP
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|query_len
operator|==
literal|0
condition|)
block|{
name|wpas_sd_all_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_UPNP
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|version
operator|=
name|query
index|[
literal|0
index|]
expr_stmt|;
name|str
operator|=
name|os_malloc
argument_list|(
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|==
name|NULL
condition|)
return|return;
name|os_memcpy
argument_list|(
name|str
argument_list|,
name|query
operator|+
literal|1
argument_list|,
name|query_len
operator|-
literal|1
argument_list|)
expr_stmt|;
name|str
index|[
name|query_len
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|dl_list_for_each
argument_list|(
argument|usrv
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|version
operator|!=
name|usrv
operator|->
name|version
condition|)
continue|continue;
if|if
condition|(
name|os_strcmp
argument_list|(
name|str
argument_list|,
literal|"ssdp:all"
argument_list|)
operator|!=
literal|0
operator|&&
name|os_strstr
argument_list|(
name|usrv
operator|->
name|service
argument_list|,
name|str
argument_list|)
operator|==
name|NULL
condition|)
continue|continue;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|2
condition|)
break|break;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Response Data */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|version
argument_list|)
expr_stmt|;
block|}
else|else
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
literal|','
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Matching UPnP Service: %s"
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
name|os_strlen
argument_list|(
name|usrv
operator|->
name|service
argument_list|)
condition|)
break|break;
name|wpabuf_put_str
argument_list|(
name|resp
argument_list|,
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|count
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Requested UPnP service not "
literal|"available"
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_REQUESTED_INFO_NOT_AVAILABLE
argument_list|)
expr_stmt|;
comment|/* Response Data: empty */
block|}
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
end_ifdef

begin_function
specifier|static
name|void
name|wpas_sd_req_wfd
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|u8
name|role
decl_stmt|;
name|u8
modifier|*
name|len_pos
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for WFD"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|wifi_display
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: WFD protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_WIFI_DISPLAY
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|query_len
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Missing WFD Requested Device "
literal|"Role"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
literal|5
condition|)
return|return;
name|pos
operator|=
name|query
expr_stmt|;
name|role
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: WSD for device role 0x%x"
argument_list|,
name|role
argument_list|)
expr_stmt|;
comment|/* TODO: role specific handling */
comment|/* Length (to be filled) */
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_WIFI_DISPLAY
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
comment|/* Status Code */
while|while
condition|(
name|pos
operator|<
name|query
operator|+
name|query_len
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|<
name|MAX_WFD_SUBELEMS
operator|&&
name|wpa_s
operator|->
name|global
operator|->
name|wfd_subelem
index|[
operator|*
name|pos
index|]
operator|&&
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|>=
name|wpabuf_len
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|wfd_subelem
index|[
operator|*
name|pos
index|]
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add WSD response "
literal|"subelement %u"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|wpabuf_put_buf
argument_list|(
name|resp
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|wfd_subelem
index|[
operator|*
name|pos
index|]
argument_list|)
expr_stmt|;
block|}
name|pos
operator|++
expr_stmt|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WIFI_DISPLAY */
end_comment

begin_function
specifier|static
name|int
name|find_p2ps_substr
parameter_list|(
name|struct
name|p2ps_advertisement
modifier|*
name|adv_data
parameter_list|,
specifier|const
name|u8
modifier|*
name|needle
parameter_list|,
name|size_t
name|needle_len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|haystack
init|=
operator|(
specifier|const
name|u8
operator|*
operator|)
name|adv_data
operator|->
name|svc_info
decl_stmt|;
name|size_t
name|haystack_len
decl_stmt|,
name|i
decl_stmt|;
comment|/* Allow search term to be empty */
if|if
condition|(
operator|!
name|needle
operator|||
operator|!
name|needle_len
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|haystack
condition|)
return|return
literal|0
return|;
name|haystack_len
operator|=
name|os_strlen
argument_list|(
name|adv_data
operator|->
name|svc_info
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|haystack_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|haystack_len
operator|-
name|i
operator|<
name|needle_len
condition|)
break|break;
if|if
condition|(
name|os_memcmp
argument_list|(
name|haystack
operator|+
name|i
argument_list|,
name|needle
argument_list|,
name|needle_len
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_req_asp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|query
parameter_list|,
name|size_t
name|query_len
parameter_list|)
block|{
name|struct
name|p2ps_advertisement
modifier|*
name|adv_data
decl_stmt|;
specifier|const
name|u8
modifier|*
name|svc
init|=
operator|&
name|query
index|[
literal|1
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|info
init|=
name|NULL
decl_stmt|;
name|size_t
name|svc_len
init|=
name|query
index|[
literal|0
index|]
decl_stmt|;
name|size_t
name|info_len
init|=
literal|0
decl_stmt|;
name|int
name|prefix
init|=
literal|0
decl_stmt|;
name|u8
modifier|*
name|count_pos
init|=
name|NULL
decl_stmt|;
name|u8
modifier|*
name|len_pos
init|=
name|NULL
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD Request for ASP"
argument_list|,
name|query
argument_list|,
name|query_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: ASP protocol not available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_P2PS
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Info block is optional */
if|if
condition|(
name|svc_len
operator|+
literal|1
operator|<
name|query_len
condition|)
block|{
name|info
operator|=
operator|&
name|svc
index|[
name|svc_len
index|]
expr_stmt|;
name|info_len
operator|=
operator|*
name|info
operator|++
expr_stmt|;
block|}
comment|/* Range check length of svc string and info block */
if|if
condition|(
name|svc_len
operator|+
operator|(
name|info_len
condition|?
name|info_len
operator|+
literal|2
else|:
literal|1
operator|)
operator|>
name|query_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: ASP bad request"
argument_list|)
expr_stmt|;
name|wpas_sd_add_bad_request
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_P2PS
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Detect and correct for prefix search */
if|if
condition|(
name|svc_len
operator|&&
name|svc
index|[
name|svc_len
operator|-
literal|1
index|]
operator|==
literal|'*'
condition|)
block|{
name|prefix
operator|=
literal|1
expr_stmt|;
name|svc_len
operator|--
expr_stmt|;
block|}
for|for
control|(
name|adv_data
operator|=
name|p2p_get_p2ps_adv_list
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
init|;
name|adv_data
condition|;
name|adv_data
operator|=
name|adv_data
operator|->
name|next
control|)
block|{
comment|/* If not a prefix match, reject length mismatches */
if|if
condition|(
operator|!
name|prefix
operator|&&
name|svc_len
operator|!=
name|os_strlen
argument_list|(
name|adv_data
operator|->
name|svc_name
argument_list|)
condition|)
continue|continue;
comment|/* Search each service for request */
if|if
condition|(
name|os_memcmp
argument_list|(
name|adv_data
operator|->
name|svc_name
argument_list|,
name|svc
argument_list|,
name|svc_len
argument_list|)
operator|==
literal|0
operator|&&
name|find_p2ps_substr
argument_list|(
name|adv_data
argument_list|,
name|info
argument_list|,
name|info_len
argument_list|)
condition|)
block|{
name|size_t
name|len
init|=
name|os_strlen
argument_list|(
name|adv_data
operator|->
name|svc_name
argument_list|)
decl_stmt|;
name|size_t
name|svc_info_len
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|adv_data
operator|->
name|svc_info
condition|)
name|svc_info_len
operator|=
name|os_strlen
argument_list|(
name|adv_data
operator|->
name|svc_info
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0xff
operator|||
name|svc_info_len
operator|>
literal|0xffff
condition|)
return|return;
comment|/* Length& Count to be filled as we go */
if|if
condition|(
operator|!
name|len_pos
operator|&&
operator|!
name|count_pos
condition|)
block|{
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
name|len
operator|+
name|svc_info_len
operator|+
literal|16
condition|)
return|return;
name|len_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_P2PS
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
comment|/* Status Code */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|P2P_SD_SUCCESS
argument_list|)
expr_stmt|;
name|count_pos
operator|=
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|1
argument_list|)
expr_stmt|;
operator|*
name|count_pos
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpabuf_tailroom
argument_list|(
name|resp
argument_list|)
operator|<
name|len
operator|+
name|svc_info_len
operator|+
literal|10
condition|)
return|return;
if|if
condition|(
name|svc_info_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add Svc: %s info: %s"
argument_list|,
name|adv_data
operator|->
name|svc_name
argument_list|,
name|adv_data
operator|->
name|svc_info
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Add Svc: %s"
argument_list|,
name|adv_data
operator|->
name|svc_name
argument_list|)
expr_stmt|;
block|}
comment|/* Advertisement ID */
name|wpabuf_put_le32
argument_list|(
name|resp
argument_list|,
name|adv_data
operator|->
name|id
argument_list|)
expr_stmt|;
comment|/* Config Methods */
name|wpabuf_put_be16
argument_list|(
name|resp
argument_list|,
name|adv_data
operator|->
name|config_methods
argument_list|)
expr_stmt|;
comment|/* Service Name */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
operator|(
name|u8
operator|)
name|len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|resp
argument_list|,
name|adv_data
operator|->
name|svc_name
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Service State */
name|wpabuf_put_u8
argument_list|(
name|resp
argument_list|,
name|adv_data
operator|->
name|state
argument_list|)
expr_stmt|;
comment|/* Service Information */
name|wpabuf_put_le16
argument_list|(
name|resp
argument_list|,
operator|(
name|u16
operator|)
name|svc_info_len
argument_list|)
expr_stmt|;
name|wpabuf_put_data
argument_list|(
name|resp
argument_list|,
name|adv_data
operator|->
name|svc_info
argument_list|,
name|svc_info_len
argument_list|)
expr_stmt|;
comment|/* Update length and count */
operator|(
operator|*
name|count_pos
operator|)
operator|++
expr_stmt|;
name|WPA_PUT_LE16
argument_list|(
name|len_pos
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|resp
argument_list|,
literal|0
argument_list|)
operator|-
name|len_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* Return error if no matching svc found */
if|if
condition|(
name|count_pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: ASP service not found"
argument_list|)
expr_stmt|;
name|wpas_sd_add_not_found
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_P2PS
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_all_asp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|)
block|{
comment|/* Query data to add all P2PS advertisements: 	 *  - Service name length: 1 	 *  - Service name: '*' 	 *  - Service Information Request Length: 0 	 */
specifier|const
name|u8
name|q
index|[]
init|=
block|{
literal|1
block|,
operator|(
specifier|const
name|u8
operator|)
literal|'*'
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
name|p2p_get_p2ps_adv_list
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
condition|)
name|wpas_sd_req_asp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|q
argument_list|,
sizeof|sizeof
argument_list|(
name|q
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_sd_request
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|u16
name|update_indic
parameter_list|,
specifier|const
name|u8
modifier|*
name|tlvs
parameter_list|,
name|size_t
name|tlvs_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
init|=
name|tlvs
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|tlvs
operator|+
name|tlvs_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|tlv_end
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|resp
decl_stmt|;
name|u8
name|srv_proto
decl_stmt|,
name|srv_trans_id
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Service Discovery Request TLVs"
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|buf_len
operator|=
literal|2
operator|*
name|tlvs_len
operator|+
literal|1
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|P2P_EVENT_SERV_DISC_REQ
literal|"%d "
name|MACSTR
literal|" %u %u %s"
argument_list|,
name|freq
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|,
name|dialog_token
argument_list|,
name|update_indic
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|p2p_sd_over_ctrl_iface
condition|)
block|{
name|wpas_notify_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|update_indic
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
return|return;
comment|/* to be processed by an external program */
block|}
name|resp
operator|=
name|wpabuf_alloc
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
operator|==
name|NULL
condition|)
return|return;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Request TLV"
argument_list|)
expr_stmt|;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
operator|||
name|slen
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unexpected Query Data "
literal|"length"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return;
block|}
name|tlv_end
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
name|srv_proto
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Protocol Type %u"
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|srv_trans_id
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Transaction ID %u"
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Query Data"
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|force_long_sd
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: SD test - force long "
literal|"response"
argument_list|)
expr_stmt|;
name|wpas_sd_all_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpas_sd_all_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpas_sd_all_asp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
goto|goto
name|done
goto|;
block|}
switch|switch
condition|(
name|srv_proto
condition|)
block|{
case|case
name|P2P_SERV_ALL_SERVICES
case|:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Discovery Request "
literal|"for all services"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|)
operator|&&
name|dl_list_empty
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|)
operator|&&
operator|!
name|p2p_get_p2ps_adv_list
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: No service "
literal|"discovery protocols available"
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|P2P_SERV_ALL_SERVICES
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpas_sd_all_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpas_sd_all_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|wpas_sd_all_asp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_SERV_BONJOUR
case|:
name|wpas_sd_req_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
case|case
name|P2P_SERV_UPNP
case|:
name|wpas_sd_req_upnp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
case|case
name|P2P_SERV_WIFI_DISPLAY
case|:
name|wpas_sd_req_wfd
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_WIFI_DISPLAY */
case|case
name|P2P_SERV_P2PS
case|:
name|wpas_sd_req_asp
argument_list|(
name|wpa_s
argument_list|,
name|resp
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unavailable service "
literal|"protocol %u"
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|wpas_sd_add_proto_not_avail
argument_list|(
name|resp
argument_list|,
name|srv_proto
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
break|break;
block|}
name|pos
operator|=
name|tlv_end
expr_stmt|;
block|}
name|done
label|:
name|wpas_notify_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|update_indic
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_response
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|sa
argument_list|,
name|dialog_token
argument_list|,
name|resp
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_sd_p2ps_serv_response
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
name|u8
name|srv_trans_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|tlv_end
parameter_list|)
block|{
name|u8
name|left
init|=
operator|*
name|pos
operator|++
decl_stmt|;
name|u32
name|adv_id
decl_stmt|;
name|u8
name|svc_status
decl_stmt|;
name|u16
name|config_methods
decl_stmt|;
name|char
name|svc_str
index|[
literal|256
index|]
decl_stmt|;
while|while
condition|(
name|left
operator|--
operator|&&
name|pos
operator|<
name|tlv_end
condition|)
block|{
name|char
modifier|*
name|buf
init|=
name|NULL
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|u8
name|svc_len
decl_stmt|;
comment|/* Sanity check fixed length+svc_str */
if|if
condition|(
name|pos
operator|+
literal|6
operator|>=
name|tlv_end
condition|)
break|break;
name|svc_len
operator|=
name|pos
index|[
literal|6
index|]
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|svc_len
operator|+
literal|10
operator|>
name|tlv_end
condition|)
break|break;
comment|/* Advertisement ID */
name|adv_id
operator|=
name|WPA_GET_LE32
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
expr_stmt|;
comment|/* Config Methods */
name|config_methods
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
comment|/* Service Name */
name|pos
operator|++
expr_stmt|;
comment|/* svc_len */
name|os_memcpy
argument_list|(
name|svc_str
argument_list|,
name|pos
argument_list|,
name|svc_len
argument_list|)
expr_stmt|;
name|svc_str
index|[
name|svc_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|+=
name|svc_len
expr_stmt|;
comment|/* Service Status */
name|svc_status
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
comment|/* Service Information Length */
name|buf_len
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
sizeof|sizeof
argument_list|(
name|u16
argument_list|)
expr_stmt|;
comment|/* Sanity check buffer length */
if|if
condition|(
name|buf_len
operator|>
call|(
name|unsigned
name|int
call|)
argument_list|(
name|tlv_end
operator|-
name|pos
argument_list|)
condition|)
break|break;
if|if
condition|(
name|buf_len
condition|)
block|{
name|buf
operator|=
name|os_zalloc
argument_list|(
literal|2
operator|*
name|buf_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|utf8_escape
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|pos
argument_list|,
name|buf_len
argument_list|,
name|buf
argument_list|,
literal|2
operator|*
name|buf_len
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
name|pos
operator|+=
name|buf_len
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_SERV_ASP_RESP 				       MACSTR
literal|" %x %x %x %x %s '%s'"
argument_list|,
argument|MAC2STR(sa)
argument_list|,
argument|srv_trans_id
argument_list|,
argument|adv_id
argument_list|,
argument|svc_status
argument_list|,
argument|config_methods
argument_list|,
argument|svc_str
argument_list|,
argument|buf
argument_list|)
empty_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg_global
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_SERV_ASP_RESP 				       MACSTR
literal|" %x %x %x %x %s"
argument_list|,
argument|MAC2STR(sa)
argument_list|,
argument|srv_trans_id
argument_list|,
argument|adv_id
argument_list|,
argument|svc_status
argument_list|,
argument|config_methods
argument_list|,
argument|svc_str
argument_list|)
empty_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|wpas_sd_response
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
name|u16
name|update_indic
parameter_list|,
specifier|const
name|u8
modifier|*
name|tlvs
parameter_list|,
name|size_t
name|tlvs_len
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
init|=
name|tlvs
decl_stmt|;
specifier|const
name|u8
modifier|*
name|end
init|=
name|tlvs
operator|+
name|tlvs_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|tlv_end
decl_stmt|;
name|u16
name|slen
decl_stmt|;
name|size_t
name|buf_len
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Service Discovery Response TLVs"
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs_len
operator|>
literal|1500
condition|)
block|{
comment|/* TODO: better way for handling this */
name|wpa_msg_ctrl
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_SERV_DISC_RESP MACSTR
literal|" %u<long response: %u bytes>"
argument_list|,
argument|MAC2STR(sa)
argument_list|,
argument|update_indic
argument_list|,
argument|(unsigned int) tlvs_len
argument_list|)
empty_stmt|;
block|}
else|else
block|{
name|buf_len
operator|=
literal|2
operator|*
name|tlvs_len
operator|+
literal|1
expr_stmt|;
name|buf
operator|=
name|os_malloc
argument_list|(
name|buf_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
name|buf_len
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
name|wpa_msg_ctrl
argument_list|(
argument|wpa_s
argument_list|,
argument|MSG_INFO
argument_list|,
argument|P2P_EVENT_SERV_DISC_RESP MACSTR
literal|" %u %s"
argument_list|,
argument|MAC2STR(sa)
argument_list|,
argument|update_indic
argument_list|,
argument|buf
argument_list|)
empty_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
while|while
condition|(
name|pos
operator|<
name|end
condition|)
block|{
name|u8
name|srv_proto
decl_stmt|,
name|srv_trans_id
decl_stmt|,
name|status
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Response TLV"
argument_list|)
expr_stmt|;
name|slen
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|slen
operator|>
name|end
operator|||
name|slen
operator|<
literal|3
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Unexpected Response Data "
literal|"length"
argument_list|)
expr_stmt|;
return|return;
block|}
name|tlv_end
operator|=
name|pos
operator|+
name|slen
expr_stmt|;
name|srv_proto
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Protocol Type %u"
argument_list|,
name|srv_proto
argument_list|)
expr_stmt|;
name|srv_trans_id
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Service Transaction ID %u"
argument_list|,
name|srv_trans_id
argument_list|)
expr_stmt|;
name|status
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"P2P: Status Code ID %u"
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_MSGDUMP
argument_list|,
literal|"P2P: Response Data"
argument_list|,
name|pos
argument_list|,
name|tlv_end
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|srv_proto
operator|==
name|P2P_SERV_P2PS
operator|&&
name|pos
operator|<
name|tlv_end
condition|)
block|{
name|wpas_sd_p2ps_serv_response
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|,
name|srv_trans_id
argument_list|,
name|pos
argument_list|,
name|tlv_end
argument_list|)
expr_stmt|;
block|}
name|pos
operator|=
name|tlv_end
expr_stmt|;
block|}
name|wpas_notify_p2p_sd_response
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|,
name|update_indic
argument_list|,
name|tlvs
argument_list|,
name|tlvs_len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|uintptr_t
operator|)
name|p2p_sd_request
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
return|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|tlvs
decl_stmt|;
name|u64
name|ret
decl_stmt|;
name|tlvs
operator|=
name|wpabuf_alloc
argument_list|(
literal|2
operator|+
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|query
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpabuf_put_le16
argument_list|(
name|tlvs
argument_list|,
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|os_strlen
argument_list|(
name|query
argument_list|)
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|P2P_SERV_UPNP
argument_list|)
expr_stmt|;
comment|/* Service Protocol Type */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Service Transaction ID */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|version
argument_list|)
expr_stmt|;
name|wpabuf_put_str
argument_list|(
name|tlvs
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpas_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tlvs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request_asp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|id
parameter_list|,
specifier|const
name|char
modifier|*
name|svc_str
parameter_list|,
specifier|const
name|char
modifier|*
name|info_substr
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|tlvs
decl_stmt|;
name|size_t
name|plen
decl_stmt|,
name|svc_len
decl_stmt|,
name|substr_len
init|=
literal|0
decl_stmt|;
name|u64
name|ret
decl_stmt|;
name|svc_len
operator|=
name|os_strlen
argument_list|(
name|svc_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|info_substr
condition|)
name|substr_len
operator|=
name|os_strlen
argument_list|(
name|info_substr
argument_list|)
expr_stmt|;
if|if
condition|(
name|svc_len
operator|>
literal|0xff
operator|||
name|substr_len
operator|>
literal|0xff
condition|)
return|return
literal|0
return|;
name|plen
operator|=
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|svc_len
operator|+
literal|1
operator|+
name|substr_len
expr_stmt|;
name|tlvs
operator|=
name|wpabuf_alloc
argument_list|(
literal|2
operator|+
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|wpabuf_put_le16
argument_list|(
name|tlvs
argument_list|,
name|plen
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|P2P_SERV_P2PS
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|id
argument_list|)
expr_stmt|;
comment|/* Service Transaction ID */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
operator|(
name|u8
operator|)
name|svc_len
argument_list|)
expr_stmt|;
comment|/* Service String Length */
name|wpabuf_put_data
argument_list|(
name|tlvs
argument_list|,
name|svc_str
argument_list|,
name|svc_len
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
operator|(
name|u8
operator|)
name|substr_len
argument_list|)
expr_stmt|;
comment|/* Info Substring Length */
name|wpabuf_put_data
argument_list|(
name|tlvs
argument_list|,
name|info_substr
argument_list|,
name|substr_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpas_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tlvs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WIFI_DISPLAY
end_ifdef

begin_function
specifier|static
name|u64
name|wpas_p2p_sd_request_wfd
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|uintptr_t
operator|)
name|p2p_sd_request_wfd
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
return|;
block|}
end_function

begin_define
define|#
directive|define
name|MAX_WFD_SD_SUBELEMS
value|20
end_define

begin_function
specifier|static
name|void
name|wfd_add_sd_req_role
parameter_list|(
name|struct
name|wpabuf
modifier|*
name|tlvs
parameter_list|,
name|u8
name|id
parameter_list|,
name|u8
name|role
parameter_list|,
specifier|const
name|char
modifier|*
name|subelems
parameter_list|)
block|{
name|u8
modifier|*
name|len
decl_stmt|;
specifier|const
name|char
modifier|*
name|pos
decl_stmt|;
name|int
name|val
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
name|len
operator|=
name|wpabuf_put
argument_list|(
name|tlvs
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|P2P_SERV_WIFI_DISPLAY
argument_list|)
expr_stmt|;
comment|/* Service Protocol Type */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|id
argument_list|)
expr_stmt|;
comment|/* Service Transaction ID */
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|role
argument_list|)
expr_stmt|;
name|pos
operator|=
name|subelems
expr_stmt|;
while|while
condition|(
operator|*
name|pos
condition|)
block|{
name|val
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|>=
literal|0
operator|&&
name|val
operator|<
literal|256
condition|)
block|{
name|wpabuf_put_u8
argument_list|(
name|tlvs
argument_list|,
name|val
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|==
name|MAX_WFD_SD_SUBELEMS
condition|)
break|break;
block|}
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
operator|+
literal|1
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
break|break;
name|pos
operator|++
expr_stmt|;
block|}
name|WPA_PUT_LE16
argument_list|(
name|len
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wpabuf_put
argument_list|(
name|tlvs
argument_list|,
literal|0
argument_list|)
operator|-
name|len
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|u64
name|wpas_p2p_sd_request_wifi_display
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|char
modifier|*
name|role
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|tlvs
decl_stmt|;
name|u64
name|ret
decl_stmt|;
specifier|const
name|char
modifier|*
name|subelems
decl_stmt|;
name|u8
name|id
init|=
literal|1
decl_stmt|;
name|subelems
operator|=
name|os_strchr
argument_list|(
name|role
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|subelems
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|subelems
operator|++
expr_stmt|;
name|tlvs
operator|=
name|wpabuf_alloc
argument_list|(
literal|4
operator|*
operator|(
literal|2
operator|+
literal|1
operator|+
literal|1
operator|+
literal|1
operator|+
name|MAX_WFD_SD_SUBELEMS
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tlvs
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[source]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x00
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[pri-sink]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x01
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[sec-sink]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x02
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strstr
argument_list|(
name|role
argument_list|,
literal|"[source+sink]"
argument_list|)
condition|)
name|wfd_add_sd_req_role
argument_list|(
name|tlvs
argument_list|,
name|id
operator|++
argument_list|,
literal|0x03
argument_list|,
name|subelems
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpas_p2p_sd_request_wfd
argument_list|(
name|wpa_s
argument_list|,
name|dst
argument_list|,
name|tlvs
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tlvs
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WIFI_DISPLAY */
end_comment

begin_function
name|int
name|wpas_p2p_sd_cancel_request
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u64
name|req
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
name|p2p_sd_cancel_request
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
operator|(
name|void
operator|*
operator|)
operator|(
name|uintptr_t
operator|)
name|req
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_sd_response
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|resp_tlvs
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
return|return;
name|p2p_sd_response
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|freq
argument_list|,
name|dst
argument_list|,
name|dialog_token
argument_list|,
name|resp_tlvs
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_sd_service_update
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
condition|)
name|p2p_sd_service_update
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_srv_bonjour_free
parameter_list|(
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
parameter_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|bsrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|bsrv
operator|->
name|query
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|bsrv
operator|->
name|resp
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bsrv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_p2p_srv_upnp_free
parameter_list|(
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
parameter_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|usrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|usrv
operator|->
name|service
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_service_flush
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|,
modifier|*
name|bn
decl_stmt|;
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|,
modifier|*
name|un
decl_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|bsrv
argument_list|,
argument|bn
argument_list|,
argument|&wpa_s->global->p2p_srv_bonjour
argument_list|,
argument|struct p2p_srv_bonjour
argument_list|,
argument|list
argument_list|)
name|wpas_p2p_srv_bonjour_free
argument_list|(
name|bsrv
argument_list|)
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|usrv
argument_list|,
argument|un
argument_list|,
argument|&wpa_s->global->p2p_srv_upnp
argument_list|,
argument|struct p2p_srv_upnp
argument_list|,
argument|list
argument_list|)
name|wpas_p2p_srv_upnp_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
name|wpas_p2p_service_flush_asp
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_p2ps_id_exists
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|adv_id
parameter_list|)
block|{
if|if
condition|(
name|adv_id
operator|==
literal|0
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|p2p_service_p2ps_id
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|adv_id
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_del_asp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u32
name|adv_id
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|p2p_service_del_asp
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|adv_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_add_asp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|auto_accept
parameter_list|,
name|u32
name|adv_id
parameter_list|,
specifier|const
name|char
modifier|*
name|adv_str
parameter_list|,
name|u8
name|svc_state
parameter_list|,
name|u16
name|config_methods
parameter_list|,
specifier|const
name|char
modifier|*
name|svc_info
parameter_list|,
specifier|const
name|u8
modifier|*
name|cpt_priority
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|ret
operator|=
name|p2p_service_add_asp
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|auto_accept
argument_list|,
name|adv_id
argument_list|,
name|adv_str
argument_list|,
name|svc_state
argument_list|,
name|config_methods
argument_list|,
name|svc_info
argument_list|,
name|cpt_priority
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|wpas_p2p_service_flush_asp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|p2p_service_flush_asp
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_add_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|query
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|resp
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|bsrv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|bsrv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|bsrv
operator|->
name|query
operator|=
name|query
expr_stmt|;
name|bsrv
operator|->
name|resp
operator|=
name|resp
expr_stmt|;
name|dl_list_add
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_bonjour
argument_list|,
operator|&
name|bsrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_del_bonjour
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|query
parameter_list|)
block|{
name|struct
name|p2p_srv_bonjour
modifier|*
name|bsrv
decl_stmt|;
name|bsrv
operator|=
name|wpas_p2p_service_get_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|bsrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_p2p_srv_bonjour_free
argument_list|(
name|bsrv
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_add_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
if|if
condition|(
name|wpas_p2p_service_get_upnp
argument_list|(
name|wpa_s
argument_list|,
name|version
argument_list|,
name|service
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Already listed */
name|usrv
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|usrv
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|usrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|usrv
operator|->
name|version
operator|=
name|version
expr_stmt|;
name|usrv
operator|->
name|service
operator|=
name|os_strdup
argument_list|(
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|usrv
operator|->
name|service
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dl_list_add
argument_list|(
operator|&
name|wpa_s
operator|->
name|global
operator|->
name|p2p_srv_upnp
argument_list|,
operator|&
name|usrv
operator|->
name|list
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_p2p_service_del_upnp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|version
parameter_list|,
specifier|const
name|char
modifier|*
name|service
parameter_list|)
block|{
name|struct
name|p2p_srv_upnp
modifier|*
name|usrv
decl_stmt|;
name|usrv
operator|=
name|wpas_p2p_service_get_upnp
argument_list|(
name|wpa_s
argument_list|,
name|version
argument_list|,
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|usrv
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_p2p_srv_upnp_free
argument_list|(
name|usrv
argument_list|)
expr_stmt|;
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


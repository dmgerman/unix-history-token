begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant / WPS integration  * Copyright (c) 2008, Jouni Malinen<j@w1.fi>  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"wpa_common.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"uuid.h"
end_include

begin_include
include|#
directive|include
file|"wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"ctrl_iface_dbus.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_wsc_common.h"
end_include

begin_include
include|#
directive|include
file|"blacklist.h"
end_include

begin_include
include|#
directive|include
file|"wps_supplicant.h"
end_include

begin_define
define|#
directive|define
name|WPS_PIN_SCAN_IGNORE_SEL_REG
value|3
end_define

begin_function_decl
specifier|static
name|void
name|wpas_wps_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_clear_wps
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|wpas_wps_eapol_cb
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wps_success
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|eap_is_wps_pin_enrollee
argument_list|(
operator|&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|eap
argument_list|)
condition|)
block|{
specifier|const
name|u8
modifier|*
name|bssid
init|=
name|wpa_s
operator|->
name|bssid
decl_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|bssid
argument_list|)
condition|)
name|bssid
operator|=
name|wpa_s
operator|->
name|pending_bssid
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN registration with "
name|MACSTR
literal|" did not succeed - continue trying to find "
literal|"suitable AP"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|blacklist_cleared
condition|?
literal|5
else|:
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|blacklist_cleared
operator|=
literal|0
expr_stmt|;
return|return
literal|1
return|;
block|}
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
operator|!
operator|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network configuration replaced - "
literal|"try to associate with the received credential"
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
operator|&&
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Registration completed - waiting "
literal|"for external credential processing"
argument_list|)
expr_stmt|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_wps_cred
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|2
operator|)
operator|&&
name|cred
operator|->
name|cred_attr
condition|)
block|{
name|size_t
name|blen
init|=
name|cred
operator|->
name|cred_attr_len
operator|*
literal|2
operator|+
literal|1
decl_stmt|;
name|char
modifier|*
name|buf
init|=
name|os_malloc
argument_list|(
name|blen
argument_list|)
decl_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
name|blen
argument_list|,
name|cred
operator|->
name|cred_attr
argument_list|,
name|cred
operator|->
name|cred_attr_len
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"%s%s"
argument_list|,
name|WPS_EVENT_CRED_RECEIVED
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
name|wpa_supplicant_dbus_notify_wps_cred
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_CRED_RECEIVED
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received Credential attribute"
argument_list|,
name|cred
operator|->
name|cred_attr
argument_list|,
name|cred
operator|->
name|cred_attr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|!=
name|WPS_AUTH_OPEN
operator|&&
name|cred
operator|->
name|auth_type
operator|!=
name|WPS_AUTH_SHARED
operator|&&
name|cred
operator|->
name|auth_type
operator|!=
name|WPS_AUTH_WPAPSK
operator|&&
name|cred
operator|->
name|auth_type
operator|!=
name|WPS_AUTH_WPA2PSK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Ignored credentials for "
literal|"unsupported authentication type %d"
argument_list|,
name|cred
operator|->
name|auth_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|ssid
operator|&&
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Replace WPS network block based "
literal|"on the received credential"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|identity
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|identity
operator|=
name|NULL
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|identity_len
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|phase1
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|phase1
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Create a new network based on the "
literal|"received credential"
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_malloc
argument_list|(
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
condition|)
block|{
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|cred
operator|->
name|ssid_len
expr_stmt|;
block|}
switch|switch
condition|(
name|cred
operator|->
name|encr_type
condition|)
block|{
case|case
name|WPS_ENCR_NONE
case|:
break|break;
case|case
name|WPS_ENCR_WEP
case|:
if|if
condition|(
name|cred
operator|->
name|key_len
operator|>
literal|0
operator|&&
name|cred
operator|->
name|key_len
operator|<=
name|MAX_WEP_KEY_LEN
operator|&&
name|cred
operator|->
name|key_idx
operator|<
name|NUM_WEP_KEYS
condition|)
block|{
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|wep_key
index|[
name|cred
operator|->
name|key_idx
index|]
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|wep_key_len
index|[
name|cred
operator|->
name|key_idx
index|]
operator|=
name|cred
operator|->
name|key_len
expr_stmt|;
name|ssid
operator|->
name|wep_tx_keyidx
operator|=
name|cred
operator|->
name|key_idx
expr_stmt|;
block|}
break|break;
case|case
name|WPS_ENCR_TKIP
case|:
name|ssid
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
break|break;
case|case
name|WPS_ENCR_AES
case|:
name|ssid
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|cred
operator|->
name|auth_type
condition|)
block|{
case|case
name|WPS_AUTH_OPEN
case|:
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_NONE
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|WPS_AUTH_SHARED
case|:
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_SHARED
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_NONE
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|WPS_AUTH_WPAPSK
case|:
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
break|break;
case|case
name|WPS_AUTH_WPA
case|:
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
break|break;
case|case
name|WPS_AUTH_WPA2
case|:
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_IEEE8021X
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
break|break;
case|case
name|WPS_AUTH_WPA2PSK
case|:
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_PSK
condition|)
block|{
if|if
condition|(
name|cred
operator|->
name|key_len
operator|==
literal|2
operator|*
name|PMK_LEN
condition|)
block|{
if|if
condition|(
name|hexstr2bin
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|cred
operator|->
name|key
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Invalid Network "
literal|"Key"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ssid
operator|->
name|psk_set
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cred
operator|->
name|key_len
operator|>=
literal|8
operator|&&
name|cred
operator|->
name|key_len
operator|<
literal|2
operator|*
name|PMK_LEN
condition|)
block|{
name|os_free
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|passphrase
operator|=
name|os_malloc
argument_list|(
name|cred
operator|->
name|key_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|passphrase
index|[
name|cred
operator|->
name|key_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_config_update_psk
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Invalid Network Key "
literal|"length %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_WRITE
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|conf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to update configuration"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_CONFIG_WRITE */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_m2d
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_m2d
modifier|*
name|m2d
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_M2D
literal|"dev_password_id=%d config_error=%d"
argument_list|,
name|m2d
operator|->
name|dev_password_id
argument_list|,
name|m2d
operator|->
name|config_error
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_fail
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_fail
modifier|*
name|fail
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_FAIL
literal|"msg=%d"
argument_list|,
name|fail
operator|->
name|msg
argument_list|)
expr_stmt|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_success
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_SUCCESS
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wps_success
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|wps_event
name|event
parameter_list|,
name|union
name|wps_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|WPS_EV_M2D
case|:
name|wpa_supplicant_wps_event_m2d
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|m2d
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_FAIL
case|:
name|wpa_supplicant_wps_event_fail
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|fail
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_SUCCESS
case|:
name|wpa_supplicant_wps_event_success
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_PWD_AUTH_FAIL
case|:
break|break;
block|}
block|}
end_function

begin_function
name|enum
name|wps_request_type
name|wpas_wps_get_req_type
parameter_list|(
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
if|if
condition|(
name|eap_is_wps_pbc_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
operator|||
name|eap_is_wps_pin_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
return|return
name|WPS_REQ_ENROLLEE
return|;
else|else
return|return
name|WPS_REQ_REGISTRAR
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_clear_wps
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|id
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Remove any existing WPS network from configuration */
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
while|while
condition|(
name|ssid
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
condition|)
block|{
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
name|id
operator|=
name|ssid
operator|->
name|id
expr_stmt|;
block|}
else|else
name|id
operator|=
operator|-
literal|1
expr_stmt|;
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|id
operator|>=
literal|0
condition|)
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
name|WPS_EVENT_TIMEOUT
literal|"Requested operation timed "
literal|"out"
argument_list|)
expr_stmt|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|wpas_wps_add_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|registrar
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"key_mgmt"
argument_list|,
literal|"WPS"
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
operator|||
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"eap"
argument_list|,
literal|"WSC"
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
operator|||
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"identity"
argument_list|,
name|registrar
condition|?
literal|"\""
name|WSC_ID_REGISTRAR
literal|"\""
else|:
literal|"\""
name|WSC_ID_ENROLLEE
literal|"\""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|bssid
condition|)
block|{
name|size_t
name|i
decl_stmt|;
name|struct
name|wpa_scan_res
modifier|*
name|res
decl_stmt|;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|bssid_set
operator|=
literal|1
expr_stmt|;
comment|/* Try to get SSID from scan results */
if|if
condition|(
name|wpa_s
operator|->
name|scan_res
operator|==
name|NULL
operator|&&
name|wpa_supplicant_get_scan_results
argument_list|(
name|wpa_s
argument_list|)
operator|<
literal|0
condition|)
return|return
name|ssid
return|;
comment|/* Could not find any scan results */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|scan_res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|res
operator|=
name|wpa_s
operator|->
name|scan_res
operator|->
name|res
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|res
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|ie
operator|=
name|wpa_scan_get_ie
argument_list|(
name|res
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|==
name|NULL
condition|)
break|break;
name|os_free
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_malloc
argument_list|(
name|ie
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ie
operator|+
literal|2
argument_list|,
name|ie
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|ie
index|[
literal|1
index|]
expr_stmt|;
break|break;
block|}
block|}
return|return
name|ssid
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_reassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|selected
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
comment|/* Mark all other networks disabled and trigger reassociation */
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
while|while
condition|(
name|ssid
condition|)
block|{
name|ssid
operator|->
name|disabled
operator|=
name|ssid
operator|!=
name|selected
expr_stmt|;
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
block|}
name|wpa_s
operator|->
name|disconnected
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|scan_runs
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|wps_success
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|blacklist_cleared
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_wps_start_pbc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpas_wps_add_network
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase1"
argument_list|,
literal|"\"pbc=1\""
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_wps_reassoc
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_start_pin
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|char
name|val
index|[
literal|30
index|]
decl_stmt|;
name|unsigned
name|int
name|rpin
init|=
literal|0
decl_stmt|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpas_wps_add_network
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|pin
condition|)
name|os_snprintf
argument_list|(
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|,
literal|"\"pin=%s\""
argument_list|,
name|pin
argument_list|)
expr_stmt|;
else|else
block|{
name|rpin
operator|=
name|wps_generate_pin
argument_list|()
expr_stmt|;
name|os_snprintf
argument_list|(
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|,
literal|"\"pin=%08d\""
argument_list|,
name|rpin
argument_list|)
expr_stmt|;
block|}
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase1"
argument_list|,
name|val
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_wps_reassoc
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return
name|rpin
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_start_reg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|char
name|val
index|[
literal|30
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|pin
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpas_wps_add_network
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_snprintf
argument_list|(
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|,
literal|"\"pin=%s\""
argument_list|,
name|pin
argument_list|)
expr_stmt|;
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase1"
argument_list|,
name|val
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_wps_reassoc
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_wps_new_psk_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received new WPA/WPA2-PSK from WPS for "
literal|"STA "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Per-device PSK"
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
comment|/* TODO */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_pin_needed_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|)
block|{
name|char
name|uuid
index|[
literal|40
index|]
decl_stmt|,
name|txt
index|[
literal|400
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|uuid_bin2str
argument_list|(
name|uuid_e
argument_list|,
name|uuid
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid
argument_list|)
argument_list|)
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN needed for UUID-E %s"
argument_list|,
name|uuid
argument_list|)
expr_stmt|;
name|len
operator|=
name|os_snprintf
argument_list|(
name|txt
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
literal|"WPS-EVENT-PIN-NEEDED %s "
name|MACSTR
literal|" [%s|%s|%s|%s|%s|%d-%08X-%d]"
argument_list|,
name|uuid
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|mac_addr
argument_list|)
argument_list|,
name|dev
operator|->
name|device_name
argument_list|,
name|dev
operator|->
name|manufacturer
argument_list|,
name|dev
operator|->
name|model_name
argument_list|,
name|dev
operator|->
name|model_number
argument_list|,
name|dev
operator|->
name|serial_number
argument_list|,
name|dev
operator|->
name|categ
argument_list|,
name|dev
operator|->
name|oui
argument_list|,
name|dev
operator|->
name|sub_categ
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
operator|&&
name|len
operator|<
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s"
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_wps_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wps_context
modifier|*
name|wps
decl_stmt|;
name|struct
name|wps_registrar_config
name|rcfg
decl_stmt|;
name|wps
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wps
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wps
operator|->
name|cred_cb
operator|=
name|wpa_supplicant_wps_cred
expr_stmt|;
name|wps
operator|->
name|event_cb
operator|=
name|wpa_supplicant_wps_event
expr_stmt|;
name|wps
operator|->
name|cb_ctx
operator|=
name|wpa_s
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|device_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|manufacturer
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|manufacturer
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|model_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|model_name
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|model_number
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|model_number
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|serial_number
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|serial_number
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
condition|)
block|{
name|char
modifier|*
name|pos
decl_stmt|;
name|u8
name|oui
index|[
literal|4
index|]
decl_stmt|;
comment|/*<categ>-<OUI>-<subcateg> */
name|wps
operator|->
name|dev
operator|.
name|categ
operator|=
name|atoi
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Invalid device_type"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|hexstr2bin
argument_list|(
name|pos
argument_list|,
name|oui
argument_list|,
literal|4
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Invalid device_type OUI"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|dev
operator|.
name|oui
operator|=
name|WPA_GET_BE32
argument_list|(
name|oui
argument_list|)
expr_stmt|;
name|pos
operator|=
name|os_strchr
argument_list|(
name|pos
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Invalid device_type"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|pos
operator|++
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|sub_categ
operator|=
name|atoi
argument_list|(
name|pos
argument_list|)
expr_stmt|;
block|}
name|wps
operator|->
name|dev
operator|.
name|os_version
operator|=
name|WPA_GET_BE32
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|os_version
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|rf_bands
operator|=
name|WPS_RF_24GHZ
operator||
name|WPS_RF_50GHZ
expr_stmt|;
comment|/* TODO: config */
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|is_nil_uuid
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|uuid
argument_list|)
condition|)
block|{
name|uuid_gen_mac_addr
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wps
operator|->
name|uuid
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID based on MAC address"
argument_list|,
name|wps
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
block|}
else|else
name|os_memcpy
argument_list|(
name|wps
operator|->
name|uuid
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wps
operator|->
name|auth_types
operator|=
name|WPS_AUTH_WPA2PSK
operator||
name|WPS_AUTH_WPAPSK
expr_stmt|;
name|wps
operator|->
name|encr_types
operator|=
name|WPS_ENCR_AES
operator||
name|WPS_ENCR_TKIP
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|rcfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rcfg
argument_list|)
argument_list|)
expr_stmt|;
name|rcfg
operator|.
name|new_psk_cb
operator|=
name|wpas_wps_new_psk_cb
expr_stmt|;
name|rcfg
operator|.
name|pin_needed_cb
operator|=
name|wpas_wps_pin_needed_cb
expr_stmt|;
name|rcfg
operator|.
name|cb_ctx
operator|=
name|wpa_s
expr_stmt|;
name|wps
operator|->
name|registrar
operator|=
name|wps_registrar_init
argument_list|(
name|wps
argument_list|,
operator|&
name|rcfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|registrar
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to initialize WPS Registrar"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|wps
operator|=
name|wps
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpas_wps_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return;
name|wps_registrar_deinit
argument_list|(
name|wpa_s
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|wps
operator|->
name|network_key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|wps
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_wps_ssid_bss_match
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|wps_ie
operator|=
name|wpa_scan_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_is_wps_pbc_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wps_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - non-WPS AP"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|wps_is_selected_pbc_registrar
argument_list|(
name|wps_ie
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - WPS AP "
literal|"without active PBC Registrar"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* TODO: overlap detection */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected based on WPS IE "
literal|"(Active PBC)"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|eap_is_wps_pin_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wps_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - non-WPS AP"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 		 * Start with WPS APs that advertise active PIN Registrar and 		 * allow any WPS AP after third scan since some APs do not set 		 * Selected Registrar attribute properly when using external 		 * Registrar. 		 */
if|if
condition|(
operator|!
name|wps_is_selected_pin_registrar
argument_list|(
name|wps_ie
argument_list|)
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|scan_runs
operator|<
name|WPS_PIN_SCAN_IGNORE_SEL_REG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - WPS AP "
literal|"without active PIN Registrar"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected based on WPS IE"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected based on WPS IE "
literal|"(Active PIN)"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|wps_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected based on WPS IE"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_ssid_wildcard_ok
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps_ie
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|eap_is_wps_pbc_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
block|{
name|wps_ie
operator|=
name|wpa_scan_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|&&
name|wps_is_selected_pbc_registrar
argument_list|(
name|wps_ie
argument_list|)
condition|)
block|{
comment|/* allow wildcard SSID for WPS PBC */
name|ret
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|eap_is_wps_pin_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
block|{
name|wps_ie
operator|=
name|wpa_scan_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|&&
operator|(
name|wps_is_selected_pin_registrar
argument_list|(
name|wps_ie
argument_list|)
operator|||
name|wpa_s
operator|->
name|scan_runs
operator|>=
name|WPS_PIN_SCAN_IGNORE_SEL_REG
operator|)
condition|)
block|{
comment|/* allow wildcard SSID for WPS PIN */
name|ret
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|ret
operator|&&
name|ssid
operator|->
name|bssid_set
operator|&&
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* allow wildcard SSID due to hardcoded BSSID match */
name|ret
operator|=
literal|1
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_scan_pbc_overlap
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|selected
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|sel_uuid
decl_stmt|,
modifier|*
name|uuid
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|eap_is_wps_pbc_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
return|return
literal|0
return|;
comment|/* Make sure that only one AP is in active PBC mode */
name|wps_ie
operator|=
name|wpa_scan_get_vendor_ie_multi
argument_list|(
name|selected
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
condition|)
name|sel_uuid
operator|=
name|wps_get_uuid_e
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
else|else
name|sel_uuid
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|scan_res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|bss
init|=
name|wpa_s
operator|->
name|scan_res
operator|->
name|res
index|[
name|i
index|]
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
if|if
condition|(
name|bss
operator|==
name|selected
condition|)
continue|continue;
name|ie
operator|=
name|wpa_scan_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ie
condition|)
continue|continue;
if|if
condition|(
operator|!
name|wps_is_selected_pbc_registrar
argument_list|(
name|ie
argument_list|)
condition|)
block|{
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|uuid
operator|=
name|wps_get_uuid_e
argument_list|(
name|ie
argument_list|)
expr_stmt|;
if|if
condition|(
name|sel_uuid
operator|==
name|NULL
operator|||
name|uuid
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|sel_uuid
argument_list|,
name|uuid
argument_list|,
literal|16
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
comment|/* PBC overlap */
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* TODO: verify that this is reasonable dual-band situation */
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|wpas_wps_notify_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|disconnected
operator|||
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_ASSOCIATED
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|scan_res
operator|->
name|num
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wpa_scan_res
modifier|*
name|bss
init|=
name|wpa_s
operator|->
name|scan_res
operator|->
name|res
index|[
name|i
index|]
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
name|ie
operator|=
name|wpa_scan_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ie
condition|)
continue|continue;
if|if
condition|(
name|wps_is_selected_pbc_registrar
argument_list|(
name|ie
argument_list|)
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_AVAILABLE_PBC
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wps_is_selected_pin_registrar
argument_list|(
name|ie
argument_list|)
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_AVAILABLE_PIN
argument_list|)
expr_stmt|;
else|else
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_AVAILABLE
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|wpas_wps_searching
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
operator|&&
operator|!
name|ssid
operator|->
name|disabled
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


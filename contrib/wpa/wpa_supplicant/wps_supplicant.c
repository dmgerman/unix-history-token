begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant / WPS integration  * Copyright (c) 2008-2014, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eloop.h"
end_include

begin_include
include|#
directive|include
file|"uuid.h"
end_include

begin_include
include|#
directive|include
file|"crypto/random.h"
end_include

begin_include
include|#
directive|include
file|"crypto/dh_group5.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_common.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"eap_common/eap_wsc_common.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"wps/wps_attr_parse.h"
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"notify.h"
end_include

begin_include
include|#
directive|include
file|"blacklist.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"ap.h"
end_include

begin_include
include|#
directive|include
file|"p2p/p2p.h"
end_include

begin_include
include|#
directive|include
file|"p2p_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"wps_supplicant.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|WPS_PIN_SCAN_IGNORE_SEL_REG
end_ifndef

begin_define
define|#
directive|define
name|WPS_PIN_SCAN_IGNORE_SEL_REG
value|3
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* WPS_PIN_SCAN_IGNORE_SEL_REG */
end_comment

begin_comment
comment|/*  * The minimum time in seconds before trying to associate to a WPS PIN AP that  * does not have Selected Registrar TRUE.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|WPS_PIN_TIME_IGNORE_SEL_REG
end_ifndef

begin_define
define|#
directive|define
name|WPS_PIN_TIME_IGNORE_SEL_REG
value|5
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* WPS_PIN_TIME_IGNORE_SEL_REG */
end_comment

begin_function_decl
specifier|static
name|void
name|wpas_wps_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|wpas_clear_wps
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|wpas_wps_clear_ap_info
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|wps_ap
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wps_ap
operator|=
name|NULL
expr_stmt|;
name|wpa_s
operator|->
name|num_wps_ap
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|wps_ap_iter
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_assoc_with_cred
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|int
name|use_fast_assoc
init|=
name|timeout_ctx
operator|!=
name|NULL
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Continuing association after eapol_cb"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|use_fast_assoc
operator|||
name|wpa_supplicant_fast_associate
argument_list|(
name|wpa_s
argument_list|)
operator|!=
literal|1
condition|)
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_assoc_with_cred_cancel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_assoc_with_cred
argument_list|,
name|wpa_s
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_assoc_with_cred
argument_list|,
name|wpa_s
argument_list|,
operator|(
name|void
operator|*
operator|)
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_wps_eapol_cb
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpas_p2p_wps_eapol_cb
argument_list|(
name|wpa_s
argument_list|)
operator|>
literal|0
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wps_success
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
name|eap_is_wps_pin_enrollee
argument_list|(
operator|&
name|wpa_s
operator|->
name|current_ssid
operator|->
name|eap
argument_list|)
condition|)
block|{
specifier|const
name|u8
modifier|*
name|bssid
init|=
name|wpa_s
operator|->
name|bssid
decl_stmt|;
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|bssid
argument_list|)
condition|)
name|bssid
operator|=
name|wpa_s
operator|->
name|pending_bssid
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN registration with "
name|MACSTR
literal|" did not succeed - continue trying to find "
literal|"suitable AP"
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_blacklist_add
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|blacklist_cleared
condition|?
literal|5
else|:
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|blacklist_cleared
operator|=
literal|0
expr_stmt|;
return|return
literal|1
return|;
block|}
name|wpas_wps_clear_ap_info
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
operator|&&
operator|!
name|wpa_s
operator|->
name|wps_success
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_FAIL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
operator|&&
name|wpa_s
operator|->
name|current_ssid
operator|&&
operator|!
operator|(
name|wpa_s
operator|->
name|current_ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
condition|)
block|{
name|int
name|disabled
init|=
name|wpa_s
operator|->
name|current_ssid
operator|->
name|disabled
decl_stmt|;
name|unsigned
name|int
name|freq
init|=
name|wpa_s
operator|->
name|assoc_freq
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|NULL
decl_stmt|;
name|int
name|use_fast_assoc
init|=
literal|0
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network configuration replaced - "
literal|"try to associate with the received credential "
literal|"(freq=%u)"
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|own_disconnect_req
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
if|if
condition|(
name|disabled
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Current network is "
literal|"disabled - wait for user to enable"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|wpa_s
operator|->
name|after_wps
operator|=
literal|5
expr_stmt|;
name|wpa_s
operator|->
name|wps_freq
operator|=
name|freq
expr_stmt|;
name|wpa_s
operator|->
name|normal_scans
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Checking whether fast association "
literal|"without a new scan can be used"
argument_list|)
expr_stmt|;
name|bss
operator|=
name|wpa_supplicant_pick_network
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps
decl_stmt|;
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wps
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|&&
name|wps_parse_msg
argument_list|(
name|wps
argument_list|,
operator|&
name|attr
argument_list|)
operator|==
literal|0
operator|&&
name|attr
operator|.
name|wps_state
operator|&&
operator|*
name|attr
operator|.
name|wps_state
operator|==
name|WPS_STATE_CONFIGURED
condition|)
name|use_fast_assoc
operator|=
literal|1
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
block|}
comment|/* 		 * Complete the next step from an eloop timeout to allow pending 		 * driver events related to the disconnection to be processed 		 * first. This makes it less likely for disconnection event to 		 * cause problems with the following connection. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Continue association from timeout"
argument_list|)
expr_stmt|;
name|wpas_wps_assoc_with_cred_cancel
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|10000
argument_list|,
name|wpas_wps_assoc_with_cred
argument_list|,
name|wpa_s
argument_list|,
name|use_fast_assoc
condition|?
operator|(
name|void
operator|*
operator|)
literal|1
else|:
operator|(
name|void
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_WPS
operator|&&
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Registration completed - waiting "
literal|"for external credential processing"
argument_list|)
expr_stmt|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|own_disconnect_req
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_security_workaround
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|struct
name|wpa_ie_data
name|adv
decl_stmt|;
name|int
name|wpa2
init|=
literal|0
decl_stmt|,
name|ccmp
init|=
literal|0
decl_stmt|;
comment|/* 	 * Many existing WPS APs do not know how to negotiate WPA2 or CCMP in 	 * case they are configured for mixed mode operation (WPA+WPA2 and 	 * TKIP+CCMP). Try to use scan results to figure out whether the AP 	 * actually supports stronger security and select that if the client 	 * has support for it, too. 	 */
if|if
condition|(
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
condition|)
return|return;
comment|/* Unknown what driver supports */
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
return|return;
name|bss
operator|=
name|wpa_bss_get
argument_list|(
name|wpa_s
argument_list|,
name|cred
operator|->
name|mac_addr
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: The AP was not found from BSS "
literal|"table - use credential as-is"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP found from BSS table"
argument_list|)
expr_stmt|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|ie
argument_list|,
literal|2
operator|+
name|ie
index|[
literal|1
index|]
argument_list|,
operator|&
name|adv
argument_list|)
operator|==
literal|0
condition|)
block|{
name|wpa2
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|adv
operator|.
name|pairwise_cipher
operator|&
name|WPA_CIPHER_CCMP
condition|)
name|ccmp
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|ie
operator|=
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
operator|&&
name|wpa_parse_wpa_ie
argument_list|(
name|ie
argument_list|,
literal|2
operator|+
name|ie
index|[
literal|1
index|]
argument_list|,
operator|&
name|adv
argument_list|)
operator|==
literal|0
operator|&&
name|adv
operator|.
name|pairwise_cipher
operator|&
name|WPA_CIPHER_CCMP
condition|)
name|ccmp
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|ie
operator|==
name|NULL
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_WPA
operator|)
operator|&&
operator|(
name|ssid
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_TKIP
operator|)
condition|)
block|{
comment|/* 		 * TODO: This could be the initial AP configuration and the 		 * Beacon contents could change shortly. Should request a new 		 * scan and delay addition of the network until the updated 		 * scan results are available. 		 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: The AP did not yet advertise WPA "
literal|"support - use credential as-is"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ccmp
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_CCMP
operator|)
operator|&&
operator|(
name|ssid
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_TKIP
operator|)
operator|&&
operator|(
name|capa
operator|.
name|key_mgmt
operator|&
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2_PSK
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Add CCMP into the credential "
literal|"based on scan results"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
condition|)
name|ssid
operator|->
name|pairwise_cipher
operator||=
name|WPA_CIPHER_CCMP
expr_stmt|;
else|else
name|ssid
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
block|}
if|if
condition|(
name|wpa2
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
operator|&&
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_WPA
operator|)
operator|&&
operator|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_CCMP
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Add WPA2 into the credential "
literal|"based on scan results"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
operator|==
literal|1
condition|)
name|ssid
operator|->
name|proto
operator||=
name|WPA_PROTO_RSN
expr_stmt|;
else|else
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_remove_dup_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|new_ssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|next
decl_stmt|;
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
operator|,
name|next
operator|=
name|ssid
condition|?
name|ssid
operator|->
name|next
else|:
name|NULL
init|;
name|ssid
condition|;
name|ssid
operator|=
name|next
operator|,
name|next
operator|=
name|ssid
condition|?
name|ssid
operator|->
name|next
else|:
name|NULL
control|)
block|{
comment|/* 		 * new_ssid has already been added to the list in 		 * wpas_wps_add_network(), so skip it. 		 */
if|if
condition|(
name|ssid
operator|==
name|new_ssid
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|->
name|bssid_set
operator|||
name|new_ssid
operator|->
name|bssid_set
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|bssid_set
operator|!=
name|new_ssid
operator|->
name|bssid_set
condition|)
continue|continue;
if|if
condition|(
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|bssid
argument_list|,
name|new_ssid
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
block|}
comment|/* compare SSID */
if|if
condition|(
name|ssid
operator|->
name|ssid_len
operator|==
literal|0
operator|||
name|ssid
operator|->
name|ssid_len
operator|!=
name|new_ssid
operator|->
name|ssid_len
condition|)
continue|continue;
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|&&
name|new_ssid
operator|->
name|ssid
condition|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|new_ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|||
name|new_ssid
operator|->
name|ssid
condition|)
continue|continue;
comment|/* compare security parameters */
if|if
condition|(
name|ssid
operator|->
name|auth_alg
operator|!=
name|new_ssid
operator|->
name|auth_alg
operator|||
name|ssid
operator|->
name|key_mgmt
operator|!=
name|new_ssid
operator|->
name|key_mgmt
operator|||
operator|(
name|ssid
operator|->
name|group_cipher
operator|!=
name|new_ssid
operator|->
name|group_cipher
operator|&&
operator|!
operator|(
name|ssid
operator|->
name|group_cipher
operator|&
name|new_ssid
operator|->
name|group_cipher
operator|&
name|WPA_CIPHER_CCMP
operator|)
operator|)
condition|)
continue|continue;
comment|/* 		 * Some existing WPS APs will send two creds in case they are 		 * configured for mixed mode operation (WPA+WPA2 and TKIP+CCMP). 		 * Try to merge these two creds if they are received in the same 		 * M8 message. 		 */
if|if
condition|(
name|ssid
operator|->
name|wps_run
operator|&&
name|ssid
operator|->
name|wps_run
operator|==
name|new_ssid
operator|->
name|wps_run
operator|&&
name|wpa_key_mgmt_wpa_psk
argument_list|(
name|ssid
operator|->
name|key_mgmt
argument_list|)
condition|)
block|{
if|if
condition|(
name|new_ssid
operator|->
name|passphrase
operator|&&
name|ssid
operator|->
name|passphrase
operator|&&
name|os_strcmp
argument_list|(
name|new_ssid
operator|->
name|passphrase
argument_list|,
name|ssid
operator|->
name|passphrase
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: M8 Creds with different passphrase - do not merge"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|new_ssid
operator|->
name|psk_set
operator|&&
operator|(
operator|!
name|ssid
operator|->
name|psk_set
operator|||
name|os_memcmp
argument_list|(
name|new_ssid
operator|->
name|psk
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|32
argument_list|)
operator|!=
literal|0
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: M8 Creds with different PSK - do not merge"
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|new_ssid
operator|->
name|passphrase
operator|&&
operator|!
name|ssid
operator|->
name|passphrase
operator|)
operator|||
operator|(
operator|!
name|new_ssid
operator|->
name|passphrase
operator|&&
name|ssid
operator|->
name|passphrase
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: M8 Creds with different passphrase/PSK type - do not merge"
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Workaround - merge likely WPA/WPA2-mixed mode creds in same M8 message"
argument_list|)
expr_stmt|;
name|new_ssid
operator|->
name|proto
operator||=
name|ssid
operator|->
name|proto
expr_stmt|;
name|new_ssid
operator|->
name|pairwise_cipher
operator||=
name|ssid
operator|->
name|pairwise_cipher
expr_stmt|;
block|}
else|else
block|{
comment|/* 			 * proto and pairwise_cipher difference matter for 			 * non-mixed-mode creds. 			 */
if|if
condition|(
name|ssid
operator|->
name|proto
operator|!=
name|new_ssid
operator|->
name|proto
operator|||
name|ssid
operator|->
name|pairwise_cipher
operator|!=
name|new_ssid
operator|->
name|pairwise_cipher
condition|)
continue|continue;
block|}
comment|/* Remove the duplicated older network entry. */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Remove duplicate network %d"
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|ssid
condition|)
name|wpa_s
operator|->
name|current_ssid
operator|=
name|NULL
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_wps_cred
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|u16
name|auth_type
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_REG_DISABLE_OPEN
name|int
name|registrar
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_REG_DISABLE_OPEN */
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|2
operator|)
operator|&&
name|cred
operator|->
name|cred_attr
condition|)
block|{
name|size_t
name|blen
init|=
name|cred
operator|->
name|cred_attr_len
operator|*
literal|2
operator|+
literal|1
decl_stmt|;
name|char
modifier|*
name|buf
init|=
name|os_malloc
argument_list|(
name|blen
argument_list|)
decl_stmt|;
if|if
condition|(
name|buf
condition|)
block|{
name|wpa_snprintf_hex
argument_list|(
name|buf
argument_list|,
name|blen
argument_list|,
name|cred
operator|->
name|cred_attr
argument_list|,
name|cred
operator|->
name|cred_attr_len
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"%s%s"
argument_list|,
name|WPS_EVENT_CRED_RECEIVED
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
name|wpas_notify_wps_credential
argument_list|(
name|wpa_s
argument_list|,
name|cred
argument_list|)
expr_stmt|;
block|}
else|else
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_CRED_RECEIVED
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received Credential attribute"
argument_list|,
name|cred
operator|->
name|cred_attr
argument_list|,
name|cred
operator|->
name|cred_attr_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|==
literal|1
condition|)
return|return
literal|0
return|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: SSID"
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Authentication Type 0x%x"
argument_list|,
name|cred
operator|->
name|auth_type
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Encryption Type 0x%x"
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network Key Index %d"
argument_list|,
name|cred
operator|->
name|key_idx
argument_list|)
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Network Key"
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MAC Address "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|cred
operator|->
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
name|auth_type
operator|=
name|cred
operator|->
name|auth_type
expr_stmt|;
if|if
condition|(
name|auth_type
operator|==
operator|(
name|WPS_AUTH_WPAPSK
operator||
name|WPS_AUTH_WPA2PSK
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Workaround - convert mixed-mode "
literal|"auth_type into WPA2PSK"
argument_list|)
expr_stmt|;
name|auth_type
operator|=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
block|}
if|if
condition|(
name|auth_type
operator|!=
name|WPS_AUTH_OPEN
operator|&&
name|auth_type
operator|!=
name|WPS_AUTH_WPAPSK
operator|&&
name|auth_type
operator|!=
name|WPS_AUTH_WPA2PSK
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Ignored credentials for "
literal|"unsupported authentication type 0x%x"
argument_list|,
name|auth_type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|auth_type
operator|==
name|WPS_AUTH_WPAPSK
operator|||
name|auth_type
operator|==
name|WPS_AUTH_WPA2PSK
condition|)
block|{
if|if
condition|(
name|cred
operator|->
name|key_len
operator|<
literal|8
operator|||
name|cred
operator|->
name|key_len
operator|>
literal|2
operator|*
name|PMK_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Reject PSK credential with "
literal|"invalid Network Key length %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
if|if
condition|(
name|ssid
operator|&&
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Replace WPS network block based "
literal|"on the received credential"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_REG_DISABLE_OPEN
if|if
condition|(
name|ssid
operator|->
name|eap
operator|.
name|identity
operator|&&
name|ssid
operator|->
name|eap
operator|.
name|identity_len
operator|==
name|WSC_ID_REGISTRAR_LEN
operator|&&
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|identity
argument_list|,
name|WSC_ID_REGISTRAR
argument_list|,
name|WSC_ID_REGISTRAR_LEN
argument_list|)
operator|==
literal|0
condition|)
name|registrar
operator|=
literal|1
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_REG_DISABLE_OPEN */
name|os_free
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|identity
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|identity
operator|=
name|NULL
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|identity_len
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|phase1
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|phase1
operator|=
name|NULL
expr_stmt|;
name|os_free
argument_list|(
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|eap
operator|.
name|eap_methods
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|ssid
operator|->
name|p2p_group
condition|)
block|{
name|ssid
operator|->
name|temporary
operator|=
literal|0
expr_stmt|;
name|ssid
operator|->
name|bssid_set
operator|=
literal|0
expr_stmt|;
block|}
name|ssid
operator|->
name|disabled_until
operator|.
name|sec
operator|=
literal|0
expr_stmt|;
name|ssid
operator|->
name|disabled_until
operator|.
name|usec
operator|=
literal|0
expr_stmt|;
name|ssid
operator|->
name|auth_failures
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Create a new network based on the "
literal|"received credential"
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
comment|/* 			 * Should the GO issue multiple credentials for some 			 * reason, each credential should be marked as a 			 * temporary P2P group similarly to the one that gets 			 * marked as such based on the pre-configured values 			 * used for the WPS network block. 			 */
name|ssid
operator|->
name|p2p_group
operator|=
name|wpa_s
operator|->
name|current_ssid
operator|->
name|p2p_group
expr_stmt|;
name|ssid
operator|->
name|temporary
operator|=
name|wpa_s
operator|->
name|current_ssid
operator|->
name|temporary
expr_stmt|;
block|}
name|wpas_notify_network_added
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|wps_run
operator|=
name|wpa_s
operator|->
name|wps_run
expr_stmt|;
name|os_free
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_malloc
argument_list|(
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
condition|)
block|{
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|cred
operator|->
name|ssid_len
expr_stmt|;
block|}
switch|switch
condition|(
name|cred
operator|->
name|encr_type
condition|)
block|{
case|case
name|WPS_ENCR_NONE
case|:
break|break;
case|case
name|WPS_ENCR_TKIP
case|:
name|ssid
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_TKIP
expr_stmt|;
break|break;
case|case
name|WPS_ENCR_AES
case|:
name|ssid
operator|->
name|pairwise_cipher
operator|=
name|WPA_CIPHER_CCMP
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|drv_capa_known
operator|&&
operator|(
name|wpa_s
operator|->
name|drv_enc
operator|&
name|WPA_DRIVER_CAPA_ENC_GCMP
operator|)
condition|)
block|{
name|ssid
operator|->
name|pairwise_cipher
operator||=
name|WPA_CIPHER_GCMP
expr_stmt|;
name|ssid
operator|->
name|group_cipher
operator||=
name|WPA_CIPHER_GCMP
expr_stmt|;
block|}
break|break;
block|}
switch|switch
condition|(
name|auth_type
condition|)
block|{
case|case
name|WPS_AUTH_OPEN
case|:
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_NONE
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
literal|0
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_REG_DISABLE_OPEN
if|if
condition|(
name|registrar
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_OPEN_NETWORK
literal|"id=%d - Credentials for an open "
literal|"network disabled by default - use "
literal|"'select_network %d' to enable"
argument_list|,
name|ssid
operator|->
name|id
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|disabled
operator|=
literal|1
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_REG_DISABLE_OPEN */
break|break;
case|case
name|WPS_AUTH_WPAPSK
case|:
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_WPA
expr_stmt|;
break|break;
case|case
name|WPS_AUTH_WPA2PSK
case|:
name|ssid
operator|->
name|auth_alg
operator|=
name|WPA_AUTH_ALG_OPEN
expr_stmt|;
name|ssid
operator|->
name|key_mgmt
operator|=
name|WPA_KEY_MGMT_PSK
expr_stmt|;
name|ssid
operator|->
name|proto
operator|=
name|WPA_PROTO_RSN
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_PSK
condition|)
block|{
if|if
condition|(
name|cred
operator|->
name|key_len
operator|==
literal|2
operator|*
name|PMK_LEN
condition|)
block|{
if|if
condition|(
name|hexstr2bin
argument_list|(
operator|(
specifier|const
name|char
operator|*
operator|)
name|cred
operator|->
name|key
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
name|PMK_LEN
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Invalid Network "
literal|"Key"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ssid
operator|->
name|psk_set
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|export_keys
operator|=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cred
operator|->
name|key_len
operator|>=
literal|8
operator|&&
name|cred
operator|->
name|key_len
operator|<
literal|2
operator|*
name|PMK_LEN
condition|)
block|{
name|os_free
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|passphrase
operator|=
name|os_malloc
argument_list|(
name|cred
operator|->
name|key_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|passphrase
index|[
name|cred
operator|->
name|key_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_config_update_psk
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|export_keys
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Invalid Network Key "
literal|"length %lu"
argument_list|,
operator|(
name|unsigned
name|long
operator|)
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
block|}
name|ssid
operator|->
name|priority
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|wps_priority
expr_stmt|;
name|wpas_wps_security_workaround
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|cred
argument_list|)
expr_stmt|;
name|wpas_wps_remove_dup_network
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_WRITE
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|conf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to update configuration"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_CONFIG_WRITE */
if|if
condition|(
name|ssid
operator|->
name|priority
condition|)
name|wpa_config_update_prio_list
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
comment|/* 	 * Optimize the post-WPS scan based on the channel used during 	 * the provisioning in case EAP-Failure is not received. 	 */
name|wpa_s
operator|->
name|after_wps
operator|=
literal|5
expr_stmt|;
name|wpa_s
operator|->
name|wps_freq
operator|=
name|wpa_s
operator|->
name|assoc_freq
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_m2d
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_m2d
modifier|*
name|m2d
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_M2D
literal|"dev_password_id=%d config_error=%d"
argument_list|,
name|m2d
operator|->
name|dev_password_id
argument_list|,
name|m2d
operator|->
name|config_error
argument_list|)
expr_stmt|;
name|wpas_notify_wps_event_m2d
argument_list|(
name|wpa_s
argument_list|,
name|m2d
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|&&
name|wpa_s
operator|->
name|parent
operator|!=
name|wpa_s
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_M2D
literal|"dev_password_id=%d config_error=%d"
argument_list|,
name|m2d
operator|->
name|dev_password_id
argument_list|,
name|m2d
operator|->
name|config_error
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|m2d
operator|->
name|config_error
operator|==
name|WPS_CFG_MULTIPLE_PBC_DETECTED
condition|)
block|{
comment|/* 		 * Notify P2P from eloop timeout to avoid issues with the 		 * interface getting removed while processing a message. 		 */
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
name|wpas_p2p_pbc_overlap_cb
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_clear_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Clear WPS network from timeout"
argument_list|)
expr_stmt|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_fail
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_fail
modifier|*
name|fail
parameter_list|)
block|{
if|if
condition|(
name|fail
operator|->
name|error_indication
operator|>
literal|0
operator|&&
name|fail
operator|->
name|error_indication
operator|<
name|NUM_WPS_EI_VALUES
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_FAIL
literal|"msg=%d config_error=%d reason=%d (%s)"
argument_list|,
name|fail
operator|->
name|msg
argument_list|,
name|fail
operator|->
name|config_error
argument_list|,
name|fail
operator|->
name|error_indication
argument_list|,
name|wps_ei_str
argument_list|(
name|fail
operator|->
name|error_indication
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|&&
name|wpa_s
operator|->
name|parent
operator|!=
name|wpa_s
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_FAIL
literal|"msg=%d config_error=%d reason=%d (%s)"
argument_list|,
name|fail
operator|->
name|msg
argument_list|,
name|fail
operator|->
name|config_error
argument_list|,
name|fail
operator|->
name|error_indication
argument_list|,
name|wps_ei_str
argument_list|(
name|fail
operator|->
name|error_indication
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_FAIL
literal|"msg=%d config_error=%d"
argument_list|,
name|fail
operator|->
name|msg
argument_list|,
name|fail
operator|->
name|config_error
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|parent
operator|&&
name|wpa_s
operator|->
name|parent
operator|!=
name|wpa_s
condition|)
name|wpa_msg
argument_list|(
name|wpa_s
operator|->
name|parent
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_FAIL
literal|"msg=%d config_error=%d"
argument_list|,
name|fail
operator|->
name|msg
argument_list|,
name|fail
operator|->
name|config_error
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Need to allow WPS processing to complete, e.g., by sending WSC_NACK. 	 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Register timeout to clear WPS network"
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_clear_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|0
argument_list|,
literal|100000
argument_list|,
name|wpas_wps_clear_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_notify_wps_event_fail
argument_list|(
name|wpa_s
argument_list|,
name|fail
argument_list|)
expr_stmt|;
name|wpas_p2p_wps_failed
argument_list|(
name|wpa_s
argument_list|,
name|fail
argument_list|)
expr_stmt|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|wpas_wps_reenable_networks_cb
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|wpas_wps_reenable_networks
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|int
name|changed
init|=
literal|0
decl_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_reenable_networks_cb
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
block|{
if|if
condition|(
name|ssid
operator|->
name|disabled_for_connect
operator|&&
name|ssid
operator|->
name|disabled
condition|)
block|{
name|ssid
operator|->
name|disabled_for_connect
operator|=
literal|0
expr_stmt|;
name|ssid
operator|->
name|disabled
operator|=
literal|0
expr_stmt|;
name|wpas_notify_network_enabled_changed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|changed
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|changed
condition|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_NO_CONFIG_WRITE
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|update_config
operator|&&
name|wpa_config_write
argument_list|(
name|wpa_s
operator|->
name|confname
argument_list|,
name|wpa_s
operator|->
name|conf
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to update "
literal|"configuration"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_NO_CONFIG_WRITE */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_reenable_networks_cb
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
comment|/* Enable the networks disabled during wpas_wps_reassoc */
name|wpas_wps_reenable_networks
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_success
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_SUCCESS
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wps_success
operator|=
literal|1
expr_stmt|;
name|wpas_notify_wps_event_success
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpas_clear_temp_disabled
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|current_ssid
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|extra_blacklist_count
operator|=
literal|0
expr_stmt|;
comment|/* 	 * Enable the networks disabled during wpas_wps_reassoc after 10 	 * seconds. The 10 seconds timer is to allow the data connection to be 	 * formed before allowing other networks to be selected. 	 */
name|eloop_register_timeout
argument_list|(
literal|10
argument_list|,
literal|0
argument_list|,
name|wpas_wps_reenable_networks_cb
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_p2p_wps_success
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_er_ap_add
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_er_ap
modifier|*
name|ap
parameter_list|)
block|{
name|char
name|uuid_str
index|[
literal|100
index|]
decl_stmt|;
name|char
name|dev_type
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|uuid_bin2str
argument_list|(
name|ap
operator|->
name|uuid
argument_list|,
name|uuid_str
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid_str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|->
name|pri_dev_type
condition|)
name|wps_dev_type_bin2str
argument_list|(
name|ap
operator|->
name|pri_dev_type
argument_list|,
name|dev_type
argument_list|,
sizeof|sizeof
argument_list|(
name|dev_type
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|dev_type
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_ER_AP_ADD
literal|"%s "
name|MACSTR
literal|" pri_dev_type=%s wps_state=%d |%s|%s|%s|%s|%s|%s|"
argument_list|,
name|uuid_str
argument_list|,
name|MAC2STR
argument_list|(
name|ap
operator|->
name|mac_addr
argument_list|)
argument_list|,
name|dev_type
argument_list|,
name|ap
operator|->
name|wps_state
argument_list|,
name|ap
operator|->
name|friendly_name
condition|?
name|ap
operator|->
name|friendly_name
else|:
literal|""
argument_list|,
name|ap
operator|->
name|manufacturer
condition|?
name|ap
operator|->
name|manufacturer
else|:
literal|""
argument_list|,
name|ap
operator|->
name|model_description
condition|?
name|ap
operator|->
name|model_description
else|:
literal|""
argument_list|,
name|ap
operator|->
name|model_name
condition|?
name|ap
operator|->
name|model_name
else|:
literal|""
argument_list|,
name|ap
operator|->
name|manufacturer_url
condition|?
name|ap
operator|->
name|manufacturer_url
else|:
literal|""
argument_list|,
name|ap
operator|->
name|model_url
condition|?
name|ap
operator|->
name|model_url
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_er_ap_remove
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_er_ap
modifier|*
name|ap
parameter_list|)
block|{
name|char
name|uuid_str
index|[
literal|100
index|]
decl_stmt|;
name|uuid_bin2str
argument_list|(
name|ap
operator|->
name|uuid
argument_list|,
name|uuid_str
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid_str
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_ER_AP_REMOVE
literal|"%s"
argument_list|,
name|uuid_str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_er_enrollee_add
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_er_enrollee
modifier|*
name|enrollee
parameter_list|)
block|{
name|char
name|uuid_str
index|[
literal|100
index|]
decl_stmt|;
name|char
name|dev_type
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
name|uuid_bin2str
argument_list|(
name|enrollee
operator|->
name|uuid
argument_list|,
name|uuid_str
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid_str
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|enrollee
operator|->
name|pri_dev_type
condition|)
name|wps_dev_type_bin2str
argument_list|(
name|enrollee
operator|->
name|pri_dev_type
argument_list|,
name|dev_type
argument_list|,
sizeof|sizeof
argument_list|(
name|dev_type
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|dev_type
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_ER_ENROLLEE_ADD
literal|"%s "
name|MACSTR
literal|" M1=%d config_methods=0x%x dev_passwd_id=%d pri_dev_type=%s "
literal|"|%s|%s|%s|%s|%s|"
argument_list|,
name|uuid_str
argument_list|,
name|MAC2STR
argument_list|(
name|enrollee
operator|->
name|mac_addr
argument_list|)
argument_list|,
name|enrollee
operator|->
name|m1_received
argument_list|,
name|enrollee
operator|->
name|config_methods
argument_list|,
name|enrollee
operator|->
name|dev_passwd_id
argument_list|,
name|dev_type
argument_list|,
name|enrollee
operator|->
name|dev_name
condition|?
name|enrollee
operator|->
name|dev_name
else|:
literal|""
argument_list|,
name|enrollee
operator|->
name|manufacturer
condition|?
name|enrollee
operator|->
name|manufacturer
else|:
literal|""
argument_list|,
name|enrollee
operator|->
name|model_name
condition|?
name|enrollee
operator|->
name|model_name
else|:
literal|""
argument_list|,
name|enrollee
operator|->
name|model_number
condition|?
name|enrollee
operator|->
name|model_number
else|:
literal|""
argument_list|,
name|enrollee
operator|->
name|serial_number
condition|?
name|enrollee
operator|->
name|serial_number
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_er_enrollee_remove
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_er_enrollee
modifier|*
name|enrollee
parameter_list|)
block|{
name|char
name|uuid_str
index|[
literal|100
index|]
decl_stmt|;
name|uuid_bin2str
argument_list|(
name|enrollee
operator|->
name|uuid
argument_list|,
name|uuid_str
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid_str
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_ER_ENROLLEE_REMOVE
literal|"%s "
name|MACSTR
argument_list|,
name|uuid_str
argument_list|,
name|MAC2STR
argument_list|(
name|enrollee
operator|->
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_er_ap_settings
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_er_ap_settings
modifier|*
name|ap_settings
parameter_list|)
block|{
name|char
name|uuid_str
index|[
literal|100
index|]
decl_stmt|;
name|char
name|key_str
index|[
literal|65
index|]
decl_stmt|;
specifier|const
name|struct
name|wps_credential
modifier|*
name|cred
init|=
name|ap_settings
operator|->
name|cred
decl_stmt|;
name|key_str
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|auth_type
operator|&
operator|(
name|WPS_AUTH_WPAPSK
operator||
name|WPS_AUTH_WPA2PSK
operator|)
condition|)
block|{
if|if
condition|(
name|cred
operator|->
name|key_len
operator|>=
literal|8
operator|&&
name|cred
operator|->
name|key_len
operator|<=
literal|64
condition|)
block|{
name|os_memcpy
argument_list|(
name|key_str
argument_list|,
name|cred
operator|->
name|key
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
name|key_str
index|[
name|cred
operator|->
name|key_len
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
name|uuid_bin2str
argument_list|(
name|ap_settings
operator|->
name|uuid
argument_list|,
name|uuid_str
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid_str
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Use wpa_msg_ctrl to avoid showing the key in debug log */
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_ER_AP_SETTINGS
literal|"uuid=%s ssid=%s auth_type=0x%04x encr_type=0x%04x "
literal|"key=%s"
argument_list|,
name|uuid_str
argument_list|,
name|wpa_ssid_txt
argument_list|(
name|cred
operator|->
name|ssid
argument_list|,
name|cred
operator|->
name|ssid_len
argument_list|)
argument_list|,
name|cred
operator|->
name|auth_type
argument_list|,
name|cred
operator|->
name|encr_type
argument_list|,
name|key_str
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event_er_set_sel_reg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_event_er_set_selected_registrar
modifier|*
name|ev
parameter_list|)
block|{
name|char
name|uuid_str
index|[
literal|100
index|]
decl_stmt|;
name|uuid_bin2str
argument_list|(
name|ev
operator|->
name|uuid
argument_list|,
name|uuid_str
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid_str
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ev
operator|->
name|state
condition|)
block|{
case|case
name|WPS_ER_SET_SEL_REG_START
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
name|WPS_EVENT_ER_SET_SEL_REG
literal|"uuid=%s state=START sel_reg=%d dev_passwd_id=%u "
literal|"sel_reg_config_methods=0x%x"
argument_list|,
name|uuid_str
argument_list|,
name|ev
operator|->
name|sel_reg
argument_list|,
name|ev
operator|->
name|dev_passwd_id
argument_list|,
name|ev
operator|->
name|sel_reg_config_methods
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_ER_SET_SEL_REG_DONE
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
name|WPS_EVENT_ER_SET_SEL_REG
literal|"uuid=%s state=DONE"
argument_list|,
name|uuid_str
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_ER_SET_SEL_REG_FAILED
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_ER_SET_SEL_REG
literal|"uuid=%s state=FAILED"
argument_list|,
name|uuid_str
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpa_supplicant_wps_event
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|enum
name|wps_event
name|event
parameter_list|,
name|union
name|wps_event_data
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
switch|switch
condition|(
name|event
condition|)
block|{
case|case
name|WPS_EV_M2D
case|:
name|wpa_supplicant_wps_event_m2d
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|m2d
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_FAIL
case|:
name|wpa_supplicant_wps_event_fail
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|fail
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_SUCCESS
case|:
name|wpa_supplicant_wps_event_success
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_PWD_AUTH_FAIL
case|:
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|&&
name|data
operator|->
name|pwd_auth_fail
operator|.
name|enrollee
condition|)
name|wpa_supplicant_ap_pwd_auth_fail
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
break|break;
case|case
name|WPS_EV_PBC_OVERLAP
case|:
break|break;
case|case
name|WPS_EV_PBC_TIMEOUT
case|:
break|break;
case|case
name|WPS_EV_PBC_ACTIVE
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_ACTIVE
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_PBC_DISABLE
case|:
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_DISABLE
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_ER_AP_ADD
case|:
name|wpa_supplicant_wps_event_er_ap_add
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|ap
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_ER_AP_REMOVE
case|:
name|wpa_supplicant_wps_event_er_ap_remove
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|ap
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_ER_ENROLLEE_ADD
case|:
name|wpa_supplicant_wps_event_er_enrollee_add
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|enrollee
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_ER_ENROLLEE_REMOVE
case|:
name|wpa_supplicant_wps_event_er_enrollee_remove
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|enrollee
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_ER_AP_SETTINGS
case|:
name|wpa_supplicant_wps_event_er_ap_settings
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|ap_settings
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_ER_SET_SELECTED_REGISTRAR
case|:
name|wpa_supplicant_wps_event_er_set_sel_reg
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|->
name|set_sel_reg
argument_list|)
expr_stmt|;
break|break;
case|case
name|WPS_EV_AP_PIN_SUCCESS
case|:
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wpa_supplicant_wps_rf_band
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|current_ssid
operator|||
operator|!
name|wpa_s
operator|->
name|assoc_freq
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|wpa_s
operator|->
name|assoc_freq
operator|>
literal|50000
operator|)
condition|?
name|WPS_RF_60GHZ
else|:
operator|(
name|wpa_s
operator|->
name|assoc_freq
operator|>
literal|2484
operator|)
condition|?
name|WPS_RF_50GHZ
else|:
name|WPS_RF_24GHZ
return|;
block|}
end_function

begin_function
name|enum
name|wps_request_type
name|wpas_wps_get_req_type
parameter_list|(
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
if|if
condition|(
name|eap_is_wps_pbc_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
operator|||
name|eap_is_wps_pin_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
return|return
name|WPS_REQ_ENROLLEE
return|;
else|else
return|return
name|WPS_REQ_REGISTRAR
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_clear_wps
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|id
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|remove_ssid
init|=
name|NULL
decl_stmt|,
modifier|*
name|prev_current
decl_stmt|;
name|wpa_s
operator|->
name|after_wps
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|known_wps_freq
operator|=
literal|0
expr_stmt|;
name|prev_current
operator|=
name|wpa_s
operator|->
name|current_ssid
expr_stmt|;
comment|/* Enable the networks disabled during wpas_wps_reassoc */
name|wpas_wps_reenable_networks
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_clear_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Remove any existing WPS network from configuration */
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
while|while
condition|(
name|ssid
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
condition|)
block|{
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|wpa_s
operator|->
name|own_disconnect_req
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
name|id
operator|=
name|ssid
operator|->
name|id
expr_stmt|;
name|remove_ssid
operator|=
name|ssid
expr_stmt|;
block|}
else|else
name|id
operator|=
operator|-
literal|1
expr_stmt|;
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|id
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|prev_current
operator|==
name|remove_ssid
condition|)
block|{
name|wpa_sm_set_config
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_notify_config
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|remove_ssid
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
block|}
block|}
name|wpas_wps_clear_ap_info
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_timeout
parameter_list|(
name|void
modifier|*
name|eloop_ctx
parameter_list|,
name|void
modifier|*
name|timeout_ctx
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|eloop_ctx
decl_stmt|;
name|union
name|wps_event_data
name|data
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_TIMEOUT
literal|"Requested operation timed "
literal|"out"
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|fail
operator|.
name|config_error
operator|=
name|WPS_CFG_MSG_TIMEOUT
expr_stmt|;
name|data
operator|.
name|fail
operator|.
name|error_indication
operator|=
name|WPS_EI_NO_ERROR
expr_stmt|;
comment|/* 	 * Call wpas_notify_wps_event_fail() directly instead of through 	 * wpa_supplicant_wps_event() which would end up registering unnecessary 	 * timeouts (those are only for the case where the failure happens 	 * during an EAP-WSC exchange). 	 */
name|wpas_notify_wps_event_fail
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|.
name|fail
argument_list|)
expr_stmt|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_ssid
modifier|*
name|wpas_wps_add_network
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|registrar
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|wpas_notify_network_added
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"key_mgmt"
argument_list|,
literal|"WPS"
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
operator|||
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"eap"
argument_list|,
literal|"WSC"
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
operator|||
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"identity"
argument_list|,
name|registrar
condition|?
literal|"\""
name|WSC_ID_REGISTRAR
literal|"\""
else|:
literal|"\""
name|WSC_ID_ENROLLEE
literal|"\""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|dev_addr
condition|)
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|go_p2p_dev_addr
argument_list|,
name|dev_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|bssid
condition|)
block|{
ifndef|#
directive|ifndef
name|CONFIG_P2P
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|bssid_set
operator|=
literal|1
expr_stmt|;
comment|/* 		 * Note: With P2P, the SSID may change at the time the WPS 		 * provisioning is started, so better not filter the AP based 		 * on the current SSID in the scan results. 		 */
ifndef|#
directive|ifndef
name|CONFIG_P2P
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
if|if
condition|(
name|os_memcmp
argument_list|(
name|bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
continue|continue;
name|os_free
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_malloc
argument_list|(
name|bss
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|bss
operator|->
name|ssid_len
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Picked SSID from "
literal|"scan results"
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|count
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: More than one SSID found "
literal|"for the AP; use wildcard"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|NULL
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
block|}
return|return
name|ssid
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_temp_disable
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|selected
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
condition|)
block|{
name|wpa_s
operator|->
name|own_disconnect_req
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
comment|/* Mark all other networks disabled and trigger reassociation */
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
while|while
condition|(
name|ssid
condition|)
block|{
name|int
name|was_disabled
init|=
name|ssid
operator|->
name|disabled
decl_stmt|;
name|ssid
operator|->
name|disabled_for_connect
operator|=
literal|0
expr_stmt|;
comment|/* 		 * In case the network object corresponds to a persistent group 		 * then do not send out network disabled signal. In addition, 		 * do not change disabled status of persistent network objects 		 * from 2 to 1 should we connect to another network. 		 */
if|if
condition|(
name|was_disabled
operator|!=
literal|2
condition|)
block|{
name|ssid
operator|->
name|disabled
operator|=
name|ssid
operator|!=
name|selected
expr_stmt|;
if|if
condition|(
name|was_disabled
operator|!=
name|ssid
operator|->
name|disabled
condition|)
block|{
if|if
condition|(
name|ssid
operator|->
name|disabled
condition|)
name|ssid
operator|->
name|disabled_for_connect
operator|=
literal|1
expr_stmt|;
name|wpas_notify_network_enabled_changed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
block|}
block|}
name|ssid
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_reassoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|selected
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|wpa_s
operator|->
name|wps_run
operator|++
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps_run
operator|==
literal|0
condition|)
name|wpa_s
operator|->
name|wps_run
operator|++
expr_stmt|;
name|wpa_s
operator|->
name|after_wps
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|known_wps_freq
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|freq
condition|)
block|{
name|wpa_s
operator|->
name|after_wps
operator|=
literal|5
expr_stmt|;
name|wpa_s
operator|->
name|wps_freq
operator|=
name|freq
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bssid
condition|)
block|{
name|bss
operator|=
name|wpa_bss_get_bssid_latest
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|bss
operator|&&
name|bss
operator|->
name|freq
operator|>
literal|0
condition|)
block|{
name|wpa_s
operator|->
name|known_wps_freq
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|wps_freq
operator|=
name|bss
operator|->
name|freq
expr_stmt|;
block|}
block|}
name|wpas_wps_temp_disable
argument_list|(
name|wpa_s
argument_list|,
name|selected
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|disconnected
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|scan_runs
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|normal_scans
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|wps_success
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|blacklist_cleared
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_wps_start_pbc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
name|int
name|p2p_group
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reject request to start Registrar(as station) operation while AP mode is enabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpas_wps_add_network
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|p2p_group
operator|=
name|p2p_group
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|p2p_group
operator|&&
name|wpa_s
operator|->
name|go_params
operator|&&
name|wpa_s
operator|->
name|go_params
operator|->
name|ssid_len
condition|)
block|{
name|ssid
operator|->
name|ssid
operator|=
name|os_zalloc
argument_list|(
name|wpa_s
operator|->
name|go_params
operator|->
name|ssid_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
condition|)
block|{
name|ssid
operator|->
name|ssid_len
operator|=
name|wpa_s
operator|->
name|go_params
operator|->
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|wpa_s
operator|->
name|go_params
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Use specific AP "
literal|"SSID"
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase1"
argument_list|,
literal|"\"pbc=1\""
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|wps_fragment_size
condition|)
name|ssid
operator|->
name|eap
operator|.
name|fragment_size
operator|=
name|wpa_s
operator|->
name|wps_fragment_size
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_wps_reassoc
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bssid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_wps_start_dev_pw
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
name|int
name|p2p_group
parameter_list|,
name|u16
name|dev_pw_id
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_pubkey_hash
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid_val
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|char
name|val
index|[
literal|128
operator|+
literal|2
operator|*
name|WPS_OOB_PUBKEY_HASH_LEN
index|]
decl_stmt|;
name|unsigned
name|int
name|rpin
init|=
literal|0
decl_stmt|;
name|char
name|hash
index|[
literal|2
operator|*
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|10
index|]
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reject request to start Registrar(as station) operation while AP mode is enabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|bssid
operator|&&
name|is_zero_ether_addr
argument_list|(
name|bssid
argument_list|)
condition|)
name|bssid
operator|=
name|NULL
expr_stmt|;
name|ssid
operator|=
name|wpas_wps_add_network
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
name|dev_addr
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Could not add network"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|ssid
operator|->
name|p2p_group
operator|=
name|p2p_group
expr_stmt|;
if|if
condition|(
name|ssid_val
condition|)
block|{
name|ssid
operator|->
name|ssid
operator|=
name|os_malloc
argument_list|(
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
condition|)
block|{
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid_val
argument_list|,
name|ssid_len
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid_len
operator|=
name|ssid_len
expr_stmt|;
block|}
block|}
if|if
condition|(
name|peer_pubkey_hash
condition|)
block|{
name|os_memcpy
argument_list|(
name|hash
argument_list|,
literal|" pkhash="
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|wpa_snprintf_hex_uppercase
argument_list|(
name|hash
operator|+
literal|8
argument_list|,
sizeof|sizeof
argument_list|(
name|hash
argument_list|)
operator|-
literal|8
argument_list|,
name|peer_pubkey_hash
argument_list|,
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|hash
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_P2P
if|if
condition|(
name|p2p_group
operator|&&
name|wpa_s
operator|->
name|go_params
operator|&&
name|wpa_s
operator|->
name|go_params
operator|->
name|ssid_len
condition|)
block|{
name|os_free
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|ssid
operator|=
name|os_zalloc
argument_list|(
name|wpa_s
operator|->
name|go_params
operator|->
name|ssid_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid
condition|)
block|{
name|ssid
operator|->
name|ssid_len
operator|=
name|wpa_s
operator|->
name|go_params
operator|->
name|ssid_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|ssid
operator|->
name|ssid
argument_list|,
name|wpa_s
operator|->
name|go_params
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Use specific AP "
literal|"SSID"
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|pin
condition|)
name|os_snprintf
argument_list|(
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|,
literal|"\"pin=%s dev_pw_id=%u%s\""
argument_list|,
name|pin
argument_list|,
name|dev_pw_id
argument_list|,
name|hash
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pin
operator|==
name|NULL
operator|&&
name|dev_pw_id
operator|==
name|DEV_PW_NFC_CONNECTION_HANDOVER
condition|)
block|{
name|os_snprintf
argument_list|(
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|,
literal|"\"dev_pw_id=%u%s\""
argument_list|,
name|dev_pw_id
argument_list|,
name|hash
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rpin
operator|=
name|wps_generate_pin
argument_list|()
expr_stmt|;
name|os_snprintf
argument_list|(
name|val
argument_list|,
sizeof|sizeof
argument_list|(
name|val
argument_list|)
argument_list|,
literal|"\"pin=%08d dev_pw_id=%u%s\""
argument_list|,
name|rpin
argument_list|,
name|dev_pw_id
argument_list|,
name|hash
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase1"
argument_list|,
name|val
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to set phase1 '%s'"
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wps_fragment_size
condition|)
name|ssid
operator|->
name|eap
operator|.
name|fragment_size
operator|=
name|wpa_s
operator|->
name|wps_fragment_size
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wps_ap_iter
operator|=
literal|1
expr_stmt|;
name|wpas_wps_reassoc
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bssid
argument_list|,
name|freq
argument_list|)
expr_stmt|;
return|return
name|rpin
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_start_pin
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
name|int
name|p2p_group
parameter_list|,
name|u16
name|dev_pw_id
parameter_list|)
block|{
name|os_get_reltime
argument_list|(
operator|&
name|wpa_s
operator|->
name|wps_pin_start_time
argument_list|)
expr_stmt|;
return|return
name|wpas_wps_start_dev_pw
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|bssid
argument_list|,
name|pin
argument_list|,
name|p2p_group
argument_list|,
name|dev_pw_id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|wpas_wps_pbc_overlap
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|union
name|wps_event_data
name|data
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|data
operator|.
name|fail
operator|.
name|config_error
operator|=
name|WPS_CFG_MULTIPLE_PBC_DETECTED
expr_stmt|;
name|data
operator|.
name|fail
operator|.
name|error_indication
operator|=
name|WPS_EI_NO_ERROR
expr_stmt|;
comment|/* 	 * Call wpas_notify_wps_event_fail() directly instead of through 	 * wpa_supplicant_wps_event() which would end up registering unnecessary 	 * timeouts (those are only for the case where the failure happens 	 * during an EAP-WSC exchange). 	 */
name|wpas_notify_wps_event_fail
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|data
operator|.
name|fail
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Cancel the wps pbc/pin requests */
end_comment

begin_function
name|int
name|wpas_wps_cancel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Cancelling in AP mode"
argument_list|)
expr_stmt|;
return|return
name|wpa_supplicant_ap_wps_cancel
argument_list|(
name|wpa_s
argument_list|)
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_SCANNING
operator|||
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_DISCONNECTED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Cancel operation - cancel scan"
argument_list|)
expr_stmt|;
name|wpa_supplicant_cancel_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_ASSOCIATED
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Cancel operation - "
literal|"deauthenticate"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|own_disconnect_req
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpas_wps_reenable_networks
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpas_wps_clear_ap_info
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_clear_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
operator|>
literal|0
condition|)
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|after_wps
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_start_reg
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
name|struct
name|wps_new_ap_settings
modifier|*
name|settings
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|char
name|val
index|[
literal|200
index|]
decl_stmt|;
name|char
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|int
name|res
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Reject request to start Registrar(as station) operation while AP mode is enabled"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_AP */
if|if
condition|(
operator|!
name|pin
condition|)
return|return
operator|-
literal|1
return|;
name|wpas_clear_wps
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpas_wps_add_network
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|,
name|NULL
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|ssid
operator|->
name|temporary
operator|=
literal|1
expr_stmt|;
name|pos
operator|=
name|val
expr_stmt|;
name|end
operator|=
name|pos
operator|+
sizeof|sizeof
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|res
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"\"pin=%s"
argument_list|,
name|pin
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|res
expr_stmt|;
if|if
condition|(
name|settings
condition|)
block|{
name|res
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|" new_ssid=%s new_auth=%s "
literal|"new_encr=%s new_key=%s"
argument_list|,
name|settings
operator|->
name|ssid_hex
argument_list|,
name|settings
operator|->
name|auth
argument_list|,
name|settings
operator|->
name|encr
argument_list|,
name|settings
operator|->
name|key_hex
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|pos
operator|+=
name|res
expr_stmt|;
block|}
name|res
operator|=
name|os_snprintf
argument_list|(
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|,
literal|"\""
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_snprintf_error
argument_list|(
name|end
operator|-
name|pos
argument_list|,
name|res
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
literal|"phase1"
argument_list|,
name|val
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|wps_fragment_size
condition|)
name|ssid
operator|->
name|eap
operator|.
name|fragment_size
operator|=
name|wpa_s
operator|->
name|wps_fragment_size
expr_stmt|;
name|eloop_register_timeout
argument_list|(
name|WPS_PBC_WALK_TIME
argument_list|,
literal|0
argument_list|,
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_wps_reassoc
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|bssid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_wps_new_psk_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|mac_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|p2p_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|psk
parameter_list|,
name|size_t
name|psk_len
parameter_list|)
block|{
if|if
condition|(
name|is_zero_ether_addr
argument_list|(
name|p2p_dev_addr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Received new WPA/WPA2-PSK from WPS for STA "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Received new WPA/WPA2-PSK from WPS for STA "
name|MACSTR
literal|" P2P Device Addr "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|mac_addr
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|p2p_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Per-device PSK"
argument_list|,
name|psk
argument_list|,
name|psk_len
argument_list|)
expr_stmt|;
comment|/* TODO */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_pin_needed_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
specifier|const
name|u8
modifier|*
name|uuid_e
parameter_list|,
specifier|const
name|struct
name|wps_device_data
modifier|*
name|dev
parameter_list|)
block|{
name|char
name|uuid
index|[
literal|40
index|]
decl_stmt|,
name|txt
index|[
literal|400
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|char
name|devtype
index|[
name|WPS_DEV_TYPE_BUFSIZE
index|]
decl_stmt|;
if|if
condition|(
name|uuid_bin2str
argument_list|(
name|uuid_e
argument_list|,
name|uuid
argument_list|,
sizeof|sizeof
argument_list|(
name|uuid
argument_list|)
argument_list|)
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: PIN needed for UUID-E %s"
argument_list|,
name|uuid
argument_list|)
expr_stmt|;
name|len
operator|=
name|os_snprintf
argument_list|(
name|txt
argument_list|,
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
literal|"WPS-EVENT-PIN-NEEDED %s "
name|MACSTR
literal|" [%s|%s|%s|%s|%s|%s]"
argument_list|,
name|uuid
argument_list|,
name|MAC2STR
argument_list|(
name|dev
operator|->
name|mac_addr
argument_list|)
argument_list|,
name|dev
operator|->
name|device_name
argument_list|,
name|dev
operator|->
name|manufacturer
argument_list|,
name|dev
operator|->
name|model_name
argument_list|,
name|dev
operator|->
name|model_number
argument_list|,
name|dev
operator|->
name|serial_number
argument_list|,
name|wps_dev_type_bin2str
argument_list|(
name|dev
operator|->
name|pri_dev_type
argument_list|,
name|devtype
argument_list|,
sizeof|sizeof
argument_list|(
name|devtype
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|os_snprintf_error
argument_list|(
sizeof|sizeof
argument_list|(
name|txt
argument_list|)
argument_list|,
name|len
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"%s"
argument_list|,
name|txt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_set_sel_reg_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|,
name|int
name|sel_reg
parameter_list|,
name|u16
name|dev_passwd_id
parameter_list|,
name|u16
name|sel_reg_config_methods
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|ctx
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps_er
operator|==
name|NULL
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: SetSelectedRegistrar - sel_reg=%d "
literal|"dev_password_id=%u sel_reg_config_methods=0x%x"
argument_list|,
name|sel_reg
argument_list|,
name|dev_passwd_id
argument_list|,
name|sel_reg_config_methods
argument_list|)
expr_stmt|;
name|wps_er_set_sel_reg
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|sel_reg
argument_list|,
name|dev_passwd_id
argument_list|,
name|sel_reg_config_methods
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_ER */
block|}
end_function

begin_function
specifier|static
name|u16
name|wps_fix_config_methods
parameter_list|(
name|u16
name|config_methods
parameter_list|)
block|{
if|if
condition|(
operator|(
name|config_methods
operator|&
operator|(
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_VIRT_DISPLAY
operator||
name|WPS_CONFIG_PHY_DISPLAY
operator|)
operator|)
operator|==
name|WPS_CONFIG_DISPLAY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Converting display to "
literal|"virtual_display for WPS 2.0 compliance"
argument_list|)
expr_stmt|;
name|config_methods
operator||=
name|WPS_CONFIG_VIRT_DISPLAY
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|config_methods
operator|&
operator|(
name|WPS_CONFIG_PUSHBUTTON
operator||
name|WPS_CONFIG_VIRT_PUSHBUTTON
operator||
name|WPS_CONFIG_PHY_PUSHBUTTON
operator|)
operator|)
operator|==
name|WPS_CONFIG_PUSHBUTTON
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WPS: Converting push_button to "
literal|"virtual_push_button for WPS 2.0 compliance"
argument_list|)
expr_stmt|;
name|config_methods
operator||=
name|WPS_CONFIG_VIRT_PUSHBUTTON
expr_stmt|;
block|}
return|return
name|config_methods
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_set_uuid
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
name|char
name|buf
index|[
literal|50
index|]
decl_stmt|;
specifier|const
name|char
modifier|*
name|src
decl_stmt|;
if|if
condition|(
name|is_nil_uuid
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|uuid
argument_list|)
condition|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|first
decl_stmt|;
name|first
operator|=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
expr_stmt|;
while|while
condition|(
name|first
operator|&&
name|first
operator|->
name|next
condition|)
name|first
operator|=
name|first
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|first
operator|&&
name|first
operator|!=
name|wpa_s
condition|)
block|{
if|if
condition|(
name|wps
operator|!=
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
operator|->
name|wps
condition|)
name|os_memcpy
argument_list|(
name|wps
operator|->
name|uuid
argument_list|,
name|wpa_s
operator|->
name|global
operator|->
name|ifaces
operator|->
name|wps
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|src
operator|=
literal|"from the first interface"
expr_stmt|;
block|}
else|else
block|{
name|uuid_gen_mac_addr
argument_list|(
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wps
operator|->
name|uuid
argument_list|)
expr_stmt|;
name|src
operator|=
literal|"based on MAC address"
expr_stmt|;
block|}
block|}
else|else
block|{
name|os_memcpy
argument_list|(
name|wps
operator|->
name|uuid
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|src
operator|=
literal|"based on configuration"
expr_stmt|;
block|}
name|uuid_bin2str
argument_list|(
name|wps
operator|->
name|uuid
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID %s: %s"
argument_list|,
name|src
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_set_vendor_ext_m1
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|vendor_ext_m1
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|vendor_ext_m1
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext_m1
condition|)
block|{
name|wps
operator|->
name|dev
operator|.
name|vendor_ext_m1
operator|=
name|wpabuf_dup
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext_m1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wps
operator|->
name|dev
operator|.
name|vendor_ext_m1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Cannot "
literal|"allocate memory for vendor_ext_m1"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|wpas_wps_init
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wps_context
modifier|*
name|wps
decl_stmt|;
name|struct
name|wps_registrar_config
name|rcfg
decl_stmt|;
name|struct
name|hostapd_hw_modes
modifier|*
name|modes
decl_stmt|;
name|u16
name|m
decl_stmt|;
name|wps
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|wps
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wps
operator|->
name|cred_cb
operator|=
name|wpa_supplicant_wps_cred
expr_stmt|;
name|wps
operator|->
name|event_cb
operator|=
name|wpa_supplicant_wps_event
expr_stmt|;
name|wps
operator|->
name|rf_band_cb
operator|=
name|wpa_supplicant_wps_rf_band
expr_stmt|;
name|wps
operator|->
name|cb_ctx
operator|=
name|wpa_s
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|device_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|manufacturer
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|manufacturer
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|model_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|model_name
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|model_number
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|model_number
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|serial_number
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|serial_number
expr_stmt|;
name|wps
operator|->
name|config_methods
operator|=
name|wps_config_methods_str2bin
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|config_methods
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wps
operator|->
name|config_methods
operator|&
operator|(
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_LABEL
operator|)
operator|)
operator|==
operator|(
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_LABEL
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Both Label and Display config "
literal|"methods are not allowed at the same time"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|config_methods
operator|=
name|wps_fix_config_methods
argument_list|(
name|wps
operator|->
name|config_methods
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|config_methods
operator|=
name|wps
operator|->
name|config_methods
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|pri_dev_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|num_sec_dev_types
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|num_sec_device_types
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|sec_dev_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|sec_device_type
argument_list|,
name|WPS_DEV_TYPE_LEN
operator|*
name|wps
operator|->
name|dev
operator|.
name|num_sec_dev_types
argument_list|)
expr_stmt|;
name|wpas_wps_set_vendor_ext_m1
argument_list|(
name|wpa_s
argument_list|,
name|wps
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|os_version
operator|=
name|WPA_GET_BE32
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|os_version
argument_list|)
expr_stmt|;
name|modes
operator|=
name|wpa_s
operator|->
name|hw
operator|.
name|modes
expr_stmt|;
if|if
condition|(
name|modes
condition|)
block|{
for|for
control|(
name|m
operator|=
literal|0
init|;
name|m
operator|<
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
condition|;
name|m
operator|++
control|)
block|{
if|if
condition|(
name|modes
index|[
name|m
index|]
operator|.
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211B
operator|||
name|modes
index|[
name|m
index|]
operator|.
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211G
condition|)
name|wps
operator|->
name|dev
operator|.
name|rf_bands
operator||=
name|WPS_RF_24GHZ
expr_stmt|;
elseif|else
if|if
condition|(
name|modes
index|[
name|m
index|]
operator|.
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211A
condition|)
name|wps
operator|->
name|dev
operator|.
name|rf_bands
operator||=
name|WPS_RF_50GHZ
expr_stmt|;
elseif|else
if|if
condition|(
name|modes
index|[
name|m
index|]
operator|.
name|mode
operator|==
name|HOSTAPD_MODE_IEEE80211AD
condition|)
name|wps
operator|->
name|dev
operator|.
name|rf_bands
operator||=
name|WPS_RF_60GHZ
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wps
operator|->
name|dev
operator|.
name|rf_bands
operator|==
literal|0
condition|)
block|{
comment|/* 		 * Default to claiming support for both bands if the driver 		 * does not provide support for fetching supported bands. 		 */
name|wps
operator|->
name|dev
operator|.
name|rf_bands
operator|=
name|WPS_RF_24GHZ
operator||
name|WPS_RF_50GHZ
expr_stmt|;
block|}
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|mac_addr
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpas_wps_set_uuid
argument_list|(
name|wpa_s
argument_list|,
name|wps
argument_list|)
expr_stmt|;
name|wps
operator|->
name|auth_types
operator|=
name|WPS_AUTH_WPA2PSK
operator||
name|WPS_AUTH_WPAPSK
expr_stmt|;
name|wps
operator|->
name|encr_types
operator|=
name|WPS_ENCR_AES
operator||
name|WPS_ENCR_TKIP
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|rcfg
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|rcfg
argument_list|)
argument_list|)
expr_stmt|;
name|rcfg
operator|.
name|new_psk_cb
operator|=
name|wpas_wps_new_psk_cb
expr_stmt|;
name|rcfg
operator|.
name|pin_needed_cb
operator|=
name|wpas_wps_pin_needed_cb
expr_stmt|;
name|rcfg
operator|.
name|set_sel_reg_cb
operator|=
name|wpas_wps_set_sel_reg_cb
expr_stmt|;
name|rcfg
operator|.
name|cb_ctx
operator|=
name|wpa_s
expr_stmt|;
name|wps
operator|->
name|registrar
operator|=
name|wps_registrar_init
argument_list|(
name|wps
argument_list|,
operator|&
name|rcfg
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|registrar
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to initialize WPS Registrar"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wpa_s
operator|->
name|wps
operator|=
name|wps
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
end_ifdef

begin_function
specifier|static
name|void
name|wpas_wps_nfc_clear
parameter_list|(
name|struct
name|wps_context
modifier|*
name|wps
parameter_list|)
block|{
name|wps
operator|->
name|ap_nfc_dev_pw_id
operator|=
literal|0
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|ap_nfc_dh_pubkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dh_pubkey
operator|=
name|NULL
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|ap_nfc_dh_privkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dh_privkey
operator|=
name|NULL
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|ap_nfc_dev_pw
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dev_pw
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_ER */
end_comment

begin_function
name|void
name|wpas_wps_deinit
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpas_wps_assoc_with_cred_cancel
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_clear_timeout
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_cancel_timeout
argument_list|(
name|wpas_wps_reenable_networks_cb
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpas_wps_clear_ap_info
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|eloop_cancel_timeout
argument_list|(
name|wpas_p2p_pbc_overlap_cb
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
if|if
condition|(
name|wpa_s
operator|->
name|wps
operator|==
name|NULL
condition|)
return|return;
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
name|wps_er_deinit
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wps_er
operator|=
name|NULL
expr_stmt|;
name|wpas_wps_nfc_clear
argument_list|(
name|wpa_s
operator|->
name|wps
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_ER */
name|wps_registrar_deinit
argument_list|(
name|wpa_s
operator|->
name|wps
operator|->
name|registrar
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|wps
operator|->
name|dh_pubkey
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|wps
operator|->
name|dh_privkey
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|wps
operator|->
name|dev
operator|.
name|vendor_ext_m1
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|wps
operator|->
name|network_key
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|wps
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wps
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_wps_ssid_bss_match
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
condition|)
return|return
operator|-
literal|1
return|;
name|wps_ie
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_is_wps_pbc_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wps_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - non-WPS AP"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|wps_is_selected_pbc_registrar
argument_list|(
name|wps_ie
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - WPS AP "
literal|"without active PBC Registrar"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* TODO: overlap detection */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected based on WPS IE "
literal|"(Active PBC)"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|eap_is_wps_pin_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wps_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - non-WPS AP"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* 		 * Start with WPS APs that advertise our address as an 		 * authorized MAC (v2.0) or active PIN Registrar (v1.0) and 		 * allow any WPS AP after couple of scans since some APs do not 		 * set Selected Registrar attribute properly when using 		 * external Registrar. 		 */
if|if
condition|(
operator|!
name|wps_is_addr_authorized
argument_list|(
name|wps_ie
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
literal|1
argument_list|)
condition|)
block|{
name|struct
name|os_reltime
name|age
decl_stmt|;
name|os_reltime_age
argument_list|(
operator|&
name|wpa_s
operator|->
name|wps_pin_start_time
argument_list|,
operator|&
name|age
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|scan_runs
operator|<
name|WPS_PIN_SCAN_IGNORE_SEL_REG
operator|||
name|age
operator|.
name|sec
operator|<
name|WPS_PIN_TIME_IGNORE_SEL_REG
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   skip - WPS AP without active PIN Registrar (scan_runs=%d age=%d)"
argument_list|,
name|wpa_s
operator|->
name|scan_runs
argument_list|,
operator|(
name|int
operator|)
name|age
operator|.
name|sec
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected based on WPS IE"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected based on WPS IE "
literal|"(Authorized MAC or Active PIN)"
argument_list|)
expr_stmt|;
block|}
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
name|wps_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"   selected based on WPS IE"
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_ssid_wildcard_ok
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps_ie
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|eap_is_wps_pbc_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
block|{
name|wps_ie
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|&&
name|wps_is_selected_pbc_registrar
argument_list|(
name|wps_ie
argument_list|)
condition|)
block|{
comment|/* allow wildcard SSID for WPS PBC */
name|ret
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|eap_is_wps_pin_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
block|{
name|wps_ie
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|&&
operator|(
name|wps_is_addr_authorized
argument_list|(
name|wps_ie
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
literal|1
argument_list|)
operator|||
name|wpa_s
operator|->
name|scan_runs
operator|>=
name|WPS_PIN_SCAN_IGNORE_SEL_REG
operator|)
condition|)
block|{
comment|/* allow wildcard SSID for WPS PIN */
name|ret
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|ret
operator|&&
name|ssid
operator|->
name|bssid_set
operator|&&
name|os_memcmp
argument_list|(
name|ssid
operator|->
name|bssid
argument_list|,
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* allow wildcard SSID due to hardcoded BSSID match */
name|ret
operator|=
literal|1
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS_STRICT
if|if
condition|(
name|wps_ie
condition|)
block|{
if|if
condition|(
name|wps_validate_beacon_probe_resp
argument_list|(
name|wps_ie
argument_list|,
name|bss
operator|->
name|beacon_ie_len
operator|>
literal|0
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bss
operator|->
name|beacon_ie_len
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|bcn_wps
decl_stmt|;
name|bcn_wps
operator|=
name|wpa_bss_get_vendor_ie_multi_beacon
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|bcn_wps
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Mandatory WPS IE "
literal|"missing from AP Beacon"
argument_list|)
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|wps_validate_beacon
argument_list|(
name|wps_ie
argument_list|)
operator|<
literal|0
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
name|wpabuf_free
argument_list|(
name|bcn_wps
argument_list|)
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_STRICT */
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_scan_pbc_overlap
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|selected
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|sel_uuid
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|eap_is_wps_pbc_enrollee
argument_list|(
operator|&
name|ssid
operator|->
name|eap
argument_list|)
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Check whether PBC session overlap is "
literal|"present in scan results; selected BSSID "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|selected
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Make sure that only one AP is in active PBC mode */
name|wps_ie
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|selected
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
condition|)
block|{
name|sel_uuid
operator|=
name|wps_get_uuid_e
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID of the selected BSS"
argument_list|,
name|sel_uuid
argument_list|,
name|UUID_LEN
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Selected BSS does not include "
literal|"WPS IE?!"
argument_list|)
expr_stmt|;
name|sel_uuid
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|num_wps_ap
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wps_ap_info
modifier|*
name|ap
init|=
operator|&
name|wpa_s
operator|->
name|wps_ap
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|ap
operator|->
name|pbc_active
operator|||
name|os_memcmp
argument_list|(
name|selected
operator|->
name|bssid
argument_list|,
name|ap
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Another BSS in active PBC mode: "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|ap
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID of the other BSS"
argument_list|,
name|ap
operator|->
name|uuid
argument_list|,
name|UUID_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|sel_uuid
operator|==
name|NULL
operator|||
name|os_memcmp
argument_list|(
name|sel_uuid
argument_list|,
name|ap
operator|->
name|uuid
argument_list|,
name|UUID_LEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ret
operator|=
literal|1
expr_stmt|;
comment|/* PBC overlap */
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WPS: PBC overlap detected: "
name|MACSTR
literal|" and "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|selected
operator|->
name|bssid
argument_list|)
argument_list|,
name|MAC2STR
argument_list|(
name|ap
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* TODO: verify that this is reasonable dual-band situation */
block|}
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|wpas_wps_notify_scan_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|unsigned
name|int
name|pbc
init|=
literal|0
decl_stmt|,
name|auth
init|=
literal|0
decl_stmt|,
name|pin
init|=
literal|0
decl_stmt|,
name|wps
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|disconnected
operator|||
name|wpa_s
operator|->
name|wpa_state
operator|>=
name|WPA_ASSOCIATED
condition|)
return|return;
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list
argument_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ie
decl_stmt|;
name|ie
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ie
condition|)
continue|continue;
if|if
condition|(
name|wps_is_selected_pbc_registrar
argument_list|(
name|ie
argument_list|)
condition|)
name|pbc
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|wps_is_addr_authorized
argument_list|(
name|ie
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
literal|0
argument_list|)
condition|)
name|auth
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|wps_is_selected_pin_registrar
argument_list|(
name|ie
argument_list|)
condition|)
name|pin
operator|++
expr_stmt|;
else|else
name|wps
operator|++
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ie
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pbc
condition|)
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_AVAILABLE_PBC
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|auth
condition|)
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_AVAILABLE_AUTH
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|pin
condition|)
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_AVAILABLE_PIN
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wps
condition|)
name|wpa_msg_ctrl
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|WPS_EVENT_AP_AVAILABLE
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|wpas_wps_searching
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_WPS
operator|)
operator|&&
operator|!
name|ssid
operator|->
name|disabled
condition|)
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_scan_result_text
parameter_list|(
specifier|const
name|u8
modifier|*
name|ies
parameter_list|,
name|size_t
name|ies_len
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|char
modifier|*
name|end
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wps_ie
operator|=
name|ieee802_11_vendor_ie_concat
argument_list|(
name|ies
argument_list|,
name|ies_len
argument_list|,
name|WPS_DEV_OUI_WFA
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
operator|==
name|NULL
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|wps_attr_text
argument_list|(
name|wps_ie
argument_list|,
name|buf
argument_list|,
name|end
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps_ie
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_er_start
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|filter
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
if|if
condition|(
name|wpa_s
operator|->
name|wps_er
condition|)
block|{
name|wps_er_refresh
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
name|wpa_s
operator|->
name|wps_er
operator|=
name|wps_er_init
argument_list|(
name|wpa_s
operator|->
name|wps
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|filter
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps_er
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
else|#
directive|else
comment|/* CONFIG_WPS_ER */
return|return
literal|0
return|;
endif|#
directive|endif
comment|/* CONFIG_WPS_ER */
block|}
end_function

begin_function
name|void
name|wpas_wps_er_stop
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
name|wps_er_deinit
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wps_er
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS_ER */
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
end_ifdef

begin_function
name|int
name|wpas_wps_er_add_pin
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|)
block|{
name|u8
name|u
index|[
name|UUID_LEN
index|]
decl_stmt|;
specifier|const
name|u8
modifier|*
name|use_uuid
init|=
name|NULL
decl_stmt|;
name|u8
name|addr_buf
index|[
name|ETH_ALEN
index|]
decl_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|uuid
argument_list|,
literal|"any"
argument_list|)
operator|==
literal|0
condition|)
block|{ 	}
elseif|else
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|uuid
argument_list|,
name|u
argument_list|)
operator|==
literal|0
condition|)
block|{
name|use_uuid
operator|=
name|u
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|uuid
argument_list|,
name|addr_buf
argument_list|)
operator|==
literal|0
condition|)
block|{
name|use_uuid
operator|=
name|wps_er_get_sta_uuid
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|addr_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|use_uuid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
block|}
else|else
return|return
operator|-
literal|1
return|;
return|return
name|wps_registrar_add_pin
argument_list|(
name|wpa_s
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|addr
argument_list|,
name|use_uuid
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|pin
argument_list|,
name|os_strlen
argument_list|(
name|pin
argument_list|)
argument_list|,
literal|300
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_er_pbc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|)
block|{
name|u8
name|u
index|[
name|UUID_LEN
index|]
decl_stmt|,
modifier|*
name|use_uuid
init|=
name|NULL
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|use_addr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|uuid
argument_list|,
name|u
argument_list|)
operator|==
literal|0
condition|)
name|use_uuid
operator|=
name|u
expr_stmt|;
elseif|else
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|uuid
argument_list|,
name|addr
argument_list|)
operator|==
literal|0
condition|)
name|use_addr
operator|=
name|addr
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
return|return
name|wps_er_pbc
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|use_uuid
argument_list|,
name|use_addr
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_er_learn
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|)
block|{
name|u8
name|u
index|[
name|UUID_LEN
index|]
decl_stmt|,
modifier|*
name|use_uuid
init|=
name|NULL
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|use_addr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|uuid
argument_list|,
name|u
argument_list|)
operator|==
literal|0
condition|)
name|use_uuid
operator|=
name|u
expr_stmt|;
elseif|else
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|uuid
argument_list|,
name|addr
argument_list|)
operator|==
literal|0
condition|)
name|use_addr
operator|=
name|addr
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
return|return
name|wps_er_learn
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|use_uuid
argument_list|,
name|use_addr
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|pin
argument_list|,
name|os_strlen
argument_list|(
name|pin
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_wps_network_to_cred
parameter_list|(
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|struct
name|wps_credential
modifier|*
name|cred
parameter_list|)
block|{
name|os_memset
argument_list|(
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|cred
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|ssid_len
operator|>
name|SSID_MAX_LEN
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|cred
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid
argument_list|,
name|ssid
operator|->
name|ssid_len
argument_list|)
expr_stmt|;
name|cred
operator|->
name|ssid_len
operator|=
name|ssid
operator|->
name|ssid_len
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
block|{
name|cred
operator|->
name|auth_type
operator|=
operator|(
name|ssid
operator|->
name|proto
operator|&
name|WPA_PROTO_RSN
operator|)
condition|?
name|WPS_AUTH_WPA2PSK
else|:
name|WPS_AUTH_WPAPSK
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_CCMP
condition|)
name|cred
operator|->
name|encr_type
operator|=
name|WPS_ENCR_AES
expr_stmt|;
else|else
name|cred
operator|->
name|encr_type
operator|=
name|WPS_ENCR_TKIP
expr_stmt|;
if|if
condition|(
name|ssid
operator|->
name|passphrase
condition|)
block|{
name|cred
operator|->
name|key_len
operator|=
name|os_strlen
argument_list|(
name|ssid
operator|->
name|passphrase
argument_list|)
expr_stmt|;
if|if
condition|(
name|cred
operator|->
name|key_len
operator|>=
literal|64
condition|)
return|return
operator|-
literal|1
return|;
name|os_memcpy
argument_list|(
name|cred
operator|->
name|key
argument_list|,
name|ssid
operator|->
name|passphrase
argument_list|,
name|cred
operator|->
name|key_len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ssid
operator|->
name|psk_set
condition|)
block|{
name|cred
operator|->
name|key_len
operator|=
literal|32
expr_stmt|;
name|os_memcpy
argument_list|(
name|cred
operator|->
name|key
argument_list|,
name|ssid
operator|->
name|psk
argument_list|,
literal|32
argument_list|)
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|cred
operator|->
name|auth_type
operator|=
name|WPS_AUTH_OPEN
expr_stmt|;
name|cred
operator|->
name|encr_type
operator|=
name|WPS_ENCR_NONE
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_er_set_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|,
name|int
name|id
parameter_list|)
block|{
name|u8
name|u
index|[
name|UUID_LEN
index|]
decl_stmt|,
modifier|*
name|use_uuid
init|=
name|NULL
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|use_addr
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|struct
name|wps_credential
name|cred
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|uuid
argument_list|,
name|u
argument_list|)
operator|==
literal|0
condition|)
name|use_uuid
operator|=
name|u
expr_stmt|;
elseif|else
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|uuid
argument_list|,
name|addr
argument_list|)
operator|==
literal|0
condition|)
name|use_addr
operator|=
name|addr
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|ssid
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpas_wps_network_to_cred
argument_list|(
name|ssid
argument_list|,
operator|&
name|cred
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|wps_er_set_config
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|use_uuid
argument_list|,
name|use_addr
argument_list|,
operator|&
name|cred
argument_list|)
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cred
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_er_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|,
specifier|const
name|char
modifier|*
name|pin
parameter_list|,
name|struct
name|wps_new_ap_settings
modifier|*
name|settings
parameter_list|)
block|{
name|u8
name|u
index|[
name|UUID_LEN
index|]
decl_stmt|,
modifier|*
name|use_uuid
init|=
name|NULL
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|use_addr
init|=
name|NULL
decl_stmt|;
name|struct
name|wps_credential
name|cred
decl_stmt|;
name|size_t
name|len
decl_stmt|;
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|uuid
argument_list|,
name|u
argument_list|)
operator|==
literal|0
condition|)
name|use_uuid
operator|=
name|u
expr_stmt|;
elseif|else
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|uuid
argument_list|,
name|addr
argument_list|)
operator|==
literal|0
condition|)
name|use_addr
operator|=
name|addr
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|settings
operator|->
name|ssid_hex
operator|==
name|NULL
operator|||
name|settings
operator|->
name|auth
operator|==
name|NULL
operator|||
name|settings
operator|->
name|encr
operator|==
name|NULL
operator|||
name|settings
operator|->
name|key_hex
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|os_memset
argument_list|(
operator|&
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|settings
operator|->
name|ssid_hex
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|&
literal|1
operator|)
operator|||
name|len
operator|>
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|cred
operator|.
name|ssid
argument_list|)
operator|||
name|hexstr2bin
argument_list|(
name|settings
operator|->
name|ssid_hex
argument_list|,
name|cred
operator|.
name|ssid
argument_list|,
name|len
operator|/
literal|2
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|cred
operator|.
name|ssid_len
operator|=
name|len
operator|/
literal|2
expr_stmt|;
name|len
operator|=
name|os_strlen
argument_list|(
name|settings
operator|->
name|key_hex
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|len
operator|&
literal|1
operator|)
operator|||
name|len
operator|>
literal|2
operator|*
sizeof|sizeof
argument_list|(
name|cred
operator|.
name|key
argument_list|)
operator|||
name|hexstr2bin
argument_list|(
name|settings
operator|->
name|key_hex
argument_list|,
name|cred
operator|.
name|key
argument_list|,
name|len
operator|/
literal|2
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
name|cred
operator|.
name|key_len
operator|=
name|len
operator|/
literal|2
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|settings
operator|->
name|auth
argument_list|,
literal|"OPEN"
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_OPEN
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|settings
operator|->
name|auth
argument_list|,
literal|"WPAPSK"
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPAPSK
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|settings
operator|->
name|auth
argument_list|,
literal|"WPA2PSK"
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|auth_type
operator|=
name|WPS_AUTH_WPA2PSK
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|settings
operator|->
name|encr
argument_list|,
literal|"NONE"
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_NONE
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_TESTING_OPTIONS
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|settings
operator|->
name|encr
argument_list|,
literal|"WEP"
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_WEP
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_TESTING_OPTIONS */
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|settings
operator|->
name|encr
argument_list|,
literal|"TKIP"
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_TKIP
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|settings
operator|->
name|encr
argument_list|,
literal|"CCMP"
argument_list|)
operator|==
literal|0
condition|)
name|cred
operator|.
name|encr_type
operator|=
name|WPS_ENCR_AES
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
return|return
name|wps_er_config
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|use_uuid
argument_list|,
name|use_addr
argument_list|,
operator|(
specifier|const
name|u8
operator|*
operator|)
name|pin
argument_list|,
name|os_strlen
argument_list|(
name|pin
argument_list|)
argument_list|,
operator|&
name|cred
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
end_ifdef

begin_function
name|struct
name|wpabuf
modifier|*
name|wpas_wps_er_nfc_config_token
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ndef
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ret
decl_stmt|;
name|u8
name|u
index|[
name|UUID_LEN
index|]
decl_stmt|,
modifier|*
name|use_uuid
init|=
name|NULL
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|use_addr
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wps_er
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|uuid
argument_list|,
name|u
argument_list|)
operator|==
literal|0
condition|)
name|use_uuid
operator|=
name|u
expr_stmt|;
elseif|else
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|uuid
argument_list|,
name|addr
argument_list|)
operator|==
literal|0
condition|)
name|use_addr
operator|=
name|addr
expr_stmt|;
else|else
return|return
name|NULL
return|;
name|ret
operator|=
name|wps_er_nfc_config_token
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|use_uuid
argument_list|,
name|use_addr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndef
operator|&&
name|ret
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ndef_build_wifi
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|tmp
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_NFC */
end_comment

begin_decl_stmt
specifier|static
name|int
name|callbacks_pending
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|wpas_wps_terminate_cb
parameter_list|(
name|void
modifier|*
name|ctx
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS ER: Terminated"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|--
name|callbacks_pending
operator|<=
literal|0
condition|)
name|eloop_terminate
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_ER */
end_comment

begin_function
name|int
name|wpas_wps_terminate_pending
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
if|if
condition|(
name|wpa_s
operator|->
name|wps_er
condition|)
block|{
name|callbacks_pending
operator|++
expr_stmt|;
name|wps_er_deinit
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|wpas_wps_terminate_cb
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wps_er
operator|=
name|NULL
expr_stmt|;
return|return
literal|1
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_ER */
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|wpas_wps_update_config
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wps_context
modifier|*
name|wps
init|=
name|wpa_s
operator|->
name|wps
decl_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_CONFIG_METHODS
condition|)
block|{
name|wps
operator|->
name|config_methods
operator|=
name|wps_config_methods_str2bin
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|config_methods
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|wps
operator|->
name|config_methods
operator|&
operator|(
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_LABEL
operator|)
operator|)
operator|==
operator|(
name|WPS_CONFIG_DISPLAY
operator||
name|WPS_CONFIG_LABEL
operator|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WPS: Both Label and Display "
literal|"config methods are not allowed at the "
literal|"same time"
argument_list|)
expr_stmt|;
name|wps
operator|->
name|config_methods
operator|&=
operator|~
name|WPS_CONFIG_LABEL
expr_stmt|;
block|}
block|}
name|wps
operator|->
name|config_methods
operator|=
name|wps_fix_config_methods
argument_list|(
name|wps
operator|->
name|config_methods
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|config_methods
operator|=
name|wps
operator|->
name|config_methods
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_DEVICE_TYPE
condition|)
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|pri_dev_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_SEC_DEVICE_TYPE
condition|)
block|{
name|wps
operator|->
name|dev
operator|.
name|num_sec_dev_types
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|num_sec_device_types
expr_stmt|;
name|os_memcpy
argument_list|(
name|wps
operator|->
name|dev
operator|.
name|sec_dev_type
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|sec_device_type
argument_list|,
name|wps
operator|->
name|dev
operator|.
name|num_sec_dev_types
operator|*
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_VENDOR_EXTENSION
condition|)
name|wpas_wps_set_vendor_ext_m1
argument_list|(
name|wpa_s
argument_list|,
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_OS_VERSION
condition|)
name|wps
operator|->
name|dev
operator|.
name|os_version
operator|=
name|WPA_GET_BE32
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|os_version
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
name|CFG_CHANGED_UUID
condition|)
name|wpas_wps_set_uuid
argument_list|(
name|wpa_s
argument_list|,
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator|&
operator|(
name|CFG_CHANGED_DEVICE_NAME
operator||
name|CFG_CHANGED_WPS_STRING
operator|)
condition|)
block|{
comment|/* Update pointers to make sure they refer current values */
name|wps
operator|->
name|dev
operator|.
name|device_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|manufacturer
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|manufacturer
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|model_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|model_name
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|model_number
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|model_number
expr_stmt|;
name|wps
operator|->
name|dev
operator|.
name|serial_number
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|serial_number
expr_stmt|;
block|}
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
end_ifdef

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wpas_wps_network_config_token
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ndef
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ret
decl_stmt|;
name|struct
name|wps_credential
name|cred
decl_stmt|;
if|if
condition|(
name|wpas_wps_network_to_cred
argument_list|(
name|ssid
argument_list|,
operator|&
name|cred
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|wps_er_config_token_from_cred
argument_list|(
name|wpa_s
operator|->
name|wps
argument_list|,
operator|&
name|cred
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndef
operator|&&
name|ret
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ndef_build_wifi
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|tmp
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_ER */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wpas_wps_nfc_config_token
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ndef
parameter_list|,
specifier|const
name|char
modifier|*
name|id_str
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
if|if
condition|(
name|id_str
condition|)
block|{
name|int
name|id
decl_stmt|;
name|char
modifier|*
name|end
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|id
operator|=
name|strtol
argument_list|(
name|id_str
argument_list|,
operator|&
name|end
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|&&
operator|*
name|end
condition|)
return|return
name|NULL
return|;
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
return|return
name|wpas_wps_network_config_token
argument_list|(
name|wpa_s
argument_list|,
name|ndef
argument_list|,
name|ssid
argument_list|)
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS_ER */
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
return|return
name|wpas_ap_wps_nfc_config_token
argument_list|(
name|wpa_s
argument_list|,
name|ndef
argument_list|)
return|;
endif|#
directive|endif
comment|/* CONFIG_AP */
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wpas_wps_nfc_token
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ndef
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_pw_from_config
condition|)
block|{
return|return
name|wps_nfc_token_build
argument_list|(
name|ndef
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
argument_list|)
return|;
block|}
return|return
name|wps_nfc_token_gen
argument_list|(
name|ndef
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_start_nfc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|go_dev_addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|dev_pw
parameter_list|,
name|u16
name|dev_pw_id
parameter_list|,
name|int
name|p2p_group
parameter_list|,
specifier|const
name|u8
modifier|*
name|peer_pubkey_hash
parameter_list|,
specifier|const
name|u8
modifier|*
name|ssid
parameter_list|,
name|size_t
name|ssid_len
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|struct
name|wps_context
modifier|*
name|wps
init|=
name|wpa_s
operator|->
name|wps
decl_stmt|;
name|char
name|pw
index|[
literal|32
operator|*
literal|2
operator|+
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|dev_pw_id
operator|!=
name|DEV_PW_NFC_CONNECTION_HANDOVER
operator|&&
name|dev_pw
operator|==
name|NULL
condition|)
block|{
name|dev_pw
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw
expr_stmt|;
name|dev_pw_id
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dev_pw_id
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Missing DH params - "
literal|"cannot start NFC-triggered connection"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|dev_pw_id
operator|!=
name|DEV_PW_NFC_CONNECTION_HANDOVER
operator|&&
name|dev_pw
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Missing Device Password (id=%u) - "
literal|"cannot start NFC-triggered connection"
argument_list|,
name|dev_pw_id
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dh5_free
argument_list|(
name|wps
operator|->
name|dh_ctx
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_pubkey
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_privkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dh_privkey
operator|=
name|wpabuf_dup
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dh_pubkey
operator|=
name|wpabuf_dup
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dh_privkey
operator|==
name|NULL
operator|||
name|wps
operator|->
name|dh_pubkey
operator|==
name|NULL
condition|)
block|{
name|wps
operator|->
name|dh_ctx
operator|=
name|NULL
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_pubkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dh_pubkey
operator|=
name|NULL
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_privkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dh_privkey
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to get DH priv/pub key"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|->
name|dh_ctx
operator|=
name|dh5_init_fixed
argument_list|(
name|wps
operator|->
name|dh_privkey
argument_list|,
name|wps
operator|->
name|dh_pubkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|->
name|dh_ctx
operator|==
name|NULL
condition|)
block|{
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_pubkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dh_pubkey
operator|=
name|NULL
expr_stmt|;
name|wpabuf_free
argument_list|(
name|wps
operator|->
name|dh_privkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|dh_privkey
operator|=
name|NULL
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Failed to initialize DH context"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|dev_pw
condition|)
block|{
name|wpa_snprintf_hex_uppercase
argument_list|(
name|pw
argument_list|,
sizeof|sizeof
argument_list|(
name|pw
argument_list|)
argument_list|,
name|wpabuf_head
argument_list|(
name|dev_pw
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|dev_pw
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|wpas_wps_start_dev_pw
argument_list|(
name|wpa_s
argument_list|,
name|go_dev_addr
argument_list|,
name|bssid
argument_list|,
name|dev_pw
condition|?
name|pw
else|:
name|NULL
argument_list|,
name|p2p_group
argument_list|,
name|dev_pw_id
argument_list|,
name|peer_pubkey_hash
argument_list|,
name|ssid
argument_list|,
name|ssid_len
argument_list|,
name|freq
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_wps_use_cred
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
comment|/* 	 * Disable existing networks temporarily to allow the newly learned 	 * credential to be preferred. Enable the temporarily disabled networks 	 * after 10 seconds. 	 */
name|wpas_wps_temp_disable
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eloop_register_timeout
argument_list|(
literal|10
argument_list|,
literal|0
argument_list|,
name|wpas_wps_reenable_networks_cb
argument_list|,
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_oob_use_cred
argument_list|(
name|wpa_s
operator|->
name|wps
argument_list|,
name|attr
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|==
name|WPA_INTERFACE_DISABLED
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|attr
operator|->
name|ap_channel
condition|)
block|{
name|u16
name|chan
init|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|->
name|ap_channel
argument_list|)
decl_stmt|;
name|int
name|freq
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|chan
operator|>=
literal|1
operator|&&
name|chan
operator|<=
literal|13
condition|)
name|freq
operator|=
literal|2407
operator|+
literal|5
operator|*
name|chan
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|==
literal|14
condition|)
name|freq
operator|=
literal|2484
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|>=
literal|30
condition|)
name|freq
operator|=
literal|5000
operator|+
literal|5
operator|*
name|chan
expr_stmt|;
if|if
condition|(
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Credential container indicated AP channel %u -> %u MHz"
argument_list|,
name|chan
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|after_wps
operator|=
literal|5
expr_stmt|;
name|wpa_s
operator|->
name|wps_freq
operator|=
name|freq
expr_stmt|;
block|}
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Request reconnection with new network "
literal|"based on the received credential added"
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|normal_scans
operator|=
literal|0
expr_stmt|;
name|wpa_supplicant_reinit_autoscan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|disconnected
operator|=
literal|0
expr_stmt|;
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_cancel_sched_scan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
end_ifdef

begin_function
specifier|static
name|int
name|wpas_wps_add_nfc_password_token
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wps_parse_attr
modifier|*
name|attr
parameter_list|)
block|{
return|return
name|wps_registrar_add_nfc_password_token
argument_list|(
name|wpa_s
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|attr
operator|->
name|oob_dev_password
argument_list|,
name|attr
operator|->
name|oob_dev_password_len
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_ER */
end_comment

begin_function
specifier|static
name|int
name|wpas_wps_nfc_tag_process
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|wps
parameter_list|)
block|{
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received NFC tag payload"
argument_list|,
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_parse_msg
argument_list|(
name|wps
argument_list|,
operator|&
name|attr
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Ignore invalid data from NFC tag"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|attr
operator|.
name|num_cred
condition|)
return|return
name|wpas_wps_use_cred
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|attr
argument_list|)
return|;
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
if|if
condition|(
name|attr
operator|.
name|oob_dev_password
condition|)
return|return
name|wpas_wps_add_nfc_password_token
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|attr
argument_list|)
return|;
endif|#
directive|endif
comment|/* CONFIG_WPS_ER */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Ignore unrecognized NFC tag"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_nfc_tag_read
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|data
parameter_list|,
name|int
name|forced_freq
parameter_list|)
block|{
specifier|const
name|struct
name|wpabuf
modifier|*
name|wps
init|=
name|data
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|tmp
init|=
name|NULL
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|data
argument_list|)
operator|<
literal|4
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
operator|*
name|wpabuf_head_u8
argument_list|(
name|data
argument_list|)
operator|!=
literal|0x10
condition|)
block|{
comment|/* Assume this contains full NDEF record */
name|tmp
operator|=
name|ndef_parse_wifi
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|tmp
operator|=
name|ndef_parse_p2p
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
condition|)
block|{
name|ret
operator|=
name|wpas_p2p_nfc_tag_process
argument_list|(
name|wpa_s
argument_list|,
name|tmp
argument_list|,
name|forced_freq
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Could not parse NDEF"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|wps
operator|=
name|tmp
expr_stmt|;
block|}
name|ret
operator|=
name|wpas_wps_nfc_tag_process
argument_list|(
name|wpa_s
argument_list|,
name|wps
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|struct
name|wpabuf
modifier|*
name|wpas_wps_nfc_handover_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ndef
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ret
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
operator|==
name|NULL
operator|&&
name|wps_nfc_gen_dh
argument_list|(
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|wps_build_nfc_handover_req
argument_list|(
name|wpa_s
operator|->
name|wps
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndef
operator|&&
name|ret
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ndef_build_wifi
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|tmp
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_WPS_NFC
end_ifdef

begin_function
specifier|static
name|struct
name|wpabuf
modifier|*
name|wpas_wps_er_nfc_handover_sel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ndef
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_WPS_ER
name|struct
name|wpabuf
modifier|*
name|ret
decl_stmt|;
name|u8
name|u
index|[
name|UUID_LEN
index|]
decl_stmt|,
modifier|*
name|use_uuid
init|=
name|NULL
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|use_addr
init|=
name|NULL
decl_stmt|;
name|struct
name|wps_context
modifier|*
name|wps
init|=
name|wpa_s
operator|->
name|wps
decl_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|uuid
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|uuid_str2bin
argument_list|(
name|uuid
argument_list|,
name|u
argument_list|)
operator|==
literal|0
condition|)
name|use_uuid
operator|=
name|u
expr_stmt|;
elseif|else
if|if
condition|(
name|hwaddr_aton
argument_list|(
name|uuid
argument_list|,
name|addr
argument_list|)
operator|==
literal|0
condition|)
name|use_addr
operator|=
name|addr
expr_stmt|;
else|else
return|return
name|NULL
return|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|wps_nfc_gen_dh
argument_list|(
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|,
operator|&
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
operator|<
literal|0
condition|)
return|return
name|NULL
return|;
block|}
name|wpas_wps_nfc_clear
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dev_pw_id
operator|=
name|DEV_PW_NFC_CONNECTION_HANDOVER
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dh_pubkey
operator|=
name|wpabuf_dup
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
name|wps
operator|->
name|ap_nfc_dh_privkey
operator|=
name|wpabuf_dup
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_privkey
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wps
operator|->
name|ap_nfc_dh_pubkey
operator|||
operator|!
name|wps
operator|->
name|ap_nfc_dh_privkey
condition|)
block|{
name|wpas_wps_nfc_clear
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|ret
operator|=
name|wps_er_nfc_handover_sel
argument_list|(
name|wpa_s
operator|->
name|wps_er
argument_list|,
name|wpa_s
operator|->
name|wps
argument_list|,
name|use_uuid
argument_list|,
name|use_addr
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|wps_nfc_dh_pubkey
argument_list|)
expr_stmt|;
if|if
condition|(
name|ndef
operator|&&
name|ret
condition|)
block|{
name|struct
name|wpabuf
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|ndef_build_wifi
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|tmp
expr_stmt|;
block|}
return|return
name|ret
return|;
else|#
directive|else
comment|/* CONFIG_WPS_ER */
return|return
name|NULL
return|;
endif|#
directive|endif
comment|/* CONFIG_WPS_ER */
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_NFC */
end_comment

begin_function
name|struct
name|wpabuf
modifier|*
name|wpas_wps_nfc_handover_sel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|ndef
parameter_list|,
name|int
name|cr
parameter_list|,
specifier|const
name|char
modifier|*
name|uuid
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|cr
condition|)
return|return
name|NULL
return|;
name|ret
operator|=
name|wpas_ap_wps_nfc_handover_sel
argument_list|(
name|wpa_s
argument_list|,
name|ndef
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
return|return
name|ret
return|;
return|return
name|wpas_wps_er_nfc_handover_sel
argument_list|(
name|wpa_s
argument_list|,
name|ndef
argument_list|,
name|uuid
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_wps_nfc_rx_handover_sel
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|u16
name|wsc_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|wpabuf
name|msg
decl_stmt|;
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|u16
name|dev_pw_id
decl_stmt|;
specifier|const
name|u8
modifier|*
name|bssid
init|=
name|NULL
decl_stmt|;
name|int
name|freq
init|=
literal|0
decl_stmt|;
name|wps
operator|=
name|ndef_parse_wifi
argument_list|(
name|data
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received application/vnd.wfa.wsc "
literal|"payload from NFC connection handover"
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: NFC payload"
argument_list|,
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Too short Wi-Fi Handover Select "
literal|"Message"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|wsc_len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|wsc_len
operator|>
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|-
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid WSC attribute length (%u) "
literal|"in Wi-Fi Handover Select Message"
argument_list|,
name|wsc_len
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: WSC attributes in Wi-Fi Handover Select Message"
argument_list|,
name|pos
argument_list|,
name|wsc_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wsc_len
operator|<
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|-
literal|2
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Ignore extra data after WSC attributes"
argument_list|,
name|pos
operator|+
name|wsc_len
argument_list|,
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|-
literal|2
operator|-
name|wsc_len
argument_list|)
expr_stmt|;
block|}
name|wpabuf_set
argument_list|(
operator|&
name|msg
argument_list|,
name|pos
argument_list|,
name|wsc_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wps_parse_msg
argument_list|(
operator|&
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Could not parse WSC attributes in "
literal|"Wi-Fi Handover Select Message"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|attr
operator|.
name|oob_dev_password
operator|==
name|NULL
operator|||
name|attr
operator|.
name|oob_dev_password_len
operator|<
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Out-of-Band Device Password "
literal|"included in Wi-Fi Handover Select Message"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|attr
operator|.
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No SSID included in Wi-Fi Handover "
literal|"Select Message"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_hexdump_ascii
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: SSID"
argument_list|,
name|attr
operator|.
name|ssid
argument_list|,
name|attr
operator|.
name|ssid_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|mac_addr
condition|)
block|{
name|bssid
operator|=
name|attr
operator|.
name|mac_addr
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: MAC Address (BSSID): "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|attr
operator|.
name|rf_bands
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: RF Bands: %d"
argument_list|,
operator|*
name|attr
operator|.
name|rf_bands
argument_list|)
expr_stmt|;
if|if
condition|(
name|attr
operator|.
name|ap_channel
condition|)
block|{
name|u16
name|chan
init|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|ap_channel
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP Channel: %d"
argument_list|,
name|chan
argument_list|)
expr_stmt|;
if|if
condition|(
name|chan
operator|>=
literal|1
operator|&&
name|chan
operator|<=
literal|13
operator|&&
operator|(
name|attr
operator|.
name|rf_bands
operator|==
name|NULL
operator|||
operator|*
name|attr
operator|.
name|rf_bands
operator|&
name|WPS_RF_24GHZ
operator|)
condition|)
name|freq
operator|=
literal|2407
operator|+
literal|5
operator|*
name|chan
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|==
literal|14
operator|&&
operator|(
name|attr
operator|.
name|rf_bands
operator|==
name|NULL
operator|||
operator|*
name|attr
operator|.
name|rf_bands
operator|&
name|WPS_RF_24GHZ
operator|)
condition|)
name|freq
operator|=
literal|2484
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|>=
literal|30
operator|&&
operator|(
name|attr
operator|.
name|rf_bands
operator|==
name|NULL
operator|||
operator|*
name|attr
operator|.
name|rf_bands
operator|&
name|WPS_RF_50GHZ
operator|)
condition|)
name|freq
operator|=
literal|5000
operator|+
literal|5
operator|*
name|chan
expr_stmt|;
elseif|else
if|if
condition|(
name|chan
operator|>=
literal|1
operator|&&
name|chan
operator|<=
literal|4
operator|&&
operator|(
name|attr
operator|.
name|rf_bands
operator|==
name|NULL
operator|||
operator|*
name|attr
operator|.
name|rf_bands
operator|&
name|WPS_RF_60GHZ
operator|)
condition|)
name|freq
operator|=
literal|56160
operator|+
literal|2160
operator|*
name|chan
expr_stmt|;
if|if
condition|(
name|freq
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP indicated channel %u -> %u MHz"
argument_list|,
name|chan
argument_list|,
name|freq
argument_list|)
expr_stmt|;
block|}
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Out-of-Band Device Password"
argument_list|,
name|attr
operator|.
name|oob_dev_password
argument_list|,
name|attr
operator|.
name|oob_dev_password_len
argument_list|)
expr_stmt|;
name|dev_pw_id
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|oob_dev_password
operator|+
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_pw_id
operator|!=
name|DEV_PW_NFC_CONNECTION_HANDOVER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected OOB Device Password ID "
literal|"%u in Wi-Fi Handover Select Message"
argument_list|,
name|dev_pw_id
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP Public Key hash"
argument_list|,
name|attr
operator|.
name|oob_dev_password
argument_list|,
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wpas_wps_start_nfc
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|bssid
argument_list|,
name|NULL
argument_list|,
name|dev_pw_id
argument_list|,
literal|0
argument_list|,
name|attr
operator|.
name|oob_dev_password
argument_list|,
name|attr
operator|.
name|ssid
argument_list|,
name|attr
operator|.
name|ssid_len
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|out
label|:
name|wpabuf_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|wpas_wps_nfc_report_handover
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|req
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|sel
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"NFC: WPS connection handover reported"
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Carrier record in request"
argument_list|,
name|req
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Carrier record in select"
argument_list|,
name|sel
argument_list|)
expr_stmt|;
return|return
name|wpas_wps_nfc_rx_handover_sel
argument_list|(
name|wpa_s
argument_list|,
name|sel
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|wpas_er_wps_nfc_report_handover
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|req
parameter_list|,
specifier|const
name|struct
name|wpabuf
modifier|*
name|sel
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps
decl_stmt|;
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
name|u16
name|wsc_len
decl_stmt|;
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|;
name|struct
name|wpabuf
name|msg
decl_stmt|;
name|struct
name|wps_parse_attr
name|attr
decl_stmt|;
name|u16
name|dev_pw_id
decl_stmt|;
comment|/* 	 * Enrollee/station is always initiator of the NFC connection handover, 	 * so use the request message here to find Enrollee public key hash. 	 */
name|wps
operator|=
name|ndef_parse_wifi
argument_list|(
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Received application/vnd.wfa.wsc "
literal|"payload from NFC connection handover"
argument_list|)
expr_stmt|;
name|wpa_hexdump_buf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: NFC payload"
argument_list|,
name|wps
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Too short Wi-Fi Handover Request "
literal|"Message"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pos
operator|=
name|wpabuf_head
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|wsc_len
operator|=
name|WPA_GET_BE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|wsc_len
operator|>
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|-
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Invalid WSC attribute length (%u) "
literal|"in rt Wi-Fi Handover Request Message"
argument_list|,
name|wsc_len
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|pos
operator|+=
literal|2
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: WSC attributes in Wi-Fi Handover Request Message"
argument_list|,
name|pos
argument_list|,
name|wsc_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wsc_len
operator|<
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|-
literal|2
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Ignore extra data after WSC attributes"
argument_list|,
name|pos
operator|+
name|wsc_len
argument_list|,
name|wpabuf_len
argument_list|(
name|wps
argument_list|)
operator|-
literal|2
operator|-
name|wsc_len
argument_list|)
expr_stmt|;
block|}
name|wpabuf_set
argument_list|(
operator|&
name|msg
argument_list|,
name|pos
argument_list|,
name|wsc_len
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wps_parse_msg
argument_list|(
operator|&
name|msg
argument_list|,
operator|&
name|attr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Could not parse WSC attributes in "
literal|"Wi-Fi Handover Request Message"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|attr
operator|.
name|oob_dev_password
operator|==
name|NULL
operator|||
name|attr
operator|.
name|oob_dev_password_len
operator|<
name|WPS_OOB_PUBKEY_HASH_LEN
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No Out-of-Band Device Password "
literal|"included in Wi-Fi Handover Request Message"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|attr
operator|.
name|uuid_e
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: No UUID-E included in Wi-Fi "
literal|"Handover Request Message"
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: UUID-E"
argument_list|,
name|attr
operator|.
name|uuid_e
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Out-of-Band Device Password"
argument_list|,
name|attr
operator|.
name|oob_dev_password
argument_list|,
name|attr
operator|.
name|oob_dev_password_len
argument_list|)
expr_stmt|;
name|dev_pw_id
operator|=
name|WPA_GET_BE16
argument_list|(
name|attr
operator|.
name|oob_dev_password
operator|+
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev_pw_id
operator|!=
name|DEV_PW_NFC_CONNECTION_HANDOVER
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Unexpected OOB Device Password ID "
literal|"%u in Wi-Fi Handover Request Message"
argument_list|,
name|dev_pw_id
argument_list|)
expr_stmt|;
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: Enrollee Public Key hash"
argument_list|,
name|attr
operator|.
name|oob_dev_password
argument_list|,
name|WPS_OOB_PUBKEY_HASH_LEN
argument_list|)
expr_stmt|;
name|ret
operator|=
name|wps_registrar_add_nfc_pw_token
argument_list|(
name|wpa_s
operator|->
name|wps
operator|->
name|registrar
argument_list|,
name|attr
operator|.
name|oob_dev_password
argument_list|,
name|DEV_PW_NFC_CONNECTION_HANDOVER
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|out
label|:
name|wpabuf_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_WPS_NFC */
end_comment

begin_function
specifier|static
name|void
name|wpas_wps_dump_ap_info
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|struct
name|os_reltime
name|now
decl_stmt|;
if|if
condition|(
name|wpa_debug_level
operator|>
name|MSG_DEBUG
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|wps_ap
operator|==
name|NULL
condition|)
return|return;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|num_wps_ap
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wps_ap_info
modifier|*
name|ap
init|=
operator|&
name|wpa_s
operator|->
name|wps_ap
index|[
name|i
index|]
decl_stmt|;
name|struct
name|wpa_blacklist
modifier|*
name|e
init|=
name|wpa_blacklist_get
argument_list|(
name|wpa_s
argument_list|,
name|ap
operator|->
name|bssid
argument_list|)
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP[%d] "
name|MACSTR
literal|" type=%d "
literal|"tries=%d last_attempt=%d sec ago blacklist=%d"
argument_list|,
operator|(
name|int
operator|)
name|i
argument_list|,
name|MAC2STR
argument_list|(
name|ap
operator|->
name|bssid
argument_list|)
argument_list|,
name|ap
operator|->
name|type
argument_list|,
name|ap
operator|->
name|tries
argument_list|,
name|ap
operator|->
name|last_attempt
operator|.
name|sec
operator|>
literal|0
condition|?
operator|(
name|int
operator|)
name|now
operator|.
name|sec
operator|-
operator|(
name|int
operator|)
name|ap
operator|->
name|last_attempt
operator|.
name|sec
else|:
operator|-
literal|1
argument_list|,
name|e
condition|?
name|e
operator|->
name|count
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|struct
name|wps_ap_info
modifier|*
name|wpas_wps_get_ap_info
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wps_ap
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|num_wps_ap
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|wps_ap_info
modifier|*
name|ap
init|=
operator|&
name|wpa_s
operator|->
name|wps_ap
index|[
name|i
index|]
decl_stmt|;
if|if
condition|(
name|os_memcmp
argument_list|(
name|ap
operator|->
name|bssid
argument_list|,
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|==
literal|0
condition|)
return|return
name|ap
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wpas_wps_update_ap_info_bss
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_res
modifier|*
name|res
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|wps
decl_stmt|;
name|enum
name|wps_ap_info_type
name|type
decl_stmt|;
name|struct
name|wps_ap_info
modifier|*
name|ap
decl_stmt|;
name|int
name|r
decl_stmt|,
name|pbc_active
decl_stmt|;
specifier|const
name|u8
modifier|*
name|uuid
decl_stmt|;
if|if
condition|(
name|wpa_scan_get_vendor_ie
argument_list|(
name|res
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
operator|==
name|NULL
condition|)
return|return;
name|wps
operator|=
name|wpa_scan_get_vendor_ie_multi
argument_list|(
name|res
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps
operator|==
name|NULL
condition|)
return|return;
name|r
operator|=
name|wps_is_addr_authorized
argument_list|(
name|wps
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r
operator|==
literal|2
condition|)
name|type
operator|=
name|WPS_AP_SEL_REG_OUR
expr_stmt|;
elseif|else
if|if
condition|(
name|r
operator|==
literal|1
condition|)
name|type
operator|=
name|WPS_AP_SEL_REG
expr_stmt|;
else|else
name|type
operator|=
name|WPS_AP_NOT_SEL_REG
expr_stmt|;
name|uuid
operator|=
name|wps_get_uuid_e
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|pbc_active
operator|=
name|wps_is_selected_pbc_registrar
argument_list|(
name|wps
argument_list|)
expr_stmt|;
name|ap
operator|=
name|wpas_wps_get_ap_info
argument_list|(
name|wpa_s
argument_list|,
name|res
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
condition|)
block|{
if|if
condition|(
name|ap
operator|->
name|type
operator|!=
name|type
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP "
name|MACSTR
literal|" changed type %d -> %d"
argument_list|,
name|MAC2STR
argument_list|(
name|res
operator|->
name|bssid
argument_list|)
argument_list|,
name|ap
operator|->
name|type
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|ap
operator|->
name|type
operator|=
name|type
expr_stmt|;
if|if
condition|(
name|type
operator|!=
name|WPS_AP_NOT_SEL_REG
condition|)
name|wpa_blacklist_del
argument_list|(
name|wpa_s
argument_list|,
name|ap
operator|->
name|bssid
argument_list|)
expr_stmt|;
block|}
name|ap
operator|->
name|pbc_active
operator|=
name|pbc_active
expr_stmt|;
if|if
condition|(
name|uuid
condition|)
name|os_memcpy
argument_list|(
name|ap
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ap
operator|=
name|os_realloc_array
argument_list|(
name|wpa_s
operator|->
name|wps_ap
argument_list|,
name|wpa_s
operator|->
name|num_wps_ap
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|wps_ap_info
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|==
name|NULL
condition|)
goto|goto
name|out
goto|;
name|wpa_s
operator|->
name|wps_ap
operator|=
name|ap
expr_stmt|;
name|ap
operator|=
operator|&
name|wpa_s
operator|->
name|wps_ap
index|[
name|wpa_s
operator|->
name|num_wps_ap
index|]
expr_stmt|;
name|wpa_s
operator|->
name|num_wps_ap
operator|++
expr_stmt|;
name|os_memset
argument_list|(
name|ap
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|ap
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|ap
operator|->
name|bssid
argument_list|,
name|res
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|ap
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|ap
operator|->
name|pbc_active
operator|=
name|pbc_active
expr_stmt|;
if|if
condition|(
name|uuid
condition|)
name|os_memcpy
argument_list|(
name|ap
operator|->
name|uuid
argument_list|,
name|uuid
argument_list|,
name|WPS_UUID_LEN
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WPS: AP "
name|MACSTR
literal|" type %d added"
argument_list|,
name|MAC2STR
argument_list|(
name|ap
operator|->
name|bssid
argument_list|)
argument_list|,
name|ap
operator|->
name|type
argument_list|)
expr_stmt|;
name|out
label|:
name|wpabuf_free
argument_list|(
name|wps
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_wps_update_ap_info
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_scan_results
modifier|*
name|scan_res
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|scan_res
operator|->
name|num
condition|;
name|i
operator|++
control|)
name|wpas_wps_update_ap_info_bss
argument_list|(
name|wpa_s
argument_list|,
name|scan_res
operator|->
name|res
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|wpas_wps_dump_ap_info
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|wpas_wps_notify_assoc
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|)
block|{
name|struct
name|wps_ap_info
modifier|*
name|ap
decl_stmt|;
name|wpa_s
operator|->
name|after_wps
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wps_ap_iter
condition|)
return|return;
name|ap
operator|=
name|wpas_wps_get_ap_info
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ap
operator|==
name|NULL
condition|)
return|return;
name|ap
operator|->
name|tries
operator|++
expr_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|ap
operator|->
name|last_attempt
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


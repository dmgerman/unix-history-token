begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / dbus-based control interface (P2P)  * Copyright (c) 2011-2012, Intel Corporation  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"../config.h"
end_include

begin_include
include|#
directive|include
file|"../wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"../wps_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"../notify.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new_helpers.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new_handlers.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new_handlers_p2p.h"
end_include

begin_include
include|#
directive|include
file|"dbus_dict_helpers.h"
end_include

begin_include
include|#
directive|include
file|"p2p/p2p.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"ap/hostapd.h"
end_include

begin_include
include|#
directive|include
file|"ap/ap_config.h"
end_include

begin_include
include|#
directive|include
file|"ap/wps_hostapd.h"
end_include

begin_include
include|#
directive|include
file|"../p2p_supplicant.h"
end_include

begin_comment
comment|/**  * Parses out the mac address from the peer object path.  * @peer_path - object path of the form  *	/fi/w1/wpa_supplicant1/Interfaces/n/Peers/00112233445566 (no colons)  * @addr - out param must be of ETH_ALEN size  * Returns 0 if valid (including MAC), -1 otherwise  */
end_comment

begin_function
specifier|static
name|int
name|parse_peer_object_path
parameter_list|(
name|char
modifier|*
name|peer_path
parameter_list|,
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|peer_path
condition|)
return|return
operator|-
literal|1
return|;
name|p
operator|=
name|os_strrchr
argument_list|(
name|peer_path
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|p
condition|)
return|return
operator|-
literal|1
return|;
name|p
operator|++
expr_stmt|;
return|return
name|hwaddr_compact_aton
argument_list|(
name|p
argument_list|,
name|addr
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_error_persistent_group_unknown - Return a new PersistentGroupUnknown  * error message  * @message: Pointer to incoming dbus message this error refers to  * Returns: a dbus error message  *  * Convenience function to create and return an invalid persistent group error.  */
end_comment

begin_function
specifier|static
name|DBusMessage
modifier|*
name|wpas_dbus_error_persistent_group_unknown
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|)
block|{
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_NETWORK_UNKNOWN
argument_list|,
literal|"There is no such persistent group in "
literal|"this P2P device."
argument_list|)
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_find
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|unsigned
name|int
name|timeout
init|=
literal|0
decl_stmt|;
name|enum
name|p2p_discovery_type
name|type
init|=
name|P2P_FIND_ONLY_SOCIAL
decl_stmt|;
name|int
name|num_req_dev_types
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|u8
modifier|*
name|req_dev_types
init|=
name|NULL
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|entry
operator|.
name|key
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"Timeout"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
operator|)
condition|)
block|{
name|timeout
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"RequestedDeviceTypes"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|)
operator|||
operator|(
name|entry
operator|.
name|array_type
operator|!=
name|WPAS_DBUS_TYPE_BINARRAY
operator|)
condition|)
goto|goto
name|error_clear
goto|;
name|os_free
argument_list|(
name|req_dev_types
argument_list|)
expr_stmt|;
name|req_dev_types
operator|=
name|os_malloc
argument_list|(
name|WPS_DEV_TYPE_LEN
operator|*
name|entry
operator|.
name|array_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|req_dev_types
condition|)
goto|goto
name|error_clear
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entry
operator|.
name|array_len
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpabuf_len
argument_list|(
name|entry
operator|.
name|binarray_value
index|[
name|i
index|]
argument_list|)
operator|!=
name|WPS_DEV_TYPE_LEN
condition|)
goto|goto
name|error_clear
goto|;
name|os_memcpy
argument_list|(
name|req_dev_types
operator|+
name|i
operator|*
name|WPS_DEV_TYPE_LEN
argument_list|,
name|wpabuf_head
argument_list|(
name|entry
operator|.
name|binarray_value
index|[
name|i
index|]
argument_list|)
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
block|}
name|num_req_dev_types
operator|=
name|entry
operator|.
name|array_len
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"DiscoveryType"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"start_with_full"
argument_list|)
condition|)
name|type
operator|=
name|P2P_FIND_START_WITH_FULL
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"social"
argument_list|)
condition|)
name|type
operator|=
name|P2P_FIND_ONLY_SOCIAL
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"progressive"
argument_list|)
condition|)
name|type
operator|=
name|P2P_FIND_PROGRESSIVE
expr_stmt|;
else|else
goto|goto
name|error_clear
goto|;
block|}
else|else
goto|goto
name|error_clear
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
name|wpas_p2p_find
argument_list|(
name|wpa_s
argument_list|,
name|timeout
argument_list|,
name|type
argument_list|,
name|num_req_dev_types
argument_list|,
name|req_dev_types
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|req_dev_types
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
name|error_clear
label|:
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|error
label|:
name|os_free
argument_list|(
name|req_dev_types
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|entry
operator|.
name|key
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_stop_find
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpas_p2p_stop_find
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_rejectpeer
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter
decl_stmt|;
name|char
modifier|*
name|peer_object_path
init|=
name|NULL
decl_stmt|;
name|u8
name|peer_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|peer_object_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|parse_peer_object_path
argument_list|(
name|peer_object_path
argument_list|,
name|peer_addr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
if|if
condition|(
name|wpas_p2p_reject
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"Failed to call wpas_p2p_reject method."
argument_list|)
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_listen
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|dbus_int32_t
name|timeout
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_INT32
argument_list|,
operator|&
name|timeout
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
return|;
if|if
condition|(
name|wpas_p2p_listen
argument_list|(
name|wpa_s
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|timeout
argument_list|)
condition|)
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_extendedlisten
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|unsigned
name|int
name|period
init|=
literal|0
decl_stmt|,
name|interval
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|entry
operator|.
name|key
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"period"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
operator|)
condition|)
name|period
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"interval"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
operator|)
condition|)
name|interval
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
else|else
goto|goto
name|error_clear
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpas_p2p_ext_listen
argument_list|(
name|wpa_s
argument_list|,
name|period
argument_list|,
name|interval
argument_list|)
condition|)
return|return
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"failed to initiate a p2p_ext_listen."
argument_list|)
return|;
return|return
name|NULL
return|;
name|error_clear
label|:
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|entry
operator|.
name|key
argument_list|)
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_presence_request
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|unsigned
name|int
name|dur1
init|=
literal|0
decl_stmt|,
name|int1
init|=
literal|0
decl_stmt|,
name|dur2
init|=
literal|0
decl_stmt|,
name|int2
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|entry
operator|.
name|key
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"duration1"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
operator|)
condition|)
name|dur1
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"interval1"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
condition|)
name|int1
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"duration2"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
condition|)
name|dur2
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"interval2"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
condition|)
name|int2
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
else|else
goto|goto
name|error_clear
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpas_p2p_presence_req
argument_list|(
name|wpa_s
argument_list|,
name|dur1
argument_list|,
name|int1
argument_list|,
name|dur2
argument_list|,
name|int2
argument_list|)
operator|<
literal|0
condition|)
return|return
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"Failed to invoke presence request."
argument_list|)
return|;
return|return
name|NULL
return|;
name|error_clear
label|:
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|entry
operator|.
name|key
argument_list|)
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_group_add
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|char
modifier|*
name|pg_object_path
init|=
name|NULL
decl_stmt|;
name|int
name|persistent_group
init|=
literal|0
decl_stmt|;
name|int
name|freq
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|iface
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|net_id_str
init|=
name|NULL
decl_stmt|;
name|unsigned
name|int
name|group_id
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|inv_args
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|inv_args
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"persistent"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_BOOLEAN
operator|)
condition|)
block|{
name|persistent_group
operator|=
operator|(
name|entry
operator|.
name|bool_value
operator|==
name|TRUE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"frequency"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
operator|)
condition|)
block|{
name|freq
operator|=
name|entry
operator|.
name|int32_value
expr_stmt|;
if|if
condition|(
name|freq
operator|<=
literal|0
condition|)
goto|goto
name|inv_args_clear
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"persistent_group_object"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_OBJECT_PATH
condition|)
name|pg_object_path
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
else|else
goto|goto
name|inv_args_clear
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|pg_object_path
operator|!=
name|NULL
condition|)
block|{
comment|/* 		 * A persistent group Object Path is defined meaning we want 		 * to re-invoke a persistent group. 		 */
name|iface
operator|=
name|wpas_dbus_new_decompose_object_path
argument_list|(
name|pg_object_path
argument_list|,
literal|1
argument_list|,
operator|&
name|net_id_str
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
operator|||
name|os_strcmp
argument_list|(
name|iface
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|pg_object_path
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|group_id
operator|=
name|strtoul
argument_list|(
name|net_id_str
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
name|EINVAL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|pg_object_path
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Get the SSID structure from the persistent group id */
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|group_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|disabled
operator|!=
literal|2
condition|)
goto|goto
name|inv_args
goto|;
if|if
condition|(
name|wpas_p2p_group_add_persistent
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
literal|0
argument_list|,
name|freq
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"Failed to reinvoke a persistent group"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|wpas_p2p_group_add
argument_list|(
name|wpa_s
argument_list|,
name|persistent_group
argument_list|,
name|freq
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|inv_args
goto|;
name|out
label|:
name|os_free
argument_list|(
name|pg_object_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|net_id_str
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|iface
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
name|inv_args_clear
label|:
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|inv_args
label|:
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_disconnect
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpas_p2p_disconnect
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"failed to disconnect"
argument_list|)
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|dbus_bool_t
name|wpa_dbus_p2p_check_enabled
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|out_reply
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|)
block|{
comment|/* Return an error message or an error if P2P isn't available */
if|if
condition|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p_disabled
operator|||
name|wpa_s
operator|->
name|global
operator|->
name|p2p
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
name|out_reply
condition|)
block|{
operator|*
name|out_reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"P2P is not available for this interface"
argument_list|)
expr_stmt|;
block|}
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"P2P is not available for this "
literal|"interface"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_flush
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_p2p_check_enabled
argument_list|(
name|wpa_s
argument_list|,
name|message
argument_list|,
operator|&
name|reply
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
name|reply
return|;
name|os_memset
argument_list|(
name|wpa_s
operator|->
name|p2p_auth_invite
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|force_long_sd
operator|=
literal|0
expr_stmt|;
name|p2p_flush
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_connect
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|char
modifier|*
name|peer_object_path
init|=
name|NULL
decl_stmt|;
name|int
name|persistent_group
init|=
literal|0
decl_stmt|;
name|int
name|join
init|=
literal|0
decl_stmt|;
name|int
name|authorize_only
init|=
literal|0
decl_stmt|;
name|int
name|go_intent
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|freq
init|=
literal|0
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|char
modifier|*
name|pin
init|=
name|NULL
decl_stmt|;
name|enum
name|p2p_wps_method
name|wps_method
init|=
name|WPS_NOT_READY
decl_stmt|;
name|int
name|new_pin
decl_stmt|;
name|char
modifier|*
name|err_msg
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|iface
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_p2p_check_enabled
argument_list|(
name|wpa_s
argument_list|,
name|message
argument_list|,
operator|&
name|reply
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
name|reply
return|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|inv_args
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|inv_args
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"peer"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_OBJECT_PATH
operator|)
condition|)
block|{
name|peer_object_path
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"persistent"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_BOOLEAN
operator|)
condition|)
block|{
name|persistent_group
operator|=
operator|(
name|entry
operator|.
name|bool_value
operator|==
name|TRUE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"join"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_BOOLEAN
operator|)
condition|)
block|{
name|join
operator|=
operator|(
name|entry
operator|.
name|bool_value
operator|==
name|TRUE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"authorize_only"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_BOOLEAN
operator|)
condition|)
block|{
name|authorize_only
operator|=
operator|(
name|entry
operator|.
name|bool_value
operator|==
name|TRUE
operator|)
condition|?
literal|1
else|:
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"frequency"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
operator|)
condition|)
block|{
name|freq
operator|=
name|entry
operator|.
name|int32_value
expr_stmt|;
if|if
condition|(
name|freq
operator|<=
literal|0
condition|)
goto|goto
name|inv_args_clear
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"go_intent"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
operator|)
condition|)
block|{
name|go_intent
operator|=
name|entry
operator|.
name|int32_value
expr_stmt|;
if|if
condition|(
operator|(
name|go_intent
operator|<
literal|0
operator|)
operator|||
operator|(
name|go_intent
operator|>
literal|15
operator|)
condition|)
goto|goto
name|inv_args_clear
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"wps_method"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"pbc"
argument_list|)
condition|)
name|wps_method
operator|=
name|WPS_PBC
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"pin"
argument_list|)
condition|)
name|wps_method
operator|=
name|WPS_PIN_DISPLAY
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"display"
argument_list|)
condition|)
name|wps_method
operator|=
name|WPS_PIN_DISPLAY
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"keypad"
argument_list|)
condition|)
name|wps_method
operator|=
name|WPS_PIN_KEYPAD
expr_stmt|;
else|else
goto|goto
name|inv_args_clear
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"pin"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|pin
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|inv_args_clear
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|peer_object_path
operator|||
operator|(
name|wps_method
operator|==
name|WPS_NOT_READY
operator|)
operator|||
operator|(
name|parse_peer_object_path
argument_list|(
name|peer_object_path
argument_list|,
name|addr
argument_list|)
operator|<
literal|0
operator|)
operator|||
operator|!
name|p2p_peer_known
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|addr
argument_list|)
condition|)
goto|goto
name|inv_args
goto|;
comment|/* 	 * Validate the wps_method specified and the pin value. 	 */
if|if
condition|(
operator|(
operator|!
name|pin
operator|||
operator|!
name|pin
index|[
literal|0
index|]
operator|)
operator|&&
operator|(
name|wps_method
operator|==
name|WPS_PIN_KEYPAD
operator|)
condition|)
goto|goto
name|inv_args
goto|;
name|new_pin
operator|=
name|wpas_p2p_connect
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|pin
argument_list|,
name|wps_method
argument_list|,
name|persistent_group
argument_list|,
literal|0
argument_list|,
name|join
argument_list|,
name|authorize_only
argument_list|,
name|go_intent
argument_list|,
name|freq
argument_list|,
operator|-
literal|1
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|new_pin
operator|>=
literal|0
condition|)
block|{
name|char
name|npin
index|[
literal|9
index|]
decl_stmt|;
name|char
modifier|*
name|generated_pin
decl_stmt|;
name|os_snprintf
argument_list|(
name|npin
argument_list|,
sizeof|sizeof
argument_list|(
name|npin
argument_list|)
argument_list|,
literal|"%08d"
argument_list|,
name|new_pin
argument_list|)
expr_stmt|;
name|generated_pin
operator|=
name|npin
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|generated_pin
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
switch|switch
condition|(
name|new_pin
condition|)
block|{
case|case
operator|-
literal|2
case|:
name|err_msg
operator|=
literal|"connect failed due to channel "
literal|"unavailability."
expr_stmt|;
name|iface
operator|=
name|WPAS_DBUS_ERROR_CONNECT_CHANNEL_UNAVAILABLE
expr_stmt|;
break|break;
case|case
operator|-
literal|3
case|:
name|err_msg
operator|=
literal|"connect failed due to unsupported channel."
expr_stmt|;
name|iface
operator|=
name|WPAS_DBUS_ERROR_CONNECT_CHANNEL_UNSUPPORTED
expr_stmt|;
break|break;
default|default:
name|err_msg
operator|=
literal|"connect failed due to unspecified error."
expr_stmt|;
name|iface
operator|=
name|WPAS_DBUS_ERROR_CONNECT_UNSPECIFIED_ERROR
expr_stmt|;
break|break;
block|}
comment|/* 		 * TODO: 		 * Do we need specialized errors corresponding to above 		 * error conditions as against just returning a different 		 * error message? 		 */
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|iface
argument_list|,
name|err_msg
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|os_free
argument_list|(
name|peer_object_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pin
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
name|inv_args_clear
label|:
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|inv_args
label|:
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_invite
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|char
modifier|*
name|peer_object_path
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|pg_object_path
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|iface
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|net_id_str
init|=
name|NULL
decl_stmt|;
name|u8
name|peer_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|unsigned
name|int
name|group_id
init|=
literal|0
decl_stmt|;
name|int
name|persistent
init|=
literal|0
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_p2p_check_enabled
argument_list|(
name|wpa_s
argument_list|,
name|message
argument_list|,
operator|&
name|reply
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
name|reply
return|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|err
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"peer"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_OBJECT_PATH
operator|)
condition|)
block|{
name|peer_object_path
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"persistent_group_object"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_OBJECT_PATH
operator|)
condition|)
block|{
name|pg_object_path
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
name|persistent
operator|=
literal|1
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|peer_object_path
operator|||
operator|(
name|parse_peer_object_path
argument_list|(
name|peer_object_path
argument_list|,
name|peer_addr
argument_list|)
operator|<
literal|0
operator|)
operator|||
operator|!
name|p2p_peer_known
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_addr
argument_list|)
condition|)
block|{
goto|goto
name|err
goto|;
block|}
if|if
condition|(
name|persistent
condition|)
block|{
comment|/* 		 * A group ID is defined meaning we want to re-invoke a 		 * persistent group 		 */
name|iface
operator|=
name|wpas_dbus_new_decompose_object_path
argument_list|(
name|pg_object_path
argument_list|,
literal|1
argument_list|,
operator|&
name|net_id_str
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
operator|||
name|os_strcmp
argument_list|(
name|iface
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|pg_object_path
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|group_id
operator|=
name|strtoul
argument_list|(
name|net_id_str
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
name|EINVAL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|pg_object_path
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Get the SSID structure from the persistent group id */
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|group_id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
operator|||
name|ssid
operator|->
name|disabled
operator|!=
literal|2
condition|)
goto|goto
name|err
goto|;
if|if
condition|(
name|wpas_p2p_invite
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|,
name|ssid
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"Failed to reinvoke a persistent group"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
else|else
block|{
comment|/* 		 * No group ID means propose to a peer to join my active group 		 */
if|if
condition|(
name|wpas_p2p_invite_group
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|ifname
argument_list|,
name|peer_addr
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"Failed to join to an active group"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
name|out
label|:
name|os_free
argument_list|(
name|pg_object_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|peer_object_path
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
name|err
label|:
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_prov_disc_req
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter
decl_stmt|;
name|char
modifier|*
name|peer_object_path
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|config_method
init|=
name|NULL
decl_stmt|;
name|u8
name|peer_addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|peer_object_path
argument_list|)
expr_stmt|;
if|if
condition|(
name|parse_peer_object_path
argument_list|(
name|peer_object_path
argument_list|,
name|peer_addr
argument_list|)
operator|<
literal|0
condition|)
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
name|dbus_message_iter_next
argument_list|(
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|config_method
argument_list|)
expr_stmt|;
comment|/* 	 * Validation checks on config_method are being duplicated here 	 * to be able to return invalid args reply since the error code 	 * from p2p module are not granular enough (yet). 	 */
if|if
condition|(
name|os_strcmp
argument_list|(
name|config_method
argument_list|,
literal|"display"
argument_list|)
operator|&&
name|os_strcmp
argument_list|(
name|config_method
argument_list|,
literal|"keypad"
argument_list|)
operator|&&
name|os_strcmp
argument_list|(
name|config_method
argument_list|,
literal|"pbc"
argument_list|)
operator|&&
name|os_strcmp
argument_list|(
name|config_method
argument_list|,
literal|"pushbutton"
argument_list|)
condition|)
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
if|if
condition|(
name|wpas_p2p_prov_disc
argument_list|(
name|wpa_s
argument_list|,
name|peer_addr
argument_list|,
name|config_method
argument_list|,
name|WPAS_P2P_PD_FOR_GO_NEG
argument_list|)
operator|<
literal|0
condition|)
return|return
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"Failed to send provision discovery request"
argument_list|)
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * P2P Device property accessor methods.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_device_config
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|DBusMessageIter
name|variant_iter
decl_stmt|,
name|dict_iter
decl_stmt|;
name|DBusMessageIter
name|iter_secdev_dict_entry
decl_stmt|,
name|iter_secdev_dict_val
decl_stmt|,
name|iter_secdev_dict_array
decl_stmt|;
specifier|const
name|char
modifier|*
name|dev_name
decl_stmt|;
name|int
name|num_vendor_extensions
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|const
name|struct
name|wpabuf
modifier|*
name|vendor_ext
index|[
name|P2P_MAX_WPS_VENDOR_EXT
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_p2p_check_enabled
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_VARIANT
argument_list|,
literal|"a{sv}"
argument_list|,
operator|&
name|variant_iter
argument_list|)
operator|||
operator|!
name|wpa_dbus_dict_open_write
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* DeviceName */
name|dev_name
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
expr_stmt|;
if|if
condition|(
name|dev_name
operator|&&
operator|!
name|wpa_dbus_dict_append_string
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"DeviceName"
argument_list|,
name|dev_name
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* Primary device type */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_byte_array
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"PrimaryDeviceType"
argument_list|,
operator|(
name|char
operator|*
operator|)
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* Secondary device types */
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|num_sec_device_types
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_array
argument_list|(
argument|&dict_iter
argument_list|,
literal|"SecondaryDeviceTypes"
argument_list|,
argument|DBUS_TYPE_ARRAY_AS_STRING 					       DBUS_TYPE_BYTE_AS_STRING
argument_list|,
argument|&iter_secdev_dict_entry
argument_list|,
argument|&iter_secdev_dict_val
argument_list|,
argument|&iter_secdev_dict_array
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|conf
operator|->
name|num_sec_device_types
condition|;
name|i
operator|++
control|)
name|wpa_dbus_dict_bin_array_add_element
argument_list|(
operator|&
name|iter_secdev_dict_array
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|sec_device_type
index|[
name|i
index|]
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_array
argument_list|(
operator|&
name|dict_iter
argument_list|,
operator|&
name|iter_secdev_dict_entry
argument_list|,
operator|&
name|iter_secdev_dict_val
argument_list|,
operator|&
name|iter_secdev_dict_array
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
block|}
comment|/* Vendor Extensions */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|P2P_MAX_WPS_VENDOR_EXT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|vendor_ext
index|[
name|num_vendor_extensions
operator|++
index|]
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|num_vendor_extensions
operator|&&
operator|!
name|wpa_dbus_dict_append_wpabuf_array
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"VendorExtension"
argument_list|,
name|vendor_ext
argument_list|,
name|num_vendor_extensions
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* GO Intent */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_uint32
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"GOIntent"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_go_intent
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* Persistent Reconnect */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_bool
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"PersistentReconnect"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|persistent_reconnect
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* Listen Reg Class */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_uint32
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"ListenRegClass"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_reg_class
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* Listen Channel */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_uint32
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"ListenChannel"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_channel
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* Oper Reg Class */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_uint32
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"OperRegClass"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* Oper Channel */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_uint32
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"OperChannel"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* SSID Postfix */
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
operator|&&
operator|!
name|wpa_dbus_dict_append_string
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"SsidPostfix"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* Intra Bss */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_bool
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"IntraBss"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_intra_bss
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* Group Idle */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_uint32
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"GroupIdle"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_group_idle
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
comment|/* Dissasociation low ack */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_uint32
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"disassoc_low_ack"
argument_list|,
name|wpa_s
operator|->
name|conf
operator|->
name|disassoc_low_ack
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_close_write
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
operator|||
operator|!
name|dbus_message_iter_close_container
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
goto|goto
name|err_no_mem
goto|;
return|return
name|TRUE
return|;
name|err_no_mem
label|:
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_p2p_device_config
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|DBusMessageIter
name|variant_iter
decl_stmt|,
name|iter_dict
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
init|=
block|{
operator|.
name|type
operator|=
name|DBUS_TYPE_STRING
block|}
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_p2p_check_enabled
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|dbus_message_iter_recurse
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|error
argument_list|)
condition|)
return|return
name|FALSE
return|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_INVALID_ARGS
argument_list|,
literal|"invalid message format"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"DeviceName"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|devname
decl_stmt|;
if|if
condition|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_STRING
condition|)
goto|goto
name|error
goto|;
name|devname
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|devname
operator|==
name|NULL
condition|)
goto|goto
name|err_no_mem_clear
goto|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|device_name
operator|=
name|devname
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_DEVICE_NAME
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"PrimaryDeviceType"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|||
name|entry
operator|.
name|array_type
operator|!=
name|DBUS_TYPE_BYTE
operator|||
name|entry
operator|.
name|array_len
operator|!=
name|WPS_DEV_TYPE_LEN
condition|)
goto|goto
name|error
goto|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|device_type
argument_list|,
name|entry
operator|.
name|bytearray_value
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_DEVICE_TYPE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"SecondaryDeviceTypes"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|||
name|entry
operator|.
name|array_type
operator|!=
name|WPAS_DBUS_TYPE_BINARRAY
operator|||
name|entry
operator|.
name|array_len
operator|>
name|MAX_SEC_DEVICE_TYPES
condition|)
goto|goto
name|error
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entry
operator|.
name|array_len
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|wpabuf_len
argument_list|(
name|entry
operator|.
name|binarray_value
index|[
name|i
index|]
argument_list|)
operator|!=
name|WPS_DEV_TYPE_LEN
condition|)
goto|goto
name|err_no_mem_clear
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|entry
operator|.
name|array_len
condition|;
name|i
operator|++
control|)
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|sec_device_type
index|[
name|i
index|]
argument_list|,
name|wpabuf_head
argument_list|(
name|entry
operator|.
name|binarray_value
index|[
name|i
index|]
argument_list|)
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|num_sec_device_types
operator|=
name|entry
operator|.
name|array_len
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_SEC_DEVICE_TYPE
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"VendorExtension"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|)
operator|||
operator|(
name|entry
operator|.
name|array_type
operator|!=
name|WPAS_DBUS_TYPE_BINARRAY
operator|)
operator|||
operator|(
name|entry
operator|.
name|array_len
operator|>
name|P2P_MAX_WPS_VENDOR_EXT
operator|)
condition|)
goto|goto
name|error
goto|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_VENDOR_EXTENSION
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|P2P_MAX_WPS_VENDOR_EXT
condition|;
name|i
operator|++
control|)
block|{
name|wpabuf_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|entry
operator|.
name|array_len
condition|)
block|{
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|=
name|entry
operator|.
name|binarray_value
index|[
name|i
index|]
expr_stmt|;
name|entry
operator|.
name|binarray_value
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|wpa_s
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"GOIntent"
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_UINT32
operator|)
operator|&&
operator|(
name|entry
operator|.
name|uint32_value
operator|<=
literal|15
operator|)
condition|)
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_go_intent
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"PersistentReconnect"
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_BOOLEAN
operator|)
condition|)
name|wpa_s
operator|->
name|conf
operator|->
name|persistent_reconnect
operator|=
name|entry
operator|.
name|bool_value
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"ListenRegClass"
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_UINT32
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_reg_class
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_P2P_LISTEN_CHANNEL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"ListenChannel"
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_UINT32
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_listen_channel
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_P2P_LISTEN_CHANNEL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"OperRegClass"
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_UINT32
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_reg_class
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_P2P_OPER_CHANNEL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"OperChannel"
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_UINT32
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_oper_channel
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_P2P_OPER_CHANNEL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"SsidPostfix"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|char
modifier|*
name|postfix
decl_stmt|;
if|if
condition|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_STRING
condition|)
goto|goto
name|error
goto|;
name|postfix
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|postfix
condition|)
goto|goto
name|err_no_mem_clear
goto|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_ssid_postfix
operator|=
name|postfix
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_P2P_SSID_POSTFIX
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"IntraBss"
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_BOOLEAN
operator|)
condition|)
block|{
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_intra_bss
operator|=
name|entry
operator|.
name|bool_value
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_P2P_INTRA_BSS
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"GroupIdle"
argument_list|)
operator|==
literal|0
operator|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_UINT32
operator|)
condition|)
name|wpa_s
operator|->
name|conf
operator|->
name|p2p_group_idle
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"disassoc_low_ack"
argument_list|)
operator|==
literal|0
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_UINT32
condition|)
name|wpa_s
operator|->
name|conf
operator|->
name|disassoc_low_ack
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
else|else
goto|goto
name|error
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
condition|)
block|{
comment|/* Some changed parameters requires to update config*/
name|wpa_supplicant_update_config
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
name|error
label|:
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_INVALID_ARGS
argument_list|,
literal|"invalid message format"
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
name|err_no_mem_clear
label|:
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peers
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|struct
name|p2p_data
modifier|*
name|p2p
init|=
name|wpa_s
operator|->
name|global
operator|->
name|p2p
decl_stmt|;
name|int
name|next
init|=
literal|0
decl_stmt|,
name|i
init|=
literal|0
decl_stmt|;
name|int
name|num
init|=
literal|0
decl_stmt|,
name|out_of_mem
init|=
literal|0
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|peer_info
init|=
name|NULL
decl_stmt|;
name|dbus_bool_t
name|success
init|=
name|FALSE
decl_stmt|;
name|struct
name|dl_list
name|peer_objpath_list
decl_stmt|;
struct|struct
name|peer_objpath_node
block|{
name|struct
name|dl_list
name|list
decl_stmt|;
name|char
name|path
index|[
name|WPAS_DBUS_OBJECT_PATH_MAX
index|]
decl_stmt|;
block|}
modifier|*
name|node
struct|,
modifier|*
name|tmp
struct|;
name|char
modifier|*
modifier|*
name|peer_obj_paths
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_p2p_check_enabled
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|dl_list_init
argument_list|(
operator|&
name|peer_objpath_list
argument_list|)
expr_stmt|;
comment|/* Get the first peer info */
name|peer_info
operator|=
name|p2p_get_peer_found
argument_list|(
name|p2p
argument_list|,
name|NULL
argument_list|,
name|next
argument_list|)
expr_stmt|;
comment|/* Get next and accumulate them */
name|next
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|peer_info
operator|!=
name|NULL
condition|)
block|{
name|node
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|peer_objpath_node
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|node
condition|)
block|{
name|out_of_mem
operator|=
literal|1
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|addr
operator|=
name|peer_info
operator|->
name|p2p_device_addr
expr_stmt|;
name|os_snprintf
argument_list|(
name|node
operator|->
name|path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NEW_P2P_PEERS_PART
literal|"/"
name|COMPACT_MACSTR
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|dl_list_add_tail
argument_list|(
operator|&
name|peer_objpath_list
argument_list|,
operator|&
name|node
operator|->
name|list
argument_list|)
expr_stmt|;
name|num
operator|++
expr_stmt|;
name|peer_info
operator|=
name|p2p_get_peer_found
argument_list|(
name|p2p
argument_list|,
name|addr
argument_list|,
name|next
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * Now construct the peer object paths in a form suitable for 	 * array_property_getter helper below. 	 */
name|peer_obj_paths
operator|=
name|os_calloc
argument_list|(
name|num
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|peer_obj_paths
condition|)
block|{
name|out_of_mem
operator|=
literal|1
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|dl_list_for_each_safe
argument_list|(
argument|node
argument_list|,
argument|tmp
argument_list|,
argument|&peer_objpath_list
argument_list|,
argument|struct peer_objpath_node
argument_list|,
argument|list
argument_list|)
name|peer_obj_paths
index|[
name|i
operator|++
index|]
operator|=
name|node
operator|->
name|path
expr_stmt|;
name|success
operator|=
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
name|peer_obj_paths
argument_list|,
name|num
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|error
label|:
if|if
condition|(
name|peer_obj_paths
condition|)
name|os_free
argument_list|(
name|peer_obj_paths
argument_list|)
expr_stmt|;
name|dl_list_for_each_safe
argument_list|(
argument|node
argument_list|,
argument|tmp
argument_list|,
argument|&peer_objpath_list
argument_list|,
argument|struct peer_objpath_node
argument_list|,
argument|list
argument_list|)
block|{
name|dl_list_del
argument_list|(
operator|&
name|node
operator|->
name|list
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|node
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|out_of_mem
condition|)
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|success
return|;
block|}
end_function

begin_enum
enum|enum
name|wpas_p2p_role
block|{
name|WPAS_P2P_ROLE_DEVICE
block|,
name|WPAS_P2P_ROLE_GO
block|,
name|WPAS_P2P_ROLE_CLIENT
block|, }
enum|;
end_enum

begin_function
specifier|static
name|enum
name|wpas_p2p_role
name|wpas_get_p2p_role
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
if|if
condition|(
operator|!
name|ssid
condition|)
return|return
name|WPAS_P2P_ROLE_DEVICE
return|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
condition|)
return|return
name|WPAS_P2P_ROLE_DEVICE
return|;
switch|switch
condition|(
name|ssid
operator|->
name|mode
condition|)
block|{
case|case
name|WPAS_MODE_P2P_GO
case|:
case|case
name|WPAS_MODE_P2P_GROUP_FORMATION
case|:
return|return
name|WPAS_P2P_ROLE_GO
return|;
case|case
name|WPAS_MODE_INFRA
case|:
if|if
condition|(
name|ssid
operator|->
name|p2p_group
condition|)
return|return
name|WPAS_P2P_ROLE_CLIENT
return|;
return|return
name|WPAS_P2P_ROLE_DEVICE
return|;
default|default:
return|return
name|WPAS_P2P_ROLE_DEVICE
return|;
block|}
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_role
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
switch|switch
condition|(
name|wpas_get_p2p_role
argument_list|(
name|wpa_s
argument_list|)
condition|)
block|{
case|case
name|WPAS_P2P_ROLE_GO
case|:
name|str
operator|=
literal|"GO"
expr_stmt|;
break|break;
case|case
name|WPAS_P2P_ROLE_CLIENT
case|:
name|str
operator|=
literal|"client"
expr_stmt|;
break|break;
default|default:
name|str
operator|=
literal|"device"
expr_stmt|;
block|}
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|str
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_group
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|char
name|path_buf
index|[
name|WPAS_DBUS_OBJECT_PATH_MAX
index|]
decl_stmt|;
name|char
modifier|*
name|dbus_groupobj_path
init|=
name|path_buf
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|dbus_groupobj_path
operator|==
name|NULL
condition|)
name|os_snprintf
argument_list|(
name|dbus_groupobj_path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
else|else
name|os_snprintf
argument_list|(
name|dbus_groupobj_path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s"
argument_list|,
name|wpa_s
operator|->
name|dbus_groupobj_path
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|dbus_groupobj_path
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peergo
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|char
name|go_peer_obj_path
index|[
name|WPAS_DBUS_OBJECT_PATH_MAX
index|]
decl_stmt|,
modifier|*
name|path
decl_stmt|;
if|if
condition|(
name|wpas_get_p2p_role
argument_list|(
name|wpa_s
argument_list|)
operator|!=
name|WPAS_P2P_ROLE_CLIENT
condition|)
name|os_snprintf
argument_list|(
name|go_peer_obj_path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
else|else
name|os_snprintf
argument_list|(
name|go_peer_obj_path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NEW_P2P_PEERS_PART
literal|"/"
name|COMPACT_MACSTR
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|go_dev_addr
argument_list|)
argument_list|)
expr_stmt|;
name|path
operator|=
name|go_peer_obj_path
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Peer object properties accessor methods  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peer_device_name
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|peer_handler_args
modifier|*
name|peer_args
init|=
name|user_data
decl_stmt|;
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|info
decl_stmt|;
name|char
modifier|*
name|tmp
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_p2p_check_enabled
argument_list|(
name|peer_args
operator|->
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|error
argument_list|)
condition|)
return|return
name|FALSE
return|;
comment|/* get the peer info */
name|info
operator|=
name|p2p_get_peer_found
argument_list|(
name|peer_args
operator|->
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_args
operator|->
name|p2p_device_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to find peer"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|tmp
operator|=
name|os_strdup
argument_list|(
name|info
operator|->
name|device_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|tmp
argument_list|,
name|error
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|os_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peer_primary_device_type
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|peer_handler_args
modifier|*
name|peer_args
init|=
name|user_data
decl_stmt|;
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|info
decl_stmt|;
name|info
operator|=
name|p2p_get_peer_found
argument_list|(
name|peer_args
operator|->
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_args
operator|->
name|p2p_device_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to find peer"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
operator|(
name|char
operator|*
operator|)
name|info
operator|->
name|pri_dev_type
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|,
name|error
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peer_config_method
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|peer_handler_args
modifier|*
name|peer_args
init|=
name|user_data
decl_stmt|;
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|info
decl_stmt|;
name|info
operator|=
name|p2p_get_peer_found
argument_list|(
name|peer_args
operator|->
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_args
operator|->
name|p2p_device_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to find peer"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_UINT16
argument_list|,
operator|&
name|info
operator|->
name|config_methods
argument_list|,
name|error
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peer_level
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|peer_handler_args
modifier|*
name|peer_args
init|=
name|user_data
decl_stmt|;
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|info
decl_stmt|;
name|info
operator|=
name|p2p_get_peer_found
argument_list|(
name|peer_args
operator|->
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_args
operator|->
name|p2p_device_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to find peer"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_INT32
argument_list|,
operator|&
name|info
operator|->
name|level
argument_list|,
name|error
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peer_device_capability
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|peer_handler_args
modifier|*
name|peer_args
init|=
name|user_data
decl_stmt|;
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|info
decl_stmt|;
name|info
operator|=
name|p2p_get_peer_found
argument_list|(
name|peer_args
operator|->
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_args
operator|->
name|p2p_device_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to find peer"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
operator|&
name|info
operator|->
name|dev_capab
argument_list|,
name|error
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peer_group_capability
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|peer_handler_args
modifier|*
name|peer_args
init|=
name|user_data
decl_stmt|;
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|info
decl_stmt|;
name|info
operator|=
name|p2p_get_peer_found
argument_list|(
name|peer_args
operator|->
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_args
operator|->
name|p2p_device_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to find peer"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
operator|&
name|info
operator|->
name|group_capab
argument_list|,
name|error
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peer_secondary_device_types
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|peer_handler_args
modifier|*
name|peer_args
init|=
name|user_data
decl_stmt|;
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|info
decl_stmt|;
name|DBusMessageIter
name|variant_iter
decl_stmt|,
name|array_iter
decl_stmt|;
name|info
operator|=
name|p2p_get_peer_found
argument_list|(
name|peer_args
operator|->
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_args
operator|->
name|p2p_device_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to find peer"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
argument|iter
argument_list|,
argument|DBUS_TYPE_VARIANT
argument_list|,
argument|DBUS_TYPE_ARRAY_AS_STRING 					      DBUS_TYPE_ARRAY_AS_STRING 					      DBUS_TYPE_BYTE_AS_STRING
argument_list|,
argument|&variant_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct message 1"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
argument|&variant_iter
argument_list|,
argument|DBUS_TYPE_ARRAY
argument_list|,
argument|DBUS_TYPE_ARRAY_AS_STRING 					      DBUS_TYPE_BYTE_AS_STRING
argument_list|,
argument|&array_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct message 2"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|info
operator|->
name|wps_sec_dev_type_list_len
condition|)
block|{
specifier|const
name|u8
modifier|*
name|sec_dev_type_list
init|=
name|info
operator|->
name|wps_sec_dev_type_list
decl_stmt|;
name|int
name|num_sec_device_types
init|=
name|info
operator|->
name|wps_sec_dev_type_list_len
operator|/
name|WPS_DEV_TYPE_LEN
decl_stmt|;
name|int
name|i
decl_stmt|;
name|DBusMessageIter
name|inner_array_iter
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_sec_device_types
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
operator|&
name|array_iter
argument_list|,
name|DBUS_TYPE_ARRAY
argument_list|,
name|DBUS_TYPE_BYTE_AS_STRING
argument_list|,
operator|&
name|inner_array_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct "
literal|"message 3 (%d)"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_append_fixed_array
argument_list|(
operator|&
name|inner_array_iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
operator|&
name|sec_dev_type_list
argument_list|,
name|WPS_DEV_TYPE_LEN
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct "
literal|"message 4 (%d)"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
operator|&
name|array_iter
argument_list|,
operator|&
name|inner_array_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct "
literal|"message 5 (%d)"
argument_list|,
name|__func__
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|sec_dev_type_list
operator|+=
name|WPS_DEV_TYPE_LEN
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|array_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct message 6"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct message 7"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peer_vendor_extension
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpabuf
modifier|*
name|vendor_extension
index|[
name|P2P_MAX_WPS_VENDOR_EXT
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|num
decl_stmt|;
name|struct
name|peer_handler_args
modifier|*
name|peer_args
init|=
name|user_data
decl_stmt|;
specifier|const
name|struct
name|p2p_peer_info
modifier|*
name|info
decl_stmt|;
name|info
operator|=
name|p2p_get_peer_found
argument_list|(
name|peer_args
operator|->
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|peer_args
operator|->
name|p2p_device_addr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|info
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to find peer"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|/* Add WPS vendor extensions attribute */
for|for
control|(
name|i
operator|=
literal|0
operator|,
name|num
operator|=
literal|0
init|;
name|i
operator|<
name|P2P_MAX_WPS_VENDOR_EXT
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|info
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|==
name|NULL
condition|)
continue|continue;
name|vendor_extension
index|[
name|num
index|]
operator|=
name|info
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
expr_stmt|;
name|num
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wpas_dbus_simple_array_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
name|vendor_extension
argument_list|,
name|num
argument_list|,
name|error
argument_list|)
condition|)
return|return
name|FALSE
return|;
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_peer_ies
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|dbus_bool_t
name|success
decl_stmt|;
comment|/* struct peer_handler_args *peer_args = user_data; */
name|success
operator|=
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
expr_stmt|;
return|return
name|success
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_persistent_groups - Get array of persistent group objects  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "PersistentGroups" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_persistent_groups
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|char
modifier|*
modifier|*
name|paths
decl_stmt|;
name|unsigned
name|int
name|i
init|=
literal|0
decl_stmt|,
name|num
init|=
literal|0
decl_stmt|;
name|dbus_bool_t
name|success
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"dbus: %s: "
literal|"An error occurred getting persistent groups list"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"an error "
literal|"occurred getting persistent groups list"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
if|if
condition|(
name|network_is_persistent_group
argument_list|(
name|ssid
argument_list|)
condition|)
name|num
operator|++
expr_stmt|;
name|paths
operator|=
name|os_calloc
argument_list|(
name|num
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|paths
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|/* Loop through configured networks and append object path of each */
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
block|{
if|if
condition|(
operator|!
name|network_is_persistent_group
argument_list|(
name|ssid
argument_list|)
condition|)
continue|continue;
name|paths
index|[
name|i
index|]
operator|=
name|os_zalloc
argument_list|(
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|paths
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Construct the object path for this network. */
name|os_snprintf
argument_list|(
name|paths
index|[
name|i
operator|++
index|]
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NEW_PERSISTENT_GROUPS_PART
literal|"/%d"
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
name|success
operator|=
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
name|paths
argument_list|,
name|num
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|out
label|:
while|while
condition|(
name|i
condition|)
name|os_free
argument_list|(
name|paths
index|[
operator|--
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|paths
argument_list|)
expr_stmt|;
return|return
name|success
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_persistent_group_properties - Get options for a persistent  *	group  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Properties" property of a persistent group.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_persistent_group_properties
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|network_handler_args
modifier|*
name|net
init|=
name|user_data
decl_stmt|;
comment|/* Leveraging the fact that persistent group object is still 	 * represented in same manner as network within. 	 */
return|return
name|wpas_dbus_getter_network_properties
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|net
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_persistent_group_properties - Get options for a persistent  *	group  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter for "Properties" property of a persistent group.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_persistent_group_properties
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|network_handler_args
modifier|*
name|net
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|net
operator|->
name|ssid
decl_stmt|;
name|DBusMessageIter
name|variant_iter
decl_stmt|;
comment|/* 	 * Leveraging the fact that persistent group object is still 	 * represented in same manner as network within. 	 */
name|dbus_message_iter_recurse
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
return|return
name|set_network_properties
argument_list|(
name|net
operator|->
name|wpa_s
argument_list|,
name|ssid
argument_list|,
operator|&
name|variant_iter
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_new_iface_add_persistent_group - Add a new configured  *	persistent_group  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing the object path of the new  * persistent group  *  * Handler function for "AddPersistentGroup" method call of a P2P Device  * interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_add_persistent_group
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|NULL
decl_stmt|;
name|char
name|path_buf
index|[
name|WPAS_DBUS_OBJECT_PATH_MAX
index|]
decl_stmt|,
modifier|*
name|path
init|=
name|path_buf
decl_stmt|;
name|DBusError
name|error
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"dbus: %s: "
literal|"Cannot add new persistent group"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"wpa_supplicant could not add "
literal|"a persistent group on this interface."
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* Mark the ssid as being a persistent group before the notification */
name|ssid
operator|->
name|disabled
operator|=
literal|2
expr_stmt|;
name|ssid
operator|->
name|p2p_persistent_group
operator|=
literal|1
expr_stmt|;
name|wpas_notify_persistent_group_added
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|dbus_error_init
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|set_network_properties
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
operator|&
name|iter
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: %s: "
literal|"Control interface could not set persistent group "
literal|"properties"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_reply_new_from_error
argument_list|(
name|message
argument_list|,
operator|&
name|error
argument_list|,
name|DBUS_ERROR_INVALID_ARGS
argument_list|,
literal|"Failed to set network "
literal|"properties"
argument_list|)
expr_stmt|;
name|dbus_error_free
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* Construct the object path for this network. */
name|os_snprintf
argument_list|(
name|path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NEW_PERSISTENT_GROUPS_PART
literal|"/%d"
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
block|{
name|dbus_message_unref
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
return|return
name|reply
return|;
name|err
label|:
if|if
condition|(
name|ssid
condition|)
block|{
name|wpas_notify_persistent_group_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_remove_persistent_group - Remove a configured persistent  *	group  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NULL on success or dbus error on failure  *  * Handler function for "RemovePersistentGroup" method call of a P2P Device  * interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_remove_persistent_group
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|op
decl_stmt|;
name|char
modifier|*
name|iface
init|=
name|NULL
decl_stmt|,
modifier|*
name|persistent_group_id
init|=
name|NULL
decl_stmt|;
name|int
name|id
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|op
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
comment|/* 	 * Extract the network ID and ensure the network is actually a child of 	 * this interface. 	 */
name|iface
operator|=
name|wpas_dbus_new_decompose_object_path
argument_list|(
name|op
argument_list|,
literal|1
argument_list|,
operator|&
name|persistent_group_id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
operator|||
name|os_strcmp
argument_list|(
name|iface
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|op
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|id
operator|=
name|strtoul
argument_list|(
name|persistent_group_id
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
name|EINVAL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|op
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_persistent_group_unknown
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpas_notify_persistent_group_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"dbus: %s: "
literal|"error occurred when removing persistent group %d"
argument_list|,
name|__func__
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"error removing the specified persistent group on "
literal|"this interface."
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
name|os_free
argument_list|(
name|iface
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|persistent_group_id
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|remove_persistent_group
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|wpas_notify_persistent_group_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"dbus: %s: "
literal|"error occurred when removing persistent group %d"
argument_list|,
name|__func__
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_remove_all_persistent_groups - Remove all configured  * persistent groups  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NULL on success or dbus error on failure  *  * Handler function for "RemoveAllPersistentGroups" method call of a  * P2P Device interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_remove_all_persistent_groups
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|struct
name|wpa_config
modifier|*
name|config
decl_stmt|;
name|config
operator|=
name|wpa_s
operator|->
name|conf
expr_stmt|;
name|ssid
operator|=
name|config
operator|->
name|ssid
expr_stmt|;
while|while
condition|(
name|ssid
condition|)
block|{
name|next
operator|=
name|ssid
operator|->
name|next
expr_stmt|;
if|if
condition|(
name|network_is_persistent_group
argument_list|(
name|ssid
argument_list|)
condition|)
name|remove_persistent_group
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/*  * Group object properties accessor methods  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_group_members
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|unsigned
name|int
name|num_members
decl_stmt|;
name|char
modifier|*
modifier|*
name|paths
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|void
modifier|*
name|next
init|=
name|NULL
decl_stmt|;
specifier|const
name|u8
modifier|*
name|addr
decl_stmt|;
name|dbus_bool_t
name|success
init|=
name|FALSE
decl_stmt|;
comment|/* Verify correct role for this property */
if|if
condition|(
name|wpas_get_p2p_role
argument_list|(
name|wpa_s
argument_list|)
operator|!=
name|WPAS_P2P_ROLE_GO
condition|)
block|{
return|return
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|error
argument_list|)
return|;
block|}
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
expr_stmt|;
comment|/* At present WPAS P2P_GO mode only applicable for p2p_go */
if|if
condition|(
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GO
operator|&&
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_AP
operator|&&
name|ssid
operator|->
name|mode
operator|!=
name|WPAS_MODE_P2P_GROUP_FORMATION
condition|)
return|return
name|FALSE
return|;
name|num_members
operator|=
name|p2p_get_group_num_members
argument_list|(
name|wpa_s
operator|->
name|p2p_group
argument_list|)
expr_stmt|;
name|paths
operator|=
name|os_calloc
argument_list|(
name|num_members
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|paths
condition|)
goto|goto
name|out_of_memory
goto|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|addr
operator|=
name|p2p_iterate_group_members
argument_list|(
name|wpa_s
operator|->
name|p2p_group
argument_list|,
operator|&
name|next
argument_list|)
operator|)
condition|)
block|{
name|paths
index|[
name|i
index|]
operator|=
name|os_zalloc
argument_list|(
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|paths
index|[
name|i
index|]
condition|)
goto|goto
name|out_of_memory
goto|;
name|os_snprintf
argument_list|(
name|paths
index|[
name|i
index|]
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NEW_P2P_GROUPMEMBERS_PART
literal|"/"
name|COMPACT_MACSTR
argument_list|,
name|wpa_s
operator|->
name|dbus_groupobj_path
argument_list|,
name|MAC2STR
argument_list|(
name|addr
argument_list|)
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|success
operator|=
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
name|paths
argument_list|,
name|num_members
argument_list|,
name|error
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_members
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
name|paths
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|paths
argument_list|)
expr_stmt|;
return|return
name|success
return|;
name|out_of_memory
label|:
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
if|if
condition|(
name|paths
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|num_members
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
name|paths
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|paths
argument_list|)
expr_stmt|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_group_ssid
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
return|return
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
name|wpa_s
operator|->
name|current_ssid
operator|->
name|ssid
argument_list|,
name|wpa_s
operator|->
name|current_ssid
operator|->
name|ssid_len
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_group_bssid
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|u8
name|role
init|=
name|wpas_get_p2p_role
argument_list|(
name|wpa_s
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|p_bssid
decl_stmt|;
if|if
condition|(
name|role
operator|==
name|WPAS_P2P_ROLE_CLIENT
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
name|p_bssid
operator|=
name|wpa_s
operator|->
name|current_ssid
operator|->
name|bssid
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
name|p_bssid
operator|=
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
operator|->
name|own_addr
expr_stmt|;
block|}
return|return
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
name|p_bssid
argument_list|,
name|ETH_ALEN
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_group_frequency
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|u16
name|op_freq
decl_stmt|;
name|u8
name|role
init|=
name|wpas_get_p2p_role
argument_list|(
name|wpa_s
argument_list|)
decl_stmt|;
if|if
condition|(
name|role
operator|==
name|WPAS_P2P_ROLE_CLIENT
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|go_params
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
name|op_freq
operator|=
name|wpa_s
operator|->
name|go_params
operator|->
name|freq
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
name|op_freq
operator|=
name|wpa_s
operator|->
name|ap_iface
operator|->
name|freq
expr_stmt|;
block|}
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_UINT16
argument_list|,
operator|&
name|op_freq
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_group_passphrase
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|u8
name|role
init|=
name|wpas_get_p2p_role
argument_list|(
name|wpa_s
argument_list|)
decl_stmt|;
name|char
modifier|*
name|p_pass
init|=
name|NULL
decl_stmt|;
comment|/* Verify correct role for this property */
if|if
condition|(
name|role
operator|==
name|WPAS_P2P_ROLE_GO
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
name|p_pass
operator|=
name|wpa_s
operator|->
name|current_ssid
operator|->
name|passphrase
expr_stmt|;
block|}
else|else
name|p_pass
operator|=
literal|""
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|p_pass
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_group_psk
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|u8
name|role
init|=
name|wpas_get_p2p_role
argument_list|(
name|wpa_s
argument_list|)
decl_stmt|;
name|u8
modifier|*
name|p_psk
init|=
name|NULL
decl_stmt|;
name|u8
name|psk_len
init|=
literal|0
decl_stmt|;
comment|/* Verify correct role for this property */
if|if
condition|(
name|role
operator|==
name|WPAS_P2P_ROLE_CLIENT
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
name|p_psk
operator|=
name|wpa_s
operator|->
name|current_ssid
operator|->
name|psk
expr_stmt|;
name|psk_len
operator|=
literal|32
expr_stmt|;
block|}
return|return
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
operator|&
name|p_psk
argument_list|,
name|psk_len
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_p2p_group_vendor_ext
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|vendor_ext
index|[
name|MAX_WPS_VENDOR_EXTENSIONS
index|]
decl_stmt|;
name|int
name|num_vendor_ext
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Verify correct role for this property */
if|if
condition|(
name|wpas_get_p2p_role
argument_list|(
name|wpa_s
argument_list|)
operator|==
name|WPAS_P2P_ROLE_GO
condition|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|==
name|NULL
condition|)
return|return
name|FALSE
return|;
name|hapd
operator|=
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
comment|/* Parse WPS Vendor Extensions sent in Beacon/Probe Response */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_WPS_VENDOR_EXTENSIONS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|hapd
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|==
name|NULL
condition|)
name|vendor_ext
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
else|else
block|{
name|vendor_ext
index|[
name|num_vendor_ext
operator|++
index|]
operator|=
name|hapd
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
block|}
comment|/* Return vendor extensions or no data */
return|return
name|wpas_dbus_simple_array_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
name|vendor_ext
argument_list|,
name|num_vendor_ext
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_p2p_group_vendor_ext
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|DBusMessageIter
name|variant_iter
decl_stmt|,
name|iter_dict
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
init|=
block|{
operator|.
name|type
operator|=
name|DBUS_TYPE_STRING
block|}
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
name|struct
name|hostapd_data
modifier|*
name|hapd
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|wpas_get_p2p_role
argument_list|(
name|wpa_s
argument_list|)
operator|==
name|WPAS_P2P_ROLE_GO
operator|&&
name|wpa_s
operator|->
name|ap_iface
operator|!=
name|NULL
condition|)
name|hapd
operator|=
name|wpa_s
operator|->
name|ap_iface
operator|->
name|bss
index|[
literal|0
index|]
expr_stmt|;
else|else
return|return
name|FALSE
return|;
name|dbus_message_iter_recurse
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|error
argument_list|)
condition|)
return|return
name|FALSE
return|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_INVALID_ARGS
argument_list|,
literal|"invalid message format"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"WPSVendorExtensions"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|||
name|entry
operator|.
name|array_type
operator|!=
name|WPAS_DBUS_TYPE_BINARRAY
operator|||
name|entry
operator|.
name|array_len
operator|>
name|MAX_WPS_VENDOR_EXTENSIONS
condition|)
goto|goto
name|error
goto|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|MAX_WPS_VENDOR_EXTENSIONS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|<
name|entry
operator|.
name|array_len
condition|)
block|{
name|hapd
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|=
name|entry
operator|.
name|binarray_value
index|[
name|i
index|]
expr_stmt|;
name|entry
operator|.
name|binarray_value
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|hapd
operator|->
name|conf
operator|->
name|wps_vendor_ext
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
name|hostapd_update_wps
argument_list|(
name|hapd
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|error
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
name|error
label|:
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_INVALID_ARGS
argument_list|,
literal|"invalid message format"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_add_service
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|int
name|upnp
init|=
literal|0
decl_stmt|;
name|int
name|bonjour
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|service
init|=
name|NULL
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|query
init|=
name|NULL
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|resp
init|=
name|NULL
decl_stmt|;
name|u8
name|version
init|=
literal|0
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"service_type"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"upnp"
argument_list|)
condition|)
name|upnp
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"bonjour"
argument_list|)
condition|)
name|bonjour
operator|=
literal|1
expr_stmt|;
else|else
goto|goto
name|error_clear
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"version"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
condition|)
block|{
name|version
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"service"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|service
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"query"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|)
operator|||
operator|(
name|entry
operator|.
name|array_type
operator|!=
name|DBUS_TYPE_BYTE
operator|)
condition|)
goto|goto
name|error_clear
goto|;
name|query
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|entry
operator|.
name|bytearray_value
argument_list|,
name|entry
operator|.
name|array_len
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"response"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|)
operator|||
operator|(
name|entry
operator|.
name|array_type
operator|!=
name|DBUS_TYPE_BYTE
operator|)
condition|)
goto|goto
name|error_clear
goto|;
name|resp
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|entry
operator|.
name|bytearray_value
argument_list|,
name|entry
operator|.
name|array_len
argument_list|)
expr_stmt|;
block|}
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|upnp
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|version
operator|<=
literal|0
operator|||
name|service
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|wpas_p2p_service_add_upnp
argument_list|(
name|wpa_s
argument_list|,
name|version
argument_list|,
name|service
argument_list|)
operator|!=
literal|0
condition|)
goto|goto
name|error
goto|;
name|os_free
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|service
operator|=
name|NULL
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|bonjour
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|query
operator|==
name|NULL
operator|||
name|resp
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|wpas_p2p_service_add_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|query
argument_list|,
name|resp
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
name|query
operator|=
name|NULL
expr_stmt|;
name|resp
operator|=
name|NULL
expr_stmt|;
block|}
else|else
goto|goto
name|error
goto|;
return|return
name|reply
return|;
name|error_clear
label|:
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|error
label|:
name|os_free
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_delete_service
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|int
name|upnp
init|=
literal|0
decl_stmt|;
name|int
name|bonjour
init|=
literal|0
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|service
init|=
name|NULL
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|query
init|=
name|NULL
decl_stmt|;
name|u8
name|version
init|=
literal|0
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"service_type"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"upnp"
argument_list|)
condition|)
name|upnp
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"bonjour"
argument_list|)
condition|)
name|bonjour
operator|=
literal|1
expr_stmt|;
else|else
goto|goto
name|error_clear
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|upnp
operator|==
literal|1
condition|)
block|{
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"version"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
condition|)
name|version
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"service"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
condition|)
name|service
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
else|else
goto|goto
name|error_clear
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|version
operator|<=
literal|0
operator|||
name|service
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ret
operator|=
name|wpas_p2p_service_del_upnp
argument_list|(
name|wpa_s
argument_list|,
name|version
argument_list|,
name|service
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|service
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
name|bonjour
operator|==
literal|1
condition|)
block|{
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"query"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|)
operator|||
operator|(
name|entry
operator|.
name|array_type
operator|!=
name|DBUS_TYPE_BYTE
operator|)
condition|)
goto|goto
name|error_clear
goto|;
name|query
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|entry
operator|.
name|bytearray_value
argument_list|,
name|entry
operator|.
name|array_len
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|error_clear
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|query
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ret
operator|=
name|wpas_p2p_service_del_bonjour
argument_list|(
name|wpa_s
argument_list|,
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
literal|0
condition|)
goto|goto
name|error
goto|;
name|wpabuf_free
argument_list|(
name|query
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|error
goto|;
return|return
name|reply
return|;
name|error_clear
label|:
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|error
label|:
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_flush_service
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpas_p2p_service_flush
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_service_sd_req
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|int
name|upnp
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|service
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|peer_object_path
init|=
name|NULL
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|tlv
init|=
name|NULL
decl_stmt|;
name|u8
name|version
init|=
literal|0
decl_stmt|;
name|u64
name|ref
init|=
literal|0
decl_stmt|;
name|u8
name|addr_buf
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|addr
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"peer_object"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_OBJECT_PATH
condition|)
block|{
name|peer_object_path
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"service_type"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
condition|)
block|{
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|str_value
argument_list|,
literal|"upnp"
argument_list|)
condition|)
name|upnp
operator|=
literal|1
expr_stmt|;
else|else
goto|goto
name|error_clear
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"version"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
condition|)
block|{
name|version
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"service"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
condition|)
block|{
name|service
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"tlv"
argument_list|)
condition|)
block|{
if|if
condition|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|||
name|entry
operator|.
name|array_type
operator|!=
name|DBUS_TYPE_BYTE
condition|)
goto|goto
name|error_clear
goto|;
name|tlv
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|entry
operator|.
name|bytearray_value
argument_list|,
name|entry
operator|.
name|array_len
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|error_clear
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|peer_object_path
condition|)
block|{
name|addr
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|parse_peer_object_path
argument_list|(
name|peer_object_path
argument_list|,
name|addr_buf
argument_list|)
operator|<
literal|0
operator|||
operator|!
name|p2p_peer_known
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|addr_buf
argument_list|)
condition|)
goto|goto
name|error
goto|;
name|addr
operator|=
name|addr_buf
expr_stmt|;
block|}
if|if
condition|(
name|upnp
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|version
operator|<=
literal|0
operator|||
name|service
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ref
operator|=
name|wpas_p2p_sd_request_upnp
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|version
argument_list|,
name|service
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|tlv
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ref
operator|=
name|wpas_p2p_sd_request
argument_list|(
name|wpa_s
argument_list|,
name|addr
argument_list|,
name|tlv
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tlv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ref
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_UINT64
argument_list|,
operator|&
name|ref
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reply
operator|=
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"Unable to send SD request"
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|os_free
argument_list|(
name|service
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|peer_object_path
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
name|error_clear
label|:
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|error
label|:
if|if
condition|(
name|tlv
condition|)
name|wpabuf_free
argument_list|(
name|tlv
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_service_sd_res
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|char
modifier|*
name|peer_object_path
init|=
name|NULL
decl_stmt|;
name|struct
name|wpabuf
modifier|*
name|tlv
init|=
name|NULL
decl_stmt|;
name|int
name|freq
init|=
literal|0
decl_stmt|;
name|int
name|dlg_tok
init|=
literal|0
decl_stmt|;
name|u8
name|addr
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"peer_object"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_OBJECT_PATH
condition|)
block|{
name|peer_object_path
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"frequency"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
condition|)
block|{
name|freq
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"dialog_token"
argument_list|)
operator|&&
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_UINT32
condition|)
block|{
name|dlg_tok
operator|=
name|entry
operator|.
name|uint32_value
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"tlvs"
argument_list|)
condition|)
block|{
if|if
condition|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|||
name|entry
operator|.
name|array_type
operator|!=
name|DBUS_TYPE_BYTE
condition|)
goto|goto
name|error_clear
goto|;
name|tlv
operator|=
name|wpabuf_alloc_copy
argument_list|(
name|entry
operator|.
name|bytearray_value
argument_list|,
name|entry
operator|.
name|array_len
argument_list|)
expr_stmt|;
block|}
else|else
goto|goto
name|error_clear
goto|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|peer_object_path
operator|||
operator|(
name|parse_peer_object_path
argument_list|(
name|peer_object_path
argument_list|,
name|addr
argument_list|)
operator|<
literal|0
operator|)
operator|||
operator|!
name|p2p_peer_known
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|p2p
argument_list|,
name|addr
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|tlv
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|wpas_p2p_sd_response
argument_list|(
name|wpa_s
argument_list|,
name|freq
argument_list|,
name|addr
argument_list|,
operator|(
name|u8
operator|)
name|dlg_tok
argument_list|,
name|tlv
argument_list|)
expr_stmt|;
name|wpabuf_free
argument_list|(
name|tlv
argument_list|)
expr_stmt|;
name|out
label|:
name|os_free
argument_list|(
name|peer_object_path
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
name|error_clear
label|:
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|error
label|:
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_service_sd_cancel_req
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter
decl_stmt|;
name|u64
name|req
init|=
literal|0
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|req
argument_list|)
expr_stmt|;
if|if
condition|(
name|req
operator|==
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|wpas_p2p_sd_cancel_request
argument_list|(
name|wpa_s
argument_list|,
name|req
argument_list|)
condition|)
goto|goto
name|error
goto|;
return|return
name|NULL
return|;
name|error
label|:
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_service_update
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpas_p2p_sd_service_update
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_p2p_serv_disc_external
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter
decl_stmt|;
name|int
name|ext
init|=
literal|0
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|ext
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|p2p_sd_over_ctrl_iface
operator|=
name|ext
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

end_unit


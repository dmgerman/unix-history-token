begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / dbus-based control interface  * Copyright (c) 2006, Dan Williams<dcbw@redhat.com> and Red Hat, Inc.  * Copyright (c) 2009-2010, Witold Sowa<witold.sowa@gmail.com>  * Copyright (c) 2009, Jouni Malinen<j@w1.fi>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap_methods.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"../config.h"
end_include

begin_include
include|#
directive|include
file|"../wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"../driver_i.h"
end_include

begin_include
include|#
directive|include
file|"../notify.h"
end_include

begin_include
include|#
directive|include
file|"../bss.h"
end_include

begin_include
include|#
directive|include
file|"../scan.h"
end_include

begin_include
include|#
directive|include
file|"../autoscan.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new_helpers.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new_handlers.h"
end_include

begin_include
include|#
directive|include
file|"dbus_dict_helpers.h"
end_include

begin_include
include|#
directive|include
file|"dbus_common_i.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_show_keys
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_timestamp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|debug_strings
index|[]
init|=
block|{
literal|"excessive"
block|,
literal|"msgdump"
block|,
literal|"debug"
block|,
literal|"info"
block|,
literal|"warning"
block|,
literal|"error"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * wpas_dbus_error_unknown_error - Return a new InvalidArgs error message  * @message: Pointer to incoming dbus message this error refers to  * @arg: Optional string appended to error message  * Returns: a dbus error message  *  * Convenience function to create and return an UnknownError  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_error_unknown_error
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
specifier|const
name|char
modifier|*
name|arg
parameter_list|)
block|{
comment|/* 	 * This function can be called as a result of a failure 	 * within internal getter calls, which will call this function 	 * with a NULL message parameter.  However, dbus_message_new_error 	 * looks very unkindly (i.e, abort()) on a NULL message, so 	 * in this case, we should not call it. 	 */
if|if
condition|(
name|message
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"dbus: wpas_dbus_error_unknown_error "
literal|"called with NULL message (arg=%s)"
argument_list|,
name|arg
condition|?
name|arg
else|:
literal|"N/A"
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_UNKNOWN_ERROR
argument_list|,
name|arg
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_error_iface_unknown - Return a new invalid interface error message  * @message: Pointer to incoming dbus message this error refers to  * Returns: A dbus error message  *  * Convenience function to create and return an invalid interface error  */
end_comment

begin_function
specifier|static
name|DBusMessage
modifier|*
name|wpas_dbus_error_iface_unknown
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|)
block|{
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_IFACE_UNKNOWN
argument_list|,
literal|"wpa_supplicant knows nothing about "
literal|"this interface."
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_error_network_unknown - Return a new NetworkUnknown error message  * @message: Pointer to incoming dbus message this error refers to  * Returns: a dbus error message  *  * Convenience function to create and return an invalid network error  */
end_comment

begin_function
specifier|static
name|DBusMessage
modifier|*
name|wpas_dbus_error_network_unknown
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|)
block|{
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_NETWORK_UNKNOWN
argument_list|,
literal|"There is no such a network in this "
literal|"interface."
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_error_invalid_args - Return a new InvalidArgs error message  * @message: Pointer to incoming dbus message this error refers to  * Returns: a dbus error message  *  * Convenience function to create and return an invalid options error  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_error_invalid_args
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
specifier|const
name|char
modifier|*
name|arg
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
decl_stmt|;
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_INVALID_ARGS
argument_list|,
literal|"Did not receive correct message "
literal|"arguments."
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|!=
name|NULL
condition|)
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|arg
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|dont_quote
index|[]
init|=
block|{
literal|"key_mgmt"
block|,
literal|"proto"
block|,
literal|"pairwise"
block|,
literal|"auth_alg"
block|,
literal|"group"
block|,
literal|"eap"
block|,
literal|"opensc_engine_path"
block|,
literal|"pkcs11_engine_path"
block|,
literal|"pkcs11_module_path"
block|,
literal|"bssid"
block|,
literal|"scan_freq"
block|,
literal|"freq_list"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|dbus_bool_t
name|should_quote_opt
parameter_list|(
specifier|const
name|char
modifier|*
name|key
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|dont_quote
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|key
argument_list|,
name|dont_quote
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
return|return
name|FALSE
return|;
name|i
operator|++
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * get_iface_by_dbus_path - Get a new network interface  * @global: Pointer to global data from wpa_supplicant_init()  * @path: Pointer to a dbus object path representing an interface  * Returns: Pointer to the interface or %NULL if not found  */
end_comment

begin_function
specifier|static
name|struct
name|wpa_supplicant
modifier|*
name|get_iface_by_dbus_path
parameter_list|(
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|,
specifier|const
name|char
modifier|*
name|path
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|path
argument_list|)
operator|==
literal|0
condition|)
return|return
name|wpa_s
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * set_network_properties - Set properties of a configured network  * @wpa_s: wpa_supplicant structure for a network interface  * @ssid: wpa_ssid structure for a configured network  * @iter: DBus message iterator containing dictionary of network  * properties to set.  * @error: On failure, an error describing the failure  * Returns: TRUE if the request succeeds, FALSE if it failed  *  * Sets network configuration with parameters given id DBus dictionary  */
end_comment

begin_function
name|dbus_bool_t
name|set_network_properties
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|,
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|)
block|{
name|struct
name|wpa_dbus_dict_entry
name|entry
init|=
block|{
operator|.
name|type
operator|=
name|DBUS_TYPE_STRING
block|}
decl_stmt|;
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|char
modifier|*
name|value
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|error
argument_list|)
condition|)
return|return
name|FALSE
return|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
name|size_t
name|size
init|=
literal|50
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
name|value
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_ARRAY
operator|&&
name|entry
operator|.
name|array_type
operator|==
name|DBUS_TYPE_BYTE
condition|)
block|{
if|if
condition|(
name|entry
operator|.
name|array_len
operator|<=
literal|0
condition|)
goto|goto
name|error
goto|;
name|size
operator|=
name|entry
operator|.
name|array_len
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
name|value
operator|=
name|os_zalloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ret
operator|=
name|wpa_snprintf_hex
argument_list|(
name|value
argument_list|,
name|size
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|entry
operator|.
name|bytearray_value
argument_list|,
name|entry
operator|.
name|array_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
condition|)
block|{
if|if
condition|(
name|should_quote_opt
argument_list|(
name|entry
operator|.
name|key
argument_list|)
condition|)
block|{
name|size
operator|=
name|os_strlen
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|size
operator|<=
literal|0
condition|)
goto|goto
name|error
goto|;
name|size
operator|+=
literal|3
expr_stmt|;
name|value
operator|=
name|os_zalloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|value
argument_list|,
name|size
argument_list|,
literal|"\"%s\""
argument_list|,
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|ret
operator|!=
operator|(
name|size
operator|-
literal|1
operator|)
condition|)
goto|goto
name|error
goto|;
block|}
else|else
block|{
name|value
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_UINT32
condition|)
block|{
name|value
operator|=
name|os_zalloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|value
argument_list|,
name|size
argument_list|,
literal|"%u"
argument_list|,
name|entry
operator|.
name|uint32_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
condition|)
block|{
name|value
operator|=
name|os_zalloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|value
argument_list|,
name|size
argument_list|,
literal|"%d"
argument_list|,
name|entry
operator|.
name|int32_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
goto|goto
name|error
goto|;
block|}
else|else
goto|goto
name|error
goto|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
name|entry
operator|.
name|key
argument_list|,
name|value
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"psk"
argument_list|)
operator|==
literal|0
operator|&&
name|value
index|[
literal|0
index|]
operator|==
literal|'"'
operator|&&
name|ssid
operator|->
name|ssid_len
operator|)
operator|||
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"ssid"
argument_list|)
operator|==
literal|0
operator|&&
name|ssid
operator|->
name|passphrase
operator|)
condition|)
name|wpa_config_update_psk
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"priority"
argument_list|)
operator|==
literal|0
condition|)
name|wpa_config_update_prio_list
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
return|return
name|TRUE
return|;
name|error
label|:
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_INVALID_ARGS
argument_list|,
literal|"invalid message format"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_simple_property_getter - Get basic type property  * @iter: Message iter to use when appending arguments  * @type: DBus type of property (must be basic type)  * @val: pointer to place holding property value  * @error: On failure an error describing the failure  * Returns: TRUE if the request was successful, FALSE if it failed  *  * Generic getter for basic type properties. Type is required to be basic.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_simple_property_getter
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
specifier|const
name|int
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|val
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|)
block|{
name|DBusMessageIter
name|variant_iter
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_type_is_basic
argument_list|(
name|type
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: given type is not basic"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_VARIANT
argument_list|,
name|wpa_dbus_type_as_string
argument_list|(
name|type
argument_list|)
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|dbus_message_iter_append_basic
argument_list|(
operator|&
name|variant_iter
argument_list|,
name|type
argument_list|,
name|val
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
goto|goto
name|error
goto|;
return|return
name|TRUE
return|;
name|error
label|:
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: error constructing reply"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_simple_property_setter - Set basic type property  * @message: Pointer to incoming dbus message  * @type: DBus type of property (must be basic type)  * @val: pointer to place where value being set will be stored  * Returns: TRUE if the request was successful, FALSE if it failed  *  * Generic setter for basic type properties. Type is required to be basic.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_simple_property_setter
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
specifier|const
name|int
name|type
parameter_list|,
name|void
modifier|*
name|val
parameter_list|)
block|{
name|DBusMessageIter
name|variant_iter
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_type_is_basic
argument_list|(
name|type
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: given type is not basic"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|/* Look at the new value */
name|dbus_message_iter_recurse
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|variant_iter
argument_list|)
operator|!=
name|type
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"wrong property type"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|variant_iter
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_simple_array_property_getter - Get array type property  * @iter: Pointer to incoming dbus message iterator  * @type: DBus type of property array elements (must be basic type)  * @array: pointer to array of elements to put into response message  * @array_len: length of above array  * @error: a pointer to an error to fill on failure  * Returns: TRUE if the request succeeded, FALSE if it failed  *  * Generic getter for array type properties. Array elements type is  * required to be basic.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_simple_array_property_getter
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
specifier|const
name|int
name|type
parameter_list|,
specifier|const
name|void
modifier|*
name|array
parameter_list|,
name|size_t
name|array_len
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|)
block|{
name|DBusMessageIter
name|variant_iter
decl_stmt|,
name|array_iter
decl_stmt|;
name|char
name|type_str
index|[]
init|=
literal|"a?"
decl_stmt|;
comment|/* ? will be replaced with subtype letter; */
specifier|const
name|char
modifier|*
name|sub_type_str
decl_stmt|;
name|size_t
name|element_size
decl_stmt|,
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_type_is_basic
argument_list|(
name|type
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: given type is not basic"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|sub_type_str
operator|=
name|wpa_dbus_type_as_string
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|type_str
index|[
literal|1
index|]
operator|=
name|sub_type_str
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_VARIANT
argument_list|,
name|type_str
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct message 1"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
operator|&
name|variant_iter
argument_list|,
name|DBUS_TYPE_ARRAY
argument_list|,
name|sub_type_str
argument_list|,
operator|&
name|array_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct message 2"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
name|DBUS_TYPE_BYTE
case|:
case|case
name|DBUS_TYPE_BOOLEAN
case|:
name|element_size
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|DBUS_TYPE_INT16
case|:
case|case
name|DBUS_TYPE_UINT16
case|:
name|element_size
operator|=
sizeof|sizeof
argument_list|(
name|uint16_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|DBUS_TYPE_INT32
case|:
case|case
name|DBUS_TYPE_UINT32
case|:
name|element_size
operator|=
sizeof|sizeof
argument_list|(
name|uint32_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|DBUS_TYPE_INT64
case|:
case|case
name|DBUS_TYPE_UINT64
case|:
name|element_size
operator|=
sizeof|sizeof
argument_list|(
name|uint64_t
argument_list|)
expr_stmt|;
break|break;
case|case
name|DBUS_TYPE_DOUBLE
case|:
name|element_size
operator|=
sizeof|sizeof
argument_list|(
name|double
argument_list|)
expr_stmt|;
break|break;
case|case
name|DBUS_TYPE_STRING
case|:
case|case
name|DBUS_TYPE_OBJECT_PATH
case|:
name|element_size
operator|=
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
expr_stmt|;
break|break;
default|default:
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: unknown element type %d"
argument_list|,
name|__func__
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|array_len
condition|;
name|i
operator|++
control|)
block|{
name|dbus_message_iter_append_basic
argument_list|(
operator|&
name|array_iter
argument_list|,
name|type
argument_list|,
name|array
operator|+
name|i
operator|*
name|element_size
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|array_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct message 3"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct message 4"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_simple_array_array_property_getter - Get array array type property  * @iter: Pointer to incoming dbus message iterator  * @type: DBus type of property array elements (must be basic type)  * @array: pointer to array of elements to put into response message  * @array_len: length of above array  * @error: a pointer to an error to fill on failure  * Returns: TRUE if the request succeeded, FALSE if it failed  *  * Generic getter for array type properties. Array elements type is  * required to be basic.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_simple_array_array_property_getter
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
specifier|const
name|int
name|type
parameter_list|,
name|struct
name|wpabuf
modifier|*
modifier|*
name|array
parameter_list|,
name|size_t
name|array_len
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|)
block|{
name|DBusMessageIter
name|variant_iter
decl_stmt|,
name|array_iter
decl_stmt|;
name|char
name|type_str
index|[]
init|=
literal|"aa?"
decl_stmt|;
name|char
name|inner_type_str
index|[]
init|=
literal|"a?"
decl_stmt|;
specifier|const
name|char
modifier|*
name|sub_type_str
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_type_is_basic
argument_list|(
name|type
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: given type is not basic"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|sub_type_str
operator|=
name|wpa_dbus_type_as_string
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|type_str
index|[
literal|2
index|]
operator|=
name|sub_type_str
index|[
literal|0
index|]
expr_stmt|;
name|inner_type_str
index|[
literal|1
index|]
operator|=
name|sub_type_str
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_VARIANT
argument_list|,
name|type_str
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct message 1"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
operator|&
name|variant_iter
argument_list|,
name|DBUS_TYPE_ARRAY
argument_list|,
name|inner_type_str
argument_list|,
operator|&
name|array_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to construct message 2"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|array_len
condition|;
name|i
operator|++
control|)
block|{
name|wpa_dbus_dict_bin_array_add_element
argument_list|(
operator|&
name|array_iter
argument_list|,
name|wpabuf_head
argument_list|(
name|array
index|[
name|i
index|]
argument_list|)
argument_list|,
name|wpabuf_len
argument_list|(
name|array
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|array_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to close message 2"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: failed to close message 1"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_create_interface - Request registration of a network iface  * @message: Pointer to incoming dbus message  * @global: %wpa_supplicant global data structure  * Returns: The object path of the new interface object,  *          or a dbus error message with more information  *  * Handler function for "CreateInterface" method call. Handles requests  * by dbus clients to register a network interface that wpa_supplicant  * will manage.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_create_interface
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
name|char
modifier|*
name|driver
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|ifname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|confname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|bridge_ifname
init|=
name|NULL
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"Driver"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|driver
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|driver
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"Ifname"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|ifname
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|ifname
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"ConfigFile"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|confname
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|confname
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"BridgeIfname"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|bridge_ifname
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|bridge_ifname
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
else|else
block|{
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
if|if
condition|(
name|ifname
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
comment|/* Required Ifname argument missing */
comment|/* 	 * Try to get the wpa_supplicant record for this iface, return 	 * an error if we already control it. 	 */
if|if
condition|(
name|wpa_supplicant_get_iface
argument_list|(
name|global
argument_list|,
name|ifname
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_IFACE_EXISTS
argument_list|,
literal|"wpa_supplicant already "
literal|"controls this interface."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|struct
name|wpa_interface
name|iface
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|iface
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|iface
operator|.
name|driver
operator|=
name|driver
expr_stmt|;
name|iface
operator|.
name|ifname
operator|=
name|ifname
expr_stmt|;
name|iface
operator|.
name|confname
operator|=
name|confname
expr_stmt|;
name|iface
operator|.
name|bridge_ifname
operator|=
name|bridge_ifname
expr_stmt|;
comment|/* Otherwise, have wpa_supplicant attach to it. */
if|if
condition|(
operator|(
name|wpa_s
operator|=
name|wpa_supplicant_add_iface
argument_list|(
name|global
argument_list|,
operator|&
name|iface
argument_list|)
operator|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|path
init|=
name|wpa_s
operator|->
name|dbus_new_path
decl_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reply
operator|=
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"wpa_supplicant couldn't grab this "
literal|"interface."
argument_list|)
expr_stmt|;
block|}
block|}
name|out
label|:
name|os_free
argument_list|(
name|driver
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ifname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|confname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bridge_ifname
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
name|error
label|:
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_remove_interface - Request deregistration of an interface  * @message: Pointer to incoming dbus message  * @global: wpa_supplicant global data structure  * Returns: a dbus message containing a UINT32 indicating success (1) or  *          failure (0), or returns a dbus error message with more information  *  * Handler function for "removeInterface" method call.  Handles requests  * by dbus clients to deregister a network interface that wpa_supplicant  * currently manages.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_remove_interface
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
name|wpa_s
operator|=
name|get_iface_by_dbus_path
argument_list|(
name|global
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
name|reply
operator|=
name|wpas_dbus_error_iface_unknown
argument_list|(
name|message
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wpa_supplicant_remove_iface
argument_list|(
name|global
argument_list|,
name|wpa_s
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"wpa_supplicant couldn't remove this "
literal|"interface."
argument_list|)
expr_stmt|;
block|}
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_get_interface - Get the object path for an interface name  * @message: Pointer to incoming dbus message  * @global: %wpa_supplicant global data structure  * Returns: The object path of the interface object,  *          or a dbus error message with more information  *  * Handler function for "getInterface" method call.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_get_interface
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|ifname
decl_stmt|;
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|ifname
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
name|wpa_s
operator|=
name|wpa_supplicant_get_iface
argument_list|(
name|global
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
return|return
name|wpas_dbus_error_iface_unknown
argument_list|(
name|message
argument_list|)
return|;
name|path
operator|=
name|wpa_s
operator|->
name|dbus_new_path
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
return|;
if|if
condition|(
operator|!
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
block|{
name|dbus_message_unref
argument_list|(
name|reply
argument_list|)
expr_stmt|;
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
return|;
block|}
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_debug_level - Get debug level  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "DebugLevel" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_debug_level
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|idx
init|=
name|wpa_debug_level
decl_stmt|;
if|if
condition|(
name|idx
operator|<
literal|0
condition|)
name|idx
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|idx
operator|>
literal|5
condition|)
name|idx
operator|=
literal|5
expr_stmt|;
name|str
operator|=
name|debug_strings
index|[
name|idx
index|]
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|str
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_debug_timestamp - Get debug timestamp  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "DebugTimestamp" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_debug_timestamp
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|wpa_debug_timestamp
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_debug_show_keys - Get debug show keys  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "DebugShowKeys" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_debug_show_keys
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|wpa_debug_show_keys
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_debug_level - Set debug level  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter for "DebugLevel" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_debug_level
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|user_data
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
init|=
name|NULL
decl_stmt|;
name|int
name|i
decl_stmt|,
name|val
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|str
argument_list|)
condition|)
return|return
name|FALSE
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|debug_strings
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|os_strcmp
argument_list|(
name|debug_strings
index|[
name|i
index|]
argument_list|,
name|str
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val
operator|=
name|i
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|val
operator|<
literal|0
operator|||
name|wpa_supplicant_set_debug_params
argument_list|(
name|global
argument_list|,
name|val
argument_list|,
name|wpa_debug_timestamp
argument_list|,
name|wpa_debug_show_keys
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"wrong debug "
literal|"level value"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_debug_timestamp - Set debug timestamp  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter for "DebugTimestamp" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_debug_timestamp
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|user_data
decl_stmt|;
name|dbus_bool_t
name|val
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|val
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|wpa_supplicant_set_debug_params
argument_list|(
name|global
argument_list|,
name|wpa_debug_level
argument_list|,
name|val
condition|?
literal|1
else|:
literal|0
argument_list|,
name|wpa_debug_show_keys
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_debug_show_keys - Set debug show keys  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter for "DebugShowKeys" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_debug_show_keys
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|user_data
decl_stmt|;
name|dbus_bool_t
name|val
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|val
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|wpa_supplicant_set_debug_params
argument_list|(
name|global
argument_list|,
name|wpa_debug_level
argument_list|,
name|wpa_debug_timestamp
argument_list|,
name|val
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_interfaces - Request registered interfaces list  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Interfaces" property. Handles requests  * by dbus clients to return list of registered interfaces objects  * paths  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_interfaces
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_global
modifier|*
name|global
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
specifier|const
name|char
modifier|*
modifier|*
name|paths
decl_stmt|;
name|unsigned
name|int
name|i
init|=
literal|0
decl_stmt|,
name|num
init|=
literal|0
decl_stmt|;
name|dbus_bool_t
name|success
decl_stmt|;
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
name|num
operator|++
expr_stmt|;
name|paths
operator|=
name|os_calloc
argument_list|(
name|num
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|paths
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|wpa_s
operator|=
name|global
operator|->
name|ifaces
init|;
name|wpa_s
condition|;
name|wpa_s
operator|=
name|wpa_s
operator|->
name|next
control|)
name|paths
index|[
name|i
operator|++
index|]
operator|=
name|wpa_s
operator|->
name|dbus_new_path
expr_stmt|;
name|success
operator|=
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
name|paths
argument_list|,
name|num
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|paths
argument_list|)
expr_stmt|;
return|return
name|success
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_eap_methods - Request supported EAP methods list  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "EapMethods" property. Handles requests  * by dbus clients to return list of strings with supported EAP methods  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_eap_methods
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|char
modifier|*
modifier|*
name|eap_methods
decl_stmt|;
name|size_t
name|num_items
init|=
literal|0
decl_stmt|;
name|dbus_bool_t
name|success
decl_stmt|;
name|eap_methods
operator|=
name|eap_get_names_as_string_array
argument_list|(
operator|&
name|num_items
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|eap_methods
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|success
operator|=
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
name|eap_methods
argument_list|,
name|num_items
argument_list|,
name|error
argument_list|)
expr_stmt|;
while|while
condition|(
name|num_items
condition|)
name|os_free
argument_list|(
name|eap_methods
index|[
operator|--
name|num_items
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|eap_methods
argument_list|)
expr_stmt|;
return|return
name|success
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_global_capabilities - Request supported global capabilities  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Capabilities" property. Handles requests by dbus clients to  * return a list of strings with supported capabilities like AP, RSN IBSS,  * and P2P that are determined at compile time.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_global_capabilities
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|capabilities
index|[
literal|5
index|]
init|=
block|{
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|,
name|NULL
block|}
decl_stmt|;
name|size_t
name|num_items
init|=
literal|0
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_AP
name|capabilities
index|[
name|num_items
operator|++
index|]
operator|=
literal|"ap"
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AP */
ifdef|#
directive|ifdef
name|CONFIG_IBSS_RSN
name|capabilities
index|[
name|num_items
operator|++
index|]
operator|=
literal|"ibss-rsn"
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IBSS_RSN */
ifdef|#
directive|ifdef
name|CONFIG_P2P
name|capabilities
index|[
name|num_items
operator|++
index|]
operator|=
literal|"p2p"
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
ifdef|#
directive|ifdef
name|CONFIG_INTERWORKING
name|capabilities
index|[
name|num_items
operator|++
index|]
operator|=
literal|"interworking"
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_INTERWORKING */
return|return
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
name|capabilities
argument_list|,
name|num_items
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_dbus_get_scan_type
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|DBusMessageIter
modifier|*
name|var
parameter_list|,
name|char
modifier|*
modifier|*
name|type
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|reply
parameter_list|)
block|{
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
name|var
argument_list|)
operator|!=
name|DBUS_TYPE_STRING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"Type must be a string"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Wrong Type value type. String required"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_get_basic
argument_list|(
name|var
argument_list|,
name|type
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_dbus_get_scan_ssids
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|DBusMessageIter
modifier|*
name|var
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|reply
parameter_list|)
block|{
name|struct
name|wpa_driver_scan_ssid
modifier|*
name|ssids
init|=
name|params
operator|->
name|ssids
decl_stmt|;
name|size_t
name|ssids_num
init|=
literal|0
decl_stmt|;
name|u8
modifier|*
name|ssid
decl_stmt|;
name|DBusMessageIter
name|array_iter
decl_stmt|,
name|sub_array_iter
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
name|var
argument_list|)
operator|!=
name|DBUS_TYPE_ARRAY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: ssids "
literal|"must be an array of arrays of bytes"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Wrong SSIDs value type. Array of arrays of "
literal|"bytes required"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_recurse
argument_list|(
name|var
argument_list|,
operator|&
name|array_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|array_iter
argument_list|)
operator|!=
name|DBUS_TYPE_ARRAY
operator|||
name|dbus_message_iter_get_element_type
argument_list|(
operator|&
name|array_iter
argument_list|)
operator|!=
name|DBUS_TYPE_BYTE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: ssids "
literal|"must be an array of arrays of bytes"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Wrong SSIDs value type. Array of arrays of "
literal|"bytes required"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|array_iter
argument_list|)
operator|==
name|DBUS_TYPE_ARRAY
condition|)
block|{
if|if
condition|(
name|ssids_num
operator|>=
name|WPAS_MAX_SCAN_SSIDS
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"Too many ssids specified on scan dbus "
literal|"call"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Too many ssids specified. Specify "
literal|"at most four"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|array_iter
argument_list|,
operator|&
name|sub_array_iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_fixed_array
argument_list|(
operator|&
name|sub_array_iter
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|MAX_SSID_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"SSID too long (len=%d max_len=%d)"
argument_list|,
name|len
argument_list|,
name|MAX_SSID_LEN
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Invalid SSID: too long"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|len
operator|!=
literal|0
condition|)
block|{
name|ssid
operator|=
name|os_malloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"out of memory. Cannot allocate "
literal|"memory for SSID"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|ssid
argument_list|,
name|val
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* Allow zero-length SSIDs */
name|ssid
operator|=
name|NULL
expr_stmt|;
block|}
name|ssids
index|[
name|ssids_num
index|]
operator|.
name|ssid
operator|=
name|ssid
expr_stmt|;
name|ssids
index|[
name|ssids_num
index|]
operator|.
name|ssid_len
operator|=
name|len
expr_stmt|;
name|dbus_message_iter_next
argument_list|(
operator|&
name|array_iter
argument_list|)
expr_stmt|;
name|ssids_num
operator|++
expr_stmt|;
block|}
name|params
operator|->
name|num_ssids
operator|=
name|ssids_num
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_dbus_get_scan_ies
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|DBusMessageIter
modifier|*
name|var
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|reply
parameter_list|)
block|{
name|u8
modifier|*
name|ies
init|=
name|NULL
decl_stmt|,
modifier|*
name|nies
decl_stmt|;
name|int
name|ies_len
init|=
literal|0
decl_stmt|;
name|DBusMessageIter
name|array_iter
decl_stmt|,
name|sub_array_iter
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
name|var
argument_list|)
operator|!=
name|DBUS_TYPE_ARRAY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: ies must "
literal|"be an array of arrays of bytes"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Wrong IEs value type. Array of arrays of "
literal|"bytes required"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_recurse
argument_list|(
name|var
argument_list|,
operator|&
name|array_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|array_iter
argument_list|)
operator|!=
name|DBUS_TYPE_ARRAY
operator|||
name|dbus_message_iter_get_element_type
argument_list|(
operator|&
name|array_iter
argument_list|)
operator|!=
name|DBUS_TYPE_BYTE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: ies must "
literal|"be an array of arrays of bytes"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Wrong IEs value type. Array required"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|array_iter
argument_list|)
operator|==
name|DBUS_TYPE_ARRAY
condition|)
block|{
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|array_iter
argument_list|,
operator|&
name|sub_array_iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_fixed_array
argument_list|(
operator|&
name|sub_array_iter
argument_list|,
operator|&
name|val
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|==
literal|0
condition|)
block|{
name|dbus_message_iter_next
argument_list|(
operator|&
name|array_iter
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|nies
operator|=
name|os_realloc
argument_list|(
name|ies
argument_list|,
name|ies_len
operator|+
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|nies
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"out of memory. Cannot allocate memory for "
literal|"IE"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ies
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|ies
operator|=
name|nies
expr_stmt|;
name|os_memcpy
argument_list|(
name|ies
operator|+
name|ies_len
argument_list|,
name|val
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|ies_len
operator|+=
name|len
expr_stmt|;
name|dbus_message_iter_next
argument_list|(
operator|&
name|array_iter
argument_list|)
expr_stmt|;
block|}
name|params
operator|->
name|extra_ies
operator|=
name|ies
expr_stmt|;
name|params
operator|->
name|extra_ies_len
operator|=
name|ies_len
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_dbus_get_scan_channels
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|DBusMessageIter
modifier|*
name|var
parameter_list|,
name|struct
name|wpa_driver_scan_params
modifier|*
name|params
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|reply
parameter_list|)
block|{
name|DBusMessageIter
name|array_iter
decl_stmt|,
name|sub_array_iter
decl_stmt|;
name|int
modifier|*
name|freqs
init|=
name|NULL
decl_stmt|,
modifier|*
name|nfreqs
decl_stmt|;
name|int
name|freqs_num
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
name|var
argument_list|)
operator|!=
name|DBUS_TYPE_ARRAY
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"Channels must be an array of structs"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Wrong Channels value type. Array of structs "
literal|"required"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_recurse
argument_list|(
name|var
argument_list|,
operator|&
name|array_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|array_iter
argument_list|)
operator|!=
name|DBUS_TYPE_STRUCT
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: Channels must be an "
literal|"array of structs"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Wrong Channels value type. Array of structs "
literal|"required"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
while|while
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|array_iter
argument_list|)
operator|==
name|DBUS_TYPE_STRUCT
condition|)
block|{
name|int
name|freq
decl_stmt|,
name|width
decl_stmt|;
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|array_iter
argument_list|,
operator|&
name|sub_array_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|sub_array_iter
argument_list|)
operator|!=
name|DBUS_TYPE_UINT32
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"Channel must by specified by struct of "
literal|"two UINT32s %c"
argument_list|,
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|sub_array_iter
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Wrong Channel struct. Two UINT32s "
literal|"required"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|sub_array_iter
argument_list|,
operator|&
name|freq
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbus_message_iter_next
argument_list|(
operator|&
name|sub_array_iter
argument_list|)
operator|||
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|sub_array_iter
argument_list|)
operator|!=
name|DBUS_TYPE_UINT32
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"Channel must by specified by struct of "
literal|"two UINT32s"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Wrong Channel struct. Two UINT32s required"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|sub_array_iter
argument_list|,
operator|&
name|width
argument_list|)
expr_stmt|;
define|#
directive|define
name|FREQS_ALLOC_CHUNK
value|32
if|if
condition|(
name|freqs_num
operator|%
name|FREQS_ALLOC_CHUNK
operator|==
literal|0
condition|)
block|{
name|nfreqs
operator|=
name|os_realloc_array
argument_list|(
name|freqs
argument_list|,
name|freqs_num
operator|+
name|FREQS_ALLOC_CHUNK
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nfreqs
operator|==
name|NULL
condition|)
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
name|freqs
operator|=
name|nfreqs
expr_stmt|;
block|}
if|if
condition|(
name|freqs
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"out of memory. can't allocate memory for "
literal|"freqs"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|freqs
index|[
name|freqs_num
index|]
operator|=
name|freq
expr_stmt|;
name|freqs_num
operator|++
expr_stmt|;
name|dbus_message_iter_next
argument_list|(
operator|&
name|array_iter
argument_list|)
expr_stmt|;
block|}
name|nfreqs
operator|=
name|os_realloc_array
argument_list|(
name|freqs
argument_list|,
name|freqs_num
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nfreqs
operator|==
name|NULL
condition|)
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
name|freqs
operator|=
name|nfreqs
expr_stmt|;
if|if
condition|(
name|freqs
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"out of memory. Can't allocate memory for freqs"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|freqs
index|[
name|freqs_num
index|]
operator|=
literal|0
expr_stmt|;
name|params
operator|->
name|freqs
operator|=
name|freqs
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_scan - Request a wireless scan on an interface  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NULL indicating success or DBus error message on failure  *  * Handler function for "Scan" method call of a network device. Requests  * that wpa_supplicant perform a wireless scan as soon as possible  * on a particular wireless interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_scan
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|,
name|dict_iter
decl_stmt|,
name|entry_iter
decl_stmt|,
name|variant_iter
decl_stmt|;
name|char
modifier|*
name|key
init|=
name|NULL
decl_stmt|,
modifier|*
name|type
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_driver_scan_params
name|params
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
expr_stmt|;
while|while
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|dict_iter
argument_list|)
operator|==
name|DBUS_TYPE_DICT_ENTRY
condition|)
block|{
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|dict_iter
argument_list|,
operator|&
name|entry_iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|entry_iter
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|dbus_message_iter_next
argument_list|(
operator|&
name|entry_iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|entry_iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|key
argument_list|,
literal|"Type"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|wpas_dbus_get_scan_type
argument_list|(
name|message
argument_list|,
operator|&
name|variant_iter
argument_list|,
operator|&
name|type
argument_list|,
operator|&
name|reply
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|key
argument_list|,
literal|"SSIDs"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|wpas_dbus_get_scan_ssids
argument_list|(
name|message
argument_list|,
operator|&
name|variant_iter
argument_list|,
operator|&
name|params
argument_list|,
operator|&
name|reply
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|key
argument_list|,
literal|"IEs"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|wpas_dbus_get_scan_ies
argument_list|(
name|message
argument_list|,
operator|&
name|variant_iter
argument_list|,
operator|&
name|params
argument_list|,
operator|&
name|reply
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|key
argument_list|,
literal|"Channels"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|wpas_dbus_get_scan_channels
argument_list|(
name|message
argument_list|,
operator|&
name|variant_iter
argument_list|,
operator|&
name|params
argument_list|,
operator|&
name|reply
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|out
goto|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"Unknown argument %s"
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|key
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dbus_message_iter_next
argument_list|(
operator|&
name|dict_iter
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|type
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"Scan type not specified"
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|key
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|type
argument_list|,
literal|"passive"
argument_list|)
condition|)
block|{
if|if
condition|(
name|params
operator|.
name|num_ssids
operator|||
name|params
operator|.
name|extra_ies_len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"SSIDs or IEs specified for passive scan."
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"You can specify only Channels in "
literal|"passive scan"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
elseif|else
if|if
condition|(
name|params
operator|.
name|freqs
operator|&&
name|params
operator|.
name|freqs
index|[
literal|0
index|]
condition|)
block|{
name|wpa_supplicant_trigger_scan
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_s
operator|->
name|scan_req
operator|=
name|MANUAL_SCAN_REQ
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|type
argument_list|,
literal|"active"
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|params
operator|.
name|num_ssids
condition|)
block|{
comment|/* Add wildcard ssid */
name|params
operator|.
name|num_ssids
operator|++
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_AUTOSCAN
name|autoscan_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_AUTOSCAN */
name|wpa_supplicant_trigger_scan
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|params
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_scan[dbus]: "
literal|"Unknown scan type: %s"
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Wrong scan type"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|WPAS_MAX_SCAN_SSIDS
condition|;
name|i
operator|++
control|)
name|os_free
argument_list|(
operator|(
name|u8
operator|*
operator|)
name|params
operator|.
name|ssids
index|[
name|i
index|]
operator|.
name|ssid
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
operator|(
name|u8
operator|*
operator|)
name|params
operator|.
name|extra_ies
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|params
operator|.
name|freqs
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/*  * wpas_dbus_handler_disconnect - Terminate the current connection  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NotConnected DBus error message if already not connected  * or NULL otherwise.  *  * Handler function for "Disconnect" method call of network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_disconnect
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|!=
name|NULL
condition|)
block|{
name|wpa_s
operator|->
name|disconnected
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_NOT_CONNECTED
argument_list|,
literal|"This interface is not connected"
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_new_iface_add_network - Add a new configured network  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing the object path of the new network  *  * Handler function for "AddNetwork" method call of a network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_add_network
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|NULL
decl_stmt|;
name|char
name|path_buf
index|[
name|WPAS_DBUS_OBJECT_PATH_MAX
index|]
decl_stmt|,
modifier|*
name|path
init|=
name|path_buf
decl_stmt|;
name|DBusError
name|error
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"wpas_dbus_handler_add_network[dbus]: "
literal|"can't add new interface."
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"wpa_supplicant could not add "
literal|"a network on this interface."
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|wpas_notify_network_added
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|disabled
operator|=
literal|1
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
name|dbus_error_init
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|set_network_properties
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
operator|&
name|iter
argument_list|,
operator|&
name|error
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_handler_add_network[dbus]:"
literal|"control interface couldn't set network "
literal|"properties"
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_reply_new_from_error
argument_list|(
name|message
argument_list|,
operator|&
name|error
argument_list|,
name|DBUS_ERROR_INVALID_ARGS
argument_list|,
literal|"Failed to add network"
argument_list|)
expr_stmt|;
name|dbus_error_free
argument_list|(
operator|&
name|error
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
comment|/* Construct the object path for this network. */
name|os_snprintf
argument_list|(
name|path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NEW_NETWORKS_PART
literal|"/%d"
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
if|if
condition|(
operator|!
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
block|{
name|dbus_message_unref
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
return|return
name|reply
return|;
name|err
label|:
if|if
condition|(
name|ssid
condition|)
block|{
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_reassociate - Reassociate to current AP  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NotConnected DBus error message if not connected  * or NULL otherwise.  *  * Handler function for "Reassociate" method call of network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_reassociate
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
operator|!=
name|NULL
condition|)
block|{
name|wpas_request_connection
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_NOT_CONNECTED
argument_list|,
literal|"This interface is not connected"
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_remove_network - Remove a configured network  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NULL on success or dbus error on failure  *  * Handler function for "RemoveNetwork" method call of a network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_remove_network
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|op
decl_stmt|;
name|char
modifier|*
name|iface
init|=
name|NULL
decl_stmt|,
modifier|*
name|net_id
init|=
name|NULL
decl_stmt|;
name|int
name|id
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|op
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
comment|/* Extract the network ID and ensure the network */
comment|/* is actually a child of this interface */
name|iface
operator|=
name|wpas_dbus_new_decompose_object_path
argument_list|(
name|op
argument_list|,
literal|0
argument_list|,
operator|&
name|net_id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
operator|||
name|net_id
operator|==
name|NULL
operator|||
name|os_strcmp
argument_list|(
name|iface
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|op
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|errno
operator|=
literal|0
expr_stmt|;
name|id
operator|=
name|strtoul
argument_list|(
name|net_id
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|op
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_network_unknown
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"wpas_dbus_handler_remove_network[dbus]: "
literal|"error occurred when removing network %d"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"error removing the specified network on "
literal|"this interface."
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|out
label|:
name|os_free
argument_list|(
name|iface
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|net_id
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|remove_network
parameter_list|(
name|void
modifier|*
name|arg
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|arg
decl_stmt|;
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"wpas_dbus_handler_remove_all_networks[dbus]: "
literal|"error occurred when removing network %d"
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_remove_all_networks - Remove all configured networks  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NULL on success or dbus error on failure  *  * Handler function for "RemoveAllNetworks" method call of a network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_remove_all_networks
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
comment|/* NB: could check for failure and return an error */
name|wpa_config_foreach_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|remove_network
argument_list|,
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_select_network - Attempt association with a network  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NULL on success or dbus error on failure  *  * Handler function for "SelectNetwork" method call of network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_select_network
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|op
decl_stmt|;
name|char
modifier|*
name|iface
init|=
name|NULL
decl_stmt|,
modifier|*
name|net_id
init|=
name|NULL
decl_stmt|;
name|int
name|id
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|op
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
comment|/* Extract the network ID and ensure the network */
comment|/* is actually a child of this interface */
name|iface
operator|=
name|wpas_dbus_new_decompose_object_path
argument_list|(
name|op
argument_list|,
literal|0
argument_list|,
operator|&
name|net_id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
operator|||
name|net_id
operator|==
name|NULL
operator|||
name|os_strcmp
argument_list|(
name|iface
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|op
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|errno
operator|=
literal|0
expr_stmt|;
name|id
operator|=
name|strtoul
argument_list|(
name|net_id
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|op
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_network_unknown
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Finally, associate with the network */
name|wpa_supplicant_select_network
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|out
label|:
name|os_free
argument_list|(
name|iface
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|net_id
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_network_reply - Reply to a NetworkRequest signal  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NULL on success or dbus error on failure  *  * Handler function for "NetworkReply" method call of network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_network_reply
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|IEEE8021X_EAPOL
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|op
decl_stmt|,
modifier|*
name|field
decl_stmt|,
modifier|*
name|value
decl_stmt|;
name|char
modifier|*
name|iface
init|=
name|NULL
decl_stmt|,
modifier|*
name|net_id
init|=
name|NULL
decl_stmt|;
name|int
name|id
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|op
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|field
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|value
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
comment|/* Extract the network ID and ensure the network */
comment|/* is actually a child of this interface */
name|iface
operator|=
name|wpas_dbus_new_decompose_object_path
argument_list|(
name|op
argument_list|,
literal|0
argument_list|,
operator|&
name|net_id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
operator|||
name|net_id
operator|==
name|NULL
operator|||
name|os_strcmp
argument_list|(
name|iface
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|op
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|errno
operator|=
literal|0
expr_stmt|;
name|id
operator|=
name|strtoul
argument_list|(
name|net_id
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|net_id
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_error_network_unknown
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|wpa_supplicant_ctrl_iface_ctrl_rsp_handle
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|,
name|field
argument_list|,
name|value
argument_list|)
operator|<
literal|0
condition|)
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|field
argument_list|)
expr_stmt|;
else|else
block|{
comment|/* Tell EAP to retry immediately */
name|eapol_sm_notify_ctrl_response
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
block|}
name|out
label|:
name|os_free
argument_list|(
name|iface
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|net_id
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
else|#
directive|else
comment|/* IEEE8021X_EAPOL */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"CTRL_IFACE: 802.1X not included"
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"802.1X not included"
argument_list|)
return|;
endif|#
directive|endif
comment|/* IEEE8021X_EAPOL */
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_add_blob - Store named binary blob (ie, for certificates)  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: A dbus message containing an error on failure or NULL on success  *  * Asks wpa_supplicant to internally store a binary blobs.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_add_blob
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|,
name|array_iter
decl_stmt|;
name|char
modifier|*
name|blob_name
decl_stmt|;
name|u8
modifier|*
name|blob_data
decl_stmt|;
name|int
name|blob_len
decl_stmt|;
name|struct
name|wpa_config_blob
modifier|*
name|blob
init|=
name|NULL
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|blob_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_get_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|blob_name
argument_list|)
condition|)
block|{
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_BLOB_EXISTS
argument_list|,
name|NULL
argument_list|)
return|;
block|}
name|dbus_message_iter_next
argument_list|(
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|array_iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_fixed_array
argument_list|(
operator|&
name|array_iter
argument_list|,
operator|&
name|blob_data
argument_list|,
operator|&
name|blob_len
argument_list|)
expr_stmt|;
name|blob
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|blob
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|blob
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|blob
operator|->
name|data
operator|=
name|os_malloc
argument_list|(
name|blob_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|blob
operator|->
name|data
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|os_memcpy
argument_list|(
name|blob
operator|->
name|data
argument_list|,
name|blob_data
argument_list|,
name|blob_len
argument_list|)
expr_stmt|;
name|blob
operator|->
name|len
operator|=
name|blob_len
expr_stmt|;
name|blob
operator|->
name|name
operator|=
name|os_strdup
argument_list|(
name|blob_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|blob
operator|->
name|name
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|err
goto|;
block|}
name|wpa_config_set_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|blob
argument_list|)
expr_stmt|;
name|wpas_notify_blob_added
argument_list|(
name|wpa_s
argument_list|,
name|blob
operator|->
name|name
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
name|err
label|:
if|if
condition|(
name|blob
condition|)
block|{
name|os_free
argument_list|(
name|blob
operator|->
name|name
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|blob
operator|->
name|data
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|blob
argument_list|)
expr_stmt|;
block|}
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_get_blob - Get named binary blob (ie, for certificates)  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: A dbus message containing array of bytes (blob)  *  * Gets one wpa_supplicant's binary blobs.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_get_blob
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|,
name|array_iter
decl_stmt|;
name|char
modifier|*
name|blob_name
decl_stmt|;
specifier|const
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|blob_name
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
name|blob
operator|=
name|wpa_config_get_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|blob_name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|blob
condition|)
block|{
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_BLOB_UNKNOWN
argument_list|,
literal|"Blob id not set"
argument_list|)
return|;
block|}
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reply
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|dbus_message_iter_init_append
argument_list|(
name|reply
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
operator|&
name|iter
argument_list|,
name|DBUS_TYPE_ARRAY
argument_list|,
name|DBUS_TYPE_BYTE_AS_STRING
argument_list|,
operator|&
name|array_iter
argument_list|)
condition|)
block|{
name|dbus_message_unref
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_append_fixed_array
argument_list|(
operator|&
name|array_iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
operator|&
operator|(
name|blob
operator|->
name|data
operator|)
argument_list|,
name|blob
operator|->
name|len
argument_list|)
condition|)
block|{
name|dbus_message_unref
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|array_iter
argument_list|)
condition|)
block|{
name|dbus_message_unref
argument_list|(
name|reply
argument_list|)
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|out
label|:
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_remove_handler_remove_blob - Remove named binary blob  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: NULL on success or dbus error  *  * Asks wpa_supplicant to internally remove a binary blobs.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_remove_blob
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|blob_name
decl_stmt|;
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|blob_name
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_remove_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|blob_name
argument_list|)
condition|)
block|{
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_BLOB_UNKNOWN
argument_list|,
literal|"Blob id not set"
argument_list|)
return|;
block|}
name|wpas_notify_blob_removed
argument_list|(
name|wpa_s
argument_list|,
name|blob_name
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/*  * wpas_dbus_handler_flush_bss - Flush the BSS cache  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NULL  *  * Handler function for "FlushBSS" method call of network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_flush_bss
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|dbus_uint32_t
name|age
decl_stmt|;
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_UINT32
argument_list|,
operator|&
name|age
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
if|if
condition|(
name|age
operator|==
literal|0
condition|)
name|wpa_bss_flush
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
else|else
name|wpa_bss_flush_by_age
argument_list|(
name|wpa_s
argument_list|,
name|age
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_AUTOSCAN
end_ifdef

begin_comment
comment|/**  * wpas_dbus_handler_autoscan - Set autoscan parameters for the interface  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: NULL  *  * Handler function for "AutoScan" method call of network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_autoscan
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|enum
name|wpa_states
name|state
init|=
name|wpa_s
operator|->
name|wpa_state
decl_stmt|;
name|char
modifier|*
name|arg
decl_stmt|;
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|arg
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|!=
name|NULL
operator|&&
name|os_strlen
argument_list|(
name|arg
argument_list|)
operator|>
literal|0
condition|)
block|{
name|char
modifier|*
name|tmp
decl_stmt|;
name|tmp
operator|=
name|os_strdup
argument_list|(
name|arg
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|autoscan
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|autoscan
operator|=
name|tmp
expr_stmt|;
if|if
condition|(
name|state
operator|==
name|WPA_DISCONNECTED
operator|||
name|state
operator|==
name|WPA_INACTIVE
condition|)
name|autoscan_init
argument_list|(
name|wpa_s
argument_list|,
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|state
operator|==
name|WPA_SCANNING
condition|)
name|wpa_supplicant_reinit_autoscan
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|arg
operator|!=
name|NULL
operator|&&
name|os_strlen
argument_list|(
name|arg
argument_list|)
operator|==
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|autoscan
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|autoscan
operator|=
name|NULL
expr_stmt|;
name|autoscan_deinit
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
block|}
else|else
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_INVALID_ARGS
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_AUTOSCAN */
end_comment

begin_comment
comment|/**  * wpas_dbus_getter_capabilities - Return interface capabilities  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Capabilities" property of an interface.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_capabilities
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
name|int
name|res
decl_stmt|;
name|DBusMessageIter
name|iter_dict
decl_stmt|,
name|iter_dict_entry
decl_stmt|,
name|iter_dict_val
decl_stmt|,
name|iter_array
decl_stmt|,
name|variant_iter
decl_stmt|;
specifier|const
name|char
modifier|*
name|scans
index|[]
init|=
block|{
literal|"active"
block|,
literal|"passive"
block|,
literal|"ssid"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_VARIANT
argument_list|,
literal|"a{sv}"
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_write
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|iter_dict
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
name|res
operator|=
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
expr_stmt|;
comment|/***** pairwise cipher */
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|args
index|[]
init|=
block|{
literal|"ccmp"
block|,
literal|"tkip"
block|,
literal|"none"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Pairwise"
argument_list|,
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Pairwise"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_CCMP
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"ccmp"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_GCMP
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"gcmp"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_TKIP
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"tkip"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_NONE
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"none"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
comment|/***** group cipher */
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|args
index|[]
init|=
block|{
literal|"ccmp"
block|,
literal|"tkip"
block|,
literal|"wep104"
block|,
literal|"wep40"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Group"
argument_list|,
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Group"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_CCMP
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"ccmp"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_GCMP
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"gcmp"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_TKIP
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"tkip"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_WEP104
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wep104"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_WEP40
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wep40"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
comment|/***** key management */
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|args
index|[]
init|=
block|{
literal|"wpa-psk"
block|,
literal|"wpa-eap"
block|,
literal|"ieee8021x"
block|,
literal|"wpa-none"
block|,
ifdef|#
directive|ifdef
name|CONFIG_WPS
literal|"wps"
block|,
endif|#
directive|endif
comment|/* CONFIG_WPS */
literal|"none"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"KeyMgmt"
argument_list|,
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"KeyMgmt"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"none"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"ieee8021x"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
operator|(
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wpa-eap"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
name|WPA_DRIVER_CAPA_KEY_MGMT_FT
condition|)
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wpa-ft-eap"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
comment|/* TODO: Ensure that driver actually supports sha256 encryption. */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wpa-eap-sha256"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
block|}
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
operator|(
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_PSK
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2_PSK
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wpa-psk"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
name|WPA_DRIVER_CAPA_KEY_MGMT_FT_PSK
condition|)
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wpa-ft-psk"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
comment|/* TODO: Ensure that driver actually supports sha256 encryption. */
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wpa-psk-sha256"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
block|}
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_NONE
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wpa-none"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_WPS
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wps"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
comment|/***** WPA protocol */
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|args
index|[]
init|=
block|{
literal|"rsn"
block|,
literal|"wpa"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Protocol"
argument_list|,
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Protocol"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
operator|(
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2_PSK
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"rsn"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
operator|(
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_PSK
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"wpa"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
comment|/***** auth alg */
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
specifier|const
name|char
modifier|*
name|args
index|[]
init|=
block|{
literal|"open"
block|,
literal|"shared"
block|,
literal|"leap"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"AuthAlg"
argument_list|,
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"AuthAlg"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
name|capa
operator|.
name|auth
operator|&
operator|(
name|WPA_DRIVER_AUTH_OPEN
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"open"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|auth
operator|&
operator|(
name|WPA_DRIVER_AUTH_SHARED
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"shared"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|auth
operator|&
operator|(
name|WPA_DRIVER_AUTH_LEAP
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"leap"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
comment|/***** Scan */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Scan"
argument_list|,
name|scans
argument_list|,
sizeof|sizeof
argument_list|(
name|scans
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
comment|/***** Modes */
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Modes"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"infrastructure"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"ad-hoc"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
name|res
operator|>=
literal|0
condition|)
block|{
if|if
condition|(
name|capa
operator|.
name|flags
operator|&
operator|(
name|WPA_DRIVER_FLAGS_AP
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"ap"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|flags
operator|&
operator|(
name|WPA_DRIVER_FLAGS_P2P_CAPABLE
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"p2p"
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
comment|/***** Modes end */
if|if
condition|(
name|res
operator|>=
literal|0
condition|)
block|{
name|dbus_int32_t
name|max_scan_ssid
init|=
name|capa
operator|.
name|max_scan_ssids
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_int32
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"MaxScanSSID"
argument_list|,
name|max_scan_ssid
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_close_write
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|iter_dict
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
return|return
name|TRUE
return|;
name|nomem
label|:
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_state - Get interface state  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "State" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_state
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
specifier|const
name|char
modifier|*
name|str_state
decl_stmt|;
name|char
modifier|*
name|state_ls
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
name|dbus_bool_t
name|success
init|=
name|FALSE
decl_stmt|;
name|str_state
operator|=
name|wpa_supplicant_state_txt
argument_list|(
name|wpa_s
operator|->
name|wpa_state
argument_list|)
expr_stmt|;
comment|/* make state string lowercase to fit new DBus API convention 	 */
name|state_ls
operator|=
name|tmp
operator|=
name|os_strdup
argument_list|(
name|str_state
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
while|while
condition|(
operator|*
name|tmp
condition|)
block|{
operator|*
name|tmp
operator|=
name|tolower
argument_list|(
operator|*
name|tmp
argument_list|)
expr_stmt|;
name|tmp
operator|++
expr_stmt|;
block|}
name|success
operator|=
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|state_ls
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|state_ls
argument_list|)
expr_stmt|;
return|return
name|success
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_new_iface_get_scanning - Get interface scanning state  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "scanning" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_scanning
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_bool_t
name|scanning
init|=
name|wpa_s
operator|->
name|scanning
condition|?
name|TRUE
else|:
name|FALSE
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|scanning
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_ap_scan - Control roaming mode  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter function for "ApScan" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_ap_scan
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_uint32_t
name|ap_scan
init|=
name|wpa_s
operator|->
name|conf
operator|->
name|ap_scan
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_UINT32
argument_list|,
operator|&
name|ap_scan
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_ap_scan - Control roaming mode  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter function for "ApScan" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_ap_scan
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_uint32_t
name|ap_scan
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_UINT32
argument_list|,
operator|&
name|ap_scan
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|wpa_supplicant_set_ap_scan
argument_list|(
name|wpa_s
argument_list|,
name|ap_scan
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"ap_scan must be 0, 1, or 2"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_fast_reauth - Control fast  * reauthentication (TLS session resumption)  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter function for "FastReauth" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_fast_reauth
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_bool_t
name|fast_reauth
init|=
name|wpa_s
operator|->
name|conf
operator|->
name|fast_reauth
condition|?
name|TRUE
else|:
name|FALSE
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|fast_reauth
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_fast_reauth - Control fast  * reauthentication (TLS session resumption)  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter function for "FastReauth" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_fast_reauth
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_bool_t
name|fast_reauth
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|fast_reauth
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|wpa_s
operator|->
name|conf
operator|->
name|fast_reauth
operator|=
name|fast_reauth
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_disconnect_reason - Get most recent reason for disconnect  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "DisconnectReason" property.  The reason is negative if it is  * locally generated.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_disconnect_reason
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_int32_t
name|reason
init|=
name|wpa_s
operator|->
name|disconnect_reason
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_INT32
argument_list|,
operator|&
name|reason
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_expire_age - Get BSS entry expiration age  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter function for "BSSExpireAge" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_expire_age
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_uint32_t
name|expire_age
init|=
name|wpa_s
operator|->
name|conf
operator|->
name|bss_expiration_age
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_UINT32
argument_list|,
operator|&
name|expire_age
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_bss_expire_age - Control BSS entry expiration age  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter function for "BSSExpireAge" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_bss_expire_age
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_uint32_t
name|expire_age
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_UINT32
argument_list|,
operator|&
name|expire_age
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|wpa_supplicant_set_bss_expiration_age
argument_list|(
name|wpa_s
argument_list|,
name|expire_age
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"BSSExpireAge must be>= 10"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_expire_count - Get BSS entry expiration scan count  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter function for "BSSExpireCount" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_expire_count
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_uint32_t
name|expire_count
init|=
name|wpa_s
operator|->
name|conf
operator|->
name|bss_expiration_scan_count
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_UINT32
argument_list|,
operator|&
name|expire_count
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_bss_expire_count - Control BSS entry expiration scan count  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter function for "BSSExpireCount" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_bss_expire_count
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_uint32_t
name|expire_count
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_UINT32
argument_list|,
operator|&
name|expire_count
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|wpa_supplicant_set_bss_expiration_count
argument_list|(
name|wpa_s
argument_list|,
name|expire_count
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"BSSExpireCount must be> 0"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_country - Control country code  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter function for "Country" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_country
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|char
name|country
index|[
literal|3
index|]
decl_stmt|;
name|char
modifier|*
name|str
init|=
name|country
decl_stmt|;
name|country
index|[
literal|0
index|]
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
expr_stmt|;
name|country
index|[
literal|1
index|]
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
expr_stmt|;
name|country
index|[
literal|2
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|str
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_country - Control country code  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter function for "Country" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_country
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
specifier|const
name|char
modifier|*
name|country
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|country
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|country
index|[
literal|0
index|]
operator|||
operator|!
name|country
index|[
literal|1
index|]
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"invalid country code"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|drv_priv
operator|!=
name|NULL
operator|&&
name|wpa_drv_set_country
argument_list|(
name|wpa_s
argument_list|,
name|country
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to set country"
argument_list|)
expr_stmt|;
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to set country code"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|0
index|]
operator|=
name|country
index|[
literal|0
index|]
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|country
index|[
literal|1
index|]
operator|=
name|country
index|[
literal|1
index|]
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_scan_interval - Get scan interval  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter function for "ScanInterval" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_scan_interval
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_int32_t
name|scan_interval
init|=
name|wpa_s
operator|->
name|scan_interval
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_INT32
argument_list|,
operator|&
name|scan_interval
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_scan_interval - Control scan interval  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter function for "ScanInterval" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_scan_interval
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_int32_t
name|scan_interval
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_INT32
argument_list|,
operator|&
name|scan_interval
argument_list|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|wpa_supplicant_set_scan_interval
argument_list|(
name|wpa_s
argument_list|,
name|scan_interval
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"scan_interval must be>= 0"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_ifname - Get interface name  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Ifname" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_ifname
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
specifier|const
name|char
modifier|*
name|ifname
init|=
name|wpa_s
operator|->
name|ifname
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|ifname
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_driver - Get interface name  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Driver" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_driver
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
specifier|const
name|char
modifier|*
name|driver
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|driver
operator|==
name|NULL
operator|||
name|wpa_s
operator|->
name|driver
operator|->
name|name
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"wpas_dbus_getter_driver[dbus]: "
literal|"wpa_s has no driver set"
argument_list|)
expr_stmt|;
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: no driver set"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|driver
operator|=
name|wpa_s
operator|->
name|driver
operator|->
name|name
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|driver
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_current_bss - Get current bss object path  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "CurrentBSS" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_current_bss
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|char
name|path_buf
index|[
name|WPAS_DBUS_OBJECT_PATH_MAX
index|]
decl_stmt|,
modifier|*
name|bss_obj_path
init|=
name|path_buf
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_bss
condition|)
name|os_snprintf
argument_list|(
name|bss_obj_path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NEW_BSSIDS_PART
literal|"/%u"
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|wpa_s
operator|->
name|current_bss
operator|->
name|id
argument_list|)
expr_stmt|;
else|else
name|os_snprintf
argument_list|(
name|bss_obj_path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|bss_obj_path
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_current_network - Get current network object path  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "CurrentNetwork" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_current_network
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|char
name|path_buf
index|[
name|WPAS_DBUS_OBJECT_PATH_MAX
index|]
decl_stmt|,
modifier|*
name|net_obj_path
init|=
name|path_buf
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|current_ssid
condition|)
name|os_snprintf
argument_list|(
name|net_obj_path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NEW_NETWORKS_PART
literal|"/%u"
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|wpa_s
operator|->
name|current_ssid
operator|->
name|id
argument_list|)
expr_stmt|;
else|else
name|os_snprintf
argument_list|(
name|net_obj_path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|net_obj_path
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_current_auth_mode - Get current authentication type  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "CurrentAuthMode" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_current_auth_mode
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
specifier|const
name|char
modifier|*
name|eap_mode
decl_stmt|;
specifier|const
name|char
modifier|*
name|auth_mode
decl_stmt|;
name|char
name|eap_mode_buf
index|[
name|WPAS_DBUS_AUTH_MODE_MAX
index|]
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
condition|)
block|{
name|auth_mode
operator|=
literal|"INACTIVE"
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X
operator|||
name|wpa_s
operator|->
name|key_mgmt
operator|==
name|WPA_KEY_MGMT_IEEE8021X_NO_WPA
condition|)
block|{
name|eap_mode
operator|=
name|wpa_supplicant_get_eap_mode
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|os_snprintf
argument_list|(
name|eap_mode_buf
argument_list|,
name|WPAS_DBUS_AUTH_MODE_MAX
argument_list|,
literal|"EAP-%s"
argument_list|,
name|eap_mode
argument_list|)
expr_stmt|;
name|auth_mode
operator|=
name|eap_mode_buf
expr_stmt|;
block|}
else|else
block|{
name|auth_mode
operator|=
name|wpa_key_mgmt_txt
argument_list|(
name|wpa_s
operator|->
name|key_mgmt
argument_list|,
name|wpa_s
operator|->
name|current_ssid
operator|->
name|proto
argument_list|)
expr_stmt|;
block|}
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|auth_mode
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bridge_ifname - Get interface name  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "BridgeIfname" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bridge_ifname
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
specifier|const
name|char
modifier|*
name|bridge_ifname
init|=
name|wpa_s
operator|->
name|bridge_ifname
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|bridge_ifname
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bsss - Get array of BSSs objects  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "BSSs" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bsss
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|char
modifier|*
modifier|*
name|paths
decl_stmt|;
name|unsigned
name|int
name|i
init|=
literal|0
decl_stmt|;
name|dbus_bool_t
name|success
init|=
name|FALSE
decl_stmt|;
name|paths
operator|=
name|os_calloc
argument_list|(
name|wpa_s
operator|->
name|num_bss
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|paths
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|/* Loop through scan results and append each result's object path */
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss_id
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list_id
argument_list|)
block|{
name|paths
index|[
name|i
index|]
operator|=
name|os_zalloc
argument_list|(
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|paths
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Construct the object path for this BSS. */
name|os_snprintf
argument_list|(
name|paths
index|[
name|i
operator|++
index|]
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NEW_BSSIDS_PART
literal|"/%u"
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|bss
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
name|success
operator|=
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
name|paths
argument_list|,
name|wpa_s
operator|->
name|num_bss
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|out
label|:
while|while
condition|(
name|i
condition|)
name|os_free
argument_list|(
name|paths
index|[
operator|--
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|paths
argument_list|)
expr_stmt|;
return|return
name|success
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_networks - Get array of networks objects  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Networks" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_networks
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|char
modifier|*
modifier|*
name|paths
decl_stmt|;
name|unsigned
name|int
name|i
init|=
literal|0
decl_stmt|,
name|num
init|=
literal|0
decl_stmt|;
name|dbus_bool_t
name|success
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|conf
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s[dbus]: An error occurred getting "
literal|"networks list."
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: an error "
literal|"occurred getting the networks list"
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
if|if
condition|(
operator|!
name|network_is_persistent_group
argument_list|(
name|ssid
argument_list|)
condition|)
name|num
operator|++
expr_stmt|;
name|paths
operator|=
name|os_calloc
argument_list|(
name|num
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|paths
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
comment|/* Loop through configured networks and append object path of each */
for|for
control|(
name|ssid
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|ssid
init|;
name|ssid
condition|;
name|ssid
operator|=
name|ssid
operator|->
name|next
control|)
block|{
if|if
condition|(
name|network_is_persistent_group
argument_list|(
name|ssid
argument_list|)
condition|)
continue|continue;
name|paths
index|[
name|i
index|]
operator|=
name|os_zalloc
argument_list|(
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|)
expr_stmt|;
if|if
condition|(
name|paths
index|[
name|i
index|]
operator|==
name|NULL
condition|)
block|{
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Construct the object path for this network. */
name|os_snprintf
argument_list|(
name|paths
index|[
name|i
operator|++
index|]
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NEW_NETWORKS_PART
literal|"/%d"
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
name|success
operator|=
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
name|paths
argument_list|,
name|num
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|out
label|:
while|while
condition|(
name|i
condition|)
name|os_free
argument_list|(
name|paths
index|[
operator|--
name|i
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|paths
argument_list|)
expr_stmt|;
return|return
name|success
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_blobs - Get all blobs defined for this interface  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Blobs" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_blobs
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|DBusMessageIter
name|variant_iter
decl_stmt|,
name|dict_iter
decl_stmt|,
name|entry_iter
decl_stmt|,
name|array_iter
decl_stmt|;
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_VARIANT
argument_list|,
literal|"a{say}"
argument_list|,
operator|&
name|variant_iter
argument_list|)
operator|||
operator|!
name|dbus_message_iter_open_container
argument_list|(
operator|&
name|variant_iter
argument_list|,
name|DBUS_TYPE_ARRAY
argument_list|,
literal|"{say}"
argument_list|,
operator|&
name|dict_iter
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|blob
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|blobs
expr_stmt|;
while|while
condition|(
name|blob
condition|)
block|{
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
operator|&
name|dict_iter
argument_list|,
name|DBUS_TYPE_DICT_ENTRY
argument_list|,
name|NULL
argument_list|,
operator|&
name|entry_iter
argument_list|)
operator|||
operator|!
name|dbus_message_iter_append_basic
argument_list|(
operator|&
name|entry_iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
operator|(
name|blob
operator|->
name|name
operator|)
argument_list|)
operator|||
operator|!
name|dbus_message_iter_open_container
argument_list|(
operator|&
name|entry_iter
argument_list|,
name|DBUS_TYPE_ARRAY
argument_list|,
name|DBUS_TYPE_BYTE_AS_STRING
argument_list|,
operator|&
name|array_iter
argument_list|)
operator|||
operator|!
name|dbus_message_iter_append_fixed_array
argument_list|(
operator|&
name|array_iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
operator|&
operator|(
name|blob
operator|->
name|data
operator|)
argument_list|,
name|blob
operator|->
name|len
argument_list|)
operator|||
operator|!
name|dbus_message_iter_close_container
argument_list|(
operator|&
name|entry_iter
argument_list|,
operator|&
name|array_iter
argument_list|)
operator|||
operator|!
name|dbus_message_iter_close_container
argument_list|(
operator|&
name|dict_iter
argument_list|,
operator|&
name|entry_iter
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|blob
operator|=
name|blob
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
operator|||
operator|!
name|dbus_message_iter_close_container
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_bss
modifier|*
name|get_bss_helper
parameter_list|(
name|struct
name|bss_handler_args
modifier|*
name|args
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
specifier|const
name|char
modifier|*
name|func_name
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|res
init|=
name|wpa_bss_get_id
argument_list|(
name|args
operator|->
name|wpa_s
argument_list|,
name|args
operator|->
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"%s[dbus]: no bss with id %d found"
argument_list|,
name|func_name
argument_list|,
name|args
operator|->
name|id
argument_list|)
expr_stmt|;
name|dbus_set_error
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"%s: BSS %d not found"
argument_list|,
name|func_name
argument_list|,
name|args
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
return|return
name|res
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_bssid - Return the BSSID of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "BSSID" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_bssid
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
return|return
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
name|res
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_ssid - Return the SSID of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "SSID" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_ssid
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
return|return
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
name|res
operator|->
name|ssid
argument_list|,
name|res
operator|->
name|ssid_len
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_privacy - Return the privacy flag of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Privacy" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_privacy
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
name|dbus_bool_t
name|privacy
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
name|privacy
operator|=
operator|(
name|res
operator|->
name|caps
operator|&
name|IEEE80211_CAP_PRIVACY
operator|)
condition|?
name|TRUE
else|:
name|FALSE
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|privacy
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_mode - Return the mode of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Mode" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_mode
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
specifier|const
name|char
modifier|*
name|mode
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
name|res
operator|->
name|caps
operator|&
name|IEEE80211_CAP_IBSS
condition|)
name|mode
operator|=
literal|"ad-hoc"
expr_stmt|;
else|else
name|mode
operator|=
literal|"infrastructure"
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|mode
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_level - Return the signal strength of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Level" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_signal
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
name|s16
name|level
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
name|level
operator|=
operator|(
name|s16
operator|)
name|res
operator|->
name|level
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_INT16
argument_list|,
operator|&
name|level
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_frequency - Return the frequency of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Frequency" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_frequency
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
name|u16
name|freq
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
name|freq
operator|=
operator|(
name|u16
operator|)
name|res
operator|->
name|freq
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_UINT16
argument_list|,
operator|&
name|freq
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cmp_u8s_desc
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
return|return
operator|(
operator|*
operator|(
name|u8
operator|*
operator|)
name|b
operator|-
operator|*
operator|(
name|u8
operator|*
operator|)
name|a
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_rates - Return available bit rates of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Rates" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_rates
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
name|u8
modifier|*
name|ie_rates
init|=
name|NULL
decl_stmt|;
name|u32
modifier|*
name|real_rates
decl_stmt|;
name|int
name|rates_num
decl_stmt|,
name|i
decl_stmt|;
name|dbus_bool_t
name|success
init|=
name|FALSE
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
name|rates_num
operator|=
name|wpa_bss_get_bit_rates
argument_list|(
name|res
argument_list|,
operator|&
name|ie_rates
argument_list|)
expr_stmt|;
if|if
condition|(
name|rates_num
operator|<
literal|0
condition|)
return|return
name|FALSE
return|;
name|qsort
argument_list|(
name|ie_rates
argument_list|,
name|rates_num
argument_list|,
literal|1
argument_list|,
name|cmp_u8s_desc
argument_list|)
expr_stmt|;
name|real_rates
operator|=
name|os_malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|u32
argument_list|)
operator|*
name|rates_num
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|real_rates
condition|)
block|{
name|os_free
argument_list|(
name|ie_rates
argument_list|)
expr_stmt|;
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rates_num
condition|;
name|i
operator|++
control|)
name|real_rates
index|[
name|i
index|]
operator|=
name|ie_rates
index|[
name|i
index|]
operator|*
literal|500000
expr_stmt|;
name|success
operator|=
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_UINT32
argument_list|,
name|real_rates
argument_list|,
name|rates_num
argument_list|,
name|error
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|ie_rates
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|real_rates
argument_list|)
expr_stmt|;
return|return
name|success
return|;
block|}
end_function

begin_function
specifier|static
name|dbus_bool_t
name|wpas_dbus_get_bss_security_prop
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|struct
name|wpa_ie_data
modifier|*
name|ie_data
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|)
block|{
name|DBusMessageIter
name|iter_dict
decl_stmt|,
name|variant_iter
decl_stmt|;
specifier|const
name|char
modifier|*
name|group
decl_stmt|;
specifier|const
name|char
modifier|*
name|pairwise
index|[
literal|3
index|]
decl_stmt|;
comment|/* max 3 pairwise ciphers is supported */
specifier|const
name|char
modifier|*
name|key_mgmt
index|[
literal|7
index|]
decl_stmt|;
comment|/* max 7 key managements may be supported */
name|int
name|n
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_VARIANT
argument_list|,
literal|"a{sv}"
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_write
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|iter_dict
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
comment|/* KeyMgmt */
name|n
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ie_data
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK
condition|)
name|key_mgmt
index|[
name|n
operator|++
index|]
operator|=
literal|"wpa-psk"
expr_stmt|;
if|if
condition|(
name|ie_data
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_PSK
condition|)
name|key_mgmt
index|[
name|n
operator|++
index|]
operator|=
literal|"wpa-ft-psk"
expr_stmt|;
if|if
condition|(
name|ie_data
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_PSK_SHA256
condition|)
name|key_mgmt
index|[
name|n
operator|++
index|]
operator|=
literal|"wpa-psk-sha256"
expr_stmt|;
if|if
condition|(
name|ie_data
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X
condition|)
name|key_mgmt
index|[
name|n
operator|++
index|]
operator|=
literal|"wpa-eap"
expr_stmt|;
if|if
condition|(
name|ie_data
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_FT_IEEE8021X
condition|)
name|key_mgmt
index|[
name|n
operator|++
index|]
operator|=
literal|"wpa-ft-eap"
expr_stmt|;
if|if
condition|(
name|ie_data
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_IEEE8021X_SHA256
condition|)
name|key_mgmt
index|[
name|n
operator|++
index|]
operator|=
literal|"wpa-eap-sha256"
expr_stmt|;
if|if
condition|(
name|ie_data
operator|->
name|key_mgmt
operator|&
name|WPA_KEY_MGMT_NONE
condition|)
name|key_mgmt
index|[
name|n
operator|++
index|]
operator|=
literal|"wpa-none"
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"KeyMgmt"
argument_list|,
name|key_mgmt
argument_list|,
name|n
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
comment|/* Group */
switch|switch
condition|(
name|ie_data
operator|->
name|group_cipher
condition|)
block|{
case|case
name|WPA_CIPHER_WEP40
case|:
name|group
operator|=
literal|"wep40"
expr_stmt|;
break|break;
case|case
name|WPA_CIPHER_TKIP
case|:
name|group
operator|=
literal|"tkip"
expr_stmt|;
break|break;
case|case
name|WPA_CIPHER_CCMP
case|:
name|group
operator|=
literal|"ccmp"
expr_stmt|;
break|break;
case|case
name|WPA_CIPHER_GCMP
case|:
name|group
operator|=
literal|"gcmp"
expr_stmt|;
break|break;
case|case
name|WPA_CIPHER_WEP104
case|:
name|group
operator|=
literal|"wep104"
expr_stmt|;
break|break;
default|default:
name|group
operator|=
literal|""
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Group"
argument_list|,
name|group
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
comment|/* Pairwise */
name|n
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ie_data
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_TKIP
condition|)
name|pairwise
index|[
name|n
operator|++
index|]
operator|=
literal|"tkip"
expr_stmt|;
if|if
condition|(
name|ie_data
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_CCMP
condition|)
name|pairwise
index|[
name|n
operator|++
index|]
operator|=
literal|"ccmp"
expr_stmt|;
if|if
condition|(
name|ie_data
operator|->
name|pairwise_cipher
operator|&
name|WPA_CIPHER_GCMP
condition|)
name|pairwise
index|[
name|n
operator|++
index|]
operator|=
literal|"gcmp"
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Pairwise"
argument_list|,
name|pairwise
argument_list|,
name|n
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
comment|/* Management group (RSN only) */
if|if
condition|(
name|ie_data
operator|->
name|proto
operator|==
name|WPA_PROTO_RSN
condition|)
block|{
switch|switch
condition|(
name|ie_data
operator|->
name|mgmt_group_cipher
condition|)
block|{
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
case|case
name|WPA_CIPHER_AES_128_CMAC
case|:
name|group
operator|=
literal|"aes128cmac"
expr_stmt|;
break|break;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
default|default:
name|group
operator|=
literal|""
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"MgmtGroup"
argument_list|,
name|group
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_close_write
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|iter_dict
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
return|return
name|TRUE
return|;
name|nomem
label|:
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_wpa - Return the WPA options of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "WPA" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_wpa
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
name|struct
name|wpa_ie_data
name|wpa_data
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
name|os_memset
argument_list|(
operator|&
name|wpa_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_data
argument_list|)
argument_list|)
expr_stmt|;
name|ie
operator|=
name|wpa_bss_get_vendor_ie
argument_list|(
name|res
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
condition|)
block|{
if|if
condition|(
name|wpa_parse_wpa_ie
argument_list|(
name|ie
argument_list|,
literal|2
operator|+
name|ie
index|[
literal|1
index|]
argument_list|,
operator|&
name|wpa_data
argument_list|)
operator|<
literal|0
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to parse WPA IE"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
return|return
name|wpas_dbus_get_bss_security_prop
argument_list|(
name|iter
argument_list|,
operator|&
name|wpa_data
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_rsn - Return the RSN options of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "RSN" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_rsn
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
name|struct
name|wpa_ie_data
name|wpa_data
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
name|os_memset
argument_list|(
operator|&
name|wpa_data
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|wpa_data
argument_list|)
argument_list|)
expr_stmt|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|res
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
condition|)
block|{
if|if
condition|(
name|wpa_parse_wpa_ie
argument_list|(
name|ie
argument_list|,
literal|2
operator|+
name|ie
index|[
literal|1
index|]
argument_list|,
operator|&
name|wpa_data
argument_list|)
operator|<
literal|0
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_FAILED
argument_list|,
literal|"failed to parse RSN IE"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
block|}
return|return
name|wpas_dbus_get_bss_security_prop
argument_list|(
name|iter
argument_list|,
operator|&
name|wpa_data
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_wps - Return the WPS options of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "WPS" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_wps
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_WPS
name|struct
name|wpabuf
modifier|*
name|wps_ie
decl_stmt|;
endif|#
directive|endif
comment|/* CONFIG_WPS */
name|DBusMessageIter
name|iter_dict
decl_stmt|,
name|variant_iter
decl_stmt|;
specifier|const
name|char
modifier|*
name|type
init|=
literal|""
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_VARIANT
argument_list|,
literal|"a{sv}"
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_write
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|iter_dict
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
ifdef|#
directive|ifdef
name|CONFIG_WPS
name|wps_ie
operator|=
name|wpa_bss_get_vendor_ie_multi
argument_list|(
name|res
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|wps_ie
condition|)
block|{
if|if
condition|(
name|wps_is_selected_pbc_registrar
argument_list|(
name|wps_ie
argument_list|)
condition|)
name|type
operator|=
literal|"pbc"
expr_stmt|;
elseif|else
if|if
condition|(
name|wps_is_selected_pin_registrar
argument_list|(
name|wps_ie
argument_list|)
condition|)
name|type
operator|=
literal|"pin"
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* CONFIG_WPS */
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"Type"
argument_list|,
name|type
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_close_write
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|iter_dict
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
if|if
condition|(
operator|!
name|dbus_message_iter_close_container
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
goto|goto
name|nomem
goto|;
return|return
name|TRUE
return|;
name|nomem
label|:
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_bss_ies - Return all IEs of a BSS  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "IEs" property.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_bss_ies
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|bss_handler_args
modifier|*
name|args
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|res
decl_stmt|;
name|res
operator|=
name|get_bss_helper
argument_list|(
name|args
argument_list|,
name|error
argument_list|,
name|__func__
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
return|return
name|FALSE
return|;
return|return
name|wpas_dbus_simple_array_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BYTE
argument_list|,
name|res
operator|+
literal|1
argument_list|,
name|res
operator|->
name|ie_len
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_enabled - Check whether network is enabled or disabled  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "enabled" property of a configured network.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_enabled
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|network_handler_args
modifier|*
name|net
init|=
name|user_data
decl_stmt|;
name|dbus_bool_t
name|enabled
init|=
name|net
operator|->
name|ssid
operator|->
name|disabled
condition|?
name|FALSE
else|:
name|TRUE
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|enabled
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_enabled - Mark a configured network as enabled or disabled  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter for "Enabled" property of a configured network.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_enabled
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|network_handler_args
modifier|*
name|net
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|dbus_bool_t
name|enable
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|enable
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|wpa_s
operator|=
name|net
operator|->
name|wpa_s
expr_stmt|;
name|ssid
operator|=
name|net
operator|->
name|ssid
expr_stmt|;
if|if
condition|(
name|enable
condition|)
name|wpa_supplicant_enable_network
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
else|else
name|wpa_supplicant_disable_network
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_network_properties - Get options for a configured network  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "Properties" property of a configured network.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_network_properties
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|network_handler_args
modifier|*
name|net
init|=
name|user_data
decl_stmt|;
name|DBusMessageIter
name|variant_iter
decl_stmt|,
name|dict_iter
decl_stmt|;
name|char
modifier|*
modifier|*
name|iterator
decl_stmt|;
name|char
modifier|*
modifier|*
name|props
init|=
name|wpa_config_get_all
argument_list|(
name|net
operator|->
name|ssid
argument_list|,
literal|1
argument_list|)
decl_stmt|;
name|dbus_bool_t
name|success
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|!
name|props
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|dbus_message_iter_open_container
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_VARIANT
argument_list|,
literal|"a{sv}"
argument_list|,
operator|&
name|variant_iter
argument_list|)
operator|||
operator|!
name|wpa_dbus_dict_open_write
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|iterator
operator|=
name|props
expr_stmt|;
while|while
condition|(
operator|*
name|iterator
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string
argument_list|(
operator|&
name|dict_iter
argument_list|,
operator|*
name|iterator
argument_list|,
operator|*
operator|(
name|iterator
operator|+
literal|1
operator|)
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|iterator
operator|+=
literal|2
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_close_write
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
operator|||
operator|!
name|dbus_message_iter_close_container
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
condition|)
block|{
name|dbus_set_error_const
argument_list|(
name|error
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"no memory"
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|success
operator|=
name|TRUE
expr_stmt|;
name|out
label|:
name|iterator
operator|=
name|props
expr_stmt|;
while|while
condition|(
operator|*
name|iterator
condition|)
block|{
name|os_free
argument_list|(
operator|*
name|iterator
argument_list|)
expr_stmt|;
name|iterator
operator|++
expr_stmt|;
block|}
name|os_free
argument_list|(
name|props
argument_list|)
expr_stmt|;
return|return
name|success
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_network_properties - Set options for a configured network  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter for "Properties" property of a configured network.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_network_properties
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|network_handler_args
modifier|*
name|net
init|=
name|user_data
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|net
operator|->
name|ssid
decl_stmt|;
name|DBusMessageIter
name|variant_iter
decl_stmt|;
name|dbus_message_iter_recurse
argument_list|(
name|iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
return|return
name|set_network_properties
argument_list|(
name|net
operator|->
name|wpa_s
argument_list|,
name|ssid
argument_list|,
operator|&
name|variant_iter
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_AP
end_ifdef

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_subscribe_preq
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpas_dbus_priv
modifier|*
name|priv
init|=
name|wpa_s
operator|->
name|global
operator|->
name|dbus
decl_stmt|;
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|preq_notify_peer
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|dbus_message_get_sender
argument_list|(
name|message
argument_list|)
argument_list|,
name|wpa_s
operator|->
name|preq_notify_peer
argument_list|)
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_SUBSCRIPTION_IN_USE
argument_list|,
literal|"Another application is already subscribed"
argument_list|)
return|;
block|}
name|name
operator|=
name|os_strdup
argument_list|(
name|dbus_message_get_sender
argument_list|(
name|message
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|name
condition|)
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|DBUS_ERROR_NO_MEMORY
argument_list|,
literal|"out of memory"
argument_list|)
return|;
name|wpa_s
operator|->
name|preq_notify_peer
operator|=
name|name
expr_stmt|;
comment|/* Subscribe to clean up if application closes socket */
name|wpas_dbus_subscribe_noc
argument_list|(
name|priv
argument_list|)
expr_stmt|;
comment|/* 	 * Double-check it's still alive to make sure that we didn't 	 * miss the NameOwnerChanged signal, e.g. while strdup'ing. 	 */
if|if
condition|(
operator|!
name|dbus_bus_name_has_owner
argument_list|(
name|priv
operator|->
name|con
argument_list|,
name|name
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
comment|/* 		 * Application no longer exists, clean up. 		 * The return value is irrelevant now. 		 * 		 * Need to check if the NameOwnerChanged handling 		 * already cleaned up because we have processed 		 * DBus messages while checking if the name still 		 * has an owner. 		 */
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|preq_notify_peer
condition|)
return|return
name|NULL
return|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|preq_notify_peer
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|preq_notify_peer
operator|=
name|NULL
expr_stmt|;
name|wpas_dbus_unsubscribe_noc
argument_list|(
name|priv
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_unsubscribe_preq
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|struct
name|wpas_dbus_priv
modifier|*
name|priv
init|=
name|wpa_s
operator|->
name|global
operator|->
name|dbus
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|preq_notify_peer
condition|)
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_NO_SUBSCRIPTION
argument_list|,
literal|"Not subscribed"
argument_list|)
return|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|wpa_s
operator|->
name|preq_notify_peer
argument_list|,
name|dbus_message_get_sender
argument_list|(
name|message
argument_list|)
argument_list|)
condition|)
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_DBUS_ERROR_SUBSCRIPTION_EPERM
argument_list|,
literal|"Can't unsubscribe others"
argument_list|)
return|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|preq_notify_peer
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|preq_notify_peer
operator|=
name|NULL
expr_stmt|;
name|wpas_dbus_unsubscribe_noc
argument_list|(
name|priv
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|void
name|wpas_dbus_signal_preq
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
specifier|const
name|u8
modifier|*
name|dst
parameter_list|,
specifier|const
name|u8
modifier|*
name|bssid
parameter_list|,
specifier|const
name|u8
modifier|*
name|ie
parameter_list|,
name|size_t
name|ie_len
parameter_list|,
name|u32
name|ssi_signal
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|msg
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|,
name|dict_iter
decl_stmt|;
name|struct
name|wpas_dbus_priv
modifier|*
name|priv
init|=
name|wpa_s
operator|->
name|global
operator|->
name|dbus
decl_stmt|;
comment|/* Do nothing if the control interface is not turned on */
if|if
condition|(
name|priv
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|preq_notify_peer
operator|==
name|NULL
condition|)
return|return;
name|msg
operator|=
name|dbus_message_new_signal
argument_list|(
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|WPAS_DBUS_NEW_IFACE_INTERFACE
argument_list|,
literal|"ProbeRequest"
argument_list|)
expr_stmt|;
if|if
condition|(
name|msg
operator|==
name|NULL
condition|)
return|return;
name|dbus_message_set_destination
argument_list|(
name|msg
argument_list|,
name|wpa_s
operator|->
name|preq_notify_peer
argument_list|)
expr_stmt|;
name|dbus_message_iter_init_append
argument_list|(
name|msg
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_write
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|addr
operator|&&
operator|!
name|wpa_dbus_dict_append_byte_array
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"addr"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|addr
argument_list|,
name|ETH_ALEN
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|dst
operator|&&
operator|!
name|wpa_dbus_dict_append_byte_array
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"dst"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|dst
argument_list|,
name|ETH_ALEN
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|bssid
operator|&&
operator|!
name|wpa_dbus_dict_append_byte_array
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"bssid"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|ie
operator|&&
name|ie_len
operator|&&
operator|!
name|wpa_dbus_dict_append_byte_array
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"ies"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|ie
argument_list|,
name|ie_len
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
name|ssi_signal
operator|&&
operator|!
name|wpa_dbus_dict_append_int32
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"signal"
argument_list|,
name|ssi_signal
argument_list|)
condition|)
goto|goto
name|fail
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_close_write
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
condition|)
goto|goto
name|fail
goto|;
name|dbus_connection_send
argument_list|(
name|priv
operator|->
name|con
argument_list|,
name|msg
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
name|fail
label|:
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"dbus: Failed to construct signal"
argument_list|)
expr_stmt|;
name|out
label|:
name|dbus_message_unref
argument_list|(
name|msg
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_AP */
end_comment

end_unit


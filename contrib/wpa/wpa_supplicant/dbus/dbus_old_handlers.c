begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / dbus-based control interface  * Copyright (c) 2006, Dan Williams<dcbw@redhat.com> and Red Hat, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<dbus/dbus.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"eap_peer/eap_methods.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"eapol_supp/eapol_supp_sm.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"../config.h"
end_include

begin_include
include|#
directive|include
file|"../wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"../driver_i.h"
end_include

begin_include
include|#
directive|include
file|"../notify.h"
end_include

begin_include
include|#
directive|include
file|"../wpas_glue.h"
end_include

begin_include
include|#
directive|include
file|"../bss.h"
end_include

begin_include
include|#
directive|include
file|"../scan.h"
end_include

begin_include
include|#
directive|include
file|"dbus_old.h"
end_include

begin_include
include|#
directive|include
file|"dbus_old_handlers.h"
end_include

begin_include
include|#
directive|include
file|"dbus_dict_helpers.h"
end_include

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_level
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_show_keys
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|wpa_debug_timestamp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/**  * wpas_dbus_new_invalid_opts_error - Return a new invalid options error message  * @message: Pointer to incoming dbus message this error refers to  * Returns: a dbus error message  *  * Convenience function to create and return an invalid options error  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_new_invalid_opts_error
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
specifier|const
name|char
modifier|*
name|arg
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
decl_stmt|;
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_INVALID_OPTS
argument_list|,
literal|"Did not receive correct message "
literal|"arguments."
argument_list|)
expr_stmt|;
if|if
condition|(
name|arg
operator|!=
name|NULL
condition|)
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|arg
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_new_success_reply - Return a new success reply message  * @message: Pointer to incoming dbus message this reply refers to  * Returns: a dbus message containing a single UINT32 that indicates  *          success (ie, a value of 1)  *  * Convenience function to create and return a success reply message  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_new_success_reply
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
decl_stmt|;
name|unsigned
name|int
name|success
init|=
literal|1
decl_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_UINT32
argument_list|,
operator|&
name|success
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_global_add_interface - Request registration of a network interface  * @message: Pointer to incoming dbus message  * @global: %wpa_supplicant global data structure  * Returns: The object path of the new interface object,  *          or a dbus error message with more information  *  * Handler function for "addInterface" method call. Handles requests  * by dbus clients to register a network interface that wpa_supplicant  * will manage.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_global_add_interface
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|char
modifier|*
name|ifname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|driver
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|driver_param
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|confname
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|bridge_ifname
init|=
name|NULL
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
comment|/* First argument: interface name (DBUS_TYPE_STRING) 	 *    Required; must be non-zero length 	 */
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|iter
argument_list|)
operator|!=
name|DBUS_TYPE_STRING
condition|)
goto|goto
name|error
goto|;
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|os_strlen
argument_list|(
name|ifname
argument_list|)
condition|)
goto|goto
name|error
goto|;
comment|/* Second argument: dict of options */
if|if
condition|(
name|dbus_message_iter_next
argument_list|(
operator|&
name|iter
argument_list|)
condition|)
block|{
name|DBusMessageIter
name|iter_dict
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"driver"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|driver
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|driver
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"driver-params"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|driver_param
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|driver_param
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"config-file"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|confname
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|confname
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"bridge-ifname"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|bridge_ifname
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
if|if
condition|(
name|bridge_ifname
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
else|else
block|{
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
block|}
block|}
comment|/* 	 * Try to get the wpa_supplicant record for this iface, return 	 * an error if we already control it. 	 */
if|if
condition|(
name|wpa_supplicant_get_iface
argument_list|(
name|global
argument_list|,
name|ifname
argument_list|)
operator|!=
name|NULL
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_EXISTS_ERROR
argument_list|,
literal|"wpa_supplicant already "
literal|"controls this interface."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|struct
name|wpa_interface
name|iface
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|iface
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|iface
argument_list|)
argument_list|)
expr_stmt|;
name|iface
operator|.
name|ifname
operator|=
name|ifname
expr_stmt|;
name|iface
operator|.
name|driver
operator|=
name|driver
expr_stmt|;
name|iface
operator|.
name|driver_param
operator|=
name|driver_param
expr_stmt|;
name|iface
operator|.
name|confname
operator|=
name|confname
expr_stmt|;
name|iface
operator|.
name|bridge_ifname
operator|=
name|bridge_ifname
expr_stmt|;
comment|/* Otherwise, have wpa_supplicant attach to it. */
if|if
condition|(
operator|(
name|wpa_s
operator|=
name|wpa_supplicant_add_iface
argument_list|(
name|global
argument_list|,
operator|&
name|iface
argument_list|)
operator|)
condition|)
block|{
specifier|const
name|char
modifier|*
name|path
init|=
name|wpa_s
operator|->
name|dbus_path
decl_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_ADD_ERROR
argument_list|,
literal|"wpa_supplicant "
literal|"couldn't grab this "
literal|"interface."
argument_list|)
expr_stmt|;
block|}
block|}
name|out
label|:
name|os_free
argument_list|(
name|driver
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|driver_param
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|confname
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|bridge_ifname
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
name|error
label|:
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_global_remove_interface - Request deregistration of an interface  * @message: Pointer to incoming dbus message  * @global: wpa_supplicant global data structure  * Returns: a dbus message containing a UINT32 indicating success (1) or  *          failure (0), or returns a dbus error message with more information  *  * Handler function for "removeInterface" method call.  Handles requests  * by dbus clients to deregister a network interface that wpa_supplicant  * currently manages.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_global_remove_interface
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
name|char
modifier|*
name|path
decl_stmt|;
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_s
operator|=
name|wpa_supplicant_get_iface_by_dbus_path
argument_list|(
name|global
argument_list|,
name|path
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_iface_error
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_supplicant_remove_iface
argument_list|(
name|global
argument_list|,
name|wpa_s
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_REMOVE_ERROR
argument_list|,
literal|"wpa_supplicant couldn't "
literal|"remove this interface."
argument_list|)
expr_stmt|;
block|}
name|out
label|:
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_global_get_interface - Get the object path for an interface name  * @message: Pointer to incoming dbus message  * @global: %wpa_supplicant global data structure  * Returns: The object path of the interface object,  *          or a dbus error message with more information  *  * Handler function for "getInterface" method call. Handles requests  * by dbus clients for the object path of an specific network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_global_get_interface
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|ifname
decl_stmt|;
specifier|const
name|char
modifier|*
name|path
decl_stmt|;
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|ifname
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpa_s
operator|=
name|wpa_supplicant_get_iface
argument_list|(
name|global
argument_list|,
name|ifname
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_iface_error
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|path
operator|=
name|wpa_s
operator|->
name|dbus_path
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_global_set_debugparams- Set the debug params  * @message: Pointer to incoming dbus message  * @global: %wpa_supplicant global data structure  * Returns: a dbus message containing a UINT32 indicating success (1) or  *          failure (0), or returns a dbus error message with more information  *  * Handler function for "setDebugParams" method call. Handles requests  * by dbus clients for the object path of an specific network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_global_set_debugparams
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_global
modifier|*
name|global
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|int
name|debug_level
decl_stmt|;
name|dbus_bool_t
name|debug_timestamp
decl_stmt|;
name|dbus_bool_t
name|debug_show_keys
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_INT32
argument_list|,
operator|&
name|debug_level
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|debug_timestamp
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|debug_show_keys
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
block|{
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
block|}
if|if
condition|(
name|wpa_supplicant_set_debug_params
argument_list|(
name|global
argument_list|,
name|debug_level
argument_list|,
name|debug_timestamp
condition|?
literal|1
else|:
literal|0
argument_list|,
name|debug_show_keys
condition|?
literal|1
else|:
literal|0
argument_list|)
condition|)
block|{
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
block|}
name|reply
operator|=
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_scan - Request a wireless scan on an interface  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: a dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "scan" method call of a network device. Requests  * that wpa_supplicant perform a wireless scan as soon as possible  * on a particular wireless interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_scan
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|scan_req
operator|=
name|MANUAL_SCAN_REQ
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_scan_results - Get the results of a recent scan request  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: a dbus message containing a dbus array of objects paths, or returns  *          a dbus error message if not scan results could be found  *  * Handler function for "scanResults" method call of a network device. Returns  * a dbus message containing the object paths of wireless networks found.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_scan_results
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|;
name|DBusMessageIter
name|sub_iter
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
comment|/* Create and initialize the return message */
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dbus_message_iter_init_append
argument_list|(
name|reply
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_open_container
argument_list|(
operator|&
name|iter
argument_list|,
name|DBUS_TYPE_ARRAY
argument_list|,
name|DBUS_TYPE_OBJECT_PATH_AS_STRING
argument_list|,
operator|&
name|sub_iter
argument_list|)
expr_stmt|;
comment|/* Loop through scan results and append each result's object path */
name|dl_list_for_each
argument_list|(
argument|bss
argument_list|,
argument|&wpa_s->bss_id
argument_list|,
argument|struct wpa_bss
argument_list|,
argument|list_id
argument_list|)
block|{
name|char
name|path_buf
index|[
name|WPAS_DBUS_OBJECT_PATH_MAX
index|]
decl_stmt|;
name|char
modifier|*
name|path
init|=
name|path_buf
decl_stmt|;
comment|/* Construct the object path for this network.  Note that ':' 		 * is not a valid character in dbus object paths. 		 */
name|os_snprintf
argument_list|(
name|path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_BSSIDS_PART
literal|"/"
name|WPAS_DBUS_BSSID_FORMAT
argument_list|,
name|wpa_s
operator|->
name|dbus_path
argument_list|,
name|MAC2STR
argument_list|(
name|bss
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|dbus_message_iter_append_basic
argument_list|(
operator|&
name|sub_iter
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|)
expr_stmt|;
block|}
name|dbus_message_iter_close_container
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|sub_iter
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_bssid_properties - Return the properties of a scanned network  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * @res: wpa_supplicant scan result for which to get properties  * Returns: a dbus message containing the properties for the requested network  *  * Handler function for "properties" method call of a scanned network.  * Returns a dbus message containing the the properties.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_bssid_properties
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_bss
modifier|*
name|bss
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|,
name|iter_dict
decl_stmt|;
specifier|const
name|u8
modifier|*
name|ie
decl_stmt|;
comment|/* Dump the properties into a dbus message */
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dbus_message_iter_init_append
argument_list|(
name|reply
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_write
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_byte_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"bssid"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
condition|)
goto|goto
name|error
goto|;
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_SSID
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_byte_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"ssid"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
operator|(
name|ie
operator|+
literal|2
operator|)
argument_list|,
name|ie
index|[
literal|1
index|]
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
name|ie
operator|=
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPA_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_byte_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"wpaie"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|ie
argument_list|,
name|ie
index|[
literal|1
index|]
operator|+
literal|2
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
name|ie
operator|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_RSN
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_byte_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"rsnie"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|ie
argument_list|,
name|ie
index|[
literal|1
index|]
operator|+
literal|2
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
name|ie
operator|=
name|wpa_bss_get_vendor_ie
argument_list|(
name|bss
argument_list|,
name|WPS_IE_VENDOR_TYPE
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_byte_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"wpsie"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|ie
argument_list|,
name|ie
index|[
literal|1
index|]
operator|+
literal|2
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|bss
operator|->
name|freq
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_int32
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"frequency"
argument_list|,
name|bss
operator|->
name|freq
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_uint16
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"capabilities"
argument_list|,
name|bss
operator|->
name|caps
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
operator|(
name|bss
operator|->
name|flags
operator|&
name|WPA_BSS_QUAL_INVALID
operator|)
operator|&&
operator|!
name|wpa_dbus_dict_append_int32
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"quality"
argument_list|,
name|bss
operator|->
name|qual
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
operator|(
name|bss
operator|->
name|flags
operator|&
name|WPA_BSS_NOISE_INVALID
operator|)
operator|&&
operator|!
name|wpa_dbus_dict_append_int32
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"noise"
argument_list|,
name|bss
operator|->
name|noise
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
operator|(
name|bss
operator|->
name|flags
operator|&
name|WPA_BSS_LEVEL_INVALID
operator|)
operator|&&
operator|!
name|wpa_dbus_dict_append_int32
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"level"
argument_list|,
name|bss
operator|->
name|level
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_int32
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"maxrate"
argument_list|,
name|wpa_bss_get_max_rate
argument_list|(
name|bss
argument_list|)
operator|*
literal|500000
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_close_write
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|)
condition|)
goto|goto
name|error
goto|;
return|return
name|reply
return|;
name|error
label|:
if|if
condition|(
name|reply
condition|)
name|dbus_message_unref
argument_list|(
name|reply
argument_list|)
expr_stmt|;
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_INTERNAL_ERROR
argument_list|,
literal|"an internal error occurred returning "
literal|"BSSID properties."
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_capabilities - Return interface capabilities  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing a dict of strings  *  * Handler function for "capabilities" method call of an interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_capabilities
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_driver_capa
name|capa
decl_stmt|;
name|int
name|res
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|,
name|iter_dict
decl_stmt|;
name|char
modifier|*
modifier|*
name|eap_methods
decl_stmt|;
name|size_t
name|num_items
decl_stmt|;
name|dbus_bool_t
name|strict
init|=
name|FALSE
decl_stmt|;
name|DBusMessageIter
name|iter_dict_entry
decl_stmt|,
name|iter_dict_val
decl_stmt|,
name|iter_array
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|strict
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
name|strict
operator|=
name|FALSE
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dbus_message_iter_init_append
argument_list|(
name|reply
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_write
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|)
condition|)
goto|goto
name|error
goto|;
comment|/* EAP methods */
name|eap_methods
operator|=
name|eap_get_names_as_string_array
argument_list|(
operator|&
name|num_items
argument_list|)
expr_stmt|;
if|if
condition|(
name|eap_methods
condition|)
block|{
name|dbus_bool_t
name|success
init|=
name|FALSE
decl_stmt|;
name|size_t
name|i
init|=
literal|0
decl_stmt|;
name|success
operator|=
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"eap"
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|*
operator|)
name|eap_methods
argument_list|,
name|num_items
argument_list|)
expr_stmt|;
comment|/* free returned method array */
while|while
condition|(
name|eap_methods
index|[
name|i
index|]
condition|)
name|os_free
argument_list|(
name|eap_methods
index|[
name|i
operator|++
index|]
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|eap_methods
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|success
condition|)
goto|goto
name|error
goto|;
block|}
name|res
operator|=
name|wpa_drv_get_capa
argument_list|(
name|wpa_s
argument_list|,
operator|&
name|capa
argument_list|)
expr_stmt|;
comment|/***** pairwise cipher */
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|strict
condition|)
block|{
specifier|const
name|char
modifier|*
name|args
index|[]
init|=
block|{
literal|"CCMP"
block|,
literal|"TKIP"
block|,
literal|"NONE"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"pairwise"
argument_list|,
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"pairwise"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_CCMP
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"CCMP"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_TKIP
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"TKIP"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_NONE
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"NONE"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
comment|/***** group cipher */
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|strict
condition|)
block|{
specifier|const
name|char
modifier|*
name|args
index|[]
init|=
block|{
literal|"CCMP"
block|,
literal|"TKIP"
block|,
literal|"WEP104"
block|,
literal|"WEP40"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"group"
argument_list|,
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"group"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_CCMP
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"CCMP"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_TKIP
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"TKIP"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_WEP104
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"WEP104"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|enc
operator|&
name|WPA_DRIVER_CAPA_ENC_WEP40
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"WEP40"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
comment|/***** key management */
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|strict
condition|)
block|{
specifier|const
name|char
modifier|*
name|args
index|[]
init|=
block|{
literal|"WPA-PSK"
block|,
literal|"WPA-EAP"
block|,
literal|"IEEE8021X"
block|,
literal|"WPA-NONE"
block|,
literal|"NONE"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"key_mgmt"
argument_list|,
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"key_mgmt"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"NONE"
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"IEEE8021X"
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
operator|(
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"WPA-EAP"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
operator|(
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_PSK
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2_PSK
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"WPA-PSK"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_NONE
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"WPA-NONE"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
comment|/***** WPA protocol */
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|strict
condition|)
block|{
specifier|const
name|char
modifier|*
name|args
index|[]
init|=
block|{
literal|"RSN"
block|,
literal|"WPA"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"proto"
argument_list|,
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"proto"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
operator|(
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA2_PSK
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"RSN"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|key_mgmt
operator|&
operator|(
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA
operator||
name|WPA_DRIVER_CAPA_KEY_MGMT_WPA_PSK
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"WPA"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
comment|/***** auth alg */
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|strict
condition|)
block|{
specifier|const
name|char
modifier|*
name|args
index|[]
init|=
block|{
literal|"OPEN"
block|,
literal|"SHARED"
block|,
literal|"LEAP"
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_append_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"auth_alg"
argument_list|,
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_begin_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
literal|"auth_alg"
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
name|capa
operator|.
name|auth
operator|&
operator|(
name|WPA_DRIVER_AUTH_OPEN
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"OPEN"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|auth
operator|&
operator|(
name|WPA_DRIVER_AUTH_SHARED
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"SHARED"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
name|capa
operator|.
name|auth
operator|&
operator|(
name|WPA_DRIVER_AUTH_LEAP
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_string_array_add_element
argument_list|(
operator|&
name|iter_array
argument_list|,
literal|"LEAP"
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_end_string_array
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|iter_dict_entry
argument_list|,
operator|&
name|iter_dict_val
argument_list|,
operator|&
name|iter_array
argument_list|)
condition|)
goto|goto
name|error
goto|;
block|}
if|if
condition|(
operator|!
name|wpa_dbus_dict_close_write
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|)
condition|)
goto|goto
name|error
goto|;
return|return
name|reply
return|;
name|error
label|:
if|if
condition|(
name|reply
condition|)
name|dbus_message_unref
argument_list|(
name|reply
argument_list|)
expr_stmt|;
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_INTERNAL_ERROR
argument_list|,
literal|"an internal error occurred returning "
literal|"interface capabilities."
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_add_network - Add a new configured network  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing the object path of the new network  *  * Handler function for "addNetwork" method call of a network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_add_network
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|char
name|path_buf
index|[
name|WPAS_DBUS_OBJECT_PATH_MAX
index|]
decl_stmt|,
modifier|*
name|path
init|=
name|path_buf
decl_stmt|;
name|ssid
operator|=
name|wpa_config_add_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_ADD_NETWORK_ERROR
argument_list|,
literal|"wpa_supplicant could not add "
literal|"a network on this interface."
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpas_notify_network_added
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|ssid
operator|->
name|disabled
operator|=
literal|1
expr_stmt|;
name|wpa_config_set_network_defaults
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
comment|/* Construct the object path for this network. */
name|os_snprintf
argument_list|(
name|path
argument_list|,
name|WPAS_DBUS_OBJECT_PATH_MAX
argument_list|,
literal|"%s/"
name|WPAS_DBUS_NETWORKS_PART
literal|"/%d"
argument_list|,
name|wpa_s
operator|->
name|dbus_path
argument_list|,
name|ssid
operator|->
name|id
argument_list|)
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|path
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_remove_network - Remove a configured network  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "removeNetwork" method call of a network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_remove_network
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|op
decl_stmt|;
name|char
modifier|*
name|iface
init|=
name|NULL
decl_stmt|,
modifier|*
name|net_id
init|=
name|NULL
decl_stmt|;
name|int
name|id
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|op
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Extract the network ID */
name|iface
operator|=
name|wpas_dbus_decompose_object_path
argument_list|(
name|op
argument_list|,
operator|&
name|net_id
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_network_error
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Ensure the network is actually a child of this interface */
if|if
condition|(
name|os_strcmp
argument_list|(
name|iface
argument_list|,
name|wpa_s
operator|->
name|dbus_path
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_network_error
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|id
operator|=
name|strtoul
argument_list|(
name|net_id
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_network_error
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|wpas_notify_network_removed
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_config_remove_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|id
argument_list|)
operator|<
literal|0
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_REMOVE_NETWORK_ERROR
argument_list|,
literal|"error removing the specified "
literal|"on this interface."
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|ssid
operator|==
name|wpa_s
operator|->
name|current_ssid
condition|)
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|out
label|:
name|os_free
argument_list|(
name|iface
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|net_id
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|dont_quote
index|[]
init|=
block|{
literal|"key_mgmt"
block|,
literal|"proto"
block|,
literal|"pairwise"
block|,
literal|"auth_alg"
block|,
literal|"group"
block|,
literal|"eap"
block|,
literal|"opensc_engine_path"
block|,
literal|"pkcs11_engine_path"
block|,
literal|"pkcs11_module_path"
block|,
literal|"bssid"
block|,
name|NULL
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|dbus_bool_t
name|should_quote_opt
parameter_list|(
specifier|const
name|char
modifier|*
name|key
parameter_list|)
block|{
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|dont_quote
index|[
name|i
index|]
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|key
argument_list|,
name|dont_quote
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
return|return
name|FALSE
return|;
name|i
operator|++
expr_stmt|;
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_set_network - Set options for a configured network  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * @ssid: wpa_ssid structure for a configured network  * Returns: a dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "set" method call of a configured network.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_set_network
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
init|=
block|{
operator|.
name|type
operator|=
name|DBUS_TYPE_STRING
block|}
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|,
name|iter_dict
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
name|char
modifier|*
name|value
init|=
name|NULL
decl_stmt|;
name|size_t
name|size
init|=
literal|50
decl_stmt|;
name|int
name|ret
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Type conversions, since wpa_supplicant wants strings */
if|if
condition|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_ARRAY
operator|&&
name|entry
operator|.
name|array_type
operator|==
name|DBUS_TYPE_BYTE
condition|)
block|{
if|if
condition|(
name|entry
operator|.
name|array_len
operator|<=
literal|0
condition|)
goto|goto
name|error
goto|;
name|size
operator|=
name|entry
operator|.
name|array_len
operator|*
literal|2
operator|+
literal|1
expr_stmt|;
name|value
operator|=
name|os_zalloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ret
operator|=
name|wpa_snprintf_hex
argument_list|(
name|value
argument_list|,
name|size
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|entry
operator|.
name|bytearray_value
argument_list|,
name|entry
operator|.
name|array_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
condition|)
block|{
if|if
condition|(
name|should_quote_opt
argument_list|(
name|entry
operator|.
name|key
argument_list|)
condition|)
block|{
name|size
operator|=
name|os_strlen
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
comment|/* Zero-length option check */
if|if
condition|(
name|size
operator|<=
literal|0
condition|)
goto|goto
name|error
goto|;
name|size
operator|+=
literal|3
expr_stmt|;
comment|/* For quotes and terminator */
name|value
operator|=
name|os_zalloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|value
argument_list|,
name|size
argument_list|,
literal|"\"%s\""
argument_list|,
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|||
operator|(
name|size_t
operator|)
name|ret
operator|!=
operator|(
name|size
operator|-
literal|1
operator|)
condition|)
goto|goto
name|error
goto|;
block|}
else|else
block|{
name|value
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_UINT32
condition|)
block|{
name|value
operator|=
name|os_zalloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|value
argument_list|,
name|size
argument_list|,
literal|"%u"
argument_list|,
name|entry
operator|.
name|uint32_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_INT32
condition|)
block|{
name|value
operator|=
name|os_zalloc
argument_list|(
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|value
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
name|ret
operator|=
name|os_snprintf
argument_list|(
name|value
argument_list|,
name|size
argument_list|,
literal|"%d"
argument_list|,
name|entry
operator|.
name|int32_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<=
literal|0
condition|)
goto|goto
name|error
goto|;
block|}
else|else
goto|goto
name|error
goto|;
if|if
condition|(
name|wpa_config_set
argument_list|(
name|ssid
argument_list|,
name|entry
operator|.
name|key
argument_list|,
name|value
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"psk"
argument_list|)
operator|==
literal|0
operator|&&
name|value
index|[
literal|0
index|]
operator|==
literal|'"'
operator|&&
name|ssid
operator|->
name|ssid_len
operator|)
operator|||
operator|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"ssid"
argument_list|)
operator|==
literal|0
operator|&&
name|ssid
operator|->
name|passphrase
operator|)
condition|)
name|wpa_config_update_psk
argument_list|(
name|ssid
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"priority"
argument_list|)
operator|==
literal|0
condition|)
name|wpa_config_update_prio_list
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
continue|continue;
name|error
label|:
name|os_free
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|entry
operator|.
name|key
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|!
name|reply
condition|)
name|reply
operator|=
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_enable_network - Mark a configured network as enabled  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * @ssid: wpa_ssid structure for a configured network  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "enable" method call of a configured network.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_enable_network
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|wpa_supplicant_enable_network
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_disable_network - Mark a configured network as disabled  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * @ssid: wpa_ssid structure for a configured network  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "disable" method call of a configured network.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_disable_network
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|wpa_ssid
modifier|*
name|ssid
parameter_list|)
block|{
name|wpa_supplicant_disable_network
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_select_network - Attempt association with a configured network  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "selectNetwork" method call of network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_select_network
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|op
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
decl_stmt|;
name|char
modifier|*
name|iface_obj_path
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|network
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|os_strlen
argument_list|(
name|dbus_message_get_signature
argument_list|(
name|message
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Any network */
name|ssid
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|int
name|nid
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_OBJECT_PATH
argument_list|,
operator|&
name|op
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Extract the network number */
name|iface_obj_path
operator|=
name|wpas_dbus_decompose_object_path
argument_list|(
name|op
argument_list|,
operator|&
name|network
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|iface_obj_path
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_iface_error
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* Ensure the object path really points to this interface */
if|if
condition|(
name|os_strcmp
argument_list|(
name|iface_obj_path
argument_list|,
name|wpa_s
operator|->
name|dbus_path
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_network_error
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|nid
operator|=
name|strtoul
argument_list|(
name|network
argument_list|,
name|NULL
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|errno
operator|==
name|EINVAL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_network_error
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ssid
operator|=
name|wpa_config_get_network
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|nid
argument_list|)
expr_stmt|;
if|if
condition|(
name|ssid
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_network_error
argument_list|(
name|message
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
block|}
comment|/* Finally, associate with the network */
name|wpa_supplicant_select_network
argument_list|(
name|wpa_s
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|reply
operator|=
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|out
label|:
name|os_free
argument_list|(
name|iface_obj_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|network
argument_list|)
expr_stmt|;
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_disconnect - Terminate the current connection  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "disconnect" method call of network interface.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_disconnect
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|wpa_s
operator|->
name|disconnected
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_deauthenticate
argument_list|(
name|wpa_s
argument_list|,
name|WLAN_REASON_DEAUTH_LEAVING
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_set_ap_scan - Control roaming mode  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "setAPScan" method call.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_set_ap_scan
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|dbus_uint32_t
name|ap_scan
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_UINT32
argument_list|,
operator|&
name|ap_scan
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
if|if
condition|(
name|wpa_supplicant_set_ap_scan
argument_list|(
name|wpa_s
argument_list|,
name|ap_scan
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|reply
operator|=
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|out
label|:
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_set_smartcard_modules - Set smartcard related module paths  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "setSmartcardModules" method call.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_set_smartcard_modules
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter
decl_stmt|,
name|iter_dict
decl_stmt|;
name|char
modifier|*
name|opensc_engine_path
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|pkcs11_engine_path
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|pkcs11_module_path
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
goto|goto
name|error
goto|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
goto|goto
name|error
goto|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"opensc_engine_path"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|opensc_engine_path
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|opensc_engine_path
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"pkcs11_engine_path"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|pkcs11_engine_path
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkcs11_engine_path
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|entry
operator|.
name|key
argument_list|,
literal|"pkcs11_module_path"
argument_list|)
operator|&&
operator|(
name|entry
operator|.
name|type
operator|==
name|DBUS_TYPE_STRING
operator|)
condition|)
block|{
name|pkcs11_module_path
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|str_value
argument_list|)
expr_stmt|;
if|if
condition|(
name|pkcs11_module_path
operator|==
name|NULL
condition|)
goto|goto
name|error
goto|;
block|}
else|else
block|{
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
goto|goto
name|error
goto|;
block|}
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|opensc_engine_path
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|opensc_engine_path
operator|=
name|opensc_engine_path
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|pkcs11_engine_path
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|pkcs11_engine_path
operator|=
name|pkcs11_engine_path
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|pkcs11_module_path
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|pkcs11_module_path
operator|=
name|pkcs11_module_path
expr_stmt|;
name|wpa_sm_set_eapol
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|eapol_sm_deinit
argument_list|(
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|eapol
operator|=
name|NULL
expr_stmt|;
name|wpa_supplicant_init_eapol
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_sm_set_eapol
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|wpa_s
operator|->
name|eapol
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
return|;
name|error
label|:
name|os_free
argument_list|(
name|opensc_engine_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pkcs11_engine_path
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|pkcs11_module_path
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_get_state - Get interface state  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing a STRING representing the current  *          interface state  *  * Handler function for "state" method call.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_get_state
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|str_state
decl_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|!=
name|NULL
condition|)
block|{
name|str_state
operator|=
name|wpa_supplicant_state_txt
argument_list|(
name|wpa_s
operator|->
name|wpa_state
argument_list|)
expr_stmt|;
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|str_state
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
block|}
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_get_scanning - Get interface scanning state  * @message: Pointer to incoming dbus message  * @wpa_s: wpa_supplicant structure for a network interface  * Returns: A dbus message containing whether the interface is scanning  *  * Handler function for "scanning" method call.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_get_scanning
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|dbus_bool_t
name|scanning
init|=
name|wpa_s
operator|->
name|scanning
condition|?
name|TRUE
else|:
name|FALSE
decl_stmt|;
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|!=
name|NULL
condition|)
block|{
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|scanning
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"dbus: Not enough memory to return "
literal|"scanning state"
argument_list|)
expr_stmt|;
block|}
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_set_blobs - Store named binary blobs (ie, for certificates)  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Asks wpa_supplicant to internally store a one or more binary blobs.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_set_blobs
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|struct
name|wpa_dbus_dict_entry
name|entry
init|=
block|{
operator|.
name|type
operator|=
name|DBUS_TYPE_STRING
block|}
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|,
name|iter_dict
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_read
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|iter_dict
argument_list|,
name|NULL
argument_list|)
condition|)
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
while|while
condition|(
name|wpa_dbus_dict_has_dict_entry
argument_list|(
operator|&
name|iter_dict
argument_list|)
condition|)
block|{
name|struct
name|wpa_config_blob
modifier|*
name|blob
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_get_entry
argument_list|(
operator|&
name|iter_dict
argument_list|,
operator|&
name|entry
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|entry
operator|.
name|type
operator|!=
name|DBUS_TYPE_ARRAY
operator|||
name|entry
operator|.
name|array_type
operator|!=
name|DBUS_TYPE_BYTE
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
literal|"Byte array expected."
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|entry
operator|.
name|array_len
operator|<=
literal|0
operator|)
operator|||
operator|(
name|entry
operator|.
name|array_len
operator|>
literal|65536
operator|)
operator|||
operator|!
name|strlen
argument_list|(
name|entry
operator|.
name|key
argument_list|)
condition|)
block|{
name|reply
operator|=
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
literal|"Invalid array size."
argument_list|)
expr_stmt|;
break|break;
block|}
name|blob
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|blob
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_ADD_ERROR
argument_list|,
literal|"Not enough memory to add blob."
argument_list|)
expr_stmt|;
break|break;
block|}
name|blob
operator|->
name|data
operator|=
name|os_zalloc
argument_list|(
name|entry
operator|.
name|array_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_ADD_ERROR
argument_list|,
literal|"Not enough memory to add blob data."
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|blob
argument_list|)
expr_stmt|;
break|break;
block|}
name|blob
operator|->
name|name
operator|=
name|os_strdup
argument_list|(
name|entry
operator|.
name|key
argument_list|)
expr_stmt|;
name|blob
operator|->
name|len
operator|=
name|entry
operator|.
name|array_len
expr_stmt|;
name|os_memcpy
argument_list|(
name|blob
operator|->
name|data
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|entry
operator|.
name|bytearray_value
argument_list|,
name|entry
operator|.
name|array_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|blob
operator|->
name|name
operator|==
name|NULL
operator|||
name|blob
operator|->
name|data
operator|==
name|NULL
condition|)
block|{
name|wpa_config_free_blob
argument_list|(
name|blob
argument_list|)
expr_stmt|;
name|reply
operator|=
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_ADD_ERROR
argument_list|,
literal|"Error adding blob."
argument_list|)
expr_stmt|;
break|break;
block|}
comment|/* Success */
if|if
condition|(
operator|!
name|wpa_config_remove_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|blob
operator|->
name|name
argument_list|)
condition|)
name|wpas_notify_blob_removed
argument_list|(
name|wpa_s
argument_list|,
name|blob
operator|->
name|name
argument_list|)
expr_stmt|;
name|wpa_config_set_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|blob
argument_list|)
expr_stmt|;
name|wpas_notify_blob_added
argument_list|(
name|wpa_s
argument_list|,
name|blob
operator|->
name|name
argument_list|)
expr_stmt|;
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
block|}
name|wpa_dbus_dict_entry_clear
argument_list|(
operator|&
name|entry
argument_list|)
expr_stmt|;
return|return
name|reply
condition|?
name|reply
else|:
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_remove_blob - Remove named binary blobs  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Asks wpa_supplicant to remove one or more previously stored binary blobs.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_remove_blobs
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessageIter
name|iter
decl_stmt|,
name|array
decl_stmt|;
name|char
modifier|*
name|err_msg
init|=
name|NULL
decl_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|iter
argument_list|)
operator|!=
name|DBUS_TYPE_ARRAY
operator|)
operator|||
operator|(
name|dbus_message_iter_get_element_type
argument_list|(
operator|&
name|iter
argument_list|)
operator|!=
name|DBUS_TYPE_STRING
operator|)
condition|)
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|array
argument_list|)
expr_stmt|;
while|while
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|array
argument_list|)
operator|==
name|DBUS_TYPE_STRING
condition|)
block|{
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|array
argument_list|,
operator|&
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|os_strlen
argument_list|(
name|name
argument_list|)
condition|)
name|err_msg
operator|=
literal|"Invalid blob name."
expr_stmt|;
if|if
condition|(
name|wpa_config_remove_blob
argument_list|(
name|wpa_s
operator|->
name|conf
argument_list|,
name|name
argument_list|)
operator|!=
literal|0
condition|)
name|err_msg
operator|=
literal|"Error removing blob."
expr_stmt|;
else|else
name|wpas_notify_blob_removed
argument_list|(
name|wpa_s
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|dbus_message_iter_next
argument_list|(
operator|&
name|array
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|err_msg
condition|)
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_REMOVE_ERROR
argument_list|,
name|err_msg
argument_list|)
return|;
return|return
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_flush - Clear BSS of old or all inactive entries  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: a dbus message containing a UINT32 indicating success (1) or  *          failure (0), or returns a dbus error message with more information  *  * Handler function for "flush" method call. Handles requests for an  * interface with an optional "age" parameter that specifies the minimum  * age of a BSS to be flushed.  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_flush
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|flush_age
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|os_strlen
argument_list|(
name|dbus_message_get_signature
argument_list|(
name|message
argument_list|)
argument_list|)
operator|!=
literal|0
operator|&&
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_INT32
argument_list|,
operator|&
name|flush_age
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
block|{
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
block|}
if|if
condition|(
name|flush_age
operator|==
literal|0
condition|)
name|wpa_bss_flush
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
else|else
name|wpa_bss_flush_by_age
argument_list|(
name|wpa_s
argument_list|,
name|flush_age
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
return|;
block|}
end_function

end_unit


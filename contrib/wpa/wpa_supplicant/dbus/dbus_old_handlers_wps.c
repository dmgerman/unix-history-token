begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / dbus-based control interface (WPS)  * Copyright (c) 2006, Dan Williams<dcbw@redhat.com> and Red Hat, Inc.  *  * This program is free software; you can redistribute it and/or modify  * it under the terms of the GNU General Public License version 2 as  * published by the Free Software Foundation.  *  * Alternatively, this software may be distributed under the terms of BSD  * license.  *  * See README and COPYING for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|<dbus/dbus.h>
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"../config.h"
end_include

begin_include
include|#
directive|include
file|"../wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"../wps_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"dbus_old.h"
end_include

begin_include
include|#
directive|include
file|"dbus_old_handlers.h"
end_include

begin_comment
comment|/**  * wpas_dbus_iface_wps_pbc - Request credentials using WPS PBC method  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "wpsPbc" method call  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_wps_pbc
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|char
modifier|*
name|arg_bssid
init|=
name|NULL
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|arg_bssid
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|arg_bssid
argument_list|,
literal|"any"
argument_list|)
condition|)
name|ret
operator|=
name|wpas_wps_start_pbc
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|hwaddr_aton
argument_list|(
name|arg_bssid
argument_list|,
name|bssid
argument_list|)
condition|)
name|ret
operator|=
name|wpas_wps_start_pbc
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|)
expr_stmt|;
else|else
block|{
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
literal|"Invalid BSSID"
argument_list|)
return|;
block|}
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_WPS_PBC_ERROR
argument_list|,
literal|"Could not start PBC "
literal|"negotiation"
argument_list|)
return|;
block|}
return|return
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_wps_pin - Establish the PIN number of the enrollee  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "wpsPin" method call  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_wps_pin
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|arg_bssid
decl_stmt|;
name|char
modifier|*
name|pin
init|=
name|NULL
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|,
modifier|*
name|_bssid
init|=
name|NULL
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|arg_bssid
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|pin
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|arg_bssid
argument_list|,
literal|"any"
argument_list|)
condition|)
name|_bssid
operator|=
name|NULL
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|hwaddr_aton
argument_list|(
name|arg_bssid
argument_list|,
name|bssid
argument_list|)
condition|)
name|_bssid
operator|=
name|bssid
expr_stmt|;
else|else
block|{
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
literal|"Invalid BSSID"
argument_list|)
return|;
block|}
if|if
condition|(
name|os_strlen
argument_list|(
name|pin
argument_list|)
operator|>
literal|0
condition|)
name|ret
operator|=
name|wpas_wps_start_pin
argument_list|(
name|wpa_s
argument_list|,
name|_bssid
argument_list|,
name|pin
argument_list|)
expr_stmt|;
else|else
name|ret
operator|=
name|wpas_wps_start_pin
argument_list|(
name|wpa_s
argument_list|,
name|_bssid
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_WPS_PIN_ERROR
argument_list|,
literal|"Could not init PIN"
argument_list|)
return|;
block|}
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|reply
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|ret
operator|==
literal|0
condition|)
block|{
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|pin
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
name|npin
index|[
literal|9
index|]
decl_stmt|;
name|os_snprintf
argument_list|(
name|npin
argument_list|,
sizeof|sizeof
argument_list|(
name|npin
argument_list|)
argument_list|,
literal|"%08d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
name|dbus_message_append_args
argument_list|(
name|reply
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|npin
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
expr_stmt|;
block|}
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_iface_wps_reg - Request credentials using the PIN of the AP  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: A dbus message containing a UINT32 indicating success (1) or  *          failure (0)  *  * Handler function for "wpsReg" method call  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_iface_wps_reg
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|char
modifier|*
name|arg_bssid
decl_stmt|;
name|char
modifier|*
name|pin
init|=
name|NULL
decl_stmt|;
name|u8
name|bssid
index|[
name|ETH_ALEN
index|]
decl_stmt|;
name|int
name|ret
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|dbus_message_get_args
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|arg_bssid
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|pin
argument_list|,
name|DBUS_TYPE_INVALID
argument_list|)
condition|)
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
name|NULL
argument_list|)
return|;
if|if
condition|(
operator|!
name|os_strcmp
argument_list|(
name|arg_bssid
argument_list|,
literal|"any"
argument_list|)
condition|)
name|ret
operator|=
name|wpas_wps_start_reg
argument_list|(
name|wpa_s
argument_list|,
name|NULL
argument_list|,
name|pin
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|!
name|hwaddr_aton
argument_list|(
name|arg_bssid
argument_list|,
name|bssid
argument_list|)
condition|)
name|ret
operator|=
name|wpas_wps_start_reg
argument_list|(
name|wpa_s
argument_list|,
name|bssid
argument_list|,
name|pin
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|else
block|{
return|return
name|wpas_dbus_new_invalid_opts_error
argument_list|(
name|message
argument_list|,
literal|"Invalid BSSID"
argument_list|)
return|;
block|}
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
return|return
name|dbus_message_new_error
argument_list|(
name|message
argument_list|,
name|WPAS_ERROR_WPS_PBC_ERROR
argument_list|,
literal|"Could not request credentials"
argument_list|)
return|;
block|}
return|return
name|wpas_dbus_new_success_reply
argument_list|(
name|message
argument_list|)
return|;
block|}
end_function

end_unit


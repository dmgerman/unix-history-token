begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * WPA Supplicant / dbus-based control interface (WPS)  * Copyright (c) 2006, Dan Williams<dcbw@redhat.com> and Red Hat, Inc.  * Copyright (c) 2009, Witold Sowa<witold.sowa@gmail.com>  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"includes.h"
end_include

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_include
include|#
directive|include
file|"../config.h"
end_include

begin_include
include|#
directive|include
file|"../wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"../wps_supplicant.h"
end_include

begin_include
include|#
directive|include
file|"../driver_i.h"
end_include

begin_include
include|#
directive|include
file|"../ap.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new_helpers.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new.h"
end_include

begin_include
include|#
directive|include
file|"dbus_new_handlers.h"
end_include

begin_include
include|#
directive|include
file|"dbus_dict_helpers.h"
end_include

begin_struct
struct|struct
name|wps_start_params
block|{
name|int
name|role
decl_stmt|;
comment|/* 0 - not set, 1 - enrollee, 2 - registrar */
name|int
name|type
decl_stmt|;
comment|/* 0 - not set, 1 - pin,      2 - pbc       */
name|u8
modifier|*
name|bssid
decl_stmt|;
name|char
modifier|*
name|pin
decl_stmt|;
name|u8
modifier|*
name|p2p_dev_addr
decl_stmt|;
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|wpas_dbus_handler_wps_role
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|DBusMessageIter
modifier|*
name|entry_iter
parameter_list|,
name|struct
name|wps_start_params
modifier|*
name|params
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|reply
parameter_list|)
block|{
name|DBusMessageIter
name|variant_iter
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
name|dbus_message_iter_recurse
argument_list|(
name|entry_iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|variant_iter
argument_list|)
operator|!=
name|DBUS_TYPE_STRING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Wrong Role type, string required"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Role must be a string"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|val
argument_list|,
literal|"enrollee"
argument_list|)
operator|==
literal|0
condition|)
name|params
operator|->
name|role
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|val
argument_list|,
literal|"registrar"
argument_list|)
operator|==
literal|0
condition|)
name|params
operator|->
name|role
operator|=
literal|2
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Unknown role %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_dbus_handler_wps_type
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|DBusMessageIter
modifier|*
name|entry_iter
parameter_list|,
name|struct
name|wps_start_params
modifier|*
name|params
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|reply
parameter_list|)
block|{
name|DBusMessageIter
name|variant_iter
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
name|dbus_message_iter_recurse
argument_list|(
name|entry_iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|variant_iter
argument_list|)
operator|!=
name|DBUS_TYPE_STRING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Wrong Type type, string required"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Type must be a string"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|val
argument_list|)
expr_stmt|;
if|if
condition|(
name|os_strcmp
argument_list|(
name|val
argument_list|,
literal|"pin"
argument_list|)
operator|==
literal|0
condition|)
name|params
operator|->
name|type
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|val
argument_list|,
literal|"pbc"
argument_list|)
operator|==
literal|0
condition|)
name|params
operator|->
name|type
operator|=
literal|2
expr_stmt|;
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Unknown type %s"
argument_list|,
name|val
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|val
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_dbus_handler_wps_bssid
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|DBusMessageIter
modifier|*
name|entry_iter
parameter_list|,
name|struct
name|wps_start_params
modifier|*
name|params
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|reply
parameter_list|)
block|{
name|DBusMessageIter
name|variant_iter
decl_stmt|,
name|array_iter
decl_stmt|;
name|int
name|len
decl_stmt|;
name|dbus_message_iter_recurse
argument_list|(
name|entry_iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|variant_iter
argument_list|)
operator|!=
name|DBUS_TYPE_ARRAY
operator|||
name|dbus_message_iter_get_element_type
argument_list|(
operator|&
name|variant_iter
argument_list|)
operator|!=
name|DBUS_TYPE_BYTE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Wrong Bssid type, byte array required"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Bssid must be a byte array"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|array_iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_fixed_array
argument_list|(
operator|&
name|array_iter
argument_list|,
operator|&
name|params
operator|->
name|bssid
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Wrong Bssid length %d"
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Bssid is wrong length"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|wpas_dbus_handler_wps_pin
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|DBusMessageIter
modifier|*
name|entry_iter
parameter_list|,
name|struct
name|wps_start_params
modifier|*
name|params
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|reply
parameter_list|)
block|{
name|DBusMessageIter
name|variant_iter
decl_stmt|;
name|dbus_message_iter_recurse
argument_list|(
name|entry_iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|variant_iter
argument_list|)
operator|!=
name|DBUS_TYPE_STRING
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Wrong Pin type, string required"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Pin must be a string"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|params
operator|->
name|pin
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|CONFIG_P2P
end_ifdef

begin_function
specifier|static
name|int
name|wpas_dbus_handler_wps_p2p_dev_addr
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|DBusMessageIter
modifier|*
name|entry_iter
parameter_list|,
name|struct
name|wps_start_params
modifier|*
name|params
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|reply
parameter_list|)
block|{
name|DBusMessageIter
name|variant_iter
decl_stmt|,
name|array_iter
decl_stmt|;
name|int
name|len
decl_stmt|;
name|dbus_message_iter_recurse
argument_list|(
name|entry_iter
argument_list|,
operator|&
name|variant_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|variant_iter
argument_list|)
operator|!=
name|DBUS_TYPE_ARRAY
operator|||
name|dbus_message_iter_get_element_type
argument_list|(
operator|&
name|variant_iter
argument_list|)
operator|!=
name|DBUS_TYPE_BYTE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Wrong P2PDeviceAddress type, byte array required"
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"P2PDeviceAddress must be a byte array"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|variant_iter
argument_list|,
operator|&
name|array_iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_fixed_array
argument_list|(
operator|&
name|array_iter
argument_list|,
operator|&
name|params
operator|->
name|p2p_dev_addr
argument_list|,
operator|&
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|!=
name|ETH_ALEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Wrong P2PDeviceAddress length %d"
argument_list|,
name|len
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"P2PDeviceAddress has wrong length"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* CONFIG_P2P */
end_comment

begin_function
specifier|static
name|int
name|wpas_dbus_handler_wps_start_entry
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|char
modifier|*
name|key
parameter_list|,
name|DBusMessageIter
modifier|*
name|entry_iter
parameter_list|,
name|struct
name|wps_start_params
modifier|*
name|params
parameter_list|,
name|DBusMessage
modifier|*
modifier|*
name|reply
parameter_list|)
block|{
if|if
condition|(
name|os_strcmp
argument_list|(
name|key
argument_list|,
literal|"Role"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|wpas_dbus_handler_wps_role
argument_list|(
name|message
argument_list|,
name|entry_iter
argument_list|,
name|params
argument_list|,
name|reply
argument_list|)
return|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|key
argument_list|,
literal|"Type"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|wpas_dbus_handler_wps_type
argument_list|(
name|message
argument_list|,
name|entry_iter
argument_list|,
name|params
argument_list|,
name|reply
argument_list|)
return|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|key
argument_list|,
literal|"Bssid"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|wpas_dbus_handler_wps_bssid
argument_list|(
name|message
argument_list|,
name|entry_iter
argument_list|,
name|params
argument_list|,
name|reply
argument_list|)
return|;
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|key
argument_list|,
literal|"Pin"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|wpas_dbus_handler_wps_pin
argument_list|(
name|message
argument_list|,
name|entry_iter
argument_list|,
name|params
argument_list|,
name|reply
argument_list|)
return|;
ifdef|#
directive|ifdef
name|CONFIG_P2P
elseif|else
if|if
condition|(
name|os_strcmp
argument_list|(
name|key
argument_list|,
literal|"P2PDeviceAddress"
argument_list|)
operator|==
literal|0
condition|)
return|return
name|wpas_dbus_handler_wps_p2p_dev_addr
argument_list|(
name|message
argument_list|,
name|entry_iter
argument_list|,
name|params
argument_list|,
name|reply
argument_list|)
return|;
endif|#
directive|endif
comment|/* CONFIG_P2P */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - unknown key %s"
argument_list|,
name|key
argument_list|)
expr_stmt|;
operator|*
name|reply
operator|=
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
name|key
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_wps_start - Start WPS configuration  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: DBus message dictionary on success or DBus error on failure  *  * Handler for "Start" method call. DBus dictionary argument contains  * information about role (enrollee or registrar), authorization method  * (pin or push button) and optionally pin and bssid. Returned message  * has a dictionary argument which may contain newly generated pin (optional).  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_wps_start
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|DBusMessage
modifier|*
name|reply
init|=
name|NULL
decl_stmt|;
name|DBusMessageIter
name|iter
decl_stmt|,
name|dict_iter
decl_stmt|,
name|entry_iter
decl_stmt|;
name|struct
name|wps_start_params
name|params
decl_stmt|;
name|char
modifier|*
name|key
decl_stmt|;
name|char
name|npin
index|[
literal|9
index|]
init|=
block|{
literal|'\0'
block|}
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|os_memset
argument_list|(
operator|&
name|params
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|params
argument_list|)
argument_list|)
expr_stmt|;
name|dbus_message_iter_init
argument_list|(
name|message
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
expr_stmt|;
while|while
condition|(
name|dbus_message_iter_get_arg_type
argument_list|(
operator|&
name|dict_iter
argument_list|)
operator|==
name|DBUS_TYPE_DICT_ENTRY
condition|)
block|{
name|dbus_message_iter_recurse
argument_list|(
operator|&
name|dict_iter
argument_list|,
operator|&
name|entry_iter
argument_list|)
expr_stmt|;
name|dbus_message_iter_get_basic
argument_list|(
operator|&
name|entry_iter
argument_list|,
operator|&
name|key
argument_list|)
expr_stmt|;
name|dbus_message_iter_next
argument_list|(
operator|&
name|entry_iter
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpas_dbus_handler_wps_start_entry
argument_list|(
name|message
argument_list|,
name|key
argument_list|,
operator|&
name|entry_iter
argument_list|,
operator|&
name|params
argument_list|,
operator|&
name|reply
argument_list|)
condition|)
return|return
name|reply
return|;
name|dbus_message_iter_next
argument_list|(
operator|&
name|dict_iter
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|CONFIG_AP
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
operator|&&
name|params
operator|.
name|type
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|params
operator|.
name|pin
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Pin required for registrar role"
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Pin required for registrar role."
argument_list|)
return|;
block|}
name|ret
operator|=
name|wpa_supplicant_ap_wps_pin
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|.
name|bssid
argument_list|,
name|params
operator|.
name|pin
argument_list|,
name|npin
argument_list|,
sizeof|sizeof
argument_list|(
name|npin
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wpa_s
operator|->
name|ap_iface
condition|)
block|{
name|ret
operator|=
name|wpa_supplicant_ap_wps_pbc
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|.
name|bssid
argument_list|,
name|params
operator|.
name|p2p_dev_addr
argument_list|)
expr_stmt|;
block|}
elseif|else
endif|#
directive|endif
comment|/* CONFIG_AP */
if|if
condition|(
name|params
operator|.
name|role
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Role not specified"
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Role not specified"
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|params
operator|.
name|role
operator|==
literal|2
condition|)
block|{
if|if
condition|(
name|params
operator|.
name|pin
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Pin required for registrar role"
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Pin required for registrar role."
argument_list|)
return|;
block|}
name|ret
operator|=
name|wpas_wps_start_reg
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|.
name|bssid
argument_list|,
name|params
operator|.
name|pin
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|params
operator|.
name|type
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start - Type not specified"
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_error_invalid_args
argument_list|(
name|message
argument_list|,
literal|"Type not specified"
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|params
operator|.
name|type
operator|==
literal|1
condition|)
block|{
name|ret
operator|=
name|wpas_wps_start_pin
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|.
name|bssid
argument_list|,
name|params
operator|.
name|pin
argument_list|,
literal|0
argument_list|,
name|DEV_PW_DEFAULT
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
name|os_snprintf
argument_list|(
name|npin
argument_list|,
sizeof|sizeof
argument_list|(
name|npin
argument_list|)
argument_list|,
literal|"%08d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ret
operator|=
name|wpas_wps_start_pbc
argument_list|(
name|wpa_s
argument_list|,
name|params
operator|.
name|bssid
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"dbus: WPS.Start wpas_wps_failed in role %s and key %s"
argument_list|,
operator|(
name|params
operator|.
name|role
operator|==
literal|1
condition|?
literal|"enrollee"
else|:
literal|"registrar"
operator|)
argument_list|,
operator|(
name|params
operator|.
name|type
operator|==
literal|0
condition|?
literal|""
else|:
operator|(
name|params
operator|.
name|type
operator|==
literal|1
condition|?
literal|"pin"
else|:
literal|"pbc"
operator|)
operator|)
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"WPS start failed"
argument_list|)
return|;
block|}
name|reply
operator|=
name|dbus_message_new_method_return
argument_list|(
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|reply
condition|)
return|return
name|wpas_dbus_error_no_memory
argument_list|(
name|message
argument_list|)
return|;
name|dbus_message_iter_init_append
argument_list|(
name|reply
argument_list|,
operator|&
name|iter
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_dbus_dict_open_write
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
operator|||
operator|(
name|os_strlen
argument_list|(
name|npin
argument_list|)
operator|>
literal|0
operator|&&
operator|!
name|wpa_dbus_dict_append_string
argument_list|(
operator|&
name|dict_iter
argument_list|,
literal|"Pin"
argument_list|,
name|npin
argument_list|)
operator|)
operator|||
operator|!
name|wpa_dbus_dict_close_write
argument_list|(
operator|&
name|iter
argument_list|,
operator|&
name|dict_iter
argument_list|)
condition|)
block|{
name|dbus_message_unref
argument_list|(
name|reply
argument_list|)
expr_stmt|;
return|return
name|wpas_dbus_error_no_memory
argument_list|(
name|message
argument_list|)
return|;
block|}
return|return
name|reply
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_handler_wps_cancel - Cancel ongoing WPS configuration  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: NULL on success or DBus error on failure  *  * Handler for "Cancel" method call. Returns NULL if WPS cancel successfull  * or DBus error on WPS cancel failure  */
end_comment

begin_function
name|DBusMessage
modifier|*
name|wpas_dbus_handler_wps_cancel
parameter_list|(
name|DBusMessage
modifier|*
name|message
parameter_list|,
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
name|wpas_wps_cancel
argument_list|(
name|wpa_s
argument_list|)
condition|)
return|return
name|wpas_dbus_error_unknown_error
argument_list|(
name|message
argument_list|,
literal|"WPS cancel failed"
argument_list|)
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_process_credentials - Check if credentials are processed  * @message: Pointer to incoming dbus message  * @wpa_s: %wpa_supplicant data structure  * Returns: TRUE on success, FALSE on failure  *  * Getter for "ProcessCredentials" property. Returns returned boolean will be  * true if wps_cred_processing configuration field is not equal to 1 or false  * if otherwise.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_process_credentials
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_bool_t
name|process
init|=
name|wpa_s
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|!=
literal|1
decl_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|process
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_process_credentials - Set credentials_processed conf param  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter for "ProcessCredentials" property. Sets credentials_processed on 2  * if boolean argument is true or on 1 if otherwise.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_process_credentials
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|dbus_bool_t
name|process_credentials
decl_stmt|,
name|old_pc
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|dbus_new_path
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_BOOLEAN
argument_list|,
operator|&
name|process_credentials
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|old_pc
operator|=
name|wpa_s
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|!=
literal|1
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|=
operator|(
name|process_credentials
condition|?
literal|2
else|:
literal|1
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|wpa_s
operator|->
name|conf
operator|->
name|wps_cred_processing
operator|!=
literal|1
operator|)
operator|!=
name|old_pc
condition|)
name|wpa_dbus_mark_property_changed
argument_list|(
name|wpa_s
operator|->
name|global
operator|->
name|dbus
argument_list|,
name|wpa_s
operator|->
name|dbus_new_path
argument_list|,
name|WPAS_DBUS_NEW_IFACE_WPS
argument_list|,
literal|"ProcessCredentials"
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_getter_config_methods - Get current WPS configuration methods  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Getter for "ConfigMethods" property. Returned boolean will be true if  * providing the relevant string worked, or false otherwise.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_getter_config_methods
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|char
modifier|*
name|methods
init|=
name|wpa_s
operator|->
name|conf
operator|->
name|config_methods
decl_stmt|;
if|if
condition|(
name|methods
operator|==
name|NULL
condition|)
name|methods
operator|=
literal|""
expr_stmt|;
return|return
name|wpas_dbus_simple_property_getter
argument_list|(
name|iter
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|methods
argument_list|,
name|error
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/**  * wpas_dbus_setter_config_methods - Set WPS configuration methods  * @iter: Pointer to incoming dbus message iter  * @error: Location to store error on failure  * @user_data: Function specific data  * Returns: TRUE on success, FALSE on failure  *  * Setter for "ConfigMethods" property. Sets the methods string, apply such  * change and returns true on success. Returns false otherwise.  */
end_comment

begin_function
name|dbus_bool_t
name|wpas_dbus_setter_config_methods
parameter_list|(
name|DBusMessageIter
modifier|*
name|iter
parameter_list|,
name|DBusError
modifier|*
name|error
parameter_list|,
name|void
modifier|*
name|user_data
parameter_list|)
block|{
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
init|=
name|user_data
decl_stmt|;
name|char
modifier|*
name|methods
decl_stmt|,
modifier|*
name|new_methods
decl_stmt|;
if|if
condition|(
operator|!
name|wpas_dbus_simple_property_setter
argument_list|(
name|iter
argument_list|,
name|error
argument_list|,
name|DBUS_TYPE_STRING
argument_list|,
operator|&
name|methods
argument_list|)
condition|)
return|return
name|FALSE
return|;
name|new_methods
operator|=
name|os_strdup
argument_list|(
name|methods
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|new_methods
condition|)
return|return
name|FALSE
return|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|conf
operator|->
name|config_methods
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|config_methods
operator|=
name|new_methods
expr_stmt|;
name|wpa_s
operator|->
name|conf
operator|->
name|changed_parameters
operator||=
name|CFG_CHANGED_CONFIG_METHODS
expr_stmt|;
name|wpa_supplicant_update_config
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant - WNM  * Copyright (c) 2011-2012, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_define
define|#
directive|define
name|MAX_TFS_IE_LEN
value|1024
end_define

begin_comment
comment|/* get the TFS IE from driver */
end_comment

begin_function
specifier|static
name|int
name|ieee80211_11_get_tfs_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|u16
modifier|*
name|buf_len
parameter_list|,
name|enum
name|wnm_oper
name|oper
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: TFS get operation %d"
argument_list|,
name|__func__
argument_list|,
name|oper
argument_list|)
expr_stmt|;
return|return
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|oper
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* set the TFS IE to driver */
end_comment

begin_function
specifier|static
name|int
name|ieee80211_11_set_tfs_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|u16
modifier|*
name|buf_len
parameter_list|,
name|enum
name|wnm_oper
name|oper
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: TFS set operation %d"
argument_list|,
name|__func__
argument_list|,
name|oper
argument_list|)
expr_stmt|;
return|return
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|oper
argument_list|,
name|addr
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* MLME-SLEEPMODE.request */
end_comment

begin_function
name|int
name|ieee802_11_send_wnmsleep_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|action
parameter_list|,
name|u16
name|intval
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|tfs_req
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|wnm_sleep_element
modifier|*
name|wnmsleep_ie
decl_stmt|;
name|u8
modifier|*
name|wnmtfs_ie
decl_stmt|;
name|u8
name|wnmsleep_ie_len
decl_stmt|;
name|u16
name|wnmtfs_ie_len
decl_stmt|;
comment|/* possibly multiple IE(s) */
name|enum
name|wnm_oper
name|tfs_oper
init|=
name|action
operator|==
literal|0
condition|?
name|WNM_SLEEP_TFS_REQ_IE_ADD
else|:
name|WNM_SLEEP_TFS_REQ_IE_NONE
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Request to send WNM-Sleep Mode Request "
literal|"action=%s to "
name|MACSTR
argument_list|,
name|action
operator|==
literal|0
condition|?
literal|"enter"
else|:
literal|"exit"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* WNM-Sleep Mode IE */
name|wnmsleep_ie_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|wnm_sleep_element
argument_list|)
expr_stmt|;
name|wnmsleep_ie
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|wnm_sleep_element
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmsleep_ie
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wnmsleep_ie
operator|->
name|eid
operator|=
name|WLAN_EID_WNMSLEEP
expr_stmt|;
name|wnmsleep_ie
operator|->
name|len
operator|=
name|wnmsleep_ie_len
operator|-
literal|2
expr_stmt|;
name|wnmsleep_ie
operator|->
name|action_type
operator|=
name|action
expr_stmt|;
name|wnmsleep_ie
operator|->
name|status
operator|=
name|WNM_STATUS_SLEEP_ACCEPT
expr_stmt|;
name|wnmsleep_ie
operator|->
name|intval
operator|=
name|host_to_le16
argument_list|(
name|intval
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: WNM-Sleep Mode element"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wnmsleep_ie
argument_list|,
name|wnmsleep_ie_len
argument_list|)
expr_stmt|;
comment|/* TFS IE(s) */
if|if
condition|(
name|tfs_req
condition|)
block|{
name|wnmtfs_ie_len
operator|=
name|wpabuf_len
argument_list|(
name|tfs_req
argument_list|)
expr_stmt|;
name|wnmtfs_ie
operator|=
name|os_malloc
argument_list|(
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmtfs_ie
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|wnmsleep_ie
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wnmtfs_ie
argument_list|,
name|wpabuf_head
argument_list|(
name|tfs_req
argument_list|)
argument_list|,
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wnmtfs_ie
operator|=
name|os_zalloc
argument_list|(
name|MAX_TFS_IE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmtfs_ie
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|wnmsleep_ie
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ieee80211_11_get_tfs_ie
argument_list|(
name|wpa_s
argument_list|,
name|wnmtfs_ie
argument_list|,
operator|&
name|wnmtfs_ie_len
argument_list|,
name|tfs_oper
argument_list|)
condition|)
block|{
name|wnmtfs_ie_len
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|wnmtfs_ie
argument_list|)
expr_stmt|;
name|wnmtfs_ie
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: TFS Request element"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wnmtfs_ie
argument_list|,
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
name|mgmt
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mgmt
argument_list|)
operator|+
name|wnmsleep_ie_len
operator|+
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgmt
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Failed to allocate buffer for "
literal|"WNM-Sleep Request action frame"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wnmsleep_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wnmtfs_ie
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ACTION
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|=
name|WLAN_ACTION_WNM
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_req
operator|.
name|action
operator|=
name|WNM_SLEEP_MODE_REQ
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_req
operator|.
name|dialogtoken
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_req
operator|.
name|variable
argument_list|,
name|wnmsleep_ie
argument_list|,
name|wnmsleep_ie_len
argument_list|)
expr_stmt|;
comment|/* copy TFS IE here */
if|if
condition|(
name|wnmtfs_ie_len
operator|>
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_req
operator|.
name|variable
operator|+
name|wnmsleep_ie_len
argument_list|,
name|wnmtfs_ie
argument_list|,
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_req
argument_list|)
operator|+
name|wnmsleep_ie_len
operator|+
name|wnmtfs_ie_len
expr_stmt|;
name|res
operator|=
name|wpa_drv_send_action
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to send WNM-Sleep Request "
literal|"(action=%d, intval=%d)"
argument_list|,
name|action
argument_list|,
name|intval
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wnmsleep_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wnmtfs_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|mgmt
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_sleep_mode_enter_success
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|tfsresp_ie_start
parameter_list|,
name|u8
modifier|*
name|tfsresp_ie_end
parameter_list|)
block|{
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|WNM_SLEEP_ENTER_CONFIRM
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* remove GTK/IGTK ?? */
comment|/* set the TFS Resp IE(s) */
if|if
condition|(
name|tfsresp_ie_start
operator|&&
name|tfsresp_ie_end
operator|&&
name|tfsresp_ie_end
operator|-
name|tfsresp_ie_start
operator|>=
literal|0
condition|)
block|{
name|u16
name|tfsresp_ie_len
decl_stmt|;
name|tfsresp_ie_len
operator|=
operator|(
name|tfsresp_ie_end
operator|+
name|tfsresp_ie_end
index|[
literal|1
index|]
operator|+
literal|2
operator|)
operator|-
name|tfsresp_ie_start
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TFS Resp IE(s) found"
argument_list|)
expr_stmt|;
comment|/* pass the TFS Resp IE(s) to driver for processing */
if|if
condition|(
name|ieee80211_11_set_tfs_ie
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|tfsresp_ie_start
argument_list|,
operator|&
name|tfsresp_ie_len
argument_list|,
name|WNM_SLEEP_TFS_RESP_IE_SET
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Fail to set TFS Resp IE"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_sleep_mode_exit_success
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|frm
parameter_list|,
name|u16
name|key_len_total
parameter_list|)
block|{
name|u8
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|gtk_len
decl_stmt|;
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|WNM_SLEEP_EXIT_CONFIRM
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Install GTK/IGTK */
comment|/* point to key data field */
name|ptr
operator|=
operator|(
name|u8
operator|*
operator|)
name|frm
operator|+
literal|1
operator|+
literal|1
operator|+
literal|2
expr_stmt|;
name|end
operator|=
name|ptr
operator|+
name|key_len_total
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Key Data"
argument_list|,
name|ptr
argument_list|,
name|key_len_total
argument_list|)
expr_stmt|;
while|while
condition|(
name|ptr
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|ptr
operator|+
literal|2
operator|+
name|ptr
index|[
literal|1
index|]
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Invalid Key Data element "
literal|"length"
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|>
name|ptr
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Remaining data"
argument_list|,
name|ptr
argument_list|,
name|end
operator|-
name|ptr
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
operator|*
name|ptr
operator|==
name|WNM_SLEEP_SUBELEM_GTK
condition|)
block|{
if|if
condition|(
name|ptr
index|[
literal|1
index|]
operator|<
literal|11
operator|+
literal|5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short GTK "
literal|"subelem"
argument_list|)
expr_stmt|;
break|break;
block|}
name|gtk_len
operator|=
operator|*
operator|(
name|ptr
operator|+
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|ptr
index|[
literal|1
index|]
operator|<
literal|11
operator|+
name|gtk_len
operator|||
name|gtk_len
operator|<
literal|5
operator|||
name|gtk_len
operator|>
literal|32
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Invalid GTK "
literal|"subelem"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_wnmsleep_install_key
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WNM_SLEEP_SUBELEM_GTK
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|13
operator|+
name|gtk_len
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
block|}
elseif|else
if|if
condition|(
operator|*
name|ptr
operator|==
name|WNM_SLEEP_SUBELEM_IGTK
condition|)
block|{
if|if
condition|(
name|ptr
index|[
literal|1
index|]
operator|<
literal|2
operator|+
literal|6
operator|+
name|WPA_IGTK_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short IGTK "
literal|"subelem"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_wnmsleep_install_key
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WNM_SLEEP_SUBELEM_IGTK
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|10
operator|+
name|WPA_IGTK_LEN
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
block|}
else|else
break|break;
comment|/* skip the loop */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee802_11_rx_wnmsleep_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|frm
parameter_list|,
name|int
name|len
parameter_list|)
block|{
comment|/* 	 * Action [1] | Diaglog Token [1] | Key Data Len [2] | Key Data | 	 * WNM-Sleep Mode IE | TFS Response IE 	 */
name|u8
modifier|*
name|pos
init|=
operator|(
name|u8
operator|*
operator|)
name|frm
decl_stmt|;
comment|/* point to action field */
name|u16
name|key_len_total
init|=
name|le_to_host16
argument_list|(
operator|*
operator|(
operator|(
name|u16
operator|*
operator|)
operator|(
name|frm
operator|+
literal|2
operator|)
operator|)
argument_list|)
decl_stmt|;
name|struct
name|wnm_sleep_element
modifier|*
name|wnmsleep_ie
init|=
name|NULL
decl_stmt|;
comment|/* multiple TFS Resp IE (assuming consecutive) */
name|u8
modifier|*
name|tfsresp_ie_start
init|=
name|NULL
decl_stmt|;
name|u8
modifier|*
name|tfsresp_ie_end
init|=
name|NULL
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"action=%d token = %d key_len_total = %d"
argument_list|,
name|frm
index|[
literal|0
index|]
argument_list|,
name|frm
index|[
literal|1
index|]
argument_list|,
name|key_len_total
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|4
operator|+
name|key_len_total
expr_stmt|;
if|if
condition|(
name|pos
operator|>
name|frm
operator|+
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WNM: Too short frame for Key Data field"
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|pos
operator|-
name|frm
operator|<
name|len
condition|)
block|{
name|u8
name|ie_len
init|=
operator|*
operator|(
name|pos
operator|+
literal|1
operator|)
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|ie_len
operator|>
name|frm
operator|+
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WNM: Invalid IE len %u"
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Element"
argument_list|,
name|pos
argument_list|,
literal|2
operator|+
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
name|WLAN_EID_WNMSLEEP
condition|)
name|wnmsleep_ie
operator|=
operator|(
expr|struct
name|wnm_sleep_element
operator|*
operator|)
name|pos
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|pos
operator|==
name|WLAN_EID_TFS_RESP
condition|)
block|{
if|if
condition|(
operator|!
name|tfsresp_ie_start
condition|)
name|tfsresp_ie_start
operator|=
name|pos
expr_stmt|;
name|tfsresp_ie_end
operator|=
name|pos
expr_stmt|;
block|}
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EID %d not recognized"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ie_len
operator|+
literal|2
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wnmsleep_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No WNM-Sleep IE found"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|wnmsleep_ie
operator|->
name|status
operator|==
name|WNM_STATUS_SLEEP_ACCEPT
operator|||
name|wnmsleep_ie
operator|->
name|status
operator|==
name|WNM_STATUS_SLEEP_EXIT_ACCEPT_GTK_UPDATE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Successfully recv WNM-Sleep Response "
literal|"frame (action=%d, intval=%d)"
argument_list|,
name|wnmsleep_ie
operator|->
name|action_type
argument_list|,
name|wnmsleep_ie
operator|->
name|intval
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmsleep_ie
operator|->
name|action_type
operator|==
name|WNM_SLEEP_MODE_ENTER
condition|)
block|{
name|wnm_sleep_mode_enter_success
argument_list|(
name|wpa_s
argument_list|,
name|tfsresp_ie_start
argument_list|,
name|tfsresp_ie_end
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wnmsleep_ie
operator|->
name|action_type
operator|==
name|WNM_SLEEP_MODE_EXIT
condition|)
block|{
name|wnm_sleep_mode_exit_success
argument_list|(
name|wpa_s
argument_list|,
name|frm
argument_list|,
name|key_len_total
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Reject recv WNM-Sleep Response frame "
literal|"(action=%d, intval=%d)"
argument_list|,
name|wnmsleep_ie
operator|->
name|action_type
argument_list|,
name|wnmsleep_ie
operator|->
name|intval
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmsleep_ie
operator|->
name|action_type
operator|==
name|WNM_SLEEP_MODE_ENTER
condition|)
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|WNM_SLEEP_ENTER_FAIL
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wnmsleep_ie
operator|->
name|action_type
operator|==
name|WNM_SLEEP_MODE_EXIT
condition|)
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|WNM_SLEEP_EXIT_FAIL
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_send_bss_transition_mgmt_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|u8
name|status
parameter_list|,
name|u8
name|delay
parameter_list|,
specifier|const
name|u8
modifier|*
name|target_bssid
parameter_list|)
block|{
name|u8
name|buf
index|[
literal|1000
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Send BSS Transition Management Response "
literal|"to "
name|MACSTR
literal|" dialog_token=%u status=%u delay=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|,
name|dialog_token
argument_list|,
name|status
argument_list|,
name|delay
argument_list|)
expr_stmt|;
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ACTION
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|=
name|WLAN_ACTION_WNM
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_resp
operator|.
name|action
operator|=
name|WNM_BSS_TRANS_MGMT_RESP
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_resp
operator|.
name|dialog_token
operator|=
name|dialog_token
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_resp
operator|.
name|status_code
operator|=
name|status
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_resp
operator|.
name|bss_termination_delay
operator|=
name|delay
expr_stmt|;
name|pos
operator|=
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_resp
operator|.
name|variable
expr_stmt|;
if|if
condition|(
name|target_bssid
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|target_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
block|}
name|len
operator|=
name|pos
operator|-
operator|(
name|u8
operator|*
operator|)
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
expr_stmt|;
name|wpa_drv_send_action
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee802_11_rx_bss_trans_mgmt_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|,
name|int
name|reply
parameter_list|)
block|{
name|u8
name|dialog_token
decl_stmt|;
name|u8
name|mode
decl_stmt|;
name|u16
name|disassoc_timer
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|5
operator|>
name|end
condition|)
return|return;
name|dialog_token
operator|=
name|pos
index|[
literal|0
index|]
expr_stmt|;
name|mode
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
name|disassoc_timer
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: BSS Transition Management Request: "
literal|"dialog_token=%u request_mode=0x%x "
literal|"disassoc_timer=%u validity_interval=%u"
argument_list|,
name|dialog_token
argument_list|,
name|mode
argument_list|,
name|disassoc_timer
argument_list|,
name|pos
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|5
expr_stmt|;
if|if
condition|(
name|mode
operator|&
literal|0x08
condition|)
name|pos
operator|+=
literal|12
expr_stmt|;
comment|/* BSS Termination Duration */
if|if
condition|(
name|mode
operator|&
literal|0x10
condition|)
block|{
name|char
name|url
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>
name|end
operator|||
name|pos
operator|+
literal|1
operator|+
name|pos
index|[
literal|0
index|]
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Invalid BSS Transition "
literal|"Management Request (URL)"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|url
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|url
index|[
name|pos
index|[
literal|0
index|]
index|]
operator|=
literal|'\0'
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WNM: ESS Disassociation Imminent - "
literal|"session_info_url=%s"
argument_list|,
name|url
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mode
operator|&
literal|0x04
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WNM: Disassociation Imminent - "
literal|"Disassociation Timer %u"
argument_list|,
name|disassoc_timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|disassoc_timer
operator|&&
operator|!
name|wpa_s
operator|->
name|scanning
condition|)
block|{
comment|/* TODO: mark current BSS less preferred for 			 * selection */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Trying to find another BSS"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|reply
condition|)
block|{
comment|/* TODO: add support for reporting Accept */
name|wnm_send_bss_transition_mgmt_resp
argument_list|(
name|wpa_s
argument_list|,
name|dialog_token
argument_list|,
literal|1
comment|/* Reject - unspecified */
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ieee802_11_rx_wnm_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|struct
name|rx_action
modifier|*
name|action
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|act
decl_stmt|;
if|if
condition|(
name|action
operator|->
name|data
operator|==
name|NULL
operator|||
name|action
operator|->
name|len
operator|==
literal|0
condition|)
return|return;
name|pos
operator|=
name|action
operator|->
name|data
expr_stmt|;
name|end
operator|=
name|pos
operator|+
name|action
operator|->
name|len
expr_stmt|;
name|act
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: RX action %u from "
name|MACSTR
argument_list|,
name|act
argument_list|,
name|MAC2STR
argument_list|(
name|action
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
operator|||
name|os_memcmp
argument_list|(
name|action
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Ignore unexpected WNM Action "
literal|"frame"
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|act
condition|)
block|{
case|case
name|WNM_BSS_TRANS_MGMT_REQ
case|:
name|ieee802_11_rx_bss_trans_mgmt_req
argument_list|(
name|wpa_s
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
operator|!
operator|(
name|action
operator|->
name|da
index|[
literal|0
index|]
operator|&
literal|0x01
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|WNM_SLEEP_MODE_RESP
case|:
name|ieee802_11_rx_wnmsleep_resp
argument_list|(
name|wpa_s
argument_list|,
name|action
operator|->
name|data
argument_list|,
name|action
operator|->
name|len
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
end_function

end_unit


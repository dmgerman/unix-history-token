begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wpa_supplicant - WNM  * Copyright (c) 2011-2013, Qualcomm Atheros, Inc.  *  * This software may be distributed under the terms of the BSD license.  * See README for more details.  */
end_comment

begin_include
include|#
directive|include
file|"utils/includes.h"
end_include

begin_include
include|#
directive|include
file|"utils/common.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_defs.h"
end_include

begin_include
include|#
directive|include
file|"common/ieee802_11_common.h"
end_include

begin_include
include|#
directive|include
file|"common/wpa_ctrl.h"
end_include

begin_include
include|#
directive|include
file|"rsn_supp/wpa.h"
end_include

begin_include
include|#
directive|include
file|"wpa_supplicant_i.h"
end_include

begin_include
include|#
directive|include
file|"driver_i.h"
end_include

begin_include
include|#
directive|include
file|"scan.h"
end_include

begin_include
include|#
directive|include
file|"ctrl_iface.h"
end_include

begin_include
include|#
directive|include
file|"bss.h"
end_include

begin_include
include|#
directive|include
file|"wnm_sta.h"
end_include

begin_include
include|#
directive|include
file|"hs20_supplicant.h"
end_include

begin_define
define|#
directive|define
name|MAX_TFS_IE_LEN
value|1024
end_define

begin_define
define|#
directive|define
name|WNM_MAX_NEIGHBOR_REPORT
value|10
end_define

begin_comment
comment|/* get the TFS IE from driver */
end_comment

begin_function
specifier|static
name|int
name|ieee80211_11_get_tfs_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|u16
modifier|*
name|buf_len
parameter_list|,
name|enum
name|wnm_oper
name|oper
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: TFS get operation %d"
argument_list|,
name|__func__
argument_list|,
name|oper
argument_list|)
expr_stmt|;
return|return
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|oper
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* set the TFS IE to driver */
end_comment

begin_function
specifier|static
name|int
name|ieee80211_11_set_tfs_ie
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|addr
parameter_list|,
name|u8
modifier|*
name|buf
parameter_list|,
name|u16
modifier|*
name|buf_len
parameter_list|,
name|enum
name|wnm_oper
name|oper
parameter_list|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%s: TFS set operation %d"
argument_list|,
name|__func__
argument_list|,
name|oper
argument_list|)
expr_stmt|;
return|return
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|oper
argument_list|,
name|addr
argument_list|,
name|buf
argument_list|,
name|buf_len
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* MLME-SLEEPMODE.request */
end_comment

begin_function
name|int
name|ieee802_11_send_wnmsleep_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|action
parameter_list|,
name|u16
name|intval
parameter_list|,
name|struct
name|wpabuf
modifier|*
name|tfs_req
parameter_list|)
block|{
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|int
name|res
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|struct
name|wnm_sleep_element
modifier|*
name|wnmsleep_ie
decl_stmt|;
name|u8
modifier|*
name|wnmtfs_ie
decl_stmt|;
name|u8
name|wnmsleep_ie_len
decl_stmt|;
name|u16
name|wnmtfs_ie_len
decl_stmt|;
comment|/* possibly multiple IE(s) */
name|enum
name|wnm_oper
name|tfs_oper
init|=
name|action
operator|==
literal|0
condition|?
name|WNM_SLEEP_TFS_REQ_IE_ADD
else|:
name|WNM_SLEEP_TFS_REQ_IE_NONE
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Request to send WNM-Sleep Mode Request "
literal|"action=%s to "
name|MACSTR
argument_list|,
name|action
operator|==
literal|0
condition|?
literal|"enter"
else|:
literal|"exit"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
comment|/* WNM-Sleep Mode IE */
name|wnmsleep_ie_len
operator|=
sizeof|sizeof
argument_list|(
expr|struct
name|wnm_sleep_element
argument_list|)
expr_stmt|;
name|wnmsleep_ie
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|wnm_sleep_element
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmsleep_ie
operator|==
name|NULL
condition|)
return|return
operator|-
literal|1
return|;
name|wnmsleep_ie
operator|->
name|eid
operator|=
name|WLAN_EID_WNMSLEEP
expr_stmt|;
name|wnmsleep_ie
operator|->
name|len
operator|=
name|wnmsleep_ie_len
operator|-
literal|2
expr_stmt|;
name|wnmsleep_ie
operator|->
name|action_type
operator|=
name|action
expr_stmt|;
name|wnmsleep_ie
operator|->
name|status
operator|=
name|WNM_STATUS_SLEEP_ACCEPT
expr_stmt|;
name|wnmsleep_ie
operator|->
name|intval
operator|=
name|host_to_le16
argument_list|(
name|intval
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: WNM-Sleep Mode element"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wnmsleep_ie
argument_list|,
name|wnmsleep_ie_len
argument_list|)
expr_stmt|;
comment|/* TFS IE(s) */
if|if
condition|(
name|tfs_req
condition|)
block|{
name|wnmtfs_ie_len
operator|=
name|wpabuf_len
argument_list|(
name|tfs_req
argument_list|)
expr_stmt|;
name|wnmtfs_ie
operator|=
name|os_malloc
argument_list|(
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmtfs_ie
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|wnmsleep_ie
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|wnmtfs_ie
argument_list|,
name|wpabuf_head
argument_list|(
name|tfs_req
argument_list|)
argument_list|,
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wnmtfs_ie
operator|=
name|os_zalloc
argument_list|(
name|MAX_TFS_IE_LEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmtfs_ie
operator|==
name|NULL
condition|)
block|{
name|os_free
argument_list|(
name|wnmsleep_ie
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
if|if
condition|(
name|ieee80211_11_get_tfs_ie
argument_list|(
name|wpa_s
argument_list|,
name|wnmtfs_ie
argument_list|,
operator|&
name|wnmtfs_ie_len
argument_list|,
name|tfs_oper
argument_list|)
condition|)
block|{
name|wnmtfs_ie_len
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|wnmtfs_ie
argument_list|)
expr_stmt|;
name|wnmtfs_ie
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: TFS Request element"
argument_list|,
operator|(
name|u8
operator|*
operator|)
name|wnmtfs_ie
argument_list|,
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
name|mgmt
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|mgmt
argument_list|)
operator|+
name|wnmsleep_ie_len
operator|+
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|mgmt
operator|==
name|NULL
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"MLME: Failed to allocate buffer for "
literal|"WNM-Sleep Request action frame"
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wnmsleep_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wnmtfs_ie
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ACTION
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|=
name|WLAN_ACTION_WNM
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_req
operator|.
name|action
operator|=
name|WNM_SLEEP_MODE_REQ
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_req
operator|.
name|dialogtoken
operator|=
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_req
operator|.
name|variable
argument_list|,
name|wnmsleep_ie
argument_list|,
name|wnmsleep_ie_len
argument_list|)
expr_stmt|;
comment|/* copy TFS IE here */
if|if
condition|(
name|wnmtfs_ie_len
operator|>
literal|0
condition|)
block|{
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_req
operator|.
name|variable
operator|+
name|wnmsleep_ie_len
argument_list|,
name|wnmtfs_ie
argument_list|,
name|wnmtfs_ie_len
argument_list|)
expr_stmt|;
block|}
name|len
operator|=
literal|1
operator|+
sizeof|sizeof
argument_list|(
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|wnm_sleep_req
argument_list|)
operator|+
name|wnmsleep_ie_len
operator|+
name|wnmtfs_ie_len
expr_stmt|;
name|res
operator|=
name|wpa_drv_send_action
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Failed to send WNM-Sleep Request "
literal|"(action=%d, intval=%d)"
argument_list|,
name|action
argument_list|,
name|intval
argument_list|)
expr_stmt|;
else|else
name|wpa_s
operator|->
name|wnmsleep_used
operator|=
literal|1
expr_stmt|;
name|os_free
argument_list|(
name|wnmsleep_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wnmtfs_ie
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|mgmt
argument_list|)
expr_stmt|;
return|return
name|res
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_sleep_mode_enter_success
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
modifier|*
name|tfsresp_ie_start
parameter_list|,
name|u8
modifier|*
name|tfsresp_ie_end
parameter_list|)
block|{
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|WNM_SLEEP_ENTER_CONFIRM
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* remove GTK/IGTK ?? */
comment|/* set the TFS Resp IE(s) */
if|if
condition|(
name|tfsresp_ie_start
operator|&&
name|tfsresp_ie_end
operator|&&
name|tfsresp_ie_end
operator|-
name|tfsresp_ie_start
operator|>=
literal|0
condition|)
block|{
name|u16
name|tfsresp_ie_len
decl_stmt|;
name|tfsresp_ie_len
operator|=
operator|(
name|tfsresp_ie_end
operator|+
name|tfsresp_ie_end
index|[
literal|1
index|]
operator|+
literal|2
operator|)
operator|-
name|tfsresp_ie_start
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"TFS Resp IE(s) found"
argument_list|)
expr_stmt|;
comment|/* pass the TFS Resp IE(s) to driver for processing */
if|if
condition|(
name|ieee80211_11_set_tfs_ie
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|tfsresp_ie_start
argument_list|,
operator|&
name|tfsresp_ie_len
argument_list|,
name|WNM_SLEEP_TFS_RESP_IE_SET
argument_list|)
condition|)
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Fail to set TFS Resp IE"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_sleep_mode_exit_success
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|frm
parameter_list|,
name|u16
name|key_len_total
parameter_list|)
block|{
name|u8
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|gtk_len
decl_stmt|;
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|WNM_SLEEP_EXIT_CONFIRM
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
comment|/* Install GTK/IGTK */
comment|/* point to key data field */
name|ptr
operator|=
operator|(
name|u8
operator|*
operator|)
name|frm
operator|+
literal|1
operator|+
literal|2
expr_stmt|;
name|end
operator|=
name|ptr
operator|+
name|key_len_total
expr_stmt|;
name|wpa_hexdump_key
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Key Data"
argument_list|,
name|ptr
argument_list|,
name|key_len_total
argument_list|)
expr_stmt|;
if|if
condition|(
name|key_len_total
operator|&&
operator|!
name|wpa_sm_pmf_enabled
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WNM: Ignore Key Data in WNM-Sleep Mode Response - PMF not enabled"
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|ptr
operator|+
literal|1
operator|<
name|end
condition|)
block|{
if|if
condition|(
name|ptr
operator|+
literal|2
operator|+
name|ptr
index|[
literal|1
index|]
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Invalid Key Data element "
literal|"length"
argument_list|)
expr_stmt|;
if|if
condition|(
name|end
operator|>
name|ptr
condition|)
block|{
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Remaining data"
argument_list|,
name|ptr
argument_list|,
name|end
operator|-
name|ptr
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
operator|*
name|ptr
operator|==
name|WNM_SLEEP_SUBELEM_GTK
condition|)
block|{
if|if
condition|(
name|ptr
index|[
literal|1
index|]
operator|<
literal|11
operator|+
literal|5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short GTK "
literal|"subelem"
argument_list|)
expr_stmt|;
break|break;
block|}
name|gtk_len
operator|=
operator|*
operator|(
name|ptr
operator|+
literal|4
operator|)
expr_stmt|;
if|if
condition|(
name|ptr
index|[
literal|1
index|]
operator|<
literal|11
operator|+
name|gtk_len
operator|||
name|gtk_len
operator|<
literal|5
operator|||
name|gtk_len
operator|>
literal|32
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Invalid GTK "
literal|"subelem"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_wnmsleep_install_key
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WNM_SLEEP_SUBELEM_GTK
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|13
operator|+
name|gtk_len
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_IEEE80211W
block|}
elseif|else
if|if
condition|(
operator|*
name|ptr
operator|==
name|WNM_SLEEP_SUBELEM_IGTK
condition|)
block|{
if|if
condition|(
name|ptr
index|[
literal|1
index|]
operator|<
literal|2
operator|+
literal|6
operator|+
name|WPA_IGTK_LEN
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short IGTK "
literal|"subelem"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_wnmsleep_install_key
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|,
name|WNM_SLEEP_SUBELEM_IGTK
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|10
operator|+
name|WPA_IGTK_LEN
expr_stmt|;
endif|#
directive|endif
comment|/* CONFIG_IEEE80211W */
block|}
else|else
break|break;
comment|/* skip the loop */
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee802_11_rx_wnmsleep_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|frm
parameter_list|,
name|int
name|len
parameter_list|)
block|{
comment|/* 	 * Action [1] | Dialog Token [1] | Key Data Len [2] | Key Data | 	 * WNM-Sleep Mode IE | TFS Response IE 	 */
name|u8
modifier|*
name|pos
init|=
operator|(
name|u8
operator|*
operator|)
name|frm
decl_stmt|;
comment|/* point to payload after the action field */
name|u16
name|key_len_total
decl_stmt|;
name|struct
name|wnm_sleep_element
modifier|*
name|wnmsleep_ie
init|=
name|NULL
decl_stmt|;
comment|/* multiple TFS Resp IE (assuming consecutive) */
name|u8
modifier|*
name|tfsresp_ie_start
init|=
name|NULL
decl_stmt|;
name|u8
modifier|*
name|tfsresp_ie_end
init|=
name|NULL
decl_stmt|;
name|size_t
name|left
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wnmsleep_used
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Ignore WNM-Sleep Mode Response frame since WNM-Sleep Mode operation has not been requested"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|<
literal|3
condition|)
return|return;
name|key_len_total
operator|=
name|WPA_GET_LE16
argument_list|(
name|frm
operator|+
literal|1
argument_list|)
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM-Sleep Mode Response token=%u key_len_total=%d"
argument_list|,
name|frm
index|[
literal|0
index|]
argument_list|,
name|key_len_total
argument_list|)
expr_stmt|;
name|left
operator|=
name|len
operator|-
literal|3
expr_stmt|;
if|if
condition|(
name|key_len_total
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WNM: Too short frame for Key Data field"
argument_list|)
expr_stmt|;
return|return;
block|}
name|pos
operator|+=
literal|3
operator|+
name|key_len_total
expr_stmt|;
while|while
condition|(
name|pos
operator|-
name|frm
operator|<
name|len
condition|)
block|{
name|u8
name|ie_len
init|=
operator|*
operator|(
name|pos
operator|+
literal|1
operator|)
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|2
operator|+
name|ie_len
operator|>
name|frm
operator|+
name|len
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_INFO
argument_list|,
literal|"WNM: Invalid IE len %u"
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
break|break;
block|}
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Element"
argument_list|,
name|pos
argument_list|,
literal|2
operator|+
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|==
name|WLAN_EID_WNMSLEEP
condition|)
name|wnmsleep_ie
operator|=
operator|(
expr|struct
name|wnm_sleep_element
operator|*
operator|)
name|pos
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|pos
operator|==
name|WLAN_EID_TFS_RESP
condition|)
block|{
if|if
condition|(
operator|!
name|tfsresp_ie_start
condition|)
name|tfsresp_ie_start
operator|=
name|pos
expr_stmt|;
name|tfsresp_ie_end
operator|=
name|pos
expr_stmt|;
block|}
else|else
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"EID %d not recognized"
argument_list|,
operator|*
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ie_len
operator|+
literal|2
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wnmsleep_ie
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"No WNM-Sleep IE found"
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_s
operator|->
name|wnmsleep_used
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|wnmsleep_ie
operator|->
name|status
operator|==
name|WNM_STATUS_SLEEP_ACCEPT
operator|||
name|wnmsleep_ie
operator|->
name|status
operator|==
name|WNM_STATUS_SLEEP_EXIT_ACCEPT_GTK_UPDATE
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Successfully recv WNM-Sleep Response "
literal|"frame (action=%d, intval=%d)"
argument_list|,
name|wnmsleep_ie
operator|->
name|action_type
argument_list|,
name|wnmsleep_ie
operator|->
name|intval
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmsleep_ie
operator|->
name|action_type
operator|==
name|WNM_SLEEP_MODE_ENTER
condition|)
block|{
name|wnm_sleep_mode_enter_success
argument_list|(
name|wpa_s
argument_list|,
name|tfsresp_ie_start
argument_list|,
name|tfsresp_ie_end
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|wnmsleep_ie
operator|->
name|action_type
operator|==
name|WNM_SLEEP_MODE_EXIT
condition|)
block|{
name|wnm_sleep_mode_exit_success
argument_list|(
name|wpa_s
argument_list|,
name|frm
argument_list|,
name|key_len_total
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Reject recv WNM-Sleep Response frame "
literal|"(action=%d, intval=%d)"
argument_list|,
name|wnmsleep_ie
operator|->
name|action_type
argument_list|,
name|wnmsleep_ie
operator|->
name|intval
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnmsleep_ie
operator|->
name|action_type
operator|==
name|WNM_SLEEP_MODE_ENTER
condition|)
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|WNM_SLEEP_ENTER_FAIL
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|wnmsleep_ie
operator|->
name|action_type
operator|==
name|WNM_SLEEP_MODE_EXIT
condition|)
name|wpa_drv_wnm_oper
argument_list|(
name|wpa_s
argument_list|,
name|WNM_SLEEP_EXIT_FAIL
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|wnm_deallocate_memory
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|wnm_num_neighbor_report
condition|;
name|i
operator|++
control|)
block|{
name|os_free
argument_list|(
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
index|[
name|i
index|]
operator|.
name|meas_pilot
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
index|[
name|i
index|]
operator|.
name|mul_bssid
argument_list|)
expr_stmt|;
block|}
name|wpa_s
operator|->
name|wnm_num_neighbor_report
operator|=
literal|0
expr_stmt|;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_parse_neighbor_report_elem
parameter_list|(
name|struct
name|neighbor_report
modifier|*
name|rep
parameter_list|,
name|u8
name|id
parameter_list|,
name|u8
name|elen
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|)
block|{
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|WNM_NEIGHBOR_TSF
case|:
if|if
condition|(
name|elen
operator|<
literal|2
operator|+
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short TSF"
argument_list|)
expr_stmt|;
break|break;
block|}
name|rep
operator|->
name|tsf_offset
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|rep
operator|->
name|beacon_int
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
expr_stmt|;
name|rep
operator|->
name|tsf_present
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WNM_NEIGHBOR_CONDENSED_COUNTRY_STRING
case|:
if|if
condition|(
name|elen
operator|<
literal|2
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short condensed "
literal|"country string"
argument_list|)
expr_stmt|;
break|break;
block|}
name|os_memcpy
argument_list|(
name|rep
operator|->
name|country
argument_list|,
name|pos
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|rep
operator|->
name|country_present
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WNM_NEIGHBOR_BSS_TRANSITION_CANDIDATE
case|:
if|if
condition|(
name|elen
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short BSS transition "
literal|"candidate"
argument_list|)
expr_stmt|;
break|break;
block|}
name|rep
operator|->
name|preference
operator|=
name|pos
index|[
literal|0
index|]
expr_stmt|;
name|rep
operator|->
name|preference_present
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WNM_NEIGHBOR_BSS_TERMINATION_DURATION
case|:
name|rep
operator|->
name|bss_term_tsf
operator|=
name|WPA_GET_LE64
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|rep
operator|->
name|bss_term_dur
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
operator|+
literal|8
argument_list|)
expr_stmt|;
name|rep
operator|->
name|bss_term_present
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WNM_NEIGHBOR_BEARING
case|:
if|if
condition|(
name|elen
operator|<
literal|8
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short neighbor "
literal|"bearing"
argument_list|)
expr_stmt|;
break|break;
block|}
name|rep
operator|->
name|bearing
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|rep
operator|->
name|distance
operator|=
name|WPA_GET_LE32
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
expr_stmt|;
name|rep
operator|->
name|rel_height
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
operator|+
literal|2
operator|+
literal|4
argument_list|)
expr_stmt|;
name|rep
operator|->
name|bearing_present
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WNM_NEIGHBOR_MEASUREMENT_PILOT
case|:
if|if
condition|(
name|elen
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short measurement "
literal|"pilot"
argument_list|)
expr_stmt|;
break|break;
block|}
name|os_free
argument_list|(
name|rep
operator|->
name|meas_pilot
argument_list|)
expr_stmt|;
name|rep
operator|->
name|meas_pilot
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|measurement_pilot
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rep
operator|->
name|meas_pilot
operator|==
name|NULL
condition|)
break|break;
name|rep
operator|->
name|meas_pilot
operator|->
name|measurement_pilot
operator|=
name|pos
index|[
literal|0
index|]
expr_stmt|;
name|rep
operator|->
name|meas_pilot
operator|->
name|subelem_len
operator|=
name|elen
operator|-
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|rep
operator|->
name|meas_pilot
operator|->
name|subelems
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|elen
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
name|WNM_NEIGHBOR_RRM_ENABLED_CAPABILITIES
case|:
if|if
condition|(
name|elen
operator|<
literal|5
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short RRM enabled "
literal|"capabilities"
argument_list|)
expr_stmt|;
break|break;
block|}
name|os_memcpy
argument_list|(
name|rep
operator|->
name|rm_capab
argument_list|,
name|pos
argument_list|,
literal|5
argument_list|)
expr_stmt|;
name|rep
operator|->
name|rm_capab_present
operator|=
literal|1
expr_stmt|;
break|break;
case|case
name|WNM_NEIGHBOR_MULTIPLE_BSSID
case|:
if|if
condition|(
name|elen
operator|<
literal|1
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short multiple BSSID"
argument_list|)
expr_stmt|;
break|break;
block|}
name|os_free
argument_list|(
name|rep
operator|->
name|mul_bssid
argument_list|)
expr_stmt|;
name|rep
operator|->
name|mul_bssid
operator|=
name|os_zalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|multiple_bssid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|rep
operator|->
name|mul_bssid
operator|==
name|NULL
condition|)
break|break;
name|rep
operator|->
name|mul_bssid
operator|->
name|max_bssid_indicator
operator|=
name|pos
index|[
literal|0
index|]
expr_stmt|;
name|rep
operator|->
name|mul_bssid
operator|->
name|subelem_len
operator|=
name|elen
operator|-
literal|1
expr_stmt|;
name|os_memcpy
argument_list|(
name|rep
operator|->
name|mul_bssid
operator|->
name|subelems
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|elen
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|wnm_nei_get_chan
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|op_class
parameter_list|,
name|u8
name|chan
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
init|=
name|wpa_s
operator|->
name|current_bss
decl_stmt|;
specifier|const
name|char
modifier|*
name|country
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|bss
condition|)
block|{
specifier|const
name|u8
modifier|*
name|elem
init|=
name|wpa_bss_get_ie
argument_list|(
name|bss
argument_list|,
name|WLAN_EID_COUNTRY
argument_list|)
decl_stmt|;
if|if
condition|(
name|elem
operator|&&
name|elem
index|[
literal|1
index|]
operator|>=
literal|2
condition|)
name|country
operator|=
operator|(
specifier|const
name|char
operator|*
operator|)
operator|(
name|elem
operator|+
literal|2
operator|)
expr_stmt|;
block|}
return|return
name|ieee80211_chan_to_freq
argument_list|(
name|country
argument_list|,
name|op_class
argument_list|,
name|chan
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_parse_neighbor_report
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
name|u8
name|len
parameter_list|,
name|struct
name|neighbor_report
modifier|*
name|rep
parameter_list|)
block|{
name|u8
name|left
init|=
name|len
decl_stmt|;
if|if
condition|(
name|left
operator|<
literal|13
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short neighbor report"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|rep
operator|->
name|bssid
argument_list|,
name|pos
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|rep
operator|->
name|bssid_info
operator|=
name|WPA_GET_LE32
argument_list|(
name|pos
operator|+
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|rep
operator|->
name|regulatory_class
operator|=
operator|*
operator|(
name|pos
operator|+
literal|10
operator|)
expr_stmt|;
name|rep
operator|->
name|channel_number
operator|=
operator|*
operator|(
name|pos
operator|+
literal|11
operator|)
expr_stmt|;
name|rep
operator|->
name|phy_type
operator|=
operator|*
operator|(
name|pos
operator|+
literal|12
operator|)
expr_stmt|;
name|pos
operator|+=
literal|13
expr_stmt|;
name|left
operator|-=
literal|13
expr_stmt|;
while|while
condition|(
name|left
operator|>=
literal|2
condition|)
block|{
name|u8
name|id
decl_stmt|,
name|elen
decl_stmt|;
name|id
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|elen
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Subelement id=%u len=%u"
argument_list|,
name|id
argument_list|,
name|elen
argument_list|)
expr_stmt|;
name|left
operator|-=
literal|2
expr_stmt|;
if|if
condition|(
name|elen
operator|>
name|left
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Truncated neighbor report subelement"
argument_list|)
expr_stmt|;
break|break;
block|}
name|wnm_parse_neighbor_report_elem
argument_list|(
name|rep
argument_list|,
name|id
argument_list|,
name|elen
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|left
operator|-=
name|elen
expr_stmt|;
name|pos
operator|+=
name|elen
expr_stmt|;
block|}
name|rep
operator|->
name|freq
operator|=
name|wnm_nei_get_chan
argument_list|(
name|wpa_s
argument_list|,
name|rep
operator|->
name|regulatory_class
argument_list|,
name|rep
operator|->
name|channel_number
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|struct
name|wpa_bss
modifier|*
name|compare_scan_neighbor_results
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|u8
name|i
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|bss
init|=
name|wpa_s
operator|->
name|current_bss
decl_stmt|;
name|struct
name|wpa_bss
modifier|*
name|target
decl_stmt|;
if|if
condition|(
operator|!
name|bss
condition|)
return|return
literal|0
return|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Current BSS "
name|MACSTR
literal|" RSSI %d"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|,
name|bss
operator|->
name|level
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|wnm_num_neighbor_report
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|neighbor_report
modifier|*
name|nei
decl_stmt|;
name|nei
operator|=
operator|&
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|nei
operator|->
name|preference_present
operator|&&
name|nei
operator|->
name|preference
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Skip excluded BSS "
name|MACSTR
argument_list|,
name|MAC2STR
argument_list|(
name|nei
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|target
operator|=
name|wpa_bss_get_bssid
argument_list|(
name|wpa_s
argument_list|,
name|nei
operator|->
name|bssid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|target
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Candidate BSS "
name|MACSTR
literal|" (pref %d) not found in scan results"
argument_list|,
name|MAC2STR
argument_list|(
name|nei
operator|->
name|bssid
argument_list|)
argument_list|,
name|nei
operator|->
name|preference_present
condition|?
name|nei
operator|->
name|preference
else|:
operator|-
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|bss
operator|->
name|ssid_len
operator|!=
name|target
operator|->
name|ssid_len
operator|||
name|os_memcmp
argument_list|(
name|bss
operator|->
name|ssid
argument_list|,
name|target
operator|->
name|ssid
argument_list|,
name|bss
operator|->
name|ssid_len
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* 			 * TODO: Could consider allowing transition to another 			 * ESS if PMF was enabled for the association. 			 */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Candidate BSS "
name|MACSTR
literal|" (pref %d) in different ESS"
argument_list|,
name|MAC2STR
argument_list|(
name|nei
operator|->
name|bssid
argument_list|)
argument_list|,
name|nei
operator|->
name|preference_present
condition|?
name|nei
operator|->
name|preference
else|:
operator|-
literal|1
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|target
operator|->
name|level
operator|<
name|bss
operator|->
name|level
operator|&&
name|target
operator|->
name|level
operator|<
operator|-
literal|80
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Candidate BSS "
name|MACSTR
literal|" (pref %d) does not have sufficient signal level (%d)"
argument_list|,
name|MAC2STR
argument_list|(
name|nei
operator|->
name|bssid
argument_list|)
argument_list|,
name|nei
operator|->
name|preference_present
condition|?
name|nei
operator|->
name|preference
else|:
operator|-
literal|1
argument_list|,
name|target
operator|->
name|level
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Found an acceptable preferred transition candidate BSS "
name|MACSTR
literal|" (RSSI %d)"
argument_list|,
name|MAC2STR
argument_list|(
name|nei
operator|->
name|bssid
argument_list|)
argument_list|,
name|target
operator|->
name|level
argument_list|)
expr_stmt|;
return|return
name|target
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_send_bss_transition_mgmt_resp
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|dialog_token
parameter_list|,
name|enum
name|bss_trans_mgmt_status_code
name|status
parameter_list|,
name|u8
name|delay
parameter_list|,
specifier|const
name|u8
modifier|*
name|target_bssid
parameter_list|)
block|{
name|u8
name|buf
index|[
literal|1000
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|res
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Send BSS Transition Management Response "
literal|"to "
name|MACSTR
literal|" dialog_token=%u status=%u delay=%d"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|,
name|dialog_token
argument_list|,
name|status
argument_list|,
name|delay
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|current_bss
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Current BSS not known - drop response"
argument_list|)
expr_stmt|;
return|return;
block|}
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ACTION
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|=
name|WLAN_ACTION_WNM
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_resp
operator|.
name|action
operator|=
name|WNM_BSS_TRANS_MGMT_RESP
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_resp
operator|.
name|dialog_token
operator|=
name|dialog_token
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_resp
operator|.
name|status_code
operator|=
name|status
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_resp
operator|.
name|bss_termination_delay
operator|=
name|delay
expr_stmt|;
name|pos
operator|=
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_resp
operator|.
name|variable
expr_stmt|;
if|if
condition|(
name|target_bssid
condition|)
block|{
name|os_memcpy
argument_list|(
name|pos
argument_list|,
name|target_bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|status
operator|==
name|WNM_BSS_TM_ACCEPT
condition|)
block|{
comment|/* 		 * P802.11-REVmc clarifies that the Target BSSID field is always 		 * present when status code is zero, so use a fake value here if 		 * no BSSID is yet known. 		 */
name|os_memset
argument_list|(
name|pos
argument_list|,
literal|0
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|pos
operator|+=
name|ETH_ALEN
expr_stmt|;
block|}
name|len
operator|=
name|pos
operator|-
operator|(
name|u8
operator|*
operator|)
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
expr_stmt|;
name|res
operator|=
name|wpa_drv_send_action
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|<
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Failed to send BSS Transition Management Response"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wnm_scan_process
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|reply_on_fail
parameter_list|)
block|{
name|struct
name|wpa_bss
modifier|*
name|bss
decl_stmt|;
name|struct
name|wpa_ssid
modifier|*
name|ssid
init|=
name|wpa_s
operator|->
name|current_ssid
decl_stmt|;
name|enum
name|bss_trans_mgmt_status_code
name|status
init|=
name|WNM_BSS_TM_REJECT_UNSPECIFIED
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|os_reltime_before
argument_list|(
operator|&
name|wpa_s
operator|->
name|wnm_cand_valid_until
argument_list|,
operator|&
name|wpa_s
operator|->
name|scan_trigger_time
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Previously stored BSS transition candidate list is not valid anymore - drop it"
argument_list|)
expr_stmt|;
name|wnm_deallocate_memory
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|current_bss
operator|||
name|os_memcmp
argument_list|(
name|wpa_s
operator|->
name|wnm_cand_from_bss
argument_list|,
name|wpa_s
operator|->
name|current_bss
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Stored BSS transition candidate list not from the current BSS - ignore it"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* Compare the Neighbor Report and scan results */
name|bss
operator|=
name|compare_scan_neighbor_results
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bss
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: No BSS transition candidate match found"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WNM_BSS_TM_REJECT_NO_SUITABLE_CANDIDATES
expr_stmt|;
goto|goto
name|send_bss_resp_fail
goto|;
block|}
comment|/* Associate to the network */
comment|/* Send the BSS Management Response - Accept */
if|if
condition|(
name|wpa_s
operator|->
name|wnm_reply
condition|)
block|{
name|wpa_s
operator|->
name|wnm_reply
operator|=
literal|0
expr_stmt|;
name|wnm_send_bss_transition_mgmt_resp
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|wnm_dialog_token
argument_list|,
name|WNM_BSS_TM_ACCEPT
argument_list|,
literal|0
argument_list|,
name|bss
operator|->
name|bssid
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bss
operator|==
name|wpa_s
operator|->
name|current_bss
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Already associated with the preferred candidate"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|wpa_s
operator|->
name|reassociate
operator|=
literal|1
expr_stmt|;
name|wpa_supplicant_connect
argument_list|(
name|wpa_s
argument_list|,
name|bss
argument_list|,
name|ssid
argument_list|)
expr_stmt|;
name|wnm_deallocate_memory
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
name|send_bss_resp_fail
label|:
if|if
condition|(
operator|!
name|reply_on_fail
condition|)
return|return
literal|0
return|;
comment|/* Send reject response for all the failures */
if|if
condition|(
name|wpa_s
operator|->
name|wnm_reply
condition|)
block|{
name|wpa_s
operator|->
name|wnm_reply
operator|=
literal|0
expr_stmt|;
name|wnm_send_bss_transition_mgmt_resp
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|wnm_dialog_token
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
name|wnm_deallocate_memory
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cand_pref_compar
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
specifier|const
name|struct
name|neighbor_report
modifier|*
name|aa
init|=
name|a
decl_stmt|;
specifier|const
name|struct
name|neighbor_report
modifier|*
name|bb
init|=
name|b
decl_stmt|;
if|if
condition|(
operator|!
name|aa
operator|->
name|preference_present
operator|&&
operator|!
name|bb
operator|->
name|preference_present
condition|)
return|return
literal|0
return|;
if|if
condition|(
operator|!
name|aa
operator|->
name|preference_present
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|bb
operator|->
name|preference_present
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|bb
operator|->
name|preference
operator|>
name|aa
operator|->
name|preference
condition|)
return|return
literal|1
return|;
if|if
condition|(
name|bb
operator|->
name|preference
operator|<
name|aa
operator|->
name|preference
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_sort_cand_list
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
condition|)
return|return;
name|qsort
argument_list|(
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
argument_list|,
name|wpa_s
operator|->
name|wnm_num_neighbor_report
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|neighbor_report
argument_list|)
argument_list|,
name|cand_pref_compar
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_dump_cand_list
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: BSS Transition Candidate List"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|wnm_num_neighbor_report
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|neighbor_report
modifier|*
name|nei
decl_stmt|;
name|nei
operator|=
operator|&
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
index|[
name|i
index|]
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"%u: "
name|MACSTR
literal|" info=0x%x op_class=%u chan=%u phy=%u pref=%d freq=%d"
argument_list|,
name|i
argument_list|,
name|MAC2STR
argument_list|(
name|nei
operator|->
name|bssid
argument_list|)
argument_list|,
name|nei
operator|->
name|bssid_info
argument_list|,
name|nei
operator|->
name|regulatory_class
argument_list|,
name|nei
operator|->
name|channel_number
argument_list|,
name|nei
operator|->
name|phy_type
argument_list|,
name|nei
operator|->
name|preference_present
condition|?
name|nei
operator|->
name|preference
else|:
operator|-
literal|1
argument_list|,
name|nei
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|chan_supported
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|int
name|freq
parameter_list|)
block|{
name|unsigned
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|hw
operator|.
name|num_modes
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|hostapd_hw_modes
modifier|*
name|mode
init|=
operator|&
name|wpa_s
operator|->
name|hw
operator|.
name|modes
index|[
name|i
index|]
decl_stmt|;
name|int
name|j
decl_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|mode
operator|->
name|num_channels
condition|;
name|j
operator|++
control|)
block|{
name|struct
name|hostapd_channel_data
modifier|*
name|chan
decl_stmt|;
name|chan
operator|=
operator|&
name|mode
operator|->
name|channels
index|[
name|j
index|]
expr_stmt|;
if|if
condition|(
name|chan
operator|->
name|freq
operator|==
name|freq
operator|&&
operator|!
operator|(
name|chan
operator|->
name|flag
operator|&
name|HOSTAPD_CHAN_DISABLED
operator|)
condition|)
return|return
literal|1
return|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|wnm_set_scan_freqs
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|)
block|{
name|int
modifier|*
name|freqs
decl_stmt|;
name|int
name|num_freqs
init|=
literal|0
decl_stmt|;
name|unsigned
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|hw
operator|.
name|modes
operator|==
name|NULL
condition|)
return|return;
name|os_free
argument_list|(
name|wpa_s
operator|->
name|next_scan_freqs
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|next_scan_freqs
operator|=
name|NULL
expr_stmt|;
name|freqs
operator|=
name|os_calloc
argument_list|(
name|wpa_s
operator|->
name|wnm_num_neighbor_report
operator|+
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|freqs
operator|==
name|NULL
condition|)
return|return;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|wpa_s
operator|->
name|wnm_num_neighbor_report
condition|;
name|i
operator|++
control|)
block|{
name|struct
name|neighbor_report
modifier|*
name|nei
decl_stmt|;
name|nei
operator|=
operator|&
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|nei
operator|->
name|freq
operator|<=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Unknown neighbor operating frequency for "
name|MACSTR
literal|" - scan all channels"
argument_list|,
name|MAC2STR
argument_list|(
name|nei
operator|->
name|bssid
argument_list|)
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|chan_supported
argument_list|(
name|wpa_s
argument_list|,
name|nei
operator|->
name|freq
argument_list|)
condition|)
name|add_freq
argument_list|(
name|freqs
argument_list|,
operator|&
name|num_freqs
argument_list|,
name|nei
operator|->
name|freq
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|num_freqs
operator|==
literal|0
condition|)
block|{
name|os_free
argument_list|(
name|freqs
argument_list|)
expr_stmt|;
return|return;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Scan %d frequencies based on transition candidate list"
argument_list|,
name|num_freqs
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|next_scan_freqs
operator|=
name|freqs
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee802_11_rx_bss_trans_mgmt_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|pos
parameter_list|,
specifier|const
name|u8
modifier|*
name|end
parameter_list|,
name|int
name|reply
parameter_list|)
block|{
name|unsigned
name|int
name|beacon_int
decl_stmt|;
name|u8
name|valid_int
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|5
operator|>
name|end
condition|)
return|return;
if|if
condition|(
name|wpa_s
operator|->
name|current_bss
condition|)
name|beacon_int
operator|=
name|wpa_s
operator|->
name|current_bss
operator|->
name|beacon_int
expr_stmt|;
else|else
name|beacon_int
operator|=
literal|100
expr_stmt|;
comment|/* best guess */
name|wpa_s
operator|->
name|wnm_dialog_token
operator|=
name|pos
index|[
literal|0
index|]
expr_stmt|;
name|wpa_s
operator|->
name|wnm_mode
operator|=
name|pos
index|[
literal|1
index|]
expr_stmt|;
name|wpa_s
operator|->
name|wnm_dissoc_timer
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
operator|+
literal|2
argument_list|)
expr_stmt|;
name|valid_int
operator|=
name|pos
index|[
literal|4
index|]
expr_stmt|;
name|wpa_s
operator|->
name|wnm_reply
operator|=
name|reply
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: BSS Transition Management Request: "
literal|"dialog_token=%u request_mode=0x%x "
literal|"disassoc_timer=%u validity_interval=%u"
argument_list|,
name|wpa_s
operator|->
name|wnm_dialog_token
argument_list|,
name|wpa_s
operator|->
name|wnm_mode
argument_list|,
name|wpa_s
operator|->
name|wnm_dissoc_timer
argument_list|,
name|valid_int
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|5
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wnm_mode
operator|&
name|WNM_BSS_TM_REQ_BSS_TERMINATION_INCLUDED
condition|)
block|{
if|if
condition|(
name|pos
operator|+
literal|12
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Too short BSS TM Request"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|wnm_bss_termination_duration
argument_list|,
name|pos
argument_list|,
literal|12
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|12
expr_stmt|;
comment|/* BSS Termination Duration */
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wnm_mode
operator|&
name|WNM_BSS_TM_REQ_ESS_DISASSOC_IMMINENT
condition|)
block|{
name|char
name|url
index|[
literal|256
index|]
decl_stmt|;
if|if
condition|(
name|pos
operator|+
literal|1
operator|>
name|end
operator|||
name|pos
operator|+
literal|1
operator|+
name|pos
index|[
literal|0
index|]
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Invalid BSS Transition "
literal|"Management Request (URL)"
argument_list|)
expr_stmt|;
return|return;
block|}
name|os_memcpy
argument_list|(
name|url
argument_list|,
name|pos
operator|+
literal|1
argument_list|,
name|pos
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|url
index|[
name|pos
index|[
literal|0
index|]
index|]
operator|=
literal|'\0'
expr_stmt|;
name|pos
operator|+=
literal|1
operator|+
name|pos
index|[
literal|0
index|]
expr_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
name|ESS_DISASSOC_IMMINENT
literal|"%d %u %s"
argument_list|,
name|wpa_sm_pmf_enabled
argument_list|(
name|wpa_s
operator|->
name|wpa
argument_list|)
argument_list|,
name|wpa_s
operator|->
name|wnm_dissoc_timer
operator|*
name|beacon_int
operator|*
literal|128
operator|/
literal|125
argument_list|,
name|url
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wnm_mode
operator|&
name|WNM_BSS_TM_REQ_DISASSOC_IMMINENT
condition|)
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WNM: Disassociation Imminent - "
literal|"Disassociation Timer %u"
argument_list|,
name|wpa_s
operator|->
name|wnm_dissoc_timer
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wnm_dissoc_timer
operator|&&
operator|!
name|wpa_s
operator|->
name|scanning
condition|)
block|{
comment|/* TODO: mark current BSS less preferred for 			 * selection */
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"Trying to find another BSS"
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|wpa_s
operator|->
name|wnm_mode
operator|&
name|WNM_BSS_TM_REQ_PREF_CAND_LIST_INCLUDED
condition|)
block|{
name|unsigned
name|int
name|valid_ms
decl_stmt|;
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WNM: Preferred List Available"
argument_list|)
expr_stmt|;
name|wnm_deallocate_memory
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
operator|=
name|os_calloc
argument_list|(
name|WNM_MAX_NEIGHBOR_REPORT
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|neighbor_report
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
operator|==
name|NULL
condition|)
return|return;
while|while
condition|(
name|pos
operator|+
literal|2
operator|<=
name|end
operator|&&
name|wpa_s
operator|->
name|wnm_num_neighbor_report
operator|<
name|WNM_MAX_NEIGHBOR_REPORT
condition|)
block|{
name|u8
name|tag
init|=
operator|*
name|pos
operator|++
decl_stmt|;
name|u8
name|len
init|=
operator|*
name|pos
operator|++
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Neighbor report tag %u"
argument_list|,
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|len
operator|>
name|end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Truncated request"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|tag
operator|==
name|WLAN_EID_NEIGHBOR_REPORT
condition|)
block|{
name|struct
name|neighbor_report
modifier|*
name|rep
decl_stmt|;
name|rep
operator|=
operator|&
name|wpa_s
operator|->
name|wnm_neighbor_report_elements
index|[
name|wpa_s
operator|->
name|wnm_num_neighbor_report
index|]
expr_stmt|;
name|wnm_parse_neighbor_report
argument_list|(
name|wpa_s
argument_list|,
name|pos
argument_list|,
name|len
argument_list|,
name|rep
argument_list|)
expr_stmt|;
block|}
name|pos
operator|+=
name|len
expr_stmt|;
name|wpa_s
operator|->
name|wnm_num_neighbor_report
operator|++
expr_stmt|;
block|}
name|wnm_sort_cand_list
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wnm_dump_cand_list
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|valid_ms
operator|=
name|valid_int
operator|*
name|beacon_int
operator|*
literal|128
operator|/
literal|125
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Candidate list valid for %u ms"
argument_list|,
name|valid_ms
argument_list|)
expr_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|wpa_s
operator|->
name|wnm_cand_valid_until
argument_list|)
expr_stmt|;
name|wpa_s
operator|->
name|wnm_cand_valid_until
operator|.
name|sec
operator|+=
name|valid_ms
operator|/
literal|1000
expr_stmt|;
name|wpa_s
operator|->
name|wnm_cand_valid_until
operator|.
name|usec
operator|+=
operator|(
name|valid_ms
operator|%
literal|1000
operator|)
operator|*
literal|1000
expr_stmt|;
name|wpa_s
operator|->
name|wnm_cand_valid_until
operator|.
name|sec
operator|+=
name|wpa_s
operator|->
name|wnm_cand_valid_until
operator|.
name|usec
operator|/
literal|1000000
expr_stmt|;
name|wpa_s
operator|->
name|wnm_cand_valid_until
operator|.
name|usec
operator|%=
literal|1000000
expr_stmt|;
name|os_memcpy
argument_list|(
name|wpa_s
operator|->
name|wnm_cand_from_bss
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|last_scan_res_used
operator|>
literal|0
condition|)
block|{
name|struct
name|os_reltime
name|now
decl_stmt|;
name|os_get_reltime
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|os_reltime_expired
argument_list|(
operator|&
name|now
argument_list|,
operator|&
name|wpa_s
operator|->
name|last_scan
argument_list|,
literal|10
argument_list|)
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Try to use recent scan results"
argument_list|)
expr_stmt|;
if|if
condition|(
name|wnm_scan_process
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|)
operator|>
literal|0
condition|)
return|return;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: No match in previous scan results - try a new scan"
argument_list|)
expr_stmt|;
block|}
block|}
name|wnm_set_scan_freqs
argument_list|(
name|wpa_s
argument_list|)
expr_stmt|;
name|wpa_supplicant_req_scan
argument_list|(
name|wpa_s
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|reply
condition|)
block|{
name|enum
name|bss_trans_mgmt_status_code
name|status
decl_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wnm_mode
operator|&
name|WNM_BSS_TM_REQ_ESS_DISASSOC_IMMINENT
condition|)
name|status
operator|=
name|WNM_BSS_TM_ACCEPT
expr_stmt|;
else|else
block|{
name|wpa_msg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_INFO
argument_list|,
literal|"WNM: BSS Transition Management Request did not include candidates"
argument_list|)
expr_stmt|;
name|status
operator|=
name|WNM_BSS_TM_REJECT_UNSPECIFIED
expr_stmt|;
block|}
name|wnm_send_bss_transition_mgmt_resp
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|wnm_dialog_token
argument_list|,
name|status
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|wnm_send_bss_transition_mgmt_query
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
name|u8
name|query_reason
parameter_list|)
block|{
name|u8
name|buf
index|[
literal|1000
index|]
decl_stmt|,
modifier|*
name|pos
decl_stmt|;
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
decl_stmt|;
name|size_t
name|len
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Send BSS Transition Management Query to "
name|MACSTR
literal|" query_reason=%u"
argument_list|,
name|MAC2STR
argument_list|(
name|wpa_s
operator|->
name|bssid
argument_list|)
argument_list|,
name|query_reason
argument_list|)
expr_stmt|;
name|mgmt
operator|=
operator|(
expr|struct
name|ieee80211_mgmt
operator|*
operator|)
name|buf
expr_stmt|;
name|os_memset
argument_list|(
operator|&
name|buf
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|da
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|os_memcpy
argument_list|(
name|mgmt
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|frame_control
operator|=
name|IEEE80211_FC
argument_list|(
name|WLAN_FC_TYPE_MGMT
argument_list|,
name|WLAN_FC_STYPE_ACTION
argument_list|)
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
operator|=
name|WLAN_ACTION_WNM
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_query
operator|.
name|action
operator|=
name|WNM_BSS_TRANS_MGMT_QUERY
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_query
operator|.
name|dialog_token
operator|=
literal|1
expr_stmt|;
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_query
operator|.
name|query_reason
operator|=
name|query_reason
expr_stmt|;
name|pos
operator|=
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|u
operator|.
name|bss_tm_query
operator|.
name|variable
expr_stmt|;
name|len
operator|=
name|pos
operator|-
operator|(
name|u8
operator|*
operator|)
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
expr_stmt|;
name|ret
operator|=
name|wpa_drv_send_action
argument_list|(
name|wpa_s
argument_list|,
name|wpa_s
operator|->
name|assoc_freq
argument_list|,
literal|0
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|wpa_s
operator|->
name|own_addr
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
operator|&
name|mgmt
operator|->
name|u
operator|.
name|action
operator|.
name|category
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ieee802_11_rx_wnm_notif_req_wfa
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|data
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|,
modifier|*
name|next
decl_stmt|;
name|u8
name|ie
decl_stmt|,
name|ie_len
decl_stmt|;
name|pos
operator|=
name|data
expr_stmt|;
name|end
operator|=
name|data
operator|+
name|len
expr_stmt|;
while|while
condition|(
name|pos
operator|+
literal|1
operator|<
name|end
condition|)
block|{
name|ie
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|ie_len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: WFA subelement %u len %u"
argument_list|,
name|ie
argument_list|,
name|ie_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|ie_len
operator|>
name|end
operator|-
name|pos
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Not enough room for "
literal|"subelement"
argument_list|)
expr_stmt|;
break|break;
block|}
name|next
operator|=
name|pos
operator|+
name|ie_len
expr_stmt|;
if|if
condition|(
name|ie_len
operator|<
literal|4
condition|)
block|{
name|pos
operator|=
name|next
expr_stmt|;
continue|continue;
block|}
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Subelement OUI %06x type %u"
argument_list|,
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
argument_list|,
name|pos
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|CONFIG_HS20
if|if
condition|(
name|ie
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|ie_len
operator|>=
literal|5
operator|&&
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
operator|==
name|OUI_WFA
operator|&&
name|pos
index|[
literal|3
index|]
operator|==
name|HS20_WNM_SUB_REM_NEEDED
condition|)
block|{
comment|/* Subscription Remediation subelement */
specifier|const
name|u8
modifier|*
name|ie_end
decl_stmt|;
name|u8
name|url_len
decl_stmt|;
name|char
modifier|*
name|url
decl_stmt|;
name|u8
name|osu_method
decl_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Subscription Remediation "
literal|"subelement"
argument_list|)
expr_stmt|;
name|ie_end
operator|=
name|pos
operator|+
name|ie_len
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
name|url_len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
if|if
condition|(
name|url_len
operator|==
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: No Server URL included"
argument_list|)
expr_stmt|;
name|url
operator|=
name|NULL
expr_stmt|;
name|osu_method
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|pos
operator|+
name|url_len
operator|+
literal|1
operator|>
name|ie_end
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Not enough room for Server URL (len=%u) and Server Method (left %d)"
argument_list|,
name|url_len
argument_list|,
call|(
name|int
call|)
argument_list|(
name|ie_end
operator|-
name|pos
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|url
operator|=
name|os_malloc
argument_list|(
name|url_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|url
argument_list|,
name|pos
argument_list|,
name|url_len
argument_list|)
expr_stmt|;
name|url
index|[
name|url_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|osu_method
operator|=
name|pos
index|[
name|url_len
index|]
expr_stmt|;
block|}
name|hs20_rx_subscription_remediation
argument_list|(
name|wpa_s
argument_list|,
name|url
argument_list|,
name|osu_method
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|pos
operator|=
name|next
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|ie
operator|==
name|WLAN_EID_VENDOR_SPECIFIC
operator|&&
name|ie_len
operator|>=
literal|8
operator|&&
name|WPA_GET_BE24
argument_list|(
name|pos
argument_list|)
operator|==
name|OUI_WFA
operator|&&
name|pos
index|[
literal|3
index|]
operator|==
name|HS20_WNM_DEAUTH_IMMINENT_NOTICE
condition|)
block|{
specifier|const
name|u8
modifier|*
name|ie_end
decl_stmt|;
name|u8
name|url_len
decl_stmt|;
name|char
modifier|*
name|url
decl_stmt|;
name|u8
name|code
decl_stmt|;
name|u16
name|reauth_delay
decl_stmt|;
name|ie_end
operator|=
name|pos
operator|+
name|ie_len
expr_stmt|;
name|pos
operator|+=
literal|4
expr_stmt|;
name|code
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|reauth_delay
operator|=
name|WPA_GET_LE16
argument_list|(
name|pos
argument_list|)
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
name|url_len
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: HS 2.0 Deauthentication "
literal|"Imminent - Reason Code %u   "
literal|"Re-Auth Delay %u  URL Length %u"
argument_list|,
name|code
argument_list|,
name|reauth_delay
argument_list|,
name|url_len
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|+
name|url_len
operator|>
name|ie_end
condition|)
break|break;
name|url
operator|=
name|os_malloc
argument_list|(
name|url_len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|url
operator|==
name|NULL
condition|)
break|break;
name|os_memcpy
argument_list|(
name|url
argument_list|,
name|pos
argument_list|,
name|url_len
argument_list|)
expr_stmt|;
name|url
index|[
name|url_len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|hs20_rx_deauth_imminent_notice
argument_list|(
name|wpa_s
argument_list|,
name|code
argument_list|,
name|reauth_delay
argument_list|,
name|url
argument_list|)
expr_stmt|;
name|os_free
argument_list|(
name|url
argument_list|)
expr_stmt|;
name|pos
operator|=
name|next
expr_stmt|;
continue|continue;
block|}
endif|#
directive|endif
comment|/* CONFIG_HS20 */
name|pos
operator|=
name|next
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ieee802_11_rx_wnm_notif_req
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|u8
modifier|*
name|sa
parameter_list|,
specifier|const
name|u8
modifier|*
name|frm
parameter_list|,
name|int
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|dialog_token
decl_stmt|,
name|type
decl_stmt|;
comment|/* Dialog Token [1] | Type [1] | Subelements */
if|if
condition|(
name|len
operator|<
literal|2
operator|||
name|sa
operator|==
name|NULL
condition|)
return|return;
name|end
operator|=
name|frm
operator|+
name|len
expr_stmt|;
name|pos
operator|=
name|frm
expr_stmt|;
name|dialog_token
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|type
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WNM: Received WNM-Notification Request "
literal|"(dialog_token %u type %u sa "
name|MACSTR
literal|")"
argument_list|,
name|dialog_token
argument_list|,
name|type
argument_list|,
name|MAC2STR
argument_list|(
name|sa
argument_list|)
argument_list|)
expr_stmt|;
name|wpa_hexdump
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM-Notification Request subelements"
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|!=
name|WPA_COMPLETED
operator|||
name|os_memcmp
argument_list|(
name|sa
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WNM: WNM-Notification frame not "
literal|"from our AP - ignore it"
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|type
condition|)
block|{
case|case
literal|1
case|:
name|ieee802_11_rx_wnm_notif_req_wfa
argument_list|(
name|wpa_s
argument_list|,
name|sa
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_dbg
argument_list|(
name|wpa_s
argument_list|,
name|MSG_DEBUG
argument_list|,
literal|"WNM: Ignore unknown "
literal|"WNM-Notification type %u"
argument_list|,
name|type
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|void
name|ieee802_11_rx_wnm_action
parameter_list|(
name|struct
name|wpa_supplicant
modifier|*
name|wpa_s
parameter_list|,
specifier|const
name|struct
name|ieee80211_mgmt
modifier|*
name|mgmt
parameter_list|,
name|size_t
name|len
parameter_list|)
block|{
specifier|const
name|u8
modifier|*
name|pos
decl_stmt|,
modifier|*
name|end
decl_stmt|;
name|u8
name|act
decl_stmt|;
if|if
condition|(
name|len
operator|<
name|IEEE80211_HDRLEN
operator|+
literal|2
condition|)
return|return;
name|pos
operator|=
operator|(
operator|(
specifier|const
name|u8
operator|*
operator|)
name|mgmt
operator|)
operator|+
name|IEEE80211_HDRLEN
operator|+
literal|1
expr_stmt|;
name|act
operator|=
operator|*
name|pos
operator|++
expr_stmt|;
name|end
operator|=
operator|(
operator|(
specifier|const
name|u8
operator|*
operator|)
name|mgmt
operator|)
operator|+
name|len
expr_stmt|;
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: RX action %u from "
name|MACSTR
argument_list|,
name|act
argument_list|,
name|MAC2STR
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|wpa_s
operator|->
name|wpa_state
operator|<
name|WPA_ASSOCIATED
operator|||
name|os_memcmp
argument_list|(
name|mgmt
operator|->
name|sa
argument_list|,
name|wpa_s
operator|->
name|bssid
argument_list|,
name|ETH_ALEN
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|wpa_printf
argument_list|(
name|MSG_DEBUG
argument_list|,
literal|"WNM: Ignore unexpected WNM Action "
literal|"frame"
argument_list|)
expr_stmt|;
return|return;
block|}
switch|switch
condition|(
name|act
condition|)
block|{
case|case
name|WNM_BSS_TRANS_MGMT_REQ
case|:
name|ieee802_11_rx_bss_trans_mgmt_req
argument_list|(
name|wpa_s
argument_list|,
name|pos
argument_list|,
name|end
argument_list|,
operator|!
operator|(
name|mgmt
operator|->
name|da
index|[
literal|0
index|]
operator|&
literal|0x01
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|WNM_SLEEP_MODE_RESP
case|:
name|ieee802_11_rx_wnmsleep_resp
argument_list|(
name|wpa_s
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
case|case
name|WNM_NOTIFICATION_REQ
case|:
name|ieee802_11_rx_wnm_notif_req
argument_list|(
name|wpa_s
argument_list|,
name|mgmt
operator|->
name|sa
argument_list|,
name|pos
argument_list|,
name|end
operator|-
name|pos
argument_list|)
expr_stmt|;
break|break;
default|default:
name|wpa_printf
argument_list|(
name|MSG_ERROR
argument_list|,
literal|"WNM: Unknown request"
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Remote debugging with the XLNT Designs, Inc (XDI) NetROM.    Copyright 1990, 1991, 1992, 1995 Free Software Foundation, Inc.    Contributed by: 	 Roger Moyers  	 XLNT Designs, Inc. 	 15050 Avenue of Science, Suite 106 	 San Diego, CA  92128 	 (619)487-9320 	 roger@xlnt.com    Adapted from work done at Cygnus Support in remote-nindy.c,    later merged in by Stan Shebs at Cygnus.  This file is part of GDB.  This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"gdbcmd.h"
end_include

begin_include
include|#
directive|include
file|"serial.h"
end_include

begin_include
include|#
directive|include
file|"target.h"
end_include

begin_comment
comment|/* Default ports used to talk with the NetROM.  */
end_comment

begin_define
define|#
directive|define
name|DEFAULT_NETROM_LOAD_PORT
value|1236
end_define

begin_define
define|#
directive|define
name|DEFAULT_NETROM_CONTROL_PORT
value|1237
end_define

begin_decl_stmt
specifier|static
name|void
name|nrom_close
name|PARAMS
argument_list|(
operator|(
name|int
name|quitting
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* New commands.  */
end_comment

begin_decl_stmt
specifier|static
name|void
name|nrom_passthru
name|PARAMS
argument_list|(
operator|(
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* We talk to the NetROM over these sockets.  */
end_comment

begin_decl_stmt
specifier|static
name|serial_t
name|load_desc
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|serial_t
name|ctrl_desc
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|load_port
init|=
name|DEFAULT_NETROM_LOAD_PORT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|control_port
init|=
name|DEFAULT_NETROM_CONTROL_PORT
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|nrom_hostname
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Forward data declaration. */
end_comment

begin_decl_stmt
specifier|extern
name|struct
name|target_ops
name|nrom_ops
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Scan input from the remote system, until STRING is found.  Print chars that    don't match.  */
end_comment

begin_function
specifier|static
name|int
name|expect
parameter_list|(
name|string
parameter_list|)
name|char
modifier|*
name|string
decl_stmt|;
block|{
name|char
modifier|*
name|p
init|=
name|string
decl_stmt|;
name|int
name|c
decl_stmt|;
name|immediate_quit
operator|=
literal|1
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|c
operator|=
name|SERIAL_READCHAR
argument_list|(
name|ctrl_desc
argument_list|,
literal|5
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
operator|*
name|p
operator|++
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|'\0'
condition|)
block|{
name|immediate_quit
operator|=
literal|0
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
else|else
block|{
name|fputc_unfiltered
argument_list|(
name|c
argument_list|,
name|gdb_stdout
argument_list|)
expr_stmt|;
name|p
operator|=
name|string
expr_stmt|;
if|if
condition|(
name|c
operator|==
operator|*
name|p
condition|)
name|p
operator|++
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|nrom_kill
parameter_list|()
block|{
name|nrom_close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|serial_t
name|open_socket
parameter_list|(
name|name
parameter_list|,
name|port
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|port
decl_stmt|;
block|{
name|char
name|sockname
index|[
literal|100
index|]
decl_stmt|;
name|serial_t
name|desc
decl_stmt|;
name|sprintf
argument_list|(
name|sockname
argument_list|,
literal|"%s:%d"
argument_list|,
name|name
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|desc
operator|=
name|SERIAL_OPEN
argument_list|(
name|sockname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|desc
condition|)
name|perror_with_name
argument_list|(
name|sockname
argument_list|)
expr_stmt|;
return|return
name|desc
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|load_cleanup
parameter_list|()
block|{
name|SERIAL_CLOSE
argument_list|(
name|load_desc
argument_list|)
expr_stmt|;
name|load_desc
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Download a file specified in ARGS to the netROM.  */
end_comment

begin_function
specifier|static
name|void
name|nrom_load
parameter_list|(
name|args
parameter_list|,
name|fromtty
parameter_list|)
name|char
modifier|*
name|args
decl_stmt|;
name|int
name|fromtty
decl_stmt|;
block|{
name|int
name|fd
decl_stmt|,
name|rd_amt
decl_stmt|,
name|fsize
decl_stmt|;
name|bfd
modifier|*
name|pbfd
decl_stmt|;
name|asection
modifier|*
name|section
decl_stmt|;
name|char
modifier|*
name|downloadstring
init|=
literal|"download 0\n"
decl_stmt|;
name|struct
name|cleanup
modifier|*
name|old_chain
decl_stmt|;
comment|/* Tell the netrom to get ready to download. */
if|if
condition|(
name|SERIAL_WRITE
argument_list|(
name|ctrl_desc
argument_list|,
name|downloadstring
argument_list|,
name|strlen
argument_list|(
name|downloadstring
argument_list|)
argument_list|)
condition|)
name|error
argument_list|(
literal|"nrom_load: control_send() of `%s' failed"
argument_list|,
name|downloadstring
argument_list|)
expr_stmt|;
name|expect
argument_list|(
literal|"Waiting for a connection...\n"
argument_list|)
expr_stmt|;
name|load_desc
operator|=
name|open_socket
argument_list|(
name|nrom_hostname
argument_list|,
name|load_port
argument_list|)
expr_stmt|;
name|old_chain
operator|=
name|make_cleanup
argument_list|(
name|load_cleanup
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|pbfd
operator|=
name|bfd_openr
argument_list|(
name|args
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|pbfd
condition|)
block|{
name|make_cleanup
argument_list|(
name|bfd_close
argument_list|,
name|pbfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bfd_check_format
argument_list|(
name|pbfd
argument_list|,
name|bfd_object
argument_list|)
condition|)
name|error
argument_list|(
literal|"\"%s\": not in executable format: %s"
argument_list|,
name|args
argument_list|,
name|bfd_errmsg
argument_list|(
name|bfd_get_error
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|section
operator|=
name|pbfd
operator|->
name|sections
init|;
name|section
condition|;
name|section
operator|=
name|section
operator|->
name|next
control|)
block|{
if|if
condition|(
name|bfd_get_section_flags
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|)
operator|&
name|SEC_ALLOC
condition|)
block|{
name|bfd_vma
name|section_address
decl_stmt|;
name|unsigned
name|long
name|section_size
decl_stmt|;
specifier|const
name|char
modifier|*
name|section_name
decl_stmt|;
name|section_name
operator|=
name|bfd_get_section_name
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|)
expr_stmt|;
name|section_address
operator|=
name|bfd_get_section_vma
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|)
expr_stmt|;
name|section_size
operator|=
name|bfd_section_size
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_get_section_flags
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|)
operator|&
name|SEC_LOAD
condition|)
block|{
name|file_ptr
name|fptr
decl_stmt|;
name|printf_filtered
argument_list|(
literal|"[Loading section %s at %x (%d bytes)]\n"
argument_list|,
name|section_name
argument_list|,
name|section_address
argument_list|,
name|section_size
argument_list|)
expr_stmt|;
name|fptr
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|section_size
operator|>
literal|0
condition|)
block|{
name|char
name|buffer
index|[
literal|1024
index|]
decl_stmt|;
name|int
name|count
decl_stmt|;
name|count
operator|=
name|min
argument_list|(
name|section_size
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
name|bfd_get_section_contents
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|,
name|buffer
argument_list|,
name|fptr
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|SERIAL_WRITE
argument_list|(
name|load_desc
argument_list|,
name|buffer
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|section_address
operator|+=
name|count
expr_stmt|;
name|fptr
operator|+=
name|count
expr_stmt|;
name|section_size
operator|-=
name|count
expr_stmt|;
block|}
block|}
else|else
comment|/* BSS and such */
block|{
name|printf_filtered
argument_list|(
literal|"[section %s: not loading]\n"
argument_list|,
name|section_name
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
name|error
argument_list|(
literal|"\"%s\": Could not open"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|do_cleanups
argument_list|(
name|old_chain
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Open a connection to the remote NetROM devices.  */
end_comment

begin_function
specifier|static
name|void
name|nrom_open
parameter_list|(
name|name
parameter_list|,
name|from_tty
parameter_list|)
name|char
modifier|*
name|name
decl_stmt|;
name|int
name|from_tty
decl_stmt|;
block|{
name|int
name|errn
decl_stmt|;
if|if
condition|(
operator|!
name|name
operator|||
name|strchr
argument_list|(
name|name
argument_list|,
literal|'/'
argument_list|)
operator|||
name|strchr
argument_list|(
name|name
argument_list|,
literal|':'
argument_list|)
condition|)
name|error
argument_list|(
literal|"To open a NetROM connection, you must specify the hostname\n\ or IP address of the NetROM device you wish to use."
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|nrom_hostname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|target_preopen
argument_list|(
name|from_tty
argument_list|)
expr_stmt|;
name|unpush_target
argument_list|(
operator|&
name|nrom_ops
argument_list|)
expr_stmt|;
name|ctrl_desc
operator|=
name|open_socket
argument_list|(
name|nrom_hostname
argument_list|,
name|control_port
argument_list|)
expr_stmt|;
name|push_target
argument_list|(
operator|&
name|nrom_ops
argument_list|)
expr_stmt|;
if|if
condition|(
name|from_tty
condition|)
name|printf_filtered
argument_list|(
literal|"Connected to NetROM device \"%s\"\n"
argument_list|,
name|nrom_hostname
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Close out all files and local state before this target loses control. */
end_comment

begin_function
specifier|static
name|void
name|nrom_close
parameter_list|(
name|quitting
parameter_list|)
name|int
name|quitting
decl_stmt|;
block|{
if|if
condition|(
name|load_desc
condition|)
name|SERIAL_CLOSE
argument_list|(
name|load_desc
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctrl_desc
condition|)
name|SERIAL_CLOSE
argument_list|(
name|ctrl_desc
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Pass arguments directly to the NetROM. */
end_comment

begin_function
specifier|static
name|void
name|nrom_passthru
parameter_list|(
name|args
parameter_list|,
name|fromtty
parameter_list|)
name|char
modifier|*
name|args
decl_stmt|;
name|int
name|fromtty
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%s\n"
argument_list|,
name|args
argument_list|)
expr_stmt|;
if|if
condition|(
name|SERIAL_WRITE
argument_list|(
name|ctrl_desc
argument_list|,
name|buf
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|)
condition|)
name|error
argument_list|(
literal|"nrom_reset: control_send() of `%s'failed"
argument_list|,
name|args
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|nrom_mourn
parameter_list|()
block|{
name|unpush_target
argument_list|(
operator|&
name|nrom_ops
argument_list|)
expr_stmt|;
name|generic_mourn_inferior
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Define the target vector. */
end_comment

begin_decl_stmt
name|struct
name|target_ops
name|nrom_ops
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|init_nrom_ops
parameter_list|(
name|void
parameter_list|)
block|{
name|nrom_ops
operator|.
name|to_shortname
operator|=
literal|"nrom"
expr_stmt|;
name|nrom_ops
operator|.
name|to_longname
operator|=
literal|"Remote XDI `NetROM' target"
expr_stmt|;
name|nrom_ops
operator|.
name|to_doc
operator|=
literal|"Remote debug using a NetROM over Ethernet"
expr_stmt|;
name|nrom_ops
operator|.
name|to_open
operator|=
name|nrom_open
expr_stmt|;
name|nrom_ops
operator|.
name|to_close
operator|=
name|nrom_close
expr_stmt|;
name|nrom_ops
operator|.
name|to_attach
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_post_attach
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_require_attach
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_detach
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_require_detach
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_resume
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_wait
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_post_wait
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_fetch_registers
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_store_registers
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_prepare_to_store
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_xfer_memory
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_files_info
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_insert_breakpoint
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_remove_breakpoint
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_terminal_init
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_terminal_inferior
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_terminal_ours_for_output
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_terminal_ours
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_terminal_info
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_kill
operator|=
name|nrom_kill
expr_stmt|;
name|nrom_ops
operator|.
name|to_load
operator|=
name|nrom_load
expr_stmt|;
name|nrom_ops
operator|.
name|to_lookup_symbol
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_create_inferior
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_post_startup_inferior
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_acknowledge_created_inferior
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_clone_and_follow_inferior
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_post_follow_inferior_by_clone
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_insert_fork_catchpoint
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_remove_fork_catchpoint
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_insert_vfork_catchpoint
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_remove_vfork_catchpoint
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_has_forked
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_has_vforked
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_can_follow_vfork_prior_to_exec
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_post_follow_vfork
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_insert_exec_catchpoint
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_remove_exec_catchpoint
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_has_execd
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_reported_exec_events_per_exec_call
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_has_exited
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_mourn_inferior
operator|=
name|nrom_mourn
expr_stmt|;
name|nrom_ops
operator|.
name|to_can_run
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_notice_signals
operator|=
literal|0
expr_stmt|;
name|nrom_ops
operator|.
name|to_thread_alive
operator|=
literal|0
expr_stmt|;
name|nrom_ops
operator|.
name|to_stop
operator|=
literal|0
expr_stmt|;
name|nrom_ops
operator|.
name|to_pid_to_exec_file
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_core_file_to_sym_file
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_stratum
operator|=
name|download_stratum
expr_stmt|;
name|nrom_ops
operator|.
name|DONT_USE
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_has_all_memory
operator|=
literal|1
expr_stmt|;
name|nrom_ops
operator|.
name|to_has_memory
operator|=
literal|1
expr_stmt|;
name|nrom_ops
operator|.
name|to_has_stack
operator|=
literal|1
expr_stmt|;
name|nrom_ops
operator|.
name|to_has_registers
operator|=
literal|1
expr_stmt|;
name|nrom_ops
operator|.
name|to_has_execution
operator|=
literal|0
expr_stmt|;
name|nrom_ops
operator|.
name|to_sections
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_sections_end
operator|=
name|NULL
expr_stmt|;
name|nrom_ops
operator|.
name|to_magic
operator|=
name|OPS_MAGIC
expr_stmt|;
block|}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_function
name|void
name|_initialize_remote_nrom
parameter_list|()
block|{
name|init_nrom_ops
argument_list|()
expr_stmt|;
name|add_target
argument_list|(
operator|&
name|nrom_ops
argument_list|)
expr_stmt|;
name|add_show_from_set
argument_list|(
name|add_set_cmd
argument_list|(
literal|"nrom_load_port"
argument_list|,
name|no_class
argument_list|,
name|var_zinteger
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|load_port
argument_list|,
literal|"Set the port to use for NetROM downloads\n"
argument_list|,
operator|&
name|setlist
argument_list|)
argument_list|,
operator|&
name|showlist
argument_list|)
expr_stmt|;
name|add_show_from_set
argument_list|(
name|add_set_cmd
argument_list|(
literal|"nrom_control_port"
argument_list|,
name|no_class
argument_list|,
name|var_zinteger
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|control_port
argument_list|,
literal|"Set the port to use for NetROM debugger services\n"
argument_list|,
operator|&
name|setlist
argument_list|)
argument_list|,
operator|&
name|showlist
argument_list|)
expr_stmt|;
name|add_cmd
argument_list|(
literal|"nrom"
argument_list|,
name|no_class
argument_list|,
name|nrom_passthru
argument_list|,
literal|"Pass arguments as command to NetROM"
argument_list|,
operator|&
name|cmdlist
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


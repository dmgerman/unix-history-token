begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Remote serial interface for local (hardwired) serial ports for Macintosh.    Copyright 1994 Free Software Foundation, Inc.    Contributed by Cygnus Support.  Written by Stan Shebs.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"serial.h"
end_include

begin_include
include|#
directive|include
file|<Types.h>
end_include

begin_include
include|#
directive|include
file|<Devices.h>
end_include

begin_comment
comment|/* This is the regular Mac Serial.h, but copied to a different name    so as not to get confused with the GDB serial.h above.  */
end_comment

begin_include
include|#
directive|include
file|"MacSerial.h"
end_include

begin_comment
comment|/* This is unused for now.  We just return a placeholder. */
end_comment

begin_struct
struct|struct
name|mac_ttystate
block|{
name|int
name|bogus
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|int
name|mac_open
name|PARAMS
argument_list|(
operator|(
name|serial_t
name|scb
operator|,
specifier|const
name|char
operator|*
name|name
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|mac_raw
name|PARAMS
argument_list|(
operator|(
name|serial_t
name|scb
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|mac_readchar
name|PARAMS
argument_list|(
operator|(
name|serial_t
name|scb
operator|,
name|int
name|timeout
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|mac_setbaudrate
name|PARAMS
argument_list|(
operator|(
name|serial_t
name|scb
operator|,
name|int
name|rate
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|mac_write
name|PARAMS
argument_list|(
operator|(
name|serial_t
name|scb
operator|,
specifier|const
name|char
operator|*
name|str
operator|,
name|int
name|len
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|mac_close
name|PARAMS
argument_list|(
operator|(
name|serial_t
name|scb
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|serial_ttystate
name|mac_get_tty_state
name|PARAMS
argument_list|(
operator|(
name|serial_t
name|scb
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|mac_set_tty_state
name|PARAMS
argument_list|(
operator|(
name|serial_t
name|scb
operator|,
name|serial_ttystate
name|state
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|aptr
name|PARAMS
argument_list|(
operator|(
name|short
name|p
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|input_refnum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|output_refnum
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|mac_input_buffer
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|mac_output_buffer
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mac_open
parameter_list|(
name|scb
parameter_list|,
name|name
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
block|{
name|OSErr
name|err
decl_stmt|;
comment|/* Alloc buffer space first - that way any allocation failures are      intercepted before the serial driver gets involved. */
if|if
condition|(
name|mac_input_buffer
operator|==
name|NULL
condition|)
name|mac_input_buffer
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
literal|4096
argument_list|)
expr_stmt|;
comment|/* Match on a name and open a port. */
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"modem"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|err
operator|=
name|OpenDriver
argument_list|(
literal|"\p.AIn"
argument_list|,
operator|&
name|input_refnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|err
operator|=
name|OpenDriver
argument_list|(
literal|"\p.AOut"
argument_list|,
operator|&
name|output_refnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|CloseDriver
argument_list|(
name|input_refnum
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|name
argument_list|,
literal|"printer"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|err
operator|=
name|OpenDriver
argument_list|(
literal|"\p.BIn"
argument_list|,
operator|&
name|input_refnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|err
operator|=
name|OpenDriver
argument_list|(
literal|"\p.BOut"
argument_list|,
operator|&
name|output_refnum
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|!=
literal|0
condition|)
block|{
name|CloseDriver
argument_list|(
name|input_refnum
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* fake */
name|scb
operator|->
name|fd
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
else|else
block|{
name|error
argument_list|(
literal|"You must specify a valid serial port name; your choices are `modem' or `printer'."
argument_list|)
expr_stmt|;
name|errno
operator|=
name|ENOENT
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* We got something open. */
if|if
condition|(
literal|1
comment|/* using custom buffer */
condition|)
name|SerSetBuf
argument_list|(
name|input_refnum
argument_list|,
name|mac_input_buffer
argument_list|,
literal|4096
argument_list|)
expr_stmt|;
comment|/* Set to a GDB-preferred state. */
name|SerReset
argument_list|(
name|input_refnum
argument_list|,
name|stop10
operator||
name|noParity
operator||
name|data8
operator||
name|baud9600
argument_list|)
expr_stmt|;
name|SerReset
argument_list|(
name|output_refnum
argument_list|,
name|stop10
operator||
name|noParity
operator||
name|data8
operator||
name|baud9600
argument_list|)
expr_stmt|;
block|{
name|CntrlParam
name|cb
decl_stmt|;
name|struct
name|SerShk
modifier|*
name|handshake
decl_stmt|;
name|cb
operator|.
name|ioCRefNum
operator|=
name|output_refnum
expr_stmt|;
name|cb
operator|.
name|csCode
operator|=
literal|14
expr_stmt|;
name|handshake
operator|=
operator|(
expr|struct
name|SerShk
operator|*
operator|)
operator|&
name|cb
operator|.
name|csParam
index|[
literal|0
index|]
expr_stmt|;
name|handshake
operator|->
name|fXOn
operator|=
literal|0
expr_stmt|;
name|handshake
operator|->
name|fCTS
operator|=
literal|0
expr_stmt|;
name|handshake
operator|->
name|xOn
operator|=
literal|0
expr_stmt|;
name|handshake
operator|->
name|xOff
operator|=
literal|0
expr_stmt|;
name|handshake
operator|->
name|errs
operator|=
literal|0
expr_stmt|;
name|handshake
operator|->
name|evts
operator|=
literal|0
expr_stmt|;
name|handshake
operator|->
name|fInX
operator|=
literal|0
expr_stmt|;
name|handshake
operator|->
name|fDTR
operator|=
literal|0
expr_stmt|;
name|err
operator|=
name|PBControl
argument_list|(
operator|(
name|ParmBlkPtr
operator|)
operator|&
name|cb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
comment|/* fake */
name|scb
operator|->
name|fd
operator|=
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mac_noop
parameter_list|(
name|scb
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mac_raw
parameter_list|(
name|scb
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
block|{
comment|/* Always effectively in raw mode. */
block|}
end_function

begin_comment
comment|/* Read a character with user-specified timeout.  TIMEOUT is number of seconds    to wait, or -1 to wait forever.  Use timeout of 0 to effect a poll.  Returns    char if successful.  Returns -2 if timeout expired, EOF if line dropped    dead, or -3 for any other error (see errno in that case). */
end_comment

begin_function
specifier|static
name|int
name|mac_readchar
parameter_list|(
name|scb
parameter_list|,
name|timeout
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
name|int
name|timeout
decl_stmt|;
block|{
name|int
name|status
decl_stmt|,
name|n
decl_stmt|;
comment|/* time_t */
name|unsigned
name|long
name|start_time
decl_stmt|,
name|now
decl_stmt|;
name|OSErr
name|err
decl_stmt|;
name|CntrlParam
name|cb
decl_stmt|;
name|IOParam
name|pb
decl_stmt|;
if|if
condition|(
name|scb
operator|->
name|bufcnt
operator|--
operator|>
literal|0
condition|)
return|return
operator|*
name|scb
operator|->
name|bufp
operator|++
return|;
name|time
argument_list|(
operator|&
name|start_time
argument_list|)
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|cb
operator|.
name|ioCRefNum
operator|=
name|input_refnum
expr_stmt|;
name|cb
operator|.
name|csCode
operator|=
literal|2
expr_stmt|;
name|err
operator|=
name|PBStatus
argument_list|(
operator|(
name|ParmBlkPtr
operator|)
operator|&
name|cb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
return|return
name|SERIAL_ERROR
return|;
name|n
operator|=
operator|*
operator|(
operator|(
name|long
operator|*
operator|)
operator|&
name|cb
operator|.
name|csParam
index|[
literal|0
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|0
condition|)
block|{
name|pb
operator|.
name|ioRefNum
operator|=
name|input_refnum
expr_stmt|;
name|pb
operator|.
name|ioBuffer
operator|=
call|(
name|Ptr
call|)
argument_list|(
name|scb
operator|->
name|buf
argument_list|)
expr_stmt|;
name|pb
operator|.
name|ioReqCount
operator|=
operator|(
name|n
operator|>
literal|64
condition|?
literal|64
else|:
name|n
operator|)
expr_stmt|;
name|err
operator|=
name|PBRead
argument_list|(
operator|(
name|ParmBlkPtr
operator|)
operator|&
name|pb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
return|return
name|SERIAL_ERROR
return|;
name|scb
operator|->
name|bufcnt
operator|=
name|pb
operator|.
name|ioReqCount
expr_stmt|;
name|scb
operator|->
name|bufcnt
operator|--
expr_stmt|;
name|scb
operator|->
name|bufp
operator|=
name|scb
operator|->
name|buf
expr_stmt|;
return|return
operator|*
name|scb
operator|->
name|bufp
operator|++
return|;
block|}
elseif|else
if|if
condition|(
name|timeout
operator|==
literal|0
condition|)
return|return
name|SERIAL_TIMEOUT
return|;
elseif|else
if|if
condition|(
name|timeout
operator|==
operator|-
literal|1
condition|)
empty_stmt|;
else|else
block|{
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|now
operator|>
name|start_time
operator|+
name|timeout
condition|)
return|return
name|SERIAL_TIMEOUT
return|;
block|}
name|PROGRESS
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* mac_{get set}_tty_state() are both dummys to fill out the function    vector.  Someday, they may do something real... */
end_comment

begin_function
specifier|static
name|serial_ttystate
name|mac_get_tty_state
parameter_list|(
name|scb
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
block|{
name|struct
name|mac_ttystate
modifier|*
name|state
decl_stmt|;
name|state
operator|=
operator|(
expr|struct
name|mac_ttystate
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
expr|*
name|state
argument_list|)
expr_stmt|;
return|return
operator|(
name|serial_ttystate
operator|)
name|state
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mac_set_tty_state
parameter_list|(
name|scb
parameter_list|,
name|ttystate
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
name|serial_ttystate
name|ttystate
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|mac_noflush_set_tty_state
parameter_list|(
name|scb
parameter_list|,
name|new_ttystate
parameter_list|,
name|old_ttystate
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
name|serial_ttystate
name|new_ttystate
decl_stmt|;
name|serial_ttystate
name|old_ttystate
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mac_print_tty_state
parameter_list|(
name|scb
parameter_list|,
name|ttystate
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
name|serial_ttystate
name|ttystate
decl_stmt|;
block|{
comment|/* Nothing to print.  */
return|return;
block|}
end_function

begin_comment
comment|/* If there is a tricky formula to relate real baud rates    to what the serial driver wants, we should use it.  Until    we get one, this table will have to do.  */
end_comment

begin_struct
specifier|static
struct|struct
block|{
name|int
name|real_rate
decl_stmt|;
name|int
name|bits
decl_stmt|;
block|}
name|mac_baud_rate_table
index|[]
init|=
block|{
block|{
literal|57600
block|,
name|baud57600
block|}
block|,
block|{
literal|38400
block|,
literal|1
block|}
block|,
block|{
literal|19200
block|,
name|baud19200
block|}
block|,
block|{
literal|9600
block|,
name|baud9600
block|}
block|,
block|{
literal|7200
block|,
name|baud7200
block|}
block|,
block|{
literal|4800
block|,
name|baud4800
block|}
block|,
block|{
literal|3600
block|,
name|baud3600
block|}
block|,
block|{
literal|2400
block|,
name|baud2400
block|}
block|,
block|{
literal|1800
block|,
name|baud1800
block|}
block|,
block|{
literal|1200
block|,
name|baud1200
block|}
block|,
block|{
literal|600
block|,
name|baud600
block|}
block|,
block|{
literal|300
block|,
name|baud300
block|}
block|,
block|{
literal|0
block|,
literal|0
block|}
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|mac_set_baud_rate
parameter_list|(
name|scb
parameter_list|,
name|rate
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
name|int
name|rate
decl_stmt|;
block|{
name|int
name|i
decl_stmt|,
name|bits
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|mac_baud_rate_table
index|[
name|i
index|]
operator|.
name|real_rate
operator|!=
literal|0
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|mac_baud_rate_table
index|[
name|i
index|]
operator|.
name|real_rate
operator|==
name|rate
condition|)
block|{
name|bits
operator|=
name|mac_baud_rate_table
index|[
name|i
index|]
operator|.
name|bits
expr_stmt|;
break|break;
block|}
block|}
name|SerReset
argument_list|(
name|input_refnum
argument_list|,
name|stop10
operator||
name|noParity
operator||
name|data8
operator||
name|bits
argument_list|)
expr_stmt|;
name|SerReset
argument_list|(
name|output_refnum
argument_list|,
name|stop10
operator||
name|noParity
operator||
name|data8
operator||
name|bits
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|mac_set_stop_bits
parameter_list|(
name|scb
parameter_list|,
name|num
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
name|int
name|num
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_decl_stmt
name|int
name|first_mac_write
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|mac_write
parameter_list|(
name|scb
parameter_list|,
name|str
parameter_list|,
name|len
parameter_list|)
name|serial_t
name|scb
decl_stmt|;
specifier|const
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
name|OSErr
name|err
decl_stmt|;
name|IOParam
name|pb
decl_stmt|;
if|if
condition|(
name|first_mac_write
operator|++
operator|<
literal|4
condition|)
block|{
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|pb
operator|.
name|ioRefNum
operator|=
name|output_refnum
expr_stmt|;
name|pb
operator|.
name|ioBuffer
operator|=
operator|(
name|Ptr
operator|)
name|str
expr_stmt|;
name|pb
operator|.
name|ioReqCount
operator|=
name|len
expr_stmt|;
name|err
operator|=
name|PBWrite
argument_list|(
operator|(
name|ParmBlkPtr
operator|)
operator|&
name|pb
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|err
operator|<
literal|0
condition|)
block|{
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|mac_close
parameter_list|(
name|serial_t
name|scb
parameter_list|)
block|{
if|if
condition|(
name|input_refnum
condition|)
block|{
if|if
condition|(
literal|1
comment|/* custom buffer */
condition|)
name|SerSetBuf
argument_list|(
name|input_refnum
argument_list|,
name|mac_input_buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CloseDriver
argument_list|(
name|input_refnum
argument_list|)
expr_stmt|;
name|input_refnum
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|output_refnum
condition|)
block|{
if|if
condition|(
literal|0
comment|/* custom buffer */
condition|)
name|SetSetBuf
argument_list|(
name|input_refnum
argument_list|,
name|mac_output_buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|CloseDriver
argument_list|(
name|output_refnum
argument_list|)
expr_stmt|;
name|output_refnum
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_decl_stmt
specifier|static
name|struct
name|serial_ops
name|mac_ops
init|=
block|{
literal|"hardwire"
block|,
literal|0
block|,
name|mac_open
block|,
name|mac_close
block|,
name|mac_readchar
block|,
name|mac_write
block|,
name|mac_noop
block|,
comment|/* flush output */
name|mac_noop
block|,
comment|/* flush input */
name|mac_noop
block|,
comment|/* send break -- currently only for nindy */
name|mac_raw
block|,
name|mac_get_tty_state
block|,
name|mac_set_tty_state
block|,
name|mac_print_tty_state
block|,
name|mac_noflush_set_tty_state
block|,
name|mac_set_baud_rate
block|,
name|mac_set_stop_bits
block|, }
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|_initialize_ser_mac
parameter_list|()
block|{
name|serial_add_interface
argument_list|(
operator|&
name|mac_ops
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


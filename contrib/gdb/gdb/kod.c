begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Kernel Object Display generic routines and callbacks    Copyright 1998, 1999, 2000 Free Software Foundation, Inc.     Written by Fernando Nasser<fnasser@cygnus.com> for Cygnus Solutions.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"command.h"
end_include

begin_include
include|#
directive|include
file|"gdbcmd.h"
end_include

begin_include
include|#
directive|include
file|"target.h"
end_include

begin_include
include|#
directive|include
file|"gdb_string.h"
end_include

begin_include
include|#
directive|include
file|"kod.h"
end_include

begin_comment
comment|/* Prototypes for exported functions.  */
end_comment

begin_function_decl
name|void
name|_initialize_kod
parameter_list|(
name|void
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Prototypes for local functions.  */
end_comment

begin_function_decl
specifier|static
name|void
name|info_kod_command
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|load_kod_library
parameter_list|(
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Prototypes for callbacks.  These are passed into the KOD modules.  */
end_comment

begin_function_decl
specifier|static
name|void
name|gdb_kod_display
parameter_list|(
name|char
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|gdb_kod_query
parameter_list|(
name|char
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|int
modifier|*
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* These functions are imported from the KOD module.        gdb_kod_open - initiates the KOD connection to the remote.  The    first argument is the display function the module should use to    communicate with the user.  The second argument is the query    function the display should use to communicate with the target.    This should call error() if there is an error.  Otherwise it should    return a malloc()d string of the form:        NAME VERSION - DESCRIPTION        Neither NAME nor VERSION should contain a hyphen.         gdb_kod_request - This is used when the user enters an "info<module>" request.  The remaining arguments are passed as the first    argument.  The second argument is the standard `from_tty'    argument.         gdb_kod_close - This is called when the KOD connection to the    remote should be terminated.  */
end_comment

begin_function_decl
specifier|static
name|char
modifier|*
function_decl|(
modifier|*
name|gdb_kod_open
function_decl|)
parameter_list|(
name|kod_display_callback_ftype
modifier|*
name|display
parameter_list|,
name|kod_query_callback_ftype
modifier|*
name|query
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
function_decl|(
modifier|*
name|gdb_kod_request
function_decl|)
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
function_decl|(
modifier|*
name|gdb_kod_close
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* Name of inferior's operating system.  */
end_comment

begin_decl_stmt
name|char
modifier|*
name|operating_system
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* We save a copy of the OS so that we can properly reset when    switching OS's.  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|old_operating_system
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Print a line of data generated by the module.  */
end_comment

begin_function
specifier|static
name|void
name|gdb_kod_display
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|)
block|{
name|printf_filtered
argument_list|(
literal|"%s"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Queries the target on behalf of the module.  */
end_comment

begin_function
specifier|static
name|void
name|gdb_kod_query
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|,
name|char
modifier|*
name|result
parameter_list|,
name|int
modifier|*
name|maxsiz
parameter_list|)
block|{
name|LONGEST
name|bufsiz
init|=
literal|0
decl_stmt|;
comment|/* Check if current target has remote_query capabilities.  If not,      it does not have kod either.  */
name|bufsiz
operator|=
name|target_read_partial
argument_list|(
operator|&
name|current_target
argument_list|,
name|TARGET_OBJECT_KOD
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|bufsiz
operator|<
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|result
argument_list|,
literal|"ERR: Kernel Object Display not supported by current target\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Just get the maximum buffer size.  */
comment|/* Check if *we* were called just for getting the buffer size.  */
if|if
condition|(
operator|*
name|maxsiz
operator|==
literal|0
condition|)
block|{
operator|*
name|maxsiz
operator|=
name|bufsiz
expr_stmt|;
name|strcpy
argument_list|(
name|result
argument_list|,
literal|"OK"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Check if caller can handle a buffer this large, if not, adjust.  */
if|if
condition|(
name|bufsiz
operator|>
operator|*
name|maxsiz
condition|)
name|bufsiz
operator|=
operator|*
name|maxsiz
expr_stmt|;
comment|/* See if buffer can hold the query (usually it can, as the query is      short).  */
if|if
condition|(
name|strlen
argument_list|(
name|arg
argument_list|)
operator|>=
name|bufsiz
condition|)
name|error
argument_list|(
literal|"kod: query argument too long"
argument_list|)
expr_stmt|;
comment|/* Send actual request.  */
if|if
condition|(
name|target_read_partial
argument_list|(
operator|&
name|current_target
argument_list|,
name|TARGET_OBJECT_KOD
argument_list|,
name|arg
argument_list|,
name|result
argument_list|,
literal|0
argument_list|,
name|bufsiz
argument_list|)
operator|<
literal|0
condition|)
name|strcpy
argument_list|(
name|result
argument_list|,
literal|"ERR: remote query failed"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Print name of kod command after selecting the appropriate kod    formatting library module.  As a side effect we create a new "info"    subcommand which is what the user actually uses to query the OS.  */
end_comment

begin_function
specifier|static
name|void
name|kod_set_os
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|from_tty
parameter_list|,
name|struct
name|cmd_list_element
modifier|*
name|command
parameter_list|)
block|{
name|char
modifier|*
name|p
decl_stmt|;
comment|/* NOTE: cagney/2002-03-17: The add_show_from_set() function clones      the set command passed as a parameter.  The clone operation will      include (BUG?) any ``set'' command callback, if present.      Commands like ``info set'' call all the ``show'' command      callbacks.  Unfortunately, for ``show'' commands cloned from      ``set'', this includes callbacks belonging to ``set'' commands.      Making this worse, this only occures if add_show_from_set() is      called after add_cmd_sfunc() (BUG?).  */
if|if
condition|(
name|cmd_type
argument_list|(
name|command
argument_list|)
operator|!=
name|set_cmd
condition|)
return|return;
comment|/* If we had already had an open OS, close it.  */
if|if
condition|(
name|gdb_kod_close
condition|)
call|(
modifier|*
name|gdb_kod_close
call|)
argument_list|()
expr_stmt|;
comment|/* Also remove the old OS's command.  */
if|if
condition|(
name|old_operating_system
condition|)
block|{
name|delete_cmd
argument_list|(
name|old_operating_system
argument_list|,
operator|&
name|infolist
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|old_operating_system
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|operating_system
operator|||
operator|!
operator|*
name|operating_system
condition|)
block|{
comment|/* If user set operating system to empty, we want to forget we 	 had a module open.  Setting these variables is just nice for 	 debugging and clarity.  */
name|gdb_kod_open
operator|=
name|NULL
expr_stmt|;
name|gdb_kod_request
operator|=
name|NULL
expr_stmt|;
name|gdb_kod_close
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|char
modifier|*
name|kodlib
decl_stmt|;
name|old_operating_system
operator|=
name|xstrdup
argument_list|(
name|operating_system
argument_list|)
expr_stmt|;
name|load_kod_library
argument_list|(
name|operating_system
argument_list|)
expr_stmt|;
name|kodlib
operator|=
call|(
modifier|*
name|gdb_kod_open
call|)
argument_list|(
name|gdb_kod_display
argument_list|,
name|gdb_kod_query
argument_list|)
expr_stmt|;
comment|/* Add kod related info commands to gdb.  */
name|add_info
argument_list|(
name|operating_system
argument_list|,
name|info_kod_command
argument_list|,
literal|"Displays information about Kernel Objects."
argument_list|)
expr_stmt|;
name|p
operator|=
name|strrchr
argument_list|(
name|kodlib
argument_list|,
literal|'-'
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
name|p
operator|++
expr_stmt|;
else|else
name|p
operator|=
literal|"Unknown KOD library"
expr_stmt|;
name|printf_filtered
argument_list|(
literal|"%s - %s\n"
argument_list|,
name|operating_system
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|kodlib
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Print information about currently known kernel objects of the    specified type or a list of all known kernel object types if    argument is empty.  */
end_comment

begin_function
specifier|static
name|void
name|info_kod_command
parameter_list|(
name|char
modifier|*
name|arg
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
call|(
modifier|*
name|gdb_kod_request
call|)
argument_list|(
name|arg
argument_list|,
name|from_tty
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Print name of kod command after selecting the appropriate kod    formatting library module.  */
end_comment

begin_function
specifier|static
name|void
name|load_kod_library
parameter_list|(
name|char
modifier|*
name|lib
parameter_list|)
block|{
if|#
directive|if
literal|0
comment|/* FIXME: Don't have the eCos code here.  */
block|if (! strcmp (lib, "ecos"))     {       gdb_kod_open = ecos_kod_open;       gdb_kod_request = ecos_kod_request;       gdb_kod_close = ecos_kod_close;     }   else
endif|#
directive|endif
comment|/* 0 */
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|lib
argument_list|,
literal|"cisco"
argument_list|)
condition|)
block|{
name|gdb_kod_open
operator|=
name|cisco_kod_open
expr_stmt|;
name|gdb_kod_request
operator|=
name|cisco_kod_request
expr_stmt|;
name|gdb_kod_close
operator|=
name|cisco_kod_close
expr_stmt|;
block|}
else|else
name|error
argument_list|(
literal|"Unknown operating system: %s\n"
argument_list|,
name|operating_system
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|_initialize_kod
parameter_list|(
name|void
parameter_list|)
block|{
name|struct
name|cmd_list_element
modifier|*
name|c
decl_stmt|;
name|c
operator|=
name|add_set_cmd
argument_list|(
literal|"os"
argument_list|,
name|no_class
argument_list|,
name|var_string
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|operating_system
argument_list|,
literal|"Set operating system"
argument_list|,
operator|&
name|setlist
argument_list|)
expr_stmt|;
name|set_cmd_sfunc
argument_list|(
name|c
argument_list|,
name|kod_set_os
argument_list|)
expr_stmt|;
name|add_show_from_set
argument_list|(
name|c
argument_list|,
operator|&
name|showlist
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


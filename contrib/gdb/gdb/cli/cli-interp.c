begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* CLI Definitions for GDB, the GNU debugger.     Copyright 2002, 2003 Free Software Foundation, Inc.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"interps.h"
end_include

begin_include
include|#
directive|include
file|"wrapper.h"
end_include

begin_include
include|#
directive|include
file|"event-top.h"
end_include

begin_include
include|#
directive|include
file|"ui-out.h"
end_include

begin_include
include|#
directive|include
file|"cli-out.h"
end_include

begin_include
include|#
directive|include
file|"top.h"
end_include

begin_comment
comment|/* for "execute_command" */
end_comment

begin_include
include|#
directive|include
file|"gdb_string.h"
end_include

begin_decl_stmt
name|struct
name|ui_out
modifier|*
name|cli_uiout
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* These are the ui_out and the interpreter for the console interpreter. */
end_comment

begin_comment
comment|/* Longjmp-safe wrapper for "execute_command" */
end_comment

begin_function_decl
specifier|static
name|int
name|do_captured_execute_command
parameter_list|(
name|struct
name|ui_out
modifier|*
name|uiout
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|enum
name|gdb_rc
name|safe_execute_command
parameter_list|(
name|struct
name|ui_out
modifier|*
name|uiout
parameter_list|,
name|char
modifier|*
name|command
parameter_list|,
name|int
name|from_tty
parameter_list|)
function_decl|;
end_function_decl

begin_struct
struct|struct
name|captured_execute_command_args
block|{
name|char
modifier|*
name|command
decl_stmt|;
name|int
name|from_tty
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* These implement the cli out interpreter: */
end_comment

begin_function
specifier|static
name|void
modifier|*
name|cli_interpreter_init
parameter_list|(
name|void
parameter_list|)
block|{
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cli_interpreter_resume
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|ui_file
modifier|*
name|stream
decl_stmt|;
comment|/*sync_execution = 1; */
comment|/* gdb_setup_readline will change gdb_stdout.  If the CLI was previously      writing to gdb_stdout, then set it to the new gdb_stdout afterwards.  */
name|stream
operator|=
name|cli_out_set_stream
argument_list|(
name|cli_uiout
argument_list|,
name|gdb_stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|stream
operator|!=
name|gdb_stdout
condition|)
block|{
name|cli_out_set_stream
argument_list|(
name|cli_uiout
argument_list|,
name|stream
argument_list|)
expr_stmt|;
name|stream
operator|=
name|NULL
expr_stmt|;
block|}
name|gdb_setup_readline
argument_list|()
expr_stmt|;
if|if
condition|(
name|stream
operator|!=
name|NULL
condition|)
name|cli_out_set_stream
argument_list|(
name|cli_uiout
argument_list|,
name|gdb_stdout
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cli_interpreter_suspend
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
name|gdb_disable_readline
argument_list|()
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_comment
comment|/* Don't display the prompt if we are set quiet.  */
end_comment

begin_function
specifier|static
name|int
name|cli_interpreter_display_prompt_p
parameter_list|(
name|void
modifier|*
name|data
parameter_list|)
block|{
if|if
condition|(
name|interp_quiet_p
argument_list|(
name|NULL
argument_list|)
condition|)
return|return
literal|0
return|;
else|else
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|cli_interpreter_exec
parameter_list|(
name|void
modifier|*
name|data
parameter_list|,
specifier|const
name|char
modifier|*
name|command_str
parameter_list|)
block|{
name|int
name|result
decl_stmt|;
name|struct
name|ui_file
modifier|*
name|old_stream
decl_stmt|;
comment|/* FIXME: cagney/2003-02-01: Need to const char *propogate      safe_execute_command.  */
name|char
modifier|*
name|str
init|=
name|strcpy
argument_list|(
name|alloca
argument_list|(
name|strlen
argument_list|(
name|command_str
argument_list|)
operator|+
literal|1
argument_list|)
argument_list|,
name|command_str
argument_list|)
decl_stmt|;
comment|/* gdb_stdout could change between the time cli_uiout was initialized      and now. Since we're probably using a different interpreter which has      a new ui_file for gdb_stdout, use that one instead of the default.       It is important that it gets reset everytime, since the user could      set gdb to use a different interpreter. */
name|old_stream
operator|=
name|cli_out_set_stream
argument_list|(
name|cli_uiout
argument_list|,
name|gdb_stdout
argument_list|)
expr_stmt|;
name|result
operator|=
name|safe_execute_command
argument_list|(
name|cli_uiout
argument_list|,
name|str
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|cli_out_set_stream
argument_list|(
name|cli_uiout
argument_list|,
name|old_stream
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|do_captured_execute_command
parameter_list|(
name|struct
name|ui_out
modifier|*
name|uiout
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|captured_execute_command_args
modifier|*
name|args
init|=
operator|(
expr|struct
name|captured_execute_command_args
operator|*
operator|)
name|data
decl_stmt|;
name|execute_command
argument_list|(
name|args
operator|->
name|command
argument_list|,
name|args
operator|->
name|from_tty
argument_list|)
expr_stmt|;
return|return
name|GDB_RC_OK
return|;
block|}
end_function

begin_function
specifier|static
name|enum
name|gdb_rc
name|safe_execute_command
parameter_list|(
name|struct
name|ui_out
modifier|*
name|uiout
parameter_list|,
name|char
modifier|*
name|command
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
name|struct
name|captured_execute_command_args
name|args
decl_stmt|;
name|args
operator|.
name|command
operator|=
name|command
expr_stmt|;
name|args
operator|.
name|from_tty
operator|=
name|from_tty
expr_stmt|;
return|return
name|catch_exceptions
argument_list|(
name|uiout
argument_list|,
name|do_captured_execute_command
argument_list|,
operator|&
name|args
argument_list|,
name|NULL
argument_list|,
name|RETURN_MASK_ALL
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* standard gdb initialization hook */
end_comment

begin_decl_stmt
specifier|extern
name|initialize_file_ftype
name|_initialize_cli_interp
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* -Wmissing-prototypes */
end_comment

begin_function
name|void
name|_initialize_cli_interp
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
specifier|const
name|struct
name|interp_procs
name|procs
init|=
block|{
name|cli_interpreter_init
block|,
comment|/* init_proc */
name|cli_interpreter_resume
block|,
comment|/* resume_proc */
name|cli_interpreter_suspend
block|,
comment|/* suspend_proc */
name|cli_interpreter_exec
block|,
comment|/* exec_proc */
name|cli_interpreter_display_prompt_p
comment|/* prompt_proc_p */
block|}
decl_stmt|;
name|struct
name|interp
modifier|*
name|cli_interp
decl_stmt|;
comment|/* Create a default uiout builder for the CLI. */
name|cli_uiout
operator|=
name|cli_out_new
argument_list|(
name|gdb_stdout
argument_list|)
expr_stmt|;
name|cli_interp
operator|=
name|interp_new
argument_list|(
name|INTERP_CONSOLE
argument_list|,
name|NULL
argument_list|,
name|cli_uiout
argument_list|,
operator|&
name|procs
argument_list|)
expr_stmt|;
name|interp_add
argument_list|(
name|cli_interp
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


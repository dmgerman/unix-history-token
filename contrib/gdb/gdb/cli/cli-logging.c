begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Command-line output logging for GDB, the GNU debugger.     Copyright 2003    Free Software Foundation, Inc.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"gdbcmd.h"
end_include

begin_include
include|#
directive|include
file|"ui-out.h"
end_include

begin_include
include|#
directive|include
file|"gdb_string.h"
end_include

begin_comment
comment|/* These hold the pushed copies of the gdb output files.    If NULL then nothing has yet been pushed.  */
end_comment

begin_struct
struct|struct
name|saved_output_files
block|{
name|struct
name|ui_file
modifier|*
name|out
decl_stmt|;
name|struct
name|ui_file
modifier|*
name|err
decl_stmt|;
name|struct
name|ui_file
modifier|*
name|log
decl_stmt|;
name|struct
name|ui_file
modifier|*
name|targ
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|struct
name|saved_output_files
name|saved_output
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|saved_filename
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|logging_filename
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|logging_overwrite
decl_stmt|,
name|logging_redirect
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* If we've pushed output files, close them and pop them.  */
end_comment

begin_function
specifier|static
name|void
name|pop_output_files
parameter_list|(
name|void
parameter_list|)
block|{
comment|/* Only delete one of the files -- they are all set to the same      value.  */
name|ui_file_delete
argument_list|(
name|gdb_stdout
argument_list|)
expr_stmt|;
name|gdb_stdout
operator|=
name|saved_output
operator|.
name|out
expr_stmt|;
name|gdb_stderr
operator|=
name|saved_output
operator|.
name|err
expr_stmt|;
name|gdb_stdlog
operator|=
name|saved_output
operator|.
name|log
expr_stmt|;
name|gdb_stdtarg
operator|=
name|saved_output
operator|.
name|targ
expr_stmt|;
name|saved_output
operator|.
name|out
operator|=
name|NULL
expr_stmt|;
name|saved_output
operator|.
name|err
operator|=
name|NULL
expr_stmt|;
name|saved_output
operator|.
name|log
operator|=
name|NULL
expr_stmt|;
name|saved_output
operator|.
name|targ
operator|=
name|NULL
expr_stmt|;
name|ui_out_redirect
argument_list|(
name|uiout
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* This is a helper for the `set logging' command.  */
end_comment

begin_function
specifier|static
name|void
name|handle_redirections
parameter_list|(
name|int
name|from_tty
parameter_list|)
block|{
name|struct
name|ui_file
modifier|*
name|output
decl_stmt|;
if|if
condition|(
name|saved_filename
operator|!=
name|NULL
condition|)
block|{
name|fprintf_unfiltered
argument_list|(
name|gdb_stdout
argument_list|,
literal|"Already logging to %s.\n"
argument_list|,
name|saved_filename
argument_list|)
expr_stmt|;
return|return;
block|}
name|output
operator|=
name|gdb_fopen
argument_list|(
name|logging_filename
argument_list|,
name|logging_overwrite
condition|?
literal|"w"
else|:
literal|"a"
argument_list|)
expr_stmt|;
if|if
condition|(
name|output
operator|==
name|NULL
condition|)
name|perror_with_name
argument_list|(
literal|"set logging"
argument_list|)
expr_stmt|;
comment|/* Redirects everything to gdb_stdout while this is running.  */
if|if
condition|(
operator|!
name|logging_redirect
condition|)
block|{
name|output
operator|=
name|tee_file_new
argument_list|(
name|gdb_stdout
argument_list|,
literal|0
argument_list|,
name|output
argument_list|,
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|output
operator|==
name|NULL
condition|)
name|perror_with_name
argument_list|(
literal|"set logging"
argument_list|)
expr_stmt|;
if|if
condition|(
name|from_tty
condition|)
name|fprintf_unfiltered
argument_list|(
name|gdb_stdout
argument_list|,
literal|"Copying output to %s.\n"
argument_list|,
name|logging_filename
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|from_tty
condition|)
name|fprintf_unfiltered
argument_list|(
name|gdb_stdout
argument_list|,
literal|"Redirecting output to %s.\n"
argument_list|,
name|logging_filename
argument_list|)
expr_stmt|;
name|saved_filename
operator|=
name|xstrdup
argument_list|(
name|logging_filename
argument_list|)
expr_stmt|;
name|saved_output
operator|.
name|out
operator|=
name|gdb_stdout
expr_stmt|;
name|saved_output
operator|.
name|err
operator|=
name|gdb_stderr
expr_stmt|;
name|saved_output
operator|.
name|log
operator|=
name|gdb_stdlog
expr_stmt|;
name|saved_output
operator|.
name|targ
operator|=
name|gdb_stdtarg
expr_stmt|;
name|gdb_stdout
operator|=
name|output
expr_stmt|;
name|gdb_stderr
operator|=
name|output
expr_stmt|;
name|gdb_stdlog
operator|=
name|output
expr_stmt|;
name|gdb_stdtarg
operator|=
name|output
expr_stmt|;
if|if
condition|(
name|ui_out_redirect
argument_list|(
name|uiout
argument_list|,
name|gdb_stdout
argument_list|)
operator|<
literal|0
condition|)
name|warning
argument_list|(
literal|"Current output protocol does not support redirection"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_logging_on
parameter_list|(
name|char
modifier|*
name|args
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
name|char
modifier|*
name|rest
init|=
name|args
decl_stmt|;
if|if
condition|(
name|rest
operator|&&
operator|*
name|rest
condition|)
block|{
name|xfree
argument_list|(
name|logging_filename
argument_list|)
expr_stmt|;
name|logging_filename
operator|=
name|xstrdup
argument_list|(
name|rest
argument_list|)
expr_stmt|;
block|}
name|handle_redirections
argument_list|(
name|from_tty
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_logging_off
parameter_list|(
name|char
modifier|*
name|args
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
if|if
condition|(
name|saved_filename
operator|==
name|NULL
condition|)
return|return;
name|pop_output_files
argument_list|()
expr_stmt|;
if|if
condition|(
name|from_tty
condition|)
name|fprintf_unfiltered
argument_list|(
name|gdb_stdout
argument_list|,
literal|"Done logging to %s.\n"
argument_list|,
name|saved_filename
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|saved_filename
argument_list|)
expr_stmt|;
name|saved_filename
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_logging_command
parameter_list|(
name|char
modifier|*
name|args
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
name|printf_unfiltered
argument_list|(
literal|"\"set logging\" lets you log output to a file.\n"
argument_list|)
expr_stmt|;
name|printf_unfiltered
argument_list|(
literal|"Usage: set logging on [FILENAME]\n"
argument_list|)
expr_stmt|;
name|printf_unfiltered
argument_list|(
literal|"       set logging off\n"
argument_list|)
expr_stmt|;
name|printf_unfiltered
argument_list|(
literal|"       set logging file FILENAME\n"
argument_list|)
expr_stmt|;
name|printf_unfiltered
argument_list|(
literal|"       set logging overwrite [on|off]\n"
argument_list|)
expr_stmt|;
name|printf_unfiltered
argument_list|(
literal|"       set logging redirect [on|off]\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|show_logging_command
parameter_list|(
name|char
modifier|*
name|args
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
if|if
condition|(
name|saved_filename
condition|)
name|printf_unfiltered
argument_list|(
literal|"Currently logging to \"%s\".\n"
argument_list|,
name|saved_filename
argument_list|)
expr_stmt|;
if|if
condition|(
name|saved_filename
operator|==
name|NULL
operator|||
name|strcmp
argument_list|(
name|logging_filename
argument_list|,
name|saved_filename
argument_list|)
operator|!=
literal|0
condition|)
name|printf_unfiltered
argument_list|(
literal|"Future logs will be written to %s.\n"
argument_list|,
name|logging_filename
argument_list|)
expr_stmt|;
if|if
condition|(
name|logging_overwrite
condition|)
name|printf_unfiltered
argument_list|(
literal|"Logs will overwrite the log file.\n"
argument_list|)
expr_stmt|;
else|else
name|printf_unfiltered
argument_list|(
literal|"Logs will be appended to the log file.\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|logging_redirect
condition|)
name|printf_unfiltered
argument_list|(
literal|"Output will be sent only to the log file.\n"
argument_list|)
expr_stmt|;
else|else
name|printf_unfiltered
argument_list|(
literal|"Output will be logged and displayed.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|_initialize_cli_logging
parameter_list|(
name|void
parameter_list|)
block|{
specifier|static
name|struct
name|cmd_list_element
modifier|*
name|set_logging_cmdlist
decl_stmt|,
modifier|*
name|show_logging_cmdlist
decl_stmt|;
name|add_prefix_cmd
argument_list|(
literal|"logging"
argument_list|,
name|class_support
argument_list|,
name|set_logging_command
argument_list|,
literal|"Set logging options"
argument_list|,
operator|&
name|set_logging_cmdlist
argument_list|,
literal|"set logging "
argument_list|,
literal|0
argument_list|,
operator|&
name|setlist
argument_list|)
expr_stmt|;
name|add_prefix_cmd
argument_list|(
literal|"logging"
argument_list|,
name|class_support
argument_list|,
name|show_logging_command
argument_list|,
literal|"Show logging options"
argument_list|,
operator|&
name|show_logging_cmdlist
argument_list|,
literal|"show logging "
argument_list|,
literal|0
argument_list|,
operator|&
name|showlist
argument_list|)
expr_stmt|;
name|add_setshow_boolean_cmd
argument_list|(
literal|"overwrite"
argument_list|,
name|class_support
argument_list|,
operator|&
name|logging_overwrite
argument_list|,
literal|"Set whether logging overwrites or appends "
literal|"to the log file.\n"
argument_list|,
literal|"Show whether logging overwrites or appends "
literal|"to the log file.\n"
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|set_logging_cmdlist
argument_list|,
operator|&
name|show_logging_cmdlist
argument_list|)
expr_stmt|;
name|add_setshow_boolean_cmd
argument_list|(
literal|"redirect"
argument_list|,
name|class_support
argument_list|,
operator|&
name|logging_redirect
argument_list|,
literal|"Set the logging output mode.\n"
literal|"If redirect is off, output will go to both the "
literal|"screen and the log file.\n"
literal|"If redirect is on, output will go only to the log "
literal|"file."
argument_list|,
literal|"Show the logging output mode.\n"
literal|"If redirect is off, output will go to both the "
literal|"screen and the log file.\n"
literal|"If redirect is on, output will go only to the log "
literal|"file."
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|set_logging_cmdlist
argument_list|,
operator|&
name|show_logging_cmdlist
argument_list|)
expr_stmt|;
name|add_setshow_cmd
argument_list|(
literal|"file"
argument_list|,
name|class_support
argument_list|,
name|var_filename
argument_list|,
operator|&
name|logging_filename
argument_list|,
literal|"Set the current logfile."
argument_list|,
literal|"Show the current logfile."
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|set_logging_cmdlist
argument_list|,
operator|&
name|show_logging_cmdlist
argument_list|)
expr_stmt|;
name|add_cmd
argument_list|(
literal|"on"
argument_list|,
name|class_support
argument_list|,
name|set_logging_on
argument_list|,
literal|"Enable logging."
argument_list|,
operator|&
name|set_logging_cmdlist
argument_list|)
expr_stmt|;
name|add_cmd
argument_list|(
literal|"off"
argument_list|,
name|class_support
argument_list|,
name|set_logging_off
argument_list|,
literal|"Disable logging."
argument_list|,
operator|&
name|set_logging_cmdlist
argument_list|)
expr_stmt|;
name|logging_filename
operator|=
name|xstrdup
argument_list|(
literal|"gdb.txt"
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


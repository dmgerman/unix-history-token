begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Remote File-I/O communications     Copyright 2003 Free Software Foundation, Inc.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_comment
comment|/* See the GDB User Guide for details of the GDB remote protocol. */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"gdb_string.h"
end_include

begin_include
include|#
directive|include
file|"gdbcmd.h"
end_include

begin_include
include|#
directive|include
file|"remote.h"
end_include

begin_include
include|#
directive|include
file|"gdb/fileio.h"
end_include

begin_include
include|#
directive|include
file|"gdb_wait.h"
end_include

begin_include
include|#
directive|include
file|"gdb_stat.h"
end_include

begin_include
include|#
directive|include
file|"remote-fileio.h"
end_include

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|__CYGWIN__
end_ifdef

begin_include
include|#
directive|include
file|<sys/cygwin.h>
end_include

begin_comment
comment|/* For cygwin_conv_to_full_posix_path.  */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<signal.h>
end_include

begin_struct
specifier|static
struct|struct
block|{
name|int
modifier|*
name|fd_map
decl_stmt|;
name|int
name|fd_map_size
decl_stmt|;
block|}
name|remote_fio_data
struct|;
end_struct

begin_define
define|#
directive|define
name|FIO_FD_INVALID
value|-1
end_define

begin_define
define|#
directive|define
name|FIO_FD_CONSOLE_IN
value|-2
end_define

begin_define
define|#
directive|define
name|FIO_FD_CONSOLE_OUT
value|-3
end_define

begin_decl_stmt
specifier|static
name|int
name|remote_fio_system_call_allowed
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|remote_fileio_init_fd_map
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|remote_fio_data
operator|.
name|fd_map
condition|)
block|{
name|remote_fio_data
operator|.
name|fd_map
operator|=
operator|(
name|int
operator|*
operator|)
name|xmalloc
argument_list|(
literal|10
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|remote_fio_data
operator|.
name|fd_map_size
operator|=
literal|10
expr_stmt|;
name|remote_fio_data
operator|.
name|fd_map
index|[
literal|0
index|]
operator|=
name|FIO_FD_CONSOLE_IN
expr_stmt|;
name|remote_fio_data
operator|.
name|fd_map
index|[
literal|1
index|]
operator|=
name|FIO_FD_CONSOLE_OUT
expr_stmt|;
name|remote_fio_data
operator|.
name|fd_map
index|[
literal|2
index|]
operator|=
name|FIO_FD_CONSOLE_OUT
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|3
init|;
name|i
operator|<
literal|10
condition|;
operator|++
name|i
control|)
name|remote_fio_data
operator|.
name|fd_map
index|[
name|i
index|]
operator|=
name|FIO_FD_INVALID
expr_stmt|;
block|}
return|return
literal|3
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|remote_fileio_resize_fd_map
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
operator|!
name|remote_fio_data
operator|.
name|fd_map
condition|)
return|return
name|remote_fileio_init_fd_map
argument_list|()
return|;
name|remote_fio_data
operator|.
name|fd_map_size
operator|+=
literal|10
expr_stmt|;
name|remote_fio_data
operator|.
name|fd_map
operator|=
operator|(
name|int
operator|*
operator|)
name|xrealloc
argument_list|(
name|remote_fio_data
operator|.
name|fd_map
argument_list|,
name|remote_fio_data
operator|.
name|fd_map_size
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|remote_fio_data
operator|.
name|fd_map_size
operator|-
literal|10
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|remote_fileio_next_free_fd
parameter_list|(
name|void
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|remote_fio_data
operator|.
name|fd_map_size
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|remote_fio_data
operator|.
name|fd_map
index|[
name|i
index|]
operator|==
name|FIO_FD_INVALID
condition|)
return|return
name|i
return|;
return|return
name|remote_fileio_resize_fd_map
argument_list|()
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|remote_fileio_fd_to_targetfd
parameter_list|(
name|int
name|fd
parameter_list|)
block|{
name|int
name|target_fd
init|=
name|remote_fileio_next_free_fd
argument_list|()
decl_stmt|;
name|remote_fio_data
operator|.
name|fd_map
index|[
name|target_fd
index|]
operator|=
name|fd
expr_stmt|;
return|return
name|target_fd
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|remote_fileio_map_fd
parameter_list|(
name|int
name|target_fd
parameter_list|)
block|{
name|remote_fileio_init_fd_map
argument_list|()
expr_stmt|;
if|if
condition|(
name|target_fd
operator|<
literal|0
operator|||
name|target_fd
operator|>=
name|remote_fio_data
operator|.
name|fd_map_size
condition|)
return|return
name|FIO_FD_INVALID
return|;
return|return
name|remote_fio_data
operator|.
name|fd_map
index|[
name|target_fd
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_close_target_fd
parameter_list|(
name|int
name|target_fd
parameter_list|)
block|{
name|remote_fileio_init_fd_map
argument_list|()
expr_stmt|;
if|if
condition|(
name|target_fd
operator|>=
literal|0
operator|&&
name|target_fd
operator|<
name|remote_fio_data
operator|.
name|fd_map_size
condition|)
name|remote_fio_data
operator|.
name|fd_map
index|[
name|target_fd
index|]
operator|=
name|FIO_FD_INVALID
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|remote_fileio_oflags_to_host
parameter_list|(
name|long
name|flags
parameter_list|)
block|{
name|int
name|hflags
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|flags
operator|&
name|FILEIO_O_CREAT
condition|)
name|hflags
operator||=
name|O_CREAT
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|FILEIO_O_EXCL
condition|)
name|hflags
operator||=
name|O_EXCL
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|FILEIO_O_TRUNC
condition|)
name|hflags
operator||=
name|O_TRUNC
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|FILEIO_O_APPEND
condition|)
name|hflags
operator||=
name|O_APPEND
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|FILEIO_O_RDONLY
condition|)
name|hflags
operator||=
name|O_RDONLY
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|FILEIO_O_WRONLY
condition|)
name|hflags
operator||=
name|O_WRONLY
expr_stmt|;
if|if
condition|(
name|flags
operator|&
name|FILEIO_O_RDWR
condition|)
name|hflags
operator||=
name|O_RDWR
expr_stmt|;
comment|/* On systems supporting binary and text mode, always open files in    binary mode. */
ifdef|#
directive|ifdef
name|O_BINARY
name|hflags
operator||=
name|O_BINARY
expr_stmt|;
endif|#
directive|endif
return|return
name|hflags
return|;
block|}
end_function

begin_function
specifier|static
name|mode_t
name|remote_fileio_mode_to_host
parameter_list|(
name|long
name|mode
parameter_list|,
name|int
name|open_call
parameter_list|)
block|{
name|mode_t
name|hmode
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|open_call
condition|)
block|{
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IFREG
condition|)
name|hmode
operator||=
name|S_IFREG
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IFDIR
condition|)
name|hmode
operator||=
name|S_IFDIR
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IFCHR
condition|)
name|hmode
operator||=
name|S_IFCHR
expr_stmt|;
block|}
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IRUSR
condition|)
name|hmode
operator||=
name|S_IRUSR
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IWUSR
condition|)
name|hmode
operator||=
name|S_IWUSR
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IXUSR
condition|)
name|hmode
operator||=
name|S_IXUSR
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IRGRP
condition|)
name|hmode
operator||=
name|S_IRGRP
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IWGRP
condition|)
name|hmode
operator||=
name|S_IWGRP
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IXGRP
condition|)
name|hmode
operator||=
name|S_IXGRP
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IROTH
condition|)
name|hmode
operator||=
name|S_IROTH
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IWOTH
condition|)
name|hmode
operator||=
name|S_IWOTH
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|FILEIO_S_IXOTH
condition|)
name|hmode
operator||=
name|S_IXOTH
expr_stmt|;
return|return
name|hmode
return|;
block|}
end_function

begin_function
specifier|static
name|LONGEST
name|remote_fileio_mode_to_target
parameter_list|(
name|mode_t
name|mode
parameter_list|)
block|{
name|mode_t
name|tmode
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IFREG
condition|)
name|tmode
operator||=
name|FILEIO_S_IFREG
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IFDIR
condition|)
name|tmode
operator||=
name|FILEIO_S_IFDIR
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IFCHR
condition|)
name|tmode
operator||=
name|FILEIO_S_IFCHR
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IRUSR
condition|)
name|tmode
operator||=
name|FILEIO_S_IRUSR
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IWUSR
condition|)
name|tmode
operator||=
name|FILEIO_S_IWUSR
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IXUSR
condition|)
name|tmode
operator||=
name|FILEIO_S_IXUSR
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IRGRP
condition|)
name|tmode
operator||=
name|FILEIO_S_IRGRP
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IWGRP
condition|)
name|tmode
operator||=
name|FILEIO_S_IWGRP
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IXGRP
condition|)
name|tmode
operator||=
name|FILEIO_S_IXGRP
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IROTH
condition|)
name|tmode
operator||=
name|FILEIO_S_IROTH
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IWOTH
condition|)
name|tmode
operator||=
name|FILEIO_S_IWOTH
expr_stmt|;
if|if
condition|(
name|mode
operator|&
name|S_IXOTH
condition|)
name|tmode
operator||=
name|FILEIO_S_IXOTH
expr_stmt|;
return|return
name|tmode
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|remote_fileio_errno_to_target
parameter_list|(
name|int
name|error
parameter_list|)
block|{
switch|switch
condition|(
name|error
condition|)
block|{
case|case
name|EPERM
case|:
return|return
name|FILEIO_EPERM
return|;
case|case
name|ENOENT
case|:
return|return
name|FILEIO_ENOENT
return|;
case|case
name|EINTR
case|:
return|return
name|FILEIO_EINTR
return|;
case|case
name|EIO
case|:
return|return
name|FILEIO_EIO
return|;
case|case
name|EBADF
case|:
return|return
name|FILEIO_EBADF
return|;
case|case
name|EACCES
case|:
return|return
name|FILEIO_EACCES
return|;
case|case
name|EFAULT
case|:
return|return
name|FILEIO_EFAULT
return|;
case|case
name|EBUSY
case|:
return|return
name|FILEIO_EBUSY
return|;
case|case
name|EEXIST
case|:
return|return
name|FILEIO_EEXIST
return|;
case|case
name|ENODEV
case|:
return|return
name|FILEIO_ENODEV
return|;
case|case
name|ENOTDIR
case|:
return|return
name|FILEIO_ENOTDIR
return|;
case|case
name|EISDIR
case|:
return|return
name|FILEIO_EISDIR
return|;
case|case
name|EINVAL
case|:
return|return
name|FILEIO_EINVAL
return|;
case|case
name|ENFILE
case|:
return|return
name|FILEIO_ENFILE
return|;
case|case
name|EMFILE
case|:
return|return
name|FILEIO_EMFILE
return|;
case|case
name|EFBIG
case|:
return|return
name|FILEIO_EFBIG
return|;
case|case
name|ENOSPC
case|:
return|return
name|FILEIO_ENOSPC
return|;
case|case
name|ESPIPE
case|:
return|return
name|FILEIO_ESPIPE
return|;
case|case
name|EROFS
case|:
return|return
name|FILEIO_EROFS
return|;
case|case
name|ENOSYS
case|:
return|return
name|FILEIO_ENOSYS
return|;
case|case
name|ENAMETOOLONG
case|:
return|return
name|FILEIO_ENAMETOOLONG
return|;
block|}
return|return
name|FILEIO_EUNKNOWN
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|remote_fileio_seek_flag_to_host
parameter_list|(
name|long
name|num
parameter_list|,
name|int
modifier|*
name|flag
parameter_list|)
block|{
if|if
condition|(
operator|!
name|flag
condition|)
return|return
literal|0
return|;
switch|switch
condition|(
name|num
condition|)
block|{
case|case
name|FILEIO_SEEK_SET
case|:
operator|*
name|flag
operator|=
name|SEEK_SET
expr_stmt|;
break|break;
case|case
name|FILEIO_SEEK_CUR
case|:
operator|*
name|flag
operator|=
name|SEEK_CUR
expr_stmt|;
break|break;
case|case
name|FILEIO_SEEK_END
case|:
operator|*
name|flag
operator|=
name|SEEK_END
expr_stmt|;
break|break;
default|default:
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|remote_fileio_extract_long
parameter_list|(
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|LONGEST
modifier|*
name|retlong
parameter_list|)
block|{
name|char
modifier|*
name|c
decl_stmt|;
name|int
name|sign
init|=
literal|1
decl_stmt|;
if|if
condition|(
operator|!
name|buf
operator|||
operator|!
operator|*
name|buf
operator|||
operator|!
operator|*
operator|*
name|buf
operator|||
operator|!
name|retlong
condition|)
return|return
operator|-
literal|1
return|;
name|c
operator|=
name|strchr
argument_list|(
operator|*
name|buf
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
condition|)
operator|*
name|c
operator|++
operator|=
literal|'\0'
expr_stmt|;
else|else
name|c
operator|=
name|strchr
argument_list|(
operator|*
name|buf
argument_list|,
literal|'\0'
argument_list|)
expr_stmt|;
while|while
condition|(
name|strchr
argument_list|(
literal|"+-"
argument_list|,
operator|*
operator|*
name|buf
argument_list|)
condition|)
block|{
if|if
condition|(
operator|*
operator|*
name|buf
operator|==
literal|'-'
condition|)
name|sign
operator|=
operator|-
name|sign
expr_stmt|;
operator|++
operator|*
name|buf
expr_stmt|;
block|}
for|for
control|(
operator|*
name|retlong
operator|=
literal|0
init|;
operator|*
operator|*
name|buf
condition|;
operator|++
operator|*
name|buf
control|)
block|{
operator|*
name|retlong
operator|<<=
literal|4
expr_stmt|;
if|if
condition|(
operator|*
operator|*
name|buf
operator|>=
literal|'0'
operator|&&
operator|*
operator|*
name|buf
operator|<=
literal|'9'
condition|)
operator|*
name|retlong
operator|+=
operator|*
operator|*
name|buf
operator|-
literal|'0'
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|*
name|buf
operator|>=
literal|'a'
operator|&&
operator|*
operator|*
name|buf
operator|<=
literal|'f'
condition|)
operator|*
name|retlong
operator|+=
operator|*
operator|*
name|buf
operator|-
literal|'a'
operator|+
literal|10
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
operator|*
name|buf
operator|>=
literal|'A'
operator|&&
operator|*
operator|*
name|buf
operator|<=
literal|'F'
condition|)
operator|*
name|retlong
operator|+=
operator|*
operator|*
name|buf
operator|-
literal|'A'
operator|+
literal|10
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
block|}
operator|*
name|retlong
operator|*=
name|sign
expr_stmt|;
operator|*
name|buf
operator|=
name|c
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|remote_fileio_extract_int
parameter_list|(
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|long
modifier|*
name|retint
parameter_list|)
block|{
name|int
name|ret
decl_stmt|;
name|LONGEST
name|retlong
decl_stmt|;
if|if
condition|(
operator|!
name|retint
condition|)
return|return
operator|-
literal|1
return|;
name|ret
operator|=
name|remote_fileio_extract_long
argument_list|(
name|buf
argument_list|,
operator|&
name|retlong
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
operator|*
name|retint
operator|=
operator|(
name|long
operator|)
name|retlong
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|remote_fileio_extract_ptr_w_len
parameter_list|(
name|char
modifier|*
modifier|*
name|buf
parameter_list|,
name|CORE_ADDR
modifier|*
name|ptrval
parameter_list|,
name|int
modifier|*
name|length
parameter_list|)
block|{
name|char
modifier|*
name|c
decl_stmt|;
name|LONGEST
name|retlong
decl_stmt|;
if|if
condition|(
operator|!
name|buf
operator|||
operator|!
operator|*
name|buf
operator|||
operator|!
operator|*
operator|*
name|buf
operator|||
operator|!
name|ptrval
operator|||
operator|!
name|length
condition|)
return|return
operator|-
literal|1
return|;
name|c
operator|=
name|strchr
argument_list|(
operator|*
name|buf
argument_list|,
literal|'/'
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|c
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|c
operator|++
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|remote_fileio_extract_long
argument_list|(
name|buf
argument_list|,
operator|&
name|retlong
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|ptrval
operator|=
operator|(
name|CORE_ADDR
operator|)
name|retlong
expr_stmt|;
operator|*
name|buf
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|remote_fileio_extract_long
argument_list|(
name|buf
argument_list|,
operator|&
name|retlong
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
operator|*
name|length
operator|=
operator|(
name|int
operator|)
name|retlong
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Convert to big endian */
end_comment

begin_function
specifier|static
name|void
name|remote_fileio_to_be
parameter_list|(
name|LONGEST
name|num
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|bytes
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|bytes
condition|;
operator|++
name|i
control|)
name|buf
index|[
name|i
index|]
operator|=
operator|(
name|num
operator|>>
operator|(
literal|8
operator|*
operator|(
name|bytes
operator|-
name|i
operator|-
literal|1
operator|)
operator|)
operator|)
operator|&
literal|0xff
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_to_fio_uint
parameter_list|(
name|long
name|num
parameter_list|,
name|fio_uint_t
name|fnum
parameter_list|)
block|{
name|remote_fileio_to_be
argument_list|(
operator|(
name|LONGEST
operator|)
name|num
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fnum
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_to_fio_mode
parameter_list|(
name|mode_t
name|num
parameter_list|,
name|fio_mode_t
name|fnum
parameter_list|)
block|{
name|remote_fileio_to_be
argument_list|(
name|remote_fileio_mode_to_target
argument_list|(
name|num
argument_list|)
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fnum
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_to_fio_time
parameter_list|(
name|time_t
name|num
parameter_list|,
name|fio_time_t
name|fnum
parameter_list|)
block|{
name|remote_fileio_to_be
argument_list|(
operator|(
name|LONGEST
operator|)
name|num
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fnum
argument_list|,
literal|4
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_to_fio_long
parameter_list|(
name|LONGEST
name|num
parameter_list|,
name|fio_long_t
name|fnum
parameter_list|)
block|{
name|remote_fileio_to_be
argument_list|(
name|num
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fnum
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_to_fio_ulong
parameter_list|(
name|LONGEST
name|num
parameter_list|,
name|fio_ulong_t
name|fnum
parameter_list|)
block|{
name|remote_fileio_to_be
argument_list|(
name|num
argument_list|,
operator|(
name|char
operator|*
operator|)
name|fnum
argument_list|,
literal|8
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_to_fio_stat
parameter_list|(
name|struct
name|stat
modifier|*
name|st
parameter_list|,
name|struct
name|fio_stat
modifier|*
name|fst
parameter_list|)
block|{
comment|/* `st_dev' is set in the calling function */
name|remote_fileio_to_fio_uint
argument_list|(
operator|(
name|long
operator|)
name|st
operator|->
name|st_ino
argument_list|,
name|fst
operator|->
name|fst_ino
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_mode
argument_list|(
name|st
operator|->
name|st_mode
argument_list|,
name|fst
operator|->
name|fst_mode
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_uint
argument_list|(
operator|(
name|long
operator|)
name|st
operator|->
name|st_nlink
argument_list|,
name|fst
operator|->
name|fst_nlink
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_uint
argument_list|(
operator|(
name|long
operator|)
name|st
operator|->
name|st_uid
argument_list|,
name|fst
operator|->
name|fst_uid
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_uint
argument_list|(
operator|(
name|long
operator|)
name|st
operator|->
name|st_gid
argument_list|,
name|fst
operator|->
name|fst_gid
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_uint
argument_list|(
operator|(
name|long
operator|)
name|st
operator|->
name|st_rdev
argument_list|,
name|fst
operator|->
name|fst_rdev
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_ulong
argument_list|(
operator|(
name|LONGEST
operator|)
name|st
operator|->
name|st_size
argument_list|,
name|fst
operator|->
name|fst_size
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_ulong
argument_list|(
operator|(
name|LONGEST
operator|)
name|st
operator|->
name|st_blksize
argument_list|,
name|fst
operator|->
name|fst_blksize
argument_list|)
expr_stmt|;
if|#
directive|if
name|HAVE_STRUCT_STAT_ST_BLOCKS
name|remote_fileio_to_fio_ulong
argument_list|(
operator|(
name|LONGEST
operator|)
name|st
operator|->
name|st_blocks
argument_list|,
name|fst
operator|->
name|fst_blocks
argument_list|)
expr_stmt|;
else|#
directive|else
comment|/* FIXME: This is correct for DJGPP, but other systems that don't      have st_blocks, if any, might prefer 512 instead of st_blksize.      (eliz, 30-12-2003)  */
name|remote_fileio_to_fio_ulong
argument_list|(
operator|(
operator|(
name|LONGEST
operator|)
name|st
operator|->
name|st_size
operator|+
name|st
operator|->
name|st_blksize
operator|-
literal|1
operator|)
operator|/
operator|(
name|LONGEST
operator|)
name|st
operator|->
name|st_blksize
argument_list|,
name|fst
operator|->
name|fst_blocks
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|remote_fileio_to_fio_time
argument_list|(
name|st
operator|->
name|st_atime
argument_list|,
name|fst
operator|->
name|fst_atime
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_time
argument_list|(
name|st
operator|->
name|st_mtime
argument_list|,
name|fst
operator|->
name|fst_mtime
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_time
argument_list|(
name|st
operator|->
name|st_ctime
argument_list|,
name|fst
operator|->
name|fst_ctime
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_to_fio_timeval
parameter_list|(
name|struct
name|timeval
modifier|*
name|tv
parameter_list|,
name|struct
name|fio_timeval
modifier|*
name|ftv
parameter_list|)
block|{
name|remote_fileio_to_fio_time
argument_list|(
name|tv
operator|->
name|tv_sec
argument_list|,
name|ftv
operator|->
name|ftv_sec
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_long
argument_list|(
name|tv
operator|->
name|tv_usec
argument_list|,
name|ftv
operator|->
name|ftv_usec
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|remote_fio_ctrl_c_flag
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|remote_fio_no_longjmp
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_if
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SIGACTION
argument_list|)
operator|&&
name|defined
argument_list|(
name|SA_RESTART
argument_list|)
end_if

begin_decl_stmt
specifier|static
name|struct
name|sigaction
name|remote_fio_sa
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|sigaction
name|remote_fio_osa
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_function_decl
specifier|static
name|void
function_decl|(
modifier|*
name|remote_fio_ofunc
function_decl|)
parameter_list|(
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
name|void
name|remote_fileio_sig_init
parameter_list|(
name|void
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SIGACTION
argument_list|)
operator|&&
name|defined
argument_list|(
name|SA_RESTART
argument_list|)
name|remote_fio_sa
operator|.
name|sa_handler
operator|=
name|SIG_IGN
expr_stmt|;
name|sigemptyset
argument_list|(
operator|&
name|remote_fio_sa
operator|.
name|sa_mask
argument_list|)
expr_stmt|;
name|remote_fio_sa
operator|.
name|sa_flags
operator|=
literal|0
expr_stmt|;
name|sigaction
argument_list|(
name|SIGINT
argument_list|,
operator|&
name|remote_fio_sa
argument_list|,
operator|&
name|remote_fio_osa
argument_list|)
expr_stmt|;
else|#
directive|else
name|remote_fio_ofunc
operator|=
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_sig_set
parameter_list|(
name|void
function_decl|(
modifier|*
name|sigint_func
function_decl|)
parameter_list|(
name|int
parameter_list|)
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SIGACTION
argument_list|)
operator|&&
name|defined
argument_list|(
name|SA_RESTART
argument_list|)
name|remote_fio_sa
operator|.
name|sa_handler
operator|=
name|sigint_func
expr_stmt|;
name|sigemptyset
argument_list|(
operator|&
name|remote_fio_sa
operator|.
name|sa_mask
argument_list|)
expr_stmt|;
name|remote_fio_sa
operator|.
name|sa_flags
operator|=
literal|0
expr_stmt|;
name|sigaction
argument_list|(
name|SIGINT
argument_list|,
operator|&
name|remote_fio_sa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|#
directive|else
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|sigint_func
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_sig_exit
parameter_list|(
name|void
parameter_list|)
block|{
if|#
directive|if
name|defined
argument_list|(
name|HAVE_SIGACTION
argument_list|)
operator|&&
name|defined
argument_list|(
name|SA_RESTART
argument_list|)
name|sigaction
argument_list|(
name|SIGINT
argument_list|,
operator|&
name|remote_fio_osa
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
else|#
directive|else
name|signal
argument_list|(
name|SIGINT
argument_list|,
name|remote_fio_ofunc
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_ctrl_c_signal_handler
parameter_list|(
name|int
name|signo
parameter_list|)
block|{
name|remote_fileio_sig_set
argument_list|(
name|SIG_IGN
argument_list|)
expr_stmt|;
name|remote_fio_ctrl_c_flag
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|remote_fio_no_longjmp
condition|)
name|throw_exception
argument_list|(
name|RETURN_QUIT
argument_list|)
expr_stmt|;
name|remote_fileio_sig_set
argument_list|(
name|remote_fileio_ctrl_c_signal_handler
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_reply
parameter_list|(
name|int
name|retcode
parameter_list|,
name|int
name|error
parameter_list|)
block|{
name|char
name|buf
index|[
literal|32
index|]
decl_stmt|;
name|remote_fileio_sig_set
argument_list|(
name|SIG_IGN
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|buf
argument_list|,
literal|"F"
argument_list|)
expr_stmt|;
if|if
condition|(
name|retcode
operator|<
literal|0
condition|)
block|{
name|strcat
argument_list|(
name|buf
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|retcode
operator|=
operator|-
name|retcode
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|"%x"
argument_list|,
name|retcode
argument_list|)
expr_stmt|;
if|if
condition|(
name|error
operator|||
name|remote_fio_ctrl_c_flag
condition|)
block|{
if|if
condition|(
name|error
operator|&&
name|remote_fio_ctrl_c_flag
condition|)
name|error
operator|=
name|FILEIO_EINTR
expr_stmt|;
if|if
condition|(
name|error
operator|<
literal|0
condition|)
block|{
name|strcat
argument_list|(
name|buf
argument_list|,
literal|"-"
argument_list|)
expr_stmt|;
name|error
operator|=
operator|-
name|error
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buf
operator|+
name|strlen
argument_list|(
name|buf
argument_list|)
argument_list|,
literal|",%x"
argument_list|,
name|error
argument_list|)
expr_stmt|;
if|if
condition|(
name|remote_fio_ctrl_c_flag
condition|)
name|strcat
argument_list|(
name|buf
argument_list|,
literal|",C"
argument_list|)
expr_stmt|;
block|}
name|remote_fileio_sig_set
argument_list|(
name|remote_fileio_ctrl_c_signal_handler
argument_list|)
expr_stmt|;
name|putpkt
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_ioerror
parameter_list|(
name|void
parameter_list|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_EIO
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_badfd
parameter_list|(
name|void
parameter_list|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_EBADF
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_return_errno
parameter_list|(
name|int
name|retcode
parameter_list|)
block|{
name|remote_fileio_reply
argument_list|(
name|retcode
argument_list|,
name|retcode
operator|<
literal|0
condition|?
name|remote_fileio_errno_to_target
argument_list|(
name|errno
argument_list|)
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_return_success
parameter_list|(
name|int
name|retcode
parameter_list|)
block|{
name|remote_fileio_reply
argument_list|(
name|retcode
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Wrapper function for remote_write_bytes() which has the disadvantage to    write only one packet, regardless of the requested number of bytes to    transfer.  This wrapper calls remote_write_bytes() as often as needed. */
end_comment

begin_function
specifier|static
name|int
name|remote_fileio_write_bytes
parameter_list|(
name|CORE_ADDR
name|memaddr
parameter_list|,
name|char
modifier|*
name|myaddr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|ret
init|=
literal|0
decl_stmt|,
name|written
decl_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
operator|&&
operator|(
name|written
operator|=
name|remote_write_bytes
argument_list|(
name|memaddr
argument_list|,
name|myaddr
argument_list|,
name|len
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|len
operator|-=
name|written
expr_stmt|;
name|memaddr
operator|+=
name|written
expr_stmt|;
name|myaddr
operator|+=
name|written
expr_stmt|;
name|ret
operator|+=
name|written
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_open
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|CORE_ADDR
name|ptrval
decl_stmt|;
name|int
name|length
decl_stmt|,
name|retlength
decl_stmt|;
name|long
name|num
decl_stmt|;
name|int
name|flags
decl_stmt|,
name|fd
decl_stmt|;
name|mode_t
name|mode
decl_stmt|;
name|char
modifier|*
name|pathname
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
comment|/* 1. Parameter: Ptr to pathname / length incl. trailing zero */
if|if
condition|(
name|remote_fileio_extract_ptr_w_len
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|ptrval
argument_list|,
operator|&
name|length
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* 2. Parameter: open flags */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|num
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|flags
operator|=
name|remote_fileio_oflags_to_host
argument_list|(
name|num
argument_list|)
expr_stmt|;
comment|/* 3. Parameter: open mode */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|num
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|mode
operator|=
name|remote_fileio_mode_to_host
argument_list|(
name|num
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|/* Request pathname using 'm' packet */
name|pathname
operator|=
name|alloca
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|retlength
operator|=
name|remote_read_bytes
argument_list|(
name|ptrval
argument_list|,
name|pathname
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
name|length
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* Check if pathname exists and is not a regular file or directory.  If so,      return an appropriate error code.  Same for trying to open directories      for writing. */
if|if
condition|(
operator|!
name|stat
argument_list|(
name|pathname
argument_list|,
operator|&
name|st
argument_list|)
condition|)
block|{
if|if
condition|(
operator|!
name|S_ISREG
argument_list|(
name|st
operator|.
name|st_mode
argument_list|)
operator|&&
operator|!
name|S_ISDIR
argument_list|(
name|st
operator|.
name|st_mode
argument_list|)
condition|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_ENODEV
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|S_ISDIR
argument_list|(
name|st
operator|.
name|st_mode
argument_list|)
operator|&&
operator|(
operator|(
name|flags
operator|&
name|O_WRONLY
operator|)
operator|==
name|O_WRONLY
operator|||
operator|(
name|flags
operator|&
name|O_RDWR
operator|)
operator|==
name|O_RDWR
operator|)
condition|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_EISDIR
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
name|fd
operator|=
name|open
argument_list|(
name|pathname
argument_list|,
name|flags
argument_list|,
name|mode
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
block|{
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
name|fd
operator|=
name|remote_fileio_fd_to_targetfd
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|remote_fileio_return_success
argument_list|(
name|fd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_close
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|long
name|num
decl_stmt|;
name|int
name|fd
decl_stmt|;
comment|/* Parameter: file descriptor */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|num
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|fd
operator|=
name|remote_fileio_map_fd
argument_list|(
operator|(
name|int
operator|)
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
name|FIO_FD_INVALID
condition|)
block|{
name|remote_fileio_badfd
argument_list|()
expr_stmt|;
return|return;
block|}
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|fd
operator|!=
name|FIO_FD_CONSOLE_IN
operator|&&
name|fd
operator|!=
name|FIO_FD_CONSOLE_OUT
operator|&&
name|close
argument_list|(
name|fd
argument_list|)
condition|)
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
name|remote_fileio_close_target_fd
argument_list|(
operator|(
name|int
operator|)
name|num
argument_list|)
expr_stmt|;
name|remote_fileio_return_success
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_read
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|long
name|target_fd
decl_stmt|,
name|num
decl_stmt|;
name|LONGEST
name|lnum
decl_stmt|;
name|CORE_ADDR
name|ptrval
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|ret
decl_stmt|,
name|retlength
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|size_t
name|length
decl_stmt|;
name|off_t
name|old_offset
decl_stmt|,
name|new_offset
decl_stmt|;
comment|/* 1. Parameter: file descriptor */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|target_fd
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|fd
operator|=
name|remote_fileio_map_fd
argument_list|(
operator|(
name|int
operator|)
name|target_fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
name|FIO_FD_INVALID
condition|)
block|{
name|remote_fileio_badfd
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* 2. Parameter: buffer pointer */
if|if
condition|(
name|remote_fileio_extract_long
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|lnum
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|ptrval
operator|=
operator|(
name|CORE_ADDR
operator|)
name|lnum
expr_stmt|;
comment|/* 3. Parameter: buffer length */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|num
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|length
operator|=
operator|(
name|size_t
operator|)
name|num
expr_stmt|;
switch|switch
condition|(
name|fd
condition|)
block|{
case|case
name|FIO_FD_CONSOLE_OUT
case|:
name|remote_fileio_badfd
argument_list|()
expr_stmt|;
return|return;
case|case
name|FIO_FD_CONSOLE_IN
case|:
block|{
specifier|static
name|char
modifier|*
name|remaining_buf
init|=
name|NULL
decl_stmt|;
specifier|static
name|int
name|remaining_length
init|=
literal|0
decl_stmt|;
name|buffer
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
literal|32768
argument_list|)
expr_stmt|;
if|if
condition|(
name|remaining_buf
condition|)
block|{
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|remaining_length
operator|>
name|length
condition|)
block|{
name|memcpy
argument_list|(
name|buffer
argument_list|,
name|remaining_buf
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|remaining_buf
argument_list|,
name|remaining_buf
operator|+
name|length
argument_list|,
name|remaining_length
operator|-
name|length
argument_list|)
expr_stmt|;
name|remaining_length
operator|-=
name|length
expr_stmt|;
name|ret
operator|=
name|length
expr_stmt|;
block|}
else|else
block|{
name|memcpy
argument_list|(
name|buffer
argument_list|,
name|remaining_buf
argument_list|,
name|remaining_length
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|remaining_buf
argument_list|)
expr_stmt|;
name|remaining_buf
operator|=
name|NULL
expr_stmt|;
name|ret
operator|=
name|remaining_length
expr_stmt|;
block|}
block|}
else|else
block|{
name|ret
operator|=
name|ui_file_read
argument_list|(
name|gdb_stdtargin
argument_list|,
name|buffer
argument_list|,
literal|32767
argument_list|)
expr_stmt|;
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|ret
operator|>
literal|0
operator|&&
operator|(
name|size_t
operator|)
name|ret
operator|>
name|length
condition|)
block|{
name|remaining_buf
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|ret
operator|-
name|length
argument_list|)
expr_stmt|;
name|remaining_length
operator|=
name|ret
operator|-
name|length
expr_stmt|;
name|memcpy
argument_list|(
name|remaining_buf
argument_list|,
name|buffer
operator|+
name|length
argument_list|,
name|remaining_length
argument_list|)
expr_stmt|;
name|ret
operator|=
name|length
expr_stmt|;
block|}
block|}
block|}
break|break;
default|default:
name|buffer
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
comment|/* POSIX defines EINTR behaviour of read in a weird way.  It's allowed 	   for read() to return -1 even if "some" bytes have been read.  It 	   has been corrected in SUSv2 but that doesn't help us much... 	   Therefore a complete solution must check how many bytes have been 	   read on EINTR to return a more reliable value to the target */
name|old_offset
operator|=
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|read
argument_list|(
name|fd
argument_list|,
name|buffer
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EINTR
condition|)
block|{
name|new_offset
operator|=
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0
argument_list|,
name|SEEK_CUR
argument_list|)
expr_stmt|;
comment|/* If some data has been read, return the number of bytes read. 	       The Ctrl-C flag is set in remote_fileio_reply() anyway */
if|if
condition|(
name|old_offset
operator|!=
name|new_offset
condition|)
name|ret
operator|=
name|new_offset
operator|-
name|old_offset
expr_stmt|;
block|}
break|break;
block|}
if|if
condition|(
name|ret
operator|>
literal|0
condition|)
block|{
name|retlength
operator|=
name|remote_fileio_write_bytes
argument_list|(
name|ptrval
argument_list|,
name|buffer
argument_list|,
name|ret
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
name|ret
condition|)
name|ret
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* errno has been set to EIO in remote_fileio_write_bytes() */
block|}
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|remote_fileio_return_success
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_write
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|long
name|target_fd
decl_stmt|,
name|num
decl_stmt|;
name|LONGEST
name|lnum
decl_stmt|;
name|CORE_ADDR
name|ptrval
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|ret
decl_stmt|,
name|retlength
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|size_t
name|length
decl_stmt|;
comment|/* 1. Parameter: file descriptor */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|target_fd
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|fd
operator|=
name|remote_fileio_map_fd
argument_list|(
operator|(
name|int
operator|)
name|target_fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
name|FIO_FD_INVALID
condition|)
block|{
name|remote_fileio_badfd
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* 2. Parameter: buffer pointer */
if|if
condition|(
name|remote_fileio_extract_long
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|lnum
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|ptrval
operator|=
operator|(
name|CORE_ADDR
operator|)
name|lnum
expr_stmt|;
comment|/* 3. Parameter: buffer length */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|num
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|length
operator|=
operator|(
name|size_t
operator|)
name|num
expr_stmt|;
name|buffer
operator|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|retlength
operator|=
name|remote_read_bytes
argument_list|(
name|ptrval
argument_list|,
name|buffer
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
name|length
condition|)
block|{
name|xfree
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
switch|switch
condition|(
name|fd
condition|)
block|{
case|case
name|FIO_FD_CONSOLE_IN
case|:
name|remote_fileio_badfd
argument_list|()
expr_stmt|;
return|return;
case|case
name|FIO_FD_CONSOLE_OUT
case|:
name|ui_file_write
argument_list|(
name|target_fd
operator|==
literal|1
condition|?
name|gdb_stdtarg
else|:
name|gdb_stdtargerr
argument_list|,
name|buffer
argument_list|,
name|length
argument_list|)
expr_stmt|;
name|gdb_flush
argument_list|(
name|target_fd
operator|==
literal|1
condition|?
name|gdb_stdtarg
else|:
name|gdb_stdtargerr
argument_list|)
expr_stmt|;
name|ret
operator|=
name|length
expr_stmt|;
break|break;
default|default:
name|ret
operator|=
name|write
argument_list|(
name|fd
argument_list|,
name|buffer
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
operator|&&
name|errno
operator|==
name|EACCES
condition|)
name|errno
operator|=
name|EBADF
expr_stmt|;
comment|/* Cygwin returns EACCESS when writing to a R/O file.*/
break|break;
block|}
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|remote_fileio_return_success
argument_list|(
name|ret
argument_list|)
expr_stmt|;
name|xfree
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_lseek
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|long
name|num
decl_stmt|;
name|LONGEST
name|lnum
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|flag
decl_stmt|;
name|off_t
name|offset
decl_stmt|,
name|ret
decl_stmt|;
comment|/* 1. Parameter: file descriptor */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|num
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|fd
operator|=
name|remote_fileio_map_fd
argument_list|(
operator|(
name|int
operator|)
name|num
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
name|FIO_FD_INVALID
condition|)
block|{
name|remote_fileio_badfd
argument_list|()
expr_stmt|;
return|return;
block|}
elseif|else
if|if
condition|(
name|fd
operator|==
name|FIO_FD_CONSOLE_IN
operator|||
name|fd
operator|==
name|FIO_FD_CONSOLE_OUT
condition|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_ESPIPE
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* 2. Parameter: offset */
if|if
condition|(
name|remote_fileio_extract_long
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|lnum
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|offset
operator|=
operator|(
name|off_t
operator|)
name|lnum
expr_stmt|;
comment|/* 3. Parameter: flag */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|num
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|remote_fileio_seek_flag_to_host
argument_list|(
name|num
argument_list|,
operator|&
name|flag
argument_list|)
condition|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_EINVAL
argument_list|)
expr_stmt|;
return|return;
block|}
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|lseek
argument_list|(
name|fd
argument_list|,
name|offset
argument_list|,
name|flag
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|(
name|off_t
operator|)
operator|-
literal|1
condition|)
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|remote_fileio_return_success
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_rename
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|CORE_ADDR
name|ptrval
decl_stmt|;
name|int
name|length
decl_stmt|,
name|retlength
decl_stmt|;
name|char
modifier|*
name|oldpath
decl_stmt|,
modifier|*
name|newpath
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|of
decl_stmt|,
name|nf
decl_stmt|;
name|struct
name|stat
name|ost
decl_stmt|,
name|nst
decl_stmt|;
comment|/* 1. Parameter: Ptr to oldpath / length incl. trailing zero */
if|if
condition|(
name|remote_fileio_extract_ptr_w_len
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|ptrval
argument_list|,
operator|&
name|length
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* Request oldpath using 'm' packet */
name|oldpath
operator|=
name|alloca
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|retlength
operator|=
name|remote_read_bytes
argument_list|(
name|ptrval
argument_list|,
name|oldpath
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
name|length
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* 2. Parameter: Ptr to newpath / length incl. trailing zero */
if|if
condition|(
name|remote_fileio_extract_ptr_w_len
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|ptrval
argument_list|,
operator|&
name|length
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* Request newpath using 'm' packet */
name|newpath
operator|=
name|alloca
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|retlength
operator|=
name|remote_read_bytes
argument_list|(
name|ptrval
argument_list|,
name|newpath
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
name|length
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* Only operate on regular files and directories */
name|of
operator|=
name|stat
argument_list|(
name|oldpath
argument_list|,
operator|&
name|ost
argument_list|)
expr_stmt|;
name|nf
operator|=
name|stat
argument_list|(
name|newpath
argument_list|,
operator|&
name|nst
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|!
name|of
operator|&&
operator|!
name|S_ISREG
argument_list|(
name|ost
operator|.
name|st_mode
argument_list|)
operator|&&
operator|!
name|S_ISDIR
argument_list|(
name|ost
operator|.
name|st_mode
argument_list|)
operator|)
operator|||
operator|(
operator|!
name|nf
operator|&&
operator|!
name|S_ISREG
argument_list|(
name|nst
operator|.
name|st_mode
argument_list|)
operator|&&
operator|!
name|S_ISDIR
argument_list|(
name|nst
operator|.
name|st_mode
argument_list|)
operator|)
condition|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_EACCES
argument_list|)
expr_stmt|;
return|return;
block|}
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|rename
argument_list|(
name|oldpath
argument_list|,
name|newpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* Special case: newpath is a non-empty directory.  Some systems          return ENOTEMPTY, some return EEXIST.  We coerce that to be 	 always EEXIST. */
if|if
condition|(
name|errno
operator|==
name|ENOTEMPTY
condition|)
name|errno
operator|=
name|EEXIST
expr_stmt|;
ifdef|#
directive|ifdef
name|__CYGWIN__
comment|/* Workaround some Cygwin problems with correct errnos. */
if|if
condition|(
name|errno
operator|==
name|EACCES
condition|)
block|{
if|if
condition|(
operator|!
name|of
operator|&&
operator|!
name|nf
operator|&&
name|S_ISDIR
argument_list|(
name|nst
operator|.
name|st_mode
argument_list|)
condition|)
block|{
if|if
condition|(
name|S_ISREG
argument_list|(
name|ost
operator|.
name|st_mode
argument_list|)
condition|)
name|errno
operator|=
name|EISDIR
expr_stmt|;
else|else
block|{
name|char
name|oldfullpath
index|[
name|PATH_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|char
name|newfullpath
index|[
name|PATH_MAX
operator|+
literal|1
index|]
decl_stmt|;
name|int
name|len
decl_stmt|;
name|cygwin_conv_to_full_posix_path
argument_list|(
name|oldpath
argument_list|,
name|oldfullpath
argument_list|)
expr_stmt|;
name|cygwin_conv_to_full_posix_path
argument_list|(
name|newpath
argument_list|,
name|newfullpath
argument_list|)
expr_stmt|;
name|len
operator|=
name|strlen
argument_list|(
name|oldfullpath
argument_list|)
expr_stmt|;
if|if
condition|(
name|newfullpath
index|[
name|len
index|]
operator|==
literal|'/'
operator|&&
operator|!
name|strncmp
argument_list|(
name|oldfullpath
argument_list|,
name|newfullpath
argument_list|,
name|len
argument_list|)
condition|)
name|errno
operator|=
name|EINVAL
expr_stmt|;
else|else
name|errno
operator|=
name|EEXIST
expr_stmt|;
block|}
block|}
block|}
endif|#
directive|endif
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
name|remote_fileio_return_success
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_unlink
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|CORE_ADDR
name|ptrval
decl_stmt|;
name|int
name|length
decl_stmt|,
name|retlength
decl_stmt|;
name|char
modifier|*
name|pathname
decl_stmt|;
name|int
name|ret
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
comment|/* Parameter: Ptr to pathname / length incl. trailing zero */
if|if
condition|(
name|remote_fileio_extract_ptr_w_len
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|ptrval
argument_list|,
operator|&
name|length
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* Request pathname using 'm' packet */
name|pathname
operator|=
name|alloca
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|retlength
operator|=
name|remote_read_bytes
argument_list|(
name|ptrval
argument_list|,
name|pathname
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
name|length
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* Only operate on regular files (and directories, which allows to return      the correct return code) */
if|if
condition|(
operator|!
name|stat
argument_list|(
name|pathname
argument_list|,
operator|&
name|st
argument_list|)
operator|&&
operator|!
name|S_ISREG
argument_list|(
name|st
operator|.
name|st_mode
argument_list|)
operator|&&
operator|!
name|S_ISDIR
argument_list|(
name|st
operator|.
name|st_mode
argument_list|)
condition|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_ENODEV
argument_list|)
expr_stmt|;
return|return;
block|}
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|unlink
argument_list|(
name|pathname
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|remote_fileio_return_success
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_stat
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|CORE_ADDR
name|ptrval
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|length
decl_stmt|,
name|retlength
decl_stmt|;
name|char
modifier|*
name|pathname
decl_stmt|;
name|LONGEST
name|lnum
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|struct
name|fio_stat
name|fst
decl_stmt|;
comment|/* 1. Parameter: Ptr to pathname / length incl. trailing zero */
if|if
condition|(
name|remote_fileio_extract_ptr_w_len
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|ptrval
argument_list|,
operator|&
name|length
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* Request pathname using 'm' packet */
name|pathname
operator|=
name|alloca
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|retlength
operator|=
name|remote_read_bytes
argument_list|(
name|ptrval
argument_list|,
name|pathname
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
name|length
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* 2. Parameter: Ptr to struct stat */
if|if
condition|(
name|remote_fileio_extract_long
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|lnum
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|ptrval
operator|=
operator|(
name|CORE_ADDR
operator|)
name|lnum
expr_stmt|;
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|stat
argument_list|(
name|pathname
argument_list|,
operator|&
name|st
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Only operate on regular files and directories */
if|if
condition|(
operator|!
name|ret
operator|&&
operator|!
name|S_ISREG
argument_list|(
name|st
operator|.
name|st_mode
argument_list|)
operator|&&
operator|!
name|S_ISDIR
argument_list|(
name|st
operator|.
name|st_mode
argument_list|)
condition|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_EACCES
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ptrval
condition|)
block|{
name|remote_fileio_to_fio_stat
argument_list|(
operator|&
name|st
argument_list|,
operator|&
name|fst
argument_list|)
expr_stmt|;
name|remote_fileio_to_fio_uint
argument_list|(
literal|0
argument_list|,
name|fst
operator|.
name|fst_dev
argument_list|)
expr_stmt|;
name|retlength
operator|=
name|remote_fileio_write_bytes
argument_list|(
name|ptrval
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|fst
argument_list|,
sizeof|sizeof
name|fst
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
sizeof|sizeof
name|fst
condition|)
block|{
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|remote_fileio_return_success
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_fstat
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|CORE_ADDR
name|ptrval
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|ret
decl_stmt|,
name|retlength
decl_stmt|;
name|long
name|target_fd
decl_stmt|;
name|LONGEST
name|lnum
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
name|struct
name|fio_stat
name|fst
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
comment|/* 1. Parameter: file descriptor */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|target_fd
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|fd
operator|=
name|remote_fileio_map_fd
argument_list|(
operator|(
name|int
operator|)
name|target_fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|==
name|FIO_FD_INVALID
condition|)
block|{
name|remote_fileio_badfd
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* 2. Parameter: Ptr to struct stat */
if|if
condition|(
name|remote_fileio_extract_long
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|lnum
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|ptrval
operator|=
operator|(
name|CORE_ADDR
operator|)
name|lnum
expr_stmt|;
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|fd
operator|==
name|FIO_FD_CONSOLE_IN
operator|||
name|fd
operator|==
name|FIO_FD_CONSOLE_OUT
condition|)
block|{
name|remote_fileio_to_fio_uint
argument_list|(
literal|1
argument_list|,
name|fst
operator|.
name|fst_dev
argument_list|)
expr_stmt|;
name|st
operator|.
name|st_mode
operator|=
name|S_IFCHR
operator||
operator|(
name|fd
operator|==
name|FIO_FD_CONSOLE_IN
condition|?
name|S_IRUSR
else|:
name|S_IWUSR
operator|)
expr_stmt|;
name|st
operator|.
name|st_nlink
operator|=
literal|1
expr_stmt|;
name|st
operator|.
name|st_uid
operator|=
name|getuid
argument_list|()
expr_stmt|;
name|st
operator|.
name|st_gid
operator|=
name|getgid
argument_list|()
expr_stmt|;
name|st
operator|.
name|st_rdev
operator|=
literal|0
expr_stmt|;
name|st
operator|.
name|st_size
operator|=
literal|0
expr_stmt|;
name|st
operator|.
name|st_blksize
operator|=
literal|512
expr_stmt|;
if|#
directive|if
name|HAVE_STRUCT_STAT_ST_BLOCKS
name|st
operator|.
name|st_blocks
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
condition|)
name|st
operator|.
name|st_atime
operator|=
name|st
operator|.
name|st_mtime
operator|=
name|st
operator|.
name|st_ctime
operator|=
name|tv
operator|.
name|tv_sec
expr_stmt|;
else|else
name|st
operator|.
name|st_atime
operator|=
name|st
operator|.
name|st_mtime
operator|=
name|st
operator|.
name|st_ctime
operator|=
operator|(
name|time_t
operator|)
literal|0
expr_stmt|;
name|ret
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|ret
operator|=
name|fstat
argument_list|(
name|fd
argument_list|,
operator|&
name|st
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ptrval
condition|)
block|{
name|remote_fileio_to_fio_stat
argument_list|(
operator|&
name|st
argument_list|,
operator|&
name|fst
argument_list|)
expr_stmt|;
name|retlength
operator|=
name|remote_fileio_write_bytes
argument_list|(
name|ptrval
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|fst
argument_list|,
sizeof|sizeof
name|fst
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
sizeof|sizeof
name|fst
condition|)
block|{
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|remote_fileio_return_success
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_gettimeofday
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|LONGEST
name|lnum
decl_stmt|;
name|CORE_ADDR
name|ptrval
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|retlength
decl_stmt|;
name|struct
name|timeval
name|tv
decl_stmt|;
name|struct
name|fio_timeval
name|ftv
decl_stmt|;
comment|/* 1. Parameter: struct timeval pointer */
if|if
condition|(
name|remote_fileio_extract_long
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|lnum
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|ptrval
operator|=
operator|(
name|CORE_ADDR
operator|)
name|lnum
expr_stmt|;
comment|/* 2. Parameter: some pointer value... */
if|if
condition|(
name|remote_fileio_extract_long
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|lnum
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* ...which has to be NULL */
if|if
condition|(
name|lnum
condition|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_EINVAL
argument_list|)
expr_stmt|;
return|return;
block|}
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|gettimeofday
argument_list|(
operator|&
name|tv
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
block|{
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|ptrval
condition|)
block|{
name|remote_fileio_to_fio_timeval
argument_list|(
operator|&
name|tv
argument_list|,
operator|&
name|ftv
argument_list|)
expr_stmt|;
name|retlength
operator|=
name|remote_fileio_write_bytes
argument_list|(
name|ptrval
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ftv
argument_list|,
sizeof|sizeof
name|ftv
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
sizeof|sizeof
name|ftv
condition|)
block|{
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|remote_fileio_return_success
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_isatty
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|long
name|target_fd
decl_stmt|;
name|int
name|fd
decl_stmt|;
comment|/* Parameter: file descriptor */
if|if
condition|(
name|remote_fileio_extract_int
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|target_fd
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
name|fd
operator|=
name|remote_fileio_map_fd
argument_list|(
operator|(
name|int
operator|)
name|target_fd
argument_list|)
expr_stmt|;
name|remote_fileio_return_success
argument_list|(
name|fd
operator|==
name|FIO_FD_CONSOLE_IN
operator|||
name|fd
operator|==
name|FIO_FD_CONSOLE_OUT
condition|?
literal|1
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|remote_fileio_func_system
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|CORE_ADDR
name|ptrval
decl_stmt|;
name|int
name|ret
decl_stmt|,
name|length
decl_stmt|,
name|retlength
decl_stmt|;
name|char
modifier|*
name|cmdline
decl_stmt|;
comment|/* Check if system(3) has been explicitely allowed using the      `set remote system-call-allowed 1' command.  If not, return      EPERM */
if|if
condition|(
operator|!
name|remote_fio_system_call_allowed
condition|)
block|{
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_EPERM
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Parameter: Ptr to commandline / length incl. trailing zero */
if|if
condition|(
name|remote_fileio_extract_ptr_w_len
argument_list|(
operator|&
name|buf
argument_list|,
operator|&
name|ptrval
argument_list|,
operator|&
name|length
argument_list|)
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
comment|/* Request commandline using 'm' packet */
name|cmdline
operator|=
name|alloca
argument_list|(
name|length
argument_list|)
expr_stmt|;
name|retlength
operator|=
name|remote_read_bytes
argument_list|(
name|ptrval
argument_list|,
name|cmdline
argument_list|,
name|length
argument_list|)
expr_stmt|;
if|if
condition|(
name|retlength
operator|!=
name|length
condition|)
block|{
name|remote_fileio_ioerror
argument_list|()
expr_stmt|;
return|return;
block|}
name|remote_fio_no_longjmp
operator|=
literal|1
expr_stmt|;
name|ret
operator|=
name|system
argument_list|(
name|cmdline
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|==
operator|-
literal|1
condition|)
name|remote_fileio_return_errno
argument_list|(
operator|-
literal|1
argument_list|)
expr_stmt|;
else|else
name|remote_fileio_return_success
argument_list|(
name|WEXITSTATUS
argument_list|(
name|ret
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_struct
specifier|static
struct|struct
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|void
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|char
modifier|*
parameter_list|)
function_decl|;
block|}
name|remote_fio_func_map
index|[]
init|=
block|{
literal|"open"
block|,
name|remote_fileio_func_open
block|,
literal|"close"
block|,
name|remote_fileio_func_close
block|,
literal|"read"
block|,
name|remote_fileio_func_read
block|,
literal|"write"
block|,
name|remote_fileio_func_write
block|,
literal|"lseek"
block|,
name|remote_fileio_func_lseek
block|,
literal|"rename"
block|,
name|remote_fileio_func_rename
block|,
literal|"unlink"
block|,
name|remote_fileio_func_unlink
block|,
literal|"stat"
block|,
name|remote_fileio_func_stat
block|,
literal|"fstat"
block|,
name|remote_fileio_func_fstat
block|,
literal|"gettimeofday"
block|,
name|remote_fileio_func_gettimeofday
block|,
literal|"isatty"
block|,
name|remote_fileio_func_isatty
block|,
literal|"system"
block|,
name|remote_fileio_func_system
block|,
name|NULL
block|,
name|NULL
block|}
struct|;
end_struct

begin_function
specifier|static
name|int
name|do_remote_fileio_request
parameter_list|(
name|struct
name|ui_out
modifier|*
name|uiout
parameter_list|,
name|void
modifier|*
name|buf_arg
parameter_list|)
block|{
name|char
modifier|*
name|buf
init|=
name|buf_arg
decl_stmt|;
name|char
modifier|*
name|c
decl_stmt|;
name|int
name|idx
decl_stmt|;
name|remote_fileio_sig_set
argument_list|(
name|remote_fileio_ctrl_c_signal_handler
argument_list|)
expr_stmt|;
name|c
operator|=
name|strchr
argument_list|(
operator|++
name|buf
argument_list|,
literal|','
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
condition|)
operator|*
name|c
operator|++
operator|=
literal|'\0'
expr_stmt|;
else|else
name|c
operator|=
name|strchr
argument_list|(
name|buf
argument_list|,
literal|'\0'
argument_list|)
expr_stmt|;
for|for
control|(
name|idx
operator|=
literal|0
init|;
name|remote_fio_func_map
index|[
name|idx
index|]
operator|.
name|name
condition|;
operator|++
name|idx
control|)
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|remote_fio_func_map
index|[
name|idx
index|]
operator|.
name|name
argument_list|,
name|buf
argument_list|)
condition|)
break|break;
if|if
condition|(
operator|!
name|remote_fio_func_map
index|[
name|idx
index|]
operator|.
name|name
condition|)
comment|/* ERROR: No such function. */
return|return
name|RETURN_ERROR
return|;
name|remote_fio_func_map
index|[
name|idx
index|]
operator|.
name|func
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|remote_fileio_request
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|)
block|{
name|int
name|ex
decl_stmt|;
name|remote_fileio_sig_init
argument_list|()
expr_stmt|;
name|remote_fio_ctrl_c_flag
operator|=
literal|0
expr_stmt|;
name|remote_fio_no_longjmp
operator|=
literal|0
expr_stmt|;
name|ex
operator|=
name|catch_exceptions
argument_list|(
name|uiout
argument_list|,
name|do_remote_fileio_request
argument_list|,
operator|(
name|void
operator|*
operator|)
name|buf
argument_list|,
name|NULL
argument_list|,
name|RETURN_MASK_ALL
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ex
condition|)
block|{
case|case
name|RETURN_ERROR
case|:
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_ENOSYS
argument_list|)
expr_stmt|;
break|break;
case|case
name|RETURN_QUIT
case|:
name|remote_fileio_reply
argument_list|(
operator|-
literal|1
argument_list|,
name|FILEIO_EINTR
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|remote_fileio_sig_exit
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|set_system_call_allowed
parameter_list|(
name|char
modifier|*
name|args
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
if|if
condition|(
name|args
condition|)
block|{
name|char
modifier|*
name|arg_end
decl_stmt|;
name|int
name|val
init|=
name|strtoul
argument_list|(
name|args
argument_list|,
operator|&
name|arg_end
argument_list|,
literal|10
argument_list|)
decl_stmt|;
if|if
condition|(
operator|*
name|args
operator|&&
operator|*
name|arg_end
operator|==
literal|'\0'
condition|)
block|{
name|remote_fio_system_call_allowed
operator|=
operator|!
operator|!
name|val
expr_stmt|;
return|return;
block|}
block|}
name|error
argument_list|(
literal|"Illegal argument for \"set remote system-call-allowed\" command"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|show_system_call_allowed
parameter_list|(
name|char
modifier|*
name|args
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
if|if
condition|(
name|args
condition|)
name|error
argument_list|(
literal|"Garbage after \"show remote system-call-allowed\" command: `%s'"
argument_list|,
name|args
argument_list|)
expr_stmt|;
name|printf_unfiltered
argument_list|(
literal|"Calling host system(3) call from target is %sallowed\n"
argument_list|,
name|remote_fio_system_call_allowed
condition|?
literal|""
else|:
literal|"not "
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|initialize_remote_fileio
parameter_list|(
name|struct
name|cmd_list_element
modifier|*
name|remote_set_cmdlist
parameter_list|,
name|struct
name|cmd_list_element
modifier|*
name|remote_show_cmdlist
parameter_list|)
block|{
name|add_cmd
argument_list|(
literal|"system-call-allowed"
argument_list|,
name|no_class
argument_list|,
name|set_system_call_allowed
argument_list|,
literal|"Set if the host system(3) call is allowed for the target.\n"
argument_list|,
operator|&
name|remote_set_cmdlist
argument_list|)
expr_stmt|;
name|add_cmd
argument_list|(
literal|"system-call-allowed"
argument_list|,
name|no_class
argument_list|,
name|show_system_call_allowed
argument_list|,
literal|"Show if the host system(3) call is allowed for the target.\n"
argument_list|,
operator|&
name|remote_show_cmdlist
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


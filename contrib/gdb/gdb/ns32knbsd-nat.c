begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Functions specific to running gdb native on an ns32k running NetBSD    Copyright 1989, 1992, 1993, 1994, 1996, 1998, 1999, 2000, 2001    Free Software Foundation, Inc.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ptrace.h>
end_include

begin_include
include|#
directive|include
file|<machine/reg.h>
end_include

begin_include
include|#
directive|include
file|<machine/frame.h>
end_include

begin_include
include|#
directive|include
file|<machine/pcb.h>
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"inferior.h"
end_include

begin_include
include|#
directive|include
file|"target.h"
end_include

begin_include
include|#
directive|include
file|"gdbcore.h"
end_include

begin_include
include|#
directive|include
file|"regcache.h"
end_include

begin_define
define|#
directive|define
name|RF
parameter_list|(
name|dst
parameter_list|,
name|src
parameter_list|)
define|\
value|memcpy(&registers[REGISTER_BYTE(dst)],&src, sizeof(src))
end_define

begin_define
define|#
directive|define
name|RS
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|)
define|\
value|memcpy(&dst,&registers[REGISTER_BYTE(src)], sizeof(dst))
end_define

begin_function
name|void
name|fetch_inferior_registers
parameter_list|(
name|int
name|regno
parameter_list|)
block|{
name|struct
name|reg
name|inferior_registers
decl_stmt|;
name|struct
name|fpreg
name|inferior_fpregisters
decl_stmt|;
name|ptrace
argument_list|(
name|PT_GETREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_registers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|PT_GETFPREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_fpregisters
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|0
argument_list|,
name|inferior_registers
operator|.
name|r_r0
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|1
argument_list|,
name|inferior_registers
operator|.
name|r_r1
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|2
argument_list|,
name|inferior_registers
operator|.
name|r_r2
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|3
argument_list|,
name|inferior_registers
operator|.
name|r_r3
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|4
argument_list|,
name|inferior_registers
operator|.
name|r_r4
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|5
argument_list|,
name|inferior_registers
operator|.
name|r_r5
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|6
argument_list|,
name|inferior_registers
operator|.
name|r_r6
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|7
argument_list|,
name|inferior_registers
operator|.
name|r_r7
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|SP_REGNUM
argument_list|,
name|inferior_registers
operator|.
name|r_sp
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP_REGNUM
argument_list|,
name|inferior_registers
operator|.
name|r_fp
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|PC_REGNUM
argument_list|,
name|inferior_registers
operator|.
name|r_pc
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|PS_REGNUM
argument_list|,
name|inferior_registers
operator|.
name|r_psr
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FPS_REGNUM
argument_list|,
name|inferior_fpregisters
operator|.
name|r_fsr
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|0
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|2
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|4
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|6
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|1
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|3
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|5
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|7
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|registers_fetched
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|store_inferior_registers
parameter_list|(
name|int
name|regno
parameter_list|)
block|{
name|struct
name|reg
name|inferior_registers
decl_stmt|;
name|struct
name|fpreg
name|inferior_fpregisters
decl_stmt|;
name|RS
argument_list|(
name|R0_REGNUM
operator|+
literal|0
argument_list|,
name|inferior_registers
operator|.
name|r_r0
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|R0_REGNUM
operator|+
literal|1
argument_list|,
name|inferior_registers
operator|.
name|r_r1
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|R0_REGNUM
operator|+
literal|2
argument_list|,
name|inferior_registers
operator|.
name|r_r2
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|R0_REGNUM
operator|+
literal|3
argument_list|,
name|inferior_registers
operator|.
name|r_r3
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|R0_REGNUM
operator|+
literal|4
argument_list|,
name|inferior_registers
operator|.
name|r_r4
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|R0_REGNUM
operator|+
literal|5
argument_list|,
name|inferior_registers
operator|.
name|r_r5
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|R0_REGNUM
operator|+
literal|6
argument_list|,
name|inferior_registers
operator|.
name|r_r6
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|R0_REGNUM
operator|+
literal|7
argument_list|,
name|inferior_registers
operator|.
name|r_r7
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|SP_REGNUM
argument_list|,
name|inferior_registers
operator|.
name|r_sp
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|FP_REGNUM
argument_list|,
name|inferior_registers
operator|.
name|r_fp
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|PC_REGNUM
argument_list|,
name|inferior_registers
operator|.
name|r_pc
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|PS_REGNUM
argument_list|,
name|inferior_registers
operator|.
name|r_psr
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|FPS_REGNUM
argument_list|,
name|inferior_fpregisters
operator|.
name|r_fsr
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|FP0_REGNUM
operator|+
literal|0
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|FP0_REGNUM
operator|+
literal|2
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|FP0_REGNUM
operator|+
literal|4
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|FP0_REGNUM
operator|+
literal|6
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|LP0_REGNUM
operator|+
literal|1
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|LP0_REGNUM
operator|+
literal|3
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|LP0_REGNUM
operator|+
literal|5
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|LP0_REGNUM
operator|+
literal|7
argument_list|,
name|inferior_fpregisters
operator|.
name|r_freg
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|PT_SETREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_registers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|PT_SETFPREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_fpregisters
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* XXX - Add this to machine/regs.h instead? */
end_comment

begin_struct
struct|struct
name|coreregs
block|{
name|struct
name|reg
name|intreg
decl_stmt|;
name|struct
name|fpreg
name|freg
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Get registers from a core file.  REG_ADDR is unused.  */
end_comment

begin_function
specifier|static
name|void
name|fetch_core_registers
parameter_list|(
name|char
modifier|*
name|core_reg_sect
parameter_list|,
name|unsigned
name|core_reg_size
parameter_list|,
name|int
name|which
parameter_list|,
name|unsigned
name|int
name|reg_addr
parameter_list|)
block|{
name|struct
name|coreregs
modifier|*
name|core_reg
decl_stmt|;
name|core_reg
operator|=
operator|(
expr|struct
name|coreregs
operator|*
operator|)
name|core_reg_sect
expr_stmt|;
comment|/*    * We have *all* registers    * in the first core section.    * Ignore which.    */
if|if
condition|(
name|core_reg_size
operator|<
sizeof|sizeof
argument_list|(
operator|*
name|core_reg
argument_list|)
condition|)
block|{
name|fprintf_unfiltered
argument_list|(
name|gdb_stderr
argument_list|,
literal|"Couldn't read regs from core file\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Integer registers */
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|0
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_r0
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|1
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_r1
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|2
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_r2
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|3
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_r3
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|4
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_r4
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|5
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_r5
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|6
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_r6
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|7
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_r7
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|SP_REGNUM
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_sp
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP_REGNUM
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_fp
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|PC_REGNUM
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_pc
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|PS_REGNUM
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|r_psr
argument_list|)
expr_stmt|;
comment|/* Floating point registers */
name|RF
argument_list|(
name|FPS_REGNUM
argument_list|,
name|core_reg
operator|->
name|freg
operator|.
name|r_fsr
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|0
argument_list|,
name|core_reg
operator|->
name|freg
operator|.
name|r_freg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|2
argument_list|,
name|core_reg
operator|->
name|freg
operator|.
name|r_freg
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|4
argument_list|,
name|core_reg
operator|->
name|freg
operator|.
name|r_freg
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|6
argument_list|,
name|core_reg
operator|->
name|freg
operator|.
name|r_freg
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|1
argument_list|,
name|core_reg
operator|->
name|freg
operator|.
name|r_freg
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|3
argument_list|,
name|core_reg
operator|->
name|freg
operator|.
name|r_freg
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|5
argument_list|,
name|core_reg
operator|->
name|freg
operator|.
name|r_freg
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|7
argument_list|,
name|core_reg
operator|->
name|freg
operator|.
name|r_freg
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|registers_fetched
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Register that we are able to handle ns32knbsd core file formats.    FIXME: is this really bfd_target_unknown_flavour? */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|core_fns
name|nat_core_fns
init|=
block|{
name|bfd_target_unknown_flavour
block|,
comment|/* core_flavour */
name|default_check_format
block|,
comment|/* check_format */
name|default_core_sniffer
block|,
comment|/* core_sniffer */
name|fetch_core_registers
block|,
comment|/* core_read_registers */
name|NULL
comment|/* next */
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|_initialize_ns32knbsd_nat
parameter_list|(
name|void
parameter_list|)
block|{
name|add_core_fns
argument_list|(
operator|&
name|nat_core_fns
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/*  * kernel_u_size() is not helpful on NetBSD because  * the "u" struct is NOT in the core dump file.  */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|FETCH_KCORE_REGISTERS
end_ifdef

begin_comment
comment|/*  * Get registers from a kernel crash dump or live kernel.  * Called by kcore-nbsd.c:get_kcore_registers().  */
end_comment

begin_function
name|void
name|fetch_kcore_registers
parameter_list|(
name|struct
name|pcb
modifier|*
name|pcb
parameter_list|)
block|{
name|struct
name|switchframe
name|sf
decl_stmt|;
name|struct
name|reg
name|intreg
decl_stmt|;
name|int
name|dummy
decl_stmt|;
comment|/* Integer registers */
if|if
condition|(
name|target_read_memory
argument_list|(
operator|(
name|CORE_ADDR
operator|)
name|pcb
operator|->
name|pcb_ksp
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|sf
argument_list|,
sizeof|sizeof
name|sf
argument_list|)
condition|)
name|error
argument_list|(
literal|"Cannot read integer registers."
argument_list|)
expr_stmt|;
comment|/* We use the psr at kernel entry */
if|if
condition|(
name|target_read_memory
argument_list|(
operator|(
name|CORE_ADDR
operator|)
name|pcb
operator|->
name|pcb_onstack
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|intreg
argument_list|,
sizeof|sizeof
name|intreg
argument_list|)
condition|)
name|error
argument_list|(
literal|"Cannot read processor status register."
argument_list|)
expr_stmt|;
name|dummy
operator|=
literal|0
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|0
argument_list|,
name|dummy
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|1
argument_list|,
name|dummy
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|2
argument_list|,
name|dummy
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|3
argument_list|,
name|sf
operator|.
name|sf_r3
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|4
argument_list|,
name|sf
operator|.
name|sf_r4
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|5
argument_list|,
name|sf
operator|.
name|sf_r5
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|6
argument_list|,
name|sf
operator|.
name|sf_r6
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|7
argument_list|,
name|sf
operator|.
name|sf_r7
argument_list|)
expr_stmt|;
name|dummy
operator|=
name|pcb
operator|->
name|pcb_kfp
operator|+
literal|8
expr_stmt|;
name|RF
argument_list|(
name|SP_REGNUM
argument_list|,
name|dummy
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP_REGNUM
argument_list|,
name|sf
operator|.
name|sf_fp
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|PC_REGNUM
argument_list|,
name|sf
operator|.
name|sf_pc
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|PS_REGNUM
argument_list|,
name|intreg
operator|.
name|r_psr
argument_list|)
expr_stmt|;
comment|/* Floating point registers */
name|RF
argument_list|(
name|FPS_REGNUM
argument_list|,
name|pcb
operator|->
name|pcb_fsr
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|0
argument_list|,
name|pcb
operator|->
name|pcb_freg
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|2
argument_list|,
name|pcb
operator|->
name|pcb_freg
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|4
argument_list|,
name|pcb
operator|->
name|pcb_freg
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|6
argument_list|,
name|pcb
operator|->
name|pcb_freg
index|[
literal|6
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|1
argument_list|,
name|pcb
operator|->
name|pcb_freg
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|3
argument_list|,
name|pcb
operator|->
name|pcb_freg
index|[
literal|3
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|5
argument_list|,
name|pcb
operator|->
name|pcb_freg
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|7
argument_list|,
name|pcb
operator|->
name|pcb_freg
index|[
literal|7
index|]
argument_list|)
expr_stmt|;
name|registers_fetched
argument_list|()
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* FETCH_KCORE_REGISTERS */
end_comment

begin_function
name|void
name|clear_regs
parameter_list|(
name|void
parameter_list|)
block|{
name|double
name|zero
init|=
literal|0.0
decl_stmt|;
name|int
name|null
init|=
literal|0
decl_stmt|;
comment|/* Integer registers */
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|0
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|1
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|2
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|3
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|4
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|5
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|6
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|R0_REGNUM
operator|+
literal|7
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|SP_REGNUM
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP_REGNUM
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|PC_REGNUM
argument_list|,
name|null
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|PS_REGNUM
argument_list|,
name|null
argument_list|)
expr_stmt|;
comment|/* Floating point registers */
name|RF
argument_list|(
name|FPS_REGNUM
argument_list|,
name|zero
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|0
argument_list|,
name|zero
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|2
argument_list|,
name|zero
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|4
argument_list|,
name|zero
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
literal|6
argument_list|,
name|zero
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|0
argument_list|,
name|zero
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|1
argument_list|,
name|zero
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|2
argument_list|,
name|zero
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|LP0_REGNUM
operator|+
literal|3
argument_list|,
name|zero
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|/* Return number of args passed to a frame.    Can return -1, meaning no way to tell. */
end_comment

begin_function
name|int
name|frame_num_args
parameter_list|(
name|struct
name|frame_info
modifier|*
name|fi
parameter_list|)
block|{
name|CORE_ADDR
name|enter_addr
decl_stmt|;
name|CORE_ADDR
name|argp
decl_stmt|;
name|int
name|inst
decl_stmt|;
name|int
name|args
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|read_memory_integer
argument_list|(
name|fi
operator|->
name|frame
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
operator|&&
name|fi
operator|->
name|pc
operator|<
literal|0x10000
condition|)
block|{
comment|/* main is always called with three args */
return|return
operator|(
literal|3
operator|)
return|;
block|}
name|enter_addr
operator|=
name|ns32k_get_enter_addr
argument_list|(
name|fi
operator|->
name|pc
argument_list|)
expr_stmt|;
if|if
condition|(
name|enter_addr
operator|=
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
name|argp
operator|=
name|enter_addr
operator|==
literal|1
condition|?
name|SAVED_PC_AFTER_CALL
argument_list|(
name|fi
argument_list|)
else|:
name|FRAME_SAVED_PC
argument_list|(
name|fi
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
block|{
comment|/*        * After a bsr gcc may emit the following instructions        * to remove the arguments from the stack:        *   cmpqd 0,tos        - to remove 4 bytes from the stack        *   cmpd tos,tos       - to remove 8 bytes from the stack        *   adjsp[bwd] -n      - to remove n bytes from the stack        * Gcc sometimes delays emitting these instructions and        * may even throw a branch between our feet.        */
name|inst
operator|=
name|read_memory_integer
argument_list|(
name|argp
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|args
operator|=
name|read_memory_integer
argument_list|(
name|argp
operator|+
literal|2
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|inst
operator|&
literal|0xff
operator|)
operator|==
literal|0xea
condition|)
block|{
comment|/* br */
name|args
operator|=
operator|(
operator|(
name|inst
operator|>>
literal|8
operator|)
operator|&
literal|0xffffff
operator|)
operator||
operator|(
name|args
operator|<<
literal|24
operator|)
expr_stmt|;
if|if
condition|(
name|args
operator|&
literal|0x80
condition|)
block|{
if|if
condition|(
name|args
operator|&
literal|0x40
condition|)
block|{
name|args
operator|=
name|ntohl
argument_list|(
name|args
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|args
operator|=
name|ntohs
argument_list|(
name|args
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
if|if
condition|(
name|args
operator|&
literal|0x2000
condition|)
name|args
operator||=
literal|0xc000
expr_stmt|;
block|}
block|}
else|else
block|{
name|args
operator|=
name|args
operator|&
literal|0xff
expr_stmt|;
if|if
condition|(
name|args
operator|&
literal|0x40
condition|)
name|args
operator||=
literal|0x80
expr_stmt|;
block|}
name|argp
operator|+=
name|args
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|(
name|inst
operator|&
literal|0xffff
operator|)
operator|==
literal|0xb81f
condition|)
comment|/* cmpqd 0,tos */
return|return
operator|(
literal|1
operator|)
return|;
elseif|else
if|if
condition|(
operator|(
name|inst
operator|&
literal|0xffff
operator|)
operator|==
literal|0xbdc7
condition|)
comment|/* cmpd tos,tos */
return|return
operator|(
literal|2
operator|)
return|;
elseif|else
if|if
condition|(
operator|(
name|inst
operator|&
literal|0xfffc
operator|)
operator|==
literal|0xa57c
condition|)
block|{
comment|/* adjsp[bwd] */
switch|switch
condition|(
name|inst
operator|&
literal|3
condition|)
block|{
case|case
literal|0
case|:
name|args
operator|=
operator|(
operator|(
name|args
operator|&
literal|0xff
operator|)
operator|+
literal|0x80
operator|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|args
operator|=
operator|(
operator|(
name|ntohs
argument_list|(
name|args
argument_list|)
operator|&
literal|0xffff
operator|)
operator|+
literal|0x8000
operator|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|args
operator|=
operator|-
name|ntohl
argument_list|(
name|args
argument_list|)
expr_stmt|;
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|args
operator|/
literal|4
operator|>
literal|10
operator|||
operator|(
name|args
operator|&
literal|3
operator|)
operator|!=
literal|0
condition|)
continue|continue;
return|return
operator|(
name|args
operator|/
literal|4
operator|)
return|;
block|}
name|argp
operator|+=
literal|1
expr_stmt|;
block|}
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_function

end_unit


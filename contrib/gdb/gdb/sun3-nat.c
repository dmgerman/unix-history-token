begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Host-dependent code for Sun-3 for GDB, the GNU debugger.    Copyright 1986, 1987, 1989, 1991, 1992, 1993, 1996, 1999, 2000, 2001    Free Software Foundation, Inc.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"inferior.h"
end_include

begin_include
include|#
directive|include
file|"gdbcore.h"
end_include

begin_include
include|#
directive|include
file|"regcache.h"
end_include

begin_include
include|#
directive|include
file|<sys/ptrace.h>
end_include

begin_define
define|#
directive|define
name|KERNEL
end_define

begin_comment
comment|/* To get floating point reg definitions */
end_comment

begin_include
include|#
directive|include
file|<machine/reg.h>
end_include

begin_function_decl
specifier|static
name|void
name|fetch_core_registers
parameter_list|(
name|char
modifier|*
parameter_list|,
name|unsigned
parameter_list|,
name|int
parameter_list|,
name|CORE_ADDR
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|fetch_inferior_registers
parameter_list|(
name|int
name|regno
parameter_list|)
block|{
name|struct
name|regs
name|inferior_registers
decl_stmt|;
name|struct
name|fp_status
name|inferior_fp_registers
decl_stmt|;
name|deprecated_registers_fetched
argument_list|()
expr_stmt|;
name|ptrace
argument_list|(
name|PTRACE_GETREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_registers
argument_list|)
expr_stmt|;
if|if
condition|(
name|FP0_REGNUM
operator|>=
literal|0
condition|)
name|ptrace
argument_list|(
name|PTRACE_GETFPREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_fp_registers
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|deprecated_registers
argument_list|,
operator|&
name|inferior_registers
argument_list|,
literal|16
operator|*
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|FP0_REGNUM
operator|>=
literal|0
condition|)
name|memcpy
argument_list|(
operator|&
name|deprecated_registers
index|[
name|DEPRECATED_REGISTER_BYTE
argument_list|(
name|FP0_REGNUM
argument_list|)
index|]
argument_list|,
operator|&
name|inferior_fp_registers
argument_list|,
sizeof|sizeof
name|inferior_fp_registers
operator|.
name|fps_regs
argument_list|)
expr_stmt|;
operator|*
operator|(
name|int
operator|*
operator|)
operator|&
name|deprecated_registers
index|[
name|DEPRECATED_REGISTER_BYTE
argument_list|(
name|PS_REGNUM
argument_list|)
index|]
operator|=
name|inferior_registers
operator|.
name|r_ps
expr_stmt|;
operator|*
operator|(
name|int
operator|*
operator|)
operator|&
name|deprecated_registers
index|[
name|DEPRECATED_REGISTER_BYTE
argument_list|(
name|PC_REGNUM
argument_list|)
index|]
operator|=
name|inferior_registers
operator|.
name|r_pc
expr_stmt|;
if|if
condition|(
name|FP0_REGNUM
operator|>=
literal|0
condition|)
name|memcpy
argument_list|(
operator|&
name|deprecated_registers
index|[
name|DEPRECATED_REGISTER_BYTE
argument_list|(
name|FPC_REGNUM
argument_list|)
index|]
argument_list|,
operator|&
name|inferior_fp_registers
operator|.
name|fps_control
argument_list|,
sizeof|sizeof
name|inferior_fp_registers
operator|-
sizeof|sizeof
name|inferior_fp_registers
operator|.
name|fps_regs
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Store our register values back into the inferior.    If REGNO is -1, do this for all registers.    Otherwise, REGNO specifies which register (so we can save time).  */
end_comment

begin_function
name|void
name|store_inferior_registers
parameter_list|(
name|int
name|regno
parameter_list|)
block|{
name|struct
name|regs
name|inferior_registers
decl_stmt|;
name|struct
name|fp_status
name|inferior_fp_registers
decl_stmt|;
name|memcpy
argument_list|(
operator|&
name|inferior_registers
argument_list|,
name|deprecated_registers
argument_list|,
literal|16
operator|*
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|FP0_REGNUM
operator|>=
literal|0
condition|)
name|memcpy
argument_list|(
operator|&
name|inferior_fp_registers
argument_list|,
operator|&
name|deprecated_registers
index|[
name|DEPRECATED_REGISTER_BYTE
argument_list|(
name|FP0_REGNUM
argument_list|)
index|]
argument_list|,
sizeof|sizeof
name|inferior_fp_registers
operator|.
name|fps_regs
argument_list|)
expr_stmt|;
name|inferior_registers
operator|.
name|r_ps
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
operator|&&
name|deprecated_registers
index|[
name|DEPRECATED_REGISTER_BYTE
argument_list|(
name|PS_REGNUM
argument_list|)
index|]
expr_stmt|;
name|inferior_registers
operator|.
name|r_pc
operator|=
operator|*
operator|(
name|int
operator|*
operator|)
operator|&&
name|deprecated_registers
index|[
name|DEPRECATED_REGISTER_BYTE
argument_list|(
name|PC_REGNUM
argument_list|)
index|]
expr_stmt|;
if|if
condition|(
name|FP0_REGNUM
operator|>=
literal|0
condition|)
name|memcpy
argument_list|(
operator|&
name|inferior_fp_registers
operator|.
name|fps_control
argument_list|,
operator|&&
name|deprecated_registers
index|[
name|DEPRECATED_REGISTER_BYTE
argument_list|(
name|FPC_REGNUM
argument_list|)
index|]
argument_list|,
sizeof|sizeof
name|inferior_fp_registers
operator|-
sizeof|sizeof
name|inferior_fp_registers
operator|.
name|fps_regs
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|PTRACE_SETREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_registers
argument_list|)
expr_stmt|;
if|if
condition|(
name|FP0_REGNUM
operator|>=
literal|0
condition|)
name|ptrace
argument_list|(
name|PTRACE_SETFPREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_fp_registers
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* All of this stuff is only relevant if both host and target are sun3.  */
end_comment

begin_comment
comment|/* Provide registers to GDB from a core file.     CORE_REG_SECT points to an array of bytes, which were obtained from    a core file which BFD thinks might contain register contents.     CORE_REG_SIZE is its size.     WHICH says which register set corelow suspects this is:      0 --- the general-purpose register set      2 --- the floating-point register set     REG_ADDR isn't used.  */
end_comment

begin_function
specifier|static
name|void
name|fetch_core_registers
parameter_list|(
name|char
modifier|*
name|core_reg_sect
parameter_list|,
name|unsigned
name|core_reg_size
parameter_list|,
name|int
name|which
parameter_list|,
name|CORE_ADDR
name|reg_addr
parameter_list|)
block|{
name|struct
name|regs
modifier|*
name|regs
init|=
operator|(
expr|struct
name|regs
operator|*
operator|)
name|core_reg_sect
decl_stmt|;
if|if
condition|(
name|which
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|core_reg_size
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|regs
argument_list|)
condition|)
name|error
argument_list|(
literal|"Can't find registers in core file"
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|deprecated_registers
argument_list|,
operator|(
name|char
operator|*
operator|)
name|regs
argument_list|,
literal|16
operator|*
literal|4
argument_list|)
expr_stmt|;
name|supply_register
argument_list|(
name|PS_REGNUM
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|regs
operator|->
name|r_ps
argument_list|)
expr_stmt|;
name|supply_register
argument_list|(
name|PC_REGNUM
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|regs
operator|->
name|r_pc
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|which
operator|==
literal|2
condition|)
block|{
define|#
directive|define
name|fpustruct
value|((struct fpu *) core_reg_sect)
if|if
condition|(
name|core_reg_size
operator|>=
sizeof|sizeof
argument_list|(
expr|struct
name|fpu
argument_list|)
condition|)
block|{
if|if
condition|(
name|FP0_REGNUM
operator|>=
literal|0
condition|)
block|{
name|memcpy
argument_list|(
operator|&&
name|deprecated_registers
index|[
name|DEPRECATED_REGISTER_BYTE
argument_list|(
name|FP0_REGNUM
argument_list|)
index|]
argument_list|,
name|fpustruct
operator|->
name|f_fpstatus
operator|.
name|fps_regs
argument_list|,
sizeof|sizeof
name|fpustruct
operator|->
name|f_fpstatus
operator|.
name|fps_regs
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&&
name|deprecated_registers
index|[
name|DEPRECATED_REGISTER_BYTE
argument_list|(
name|FPC_REGNUM
argument_list|)
index|]
argument_list|,
operator|&
name|fpustruct
operator|->
name|f_fpstatus
operator|.
name|fps_control
argument_list|,
sizeof|sizeof
name|fpustruct
operator|->
name|f_fpstatus
operator|-
sizeof|sizeof
name|fpustruct
operator|->
name|f_fpstatus
operator|.
name|fps_regs
argument_list|)
expr_stmt|;
block|}
block|}
else|else
name|fprintf_unfiltered
argument_list|(
name|gdb_stderr
argument_list|,
literal|"Couldn't read float regs from core file\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Register that we are able to handle sun3 core file formats.    FIXME: is this really bfd_target_unknown_flavour? */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|core_fns
name|sun3_core_fns
init|=
block|{
name|bfd_target_unknown_flavour
block|,
comment|/* core_flavour */
name|default_check_format
block|,
comment|/* check_format */
name|default_core_sniffer
block|,
comment|/* core_sniffer */
name|fetch_core_registers
block|,
comment|/* core_read_registers */
name|NULL
comment|/* next */
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|_initialize_core_sun3
parameter_list|(
name|void
parameter_list|)
block|{
name|add_core_fns
argument_list|(
operator|&
name|sun3_core_fns
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


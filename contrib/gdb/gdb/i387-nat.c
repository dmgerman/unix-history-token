begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Native-dependent code for the i387.    Copyright 2000, 2001 Free Software Foundation, Inc.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"inferior.h"
end_include

begin_include
include|#
directive|include
file|"value.h"
end_include

begin_include
include|#
directive|include
file|"regcache.h"
end_include

begin_include
include|#
directive|include
file|"i387-nat.h"
end_include

begin_include
include|#
directive|include
file|"i386-tdep.h"
end_include

begin_comment
comment|/* FIXME: kettenis/2000-05-21: Right now more than a few i386 targets    define their own routines to manage the floating-point registers in    GDB's register array.  Most (if not all) of these targets use the    format used by the "fsave" instruction in their communication with    the OS.  They should all be converted to use the routines below.  */
end_comment

begin_comment
comment|/* At fsave_offset[REGNUM] you'll find the offset to the location in    the data structure used by the "fsave" instruction where GDB    register REGNUM is stored.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|fsave_offset
index|[]
init|=
block|{
literal|28
operator|+
literal|0
operator|*
name|FPU_REG_RAW_SIZE
block|,
comment|/* FP0_REGNUM through ...  */
literal|28
operator|+
literal|1
operator|*
name|FPU_REG_RAW_SIZE
block|,
literal|28
operator|+
literal|2
operator|*
name|FPU_REG_RAW_SIZE
block|,
literal|28
operator|+
literal|3
operator|*
name|FPU_REG_RAW_SIZE
block|,
literal|28
operator|+
literal|4
operator|*
name|FPU_REG_RAW_SIZE
block|,
literal|28
operator|+
literal|5
operator|*
name|FPU_REG_RAW_SIZE
block|,
literal|28
operator|+
literal|6
operator|*
name|FPU_REG_RAW_SIZE
block|,
literal|28
operator|+
literal|7
operator|*
name|FPU_REG_RAW_SIZE
block|,
comment|/* ... FP7_REGNUM.  */
literal|0
block|,
comment|/* FCTRL_REGNUM (16 bits).  */
literal|4
block|,
comment|/* FSTAT_REGNUM (16 bits).  */
literal|8
block|,
comment|/* FTAG_REGNUM (16 bits).  */
literal|16
block|,
comment|/* FISEG_REGNUM (16 bits).  */
literal|12
block|,
comment|/* FIOFF_REGNUM.  */
literal|24
block|,
comment|/* FOSEG_REGNUM.  */
literal|20
block|,
comment|/* FOOFF_REGNUM.  */
literal|18
comment|/* FOP_REGNUM (bottom 11 bits).  */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|FSAVE_ADDR
parameter_list|(
name|fsave
parameter_list|,
name|regnum
parameter_list|)
value|(fsave + fsave_offset[regnum - FP0_REGNUM])
end_define

begin_escape
end_escape

begin_comment
comment|/* Fill register REGNUM in GDB's register array with the appropriate    value from *FSAVE.  This function masks off any of the reserved    bits in *FSAVE.  */
end_comment

begin_function
name|void
name|i387_supply_register
parameter_list|(
name|int
name|regnum
parameter_list|,
name|char
modifier|*
name|fsave
parameter_list|)
block|{
comment|/* Most of the FPU control registers occupy only 16 bits in      the fsave area.  Give those a special treatment.  */
if|if
condition|(
name|regnum
operator|>=
name|FPC_REGNUM
operator|&&
name|regnum
operator|!=
name|FIOFF_REGNUM
operator|&&
name|regnum
operator|!=
name|FOOFF_REGNUM
condition|)
block|{
name|unsigned
name|int
name|val
init|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
name|FSAVE_ADDR
argument_list|(
name|fsave
argument_list|,
name|regnum
argument_list|)
operator|)
decl_stmt|;
if|if
condition|(
name|regnum
operator|==
name|FOP_REGNUM
condition|)
block|{
name|val
operator|&=
operator|(
operator|(
literal|1
operator|<<
literal|11
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|supply_register
argument_list|(
name|regnum
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|val
argument_list|)
expr_stmt|;
block|}
else|else
name|supply_register
argument_list|(
name|regnum
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|val
argument_list|)
expr_stmt|;
block|}
else|else
name|supply_register
argument_list|(
name|regnum
argument_list|,
name|FSAVE_ADDR
argument_list|(
name|fsave
argument_list|,
name|regnum
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Fill GDB's register array with the floating-point register values    in *FSAVE.  This function masks off any of the reserved    bits in *FSAVE.  */
end_comment

begin_function
name|void
name|i387_supply_fsave
parameter_list|(
name|char
modifier|*
name|fsave
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|FP0_REGNUM
init|;
name|i
operator|<
name|XMM0_REGNUM
condition|;
name|i
operator|++
control|)
name|i387_supply_register
argument_list|(
name|i
argument_list|,
name|fsave
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Fill register REGNUM (if it is a floating-point register) in *FSAVE    with the value in GDB's register array.  If REGNUM is -1, do this    for all registers.  This function doesn't touch any of the reserved    bits in *FSAVE.  */
end_comment

begin_function
name|void
name|i387_fill_fsave
parameter_list|(
name|char
modifier|*
name|fsave
parameter_list|,
name|int
name|regnum
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|FP0_REGNUM
init|;
name|i
operator|<
name|XMM0_REGNUM
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|regnum
operator|==
operator|-
literal|1
operator|||
name|regnum
operator|==
name|i
condition|)
block|{
comment|/* Most of the FPU control registers occupy only 16 bits in            the fsave area.  Give those a special treatment.  */
if|if
condition|(
name|i
operator|>=
name|FPC_REGNUM
operator|&&
name|i
operator|!=
name|FIOFF_REGNUM
operator|&&
name|i
operator|!=
name|FOOFF_REGNUM
condition|)
block|{
if|if
condition|(
name|i
operator|==
name|FOP_REGNUM
condition|)
block|{
name|unsigned
name|short
name|oldval
decl_stmt|,
name|newval
decl_stmt|;
comment|/* The opcode occupies only 11 bits.  */
name|oldval
operator|=
operator|(
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
name|FSAVE_ADDR
argument_list|(
name|fsave
argument_list|,
name|i
argument_list|)
operator|)
operator|)
expr_stmt|;
name|newval
operator|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|registers
index|[
name|REGISTER_BYTE
argument_list|(
name|i
argument_list|)
index|]
expr_stmt|;
name|newval
operator|&=
operator|(
operator|(
literal|1
operator|<<
literal|11
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|newval
operator||=
name|oldval
operator|&
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|11
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|FSAVE_ADDR
argument_list|(
name|fsave
argument_list|,
name|i
argument_list|)
argument_list|,
operator|&
name|newval
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
name|memcpy
argument_list|(
name|FSAVE_ADDR
argument_list|(
name|fsave
argument_list|,
name|i
argument_list|)
argument_list|,
operator|&
name|registers
index|[
name|REGISTER_BYTE
argument_list|(
name|i
argument_list|)
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
name|memcpy
argument_list|(
name|FSAVE_ADDR
argument_list|(
name|fsave
argument_list|,
name|i
argument_list|)
argument_list|,
operator|&
name|registers
index|[
name|REGISTER_BYTE
argument_list|(
name|i
argument_list|)
index|]
argument_list|,
name|REGISTER_RAW_SIZE
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* At fxsave_offset[REGNUM] you'll find the offset to the location in    the data structure used by the "fxsave" instruction where GDB    register REGNUM is stored.  */
end_comment

begin_decl_stmt
specifier|static
name|int
name|fxsave_offset
index|[]
init|=
block|{
literal|32
block|,
comment|/* FP0_REGNUM through ...  */
literal|48
block|,
literal|64
block|,
literal|80
block|,
literal|96
block|,
literal|112
block|,
literal|128
block|,
literal|144
block|,
comment|/* ... FP7_REGNUM (80 bits each).  */
literal|0
block|,
comment|/* FCTRL_REGNUM (16 bits).  */
literal|2
block|,
comment|/* FSTAT_REGNUM (16 bits).  */
literal|4
block|,
comment|/* FTAG_REGNUM (16 bits).  */
literal|12
block|,
comment|/* FISEG_REGNUM (16 bits).  */
literal|8
block|,
comment|/* FIOFF_REGNUM.  */
literal|20
block|,
comment|/* FOSEG_REGNUM (16 bits).  */
literal|16
block|,
comment|/* FOOFF_REGNUM.  */
literal|6
block|,
comment|/* FOP_REGNUM (bottom 11 bits).  */
literal|160
block|,
comment|/* XMM0_REGNUM through ...  */
literal|176
block|,
literal|192
block|,
literal|208
block|,
literal|224
block|,
literal|240
block|,
literal|256
block|,
literal|272
block|,
comment|/* ... XMM7_REGNUM (128 bits each).  */
literal|24
block|,
comment|/* MXCSR_REGNUM.  */
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|FXSAVE_ADDR
parameter_list|(
name|fxsave
parameter_list|,
name|regnum
parameter_list|)
define|\
value|(fxsave + fxsave_offset[regnum - FP0_REGNUM])
end_define

begin_function_decl
specifier|static
name|int
name|i387_tag
parameter_list|(
name|unsigned
name|char
modifier|*
name|raw
parameter_list|)
function_decl|;
end_function_decl

begin_escape
end_escape

begin_comment
comment|/* Fill GDB's register array with the floating-point and SSE register    values in *FXSAVE.  This function masks off any of the reserved    bits in *FXSAVE.  */
end_comment

begin_function
name|void
name|i387_supply_fxsave
parameter_list|(
name|char
modifier|*
name|fxsave
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|FP0_REGNUM
init|;
name|i
operator|<=
name|MXCSR_REGNUM
condition|;
name|i
operator|++
control|)
block|{
comment|/* Most of the FPU control registers occupy only 16 bits in 	 the fxsave area.  Give those a special treatment.  */
if|if
condition|(
name|i
operator|>=
name|FPC_REGNUM
operator|&&
name|i
operator|<
name|XMM0_REGNUM
operator|&&
name|i
operator|!=
name|FIOFF_REGNUM
operator|&&
name|i
operator|!=
name|FOOFF_REGNUM
condition|)
block|{
name|unsigned
name|long
name|val
init|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
name|FXSAVE_ADDR
argument_list|(
name|fxsave
argument_list|,
name|i
argument_list|)
operator|)
decl_stmt|;
if|if
condition|(
name|i
operator|==
name|FOP_REGNUM
condition|)
block|{
name|val
operator|&=
operator|(
operator|(
literal|1
operator|<<
literal|11
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|supply_register
argument_list|(
name|i
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|val
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
name|FTAG_REGNUM
condition|)
block|{
comment|/* The fxsave area contains a simplified version of the                  tag word.  We have to look at the actual 80-bit FP                  data to recreate the traditional i387 tag word.  */
name|unsigned
name|long
name|ftag
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|fstat
decl_stmt|;
name|int
name|fpreg
decl_stmt|;
name|int
name|top
decl_stmt|;
name|fstat
operator|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
name|FXSAVE_ADDR
argument_list|(
name|fxsave
argument_list|,
name|FSTAT_REGNUM
argument_list|)
operator|)
expr_stmt|;
name|top
operator|=
operator|(
operator|(
name|fstat
operator|>>
literal|11
operator|)
operator|&
literal|0x7
operator|)
expr_stmt|;
for|for
control|(
name|fpreg
operator|=
literal|7
init|;
name|fpreg
operator|>=
literal|0
condition|;
name|fpreg
operator|--
control|)
block|{
name|int
name|tag
decl_stmt|;
if|if
condition|(
name|val
operator|&
operator|(
literal|1
operator|<<
name|fpreg
operator|)
condition|)
block|{
name|int
name|regnum
init|=
operator|(
name|fpreg
operator|+
literal|8
operator|-
name|top
operator|)
operator|%
literal|8
operator|+
name|FP0_REGNUM
decl_stmt|;
name|tag
operator|=
name|i387_tag
argument_list|(
name|FXSAVE_ADDR
argument_list|(
name|fxsave
argument_list|,
name|regnum
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|tag
operator|=
literal|3
expr_stmt|;
comment|/* Empty */
name|ftag
operator||=
name|tag
operator|<<
operator|(
literal|2
operator|*
name|fpreg
operator|)
expr_stmt|;
block|}
name|supply_register
argument_list|(
name|i
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ftag
argument_list|)
expr_stmt|;
block|}
else|else
name|supply_register
argument_list|(
name|i
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|val
argument_list|)
expr_stmt|;
block|}
else|else
name|supply_register
argument_list|(
name|i
argument_list|,
name|FXSAVE_ADDR
argument_list|(
name|fxsave
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Fill register REGNUM (if it is a floating-point or SSE register) in    *FXSAVE with the value in GDB's register array.  If REGNUM is -1, do    this for all registers.  This function doesn't touch any of the    reserved bits in *FXSAVE.  */
end_comment

begin_function
name|void
name|i387_fill_fxsave
parameter_list|(
name|char
modifier|*
name|fxsave
parameter_list|,
name|int
name|regnum
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
name|FP0_REGNUM
init|;
name|i
operator|<=
name|MXCSR_REGNUM
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|regnum
operator|==
operator|-
literal|1
operator|||
name|regnum
operator|==
name|i
condition|)
block|{
comment|/* Most of the FPU control registers occupy only 16 bits in            the fxsave area.  Give those a special treatment.  */
if|if
condition|(
name|i
operator|>=
name|FPC_REGNUM
operator|&&
name|i
operator|<
name|XMM0_REGNUM
operator|&&
name|i
operator|!=
name|FIOFF_REGNUM
operator|&&
name|i
operator|!=
name|FDOFF_REGNUM
condition|)
block|{
if|if
condition|(
name|i
operator|==
name|FOP_REGNUM
condition|)
block|{
name|unsigned
name|short
name|oldval
decl_stmt|,
name|newval
decl_stmt|;
comment|/* The opcode occupies only 11 bits.  */
name|oldval
operator|=
operator|(
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|(
name|FXSAVE_ADDR
argument_list|(
name|fxsave
argument_list|,
name|i
argument_list|)
operator|)
operator|)
expr_stmt|;
name|newval
operator|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|registers
index|[
name|REGISTER_BYTE
argument_list|(
name|i
argument_list|)
index|]
expr_stmt|;
name|newval
operator|&=
operator|(
operator|(
literal|1
operator|<<
literal|11
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|newval
operator||=
name|oldval
operator|&
operator|~
operator|(
operator|(
literal|1
operator|<<
literal|11
operator|)
operator|-
literal|1
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|FXSAVE_ADDR
argument_list|(
name|fxsave
argument_list|,
name|i
argument_list|)
argument_list|,
operator|&
name|newval
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|i
operator|==
name|FTAG_REGNUM
condition|)
block|{
comment|/* Converting back is much easier.  */
name|unsigned
name|short
name|val
init|=
literal|0
decl_stmt|;
name|unsigned
name|short
name|ftag
decl_stmt|;
name|int
name|fpreg
decl_stmt|;
name|ftag
operator|=
operator|*
operator|(
name|unsigned
name|short
operator|*
operator|)
operator|&
name|registers
index|[
name|REGISTER_BYTE
argument_list|(
name|i
argument_list|)
index|]
expr_stmt|;
for|for
control|(
name|fpreg
operator|=
literal|7
init|;
name|fpreg
operator|>=
literal|0
condition|;
name|fpreg
operator|--
control|)
block|{
name|int
name|tag
init|=
operator|(
name|ftag
operator|>>
operator|(
name|fpreg
operator|*
literal|2
operator|)
operator|)
operator|&
literal|3
decl_stmt|;
if|if
condition|(
name|tag
operator|!=
literal|3
condition|)
name|val
operator||=
operator|(
literal|1
operator|<<
name|fpreg
operator|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|FXSAVE_ADDR
argument_list|(
name|fxsave
argument_list|,
name|i
argument_list|)
argument_list|,
operator|&
name|val
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
name|memcpy
argument_list|(
name|FXSAVE_ADDR
argument_list|(
name|fxsave
argument_list|,
name|i
argument_list|)
argument_list|,
operator|&
name|registers
index|[
name|REGISTER_BYTE
argument_list|(
name|i
argument_list|)
index|]
argument_list|,
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
name|memcpy
argument_list|(
name|FXSAVE_ADDR
argument_list|(
name|fxsave
argument_list|,
name|i
argument_list|)
argument_list|,
operator|&
name|registers
index|[
name|REGISTER_BYTE
argument_list|(
name|i
argument_list|)
index|]
argument_list|,
name|REGISTER_RAW_SIZE
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Recreate the FTW (tag word) valid bits from the 80-bit FP data in    *RAW.  */
end_comment

begin_function
specifier|static
name|int
name|i387_tag
parameter_list|(
name|unsigned
name|char
modifier|*
name|raw
parameter_list|)
block|{
name|int
name|integer
decl_stmt|;
name|unsigned
name|int
name|exponent
decl_stmt|;
name|unsigned
name|long
name|fraction
index|[
literal|2
index|]
decl_stmt|;
name|integer
operator|=
name|raw
index|[
literal|7
index|]
operator|&
literal|0x80
expr_stmt|;
name|exponent
operator|=
operator|(
operator|(
operator|(
name|raw
index|[
literal|9
index|]
operator|&
literal|0x7f
operator|)
operator|<<
literal|8
operator|)
operator||
name|raw
index|[
literal|8
index|]
operator|)
expr_stmt|;
name|fraction
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|raw
index|[
literal|3
index|]
operator|<<
literal|24
operator|)
operator||
operator|(
name|raw
index|[
literal|2
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|raw
index|[
literal|1
index|]
operator|<<
literal|8
operator|)
operator||
name|raw
index|[
literal|0
index|]
operator|)
expr_stmt|;
name|fraction
index|[
literal|1
index|]
operator|=
operator|(
operator|(
operator|(
name|raw
index|[
literal|7
index|]
operator|&
literal|0x7f
operator|)
operator|<<
literal|24
operator|)
operator||
operator|(
name|raw
index|[
literal|6
index|]
operator|<<
literal|16
operator|)
operator||
operator|(
name|raw
index|[
literal|5
index|]
operator|<<
literal|8
operator|)
operator||
name|raw
index|[
literal|4
index|]
operator|)
expr_stmt|;
if|if
condition|(
name|exponent
operator|==
literal|0x7fff
condition|)
block|{
comment|/* Special.  */
return|return
operator|(
literal|2
operator|)
return|;
block|}
elseif|else
if|if
condition|(
name|exponent
operator|==
literal|0x0000
condition|)
block|{
if|if
condition|(
name|fraction
index|[
literal|0
index|]
operator|==
literal|0x0000
operator|&&
name|fraction
index|[
literal|1
index|]
operator|==
literal|0x0000
operator|&&
operator|!
name|integer
condition|)
block|{
comment|/* Zero.  */
return|return
operator|(
literal|1
operator|)
return|;
block|}
else|else
block|{
comment|/* Special.  */
return|return
operator|(
literal|2
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|integer
condition|)
block|{
comment|/* Valid.  */
return|return
operator|(
literal|0
operator|)
return|;
block|}
else|else
block|{
comment|/* Special.  */
return|return
operator|(
literal|2
operator|)
return|;
block|}
block|}
block|}
end_function

end_unit


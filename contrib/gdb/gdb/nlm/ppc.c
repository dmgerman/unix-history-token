begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<nwtypes.h>
end_include

begin_include
include|#
directive|include
file|<nwdfs.h>
end_include

begin_include
include|#
directive|include
file|<nwconio.h>
end_include

begin_include
include|#
directive|include
file|<nwadv.h>
end_include

begin_include
include|#
directive|include
file|<nwdbgapi.h>
end_include

begin_include
include|#
directive|include
file|<nwthread.h>
end_include

begin_include
include|#
directive|include
file|"ppc.h"
end_include

begin_function_decl
specifier|extern
name|char
modifier|*
name|mem2hex
parameter_list|(
name|void
modifier|*
name|mem
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|may_fault
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|hex2mem
parameter_list|(
name|char
modifier|*
name|buf
parameter_list|,
name|void
modifier|*
name|mem
parameter_list|,
name|int
name|count
parameter_list|,
name|int
name|may_fault
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|computeSignal
parameter_list|(
name|int
name|exceptionVector
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|void
name|flush_i_cache
parameter_list|(
name|void
parameter_list|)
block|{ }
end_function

begin_comment
comment|/* Get the registers out of the frame information.  */
end_comment

begin_function
name|void
name|frame_to_registers
parameter_list|(
name|struct
name|StackFrame
modifier|*
name|frame
parameter_list|,
name|char
modifier|*
name|regs
parameter_list|)
block|{
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|CsavedRegs
argument_list|,
operator|&
name|regs
index|[
name|GP0_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
literal|4
operator|*
literal|32
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|CSavedFPRegs
argument_list|,
operator|&
name|regs
index|[
name|FP0_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
literal|4
operator|*
literal|32
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionPC
argument_list|,
operator|&
name|regs
index|[
name|PC_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedSRR1
argument_list|,
operator|&
name|regs
index|[
name|CR_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedLR
argument_list|,
operator|&
name|regs
index|[
name|LR_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedCTR
argument_list|,
operator|&
name|regs
index|[
name|CTR_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedXER
argument_list|,
operator|&
name|regs
index|[
name|XER_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedMQ
argument_list|,
operator|&
name|regs
index|[
name|MQ_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Put the registers back into the frame information.  */
end_comment

begin_function
name|void
name|registers_to_frame
parameter_list|(
name|char
modifier|*
name|regs
parameter_list|,
name|struct
name|StackFrame
modifier|*
name|frame
parameter_list|)
block|{
name|hex2mem
argument_list|(
operator|&
name|regs
index|[
name|GP0_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|CsavedRegs
argument_list|,
literal|4
operator|*
literal|32
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hex2mem
argument_list|(
operator|&
name|regs
index|[
name|FP0_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|CSavedFPRegs
argument_list|,
literal|4
operator|*
literal|32
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hex2mem
argument_list|(
operator|&
name|regs
index|[
name|PC_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
operator|&
name|frame
operator|->
name|ExceptionPC
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hex2mem
argument_list|(
operator|&
name|regs
index|[
name|CR_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedSRR1
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hex2mem
argument_list|(
operator|&
name|regs
index|[
name|LR_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedLR
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hex2mem
argument_list|(
operator|&
name|regs
index|[
name|CTR_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedCTR
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hex2mem
argument_list|(
operator|&
name|regs
index|[
name|XER_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedXER
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|hex2mem
argument_list|(
operator|&
name|regs
index|[
name|MQ_REGNUM
operator|*
literal|4
operator|*
literal|2
index|]
argument_list|,
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedMQ
argument_list|,
literal|4
operator|*
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_decl_stmt
specifier|extern
specifier|volatile
name|int
name|mem_err
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|ALTERNATE_MEM_FUNCS
end_ifdef

begin_function_decl
specifier|extern
name|int
name|ReadByteAltDebugger
parameter_list|(
name|char
modifier|*
name|addr
parameter_list|,
name|char
modifier|*
name|theByte
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|int
name|WriteByteAltDebugger
parameter_list|(
name|char
modifier|*
name|addr
parameter_list|,
name|char
name|theByte
parameter_list|)
function_decl|;
end_function_decl

begin_function
name|int
name|get_char
parameter_list|(
name|char
modifier|*
name|addr
parameter_list|)
block|{
name|char
name|c
decl_stmt|;
if|if
condition|(
operator|!
name|ReadByteAltDebugger
argument_list|(
name|addr
argument_list|,
operator|&
name|c
argument_list|)
condition|)
name|mem_err
operator|=
literal|1
expr_stmt|;
return|return
name|c
return|;
block|}
end_function

begin_function
name|void
name|set_char
parameter_list|(
name|char
modifier|*
name|addr
parameter_list|,
name|int
name|val
parameter_list|)
block|{
if|if
condition|(
operator|!
name|WriteByteAltDebugger
argument_list|(
name|addr
argument_list|,
name|val
argument_list|)
condition|)
name|mem_err
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|int
name|mem_write
parameter_list|(
name|char
modifier|*
name|dst
parameter_list|,
name|char
modifier|*
name|src
parameter_list|,
name|int
name|len
parameter_list|)
block|{
while|while
condition|(
name|len
operator|--
operator|&&
operator|!
name|mem_err
condition|)
name|set_char
argument_list|(
name|dst
operator|++
argument_list|,
operator|*
name|src
operator|++
argument_list|)
expr_stmt|;
return|return
name|mem_err
return|;
block|}
end_function

begin_union
union|union
name|inst
block|{
name|LONG
name|l
decl_stmt|;
struct|struct
block|{
union|union
block|{
struct|struct
comment|/* Unconditional branch */
block|{
name|unsigned
name|opcode
range|:
literal|6
decl_stmt|;
comment|/* 18 */
name|signed
name|li
range|:
literal|24
decl_stmt|;
name|unsigned
name|aa
range|:
literal|1
decl_stmt|;
name|unsigned
name|lk
range|:
literal|1
decl_stmt|;
block|}
name|b
struct|;
struct|struct
comment|/* Conditional branch */
block|{
name|unsigned
name|opcode
range|:
literal|6
decl_stmt|;
comment|/* 16 */
name|unsigned
name|bo
range|:
literal|5
decl_stmt|;
name|unsigned
name|bi
range|:
literal|5
decl_stmt|;
name|signed
name|bd
range|:
literal|14
decl_stmt|;
name|unsigned
name|aa
range|:
literal|1
decl_stmt|;
name|unsigned
name|lk
range|:
literal|1
decl_stmt|;
block|}
name|bc
struct|;
struct|struct
comment|/* Conditional branch to ctr or lr reg */
block|{
name|unsigned
name|opcode
range|:
literal|6
decl_stmt|;
comment|/* 19 */
name|unsigned
name|bo
range|:
literal|5
decl_stmt|;
name|unsigned
name|bi
range|:
literal|5
decl_stmt|;
name|unsigned
name|type
range|:
literal|15
decl_stmt|;
comment|/* 528 = ctr, 16 = lr */
name|unsigned
name|lk
range|:
literal|1
decl_stmt|;
block|}
name|bclr
struct|;
block|}
name|variant
union|;
block|}
name|inst
struct|;
block|}
union|;
end_union

begin_decl_stmt
specifier|static
name|LONG
name|saved_inst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|LONG
modifier|*
name|saved_inst_pc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|LONG
name|saved_target_inst
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|LONG
modifier|*
name|saved_target_inst_pc
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|set_step_traps
parameter_list|(
name|struct
name|StackFrame
modifier|*
name|frame
parameter_list|)
block|{
name|union
name|inst
name|inst
decl_stmt|;
name|LONG
modifier|*
name|target
decl_stmt|;
name|int
name|opcode
decl_stmt|;
name|int
name|ra
decl_stmt|,
name|rb
decl_stmt|;
name|LONG
modifier|*
name|pc
init|=
operator|(
name|LONG
operator|*
operator|)
name|frame
operator|->
name|ExceptionPC
decl_stmt|;
name|inst
operator|.
name|l
operator|=
operator|*
name|pc
operator|++
expr_stmt|;
name|opcode
operator|=
name|inst
operator|.
name|inst
operator|.
name|variant
operator|.
name|b
operator|.
name|opcode
expr_stmt|;
name|target
operator|=
name|pc
expr_stmt|;
switch|switch
condition|(
name|opcode
condition|)
block|{
case|case
literal|18
case|:
comment|/* Unconditional branch */
if|if
condition|(
name|inst
operator|.
name|inst
operator|.
name|variant
operator|.
name|b
operator|.
name|aa
condition|)
comment|/* Absolute? */
name|target
operator|=
literal|0
expr_stmt|;
name|target
operator|+=
name|inst
operator|.
name|inst
operator|.
name|variant
operator|.
name|b
operator|.
name|li
expr_stmt|;
break|break;
case|case
literal|16
case|:
comment|/* Conditional branch */
if|if
condition|(
operator|!
name|inst
operator|.
name|inst
operator|.
name|variant
operator|.
name|bc
operator|.
name|aa
condition|)
comment|/* Absolute? */
name|target
operator|=
literal|0
expr_stmt|;
name|target
operator|+=
name|inst
operator|.
name|inst
operator|.
name|variant
operator|.
name|bc
operator|.
name|bd
expr_stmt|;
break|break;
case|case
literal|19
case|:
comment|/* Cond. branch via ctr or lr reg */
switch|switch
condition|(
name|inst
operator|.
name|inst
operator|.
name|variant
operator|.
name|bclr
operator|.
name|type
condition|)
block|{
case|case
literal|528
case|:
comment|/* ctr */
name|target
operator|=
operator|(
name|LONG
operator|*
operator|)
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedCTR
expr_stmt|;
break|break;
case|case
literal|16
case|:
comment|/* lr */
name|target
operator|=
operator|(
name|LONG
operator|*
operator|)
name|frame
operator|->
name|ExceptionState
operator|.
name|u
operator|.
name|SpecialRegistersEnumerated
operator|.
name|CsavedLR
expr_stmt|;
break|break;
block|}
break|break;
block|}
name|saved_inst
operator|=
operator|*
name|pc
expr_stmt|;
name|mem_write
argument_list|(
name|pc
argument_list|,
name|breakpoint_insn
argument_list|,
name|BREAKPOINT_SIZE
argument_list|)
expr_stmt|;
name|saved_inst_pc
operator|=
name|pc
expr_stmt|;
if|if
condition|(
name|target
operator|!=
name|pc
condition|)
block|{
name|saved_target_inst
operator|=
operator|*
name|target
expr_stmt|;
name|mem_write
argument_list|(
name|target
argument_list|,
name|breakpoint_insn
argument_list|,
name|BREAKPOINT_SIZE
argument_list|)
expr_stmt|;
name|saved_target_inst_pc
operator|=
name|target
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Remove step breakpoints.  Returns non-zero if pc was at a step breakpoint,    zero otherwise.  This routine works even if there were no step breakpoints    set.  */
end_comment

begin_function
name|int
name|clear_step_traps
parameter_list|(
name|struct
name|StackFrame
modifier|*
name|frame
parameter_list|)
block|{
name|int
name|retcode
decl_stmt|;
name|LONG
modifier|*
name|pc
init|=
operator|(
name|LONG
operator|*
operator|)
name|frame
operator|->
name|ExceptionPC
decl_stmt|;
if|if
condition|(
name|saved_inst_pc
operator|==
name|pc
operator|||
name|saved_target_inst_pc
operator|==
name|pc
condition|)
name|retcode
operator|=
literal|1
expr_stmt|;
else|else
name|retcode
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|saved_inst_pc
condition|)
block|{
name|mem_write
argument_list|(
name|saved_inst_pc
argument_list|,
name|saved_inst
argument_list|,
name|BREAKPOINT_SIZE
argument_list|)
expr_stmt|;
name|saved_inst_pc
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|saved_target_inst_pc
condition|)
block|{
name|mem_write
argument_list|(
name|saved_target_inst_pc
argument_list|,
name|saved_target_inst
argument_list|,
name|BREAKPOINT_SIZE
argument_list|)
expr_stmt|;
name|saved_target_inst_pc
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|retcode
return|;
block|}
end_function

begin_function
name|void
name|do_status
parameter_list|(
name|char
modifier|*
name|ptr
parameter_list|,
name|struct
name|StackFrame
modifier|*
name|frame
parameter_list|)
block|{
name|int
name|sigval
decl_stmt|;
name|sigval
operator|=
name|computeSignal
argument_list|(
name|frame
operator|->
name|ExceptionNumber
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|ptr
argument_list|,
literal|"T%02x"
argument_list|,
name|sigval
argument_list|)
expr_stmt|;
name|ptr
operator|+=
literal|3
expr_stmt|;
name|sprintf
argument_list|(
name|ptr
argument_list|,
literal|"%02x:"
argument_list|,
name|PC_REGNUM
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionPC
argument_list|,
name|ptr
operator|+
literal|3
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|';'
expr_stmt|;
name|sprintf
argument_list|(
name|ptr
argument_list|,
literal|"%02x:"
argument_list|,
name|SP_REGNUM
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|CsavedRegs
index|[
name|SP_REGNUM
index|]
argument_list|,
name|ptr
operator|+
literal|3
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|';'
expr_stmt|;
name|sprintf
argument_list|(
name|ptr
argument_list|,
literal|"%02x:"
argument_list|,
name|LR_REGNUM
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|mem2hex
argument_list|(
operator|&
name|frame
operator|->
name|ExceptionState
operator|.
name|CsavedRegs
index|[
name|LR_REGNUM
index|]
argument_list|,
name|ptr
operator|+
literal|3
argument_list|,
literal|4
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
literal|';'
expr_stmt|;
operator|*
name|ptr
operator|=
literal|'\000'
expr_stmt|;
block|}
end_function

end_unit


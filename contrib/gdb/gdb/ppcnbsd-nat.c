begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Native-dependent code for PowerPC's running NetBSD, for GDB.    Copyright 1988, 1989, 1991, 1992, 1994, 1996, 2000, 2001    Free Software Foundation, Inc.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ptrace.h>
end_include

begin_include
include|#
directive|include
file|<machine/reg.h>
end_include

begin_include
include|#
directive|include
file|<machine/frame.h>
end_include

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"inferior.h"
end_include

begin_include
include|#
directive|include
file|"gdbcore.h"
end_include

begin_include
include|#
directive|include
file|"ppc-tdep.h"
end_include

begin_include
include|#
directive|include
file|"regcache.h"
end_include

begin_define
define|#
directive|define
name|RF
parameter_list|(
name|dst
parameter_list|,
name|src
parameter_list|)
define|\
value|memcpy(&registers[REGISTER_BYTE(dst)],&src, sizeof(src))
end_define

begin_define
define|#
directive|define
name|RS
parameter_list|(
name|src
parameter_list|,
name|dst
parameter_list|)
define|\
value|memcpy(&dst,&registers[REGISTER_BYTE(src)], sizeof(dst))
end_define

begin_function
name|void
name|fetch_inferior_registers
parameter_list|(
name|int
name|regno
parameter_list|)
block|{
name|struct
name|reg
name|inferior_registers
decl_stmt|;
ifdef|#
directive|ifdef
name|PT_GETFPREGS
name|struct
name|fpreg
name|inferior_fp_registers
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
name|ptrace
argument_list|(
name|PT_GETREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_registers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|RF
argument_list|(
name|i
argument_list|,
name|inferior_registers
operator|.
name|fixreg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_lr_regnum
argument_list|,
name|inferior_registers
operator|.
name|lr
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_cr_regnum
argument_list|,
name|inferior_registers
operator|.
name|cr
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_xer_regnum
argument_list|,
name|inferior_registers
operator|.
name|xer
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_ctr_regnum
argument_list|,
name|inferior_registers
operator|.
name|ctr
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|PC_REGNUM
argument_list|,
name|inferior_registers
operator|.
name|pc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PT_GETFPREGS
name|ptrace
argument_list|(
name|PT_GETFPREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_fp_registers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
name|i
argument_list|,
name|inferior_fp_registers
operator|.
name|fpreg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|registers_fetched
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
name|void
name|store_inferior_registers
parameter_list|(
name|int
name|regno
parameter_list|)
block|{
name|struct
name|reg
name|inferior_registers
decl_stmt|;
ifdef|#
directive|ifdef
name|PT_SETFPREGS
name|struct
name|fpreg
name|inferior_fp_registers
decl_stmt|;
endif|#
directive|endif
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|RS
argument_list|(
name|i
argument_list|,
name|inferior_registers
operator|.
name|fixreg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_lr_regnum
argument_list|,
name|inferior_registers
operator|.
name|lr
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_cr_regnum
argument_list|,
name|inferior_registers
operator|.
name|cr
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_xer_regnum
argument_list|,
name|inferior_registers
operator|.
name|xer
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_ctr_regnum
argument_list|,
name|inferior_registers
operator|.
name|ctr
argument_list|)
expr_stmt|;
name|RS
argument_list|(
name|PC_REGNUM
argument_list|,
name|inferior_registers
operator|.
name|pc
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|PT_SETREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_registers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PT_SETFPREGS
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|RS
argument_list|(
name|FP0_REGNUM
operator|+
name|i
argument_list|,
name|inferior_fp_registers
operator|.
name|fpreg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|ptrace
argument_list|(
name|PT_SETFPREGS
argument_list|,
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|,
operator|(
name|PTRACE_ARG3_TYPE
operator|)
operator|&
name|inferior_fp_registers
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_struct
struct|struct
name|md_core
block|{
name|struct
name|reg
name|intreg
decl_stmt|;
ifdef|#
directive|ifdef
name|PT_GETFPREGS
name|struct
name|fpreg
name|freg
decl_stmt|;
endif|#
directive|endif
block|}
struct|;
end_struct

begin_function
name|void
name|fetch_core_registers
parameter_list|(
name|char
modifier|*
name|core_reg_sect
parameter_list|,
name|unsigned
name|core_reg_size
parameter_list|,
name|int
name|which
parameter_list|,
name|CORE_ADDR
name|ignore
parameter_list|)
block|{
name|struct
name|md_core
modifier|*
name|core_reg
init|=
operator|(
expr|struct
name|md_core
operator|*
operator|)
name|core_reg_sect
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* Integer registers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|RF
argument_list|(
name|i
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|fixreg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_lr_regnum
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|lr
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_cr_regnum
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|cr
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_xer_regnum
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|xer
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|gdbarch_tdep
argument_list|(
name|current_gdbarch
argument_list|)
operator|->
name|ppc_ctr_regnum
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|ctr
argument_list|)
expr_stmt|;
name|RF
argument_list|(
name|PC_REGNUM
argument_list|,
name|core_reg
operator|->
name|intreg
operator|.
name|pc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|PT_FPGETREGS
comment|/* Floating point registers */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|32
condition|;
name|i
operator|++
control|)
name|RF
argument_list|(
name|FP0_REGNUM
operator|+
name|i
argument_list|,
name|core_reg
operator|->
name|freg
operator|.
name|fpreg
index|[
name|i
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|registers_fetched
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Register that we are able to handle ppcnbsd core file formats.    FIXME: is this really bfd_target_unknown_flavour? */
end_comment

begin_decl_stmt
specifier|static
name|struct
name|core_fns
name|ppcnbsd_core_fns
init|=
block|{
name|bfd_target_unknown_flavour
block|,
comment|/* core_flavour */
name|default_check_format
block|,
comment|/* check_format */
name|default_core_sniffer
block|,
comment|/* core_sniffer */
name|fetch_core_registers
block|,
comment|/* core_read_registers */
name|NULL
comment|/* next */
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|_initialize_ppcnbsd_nat
parameter_list|(
name|void
parameter_list|)
block|{
name|add_core_fns
argument_list|(
operator|&
name|ppcnbsd_core_fns
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Shared library support for RS/6000 (xcoff) object files, for GDB.    Copyright 1991, 1992, 1995, 1996, 1999, 2000, 2001    Free Software Foundation, Inc.    Contributed by IBM Corporation.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"xcoffsolib.h"
end_include

begin_include
include|#
directive|include
file|"inferior.h"
end_include

begin_include
include|#
directive|include
file|"gdbcmd.h"
end_include

begin_include
include|#
directive|include
file|"symfile.h"
end_include

begin_include
include|#
directive|include
file|"frame.h"
end_include

begin_include
include|#
directive|include
file|"gdb_regex.h"
end_include

begin_comment
comment|/* If ADDR lies in a shared library, return its name.    Note that returned name points to static data whose content is overwritten    by each call.  */
end_comment

begin_function
name|char
modifier|*
name|xcoff_solib_address
parameter_list|(
name|CORE_ADDR
name|addr
parameter_list|)
block|{
specifier|static
name|char
modifier|*
name|buffer
init|=
name|NULL
decl_stmt|;
name|struct
name|vmap
modifier|*
name|vp
init|=
name|vmap
decl_stmt|;
comment|/* The first vmap entry is for the exec file.  */
if|if
condition|(
name|vp
operator|==
name|NULL
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|vp
operator|=
name|vp
operator|->
name|nxt
init|;
name|vp
condition|;
name|vp
operator|=
name|vp
operator|->
name|nxt
control|)
if|if
condition|(
name|vp
operator|->
name|tstart
operator|<=
name|addr
operator|&&
name|addr
operator|<
name|vp
operator|->
name|tend
condition|)
block|{
name|xfree
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|xasprintf
argument_list|(
operator|&
name|buffer
argument_list|,
literal|"%s%s%s%s"
argument_list|,
name|vp
operator|->
name|name
argument_list|,
operator|*
name|vp
operator|->
name|member
condition|?
literal|"("
else|:
literal|""
argument_list|,
name|vp
operator|->
name|member
argument_list|,
operator|*
name|vp
operator|->
name|member
condition|?
literal|")"
else|:
literal|""
argument_list|)
expr_stmt|;
return|return
name|buffer
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function_decl
specifier|static
name|void
name|solib_info
parameter_list|(
name|char
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sharedlibrary_command
parameter_list|(
name|char
modifier|*
name|pattern
parameter_list|,
name|int
name|from_tty
parameter_list|)
function_decl|;
end_function_decl

begin_function
specifier|static
name|void
name|solib_info
parameter_list|(
name|char
modifier|*
name|args
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
name|struct
name|vmap
modifier|*
name|vp
init|=
name|vmap
decl_stmt|;
comment|/* Check for new shared libraries loaded with load ().  */
if|if
condition|(
operator|!
name|ptid_equal
argument_list|(
name|inferior_ptid
argument_list|,
name|null_ptid
argument_list|)
condition|)
name|xcoff_relocate_symtab
argument_list|(
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|vp
operator|==
name|NULL
operator|||
name|vp
operator|->
name|nxt
operator|==
name|NULL
condition|)
block|{
name|printf_unfiltered
argument_list|(
literal|"No shared libraries loaded at this time.\n"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* Skip over the first vmap, it is the main program, always loaded.  */
name|vp
operator|=
name|vp
operator|->
name|nxt
expr_stmt|;
name|printf_unfiltered
argument_list|(
literal|"\ Text Range		Data Range		Syms	Shared Object Library\n"
argument_list|)
expr_stmt|;
for|for
control|(
init|;
name|vp
operator|!=
name|NULL
condition|;
name|vp
operator|=
name|vp
operator|->
name|nxt
control|)
block|{
name|printf_unfiltered
argument_list|(
literal|"0x%s-0x%s	0x%s-0x%s	%s	%s%s%s%s\n"
argument_list|,
name|paddr
argument_list|(
name|vp
operator|->
name|tstart
argument_list|)
argument_list|,
name|paddr
argument_list|(
name|vp
operator|->
name|tend
argument_list|)
argument_list|,
name|paddr
argument_list|(
name|vp
operator|->
name|dstart
argument_list|)
argument_list|,
name|paddr
argument_list|(
name|vp
operator|->
name|dend
argument_list|)
argument_list|,
name|vp
operator|->
name|loaded
condition|?
literal|"Yes"
else|:
literal|"No "
argument_list|,
name|vp
operator|->
name|name
argument_list|,
operator|*
name|vp
operator|->
name|member
condition|?
literal|"("
else|:
literal|""
argument_list|,
name|vp
operator|->
name|member
argument_list|,
operator|*
name|vp
operator|->
name|member
condition|?
literal|")"
else|:
literal|""
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|sharedlibrary_command
parameter_list|(
name|char
modifier|*
name|pattern
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
name|dont_repeat
argument_list|()
expr_stmt|;
comment|/* Check for new shared libraries loaded with load ().  */
if|if
condition|(
operator|!
name|ptid_equal
argument_list|(
name|inferior_ptid
argument_list|,
name|null_ptid
argument_list|)
condition|)
name|xcoff_relocate_symtab
argument_list|(
name|PIDGET
argument_list|(
name|inferior_ptid
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|pattern
condition|)
block|{
name|char
modifier|*
name|re_err
init|=
name|re_comp
argument_list|(
name|pattern
argument_list|)
decl_stmt|;
if|if
condition|(
name|re_err
condition|)
name|error
argument_list|(
literal|"Invalid regexp: %s"
argument_list|,
name|re_err
argument_list|)
expr_stmt|;
block|}
comment|/* Walk the list of currently loaded shared libraries, and read      symbols for any that match the pattern --- or any whose symbols      aren't already loaded, if no pattern was given.  */
block|{
name|int
name|any_matches
init|=
literal|0
decl_stmt|;
name|int
name|loaded_any_symbols
init|=
literal|0
decl_stmt|;
name|struct
name|vmap
modifier|*
name|vp
init|=
name|vmap
decl_stmt|;
if|if
condition|(
operator|!
name|vp
condition|)
return|return;
comment|/* skip over the first vmap, it is the main program, always loaded. */
for|for
control|(
name|vp
operator|=
name|vp
operator|->
name|nxt
init|;
name|vp
condition|;
name|vp
operator|=
name|vp
operator|->
name|nxt
control|)
if|if
condition|(
operator|!
name|pattern
operator|||
name|re_exec
argument_list|(
name|vp
operator|->
name|name
argument_list|)
operator|||
operator|(
operator|*
name|vp
operator|->
name|member
operator|&&
name|re_exec
argument_list|(
name|vp
operator|->
name|member
argument_list|)
operator|)
condition|)
block|{
name|any_matches
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|vp
operator|->
name|loaded
condition|)
block|{
if|if
condition|(
name|from_tty
condition|)
name|printf_unfiltered
argument_list|(
literal|"Symbols already loaded for %s\n"
argument_list|,
name|vp
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|vmap_add_symbols
argument_list|(
name|vp
argument_list|)
condition|)
name|loaded_any_symbols
operator|=
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|from_tty
operator|&&
name|pattern
operator|&&
operator|!
name|any_matches
condition|)
name|printf_unfiltered
argument_list|(
literal|"No loaded shared libraries match the pattern `%s'.\n"
argument_list|,
name|pattern
argument_list|)
expr_stmt|;
if|if
condition|(
name|loaded_any_symbols
condition|)
block|{
comment|/* Getting new symbols may change our opinion about what is 	   frameless.  */
name|reinit_frame_cache
argument_list|()
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* LOCAL FUNCTION     no_shared_libraries -- handle command to explicitly discard symbols    from shared libraries.     DESCRIPTION     Implements the command "nosharedlibrary", which discards symbols    that have been auto-loaded from shared libraries.  Symbols from    shared libraries that were added by explicit request of the user    are not discarded.  Also called from remote.c.  */
end_comment

begin_function
name|void
name|no_shared_libraries
parameter_list|(
name|char
modifier|*
name|ignored
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
comment|/* FIXME */
block|}
end_function

begin_function
name|void
name|_initialize_xcoffsolib
parameter_list|(
name|void
parameter_list|)
block|{
name|add_com
argument_list|(
literal|"sharedlibrary"
argument_list|,
name|class_files
argument_list|,
name|sharedlibrary_command
argument_list|,
literal|"Load shared object library symbols for files matching REGEXP."
argument_list|)
expr_stmt|;
name|add_info
argument_list|(
literal|"sharedlibrary"
argument_list|,
name|solib_info
argument_list|,
literal|"Status of loaded shared object libraries"
argument_list|)
expr_stmt|;
name|add_show_from_set
argument_list|(
name|add_set_cmd
argument_list|(
literal|"auto-solib-add"
argument_list|,
name|class_support
argument_list|,
name|var_boolean
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|auto_solib_add
argument_list|,
literal|"Set autoloading of shared library symbols.\n\ If \"on\", symbols from all shared object libraries will be loaded\n\ automatically when the inferior begins execution, when the dynamic linker\n\ informs gdb that a new library has been loaded, or when attaching to the\n\ inferior.  Otherwise, symbols must be loaded manually, using `sharedlibrary'."
argument_list|,
operator|&
name|setlist
argument_list|)
argument_list|,
operator|&
name|showlist
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


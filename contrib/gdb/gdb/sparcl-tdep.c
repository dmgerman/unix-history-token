begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Target dependent code for the Fujitsu SPARClite for GDB, the GNU debugger.    Copyright 1994, 1995, 1996, 1998, 1999, 2000, 2001    Free Software Foundation, Inc.     This file is part of GDB.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330,    Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_include
include|#
directive|include
file|"gdbcore.h"
end_include

begin_include
include|#
directive|include
file|"breakpoint.h"
end_include

begin_include
include|#
directive|include
file|"target.h"
end_include

begin_include
include|#
directive|include
file|"serial.h"
end_include

begin_include
include|#
directive|include
file|"regcache.h"
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_if
if|#
directive|if
operator|(
operator|!
name|defined
argument_list|(
name|__GO32__
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|)
operator|||
name|defined
argument_list|(
name|__CYGWIN32__
argument_list|)
end_if

begin_define
define|#
directive|define
name|HAVE_SOCKETS
end_define

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_include
include|#
directive|include
file|<netdb.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|static
name|struct
name|target_ops
name|sparclite_ops
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|remote_target_name
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|serial
modifier|*
name|remote_desc
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|serial_flag
decl_stmt|;
end_decl_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SOCKETS
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|udp_fd
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|struct
name|serial
modifier|*
name|open_tty
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|send_resp
parameter_list|(
name|struct
name|serial
modifier|*
name|desc
parameter_list|,
name|char
name|c
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|close_tty
parameter_list|(
name|void
modifier|*
name|ignore
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SOCKETS
end_ifdef

begin_function_decl
specifier|static
name|int
name|recv_udp_buf
parameter_list|(
name|int
name|fd
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|timeout
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|send_udp_buf
parameter_list|(
name|int
name|fd
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|sparclite_open
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|from_tty
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sparclite_close
parameter_list|(
name|int
name|quitting
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|download
parameter_list|(
name|char
modifier|*
name|target_name
parameter_list|,
name|char
modifier|*
name|args
parameter_list|,
name|int
name|from_tty
parameter_list|,
name|void
function_decl|(
modifier|*
name|write_routine
function_decl|)
parameter_list|(
name|bfd
modifier|*
name|from_bfd
parameter_list|,
name|asection
modifier|*
name|from_sec
parameter_list|,
name|file_ptr
name|from_addr
parameter_list|,
name|bfd_vma
name|to_addr
parameter_list|,
name|int
name|len
parameter_list|)
parameter_list|,
name|void
function_decl|(
modifier|*
name|start_routine
function_decl|)
parameter_list|(
name|bfd_vma
name|entry
parameter_list|)
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sparclite_serial_start
parameter_list|(
name|bfd_vma
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sparclite_serial_write
parameter_list|(
name|bfd
modifier|*
name|from_bfd
parameter_list|,
name|asection
modifier|*
name|from_sec
parameter_list|,
name|file_ptr
name|from_addr
parameter_list|,
name|bfd_vma
name|to_addr
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SOCKETS
end_ifdef

begin_function_decl
specifier|static
name|unsigned
name|short
name|calc_checksum
parameter_list|(
name|unsigned
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|count
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sparclite_udp_start
parameter_list|(
name|bfd_vma
name|entry
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|void
name|sparclite_udp_write
parameter_list|(
name|bfd
modifier|*
name|from_bfd
parameter_list|,
name|asection
modifier|*
name|from_sec
parameter_list|,
name|file_ptr
name|from_addr
parameter_list|,
name|bfd_vma
name|to_addr
parameter_list|,
name|int
name|len
parameter_list|)
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|void
name|sparclite_download
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|from_tty
parameter_list|)
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|DDA2_SUP_ASI
value|0xb000000
end_define

begin_define
define|#
directive|define
name|DDA1_SUP_ASI
value|0xb0000
end_define

begin_define
define|#
directive|define
name|DDA2_ASI_MASK
value|0xff000000
end_define

begin_define
define|#
directive|define
name|DDA1_ASI_MASK
value|0xff0000
end_define

begin_define
define|#
directive|define
name|DIA2_SUP_MODE
value|0x8000
end_define

begin_define
define|#
directive|define
name|DIA1_SUP_MODE
value|0x4000
end_define

begin_define
define|#
directive|define
name|DDA2_ENABLE
value|0x100
end_define

begin_define
define|#
directive|define
name|DDA1_ENABLE
value|0x80
end_define

begin_define
define|#
directive|define
name|DIA2_ENABLE
value|0x40
end_define

begin_define
define|#
directive|define
name|DIA1_ENABLE
value|0x20
end_define

begin_define
define|#
directive|define
name|DSINGLE_STEP
value|0x10
end_define

begin_comment
comment|/* not used */
end_comment

begin_define
define|#
directive|define
name|DDV_TYPE_MASK
value|0xc
end_define

begin_define
define|#
directive|define
name|DDV_TYPE_LOAD
value|0x0
end_define

begin_define
define|#
directive|define
name|DDV_TYPE_STORE
value|0x4
end_define

begin_define
define|#
directive|define
name|DDV_TYPE_ACCESS
value|0x8
end_define

begin_define
define|#
directive|define
name|DDV_TYPE_ALWAYS
value|0xc
end_define

begin_define
define|#
directive|define
name|DDV_COND
value|0x2
end_define

begin_define
define|#
directive|define
name|DDV_MASK
value|0x1
end_define

begin_function
name|int
name|sparclite_insert_watchpoint
parameter_list|(
name|CORE_ADDR
name|addr
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|CORE_ADDR
name|dcr
decl_stmt|;
name|dcr
operator|=
name|read_register
argument_list|(
name|DCR_REGNUM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|dcr
operator|&
name|DDA1_ENABLE
operator|)
condition|)
block|{
name|write_register
argument_list|(
name|DDA1_REGNUM
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|dcr
operator|&=
operator|~
operator|(
name|DDA1_ASI_MASK
operator||
name|DDV_TYPE_MASK
operator|)
expr_stmt|;
name|dcr
operator||=
operator|(
name|DDA1_SUP_ASI
operator||
name|DDA1_ENABLE
operator|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
literal|1
condition|)
block|{
name|write_register
argument_list|(
name|DDV1_REGNUM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write_register
argument_list|(
name|DDV2_REGNUM
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|dcr
operator||=
operator|(
name|DDV_TYPE_LOAD
operator|&
operator|(
operator|~
name|DDV_COND
operator|&
operator|~
name|DDV_MASK
operator|)
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
literal|0
condition|)
block|{
name|write_register
argument_list|(
name|DDV1_REGNUM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write_register
argument_list|(
name|DDV2_REGNUM
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|dcr
operator||=
operator|(
name|DDV_TYPE_STORE
operator|&
operator|(
operator|~
name|DDV_COND
operator|&
operator|~
name|DDV_MASK
operator|)
operator|)
expr_stmt|;
block|}
else|else
block|{
name|write_register
argument_list|(
name|DDV1_REGNUM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write_register
argument_list|(
name|DDV2_REGNUM
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|dcr
operator||=
operator|(
name|DDV_TYPE_ACCESS
operator|)
expr_stmt|;
block|}
name|write_register
argument_list|(
name|DCR_REGNUM
argument_list|,
name|dcr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|dcr
operator|&
name|DDA2_ENABLE
operator|)
condition|)
block|{
name|write_register
argument_list|(
name|DDA2_REGNUM
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|dcr
operator|&=
operator|~
operator|(
name|DDA2_ASI_MASK
operator|&
name|DDV_TYPE_MASK
operator|)
expr_stmt|;
name|dcr
operator||=
operator|(
name|DDA2_SUP_ASI
operator||
name|DDA2_ENABLE
operator|)
expr_stmt|;
if|if
condition|(
name|type
operator|==
literal|1
condition|)
block|{
name|write_register
argument_list|(
name|DDV1_REGNUM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write_register
argument_list|(
name|DDV2_REGNUM
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|dcr
operator||=
operator|(
name|DDV_TYPE_LOAD
operator|&
operator|~
name|DDV_COND
operator|&
operator|~
name|DDV_MASK
operator|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|type
operator|==
literal|0
condition|)
block|{
name|write_register
argument_list|(
name|DDV1_REGNUM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write_register
argument_list|(
name|DDV2_REGNUM
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|dcr
operator||=
operator|(
name|DDV_TYPE_STORE
operator|&
operator|~
name|DDV_COND
operator|&
operator|~
name|DDV_MASK
operator|)
expr_stmt|;
block|}
else|else
block|{
name|write_register
argument_list|(
name|DDV1_REGNUM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write_register
argument_list|(
name|DDV2_REGNUM
argument_list|,
literal|0xffffffff
argument_list|)
expr_stmt|;
name|dcr
operator||=
operator|(
name|DDV_TYPE_ACCESS
operator|)
expr_stmt|;
block|}
name|write_register
argument_list|(
name|DCR_REGNUM
argument_list|,
name|dcr
argument_list|)
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sparclite_remove_watchpoint
parameter_list|(
name|CORE_ADDR
name|addr
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|type
parameter_list|)
block|{
name|CORE_ADDR
name|dcr
decl_stmt|,
name|dda1
decl_stmt|,
name|dda2
decl_stmt|;
name|dcr
operator|=
name|read_register
argument_list|(
name|DCR_REGNUM
argument_list|)
expr_stmt|;
name|dda1
operator|=
name|read_register
argument_list|(
name|DDA1_REGNUM
argument_list|)
expr_stmt|;
name|dda2
operator|=
name|read_register
argument_list|(
name|DDA2_REGNUM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dcr
operator|&
name|DDA1_ENABLE
operator|)
operator|&&
name|addr
operator|==
name|dda1
condition|)
name|write_register
argument_list|(
name|DCR_REGNUM
argument_list|,
operator|(
name|dcr
operator|&
operator|~
name|DDA1_ENABLE
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dcr
operator|&
name|DDA2_ENABLE
operator|)
operator|&&
name|addr
operator|==
name|dda2
condition|)
name|write_register
argument_list|(
name|DCR_REGNUM
argument_list|,
operator|(
name|dcr
operator|&
operator|~
name|DDA2_ENABLE
operator|)
argument_list|)
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sparclite_insert_hw_breakpoint
parameter_list|(
name|CORE_ADDR
name|addr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|CORE_ADDR
name|dcr
decl_stmt|;
name|dcr
operator|=
name|read_register
argument_list|(
name|DCR_REGNUM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|dcr
operator|&
name|DIA1_ENABLE
operator|)
condition|)
block|{
name|write_register
argument_list|(
name|DIA1_REGNUM
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|write_register
argument_list|(
name|DCR_REGNUM
argument_list|,
operator|(
name|dcr
operator||
name|DIA1_ENABLE
operator||
name|DIA1_SUP_MODE
operator|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|dcr
operator|&
name|DIA2_ENABLE
operator|)
condition|)
block|{
name|write_register
argument_list|(
name|DIA2_REGNUM
argument_list|,
name|addr
argument_list|)
expr_stmt|;
name|write_register
argument_list|(
name|DCR_REGNUM
argument_list|,
operator|(
name|dcr
operator||
name|DIA2_ENABLE
operator||
name|DIA2_SUP_MODE
operator|)
argument_list|)
expr_stmt|;
block|}
else|else
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sparclite_remove_hw_breakpoint
parameter_list|(
name|CORE_ADDR
name|addr
parameter_list|,
name|int
name|shadow
parameter_list|)
block|{
name|CORE_ADDR
name|dcr
decl_stmt|,
name|dia1
decl_stmt|,
name|dia2
decl_stmt|;
name|dcr
operator|=
name|read_register
argument_list|(
name|DCR_REGNUM
argument_list|)
expr_stmt|;
name|dia1
operator|=
name|read_register
argument_list|(
name|DIA1_REGNUM
argument_list|)
expr_stmt|;
name|dia2
operator|=
name|read_register
argument_list|(
name|DIA2_REGNUM
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|dcr
operator|&
name|DIA1_ENABLE
operator|)
operator|&&
name|addr
operator|==
name|dia1
condition|)
name|write_register
argument_list|(
name|DCR_REGNUM
argument_list|,
operator|(
name|dcr
operator|&
operator|~
name|DIA1_ENABLE
operator|)
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dcr
operator|&
name|DIA2_ENABLE
operator|)
operator|&&
name|addr
operator|==
name|dia2
condition|)
name|write_register
argument_list|(
name|DCR_REGNUM
argument_list|,
operator|(
name|dcr
operator|&
operator|~
name|DIA2_ENABLE
operator|)
argument_list|)
expr_stmt|;
else|else
return|return
operator|-
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|sparclite_check_watch_resources
parameter_list|(
name|int
name|type
parameter_list|,
name|int
name|cnt
parameter_list|,
name|int
name|ot
parameter_list|)
block|{
comment|/* Watchpoints not supported on simulator.  */
if|if
condition|(
name|strcmp
argument_list|(
name|target_shortname
argument_list|,
literal|"sim"
argument_list|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|type
operator|==
name|bp_hardware_breakpoint
condition|)
block|{
if|if
condition|(
name|TARGET_HW_BREAK_LIMIT
operator|==
literal|0
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|cnt
operator|<=
name|TARGET_HW_BREAK_LIMIT
condition|)
return|return
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|TARGET_HW_WATCH_LIMIT
operator|==
literal|0
condition|)
return|return
literal|0
return|;
elseif|else
if|if
condition|(
name|ot
condition|)
return|return
operator|-
literal|1
return|;
elseif|else
if|if
condition|(
name|cnt
operator|<=
name|TARGET_HW_WATCH_LIMIT
condition|)
return|return
literal|1
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|CORE_ADDR
name|sparclite_stopped_data_address
parameter_list|(
name|void
parameter_list|)
block|{
name|CORE_ADDR
name|dsr
decl_stmt|,
name|dda1
decl_stmt|,
name|dda2
decl_stmt|;
name|dsr
operator|=
name|read_register
argument_list|(
name|DSR_REGNUM
argument_list|)
expr_stmt|;
name|dda1
operator|=
name|read_register
argument_list|(
name|DDA1_REGNUM
argument_list|)
expr_stmt|;
name|dda2
operator|=
name|read_register
argument_list|(
name|DDA2_REGNUM
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsr
operator|&
literal|0x10
condition|)
return|return
name|dda1
return|;
elseif|else
if|if
condition|(
name|dsr
operator|&
literal|0x20
condition|)
return|return
name|dda2
return|;
else|else
return|return
literal|0
return|;
block|}
end_function

begin_escape
end_escape

begin_function
specifier|static
name|struct
name|serial
modifier|*
name|open_tty
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
name|struct
name|serial
modifier|*
name|desc
decl_stmt|;
name|desc
operator|=
name|serial_open
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|desc
condition|)
name|perror_with_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|baud_rate
operator|!=
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|serial_setbaudrate
argument_list|(
name|desc
argument_list|,
name|baud_rate
argument_list|)
condition|)
block|{
name|serial_close
argument_list|(
name|desc
argument_list|)
expr_stmt|;
name|perror_with_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
block|}
name|serial_raw
argument_list|(
name|desc
argument_list|)
expr_stmt|;
name|serial_flush_input
argument_list|(
name|desc
argument_list|)
expr_stmt|;
return|return
name|desc
return|;
block|}
end_function

begin_comment
comment|/* Read a single character from the remote end, masking it down to 7 bits. */
end_comment

begin_function
specifier|static
name|int
name|readchar
parameter_list|(
name|struct
name|serial
modifier|*
name|desc
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|int
name|ch
decl_stmt|;
name|char
name|s
index|[
literal|10
index|]
decl_stmt|;
name|ch
operator|=
name|serial_readchar
argument_list|(
name|desc
argument_list|,
name|timeout
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|SERIAL_EOF
case|:
name|error
argument_list|(
literal|"SPARClite remote connection closed"
argument_list|)
expr_stmt|;
case|case
name|SERIAL_ERROR
case|:
name|perror_with_name
argument_list|(
literal|"SPARClite communication error"
argument_list|)
expr_stmt|;
case|case
name|SERIAL_TIMEOUT
case|:
name|error
argument_list|(
literal|"SPARClite remote timeout"
argument_list|)
expr_stmt|;
default|default:
if|if
condition|(
name|remote_debug
operator|>
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"[%02x]"
argument_list|,
name|ch
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|puts_debug
argument_list|(
literal|"read -->"
argument_list|,
name|s
argument_list|,
literal|"<--"
argument_list|)
expr_stmt|;
block|}
return|return
name|ch
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|debug_serial_write
parameter_list|(
name|struct
name|serial
modifier|*
name|desc
parameter_list|,
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|char
name|s
index|[
literal|10
index|]
decl_stmt|;
name|serial_write
argument_list|(
name|desc
argument_list|,
name|buf
argument_list|,
name|len
argument_list|)
expr_stmt|;
if|if
condition|(
name|remote_debug
operator|>
literal|0
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|s
argument_list|,
literal|"[%02x]"
argument_list|,
operator|*
name|buf
operator|&
literal|0xff
argument_list|)
expr_stmt|;
name|puts_debug
argument_list|(
literal|"Sent -->"
argument_list|,
name|s
argument_list|,
literal|"<--"
argument_list|)
expr_stmt|;
name|buf
operator|++
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|send_resp
parameter_list|(
name|struct
name|serial
modifier|*
name|desc
parameter_list|,
name|char
name|c
parameter_list|)
block|{
name|debug_serial_write
argument_list|(
name|desc
argument_list|,
operator|&
name|c
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
name|readchar
argument_list|(
name|desc
argument_list|,
name|remote_timeout
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|close_tty
parameter_list|(
name|void
modifier|*
name|ignore
parameter_list|)
block|{
if|if
condition|(
operator|!
name|remote_desc
condition|)
return|return;
name|serial_close
argument_list|(
name|remote_desc
argument_list|)
expr_stmt|;
name|remote_desc
operator|=
name|NULL
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SOCKETS
end_ifdef

begin_function
specifier|static
name|int
name|recv_udp_buf
parameter_list|(
name|int
name|fd
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|,
name|int
name|timeout
parameter_list|)
block|{
name|int
name|cc
decl_stmt|;
name|fd_set
name|readfds
decl_stmt|;
name|FD_ZERO
argument_list|(
operator|&
name|readfds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|fd
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
if|if
condition|(
name|timeout
operator|>=
literal|0
condition|)
block|{
name|struct
name|timeval
name|timebuf
decl_stmt|;
name|timebuf
operator|.
name|tv_sec
operator|=
name|timeout
expr_stmt|;
name|timebuf
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|cc
operator|=
name|select
argument_list|(
name|fd
operator|+
literal|1
argument_list|,
operator|&
name|readfds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|timebuf
argument_list|)
expr_stmt|;
block|}
else|else
name|cc
operator|=
name|select
argument_list|(
name|fd
operator|+
literal|1
argument_list|,
operator|&
name|readfds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|==
literal|0
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|cc
operator|!=
literal|1
condition|)
name|perror_with_name
argument_list|(
literal|"recv_udp_buf: Bad return value from select:"
argument_list|)
expr_stmt|;
name|cc
operator|=
name|recv
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|<
literal|0
condition|)
name|perror_with_name
argument_list|(
literal|"Got an error from recv: "
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|send_udp_buf
parameter_list|(
name|int
name|fd
parameter_list|,
name|unsigned
name|char
modifier|*
name|buf
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|int
name|cc
decl_stmt|;
name|cc
operator|=
name|send
argument_list|(
name|fd
argument_list|,
name|buf
argument_list|,
name|len
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|==
name|len
condition|)
return|return;
if|if
condition|(
name|cc
operator|<
literal|0
condition|)
name|perror_with_name
argument_list|(
literal|"Got an error from send: "
argument_list|)
expr_stmt|;
name|error
argument_list|(
literal|"Short count in send: tried %d, sent %d\n"
argument_list|,
name|len
argument_list|,
name|cc
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SOCKETS */
end_comment

begin_function
specifier|static
name|void
name|sparclite_open
parameter_list|(
name|char
modifier|*
name|name
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
name|struct
name|cleanup
modifier|*
name|old_chain
decl_stmt|;
name|int
name|c
decl_stmt|;
name|char
modifier|*
name|p
decl_stmt|;
if|if
condition|(
operator|!
name|name
condition|)
name|error
argument_list|(
literal|"You need to specify what device or hostname is associated with the SparcLite board."
argument_list|)
expr_stmt|;
name|target_preopen
argument_list|(
name|from_tty
argument_list|)
expr_stmt|;
name|unpush_target
argument_list|(
operator|&
name|sparclite_ops
argument_list|)
expr_stmt|;
if|if
condition|(
name|remote_target_name
condition|)
name|xfree
argument_list|(
name|remote_target_name
argument_list|)
expr_stmt|;
name|remote_target_name
operator|=
name|xstrdup
argument_list|(
name|name
argument_list|)
expr_stmt|;
comment|/* We need a 'serial' or 'udp' keyword to disambiguate host:port, which can      mean either a serial port on a terminal server, or the IP address of a      SPARClite demo board.  If there's no colon, then it pretty much has to be      a local device (except for DOS... grrmble) */
name|p
operator|=
name|strchr
argument_list|(
name|name
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|'\000'
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|p
operator|!=
literal|'\000'
operator|)
operator|&&
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"serial"
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|serial_flag
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|name
argument_list|,
literal|"udp"
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|serial_flag
operator|=
literal|0
expr_stmt|;
else|else
name|error
argument_list|(
literal|"Must specify either `serial' or `udp'."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|p
operator|=
name|name
expr_stmt|;
if|if
condition|(
operator|!
name|strchr
argument_list|(
name|name
argument_list|,
literal|':'
argument_list|)
condition|)
name|serial_flag
operator|=
literal|1
expr_stmt|;
comment|/* No colon is unambiguous (local device) */
else|else
name|error
argument_list|(
literal|"Usage: target sparclite serial /dev/ttyb\n\ or: target sparclite udp host"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|serial_flag
condition|)
block|{
name|remote_desc
operator|=
name|open_tty
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|old_chain
operator|=
name|make_cleanup
argument_list|(
name|close_tty
argument_list|,
literal|0
comment|/*ignore*/
argument_list|)
expr_stmt|;
name|c
operator|=
name|send_resp
argument_list|(
name|remote_desc
argument_list|,
literal|0x00
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|!=
literal|0xaa
condition|)
name|error
argument_list|(
literal|"Unknown response (0x%x) from SparcLite.  Try resetting the board."
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|c
operator|=
name|send_resp
argument_list|(
name|remote_desc
argument_list|,
literal|0x55
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|!=
literal|0x55
condition|)
name|error
argument_list|(
literal|"Sparclite appears to be ill."
argument_list|)
expr_stmt|;
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|HAVE_SOCKETS
name|struct
name|hostent
modifier|*
name|he
decl_stmt|;
name|struct
name|sockaddr_in
name|sockaddr
decl_stmt|;
name|unsigned
name|char
name|buffer
index|[
literal|100
index|]
decl_stmt|;
name|int
name|cc
decl_stmt|;
comment|/* Setup the socket.  Must be raw UDP. */
name|he
operator|=
name|gethostbyname
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|he
condition|)
name|error
argument_list|(
literal|"No such host %s."
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|udp_fd
operator|=
name|socket
argument_list|(
name|PF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|old_chain
operator|=
name|make_cleanup
argument_list|(
name|close
argument_list|,
name|udp_fd
argument_list|)
expr_stmt|;
name|sockaddr
operator|.
name|sin_family
operator|=
name|PF_INET
expr_stmt|;
name|sockaddr
operator|.
name|sin_port
operator|=
name|htons
argument_list|(
literal|7000
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|sockaddr
operator|.
name|sin_addr
operator|.
name|s_addr
argument_list|,
name|he
operator|->
name|h_addr
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|in_addr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|connect
argument_list|(
name|udp_fd
argument_list|,
operator|&
name|sockaddr
argument_list|,
sizeof|sizeof
argument_list|(
name|sockaddr
argument_list|)
argument_list|)
condition|)
name|perror_with_name
argument_list|(
literal|"Connect failed"
argument_list|)
expr_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
literal|0x5
expr_stmt|;
name|buffer
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|send_udp_buf
argument_list|(
name|udp_fd
argument_list|,
name|buffer
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|/* Request version */
name|cc
operator|=
name|recv_udp_buf
argument_list|(
name|udp_fd
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
literal|5
argument_list|)
expr_stmt|;
comment|/* Get response */
if|if
condition|(
name|cc
operator|==
literal|0
condition|)
name|error
argument_list|(
literal|"SPARClite isn't responding."
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|<
literal|3
condition|)
name|error
argument_list|(
literal|"SPARClite appears to be ill."
argument_list|)
expr_stmt|;
else|#
directive|else
name|error
argument_list|(
literal|"UDP downloading is not supported for DOS hosts."
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* HAVE_SOCKETS */
block|}
name|printf_unfiltered
argument_list|(
literal|"[SPARClite appears to be alive]\n"
argument_list|)
expr_stmt|;
name|push_target
argument_list|(
operator|&
name|sparclite_ops
argument_list|)
expr_stmt|;
name|discard_cleanups
argument_list|(
name|old_chain
argument_list|)
expr_stmt|;
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|sparclite_close
parameter_list|(
name|int
name|quitting
parameter_list|)
block|{
if|if
condition|(
name|serial_flag
condition|)
name|close_tty
argument_list|(
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SOCKETS
elseif|else
if|if
condition|(
name|udp_fd
operator|!=
operator|-
literal|1
condition|)
name|close
argument_list|(
name|udp_fd
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_define
define|#
directive|define
name|LOAD_ADDRESS
value|0x40000000
end_define

begin_function
specifier|static
name|void
name|download
parameter_list|(
name|char
modifier|*
name|target_name
parameter_list|,
name|char
modifier|*
name|args
parameter_list|,
name|int
name|from_tty
parameter_list|,
name|void
function_decl|(
modifier|*
name|write_routine
function_decl|)
parameter_list|(
name|bfd
modifier|*
name|from_bfd
parameter_list|,
name|asection
modifier|*
name|from_sec
parameter_list|,
name|file_ptr
name|from_addr
parameter_list|,
name|bfd_vma
name|to_addr
parameter_list|,
name|int
name|len
parameter_list|)
parameter_list|,
name|void
function_decl|(
modifier|*
name|start_routine
function_decl|)
parameter_list|(
name|bfd_vma
name|entry
parameter_list|)
parameter_list|)
block|{
name|struct
name|cleanup
modifier|*
name|old_chain
decl_stmt|;
name|asection
modifier|*
name|section
decl_stmt|;
name|bfd
modifier|*
name|pbfd
decl_stmt|;
name|bfd_vma
name|entry
decl_stmt|;
name|int
name|i
decl_stmt|;
define|#
directive|define
name|WRITESIZE
value|1024
name|char
modifier|*
name|filename
decl_stmt|;
name|int
name|quiet
decl_stmt|;
name|int
name|nostart
decl_stmt|;
name|quiet
operator|=
literal|0
expr_stmt|;
name|nostart
operator|=
literal|0
expr_stmt|;
name|filename
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
operator|*
name|args
operator|!=
literal|'\000'
condition|)
block|{
name|char
modifier|*
name|arg
decl_stmt|;
while|while
condition|(
name|isspace
argument_list|(
operator|*
name|args
argument_list|)
condition|)
name|args
operator|++
expr_stmt|;
name|arg
operator|=
name|args
expr_stmt|;
while|while
condition|(
operator|(
operator|*
name|args
operator|!=
literal|'\000'
operator|)
operator|&&
operator|!
name|isspace
argument_list|(
operator|*
name|args
argument_list|)
condition|)
name|args
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|args
operator|!=
literal|'\000'
condition|)
operator|*
name|args
operator|++
operator|=
literal|'\000'
expr_stmt|;
if|if
condition|(
operator|*
name|arg
operator|!=
literal|'-'
condition|)
name|filename
operator|=
name|arg
expr_stmt|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|arg
argument_list|,
literal|"-quiet"
argument_list|,
name|strlen
argument_list|(
name|arg
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|quiet
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|arg
argument_list|,
literal|"-nostart"
argument_list|,
name|strlen
argument_list|(
name|arg
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|nostart
operator|=
literal|1
expr_stmt|;
else|else
name|error
argument_list|(
literal|"unknown option `%s'"
argument_list|,
name|arg
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|filename
condition|)
name|filename
operator|=
name|get_exec_file
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|pbfd
operator|=
name|bfd_openr
argument_list|(
name|filename
argument_list|,
name|gnutarget
argument_list|)
expr_stmt|;
if|if
condition|(
name|pbfd
operator|==
name|NULL
condition|)
block|{
name|perror_with_name
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
name|old_chain
operator|=
name|make_cleanup_bfd_close
argument_list|(
name|pbfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bfd_check_format
argument_list|(
name|pbfd
argument_list|,
name|bfd_object
argument_list|)
condition|)
name|error
argument_list|(
literal|"\"%s\" is not an object file: %s"
argument_list|,
name|filename
argument_list|,
name|bfd_errmsg
argument_list|(
name|bfd_get_error
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|section
operator|=
name|pbfd
operator|->
name|sections
init|;
name|section
condition|;
name|section
operator|=
name|section
operator|->
name|next
control|)
block|{
if|if
condition|(
name|bfd_get_section_flags
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|)
operator|&
name|SEC_LOAD
condition|)
block|{
name|bfd_vma
name|section_address
decl_stmt|;
name|bfd_size_type
name|section_size
decl_stmt|;
name|file_ptr
name|fptr
decl_stmt|;
specifier|const
name|char
modifier|*
name|section_name
decl_stmt|;
name|section_name
operator|=
name|bfd_get_section_name
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|)
expr_stmt|;
name|section_address
operator|=
name|bfd_get_section_vma
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|)
expr_stmt|;
comment|/* Adjust sections from a.out files, since they don't 	     carry their addresses with.  */
if|if
condition|(
name|bfd_get_flavour
argument_list|(
name|pbfd
argument_list|)
operator|==
name|bfd_target_aout_flavour
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|section_name
argument_list|,
literal|".text"
argument_list|)
operator|==
literal|0
condition|)
name|section_address
operator|=
name|bfd_get_start_address
argument_list|(
name|pbfd
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
name|section_name
argument_list|,
literal|".data"
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Read the first 8 bytes of the data section. 		     There should be the string 'DaTa' followed by 		     a word containing the actual section address. */
struct|struct
name|data_marker
block|{
name|char
name|signature
index|[
literal|4
index|]
decl_stmt|;
comment|/* 'DaTa' */
name|unsigned
name|char
name|sdata
index|[
literal|4
index|]
decl_stmt|;
comment|/*&sdata */
block|}
name|marker
struct|;
name|bfd_get_section_contents
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|,
operator|&
name|marker
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|marker
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|marker
operator|.
name|signature
argument_list|,
literal|"DaTa"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|TARGET_BYTE_ORDER
operator|==
name|BFD_ENDIAN_BIG
condition|)
name|section_address
operator|=
name|bfd_getb32
argument_list|(
name|marker
operator|.
name|sdata
argument_list|)
expr_stmt|;
else|else
name|section_address
operator|=
name|bfd_getl32
argument_list|(
name|marker
operator|.
name|sdata
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|section_size
operator|=
name|bfd_get_section_size_before_reloc
argument_list|(
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|quiet
condition|)
name|printf_filtered
argument_list|(
literal|"[Loading section %s at 0x%x (%d bytes)]\n"
argument_list|,
name|bfd_get_section_name
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|)
argument_list|,
name|section_address
argument_list|,
name|section_size
argument_list|)
expr_stmt|;
name|fptr
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|section_size
operator|>
literal|0
condition|)
block|{
name|int
name|count
decl_stmt|;
specifier|static
name|char
name|inds
index|[]
init|=
literal|"|/-\\"
decl_stmt|;
specifier|static
name|int
name|k
init|=
literal|0
decl_stmt|;
name|QUIT
expr_stmt|;
name|count
operator|=
name|min
argument_list|(
name|section_size
argument_list|,
name|WRITESIZE
argument_list|)
expr_stmt|;
name|write_routine
argument_list|(
name|pbfd
argument_list|,
name|section
argument_list|,
name|fptr
argument_list|,
name|section_address
argument_list|,
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|quiet
condition|)
block|{
name|printf_unfiltered
argument_list|(
literal|"\r%c"
argument_list|,
name|inds
index|[
name|k
operator|++
operator|%
literal|4
index|]
argument_list|)
expr_stmt|;
name|gdb_flush
argument_list|(
name|gdb_stdout
argument_list|)
expr_stmt|;
block|}
name|section_address
operator|+=
name|count
expr_stmt|;
name|fptr
operator|+=
name|count
expr_stmt|;
name|section_size
operator|-=
name|count
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|nostart
condition|)
block|{
name|entry
operator|=
name|bfd_get_start_address
argument_list|(
name|pbfd
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|quiet
condition|)
name|printf_unfiltered
argument_list|(
literal|"[Starting %s at 0x%x]\n"
argument_list|,
name|filename
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|start_routine
argument_list|(
name|entry
argument_list|)
expr_stmt|;
block|}
name|do_cleanups
argument_list|(
name|old_chain
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sparclite_serial_start
parameter_list|(
name|bfd_vma
name|entry
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|5
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
literal|0x03
expr_stmt|;
name|store_unsigned_integer
argument_list|(
name|buffer
operator|+
literal|1
argument_list|,
literal|4
argument_list|,
name|entry
argument_list|)
expr_stmt|;
name|debug_serial_write
argument_list|(
name|remote_desc
argument_list|,
name|buffer
argument_list|,
literal|1
operator|+
literal|4
argument_list|)
expr_stmt|;
name|i
operator|=
name|readchar
argument_list|(
name|remote_desc
argument_list|,
name|remote_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0x55
condition|)
name|error
argument_list|(
literal|"Can't start SparcLite.  Error code %d\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sparclite_serial_write
parameter_list|(
name|bfd
modifier|*
name|from_bfd
parameter_list|,
name|asection
modifier|*
name|from_sec
parameter_list|,
name|file_ptr
name|from_addr
parameter_list|,
name|bfd_vma
name|to_addr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|char
name|buffer
index|[
literal|4
operator|+
literal|4
operator|+
name|WRITESIZE
index|]
decl_stmt|;
comment|/* addr + len + data */
name|unsigned
name|char
name|checksum
decl_stmt|;
name|int
name|i
decl_stmt|;
name|store_unsigned_integer
argument_list|(
name|buffer
argument_list|,
literal|4
argument_list|,
name|to_addr
argument_list|)
expr_stmt|;
comment|/* Address */
name|store_unsigned_integer
argument_list|(
name|buffer
operator|+
literal|4
argument_list|,
literal|4
argument_list|,
name|len
argument_list|)
expr_stmt|;
comment|/* Length */
name|bfd_get_section_contents
argument_list|(
name|from_bfd
argument_list|,
name|from_sec
argument_list|,
name|buffer
operator|+
literal|8
argument_list|,
name|from_addr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|checksum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|checksum
operator|+=
name|buffer
index|[
literal|8
operator|+
name|i
index|]
expr_stmt|;
name|i
operator|=
name|send_resp
argument_list|(
name|remote_desc
argument_list|,
literal|0x01
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0x5a
condition|)
name|error
argument_list|(
literal|"Bad response from load command (0x%x)"
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|debug_serial_write
argument_list|(
name|remote_desc
argument_list|,
name|buffer
argument_list|,
literal|4
operator|+
literal|4
operator|+
name|len
argument_list|)
expr_stmt|;
name|i
operator|=
name|readchar
argument_list|(
name|remote_desc
argument_list|,
name|remote_timeout
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|!=
name|checksum
condition|)
name|error
argument_list|(
literal|"Bad checksum from load command (0x%x)"
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SOCKETS
end_ifdef

begin_function
specifier|static
name|unsigned
name|short
name|calc_checksum
parameter_list|(
name|unsigned
name|char
modifier|*
name|buffer
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|unsigned
name|short
name|checksum
decl_stmt|;
name|checksum
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
name|count
operator|>
literal|0
condition|;
name|count
operator|-=
literal|2
operator|,
name|buffer
operator|+=
literal|2
control|)
name|checksum
operator|+=
operator|(
operator|*
name|buffer
operator|<<
literal|8
operator|)
operator||
operator|*
operator|(
name|buffer
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|count
operator|!=
literal|0
condition|)
name|checksum
operator|+=
operator|*
name|buffer
operator|<<
literal|8
expr_stmt|;
return|return
name|checksum
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|sparclite_udp_start
parameter_list|(
name|bfd_vma
name|entry
parameter_list|)
block|{
name|unsigned
name|char
name|buffer
index|[
literal|6
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
literal|0x3
expr_stmt|;
name|buffer
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|buffer
index|[
literal|2
index|]
operator|=
name|entry
operator|>>
literal|24
expr_stmt|;
name|buffer
index|[
literal|3
index|]
operator|=
name|entry
operator|>>
literal|16
expr_stmt|;
name|buffer
index|[
literal|4
index|]
operator|=
name|entry
operator|>>
literal|8
expr_stmt|;
name|buffer
index|[
literal|5
index|]
operator|=
name|entry
expr_stmt|;
name|send_udp_buf
argument_list|(
name|udp_fd
argument_list|,
name|buffer
argument_list|,
literal|6
argument_list|)
expr_stmt|;
comment|/* Send start addr */
name|i
operator|=
name|recv_udp_buf
argument_list|(
name|udp_fd
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|buffer
argument_list|)
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* Get response */
if|if
condition|(
name|i
operator|<
literal|1
operator|||
name|buffer
index|[
literal|0
index|]
operator|!=
literal|0x55
condition|)
name|error
argument_list|(
literal|"Failed to take start address."
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|sparclite_udp_write
parameter_list|(
name|bfd
modifier|*
name|from_bfd
parameter_list|,
name|asection
modifier|*
name|from_sec
parameter_list|,
name|file_ptr
name|from_addr
parameter_list|,
name|bfd_vma
name|to_addr
parameter_list|,
name|int
name|len
parameter_list|)
block|{
name|unsigned
name|char
name|buffer
index|[
literal|2000
index|]
decl_stmt|;
name|unsigned
name|short
name|checksum
decl_stmt|;
specifier|static
name|int
name|pkt_num
init|=
literal|0
decl_stmt|;
specifier|static
name|unsigned
name|long
name|old_addr
init|=
operator|-
literal|1
decl_stmt|;
name|int
name|i
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|to_addr
operator|!=
name|old_addr
condition|)
block|{
name|buffer
index|[
literal|0
index|]
operator|=
literal|0x1
expr_stmt|;
comment|/* Load command */
name|buffer
index|[
literal|1
index|]
operator|=
literal|0x1
expr_stmt|;
comment|/* Loading address */
name|buffer
index|[
literal|2
index|]
operator|=
name|to_addr
operator|>>
literal|24
expr_stmt|;
name|buffer
index|[
literal|3
index|]
operator|=
name|to_addr
operator|>>
literal|16
expr_stmt|;
name|buffer
index|[
literal|4
index|]
operator|=
name|to_addr
operator|>>
literal|8
expr_stmt|;
name|buffer
index|[
literal|5
index|]
operator|=
name|to_addr
expr_stmt|;
name|checksum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
control|)
name|checksum
operator|+=
name|buffer
index|[
name|i
index|]
expr_stmt|;
name|checksum
operator|&=
literal|0xff
expr_stmt|;
name|send_udp_buf
argument_list|(
name|udp_fd
argument_list|,
name|buffer
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|i
operator|=
name|recv_udp_buf
argument_list|(
name|udp_fd
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|1
condition|)
name|error
argument_list|(
literal|"Got back short checksum for load addr."
argument_list|)
expr_stmt|;
if|if
condition|(
name|checksum
operator|!=
name|buffer
index|[
literal|0
index|]
condition|)
name|error
argument_list|(
literal|"Got back bad checksum for load addr."
argument_list|)
expr_stmt|;
name|pkt_num
operator|=
literal|0
expr_stmt|;
comment|/* Load addr resets packet seq # */
name|old_addr
operator|=
name|to_addr
expr_stmt|;
block|}
name|bfd_get_section_contents
argument_list|(
name|from_bfd
argument_list|,
name|from_sec
argument_list|,
name|buffer
operator|+
literal|6
argument_list|,
name|from_addr
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|checksum
operator|=
name|calc_checksum
argument_list|(
name|buffer
operator|+
literal|6
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|buffer
index|[
literal|0
index|]
operator|=
literal|0x1
expr_stmt|;
comment|/* Load command */
name|buffer
index|[
literal|1
index|]
operator|=
literal|0x2
expr_stmt|;
comment|/* Loading data */
name|buffer
index|[
literal|2
index|]
operator|=
name|pkt_num
operator|>>
literal|8
expr_stmt|;
name|buffer
index|[
literal|3
index|]
operator|=
name|pkt_num
expr_stmt|;
name|buffer
index|[
literal|4
index|]
operator|=
name|checksum
operator|>>
literal|8
expr_stmt|;
name|buffer
index|[
literal|5
index|]
operator|=
name|checksum
expr_stmt|;
name|send_udp_buf
argument_list|(
name|udp_fd
argument_list|,
name|buffer
argument_list|,
name|len
operator|+
literal|6
argument_list|)
expr_stmt|;
name|i
operator|=
name|recv_udp_buf
argument_list|(
name|udp_fd
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
name|buffer
argument_list|,
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|fprintf_unfiltered
argument_list|(
name|gdb_stderr
argument_list|,
literal|"send_data: timeout sending %d bytes to address 0x%x retrying\n"
argument_list|,
name|len
argument_list|,
name|to_addr
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|buffer
index|[
literal|0
index|]
operator|!=
literal|0xff
condition|)
name|error
argument_list|(
literal|"Got back bad response for load data."
argument_list|)
expr_stmt|;
name|old_addr
operator|+=
name|len
expr_stmt|;
name|pkt_num
operator|++
expr_stmt|;
return|return;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SOCKETS */
end_comment

begin_function
specifier|static
name|void
name|sparclite_download
parameter_list|(
name|char
modifier|*
name|filename
parameter_list|,
name|int
name|from_tty
parameter_list|)
block|{
if|if
condition|(
operator|!
name|serial_flag
condition|)
ifdef|#
directive|ifdef
name|HAVE_SOCKETS
name|download
argument_list|(
name|remote_target_name
argument_list|,
name|filename
argument_list|,
name|from_tty
argument_list|,
name|sparclite_udp_write
argument_list|,
name|sparclite_udp_start
argument_list|)
expr_stmt|;
else|#
directive|else
name|internal_error
argument_list|(
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|"failed internal consistency check"
argument_list|)
expr_stmt|;
comment|/* sparclite_open should prevent this! */
endif|#
directive|endif
else|else
name|download
argument_list|(
name|remote_target_name
argument_list|,
name|filename
argument_list|,
name|from_tty
argument_list|,
name|sparclite_serial_write
argument_list|,
name|sparclite_serial_start
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Set up the sparclite target vector.  */
end_comment

begin_function
specifier|static
name|void
name|init_sparclite_ops
parameter_list|(
name|void
parameter_list|)
block|{
name|sparclite_ops
operator|.
name|to_shortname
operator|=
literal|"sparclite"
expr_stmt|;
name|sparclite_ops
operator|.
name|to_longname
operator|=
literal|"SPARClite download target"
expr_stmt|;
name|sparclite_ops
operator|.
name|to_doc
operator|=
literal|"Download to a remote SPARClite target board via serial of UDP.\n\ Specify the device it is connected to (e.g. /dev/ttya)."
expr_stmt|;
name|sparclite_ops
operator|.
name|to_open
operator|=
name|sparclite_open
expr_stmt|;
name|sparclite_ops
operator|.
name|to_close
operator|=
name|sparclite_close
expr_stmt|;
name|sparclite_ops
operator|.
name|to_load
operator|=
name|sparclite_download
expr_stmt|;
name|sparclite_ops
operator|.
name|to_stratum
operator|=
name|download_stratum
expr_stmt|;
name|sparclite_ops
operator|.
name|to_magic
operator|=
name|OPS_MAGIC
expr_stmt|;
block|}
end_function

begin_function
name|void
name|_initialize_sparcl_tdep
parameter_list|(
name|void
parameter_list|)
block|{
name|init_sparclite_ops
argument_list|()
expr_stmt|;
name|add_target
argument_list|(
operator|&
name|sparclite_ops
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* BFD back-end for Motorola 68000 COFF binaries.    Copyright 1990, 91, 92, 93, 94, 95, 1996 Free Software Foundation, Inc.    Written by Cygnus Support.  This file is part of BFD, the Binary File Descriptor library.  This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"obstack.h"
end_include

begin_include
include|#
directive|include
file|"coff/m68k.h"
end_include

begin_include
include|#
directive|include
file|"coff/internal.h"
end_include

begin_include
include|#
directive|include
file|"libcoff.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|LYNX_SPECIAL_FN
end_ifndef

begin_define
define|#
directive|define
name|LYNX_SPECIAL_FN
value|0
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|COFF_DEFAULT_SECTION_ALIGNMENT_POWER
value|(2)
end_define

begin_ifndef
ifndef|#
directive|ifndef
name|COFF_PAGE_SIZE
end_ifndef

begin_comment
comment|/* The page size is a guess based on ELF.  */
end_comment

begin_define
define|#
directive|define
name|COFF_PAGE_SIZE
value|0x2000
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Clean up namespace.  */
end_comment

begin_define
define|#
directive|define
name|m68kcoff_howto_table
value|_bfd_m68kcoff_howto_table
end_define

begin_define
define|#
directive|define
name|m68k_rtype2howto
value|_bfd_m68kcoff_rtype2howto
end_define

begin_define
define|#
directive|define
name|m68k_howto2rtype
value|_bfd_m68kcoff_howto2rtype
end_define

begin_define
define|#
directive|define
name|m68k_reloc_type_lookup
value|_bfd_m68kcoff_reloc_type_lookup
end_define

begin_ifdef
ifdef|#
directive|ifdef
name|ONLY_DECLARE_RELOCS
end_ifdef

begin_decl_stmt
specifier|extern
name|reloc_howto_type
name|m68kcoff_howto_table
index|[]
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|reloc_howto_type
name|m68kcoff_howto_table
index|[]
init|=
block|{
name|HOWTO
argument_list|(
name|R_RELBYTE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
name|false
argument_list|,
literal|0
argument_list|,
name|complain_overflow_bitfield
argument_list|,
name|LYNX_SPECIAL_FN
argument_list|,
literal|"8"
argument_list|,
name|true
argument_list|,
literal|0x000000ff
argument_list|,
literal|0x000000ff
argument_list|,
name|false
argument_list|)
block|,
name|HOWTO
argument_list|(
name|R_RELWORD
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|16
argument_list|,
name|false
argument_list|,
literal|0
argument_list|,
name|complain_overflow_bitfield
argument_list|,
name|LYNX_SPECIAL_FN
argument_list|,
literal|"16"
argument_list|,
name|true
argument_list|,
literal|0x0000ffff
argument_list|,
literal|0x0000ffff
argument_list|,
name|false
argument_list|)
block|,
name|HOWTO
argument_list|(
name|R_RELLONG
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|32
argument_list|,
name|false
argument_list|,
literal|0
argument_list|,
name|complain_overflow_bitfield
argument_list|,
name|LYNX_SPECIAL_FN
argument_list|,
literal|"32"
argument_list|,
name|true
argument_list|,
literal|0xffffffff
argument_list|,
literal|0xffffffff
argument_list|,
name|false
argument_list|)
block|,
name|HOWTO
argument_list|(
name|R_PCRBYTE
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|8
argument_list|,
name|true
argument_list|,
literal|0
argument_list|,
name|complain_overflow_signed
argument_list|,
name|LYNX_SPECIAL_FN
argument_list|,
literal|"DISP8"
argument_list|,
name|true
argument_list|,
literal|0x000000ff
argument_list|,
literal|0x000000ff
argument_list|,
name|false
argument_list|)
block|,
name|HOWTO
argument_list|(
name|R_PCRWORD
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|16
argument_list|,
name|true
argument_list|,
literal|0
argument_list|,
name|complain_overflow_signed
argument_list|,
name|LYNX_SPECIAL_FN
argument_list|,
literal|"DISP16"
argument_list|,
name|true
argument_list|,
literal|0x0000ffff
argument_list|,
literal|0x0000ffff
argument_list|,
name|false
argument_list|)
block|,
name|HOWTO
argument_list|(
name|R_PCRLONG
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|,
literal|32
argument_list|,
name|true
argument_list|,
literal|0
argument_list|,
name|complain_overflow_signed
argument_list|,
name|LYNX_SPECIAL_FN
argument_list|,
literal|"DISP32"
argument_list|,
name|true
argument_list|,
literal|0xffffffff
argument_list|,
literal|0xffffffff
argument_list|,
name|false
argument_list|)
block|,
name|HOWTO
argument_list|(
name|R_RELLONG_NEG
argument_list|,
literal|0
argument_list|,
operator|-
literal|2
argument_list|,
literal|32
argument_list|,
name|false
argument_list|,
literal|0
argument_list|,
name|complain_overflow_bitfield
argument_list|,
name|LYNX_SPECIAL_FN
argument_list|,
literal|"-32"
argument_list|,
name|true
argument_list|,
literal|0xffffffff
argument_list|,
literal|0xffffffff
argument_list|,
name|false
argument_list|)
block|, }
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not ONLY_DECLARE_RELOCS */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|BADMAG
end_ifndef

begin_define
define|#
directive|define
name|BADMAG
parameter_list|(
name|x
parameter_list|)
value|M68KBADMAG(x)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|M68
value|1
end_define

begin_comment
comment|/* Customize coffcode.h */
end_comment

begin_comment
comment|/* Turn a howto into a reloc number */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|ONLY_DECLARE_RELOCS
end_ifdef

begin_decl_stmt
specifier|extern
name|void
name|m68k_rtype2howto
name|PARAMS
argument_list|(
operator|(
name|arelent
operator|*
name|internal
operator|,
name|int
name|relocentry
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|m68k_howto2rtype
name|PARAMS
argument_list|(
operator|(
name|reloc_howto_type
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|reloc_howto_type
modifier|*
name|m68k_reloc_type_lookup
name|PARAMS
argument_list|(
operator|(
name|bfd
operator|*
operator|,
name|bfd_reloc_code_real_type
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_function
name|void
name|m68k_rtype2howto
parameter_list|(
name|internal
parameter_list|,
name|relocentry
parameter_list|)
name|arelent
modifier|*
name|internal
decl_stmt|;
name|int
name|relocentry
decl_stmt|;
block|{
switch|switch
condition|(
name|relocentry
condition|)
block|{
case|case
name|R_RELBYTE
case|:
name|internal
operator|->
name|howto
operator|=
name|m68kcoff_howto_table
operator|+
literal|0
expr_stmt|;
break|break;
case|case
name|R_RELWORD
case|:
name|internal
operator|->
name|howto
operator|=
name|m68kcoff_howto_table
operator|+
literal|1
expr_stmt|;
break|break;
case|case
name|R_RELLONG
case|:
name|internal
operator|->
name|howto
operator|=
name|m68kcoff_howto_table
operator|+
literal|2
expr_stmt|;
break|break;
case|case
name|R_PCRBYTE
case|:
name|internal
operator|->
name|howto
operator|=
name|m68kcoff_howto_table
operator|+
literal|3
expr_stmt|;
break|break;
case|case
name|R_PCRWORD
case|:
name|internal
operator|->
name|howto
operator|=
name|m68kcoff_howto_table
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|R_PCRLONG
case|:
name|internal
operator|->
name|howto
operator|=
name|m68kcoff_howto_table
operator|+
literal|5
expr_stmt|;
break|break;
case|case
name|R_RELLONG_NEG
case|:
name|internal
operator|->
name|howto
operator|=
name|m68kcoff_howto_table
operator|+
literal|6
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
name|int
name|m68k_howto2rtype
parameter_list|(
name|internal
parameter_list|)
name|reloc_howto_type
modifier|*
name|internal
decl_stmt|;
block|{
if|if
condition|(
name|internal
operator|->
name|pc_relative
condition|)
block|{
switch|switch
condition|(
name|internal
operator|->
name|bitsize
condition|)
block|{
case|case
literal|32
case|:
return|return
name|R_PCRLONG
return|;
case|case
literal|16
case|:
return|return
name|R_PCRWORD
return|;
case|case
literal|8
case|:
return|return
name|R_PCRBYTE
return|;
block|}
block|}
else|else
block|{
switch|switch
condition|(
name|internal
operator|->
name|bitsize
condition|)
block|{
case|case
literal|32
case|:
return|return
name|R_RELLONG
return|;
case|case
literal|16
case|:
return|return
name|R_RELWORD
return|;
case|case
literal|8
case|:
return|return
name|R_RELBYTE
return|;
block|}
block|}
return|return
name|R_RELLONG
return|;
block|}
end_function

begin_function
name|reloc_howto_type
modifier|*
name|m68k_reloc_type_lookup
parameter_list|(
name|abfd
parameter_list|,
name|code
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
name|bfd_reloc_code_real_type
name|code
decl_stmt|;
block|{
switch|switch
condition|(
name|code
condition|)
block|{
default|default:
return|return
name|NULL
return|;
case|case
name|BFD_RELOC_8
case|:
return|return
name|m68kcoff_howto_table
operator|+
literal|0
return|;
case|case
name|BFD_RELOC_16
case|:
return|return
name|m68kcoff_howto_table
operator|+
literal|1
return|;
case|case
name|BFD_RELOC_CTOR
case|:
case|case
name|BFD_RELOC_32
case|:
return|return
name|m68kcoff_howto_table
operator|+
literal|2
return|;
case|case
name|BFD_RELOC_8_PCREL
case|:
return|return
name|m68kcoff_howto_table
operator|+
literal|3
return|;
case|case
name|BFD_RELOC_16_PCREL
case|:
return|return
name|m68kcoff_howto_table
operator|+
literal|4
return|;
case|case
name|BFD_RELOC_32_PCREL
case|:
return|return
name|m68kcoff_howto_table
operator|+
literal|5
return|;
comment|/* FIXME: There doesn't seem to be a code for R_RELLONG_NEG.  */
block|}
comment|/*NOTREACHED*/
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* not ONLY_DECLARE_RELOCS */
end_comment

begin_define
define|#
directive|define
name|RTYPE2HOWTO
parameter_list|(
name|internal
parameter_list|,
name|relocentry
parameter_list|)
define|\
value|m68k_rtype2howto(internal, (relocentry)->r_type)
end_define

begin_define
define|#
directive|define
name|SELECT_RELOC
parameter_list|(
name|external
parameter_list|,
name|internal
parameter_list|)
define|\
value|external.r_type = m68k_howto2rtype(internal);
end_define

begin_define
define|#
directive|define
name|coff_bfd_reloc_type_lookup
value|m68k_reloc_type_lookup
end_define

begin_define
define|#
directive|define
name|coff_relocate_section
value|_bfd_coff_generic_relocate_section
end_define

begin_include
include|#
directive|include
file|"coffcode.h"
end_include

begin_decl_stmt
specifier|const
name|bfd_target
ifdef|#
directive|ifdef
name|TARGET_SYM
name|TARGET_SYM
init|=
else|#
directive|else
name|m68kcoff_vec
operator|=
endif|#
directive|endif
block|{
ifdef|#
directive|ifdef
name|TARGET_NAME
name|TARGET_NAME
block|,
else|#
directive|else
literal|"coff-m68k"
block|,
comment|/* name */
endif|#
directive|endif
name|bfd_target_coff_flavour
block|,
name|BFD_ENDIAN_BIG
block|,
comment|/* data byte order is big */
name|BFD_ENDIAN_BIG
block|,
comment|/* header byte order is big */
operator|(
name|HAS_RELOC
operator||
name|EXEC_P
operator||
comment|/* object flags */
name|HAS_LINENO
operator||
name|HAS_DEBUG
operator||
name|HAS_SYMS
operator||
name|HAS_LOCALS
operator||
name|WP_TEXT
operator||
name|D_PAGED
operator|)
block|,
operator|(
name|SEC_HAS_CONTENTS
operator||
name|SEC_ALLOC
operator||
name|SEC_LOAD
operator||
name|SEC_RELOC
operator|)
block|,
comment|/* section flags */
ifdef|#
directive|ifdef
name|NAMES_HAVE_UNDERSCORE
literal|'_'
block|,
else|#
directive|else
literal|0
block|,
comment|/* leading underscore */
endif|#
directive|endif
literal|'/'
block|,
comment|/* ar_pad_char */
literal|15
block|,
comment|/* ar_max_namelen */
name|bfd_getb64
block|,
name|bfd_getb_signed_64
block|,
name|bfd_putb64
block|,
name|bfd_getb32
block|,
name|bfd_getb_signed_32
block|,
name|bfd_putb32
block|,
name|bfd_getb16
block|,
name|bfd_getb_signed_16
block|,
name|bfd_putb16
block|,
comment|/* data */
name|bfd_getb64
block|,
name|bfd_getb_signed_64
block|,
name|bfd_putb64
block|,
name|bfd_getb32
block|,
name|bfd_getb_signed_32
block|,
name|bfd_putb32
block|,
name|bfd_getb16
block|,
name|bfd_getb_signed_16
block|,
name|bfd_putb16
block|,
comment|/* hdrs */
block|{
name|_bfd_dummy_target
block|,
name|coff_object_p
block|,
comment|/* bfd_check_format */
name|bfd_generic_archive_p
block|,
name|_bfd_dummy_target
block|}
block|,
block|{
name|bfd_false
block|,
name|coff_mkobject
block|,
name|_bfd_generic_mkarchive
block|,
comment|/* bfd_set_format */
name|bfd_false
block|}
block|,
block|{
name|bfd_false
block|,
name|coff_write_object_contents
block|,
comment|/* bfd_write_contents */
name|_bfd_write_archive_contents
block|,
name|bfd_false
block|}
block|,
name|BFD_JUMP_TABLE_GENERIC
argument_list|(
name|coff
argument_list|)
block|,
name|BFD_JUMP_TABLE_COPY
argument_list|(
name|coff
argument_list|)
block|,
name|BFD_JUMP_TABLE_CORE
argument_list|(
name|_bfd_nocore
argument_list|)
block|,
name|BFD_JUMP_TABLE_ARCHIVE
argument_list|(
name|_bfd_archive_coff
argument_list|)
block|,
name|BFD_JUMP_TABLE_SYMBOLS
argument_list|(
name|coff
argument_list|)
block|,
name|BFD_JUMP_TABLE_RELOCS
argument_list|(
name|coff
argument_list|)
block|,
name|BFD_JUMP_TABLE_WRITE
argument_list|(
name|coff
argument_list|)
block|,
name|BFD_JUMP_TABLE_LINK
argument_list|(
name|coff
argument_list|)
block|,
name|BFD_JUMP_TABLE_DYNAMIC
argument_list|(
name|_bfd_nodynamic
argument_list|)
block|,
name|COFF_SWAP_TABLE
block|}
decl_stmt|;
end_decl_stmt

end_unit


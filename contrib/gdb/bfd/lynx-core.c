begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* BFD back end for Lynx core files    Copyright 1993 Free Software Foundation, Inc.    Written by Stu Grossman of Cygnus Support.  This file is part of BFD, the Binary File Descriptor library.  This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|LYNX_CORE
end_ifdef

begin_include
include|#
directive|include
file|<sys/conf.h>
end_include

begin_include
include|#
directive|include
file|<sys/kernel.h>
end_include

begin_comment
comment|/* sys/kernel.h should define this, but doesn't always, sigh. */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|__LYNXOS
end_ifndef

begin_define
define|#
directive|define
name|__LYNXOS
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<sys/mem.h>
end_include

begin_include
include|#
directive|include
file|<sys/signal.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/resource.h>
end_include

begin_include
include|#
directive|include
file|<sys/itimer.h>
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/proc.h>
end_include

begin_comment
comment|/* These are stored in the bfd's tdata */
end_comment

begin_struct
struct|struct
name|lynx_core_struct
block|{
name|int
name|sig
decl_stmt|;
name|char
name|cmd
index|[
name|PNMLEN
operator|+
literal|1
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|core_hdr
parameter_list|(
name|bfd
parameter_list|)
value|((bfd)->tdata.lynx_core_data)
end_define

begin_define
define|#
directive|define
name|core_signal
parameter_list|(
name|bfd
parameter_list|)
value|(core_hdr(bfd)->sig)
end_define

begin_define
define|#
directive|define
name|core_command
parameter_list|(
name|bfd
parameter_list|)
value|(core_hdr(bfd)->cmd)
end_define

begin_comment
comment|/* Handle Lynx core dump file.  */
end_comment

begin_function
specifier|static
name|asection
modifier|*
name|make_bfd_asection
parameter_list|(
name|abfd
parameter_list|,
name|name
parameter_list|,
name|flags
parameter_list|,
name|_raw_size
parameter_list|,
name|vma
parameter_list|,
name|filepos
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
name|CONST
name|char
modifier|*
name|name
decl_stmt|;
name|flagword
name|flags
decl_stmt|;
name|bfd_size_type
name|_raw_size
decl_stmt|;
name|bfd_vma
name|vma
decl_stmt|;
name|file_ptr
name|filepos
decl_stmt|;
block|{
name|asection
modifier|*
name|asect
decl_stmt|;
name|char
modifier|*
name|newname
decl_stmt|;
name|newname
operator|=
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|strlen
argument_list|(
name|name
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newname
condition|)
return|return
name|NULL
return|;
name|strcpy
argument_list|(
name|newname
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|asect
operator|=
name|bfd_make_section
argument_list|(
name|abfd
argument_list|,
name|newname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|asect
condition|)
return|return
name|NULL
return|;
name|asect
operator|->
name|flags
operator|=
name|flags
expr_stmt|;
name|asect
operator|->
name|_raw_size
operator|=
name|_raw_size
expr_stmt|;
name|asect
operator|->
name|vma
operator|=
name|vma
expr_stmt|;
name|asect
operator|->
name|filepos
operator|=
name|filepos
expr_stmt|;
name|asect
operator|->
name|alignment_power
operator|=
literal|2
expr_stmt|;
return|return
name|asect
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
specifier|const
name|bfd_target
modifier|*
name|lynx_core_file_p
parameter_list|(
name|abfd
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
block|{
name|int
name|val
decl_stmt|;
name|int
name|secnum
decl_stmt|;
name|struct
name|pssentry
name|pss
decl_stmt|;
name|size_t
name|tcontext_size
decl_stmt|;
name|core_st_t
modifier|*
name|threadp
decl_stmt|;
name|int
name|pagesize
decl_stmt|;
name|asection
modifier|*
name|newsect
decl_stmt|;
name|pagesize
operator|=
name|getpagesize
argument_list|()
expr_stmt|;
comment|/* Serious cross-target issue here...  This 				   really needs to come from a system-specific 				   header file.  */
comment|/* Get the pss entry from the core file */
if|if
condition|(
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
name|val
operator|=
name|bfd_read
argument_list|(
operator|(
name|void
operator|*
operator|)
operator|&
name|pss
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
name|pss
argument_list|,
name|abfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
sizeof|sizeof
name|pss
condition|)
block|{
comment|/* Too small to be a core file */
if|if
condition|(
name|bfd_get_error
argument_list|()
operator|!=
name|bfd_error_system_call
condition|)
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|core_hdr
argument_list|(
name|abfd
argument_list|)
operator|=
operator|(
expr|struct
name|lynx_core_struct
operator|*
operator|)
name|bfd_zalloc
argument_list|(
name|abfd
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|lynx_core_struct
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|core_hdr
argument_list|(
name|abfd
argument_list|)
condition|)
return|return
name|NULL
return|;
name|strncpy
argument_list|(
name|core_command
argument_list|(
name|abfd
argument_list|)
argument_list|,
name|pss
operator|.
name|pname
argument_list|,
name|PNMLEN
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* Compute the size of the thread contexts */
name|tcontext_size
operator|=
name|pss
operator|.
name|threadcnt
operator|*
sizeof|sizeof
argument_list|(
name|core_st_t
argument_list|)
expr_stmt|;
comment|/* Allocate space for the thread contexts */
name|threadp
operator|=
operator|(
name|core_st_t
operator|*
operator|)
name|bfd_alloc
argument_list|(
name|abfd
argument_list|,
name|tcontext_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|threadp
condition|)
return|return
name|NULL
return|;
comment|/* Save thread contexts */
if|if
condition|(
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
name|pagesize
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
condition|)
return|return
name|NULL
return|;
name|val
operator|=
name|bfd_read
argument_list|(
operator|(
name|void
operator|*
operator|)
name|threadp
argument_list|,
name|pss
operator|.
name|threadcnt
argument_list|,
sizeof|sizeof
argument_list|(
name|core_st_t
argument_list|)
argument_list|,
name|abfd
argument_list|)
expr_stmt|;
if|if
condition|(
name|val
operator|!=
name|tcontext_size
condition|)
block|{
comment|/* Probably too small to be a core file */
if|if
condition|(
name|bfd_get_error
argument_list|()
operator|!=
name|bfd_error_system_call
condition|)
name|bfd_set_error
argument_list|(
name|bfd_error_wrong_format
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|core_signal
argument_list|(
name|abfd
argument_list|)
operator|=
name|threadp
operator|->
name|currsig
expr_stmt|;
name|newsect
operator|=
name|make_bfd_asection
argument_list|(
name|abfd
argument_list|,
literal|".stack"
argument_list|,
name|SEC_ALLOC
operator|+
name|SEC_LOAD
operator|+
name|SEC_HAS_CONTENTS
argument_list|,
name|pss
operator|.
name|ssize
argument_list|,
name|pss
operator|.
name|slimit
argument_list|,
name|pagesize
operator|+
name|tcontext_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newsect
condition|)
return|return
name|NULL
return|;
name|newsect
operator|=
name|make_bfd_asection
argument_list|(
name|abfd
argument_list|,
literal|".data"
argument_list|,
name|SEC_ALLOC
operator|+
name|SEC_LOAD
operator|+
name|SEC_HAS_CONTENTS
argument_list|,
name|pss
operator|.
name|data_len
operator|+
name|pss
operator|.
name|bss_len
argument_list|,
name|pss
operator|.
name|data_start
argument_list|,
name|pagesize
operator|+
name|tcontext_size
operator|+
name|pss
operator|.
name|ssize
if|#
directive|if
name|defined
argument_list|(
name|SPARC
argument_list|)
operator|||
name|defined
argument_list|(
name|__SPARC__
argument_list|)
comment|/* SPARC Lynx seems to start dumping                                   the .data section at a page                                   boundary.  It's OK to check a                                   #define like SPARC here because this                                   file can only be compiled on a Lynx                                   host.  */
operator|+
name|pss
operator|.
name|data_start
operator|%
name|pagesize
endif|#
directive|endif
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newsect
condition|)
return|return
name|NULL
return|;
comment|/* And, now for the .reg/XXX pseudo sections.  Each thread has it's own    .reg/XXX section, where XXX is the thread id (without leading zeros).  The    currently running thread (at the time of the core dump) also has an alias    called `.reg' (just to keep GDB happy).  Note that we use `.reg/XXX' as    opposed to `.regXXX' because GDB expects that .reg2 will be the floating-    point registers.  */
name|newsect
operator|=
name|make_bfd_asection
argument_list|(
name|abfd
argument_list|,
literal|".reg"
argument_list|,
name|SEC_HAS_CONTENTS
argument_list|,
sizeof|sizeof
argument_list|(
name|core_st_t
argument_list|)
argument_list|,
literal|0
argument_list|,
name|pagesize
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newsect
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|secnum
operator|=
literal|0
init|;
name|secnum
operator|<
name|pss
operator|.
name|threadcnt
condition|;
name|secnum
operator|++
control|)
block|{
name|char
name|secname
index|[
literal|100
index|]
decl_stmt|;
name|sprintf
argument_list|(
name|secname
argument_list|,
literal|".reg/%d"
argument_list|,
name|BUILDPID
argument_list|(
literal|0
argument_list|,
name|threadp
index|[
name|secnum
index|]
operator|.
name|tid
argument_list|)
argument_list|)
expr_stmt|;
name|newsect
operator|=
name|make_bfd_asection
argument_list|(
name|abfd
argument_list|,
name|secname
argument_list|,
name|SEC_HAS_CONTENTS
argument_list|,
sizeof|sizeof
argument_list|(
name|core_st_t
argument_list|)
argument_list|,
literal|0
argument_list|,
name|pagesize
operator|+
name|secnum
operator|*
sizeof|sizeof
argument_list|(
name|core_st_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newsect
condition|)
return|return
name|NULL
return|;
block|}
return|return
name|abfd
operator|->
name|xvec
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|lynx_core_file_failing_command
parameter_list|(
name|abfd
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
block|{
return|return
name|core_command
argument_list|(
name|abfd
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|int
name|lynx_core_file_failing_signal
parameter_list|(
name|abfd
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
block|{
return|return
name|core_signal
argument_list|(
name|abfd
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|boolean
name|lynx_core_file_matches_executable_p
parameter_list|(
name|core_bfd
parameter_list|,
name|exec_bfd
parameter_list|)
name|bfd
modifier|*
name|core_bfd
decl_stmt|,
decl|*
name|exec_bfd
decl_stmt|;
end_function

begin_block
block|{
return|return
name|true
return|;
comment|/* FIXME, We have no way of telling at this point */
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* LYNX_CORE */
end_comment

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* BFD back-end for MS-DOS executables.    Copyright 1990, 1991, 1992, 1993, 1994 Free Software Foundation, Inc.    Written by Bryan Ford of the University of Utah.     Contributed by the Center for Software Science at the    University of Utah (pa-gdb-bugs@cs.utah.edu).     This file is part of BFD, the Binary File Descriptor library.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.  */
end_comment

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"libbfd.h"
end_include

begin_include
include|#
directive|include
file|"libaout.h"
end_include

begin_if
if|#
directive|if
literal|0
end_if

begin_comment
unit|struct exe_header { 	unsigned short magic; 	unsigned short bytes_in_last_page; 	unsigned short npages;
comment|/* number of 512-byte "pages" including this header */
end_comment

begin_comment
unit|unsigned short nrelocs; 	unsigned short header_paras;
comment|/* number of 16-byte paragraphs in header */
end_comment

begin_endif
unit|unsigned short reserved; 	unsigned short load_switch; 	unsigned short ss_ofs; 	unsigned short sp; 	unsigned short checksum; 	unsigned short ip; 	unsigned short cs_ofs; 	unsigned short reloc_ofs; 	unsigned short reserved2; 	unsigned short something1; 	unsigned short something2; 	unsigned short something3; };
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|EXE_MAGIC
value|0x5a4d
end_define

begin_define
define|#
directive|define
name|EXE_LOAD_HIGH
value|0x0000
end_define

begin_define
define|#
directive|define
name|EXE_LOAD_LOW
value|0xffff
end_define

begin_define
define|#
directive|define
name|EXE_PAGE_SIZE
value|512
end_define

begin_function
specifier|static
name|int
name|msdos_sizeof_headers
parameter_list|(
name|abfd
parameter_list|,
name|exec
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
name|boolean
name|exec
decl_stmt|;
block|{
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|boolean
name|msdos_write_object_contents
parameter_list|(
name|abfd
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
block|{
specifier|static
name|char
name|hdr
index|[
name|EXE_PAGE_SIZE
index|]
decl_stmt|;
name|file_ptr
name|outfile_size
init|=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
decl_stmt|;
name|bfd_vma
name|high_vma
init|=
literal|0
decl_stmt|;
name|asection
modifier|*
name|sec
decl_stmt|;
comment|/* Find the total size of the program on disk and in memory.  */
for|for
control|(
name|sec
operator|=
name|abfd
operator|->
name|sections
init|;
name|sec
operator|!=
operator|(
name|asection
operator|*
operator|)
name|NULL
condition|;
name|sec
operator|=
name|sec
operator|->
name|next
control|)
block|{
if|if
condition|(
name|bfd_get_section_size_before_reloc
argument_list|(
name|sec
argument_list|)
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|bfd_get_section_flags
argument_list|(
name|abfd
argument_list|,
name|sec
argument_list|)
operator|&
name|SEC_ALLOC
condition|)
block|{
name|bfd_vma
name|sec_vma
init|=
name|bfd_get_section_vma
argument_list|(
name|abfd
argument_list|,
name|sec
argument_list|)
operator|+
name|bfd_get_section_size_before_reloc
argument_list|(
name|sec
argument_list|)
decl_stmt|;
if|if
condition|(
name|sec_vma
operator|>
name|high_vma
condition|)
name|high_vma
operator|=
name|sec_vma
expr_stmt|;
block|}
if|if
condition|(
name|bfd_get_section_flags
argument_list|(
name|abfd
argument_list|,
name|sec
argument_list|)
operator|&
name|SEC_LOAD
condition|)
block|{
name|file_ptr
name|sec_end
init|=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
operator|+
name|bfd_get_section_vma
argument_list|(
name|abfd
argument_list|,
name|sec
argument_list|)
operator|+
name|bfd_get_section_size_before_reloc
argument_list|(
name|sec
argument_list|)
decl_stmt|;
if|if
condition|(
name|sec_end
operator|>
name|outfile_size
condition|)
name|outfile_size
operator|=
name|sec_end
expr_stmt|;
block|}
block|}
comment|/* Make sure the program isn't too big.  */
if|if
condition|(
name|high_vma
operator|>
operator|(
name|bfd_vma
operator|)
literal|0xffff
condition|)
block|{
name|bfd_set_error
argument_list|(
name|bfd_error_file_too_big
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
comment|/* constants */
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
name|EXE_MAGIC
argument_list|,
operator|&
name|hdr
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
name|EXE_PAGE_SIZE
operator|/
literal|16
argument_list|,
operator|&
name|hdr
index|[
literal|8
index|]
argument_list|)
expr_stmt|;
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
name|EXE_LOAD_LOW
argument_list|,
operator|&
name|hdr
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
literal|0x3e
argument_list|,
operator|&
name|hdr
index|[
literal|24
index|]
argument_list|)
expr_stmt|;
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
literal|0x0001
argument_list|,
operator|&
name|hdr
index|[
literal|28
index|]
argument_list|)
expr_stmt|;
comment|/* XXX??? */
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
literal|0x30fb
argument_list|,
operator|&
name|hdr
index|[
literal|30
index|]
argument_list|)
expr_stmt|;
comment|/* XXX??? */
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
literal|0x726a
argument_list|,
operator|&
name|hdr
index|[
literal|32
index|]
argument_list|)
expr_stmt|;
comment|/* XXX??? */
comment|/* bytes in last page (0 = full page) */
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
name|outfile_size
operator|&
operator|(
name|EXE_PAGE_SIZE
operator|-
literal|1
operator|)
argument_list|,
operator|&
name|hdr
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
comment|/* number of pages */
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
operator|(
name|outfile_size
operator|+
name|EXE_PAGE_SIZE
operator|-
literal|1
operator|)
operator|/
name|EXE_PAGE_SIZE
argument_list|,
operator|&
name|hdr
index|[
literal|4
index|]
argument_list|)
expr_stmt|;
comment|/* Set the initial stack pointer to the end of the bss.      The program's crt0 code must relocate it to a real stack.  */
name|bfd_h_put_16
argument_list|(
name|abfd
argument_list|,
name|high_vma
argument_list|,
operator|&
name|hdr
index|[
literal|16
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
operator|(
name|file_ptr
operator|)
literal|0
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
operator|||
name|bfd_write
argument_list|(
name|hdr
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
argument_list|,
name|abfd
argument_list|)
operator|!=
sizeof|sizeof
argument_list|(
name|hdr
argument_list|)
condition|)
return|return
name|false
return|;
return|return
name|true
return|;
block|}
end_function

begin_function
specifier|static
name|boolean
name|msdos_set_section_contents
parameter_list|(
name|abfd
parameter_list|,
name|section
parameter_list|,
name|location
parameter_list|,
name|offset
parameter_list|,
name|count
parameter_list|)
name|bfd
modifier|*
name|abfd
decl_stmt|;
name|sec_ptr
name|section
decl_stmt|;
name|PTR
name|location
decl_stmt|;
name|file_ptr
name|offset
decl_stmt|;
name|bfd_size_type
name|count
decl_stmt|;
block|{
if|if
condition|(
name|count
operator|==
literal|0
condition|)
return|return
name|true
return|;
name|section
operator|->
name|filepos
operator|=
name|EXE_PAGE_SIZE
operator|+
name|bfd_get_section_vma
argument_list|(
name|abfd
argument_list|,
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|bfd_get_section_flags
argument_list|(
name|abfd
argument_list|,
name|section
argument_list|)
operator|&
name|SEC_LOAD
condition|)
block|{
if|if
condition|(
name|bfd_seek
argument_list|(
name|abfd
argument_list|,
call|(
name|file_ptr
call|)
argument_list|(
name|section
operator|->
name|filepos
operator|+
name|offset
argument_list|)
argument_list|,
name|SEEK_SET
argument_list|)
operator|!=
literal|0
operator|||
name|bfd_write
argument_list|(
name|location
argument_list|,
literal|1
argument_list|,
name|count
argument_list|,
name|abfd
argument_list|)
operator|!=
name|count
condition|)
return|return
name|false
return|;
block|}
return|return
name|true
return|;
block|}
end_function

begin_define
define|#
directive|define
name|msdos_mkobject
value|aout_32_mkobject
end_define

begin_define
define|#
directive|define
name|msdos_make_empty_symbol
value|aout_32_make_empty_symbol
end_define

begin_define
define|#
directive|define
name|msdos_bfd_reloc_type_lookup
value|aout_32_reloc_type_lookup
end_define

begin_define
define|#
directive|define
name|msdos_close_and_cleanup
value|_bfd_generic_close_and_cleanup
end_define

begin_define
define|#
directive|define
name|msdos_bfd_free_cached_info
value|_bfd_generic_bfd_free_cached_info
end_define

begin_define
define|#
directive|define
name|msdos_new_section_hook
value|_bfd_generic_new_section_hook
end_define

begin_define
define|#
directive|define
name|msdos_get_section_contents
value|_bfd_generic_get_section_contents
end_define

begin_define
define|#
directive|define
name|msdos_get_section_contents_in_window
define|\
value|_bfd_generic_get_section_contents_in_window
end_define

begin_define
define|#
directive|define
name|msdos_bfd_get_relocated_section_contents
define|\
value|bfd_generic_get_relocated_section_contents
end_define

begin_define
define|#
directive|define
name|msdos_bfd_relax_section
value|bfd_generic_relax_section
end_define

begin_define
define|#
directive|define
name|msdos_bfd_link_hash_table_create
value|_bfd_generic_link_hash_table_create
end_define

begin_define
define|#
directive|define
name|msdos_bfd_link_add_symbols
value|_bfd_generic_link_add_symbols
end_define

begin_define
define|#
directive|define
name|msdos_bfd_final_link
value|_bfd_generic_final_link
end_define

begin_define
define|#
directive|define
name|msdos_bfd_link_split_section
value|_bfd_generic_link_split_section
end_define

begin_define
define|#
directive|define
name|msdos_set_arch_mach
value|_bfd_generic_set_arch_mach
end_define

begin_define
define|#
directive|define
name|msdos_get_symtab_upper_bound
value|_bfd_nosymbols_get_symtab_upper_bound
end_define

begin_define
define|#
directive|define
name|msdos_get_symtab
value|_bfd_nosymbols_get_symtab
end_define

begin_define
define|#
directive|define
name|msdos_print_symbol
value|_bfd_nosymbols_print_symbol
end_define

begin_define
define|#
directive|define
name|msdos_get_symbol_info
value|_bfd_nosymbols_get_symbol_info
end_define

begin_define
define|#
directive|define
name|msdos_find_nearest_line
value|_bfd_nosymbols_find_nearest_line
end_define

begin_define
define|#
directive|define
name|msdos_get_lineno
value|_bfd_nosymbols_get_lineno
end_define

begin_define
define|#
directive|define
name|msdos_bfd_is_local_label
value|_bfd_nosymbols_bfd_is_local_label
end_define

begin_define
define|#
directive|define
name|msdos_bfd_make_debug_symbol
value|_bfd_nosymbols_bfd_make_debug_symbol
end_define

begin_define
define|#
directive|define
name|msdos_read_minisymbols
value|_bfd_nosymbols_read_minisymbols
end_define

begin_define
define|#
directive|define
name|msdos_minisymbol_to_symbol
value|_bfd_nosymbols_minisymbol_to_symbol
end_define

begin_define
define|#
directive|define
name|msdos_canonicalize_reloc
value|_bfd_norelocs_canonicalize_reloc
end_define

begin_define
define|#
directive|define
name|msdos_get_reloc_upper_bound
value|_bfd_norelocs_get_reloc_upper_bound
end_define

begin_define
define|#
directive|define
name|msdos_32_bfd_link_split_section
value|_bfd_generic_link_split_section
end_define

begin_decl_stmt
specifier|const
name|bfd_target
name|i386msdos_vec
init|=
block|{
literal|"msdos"
block|,
comment|/* name */
name|bfd_target_msdos_flavour
block|,
name|BFD_ENDIAN_LITTLE
block|,
comment|/* target byte order */
name|BFD_ENDIAN_LITTLE
block|,
comment|/* target headers byte order */
operator|(
name|EXEC_P
operator|)
block|,
comment|/* object flags */
operator|(
name|SEC_CODE
operator||
name|SEC_DATA
operator||
name|SEC_HAS_CONTENTS
operator||
name|SEC_ALLOC
operator||
name|SEC_LOAD
operator|)
block|,
comment|/* section flags */
literal|0
block|,
comment|/* leading underscore */
literal|' '
block|,
comment|/* ar_pad_char */
literal|16
block|,
comment|/* ar_max_namelen */
name|bfd_getl64
block|,
name|bfd_getl_signed_64
block|,
name|bfd_putl64
block|,
name|bfd_getl32
block|,
name|bfd_getl_signed_32
block|,
name|bfd_putl32
block|,
name|bfd_getl16
block|,
name|bfd_getl_signed_16
block|,
name|bfd_putl16
block|,
comment|/* data */
name|bfd_getl64
block|,
name|bfd_getl_signed_64
block|,
name|bfd_putl64
block|,
name|bfd_getl32
block|,
name|bfd_getl_signed_32
block|,
name|bfd_putl32
block|,
name|bfd_getl16
block|,
name|bfd_getl_signed_16
block|,
name|bfd_putl16
block|,
comment|/* hdrs */
block|{
name|_bfd_dummy_target
block|,
name|_bfd_dummy_target
block|,
comment|/* bfd_check_format */
name|_bfd_dummy_target
block|,
name|_bfd_dummy_target
block|,   }
block|,
block|{
name|bfd_false
block|,
name|msdos_mkobject
block|,
name|_bfd_generic_mkarchive
block|,
name|bfd_false
block|,   }
block|,
block|{
comment|/* bfd_write_contents */
name|bfd_false
block|,
name|msdos_write_object_contents
block|,
name|_bfd_write_archive_contents
block|,
name|bfd_false
block|,   }
block|,
name|BFD_JUMP_TABLE_GENERIC
argument_list|(
name|msdos
argument_list|)
block|,
name|BFD_JUMP_TABLE_COPY
argument_list|(
name|_bfd_generic
argument_list|)
block|,
name|BFD_JUMP_TABLE_CORE
argument_list|(
name|_bfd_nocore
argument_list|)
block|,
name|BFD_JUMP_TABLE_ARCHIVE
argument_list|(
name|_bfd_noarchive
argument_list|)
block|,
name|BFD_JUMP_TABLE_SYMBOLS
argument_list|(
name|msdos
argument_list|)
block|,
name|BFD_JUMP_TABLE_RELOCS
argument_list|(
name|msdos
argument_list|)
block|,
name|BFD_JUMP_TABLE_WRITE
argument_list|(
name|msdos
argument_list|)
block|,
name|BFD_JUMP_TABLE_LINK
argument_list|(
name|msdos
argument_list|)
block|,
name|BFD_JUMP_TABLE_DYNAMIC
argument_list|(
name|_bfd_nodynamic
argument_list|)
block|,
operator|(
name|PTR
operator|)
literal|0
block|}
decl_stmt|;
end_decl_stmt

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * host2wire.c  *  * conversion routines from the host to the wire format.  * This will usually just a re-ordering of the  * data (as we store it in network format)  *  * a Net::DNS like library for C  *  * (c) NLnet Labs, 2004-2006  *  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|<ldns/config.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_comment
comment|/* TODO Jelte   add a pointer to a 'possiblecompression' structure   to all the needed functions?   something like an array of name, pointer values?   every dname part could be added to it */
end_comment

begin_function
name|ldns_status
name|ldns_dname2buffer_wire
parameter_list|(
name|ldns_buffer
modifier|*
name|buffer
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|name
parameter_list|)
block|{
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|buffer
argument_list|,
name|ldns_rdf_size
argument_list|(
name|name
argument_list|)
argument_list|)
condition|)
block|{
name|ldns_buffer_write
argument_list|(
name|buffer
argument_list|,
name|ldns_rdf_data
argument_list|(
name|name
argument_list|)
argument_list|,
name|ldns_rdf_size
argument_list|(
name|name
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ldns_buffer_status
argument_list|(
name|buffer
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_rdf2buffer_wire
parameter_list|(
name|ldns_buffer
modifier|*
name|buffer
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|rdf
parameter_list|)
block|{
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|buffer
argument_list|,
name|ldns_rdf_size
argument_list|(
name|rdf
argument_list|)
argument_list|)
condition|)
block|{
name|ldns_buffer_write
argument_list|(
name|buffer
argument_list|,
name|ldns_rdf_data
argument_list|(
name|rdf
argument_list|)
argument_list|,
name|ldns_rdf_size
argument_list|(
name|rdf
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ldns_buffer_status
argument_list|(
name|buffer
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_rdf2buffer_wire_canonical
parameter_list|(
name|ldns_buffer
modifier|*
name|buffer
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|rdf
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|uint8_t
modifier|*
name|rdf_data
decl_stmt|;
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|rdf
argument_list|)
operator|==
name|LDNS_RDF_TYPE_DNAME
condition|)
block|{
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|buffer
argument_list|,
name|ldns_rdf_size
argument_list|(
name|rdf
argument_list|)
argument_list|)
condition|)
block|{
name|rdf_data
operator|=
name|ldns_rdf_data
argument_list|(
name|rdf
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rdf_size
argument_list|(
name|rdf
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ldns_buffer_write_u8
argument_list|(
name|buffer
argument_list|,
operator|(
name|uint8_t
operator|)
name|LDNS_DNAME_NORMALIZE
argument_list|(
operator|(
name|int
operator|)
name|rdf_data
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
comment|/* direct copy for all other types */
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|buffer
argument_list|,
name|ldns_rdf_size
argument_list|(
name|rdf
argument_list|)
argument_list|)
condition|)
block|{
name|ldns_buffer_write
argument_list|(
name|buffer
argument_list|,
name|ldns_rdf_data
argument_list|(
name|rdf
argument_list|)
argument_list|,
name|ldns_rdf_size
argument_list|(
name|rdf
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ldns_buffer_status
argument_list|(
name|buffer
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* convert a rr list to wireformat */
end_comment

begin_function
name|ldns_status
name|ldns_rr_list2buffer_wire
parameter_list|(
name|ldns_buffer
modifier|*
name|buffer
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|rr_list
parameter_list|)
block|{
name|uint16_t
name|rr_count
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|rr_count
operator|=
name|ldns_rr_list_rr_count
argument_list|(
name|rr_list
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rr_count
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|ldns_rr2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|rr_list
argument_list|,
name|i
argument_list|)
argument_list|,
name|LDNS_SECTION_ANY
argument_list|)
expr_stmt|;
block|}
return|return
name|ldns_buffer_status
argument_list|(
name|buffer
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_rr2buffer_wire_canonical
parameter_list|(
name|ldns_buffer
modifier|*
name|buffer
parameter_list|,
specifier|const
name|ldns_rr
modifier|*
name|rr
parameter_list|,
name|int
name|section
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|;
name|uint16_t
name|rdl_pos
init|=
literal|0
decl_stmt|;
name|bool
name|pre_rfc3597
init|=
name|false
decl_stmt|;
switch|switch
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
condition|)
block|{
case|case
name|LDNS_RR_TYPE_NS
case|:
case|case
name|LDNS_RR_TYPE_MD
case|:
case|case
name|LDNS_RR_TYPE_MF
case|:
case|case
name|LDNS_RR_TYPE_CNAME
case|:
case|case
name|LDNS_RR_TYPE_SOA
case|:
case|case
name|LDNS_RR_TYPE_MB
case|:
case|case
name|LDNS_RR_TYPE_MG
case|:
case|case
name|LDNS_RR_TYPE_MR
case|:
case|case
name|LDNS_RR_TYPE_PTR
case|:
case|case
name|LDNS_RR_TYPE_HINFO
case|:
case|case
name|LDNS_RR_TYPE_MINFO
case|:
case|case
name|LDNS_RR_TYPE_MX
case|:
case|case
name|LDNS_RR_TYPE_RP
case|:
case|case
name|LDNS_RR_TYPE_AFSDB
case|:
case|case
name|LDNS_RR_TYPE_RT
case|:
case|case
name|LDNS_RR_TYPE_SIG
case|:
case|case
name|LDNS_RR_TYPE_PX
case|:
case|case
name|LDNS_RR_TYPE_NXT
case|:
case|case
name|LDNS_RR_TYPE_NAPTR
case|:
case|case
name|LDNS_RR_TYPE_KX
case|:
case|case
name|LDNS_RR_TYPE_SRV
case|:
case|case
name|LDNS_RR_TYPE_DNAME
case|:
case|case
name|LDNS_RR_TYPE_A6
case|:
case|case
name|LDNS_RR_TYPE_RRSIG
case|:
name|pre_rfc3597
operator|=
name|true
expr_stmt|;
break|break;
default|default:
break|break;
block|}
if|if
condition|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire_canonical
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|buffer
argument_list|,
literal|4
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_get_class
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|section
operator|!=
name|LDNS_SECTION_QUESTION
condition|)
block|{
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|buffer
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|ldns_buffer_write_u32
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_ttl
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* remember pos for later */
name|rdl_pos
operator|=
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_rd_count
argument_list|(
name|rr
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|pre_rfc3597
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire_canonical
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rdl_pos
operator|!=
literal|0
condition|)
block|{
name|ldns_buffer_write_u16_at
argument_list|(
name|buffer
argument_list|,
name|rdl_pos
argument_list|,
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
operator|-
name|rdl_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ldns_buffer_status
argument_list|(
name|buffer
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_rr2buffer_wire
parameter_list|(
name|ldns_buffer
modifier|*
name|buffer
parameter_list|,
specifier|const
name|ldns_rr
modifier|*
name|rr
parameter_list|,
name|int
name|section
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|;
name|uint16_t
name|rdl_pos
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_dname2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|buffer
argument_list|,
literal|4
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_get_class
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|section
operator|!=
name|LDNS_SECTION_QUESTION
condition|)
block|{
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|buffer
argument_list|,
literal|6
argument_list|)
condition|)
block|{
name|ldns_buffer_write_u32
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_ttl
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
comment|/* remember pos for later */
name|rdl_pos
operator|=
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_rd_count
argument_list|(
name|rr
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rdl_pos
operator|!=
literal|0
condition|)
block|{
name|ldns_buffer_write_u16_at
argument_list|(
name|buffer
argument_list|,
name|rdl_pos
argument_list|,
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
operator|-
name|rdl_pos
operator|-
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|ldns_buffer_status
argument_list|(
name|buffer
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_rrsig2buffer_wire
parameter_list|(
name|ldns_buffer
modifier|*
name|buffer
parameter_list|,
specifier|const
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|;
comment|/* it must be a sig RR */
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_RRSIG
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
comment|/* Convert all the rdfs, except the actual signature data 	 * rdf number 8  - the last, hence: -1 */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_rd_count
argument_list|(
name|rr
argument_list|)
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire_canonical
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ldns_buffer_status
argument_list|(
name|buffer
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_rr_rdata2buffer_wire
parameter_list|(
name|ldns_buffer
modifier|*
name|buffer
parameter_list|,
specifier|const
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|;
comment|/* convert all the rdf's */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_rd_count
argument_list|(
name|rr
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|ldns_rdf2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ldns_buffer_status
argument_list|(
name|buffer
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*  * Copies the packet header data to the buffer in wire format  */
end_comment

begin_function
specifier|static
name|ldns_status
name|ldns_hdr2buffer_wire
parameter_list|(
name|ldns_buffer
modifier|*
name|buffer
parameter_list|,
specifier|const
name|ldns_pkt
modifier|*
name|packet
parameter_list|)
block|{
name|uint8_t
name|flags
decl_stmt|;
name|uint16_t
name|arcount
decl_stmt|;
if|if
condition|(
name|ldns_buffer_reserve
argument_list|(
name|buffer
argument_list|,
literal|12
argument_list|)
condition|)
block|{
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
name|ldns_pkt_id
argument_list|(
name|packet
argument_list|)
argument_list|)
expr_stmt|;
name|flags
operator|=
name|ldns_pkt_qr
argument_list|(
name|packet
argument_list|)
operator|<<
literal|7
operator||
name|ldns_pkt_get_opcode
argument_list|(
name|packet
argument_list|)
operator|<<
literal|3
operator||
name|ldns_pkt_aa
argument_list|(
name|packet
argument_list|)
operator|<<
literal|2
operator||
name|ldns_pkt_tc
argument_list|(
name|packet
argument_list|)
operator|<<
literal|1
operator||
name|ldns_pkt_rd
argument_list|(
name|packet
argument_list|)
expr_stmt|;
name|ldns_buffer_write_u8
argument_list|(
name|buffer
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|flags
operator|=
name|ldns_pkt_ra
argument_list|(
name|packet
argument_list|)
operator|<<
literal|7
comment|/*| ldns_pkt_z(packet)<< 6*/
operator||
name|ldns_pkt_ad
argument_list|(
name|packet
argument_list|)
operator|<<
literal|5
operator||
name|ldns_pkt_cd
argument_list|(
name|packet
argument_list|)
operator|<<
literal|4
operator||
name|ldns_pkt_get_rcode
argument_list|(
name|packet
argument_list|)
expr_stmt|;
name|ldns_buffer_write_u8
argument_list|(
name|buffer
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
name|ldns_pkt_qdcount
argument_list|(
name|packet
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
name|ldns_pkt_ancount
argument_list|(
name|packet
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
name|ldns_pkt_nscount
argument_list|(
name|packet
argument_list|)
argument_list|)
expr_stmt|;
comment|/* add EDNS0 and TSIG to additional if they are there */
name|arcount
operator|=
name|ldns_pkt_arcount
argument_list|(
name|packet
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_pkt_tsig
argument_list|(
name|packet
argument_list|)
condition|)
block|{
name|arcount
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|ldns_pkt_edns
argument_list|(
name|packet
argument_list|)
condition|)
block|{
name|arcount
operator|++
expr_stmt|;
block|}
name|ldns_buffer_write_u16
argument_list|(
name|buffer
argument_list|,
name|arcount
argument_list|)
expr_stmt|;
block|}
return|return
name|ldns_buffer_status
argument_list|(
name|buffer
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_pkt2buffer_wire
parameter_list|(
name|ldns_buffer
modifier|*
name|buffer
parameter_list|,
specifier|const
name|ldns_pkt
modifier|*
name|packet
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|rr_list
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
comment|/* edns tmp vars */
name|ldns_rr
modifier|*
name|edns_rr
decl_stmt|;
name|uint8_t
name|edata
index|[
literal|4
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|ldns_hdr2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|packet
argument_list|)
expr_stmt|;
name|rr_list
operator|=
name|ldns_pkt_question
argument_list|(
name|packet
argument_list|)
expr_stmt|;
if|if
condition|(
name|rr_list
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rr_list
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|ldns_rr2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|rr_list
argument_list|,
name|i
argument_list|)
argument_list|,
name|LDNS_SECTION_QUESTION
argument_list|)
expr_stmt|;
block|}
block|}
name|rr_list
operator|=
name|ldns_pkt_answer
argument_list|(
name|packet
argument_list|)
expr_stmt|;
if|if
condition|(
name|rr_list
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rr_list
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|ldns_rr2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|rr_list
argument_list|,
name|i
argument_list|)
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
block|}
block|}
name|rr_list
operator|=
name|ldns_pkt_authority
argument_list|(
name|packet
argument_list|)
expr_stmt|;
if|if
condition|(
name|rr_list
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rr_list
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|ldns_rr2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|rr_list
argument_list|,
name|i
argument_list|)
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
block|}
block|}
name|rr_list
operator|=
name|ldns_pkt_additional
argument_list|(
name|packet
argument_list|)
expr_stmt|;
if|if
condition|(
name|rr_list
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rr_list
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
operator|(
name|void
operator|)
name|ldns_rr2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|rr_list
argument_list|,
name|i
argument_list|)
argument_list|,
name|LDNS_SECTION_ADDITIONAL
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* add EDNS to additional if it is needed */
if|if
condition|(
name|ldns_pkt_edns
argument_list|(
name|packet
argument_list|)
condition|)
block|{
name|edns_rr
operator|=
name|ldns_rr_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|edns_rr
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
name|ldns_rr_set_owner
argument_list|(
name|edns_rr
argument_list|,
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
literal|"."
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_set_type
argument_list|(
name|edns_rr
argument_list|,
name|LDNS_RR_TYPE_OPT
argument_list|)
expr_stmt|;
name|ldns_rr_set_class
argument_list|(
name|edns_rr
argument_list|,
name|ldns_pkt_edns_udp_size
argument_list|(
name|packet
argument_list|)
argument_list|)
expr_stmt|;
name|edata
index|[
literal|0
index|]
operator|=
name|ldns_pkt_edns_extended_rcode
argument_list|(
name|packet
argument_list|)
expr_stmt|;
name|edata
index|[
literal|1
index|]
operator|=
name|ldns_pkt_edns_version
argument_list|(
name|packet
argument_list|)
expr_stmt|;
name|ldns_write_uint16
argument_list|(
operator|&
name|edata
index|[
literal|2
index|]
argument_list|,
name|ldns_pkt_edns_z
argument_list|(
name|packet
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_set_ttl
argument_list|(
name|edns_rr
argument_list|,
name|ldns_read_uint32
argument_list|(
name|edata
argument_list|)
argument_list|)
expr_stmt|;
comment|/* don't forget to add the edns rdata (if any) */
if|if
condition|(
name|packet
operator|->
name|_edns_data
condition|)
name|ldns_rr_push_rdf
argument_list|(
name|edns_rr
argument_list|,
name|packet
operator|->
name|_edns_data
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_rr2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|edns_rr
argument_list|,
name|LDNS_SECTION_ADDITIONAL
argument_list|)
expr_stmt|;
comment|/* take the edns rdata back out of the rr before we free rr */
if|if
condition|(
name|packet
operator|->
name|_edns_data
condition|)
operator|(
name|void
operator|)
name|ldns_rr_pop_rdf
argument_list|(
name|edns_rr
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|edns_rr
argument_list|)
expr_stmt|;
block|}
comment|/* add TSIG to additional if it is there */
if|if
condition|(
name|ldns_pkt_tsig
argument_list|(
name|packet
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_rr2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|ldns_pkt_tsig
argument_list|(
name|packet
argument_list|)
argument_list|,
name|LDNS_SECTION_ADDITIONAL
argument_list|)
expr_stmt|;
block|}
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_rdf2wire
parameter_list|(
name|uint8_t
modifier|*
modifier|*
name|dest
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|rdf
parameter_list|,
name|size_t
modifier|*
name|result_size
parameter_list|)
block|{
name|ldns_buffer
modifier|*
name|buffer
init|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
decl_stmt|;
name|uint8_t
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
operator|*
name|result_size
operator|=
literal|0
expr_stmt|;
operator|*
name|dest
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|buffer
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
name|status
operator|=
name|ldns_rdf2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|rdf
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
operator|*
name|result_size
operator|=
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|ldns_buffer_export
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_buffer_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|result
condition|)
block|{
operator|*
name|dest
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|dest
condition|)
block|{
name|ldns_buffer_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|memcpy
argument_list|(
operator|*
name|dest
argument_list|,
name|result
argument_list|,
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ldns_buffer_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_rr2wire
parameter_list|(
name|uint8_t
modifier|*
modifier|*
name|dest
parameter_list|,
specifier|const
name|ldns_rr
modifier|*
name|rr
parameter_list|,
name|int
name|section
parameter_list|,
name|size_t
modifier|*
name|result_size
parameter_list|)
block|{
name|ldns_buffer
modifier|*
name|buffer
init|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
decl_stmt|;
name|uint8_t
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
operator|*
name|result_size
operator|=
literal|0
expr_stmt|;
operator|*
name|dest
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|buffer
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
name|status
operator|=
name|ldns_rr2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|rr
argument_list|,
name|section
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
operator|*
name|result_size
operator|=
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|ldns_buffer_export
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_buffer_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|result
condition|)
block|{
operator|*
name|dest
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|dest
condition|)
block|{
name|ldns_buffer_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|memcpy
argument_list|(
operator|*
name|dest
argument_list|,
name|result
argument_list|,
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ldns_buffer_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_pkt2wire
parameter_list|(
name|uint8_t
modifier|*
modifier|*
name|dest
parameter_list|,
specifier|const
name|ldns_pkt
modifier|*
name|packet
parameter_list|,
name|size_t
modifier|*
name|result_size
parameter_list|)
block|{
name|ldns_buffer
modifier|*
name|buffer
init|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
decl_stmt|;
name|uint8_t
modifier|*
name|result
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
operator|*
name|result_size
operator|=
literal|0
expr_stmt|;
operator|*
name|dest
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|buffer
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
name|status
operator|=
name|ldns_pkt2buffer_wire
argument_list|(
name|buffer
argument_list|,
name|packet
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
operator|*
name|result_size
operator|=
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
name|result
operator|=
operator|(
name|uint8_t
operator|*
operator|)
name|ldns_buffer_export
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_buffer_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
if|if
condition|(
name|result
condition|)
block|{
operator|*
name|dest
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|dest
condition|)
block|{
name|ldns_buffer_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|memcpy
argument_list|(
operator|*
name|dest
argument_list|,
name|result
argument_list|,
name|ldns_buffer_position
argument_list|(
name|buffer
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ldns_buffer_free
argument_list|(
name|buffer
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

end_unit


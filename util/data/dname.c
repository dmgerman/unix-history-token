begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * util/data/dname.h - domain name handling  *  * Copyright (c) 2007, NLnet Labs. All rights reserved.  *  * This software is open source.  *   * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  *   * Redistributions of source code must retain the above copyright notice,  * this list of conditions and the following disclaimer.  *   * Redistributions in binary form must reproduce the above copyright notice,  * this list of conditions and the following disclaimer in the documentation  * and/or other materials provided with the distribution.  *   * Neither the name of the NLNET LABS nor the names of its contributors may  * be used to endorse or promote products derived from this software without  * specific prior written permission.  *   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS  * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT  * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR  * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT  * HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,  * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED  * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR  * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF  * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING  * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_comment
comment|/**  * \file  *  * This file contains domain name handling functions.  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"util/data/dname.h"
end_include

begin_include
include|#
directive|include
file|"util/data/msgparse.h"
end_include

begin_include
include|#
directive|include
file|"util/log.h"
end_include

begin_include
include|#
directive|include
file|"util/storage/lookup3.h"
end_include

begin_include
include|#
directive|include
file|"sldns/sbuffer.h"
end_include

begin_comment
comment|/* determine length of a dname in buffer, no compression pointers allowed */
end_comment

begin_function
name|size_t
name|query_dname_len
parameter_list|(
name|sldns_buffer
modifier|*
name|query
parameter_list|)
block|{
name|size_t
name|len
init|=
literal|0
decl_stmt|;
name|size_t
name|labellen
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
if|if
condition|(
name|sldns_buffer_remaining
argument_list|(
name|query
argument_list|)
operator|<
literal|1
condition|)
return|return
literal|0
return|;
comment|/* parse error, need label len */
name|labellen
operator|=
name|sldns_buffer_read_u8
argument_list|(
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|labellen
operator|&
literal|0xc0
condition|)
return|return
literal|0
return|;
comment|/* no compression allowed in queries */
name|len
operator|+=
name|labellen
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|LDNS_MAX_DOMAINLEN
condition|)
return|return
literal|0
return|;
comment|/* too long */
if|if
condition|(
name|labellen
operator|==
literal|0
condition|)
return|return
name|len
return|;
if|if
condition|(
name|sldns_buffer_remaining
argument_list|(
name|query
argument_list|)
operator|<
name|labellen
condition|)
return|return
literal|0
return|;
comment|/* parse error, need content */
name|sldns_buffer_skip
argument_list|(
name|query
argument_list|,
operator|(
name|ssize_t
operator|)
name|labellen
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|size_t
name|dname_valid
parameter_list|(
name|uint8_t
modifier|*
name|dname
parameter_list|,
name|size_t
name|maxlen
parameter_list|)
block|{
name|size_t
name|len
init|=
literal|0
decl_stmt|;
name|size_t
name|labellen
decl_stmt|;
name|labellen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
while|while
condition|(
name|labellen
condition|)
block|{
if|if
condition|(
name|labellen
operator|&
literal|0xc0
condition|)
return|return
literal|0
return|;
comment|/* no compression ptrs allowed */
name|len
operator|+=
name|labellen
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|LDNS_MAX_DOMAINLEN
condition|)
return|return
literal|0
return|;
comment|/* too long */
if|if
condition|(
name|len
operator|>
name|maxlen
condition|)
return|return
literal|0
return|;
comment|/* does not fit in memory allocation */
name|dname
operator|+=
name|labellen
expr_stmt|;
name|labellen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
block|}
name|len
operator|+=
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|maxlen
condition|)
return|return
literal|0
return|;
comment|/* does not fit in memory allocation */
return|return
name|len
return|;
block|}
end_function

begin_comment
comment|/** compare uncompressed, noncanonical, registers are hints for speed */
end_comment

begin_function
name|int
name|query_dname_compare
parameter_list|(
specifier|register
name|uint8_t
modifier|*
name|d1
parameter_list|,
specifier|register
name|uint8_t
modifier|*
name|d2
parameter_list|)
block|{
specifier|register
name|uint8_t
name|lab1
decl_stmt|,
name|lab2
decl_stmt|;
name|log_assert
argument_list|(
name|d1
operator|&&
name|d2
argument_list|)
expr_stmt|;
name|lab1
operator|=
operator|*
name|d1
operator|++
expr_stmt|;
name|lab2
operator|=
operator|*
name|d2
operator|++
expr_stmt|;
while|while
condition|(
name|lab1
operator|!=
literal|0
operator|||
name|lab2
operator|!=
literal|0
condition|)
block|{
comment|/* compare label length */
comment|/* if one dname ends, it has labellength 0 */
if|if
condition|(
name|lab1
operator|!=
name|lab2
condition|)
block|{
if|if
condition|(
name|lab1
operator|<
name|lab2
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|1
return|;
block|}
name|log_assert
argument_list|(
name|lab1
operator|==
name|lab2
operator|&&
name|lab1
operator|!=
literal|0
argument_list|)
expr_stmt|;
comment|/* compare lowercased labels. */
while|while
condition|(
name|lab1
operator|--
condition|)
block|{
comment|/* compare bytes first for speed */
if|if
condition|(
operator|*
name|d1
operator|!=
operator|*
name|d2
operator|&&
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d1
argument_list|)
operator|!=
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d2
argument_list|)
condition|)
block|{
if|if
condition|(
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d1
argument_list|)
operator|<
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d2
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|1
return|;
block|}
name|d1
operator|++
expr_stmt|;
name|d2
operator|++
expr_stmt|;
block|}
comment|/* next pair of labels. */
name|lab1
operator|=
operator|*
name|d1
operator|++
expr_stmt|;
name|lab2
operator|=
operator|*
name|d2
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|query_dname_tolower
parameter_list|(
name|uint8_t
modifier|*
name|dname
parameter_list|)
block|{
comment|/* the dname is stored uncompressed */
name|uint8_t
name|labellen
decl_stmt|;
name|labellen
operator|=
operator|*
name|dname
expr_stmt|;
while|while
condition|(
name|labellen
condition|)
block|{
name|dname
operator|++
expr_stmt|;
while|while
condition|(
name|labellen
operator|--
condition|)
block|{
operator|*
name|dname
operator|=
operator|(
name|uint8_t
operator|)
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|dname
argument_list|)
expr_stmt|;
name|dname
operator|++
expr_stmt|;
block|}
name|labellen
operator|=
operator|*
name|dname
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|pkt_dname_tolower
parameter_list|(
name|sldns_buffer
modifier|*
name|pkt
parameter_list|,
name|uint8_t
modifier|*
name|dname
parameter_list|)
block|{
name|uint8_t
name|lablen
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|dname
operator|>=
name|sldns_buffer_end
argument_list|(
name|pkt
argument_list|)
condition|)
return|return;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
while|while
condition|(
name|lablen
condition|)
block|{
if|if
condition|(
name|LABEL_IS_PTR
argument_list|(
name|lablen
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|size_t
operator|)
name|PTR_OFFSET
argument_list|(
name|lablen
argument_list|,
operator|*
name|dname
argument_list|)
operator|>=
name|sldns_buffer_limit
argument_list|(
name|pkt
argument_list|)
condition|)
return|return;
name|dname
operator|=
name|sldns_buffer_at
argument_list|(
name|pkt
argument_list|,
name|PTR_OFFSET
argument_list|(
name|lablen
argument_list|,
operator|*
name|dname
argument_list|)
argument_list|)
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
if|if
condition|(
name|count
operator|++
operator|>
name|MAX_COMPRESS_PTRS
condition|)
return|return;
continue|continue;
block|}
if|if
condition|(
name|dname
operator|+
name|lablen
operator|>=
name|sldns_buffer_end
argument_list|(
name|pkt
argument_list|)
condition|)
return|return;
while|while
condition|(
name|lablen
operator|--
condition|)
block|{
operator|*
name|dname
operator|=
operator|(
name|uint8_t
operator|)
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|dname
argument_list|)
expr_stmt|;
name|dname
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|dname
operator|>=
name|sldns_buffer_end
argument_list|(
name|pkt
argument_list|)
condition|)
return|return;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|size_t
name|pkt_dname_len
parameter_list|(
name|sldns_buffer
modifier|*
name|pkt
parameter_list|)
block|{
name|size_t
name|len
init|=
literal|0
decl_stmt|;
name|int
name|ptrcount
init|=
literal|0
decl_stmt|;
name|uint8_t
name|labellen
decl_stmt|;
name|size_t
name|endpos
init|=
literal|0
decl_stmt|;
comment|/* read dname and determine length */
comment|/* check compression pointers, loops, out of bounds */
while|while
condition|(
literal|1
condition|)
block|{
comment|/* read next label */
if|if
condition|(
name|sldns_buffer_remaining
argument_list|(
name|pkt
argument_list|)
operator|<
literal|1
condition|)
return|return
literal|0
return|;
name|labellen
operator|=
name|sldns_buffer_read_u8
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
if|if
condition|(
name|LABEL_IS_PTR
argument_list|(
name|labellen
argument_list|)
condition|)
block|{
comment|/* compression ptr */
name|uint16_t
name|ptr
decl_stmt|;
if|if
condition|(
name|sldns_buffer_remaining
argument_list|(
name|pkt
argument_list|)
operator|<
literal|1
condition|)
return|return
literal|0
return|;
name|ptr
operator|=
name|PTR_OFFSET
argument_list|(
name|labellen
argument_list|,
name|sldns_buffer_read_u8
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|ptrcount
operator|++
operator|>
name|MAX_COMPRESS_PTRS
condition|)
return|return
literal|0
return|;
comment|/* loop! */
if|if
condition|(
name|sldns_buffer_limit
argument_list|(
name|pkt
argument_list|)
operator|<=
name|ptr
condition|)
return|return
literal|0
return|;
comment|/* out of bounds! */
if|if
condition|(
operator|!
name|endpos
condition|)
name|endpos
operator|=
name|sldns_buffer_position
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|sldns_buffer_set_position
argument_list|(
name|pkt
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* label contents */
if|if
condition|(
name|labellen
operator|>
literal|0x3f
condition|)
return|return
literal|0
return|;
comment|/* label too long */
name|len
operator|+=
literal|1
operator|+
name|labellen
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|LDNS_MAX_DOMAINLEN
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|labellen
operator|==
literal|0
condition|)
block|{
comment|/* end of dname */
break|break;
block|}
if|if
condition|(
name|sldns_buffer_remaining
argument_list|(
name|pkt
argument_list|)
operator|<
name|labellen
condition|)
return|return
literal|0
return|;
name|sldns_buffer_skip
argument_list|(
name|pkt
argument_list|,
operator|(
name|ssize_t
operator|)
name|labellen
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|endpos
condition|)
name|sldns_buffer_set_position
argument_list|(
name|pkt
argument_list|,
name|endpos
argument_list|)
expr_stmt|;
return|return
name|len
return|;
block|}
end_function

begin_function
name|int
name|dname_pkt_compare
parameter_list|(
name|sldns_buffer
modifier|*
name|pkt
parameter_list|,
name|uint8_t
modifier|*
name|d1
parameter_list|,
name|uint8_t
modifier|*
name|d2
parameter_list|)
block|{
name|uint8_t
name|len1
decl_stmt|,
name|len2
decl_stmt|;
name|log_assert
argument_list|(
name|pkt
operator|&&
name|d1
operator|&&
name|d2
argument_list|)
expr_stmt|;
name|len1
operator|=
operator|*
name|d1
operator|++
expr_stmt|;
name|len2
operator|=
operator|*
name|d2
operator|++
expr_stmt|;
while|while
condition|(
name|len1
operator|!=
literal|0
operator|||
name|len2
operator|!=
literal|0
condition|)
block|{
comment|/* resolve ptrs */
if|if
condition|(
name|LABEL_IS_PTR
argument_list|(
name|len1
argument_list|)
condition|)
block|{
name|d1
operator|=
name|sldns_buffer_at
argument_list|(
name|pkt
argument_list|,
name|PTR_OFFSET
argument_list|(
name|len1
argument_list|,
operator|*
name|d1
argument_list|)
argument_list|)
expr_stmt|;
name|len1
operator|=
operator|*
name|d1
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|LABEL_IS_PTR
argument_list|(
name|len2
argument_list|)
condition|)
block|{
name|d2
operator|=
name|sldns_buffer_at
argument_list|(
name|pkt
argument_list|,
name|PTR_OFFSET
argument_list|(
name|len2
argument_list|,
operator|*
name|d2
argument_list|)
argument_list|)
expr_stmt|;
name|len2
operator|=
operator|*
name|d2
operator|++
expr_stmt|;
continue|continue;
block|}
comment|/* check label length */
name|log_assert
argument_list|(
name|len1
operator|<=
name|LDNS_MAX_LABELLEN
argument_list|)
expr_stmt|;
name|log_assert
argument_list|(
name|len2
operator|<=
name|LDNS_MAX_LABELLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|len1
operator|!=
name|len2
condition|)
block|{
if|if
condition|(
name|len1
operator|<
name|len2
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|1
return|;
block|}
name|log_assert
argument_list|(
name|len1
operator|==
name|len2
operator|&&
name|len1
operator|!=
literal|0
argument_list|)
expr_stmt|;
comment|/* compare labels */
while|while
condition|(
name|len1
operator|--
condition|)
block|{
if|if
condition|(
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d1
argument_list|)
operator|!=
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d2
argument_list|)
condition|)
block|{
if|if
condition|(
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d1
argument_list|)
operator|<
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d2
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|1
return|;
block|}
name|d1
operator|++
expr_stmt|;
name|d2
operator|++
expr_stmt|;
block|}
name|len1
operator|=
operator|*
name|d1
operator|++
expr_stmt|;
name|len2
operator|=
operator|*
name|d2
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|hashvalue_t
name|dname_query_hash
parameter_list|(
name|uint8_t
modifier|*
name|dname
parameter_list|,
name|hashvalue_t
name|h
parameter_list|)
block|{
name|uint8_t
name|labuf
index|[
name|LDNS_MAX_LABELLEN
operator|+
literal|1
index|]
decl_stmt|;
name|uint8_t
name|lablen
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* preserve case of query, make hash label by label */
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
while|while
condition|(
name|lablen
condition|)
block|{
name|log_assert
argument_list|(
name|lablen
operator|<=
name|LDNS_MAX_LABELLEN
argument_list|)
expr_stmt|;
name|labuf
index|[
literal|0
index|]
operator|=
name|lablen
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|lablen
operator|--
condition|)
block|{
name|labuf
index|[
operator|++
name|i
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|dname
argument_list|)
expr_stmt|;
name|dname
operator|++
expr_stmt|;
block|}
name|h
operator|=
name|hashlittle
argument_list|(
name|labuf
argument_list|,
name|labuf
index|[
literal|0
index|]
operator|+
literal|1
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
block|}
return|return
name|h
return|;
block|}
end_function

begin_function
name|hashvalue_t
name|dname_pkt_hash
parameter_list|(
name|sldns_buffer
modifier|*
name|pkt
parameter_list|,
name|uint8_t
modifier|*
name|dname
parameter_list|,
name|hashvalue_t
name|h
parameter_list|)
block|{
name|uint8_t
name|labuf
index|[
name|LDNS_MAX_LABELLEN
operator|+
literal|1
index|]
decl_stmt|;
name|uint8_t
name|lablen
decl_stmt|;
name|int
name|i
decl_stmt|;
comment|/* preserve case of query, make hash label by label */
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
while|while
condition|(
name|lablen
condition|)
block|{
if|if
condition|(
name|LABEL_IS_PTR
argument_list|(
name|lablen
argument_list|)
condition|)
block|{
comment|/* follow pointer */
name|dname
operator|=
name|sldns_buffer_at
argument_list|(
name|pkt
argument_list|,
name|PTR_OFFSET
argument_list|(
name|lablen
argument_list|,
operator|*
name|dname
argument_list|)
argument_list|)
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
continue|continue;
block|}
name|log_assert
argument_list|(
name|lablen
operator|<=
name|LDNS_MAX_LABELLEN
argument_list|)
expr_stmt|;
name|labuf
index|[
literal|0
index|]
operator|=
name|lablen
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|lablen
operator|--
condition|)
block|{
name|labuf
index|[
operator|++
name|i
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|dname
argument_list|)
expr_stmt|;
name|dname
operator|++
expr_stmt|;
block|}
name|h
operator|=
name|hashlittle
argument_list|(
name|labuf
argument_list|,
name|labuf
index|[
literal|0
index|]
operator|+
literal|1
argument_list|,
name|h
argument_list|)
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
block|}
return|return
name|h
return|;
block|}
end_function

begin_function
name|void
name|dname_pkt_copy
parameter_list|(
name|sldns_buffer
modifier|*
name|pkt
parameter_list|,
name|uint8_t
modifier|*
name|to
parameter_list|,
name|uint8_t
modifier|*
name|dname
parameter_list|)
block|{
comment|/* copy over the dname and decompress it at the same time */
name|size_t
name|len
init|=
literal|0
decl_stmt|;
name|uint8_t
name|lablen
decl_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
while|while
condition|(
name|lablen
condition|)
block|{
if|if
condition|(
name|LABEL_IS_PTR
argument_list|(
name|lablen
argument_list|)
condition|)
block|{
comment|/* follow pointer */
name|dname
operator|=
name|sldns_buffer_at
argument_list|(
name|pkt
argument_list|,
name|PTR_OFFSET
argument_list|(
name|lablen
argument_list|,
operator|*
name|dname
argument_list|)
argument_list|)
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
continue|continue;
block|}
name|log_assert
argument_list|(
name|lablen
operator|<=
name|LDNS_MAX_LABELLEN
argument_list|)
expr_stmt|;
name|len
operator|+=
operator|(
name|size_t
operator|)
name|lablen
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|LDNS_MAX_DOMAINLEN
condition|)
block|{
operator|*
name|to
operator|=
literal|0
expr_stmt|;
comment|/* end the result prematurely */
name|log_err
argument_list|(
literal|"bad dname in dname_pkt_copy"
argument_list|)
expr_stmt|;
return|return;
block|}
operator|*
name|to
operator|++
operator|=
name|lablen
expr_stmt|;
name|memmove
argument_list|(
name|to
argument_list|,
name|dname
argument_list|,
name|lablen
argument_list|)
expr_stmt|;
name|dname
operator|+=
name|lablen
expr_stmt|;
name|to
operator|+=
name|lablen
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
block|}
comment|/* copy last \0 */
operator|*
name|to
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dname_print
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|struct
name|sldns_buffer
modifier|*
name|pkt
parameter_list|,
name|uint8_t
modifier|*
name|dname
parameter_list|)
block|{
name|uint8_t
name|lablen
decl_stmt|;
if|if
condition|(
operator|!
name|out
condition|)
name|out
operator|=
name|stdout
expr_stmt|;
if|if
condition|(
operator|!
name|dname
condition|)
return|return;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|lablen
condition|)
name|fputc
argument_list|(
literal|'.'
argument_list|,
name|out
argument_list|)
expr_stmt|;
while|while
condition|(
name|lablen
condition|)
block|{
if|if
condition|(
name|LABEL_IS_PTR
argument_list|(
name|lablen
argument_list|)
condition|)
block|{
comment|/* follow pointer */
if|if
condition|(
operator|!
name|pkt
condition|)
block|{
name|fputs
argument_list|(
literal|"??compressionptr??"
argument_list|,
name|out
argument_list|)
expr_stmt|;
return|return;
block|}
name|dname
operator|=
name|sldns_buffer_at
argument_list|(
name|pkt
argument_list|,
name|PTR_OFFSET
argument_list|(
name|lablen
argument_list|,
operator|*
name|dname
argument_list|)
argument_list|)
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|lablen
operator|>
name|LDNS_MAX_LABELLEN
condition|)
block|{
name|fputs
argument_list|(
literal|"??extendedlabel??"
argument_list|,
name|out
argument_list|)
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|lablen
operator|--
condition|)
name|fputc
argument_list|(
operator|(
name|int
operator|)
operator|*
name|dname
operator|++
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
literal|'.'
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_function
name|int
name|dname_count_labels
parameter_list|(
name|uint8_t
modifier|*
name|dname
parameter_list|)
block|{
name|uint8_t
name|lablen
decl_stmt|;
name|int
name|labs
init|=
literal|1
decl_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
while|while
condition|(
name|lablen
condition|)
block|{
name|labs
operator|++
expr_stmt|;
name|dname
operator|+=
name|lablen
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
block|}
return|return
name|labs
return|;
block|}
end_function

begin_function
name|int
name|dname_count_size_labels
parameter_list|(
name|uint8_t
modifier|*
name|dname
parameter_list|,
name|size_t
modifier|*
name|size
parameter_list|)
block|{
name|uint8_t
name|lablen
decl_stmt|;
name|int
name|labs
init|=
literal|1
decl_stmt|;
name|size_t
name|sz
init|=
literal|1
decl_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
while|while
condition|(
name|lablen
condition|)
block|{
name|labs
operator|++
expr_stmt|;
name|sz
operator|+=
name|lablen
operator|+
literal|1
expr_stmt|;
name|dname
operator|+=
name|lablen
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
block|}
operator|*
name|size
operator|=
name|sz
expr_stmt|;
return|return
name|labs
return|;
block|}
end_function

begin_comment
comment|/**  * Compare labels in memory, lowercase while comparing.  * @param p1: label 1  * @param p2: label 2  * @param len: number of bytes to compare.  * @return: 0, -1, +1 comparison result.  */
end_comment

begin_function
specifier|static
name|int
name|memlowercmp
parameter_list|(
name|uint8_t
modifier|*
name|p1
parameter_list|,
name|uint8_t
modifier|*
name|p2
parameter_list|,
name|uint8_t
name|len
parameter_list|)
block|{
while|while
condition|(
name|len
operator|--
condition|)
block|{
if|if
condition|(
operator|*
name|p1
operator|!=
operator|*
name|p2
operator|&&
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|p1
argument_list|)
operator|!=
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|p2
argument_list|)
condition|)
block|{
if|if
condition|(
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|p1
argument_list|)
operator|<
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|p2
argument_list|)
condition|)
return|return
operator|-
literal|1
return|;
return|return
literal|1
return|;
block|}
name|p1
operator|++
expr_stmt|;
name|p2
operator|++
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dname_lab_cmp
parameter_list|(
name|uint8_t
modifier|*
name|d1
parameter_list|,
name|int
name|labs1
parameter_list|,
name|uint8_t
modifier|*
name|d2
parameter_list|,
name|int
name|labs2
parameter_list|,
name|int
modifier|*
name|mlabs
parameter_list|)
block|{
name|uint8_t
name|len1
decl_stmt|,
name|len2
decl_stmt|;
name|int
name|atlabel
init|=
name|labs1
decl_stmt|;
name|int
name|lastmlabs
decl_stmt|;
name|int
name|lastdiff
init|=
literal|0
decl_stmt|;
comment|/* first skip so that we compare same label. */
if|if
condition|(
name|labs1
operator|>
name|labs2
condition|)
block|{
while|while
condition|(
name|atlabel
operator|>
name|labs2
condition|)
block|{
name|len1
operator|=
operator|*
name|d1
operator|++
expr_stmt|;
name|d1
operator|+=
name|len1
expr_stmt|;
name|atlabel
operator|--
expr_stmt|;
block|}
name|log_assert
argument_list|(
name|atlabel
operator|==
name|labs2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|labs1
operator|<
name|labs2
condition|)
block|{
name|atlabel
operator|=
name|labs2
expr_stmt|;
while|while
condition|(
name|atlabel
operator|>
name|labs1
condition|)
block|{
name|len2
operator|=
operator|*
name|d2
operator|++
expr_stmt|;
name|d2
operator|+=
name|len2
expr_stmt|;
name|atlabel
operator|--
expr_stmt|;
block|}
name|log_assert
argument_list|(
name|atlabel
operator|==
name|labs1
argument_list|)
expr_stmt|;
block|}
name|lastmlabs
operator|=
name|atlabel
operator|+
literal|1
expr_stmt|;
comment|/* now at same label in d1 and d2, atlabel */
comment|/* www.example.com.                  */
comment|/* 4   3       2  1   atlabel number */
comment|/* repeat until at root label (which is always the same) */
while|while
condition|(
name|atlabel
operator|>
literal|1
condition|)
block|{
name|len1
operator|=
operator|*
name|d1
operator|++
expr_stmt|;
name|len2
operator|=
operator|*
name|d2
operator|++
expr_stmt|;
if|if
condition|(
name|len1
operator|!=
name|len2
condition|)
block|{
name|log_assert
argument_list|(
name|len1
operator|!=
literal|0
operator|&&
name|len2
operator|!=
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|len1
operator|<
name|len2
condition|)
name|lastdiff
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|lastdiff
operator|=
literal|1
expr_stmt|;
name|lastmlabs
operator|=
name|atlabel
expr_stmt|;
name|d1
operator|+=
name|len1
expr_stmt|;
name|d2
operator|+=
name|len2
expr_stmt|;
block|}
else|else
block|{
comment|/* memlowercmp is inlined here; or just like 			 * if((c=memlowercmp(d1, d2, len1)) != 0) {  			 *	lastdiff = c; 			 *	lastmlabs = atlabel; } apart from d1++,d2++ */
while|while
condition|(
name|len1
condition|)
block|{
if|if
condition|(
operator|*
name|d1
operator|!=
operator|*
name|d2
operator|&&
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d1
argument_list|)
operator|!=
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d2
argument_list|)
condition|)
block|{
if|if
condition|(
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d1
argument_list|)
operator|<
name|tolower
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|d2
argument_list|)
condition|)
block|{
name|lastdiff
operator|=
operator|-
literal|1
expr_stmt|;
name|lastmlabs
operator|=
name|atlabel
expr_stmt|;
name|d1
operator|+=
name|len1
expr_stmt|;
name|d2
operator|+=
name|len1
expr_stmt|;
break|break;
block|}
name|lastdiff
operator|=
literal|1
expr_stmt|;
name|lastmlabs
operator|=
name|atlabel
expr_stmt|;
name|d1
operator|+=
name|len1
expr_stmt|;
name|d2
operator|+=
name|len1
expr_stmt|;
break|break;
comment|/* out of memlowercmp */
block|}
name|d1
operator|++
expr_stmt|;
name|d2
operator|++
expr_stmt|;
name|len1
operator|--
expr_stmt|;
block|}
block|}
name|atlabel
operator|--
expr_stmt|;
block|}
comment|/* last difference atlabel number, so number of labels matching, 	 * at the right side, is one less. */
operator|*
name|mlabs
operator|=
name|lastmlabs
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|lastdiff
operator|==
literal|0
condition|)
block|{
comment|/* all labels compared were equal, check if one has more 		 * labels, so that example.com.> com. */
if|if
condition|(
name|labs1
operator|>
name|labs2
condition|)
return|return
literal|1
return|;
elseif|else
if|if
condition|(
name|labs1
operator|<
name|labs2
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
name|lastdiff
return|;
block|}
end_function

begin_function
name|int
name|dname_buffer_write
parameter_list|(
name|sldns_buffer
modifier|*
name|pkt
parameter_list|,
name|uint8_t
modifier|*
name|dname
parameter_list|)
block|{
name|uint8_t
name|lablen
decl_stmt|;
if|if
condition|(
name|sldns_buffer_remaining
argument_list|(
name|pkt
argument_list|)
operator|<
literal|1
condition|)
return|return
literal|0
return|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
name|sldns_buffer_write_u8
argument_list|(
name|pkt
argument_list|,
name|lablen
argument_list|)
expr_stmt|;
while|while
condition|(
name|lablen
condition|)
block|{
if|if
condition|(
name|sldns_buffer_remaining
argument_list|(
name|pkt
argument_list|)
operator|<
operator|(
name|size_t
operator|)
name|lablen
operator|+
literal|1
condition|)
return|return
literal|0
return|;
name|sldns_buffer_write
argument_list|(
name|pkt
argument_list|,
name|dname
argument_list|,
name|lablen
argument_list|)
expr_stmt|;
name|dname
operator|+=
name|lablen
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
name|sldns_buffer_write_u8
argument_list|(
name|pkt
argument_list|,
name|lablen
argument_list|)
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|dname_str
parameter_list|(
name|uint8_t
modifier|*
name|dname
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|size_t
name|len
init|=
literal|0
decl_stmt|;
name|uint8_t
name|lablen
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|s
init|=
name|str
decl_stmt|;
if|if
condition|(
operator|!
name|dname
operator|||
operator|!
operator|*
name|dname
condition|)
block|{
operator|*
name|s
operator|++
operator|=
literal|'.'
expr_stmt|;
operator|*
name|s
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
while|while
condition|(
name|lablen
condition|)
block|{
if|if
condition|(
name|lablen
operator|>
name|LDNS_MAX_LABELLEN
condition|)
block|{
operator|*
name|s
operator|++
operator|=
literal|'#'
expr_stmt|;
operator|*
name|s
operator|=
literal|0
expr_stmt|;
return|return;
block|}
name|len
operator|+=
name|lablen
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|len
operator|>=
name|LDNS_MAX_DOMAINLEN
operator|-
literal|1
condition|)
block|{
operator|*
name|s
operator|++
operator|=
literal|'&'
expr_stmt|;
operator|*
name|s
operator|=
literal|0
expr_stmt|;
return|return;
block|}
while|while
condition|(
name|lablen
operator|--
condition|)
block|{
if|if
condition|(
name|isalnum
argument_list|(
operator|(
name|unsigned
name|char
operator|)
operator|*
name|dname
argument_list|)
operator|||
operator|*
name|dname
operator|==
literal|'-'
operator|||
operator|*
name|dname
operator|==
literal|'_'
operator|||
operator|*
name|dname
operator|==
literal|'*'
condition|)
operator|*
name|s
operator|++
operator|=
operator|*
operator|(
name|char
operator|*
operator|)
name|dname
operator|++
expr_stmt|;
else|else
block|{
operator|*
name|s
operator|++
operator|=
literal|'?'
expr_stmt|;
name|dname
operator|++
expr_stmt|;
block|}
block|}
operator|*
name|s
operator|++
operator|=
literal|'.'
expr_stmt|;
name|lablen
operator|=
operator|*
name|dname
operator|++
expr_stmt|;
block|}
operator|*
name|s
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|int
name|dname_strict_subdomain
parameter_list|(
name|uint8_t
modifier|*
name|d1
parameter_list|,
name|int
name|labs1
parameter_list|,
name|uint8_t
modifier|*
name|d2
parameter_list|,
name|int
name|labs2
parameter_list|)
block|{
name|int
name|m
decl_stmt|;
comment|/* check subdomain: d1: www.example.com. and d2: example.com. */
if|if
condition|(
name|labs2
operator|>=
name|labs1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|dname_lab_cmp
argument_list|(
name|d1
argument_list|,
name|labs1
argument_list|,
name|d2
argument_list|,
name|labs2
argument_list|,
operator|&
name|m
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/* subdomain if all labels match */
return|return
operator|(
name|m
operator|==
name|labs2
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dname_strict_subdomain_c
parameter_list|(
name|uint8_t
modifier|*
name|d1
parameter_list|,
name|uint8_t
modifier|*
name|d2
parameter_list|)
block|{
return|return
name|dname_strict_subdomain
argument_list|(
name|d1
argument_list|,
name|dname_count_labels
argument_list|(
name|d1
argument_list|)
argument_list|,
name|d2
argument_list|,
name|dname_count_labels
argument_list|(
name|d2
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|dname_subdomain_c
parameter_list|(
name|uint8_t
modifier|*
name|d1
parameter_list|,
name|uint8_t
modifier|*
name|d2
parameter_list|)
block|{
name|int
name|m
decl_stmt|;
comment|/* check subdomain: d1: www.example.com. and d2: example.com. */
comment|/*  	or 	    d1: example.com. and d2: example.com. */
name|int
name|labs1
init|=
name|dname_count_labels
argument_list|(
name|d1
argument_list|)
decl_stmt|;
name|int
name|labs2
init|=
name|dname_count_labels
argument_list|(
name|d2
argument_list|)
decl_stmt|;
if|if
condition|(
name|labs2
operator|>
name|labs1
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|dname_lab_cmp
argument_list|(
name|d1
argument_list|,
name|labs1
argument_list|,
name|d2
argument_list|,
name|labs2
argument_list|,
operator|&
name|m
argument_list|)
operator|<
literal|0
condition|)
block|{
comment|/* must have been example.com , www.example.com - wrong */
comment|/* or otherwise different dnames */
return|return
literal|0
return|;
block|}
return|return
operator|(
name|m
operator|==
name|labs2
operator|)
return|;
block|}
end_function

begin_function
name|int
name|dname_is_root
parameter_list|(
name|uint8_t
modifier|*
name|dname
parameter_list|)
block|{
name|uint8_t
name|len
decl_stmt|;
name|log_assert
argument_list|(
name|dname
argument_list|)
expr_stmt|;
name|len
operator|=
name|dname
index|[
literal|0
index|]
expr_stmt|;
name|log_assert
argument_list|(
operator|!
name|LABEL_IS_PTR
argument_list|(
name|len
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|len
operator|==
literal|0
operator|)
return|;
block|}
end_function

begin_function
name|void
name|dname_remove_label
parameter_list|(
name|uint8_t
modifier|*
modifier|*
name|dname
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|)
block|{
name|size_t
name|lablen
decl_stmt|;
name|log_assert
argument_list|(
name|dname
operator|&&
operator|*
name|dname
operator|&&
name|len
argument_list|)
expr_stmt|;
name|lablen
operator|=
operator|(
operator|*
name|dname
operator|)
index|[
literal|0
index|]
expr_stmt|;
name|log_assert
argument_list|(
operator|!
name|LABEL_IS_PTR
argument_list|(
name|lablen
argument_list|)
argument_list|)
expr_stmt|;
name|log_assert
argument_list|(
operator|*
name|len
operator|>
name|lablen
argument_list|)
expr_stmt|;
if|if
condition|(
name|lablen
operator|==
literal|0
condition|)
return|return;
comment|/* do not modify root label */
operator|*
name|len
operator|-=
name|lablen
operator|+
literal|1
expr_stmt|;
operator|*
name|dname
operator|+=
name|lablen
operator|+
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|dname_remove_labels
parameter_list|(
name|uint8_t
modifier|*
modifier|*
name|dname
parameter_list|,
name|size_t
modifier|*
name|len
parameter_list|,
name|int
name|n
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
name|dname_remove_label
argument_list|(
name|dname
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|dname_signame_label_count
parameter_list|(
name|uint8_t
modifier|*
name|dname
parameter_list|)
block|{
name|uint8_t
name|lablen
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
operator|*
name|dname
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|dname
index|[
literal|0
index|]
operator|==
literal|1
operator|&&
name|dname
index|[
literal|1
index|]
operator|==
literal|'*'
condition|)
name|dname
operator|+=
literal|2
expr_stmt|;
name|lablen
operator|=
name|dname
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
name|lablen
condition|)
block|{
name|count
operator|++
expr_stmt|;
name|dname
operator|+=
name|lablen
expr_stmt|;
name|dname
operator|+=
literal|1
expr_stmt|;
name|lablen
operator|=
name|dname
index|[
literal|0
index|]
expr_stmt|;
block|}
return|return
name|count
return|;
block|}
end_function

begin_function
name|int
name|dname_is_wild
parameter_list|(
name|uint8_t
modifier|*
name|dname
parameter_list|)
block|{
return|return
operator|(
name|dname
index|[
literal|0
index|]
operator|==
literal|1
operator|&&
name|dname
index|[
literal|1
index|]
operator|==
literal|'*'
operator|)
return|;
block|}
end_function

begin_comment
comment|/**  * Compare labels in memory, lowercase while comparing.  * Returns canonical order for labels. If all is equal, the  * shortest is first.  *  * @param p1: label 1  * @param len1: length of label 1.  * @param p2: label 2  * @param len2: length of label 2.  * @return: 0, -1, +1 comparison result.  */
end_comment

begin_function
specifier|static
name|int
name|memcanoncmp
parameter_list|(
name|uint8_t
modifier|*
name|p1
parameter_list|,
name|uint8_t
name|len1
parameter_list|,
name|uint8_t
modifier|*
name|p2
parameter_list|,
name|uint8_t
name|len2
parameter_list|)
block|{
name|uint8_t
name|min
init|=
operator|(
name|len1
operator|<
name|len2
operator|)
condition|?
name|len1
else|:
name|len2
decl_stmt|;
name|int
name|c
init|=
name|memlowercmp
argument_list|(
name|p1
argument_list|,
name|p2
argument_list|,
name|min
argument_list|)
decl_stmt|;
if|if
condition|(
name|c
operator|!=
literal|0
condition|)
return|return
name|c
return|;
comment|/* equal, see who is shortest */
if|if
condition|(
name|len1
operator|<
name|len2
condition|)
return|return
operator|-
literal|1
return|;
if|if
condition|(
name|len1
operator|>
name|len2
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|dname_canon_lab_cmp
parameter_list|(
name|uint8_t
modifier|*
name|d1
parameter_list|,
name|int
name|labs1
parameter_list|,
name|uint8_t
modifier|*
name|d2
parameter_list|,
name|int
name|labs2
parameter_list|,
name|int
modifier|*
name|mlabs
parameter_list|)
block|{
comment|/* like dname_lab_cmp, but with different label comparison, 	 * empty character sorts before \000. 	 * So   ylyly is before z. */
name|uint8_t
name|len1
decl_stmt|,
name|len2
decl_stmt|;
name|int
name|atlabel
init|=
name|labs1
decl_stmt|;
name|int
name|lastmlabs
decl_stmt|;
name|int
name|lastdiff
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|;
comment|/* first skip so that we compare same label. */
if|if
condition|(
name|labs1
operator|>
name|labs2
condition|)
block|{
while|while
condition|(
name|atlabel
operator|>
name|labs2
condition|)
block|{
name|len1
operator|=
operator|*
name|d1
operator|++
expr_stmt|;
name|d1
operator|+=
name|len1
expr_stmt|;
name|atlabel
operator|--
expr_stmt|;
block|}
name|log_assert
argument_list|(
name|atlabel
operator|==
name|labs2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|labs1
operator|<
name|labs2
condition|)
block|{
name|atlabel
operator|=
name|labs2
expr_stmt|;
while|while
condition|(
name|atlabel
operator|>
name|labs1
condition|)
block|{
name|len2
operator|=
operator|*
name|d2
operator|++
expr_stmt|;
name|d2
operator|+=
name|len2
expr_stmt|;
name|atlabel
operator|--
expr_stmt|;
block|}
name|log_assert
argument_list|(
name|atlabel
operator|==
name|labs1
argument_list|)
expr_stmt|;
block|}
name|lastmlabs
operator|=
name|atlabel
operator|+
literal|1
expr_stmt|;
comment|/* now at same label in d1 and d2, atlabel */
comment|/* www.example.com.                  */
comment|/* 4   3       2  1   atlabel number */
comment|/* repeat until at root label (which is always the same) */
while|while
condition|(
name|atlabel
operator|>
literal|1
condition|)
block|{
name|len1
operator|=
operator|*
name|d1
operator|++
expr_stmt|;
name|len2
operator|=
operator|*
name|d2
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|memcanoncmp
argument_list|(
name|d1
argument_list|,
name|len1
argument_list|,
name|d2
argument_list|,
name|len2
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|<
literal|0
condition|)
name|lastdiff
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|lastdiff
operator|=
literal|1
expr_stmt|;
name|lastmlabs
operator|=
name|atlabel
expr_stmt|;
block|}
name|d1
operator|+=
name|len1
expr_stmt|;
name|d2
operator|+=
name|len2
expr_stmt|;
name|atlabel
operator|--
expr_stmt|;
block|}
comment|/* last difference atlabel number, so number of labels matching, 	 * at the right side, is one less. */
operator|*
name|mlabs
operator|=
name|lastmlabs
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|lastdiff
operator|==
literal|0
condition|)
block|{
comment|/* all labels compared were equal, check if one has more 		 * labels, so that example.com.> com. */
if|if
condition|(
name|labs1
operator|>
name|labs2
condition|)
return|return
literal|1
return|;
elseif|else
if|if
condition|(
name|labs1
operator|<
name|labs2
condition|)
return|return
operator|-
literal|1
return|;
block|}
return|return
name|lastdiff
return|;
block|}
end_function

begin_function
name|int
name|dname_canonical_compare
parameter_list|(
name|uint8_t
modifier|*
name|d1
parameter_list|,
name|uint8_t
modifier|*
name|d2
parameter_list|)
block|{
name|int
name|labs1
decl_stmt|,
name|labs2
decl_stmt|,
name|m
decl_stmt|;
name|labs1
operator|=
name|dname_count_labels
argument_list|(
name|d1
argument_list|)
expr_stmt|;
name|labs2
operator|=
name|dname_count_labels
argument_list|(
name|d2
argument_list|)
expr_stmt|;
return|return
name|dname_canon_lab_cmp
argument_list|(
name|d1
argument_list|,
name|labs1
argument_list|,
name|d2
argument_list|,
name|labs2
argument_list|,
operator|&
name|m
argument_list|)
return|;
block|}
end_function

begin_function
name|uint8_t
modifier|*
name|dname_get_shared_topdomain
parameter_list|(
name|uint8_t
modifier|*
name|d1
parameter_list|,
name|uint8_t
modifier|*
name|d2
parameter_list|)
block|{
name|int
name|labs1
decl_stmt|,
name|labs2
decl_stmt|,
name|m
decl_stmt|;
name|size_t
name|len
init|=
name|LDNS_MAX_DOMAINLEN
decl_stmt|;
name|labs1
operator|=
name|dname_count_labels
argument_list|(
name|d1
argument_list|)
expr_stmt|;
name|labs2
operator|=
name|dname_count_labels
argument_list|(
name|d2
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|dname_lab_cmp
argument_list|(
name|d1
argument_list|,
name|labs1
argument_list|,
name|d2
argument_list|,
name|labs2
argument_list|,
operator|&
name|m
argument_list|)
expr_stmt|;
name|dname_remove_labels
argument_list|(
operator|&
name|d1
argument_list|,
operator|&
name|len
argument_list|,
name|labs1
operator|-
name|m
argument_list|)
expr_stmt|;
return|return
name|d1
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*$Header: /p/tcsh/cvsroot/tcsh/win32/console.c,v 1.9 2006/08/27 01:13:28 amold Exp $*/
end_comment

begin_comment
comment|/*-  * Copyright (c) 1980, 1991 The Regents of the University of California.  * All rights reserved.  *  * Redistribution and use in source and binary forms, with or without  * modification, are permitted provided that the following conditions  * are met:  * 1. Redistributions of source code must retain the above copyright  *    notice, this list of conditions and the following disclaimer.  * 2. Redistributions in binary form must reproduce the above copyright  *    notice, this list of conditions and the following disclaimer in the  *    documentation and/or other materials provided with the distribution.  * 3. Neither the name of the University nor the names of its contributors  *    may be used to endorse or promote products derived from this software  *    without specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND  * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE  * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE  * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL  * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS  * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)  * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT  * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY  * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF  * SUCH DAMAGE.  */
end_comment

begin_comment
comment|/*  * console.c: hacks to do various cursor movement/attribute things  * -amol  */
end_comment

begin_define
define|#
directive|define
name|WIN32_LEAN_AND_MEAN
end_define

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_include
include|#
directive|include
file|<wincon.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"ntport.h"
end_include

begin_comment
comment|// int to SHORT. caused by all the stupid functions that take WORDs
end_comment

begin_pragma
pragma|#
directive|pragma
name|warning
name|(
name|disable
name|:
name|4244
name|)
end_pragma

begin_function_decl
name|void
name|ScrollBuf
parameter_list|(
name|HANDLE
parameter_list|,
name|CONSOLE_SCREEN_BUFFER_INFO
modifier|*
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|void
name|NT_MoveToLineOrChar
parameter_list|(
name|int
parameter_list|,
name|int
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|WORD
name|get_attributes
parameter_list|()
function_decl|;
end_function_decl

begin_define
define|#
directive|define
name|FSHIN
value|16
end_define

begin_comment
comment|/* Preferred desc for shell input */
end_comment

begin_define
define|#
directive|define
name|FSHOUT
value|17
end_define

begin_comment
comment|/* Preferred desc for shell input */
end_comment

begin_define
define|#
directive|define
name|FOREGROUND_BLACK
value|(FOREGROUND_RED |FOREGROUND_GREEN | FOREGROUND_BLUE)
end_define

begin_define
define|#
directive|define
name|FOREGROUND_WHITE
value|0
end_define

begin_define
define|#
directive|define
name|BACKGROUND_BLACK
value|(BACKGROUND_RED |BACKGROUND_GREEN | BACKGROUND_BLUE)
end_define

begin_define
define|#
directive|define
name|BACKGROUND_WHITE
value|0
end_define

begin_decl_stmt
specifier|static
name|WORD
name|wNormalAttributes
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|nt_is_raw
decl_stmt|;
end_decl_stmt

begin_comment
comment|//
end_comment

begin_comment
comment|// The following are used to optimize some console routines. It avoids having
end_comment

begin_comment
comment|// to call GetConsoleScreenBufferInfo.
end_comment

begin_comment
comment|// Seems to have helped the speed a bit. -amol
end_comment

begin_comment
comment|//
end_comment

begin_decl_stmt
name|HANDLE
name|ghstdout
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|HANDLE
name|ghReverse
decl_stmt|;
end_decl_stmt

begin_comment
comment|//
end_comment

begin_comment
comment|// This function is called to set the values for above variables.
end_comment

begin_comment
comment|//
end_comment

begin_function
name|void
name|redo_console
parameter_list|(
name|void
parameter_list|)
block|{
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
name|HANDLE
name|hTemp
init|=
name|GetStdHandle
argument_list|(
name|STD_OUTPUT_HANDLE
argument_list|)
decl_stmt|;
name|WORD
name|dbga
decl_stmt|;
name|DWORD
name|wrote
decl_stmt|;
name|COORD
name|origin
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
if|if
condition|(
operator|!
name|DuplicateHandle
argument_list|(
name|GetCurrentProcess
argument_list|()
argument_list|,
name|hTemp
argument_list|,
name|GetCurrentProcess
argument_list|()
argument_list|,
operator|&
name|ghstdout
argument_list|,
literal|0
argument_list|,
name|TRUE
argument_list|,
name|DUPLICATE_SAME_ACCESS
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|ghstdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
name|wNormalAttributes
operator|=
name|FOREGROUND_BLACK
operator||
name|BACKGROUND_WHITE
expr_stmt|;
block|}
else|else
name|wNormalAttributes
operator|=
name|scrbuf
operator|.
name|wAttributes
expr_stmt|;
name|ghReverse
operator|=
name|CreateConsoleScreenBuffer
argument_list|(
name|GENERIC_READ
operator||
name|GENERIC_WRITE
argument_list|,
name|FILE_SHARE_READ
operator||
name|FILE_SHARE_WRITE
argument_list|,
name|NULL
argument_list|,
name|CONSOLE_TEXTMODE_BUFFER
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|dbga
operator|=
operator|(
operator|(
name|wNormalAttributes
operator|&
literal|0x00f0
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|wNormalAttributes
operator|&
literal|0x000f
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|FillConsoleOutputAttribute
argument_list|(
name|ghReverse
argument_list|,
name|dbga
argument_list|,
name|scrbuf
operator|.
name|dwSize
operator|.
name|X
operator|*
name|scrbuf
operator|.
name|dwSize
operator|.
name|Y
argument_list|,
name|origin
argument_list|,
operator|&
name|wrote
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nt_term_cleanup
parameter_list|(
name|void
parameter_list|)
block|{
name|CloseHandle
argument_list|(
name|ghstdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|nt_term_init
parameter_list|()
block|{
name|DWORD
name|dwmode
decl_stmt|;
name|HANDLE
name|hinput
init|=
name|GetStdHandle
argument_list|(
name|STD_INPUT_HANDLE
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|GetConsoleMode
argument_list|(
name|hinput
argument_list|,
operator|&
name|dwmode
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|SetConsoleMode
argument_list|(
name|hinput
argument_list|,
name|dwmode
operator||
name|ENABLE_WINDOW_INPUT
argument_list|)
condition|)
block|{
return|return;
block|}
name|redo_console
argument_list|()
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|int
name|do_nt_check_cooked_mode
parameter_list|(
name|void
parameter_list|)
block|{
return|return
operator|!
name|nt_is_raw
return|;
block|}
end_function

begin_function
name|void
name|do_nt_raw_mode
parameter_list|()
block|{
name|DWORD
name|dwmode
decl_stmt|;
name|HANDLE
name|hinput
init|=
operator|(
name|HANDLE
operator|)
name|_get_osfhandle
argument_list|(
name|FSHIN
argument_list|)
decl_stmt|;
if|if
condition|(
name|hinput
operator|==
name|INVALID_HANDLE_VALUE
condition|)
return|return;
if|if
condition|(
operator|!
name|GetConsoleMode
argument_list|(
name|hinput
argument_list|,
operator|&
name|dwmode
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|SetConsoleMode
argument_list|(
name|hinput
argument_list|,
name|dwmode
operator|&
operator|(
operator|~
operator|(
name|ENABLE_LINE_INPUT
operator||
name|ENABLE_ECHO_INPUT
operator||
name|ENABLE_PROCESSED_INPUT
operator|)
operator||
name|ENABLE_WINDOW_INPUT
operator|)
argument_list|)
condition|)
block|{
return|return;
block|}
name|nt_is_raw
operator|=
literal|1
expr_stmt|;
return|return;
block|}
end_function

begin_function
name|void
name|do_nt_cooked_mode
parameter_list|()
block|{
name|DWORD
name|dwmode
decl_stmt|;
name|HANDLE
name|hinput
init|=
operator|(
name|HANDLE
operator|)
name|_get_osfhandle
argument_list|(
name|FSHIN
argument_list|)
decl_stmt|;
if|if
condition|(
name|hinput
operator|==
name|INVALID_HANDLE_VALUE
condition|)
return|return;
if|if
condition|(
operator|!
name|GetConsoleMode
argument_list|(
name|hinput
argument_list|,
operator|&
name|dwmode
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|SetConsoleMode
argument_list|(
name|hinput
argument_list|,
name|dwmode
operator||
operator|(
operator|(
name|ENABLE_LINE_INPUT
operator||
name|ENABLE_ECHO_INPUT
operator||
name|ENABLE_PROCESSED_INPUT
operator|)
operator|)
argument_list|)
condition|)
block|{ 	}
name|nt_is_raw
operator|=
literal|0
expr_stmt|;
return|return;
block|}
end_function

begin_comment
comment|//
end_comment

begin_comment
comment|// this function is a bit ugly, but I don't know how to do it better
end_comment

begin_comment
comment|// -amol
end_comment

begin_comment
comment|//
end_comment

begin_function
name|int
name|nt_ClearEOL
parameter_list|(
name|void
parameter_list|)
block|{
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
name|HANDLE
name|hStdout
init|=
name|ghstdout
decl_stmt|;
name|DWORD
name|numwrote
decl_stmt|;
name|char
name|errbuf
index|[
literal|128
index|]
decl_stmt|;
comment|/*FIXME: uninitialized*/
name|int
name|num
init|=
literal|0
decl_stmt|;
name|COORD
name|savepos
decl_stmt|;
if|if
condition|(
name|hStdout
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
name|ExitProcess
argument_list|(
literal|0xFFFF
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|hStdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
return|return
literal|0
return|;
block|}
name|num
operator|=
literal|2048
expr_stmt|;
name|savepos
operator|=
name|scrbuf
operator|.
name|dwCursorPosition
expr_stmt|;
if|if
condition|(
operator|!
name|FillConsoleOutputCharacter
argument_list|(
name|hStdout
argument_list|,
literal|' '
argument_list|,
name|num
argument_list|,
name|scrbuf
operator|.
name|dwCursorPosition
argument_list|,
operator|&
name|numwrote
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"error from FillCons %s"
argument_list|,
name|errbuf
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|FillConsoleOutputAttribute
argument_list|(
name|hStdout
argument_list|,
name|scrbuf
operator|.
name|wAttributes
argument_list|,
name|num
argument_list|,
name|scrbuf
operator|.
name|dwCursorPosition
argument_list|,
operator|&
name|numwrote
argument_list|)
condition|)
block|{
name|dprintf
argument_list|(
literal|"error from FillConsAttr %s"
argument_list|,
name|errbuf
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|nt_move_next_tab
parameter_list|(
name|void
parameter_list|)
block|{
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
name|HANDLE
name|hStdout
init|=
name|ghstdout
decl_stmt|;
name|int
name|where
decl_stmt|;
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|hStdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
name|where
operator|=
literal|8
operator|-
operator|(
name|scrbuf
operator|.
name|dwCursorPosition
operator|.
name|X
operator|+
literal|1
operator|)
operator|%
literal|8
expr_stmt|;
name|scrbuf
operator|.
name|dwCursorPosition
operator|.
name|X
operator|+=
name|where
expr_stmt|;
if|if
condition|(
operator|!
name|SetConsoleCursorPosition
argument_list|(
name|hStdout
argument_list|,
name|scrbuf
operator|.
name|dwCursorPosition
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|NT_VisibleBell
parameter_list|(
name|void
parameter_list|)
block|{
if|if
condition|(
name|ghReverse
operator|!=
name|INVALID_HANDLE_VALUE
condition|)
block|{
name|SetConsoleActiveScreenBuffer
argument_list|(
name|ghReverse
argument_list|)
expr_stmt|;
name|Sleep
argument_list|(
literal|100
argument_list|)
expr_stmt|;
name|SetConsoleActiveScreenBuffer
argument_list|(
name|ghstdout
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|NT_WrapHorizontal
parameter_list|(
name|void
parameter_list|)
block|{
name|SMALL_RECT
name|wnd
decl_stmt|;
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
if|if
condition|(
name|ghstdout
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
return|return;
block|}
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|ghstdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
return|return;
block|}
comment|//absolute movement
name|wnd
operator|.
name|Left
operator|=
literal|0
expr_stmt|;
comment|//scrbuf.srWindow.Left ;
name|wnd
operator|.
name|Right
operator|=
name|scrbuf
operator|.
name|srWindow
operator|.
name|Right
operator|-
name|scrbuf
operator|.
name|srWindow
operator|.
name|Left
operator|+
literal|1
expr_stmt|;
name|wnd
operator|.
name|Top
operator|=
name|scrbuf
operator|.
name|srWindow
operator|.
name|Top
expr_stmt|;
name|wnd
operator|.
name|Bottom
operator|=
name|scrbuf
operator|.
name|srWindow
operator|.
name|Bottom
expr_stmt|;
name|SetConsoleWindowInfo
argument_list|(
name|ghstdout
argument_list|,
name|TRUE
argument_list|,
operator|&
name|wnd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ScrollBufHorizontal
parameter_list|(
name|HANDLE
name|hOut
parameter_list|,
name|CONSOLE_SCREEN_BUFFER_INFO
modifier|*
name|scrbuf
parameter_list|,
name|int
name|where
parameter_list|)
block|{
name|SMALL_RECT
name|wnd
decl_stmt|;
name|int
name|diff
decl_stmt|;
name|CHAR_INFO
name|chr
decl_stmt|;
comment|//absolute movement
name|wnd
operator|.
name|Left
operator|=
operator|(
name|where
operator|-
name|scrbuf
operator|->
name|srWindow
operator|.
name|Right
operator|)
operator|+
name|scrbuf
operator|->
name|srWindow
operator|.
name|Left
expr_stmt|;
name|wnd
operator|.
name|Right
operator|=
name|where
expr_stmt|;
name|wnd
operator|.
name|Top
operator|=
name|scrbuf
operator|->
name|srWindow
operator|.
name|Top
expr_stmt|;
name|wnd
operator|.
name|Bottom
operator|=
name|scrbuf
operator|->
name|srWindow
operator|.
name|Bottom
expr_stmt|;
comment|//diff = scrbuf->srWindow.Right - where;
comment|//dprintf("\tdiff1 %d\n",diff);
name|diff
operator|=
name|scrbuf
operator|->
name|dwSize
operator|.
name|X
operator|-
name|where
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|diff
operator|<
literal|0
condition|)
block|{
comment|//would scroll past console buffer
name|chr
operator|.
name|Char
operator|.
name|AsciiChar
operator|=
literal|' '
expr_stmt|;
name|chr
operator|.
name|Attributes
operator|=
name|scrbuf
operator|->
name|wAttributes
expr_stmt|;
name|scrbuf
operator|->
name|dwCursorPosition
operator|.
name|Y
operator|=
name|scrbuf
operator|->
name|srWindow
operator|.
name|Top
expr_stmt|;
name|scrbuf
operator|->
name|dwCursorPosition
operator|.
name|X
operator|=
name|scrbuf
operator|->
name|srWindow
operator|.
name|Right
operator|+
name|diff
expr_stmt|;
name|dprintf
argument_list|(
literal|"scroll diff %d\n"
argument_list|,
name|diff
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ScrollConsoleScreenBuffer
argument_list|(
name|hOut
argument_list|,
operator|&
operator|(
name|scrbuf
operator|->
name|srWindow
operator|)
argument_list|,
name|NULL
argument_list|,
name|scrbuf
operator|->
name|dwCursorPosition
argument_list|,
operator|&
name|chr
argument_list|)
condition|)
empty_stmt|;
return|return;
block|}
name|SetConsoleWindowInfo
argument_list|(
name|hOut
argument_list|,
name|TRUE
argument_list|,
operator|&
name|wnd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|// relative movement of "where".  line is 1 if we want to move to a line,
end_comment

begin_comment
comment|// or 0 if the movement is horizontal
end_comment

begin_function
name|void
name|NT_MoveToLineOrChar
parameter_list|(
name|int
name|where
parameter_list|,
name|int
name|line
parameter_list|)
block|{
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
name|HANDLE
name|hStdout
init|=
name|ghstdout
decl_stmt|;
if|if
condition|(
name|hStdout
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
return|return;
block|}
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|hStdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|line
condition|)
block|{
if|if
condition|(
operator|(
operator|(
name|scrbuf
operator|.
name|dwCursorPosition
operator|.
name|Y
operator|+
name|where
operator|)
operator|>
operator|(
name|scrbuf
operator|.
name|srWindow
operator|.
name|Bottom
operator|-
literal|1
operator|)
operator|)
operator|&&
operator|(
name|where
operator|>
literal|0
operator|)
condition|)
block|{
name|ScrollBuf
argument_list|(
name|hStdout
argument_list|,
operator|&
name|scrbuf
argument_list|,
name|where
argument_list|)
expr_stmt|;
name|scrbuf
operator|.
name|dwCursorPosition
operator|.
name|Y
operator|+=
name|where
expr_stmt|;
block|}
else|else
name|scrbuf
operator|.
name|dwCursorPosition
operator|.
name|Y
operator|+=
name|where
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|where
operator|>
operator|(
name|scrbuf
operator|.
name|srWindow
operator|.
name|Right
operator|)
operator|)
operator|&&
operator|(
name|where
operator|>
literal|0
operator|)
condition|)
block|{
name|ScrollBufHorizontal
argument_list|(
name|hStdout
argument_list|,
operator|&
name|scrbuf
argument_list|,
name|where
argument_list|)
expr_stmt|;
block|}
name|scrbuf
operator|.
name|dwCursorPosition
operator|.
name|X
operator|=
name|where
expr_stmt|;
block|}
if|if
condition|(
name|scrbuf
operator|.
name|dwCursorPosition
operator|.
name|X
operator|<
literal|0
operator|||
name|scrbuf
operator|.
name|dwCursorPosition
operator|.
name|Y
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
operator|!
name|SetConsoleCursorPosition
argument_list|(
name|hStdout
argument_list|,
name|scrbuf
operator|.
name|dwCursorPosition
argument_list|)
condition|)
block|{
return|return;
block|}
block|}
end_function

begin_function
name|void
name|ScrollBuf
parameter_list|(
name|HANDLE
name|hOut
parameter_list|,
name|CONSOLE_SCREEN_BUFFER_INFO
modifier|*
name|scrbuf
parameter_list|,
name|int
name|where
parameter_list|)
block|{
name|SMALL_RECT
name|wnd
decl_stmt|;
name|int
name|diff
decl_stmt|;
name|CHAR_INFO
name|chr
decl_stmt|;
name|COORD
name|newpos
decl_stmt|;
name|wnd
operator|.
name|Left
operator|=
literal|0
expr_stmt|;
name|wnd
operator|.
name|Right
operator|=
literal|0
expr_stmt|;
name|wnd
operator|.
name|Top
operator|=
name|where
expr_stmt|;
name|wnd
operator|.
name|Bottom
operator|=
name|where
expr_stmt|;
comment|//dwSize is not 0-based, so add 1 to proposed location
name|diff
operator|=
name|scrbuf
operator|->
name|srWindow
operator|.
name|Bottom
operator|+
name|where
operator|+
literal|1
expr_stmt|;
name|diff
operator|=
name|scrbuf
operator|->
name|dwSize
operator|.
name|Y
operator|-
name|diff
expr_stmt|;
if|if
condition|(
name|diff
operator|<
literal|0
condition|)
block|{
comment|//would scroll past console buffer
name|chr
operator|.
name|Char
operator|.
name|AsciiChar
operator|=
literal|' '
expr_stmt|;
name|chr
operator|.
name|Attributes
operator|=
name|scrbuf
operator|->
name|wAttributes
expr_stmt|;
name|newpos
operator|.
name|Y
operator|=
name|scrbuf
operator|->
name|srWindow
operator|.
name|Top
operator|+
name|diff
expr_stmt|;
name|newpos
operator|.
name|X
operator|=
name|scrbuf
operator|->
name|srWindow
operator|.
name|Left
expr_stmt|;
name|dprintf
argument_list|(
literal|"scroll diff %d\n"
argument_list|,
name|diff
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ScrollConsoleScreenBuffer
argument_list|(
name|hOut
argument_list|,
operator|&
operator|(
name|scrbuf
operator|->
name|srWindow
operator|)
argument_list|,
name|NULL
argument_list|,
name|newpos
argument_list|,
operator|&
name|chr
argument_list|)
condition|)
empty_stmt|;
comment|// need this to be in sync with tcsh
name|scrbuf
operator|->
name|dwCursorPosition
operator|.
name|Y
operator|+=
name|diff
expr_stmt|;
return|return;
block|}
name|SetConsoleWindowInfo
argument_list|(
name|hOut
argument_list|,
name|FALSE
argument_list|,
operator|&
name|wnd
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|BOOL
name|ConsolePageUpOrDown
parameter_list|(
name|BOOL
name|Up
parameter_list|)
block|{
name|HANDLE
name|hStdout
init|=
name|ghstdout
decl_stmt|;
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
name|SMALL_RECT
name|srect
decl_stmt|;
name|short
name|diff
decl_stmt|;
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|hStdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
return|return
name|FALSE
return|;
block|}
name|diff
operator|=
name|scrbuf
operator|.
name|srWindow
operator|.
name|Bottom
operator|-
name|scrbuf
operator|.
name|srWindow
operator|.
name|Top
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|Up
condition|)
name|diff
operator|=
operator|-
name|diff
expr_stmt|;
if|if
condition|(
operator|(
name|scrbuf
operator|.
name|srWindow
operator|.
name|Top
operator|+
name|diff
operator|>
literal|0
operator|)
operator|&&
operator|(
name|scrbuf
operator|.
name|srWindow
operator|.
name|Bottom
operator|+
name|diff
operator|<
name|scrbuf
operator|.
name|dwSize
operator|.
name|Y
operator|)
condition|)
block|{
name|srect
operator|.
name|Top
operator|=
name|diff
expr_stmt|;
name|srect
operator|.
name|Bottom
operator|=
name|diff
expr_stmt|;
name|srect
operator|.
name|Left
operator|=
literal|0
expr_stmt|;
name|srect
operator|.
name|Right
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|SetConsoleWindowInfo
argument_list|(
name|hStdout
argument_list|,
name|FALSE
argument_list|,
operator|&
name|srect
argument_list|)
condition|)
block|{
return|return
name|FALSE
return|;
block|}
block|}
return|return
name|TRUE
return|;
block|}
end_function

begin_function
name|int
name|nt_getsize
parameter_list|(
name|int
modifier|*
name|lins
parameter_list|,
name|int
modifier|*
name|cols
parameter_list|,
name|int
modifier|*
name|visiblecols
parameter_list|)
block|{
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
name|HANDLE
name|hStdout
init|=
name|ghstdout
decl_stmt|;
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|hStdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
operator|*
name|lins
operator|=
name|scrbuf
operator|.
name|srWindow
operator|.
name|Bottom
operator|-
name|scrbuf
operator|.
name|srWindow
operator|.
name|Top
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|visiblecols
condition|)
operator|*
name|visiblecols
operator|=
name|scrbuf
operator|.
name|srWindow
operator|.
name|Right
operator|-
name|scrbuf
operator|.
name|srWindow
operator|.
name|Left
operator|+
literal|1
expr_stmt|;
operator|*
name|cols
operator|=
name|scrbuf
operator|.
name|dwSize
operator|.
name|X
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|nt_set_size
parameter_list|(
name|int
name|lins
parameter_list|,
name|int
name|cols
parameter_list|)
block|{
name|SMALL_RECT
name|srect
decl_stmt|;
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
name|int
name|expand
decl_stmt|;
comment|/* The screen buffer visible window is specified as co-ordinates 	 * not size. Therefore, it must be zero-based 	 */
name|cols
operator|--
expr_stmt|;
name|lins
operator|--
expr_stmt|;
name|srect
operator|.
name|Left
operator|=
name|srect
operator|.
name|Top
operator|=
literal|0
expr_stmt|;
name|srect
operator|.
name|Right
operator|=
name|cols
expr_stmt|;
name|srect
operator|.
name|Bottom
operator|=
name|lins
expr_stmt|;
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|ghstdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
return|return;
name|expand
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|scrbuf
operator|.
name|dwSize
operator|.
name|X
operator|<
name|cols
condition|)
block|{
name|expand
operator|=
literal|1
expr_stmt|;
name|scrbuf
operator|.
name|dwSize
operator|.
name|X
operator|=
name|cols
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|scrbuf
operator|.
name|dwSize
operator|.
name|Y
operator|<
name|lins
condition|)
block|{
name|expand
operator|=
literal|1
expr_stmt|;
name|scrbuf
operator|.
name|dwSize
operator|.
name|Y
operator|=
name|lins
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|expand
operator|&&
operator|!
name|SetConsoleScreenBufferSize
argument_list|(
name|ghstdout
argument_list|,
name|scrbuf
operator|.
name|dwSize
argument_list|)
condition|)
return|return;
if|if
condition|(
operator|!
name|SetConsoleWindowInfo
argument_list|(
name|ghstdout
argument_list|,
name|TRUE
argument_list|,
operator|&
name|srect
argument_list|)
condition|)
block|{
name|int
name|err
decl_stmt|;
name|err
operator|=
name|GetLastError
argument_list|()
expr_stmt|;
name|dprintf
argument_list|(
literal|"error %d\n"
argument_list|,
name|err
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|NT_ClearEOD
parameter_list|(
name|void
parameter_list|)
block|{
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
name|DWORD
name|numwrote
decl_stmt|;
name|COORD
name|origin
decl_stmt|;
name|int
name|ht
decl_stmt|,
name|wt
decl_stmt|;
name|HANDLE
name|hStdout
init|=
name|ghstdout
decl_stmt|;
comment|//GetStdHandle(STD_OUTPUT_HANDLE);
if|if
condition|(
name|hStdout
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
return|return ;
block|}
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|hStdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
return|return ;
block|}
name|origin
operator|=
name|scrbuf
operator|.
name|dwCursorPosition
expr_stmt|;
name|ht
operator|=
name|scrbuf
operator|.
name|dwSize
operator|.
name|Y
operator|-
name|origin
operator|.
name|Y
expr_stmt|;
name|wt
operator|=
name|scrbuf
operator|.
name|dwSize
operator|.
name|X
operator|-
name|origin
operator|.
name|X
expr_stmt|;
if|if
condition|(
operator|!
name|FillConsoleOutputCharacter
argument_list|(
name|hStdout
argument_list|,
literal|' '
argument_list|,
name|ht
operator|*
name|wt
argument_list|,
name|origin
argument_list|,
operator|&
name|numwrote
argument_list|)
condition|)
block|{
return|return ;
block|}
if|if
condition|(
operator|!
name|FillConsoleOutputAttribute
argument_list|(
name|hStdout
argument_list|,
name|scrbuf
operator|.
name|wAttributes
argument_list|,
name|ht
operator|*
name|wt
argument_list|,
name|scrbuf
operator|.
name|dwCursorPosition
argument_list|,
operator|&
name|numwrote
argument_list|)
condition|)
block|{
return|return;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|NT_ClearScreen
parameter_list|(
name|void
parameter_list|)
block|{
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
name|DWORD
name|numwrote
decl_stmt|;
name|COORD
name|origin
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|HANDLE
name|hStdout
init|=
name|ghstdout
decl_stmt|;
comment|//GetStdHandle(STD_OUTPUT_HANDLE);
if|if
condition|(
name|hStdout
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|hStdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
name|origin
operator|.
name|X
operator|=
name|scrbuf
operator|.
name|srWindow
operator|.
name|Left
expr_stmt|;
name|origin
operator|.
name|Y
operator|=
name|scrbuf
operator|.
name|srWindow
operator|.
name|Top
expr_stmt|;
if|if
condition|(
operator|!
name|FillConsoleOutputCharacter
argument_list|(
name|hStdout
argument_list|,
literal|' '
argument_list|,
name|scrbuf
operator|.
name|dwSize
operator|.
name|X
operator|*
name|scrbuf
operator|.
name|dwSize
operator|.
name|Y
argument_list|,
name|origin
argument_list|,
operator|&
name|numwrote
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|FillConsoleOutputAttribute
argument_list|(
name|hStdout
argument_list|,
name|scrbuf
operator|.
name|wAttributes
argument_list|,
name|scrbuf
operator|.
name|dwSize
operator|.
name|X
operator|*
name|scrbuf
operator|.
name|dwSize
operator|.
name|Y
argument_list|,
name|origin
argument_list|,
operator|&
name|numwrote
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|SetConsoleCursorPosition
argument_list|(
name|hStdout
argument_list|,
name|origin
argument_list|)
condition|)
block|{
comment|// home cursor
empty_stmt|;
block|}
return|return;
block|}
end_function

begin_function
name|void
name|NT_ClearScreen_WholeBuffer
parameter_list|(
name|void
parameter_list|)
block|{
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
name|DWORD
name|numwrote
decl_stmt|;
name|COORD
name|origin
init|=
block|{
literal|0
block|,
literal|0
block|}
decl_stmt|;
name|HANDLE
name|hStdout
init|=
name|ghstdout
decl_stmt|;
if|if
condition|(
name|hStdout
operator|==
name|INVALID_HANDLE_VALUE
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|hStdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|FillConsoleOutputCharacter
argument_list|(
name|hStdout
argument_list|,
literal|' '
argument_list|,
name|scrbuf
operator|.
name|dwSize
operator|.
name|X
operator|*
name|scrbuf
operator|.
name|dwSize
operator|.
name|Y
argument_list|,
name|origin
argument_list|,
operator|&
name|numwrote
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|FillConsoleOutputAttribute
argument_list|(
name|hStdout
argument_list|,
name|scrbuf
operator|.
name|wAttributes
argument_list|,
name|scrbuf
operator|.
name|dwSize
operator|.
name|X
operator|*
name|scrbuf
operator|.
name|dwSize
operator|.
name|Y
argument_list|,
name|origin
argument_list|,
operator|&
name|numwrote
argument_list|)
condition|)
block|{
empty_stmt|;
block|}
if|if
condition|(
operator|!
name|SetConsoleCursorPosition
argument_list|(
name|hStdout
argument_list|,
name|origin
argument_list|)
condition|)
block|{
comment|// home cursor
empty_stmt|;
block|}
return|return;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|COLOR_LS_F
end_ifndef

begin_function
name|void
name|set_cons_attr
parameter_list|(
name|char
modifier|*
name|attr2
parameter_list|)
block|{
name|char
name|cp
index|[
literal|3
index|]
decl_stmt|;
name|USHORT
name|attr
decl_stmt|;
name|HANDLE
name|outhandle
init|=
operator|(
name|HANDLE
operator|)
name|_get_osfhandle
argument_list|(
name|FSHOUT
argument_list|)
decl_stmt|;
specifier|static
name|WORD
name|old_attribs
decl_stmt|;
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
if|if
condition|(
operator|!
name|old_attribs
condition|)
block|{
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|outhandle
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
block|{
return|return;
block|}
name|old_attribs
operator|=
name|scrbuf
operator|.
name|wAttributes
expr_stmt|;
block|}
name|cp
index|[
literal|0
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|attr2
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|cp
index|[
literal|1
index|]
operator|=
call|(
name|unsigned
name|char
call|)
argument_list|(
name|attr2
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|cp
index|[
literal|2
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cp
index|[
literal|0
index|]
operator|!=
literal|'g'
operator|||
name|cp
index|[
literal|1
index|]
operator|!=
literal|'g'
condition|)
name|attr
operator|=
operator|(
name|USHORT
operator|)
name|strtol
argument_list|(
name|cp
argument_list|,
name|NULL
argument_list|,
literal|16
argument_list|)
expr_stmt|;
else|else
block|{
name|attr
operator|=
name|old_attribs
expr_stmt|;
name|old_attribs
operator|=
literal|0
expr_stmt|;
block|}
name|SetConsoleTextAttribute
argument_list|(
name|outhandle
argument_list|,
name|attr
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !COLOR_LS_F */
end_comment

begin_comment
comment|/*    color escape sequences (ISO 6429, aixterm)    - nayuta  */
end_comment

begin_function
name|WORD
name|get_attributes
parameter_list|()
block|{
name|CONSOLE_SCREEN_BUFFER_INFO
name|scrbuf
decl_stmt|;
if|if
condition|(
operator|!
name|GetConsoleScreenBufferInfo
argument_list|(
name|ghstdout
argument_list|,
operator|&
name|scrbuf
argument_list|)
condition|)
return|return
literal|0x70
return|;
comment|// ERROR: return white background, black text
return|return
name|scrbuf
operator|.
name|wAttributes
return|;
block|}
end_function

begin_ifndef
ifndef|#
directive|ifndef
name|COMMON_LVB_REVERSE_VIDEO
end_ifndef

begin_define
define|#
directive|define
name|COMMON_LVB_REVERSE_VIDEO
value|0x4000
end_define

begin_define
define|#
directive|define
name|COMMON_LVB_UNDERSCORE
value|0x8000
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|set_attributes
parameter_list|(
specifier|const
name|unsigned
name|char
modifier|*
name|color
parameter_list|)
block|{
specifier|static
specifier|const
name|int
name|colors
index|[
literal|8
index|]
init|=
block|{
literal|0
block|,
literal|4
block|,
literal|2
block|,
literal|6
block|,
literal|1
block|,
literal|5
block|,
literal|3
block|,
literal|7
block|}
decl_stmt|;
name|WORD
name|wAttributes
decl_stmt|;
specifier|const
name|char
modifier|*
name|t
decl_stmt|;
if|if
condition|(
name|color
index|[
literal|0
index|]
operator|==
literal|'\x1b'
operator|&&
name|color
index|[
literal|1
index|]
operator|==
literal|'['
condition|)
name|color
operator|+=
literal|2
expr_stmt|;
if|if
condition|(
operator|!
operator|(
literal|'0'
operator|<=
name|color
index|[
literal|0
index|]
operator|&&
name|color
index|[
literal|0
index|]
operator|<=
literal|'9'
operator|)
condition|)
block|{
name|SetConsoleTextAttribute
argument_list|(
name|ghstdout
argument_list|,
name|wNormalAttributes
argument_list|)
expr_stmt|;
return|return;
block|}
name|wAttributes
operator|=
name|get_attributes
argument_list|()
expr_stmt|;
name|t
operator|=
operator|(
name|char
operator|*
operator|)
name|color
expr_stmt|;
while|while
condition|(
name|t
condition|)
block|{
name|int
name|n
init|=
name|atoi
argument_list|(
name|t
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|t
operator|=
name|strchr
argument_list|(
name|t
argument_list|,
literal|';'
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
name|t
operator|++
expr_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
comment|// Normal (default)
name|wAttributes
operator|=
name|wNormalAttributes
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|==
literal|1
condition|)
comment|// Bold
name|wAttributes
operator||=
name|FOREGROUND_INTENSITY
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|==
literal|4
condition|)
comment|// Underlined
name|wAttributes
operator||=
name|COMMON_LVB_UNDERSCORE
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|==
literal|5
condition|)
comment|// Blink (appears as BACKGROUND_INTENSITY)
name|wAttributes
operator||=
name|BACKGROUND_INTENSITY
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|==
literal|7
condition|)
comment|// Inverse
name|wAttributes
operator||=
name|COMMON_LVB_REVERSE_VIDEO
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|==
literal|21
condition|)
comment|// Not bold
name|wAttributes
operator|&=
operator|~
name|FOREGROUND_INTENSITY
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|==
literal|24
condition|)
comment|// Not underlined
name|wAttributes
operator|&=
operator|~
name|COMMON_LVB_UNDERSCORE
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|==
literal|25
condition|)
comment|// Steady (not blinking)
name|wAttributes
operator|&=
operator|~
name|BACKGROUND_INTENSITY
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|==
literal|27
condition|)
comment|// Positive (not inverse)
name|wAttributes
operator|&=
operator|~
name|COMMON_LVB_REVERSE_VIDEO
expr_stmt|;
elseif|else
if|if
condition|(
literal|30
operator|<=
name|n
operator|&&
name|n
operator|<=
literal|37
condition|)
comment|// Set foreground color
name|wAttributes
operator|=
operator|(
name|wAttributes
operator|&
operator|~
literal|0x0007
operator|)
operator||
name|colors
index|[
name|n
operator|-
literal|30
index|]
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|==
literal|39
condition|)
comment|// Set foreground color to default
name|wAttributes
operator|=
operator|(
name|wAttributes
operator|&
operator|~
literal|0x0007
operator|)
operator||
operator|(
name|wNormalAttributes
operator|&
literal|0x0007
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
literal|40
operator|<=
name|n
operator|&&
name|n
operator|<=
literal|47
condition|)
comment|// Set background color
name|wAttributes
operator|=
operator|(
name|wAttributes
operator|&
operator|~
literal|0x0070
operator|)
operator||
operator|(
name|colors
index|[
name|n
operator|-
literal|40
index|]
operator|<<
literal|4
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
name|n
operator|==
literal|49
condition|)
comment|// Set background color to default
name|wAttributes
operator|=
operator|(
name|wAttributes
operator|&
operator|~
literal|0x0070
operator|)
operator||
operator|(
name|wNormalAttributes
operator|&
literal|0x0070
operator|)
expr_stmt|;
elseif|else
if|if
condition|(
literal|90
operator|<=
name|n
operator|&&
name|n
operator|<=
literal|97
condition|)
comment|// Set foreground color (bright)
name|wAttributes
operator|=
operator|(
name|wAttributes
operator|&
operator|~
literal|0x0007
operator|)
operator||
name|colors
index|[
name|n
operator|-
literal|90
index|]
operator||
name|FOREGROUND_INTENSITY
expr_stmt|;
elseif|else
if|if
condition|(
literal|100
operator|<=
name|n
operator|&&
name|n
operator|<=
literal|107
condition|)
comment|// Set background color (bright)
name|wAttributes
operator|=
operator|(
name|wAttributes
operator|&
operator|~
literal|0x0070
operator|)
operator||
operator|(
name|colors
index|[
name|n
operator|-
literal|100
index|]
operator|<<
literal|4
operator|)
operator||
name|BACKGROUND_INTENSITY
expr_stmt|;
else|else
comment|// (default)
name|wAttributes
operator|=
name|wNormalAttributes
expr_stmt|;
block|}
comment|// Though Windows' console supports COMMON_LVB_REVERSE_VIDEO,
comment|// it seems to be buggy.  So we must simulate it.
if|if
condition|(
name|wAttributes
operator|&
name|COMMON_LVB_REVERSE_VIDEO
condition|)
name|wAttributes
operator|=
operator|(
name|wAttributes
operator|&
name|COMMON_LVB_UNDERSCORE
operator|)
operator||
operator|(
operator|(
name|wAttributes
operator|&
literal|0x00f0
operator|)
operator|>>
literal|4
operator|)
operator||
operator|(
operator|(
name|wAttributes
operator|&
literal|0x000f
operator|)
operator|<<
literal|4
operator|)
expr_stmt|;
name|SetConsoleTextAttribute
argument_list|(
name|ghstdout
argument_list|,
name|wAttributes
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|StartHighlight
parameter_list|(
name|void
parameter_list|)
block|{ }
end_function

begin_function
name|void
name|StopHighlight
parameter_list|(
name|void
parameter_list|)
block|{ }
end_function

end_unit


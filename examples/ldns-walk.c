begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ldns-walk uses educated guesses and NSEC data to retrieve the  * contents of a dnssec signed zone  *  * (c) NLnet Labs, 2005 - 2008  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_decl_stmt
name|int
name|verbosity
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|usage
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|char
modifier|*
name|prog
parameter_list|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s [options] domain\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  print out the owner names for domain and the record types for those names\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"OPTIONS:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"-4\t\tonly use IPv4\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"-6\t\tonly use IPv6\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"-f\t\tfull; get all rrsets instead of only a list of names and types\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"-s<name>\t\tStart from this name\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"-v<verbosity>\t\tVerbosity level [1-5]\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"-version\tShow version and exit\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"@<nameserver>\t\tUse this nameserver\n"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|create_dname_plus_1
parameter_list|(
name|ldns_rdf
modifier|*
name|dname
parameter_list|)
block|{
name|uint8_t
modifier|*
name|wire
decl_stmt|;
name|ldns_rdf
modifier|*
name|newdname
decl_stmt|;
name|uint8_t
name|labellen
decl_stmt|;
name|size_t
name|pos
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|ldns_dname2canonical
argument_list|(
name|dname
argument_list|)
expr_stmt|;
name|labellen
operator|=
name|ldns_rdf_data
argument_list|(
name|dname
argument_list|)
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"Create +e for "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|dname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|labellen
operator|<
literal|63
condition|)
block|{
name|wire
operator|=
name|malloc
argument_list|(
name|ldns_rdf_size
argument_list|(
name|dname
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wire
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Malloc error: out of memory?\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|127
argument_list|)
expr_stmt|;
block|}
name|wire
index|[
literal|0
index|]
operator|=
name|labellen
operator|+
literal|1
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|wire
index|[
literal|1
index|]
argument_list|,
name|ldns_rdf_data
argument_list|(
name|dname
argument_list|)
operator|+
literal|1
argument_list|,
name|labellen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|wire
index|[
name|labellen
operator|+
literal|1
index|]
argument_list|,
name|ldns_rdf_data
argument_list|(
name|dname
argument_list|)
operator|+
name|labellen
argument_list|,
name|ldns_rdf_size
argument_list|(
name|dname
argument_list|)
operator|-
name|labellen
argument_list|)
expr_stmt|;
name|wire
index|[
name|labellen
operator|+
literal|1
index|]
operator|=
operator|(
name|uint8_t
operator|)
literal|'\000'
expr_stmt|;
name|pos
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|ldns_wire2dname
argument_list|(
operator|&
name|newdname
argument_list|,
name|wire
argument_list|,
name|ldns_rdf_size
argument_list|(
name|dname
argument_list|)
operator|+
literal|1
argument_list|,
operator|&
name|pos
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|wire
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|wire
operator|=
name|malloc
argument_list|(
name|ldns_rdf_size
argument_list|(
name|dname
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|wire
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Malloc error: out of memory?\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|127
argument_list|)
expr_stmt|;
block|}
name|wire
index|[
literal|0
index|]
operator|=
name|labellen
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|wire
index|[
literal|1
index|]
argument_list|,
name|ldns_rdf_data
argument_list|(
name|dname
argument_list|)
operator|+
literal|1
argument_list|,
name|labellen
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|wire
index|[
name|labellen
index|]
argument_list|,
name|ldns_rdf_data
argument_list|(
name|dname
argument_list|)
operator|+
name|labellen
argument_list|,
name|ldns_rdf_size
argument_list|(
name|dname
argument_list|)
operator|-
name|labellen
argument_list|)
expr_stmt|;
name|i
operator|=
name|labellen
expr_stmt|;
while|while
condition|(
name|wire
index|[
name|i
index|]
operator|==
literal|255
condition|)
block|{
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Error, don't know how to add 1 to a label with maximum length and all values on 255\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|9
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|i
operator|--
expr_stmt|;
block|}
block|}
name|wire
index|[
name|i
index|]
operator|=
name|wire
index|[
name|i
index|]
operator|+
literal|1
expr_stmt|;
name|pos
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|ldns_wire2dname
argument_list|(
operator|&
name|newdname
argument_list|,
name|wire
argument_list|,
name|ldns_rdf_size
argument_list|(
name|dname
argument_list|)
operator|+
literal|1
argument_list|,
operator|&
name|pos
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|wire
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"result: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|newdname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"Error: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|10
argument_list|)
expr_stmt|;
block|}
return|return
name|newdname
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|create_plus_1_dname
parameter_list|(
name|ldns_rdf
modifier|*
name|dname
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|label
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"Creating n+e for: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|dname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|ldns_dname2canonical
argument_list|(
name|dname
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_str2rdf_dname
argument_list|(
operator|&
name|label
argument_list|,
literal|"\\000"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"error creating \\000 dname: %s\n\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|ldns_dname_cat
argument_list|(
name|label
argument_list|,
name|dname
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"error catting \\000 dname: %s\n\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
return|return
name|label
return|;
block|}
end_function

begin_function
name|ldns_status
name|query_type_bitmaps
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|uint16_t
name|res_flags
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|name
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|rdf
parameter_list|)
block|{
comment|/* Note: this code is duplicated in higher.c in  	 * ldns_nsec_type_check() function 	 */
name|uint8_t
name|window_block_nr
decl_stmt|;
name|uint8_t
name|bitmap_length
decl_stmt|;
name|uint16_t
name|type
decl_stmt|;
name|uint16_t
name|pos
init|=
literal|0
decl_stmt|;
name|uint16_t
name|bit_pos
decl_stmt|;
name|uint8_t
modifier|*
name|data
init|=
name|ldns_rdf_data
argument_list|(
name|rdf
argument_list|)
decl_stmt|;
name|ldns_pkt
modifier|*
name|answer_pkt
decl_stmt|;
name|char
modifier|*
name|errstr
decl_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"Getting Resource Records covered by NSEC at "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|pos
operator|<
name|ldns_rdf_size
argument_list|(
name|rdf
argument_list|)
condition|)
block|{
name|window_block_nr
operator|=
name|data
index|[
name|pos
index|]
expr_stmt|;
name|bitmap_length
operator|=
name|data
index|[
name|pos
operator|+
literal|1
index|]
expr_stmt|;
name|pos
operator|+=
literal|2
expr_stmt|;
for|for
control|(
name|bit_pos
operator|=
literal|0
init|;
name|bit_pos
operator|<
operator|(
name|bitmap_length
operator|)
operator|*
literal|8
condition|;
name|bit_pos
operator|++
control|)
block|{
if|if
condition|(
name|ldns_get_bit
argument_list|(
operator|&
name|data
index|[
name|pos
index|]
argument_list|,
name|bit_pos
argument_list|)
condition|)
block|{
name|type
operator|=
literal|256
operator|*
operator|(
name|uint16_t
operator|)
name|window_block_nr
operator|+
name|bit_pos
expr_stmt|;
comment|/* skip nsec and rrsig */
if|if
condition|(
name|type
operator|!=
name|LDNS_RR_TYPE_NSEC
operator|&&
name|type
operator|!=
name|LDNS_RR_TYPE_RRSIG
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"querying for:\n"
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" type %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|type
argument_list|)
expr_stmt|;
block|}
name|answer_pkt
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
name|res_flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|answer_pkt
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|answer_pkt
argument_list|)
expr_stmt|;
block|}
comment|/* hmm, this does not give us the right records 						 * when askking for type NS above the delegation 						 * (or, in fact, when the delegated zone is  						 * served by this server either) 						 * do we need to special case NS like NSEC? 						 * or can we fix the query or the answer reading? 						 * ... 						 */
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|ldns_pkt_answer
argument_list|(
name|answer_pkt
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|answer_pkt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Query error, bailing out\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Failed at "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|errstr
operator|=
name|ldns_rr_type2str
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %s\n"
argument_list|,
name|errstr
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|errstr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|pos
operator|+=
operator|(
name|uint16_t
operator|)
name|bitmap_length
expr_stmt|;
block|}
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ldns_status
name|status
decl_stmt|;
name|ldns_resolver
modifier|*
name|res
decl_stmt|;
name|ldns_rdf
modifier|*
name|domain
init|=
name|NULL
decl_stmt|;
name|ldns_pkt
modifier|*
name|p
decl_stmt|;
name|ldns_rr
modifier|*
name|soa
decl_stmt|;
name|ldns_rr_list
modifier|*
name|rrlist
decl_stmt|;
name|ldns_rr_list
modifier|*
name|rrlist2
decl_stmt|;
name|ldns_rr_list
modifier|*
name|nsec_sigs
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|soa_p1
decl_stmt|;
name|ldns_rdf
modifier|*
name|next_dname
decl_stmt|;
name|ldns_rdf
modifier|*
name|last_dname
decl_stmt|;
name|ldns_rdf
modifier|*
name|last_dname_p
decl_stmt|;
name|ldns_rdf
modifier|*
name|startpoint
init|=
name|NULL
decl_stmt|;
name|ldns_rr
modifier|*
name|nsec_rr
init|=
name|NULL
decl_stmt|;
specifier|const
name|char
modifier|*
name|arg_domain
init|=
name|NULL
decl_stmt|;
name|int
name|full
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|serv
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|serv_rdf
decl_stmt|;
name|ldns_resolver
modifier|*
name|cmdline_res
decl_stmt|;
name|ldns_rr_list
modifier|*
name|cmdline_rr_list
decl_stmt|;
name|ldns_rdf
modifier|*
name|cmdline_dname
decl_stmt|;
name|uint8_t
name|fam
init|=
name|LDNS_RESOLV_INETANY
decl_stmt|;
name|int
name|result
init|=
literal|0
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|arg_end_ptr
init|=
name|NULL
decl_stmt|;
name|size_t
name|j
decl_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
name|rrlist
operator|=
name|NULL
expr_stmt|;
name|rrlist2
operator|=
name|NULL
expr_stmt|;
name|soa
operator|=
name|NULL
expr_stmt|;
name|domain
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|2
condition|)
block|{
name|usage
argument_list|(
name|stdout
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-4"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|fam
operator|!=
name|LDNS_RESOLV_INETANY
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"You can only specify one of -4 or -6\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fam
operator|=
name|LDNS_RESOLV_INET
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-6"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|fam
operator|!=
name|LDNS_RESOLV_INETANY
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"You can only specify one of -4 or -6\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|fam
operator|=
name|LDNS_RESOLV_INET6
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-f"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|full
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-s"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
if|if
condition|(
operator|!
name|ldns_str2rdf_dname
argument_list|(
operator|&
name|startpoint
argument_list|,
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"Bad start point name: %s\n"
argument_list|,
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Missing argument for -s\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-v"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
name|verbosity
operator|=
name|strtol
argument_list|(
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
operator|&
name|arg_end_ptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|arg_end_ptr
operator|!=
literal|'\0'
condition|)
block|{
name|printf
argument_list|(
literal|"Bad argument for -v: %s\n"
argument_list|,
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Missing argument for -v\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|i
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
literal|"-version"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"dns zone walker, version %s (ldns version %s)\n"
argument_list|,
name|LDNS_VERSION
argument_list|,
name|ldns_version
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
else|else
block|{
if|if
condition|(
name|argv
index|[
name|i
index|]
index|[
literal|0
index|]
operator|==
literal|'@'
condition|)
block|{
if|if
condition|(
name|strlen
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
name|serv
operator|=
name|argv
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Missing argument for -s\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|serv
operator|=
name|argv
index|[
name|i
index|]
operator|+
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|i
operator|<
name|argc
condition|)
block|{
if|if
condition|(
operator|!
name|domain
condition|)
block|{
comment|/* create a rdf from the command line arg */
name|arg_domain
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
name|domain
operator|=
name|ldns_dname_new_frm_str
argument_list|(
name|arg_domain
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|domain
condition|)
block|{
name|usage
argument_list|(
name|stdout
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"One domain at a time please\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"No domain given to walk\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
if|if
condition|(
operator|!
name|domain
condition|)
block|{
name|printf
argument_list|(
literal|"Missing argument\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* create a new resolver from /etc/resolv.conf */
if|if
condition|(
operator|!
name|serv
condition|)
block|{
if|if
condition|(
name|ldns_resolver_new_frm_file
argument_list|(
operator|&
name|res
argument_list|,
name|NULL
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s"
argument_list|,
literal|"Could not create resolver obj"
argument_list|)
expr_stmt|;
name|result
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
else|else
block|{
name|res
operator|=
name|ldns_resolver_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|res
operator|||
name|strlen
argument_list|(
name|serv
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|result
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
comment|/* add the nameserver */
name|serv_rdf
operator|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_A
argument_list|,
name|serv
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|serv_rdf
condition|)
block|{
comment|/* maybe ip6 */
name|serv_rdf
operator|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_AAAA
argument_list|,
name|serv
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|serv_rdf
condition|)
block|{
comment|/* try to resolv the name if possible */
name|status
operator|=
name|ldns_resolver_new_frm_file
argument_list|(
operator|&
name|cmdline_res
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s"
argument_list|,
literal|"@server ip could not be converted"
argument_list|)
expr_stmt|;
name|result
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
name|cmdline_dname
operator|=
name|ldns_dname_new_frm_str
argument_list|(
name|serv
argument_list|)
expr_stmt|;
name|cmdline_rr_list
operator|=
name|ldns_get_rr_list_addr_by_name
argument_list|(
name|cmdline_res
argument_list|,
name|cmdline_dname
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|cmdline_dname
argument_list|)
expr_stmt|;
name|ldns_resolver_deep_free
argument_list|(
name|cmdline_res
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|cmdline_rr_list
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s %s"
argument_list|,
literal|"could not find any address for the name: "
argument_list|,
name|serv
argument_list|)
expr_stmt|;
name|result
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
else|else
block|{
if|if
condition|(
name|ldns_resolver_push_nameserver_rr_list
argument_list|(
name|res
argument_list|,
name|cmdline_rr_list
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s"
argument_list|,
literal|"pushing nameserver"
argument_list|)
expr_stmt|;
name|result
operator|=
name|EXIT_FAILURE
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|cmdline_rr_list
argument_list|)
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|cmdline_rr_list
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ldns_resolver_push_nameserver
argument_list|(
name|res
argument_list|,
name|serv_rdf
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s"
argument_list|,
literal|"pushing nameserver"
argument_list|)
expr_stmt|;
name|result
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
else|else
block|{
name|ldns_rdf_deep_free
argument_list|(
name|serv_rdf
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ldns_resolver_set_dnssec
argument_list|(
name|res
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ldns_resolver_set_dnssec_cd
argument_list|(
name|res
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ldns_resolver_set_ip6
argument_list|(
name|res
argument_list|,
name|fam
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
condition|)
block|{
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
comment|/* use the resolver to send it a query for the soa 	 * records of the domain given on the command line 	 */
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"\nQuerying for: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|domain
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|LDNS_RR_TYPE_SOA
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
name|LDNS_RD
argument_list|)
expr_stmt|;
name|soa
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
if|if
condition|(
name|p
condition|)
block|{
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"No Packet Received from ldns_resolver_query()\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|exit
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* retrieve the MX records from the answer section of that 		 * packet 		 */
name|rrlist
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_SOA
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rrlist
operator|||
name|ldns_rr_list_rr_count
argument_list|(
name|rrlist
argument_list|)
operator|!=
literal|1
condition|)
block|{
if|if
condition|(
name|rrlist
condition|)
block|{
name|printf
argument_list|(
literal|" ***> 1 SOA: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_rr_list_rr_count
argument_list|(
name|rrlist
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|" *** No rrlist...\b"
argument_list|)
expr_stmt|;
block|}
comment|/* TODO: conversion memory */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|" *** invalid answer name after SOA query for %s\n"
argument_list|,
name|arg_domain
argument_list|)
expr_stmt|;
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ldns_resolver_deep_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|soa
operator|=
name|ldns_rr_clone
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrlist
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|rrlist
argument_list|)
expr_stmt|;
name|rrlist
operator|=
name|NULL
expr_stmt|;
comment|/* check if zone contains DNSSEC data */
name|rrlist
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rrlist
condition|)
block|{
name|printf
argument_list|(
literal|"No DNSSEC data received; either the zone is not secured or you should query it directly (with @nameserver)\n"
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ldns_resolver_deep_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|5
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|rrlist
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* add \001 to soa */
name|status
operator|=
name|ldns_str2rdf_dname
argument_list|(
operator|&
name|soa_p1
argument_list|,
literal|"\\000"
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"error: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|soa
condition|)
block|{
name|printf
argument_list|(
literal|"Error getting SOA\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|startpoint
condition|)
block|{
name|last_dname
operator|=
name|startpoint
expr_stmt|;
name|last_dname_p
operator|=
name|create_dname_plus_1
argument_list|(
name|last_dname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|last_dname
operator|=
name|ldns_rdf_clone
argument_list|(
name|domain
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_dname_cat
argument_list|(
name|soa_p1
argument_list|,
name|last_dname
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"Error concatenating dnames\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|last_dname_p
operator|=
name|ldns_rdf_clone
argument_list|(
name|soa_p1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|full
condition|)
block|{
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|ldns_rr_owner
argument_list|(
name|soa
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
block|}
name|next_dname
operator|=
name|NULL
expr_stmt|;
while|while
condition|(
operator|!
name|next_dname
operator|||
name|ldns_rdf_compare
argument_list|(
name|next_dname
argument_list|,
name|domain
argument_list|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|p
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"Querying for: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|last_dname_p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|last_dname_p
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
name|LDNS_RD
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
if|if
condition|(
name|p
condition|)
block|{
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"No Packet Received from ldns_resolver_query()\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|next_dname
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|next_dname
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|nsec_rr
argument_list|)
expr_stmt|;
name|next_dname
operator|=
name|NULL
expr_stmt|;
name|nsec_rr
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error trying to resolve: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stderr
argument_list|,
name|last_dname_p
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|p
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"Querying for: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|last_dname_p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|last_dname_p
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
name|LDNS_RD
argument_list|)
expr_stmt|;
comment|/* TODO: make a general option for this (something like ignore_rtt)? */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_resolver_nameserver_count
argument_list|(
name|res
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|ldns_resolver_nameserver_rtt
argument_list|(
name|res
argument_list|,
name|j
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ldns_resolver_set_nameserver_rtt
argument_list|(
name|res
argument_list|,
name|j
argument_list|,
name|LDNS_RESOLV_RTT_MIN
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
if|if
condition|(
name|p
condition|)
block|{
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"No Packet Received from ldns_resolver_query()\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
comment|/* if the current name is an empty non-terminal, bind returns 		 * SERVFAIL on the plus1-query... 		 * so requery with only the last dname 		 */
if|if
condition|(
name|ldns_pkt_get_rcode
argument_list|(
name|p
argument_list|)
operator|==
name|LDNS_RCODE_SERVFAIL
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"Querying for: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|last_dname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|p
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|last_dname
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
name|LDNS_RD
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
if|if
condition|(
name|p
condition|)
block|{
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|p
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"No Packet Received from ldns_resolver_query()\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|p
condition|)
block|{
name|exit
argument_list|(
literal|51
argument_list|)
expr_stmt|;
block|}
name|rrlist
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
name|rrlist2
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rrlist
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
name|rrlist2
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|p
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|rrlist
operator|&&
name|rrlist2
condition|)
block|{
name|ldns_rr_list_cat
argument_list|(
name|rrlist
argument_list|,
name|rrlist2
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rrlist2
condition|)
block|{
name|rrlist
operator|=
name|rrlist2
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|rrlist
operator|||
name|ldns_rr_list_rr_count
argument_list|(
name|rrlist
argument_list|)
operator|<
literal|1
condition|)
block|{
if|if
condition|(
operator|!
name|rrlist
condition|)
block|{
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Zone does not seem to be DNSSEC secured,"
literal|"or it uses NSEC3.\n"
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
else|else
block|{
comment|/* find correct nsec */
name|next_dname
operator|=
name|NULL
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrlist
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|ldns_nsec_covers_name
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrlist
argument_list|,
name|j
argument_list|)
argument_list|,
name|last_dname_p
argument_list|)
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"The domain name: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|last_dname_p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nis covered by NSEC: "
argument_list|)
expr_stmt|;
name|ldns_rr_print
argument_list|(
name|stdout
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|rrlist
argument_list|,
name|j
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|next_dname
operator|=
name|ldns_rdf_clone
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrlist
argument_list|,
name|j
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|nsec_rr
operator|=
name|ldns_rr_clone
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrlist
argument_list|,
name|j
argument_list|)
argument_list|)
expr_stmt|;
name|nsec_sigs
operator|=
name|ldns_dnssec_pkt_get_rrsigs_for_name_and_type
argument_list|(
name|p
argument_list|,
name|ldns_rr_owner
argument_list|(
name|nsec_rr
argument_list|)
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|last_dname_p
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nNOT covered by NSEC: "
argument_list|)
expr_stmt|;
name|ldns_rr_print
argument_list|(
name|stdout
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|rrlist
argument_list|,
name|j
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
operator|!
name|next_dname
condition|)
block|{
name|printf
argument_list|(
literal|"Error no nsec for "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|last_dname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|rrlist
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|next_dname
condition|)
block|{
comment|/* apparently the zone also has prepended data (i.e. a.example and www.a.example,   		 * The www comes after the a but befpre a\\000, so we need to make another name (\\000.a) 		 */
if|if
condition|(
name|last_dname_p
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|last_dname_p
argument_list|)
expr_stmt|;
block|}
name|last_dname_p
operator|=
name|create_plus_1_dname
argument_list|(
name|last_dname
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|last_dname
condition|)
block|{
if|if
condition|(
name|ldns_rdf_compare
argument_list|(
name|last_dname
argument_list|,
name|next_dname
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\n\nNext dname is the same as current, this would loop forever. This is a problem that usually occurs when walking through a caching forwarder. Try using the authoritative nameserver to walk (with @nameserver).\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|last_dname
argument_list|)
expr_stmt|;
block|}
name|last_dname
operator|=
name|ldns_rdf_clone
argument_list|(
name|next_dname
argument_list|)
expr_stmt|;
if|if
condition|(
name|last_dname_p
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|last_dname_p
argument_list|)
expr_stmt|;
block|}
name|last_dname_p
operator|=
name|create_dname_plus_1
argument_list|(
name|last_dname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|full
condition|)
block|{
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|ldns_rr_owner
argument_list|(
name|nsec_rr
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|nsec_rr
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* ok, so now we know all the types present at this name, 			 * query for those one by one (...) 			 */
name|status
operator|=
name|query_type_bitmaps
argument_list|(
name|res
argument_list|,
name|LDNS_RD
argument_list|,
name|ldns_rr_owner
argument_list|(
name|nsec_rr
argument_list|)
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|nsec_rr
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* print this nsec and its signatures too */
name|ldns_rr_print
argument_list|(
name|stdout
argument_list|,
name|nsec_rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsec_sigs
condition|)
block|{
name|ldns_rr_list_print
argument_list|(
name|stdout
argument_list|,
name|nsec_sigs
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|nsec_sigs
argument_list|)
expr_stmt|;
name|nsec_sigs
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
block|}
name|ldns_rdf_deep_free
argument_list|(
name|domain
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|soa_p1
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|last_dname_p
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|last_dname
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|next_dname
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|nsec_rr
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|soa
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
name|ldns_resolver_deep_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
name|exit
label|:
return|return
name|result
return|;
block|}
end_function

end_unit


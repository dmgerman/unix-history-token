begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ldns-dpa inspects the (udp) DNS packets found in a pcap file  * and provides statistics about them  *   * (C) NLnet Labs 2006 - 2008  *  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_PCAP_H
end_ifdef

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_LIBPCAP
end_ifdef

begin_include
include|#
directive|include
file|"ldns-dpa.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETINET_IP6_H
end_ifdef

begin_include
include|#
directive|include
file|<netinet/ip6.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|IP_OFFMASK
end_ifndef

begin_define
define|#
directive|define
name|IP_OFFMASK
value|0x1fff
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
name|int
name|verbosity
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|ETHER_HEADER_LENGTH
value|14
end_define

begin_define
define|#
directive|define
name|UDP_HEADER_LENGTH
value|8
end_define

begin_define
define|#
directive|define
name|IP6_HEADER_LENGTH
value|40
end_define

begin_comment
comment|/* some systems don't have this? */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|ETHERTYPE_IPV6
end_ifndef

begin_define
define|#
directive|define
name|ETHERTYPE_IPV6
value|0x86dd
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|MAX_MATCHES
value|20
end_define

begin_define
define|#
directive|define
name|MAX_OPERATORS
value|7
end_define

begin_comment
comment|/* global options */
end_comment

begin_decl_stmt
name|bool
name|show_filter_matches
init|=
name|false
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|total_nr_of_dns_packets
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|total_nr_of_filtered_packets
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|not_ip_packets
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|bad_dns_packets
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|arp_packets
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|udp_packets
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|tcp_packets
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|fragmented_packets
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|size_t
name|lost_packet_fragments
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|hexdumpfile
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|pcap_dumper_t
modifier|*
name|dumper
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|pcap_dumper_t
modifier|*
name|not_ip_dump
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|pcap_dumper_t
modifier|*
name|bad_dns_dump
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|fragment_part
block|{
name|uint16_t
name|ip_id
decl_stmt|;
name|uint8_t
name|data
index|[
literal|65536
index|]
decl_stmt|;
name|size_t
name|cur_len
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|struct
name|fragment_part
modifier|*
name|fragment_p
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* To add a match,  * - add it to the enum  * - add it to the table_matches const  * - add a handler to value_matches  * - tell in get_string_value() where in the packet the data lies  * - add to parser?  * - add to show_match_ function  */
end_comment

begin_enum
enum|enum
name|enum_match_ids
block|{
name|MATCH_ID
block|,
name|MATCH_OPCODE
block|,
name|MATCH_RCODE
block|,
name|MATCH_PACKETSIZE
block|,
name|MATCH_QR
block|,
name|MATCH_TC
block|,
name|MATCH_AD
block|,
name|MATCH_CD
block|,
name|MATCH_RD
block|,
name|MATCH_EDNS
block|,
name|MATCH_EDNS_PACKETSIZE
block|,
name|MATCH_DO
block|,
name|MATCH_QUESTION_SIZE
block|,
name|MATCH_ANSWER_SIZE
block|,
name|MATCH_AUTHORITY_SIZE
block|,
name|MATCH_ADDITIONAL_SIZE
block|,
name|MATCH_SRC_ADDRESS
block|,
name|MATCH_DST_ADDRESS
block|,
name|MATCH_TIMESTAMP
block|,
name|MATCH_QUERY
block|,
name|MATCH_QTYPE
block|,
name|MATCH_QNAME
block|,
name|MATCH_ANSWER
block|,
name|MATCH_AUTHORITY
block|,
name|MATCH_ADDITIONAL
block|,
name|MATCH_LAST
block|}
enum|;
end_enum

begin_typedef
typedef|typedef
name|enum
name|enum_match_ids
name|match_id
typedef|;
end_typedef

begin_enum
enum|enum
name|enum_counter_types
block|{
name|TYPE_INT
block|,
name|TYPE_BOOL
block|,
name|TYPE_OPCODE
block|,
name|TYPE_RCODE
block|,
name|TYPE_STRING
block|,
name|TYPE_TIMESTAMP
block|,
name|TYPE_ADDRESS
block|,
name|TYPE_RR
block|,
name|TYPE_RR_TYPE
block|,
name|TYPE_LAST
block|}
enum|;
end_enum

begin_typedef
typedef|typedef
name|enum
name|enum_counter_types
name|counter_type
typedef|;
end_typedef

begin_decl_stmt
specifier|const
name|ldns_lookup_table
name|lt_types
index|[]
init|=
block|{
block|{
name|TYPE_INT
block|,
literal|"int"
block|}
block|,
block|{
name|TYPE_BOOL
block|,
literal|"bool"
block|}
block|,
block|{
name|TYPE_OPCODE
block|,
literal|"opcode"
block|}
block|,
block|{
name|TYPE_RCODE
block|,
literal|"rcode"
block|}
block|,
block|{
name|TYPE_STRING
block|,
literal|"string"
block|}
block|,
block|{
name|TYPE_TIMESTAMP
block|,
literal|"timestamp"
block|}
block|,
block|{
name|TYPE_ADDRESS
block|,
literal|"address"
block|}
block|,
block|{
name|TYPE_RR
block|,
literal|"rr"
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|enum_type_operators
block|{
name|OP_EQUAL
block|,
name|OP_NOTEQUAL
block|,
name|OP_GREATER
block|,
name|OP_LESSER
block|,
name|OP_GREATEREQUAL
block|,
name|OP_LESSEREQUAL
block|,
name|OP_CONTAINS
block|,
name|OP_LAST
block|}
enum|;
end_enum

begin_typedef
typedef|typedef
name|enum
name|enum_type_operators
name|type_operator
typedef|;
end_typedef

begin_decl_stmt
specifier|const
name|ldns_lookup_table
name|lt_operators
index|[]
init|=
block|{
block|{
name|OP_EQUAL
block|,
literal|"="
block|}
block|,
block|{
name|OP_NOTEQUAL
block|,
literal|"!="
block|}
block|,
block|{
name|OP_GREATER
block|,
literal|">"
block|}
block|,
block|{
name|OP_LESSER
block|,
literal|"<"
block|}
block|,
block|{
name|OP_GREATEREQUAL
block|,
literal|">="
block|}
block|,
block|{
name|OP_LESSEREQUAL
block|,
literal|"<="
block|}
block|,
block|{
name|OP_CONTAINS
block|,
literal|"~="
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_op_str
parameter_list|(
name|type_operator
name|op
parameter_list|)
block|{
specifier|const
name|ldns_lookup_table
modifier|*
name|lt
decl_stmt|;
name|lt
operator|=
name|ldns_lookup_by_id
argument_list|(
operator|(
name|ldns_lookup_table
operator|*
operator|)
name|lt_operators
argument_list|,
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
return|return
name|lt
operator|->
name|name
return|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown operator id: %u\n"
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|type_operator
name|get_op_id
parameter_list|(
name|char
modifier|*
name|op_str
parameter_list|)
block|{
specifier|const
name|ldns_lookup_table
modifier|*
name|lt
decl_stmt|;
name|lt
operator|=
name|ldns_lookup_by_name
argument_list|(
operator|(
name|ldns_lookup_table
operator|*
operator|)
name|lt_operators
argument_list|,
name|op_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
return|return
operator|(
name|type_operator
operator|)
name|lt
operator|->
name|id
return|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown operator: %s\n"
argument_list|,
name|op_str
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_struct
struct|struct
name|struct_type_operators
block|{
name|counter_type
name|type
decl_stmt|;
name|size_t
name|operator_count
decl_stmt|;
name|type_operator
name|operators
index|[
literal|10
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|struct_type_operators
name|type_operators
typedef|;
end_typedef

begin_decl_stmt
specifier|const
name|type_operators
name|const_type_operators
index|[]
init|=
block|{
block|{
name|TYPE_INT
block|,
literal|6
block|,
block|{
name|OP_EQUAL
block|,
name|OP_NOTEQUAL
block|,
name|OP_GREATER
block|,
name|OP_LESSER
block|,
name|OP_GREATEREQUAL
block|,
name|OP_LESSEREQUAL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
name|TYPE_BOOL
block|,
literal|2
block|,
block|{
name|OP_EQUAL
block|,
name|OP_NOTEQUAL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
name|TYPE_OPCODE
block|,
literal|2
block|,
block|{
name|OP_EQUAL
block|,
name|OP_NOTEQUAL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
name|TYPE_RCODE
block|,
literal|2
block|,
block|{
name|OP_EQUAL
block|,
name|OP_NOTEQUAL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
name|TYPE_STRING
block|,
literal|3
block|,
block|{
name|OP_EQUAL
block|,
name|OP_NOTEQUAL
block|,
name|OP_CONTAINS
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
name|TYPE_TIMESTAMP
block|,
literal|6
block|,
block|{
name|OP_EQUAL
block|,
name|OP_NOTEQUAL
block|,
name|OP_GREATER
block|,
name|OP_LESSER
block|,
name|OP_GREATEREQUAL
block|,
name|OP_LESSEREQUAL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
name|TYPE_ADDRESS
block|,
literal|3
block|,
block|{
name|OP_EQUAL
block|,
name|OP_NOTEQUAL
block|,
name|OP_CONTAINS
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
name|TYPE_RR
block|,
literal|3
block|,
block|{
name|OP_EQUAL
block|,
name|OP_NOTEQUAL
block|,
name|OP_CONTAINS
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
name|TYPE_RR_TYPE
block|,
literal|6
block|,
block|{
name|OP_EQUAL
block|,
name|OP_NOTEQUAL
block|,
name|OP_GREATER
block|,
name|OP_LESSER
block|,
name|OP_GREATEREQUAL
block|,
name|OP_LESSEREQUAL
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|,
block|{
literal|0
block|,
literal|0
block|,
block|{
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|,
literal|0
block|}
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|const
name|type_operators
modifier|*
name|get_type_operators
parameter_list|(
name|counter_type
name|type
parameter_list|)
block|{
specifier|const
name|type_operators
modifier|*
name|to
init|=
name|const_type_operators
decl_stmt|;
while|while
condition|(
name|to
condition|)
block|{
if|if
condition|(
name|to
operator|->
name|type
operator|==
name|type
condition|)
block|{
return|return
name|to
return|;
block|}
name|to
operator|++
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_struct
struct|struct
name|struct_match_table
block|{
name|match_id
name|id
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
specifier|const
name|char
modifier|*
name|description
decl_stmt|;
specifier|const
name|counter_type
name|type
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|struct_match_table
name|match_table
typedef|;
end_typedef

begin_comment
comment|/* order of entries has been changed after gprof analysis, and reasoning  * about the uses of -u arguments  */
end_comment

begin_decl_stmt
specifier|const
name|match_table
name|matches
index|[]
init|=
block|{
block|{
name|MATCH_QUERY
block|,
literal|"query"
block|,
literal|"String representation of the query RR"
block|,
name|TYPE_RR
block|}
block|,
block|{
name|MATCH_QTYPE
block|,
literal|"qtype"
block|,
literal|"RR Type of the question RR, if present"
block|,
name|TYPE_RR_TYPE
block|}
block|,
block|{
name|MATCH_QNAME
block|,
literal|"qname"
block|,
literal|"Owner name of the question RR, if present"
block|,
name|TYPE_STRING
block|}
block|,
block|{
name|MATCH_SRC_ADDRESS
block|,
literal|"srcaddress"
block|,
literal|"address the packet was sent from"
block|,
name|TYPE_ADDRESS
block|}
block|,
block|{
name|MATCH_TIMESTAMP
block|,
literal|"timestamp"
block|,
literal|"time the packet was sent"
block|,
name|TYPE_TIMESTAMP
block|}
block|,
block|{
name|MATCH_DST_ADDRESS
block|,
literal|"dstaddress"
block|,
literal|"address the packet was sent to"
block|,
name|TYPE_ADDRESS
block|}
block|,
block|{
name|MATCH_EDNS_PACKETSIZE
block|,
literal|"edns-packetsize"
block|,
literal|"packets size specified in edns rr"
block|,
name|TYPE_INT
block|}
block|,
block|{
name|MATCH_ID
block|,
literal|"id"
block|,
literal|"id of the packet"
block|,
name|TYPE_INT
block|}
block|,
block|{
name|MATCH_OPCODE
block|,
literal|"opcode"
block|,
literal|"opcode of packet (rfc1035)"
block|,
name|TYPE_OPCODE
block|}
block|,
block|{
name|MATCH_RCODE
block|,
literal|"rcode"
block|,
literal|"response code of packet"
block|,
name|TYPE_RCODE
block|}
block|,
block|{
name|MATCH_PACKETSIZE
block|,
literal|"packetsize"
block|,
literal|"size of packet in bytes"
block|,
name|TYPE_INT
block|}
block|,
block|{
name|MATCH_QR
block|,
literal|"qr"
block|,
literal|"value of qr bit"
block|,
name|TYPE_BOOL
block|}
block|,
block|{
name|MATCH_TC
block|,
literal|"tc"
block|,
literal|"value of tc bit"
block|,
name|TYPE_BOOL
block|}
block|,
block|{
name|MATCH_AD
block|,
literal|"ad"
block|,
literal|"value of ad bit"
block|,
name|TYPE_BOOL
block|}
block|,
block|{
name|MATCH_CD
block|,
literal|"cd"
block|,
literal|"value of cd bit"
block|,
name|TYPE_BOOL
block|}
block|,
block|{
name|MATCH_RD
block|,
literal|"rd"
block|,
literal|"value of rd bit"
block|,
name|TYPE_BOOL
block|}
block|,
block|{
name|MATCH_EDNS
block|,
literal|"edns"
block|,
literal|"existence of edns rr"
block|,
name|TYPE_BOOL
block|}
block|,
block|{
name|MATCH_DO
block|,
literal|"do"
block|,
literal|"value of do bit"
block|,
name|TYPE_BOOL
block|}
block|,
block|{
name|MATCH_QUESTION_SIZE
block|,
literal|"questionsize"
block|,
literal|"number of rrs in the question section"
block|,
name|TYPE_INT
block|}
block|,
block|{
name|MATCH_ANSWER_SIZE
block|,
literal|"answersize"
block|,
literal|"number of rrs in the answer section"
block|,
name|TYPE_INT
block|}
block|,
block|{
name|MATCH_AUTHORITY_SIZE
block|,
literal|"authoritysize"
block|,
literal|"number of rrs in the authority section"
block|,
name|TYPE_INT
block|}
block|,
block|{
name|MATCH_ADDITIONAL_SIZE
block|,
literal|"additionalsize"
block|,
literal|"number of rrs in the additional section"
block|,
name|TYPE_INT
block|}
block|,
block|{
name|MATCH_ANSWER
block|,
literal|"answer"
block|,
literal|"String representation of the answer RRs"
block|,
name|TYPE_RR
block|}
block|,
block|{
name|MATCH_AUTHORITY
block|,
literal|"authority"
block|,
literal|"String representation of the authority RRs"
block|,
name|TYPE_RR
block|}
block|,
block|{
name|MATCH_ADDITIONAL
block|,
literal|"additional"
block|,
literal|"String representation of the additional RRs"
block|,
name|TYPE_RR
block|}
block|,
block|{
literal|0
block|,
name|NULL
block|,
name|NULL
block|,
name|TYPE_INT
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_enum
enum|enum
name|enum_match_expression_operators
block|{
name|MATCH_EXPR_OR
block|,
name|MATCH_EXPR_AND
block|,
name|MATCH_EXPR_LEAF
block|}
enum|;
end_enum

begin_typedef
typedef|typedef
name|enum
name|enum_match_expression_operators
name|match_expression_operator
typedef|;
end_typedef

begin_struct
struct|struct
name|struct_match_operation
block|{
name|match_id
name|id
decl_stmt|;
name|type_operator
name|operator
decl_stmt|;
name|char
modifier|*
name|value
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|struct_match_operation
name|match_operation
typedef|;
end_typedef

begin_typedef
typedef|typedef
name|struct
name|struct_match_expression
name|match_expression
typedef|;
end_typedef

begin_struct
struct|struct
name|struct_match_expression
block|{
comment|/* and or or, or leaf (in which case there are no subtrees, but only a match_table */
name|match_expression_operator
name|op
decl_stmt|;
name|match_expression
modifier|*
name|left
decl_stmt|;
name|match_expression
modifier|*
name|right
decl_stmt|;
name|match_operation
modifier|*
name|match
decl_stmt|;
name|size_t
name|count
decl_stmt|;
block|}
struct|;
end_struct

begin_typedef
typedef|typedef
name|struct
name|struct_match_counters
name|match_counters
typedef|;
end_typedef

begin_struct
struct|struct
name|struct_match_counters
block|{
comment|/* 	match_expression **counter; 	size_t size; */
name|match_expression
modifier|*
name|match
decl_stmt|;
name|match_counters
modifier|*
name|left
decl_stmt|;
name|match_counters
modifier|*
name|right
decl_stmt|;
block|}
struct|;
end_struct

begin_function
name|match_table
modifier|*
name|get_match_by_name
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
name|match_table
modifier|*
name|mt
init|=
operator|(
name|match_table
operator|*
operator|)
name|matches
decl_stmt|;
if|if
condition|(
name|name
condition|)
block|{
while|while
condition|(
name|mt
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|name
argument_list|,
name|mt
operator|->
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
name|mt
return|;
block|}
name|mt
operator|++
expr_stmt|;
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|match_table
modifier|*
name|get_match_by_id
parameter_list|(
name|match_id
name|id
parameter_list|)
block|{
name|match_table
modifier|*
name|mt
init|=
operator|(
name|match_table
operator|*
operator|)
name|matches
decl_stmt|;
while|while
condition|(
name|mt
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
if|if
condition|(
name|mt
operator|->
name|id
operator|==
name|id
condition|)
block|{
return|return
name|mt
return|;
block|}
name|mt
operator|++
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|get_match_name_str
parameter_list|(
name|match_id
name|id
parameter_list|)
block|{
name|match_table
modifier|*
name|mt
init|=
name|get_match_by_id
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|mt
condition|)
block|{
return|return
name|mt
operator|->
name|name
return|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown match id: %u\n"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|"Unknown match id"
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_match_operation
parameter_list|(
name|FILE
modifier|*
name|output
parameter_list|,
name|match_operation
modifier|*
name|mc
parameter_list|)
block|{
name|match_table
modifier|*
name|mt
init|=
name|NULL
decl_stmt|;
name|ldns_lookup_table
modifier|*
name|lt
decl_stmt|;
name|struct
name|timeval
name|time
decl_stmt|;
name|time_t
name|time_tt
decl_stmt|;
name|int
name|value
decl_stmt|;
name|size_t
name|pos
decl_stmt|;
name|char
modifier|*
name|tmp
decl_stmt|,
modifier|*
name|tmp2
decl_stmt|;
if|if
condition|(
name|mc
condition|)
block|{
name|mt
operator|=
name|get_match_by_id
argument_list|(
name|mc
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|mt
condition|)
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"%s %s "
argument_list|,
name|mt
operator|->
name|name
argument_list|,
name|get_op_str
argument_list|(
name|mc
operator|->
name|operator
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mt
operator|->
name|type
condition|)
block|{
case|case
name|TYPE_INT
case|:
case|case
name|TYPE_STRING
case|:
case|case
name|TYPE_ADDRESS
case|:
case|case
name|TYPE_RR
case|:
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"'%s'"
argument_list|,
name|mc
operator|->
name|value
argument_list|)
expr_stmt|;
break|break;
case|case
name|TYPE_BOOL
case|:
if|if
condition|(
name|strncmp
argument_list|(
name|mc
operator|->
name|value
argument_list|,
literal|"1"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"'true'"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"'false'"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TYPE_OPCODE
case|:
name|value
operator|=
name|atoi
argument_list|(
name|mc
operator|->
name|value
argument_list|)
expr_stmt|;
name|lt
operator|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_opcodes
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"%s"
argument_list|,
name|lt
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"%s"
argument_list|,
name|mc
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TYPE_RCODE
case|:
name|value
operator|=
name|atoi
argument_list|(
name|mc
operator|->
name|value
argument_list|)
expr_stmt|;
name|lt
operator|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_rcodes
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"%s"
argument_list|,
name|lt
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"%s"
argument_list|,
name|mc
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TYPE_TIMESTAMP
case|:
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|time
operator|.
name|tv_sec
operator|=
operator|(
name|long
name|int
operator|)
name|atol
argument_list|(
name|mc
operator|->
name|value
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|time_tt
operator|=
operator|(
name|time_t
operator|)
name|time
operator|.
name|tv_sec
expr_stmt|;
name|tmp
operator|=
name|ctime
argument_list|(
operator|&
name|time_tt
argument_list|)
expr_stmt|;
name|tmp2
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|tmp
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|pos
operator|=
literal|0
init|;
name|pos
operator|<
name|strlen
argument_list|(
name|tmp
argument_list|)
condition|;
name|pos
operator|++
control|)
block|{
if|if
condition|(
name|tmp
index|[
name|pos
index|]
operator|==
literal|'\n'
condition|)
block|{
name|tmp2
index|[
name|pos
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
block|{
name|tmp2
index|[
name|pos
index|]
operator|=
name|tmp
index|[
name|pos
index|]
expr_stmt|;
block|}
block|}
name|tmp2
index|[
name|pos
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"%s"
argument_list|,
name|tmp2
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tmp2
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"'%s'"
argument_list|,
name|mc
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"%u %s '%s'"
argument_list|,
name|mc
operator|->
name|id
argument_list|,
name|get_op_str
argument_list|(
name|mc
operator|->
name|operator
argument_list|)
argument_list|,
name|mc
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"(nil)"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_match_expression
parameter_list|(
name|FILE
modifier|*
name|output
parameter_list|,
name|match_expression
modifier|*
name|expr
parameter_list|)
block|{
if|if
condition|(
name|expr
condition|)
block|{
switch|switch
condition|(
name|expr
operator|->
name|op
condition|)
block|{
case|case
name|MATCH_EXPR_OR
case|:
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"("
argument_list|)
expr_stmt|;
name|print_match_expression
argument_list|(
name|output
argument_list|,
name|expr
operator|->
name|left
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|" | "
argument_list|)
expr_stmt|;
name|print_match_expression
argument_list|(
name|output
argument_list|,
name|expr
operator|->
name|right
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|")"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_EXPR_AND
case|:
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"("
argument_list|)
expr_stmt|;
name|print_match_expression
argument_list|(
name|output
argument_list|,
name|expr
operator|->
name|left
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"& "
argument_list|)
expr_stmt|;
name|print_match_expression
argument_list|(
name|output
argument_list|,
name|expr
operator|->
name|right
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|")"
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_EXPR_LEAF
case|:
name|print_match_operation
argument_list|(
name|output
argument_list|,
name|expr
operator|->
name|match
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|/* 				fprintf(output, "ERROR PRINTING MATCH: unknown op: %u\n", expr->op); 				exit(1); */
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"("
argument_list|)
expr_stmt|;
if|if
condition|(
name|expr
operator|->
name|left
condition|)
block|{
name|print_match_expression
argument_list|(
name|output
argument_list|,
name|expr
operator|->
name|left
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|output
argument_list|,
literal|" ? "
argument_list|)
expr_stmt|;
if|if
condition|(
name|expr
operator|->
name|right
condition|)
block|{
name|print_match_expression
argument_list|(
name|output
argument_list|,
name|expr
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|output
argument_list|,
literal|") _"
argument_list|)
expr_stmt|;
if|if
condition|(
name|expr
operator|->
name|match
condition|)
block|{
name|print_match_operation
argument_list|(
name|output
argument_list|,
name|expr
operator|->
name|match
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"_"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"(nil)"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|print_counters
parameter_list|(
name|FILE
modifier|*
name|output
parameter_list|,
name|match_counters
modifier|*
name|counters
parameter_list|,
name|bool
name|show_percentages
parameter_list|,
name|size_t
name|total
parameter_list|,
name|int
name|count_minimum
parameter_list|)
block|{
name|double
name|percentage
decl_stmt|;
if|if
condition|(
operator|!
name|counters
operator|||
operator|!
name|output
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
name|print_counters
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|left
argument_list|,
name|show_percentages
argument_list|,
name|total
argument_list|,
name|count_minimum
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|match
condition|)
block|{
if|if
condition|(
name|count_minimum
operator|<
operator|(
name|int
operator|)
name|counters
operator|->
name|match
operator|->
name|count
condition|)
block|{
name|print_match_expression
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|match
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|": %u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|counters
operator|->
name|match
operator|->
name|count
argument_list|)
expr_stmt|;
if|if
condition|(
name|show_percentages
condition|)
block|{
name|percentage
operator|=
operator|(
name|double
operator|)
name|counters
operator|->
name|match
operator|->
name|count
operator|/
operator|(
name|double
operator|)
name|total
operator|*
literal|100.0
expr_stmt|;
name|printf
argument_list|(
literal|" (%.2f%%)"
argument_list|,
name|percentage
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
name|print_counters
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|right
argument_list|,
name|show_percentages
argument_list|,
name|total
argument_list|,
name|count_minimum
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|ldns_pkt2file_hex
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
specifier|const
name|ldns_pkt
modifier|*
name|pkt
parameter_list|)
block|{
name|uint8_t
modifier|*
name|wire
decl_stmt|;
name|size_t
name|size
decl_stmt|,
name|i
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|status
operator|=
name|ldns_pkt2wire
argument_list|(
operator|&
name|wire
argument_list|,
name|pkt
argument_list|,
operator|&
name|size
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to convert packet: error code %u"
argument_list|,
name|status
argument_list|)
expr_stmt|;
return|return;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"; 0"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" %2u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|i
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|";--"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
literal|20
condition|;
name|i
operator|++
control|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" --"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|size
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|%
literal|20
operator|==
literal|0
operator|&&
name|i
operator|>
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\t; %4u-%4u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|i
operator|-
literal|19
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|i
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|" %02x"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|wire
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * Calculate the total for all match operations with the same id as this one  * (if they are 'under' this one in the tree, which should be the case in  * the unique counter tree  */
end_comment

begin_function
specifier|static
name|size_t
name|calculate_total_value
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
name|size_t
name|result
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|counters
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|counters
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|==
name|cur
operator|->
name|id
condition|)
block|{
name|result
operator|=
operator|(
name|size_t
operator|)
name|atol
argument_list|(
name|counters
operator|->
name|match
operator|->
name|match
operator|->
name|value
argument_list|)
operator|*
name|counters
operator|->
name|match
operator|->
name|count
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
name|result
operator|+=
name|calculate_total_value
argument_list|(
name|counters
operator|->
name|left
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
name|result
operator|+=
name|calculate_total_value
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
name|calculate_total_count_matches
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
name|size_t
name|result
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|counters
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|counters
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|==
name|cur
operator|->
name|id
condition|)
block|{
name|result
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
comment|/* In some cases, you don't want the number of actual 		   counted matches, for instance when calculating the 		   average number of queries per second. In this case 		   you want the number of seconds */
if|if
condition|(
name|cur
operator|->
name|id
operator|==
name|MATCH_TIMESTAMP
condition|)
block|{
name|result
operator|+=
operator|(
name|size_t
operator|)
name|abs
argument_list|(
call|(
name|int
call|)
argument_list|(
name|atol
argument_list|(
name|counters
operator|->
name|match
operator|->
name|match
operator|->
name|value
argument_list|)
operator|-
name|atol
argument_list|(
name|counters
operator|->
name|left
operator|->
name|match
operator|->
name|match
operator|->
name|value
argument_list|)
argument_list|)
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|result
operator|+=
name|calculate_total_count_matches
argument_list|(
name|counters
operator|->
name|left
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
if|if
condition|(
name|cur
operator|->
name|id
operator|==
name|MATCH_TIMESTAMP
condition|)
block|{
name|result
operator|+=
operator|(
name|size_t
operator|)
name|abs
argument_list|(
call|(
name|int
call|)
argument_list|(
name|atol
argument_list|(
name|counters
operator|->
name|right
operator|->
name|match
operator|->
name|match
operator|->
name|value
argument_list|)
operator|-
name|atol
argument_list|(
name|counters
operator|->
name|match
operator|->
name|match
operator|->
name|value
argument_list|)
argument_list|)
argument_list|)
operator|-
literal|1
expr_stmt|;
block|}
name|result
operator|+=
name|calculate_total_count_matches
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/**  * Returns true if there is a previous match operation with the given type  * in the counters structure  */
end_comment

begin_function
specifier|static
name|bool
name|has_previous_match
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
if|if
condition|(
operator|!
name|counters
condition|)
block|{
return|return
name|false
return|;
block|}
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|left
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|==
name|cur
operator|->
name|id
condition|)
block|{
return|return
name|true
return|;
block|}
elseif|else
if|if
condition|(
name|has_previous_match
argument_list|(
name|counters
operator|->
name|left
argument_list|,
name|cur
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
elseif|else
if|if
condition|(
name|counters
operator|->
name|left
operator|->
name|right
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|left
operator|->
name|right
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|==
name|cur
operator|->
name|id
condition|)
block|{
return|return
name|true
return|;
block|}
elseif|else
if|if
condition|(
name|has_previous_match
argument_list|(
name|counters
operator|->
name|left
operator|->
name|right
argument_list|,
name|cur
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
block|}
block|}
return|return
name|false
return|;
block|}
end_function

begin_comment
comment|/**  * Returns true if there is a later match operation with the given type  * in the counters structure  */
end_comment

begin_function
specifier|static
name|bool
name|has_next_match
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
if|if
condition|(
operator|!
name|counters
condition|)
block|{
return|return
name|false
return|;
block|}
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|right
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|==
name|cur
operator|->
name|id
condition|)
block|{
return|return
name|true
return|;
block|}
elseif|else
if|if
condition|(
name|has_next_match
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
elseif|else
if|if
condition|(
name|counters
operator|->
name|right
operator|->
name|left
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|right
operator|->
name|left
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|==
name|cur
operator|->
name|id
condition|)
block|{
return|return
name|true
return|;
block|}
elseif|else
if|if
condition|(
name|has_next_match
argument_list|(
name|counters
operator|->
name|right
operator|->
name|left
argument_list|,
name|cur
argument_list|)
condition|)
block|{
return|return
name|true
return|;
block|}
block|}
block|}
return|return
name|false
return|;
block|}
end_function

begin_comment
comment|/**  * Returns the first match with the same type at *cur in  * the counter list, or NULL if it is not found  */
end_comment

begin_function
specifier|static
name|match_expression
modifier|*
name|get_first_match_expression
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
if|if
condition|(
operator|!
name|counters
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|has_previous_match
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
condition|)
block|{
return|return
name|get_first_match_expression
argument_list|(
name|counters
operator|->
name|left
argument_list|,
name|cur
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|counters
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|==
name|cur
operator|->
name|id
condition|)
block|{
return|return
name|counters
operator|->
name|match
return|;
block|}
elseif|else
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
return|return
name|get_first_match_expression
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_comment
comment|/**  * Returns the second match expression with the same type at *cur in  * the counter list, or NULL if it is not found  */
end_comment

begin_function
specifier|static
name|match_expression
modifier|*
name|get_second_match_expression
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
if|if
condition|(
operator|!
name|counters
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|has_previous_match
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
condition|)
block|{
if|if
condition|(
name|has_previous_match
argument_list|(
name|counters
operator|->
name|left
argument_list|,
name|cur
argument_list|)
condition|)
block|{
return|return
name|get_second_match_expression
argument_list|(
name|counters
operator|->
name|left
argument_list|,
name|cur
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|counters
operator|->
name|left
operator|->
name|match
return|;
block|}
comment|/* 	} else if (counters->match->match->id == cur->id) { 		return counters->match->match->value; */
block|}
elseif|else
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
return|return
name|get_first_match_expression
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_comment
comment|/**  * Returns the last match expression with the same type at *cur in  * the counter list, or NULL if it is not found  */
end_comment

begin_function
specifier|static
name|match_expression
modifier|*
name|get_last_match_expression
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
if|if
condition|(
operator|!
name|counters
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|has_next_match
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
condition|)
block|{
return|return
name|get_last_match_expression
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|counters
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|==
name|cur
operator|->
name|id
condition|)
block|{
return|return
name|counters
operator|->
name|match
return|;
block|}
elseif|else
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
return|return
name|get_last_match_expression
argument_list|(
name|counters
operator|->
name|left
argument_list|,
name|cur
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_comment
comment|/**  * Returns the last but one match expression with the same type at *cur in  * the counter list, or NULL if it is not found  */
end_comment

begin_function
specifier|static
name|match_expression
modifier|*
name|get_last_but_one_match_expression
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
if|if
condition|(
operator|!
name|counters
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|has_next_match
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
condition|)
block|{
if|if
condition|(
name|has_next_match
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
condition|)
block|{
return|return
name|get_last_but_one_match_expression
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|counters
operator|->
name|match
return|;
block|}
comment|/* 	} else if (counters->match->match->id == cur->id) { 		return counters->match->match->value; */
block|}
elseif|else
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
return|return
name|get_last_match_expression
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|NULL
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|size_t
name|get_first_count
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
name|match_expression
modifier|*
name|o
init|=
name|get_first_match_expression
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
decl_stmt|;
if|if
condition|(
name|o
condition|)
block|{
return|return
name|o
operator|->
name|count
return|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|size_t
name|get_last_count
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
name|match_expression
modifier|*
name|o
init|=
name|get_last_match_expression
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
decl_stmt|;
if|if
condition|(
name|o
condition|)
block|{
return|return
name|o
operator|->
name|count
return|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|size_t
name|calculate_total_count
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
name|size_t
name|result
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|counters
condition|)
block|{
return|return
literal|0
return|;
block|}
if|if
condition|(
name|counters
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|==
name|cur
operator|->
name|id
condition|)
block|{
name|result
operator|=
name|counters
operator|->
name|match
operator|->
name|count
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
name|result
operator|+=
name|calculate_total_count
argument_list|(
name|counters
operator|->
name|left
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
name|result
operator|+=
name|calculate_total_count
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|print_counter_averages
parameter_list|(
name|FILE
modifier|*
name|output
parameter_list|,
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|)
block|{
name|size_t
name|total_value
decl_stmt|;
name|size_t
name|total_count
decl_stmt|;
name|match_table
modifier|*
name|mt
decl_stmt|;
if|if
condition|(
operator|!
name|counters
operator|||
operator|!
name|output
condition|)
block|{
return|return;
block|}
if|if
condition|(
operator|!
name|cur
condition|)
block|{
name|cur
operator|=
name|counters
operator|->
name|match
operator|->
name|match
expr_stmt|;
name|mt
operator|=
name|get_match_by_id
argument_list|(
name|cur
operator|->
name|id
argument_list|)
expr_stmt|;
name|total_value
operator|=
name|calculate_total_value
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|total_count
operator|=
name|calculate_total_count
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Average for %s: (%u / %u) %.02f\n"
argument_list|,
name|mt
operator|->
name|name
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|total_value
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|total_count
argument_list|,
operator|(
name|float
operator|)
name|total_value
operator|/
operator|(
name|float
operator|)
name|total_count
argument_list|)
expr_stmt|;
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
name|print_counter_averages
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|left
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
name|print_counter_averages
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|left
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|!=
name|cur
operator|->
name|id
condition|)
block|{
name|print_counter_averages
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|left
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|right
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|!=
name|cur
operator|->
name|id
condition|)
block|{
name|print_counter_averages
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|right
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|void
name|print_counter_average_count
parameter_list|(
name|FILE
modifier|*
name|output
parameter_list|,
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_operation
modifier|*
name|cur
parameter_list|,
name|bool
name|remove_first_last
parameter_list|)
block|{
name|size_t
name|total_matches
decl_stmt|;
name|size_t
name|total_count
decl_stmt|;
name|match_table
modifier|*
name|mt
decl_stmt|;
if|if
condition|(
operator|!
name|counters
operator|||
operator|!
name|output
condition|)
block|{
return|return;
block|}
if|if
condition|(
operator|!
name|cur
condition|)
block|{
name|cur
operator|=
name|counters
operator|->
name|match
operator|->
name|match
expr_stmt|;
name|mt
operator|=
name|get_match_by_id
argument_list|(
name|cur
operator|->
name|id
argument_list|)
expr_stmt|;
name|total_matches
operator|=
name|calculate_total_count_matches
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|total_count
operator|=
name|calculate_total_count
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
expr_stmt|;
comment|/* Remove the first and last for instance for timestamp average counts (half seconds drag down the average) */
if|if
condition|(
name|remove_first_last
condition|)
block|{
name|total_count
operator|-=
name|get_first_count
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|total_count
operator|-=
name|get_last_count
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Removing first count from average: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|get_first_count
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Removing last count from average: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|get_last_count
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
argument_list|)
expr_stmt|;
comment|/* in the case where we count the differences between match values too 			 * (like with timestamps) we need to subtract from the match count too 			 */
if|if
condition|(
name|cur
operator|->
name|id
operator|==
name|MATCH_TIMESTAMP
condition|)
block|{
if|if
condition|(
name|get_first_match_expression
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
operator|&&
name|get_second_match_expression
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
condition|)
block|{
name|total_matches
operator|-=
name|atol
argument_list|(
name|get_second_match_expression
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
operator|->
name|match
operator|->
name|value
argument_list|)
operator|-
name|atol
argument_list|(
name|get_first_match_expression
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
operator|->
name|match
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|get_last_match_expression
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
operator|&&
name|get_last_but_one_match_expression
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
condition|)
block|{
name|total_matches
operator|-=
name|atol
argument_list|(
name|get_last_match_expression
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
operator|->
name|match
operator|->
name|value
argument_list|)
operator|-
name|atol
argument_list|(
name|get_last_but_one_match_expression
argument_list|(
name|counters
argument_list|,
name|cur
argument_list|)
operator|->
name|match
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|total_matches
operator|-=
literal|2
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"Average count for %s: (%u / %u) %.02f\n"
argument_list|,
name|mt
operator|->
name|name
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|total_count
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|total_matches
argument_list|,
operator|(
name|float
operator|)
name|total_count
operator|/
operator|(
name|float
operator|)
name|total_matches
argument_list|)
expr_stmt|;
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
name|print_counter_averages
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|left
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
name|print_counter_averages
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|right
argument_list|,
name|cur
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|left
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|!=
name|cur
operator|->
name|id
condition|)
block|{
name|print_counter_averages
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|left
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|right
operator|->
name|match
operator|->
name|match
operator|->
name|id
operator|!=
name|cur
operator|->
name|id
condition|)
block|{
name|print_counter_averages
argument_list|(
name|output
argument_list|,
name|counters
operator|->
name|right
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return;
block|}
end_function

begin_function
specifier|static
name|bool
name|match_int
parameter_list|(
name|type_operator
name|operator
parameter_list|,
name|char
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|mvalue
parameter_list|)
block|{
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
if|if
condition|(
operator|!
name|value
operator|||
operator|!
name|mvalue
condition|)
block|{
return|return
name|false
return|;
block|}
name|a
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|b
operator|=
name|atoi
argument_list|(
name|mvalue
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|operator
condition|)
block|{
case|case
name|OP_EQUAL
case|:
return|return
name|a
operator|==
name|b
return|;
break|break;
case|case
name|OP_NOTEQUAL
case|:
return|return
name|a
operator|!=
name|b
return|;
break|break;
case|case
name|OP_GREATER
case|:
return|return
name|a
operator|>
name|b
return|;
break|break;
case|case
name|OP_LESSER
case|:
return|return
name|a
operator|<
name|b
return|;
break|break;
case|case
name|OP_GREATEREQUAL
case|:
return|return
name|a
operator|>=
name|b
return|;
break|break;
case|case
name|OP_LESSEREQUAL
case|:
return|return
name|a
operator|<=
name|b
return|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown operator: %u\n"
argument_list|,
name|operator
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|match_opcode
parameter_list|(
name|type_operator
name|operator
parameter_list|,
name|char
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|mvalue
parameter_list|)
block|{
name|ldns_pkt_opcode
name|a
decl_stmt|,
name|b
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ldns_lookup_table
modifier|*
name|lt
decl_stmt|;
comment|/* try parse name first, then parse as int */
name|lt
operator|=
name|ldns_lookup_by_name
argument_list|(
name|ldns_opcodes
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|a
operator|=
name|lt
operator|->
name|id
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
operator|&&
operator|!
name|isdigit
argument_list|(
name|value
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|lt
operator|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_opcodes
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|a
operator|=
name|lt
operator|->
name|id
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown opcode: %s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown opcode: %s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
name|lt
operator|=
name|ldns_lookup_by_name
argument_list|(
name|ldns_opcodes
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|b
operator|=
name|lt
operator|->
name|id
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|atoi
argument_list|(
name|mvalue
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
operator|&&
operator|!
name|isdigit
argument_list|(
name|mvalue
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|lt
operator|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_opcodes
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|b
operator|=
name|lt
operator|->
name|id
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown opcode: %s\n"
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown opcode: %s\n"
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
switch|switch
condition|(
name|operator
condition|)
block|{
case|case
name|OP_EQUAL
case|:
return|return
name|a
operator|==
name|b
return|;
break|break;
case|case
name|OP_NOTEQUAL
case|:
return|return
name|a
operator|!=
name|b
return|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error bad operator for opcode: %s\n"
argument_list|,
name|get_op_str
argument_list|(
name|operator
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|false
return|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|match_str
parameter_list|(
name|type_operator
name|operator
parameter_list|,
name|char
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|mvalue
parameter_list|)
block|{
name|char
modifier|*
name|valuedup
decl_stmt|,
modifier|*
name|mvaluedup
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|bool
name|result
decl_stmt|;
if|if
condition|(
name|operator
operator|==
name|OP_CONTAINS
condition|)
block|{
comment|/* strcasestr is not C89  		return strcasestr(value, mvalue) != 0; 		*/
name|valuedup
operator|=
name|strdup
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|mvaluedup
operator|=
name|strdup
argument_list|(
name|mvalue
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|valuedup
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|valuedup
index|[
name|i
index|]
operator|=
name|tolower
argument_list|(
name|valuedup
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|mvaluedup
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|mvaluedup
index|[
name|i
index|]
operator|=
name|tolower
argument_list|(
name|mvaluedup
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|strstr
argument_list|(
name|valuedup
argument_list|,
name|mvaluedup
argument_list|)
operator|!=
literal|0
expr_stmt|;
name|free
argument_list|(
name|valuedup
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|mvaluedup
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
elseif|else
if|if
condition|(
name|operator
operator|==
name|OP_EQUAL
condition|)
block|{
return|return
name|strcmp
argument_list|(
name|value
argument_list|,
name|mvalue
argument_list|)
operator|==
literal|0
return|;
block|}
else|else
block|{
return|return
name|strcmp
argument_list|(
name|value
argument_list|,
name|mvalue
argument_list|)
operator|!=
literal|0
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|match_rr_type
parameter_list|(
name|type_operator
name|operator
parameter_list|,
name|char
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|mvalue
parameter_list|)
block|{
name|ldns_rr_type
name|a
decl_stmt|,
name|b
decl_stmt|;
name|a
operator|=
name|ldns_get_rr_type_by_name
argument_list|(
name|value
argument_list|)
expr_stmt|;
name|b
operator|=
name|ldns_get_rr_type_by_name
argument_list|(
name|mvalue
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|operator
condition|)
block|{
case|case
name|OP_EQUAL
case|:
return|return
name|a
operator|==
name|b
return|;
break|break;
case|case
name|OP_NOTEQUAL
case|:
return|return
name|a
operator|!=
name|b
return|;
break|break;
case|case
name|OP_GREATER
case|:
return|return
name|a
operator|>
name|b
return|;
break|break;
case|case
name|OP_LESSER
case|:
return|return
name|a
operator|<
name|b
return|;
break|break;
case|case
name|OP_GREATEREQUAL
case|:
return|return
name|a
operator|>=
name|b
return|;
break|break;
case|case
name|OP_LESSEREQUAL
case|:
return|return
name|a
operator|<=
name|b
return|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown operator: %u\n"
argument_list|,
name|operator
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|match_rcode
parameter_list|(
name|type_operator
name|operator
parameter_list|,
name|char
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|mvalue
parameter_list|)
block|{
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
name|int
name|i
decl_stmt|;
name|ldns_lookup_table
modifier|*
name|lt
decl_stmt|;
comment|/* try parse name first, then parse as int */
name|lt
operator|=
name|ldns_lookup_by_name
argument_list|(
name|ldns_rcodes
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|a
operator|=
name|lt
operator|->
name|id
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|atoi
argument_list|(
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
operator|&&
operator|!
name|isdigit
argument_list|(
name|value
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|lt
operator|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_rcodes
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|a
operator|=
name|lt
operator|->
name|id
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown rcode: %s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown rcode: %s\n"
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
name|lt
operator|=
name|ldns_lookup_by_name
argument_list|(
name|ldns_rcodes
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|b
operator|=
name|lt
operator|->
name|id
expr_stmt|;
block|}
else|else
block|{
name|i
operator|=
name|atoi
argument_list|(
name|mvalue
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
literal|0
operator|&&
operator|!
name|isdigit
argument_list|(
name|mvalue
index|[
literal|0
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|lt
operator|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_rcodes
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|b
operator|=
name|lt
operator|->
name|id
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown rcode: %s\n"
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown rcode: %s\n"
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
block|}
switch|switch
condition|(
name|operator
condition|)
block|{
case|case
name|OP_EQUAL
case|:
return|return
name|a
operator|==
name|b
return|;
break|break;
case|case
name|OP_NOTEQUAL
case|:
return|return
name|a
operator|!=
name|b
return|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error bad operator for rcode: %s\n"
argument_list|,
name|get_op_str
argument_list|(
name|operator
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|false
return|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|bool
name|value_matches
parameter_list|(
name|match_id
name|id
parameter_list|,
name|type_operator
name|operator
parameter_list|,
name|char
modifier|*
name|value
parameter_list|,
name|char
modifier|*
name|mvalue
parameter_list|)
block|{
name|int
name|result
decl_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"Match %s: %s %s %s: "
argument_list|,
name|get_match_name_str
argument_list|(
name|id
argument_list|)
argument_list|,
name|value
argument_list|,
name|get_op_str
argument_list|(
name|operator
argument_list|)
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|MATCH_OPCODE
case|:
name|result
operator|=
name|match_opcode
argument_list|(
name|operator
argument_list|,
name|value
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_RCODE
case|:
name|result
operator|=
name|match_rcode
argument_list|(
name|operator
argument_list|,
name|value
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_ID
case|:
case|case
name|MATCH_QR
case|:
case|case
name|MATCH_TC
case|:
case|case
name|MATCH_AD
case|:
case|case
name|MATCH_CD
case|:
case|case
name|MATCH_RD
case|:
case|case
name|MATCH_DO
case|:
case|case
name|MATCH_PACKETSIZE
case|:
case|case
name|MATCH_EDNS
case|:
case|case
name|MATCH_EDNS_PACKETSIZE
case|:
case|case
name|MATCH_QUESTION_SIZE
case|:
case|case
name|MATCH_ANSWER_SIZE
case|:
case|case
name|MATCH_AUTHORITY_SIZE
case|:
case|case
name|MATCH_ADDITIONAL_SIZE
case|:
case|case
name|MATCH_TIMESTAMP
case|:
name|result
operator|=
name|match_int
argument_list|(
name|operator
argument_list|,
name|value
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_QUERY
case|:
case|case
name|MATCH_QNAME
case|:
case|case
name|MATCH_ANSWER
case|:
case|case
name|MATCH_AUTHORITY
case|:
case|case
name|MATCH_ADDITIONAL
case|:
name|result
operator|=
name|match_str
argument_list|(
name|operator
argument_list|,
name|value
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_SRC_ADDRESS
case|:
case|case
name|MATCH_DST_ADDRESS
case|:
name|result
operator|=
name|match_str
argument_list|(
name|operator
argument_list|,
name|value
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_QTYPE
case|:
name|result
operator|=
name|match_rr_type
argument_list|(
name|operator
argument_list|,
name|value
argument_list|,
name|mvalue
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: value_matches() for operator %s not implemented yet.\n"
argument_list|,
name|get_op_str
argument_list|(
operator|(
name|type_operator
operator|)
name|id
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
if|if
condition|(
name|result
condition|)
block|{
name|printf
argument_list|(
literal|"true\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"false\n"
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|get_string_value
parameter_list|(
name|match_id
name|id
parameter_list|,
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rdf
modifier|*
name|src_addr
parameter_list|,
name|ldns_rdf
modifier|*
name|dst_addr
parameter_list|)
block|{
name|char
modifier|*
name|val
decl_stmt|;
name|match_table
modifier|*
name|mt
decl_stmt|;
name|size_t
name|valsize
init|=
literal|100
decl_stmt|;
name|val
operator|=
name|malloc
argument_list|(
name|valsize
argument_list|)
expr_stmt|;
name|memset
argument_list|(
name|val
argument_list|,
literal|0
argument_list|,
name|valsize
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|id
condition|)
block|{
case|case
name|MATCH_QR
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_qr
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_ID
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_id
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_OPCODE
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_get_opcode
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_RCODE
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_get_rcode
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_PACKETSIZE
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_size
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_TC
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_tc
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_AD
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_ad
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_CD
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_cd
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_RD
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_rd
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_EDNS
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_edns
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_EDNS_PACKETSIZE
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_edns_udp_size
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_DO
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_edns_do
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_QUESTION_SIZE
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_qdcount
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_ANSWER_SIZE
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_ancount
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_AUTHORITY_SIZE
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_nscount
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_ADDITIONAL_SIZE
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_arcount
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_SRC_ADDRESS
case|:
name|free
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|ldns_rdf2str
argument_list|(
name|src_addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_DST_ADDRESS
case|:
name|free
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|ldns_rdf2str
argument_list|(
name|dst_addr
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_TIMESTAMP
case|:
name|snprintf
argument_list|(
name|val
argument_list|,
name|valsize
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_pkt_timestamp
argument_list|(
name|pkt
argument_list|)
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_QUERY
case|:
if|if
condition|(
name|ldns_pkt_qdcount
argument_list|(
name|pkt
argument_list|)
operator|>
literal|0
condition|)
block|{
name|free
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|ldns_rr2str
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|ldns_pkt_question
argument_list|(
name|pkt
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
comment|/* replace \n for nicer printing later */
if|if
condition|(
name|strchr
argument_list|(
name|val
argument_list|,
literal|'\n'
argument_list|)
condition|)
block|{
operator|*
operator|(
name|strchr
argument_list|(
name|val
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
else|else
block|{
name|val
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
case|case
name|MATCH_QNAME
case|:
if|if
condition|(
name|ldns_pkt_qdcount
argument_list|(
name|pkt
argument_list|)
operator|>
literal|0
condition|)
block|{
name|free
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|ldns_rdf2str
argument_list|(
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|ldns_pkt_question
argument_list|(
name|pkt
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* replace \n for nicer printing later */
if|if
condition|(
name|strchr
argument_list|(
name|val
argument_list|,
literal|'\n'
argument_list|)
condition|)
block|{
operator|*
operator|(
name|strchr
argument_list|(
name|val
argument_list|,
literal|'\n'
argument_list|)
operator|)
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
else|else
block|{
name|val
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
case|case
name|MATCH_QTYPE
case|:
if|if
condition|(
name|ldns_pkt_qdcount
argument_list|(
name|pkt
argument_list|)
operator|>
literal|0
condition|)
block|{
name|free
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|ldns_rr_type2str
argument_list|(
name|ldns_rr_get_type
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|ldns_pkt_question
argument_list|(
name|pkt
argument_list|)
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
case|case
name|MATCH_ANSWER
case|:
if|if
condition|(
name|ldns_pkt_ancount
argument_list|(
name|pkt
argument_list|)
operator|>
literal|0
condition|)
block|{
name|free
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|ldns_rr_list2str
argument_list|(
name|ldns_pkt_answer
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
case|case
name|MATCH_AUTHORITY
case|:
if|if
condition|(
name|ldns_pkt_nscount
argument_list|(
name|pkt
argument_list|)
operator|>
literal|0
condition|)
block|{
name|free
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|ldns_rr_list2str
argument_list|(
name|ldns_pkt_authority
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
case|case
name|MATCH_ADDITIONAL
case|:
if|if
condition|(
name|ldns_pkt_arcount
argument_list|(
name|pkt
argument_list|)
operator|>
literal|0
condition|)
block|{
name|free
argument_list|(
name|val
argument_list|)
expr_stmt|;
name|val
operator|=
name|ldns_rr_list2str
argument_list|(
name|ldns_pkt_additional
argument_list|(
name|pkt
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
break|break;
default|default:
name|mt
operator|=
name|get_match_by_id
argument_list|(
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mt
condition|)
block|{
name|printf
argument_list|(
literal|"ERROR UNKNOWN MATCH_TABLE ID %u\n"
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Matcher for %s not implemented yet\n"
argument_list|,
name|mt
operator|->
name|name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|val
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|match_packet_to_operation
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rdf
modifier|*
name|src_addr
parameter_list|,
name|ldns_rdf
modifier|*
name|dst_addr
parameter_list|,
name|match_operation
modifier|*
name|operation
parameter_list|)
block|{
name|bool
name|result
decl_stmt|;
name|char
modifier|*
name|val
decl_stmt|;
if|if
condition|(
operator|!
name|pkt
operator|||
operator|!
name|operation
condition|)
block|{
return|return
name|false
return|;
block|}
else|else
block|{
name|val
operator|=
name|get_string_value
argument_list|(
name|operation
operator|->
name|id
argument_list|,
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|val
condition|)
block|{
return|return
name|false
return|;
block|}
name|result
operator|=
name|value_matches
argument_list|(
name|operation
operator|->
name|id
argument_list|,
name|operation
operator|->
name|operator
argument_list|,
name|val
argument_list|,
name|operation
operator|->
name|value
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|val
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|match_operation_compare
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
name|match_operation
modifier|*
name|moa
decl_stmt|,
modifier|*
name|mob
decl_stmt|;
name|match_table
modifier|*
name|mt
decl_stmt|;
name|long
name|ia
decl_stmt|,
name|ib
decl_stmt|;
if|if
condition|(
operator|!
name|a
condition|)
block|{
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|b
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|moa
operator|=
operator|(
name|match_operation
operator|*
operator|)
name|a
expr_stmt|;
name|mob
operator|=
operator|(
name|match_operation
operator|*
operator|)
name|b
expr_stmt|;
if|if
condition|(
name|moa
operator|->
name|id
operator|<
name|mob
operator|->
name|id
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|moa
operator|->
name|id
operator|>
name|mob
operator|->
name|id
condition|)
block|{
return|return
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|moa
operator|->
name|operator
operator|<
name|mob
operator|->
name|operator
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|moa
operator|->
name|operator
operator|>
name|mob
operator|->
name|operator
condition|)
block|{
return|return
literal|1
return|;
block|}
else|else
block|{
name|mt
operator|=
name|get_match_by_id
argument_list|(
name|moa
operator|->
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|mt
condition|)
block|{
switch|switch
condition|(
name|mt
operator|->
name|type
condition|)
block|{
case|case
name|TYPE_INT
case|:
case|case
name|TYPE_TIMESTAMP
case|:
case|case
name|TYPE_BOOL
case|:
case|case
name|TYPE_OPCODE
case|:
case|case
name|TYPE_RCODE
case|:
name|ia
operator|=
name|atol
argument_list|(
name|moa
operator|->
name|value
argument_list|)
expr_stmt|;
name|ib
operator|=
name|atol
argument_list|(
name|mob
operator|->
name|value
argument_list|)
expr_stmt|;
return|return
name|ia
operator|-
name|ib
return|;
break|break;
case|case
name|TYPE_STRING
case|:
case|case
name|TYPE_ADDRESS
case|:
case|case
name|TYPE_RR
case|:
default|default:
return|return
name|strcmp
argument_list|(
name|moa
operator|->
name|value
argument_list|,
name|mob
operator|->
name|value
argument_list|)
return|;
break|break;
block|}
block|}
else|else
block|{
return|return
name|strcmp
argument_list|(
name|moa
operator|->
name|value
argument_list|,
name|mob
operator|->
name|value
argument_list|)
return|;
block|}
block|}
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|int
name|match_expression_compare
parameter_list|(
specifier|const
name|void
modifier|*
name|a
parameter_list|,
specifier|const
name|void
modifier|*
name|b
parameter_list|)
block|{
name|match_expression
modifier|*
name|mea
decl_stmt|,
modifier|*
name|meb
decl_stmt|;
if|if
condition|(
operator|!
name|a
condition|)
block|{
return|return
literal|1
return|;
block|}
elseif|else
if|if
condition|(
operator|!
name|b
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
name|mea
operator|=
operator|(
name|match_expression
operator|*
operator|)
name|a
expr_stmt|;
name|meb
operator|=
operator|(
name|match_expression
operator|*
operator|)
name|b
expr_stmt|;
if|if
condition|(
name|mea
operator|->
name|op
operator|<
name|meb
operator|->
name|op
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|mea
operator|->
name|op
operator|>
name|meb
operator|->
name|op
condition|)
block|{
return|return
literal|1
return|;
block|}
else|else
block|{
switch|switch
condition|(
name|mea
operator|->
name|op
condition|)
block|{
case|case
name|MATCH_EXPR_AND
case|:
case|case
name|MATCH_EXPR_OR
case|:
if|if
condition|(
name|match_expression_compare
argument_list|(
name|mea
operator|->
name|left
argument_list|,
name|meb
operator|->
name|left
argument_list|)
operator|<
literal|0
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
elseif|else
if|if
condition|(
name|match_expression_compare
argument_list|(
name|mea
operator|->
name|left
argument_list|,
name|meb
operator|->
name|left
argument_list|)
operator|>
literal|0
condition|)
block|{
return|return
literal|1
return|;
block|}
else|else
block|{
return|return
name|match_expression_compare
argument_list|(
name|mea
operator|->
name|right
argument_list|,
name|meb
operator|->
name|right
argument_list|)
return|;
block|}
break|break;
case|case
name|MATCH_EXPR_LEAF
case|:
return|return
name|match_operation_compare
argument_list|(
name|mea
operator|->
name|match
argument_list|,
name|meb
operator|->
name|match
argument_list|)
return|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown Match Expression logic operator: %u\n"
argument_list|,
name|mea
operator|->
name|op
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_comment
comment|/**  * If count is true, and the counter is found, its count is increased by 1  */
end_comment

begin_function
specifier|static
name|int
name|add_match_counter
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|match_expression
modifier|*
name|expr
parameter_list|,
name|bool
name|count
parameter_list|)
block|{
name|int
name|cmp
decl_stmt|;
name|match_counters
modifier|*
name|new
decl_stmt|;
if|if
condition|(
operator|!
name|counters
operator|||
operator|!
name|expr
condition|)
block|{
return|return
operator|-
literal|1
return|;
block|}
else|else
block|{
if|if
condition|(
name|counters
operator|->
name|match
condition|)
block|{
name|cmp
operator|=
name|match_expression_compare
argument_list|(
name|counters
operator|->
name|match
argument_list|,
name|expr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cmp
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
return|return
name|add_match_counter
argument_list|(
name|counters
operator|->
name|left
argument_list|,
name|expr
argument_list|,
name|count
argument_list|)
return|;
block|}
else|else
block|{
name|new
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|match_counters
argument_list|)
argument_list|)
expr_stmt|;
name|new
operator|->
name|left
operator|=
name|NULL
expr_stmt|;
name|new
operator|->
name|right
operator|=
name|NULL
expr_stmt|;
name|new
operator|->
name|match
operator|=
name|expr
expr_stmt|;
name|counters
operator|->
name|left
operator|=
name|new
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|cmp
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
return|return
name|add_match_counter
argument_list|(
name|counters
operator|->
name|right
argument_list|,
name|expr
argument_list|,
name|count
argument_list|)
return|;
block|}
else|else
block|{
name|new
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|match_counters
argument_list|)
argument_list|)
expr_stmt|;
name|new
operator|->
name|left
operator|=
name|NULL
expr_stmt|;
name|new
operator|->
name|right
operator|=
name|NULL
expr_stmt|;
name|new
operator|->
name|match
operator|=
name|expr
expr_stmt|;
name|counters
operator|->
name|right
operator|=
name|new
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
else|else
block|{
comment|/* already there? */
if|if
condition|(
name|count
condition|)
block|{
name|counters
operator|->
name|match
operator|->
name|count
operator|++
expr_stmt|;
block|}
return|return
literal|1
return|;
block|}
block|}
else|else
block|{
comment|/* shouldn't happen but anyway */
name|counters
operator|->
name|match
operator|=
name|expr
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|bool
name|match_dns_packet_to_expr
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rdf
modifier|*
name|src_addr
parameter_list|,
name|ldns_rdf
modifier|*
name|dst_addr
parameter_list|,
name|match_expression
modifier|*
name|expr
parameter_list|)
block|{
name|bool
name|result
decl_stmt|;
if|if
condition|(
operator|!
name|pkt
operator|||
operator|!
name|expr
condition|)
block|{
return|return
name|false
return|;
block|}
switch|switch
condition|(
name|expr
operator|->
name|op
condition|)
block|{
case|case
name|MATCH_EXPR_OR
case|:
name|result
operator|=
operator|(
name|match_dns_packet_to_expr
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|expr
operator|->
name|left
argument_list|)
operator|||
name|match_dns_packet_to_expr
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|expr
operator|->
name|right
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|MATCH_EXPR_AND
case|:
name|result
operator|=
operator|(
name|match_dns_packet_to_expr
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|expr
operator|->
name|left
argument_list|)
operator|&&
name|match_dns_packet_to_expr
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|expr
operator|->
name|right
argument_list|)
operator|)
expr_stmt|;
break|break;
case|case
name|MATCH_EXPR_LEAF
case|:
name|result
operator|=
name|match_packet_to_operation
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|expr
operator|->
name|match
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error, unknown expression operator %u\n"
argument_list|,
name|expr
operator|->
name|op
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"full expression:\n"
argument_list|)
expr_stmt|;
name|print_match_expression
argument_list|(
name|stderr
argument_list|,
name|expr
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"Found Match:\n"
argument_list|)
expr_stmt|;
name|print_match_expression
argument_list|(
name|stdout
argument_list|,
name|expr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nCount now %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|expr
operator|->
name|count
argument_list|)
expr_stmt|;
block|}
name|expr
operator|->
name|count
operator|++
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_match_operation
parameter_list|(
name|match_operation
modifier|*
name|operation
parameter_list|)
block|{
if|if
condition|(
name|operation
condition|)
block|{
if|if
condition|(
name|operation
operator|->
name|value
condition|)
block|{
name|free
argument_list|(
name|operation
operator|->
name|value
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|operation
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|free_match_expression
parameter_list|(
name|match_expression
modifier|*
name|expr
parameter_list|)
block|{
if|if
condition|(
name|expr
condition|)
block|{
switch|switch
condition|(
name|expr
operator|->
name|op
condition|)
block|{
case|case
name|MATCH_EXPR_OR
case|:
case|case
name|MATCH_EXPR_AND
case|:
name|free_match_expression
argument_list|(
name|expr
operator|->
name|left
argument_list|)
expr_stmt|;
name|free_match_expression
argument_list|(
name|expr
operator|->
name|right
argument_list|)
expr_stmt|;
break|break;
case|case
name|MATCH_EXPR_LEAF
case|:
name|free_match_operation
argument_list|(
name|expr
operator|->
name|match
argument_list|)
expr_stmt|;
break|break;
block|}
name|free
argument_list|(
name|expr
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|free_counters
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|)
block|{
if|if
condition|(
name|counters
condition|)
block|{
if|if
condition|(
name|counters
operator|->
name|left
condition|)
block|{
name|free_counters
argument_list|(
name|counters
operator|->
name|left
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|match
condition|)
block|{
name|free_match_expression
argument_list|(
name|counters
operator|->
name|match
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|counters
operator|->
name|right
condition|)
block|{
name|free_counters
argument_list|(
name|counters
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|counters
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|match_pkt_counters
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rdf
modifier|*
name|src_addr
parameter_list|,
name|ldns_rdf
modifier|*
name|dst_addr
parameter_list|,
name|match_counters
modifier|*
name|counts
parameter_list|)
block|{
if|if
condition|(
name|counts
operator|->
name|left
condition|)
block|{
name|match_pkt_counters
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|counts
operator|->
name|left
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|counts
operator|->
name|match
condition|)
block|{
if|if
condition|(
name|match_dns_packet_to_expr
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|counts
operator|->
name|match
argument_list|)
condition|)
block|{
comment|/* 			counts->match->count++; */
block|}
block|}
if|if
condition|(
name|counts
operator|->
name|right
condition|)
block|{
name|match_pkt_counters
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|counts
operator|->
name|right
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|match_pkt_uniques
parameter_list|(
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rdf
modifier|*
name|src_addr
parameter_list|,
name|ldns_rdf
modifier|*
name|dst_addr
parameter_list|,
name|match_counters
modifier|*
name|uniques
parameter_list|,
name|match_id
name|unique_ids
index|[]
parameter_list|,
name|size_t
name|unique_id_count
parameter_list|)
block|{
name|match_expression
modifier|*
name|me
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|match_operation
modifier|*
name|mo
decl_stmt|;
name|int
name|add_result
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|unique_id_count
condition|;
name|i
operator|++
control|)
block|{
name|mo
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|match_operation
argument_list|)
argument_list|)
expr_stmt|;
name|mo
operator|->
name|id
operator|=
name|unique_ids
index|[
name|i
index|]
expr_stmt|;
name|mo
operator|->
name|operator
operator|=
name|OP_EQUAL
expr_stmt|;
name|mo
operator|->
name|value
operator|=
name|get_string_value
argument_list|(
name|mo
operator|->
name|id
argument_list|,
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|)
expr_stmt|;
name|me
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|match_expression
argument_list|)
argument_list|)
expr_stmt|;
name|me
operator|->
name|op
operator|=
name|MATCH_EXPR_LEAF
expr_stmt|;
name|me
operator|->
name|left
operator|=
name|NULL
expr_stmt|;
name|me
operator|->
name|right
operator|=
name|NULL
expr_stmt|;
name|me
operator|->
name|match
operator|=
name|mo
expr_stmt|;
name|me
operator|->
name|count
operator|=
literal|1
expr_stmt|;
name|add_result
operator|=
name|add_match_counter
argument_list|(
name|uniques
argument_list|,
name|me
argument_list|,
name|true
argument_list|)
expr_stmt|;
comment|/* if result=1 it was already found, so delete new one */
if|if
condition|(
name|add_result
operator|==
literal|1
condition|)
block|{
name|free_match_expression
argument_list|(
name|me
argument_list|)
expr_stmt|;
block|}
block|}
if|#
directive|if
literal|0
block|size_t i, j; 	bool found; 	match_expression *me; 	match_operation *mo;
comment|/* get the value, match uniques for that, if not match, add new */
comment|/* all unique values should be MATCH_EXPR_LEAF */
block|found = false; 		for (j = 0; j< uniques->size; j++) { 			if (uniques->counter[j]->match->id == unique_ids[i]) { 				if (match_dns_packet_to_expr(pkt, src_addr, dst_addr, uniques->counter[j])) { 					found = true; 				} 			} 		} 		if (!found) { 			mo = malloc(sizeof(match_operation)); 			mo->id = unique_ids[i]; 			mo->operator = OP_EQUAL; 			mo->value = get_string_value(mo->id, pkt, src_addr, dst_addr);  			me = malloc(sizeof(match_expression)); 			me->match = mo; 			me->op = MATCH_EXPR_LEAF; 			me->left = NULL; 			me->right = NULL; 			me->count = 1;  			add_counter(uniques, me); 		} 	}
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|match_expression
modifier|*
name|parse_match_expression
parameter_list|(
name|char
modifier|*
name|string
parameter_list|)
block|{
name|match_expression
modifier|*
name|expr
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|size_t
name|leftstart
decl_stmt|,
name|leftend
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|left_str
decl_stmt|,
modifier|*
name|op
decl_stmt|,
modifier|*
name|val
decl_stmt|;
name|match_table
modifier|*
name|mt
decl_stmt|;
name|match_operation
modifier|*
name|mo
init|=
name|NULL
decl_stmt|;
specifier|const
name|type_operators
modifier|*
name|tos
decl_stmt|;
name|match_expression
modifier|*
name|result
decl_stmt|;
name|ldns_lookup_table
modifier|*
name|lt
init|=
name|NULL
decl_stmt|;
comment|/* remove whitespace */
name|char
modifier|*
name|str
init|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|string
argument_list|)
operator|+
literal|1
argument_list|)
decl_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|string
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|isspace
argument_list|(
name|string
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|str
index|[
name|j
index|]
operator|=
name|string
index|[
name|i
index|]
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
block|}
name|str
index|[
name|j
index|]
operator|=
literal|'\0'
expr_stmt|;
name|expr
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|match_expression
argument_list|)
argument_list|)
expr_stmt|;
name|expr
operator|->
name|left
operator|=
name|NULL
expr_stmt|;
name|expr
operator|->
name|right
operator|=
name|NULL
expr_stmt|;
name|expr
operator|->
name|match
operator|=
name|NULL
expr_stmt|;
name|expr
operator|->
name|count
operator|=
literal|0
expr_stmt|;
name|leftstart
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|str
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|str
index|[
name|i
index|]
operator|==
literal|'&'
condition|)
block|{
name|expr
operator|->
name|op
operator|=
name|MATCH_EXPR_AND
expr_stmt|;
if|if
condition|(
operator|!
name|expr
operator|->
name|left
condition|)
block|{
name|left_str
operator|=
name|malloc
argument_list|(
name|leftend
operator|-
name|leftstart
operator|+
literal|2
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|left_str
argument_list|,
operator|&
name|str
index|[
name|leftstart
index|]
argument_list|,
name|leftend
operator|-
name|leftstart
operator|+
literal|1
argument_list|)
expr_stmt|;
name|left_str
index|[
name|leftend
operator|-
name|leftstart
operator|+
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|expr
operator|->
name|left
operator|=
name|parse_match_expression
argument_list|(
name|left_str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|left_str
argument_list|)
expr_stmt|;
block|}
name|expr
operator|->
name|right
operator|=
name|parse_match_expression
argument_list|(
operator|&
name|str
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|expr
operator|->
name|left
operator|&&
name|expr
operator|->
name|right
condition|)
block|{
name|result
operator|=
name|expr
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|else
block|{
name|result
operator|=
name|NULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|str
index|[
name|i
index|]
operator|==
literal|'|'
condition|)
block|{
name|expr
operator|->
name|op
operator|=
name|MATCH_EXPR_OR
expr_stmt|;
if|if
condition|(
operator|!
name|expr
operator|->
name|left
condition|)
block|{
name|left_str
operator|=
name|malloc
argument_list|(
name|leftend
operator|-
name|leftstart
operator|+
literal|2
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|left_str
argument_list|,
operator|&
name|str
index|[
name|leftstart
index|]
argument_list|,
name|leftend
operator|-
name|leftstart
operator|+
literal|1
argument_list|)
expr_stmt|;
name|left_str
index|[
name|leftend
operator|-
name|leftstart
operator|+
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|expr
operator|->
name|left
operator|=
name|parse_match_expression
argument_list|(
name|left_str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|left_str
argument_list|)
expr_stmt|;
block|}
name|expr
operator|->
name|right
operator|=
name|parse_match_expression
argument_list|(
operator|&
name|str
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|expr
operator|->
name|count
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|expr
operator|->
name|left
operator|&&
name|expr
operator|->
name|right
condition|)
block|{
name|result
operator|=
name|expr
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|else
block|{
name|result
operator|=
name|NULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|str
index|[
name|i
index|]
operator|==
literal|'('
condition|)
block|{
name|leftstart
operator|=
name|i
operator|+
literal|1
expr_stmt|;
name|j
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|j
operator|>
literal|0
condition|)
block|{
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|strlen
argument_list|(
name|str
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"parse error: no closing bracket: %s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"                                 "
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|leftstart
operator|-
literal|1
condition|;
name|j
operator|++
control|)
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"^\n"
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|str
index|[
name|i
index|]
operator|==
literal|')'
condition|)
block|{
name|j
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|str
index|[
name|i
index|]
operator|==
literal|'('
condition|)
block|{
name|j
operator|++
expr_stmt|;
block|}
else|else
block|{ 				}
block|}
name|leftend
operator|=
name|i
operator|-
literal|1
expr_stmt|;
name|left_str
operator|=
name|malloc
argument_list|(
name|leftend
operator|-
name|leftstart
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|left_str
argument_list|,
operator|&
name|str
index|[
name|leftstart
index|]
argument_list|,
name|leftend
operator|-
name|leftstart
operator|+
literal|1
argument_list|)
expr_stmt|;
name|expr
operator|->
name|left
operator|=
name|parse_match_expression
argument_list|(
name|left_str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|left_str
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|strlen
argument_list|(
name|str
argument_list|)
operator|-
literal|1
condition|)
block|{
name|result
operator|=
name|expr
operator|->
name|left
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|str
index|[
name|i
index|]
operator|==
literal|')'
condition|)
block|{
name|printf
argument_list|(
literal|"parse error: ) without (\n"
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|else
block|{
name|leftend
operator|=
name|i
expr_stmt|;
block|}
block|}
comment|/* no operators or hooks left, expr should be of the form<name><operator><value> now */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|str
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|str
index|[
name|i
index|]
operator|==
literal|'='
operator|||
name|str
index|[
name|i
index|]
operator|==
literal|'>'
operator|||
name|str
index|[
name|i
index|]
operator|==
literal|'<'
operator|||
name|str
index|[
name|i
index|]
operator|==
literal|'!'
operator|||
name|str
index|[
name|i
index|]
operator|==
literal|'~'
condition|)
block|{
name|leftend
operator|=
name|i
operator|-
literal|1
expr_stmt|;
name|op
operator|=
name|malloc
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
name|op
index|[
name|j
index|]
operator|=
name|str
index|[
name|i
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|j
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|strlen
argument_list|(
name|str
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"parse error no right hand side: %s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
if|if
condition|(
name|str
index|[
name|i
index|]
operator|==
literal|'='
operator|||
name|str
index|[
name|i
index|]
operator|==
literal|'>'
operator|||
name|str
index|[
name|i
index|]
operator|==
literal|'<'
operator|||
name|str
index|[
name|i
index|]
operator|==
literal|'!'
operator|||
name|str
index|[
name|i
index|]
operator|==
literal|'~'
condition|)
block|{
name|op
index|[
name|j
index|]
operator|=
name|str
index|[
name|i
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
name|j
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|>
name|strlen
argument_list|(
name|str
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"parse error no right hand side: %s\n"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|op
index|[
name|j
index|]
operator|=
literal|'\0'
expr_stmt|;
name|left_str
operator|=
name|malloc
argument_list|(
name|leftend
operator|-
name|leftstart
operator|+
literal|2
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|left_str
argument_list|,
operator|&
name|str
index|[
name|leftstart
index|]
argument_list|,
name|leftend
operator|-
name|leftstart
operator|+
literal|1
argument_list|)
expr_stmt|;
name|left_str
index|[
name|leftend
operator|-
name|leftstart
operator|+
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
name|mt
operator|=
name|get_match_by_name
argument_list|(
name|left_str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mt
condition|)
block|{
name|printf
argument_list|(
literal|"parse error: unknown match name: %s\n"
argument_list|,
name|left_str
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
else|else
block|{
comment|/* check if operator is allowed */
name|tos
operator|=
name|get_type_operators
argument_list|(
name|mt
operator|->
name|type
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|tos
operator|->
name|operator_count
condition|;
name|j
operator|++
control|)
block|{
if|if
condition|(
name|get_op_id
argument_list|(
name|op
argument_list|)
operator|==
name|tos
operator|->
name|operators
index|[
name|j
index|]
condition|)
block|{
name|mo
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|match_operation
argument_list|)
argument_list|)
expr_stmt|;
name|mo
operator|->
name|id
operator|=
name|mt
operator|->
name|id
expr_stmt|;
name|mo
operator|->
name|operator
operator|=
name|get_op_id
argument_list|(
name|op
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mt
operator|->
name|type
condition|)
block|{
case|case
name|TYPE_BOOL
case|:
name|val
operator|=
name|malloc
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|,
literal|"true"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|,
literal|"TRUE"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|,
literal|"True"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|,
literal|"1"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val
index|[
literal|0
index|]
operator|=
literal|'1'
expr_stmt|;
name|val
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|,
literal|"false"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|,
literal|"FALSE"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|,
literal|"False"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
operator|||
name|strncmp
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|,
literal|"0"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
block|{
name|val
index|[
literal|0
index|]
operator|=
literal|'0'
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad value for bool: %s\n"
argument_list|,
operator|&
name|str
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|val
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
break|break;
case|case
name|TYPE_RR
case|:
comment|/* convert first so we have the same strings for the same rrs in match_ later */
comment|/* 								qrr = ldns_rr_new_frm_str(&str[i], LDNS_DEFAULT_TTL, NULL); 								if (!qrr) { 									fprintf(stderr, "Bad value for RR: %s\n",&str[i]); 									exit(EXIT_FAILURE); 								} 								val = ldns_rr2str(qrr); 								*/
comment|/* remove \n for readability */
comment|/* 								if (strchr(val, '\n')) { 									*(strchr(val, '\n')) = '\0'; 								} 								ldns_rr_free(qrr); 								*/
name|val
operator|=
name|strdup
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
case|case
name|TYPE_OPCODE
case|:
name|lt
operator|=
name|ldns_lookup_by_name
argument_list|(
name|ldns_opcodes
argument_list|,
operator|&
name|str
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|val
operator|=
name|malloc
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|val
argument_list|,
literal|3
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|lt
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|strdup
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|TYPE_RCODE
case|:
name|lt
operator|=
name|ldns_lookup_by_name
argument_list|(
name|ldns_rcodes
argument_list|,
operator|&
name|str
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|lt
condition|)
block|{
name|val
operator|=
name|malloc
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|val
argument_list|,
literal|3
argument_list|,
literal|"%u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|lt
operator|->
name|id
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|val
operator|=
name|strdup
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
name|val
operator|=
name|strdup
argument_list|(
operator|&
name|str
index|[
name|i
index|]
argument_list|)
expr_stmt|;
break|break;
block|}
name|mo
operator|->
name|value
operator|=
name|val
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|mo
condition|)
block|{
name|printf
argument_list|(
literal|"parse error: operator %s not allowed for match %s\n"
argument_list|,
name|op
argument_list|,
name|left_str
argument_list|)
expr_stmt|;
name|result
operator|=
name|NULL
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|free
argument_list|(
name|left_str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|op
argument_list|)
expr_stmt|;
name|expr
operator|->
name|match
operator|=
name|mo
expr_stmt|;
name|expr
operator|->
name|op
operator|=
name|MATCH_EXPR_LEAF
expr_stmt|;
name|result
operator|=
name|expr
expr_stmt|;
goto|goto
name|done
goto|;
block|}
block|}
name|result
operator|=
name|NULL
expr_stmt|;
name|done
label|:
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
condition|)
block|{
name|free_match_expression
argument_list|(
name|expr
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_comment
comment|/* end of matches and counts */
end_comment

begin_function
name|void
name|usage
parameter_list|(
name|FILE
modifier|*
name|output
parameter_list|)
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"Usage: ldns-dpa [OPTIONS]<pcap file>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"Options:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-c<exprlist>:\tCount occurrences of matching expressions\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-f<expression>:\tFilter occurrences of matching expressions\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-h:\t\tshow this help\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-p:\t\tshow percentage of -u and -c values (of the total of\n\t\t\tmatching on the -f filter. if no filter is given,\n\t\t\tpercentages are on all correct dns packets)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-of<file>:\tWrite pcap packets that match the -f flag to file\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-ofh<file>:\tWrite pcap packets that match the -f flag to file\n\t\tin a hexadecimal format readable by drill\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-s:\t\tshow possible match names\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-s<matchname>:\tshow possible match operators and values for<name>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-sf:\t\tPrint packet that match -f. If no -f is given, print\n\t\t\tall dns packets\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-u<matchnamelist>:\tCount all occurrences of matchname\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-ua:\t\tShow average value of every -u matchname\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-uac:\t\tShow average count of every -u matchname\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-um<number>:\tOnly show -u results that occured more than number times\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-v<level>:\tbe more verbose\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-notip<file>:\tDump pcap packets that were not recognized as\n\t\t\tIP packets to file\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-baddns<file>:\tDump mangled dns packets to file\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t-version:\tShow the version and exit\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"The filename '-' stands for stdin or stdout, so you can use \"-of -\" if you want to pipe the output to another process\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"A<list> is a comma separated list of items\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"An expression has the following form:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"<expr>:\t(<expr>)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t<expr> |<expr>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t<expr>&<expr>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\t<match>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"<match>:\t<matchname><operator><value>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"See the -s option for possible matchnames, operators and values.\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|show_match_names
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
block|{
name|size_t
name|j
decl_stmt|;
name|match_table
modifier|*
name|mt
decl_stmt|;
name|ldns_lookup_table
modifier|*
name|lt
decl_stmt|;
specifier|const
name|type_operators
modifier|*
name|tos
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|;
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|name
condition|)
block|{
name|mt
operator|=
name|get_match_by_name
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|mt
condition|)
block|{
name|printf
argument_list|(
literal|"%s:\n"
argument_list|,
name|mt
operator|->
name|name
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t%s.\n"
argument_list|,
name|mt
operator|->
name|description
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\toperators: "
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t"
argument_list|)
expr_stmt|;
name|tos
operator|=
name|get_type_operators
argument_list|(
name|mt
operator|->
name|type
argument_list|)
expr_stmt|;
if|if
condition|(
name|tos
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|tos
operator|->
name|operator_count
condition|;
name|j
operator|++
control|)
block|{
name|printf
argument_list|(
literal|"%s "
argument_list|,
name|get_op_str
argument_list|(
name|tos
operator|->
name|operators
index|[
name|j
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* 					lt = ldns_lookup_by_id((ldns_lookup_table *) lt_operators, tos->operators[j]); 					if (lt) { 						printf("%s ", lt->name); 					} else { 						printf("? "); 					} */
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"unknown type"
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tValues:\n"
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|mt
operator|->
name|type
condition|)
block|{
case|case
name|TYPE_INT
case|:
name|printf
argument_list|(
literal|"\t\t<Integer>\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TYPE_BOOL
case|:
name|printf
argument_list|(
literal|"\t\t0\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t1\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\ttrue\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tfalse\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TYPE_OPCODE
case|:
name|printf
argument_list|(
literal|"\t\t<Integer>\n"
argument_list|)
expr_stmt|;
name|lt
operator|=
name|ldns_opcodes
expr_stmt|;
while|while
condition|(
name|lt
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"\t\t%s\n"
argument_list|,
name|lt
operator|->
name|name
argument_list|)
expr_stmt|;
name|lt
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|TYPE_RCODE
case|:
name|printf
argument_list|(
literal|"\t\t<Integer>\n"
argument_list|)
expr_stmt|;
name|lt
operator|=
name|ldns_rcodes
expr_stmt|;
while|while
condition|(
name|lt
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
name|printf
argument_list|(
literal|"\t\t%s\n"
argument_list|,
name|lt
operator|->
name|name
argument_list|)
expr_stmt|;
name|lt
operator|++
expr_stmt|;
block|}
break|break;
case|case
name|TYPE_STRING
case|:
name|printf
argument_list|(
literal|"\t\t<String>\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TYPE_TIMESTAMP
case|:
name|printf
argument_list|(
literal|"\t\t<Integer> (seconds since epoch)\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TYPE_ADDRESS
case|:
name|printf
argument_list|(
literal|"\t\t<IP address>\n"
argument_list|)
expr_stmt|;
break|break;
case|case
name|TYPE_RR
case|:
name|printf
argument_list|(
literal|"\t\t<Resource Record>\n"
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Unknown match name: %s\n"
argument_list|,
name|name
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|mt
operator|=
operator|(
name|match_table
operator|*
operator|)
name|matches
expr_stmt|;
while|while
condition|(
name|mt
operator|->
name|name
operator|!=
name|NULL
condition|)
block|{
name|str
operator|=
operator|(
name|char
operator|*
operator|)
name|mt
operator|->
name|name
expr_stmt|;
name|printf
argument_list|(
literal|"%s:"
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|i
operator|=
name|strlen
argument_list|(
name|str
argument_list|)
operator|+
literal|1
expr_stmt|;
while|while
condition|(
name|i
operator|<
literal|24
condition|)
block|{
name|printf
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|mt
operator|->
name|description
argument_list|)
expr_stmt|;
name|mt
operator|++
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|int
name|handle_ether_packet
parameter_list|(
specifier|const
name|u_char
modifier|*
name|data
parameter_list|,
name|struct
name|pcap_pkthdr
name|cur_hdr
parameter_list|,
name|match_counters
modifier|*
name|count
parameter_list|,
name|match_expression
modifier|*
name|match_expr
parameter_list|,
name|match_counters
modifier|*
name|uniques
parameter_list|,
name|match_id
name|unique_ids
index|[]
parameter_list|,
name|size_t
name|unique_id_count
parameter_list|)
block|{
name|struct
name|ether_header
modifier|*
name|eptr
decl_stmt|;
name|struct
name|ip
modifier|*
name|iptr
decl_stmt|;
name|struct
name|ip6_hdr
modifier|*
name|ip6_hdr
decl_stmt|;
name|int
name|ip_hdr_size
decl_stmt|;
name|uint8_t
name|protocol
decl_stmt|;
name|size_t
name|data_offset
init|=
literal|0
decl_stmt|;
name|ldns_rdf
modifier|*
name|src_addr
decl_stmt|,
modifier|*
name|dst_addr
decl_stmt|;
name|uint8_t
modifier|*
name|ap
decl_stmt|;
name|char
modifier|*
name|astr
decl_stmt|;
name|bpf_u_int32
name|len
init|=
name|cur_hdr
operator|.
name|caplen
decl_stmt|;
name|struct
name|timeval
name|timestamp
decl_stmt|;
name|uint16_t
name|ip_flags
decl_stmt|;
name|uint16_t
name|ip_len
decl_stmt|;
name|uint16_t
name|ip_id
decl_stmt|;
name|uint16_t
name|ip_f_offset
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|newdata
init|=
name|NULL
decl_stmt|;
comment|/* printf("timeval: %u ; %u\n", cur_hdr.ts.tv_sec, cur_hdr.ts.tv_usec); */
name|uint8_t
modifier|*
name|dnspkt
decl_stmt|;
name|ldns_pkt
modifier|*
name|pkt
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
comment|/* lets start with the ether header... */
name|eptr
operator|=
operator|(
expr|struct
name|ether_header
operator|*
operator|)
name|data
expr_stmt|;
comment|/* Do a couple of checks to see what packet type we have..*/
if|if
condition|(
name|ntohs
argument_list|(
name|eptr
operator|->
name|ether_type
argument_list|)
operator|==
name|ETHERTYPE_IP
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"Ethernet type hex:%x dec:%u is an IP packet\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ntohs
argument_list|(
name|eptr
operator|->
name|ether_type
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ntohs
argument_list|(
name|eptr
operator|->
name|ether_type
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|data_offset
operator|=
name|ETHER_HEADER_LENGTH
expr_stmt|;
name|iptr
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
operator|(
name|data
operator|+
name|data_offset
operator|)
expr_stmt|;
comment|/* 		printf("IP_OFF: %u (%04x) %04x %04x (%d) (%d)\n", iptr->ip_off, iptr->ip_off, IP_MF, IP_DF, iptr->ip_off& 0x4000, iptr->ip_off& 0x2000); 		*/
name|ip_flags
operator|=
name|ldns_read_uint16
argument_list|(
operator|&
operator|(
name|iptr
operator|->
name|ip_off
operator|)
argument_list|)
expr_stmt|;
name|ip_id
operator|=
name|ldns_read_uint16
argument_list|(
operator|&
operator|(
name|iptr
operator|->
name|ip_id
operator|)
argument_list|)
expr_stmt|;
name|ip_len
operator|=
name|ldns_read_uint16
argument_list|(
operator|&
operator|(
name|iptr
operator|->
name|ip_len
operator|)
argument_list|)
expr_stmt|;
name|ip_f_offset
operator|=
operator|(
name|ip_flags
operator|&
name|IP_OFFMASK
operator|)
operator|*
literal|8
expr_stmt|;
if|if
condition|(
name|ip_flags
operator|&
name|IP_MF
operator|&&
name|ip_f_offset
operator|==
literal|0
condition|)
block|{
comment|/*printf("First Frag id %u len\n", ip_id, ip_len);*/
name|fragment_p
operator|->
name|ip_id
operator|=
name|ip_id
expr_stmt|;
name|memset
argument_list|(
name|fragment_p
operator|->
name|data
argument_list|,
literal|0
argument_list|,
literal|65535
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|fragment_p
operator|->
name|data
argument_list|,
name|iptr
argument_list|,
name|ip_len
argument_list|)
expr_stmt|;
name|fragment_p
operator|->
name|cur_len
operator|=
name|ip_len
operator|+
literal|20
expr_stmt|;
comment|/* 				for (ip_len = 0; ip_len< fragment_p->cur_len; ip_len++) { 					if (ip_len> 0&& ip_len % 20 == 0) { 						printf("\t; %u - %u\n", ip_len - 19, ip_len); 					} 					printf("%02x ", fragment_p->data[ip_len]); 				} 				printf("\t; ??? - %u\n", ip_len); */
return|return
literal|0
return|;
block|}
elseif|else
if|if
condition|(
name|ip_flags
operator|&
name|IP_MF
operator|&&
name|ip_f_offset
operator|!=
literal|0
condition|)
block|{
comment|/*printf("Next frag\n");*/
if|if
condition|(
name|ip_id
operator|==
name|fragment_p
operator|->
name|ip_id
condition|)
block|{
comment|/*printf("add fragment to current id %u len %u offset %u\n", ip_id, ip_len, ip_f_offset);*/
name|memcpy
argument_list|(
name|fragment_p
operator|->
name|data
operator|+
operator|(
name|ip_f_offset
operator|)
operator|+
literal|20
argument_list|,
name|data
operator|+
name|data_offset
operator|+
literal|20
argument_list|,
name|ip_len
operator|-
operator|(
name|iptr
operator|->
name|ip_hl
operator|)
operator|*
literal|4
argument_list|)
expr_stmt|;
comment|/*printf("COPIED %u\n", ip_len);*/
name|fragment_p
operator|->
name|cur_len
operator|=
name|fragment_p
operator|->
name|cur_len
operator|+
name|ip_len
operator|-
literal|20
expr_stmt|;
comment|/*printf("cur len now %u\n", fragment_p->cur_len);*/
comment|/* 				for (ip_len = 0; ip_len< fragment_p->cur_len; ip_len++) { 					if (ip_len> 0&& ip_len % 20 == 0) { 						printf("\t; %u - %u\n", ip_len - 19, ip_len); 					} 					printf("%02x ", fragment_p->data[ip_len]); 				} 				printf("\t; ??? - %u\n", ip_len); */
return|return
literal|0
return|;
block|}
else|else
block|{
comment|/*printf("Lost fragment %u\n", iptr->ip_id);*/
name|lost_packet_fragments
operator|++
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
operator|(
name|ip_flags
operator|&
name|IP_MF
operator|)
operator|&&
name|ip_f_offset
operator|!=
literal|0
condition|)
block|{
comment|/*printf("Last frag\n");*/
if|if
condition|(
name|ip_id
operator|==
name|fragment_p
operator|->
name|ip_id
condition|)
block|{
comment|/*printf("add fragment to current id %u len %u offset %u\n", ip_id, ip_len, ip_f_offset);*/
name|memcpy
argument_list|(
name|fragment_p
operator|->
name|data
operator|+
name|ip_f_offset
operator|+
literal|20
argument_list|,
name|data
operator|+
name|data_offset
operator|+
literal|20
argument_list|,
name|ip_len
operator|-
literal|20
argument_list|)
expr_stmt|;
name|fragment_p
operator|->
name|cur_len
operator|=
name|fragment_p
operator|->
name|cur_len
operator|+
name|ip_len
operator|-
literal|20
expr_stmt|;
name|iptr
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|fragment_p
operator|->
name|data
expr_stmt|;
name|newdata
operator|=
name|malloc
argument_list|(
name|fragment_p
operator|->
name|cur_len
operator|+
name|data_offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newdata
condition|)
block|{
name|printf
argument_list|(
literal|"Malloc failed, out of mem?\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|4
argument_list|)
expr_stmt|;
block|}
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|newdata
argument_list|,
name|data
argument_list|,
name|data_offset
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|newdata
operator|+
name|data_offset
argument_list|,
name|fragment_p
operator|->
name|data
argument_list|,
name|fragment_p
operator|->
name|cur_len
argument_list|)
expr_stmt|;
name|iptr
operator|->
name|ip_len
operator|=
operator|(
name|u_short
operator|)
name|ldns_read_uint16
argument_list|(
operator|&
operator|(
name|fragment_p
operator|->
name|cur_len
operator|)
argument_list|)
expr_stmt|;
name|iptr
operator|->
name|ip_off
operator|=
literal|0
expr_stmt|;
name|len
operator|=
operator|(
name|bpf_u_int32
operator|)
name|fragment_p
operator|->
name|cur_len
expr_stmt|;
name|cur_hdr
operator|.
name|caplen
operator|=
name|len
expr_stmt|;
name|fragment_p
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|fragmented_packets
operator|++
expr_stmt|;
comment|/* 				for (ip_len = 0; ip_len< fragment_p->cur_len; ip_len++) { 					if (ip_len> 0&& ip_len % 20 == 0) { 						printf("\t; %u - %u\n", ip_len - 19, ip_len); 					} 					printf("%02x ", fragment_p->data[ip_len]); 				} 				printf("\t; ??? - %u\n", ip_len); */
block|}
else|else
block|{
comment|/*printf("Lost fragment %u\n", iptr->ip_id);*/
name|lost_packet_fragments
operator|++
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
else|else
block|{
name|newdata
operator|=
name|data
expr_stmt|;
block|}
comment|/* 		if (iptr->ip_off& 0x0040) { 			printf("Don't fragment\n"); 		} */
comment|/* in_addr portability woes, going manual for now */
comment|/* ipv4 */
name|ap
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
operator|(
name|iptr
operator|->
name|ip_src
operator|)
expr_stmt|;
name|astr
operator|=
name|malloc
argument_list|(
name|INET_ADDRSTRLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|inet_ntop
argument_list|(
name|AF_INET
argument_list|,
name|ap
argument_list|,
name|astr
argument_list|,
name|INET_ADDRSTRLEN
argument_list|)
condition|)
block|{
if|if
condition|(
name|ldns_str2rdf_a
argument_list|(
operator|&
name|src_addr
argument_list|,
name|astr
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{ 					 				}
name|free
argument_list|(
name|astr
argument_list|)
expr_stmt|;
block|}
name|ap
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
operator|(
name|iptr
operator|->
name|ip_dst
operator|)
expr_stmt|;
name|astr
operator|=
name|malloc
argument_list|(
name|INET_ADDRSTRLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|inet_ntop
argument_list|(
name|AF_INET
argument_list|,
name|ap
argument_list|,
name|astr
argument_list|,
name|INET_ADDRSTRLEN
argument_list|)
condition|)
block|{
if|if
condition|(
name|ldns_str2rdf_a
argument_list|(
operator|&
name|dst_addr
argument_list|,
name|astr
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{ 					 				}
name|free
argument_list|(
name|astr
argument_list|)
expr_stmt|;
block|}
name|ip_hdr_size
operator|=
operator|(
name|int
operator|)
name|iptr
operator|->
name|ip_hl
operator|*
literal|4
expr_stmt|;
name|protocol
operator|=
operator|(
name|uint8_t
operator|)
name|iptr
operator|->
name|ip_p
expr_stmt|;
name|data_offset
operator|+=
name|ip_hdr_size
expr_stmt|;
if|if
condition|(
name|protocol
operator|==
name|IPPROTO_UDP
condition|)
block|{
name|udp_packets
operator|++
expr_stmt|;
name|data_offset
operator|+=
name|UDP_HEADER_LENGTH
expr_stmt|;
name|dnspkt
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|newdata
operator|+
name|data_offset
operator|)
expr_stmt|;
comment|/*printf("packet starts at byte %u\n", data_offset);*/
comment|/*printf("Len: %u\n", len);*/
name|status
operator|=
name|ldns_wire2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
name|dnspkt
argument_list|,
name|len
operator|-
name|data_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"No dns packet: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
for|for
control|(
name|ip_len
operator|=
literal|0
init|;
name|ip_len
operator|<
name|len
operator|-
name|data_offset
condition|;
name|ip_len
operator|++
control|)
block|{
if|if
condition|(
name|ip_len
operator|>
literal|0
operator|&&
name|ip_len
operator|%
literal|20
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"\t; %u - %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ip_len
operator|-
literal|19
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ip_len
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%02x "
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|dnspkt
index|[
name|ip_len
index|]
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"\t; ??? - %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ip_len
argument_list|)
expr_stmt|;
block|}
name|bad_dns_packets
operator|++
expr_stmt|;
if|if
condition|(
name|bad_dns_dump
condition|)
block|{
name|pcap_dump
argument_list|(
operator|(
name|u_char
operator|*
operator|)
name|bad_dns_dump
argument_list|,
operator|&
name|cur_hdr
argument_list|,
name|newdata
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|timestamp
operator|.
name|tv_sec
operator|=
name|cur_hdr
operator|.
name|ts
operator|.
name|tv_sec
expr_stmt|;
name|timestamp
operator|.
name|tv_usec
operator|=
name|cur_hdr
operator|.
name|ts
operator|.
name|tv_usec
expr_stmt|;
name|ldns_pkt_set_timestamp
argument_list|(
name|pkt
argument_list|,
name|timestamp
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"DNS packet\n"
argument_list|)
expr_stmt|;
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
block|}
name|total_nr_of_dns_packets
operator|++
expr_stmt|;
if|if
condition|(
name|match_expr
condition|)
block|{
if|if
condition|(
name|match_dns_packet_to_expr
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|match_expr
argument_list|)
condition|)
block|{
comment|/* if outputfile write */
if|if
condition|(
name|dumper
condition|)
block|{
name|pcap_dump
argument_list|(
operator|(
name|u_char
operator|*
operator|)
name|dumper
argument_list|,
operator|&
name|cur_hdr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hexdumpfile
condition|)
block|{
name|fprintf
argument_list|(
name|hexdumpfile
argument_list|,
literal|";; %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|total_nr_of_dns_packets
argument_list|)
expr_stmt|;
name|ldns_pkt2file_hex
argument_list|(
name|hexdumpfile
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|show_filter_matches
condition|)
block|{
name|printf
argument_list|(
literal|";; From: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|src_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|";; To:   "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|dst_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"------------------------------------------------------------\n\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|src_addr
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|dst_addr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|dumper
condition|)
block|{
name|pcap_dump
argument_list|(
operator|(
name|u_char
operator|*
operator|)
name|dumper
argument_list|,
operator|&
name|cur_hdr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hexdumpfile
condition|)
block|{
name|fprintf
argument_list|(
name|hexdumpfile
argument_list|,
literal|";; %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|total_nr_of_dns_packets
argument_list|)
expr_stmt|;
name|ldns_pkt2file_hex
argument_list|(
name|hexdumpfile
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|show_filter_matches
condition|)
block|{
name|printf
argument_list|(
literal|";; From: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|src_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|";; To:   "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|dst_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"------------------------------------------------------------\n\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* General counters here */
name|total_nr_of_filtered_packets
operator|++
expr_stmt|;
name|match_pkt_counters
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|match_pkt_uniques
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|uniques
argument_list|,
name|unique_ids
argument_list|,
name|unique_id_count
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|pkt
operator|=
name|NULL
expr_stmt|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|src_addr
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|dst_addr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|protocol
operator|==
name|IPPROTO_TCP
condition|)
block|{
comment|/* tcp packets are skipped */
name|tcp_packets
operator|++
expr_stmt|;
block|}
comment|/* don't have a define for ethertype ipv6 */
block|}
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|eptr
operator|->
name|ether_type
argument_list|)
operator|==
name|ETHERTYPE_IPV6
condition|)
block|{
comment|/*printf("IPv6!\n");*/
comment|/* copied from ipv4, move this to function? */
name|data_offset
operator|=
name|ETHER_HEADER_LENGTH
expr_stmt|;
name|ip6_hdr
operator|=
operator|(
expr|struct
name|ip6_hdr
operator|*
operator|)
operator|(
name|data
operator|+
name|data_offset
operator|)
expr_stmt|;
name|newdata
operator|=
name|data
expr_stmt|;
comment|/* in_addr portability woes, going manual for now */
comment|/* ipv6 */
name|ap
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
operator|(
name|ip6_hdr
operator|->
name|ip6_src
operator|)
expr_stmt|;
name|astr
operator|=
name|malloc
argument_list|(
name|INET6_ADDRSTRLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|ap
argument_list|,
name|astr
argument_list|,
name|INET6_ADDRSTRLEN
argument_list|)
condition|)
block|{
if|if
condition|(
name|ldns_str2rdf_aaaa
argument_list|(
operator|&
name|src_addr
argument_list|,
name|astr
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{ 				 			}
name|free
argument_list|(
name|astr
argument_list|)
expr_stmt|;
block|}
name|ap
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|&
operator|(
name|ip6_hdr
operator|->
name|ip6_dst
operator|)
expr_stmt|;
name|astr
operator|=
name|malloc
argument_list|(
name|INET6_ADDRSTRLEN
argument_list|)
expr_stmt|;
if|if
condition|(
name|inet_ntop
argument_list|(
name|AF_INET6
argument_list|,
name|ap
argument_list|,
name|astr
argument_list|,
name|INET6_ADDRSTRLEN
argument_list|)
condition|)
block|{
if|if
condition|(
name|ldns_str2rdf_aaaa
argument_list|(
operator|&
name|dst_addr
argument_list|,
name|astr
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{ 				 			}
name|free
argument_list|(
name|astr
argument_list|)
expr_stmt|;
block|}
name|ip_hdr_size
operator|=
name|IP6_HEADER_LENGTH
expr_stmt|;
name|protocol
operator|=
operator|(
name|uint8_t
operator|)
name|ip6_hdr
operator|->
name|ip6_ctlun
operator|.
name|ip6_un1
operator|.
name|ip6_un1_nxt
expr_stmt|;
name|data_offset
operator|+=
name|ip_hdr_size
expr_stmt|;
if|if
condition|(
name|protocol
operator|==
name|IPPROTO_UDP
condition|)
block|{
name|udp_packets
operator|++
expr_stmt|;
comment|/*printf("V6 UDP!\n");*/
name|data_offset
operator|+=
name|UDP_HEADER_LENGTH
expr_stmt|;
name|dnspkt
operator|=
operator|(
name|uint8_t
operator|*
operator|)
operator|(
name|newdata
operator|+
name|data_offset
operator|)
expr_stmt|;
comment|/*printf("Len: %u\n", len);*/
name|status
operator|=
name|ldns_wire2pkt
argument_list|(
operator|&
name|pkt
argument_list|,
name|dnspkt
argument_list|,
name|len
operator|-
name|data_offset
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|3
condition|)
block|{
name|printf
argument_list|(
literal|"No dns packet: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|bad_dns_packets
operator|++
expr_stmt|;
if|if
condition|(
name|bad_dns_dump
condition|)
block|{
name|pcap_dump
argument_list|(
operator|(
name|u_char
operator|*
operator|)
name|bad_dns_dump
argument_list|,
operator|&
name|cur_hdr
argument_list|,
name|newdata
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|timestamp
operator|.
name|tv_sec
operator|=
name|cur_hdr
operator|.
name|ts
operator|.
name|tv_sec
expr_stmt|;
name|timestamp
operator|.
name|tv_usec
operator|=
name|cur_hdr
operator|.
name|ts
operator|.
name|tv_usec
expr_stmt|;
name|ldns_pkt_set_timestamp
argument_list|(
name|pkt
argument_list|,
name|timestamp
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|4
condition|)
block|{
name|printf
argument_list|(
literal|"DNS packet\n"
argument_list|)
expr_stmt|;
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
block|}
name|total_nr_of_dns_packets
operator|++
expr_stmt|;
if|if
condition|(
name|match_expr
condition|)
block|{
if|if
condition|(
name|match_dns_packet_to_expr
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|match_expr
argument_list|)
condition|)
block|{
comment|/* if outputfile write */
if|if
condition|(
name|dumper
condition|)
block|{
name|pcap_dump
argument_list|(
operator|(
name|u_char
operator|*
operator|)
name|dumper
argument_list|,
operator|&
name|cur_hdr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|show_filter_matches
condition|)
block|{
name|printf
argument_list|(
literal|";; From: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|src_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|";; To:   "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|dst_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"------------------------------------------------------------\n\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|src_addr
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|dst_addr
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|show_filter_matches
condition|)
block|{
name|printf
argument_list|(
literal|";; From: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|src_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|";; To:   "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|dst_addr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|pkt
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"------------------------------------------------------------\n\n"
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* General counters here */
name|total_nr_of_filtered_packets
operator|++
expr_stmt|;
name|match_pkt_counters
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|count
argument_list|)
expr_stmt|;
name|match_pkt_uniques
argument_list|(
name|pkt
argument_list|,
name|src_addr
argument_list|,
name|dst_addr
argument_list|,
name|uniques
argument_list|,
name|unique_ids
argument_list|,
name|unique_id_count
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|pkt
operator|=
name|NULL
expr_stmt|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|src_addr
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|dst_addr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|protocol
operator|==
name|IPPROTO_TCP
condition|)
block|{
comment|/* tcp packets are skipped */
name|tcp_packets
operator|++
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"ipv6 unknown next header type: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|protocol
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|ntohs
argument_list|(
name|eptr
operator|->
name|ether_type
argument_list|)
operator|==
name|ETHERTYPE_ARP
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"Ethernet type hex:%x dec:%u is an ARP packet\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ntohs
argument_list|(
name|eptr
operator|->
name|ether_type
argument_list|)
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ntohs
argument_list|(
name|eptr
operator|->
name|ether_type
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|arp_packets
operator|++
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Ethernet type %x not IP\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ntohs
argument_list|(
name|eptr
operator|->
name|ether_type
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"Ethernet type %x not IP\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ntohs
argument_list|(
name|eptr
operator|->
name|ether_type
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|not_ip_packets
operator|++
expr_stmt|;
if|if
condition|(
name|not_ip_dump
condition|)
block|{
name|pcap_dump
argument_list|(
operator|(
name|u_char
operator|*
operator|)
name|not_ip_dump
argument_list|,
operator|&
name|cur_hdr
argument_list|,
name|data
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|bool
name|parse_match_list
parameter_list|(
name|match_counters
modifier|*
name|counters
parameter_list|,
name|char
modifier|*
name|string
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|match_expression
modifier|*
name|expr
decl_stmt|;
comment|/*	match_counter *mc;*/
name|size_t
name|lastpos
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|substring
decl_stmt|;
comment|/*printf("Parsing match list: '%s'\n", string);*/
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|string
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|string
index|[
name|i
index|]
operator|==
literal|','
condition|)
block|{
if|if
condition|(
name|i
operator|<
literal|2
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Matchlist cannot start with ,\n"
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
else|else
block|{
name|substring
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|string
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|substring
argument_list|,
operator|&
name|string
index|[
name|lastpos
index|]
argument_list|,
name|i
operator|-
name|lastpos
operator|+
literal|1
argument_list|)
expr_stmt|;
name|substring
index|[
name|i
operator|-
name|lastpos
index|]
operator|=
literal|'\0'
expr_stmt|;
name|expr
operator|=
name|parse_match_expression
argument_list|(
name|substring
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|expr
condition|)
block|{
return|return
name|false
return|;
block|}
name|free
argument_list|(
name|substring
argument_list|)
expr_stmt|;
comment|/* 				if (expr->op != MATCH_EXPR_LEAF) { 					fprintf(stderr, "Matchlist can only contain<match>, not a logic expression\n"); 					return false; 				} 				*/
name|add_match_counter
argument_list|(
name|counters
argument_list|,
name|expr
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|lastpos
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
block|}
block|}
name|substring
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|string
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|substring
argument_list|,
operator|&
name|string
index|[
name|lastpos
index|]
argument_list|,
name|i
operator|-
name|lastpos
operator|+
literal|1
argument_list|)
expr_stmt|;
name|substring
index|[
name|i
operator|-
name|lastpos
index|]
operator|=
literal|'\0'
expr_stmt|;
name|expr
operator|=
name|parse_match_expression
argument_list|(
name|substring
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|expr
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad match: %s\n"
argument_list|,
name|substring
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|free
argument_list|(
name|substring
argument_list|)
expr_stmt|;
comment|/* 	if (expr->op != MATCH_EXPR_LEAF) { 		fprintf(stderr, "Matchlist can only contain<match>, not a logic expression\n"); 		return false; 	} 	*/
name|add_match_counter
argument_list|(
name|counters
argument_list|,
name|expr
argument_list|,
name|false
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
name|bool
name|parse_uniques
parameter_list|(
name|match_id
name|ids
index|[]
parameter_list|,
name|size_t
modifier|*
name|count
parameter_list|,
name|char
modifier|*
name|string
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|,
name|lastpos
decl_stmt|;
name|char
modifier|*
name|str
decl_stmt|,
modifier|*
name|strpart
decl_stmt|;
name|match_table
modifier|*
name|mt
decl_stmt|;
comment|/*printf("Parsing unique counts: '%s'\n", string);*/
name|str
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|string
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|strlen
argument_list|(
name|string
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
operator|!
name|isspace
argument_list|(
name|string
index|[
name|i
index|]
argument_list|)
condition|)
block|{
name|str
index|[
name|j
index|]
operator|=
name|string
index|[
name|i
index|]
expr_stmt|;
name|j
operator|++
expr_stmt|;
block|}
block|}
name|str
index|[
name|j
index|]
operator|=
literal|'\0'
expr_stmt|;
name|lastpos
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|strlen
argument_list|(
name|str
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|str
index|[
name|i
index|]
operator|==
literal|','
operator|||
name|i
operator|>=
name|strlen
argument_list|(
name|str
argument_list|)
condition|)
block|{
name|strpart
operator|=
name|malloc
argument_list|(
name|i
operator|-
name|lastpos
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|strpart
argument_list|,
operator|&
name|str
index|[
name|lastpos
index|]
argument_list|,
name|i
operator|-
name|lastpos
argument_list|)
expr_stmt|;
name|strpart
index|[
name|i
operator|-
name|lastpos
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|mt
operator|=
name|get_match_by_name
argument_list|(
name|strpart
argument_list|)
operator|)
condition|)
block|{
name|ids
index|[
operator|*
name|count
index|]
operator|=
name|mt
operator|->
name|id
expr_stmt|;
operator|*
name|count
operator|=
operator|*
name|count
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Error parsing match list; unknown match name: %s\n"
argument_list|,
name|strpart
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|free
argument_list|(
name|strpart
argument_list|)
expr_stmt|;
name|lastpos
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
block|}
if|if
condition|(
name|i
operator|>
name|lastpos
condition|)
block|{
name|strpart
operator|=
name|malloc
argument_list|(
name|i
operator|-
name|lastpos
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strncpy
argument_list|(
name|strpart
argument_list|,
operator|&
name|str
index|[
name|lastpos
index|]
argument_list|,
name|i
operator|-
name|lastpos
argument_list|)
expr_stmt|;
name|strpart
index|[
name|i
operator|-
name|lastpos
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|mt
operator|=
name|get_match_by_name
argument_list|(
name|strpart
argument_list|)
operator|)
condition|)
block|{
name|ids
index|[
operator|*
name|count
index|]
operator|=
name|mt
operator|->
name|id
expr_stmt|;
operator|*
name|count
operator|=
operator|*
name|count
operator|+
literal|1
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Error parsing match list; unknown match name: %s\n"
argument_list|,
name|strpart
argument_list|)
expr_stmt|;
return|return
name|false
return|;
block|}
name|free
argument_list|(
name|strpart
argument_list|)
expr_stmt|;
name|lastpos
operator|=
name|i
operator|+
literal|1
expr_stmt|;
block|}
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
name|true
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|int
name|status
init|=
name|EXIT_SUCCESS
decl_stmt|;
name|match_counters
modifier|*
name|count
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|match_counters
argument_list|)
argument_list|)
decl_stmt|;
specifier|const
name|char
modifier|*
name|inputfile
init|=
name|NULL
decl_stmt|;
name|char
name|errbuf
index|[
name|PCAP_ERRBUF_SIZE
index|]
decl_stmt|;
name|pcap_t
modifier|*
name|pc
init|=
name|NULL
decl_stmt|;
specifier|const
name|u_char
modifier|*
name|cur
decl_stmt|;
name|struct
name|pcap_pkthdr
name|cur_hdr
decl_stmt|;
name|match_expression
modifier|*
name|expr
init|=
name|NULL
decl_stmt|;
name|match_id
name|unique_ids
index|[
name|MAX_MATCHES
index|]
decl_stmt|;
name|size_t
name|unique_id_count
init|=
literal|0
decl_stmt|;
comment|/* number of unique counters */
name|match_counters
modifier|*
name|uniques
init|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
name|match_counters
argument_list|)
argument_list|)
decl_stmt|;
name|char
modifier|*
name|dumpfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|hexdumpfilename
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|not_ip_dumpfile
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|bad_dns_dumpfile
init|=
name|NULL
decl_stmt|;
name|bool
name|show_percentages
init|=
name|false
decl_stmt|;
name|bool
name|show_averages
init|=
name|false
decl_stmt|;
name|bool
name|show_average_count
init|=
name|false
decl_stmt|;
name|int
name|unique_minimum
init|=
literal|0
decl_stmt|;
name|count
operator|->
name|left
operator|=
name|NULL
expr_stmt|;
name|count
operator|->
name|match
operator|=
name|NULL
expr_stmt|;
name|count
operator|->
name|right
operator|=
name|NULL
expr_stmt|;
name|uniques
operator|->
name|left
operator|=
name|NULL
expr_stmt|;
name|uniques
operator|->
name|match
operator|=
name|NULL
expr_stmt|;
name|uniques
operator|->
name|right
operator|=
name|NULL
expr_stmt|;
name|fragment_p
operator|=
name|malloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|fragment_part
argument_list|)
argument_list|)
expr_stmt|;
name|fragment_p
operator|->
name|ip_id
operator|=
literal|0
expr_stmt|;
name|fragment_p
operator|->
name|cur_len
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|argc
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-baddns"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
name|bad_dns_dumpfile
operator|=
name|argv
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-notip"
argument_list|,
literal|7
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
name|not_ip_dumpfile
operator|=
name|argv
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-c"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
if|if
condition|(
operator|!
name|parse_match_list
argument_list|(
name|count
argument_list|,
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
condition|)
block|{
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-f"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
if|if
condition|(
name|expr
operator|||
name|strchr
argument_list|(
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|,
literal|','
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"You can only specify 1 filter expression.\n"
argument_list|)
expr_stmt|;
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
name|expr
operator|=
name|parse_match_expression
argument_list|(
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-h"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|usage
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|status
operator|=
name|EXIT_SUCCESS
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-p"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
name|show_percentages
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-of"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
name|dumpfile
operator|=
name|argv
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-ofh"
argument_list|,
literal|5
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
name|hexdumpfilename
operator|=
name|argv
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-s"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
name|show_match_names
argument_list|(
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|show_match_names
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|EXIT_SUCCESS
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-sf"
argument_list|,
literal|4
argument_list|)
operator|==
literal|0
condition|)
block|{
name|show_filter_matches
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncmp
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
literal|"-u"
argument_list|,
literal|3
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
if|if
condition|(
operator|!
name|parse_uniques
argument_list|(
name|unique_ids
argument_list|,
operator|&
name|unique_id_count
argument_list|,
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
condition|)
block|{
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
literal|"-ua"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|show_averages
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
literal|"-uac"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|show_average_count
operator|=
name|true
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
literal|"-um"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|i
operator|+
literal|1
operator|<
name|argc
condition|)
block|{
name|unique_minimum
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|i
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"-um requires an argument"
argument_list|)
expr_stmt|;
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|status
operator|=
name|EXIT_FAILURE
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
literal|"-v"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|i
operator|++
expr_stmt|;
if|if
condition|(
name|i
operator|<
name|argc
condition|)
block|{
name|verbosity
operator|=
name|atoi
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strcmp
argument_list|(
literal|"-version"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
operator|==
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"dns packet analyzer, version %s (ldns version %s)\n"
argument_list|,
name|LDNS_VERSION
argument_list|,
name|ldns_version
argument_list|()
argument_list|)
expr_stmt|;
goto|goto
name|exit
goto|;
block|}
else|else
block|{
if|if
condition|(
name|inputfile
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"You can only specify 1 input file\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|inputfile
operator|=
name|argv
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|!
name|inputfile
condition|)
block|{
name|inputfile
operator|=
literal|"-"
expr_stmt|;
block|}
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"Filter:\n"
argument_list|)
expr_stmt|;
name|print_match_expression
argument_list|(
name|stdout
argument_list|,
name|expr
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n\n"
argument_list|)
expr_stmt|;
block|}
name|pc
operator|=
name|pcap_open_offline
argument_list|(
name|inputfile
argument_list|,
name|errbuf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|pc
condition|)
block|{
if|if
condition|(
name|errno
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"Error opening pcap file %s: %s\n"
argument_list|,
name|inputfile
argument_list|,
name|errbuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
goto|goto
name|showresult
goto|;
block|}
block|}
if|if
condition|(
name|dumpfile
condition|)
block|{
name|dumper
operator|=
name|pcap_dump_open
argument_list|(
name|pc
argument_list|,
name|dumpfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dumper
condition|)
block|{
name|printf
argument_list|(
literal|"Error opening pcap dump file %s: %s\n"
argument_list|,
name|dumpfile
argument_list|,
name|errbuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|hexdumpfilename
condition|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|hexdumpfilename
argument_list|,
literal|"-"
argument_list|,
literal|2
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|printf
argument_list|(
literal|"hexdump is file\n"
argument_list|)
expr_stmt|;
name|hexdumpfile
operator|=
name|fopen
argument_list|(
name|hexdumpfilename
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"hexdump is stdout\n"
argument_list|)
expr_stmt|;
name|hexdumpfile
operator|=
name|stdout
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|hexdumpfile
condition|)
block|{
name|printf
argument_list|(
literal|"Error opening hex dump file %s: %s\n"
argument_list|,
name|hexdumpfilename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|not_ip_dumpfile
condition|)
block|{
name|not_ip_dump
operator|=
name|pcap_dump_open
argument_list|(
name|pc
argument_list|,
name|not_ip_dumpfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|not_ip_dump
condition|)
block|{
name|printf
argument_list|(
literal|"Error opening pcap dump file NOT_IP: %s\n"
argument_list|,
name|errbuf
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|bad_dns_dumpfile
condition|)
block|{
name|bad_dns_dump
operator|=
name|pcap_dump_open
argument_list|(
name|pc
argument_list|,
name|bad_dns_dumpfile
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|bad_dns_dump
condition|)
block|{
name|printf
argument_list|(
literal|"Error opening pcap dump file NOT_IP: %s\n"
argument_list|,
name|errbuf
argument_list|)
expr_stmt|;
block|}
block|}
while|while
condition|(
operator|(
name|cur
operator|=
name|pcap_next
argument_list|(
name|pc
argument_list|,
operator|&
name|cur_hdr
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|verbosity
operator|>=
literal|5
condition|)
block|{
name|printf
argument_list|(
literal|"\n\n\n[PKT_HDR] caplen: %u \tlen: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|cur_hdr
operator|.
name|caplen
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|cur_hdr
operator|.
name|len
argument_list|)
expr_stmt|;
block|}
name|handle_ether_packet
argument_list|(
name|cur
argument_list|,
name|cur_hdr
argument_list|,
name|count
argument_list|,
name|expr
argument_list|,
name|uniques
argument_list|,
name|unique_ids
argument_list|,
name|unique_id_count
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|not_ip_dump
condition|)
block|{
name|pcap_dump_close
argument_list|(
name|not_ip_dump
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bad_dns_dump
condition|)
block|{
name|pcap_dump_close
argument_list|(
name|bad_dns_dump
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dumper
condition|)
block|{
name|pcap_dump_close
argument_list|(
name|dumper
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|hexdumpfile
operator|&&
name|hexdumpfile
operator|!=
name|stdout
condition|)
block|{
name|fclose
argument_list|(
name|hexdumpfile
argument_list|)
expr_stmt|;
block|}
name|pcap_close
argument_list|(
name|pc
argument_list|)
expr_stmt|;
name|showresult
label|:
if|if
condition|(
name|show_percentages
condition|)
block|{
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Packets that are not IP: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|not_ip_packets
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"bad dns packets: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|bad_dns_packets
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"arp packets: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|arp_packets
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"udp packets: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|udp_packets
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"tcp packets (skipped): %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|tcp_packets
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"reassembled fragmented packets: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|fragmented_packets
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"packet fragments lost: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|lost_packet_fragments
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Total number of DNS packets: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|total_nr_of_dns_packets
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"Total number of DNS packets after filter: %u\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|total_nr_of_filtered_packets
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|->
name|match
condition|)
block|{
name|print_counters
argument_list|(
name|stdout
argument_list|,
name|count
argument_list|,
name|show_percentages
argument_list|,
name|total_nr_of_filtered_packets
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|uniques
operator|->
name|match
condition|)
block|{
name|print_counters
argument_list|(
name|stdout
argument_list|,
name|uniques
argument_list|,
name|show_percentages
argument_list|,
name|total_nr_of_filtered_packets
argument_list|,
name|unique_minimum
argument_list|)
expr_stmt|;
if|if
condition|(
name|show_averages
condition|)
block|{
name|print_counter_averages
argument_list|(
name|stdout
argument_list|,
name|uniques
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|show_average_count
condition|)
block|{
name|print_counter_average_count
argument_list|(
name|stdout
argument_list|,
name|uniques
argument_list|,
name|NULL
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
block|}
name|exit
label|:
name|free_match_expression
argument_list|(
name|expr
argument_list|)
expr_stmt|;
name|free_counters
argument_list|(
name|count
argument_list|)
expr_stmt|;
name|free_counters
argument_list|(
name|uniques
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_else
else|#
directive|else
end_else

begin_function
name|int
name|main
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ldns-dpa was not built because there is no pcap library on this system, or there was no pcap header file at compilation time. Please install pcap and rebuild.\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_function
name|int
name|main
parameter_list|(
name|void
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ldns-dpa was not built because there is no pcap library on this system, or there was no pcap header file at compilation time. Please install pcap and rebuild.\n"
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


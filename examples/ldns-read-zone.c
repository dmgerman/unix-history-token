begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * read a zone file from disk and prints it, one RR per line  *  * (c) NLnetLabs 2005-2008  *  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|<ldns/host2str.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_function
name|void
name|print_usage
parameter_list|(
specifier|const
name|char
modifier|*
name|progname
parameter_list|)
block|{
name|printf
argument_list|(
literal|"Usage: %s [OPTIONS]<zonefile>\n"
argument_list|,
name|progname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tReads the zonefile and prints it.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\tThe RR count of the zone is printed to stderr.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-b include Bubble Babble encoding of DS's.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-0 zeroize timestamps and signature in RRSIG records.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-c canonicalize all rrs in the zone.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-d only show DNSSEC data from the zone\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-h show this text\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-n do not print the SOA record\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-p prepend SOA serial with spaces so"
literal|" it takes exactly ten characters.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-s strip DNSSEC data from the zone\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-S [[+|-]<number> | YYYYMMDDxx | "
literal|" unixtime ]\n"
literal|"\t\tSet serial number to<number> or,"
literal|" when preceded by a sign,\n"
literal|"\t\toffset the existing number with "
literal|"<number>.  With YYYYMMDDxx\n"
literal|"\t\tthe serial is formatted as a datecounter"
literal|", and with unixtime as\n"
literal|"\t\tthe number of seconds since 1-1-1970."
literal|"  However, on serial\n"
literal|"\t\tnumber decrease, +1 is used in stead"
literal|".  (implies -s)\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-u<rr type>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tMark<rr type> for printing in unknown type format.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tThis option may be given multiple times.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t-u is not meant to be used together with -U.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-U<rr type>\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tMark<rr type> for not printing in unknown type format.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tThis option may be given multiple times.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\tThe first occurrence of the -U option marks all RR types for"
literal|"\n\t\tprinting in unknown type format except for the given<rr type>."
literal|"\n\t\tSubsequent -U options will clear the mark for those<rr type>s"
literal|"\n\t\ttoo, so that only the given<rr type>s will be printed in the"
literal|"\n\t\tpresentation format specific for those<rr type>s.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t\t-U is not meant to be used together with -u.\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-v shows the version and exits\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\t-z sort the zone (implies -c).\n"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\nif no file is given standard input is read\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
modifier|*
name|filename
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|ldns_zone
modifier|*
name|z
decl_stmt|;
name|int
name|line_nr
init|=
literal|0
decl_stmt|;
name|int
name|c
decl_stmt|;
name|bool
name|canonicalize
init|=
name|false
decl_stmt|;
name|bool
name|sort
init|=
name|false
decl_stmt|;
name|bool
name|strip
init|=
name|false
decl_stmt|;
name|bool
name|only_dnssec
init|=
name|false
decl_stmt|;
name|bool
name|print_soa
init|=
name|true
decl_stmt|;
name|ldns_status
name|s
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|ldns_rr_list
modifier|*
name|stripped_list
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_rr
decl_stmt|;
name|ldns_rr_type
name|cur_rr_type
decl_stmt|;
name|ldns_output_format_storage
name|fmt_storage
decl_stmt|;
name|ldns_output_format
modifier|*
name|fmt
init|=
name|ldns_output_format_init
argument_list|(
operator|&
name|fmt_storage
argument_list|)
decl_stmt|;
name|ldns_soa_serial_increment_func_t
name|soa_serial_increment_func
init|=
name|NULL
decl_stmt|;
name|int
name|soa_serial_increment_func_data
init|=
literal|0
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"0bcdhnpsu:U:vzS:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'b'
case|:
name|fmt
operator|->
name|flags
operator||=
operator|(
name|LDNS_COMMENT_BUBBLEBABBLE
operator||
name|LDNS_COMMENT_FLAGS
operator|)
expr_stmt|;
break|break;
case|case
literal|'0'
case|:
name|fmt
operator|->
name|flags
operator||=
name|LDNS_FMT_ZEROIZE_RRSIGS
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|canonicalize
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'d'
case|:
name|only_dnssec
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|strip
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: stripping both DNSSEC and non-DNSSEC records. Output will be sparse.\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'h'
case|:
name|print_usage
argument_list|(
literal|"ldns-read-zone"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|print_soa
operator|=
name|false
expr_stmt|;
break|break;
case|case
literal|'p'
case|:
name|fmt
operator|->
name|flags
operator||=
name|LDNS_FMT_PAD_SOA_SERIAL
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|strip
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|only_dnssec
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: stripping both DNSSEC and non-DNSSEC records. Output will be sparse.\n"
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'u'
case|:
name|s
operator|=
name|ldns_output_format_set_type
argument_list|(
name|fmt
argument_list|,
name|ldns_get_rr_type_by_name
argument_list|(
name|optarg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot set rr type %s "
literal|"in output format to "
literal|"print as unknown type: %s\n"
argument_list|,
name|ldns_rr_descript
argument_list|(
name|ldns_get_rr_type_by_name
argument_list|(
name|optarg
argument_list|)
argument_list|)
operator|->
name|_name
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'U'
case|:
name|s
operator|=
name|ldns_output_format_clear_type
argument_list|(
name|fmt
argument_list|,
name|ldns_get_rr_type_by_name
argument_list|(
name|optarg
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Cannot set rr type %s "
literal|"in output format to not "
literal|"print as unknown type: %s\n"
argument_list|,
name|ldns_rr_descript
argument_list|(
name|ldns_get_rr_type_by_name
argument_list|(
name|optarg
argument_list|)
argument_list|)
operator|->
name|_name
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|s
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'v'
case|:
name|printf
argument_list|(
literal|"read zone version %s (ldns version %s)\n"
argument_list|,
name|LDNS_VERSION
argument_list|,
name|ldns_version
argument_list|()
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'z'
case|:
name|canonicalize
operator|=
name|true
expr_stmt|;
name|sort
operator|=
name|true
expr_stmt|;
break|break;
case|case
literal|'S'
case|:
name|strip
operator|=
name|true
expr_stmt|;
if|if
condition|(
operator|*
name|optarg
operator|==
literal|'+'
operator|||
operator|*
name|optarg
operator|==
literal|'-'
condition|)
block|{
name|soa_serial_increment_func_data
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
name|soa_serial_increment_func
operator|=
name|ldns_soa_serial_increment_by
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strtok
argument_list|(
name|optarg
argument_list|,
literal|"0123456789"
argument_list|)
condition|)
block|{
name|soa_serial_increment_func_data
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
name|soa_serial_increment_func
operator|=
name|ldns_soa_serial_identity
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|optarg
argument_list|,
literal|"YYYYMMDDxx"
argument_list|)
condition|)
block|{
name|soa_serial_increment_func
operator|=
name|ldns_soa_serial_datecounter
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|strcasecmp
argument_list|(
name|optarg
argument_list|,
literal|"unixtime"
argument_list|)
condition|)
block|{
name|soa_serial_increment_func
operator|=
name|ldns_soa_serial_unixtime
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"-S expects a number "
literal|"optionally preceded by a "
literal|"+ or - sign to indicate an "
literal|"offset, or the text YYYYMM"
literal|"DDxx or unixtime\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
block|{
name|fp
operator|=
name|stdin
expr_stmt|;
block|}
else|else
block|{
name|filename
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|fp
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|fp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to open %s: %s\n"
argument_list|,
name|filename
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
name|s
operator|=
name|ldns_zone_new_frm_fp_l
argument_list|(
operator|&
name|z
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
operator|&
name|line_nr
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s at %d\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|s
argument_list|)
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strip
condition|)
block|{
name|stripped_list
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|cur_rr
operator|=
name|ldns_rr_list_pop_rr
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|cur_rr_type
operator|=
name|ldns_rr_get_type
argument_list|(
name|cur_rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_rr_type
operator|==
name|LDNS_RR_TYPE_RRSIG
operator|||
name|cur_rr_type
operator|==
name|LDNS_RR_TYPE_NSEC
operator|||
name|cur_rr_type
operator|==
name|LDNS_RR_TYPE_NSEC3
operator|||
name|cur_rr_type
operator|==
name|LDNS_RR_TYPE_NSEC3PARAM
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|cur_rr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|stripped_list
argument_list|,
name|cur_rr
argument_list|)
expr_stmt|;
block|}
block|}
name|ldns_rr_list_free
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_zone_set_rrs
argument_list|(
name|z
argument_list|,
name|stripped_list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|only_dnssec
condition|)
block|{
name|stripped_list
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
while|while
condition|(
operator|(
name|cur_rr
operator|=
name|ldns_rr_list_pop_rr
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|)
operator|)
condition|)
block|{
name|cur_rr_type
operator|=
name|ldns_rr_get_type
argument_list|(
name|cur_rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_rr_type
operator|==
name|LDNS_RR_TYPE_RRSIG
operator|||
name|cur_rr_type
operator|==
name|LDNS_RR_TYPE_NSEC
operator|||
name|cur_rr_type
operator|==
name|LDNS_RR_TYPE_NSEC3
operator|||
name|cur_rr_type
operator|==
name|LDNS_RR_TYPE_NSEC3PARAM
condition|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|stripped_list
argument_list|,
name|cur_rr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_rr_free
argument_list|(
name|cur_rr
argument_list|)
expr_stmt|;
block|}
block|}
name|ldns_rr_list_free
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_zone_set_rrs
argument_list|(
name|z
argument_list|,
name|stripped_list
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|canonicalize
condition|)
block|{
name|ldns_rr2canonical
argument_list|(
name|ldns_zone_soa
argument_list|(
name|z
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ldns_rr2canonical
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|sort
condition|)
block|{
name|ldns_zone_sort
argument_list|(
name|z
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|print_soa
operator|&&
name|ldns_zone_soa
argument_list|(
name|z
argument_list|)
condition|)
block|{
if|if
condition|(
name|soa_serial_increment_func
condition|)
block|{
name|ldns_rr_soa_increment_func_int
argument_list|(
name|ldns_zone_soa
argument_list|(
name|z
argument_list|)
argument_list|,
name|soa_serial_increment_func
argument_list|,
name|soa_serial_increment_func_data
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_print_fmt
argument_list|(
name|stdout
argument_list|,
name|fmt
argument_list|,
name|ldns_zone_soa
argument_list|(
name|z
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_print_fmt
argument_list|(
name|stdout
argument_list|,
name|fmt
argument_list|,
name|ldns_zone_rrs
argument_list|(
name|z
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_zone_deep_free
argument_list|(
name|z
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


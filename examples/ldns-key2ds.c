begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * key2ds transforms a public key into its DS  * It (currently) prints out the public key  *  * (c) NLnet Labs, 2005 - 2008  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|char
modifier|*
name|prog
parameter_list|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s [-fn] [-1|-2] keyfile\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  Generate a DS RR from the DNSKEYS in keyfile\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  The following file will be created: "
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"K<name>+<alg>+<id>.ds\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  The base name (K<name>+<alg>+<id> will be printed to stdout\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"Options:\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  -f: ignore SEP flag (i.e. make DS records for any key)\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  -n: do not write DS records to file(s) but to stdout\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  (default) use similar hash to the key algorithm.\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  -1: use SHA1 for the DS hash\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  -2: use SHA256 for the DS hash\n"
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|USE_GOST
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  -g: use GOST for the DS hash\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_ECDSA
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  -4: use SHA384 for the DS hash\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|static
name|int
name|is_suitable_dnskey
parameter_list|(
name|ldns_rr
modifier|*
name|rr
parameter_list|,
name|int
name|sep_only
parameter_list|)
block|{
if|if
condition|(
operator|!
name|rr
operator|||
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_DNSKEY
condition|)
block|{
return|return
literal|0
return|;
block|}
return|return
operator|!
name|sep_only
operator|||
operator|(
name|ldns_rdf2native_int16
argument_list|(
name|ldns_rr_dnskey_flags
argument_list|(
name|rr
argument_list|)
argument_list|)
operator|&
name|LDNS_KEY_SEP_KEY
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_hash
name|suitable_hash
parameter_list|(
name|ldns_signing_algorithm
name|algorithm
parameter_list|)
block|{
switch|switch
condition|(
name|algorithm
condition|)
block|{
case|case
name|LDNS_SIGN_RSASHA256
case|:
case|case
name|LDNS_SIGN_RSASHA512
case|:
return|return
name|LDNS_SHA256
return|;
case|case
name|LDNS_SIGN_ECC_GOST
case|:
ifdef|#
directive|ifdef
name|USE_GOST
return|return
name|LDNS_HASH_GOST
return|;
else|#
directive|else
return|return
name|LDNS_SHA256
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_ECDSA
case|case
name|LDNS_SIGN_ECDSAP256SHA256
case|:
return|return
name|LDNS_SHA256
return|;
case|case
name|LDNS_SIGN_ECDSAP384SHA384
case|:
return|return
name|LDNS_SHA384
return|;
endif|#
directive|endif
default|default:
break|break;
block|}
return|return
name|LDNS_SHA1
return|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|FILE
modifier|*
name|keyfp
decl_stmt|,
modifier|*
name|dsfp
decl_stmt|;
name|char
modifier|*
name|keyname
decl_stmt|;
name|char
modifier|*
name|dsname
decl_stmt|;
name|char
modifier|*
name|owner
decl_stmt|;
name|ldns_rr
modifier|*
name|k
decl_stmt|,
modifier|*
name|ds
decl_stmt|;
name|ldns_signing_algorithm
name|alg
decl_stmt|;
name|ldns_hash
name|h
decl_stmt|;
name|int
name|similar_hash
init|=
literal|1
decl_stmt|;
name|char
modifier|*
name|program
init|=
name|argv
index|[
literal|0
index|]
decl_stmt|;
name|int
name|nofile
init|=
literal|0
decl_stmt|;
name|ldns_rdf
modifier|*
name|origin
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|result
init|=
name|LDNS_STATUS_OK
decl_stmt|;
name|int
name|sep_only
init|=
literal|1
decl_stmt|;
name|alg
operator|=
literal|0
expr_stmt|;
name|h
operator|=
name|LDNS_SHA1
expr_stmt|;
name|argv
operator|++
operator|,
name|argc
operator|--
expr_stmt|;
while|while
condition|(
name|argc
operator|&&
name|argv
index|[
literal|0
index|]
index|[
literal|0
index|]
operator|==
literal|'-'
condition|)
block|{
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-1"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|h
operator|=
name|LDNS_SHA1
expr_stmt|;
name|similar_hash
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-2"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|h
operator|=
name|LDNS_SHA256
expr_stmt|;
name|similar_hash
operator|=
literal|0
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|USE_GOST
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-g"
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|ldns_key_EVP_load_gost_id
argument_list|()
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"error: libcrypto does not provide GOST\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|h
operator|=
name|LDNS_HASH_GOST
expr_stmt|;
name|similar_hash
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_ECDSA
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-4"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|h
operator|=
name|LDNS_SHA384
expr_stmt|;
name|similar_hash
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-f"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|sep_only
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|,
literal|"-n"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|nofile
operator|=
literal|1
expr_stmt|;
block|}
name|argv
operator|++
operator|,
name|argc
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|argc
operator|!=
literal|1
condition|)
block|{
name|usage
argument_list|(
name|stderr
argument_list|,
name|program
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|keyname
operator|=
name|strdup
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|keyfp
operator|=
name|fopen
argument_list|(
name|keyname
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|keyfp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Failed to open public key file %s: %s\n"
argument_list|,
name|keyname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
while|while
condition|(
name|result
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|result
operator|=
name|ldns_rr_new_frm_fp
argument_list|(
operator|&
name|k
argument_list|,
name|keyfp
argument_list|,
literal|0
argument_list|,
operator|&
name|origin
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
while|while
condition|(
name|result
operator|==
name|LDNS_STATUS_SYNTAX_ORIGIN
operator|||
name|result
operator|==
name|LDNS_STATUS_SYNTAX_TTL
operator|||
operator|(
name|result
operator|==
name|LDNS_STATUS_OK
operator|&&
operator|!
name|is_suitable_dnskey
argument_list|(
name|k
argument_list|,
name|sep_only
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|result
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_rr_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|ldns_rr_new_frm_fp
argument_list|(
operator|&
name|k
argument_list|,
name|keyfp
argument_list|,
literal|0
argument_list|,
operator|&
name|origin
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|LDNS_STATUS_SYNTAX_EMPTY
condition|)
block|{
comment|/* we're done */
break|break;
block|}
if|if
condition|(
name|result
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Could not read public key from file %s: %s\n"
argument_list|,
name|keyname
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|result
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|owner
operator|=
name|ldns_rdf2str
argument_list|(
name|ldns_rr_owner
argument_list|(
name|k
argument_list|)
argument_list|)
expr_stmt|;
name|alg
operator|=
name|ldns_rdf2native_int8
argument_list|(
name|ldns_rr_dnskey_algorithm
argument_list|(
name|k
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|similar_hash
condition|)
name|h
operator|=
name|suitable_hash
argument_list|(
name|alg
argument_list|)
expr_stmt|;
name|ds
operator|=
name|ldns_key_rr2ds
argument_list|(
name|k
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ds
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Conversion to a DS RR failed\n"
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|owner
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
comment|/* print the public key RR to .key */
name|dsname
operator|=
name|LDNS_XMALLOC
argument_list|(
name|char
argument_list|,
name|strlen
argument_list|(
name|owner
argument_list|)
operator|+
literal|16
argument_list|)
expr_stmt|;
name|snprintf
argument_list|(
name|dsname
argument_list|,
name|strlen
argument_list|(
name|owner
argument_list|)
operator|+
literal|15
argument_list|,
literal|"K%s+%03u+%05u.ds"
argument_list|,
name|owner
argument_list|,
name|alg
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_calc_keytag
argument_list|(
name|k
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nofile
condition|)
name|ldns_rr_print
argument_list|(
name|stdout
argument_list|,
name|ds
argument_list|)
expr_stmt|;
else|else
block|{
name|dsfp
operator|=
name|fopen
argument_list|(
name|dsname
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dsfp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to open %s: %s\n"
argument_list|,
name|dsname
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_rr_print
argument_list|(
name|dsfp
argument_list|,
name|ds
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|dsfp
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stdout
argument_list|,
literal|"K%s+%03u+%05u\n"
argument_list|,
name|owner
argument_list|,
name|alg
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_calc_keytag
argument_list|(
name|k
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ldns_rr_free
argument_list|(
name|ds
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|k
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|owner
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|dsname
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|keyfp
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|keyname
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


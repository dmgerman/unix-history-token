begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $Id: ldns-update.c,v 1.1 2005/09/13 09:37:05 ho Exp $ */
end_comment

begin_comment
comment|/*  * Example of the update functionality  *  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_comment
comment|/* dynamic update stuff */
end_comment

begin_function
specifier|static
name|ldns_resolver
modifier|*
name|ldns_update_resolver_new
parameter_list|(
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|,
specifier|const
name|char
modifier|*
name|zone
parameter_list|,
name|ldns_rr_class
name|class
parameter_list|,
name|uint16_t
name|port
parameter_list|,
name|ldns_tsig_credentials
modifier|*
name|tsig_cred
parameter_list|,
name|ldns_rdf
modifier|*
modifier|*
name|zone_rdf
parameter_list|)
block|{
name|ldns_resolver
modifier|*
name|r1
decl_stmt|,
modifier|*
name|r2
decl_stmt|;
name|ldns_pkt
modifier|*
name|query
init|=
name|NULL
decl_stmt|,
modifier|*
name|resp
init|=
name|NULL
decl_stmt|;
name|ldns_rr_list
modifier|*
name|nslist
decl_stmt|,
modifier|*
name|iplist
decl_stmt|;
name|ldns_rdf
modifier|*
name|soa_zone
decl_stmt|,
modifier|*
name|soa_mname
init|=
name|NULL
decl_stmt|,
modifier|*
name|ns_name
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|ldns_status
name|s
decl_stmt|;
if|if
condition|(
name|class
operator|==
literal|0
condition|)
block|{
name|class
operator|=
name|LDNS_RR_CLASS_IN
expr_stmt|;
block|}
if|if
condition|(
name|port
operator|==
literal|0
condition|)
block|{
name|port
operator|=
name|LDNS_PORT
expr_stmt|;
block|}
comment|/* First, get data from /etc/resolv.conf */
name|s
operator|=
name|ldns_resolver_new_frm_file
argument_list|(
operator|&
name|r1
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|r2
operator|=
name|ldns_resolver_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|r2
condition|)
block|{
goto|goto
name|bad
goto|;
block|}
name|ldns_resolver_set_port
argument_list|(
name|r2
argument_list|,
name|port
argument_list|)
expr_stmt|;
comment|/* TSIG key data available? Copy into the resolver. */
if|if
condition|(
name|tsig_cred
condition|)
block|{
name|ldns_resolver_set_tsig_algorithm
argument_list|(
name|r2
argument_list|,
name|ldns_tsig_algorithm
argument_list|(
name|tsig_cred
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_tsig_keyname
argument_list|(
name|r2
argument_list|,
name|ldns_tsig_keyname
argument_list|(
name|tsig_cred
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_tsig_keydata
argument_list|(
name|r2
argument_list|,
name|ldns_tsig_keydata
argument_list|(
name|tsig_cred
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* Now get SOA zone, mname, NS, and construct r2. [RFC2136 4.3] */
comment|/* Explicit 'zone' or no? */
if|if
condition|(
name|zone
condition|)
block|{
name|soa_zone
operator|=
name|ldns_dname_new_frm_str
argument_list|(
name|zone
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_update_soa_mname
argument_list|(
name|soa_zone
argument_list|,
name|r1
argument_list|,
name|class
argument_list|,
operator|&
name|soa_mname
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
goto|goto
name|bad
goto|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|ldns_update_soa_zone_mname
argument_list|(
name|fqdn
argument_list|,
name|r1
argument_list|,
name|class
argument_list|,
operator|&
name|soa_zone
argument_list|,
operator|&
name|soa_mname
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
goto|goto
name|bad
goto|;
block|}
block|}
comment|/* Pass zone_rdf on upwards. */
operator|*
name|zone_rdf
operator|=
name|ldns_rdf_clone
argument_list|(
name|soa_zone
argument_list|)
expr_stmt|;
comment|/* NS */
name|query
operator|=
name|ldns_pkt_query_new
argument_list|(
name|soa_zone
argument_list|,
name|LDNS_RR_TYPE_NS
argument_list|,
name|class
argument_list|,
name|LDNS_RD
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|query
condition|)
block|{
goto|goto
name|bad
goto|;
block|}
name|soa_zone
operator|=
name|NULL
expr_stmt|;
name|ldns_pkt_set_random_id
argument_list|(
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_resolver_send_pkt
argument_list|(
operator|&
name|resp
argument_list|,
name|r1
argument_list|,
name|query
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|dprintf
argument_list|(
literal|"%s"
argument_list|,
literal|"NS query failed!\n"
argument_list|)
expr_stmt|;
goto|goto
name|bad
goto|;
block|}
name|ldns_pkt_free
argument_list|(
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|resp
condition|)
block|{
goto|goto
name|bad
goto|;
block|}
comment|/* Match SOA MNAME to NS list, adding it first */
name|nslist
operator|=
name|ldns_pkt_answer
argument_list|(
name|resp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nslist
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ns_name
operator|=
name|ldns_rr_rdf
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nslist
argument_list|,
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ns_name
condition|)
continue|continue;
if|if
condition|(
name|ldns_rdf_compare
argument_list|(
name|soa_mname
argument_list|,
name|ns_name
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* Match */
name|iplist
operator|=
name|ldns_get_rr_list_addr_by_name
argument_list|(
name|r1
argument_list|,
name|ns_name
argument_list|,
name|class
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_resolver_push_nameserver_rr_list
argument_list|(
name|r2
argument_list|,
name|iplist
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|iplist
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
comment|/* Then all the other NSs. XXX Randomize? */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nslist
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ns_name
operator|=
name|ldns_rr_rdf
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nslist
argument_list|,
name|i
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ns_name
condition|)
continue|continue;
if|if
condition|(
name|ldns_rdf_compare
argument_list|(
name|soa_mname
argument_list|,
name|ns_name
argument_list|)
operator|!=
literal|0
condition|)
block|{
comment|/* No match, add it now. */
name|iplist
operator|=
name|ldns_get_rr_list_addr_by_name
argument_list|(
name|r1
argument_list|,
name|ns_name
argument_list|,
name|class
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_resolver_push_nameserver_rr_list
argument_list|(
name|r2
argument_list|,
name|iplist
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|iplist
argument_list|)
expr_stmt|;
block|}
block|}
name|ldns_resolver_set_random
argument_list|(
name|r2
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
name|ldns_resolver_deep_free
argument_list|(
name|r1
argument_list|)
expr_stmt|;
if|if
condition|(
name|soa_mname
condition|)
name|ldns_rdf_deep_free
argument_list|(
name|soa_mname
argument_list|)
expr_stmt|;
return|return
name|r2
return|;
name|bad
label|:
if|if
condition|(
name|r1
condition|)
name|ldns_resolver_deep_free
argument_list|(
name|r1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r2
condition|)
name|ldns_resolver_deep_free
argument_list|(
name|r2
argument_list|)
expr_stmt|;
if|if
condition|(
name|query
condition|)
name|ldns_pkt_free
argument_list|(
name|query
argument_list|)
expr_stmt|;
if|if
condition|(
name|resp
condition|)
name|ldns_pkt_free
argument_list|(
name|resp
argument_list|)
expr_stmt|;
if|if
condition|(
name|soa_mname
condition|)
name|ldns_rdf_deep_free
argument_list|(
name|soa_mname
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_status
name|ldns_update_send_simple_addr
parameter_list|(
specifier|const
name|char
modifier|*
name|fqdn
parameter_list|,
specifier|const
name|char
modifier|*
name|zone
parameter_list|,
specifier|const
name|char
modifier|*
name|ipaddr
parameter_list|,
name|uint16_t
name|p
parameter_list|,
name|uint32_t
name|ttl
parameter_list|,
name|ldns_tsig_credentials
modifier|*
name|tsig_cred
parameter_list|)
block|{
name|ldns_resolver
modifier|*
name|res
decl_stmt|;
name|ldns_pkt
modifier|*
name|u_pkt
init|=
name|NULL
decl_stmt|,
modifier|*
name|r_pkt
decl_stmt|;
name|ldns_rr_list
modifier|*
name|up_rrlist
decl_stmt|;
name|ldns_rr
modifier|*
name|up_rr
decl_stmt|;
name|ldns_rdf
modifier|*
name|zone_rdf
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|rrstr
decl_stmt|;
name|uint32_t
name|rrstrlen
decl_stmt|,
name|status
init|=
name|LDNS_STATUS_OK
decl_stmt|;
if|if
condition|(
operator|!
name|fqdn
operator|||
name|strlen
argument_list|(
name|fqdn
argument_list|)
operator|==
literal|0
condition|)
return|return
name|LDNS_STATUS_ERR
return|;
comment|/* Create resolver */
name|res
operator|=
name|ldns_update_resolver_new
argument_list|(
name|fqdn
argument_list|,
name|zone
argument_list|,
literal|0
argument_list|,
name|p
argument_list|,
name|tsig_cred
argument_list|,
operator|&
name|zone_rdf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|res
operator|||
operator|!
name|zone_rdf
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
comment|/* Set up the update section. */
name|up_rrlist
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|up_rrlist
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
comment|/* Create input for ldns_rr_new_frm_str() */
if|if
condition|(
name|ipaddr
condition|)
block|{
comment|/* We're adding A or AAAA */
name|rrstrlen
operator|=
name|strlen
argument_list|(
name|fqdn
argument_list|)
operator|+
sizeof|sizeof
argument_list|(
literal|" IN AAAA "
argument_list|)
operator|+
name|strlen
argument_list|(
name|ipaddr
argument_list|)
operator|+
literal|1
expr_stmt|;
name|rrstr
operator|=
operator|(
name|char
operator|*
operator|)
name|malloc
argument_list|(
name|rrstrlen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|rrstr
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|up_rrlist
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|snprintf
argument_list|(
name|rrstr
argument_list|,
name|rrstrlen
argument_list|,
literal|"%s IN %s %s"
argument_list|,
name|fqdn
argument_list|,
name|strchr
argument_list|(
name|ipaddr
argument_list|,
literal|':'
argument_list|)
condition|?
literal|"AAAA"
else|:
literal|"A"
argument_list|,
name|ipaddr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_new_frm_str
argument_list|(
operator|&
name|up_rr
argument_list|,
name|rrstr
argument_list|,
name|ttl
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|up_rrlist
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|rrstr
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|free
argument_list|(
name|rrstr
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|up_rrlist
argument_list|,
name|up_rr
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* We're removing A and/or AAAA from 'fqdn'. [RFC2136 2.5.2] */
name|up_rr
operator|=
name|ldns_rr_new
argument_list|()
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|up_rr
argument_list|,
name|ldns_dname_new_frm_str
argument_list|(
name|fqdn
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_set_ttl
argument_list|(
name|up_rr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_rr_set_class
argument_list|(
name|up_rr
argument_list|,
name|LDNS_RR_CLASS_ANY
argument_list|)
expr_stmt|;
name|ldns_rr_set_type
argument_list|(
name|up_rr
argument_list|,
name|LDNS_RR_TYPE_A
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|up_rrlist
argument_list|,
name|ldns_rr_clone
argument_list|(
name|up_rr
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_set_type
argument_list|(
name|up_rr
argument_list|,
name|LDNS_RR_TYPE_AAAA
argument_list|)
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|up_rrlist
argument_list|,
name|up_rr
argument_list|)
expr_stmt|;
block|}
comment|/* Create update packet. */
name|u_pkt
operator|=
name|ldns_update_pkt_new
argument_list|(
name|zone_rdf
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
name|NULL
argument_list|,
name|up_rrlist
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|zone_rdf
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|u_pkt
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|up_rrlist
argument_list|)
expr_stmt|;
goto|goto
name|cleanup
goto|;
block|}
name|ldns_pkt_set_random_id
argument_list|(
name|u_pkt
argument_list|)
expr_stmt|;
comment|/* Add TSIG */
if|if
condition|(
name|tsig_cred
condition|)
if|if
condition|(
name|ldns_update_pkt_tsig_add
argument_list|(
name|u_pkt
argument_list|,
name|res
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|ldns_resolver_send_pkt
argument_list|(
operator|&
name|r_pkt
argument_list|,
name|res
argument_list|,
name|u_pkt
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
name|ldns_pkt_free
argument_list|(
name|u_pkt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r_pkt
condition|)
block|{
goto|goto
name|cleanup
goto|;
block|}
if|if
condition|(
name|ldns_pkt_get_rcode
argument_list|(
name|r_pkt
argument_list|)
operator|!=
name|LDNS_RCODE_NOERROR
condition|)
block|{
name|ldns_lookup_table
modifier|*
name|t
init|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_rcodes
argument_list|,
operator|(
name|int
operator|)
name|ldns_pkt_get_rcode
argument_list|(
name|r_pkt
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|t
condition|)
block|{
name|dprintf
argument_list|(
literal|";; UPDATE response was %s\n"
argument_list|,
name|t
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dprintf
argument_list|(
literal|";; UPDATE response was (%d)\n"
argument_list|,
name|ldns_pkt_get_rcode
argument_list|(
name|r_pkt
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|status
operator|=
name|LDNS_STATUS_ERR
expr_stmt|;
block|}
name|ldns_pkt_free
argument_list|(
name|r_pkt
argument_list|)
expr_stmt|;
name|ldns_resolver_deep_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
return|return
name|status
return|;
name|cleanup
label|:
if|if
condition|(
name|res
condition|)
name|ldns_resolver_deep_free
argument_list|(
name|res
argument_list|)
expr_stmt|;
if|if
condition|(
name|u_pkt
condition|)
name|ldns_pkt_free
argument_list|(
name|u_pkt
argument_list|)
expr_stmt|;
if|if
condition|(
name|zone_rdf
condition|)
name|ldns_rdf_deep_free
argument_list|(
name|zone_rdf
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_ERR
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
name|char
modifier|*
name|prog
parameter_list|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s domain [zone] ip tsig_name tsig_alg tsig_hmac\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  send a dynamic update packet to<ip>\n\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  Use 'none' instead of ip to remove any previous address\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  If 'zone'  is not specified, try to figure it out from the zone's SOA\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  Example: %s my.example.org 1.2.3.4\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|char
modifier|*
name|fqdn
decl_stmt|,
modifier|*
name|ipaddr
decl_stmt|,
modifier|*
name|zone
decl_stmt|,
modifier|*
name|prog
decl_stmt|;
name|ldns_status
name|ret
decl_stmt|;
name|ldns_tsig_credentials
name|tsig_cr
decl_stmt|,
modifier|*
name|tsig_cred
decl_stmt|;
name|int
name|c
init|=
literal|2
decl_stmt|;
name|uint32_t
name|defttl
init|=
literal|300
decl_stmt|;
name|uint32_t
name|port
init|=
literal|5353
decl_stmt|;
name|prog
operator|=
name|strdup
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|argc
condition|)
block|{
case|case
literal|3
case|:
case|case
literal|4
case|:
case|case
literal|6
case|:
case|case
literal|7
case|:
break|break;
default|default:
name|usage
argument_list|(
name|stderr
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|fqdn
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|c
operator|=
literal|2
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|4
operator|||
name|argc
operator|==
literal|7
condition|)
block|{
name|zone
operator|=
name|argv
index|[
name|c
operator|++
index|]
expr_stmt|;
block|}
else|else
block|{
name|zone
operator|=
name|NULL
expr_stmt|;
block|}
if|if
condition|(
name|strcmp
argument_list|(
name|argv
index|[
name|c
index|]
argument_list|,
literal|"none"
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ipaddr
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|ipaddr
operator|=
name|argv
index|[
name|c
index|]
expr_stmt|;
block|}
name|c
operator|++
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|6
operator|||
name|argc
operator|==
literal|7
condition|)
block|{
name|tsig_cr
operator|.
name|keyname
operator|=
name|argv
index|[
name|c
operator|++
index|]
expr_stmt|;
if|if
condition|(
name|strncasecmp
argument_list|(
name|argv
index|[
name|c
index|]
argument_list|,
literal|"hmac-sha1"
argument_list|,
literal|9
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tsig_cr
operator|.
name|algorithm
operator|=
operator|(
name|char
operator|*
operator|)
literal|"hmac-sha1."
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|strncasecmp
argument_list|(
name|argv
index|[
name|c
index|]
argument_list|,
literal|"hmac-md5"
argument_list|,
literal|8
argument_list|)
operator|==
literal|0
condition|)
block|{
name|tsig_cr
operator|.
name|algorithm
operator|=
operator|(
name|char
operator|*
operator|)
literal|"hmac-md5.sig-alg.reg.int."
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unknown algorithm, try \"hmac-md5\" "
literal|"or \"hmac-sha1\".\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|tsig_cr
operator|.
name|keydata
operator|=
name|argv
index|[
operator|++
name|c
index|]
expr_stmt|;
name|tsig_cred
operator|=
operator|&
name|tsig_cr
expr_stmt|;
block|}
else|else
block|{
name|tsig_cred
operator|=
name|NULL
expr_stmt|;
block|}
name|printf
argument_list|(
literal|";; trying UPDATE with FQDN \"%s\" and IP \"%s\"\n"
argument_list|,
name|fqdn
argument_list|,
name|ipaddr
condition|?
name|ipaddr
else|:
literal|"<none>"
argument_list|)
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|6
operator|||
name|argc
operator|==
literal|7
condition|)
block|{
name|printf
argument_list|(
literal|";; tsig: \"%s\" \"%s\" \"%s\"\n"
argument_list|,
name|tsig_cr
operator|.
name|keyname
argument_list|,
name|tsig_cr
operator|.
name|algorithm
argument_list|,
name|tsig_cr
operator|.
name|keydata
argument_list|)
expr_stmt|;
block|}
name|ret
operator|=
name|ldns_update_send_simple_addr
argument_list|(
name|fqdn
argument_list|,
name|zone
argument_list|,
name|ipaddr
argument_list|,
name|port
argument_list|,
name|defttl
argument_list|,
name|tsig_cred
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ldnsd. Light-weight DNS daemon  *  * Tiny dns server to show how a real one could be built.  *  * (c) NLnet Labs, 2005  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SYS_SOCKET_H
end_ifdef

begin_include
include|#
directive|include
file|<sys/socket.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_ARPA_INET_H
end_ifdef

begin_include
include|#
directive|include
file|<arpa/inet.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETINET_IN_H
end_ifdef

begin_include
include|#
directive|include
file|<netinet/in.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETINET_UDP_H
end_ifdef

begin_include
include|#
directive|include
file|<netinet/udp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_NETINET_IGMP_H
end_ifdef

begin_include
include|#
directive|include
file|<netinet/igmp.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_define
define|#
directive|define
name|INBUF_SIZE
value|4096
end_define

begin_function
name|void
name|usage
parameter_list|(
name|FILE
modifier|*
name|output
parameter_list|)
block|{
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"Usage: ldnsd<address><port><zone><zonefile>\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"Listens on the specified port and answers queries for the given zone\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|output
argument_list|,
literal|"This is NOT a full-fledged authoritative nameserver!\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|udp_bind
parameter_list|(
name|int
name|sock
parameter_list|,
name|int
name|port
parameter_list|,
specifier|const
name|char
modifier|*
name|my_address
parameter_list|)
block|{
name|struct
name|sockaddr_in
name|addr
decl_stmt|;
name|in_addr_t
name|maddr
init|=
name|INADDR_ANY
decl_stmt|;
if|if
condition|(
name|my_address
condition|)
block|{
ifdef|#
directive|ifdef
name|AF_INET6
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET6
argument_list|,
name|my_address
argument_list|,
operator|&
name|maddr
argument_list|)
operator|<
literal|1
condition|)
block|{
else|#
directive|else
if|if
condition|(
literal|0
condition|)
block|{
endif|#
directive|endif
if|if
condition|(
name|inet_pton
argument_list|(
name|AF_INET
argument_list|,
name|my_address
argument_list|,
operator|&
name|maddr
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
operator|-
literal|2
return|;
block|}
block|}
block|}
ifndef|#
directive|ifndef
name|S_SPLINT_S
name|addr
operator|.
name|sin_family
operator|=
name|AF_INET
expr_stmt|;
endif|#
directive|endif
name|addr
operator|.
name|sin_port
operator|=
operator|(
name|in_port_t
operator|)
name|htons
argument_list|(
operator|(
name|uint16_t
operator|)
name|port
argument_list|)
expr_stmt|;
name|addr
operator|.
name|sin_addr
operator|.
name|s_addr
operator|=
name|maddr
expr_stmt|;
return|return
name|bind
argument_list|(
name|sock
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|addr
argument_list|,
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|addr
argument_list|)
argument_list|)
return|;
block|}
comment|/* this will probably be moved to a better place in the library itself */
name|ldns_rr_list
modifier|*
name|get_rrset
parameter_list|(
specifier|const
name|ldns_zone
modifier|*
name|zone
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|owner_name
parameter_list|,
specifier|const
name|ldns_rr_type
name|qtype
parameter_list|,
specifier|const
name|ldns_rr_class
name|qclass
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|;
name|ldns_rr_list
modifier|*
name|rrlist
init|=
name|ldns_rr_list_new
argument_list|()
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_rr
decl_stmt|;
if|if
condition|(
operator|!
name|zone
operator|||
operator|!
name|owner_name
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Warning: get_rrset called with NULL zone or owner name\n"
argument_list|)
expr_stmt|;
return|return
name|rrlist
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_zone_rr_count
argument_list|(
name|zone
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cur_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|ldns_zone_rrs
argument_list|(
name|zone
argument_list|)
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|cur_rr
argument_list|)
argument_list|,
name|owner_name
argument_list|)
operator|==
literal|0
operator|&&
name|ldns_rr_get_class
argument_list|(
name|cur_rr
argument_list|)
operator|==
name|qclass
operator|&&
name|ldns_rr_get_type
argument_list|(
name|cur_rr
argument_list|)
operator|==
name|qtype
condition|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|rrlist
argument_list|,
name|ldns_rr_clone
argument_list|(
name|cur_rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|printf
argument_list|(
literal|"Found rrset of %u rrs\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_rr_list_rr_count
argument_list|(
name|rrlist
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|rrlist
return|;
block|}
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
comment|/* arguments */
name|int
name|port
decl_stmt|;
specifier|const
name|char
modifier|*
name|zone_file
decl_stmt|;
comment|/* network */
name|int
name|sock
decl_stmt|;
name|ssize_t
name|nb
decl_stmt|;
name|struct
name|sockaddr
name|addr_me
decl_stmt|;
name|struct
name|sockaddr
name|addr_him
decl_stmt|;
name|socklen_t
name|hislen
init|=
operator|(
name|socklen_t
operator|)
sizeof|sizeof
argument_list|(
name|addr_him
argument_list|)
decl_stmt|;
name|uint8_t
name|inbuf
index|[
name|INBUF_SIZE
index|]
decl_stmt|;
name|uint8_t
modifier|*
name|outbuf
decl_stmt|;
comment|/* dns */
name|ldns_status
name|status
decl_stmt|;
name|ldns_pkt
modifier|*
name|query_pkt
decl_stmt|;
name|ldns_pkt
modifier|*
name|answer_pkt
decl_stmt|;
name|size_t
name|answer_size
decl_stmt|;
name|ldns_rr
modifier|*
name|query_rr
decl_stmt|;
name|ldns_rr_list
modifier|*
name|answer_qr
decl_stmt|;
name|ldns_rr_list
modifier|*
name|answer_an
decl_stmt|;
name|ldns_rr_list
modifier|*
name|answer_ns
decl_stmt|;
name|ldns_rr_list
modifier|*
name|answer_ad
decl_stmt|;
name|ldns_rdf
modifier|*
name|origin
init|=
name|NULL
decl_stmt|;
comment|/* zone */
name|ldns_zone
modifier|*
name|zone
decl_stmt|;
name|int
name|line_nr
decl_stmt|;
name|FILE
modifier|*
name|zone_fp
decl_stmt|;
comment|/* use this to listen on specified interfaces later? */
name|char
modifier|*
name|my_address
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|argc
operator|<
literal|5
condition|)
block|{
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|my_address
operator|=
name|argv
index|[
literal|1
index|]
expr_stmt|;
name|port
operator|=
name|atoi
argument_list|(
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|<
literal|1
condition|)
block|{
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ldns_str2rdf_dname
argument_list|(
operator|&
name|origin
argument_list|,
name|argv
index|[
literal|3
index|]
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Bad origin, not a correct domain name\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|zone_file
operator|=
name|argv
index|[
literal|4
index|]
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"Reading zone file %s\n"
argument_list|,
name|zone_file
argument_list|)
expr_stmt|;
name|zone_fp
operator|=
name|fopen
argument_list|(
name|zone_file
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|zone_fp
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Unable to open %s: %s\n"
argument_list|,
name|zone_file
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|line_nr
operator|=
literal|0
expr_stmt|;
name|status
operator|=
name|ldns_zone_new_frm_fp_l
argument_list|(
operator|&
name|zone
argument_list|,
name|zone_fp
argument_list|,
name|origin
argument_list|,
literal|0
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
operator|&
name|line_nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"Zone reader failed, aborting\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|printf
argument_list|(
literal|"Read %u resource records in zone file\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_zone_rr_count
argument_list|(
name|zone
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|zone_fp
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Listening on port %d\n"
argument_list|,
name|port
argument_list|)
expr_stmt|;
name|sock
operator|=
name|socket
argument_list|(
name|AF_INET
argument_list|,
name|SOCK_DGRAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|sock
operator|<
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: socket(): %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|memset
argument_list|(
operator|&
name|addr_me
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|addr_me
argument_list|)
argument_list|)
expr_stmt|;
comment|/* bind: try all ports in that range */
if|if
condition|(
name|udp_bind
argument_list|(
name|sock
argument_list|,
name|port
argument_list|,
name|my_address
argument_list|)
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: cannot bind(): %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|errno
argument_list|)
expr_stmt|;
block|}
comment|/* Done. Now receive */
while|while
condition|(
literal|1
condition|)
block|{
name|nb
operator|=
name|recvfrom
argument_list|(
name|sock
argument_list|,
operator|(
name|void
operator|*
operator|)
name|inbuf
argument_list|,
name|INBUF_SIZE
argument_list|,
literal|0
argument_list|,
operator|&
name|addr_him
argument_list|,
operator|&
name|hislen
argument_list|)
expr_stmt|;
if|if
condition|(
name|nb
operator|<
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: recvfrom(): %s\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* 		show(inbuf, nb, nn, hp, sp, ip, bp); 		*/
name|printf
argument_list|(
literal|"Got query of %u bytes\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|nb
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_wire2pkt
argument_list|(
operator|&
name|query_pkt
argument_list|,
name|inbuf
argument_list|,
operator|(
name|size_t
operator|)
name|nb
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"Got bad packet: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
name|query_pkt
argument_list|)
expr_stmt|;
block|}
name|query_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|ldns_pkt_question
argument_list|(
name|query_pkt
argument_list|)
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"QUERY RR: \n"
argument_list|)
expr_stmt|;
name|ldns_rr_print
argument_list|(
name|stdout
argument_list|,
name|query_rr
argument_list|)
expr_stmt|;
name|answer_qr
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|answer_qr
argument_list|,
name|ldns_rr_clone
argument_list|(
name|query_rr
argument_list|)
argument_list|)
expr_stmt|;
name|answer_an
operator|=
name|get_rrset
argument_list|(
name|zone
argument_list|,
name|ldns_rr_owner
argument_list|(
name|query_rr
argument_list|)
argument_list|,
name|ldns_rr_get_type
argument_list|(
name|query_rr
argument_list|)
argument_list|,
name|ldns_rr_get_class
argument_list|(
name|query_rr
argument_list|)
argument_list|)
expr_stmt|;
name|answer_pkt
operator|=
name|ldns_pkt_new
argument_list|()
expr_stmt|;
name|answer_ns
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
name|answer_ad
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
name|ldns_pkt_set_qr
argument_list|(
name|answer_pkt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ldns_pkt_set_aa
argument_list|(
name|answer_pkt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|ldns_pkt_set_id
argument_list|(
name|answer_pkt
argument_list|,
name|ldns_pkt_id
argument_list|(
name|query_pkt
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_push_rr_list
argument_list|(
name|answer_pkt
argument_list|,
name|LDNS_SECTION_QUESTION
argument_list|,
name|answer_qr
argument_list|)
expr_stmt|;
name|ldns_pkt_push_rr_list
argument_list|(
name|answer_pkt
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|,
name|answer_an
argument_list|)
expr_stmt|;
name|ldns_pkt_push_rr_list
argument_list|(
name|answer_pkt
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|,
name|answer_ns
argument_list|)
expr_stmt|;
name|ldns_pkt_push_rr_list
argument_list|(
name|answer_pkt
argument_list|,
name|LDNS_SECTION_ADDITIONAL
argument_list|,
name|answer_ad
argument_list|)
expr_stmt|;
name|status
operator|=
name|ldns_pkt2wire
argument_list|(
operator|&
name|outbuf
argument_list|,
name|answer_pkt
argument_list|,
operator|&
name|answer_size
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"Answer packet size: %u bytes.\n"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|answer_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|printf
argument_list|(
literal|"Error creating answer: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nb
operator|=
name|sendto
argument_list|(
name|sock
argument_list|,
operator|(
name|void
operator|*
operator|)
name|outbuf
argument_list|,
name|answer_size
argument_list|,
literal|0
argument_list|,
operator|&
name|addr_him
argument_list|,
name|hislen
argument_list|)
expr_stmt|;
block|}
name|ldns_pkt_free
argument_list|(
name|query_pkt
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|answer_pkt
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|outbuf
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|answer_qr
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|answer_an
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|answer_ns
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|answer_ad
argument_list|)
expr_stmt|;
block|}
comment|/* No cleanup because of the infinite loop 	 * 	 * ldns_rdf_deep_free(origin); 	 * ldns_zone_deep_free(zone); 	 * return 0; 	 */
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * ldns-signzone signs a zone file  *   * (c) NLnet Labs, 2005 - 2008  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|<stdlib.h>
end_include

begin_include
include|#
directive|include
file|<unistd.h>
end_include

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|<ldns/keys.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_include
include|#
directive|include
file|<openssl/conf.h>
end_include

begin_include
include|#
directive|include
file|<openssl/engine.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_SSL */
end_comment

begin_define
define|#
directive|define
name|MAX_FILENAME_LEN
value|250
end_define

begin_decl_stmt
name|int
name|verbosity
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|FILE
modifier|*
name|fp
parameter_list|,
specifier|const
name|char
modifier|*
name|prog
parameter_list|)
block|{
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"%s [OPTIONS]<domain name>\n"
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"  prints the NSEC3 hash of the given domain name\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"-a [algorithm] hashing algorithm\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"-t [number] number of hash iterations\n"
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|fp
argument_list|,
literal|"-s [string] salt\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
name|argv
index|[]
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|dname
decl_stmt|,
modifier|*
name|hashed_dname
decl_stmt|;
name|uint8_t
name|nsec3_algorithm
init|=
literal|1
decl_stmt|;
name|size_t
name|nsec3_iterations_cmd
init|=
literal|1
decl_stmt|;
name|uint16_t
name|nsec3_iterations
init|=
literal|1
decl_stmt|;
name|uint8_t
name|nsec3_salt_length
init|=
literal|0
decl_stmt|;
name|uint8_t
modifier|*
name|nsec3_salt
init|=
name|NULL
decl_stmt|;
name|char
modifier|*
name|prog
init|=
name|strdup
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
decl_stmt|;
name|int
name|c
decl_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"a:s:t:"
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'a'
case|:
name|nsec3_algorithm
operator|=
operator|(
name|uint8_t
operator|)
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
if|if
condition|(
name|strlen
argument_list|(
name|optarg
argument_list|)
operator|%
literal|2
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Salt value is not valid hex data, not a multiple of 2 characters\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strlen
argument_list|(
name|optarg
argument_list|)
operator|>
literal|512
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Salt too long\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|nsec3_salt_length
operator|=
call|(
name|uint8_t
call|)
argument_list|(
name|strlen
argument_list|(
name|optarg
argument_list|)
operator|/
literal|2
argument_list|)
expr_stmt|;
name|nsec3_salt
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|nsec3_salt_length
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
operator|(
name|int
operator|)
name|strlen
argument_list|(
name|optarg
argument_list|)
condition|;
name|c
operator|+=
literal|2
control|)
block|{
if|if
condition|(
name|isxdigit
argument_list|(
operator|(
name|int
operator|)
name|optarg
index|[
name|c
index|]
argument_list|)
operator|&&
name|isxdigit
argument_list|(
operator|(
name|int
operator|)
name|optarg
index|[
name|c
operator|+
literal|1
index|]
argument_list|)
condition|)
block|{
name|nsec3_salt
index|[
name|c
operator|/
literal|2
index|]
operator|=
operator|(
name|uint8_t
operator|)
name|ldns_hexdigit_to_int
argument_list|(
name|optarg
index|[
name|c
index|]
argument_list|)
operator|*
literal|16
operator|+
name|ldns_hexdigit_to_int
argument_list|(
name|optarg
index|[
name|c
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Salt value is not valid hex data.\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'t'
case|:
name|nsec3_iterations_cmd
operator|=
operator|(
name|size_t
operator|)
name|atol
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
if|if
condition|(
name|nsec3_iterations_cmd
operator|>
name|LDNS_NSEC3_MAX_ITERATIONS
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Iterations count can not exceed %u, quitting\n"
argument_list|,
name|LDNS_NSEC3_MAX_ITERATIONS
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
name|nsec3_iterations
operator|=
operator|(
name|uint16_t
operator|)
name|nsec3_iterations_cmd
expr_stmt|;
break|break;
default|default:
name|usage
argument_list|(
name|stderr
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_SUCCESS
argument_list|)
expr_stmt|;
block|}
block|}
name|argc
operator|-=
name|optind
expr_stmt|;
name|argv
operator|+=
name|optind
expr_stmt|;
if|if
condition|(
name|argc
operator|<
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"Error: not enough arguments\n"
argument_list|)
expr_stmt|;
name|usage
argument_list|(
name|stdout
argument_list|,
name|prog
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|EXIT_FAILURE
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|dname
operator|=
name|ldns_dname_new_frm_str
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dname
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error: unable to parse domain name\n"
argument_list|)
expr_stmt|;
return|return
name|EXIT_FAILURE
return|;
block|}
name|hashed_dname
operator|=
name|ldns_nsec3_hash_name
argument_list|(
name|dname
argument_list|,
name|nsec3_algorithm
argument_list|,
name|nsec3_iterations
argument_list|,
name|nsec3_salt_length
argument_list|,
name|nsec3_salt
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|hashed_dname
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error creating NSEC3 hash\n"
argument_list|)
expr_stmt|;
return|return
name|EXIT_FAILURE
return|;
block|}
name|ldns_rdf_print
argument_list|(
name|stdout
argument_list|,
name|hashed_dname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|dname
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|hashed_dname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|nsec3_salt
condition|)
block|{
name|free
argument_list|(
name|nsec3_salt
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|prog
argument_list|)
expr_stmt|;
return|return
name|EXIT_SUCCESS
return|;
block|}
end_function

end_unit


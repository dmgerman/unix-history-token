begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* winduni.c -- unicode support for the windres program.    Copyright 1997, 1998, 2000, 2001, 2003, 2007    Free Software Foundation, Inc.    Written by Ian Lance Taylor, Cygnus Support.    Rewritten by Kai Tietz, Onevision.     This file is part of GNU Binutils.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2 of the License, or    (at your option) any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston, MA    02110-1301, USA.  */
end_comment

begin_comment
comment|/* This file contains unicode support routines for the windres    program.  Ideally, we would have generic unicode support which    would work on all systems.  However, we don't.  Instead, on a    Windows host, we are prepared to call some Windows routines.  This    means that we will generate different output on Windows and Unix    hosts, but that seems better than not really supporting unicode at    all.  */
end_comment

begin_include
include|#
directive|include
file|"sysdep.h"
end_include

begin_include
include|#
directive|include
file|"bfd.h"
end_include

begin_include
include|#
directive|include
file|"libiberty.h"
end_include

begin_comment
comment|/* for xstrdup */
end_comment

begin_include
include|#
directive|include
file|"bucomm.h"
end_include

begin_comment
comment|/* Must be include before windows.h and winnls.h.  */
end_comment

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|||
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
end_if

begin_include
include|#
directive|include
file|<windows.h>
end_include

begin_include
include|#
directive|include
file|<winnls.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"winduni.h"
end_include

begin_include
include|#
directive|include
file|"safe-ctype.h"
end_include

begin_if
if|#
directive|if
name|HAVE_ICONV_H
end_if

begin_include
include|#
directive|include
file|<iconv.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|static
name|rc_uint_type
name|wind_WideCharToMultiByte
parameter_list|(
name|rc_uint_type
parameter_list|,
specifier|const
name|unichar
modifier|*
parameter_list|,
name|char
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|rc_uint_type
name|wind_MultiByteToWideChar
parameter_list|(
name|rc_uint_type
parameter_list|,
specifier|const
name|char
modifier|*
parameter_list|,
name|unichar
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
specifier|static
name|int
name|unichar_isascii
parameter_list|(
specifier|const
name|unichar
modifier|*
parameter_list|,
name|rc_uint_type
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/* Convert an ASCII string to a unicode string.  We just copy it,    expanding chars to shorts, rather than doing something intelligent.  */
end_comment

begin_if
if|#
directive|if
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
end_if

begin_comment
comment|/* Codepages mapped.  */
end_comment

begin_decl_stmt
specifier|static
name|local_iconv_map
name|codepages
index|[]
init|=
block|{
block|{
literal|0
block|,
literal|"MS-ANSI"
block|}
block|,
block|{
literal|1
block|,
literal|"WINDOWS-1252"
block|}
block|,
block|{
literal|437
block|,
literal|"MS-ANSI"
block|}
block|,
block|{
literal|737
block|,
literal|"MS-GREEK"
block|}
block|,
block|{
literal|775
block|,
literal|"WINBALTRIM"
block|}
block|,
block|{
literal|850
block|,
literal|"MS-ANSI"
block|}
block|,
block|{
literal|852
block|,
literal|"MS-EE"
block|}
block|,
block|{
literal|857
block|,
literal|"MS-TURK"
block|}
block|,
block|{
literal|862
block|,
literal|"CP862"
block|}
block|,
block|{
literal|864
block|,
literal|"CP864"
block|}
block|,
block|{
literal|866
block|,
literal|"MS-CYRL"
block|}
block|,
block|{
literal|874
block|,
literal|"WINDOWS-874"
block|}
block|,
block|{
literal|932
block|,
literal|"CP932"
block|}
block|,
block|{
literal|936
block|,
literal|"CP936"
block|}
block|,
block|{
literal|949
block|,
literal|"CP949"
block|}
block|,
block|{
literal|950
block|,
literal|"CP950"
block|}
block|,
block|{
literal|1250
block|,
literal|"WINDOWS-1250"
block|}
block|,
block|{
literal|1251
block|,
literal|"WINDOWS-1251"
block|}
block|,
block|{
literal|1252
block|,
literal|"WINDOWS-1252"
block|}
block|,
block|{
literal|1253
block|,
literal|"WINDOWS-1253"
block|}
block|,
block|{
literal|1254
block|,
literal|"WINDOWS-1254"
block|}
block|,
block|{
literal|1255
block|,
literal|"WINDOWS-1255"
block|}
block|,
block|{
literal|1256
block|,
literal|"WINDOWS-1256"
block|}
block|,
block|{
literal|1257
block|,
literal|"WINDOWS-1257"
block|}
block|,
block|{
literal|1258
block|,
literal|"WINDOWS-1258"
block|}
block|,
block|{
name|CP_UTF7
block|,
literal|"UTF-7"
block|}
block|,
block|{
name|CP_UTF8
block|,
literal|"UTF-8"
block|}
block|,
block|{
name|CP_UTF16
block|,
literal|"UTF-16"
block|}
block|,
block|{
operator|(
name|rc_uint_type
operator|)
operator|-
literal|1
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Languages supported.  */
end_comment

begin_decl_stmt
specifier|static
specifier|const
name|wind_language_t
name|languages
index|[]
init|=
block|{
block|{
literal|0x0000
block|,
literal|437
block|,
literal|1252
block|,
literal|"Neutral"
block|,
literal|"Neutral"
block|}
block|,
block|{
literal|0x0401
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Saudi Arabia"
block|}
block|,
block|{
literal|0x0402
block|,
literal|866
block|,
literal|1251
block|,
literal|"Bulgarian"
block|,
literal|"Bulgaria"
block|}
block|,
block|{
literal|0x0403
block|,
literal|850
block|,
literal|1252
block|,
literal|"Catalan"
block|,
literal|"Spain"
block|}
block|,
block|{
literal|0x0404
block|,
literal|950
block|,
literal|950
block|,
literal|"Chinese"
block|,
literal|"Taiwan"
block|}
block|,
block|{
literal|0x0405
block|,
literal|852
block|,
literal|1250
block|,
literal|"Czech"
block|,
literal|"Czech Republic"
block|}
block|,
block|{
literal|0x0406
block|,
literal|850
block|,
literal|1252
block|,
literal|"Danish"
block|,
literal|"Denmark"
block|}
block|,
block|{
literal|0x0407
block|,
literal|850
block|,
literal|1252
block|,
literal|"German"
block|,
literal|"Germany"
block|}
block|,
block|{
literal|0x0408
block|,
literal|737
block|,
literal|1253
block|,
literal|"Greek"
block|,
literal|"Greece"
block|}
block|,
block|{
literal|0x0409
block|,
literal|437
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"United States"
block|}
block|,
block|{
literal|0x040A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish - Traditional Sort"
block|,
literal|"Spain"
block|}
block|,
block|{
literal|0x040B
block|,
literal|850
block|,
literal|1252
block|,
literal|"Finnish"
block|,
literal|"Finland"
block|}
block|,
block|{
literal|0x040C
block|,
literal|850
block|,
literal|1252
block|,
literal|"French"
block|,
literal|"France"
block|}
block|,
block|{
literal|0x040D
block|,
literal|862
block|,
literal|1255
block|,
literal|"Hebrew"
block|,
literal|"Israel"
block|}
block|,
block|{
literal|0x040E
block|,
literal|852
block|,
literal|1250
block|,
literal|"Hungarian"
block|,
literal|"Hungary"
block|}
block|,
block|{
literal|0x040F
block|,
literal|850
block|,
literal|1252
block|,
literal|"Icelandic"
block|,
literal|"Iceland"
block|}
block|,
block|{
literal|0x0410
block|,
literal|850
block|,
literal|1252
block|,
literal|"Italian"
block|,
literal|"Italy"
block|}
block|,
block|{
literal|0x0411
block|,
literal|932
block|,
literal|932
block|,
literal|"Japanese"
block|,
literal|"Japan"
block|}
block|,
block|{
literal|0x0412
block|,
literal|949
block|,
literal|949
block|,
literal|"Korean"
block|,
literal|"Korea (south)"
block|}
block|,
block|{
literal|0x0413
block|,
literal|850
block|,
literal|1252
block|,
literal|"Dutch"
block|,
literal|"Netherlands"
block|}
block|,
block|{
literal|0x0414
block|,
literal|850
block|,
literal|1252
block|,
literal|"Norwegian (Bokm√•l)"
block|,
literal|"Norway"
block|}
block|,
block|{
literal|0x0415
block|,
literal|852
block|,
literal|1250
block|,
literal|"Polish"
block|,
literal|"Poland"
block|}
block|,
block|{
literal|0x0416
block|,
literal|850
block|,
literal|1252
block|,
literal|"Portuguese"
block|,
literal|"Brazil"
block|}
block|,
block|{
literal|0x0418
block|,
literal|852
block|,
literal|1250
block|,
literal|"Romanian"
block|,
literal|"Romania"
block|}
block|,
block|{
literal|0x0419
block|,
literal|866
block|,
literal|1251
block|,
literal|"Russian"
block|,
literal|"Russia"
block|}
block|,
block|{
literal|0x041A
block|,
literal|852
block|,
literal|1250
block|,
literal|"Croatian"
block|,
literal|"Croatia"
block|}
block|,
block|{
literal|0x041B
block|,
literal|852
block|,
literal|1250
block|,
literal|"Slovak"
block|,
literal|"Slovakia"
block|}
block|,
block|{
literal|0x041C
block|,
literal|852
block|,
literal|1250
block|,
literal|"Albanian"
block|,
literal|"Albania"
block|}
block|,
block|{
literal|0x041D
block|,
literal|850
block|,
literal|1252
block|,
literal|"Swedish"
block|,
literal|"Sweden"
block|}
block|,
block|{
literal|0x041E
block|,
literal|874
block|,
literal|874
block|,
literal|"Thai"
block|,
literal|"Thailand"
block|}
block|,
block|{
literal|0x041F
block|,
literal|857
block|,
literal|1254
block|,
literal|"Turkish"
block|,
literal|"Turkey"
block|}
block|,
block|{
literal|0x0421
block|,
literal|850
block|,
literal|1252
block|,
literal|"Indonesian"
block|,
literal|"Indonesia"
block|}
block|,
block|{
literal|0x0422
block|,
literal|866
block|,
literal|1251
block|,
literal|"Ukrainian"
block|,
literal|"Ukraine"
block|}
block|,
block|{
literal|0x0423
block|,
literal|866
block|,
literal|1251
block|,
literal|"Belarusian"
block|,
literal|"Belarus"
block|}
block|,
block|{
literal|0x0424
block|,
literal|852
block|,
literal|1250
block|,
literal|"Slovene"
block|,
literal|"Slovenia"
block|}
block|,
block|{
literal|0x0425
block|,
literal|775
block|,
literal|1257
block|,
literal|"Estonian"
block|,
literal|"Estonia"
block|}
block|,
block|{
literal|0x0426
block|,
literal|775
block|,
literal|1257
block|,
literal|"Latvian"
block|,
literal|"Latvia"
block|}
block|,
block|{
literal|0x0427
block|,
literal|775
block|,
literal|1257
block|,
literal|"Lithuanian"
block|,
literal|"Lithuania"
block|}
block|,
block|{
literal|0x0429
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Farsi"
block|}
block|,
block|{
literal|0x042A
block|,
literal|1258
block|,
literal|1258
block|,
literal|"Vietnamese"
block|,
literal|"Vietnam"
block|}
block|,
block|{
literal|0x042D
block|,
literal|850
block|,
literal|1252
block|,
literal|"Basque"
block|,
literal|"Spain"
block|}
block|,
block|{
literal|0x042F
block|,
literal|866
block|,
literal|1251
block|,
literal|"Macedonian"
block|,
literal|"Former Yugoslav Republic of Macedonia"
block|}
block|,
block|{
literal|0x0436
block|,
literal|850
block|,
literal|1252
block|,
literal|"Afrikaans"
block|,
literal|"South Africa"
block|}
block|,
block|{
literal|0x0438
block|,
literal|850
block|,
literal|1252
block|,
literal|"Faroese"
block|,
literal|"Faroe Islands"
block|}
block|,
block|{
literal|0x043C
block|,
literal|437
block|,
literal|1252
block|,
literal|"Irish"
block|,
literal|"Ireland"
block|}
block|,
block|{
literal|0x043E
block|,
literal|850
block|,
literal|1252
block|,
literal|"Malay"
block|,
literal|"Malaysia"
block|}
block|,
block|{
literal|0x0801
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Iraq"
block|}
block|,
block|{
literal|0x0804
block|,
literal|936
block|,
literal|936
block|,
literal|"Chinese (People's republic of China)"
block|,
literal|"People's republic of China"
block|}
block|,
block|{
literal|0x0807
block|,
literal|850
block|,
literal|1252
block|,
literal|"German"
block|,
literal|"Switzerland"
block|}
block|,
block|{
literal|0x0809
block|,
literal|850
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"United Kingdom"
block|}
block|,
block|{
literal|0x080A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Mexico"
block|}
block|,
block|{
literal|0x080C
block|,
literal|850
block|,
literal|1252
block|,
literal|"French"
block|,
literal|"Belgium"
block|}
block|,
block|{
literal|0x0810
block|,
literal|850
block|,
literal|1252
block|,
literal|"Italian"
block|,
literal|"Switzerland"
block|}
block|,
block|{
literal|0x0813
block|,
literal|850
block|,
literal|1252
block|,
literal|"Dutch"
block|,
literal|"Belgium"
block|}
block|,
block|{
literal|0x0814
block|,
literal|850
block|,
literal|1252
block|,
literal|"Norwegian (Nynorsk)"
block|,
literal|"Norway"
block|}
block|,
block|{
literal|0x0816
block|,
literal|850
block|,
literal|1252
block|,
literal|"Portuguese"
block|,
literal|"Portugal"
block|}
block|,
block|{
literal|0x081A
block|,
literal|852
block|,
literal|1252
block|,
literal|"Serbian (latin)"
block|,
literal|"Yugoslavia"
block|}
block|,
block|{
literal|0x081D
block|,
literal|850
block|,
literal|1252
block|,
literal|"Swedish (Finland)"
block|,
literal|"Finland"
block|}
block|,
block|{
literal|0x0C01
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Egypt"
block|}
block|,
block|{
literal|0x0C04
block|,
literal|950
block|,
literal|950
block|,
literal|"Chinese"
block|,
literal|"Hong Kong"
block|}
block|,
block|{
literal|0x0C07
block|,
literal|850
block|,
literal|1252
block|,
literal|"German"
block|,
literal|"Austria"
block|}
block|,
block|{
literal|0x0C09
block|,
literal|850
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"Australia"
block|}
block|,
block|{
literal|0x0C0A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish - International Sort"
block|,
literal|"Spain"
block|}
block|,
block|{
literal|0x0C0C
block|,
literal|850
block|,
literal|1252
block|,
literal|"French"
block|,
literal|"Canada"
block|}
block|,
block|{
literal|0x0C1A
block|,
literal|855
block|,
literal|1251
block|,
literal|"Serbian (Cyrillic)"
block|,
literal|"Serbia"
block|}
block|,
block|{
literal|0x1001
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Libya"
block|}
block|,
block|{
literal|0x1004
block|,
literal|936
block|,
literal|936
block|,
literal|"Chinese"
block|,
literal|"Singapore"
block|}
block|,
block|{
literal|0x1007
block|,
literal|850
block|,
literal|1252
block|,
literal|"German"
block|,
literal|"Luxembourg"
block|}
block|,
block|{
literal|0x1009
block|,
literal|850
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"Canada"
block|}
block|,
block|{
literal|0x100A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Guatemala"
block|}
block|,
block|{
literal|0x100C
block|,
literal|850
block|,
literal|1252
block|,
literal|"French"
block|,
literal|"Switzerland"
block|}
block|,
block|{
literal|0x1401
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Algeria"
block|}
block|,
block|{
literal|0x1407
block|,
literal|850
block|,
literal|1252
block|,
literal|"German"
block|,
literal|"Liechtenstein"
block|}
block|,
block|{
literal|0x1409
block|,
literal|850
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"New Zealand"
block|}
block|,
block|{
literal|0x140A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Costa Rica"
block|}
block|,
block|{
literal|0x140C
block|,
literal|850
block|,
literal|1252
block|,
literal|"French"
block|,
literal|"Luxembourg"
block|}
block|,
block|{
literal|0x1801
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Morocco"
block|}
block|,
block|{
literal|0x1809
block|,
literal|850
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"Ireland"
block|}
block|,
block|{
literal|0x180A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Panama"
block|}
block|,
block|{
literal|0x180C
block|,
literal|850
block|,
literal|1252
block|,
literal|"French"
block|,
literal|"Monaco"
block|}
block|,
block|{
literal|0x1C01
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Tunisia"
block|}
block|,
block|{
literal|0x1C09
block|,
literal|437
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"South Africa"
block|}
block|,
block|{
literal|0x1C0A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Dominican Republic"
block|}
block|,
block|{
literal|0x2001
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Oman"
block|}
block|,
block|{
literal|0x2009
block|,
literal|850
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"Jamaica"
block|}
block|,
block|{
literal|0x200A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Venezuela"
block|}
block|,
block|{
literal|0x2401
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Yemen"
block|}
block|,
block|{
literal|0x2409
block|,
literal|850
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"Caribbean"
block|}
block|,
block|{
literal|0x240A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Colombia"
block|}
block|,
block|{
literal|0x2801
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Syria"
block|}
block|,
block|{
literal|0x2809
block|,
literal|850
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"Belize"
block|}
block|,
block|{
literal|0x280A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Peru"
block|}
block|,
block|{
literal|0x2C01
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Jordan"
block|}
block|,
block|{
literal|0x2C09
block|,
literal|437
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"Trinidad& Tobago"
block|}
block|,
block|{
literal|0x2C0A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Argentina"
block|}
block|,
block|{
literal|0x3001
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Lebanon"
block|}
block|,
block|{
literal|0x3009
block|,
literal|437
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"Zimbabwe"
block|}
block|,
block|{
literal|0x300A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Ecuador"
block|}
block|,
block|{
literal|0x3401
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Kuwait"
block|}
block|,
block|{
literal|0x3409
block|,
literal|437
block|,
literal|1252
block|,
literal|"English"
block|,
literal|"Philippines"
block|}
block|,
block|{
literal|0x340A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Chile"
block|}
block|,
block|{
literal|0x3801
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"United Arab Emirates"
block|}
block|,
block|{
literal|0x380A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Uruguay"
block|}
block|,
block|{
literal|0x3C01
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Bahrain"
block|}
block|,
block|{
literal|0x3C0A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Paraguay"
block|}
block|,
block|{
literal|0x4001
block|,
literal|864
block|,
literal|1256
block|,
literal|"Arabic"
block|,
literal|"Qatar"
block|}
block|,
block|{
literal|0x400A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Bolivia"
block|}
block|,
block|{
literal|0x440A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"El Salvador"
block|}
block|,
block|{
literal|0x480A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Honduras"
block|}
block|,
block|{
literal|0x4C0A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Nicaragua"
block|}
block|,
block|{
literal|0x500A
block|,
literal|850
block|,
literal|1252
block|,
literal|"Spanish"
block|,
literal|"Puerto Rico"
block|}
block|,
block|{
operator|(
name|unsigned
operator|)
operator|-
literal|1
block|,
literal|0
block|,
literal|0
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Specifies the default codepage to be used for unicode    transformations.  By default this is CP_ACP.  */
end_comment

begin_decl_stmt
name|rc_uint_type
name|wind_default_codepage
init|=
name|CP_ACP
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Specifies the currently used codepage for unicode    transformations.  By default this is CP_ACP.  */
end_comment

begin_decl_stmt
name|rc_uint_type
name|wind_current_codepage
init|=
name|CP_ACP
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Convert an ASCII string to a unicode string.  We just copy it,    expanding chars to shorts, rather than doing something intelligent.  */
end_comment

begin_function
name|void
name|unicode_from_ascii
parameter_list|(
name|rc_uint_type
modifier|*
name|length
parameter_list|,
name|unichar
modifier|*
modifier|*
name|unicode
parameter_list|,
specifier|const
name|char
modifier|*
name|ascii
parameter_list|)
block|{
name|unicode_from_codepage
argument_list|(
name|length
argument_list|,
name|unicode
argument_list|,
name|ascii
argument_list|,
name|wind_current_codepage
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Convert an unicode string to an ASCII string.  We just copy it,    shrink shorts to chars, rather than doing something intelligent.    Shorts with not within the char range are replaced by '_'.  */
end_comment

begin_function
name|void
name|ascii_from_unicode
parameter_list|(
name|rc_uint_type
modifier|*
name|length
parameter_list|,
specifier|const
name|unichar
modifier|*
name|unicode
parameter_list|,
name|char
modifier|*
modifier|*
name|ascii
parameter_list|)
block|{
name|codepage_from_unicode
argument_list|(
name|length
argument_list|,
name|unicode
argument_list|,
name|ascii
argument_list|,
name|wind_current_codepage
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Print the unicode string UNICODE to the file E.  LENGTH is the    number of characters to print, or -1 if we should print until the    end of the string.  FIXME: On a Windows host, we should be calling    some Windows function, probably WideCharToMultiByte.  */
end_comment

begin_function
name|void
name|unicode_print
parameter_list|(
name|FILE
modifier|*
name|e
parameter_list|,
specifier|const
name|unichar
modifier|*
name|unicode
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
while|while
condition|(
literal|1
condition|)
block|{
name|unichar
name|ch
decl_stmt|;
if|if
condition|(
name|length
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|bfd_signed_vma
operator|)
name|length
operator|>
literal|0
condition|)
operator|--
name|length
expr_stmt|;
name|ch
operator|=
operator|*
name|unicode
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|0
operator|&&
operator|(
name|bfd_signed_vma
operator|)
name|length
operator|<
literal|0
condition|)
return|return;
operator|++
name|unicode
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|&
literal|0x7f
operator|)
operator|==
name|ch
condition|)
block|{
if|if
condition|(
name|ch
operator|==
literal|'\\'
condition|)
name|fputs
argument_list|(
literal|"\\\\"
argument_list|,
name|e
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'"'
condition|)
name|fputs
argument_list|(
literal|"\"\""
argument_list|,
name|e
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ISPRINT
argument_list|(
name|ch
argument_list|)
condition|)
name|putc
argument_list|(
name|ch
argument_list|,
name|e
argument_list|)
expr_stmt|;
else|else
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|ESCAPE_A
case|:
name|fputs
argument_list|(
literal|"\\a"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_B
case|:
name|fputs
argument_list|(
literal|"\\b"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_F
case|:
name|fputs
argument_list|(
literal|"\\f"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_N
case|:
name|fputs
argument_list|(
literal|"\\n"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_R
case|:
name|fputs
argument_list|(
literal|"\\r"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_T
case|:
name|fputs
argument_list|(
literal|"\\t"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_V
case|:
name|fputs
argument_list|(
literal|"\\v"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|e
argument_list|,
literal|"\\%03o"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ch
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
elseif|else
if|if
condition|(
operator|(
name|ch
operator|&
literal|0xff
operator|)
operator|==
name|ch
condition|)
name|fprintf
argument_list|(
name|e
argument_list|,
literal|"\\%03o"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ch
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|e
argument_list|,
literal|"\\x%04x"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ch
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Print a unicode string to a file.  */
end_comment

begin_function
name|void
name|ascii_print
parameter_list|(
name|FILE
modifier|*
name|e
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|rc_uint_type
name|length
parameter_list|)
block|{
while|while
condition|(
literal|1
condition|)
block|{
name|char
name|ch
decl_stmt|;
if|if
condition|(
name|length
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
operator|(
name|bfd_signed_vma
operator|)
name|length
operator|>
literal|0
condition|)
operator|--
name|length
expr_stmt|;
name|ch
operator|=
operator|*
name|s
expr_stmt|;
if|if
condition|(
name|ch
operator|==
literal|0
operator|&&
operator|(
name|bfd_signed_vma
operator|)
name|length
operator|<
literal|0
condition|)
return|return;
operator|++
name|s
expr_stmt|;
if|if
condition|(
operator|(
name|ch
operator|&
literal|0x7f
operator|)
operator|==
name|ch
condition|)
block|{
if|if
condition|(
name|ch
operator|==
literal|'\\'
condition|)
name|fputs
argument_list|(
literal|"\\\\"
argument_list|,
name|e
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'"'
condition|)
name|fputs
argument_list|(
literal|"\"\""
argument_list|,
name|e
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|ISPRINT
argument_list|(
name|ch
argument_list|)
condition|)
name|putc
argument_list|(
name|ch
argument_list|,
name|e
argument_list|)
expr_stmt|;
else|else
block|{
switch|switch
condition|(
name|ch
condition|)
block|{
case|case
name|ESCAPE_A
case|:
name|fputs
argument_list|(
literal|"\\a"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_B
case|:
name|fputs
argument_list|(
literal|"\\b"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_F
case|:
name|fputs
argument_list|(
literal|"\\f"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_N
case|:
name|fputs
argument_list|(
literal|"\\n"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_R
case|:
name|fputs
argument_list|(
literal|"\\r"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_T
case|:
name|fputs
argument_list|(
literal|"\\t"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
case|case
name|ESCAPE_V
case|:
name|fputs
argument_list|(
literal|"\\v"
argument_list|,
name|e
argument_list|)
expr_stmt|;
break|break;
default|default:
name|fprintf
argument_list|(
name|e
argument_list|,
literal|"\\%03o"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ch
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
else|else
name|fprintf
argument_list|(
name|e
argument_list|,
literal|"\\%03o"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ch
operator|&
literal|0xff
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|rc_uint_type
name|unichar_len
parameter_list|(
specifier|const
name|unichar
modifier|*
name|unicode
parameter_list|)
block|{
name|rc_uint_type
name|r
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|unicode
condition|)
while|while
condition|(
name|unicode
index|[
name|r
index|]
operator|!=
literal|0
condition|)
name|r
operator|++
expr_stmt|;
else|else
operator|--
name|r
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|unichar
modifier|*
name|unichar_dup
parameter_list|(
specifier|const
name|unichar
modifier|*
name|unicode
parameter_list|)
block|{
name|unichar
modifier|*
name|r
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|!
name|unicode
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|len
operator|=
literal|0
init|;
name|unicode
index|[
name|len
index|]
operator|!=
literal|0
condition|;
operator|++
name|len
control|)
empty_stmt|;
operator|++
name|len
expr_stmt|;
name|r
operator|=
operator|(
operator|(
name|unichar
operator|*
operator|)
name|res_alloc
argument_list|(
name|len
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
operator|)
expr_stmt|;
name|memcpy
argument_list|(
name|r
argument_list|,
name|unicode
argument_list|,
name|len
operator|*
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|unichar
modifier|*
name|unichar_dup_uppercase
parameter_list|(
specifier|const
name|unichar
modifier|*
name|u
parameter_list|)
block|{
name|unichar
modifier|*
name|r
init|=
name|unichar_dup
argument_list|(
name|u
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|r
index|[
name|i
index|]
operator|!=
literal|0
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|r
index|[
name|i
index|]
operator|>=
literal|'a'
operator|&&
name|r
index|[
name|i
index|]
operator|<=
literal|'z'
condition|)
name|r
index|[
name|i
index|]
operator|&=
literal|0xdf
expr_stmt|;
block|}
return|return
name|r
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|unichar_isascii
parameter_list|(
specifier|const
name|unichar
modifier|*
name|u
parameter_list|,
name|rc_uint_type
name|len
parameter_list|)
block|{
name|rc_uint_type
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|bfd_signed_vma
operator|)
name|len
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|u
condition|)
name|len
operator|=
operator|(
name|rc_uint_type
operator|)
name|unichar_len
argument_list|(
name|u
argument_list|)
expr_stmt|;
else|else
name|len
operator|=
literal|0
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
if|if
condition|(
operator|(
name|u
index|[
name|i
index|]
operator|&
literal|0xff80
operator|)
operator|!=
literal|0
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|unicode_print_quoted
parameter_list|(
name|FILE
modifier|*
name|e
parameter_list|,
specifier|const
name|unichar
modifier|*
name|u
parameter_list|,
name|rc_uint_type
name|len
parameter_list|)
block|{
if|if
condition|(
operator|!
name|unichar_isascii
argument_list|(
name|u
argument_list|,
name|len
argument_list|)
condition|)
name|fputc
argument_list|(
literal|'L'
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
literal|'"'
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|unicode_print
argument_list|(
name|e
argument_list|,
name|u
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
literal|'"'
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|unicode_is_valid_codepage
parameter_list|(
name|rc_uint_type
name|cp
parameter_list|)
block|{
if|if
condition|(
operator|(
name|cp
operator|&
literal|0xffff
operator|)
operator|!=
name|cp
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|cp
operator|==
name|CP_UTF16
operator|||
name|cp
operator|==
name|CP_ACP
condition|)
return|return
literal|1
return|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
if|if
condition|(
operator|!
name|wind_find_codepage_info
argument_list|(
name|cp
argument_list|)
condition|)
return|return
literal|0
return|;
return|return
literal|1
return|;
else|#
directive|else
return|return
operator|!
operator|!
name|IsValidCodePage
argument_list|(
operator|(
name|UINT
operator|)
name|cp
argument_list|)
return|;
endif|#
directive|endif
block|}
end_function

begin_if
if|#
directive|if
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|||
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
end_if

begin_define
define|#
directive|define
name|max_cp_string_len
value|6
end_define

begin_function
specifier|static
name|unsigned
name|int
name|codepage_from_langid
parameter_list|(
name|unsigned
name|short
name|langid
parameter_list|)
block|{
name|char
name|cp_string
index|[
name|max_cp_string_len
index|]
decl_stmt|;
name|int
name|c
decl_stmt|;
name|memset
argument_list|(
name|cp_string
argument_list|,
literal|0
argument_list|,
name|max_cp_string_len
argument_list|)
expr_stmt|;
comment|/* LOCALE_RETURN_NUMBER flag would avoid strtoul conversion,      but is unavailable on Win95.  */
name|c
operator|=
name|GetLocaleInfoA
argument_list|(
name|MAKELCID
argument_list|(
name|langid
argument_list|,
name|SORT_DEFAULT
argument_list|)
argument_list|,
name|LOCALE_IDEFAULTANSICODEPAGE
argument_list|,
name|cp_string
argument_list|,
name|max_cp_string_len
argument_list|)
expr_stmt|;
comment|/* If codepage data for an LCID is not installed on users's system,      GetLocaleInfo returns an empty string.  Fall back to system ANSI      default. */
if|if
condition|(
name|c
operator|==
literal|0
condition|)
return|return
name|CP_ACP
return|;
return|return
name|strtoul
argument_list|(
name|cp_string
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|unsigned
name|int
name|wincodepage_from_langid
parameter_list|(
name|unsigned
name|short
name|langid
parameter_list|)
block|{
name|char
name|cp_string
index|[
name|max_cp_string_len
index|]
decl_stmt|;
name|int
name|c
decl_stmt|;
name|memset
argument_list|(
name|cp_string
argument_list|,
literal|0
argument_list|,
name|max_cp_string_len
argument_list|)
expr_stmt|;
comment|/* LOCALE_RETURN_NUMBER flag would avoid strtoul conversion,      but is unavailable on Win95.  */
name|c
operator|=
name|GetLocaleInfoA
argument_list|(
name|MAKELCID
argument_list|(
name|langid
argument_list|,
name|SORT_DEFAULT
argument_list|)
argument_list|,
name|LOCALE_IDEFAULTCODEPAGE
argument_list|,
name|cp_string
argument_list|,
name|max_cp_string_len
argument_list|)
expr_stmt|;
comment|/* If codepage data for an LCID is not installed on users's system,      GetLocaleInfo returns an empty string.  Fall back to system ANSI      default. */
if|if
condition|(
name|c
operator|==
literal|0
condition|)
return|return
name|CP_OEM
return|;
return|return
name|strtoul
argument_list|(
name|cp_string
argument_list|,
literal|0
argument_list|,
literal|10
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|lang_from_langid
parameter_list|(
name|unsigned
name|short
name|langid
parameter_list|)
block|{
name|char
name|cp_string
index|[
literal|261
index|]
decl_stmt|;
name|int
name|c
decl_stmt|;
name|memset
argument_list|(
name|cp_string
argument_list|,
literal|0
argument_list|,
literal|261
argument_list|)
expr_stmt|;
name|c
operator|=
name|GetLocaleInfoA
argument_list|(
name|MAKELCID
argument_list|(
name|langid
argument_list|,
name|SORT_DEFAULT
argument_list|)
argument_list|,
name|LOCALE_SENGLANGUAGE
argument_list|,
name|cp_string
argument_list|,
literal|260
argument_list|)
expr_stmt|;
comment|/* If codepage data for an LCID is not installed on users's system,      GetLocaleInfo returns an empty string.  Fall back to system ANSI      default. */
if|if
condition|(
name|c
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|cp_string
argument_list|,
literal|"Neutral"
argument_list|)
expr_stmt|;
return|return
name|xstrdup
argument_list|(
name|cp_string
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|country_from_langid
parameter_list|(
name|unsigned
name|short
name|langid
parameter_list|)
block|{
name|char
name|cp_string
index|[
literal|261
index|]
decl_stmt|;
name|int
name|c
decl_stmt|;
name|memset
argument_list|(
name|cp_string
argument_list|,
literal|0
argument_list|,
literal|261
argument_list|)
expr_stmt|;
name|c
operator|=
name|GetLocaleInfoA
argument_list|(
name|MAKELCID
argument_list|(
name|langid
argument_list|,
name|SORT_DEFAULT
argument_list|)
argument_list|,
name|LOCALE_SENGCOUNTRY
argument_list|,
name|cp_string
argument_list|,
literal|260
argument_list|)
expr_stmt|;
comment|/* If codepage data for an LCID is not installed on users's system,      GetLocaleInfo returns an empty string.  Fall back to system ANSI      default. */
if|if
condition|(
name|c
operator|==
literal|0
condition|)
name|strcpy
argument_list|(
name|cp_string
argument_list|,
literal|"Neutral"
argument_list|)
expr_stmt|;
return|return
name|xstrdup
argument_list|(
name|cp_string
argument_list|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|const
name|wind_language_t
modifier|*
name|wind_find_language_by_id
parameter_list|(
name|unsigned
name|id
parameter_list|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|!
name|id
condition|)
return|return
name|NULL
return|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|languages
index|[
name|i
index|]
operator|.
name|id
operator|!=
operator|(
name|unsigned
operator|)
operator|-
literal|1
operator|&&
name|languages
index|[
name|i
index|]
operator|.
name|id
operator|!=
name|id
condition|;
name|i
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|languages
index|[
name|i
index|]
operator|.
name|id
operator|==
name|id
condition|)
return|return
operator|&
name|languages
index|[
name|i
index|]
return|;
return|return
name|NULL
return|;
else|#
directive|else
specifier|static
name|wind_language_t
name|wl
decl_stmt|;
name|wl
operator|.
name|id
operator|=
name|id
expr_stmt|;
name|wl
operator|.
name|doscp
operator|=
name|codepage_from_langid
argument_list|(
operator|(
name|unsigned
name|short
operator|)
name|id
argument_list|)
expr_stmt|;
name|wl
operator|.
name|wincp
operator|=
name|wincodepage_from_langid
argument_list|(
operator|(
name|unsigned
name|short
operator|)
name|id
argument_list|)
expr_stmt|;
name|wl
operator|.
name|name
operator|=
name|lang_from_langid
argument_list|(
operator|(
name|unsigned
name|short
operator|)
name|id
argument_list|)
expr_stmt|;
name|wl
operator|.
name|country
operator|=
name|country_from_langid
argument_list|(
operator|(
name|unsigned
name|short
operator|)
name|id
argument_list|)
expr_stmt|;
return|return
operator|&
name|wl
return|;
endif|#
directive|endif
block|}
end_function

begin_function
specifier|const
name|local_iconv_map
modifier|*
name|wind_find_codepage_info
parameter_list|(
name|unsigned
name|cp
parameter_list|)
block|{
if|#
directive|if
operator|!
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|&&
operator|!
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|codepages
index|[
name|i
index|]
operator|.
name|codepage
operator|!=
operator|(
name|rc_uint_type
operator|)
operator|-
literal|1
operator|&&
name|codepages
index|[
name|i
index|]
operator|.
name|codepage
operator|!=
name|cp
condition|;
name|i
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|codepages
index|[
name|i
index|]
operator|.
name|codepage
operator|==
operator|(
name|rc_uint_type
operator|)
operator|-
literal|1
condition|)
return|return
name|NULL
return|;
return|return
operator|&
name|codepages
index|[
name|i
index|]
return|;
else|#
directive|else
specifier|static
name|local_iconv_map
name|lim
decl_stmt|;
if|if
condition|(
operator|!
name|unicode_is_valid_codepage
argument_list|(
name|cp
argument_list|)
condition|)
return|return
name|NULL
return|;
name|lim
operator|.
name|codepage
operator|=
name|cp
expr_stmt|;
name|lim
operator|.
name|iconv_name
operator|=
literal|""
expr_stmt|;
return|return
operator|&
name|lim
return|;
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* Convert an Codepage string to a unicode string.  */
end_comment

begin_function
name|void
name|unicode_from_codepage
parameter_list|(
name|rc_uint_type
modifier|*
name|length
parameter_list|,
name|unichar
modifier|*
modifier|*
name|u
parameter_list|,
specifier|const
name|char
modifier|*
name|src
parameter_list|,
name|rc_uint_type
name|cp
parameter_list|)
block|{
name|rc_uint_type
name|len
decl_stmt|;
name|len
operator|=
name|wind_MultiByteToWideChar
argument_list|(
name|cp
argument_list|,
name|src
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
operator|*
name|u
operator|=
operator|(
operator|(
name|unichar
operator|*
operator|)
name|res_alloc
argument_list|(
name|len
argument_list|)
operator|)
expr_stmt|;
name|wind_MultiByteToWideChar
argument_list|(
name|cp
argument_list|,
name|src
argument_list|,
operator|*
name|u
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
comment|/* Discount the trailing '/0'.  If MultiByteToWideChar failed,      this will set *length to -1.  */
name|len
operator|-=
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|!=
name|NULL
condition|)
operator|*
name|length
operator|=
name|len
operator|/
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Convert an unicode string to an codepage string.  */
end_comment

begin_function
name|void
name|codepage_from_unicode
parameter_list|(
name|rc_uint_type
modifier|*
name|length
parameter_list|,
specifier|const
name|unichar
modifier|*
name|unicode
parameter_list|,
name|char
modifier|*
modifier|*
name|ascii
parameter_list|,
name|rc_uint_type
name|cp
parameter_list|)
block|{
name|rc_uint_type
name|len
decl_stmt|;
name|len
operator|=
name|wind_WideCharToMultiByte
argument_list|(
name|cp
argument_list|,
name|unicode
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
condition|)
block|{
operator|*
name|ascii
operator|=
operator|(
name|char
operator|*
operator|)
name|res_alloc
argument_list|(
name|len
operator|*
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
name|wind_WideCharToMultiByte
argument_list|(
name|cp
argument_list|,
name|unicode
argument_list|,
operator|*
name|ascii
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
comment|/* Discount the trailing '/0'.  If MultiByteToWideChar failed,      this will set *length to -1.  */
name|len
operator|--
expr_stmt|;
if|if
condition|(
name|length
operator|!=
name|NULL
condition|)
operator|*
name|length
operator|=
name|len
expr_stmt|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_ICONV_H
end_ifdef

begin_function
specifier|static
name|int
name|iconv_onechar
parameter_list|(
name|iconv_t
name|cd
parameter_list|,
specifier|const
name|char
modifier|*
name|s
parameter_list|,
name|char
modifier|*
name|d
parameter_list|,
name|int
name|d_len
parameter_list|,
specifier|const
name|char
modifier|*
modifier|*
name|n_s
parameter_list|,
name|char
modifier|*
modifier|*
name|n_d
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
literal|32
condition|;
name|i
operator|++
control|)
block|{
name|char
modifier|*
name|tmp_d
init|=
name|d
decl_stmt|;
specifier|const
name|char
modifier|*
name|tmp_s
init|=
name|s
decl_stmt|;
name|size_t
name|ret
decl_stmt|;
name|size_t
name|s_left
init|=
operator|(
name|size_t
operator|)
name|i
decl_stmt|;
name|size_t
name|d_left
init|=
operator|(
name|size_t
operator|)
name|d_len
decl_stmt|;
name|ret
operator|=
name|iconv
argument_list|(
name|cd
argument_list|,
operator|&
name|tmp_s
argument_list|,
operator|&
name|s_left
argument_list|,
operator|&
name|tmp_d
argument_list|,
operator|&
name|d_left
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|!=
operator|(
name|size_t
operator|)
operator|-
literal|1
condition|)
block|{
operator|*
name|n_s
operator|=
name|tmp_s
expr_stmt|;
operator|*
name|n_d
operator|=
name|tmp_d
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|wind_iconv_cp
parameter_list|(
name|rc_uint_type
name|cp
parameter_list|)
block|{
specifier|const
name|local_iconv_map
modifier|*
name|lim
init|=
name|wind_find_codepage_info
argument_list|(
name|cp
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|lim
condition|)
return|return
name|NULL
return|;
return|return
name|lim
operator|->
name|iconv_name
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* HAVE_ICONV_H */
end_comment

begin_function
specifier|static
name|rc_uint_type
name|wind_MultiByteToWideChar
parameter_list|(
name|rc_uint_type
name|cp
parameter_list|,
specifier|const
name|char
modifier|*
name|mb
parameter_list|,
name|unichar
modifier|*
name|u
parameter_list|,
name|rc_uint_type
name|u_len
parameter_list|)
block|{
name|rc_uint_type
name|ret
init|=
literal|0
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|||
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
name|ret
operator|=
operator|(
name|rc_uint_type
operator|)
name|MultiByteToWideChar
argument_list|(
name|cp
argument_list|,
name|MB_PRECOMPOSED
argument_list|,
name|mb
argument_list|,
operator|-
literal|1
argument_list|,
name|u
argument_list|,
name|u_len
argument_list|)
expr_stmt|;
comment|/* Convert to bytes. */
name|ret
operator|*=
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|HAVE_ICONV_H
argument_list|)
name|int
name|first
init|=
literal|1
decl_stmt|;
name|char
name|tmp
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|p_tmp
decl_stmt|;
specifier|const
name|char
modifier|*
name|iconv_name
init|=
name|wind_iconv_cp
argument_list|(
name|cp
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|mb
operator|||
operator|!
name|iconv_name
condition|)
return|return
literal|0
return|;
name|iconv_t
name|cd
init|=
name|iconv_open
argument_list|(
literal|"UTF-16"
argument_list|,
name|iconv_name
argument_list|)
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|iret
decl_stmt|;
specifier|const
name|char
modifier|*
name|n_mb
decl_stmt|;
name|char
modifier|*
name|n_tmp
decl_stmt|;
name|p_tmp
operator|=
name|tmp
expr_stmt|;
name|iret
operator|=
name|iconv_onechar
argument_list|(
name|cd
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|mb
argument_list|,
name|p_tmp
argument_list|,
literal|32
argument_list|,
operator|&
name|n_mb
argument_list|,
operator|&
name|n_tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|iret
condition|)
block|{
name|size_t
name|l_tmp
init|=
call|(
name|size_t
call|)
argument_list|(
name|n_tmp
operator|-
name|p_tmp
argument_list|)
decl_stmt|;
if|if
condition|(
name|u
condition|)
block|{
if|if
condition|(
operator|(
name|size_t
operator|)
name|u_len
operator|<
name|l_tmp
condition|)
break|break;
name|memcpy
argument_list|(
name|u
argument_list|,
name|tmp
argument_list|,
name|l_tmp
argument_list|)
expr_stmt|;
name|u
operator|+=
name|l_tmp
operator|/
literal|2
expr_stmt|;
name|u_len
operator|-=
name|l_tmp
expr_stmt|;
block|}
name|ret
operator|+=
name|l_tmp
expr_stmt|;
block|}
else|else
break|break;
if|if
condition|(
name|tmp
index|[
literal|0
index|]
operator|==
literal|0
operator|&&
name|tmp
index|[
literal|1
index|]
operator|==
literal|0
condition|)
break|break;
name|mb
operator|=
name|n_mb
expr_stmt|;
block|}
name|iconv_close
argument_list|(
name|cd
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|cp
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
name|ret
operator|=
name|strlen
argument_list|(
name|mb
argument_list|)
operator|+
literal|1
expr_stmt|;
name|ret
operator|*=
sizeof|sizeof
argument_list|(
name|unichar
argument_list|)
expr_stmt|;
if|if
condition|(
name|u
operator|!=
name|NULL
operator|&&
name|u_len
operator|!=
literal|0
condition|)
block|{
do|do
block|{
operator|*
name|u
operator|++
operator|=
operator|(
operator|(
name|unichar
operator|)
operator|*
name|mb
operator|)
operator|&
literal|0xff
expr_stmt|;
operator|--
name|u_len
expr_stmt|;
name|mb
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|u_len
operator|!=
literal|0
operator|&&
name|mb
index|[
operator|-
literal|1
index|]
operator|!=
literal|0
condition|)
do|;
block|}
if|if
condition|(
name|u
operator|!=
name|NULL
operator|&&
name|u_len
operator|!=
literal|0
condition|)
operator|*
name|u
operator|=
literal|0
expr_stmt|;
endif|#
directive|endif
return|return
name|ret
return|;
block|}
end_function

begin_function
specifier|static
name|rc_uint_type
name|wind_WideCharToMultiByte
parameter_list|(
name|rc_uint_type
name|cp
parameter_list|,
specifier|const
name|unichar
modifier|*
name|u
parameter_list|,
name|char
modifier|*
name|mb
parameter_list|,
name|rc_uint_type
name|mb_len
parameter_list|)
block|{
name|rc_uint_type
name|ret
init|=
literal|0
decl_stmt|;
if|#
directive|if
name|defined
argument_list|(
name|_WIN32
argument_list|)
operator|||
name|defined
argument_list|(
name|__CYGWIN__
argument_list|)
name|WINBOOL
name|used_def
init|=
name|FALSE
decl_stmt|;
name|ret
operator|=
operator|(
name|rc_uint_type
operator|)
name|WideCharToMultiByte
argument_list|(
name|cp
argument_list|,
literal|0
argument_list|,
name|u
argument_list|,
operator|-
literal|1
argument_list|,
name|mb
argument_list|,
name|mb_len
argument_list|,
name|NULL
argument_list|,
operator|&
name|used_def
argument_list|)
expr_stmt|;
elif|#
directive|elif
name|defined
argument_list|(
name|HAVE_ICONV_H
argument_list|)
name|int
name|first
init|=
literal|1
decl_stmt|;
name|char
name|tmp
index|[
literal|32
index|]
decl_stmt|;
name|char
modifier|*
name|p_tmp
decl_stmt|;
specifier|const
name|char
modifier|*
name|iconv_name
init|=
name|wind_iconv_cp
argument_list|(
name|cp
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|u
operator|||
operator|!
name|iconv_name
condition|)
return|return
literal|0
return|;
name|iconv_t
name|cd
init|=
name|iconv_open
argument_list|(
name|iconv_name
argument_list|,
literal|"UTF-16"
argument_list|)
decl_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|int
name|iret
decl_stmt|;
specifier|const
name|char
modifier|*
name|n_u
decl_stmt|;
name|char
modifier|*
name|n_tmp
decl_stmt|;
name|p_tmp
operator|=
name|tmp
expr_stmt|;
name|iret
operator|=
name|iconv_onechar
argument_list|(
name|cd
argument_list|,
operator|(
specifier|const
name|char
operator|*
operator|)
name|u
argument_list|,
name|p_tmp
argument_list|,
literal|32
argument_list|,
operator|&
name|n_u
argument_list|,
operator|&
name|n_tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
literal|0
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
operator|!
name|iret
condition|)
block|{
name|size_t
name|l_tmp
init|=
call|(
name|size_t
call|)
argument_list|(
name|n_tmp
operator|-
name|p_tmp
argument_list|)
decl_stmt|;
if|if
condition|(
name|mb
condition|)
block|{
if|if
condition|(
operator|(
name|size_t
operator|)
name|mb_len
operator|<
name|l_tmp
condition|)
break|break;
name|memcpy
argument_list|(
name|mb
argument_list|,
name|tmp
argument_list|,
name|l_tmp
argument_list|)
expr_stmt|;
name|mb
operator|+=
name|l_tmp
expr_stmt|;
name|mb_len
operator|-=
name|l_tmp
expr_stmt|;
block|}
name|ret
operator|+=
name|l_tmp
expr_stmt|;
block|}
else|else
break|break;
if|if
condition|(
name|u
index|[
literal|0
index|]
operator|==
literal|0
condition|)
break|break;
name|u
operator|=
operator|(
specifier|const
name|unichar
operator|*
operator|)
name|n_u
expr_stmt|;
block|}
name|iconv_close
argument_list|(
name|cd
argument_list|)
expr_stmt|;
else|#
directive|else
if|if
condition|(
name|cp
condition|)
name|ret
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|u
index|[
name|ret
index|]
operator|!=
literal|0
condition|)
operator|++
name|ret
expr_stmt|;
operator|++
name|ret
expr_stmt|;
if|if
condition|(
name|mb
condition|)
block|{
while|while
condition|(
operator|*
name|u
operator|!=
literal|0
operator|&&
name|mb_len
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|u
index|[
literal|0
index|]
operator|==
operator|(
name|u
index|[
literal|0
index|]
operator|&
literal|0x7f
operator|)
condition|)
operator|*
name|mb
operator|++
operator|=
operator|(
name|char
operator|)
name|u
index|[
literal|0
index|]
expr_stmt|;
else|else
operator|*
name|mb
operator|++
operator|=
literal|'_'
expr_stmt|;
operator|++
name|u
expr_stmt|;
operator|--
name|mb_len
expr_stmt|;
block|}
if|if
condition|(
name|mb_len
operator|!=
literal|0
condition|)
operator|*
name|mb
operator|=
literal|0
expr_stmt|;
block|}
endif|#
directive|endif
return|return
name|ret
return|;
block|}
end_function

end_unit


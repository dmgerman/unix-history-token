begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* sunlink.c - X.25 abstractions for SunLink X25 */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/compat/RCS/sunlink.c,v 7.6 91/02/22 09:16:06 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * $Header: /f/osi/compat/RCS/sunlink.c,v 7.6 91/02/22 09:16:06 mrose Interim $  *  * Contributed by John Pavel, Department of Trade and Industry/National  * Physical Laboratory in the UK  *  *  * $Log:	sunlink.c,v $  * Revision 7.6  91/02/22  09:16:06  mrose  * Interim 6.8  *   * Revision 7.5  91/01/14  13:33:49  mrose  * loader  *   * Revision 7.4  91/01/07  12:39:59  mrose  * update  *   * Revision 7.3  90/10/15  18:19:36  mrose  * sync  *   * Revision 7.2  90/07/27  08:41:49  mrose  * update  *   * Revision 7.1  90/07/09  14:32:22  mrose  * sync  *   * Revision 7.0  89/11/23  21:23:42  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *                                NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"general.h"
end_include

begin_include
include|#
directive|include
file|"manifest.h"
end_include

begin_include
include|#
directive|include
file|"tailor.h"
end_include

begin_comment
comment|/*
comment|SUN UNIX: SunLink X25 */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|X25
end_ifdef

begin_include
include|#
directive|include
file|"x25.h"
end_include

begin_include
include|#
directive|include
file|"isoaddrs.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|SUN_X25
end_ifdef

begin_define
define|#
directive|define
name|CALLING
value|0
end_define

begin_define
define|#
directive|define
name|CALLED
value|1
end_define

begin_define
define|#
directive|define
name|PROBE
value|(-1)
end_define

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function_decl
name|void
name|print_x25_facilities
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|int
name|start_x25_client
parameter_list|(
name|local
parameter_list|,
name|priv
parameter_list|)
name|struct
name|NSAPaddr
modifier|*
name|local
decl_stmt|;
name|int
name|priv
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|;
if|if
condition|(
operator|(
name|sd
operator|=
name|socket
argument_list|(
name|AF_X25
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"socket"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
return|return
name|sd
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|start_x25_server
parameter_list|(
name|local
parameter_list|,
name|backlog
parameter_list|,
name|opt1
parameter_list|,
name|opt2
parameter_list|)
name|struct
name|NSAPaddr
modifier|*
name|local
decl_stmt|;
name|int
name|backlog
decl_stmt|,
name|opt1
decl_stmt|,
name|opt2
decl_stmt|;
block|{
name|CONN_DB
name|sbuf
decl_stmt|,
name|xbuf
decl_stmt|;
name|CONN_DB
modifier|*
name|sock
init|=
operator|&
name|sbuf
decl_stmt|,
modifier|*
name|xs
init|=
operator|&
name|xbuf
decl_stmt|;
name|int
name|sd
decl_stmt|,
name|onoff
decl_stmt|;
if|if
condition|(
operator|(
name|sd
operator|=
name|socket
argument_list|(
name|AF_X25
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"socket"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|onoff
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|X25_CALL_ACPT_APPROVAL
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"X25_CALL_ACPT_APPROVAL"
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close_x25_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|X25_RD_HOSTADR
argument_list|,
operator|(
name|char
operator|*
operator|)
name|xs
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"X25_RD_HOSTADR"
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close_x25_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
comment|/* if null DTE in /etc/x25params 					   then ALWAYS use null DTE for 					   listen if PID is specified */
if|if
condition|(
name|xs
operator|->
name|hostlen
operator|==
literal|0
operator|&&
name|local
operator|->
name|na_pidlen
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|local
operator|->
name|na_pidlen
operator|>
name|NPSIZE
condition|)
name|local
operator|->
name|na_pidlen
operator|=
name|NPSIZE
expr_stmt|;
operator|*
name|sock
operator|=
operator|*
name|xs
expr_stmt|;
comment|/* struct copy */
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|sock
operator|->
name|data
argument_list|,
name|NPSIZE
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|local
operator|->
name|na_pid
argument_list|,
operator|(
name|char
operator|*
operator|)
name|sock
operator|->
name|data
argument_list|,
name|local
operator|->
name|na_pidlen
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|local
operator|->
name|na_cudf
argument_list|,
operator|(
name|char
operator|*
operator|)
name|sock
operator|->
name|data
operator|+
name|NPSIZE
argument_list|,
name|local
operator|->
name|na_cudflen
argument_list|)
expr_stmt|;
name|sock
operator|->
name|datalen
operator|=
name|local
operator|->
name|na_pidlen
operator|+
name|local
operator|->
name|na_cudflen
expr_stmt|;
block|}
else|else
name|sock
operator|=
name|gen2if
argument_list|(
name|local
argument_list|,
name|sock
argument_list|,
name|ADDR_LISTEN
argument_list|)
expr_stmt|;
comment|/* Adopt the convention that if a null DTE is given,        we should get the one from /etc/x25params */
if|if
condition|(
operator|!
name|local
operator|->
name|na_dtelen
condition|)
block|{
comment|/* Now set the generic local address */
name|local
operator|=
name|if2gen
argument_list|(
name|local
argument_list|,
name|xs
argument_list|,
name|ADDR_LOCAL
argument_list|)
expr_stmt|;
comment|/* Modified by INRIA to avoid a null local address */
if|if
condition|(
operator|!
name|local
operator|->
name|na_dtelen
condition|)
block|{
name|local
operator|->
name|na_dtelen
operator|=
literal|1
expr_stmt|;
name|local
operator|->
name|na_dte
index|[
literal|0
index|]
operator|=
literal|'0'
expr_stmt|;
block|}
block|}
if|if
condition|(
name|bind
argument_list|(
name|sd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sock
argument_list|,
sizeof|sizeof
argument_list|(
name|CONN_DB
argument_list|)
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"bind"
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close_x25_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
ifndef|#
directive|ifndef
name|BSD43
if|if
condition|(
name|opt1
condition|)
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|opt1
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt2
condition|)
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|opt2
argument_list|,
name|NULLCP
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|#
directive|else
name|onoff
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|opt1
condition|)
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|opt1
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|,
sizeof|sizeof
name|onoff
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt2
condition|)
operator|(
name|void
operator|)
name|setsockopt
argument_list|(
name|sd
argument_list|,
name|SOL_SOCKET
argument_list|,
name|opt2
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|onoff
argument_list|,
sizeof|sizeof
name|onoff
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|set_x25_facilities
argument_list|(
name|sd
argument_list|,
name|CALLED
argument_list|,
literal|"Acceptable"
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|close_x25_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
operator|(
name|void
operator|)
name|listen
argument_list|(
name|sd
argument_list|,
name|backlog
argument_list|)
expr_stmt|;
return|return
name|sd
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|join_x25_server
parameter_list|(
name|fd
parameter_list|,
name|remote
parameter_list|)
specifier|register
name|int
name|fd
decl_stmt|;
specifier|register
name|struct
name|NSAPaddr
modifier|*
name|remote
decl_stmt|;
block|{
name|CONN_DB
name|sbuf
decl_stmt|;
name|CONN_DB
modifier|*
name|sock
init|=
operator|&
name|sbuf
decl_stmt|;
specifier|register
name|int
name|nfd
decl_stmt|;
if|if
condition|(
operator|(
name|sock
operator|=
name|gen2if
argument_list|(
name|remote
argument_list|,
name|sock
argument_list|,
name|ADDR_REMOTE
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|set_x25_facilities
argument_list|(
name|fd
argument_list|,
name|CALLING
argument_list|,
literal|"Proposed"
argument_list|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
ifdef|#
directive|ifdef
name|ANY_LINK
name|sock
operator|->
name|hostlen
operator||=
name|ANY_LINK
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|nfd
operator|=
name|connect
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sock
argument_list|,
sizeof|sizeof
argument_list|(
name|CONN_DB
argument_list|)
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|compat_log
operator|->
name|ll_events
operator|&
name|LLOG_EXCEPTIONS
condition|)
operator|(
name|void
operator|)
name|log_cause_and_diag
argument_list|(
name|fd
argument_list|)
expr_stmt|;
comment|/* Sun's documentation throwns 						   no light as to whether, or 						   not this will result in any 						   useful information */
block|}
ifdef|#
directive|ifdef
name|DEBUG
elseif|else
if|if
condition|(
name|compat_log
operator|->
name|ll_events
operator|&
name|LLOG_DEBUG
condition|)
operator|(
name|void
operator|)
name|log_x25_facilities
argument_list|(
name|fd
argument_list|,
name|CALLING
argument_list|,
literal|"Effective Calling"
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|ANY_LINK
name|sock
operator|->
name|hostlen
operator|&=
operator|~
name|ANY_LINK
expr_stmt|;
endif|#
directive|endif
name|remote
operator|=
name|if2gen
argument_list|(
name|remote
argument_list|,
name|sock
argument_list|,
name|ADDR_REMOTE
argument_list|)
expr_stmt|;
return|return
name|nfd
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|join_x25_client
parameter_list|(
name|fd
parameter_list|,
name|remote
parameter_list|)
name|int
name|fd
decl_stmt|;
name|struct
name|NSAPaddr
modifier|*
name|remote
decl_stmt|;
block|{
name|CONN_DB
name|sbuf
decl_stmt|;
name|CONN_DB
modifier|*
name|sock
init|=
operator|&
name|sbuf
decl_stmt|;
name|int
name|len
init|=
sizeof|sizeof
expr|*
name|sock
decl_stmt|;
name|int
name|nfd
decl_stmt|;
if|if
condition|(
operator|(
name|nfd
operator|=
name|accept
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|sock
argument_list|,
operator|&
name|len
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
if|if
condition|(
name|compat_log
operator|->
name|ll_events
operator|&
name|LLOG_EXCEPTIONS
condition|)
operator|(
name|void
operator|)
name|log_cause_and_diag
argument_list|(
name|fd
argument_list|)
expr_stmt|;
comment|/* Sun's documentation throwns 						   no light as to whether, or 						   not this will result in any 						   useful information */
block|}
ifdef|#
directive|ifdef
name|DEBUG
elseif|else
if|if
condition|(
name|compat_log
operator|->
name|ll_events
operator|&
name|LLOG_DEBUG
condition|)
operator|(
name|void
operator|)
name|log_x25_facilities
argument_list|(
name|fd
argument_list|,
name|CALLED
argument_list|,
literal|"Effective Called"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|nfd
operator|<
literal|0
condition|)
return|return
name|nfd
return|;
comment|/* May also need to send call accept packet if using      * FAST_ACPT_CLR, or X25_CALL_ACPT_APPROVAL      * there was a SUNLINK bug in this area      *      * May as well try it -- if it fails, so what ??      */
if|if
condition|(
name|ioctl
argument_list|(
name|nfd
argument_list|,
name|X25_SEND_CALL_ACPT
argument_list|,
name|NULLCP
argument_list|)
operator|<
literal|0
condition|)
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"X25_SEND_CALL_ACPT"
operator|)
argument_list|)
expr_stmt|;
name|remote
operator|=
name|if2gen
argument_list|(
name|remote
argument_list|,
name|sock
argument_list|,
name|ADDR_REMOTE
argument_list|)
expr_stmt|;
return|return
name|nfd
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* There is a bug whereby if the thruput is set, calls fail. pb@cl.cam.ac.uk */
end_comment

begin_decl_stmt
name|int
name|sun_fixed_thruput
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Set up X.25 Facilities.  Note that setting even one value causes    the default (/etc/x25params) values to be set explicitly on the    call request (and probably also call accept).  This can screw    things up, if your /etc/x25params has not been properly    localised as is normally the case.  */
end_comment

begin_function
name|int
name|set_x25_facilities
parameter_list|(
name|sd
parameter_list|,
name|coc
parameter_list|,
name|caption
parameter_list|)
name|int
name|sd
decl_stmt|,
name|coc
decl_stmt|;
name|char
modifier|*
name|caption
decl_stmt|;
block|{
name|FACILITY_DB
name|facilities
decl_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|facilities
argument_list|,
sizeof|sizeof
name|facilities
argument_list|)
expr_stmt|;
if|if
condition|(
name|coc
operator|!=
name|CALLED
operator|&&
name|ioctl
argument_list|(
name|sd
argument_list|,
name|X25_RD_FACILITY
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|facilities
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"X25_RD_FACILITY"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|coc
operator|==
name|PROBE
operator|||
operator|!
operator|(
name|coc
operator|==
name|CALLED
operator|||
name|reverse_charge
operator|||
name|recvpktsize
operator|||
name|sendpktsize
operator|||
name|recvwndsize
operator|||
name|sendwndsize
operator|||
name|recvthruput
operator|||
name|sendthruput
operator|||
name|cug_req
comment|/* || cug_index */
operator|||
name|fast_select_type
operator|||
name|rpoa_req
comment|/* || rpoa */
operator|)
condition|)
block|{
if|if
condition|(
name|facilities
operator|.
name|recvpktsize
condition|)
name|recvpktsize
operator|=
name|facilities
operator|.
name|recvpktsize
expr_stmt|;
if|if
condition|(
name|facilities
operator|.
name|sendpktsize
condition|)
name|sendpktsize
operator|=
name|facilities
operator|.
name|sendpktsize
expr_stmt|;
return|return
name|OK
return|;
block|}
if|if
condition|(
name|reverse_charge
condition|)
name|facilities
operator|.
name|reverse_charge
operator|=
name|reverse_charge
expr_stmt|;
if|if
condition|(
name|recvpktsize
condition|)
name|facilities
operator|.
name|recvpktsize
operator|=
name|recvpktsize
expr_stmt|;
if|if
condition|(
name|sendpktsize
condition|)
name|facilities
operator|.
name|sendpktsize
operator|=
name|sendpktsize
expr_stmt|;
if|if
condition|(
name|recvwndsize
condition|)
name|facilities
operator|.
name|recvwndsize
operator|=
name|recvwndsize
expr_stmt|;
if|if
condition|(
name|sendwndsize
condition|)
name|facilities
operator|.
name|sendwndsize
operator|=
name|sendwndsize
expr_stmt|;
if|if
condition|(
name|sun_fixed_thruput
condition|)
block|{
comment|/* get round Sun bug */
if|if
condition|(
name|recvthruput
condition|)
name|facilities
operator|.
name|recvthruput
operator|=
name|recvthruput
expr_stmt|;
if|if
condition|(
name|sendthruput
condition|)
name|facilities
operator|.
name|sendthruput
operator|=
name|sendthruput
expr_stmt|;
block|}
else|else
name|facilities
operator|.
name|recvthruput
operator|=
name|facilities
operator|.
name|sendthruput
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cug_req
condition|)
name|facilities
operator|.
name|cug_req
operator|=
name|cug_req
expr_stmt|;
if|if
condition|(
name|cug_index
condition|)
name|facilities
operator|.
name|cug_index
operator|=
name|cug_index
expr_stmt|;
if|if
condition|(
name|fast_select_type
condition|)
name|facilities
operator|.
name|fast_select_type
operator|=
name|fast_select_type
expr_stmt|;
comment|/* May as well accept FCS calls */
elseif|else
if|if
condition|(
name|coc
operator|==
name|CALLED
condition|)
name|facilities
operator|.
name|fast_select_type
operator|=
name|FAST_ACPT_CLR
expr_stmt|;
if|if
condition|(
name|rpoa_req
condition|)
name|facilities
operator|.
name|rpoa_req
operator|=
name|rpoa_req
expr_stmt|;
if|if
condition|(
name|rpoa
condition|)
name|facilities
operator|.
name|rpoa
operator|=
name|rpoa
expr_stmt|;
define|#
directive|define
name|DO_NOT_USE_FACILITIES
ifndef|#
directive|ifndef
name|DO_NOT_USE_FACILITIES
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|compat_log
operator|->
name|ll_events
operator|&
name|LLOG_DEBUG
condition|)
name|print_x25_facilities
argument_list|(
name|facilities
argument_list|,
name|coc
argument_list|,
name|caption
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ioctl
argument_list|(
name|sd
argument_list|,
name|X25_WR_FACILITY
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|facilities
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"X25_WR_FACILITY"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
endif|#
directive|endif
ifdef|#
directive|ifdef
name|notyet
if|if
condition|(
name|facilities
operator|.
name|recvpktsize
condition|)
name|recvpktsize
operator|=
name|facilities
operator|.
name|recvpktsize
expr_stmt|;
if|if
condition|(
name|facilities
operator|.
name|sendpktsize
condition|)
name|sendpktsize
operator|=
name|facilities
operator|.
name|sendpktsize
expr_stmt|;
endif|#
directive|endif
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|log_cause_and_diag
parameter_list|(
name|fd
parameter_list|)
name|int
name|fd
decl_stmt|;
block|{
name|X25_CAUSE_DIAG
name|diag
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|X25_RD_CAUSE_DIAG
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|diag
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"X25_RD_CAUSE_DIAG"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
return|return
name|elucidate_x25_err
argument_list|(
operator|(
name|int
operator|)
name|diag
operator|.
name|flags
argument_list|,
operator|(
name|char
operator|*
operator|)
name|diag
operator|.
name|data
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_function
specifier|static
name|int
name|log_x25_facilities
parameter_list|(
name|fd
parameter_list|,
name|coc
parameter_list|,
name|caption
parameter_list|)
name|int
name|fd
decl_stmt|;
name|int
name|coc
decl_stmt|;
name|char
modifier|*
name|caption
decl_stmt|;
block|{
name|FACILITY_DB
name|f
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|fd
argument_list|,
name|X25_RD_FACILITY
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|f
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"X25_RD_FACILITY"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|print_x25_facilities
argument_list|(
name|f
argument_list|,
name|coc
argument_list|,
name|caption
argument_list|)
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|void
name|print_x25_facilities
parameter_list|(
name|f
parameter_list|,
name|coc
parameter_list|,
name|caption
parameter_list|)
name|FACILITY_DB
name|f
decl_stmt|;
name|int
name|coc
decl_stmt|;
name|char
modifier|*
name|caption
decl_stmt|;
block|{
name|int
name|baud
decl_stmt|;
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"%s X.25 Facilities:"
operator|,
name|caption
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|f
operator|.
name|reverse_charge
condition|)
block|{
case|case
literal|0
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
operator|(
name|coc
operator|==
name|CALLED
operator|)
condition|?
literal|"reverse charging not requested"
else|:
literal|"reverse charging not allowed"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
operator|(
name|coc
operator|==
name|CALLING
operator|)
condition|?
literal|"reverse charging requested"
else|:
literal|"reverse charging allowed"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"invalid reverse_charge: %d"
operator|,
name|f
operator|.
name|reverse_charge
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|f
operator|.
name|recvpktsize
condition|)
block|{
case|case
literal|0
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"default recv packet size"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|16
case|:
case|case
literal|32
case|:
case|case
literal|64
case|:
case|case
literal|128
case|:
case|case
literal|256
case|:
case|case
literal|512
case|:
case|case
literal|1024
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"recv packet size %d"
operator|,
name|f
operator|.
name|recvpktsize
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"invalid recv packet size %d"
operator|,
name|f
operator|.
name|recvpktsize
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|f
operator|.
name|sendpktsize
condition|)
block|{
case|case
literal|0
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"default send packet size"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|16
case|:
case|case
literal|32
case|:
case|case
literal|64
case|:
case|case
literal|128
case|:
case|case
literal|256
case|:
case|case
literal|512
case|:
case|case
literal|1024
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"send packet size %d"
operator|,
name|f
operator|.
name|sendpktsize
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"invalid send packet size %d"
operator|,
name|f
operator|.
name|sendpktsize
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
name|f
operator|.
name|recvwndsize
operator|==
literal|0
condition|?
literal|"default recv window size"
else|:
literal|1
operator|<=
name|f
operator|.
name|recvwndsize
operator|&&
name|f
operator|.
name|recvwndsize
operator|<=
literal|127
condition|?
literal|"recv window size %d"
else|:
literal|"invalid recv window size %d"
operator|,
name|f
operator|.
name|recvwndsize
operator|)
argument_list|)
expr_stmt|;
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
name|f
operator|.
name|sendwndsize
operator|==
literal|0
condition|?
literal|"default send window size"
else|:
literal|1
operator|<=
name|f
operator|.
name|sendwndsize
operator|&&
name|f
operator|.
name|sendwndsize
operator|<=
literal|127
condition|?
literal|"send window size %d"
else|:
literal|"invalid send window size %d"
operator|,
name|f
operator|.
name|sendwndsize
operator|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|f
operator|.
name|recvthruput
condition|)
block|{
case|case
literal|0
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"default recv throughput"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|baud
operator|=
literal|75
expr_stmt|;
name|print_recv
label|:
empty_stmt|;
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"recv throughput %dbps"
operator|,
name|baud
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|baud
operator|=
literal|150
expr_stmt|;
goto|goto
name|print_recv
goto|;
case|case
literal|5
case|:
name|baud
operator|=
literal|300
expr_stmt|;
goto|goto
name|print_recv
goto|;
case|case
literal|6
case|:
name|baud
operator|=
literal|600
expr_stmt|;
goto|goto
name|print_recv
goto|;
case|case
literal|7
case|:
name|baud
operator|=
literal|1200
expr_stmt|;
goto|goto
name|print_recv
goto|;
case|case
literal|8
case|:
name|baud
operator|=
literal|2400
expr_stmt|;
goto|goto
name|print_recv
goto|;
case|case
literal|9
case|:
name|baud
operator|=
literal|4800
expr_stmt|;
goto|goto
name|print_recv
goto|;
case|case
literal|10
case|:
name|baud
operator|=
literal|9600
expr_stmt|;
goto|goto
name|print_recv
goto|;
case|case
literal|11
case|:
name|baud
operator|=
literal|19200
expr_stmt|;
goto|goto
name|print_recv
goto|;
case|case
literal|12
case|:
name|baud
operator|=
literal|48000
expr_stmt|;
goto|goto
name|print_recv
goto|;
default|default:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"invalid recv throughput %d"
operator|,
name|f
operator|.
name|recvthruput
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|f
operator|.
name|sendthruput
condition|)
block|{
case|case
literal|0
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"default send throughput"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|baud
operator|=
literal|75
expr_stmt|;
name|print_send
label|:
empty_stmt|;
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"send throughput %dbps"
operator|,
name|baud
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|baud
operator|=
literal|150
expr_stmt|;
goto|goto
name|print_send
goto|;
case|case
literal|5
case|:
name|baud
operator|=
literal|300
expr_stmt|;
goto|goto
name|print_send
goto|;
case|case
literal|6
case|:
name|baud
operator|=
literal|600
expr_stmt|;
goto|goto
name|print_send
goto|;
case|case
literal|7
case|:
name|baud
operator|=
literal|1200
expr_stmt|;
goto|goto
name|print_send
goto|;
case|case
literal|8
case|:
name|baud
operator|=
literal|2400
expr_stmt|;
goto|goto
name|print_send
goto|;
case|case
literal|9
case|:
name|baud
operator|=
literal|4800
expr_stmt|;
goto|goto
name|print_send
goto|;
case|case
literal|10
case|:
name|baud
operator|=
literal|9600
expr_stmt|;
goto|goto
name|print_send
goto|;
case|case
literal|11
case|:
name|baud
operator|=
literal|19200
expr_stmt|;
goto|goto
name|print_send
goto|;
case|case
literal|12
case|:
name|baud
operator|=
literal|48000
expr_stmt|;
goto|goto
name|print_send
goto|;
default|default:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"invalid send throughput %d"
operator|,
name|f
operator|.
name|sendthruput
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|f
operator|.
name|cug_req
condition|)
block|{
case|case
literal|0
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"no closed user group"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"closed user group 0x%x (BCD)"
operator|,
name|f
operator|.
name|cug_req
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"invalid closed user group %d"
operator|,
name|f
operator|.
name|cug_req
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|f
operator|.
name|fast_select_type
condition|)
block|{
case|case
name|FAST_OFF
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"don't use fast select"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|FAST_CLR_ONLY
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"clear is fast select response"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|FAST_ACPT_CLR
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"clear or call accepted is fast select response"
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"invalid fast select type %d"
operator|,
name|f
operator|.
name|fast_select_type
operator|)
argument_list|)
expr_stmt|;
break|break;
block|}
switch|switch
condition|(
name|f
operator|.
name|rpoa_req
condition|)
block|{
case|case
literal|0
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"no RPOA transit request"
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"RPOA transit request 0x%x"
operator|,
name|f
operator|.
name|rpoa_req
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default:
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"invalid RPOA transit request %d"
operator|,
name|f
operator|.
name|rpoa_req
operator|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_endif
endif|#
directive|endif
end_endif

begin_else
else|#
directive|else
end_else

begin_function
name|int
name|_sunlink_stub
parameter_list|()
block|{}
end_function

begin_empty_stmt
empty_stmt|;
end_empty_stmt

begin_endif
endif|#
directive|endif
end_endif

end_unit


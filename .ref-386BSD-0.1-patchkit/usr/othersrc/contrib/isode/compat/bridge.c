begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* bridge.c - X.25 abstractions for TCP bridge to X25 */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/compat/RCS/bridge.c,v 7.2 91/02/22 09:14:58 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/compat/RCS/bridge.c,v 7.2 91/02/22 09:14:58 mrose Interim $  *  * Contributed by Julian Onions, Nottingham University in the UK  *  *  * $Log:	bridge.c,v $  * Revision 7.2  91/02/22  09:14:58  mrose  * Interim 6.8  *   * Revision 7.1  90/07/09  14:31:32  mrose  * sync  *   * Revision 7.0  89/11/23  21:22:55  mrose  * Release 6.0  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_comment
comment|/* LINTLIBRARY */
end_comment

begin_include
include|#
directive|include
file|<errno.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|"general.h"
end_include

begin_include
include|#
directive|include
file|"manifest.h"
end_include

begin_include
include|#
directive|include
file|"tailor.h"
end_include

begin_include
include|#
directive|include
file|"internet.h"
end_include

begin_include
include|#
directive|include
file|"tpkt.h"
end_include

begin_comment
comment|/*
comment|TCP/X.25 BRIDGE */
end_comment

begin_ifdef
ifdef|#
directive|ifdef
name|BRIDGE_X25
end_ifdef

begin_decl_stmt
specifier|static
name|int
name|assfd
index|[
name|FD_SETSIZE
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|bridge_inited
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*
comment|*/
end_comment

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|int
name|start_bridge_client
parameter_list|(
name|local
parameter_list|)
name|struct
name|NSAPaddr
modifier|*
name|local
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|;
name|u_short
name|port
decl_stmt|;
specifier|register
name|struct
name|servent
modifier|*
name|sp
decl_stmt|;
if|if
condition|(
operator|(
name|sp
operator|=
name|getservbyname
argument_list|(
literal|"x25bridge"
argument_list|,
literal|"tcp"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|port
operator|=
name|x25_bridge_port
expr_stmt|;
else|else
name|port
operator|=
name|sp
operator|->
name|s_port
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|=
name|in_connect
argument_list|(
name|x25_bridge_host
argument_list|,
name|port
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|write_tcp_socket
argument_list|(
name|sd
argument_list|,
literal|"\01"
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"initial write"
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close_tcp_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
return|return
name|sd
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|in_connect
parameter_list|(
name|addr
parameter_list|,
name|port
parameter_list|)
name|char
modifier|*
name|addr
decl_stmt|;
name|u_short
name|port
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|;
name|struct
name|sockaddr_in
name|in_socket
decl_stmt|;
specifier|register
name|struct
name|sockaddr_in
modifier|*
name|isock
init|=
operator|&
name|in_socket
decl_stmt|;
specifier|register
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
if|if
condition|(
operator|(
name|hp
operator|=
name|gethostbystring
argument_list|(
name|addr
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|SLOG
argument_list|(
name|addr_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
operator|(
literal|"%s: unknown host"
operator|,
name|addr
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|isock
argument_list|,
sizeof|sizeof
expr|*
name|isock
argument_list|)
expr_stmt|;
name|isock
operator|->
name|sin_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|isock
operator|->
name|sin_port
operator|=
name|port
expr_stmt|;
name|inaddr_copy
argument_list|(
name|hp
argument_list|,
name|isock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|=
name|start_tcp_client
argument_list|(
operator|(
expr|struct
name|sockaddr_in
operator|*
operator|)
name|NULL
argument_list|,
literal|0
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"start_tcp_client"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|join_tcp_server
argument_list|(
name|sd
argument_list|,
name|isock
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"join_tcp_server"
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close_tcp_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
return|return
name|sd
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|join_bridge_server
parameter_list|(
name|fd
parameter_list|,
name|remote
parameter_list|)
name|int
name|fd
decl_stmt|;
specifier|register
name|struct
name|NSAPaddr
modifier|*
name|remote
decl_stmt|;
block|{
if|if
condition|(
name|remote
operator|!=
name|NULLNA
condition|)
name|remote
operator|->
name|na_stack
operator|=
name|NA_BRG
operator|,
name|remote
operator|->
name|na_community
operator|=
name|ts_comm_x25_default
expr_stmt|;
if|if
condition|(
name|bridge_write_nsap_addr
argument_list|(
name|fd
argument_list|,
name|remote
argument_list|,
name|write_tcp_socket
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
operator|(
literal|"write of NSAP failed"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
return|return
name|fd
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|start_bridge_server
parameter_list|(
name|local
parameter_list|,
name|backlog
parameter_list|,
name|opt1
parameter_list|,
name|opt2
parameter_list|)
name|struct
name|NSAPaddr
modifier|*
name|local
decl_stmt|;
name|int
name|backlog
decl_stmt|,
name|opt1
decl_stmt|,
name|opt2
decl_stmt|;
block|{
name|int
name|len
decl_stmt|,
name|new
decl_stmt|,
name|sd
decl_stmt|;
name|u_short
name|port
decl_stmt|;
name|struct
name|servent
modifier|*
name|sp
decl_stmt|;
name|struct
name|sockaddr_in
name|in_socket
decl_stmt|;
specifier|register
name|struct
name|sockaddr_in
modifier|*
name|isock
init|=
operator|&
name|in_socket
decl_stmt|;
if|if
condition|(
name|bridge_inited
operator|==
literal|0
condition|)
block|{
for|for
control|(
name|sd
operator|=
literal|0
init|;
name|sd
operator|<
name|FD_SETSIZE
condition|;
name|sd
operator|++
control|)
name|assfd
index|[
name|sd
index|]
operator|=
name|NOTOK
expr_stmt|;
name|bridge_inited
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|sp
operator|=
name|getservbyname
argument_list|(
literal|"x25bridge"
argument_list|,
literal|"tcp"
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|port
operator|=
name|x25_bridge_port
expr_stmt|;
else|else
name|port
operator|=
name|sp
operator|->
name|s_port
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|=
name|in_connect
argument_list|(
name|x25_bridge_host
argument_list|,
name|port
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
return|return
name|NOTOK
return|;
if|if
condition|(
name|write_tcp_socket
argument_list|(
name|sd
argument_list|,
literal|"\02"
argument_list|,
literal|1
argument_list|)
operator|!=
literal|1
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"initial write"
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close_tcp_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|local
operator|!=
name|NULLNA
condition|)
name|local
operator|->
name|na_stack
operator|=
name|NA_BRG
operator|,
name|local
operator|->
name|na_community
operator|=
name|ts_comm_x25_default
expr_stmt|;
if|if
condition|(
name|local
operator|!=
name|NULLNA
operator|&&
name|local
operator|->
name|na_dtelen
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|local
operator|->
name|na_dte
argument_list|,
name|x25_bridge_addr
argument_list|)
expr_stmt|;
name|local
operator|->
name|na_dtelen
operator|=
name|strlen
argument_list|(
name|x25_bridge_addr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|local
operator|!=
name|NULLNA
condition|)
block|{
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"addr"
operator|,
literal|"type=%d '%s' len=%d"
operator|,
name|local
operator|->
name|na_stack
operator|,
name|local
operator|->
name|na_dte
operator|,
name|local
operator|->
name|na_dtelen
operator|)
argument_list|)
expr_stmt|;
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"addr"
operator|,
literal|"pid='%s'(%d) fac='%s'(%d) cudf='%s'(%d)"
operator|,
name|local
operator|->
name|na_pid
operator|,
name|local
operator|->
name|na_pidlen
operator|,
name|local
operator|->
name|na_fac
operator|,
name|local
operator|->
name|na_faclen
operator|,
name|local
operator|->
name|na_pid
operator|,
name|local
operator|->
name|na_pidlen
operator|,
name|local
operator|->
name|na_cudf
operator|,
name|local
operator|->
name|na_cudflen
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|bridge_write_nsap_addr
argument_list|(
name|sd
argument_list|,
name|local
argument_list|,
name|write_tcp_socket
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
operator|(
literal|"write of NSAP failed"
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close_tcp_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
operator|(
name|new
operator|=
name|in_listen
argument_list|(
name|backlog
argument_list|,
name|opt1
argument_list|,
name|opt2
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|close_tcp_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|len
operator|=
sizeof|sizeof
expr|*
name|isock
expr_stmt|;
if|if
condition|(
name|getsockname
argument_list|(
name|new
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
name|isock
argument_list|,
operator|&
name|len
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"getsockname"
operator|)
argument_list|)
expr_stmt|;
name|out
label|:
empty_stmt|;
operator|(
name|void
operator|)
name|close_tcp_socket
argument_list|(
name|sd
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close_tcp_socket
argument_list|(
name|new
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|isock
operator|->
name|sin_family
operator|=
name|htons
argument_list|(
name|isock
operator|->
name|sin_family
argument_list|)
expr_stmt|;
if|if
condition|(
name|write_tcp_socket
argument_list|(
name|sd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|isock
argument_list|,
sizeof|sizeof
expr|*
name|isock
argument_list|)
operator|!=
sizeof|sizeof
expr|*
name|isock
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"write of sockaddr_in"
operator|)
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|assfd
index|[
name|new
index|]
operator|=
name|sd
expr_stmt|;
return|return
name|new
return|;
block|}
end_function

begin_function
name|int
name|get_bridge_assfd
parameter_list|(
name|fd
parameter_list|)
name|int
name|fd
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|bridge_inited
condition|)
return|return
name|NOTOK
return|;
return|return
name|assfd
index|[
name|fd
index|]
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
specifier|static
name|int
name|in_listen
parameter_list|(
name|backlog
parameter_list|,
name|opt1
parameter_list|,
name|opt2
parameter_list|)
name|int
name|backlog
decl_stmt|,
name|opt1
decl_stmt|,
name|opt2
decl_stmt|;
block|{
name|int
name|sd
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|struct
name|sockaddr_in
name|lo_socket
decl_stmt|;
specifier|register
name|struct
name|sockaddr_in
modifier|*
name|lsock
init|=
operator|&
name|lo_socket
decl_stmt|;
specifier|register
name|struct
name|hostent
modifier|*
name|hp
decl_stmt|;
if|if
condition|(
operator|(
name|hp
operator|=
name|gethostbystring
argument_list|(
name|cp
operator|=
name|getlocalhost
argument_list|()
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|SLOG
argument_list|(
name|addr_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
operator|(
literal|"%s: unknown host"
operator|,
name|cp
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|lsock
argument_list|,
sizeof|sizeof
expr|*
name|lsock
argument_list|)
expr_stmt|;
name|lsock
operator|->
name|sin_family
operator|=
name|hp
operator|->
name|h_addrtype
expr_stmt|;
name|inaddr_copy
argument_list|(
name|hp
argument_list|,
name|lsock
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|sd
operator|=
name|start_tcp_server
argument_list|(
name|lsock
argument_list|,
name|backlog
argument_list|,
name|opt1
argument_list|,
name|opt2
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"start_tcp_server"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
return|return
name|sd
return|;
block|}
end_function

begin_comment
comment|/*
comment|*/
end_comment

begin_function
name|int
name|join_bridge_client
parameter_list|(
name|fd
parameter_list|,
name|remote
parameter_list|)
name|int
name|fd
decl_stmt|;
name|struct
name|NSAPaddr
modifier|*
name|remote
decl_stmt|;
block|{
name|int
name|new
decl_stmt|;
name|struct
name|sockaddr_in
name|in_socket
decl_stmt|;
name|struct
name|NSAPaddr
name|sock
decl_stmt|;
if|if
condition|(
operator|(
name|new
operator|=
name|join_tcp_client
argument_list|(
name|fd
argument_list|,
operator|&
name|in_socket
argument_list|)
operator|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"join_tcp_client"
operator|)
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
if|if
condition|(
name|bridge_read_nsap_addr
argument_list|(
name|new
argument_list|,
operator|&
name|sock
argument_list|,
name|read_tcp_socket
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
name|SLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
operator|(
literal|"read of NSAP"
operator|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|close_tcp_socket
argument_list|(
name|new
argument_list|)
expr_stmt|;
return|return
name|NOTOK
return|;
block|}
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"addr"
operator|,
literal|"type=%d '%s' len=%d"
operator|,
name|sock
operator|.
name|na_stack
operator|,
name|sock
operator|.
name|na_dte
operator|,
name|sock
operator|.
name|na_dtelen
operator|)
argument_list|)
expr_stmt|;
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"addr"
operator|,
literal|"pid='%s'(%d) fac='%s'(%d) cudf='%s'(%d)"
operator|,
name|sock
operator|.
name|na_pid
operator|,
name|sock
operator|.
name|na_pidlen
operator|,
name|sock
operator|.
name|na_fac
operator|,
name|sock
operator|.
name|na_faclen
operator|,
name|sock
operator|.
name|na_pid
operator|,
name|sock
operator|.
name|na_pidlen
operator|,
name|sock
operator|.
name|na_cudf
operator|,
name|sock
operator|.
name|na_cudflen
operator|)
argument_list|)
expr_stmt|;
name|sock
operator|.
name|na_stack
operator|=
name|ntohl
argument_list|(
name|sock
operator|.
name|na_stack
argument_list|)
expr_stmt|;
operator|*
name|remote
operator|=
name|sock
expr_stmt|;
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"addr"
operator|,
literal|"type=%d '%s' len=%d"
operator|,
name|remote
operator|->
name|na_stack
operator|,
name|remote
operator|->
name|na_dte
operator|,
name|remote
operator|->
name|na_dtelen
operator|)
argument_list|)
expr_stmt|;
name|DLOG
argument_list|(
name|compat_log
argument_list|,
name|LLOG_DEBUG
argument_list|,
operator|(
literal|"addr"
operator|,
literal|"pid='%s'(%d) fac='%s'(%d) cudf='%s'(%d)"
operator|,
name|remote
operator|->
name|na_pid
operator|,
name|remote
operator|->
name|na_pidlen
operator|,
name|remote
operator|->
name|na_fac
operator|,
name|remote
operator|->
name|na_faclen
operator|,
name|remote
operator|->
name|na_pid
operator|,
name|remote
operator|->
name|na_pidlen
operator|,
name|remote
operator|->
name|na_cudf
operator|,
name|remote
operator|->
name|na_cudflen
operator|)
argument_list|)
expr_stmt|;
return|return
name|new
return|;
block|}
end_function

begin_function
name|int
name|close_bridge_socket
parameter_list|(
name|sd
parameter_list|)
name|int
name|sd
decl_stmt|;
block|{
if|if
condition|(
name|bridge_inited
operator|&&
name|assfd
index|[
name|sd
index|]
operator|!=
name|NOTOK
condition|)
operator|(
name|void
operator|)
name|close_tcp_socket
argument_list|(
name|assfd
index|[
name|sd
index|]
argument_list|)
expr_stmt|;
name|assfd
index|[
name|sd
index|]
operator|=
name|NOTOK
expr_stmt|;
return|return
name|close_tcp_socket
argument_list|(
name|sd
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ARGSUSED */
end_comment

begin_function
name|int
name|bridgediscrim
parameter_list|(
name|na
parameter_list|)
name|struct
name|NSAPaddr
modifier|*
name|na
decl_stmt|;
block|{
ifndef|#
directive|ifndef
name|X25
return|return
literal|1
return|;
comment|/* must be bridge */
else|#
directive|else
name|int
name|len
init|=
name|strlen
argument_list|(
name|x25_bridge_discrim
argument_list|)
decl_stmt|;
if|if
condition|(
name|len
operator|==
literal|1
operator|&&
operator|*
name|x25_bridge_discrim
operator|==
literal|'-'
condition|)
return|return
literal|0
return|;
return|return
operator|(
name|len
operator|==
literal|0
condition|?
literal|1
else|:
name|strncmp
argument_list|(
name|na
operator|->
name|na_dte
argument_list|,
name|x25_bridge_discrim
argument_list|,
name|len
argument_list|)
operator|==
literal|0
operator|)
return|;
endif|#
directive|endif
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  * Structure is as follows :-  * 0-1		type  * 2-17 	dte  * 18		dte len  * 19-22	pid  * 23		pid len  * 24-39	user data  * 40		user data len  * 41-46	facilities  * 47		facility length  */
end_comment

begin_function
name|int
name|bridge_write_nsap_addr
parameter_list|(
name|fd
parameter_list|,
name|nsap
parameter_list|,
name|writefnx
parameter_list|)
name|int
name|fd
decl_stmt|;
name|struct
name|NSAPaddr
modifier|*
name|nsap
decl_stmt|;
name|IFP
name|writefnx
decl_stmt|;
block|{
name|u_short
name|na_stack
decl_stmt|;
name|char
name|buffer
index|[
literal|50
index|]
decl_stmt|;
if|if
condition|(
name|nsap
operator|==
name|NULLNA
operator|||
operator|(
name|na_stack
operator|=
name|nsap
operator|->
name|na_stack
operator|)
operator|!=
name|NA_BRG
condition|)
return|return
name|NOTOK
return|;
name|na_stack
operator|=
name|htons
argument_list|(
name|na_stack
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|na_stack
argument_list|,
name|buffer
argument_list|,
sizeof|sizeof
argument_list|(
name|na_stack
argument_list|)
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|nsap
operator|->
name|na_dte
argument_list|,
operator|&
name|buffer
index|[
literal|2
index|]
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|buffer
index|[
literal|18
index|]
operator|=
name|nsap
operator|->
name|na_dtelen
expr_stmt|;
name|bcopy
argument_list|(
name|nsap
operator|->
name|na_pid
argument_list|,
operator|&
name|buffer
index|[
literal|19
index|]
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|buffer
index|[
literal|23
index|]
operator|=
name|nsap
operator|->
name|na_pidlen
expr_stmt|;
name|bcopy
argument_list|(
name|nsap
operator|->
name|na_cudf
argument_list|,
operator|&
name|buffer
index|[
literal|24
index|]
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|buffer
index|[
literal|40
index|]
operator|=
name|nsap
operator|->
name|na_cudflen
expr_stmt|;
name|bcopy
argument_list|(
name|nsap
operator|->
name|na_fac
argument_list|,
operator|&
name|buffer
index|[
literal|41
index|]
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|buffer
index|[
literal|47
index|]
operator|=
name|nsap
operator|->
name|na_faclen
expr_stmt|;
if|if
condition|(
call|(
modifier|*
name|writefnx
call|)
argument_list|(
name|fd
argument_list|,
name|buffer
argument_list|,
literal|48
argument_list|)
operator|!=
literal|48
condition|)
return|return
name|NOTOK
return|;
return|return
name|OK
return|;
block|}
end_function

begin_function
name|int
name|bridge_read_nsap_addr
parameter_list|(
name|fd
parameter_list|,
name|nsap
parameter_list|,
name|readfnx
parameter_list|)
name|int
name|fd
decl_stmt|;
name|struct
name|NSAPaddr
modifier|*
name|nsap
decl_stmt|;
name|IFP
name|readfnx
decl_stmt|;
block|{
name|u_short
name|na_stack
decl_stmt|;
name|char
name|buffer
index|[
literal|50
index|]
decl_stmt|;
if|if
condition|(
name|readx
argument_list|(
name|fd
argument_list|,
name|buffer
argument_list|,
literal|48
argument_list|,
name|readfnx
argument_list|)
operator|!=
literal|48
condition|)
return|return
name|NOTOK
return|;
name|bcopy
argument_list|(
name|buffer
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|na_stack
argument_list|,
sizeof|sizeof
argument_list|(
name|na_stack
argument_list|)
argument_list|)
expr_stmt|;
name|na_stack
operator|=
name|ntohs
argument_list|(
name|na_stack
argument_list|)
expr_stmt|;
if|if
condition|(
name|na_stack
operator|!=
name|NA_BRG
condition|)
return|return
name|NOTOK
return|;
name|nsap
operator|->
name|na_stack
operator|=
name|na_stack
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|buffer
index|[
literal|2
index|]
argument_list|,
name|nsap
operator|->
name|na_dte
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|nsap
operator|->
name|na_dtelen
operator|=
name|buffer
index|[
literal|18
index|]
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|buffer
index|[
literal|19
index|]
argument_list|,
name|nsap
operator|->
name|na_pid
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|nsap
operator|->
name|na_pidlen
operator|=
name|buffer
index|[
literal|23
index|]
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|buffer
index|[
literal|24
index|]
argument_list|,
name|nsap
operator|->
name|na_cudf
argument_list|,
literal|16
argument_list|)
expr_stmt|;
name|nsap
operator|->
name|na_cudflen
operator|=
name|buffer
index|[
literal|40
index|]
expr_stmt|;
name|bcopy
argument_list|(
operator|&
name|buffer
index|[
literal|41
index|]
argument_list|,
name|nsap
operator|->
name|na_fac
argument_list|,
literal|6
argument_list|)
expr_stmt|;
name|nsap
operator|->
name|na_faclen
operator|=
name|buffer
index|[
literal|47
index|]
expr_stmt|;
return|return
name|OK
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|readx
parameter_list|(
name|fd
parameter_list|,
name|buffer
parameter_list|,
name|n
parameter_list|,
name|readfnx
parameter_list|)
name|int
name|fd
decl_stmt|;
name|char
modifier|*
name|buffer
decl_stmt|;
name|int
name|n
decl_stmt|;
name|IFP
name|readfnx
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|cc
decl_stmt|;
specifier|register
name|char
modifier|*
name|bp
decl_stmt|;
for|for
control|(
name|bp
operator|=
name|buffer
operator|,
name|i
operator|=
name|n
init|;
name|i
operator|>
literal|0
condition|;
name|bp
operator|+=
name|cc
operator|,
name|i
operator|-=
name|cc
control|)
block|{
switch|switch
condition|(
name|cc
operator|=
call|(
modifier|*
name|readfnx
call|)
argument_list|(
name|fd
argument_list|,
name|bp
argument_list|,
name|i
argument_list|)
condition|)
block|{
case|case
name|NOTOK
case|:
return|return
operator|(
name|i
operator|=
name|bp
operator|-
name|buffer
operator|)
condition|?
name|i
else|:
name|NOTOK
return|;
case|case
name|OK
case|:
break|break;
default|default:
continue|continue;
block|}
break|break;
block|}
return|return
operator|(
name|bp
operator|-
name|buffer
operator|)
return|;
block|}
end_function

end_unit


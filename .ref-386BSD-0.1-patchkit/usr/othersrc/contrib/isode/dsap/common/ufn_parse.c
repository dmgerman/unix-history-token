begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* ufn_parse.c - user-friendly name resolution */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/dsap/common/RCS/ufn_parse.c,v 7.3 91/02/22 09:20:42 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*   * $Header: /f/osi/dsap/common/RCS/ufn_parse.c,v 7.3 91/02/22 09:20:42 mrose Interim $  *  *  * $Log:	ufn_parse.c,v $  * Revision 7.3  91/02/22  09:20:42  mrose  * Interim 6.8  *   * Revision 7.2  90/10/17  11:43:08  mrose  * sync  *   * Revision 7.1  90/07/09  14:35:20  mrose  * sync  *   * Revision 7.0  90/06/11  09:59:42  mrose  * *** empty log message ***  *   */
end_comment

begin_comment
comment|/*  *				  NOTICE  *  *    Acquisition, use, and distribution of this module and related  *    materials are subject to the restrictions of a license agreement.  *    Consult the Preface in the User's Manual for the full terms of  *    this agreement.  *  */
end_comment

begin_include
include|#
directive|include
file|"quipu/ufn.h"
end_include

begin_include
include|#
directive|include
file|"tailor.h"
end_include

begin_include
include|#
directive|include
file|"quipu/list.h"
end_include

begin_include
include|#
directive|include
file|"quipu/ds_search.h"
end_include

begin_include
include|#
directive|include
file|"quipu/connection.h"
end_include

begin_comment
comment|/* ds_search uses di_block - include this for lint !!! */
end_comment

begin_include
include|#
directive|include
file|"quipu/dua.h"
end_include

begin_decl_stmt
name|char
name|ufn_notify
init|=
name|FALSE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ufn_flags
init|=
name|UFN_ALL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
name|PY_pepy
index|[]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NOTIFY
parameter_list|(
name|x
parameter_list|)
value|if (ufn_notify) (void) printf x, (void) putchar('\n'); else ;
end_define

begin_decl_stmt
name|AttributeType
name|at_OrgUnit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AttributeType
name|at_Organisation
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AttributeType
name|at_Locality
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AttributeType
name|at_CountryName
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AttributeType
name|at_FriendlyCountryName
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AttributeType
name|at_CommonName
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AttributeType
name|at_Surname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AttributeType
name|at_Userid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|AttributeType
name|at_ObjectClass
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Attr_Sequence
name|ufnas
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|LLog
modifier|*
name|log_dsap
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|extern
name|Filter
name|strfilter
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|Filter
name|ocfilter
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|Filter
name|joinfilter
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
specifier|extern
name|char
modifier|*
name|TidyString
parameter_list|()
function_decl|;
end_function_decl

begin_function
name|DNS
name|DNS_append
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
name|DNS
name|a
decl_stmt|,
name|b
decl_stmt|;
block|{
name|DNS
name|c
decl_stmt|;
if|if
condition|(
name|a
operator|==
name|NULLDNS
condition|)
return|return
name|b
return|;
for|for
control|(
name|c
operator|=
name|a
init|;
name|c
operator|->
name|dns_next
operator|!=
name|NULLDNS
condition|;
name|c
operator|=
name|c
operator|->
name|dns_next
control|)
empty_stmt|;
comment|/* Nothing */
name|c
operator|->
name|dns_next
operator|=
name|b
expr_stmt|;
return|return
name|a
return|;
block|}
end_function

begin_function
specifier|static
name|Attr_Sequence
name|read_cache
parameter_list|(
name|base
parameter_list|)
name|DN
name|base
decl_stmt|;
block|{
name|Entry
name|ptr
decl_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|local_find_entry
argument_list|(
name|base
argument_list|,
name|FALSE
argument_list|)
operator|)
operator|!=
name|NULLENTRY
condition|)
return|return
operator|(
name|ptr
operator|->
name|e_attributes
operator|)
return|;
return|return
name|NULLATTR
return|;
block|}
end_function

begin_function
specifier|static
name|char
name|exact_match
parameter_list|(
name|dn
parameter_list|,
name|s
parameter_list|)
name|DN
name|dn
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|RDN
name|rdn
decl_stmt|;
for|for
control|(
init|;
name|dn
operator|->
name|dn_parent
operator|!=
name|NULLDN
condition|;
name|dn
operator|=
name|dn
operator|->
name|dn_parent
control|)
empty_stmt|;
comment|/* Nothing */
for|for
control|(
name|rdn
operator|=
name|dn
operator|->
name|dn_rdn
init|;
name|rdn
operator|!=
name|NULLRDN
condition|;
name|rdn
operator|=
name|rdn
operator|->
name|rdn_next
control|)
block|{
if|if
condition|(
name|sub_string
argument_list|(
name|rdn
operator|->
name|rdn_av
operator|.
name|av_syntax
argument_list|)
operator|&&
operator|(
name|lexequ
argument_list|(
operator|(
name|char
operator|*
operator|)
name|rdn
operator|->
name|rdn_av
operator|.
name|av_struct
argument_list|,
name|s
argument_list|)
operator|==
literal|0
operator|)
condition|)
return|return
name|TRUE
return|;
block|}
return|return
name|FALSE
return|;
block|}
end_function

begin_function
specifier|static
name|char
name|good_match
parameter_list|(
name|dn
parameter_list|,
name|s
parameter_list|)
name|DN
name|dn
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|Attr_Sequence
name|as
decl_stmt|;
name|AV_Sequence
name|avs
decl_stmt|;
for|for
control|(
name|as
operator|=
name|read_cache
argument_list|(
name|dn
argument_list|)
init|;
name|as
operator|!=
name|NULLATTR
condition|;
name|as
operator|=
name|as
operator|->
name|attr_link
control|)
for|for
control|(
name|avs
operator|=
name|as
operator|->
name|attr_value
init|;
name|avs
operator|!=
name|NULLAV
condition|;
name|avs
operator|=
name|avs
operator|->
name|avseq_next
control|)
if|if
condition|(
name|sub_string
argument_list|(
name|avs
operator|->
name|avseq_av
operator|.
name|av_syntax
argument_list|)
operator|&&
operator|(
name|lexequ
argument_list|(
operator|(
name|char
operator|*
operator|)
name|avs
operator|->
name|avseq_av
operator|.
name|av_struct
argument_list|,
name|s
argument_list|)
operator|==
literal|0
operator|)
condition|)
return|return
name|TRUE
return|;
return|return
name|FALSE
return|;
block|}
end_function

begin_macro
name|dnSelect
argument_list|(
argument|s
argument_list|,
argument|dlist
argument_list|,
argument|interact
argument_list|,
argument|el
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DNS
modifier|*
name|dlist
decl_stmt|;
end_decl_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DNS
name|el
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|DNS
name|exact
init|=
name|NULLDNS
decl_stmt|;
name|DNS
name|good
init|=
name|NULLDNS
decl_stmt|;
name|DNS
name|bad
init|=
name|NULLDNS
decl_stmt|;
name|DNS
name|tmp
decl_stmt|,
name|next
init|=
name|NULLDNS
decl_stmt|;
if|if
condition|(
operator|(
name|dlist
operator|==
operator|(
name|DNS
operator|*
operator|)
name|NULL
operator|)
operator|||
operator|(
operator|*
name|dlist
operator|==
name|NULLDNS
operator|)
condition|)
return|return
literal|2
return|;
for|for
control|(
name|tmp
operator|=
operator|*
name|dlist
init|;
name|tmp
operator|!=
name|NULLDNS
condition|;
name|tmp
operator|=
name|next
control|)
block|{
name|next
operator|=
name|tmp
operator|->
name|dns_next
expr_stmt|;
if|if
condition|(
name|exact_match
argument_list|(
name|tmp
operator|->
name|dns_dn
argument_list|,
name|s
argument_list|)
condition|)
block|{
name|tmp
operator|->
name|dns_next
operator|=
name|exact
expr_stmt|;
name|exact
operator|=
name|tmp
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|good_match
argument_list|(
name|tmp
operator|->
name|dns_dn
argument_list|,
name|s
argument_list|)
condition|)
block|{
name|tmp
operator|->
name|dns_next
operator|=
name|good
expr_stmt|;
name|good
operator|=
name|tmp
expr_stmt|;
block|}
else|else
block|{
name|tmp
operator|->
name|dns_next
operator|=
name|bad
expr_stmt|;
name|bad
operator|=
name|tmp
expr_stmt|;
block|}
block|}
if|if
condition|(
name|exact
condition|)
block|{
name|NOTIFY
argument_list|(
operator|(
literal|"Found exact match(es) for '%s'"
operator|,
name|s
operator|)
argument_list|)
expr_stmt|;
operator|*
name|dlist
operator|=
name|exact
expr_stmt|;
name|dn_seq_free
argument_list|(
name|good
argument_list|)
expr_stmt|;
name|dn_seq_free
argument_list|(
name|bad
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
if|if
condition|(
name|good
condition|)
block|{
name|NOTIFY
argument_list|(
operator|(
literal|"Found good match(es) for '%s'"
operator|,
name|s
operator|)
argument_list|)
expr_stmt|;
operator|*
name|dlist
operator|=
name|good
expr_stmt|;
name|dn_seq_free
argument_list|(
name|bad
argument_list|)
expr_stmt|;
return|return
name|TRUE
return|;
block|}
name|good
operator|=
call|(
modifier|*
name|interact
call|)
argument_list|(
name|bad
argument_list|,
name|el
operator|->
name|dns_dn
argument_list|,
name|s
argument_list|)
expr_stmt|;
operator|*
name|dlist
operator|=
name|good
expr_stmt|;
if|if
condition|(
name|good
operator|!=
name|NULLDNS
condition|)
return|return
name|TRUE
return|;
else|else
return|return
literal|2
return|;
comment|/* back track allowed ! */
block|}
end_block

begin_macro
name|ufn_search
argument_list|(
argument|base
argument_list|,
argument|subtree
argument_list|,
argument|filt
argument_list|,
argument|res
argument_list|,
argument|s
argument_list|,
argument|interact
argument_list|,
argument|el
argument_list|)
end_macro

begin_decl_stmt
name|DN
name|base
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|subtree
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Filter
name|filt
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DNS
modifier|*
name|res
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DNS
name|el
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|ds_search_arg
name|search_arg
decl_stmt|;
specifier|static
name|struct
name|ds_search_result
name|result
decl_stmt|;
name|struct
name|DSError
name|err
decl_stmt|;
specifier|static
name|CommonArgs
name|ca
init|=
name|default_common_args
decl_stmt|;
name|EntryInfo
modifier|*
name|ptr
decl_stmt|;
name|DNS
name|newdns
decl_stmt|,
name|r
init|=
name|NULLDNS
decl_stmt|;
name|search_arg
operator|.
name|sra_baseobject
operator|=
name|base
expr_stmt|;
name|search_arg
operator|.
name|sra_filter
operator|=
name|filt
expr_stmt|;
if|if
condition|(
name|subtree
condition|)
name|search_arg
operator|.
name|sra_subset
operator|=
name|SRA_WHOLESUBTREE
expr_stmt|;
else|else
name|search_arg
operator|.
name|sra_subset
operator|=
name|SRA_ONELEVEL
expr_stmt|;
name|search_arg
operator|.
name|sra_searchaliases
operator|=
name|TRUE
expr_stmt|;
name|search_arg
operator|.
name|sra_common
operator|=
name|ca
expr_stmt|;
comment|/* struct copy */
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_infotypes
operator|=
name|TRUE
expr_stmt|;
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_allattributes
operator|=
name|FALSE
expr_stmt|;
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_select
operator|=
name|ufnas
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|ufn_notify
operator|==
literal|2
condition|)
name|print_search
argument_list|(
name|base
argument_list|,
name|subtree
argument_list|,
name|filt
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ds_search
argument_list|(
operator|&
name|search_arg
argument_list|,
operator|&
name|err
argument_list|,
operator|&
name|result
argument_list|)
operator|!=
name|DS_OK
condition|)
block|{
name|log_ds_error
argument_list|(
operator|&
name|err
argument_list|)
expr_stmt|;
name|NOTIFY
argument_list|(
argument|(
literal|"DAP Search returned an error"
argument|)
argument_list|)
name|ds_error_free
argument_list|(
operator|&
name|err
argument_list|)
expr_stmt|;
name|filter_free
argument_list|(
name|filt
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|filter_free
argument_list|(
name|filt
argument_list|)
expr_stmt|;
name|correlate_search_results
argument_list|(
operator|&
name|result
argument_list|)
expr_stmt|;
name|dn_free
argument_list|(
name|result
operator|.
name|CSR_object
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|result
operator|.
name|CSR_limitproblem
operator|!=
name|LSR_NOLIMITPROBLEM
operator|)
operator|||
operator|(
name|result
operator|.
name|CSR_cr
operator|!=
name|NULLCONTINUATIONREF
operator|)
condition|)
block|{
name|crefs_free
argument_list|(
name|result
operator|.
name|CSR_cr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|result
operator|.
name|CSR_entries
condition|)
block|{
name|NOTIFY
argument_list|(
argument|(
literal|"Search returned partial results"
argument|)
argument_list|)
return|return
name|FALSE
return|;
block|}
name|NOTIFY
argument_list|(
operator|(
literal|"Continuing with partial results !"
operator|)
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|ptr
operator|=
name|result
operator|.
name|CSR_entries
init|;
name|ptr
operator|!=
name|NULLENTRYINFO
condition|;
name|ptr
operator|=
name|ptr
operator|->
name|ent_next
control|)
block|{
name|cache_entry
argument_list|(
name|ptr
argument_list|,
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_allattributes
argument_list|,
name|search_arg
operator|.
name|sra_eis
operator|.
name|eis_infotypes
argument_list|)
expr_stmt|;
name|newdns
operator|=
name|dn_seq_alloc
argument_list|()
expr_stmt|;
name|newdns
operator|->
name|dns_next
operator|=
name|r
expr_stmt|;
name|newdns
operator|->
name|dns_dn
operator|=
name|dn_cpy
argument_list|(
name|ptr
operator|->
name|ent_dn
argument_list|)
expr_stmt|;
name|r
operator|=
name|newdns
expr_stmt|;
block|}
name|entryinfo_free
argument_list|(
name|result
operator|.
name|CSR_entries
argument_list|,
literal|0
argument_list|)
expr_stmt|;
operator|*
name|res
operator|=
name|r
expr_stmt|;
return|return
name|dnSelect
argument_list|(
name|s
argument_list|,
name|res
argument_list|,
name|interact
argument_list|,
name|el
argument_list|)
return|;
block|}
end_block

begin_define
define|#
directive|define
name|SUBSTRINGS
parameter_list|()
value|((ufn_flags& UFN_WILDHEAD) ? FILTERITEM_SUBSTRINGS \ 			 			    : -FILTERITEM_SUBSTRINGS)
end_define

begin_expr_stmt
specifier|static
name|rootSearch
argument_list|(
argument|s
argument_list|,
argument|interact
argument_list|,
argument|el
argument_list|,
argument|result
argument_list|)
name|char
operator|*
name|s
expr_stmt|;
end_expr_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DNS
name|el
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DNS
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Filter
name|filt
decl_stmt|,
name|filta
decl_stmt|,
name|filtb
decl_stmt|,
name|filtc
decl_stmt|,
name|filtd
decl_stmt|,
name|filte
decl_stmt|,
name|filtf
decl_stmt|;
if|if
condition|(
name|check_3166
argument_list|(
name|s
argument_list|)
condition|)
block|{
name|filta
operator|=
name|strfilter
argument_list|(
name|at_CountryName
argument_list|,
name|s
argument_list|,
name|FILTERITEM_EQUALITY
argument_list|)
expr_stmt|;
name|filtb
operator|=
name|strfilter
argument_list|(
name|at_FriendlyCountryName
argument_list|,
name|s
argument_list|,
name|FILTERITEM_EQUALITY
argument_list|)
expr_stmt|;
name|filtb
operator|->
name|flt_next
operator|=
name|filta
expr_stmt|;
name|filtc
operator|=
name|strfilter
argument_list|(
name|at_Organisation
argument_list|,
name|s
argument_list|,
name|FILTERITEM_EQUALITY
argument_list|)
expr_stmt|;
name|filtc
operator|->
name|flt_next
operator|=
name|filtb
expr_stmt|;
name|filt
operator|=
name|joinfilter
argument_list|(
name|filtc
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|filta
operator|=
name|strfilter
argument_list|(
name|at_FriendlyCountryName
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
name|filtc
operator|=
name|strfilter
argument_list|(
name|at_Organisation
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
name|filtc
operator|->
name|flt_next
operator|=
name|filta
expr_stmt|;
name|filte
operator|=
name|strfilter
argument_list|(
name|at_Locality
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
name|filte
operator|->
name|flt_next
operator|=
name|filtc
expr_stmt|;
if|if
condition|(
operator|(
name|ufn_flags
operator|&
name|UFN_APPROX
operator|)
operator|&&
operator|!
name|index
argument_list|(
name|s
argument_list|,
literal|'*'
argument_list|)
condition|)
block|{
name|filtb
operator|=
name|strfilter
argument_list|(
name|at_FriendlyCountryName
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtb
operator|->
name|flt_next
operator|=
name|filte
expr_stmt|;
name|filtd
operator|=
name|strfilter
argument_list|(
name|at_Organisation
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtd
operator|->
name|flt_next
operator|=
name|filtb
expr_stmt|;
name|filtf
operator|=
name|strfilter
argument_list|(
name|at_Locality
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtf
operator|->
name|flt_next
operator|=
name|filtd
expr_stmt|;
name|filt
operator|=
name|joinfilter
argument_list|(
name|filtf
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
block|}
else|else
name|filt
operator|=
name|joinfilter
argument_list|(
name|filte
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
block|}
return|return
name|ufn_search
argument_list|(
name|NULLDN
argument_list|,
name|FALSE
argument_list|,
name|filt
argument_list|,
name|result
argument_list|,
name|s
argument_list|,
name|interact
argument_list|,
name|el
argument_list|)
return|;
block|}
end_block

begin_function
specifier|static
name|char
name|present
parameter_list|(
name|d
parameter_list|,
name|t
parameter_list|)
name|DN
name|d
decl_stmt|;
name|AttributeType
name|t
decl_stmt|;
block|{
name|RDN
name|rdn
decl_stmt|;
for|for
control|(
init|;
name|d
operator|!=
name|NULLDN
condition|;
name|d
operator|=
name|d
operator|->
name|dn_parent
control|)
for|for
control|(
name|rdn
operator|=
name|d
operator|->
name|dn_rdn
init|;
name|rdn
condition|;
name|rdn
operator|=
name|rdn
operator|->
name|rdn_next
control|)
if|if
condition|(
name|AttrT_cmp
argument_list|(
name|rdn
operator|->
name|rdn_at
argument_list|,
name|t
argument_list|)
operator|==
literal|0
condition|)
return|return
name|TRUE
return|;
return|return
name|FALSE
return|;
comment|/* More work ... */
block|}
end_function

begin_expr_stmt
specifier|static
name|intSearch
argument_list|(
argument|base
argument_list|,
argument|s
argument_list|,
argument|interact
argument_list|,
argument|el
argument_list|,
argument|result
argument_list|)
name|DN
name|base
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DNS
name|el
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DNS
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Filter
name|filt
decl_stmt|,
name|filta
decl_stmt|,
name|filtb
decl_stmt|,
name|filtc
decl_stmt|,
name|filtd
decl_stmt|,
name|filte
decl_stmt|,
name|filtf
decl_stmt|,
name|filtg
decl_stmt|,
name|filth
decl_stmt|;
if|if
condition|(
name|present
argument_list|(
name|base
argument_list|,
name|at_OrgUnit
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|filte
operator|=
name|ocfilter
argument_list|(
literal|"OrganizationalUnit"
argument_list|)
operator|)
operator|==
name|NULLFILTER
condition|)
return|return
name|FALSE
return|;
name|filta
operator|=
name|strfilter
argument_list|(
name|at_OrgUnit
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ufn_flags
operator|&
name|UFN_APPROX
operator|)
operator|&&
operator|!
name|index
argument_list|(
name|s
argument_list|,
literal|'*'
argument_list|)
condition|)
block|{
name|filtb
operator|=
name|strfilter
argument_list|(
name|at_OrgUnit
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtb
operator|->
name|flt_next
operator|=
name|filta
expr_stmt|;
name|filt
operator|=
name|joinfilter
argument_list|(
name|filtb
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
block|}
else|else
name|filt
operator|=
name|filta
expr_stmt|;
name|filte
operator|->
name|flt_next
operator|=
name|filt
expr_stmt|;
name|filtf
operator|=
name|joinfilter
argument_list|(
name|filte
argument_list|,
name|FILTER_AND
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|present
argument_list|(
name|base
argument_list|,
name|at_Organisation
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|filte
operator|=
name|ocfilter
argument_list|(
literal|"OrganizationalUnit"
argument_list|)
operator|)
operator|==
name|NULLFILTER
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|(
name|filth
operator|=
name|ocfilter
argument_list|(
literal|"Locality"
argument_list|)
operator|)
operator|==
name|NULLFILTER
condition|)
block|{
name|filter_free
argument_list|(
name|filte
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|filth
operator|->
name|flt_next
operator|=
name|filte
expr_stmt|;
name|filtg
operator|=
name|joinfilter
argument_list|(
name|filth
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
name|filta
operator|=
name|strfilter
argument_list|(
name|at_OrgUnit
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
name|filtc
operator|=
name|strfilter
argument_list|(
name|at_Locality
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
name|filtc
operator|->
name|flt_next
operator|=
name|filta
expr_stmt|;
if|if
condition|(
operator|(
name|ufn_flags
operator|&
name|UFN_APPROX
operator|)
operator|&&
operator|!
name|index
argument_list|(
name|s
argument_list|,
literal|'*'
argument_list|)
condition|)
block|{
name|filtb
operator|=
name|strfilter
argument_list|(
name|at_OrgUnit
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtb
operator|->
name|flt_next
operator|=
name|filtc
expr_stmt|;
name|filtd
operator|=
name|strfilter
argument_list|(
name|at_Locality
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtd
operator|->
name|flt_next
operator|=
name|filtb
expr_stmt|;
name|filt
operator|=
name|joinfilter
argument_list|(
name|filtd
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
block|}
else|else
name|filt
operator|=
name|joinfilter
argument_list|(
name|filtc
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
name|filtg
operator|->
name|flt_next
operator|=
name|filt
expr_stmt|;
name|filtf
operator|=
name|joinfilter
argument_list|(
name|filtg
argument_list|,
name|FILTER_AND
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|present
argument_list|(
name|base
argument_list|,
name|at_Locality
argument_list|)
condition|)
block|{
if|if
condition|(
operator|(
name|filte
operator|=
name|ocfilter
argument_list|(
literal|"Organization"
argument_list|)
operator|)
operator|==
name|NULLFILTER
condition|)
return|return
name|FALSE
return|;
name|filta
operator|=
name|strfilter
argument_list|(
name|at_Organisation
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ufn_flags
operator|&
name|UFN_APPROX
operator|)
operator|&&
operator|!
name|index
argument_list|(
name|s
argument_list|,
literal|'*'
argument_list|)
condition|)
block|{
name|filtb
operator|=
name|strfilter
argument_list|(
name|at_Organisation
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtb
operator|->
name|flt_next
operator|=
name|filta
expr_stmt|;
name|filt
operator|=
name|joinfilter
argument_list|(
name|filtb
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
block|}
else|else
name|filt
operator|=
name|filta
expr_stmt|;
name|filte
operator|->
name|flt_next
operator|=
name|filt
expr_stmt|;
name|filtf
operator|=
name|joinfilter
argument_list|(
name|filte
argument_list|,
name|FILTER_AND
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|filte
operator|=
name|ocfilter
argument_list|(
literal|"Organization"
argument_list|)
operator|)
operator|==
name|NULLFILTER
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|(
name|filth
operator|=
name|ocfilter
argument_list|(
literal|"Locality"
argument_list|)
operator|)
operator|==
name|NULLFILTER
condition|)
block|{
name|filter_free
argument_list|(
name|filte
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|filth
operator|->
name|flt_next
operator|=
name|filte
expr_stmt|;
name|filtg
operator|=
name|joinfilter
argument_list|(
name|filth
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
name|filta
operator|=
name|strfilter
argument_list|(
name|at_Organisation
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
name|filtc
operator|=
name|strfilter
argument_list|(
name|at_Locality
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
name|filtc
operator|->
name|flt_next
operator|=
name|filta
expr_stmt|;
if|if
condition|(
operator|(
name|ufn_flags
operator|&
name|UFN_APPROX
operator|)
operator|&&
operator|!
name|index
argument_list|(
name|s
argument_list|,
literal|'*'
argument_list|)
condition|)
block|{
name|filtb
operator|=
name|strfilter
argument_list|(
name|at_Organisation
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtb
operator|->
name|flt_next
operator|=
name|filtc
expr_stmt|;
name|filtd
operator|=
name|strfilter
argument_list|(
name|at_Locality
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtd
operator|->
name|flt_next
operator|=
name|filtb
expr_stmt|;
name|filt
operator|=
name|joinfilter
argument_list|(
name|filtd
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
block|}
else|else
name|filt
operator|=
name|joinfilter
argument_list|(
name|filtc
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
name|filtg
operator|->
name|flt_next
operator|=
name|filt
expr_stmt|;
name|filtf
operator|=
name|joinfilter
argument_list|(
name|filtg
argument_list|,
name|FILTER_AND
argument_list|)
expr_stmt|;
block|}
return|return
name|ufn_search
argument_list|(
name|base
argument_list|,
name|FALSE
argument_list|,
name|filtf
argument_list|,
name|result
argument_list|,
name|s
argument_list|,
name|interact
argument_list|,
name|el
argument_list|)
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|leafSearch
argument_list|(
argument|base
argument_list|,
argument|s
argument_list|,
argument|subtree
argument_list|,
argument|interact
argument_list|,
argument|el
argument_list|,
argument|result
argument_list|)
name|DN
name|base
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|subtree
decl_stmt|;
end_decl_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DNS
name|el
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DNS
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Filter
name|filt
decl_stmt|,
name|filta
decl_stmt|,
name|filtb
decl_stmt|,
name|filtc
decl_stmt|,
name|filtd
decl_stmt|,
name|filte
decl_stmt|,
name|filtf
decl_stmt|;
name|filta
operator|=
name|strfilter
argument_list|(
name|at_CommonName
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
name|filtc
operator|=
name|strfilter
argument_list|(
name|at_Surname
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
name|filtc
operator|->
name|flt_next
operator|=
name|filta
expr_stmt|;
name|filte
operator|=
name|strfilter
argument_list|(
name|at_Userid
argument_list|,
name|s
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
name|filte
operator|->
name|flt_next
operator|=
name|filtc
expr_stmt|;
if|if
condition|(
operator|(
name|ufn_flags
operator|&
name|UFN_APPROX
operator|)
operator|&&
operator|!
name|index
argument_list|(
name|s
argument_list|,
literal|'*'
argument_list|)
condition|)
block|{
name|filtb
operator|=
name|strfilter
argument_list|(
name|at_CommonName
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtb
operator|->
name|flt_next
operator|=
name|filte
expr_stmt|;
name|filtd
operator|=
name|strfilter
argument_list|(
name|at_Surname
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtd
operator|->
name|flt_next
operator|=
name|filtb
expr_stmt|;
name|filtf
operator|=
name|strfilter
argument_list|(
name|at_Userid
argument_list|,
name|s
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtf
operator|->
name|flt_next
operator|=
name|filtd
expr_stmt|;
name|filt
operator|=
name|joinfilter
argument_list|(
name|filtf
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
block|}
else|else
name|filt
operator|=
name|joinfilter
argument_list|(
name|filte
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
return|return
name|ufn_search
argument_list|(
name|base
argument_list|,
name|subtree
argument_list|,
name|filt
argument_list|,
name|result
argument_list|,
name|s
argument_list|,
name|interact
argument_list|,
name|el
argument_list|)
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|keyedSearch
argument_list|(
argument|base
argument_list|,
argument|t
argument_list|,
argument|v
argument_list|,
argument|interact
argument_list|,
argument|el
argument_list|,
argument|result
argument_list|)
name|DN
name|base
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|t
decl_stmt|,
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DNS
name|el
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DNS
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Filter
name|filt
decl_stmt|,
name|filta
decl_stmt|,
name|filtb
decl_stmt|;
name|AttributeType
name|at
decl_stmt|;
if|if
condition|(
operator|(
name|at
operator|=
name|AttrT_new
argument_list|(
name|t
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|NOTIFY
argument_list|(
operator|(
literal|"Invalid Key !"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
if|if
condition|(
operator|!
name|sub_string
argument_list|(
name|at
operator|->
name|oa_syntax
argument_list|)
condition|)
block|{
name|NOTIFY
argument_list|(
operator|(
literal|"String types only !"
operator|)
argument_list|)
expr_stmt|;
return|return
name|FALSE
return|;
block|}
name|filta
operator|=
name|strfilter
argument_list|(
name|at
argument_list|,
name|v
argument_list|,
name|SUBSTRINGS
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ufn_flags
operator|&
name|UFN_APPROX
operator|)
operator|&&
operator|!
name|index
argument_list|(
name|v
argument_list|,
literal|'*'
argument_list|)
condition|)
block|{
name|filtb
operator|=
name|strfilter
argument_list|(
name|at
argument_list|,
name|v
argument_list|,
name|FILTERITEM_APPROX
argument_list|)
expr_stmt|;
name|filtb
operator|->
name|flt_next
operator|=
name|filta
expr_stmt|;
name|filt
operator|=
name|joinfilter
argument_list|(
name|filtb
argument_list|,
name|FILTER_OR
argument_list|)
expr_stmt|;
block|}
else|else
name|filt
operator|=
name|filta
expr_stmt|;
return|return
name|ufn_search
argument_list|(
name|base
argument_list|,
name|base
operator|&&
name|base
operator|->
name|dn_parent
argument_list|,
name|filt
argument_list|,
name|result
argument_list|,
name|v
argument_list|,
name|interact
argument_list|,
name|el
argument_list|)
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|purportedMatch
argument_list|(
argument|base
argument_list|,
argument|c
argument_list|,
argument|v
argument_list|,
argument|interact
argument_list|,
argument|el
argument_list|,
argument|result
argument_list|)
name|DN
name|base
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DNS
name|el
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DNS
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|DNS
name|root
decl_stmt|,
name|x
decl_stmt|,
name|new
init|=
name|NULLDNS
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|matches
decl_stmt|;
name|s
operator|=
name|TidyString
argument_list|(
name|v
index|[
name|c
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|1
condition|)
block|{
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
name|s
argument_list|,
literal|'='
argument_list|)
operator|)
operator|!=
name|NULLCP
condition|)
block|{
operator|*
name|ptr
operator|++
operator|=
literal|0
expr_stmt|;
name|matches
operator|=
name|keyedSearch
argument_list|(
name|base
argument_list|,
name|SkipSpace
argument_list|(
name|s
argument_list|)
argument_list|,
name|SkipSpace
argument_list|(
name|ptr
argument_list|)
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
name|result
argument_list|)
expr_stmt|;
operator|*
operator|(
operator|--
name|ptr
operator|)
operator|=
literal|'='
expr_stmt|;
return|return
name|matches
return|;
block|}
elseif|else
if|if
condition|(
name|base
operator|==
name|NULLDN
condition|)
block|{
name|matches
operator|=
name|rootSearch
argument_list|(
name|s
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|result
operator|!=
name|NULLDNS
condition|)
return|return
name|matches
return|;
elseif|else
if|if
condition|(
name|matches
operator|==
name|TRUE
condition|)
return|return
name|TRUE
return|;
else|else
return|return
name|leafSearch
argument_list|(
name|base
argument_list|,
name|s
argument_list|,
name|FALSE
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
name|result
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|base
operator|->
name|dn_parent
operator|==
name|NULLDN
condition|)
block|{
comment|/* length == 1 */
name|matches
operator|=
name|intSearch
argument_list|(
name|base
argument_list|,
name|s
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|result
operator|!=
name|NULLDNS
condition|)
return|return
name|matches
return|;
elseif|else
if|if
condition|(
name|matches
operator|==
name|TRUE
condition|)
return|return
name|TRUE
return|;
else|else
return|return
name|leafSearch
argument_list|(
name|base
argument_list|,
name|s
argument_list|,
name|FALSE
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
name|result
argument_list|)
return|;
block|}
else|else
block|{
name|matches
operator|=
name|leafSearch
argument_list|(
name|base
argument_list|,
name|s
argument_list|,
name|TRUE
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
name|result
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|result
operator|!=
name|NULLDNS
condition|)
return|return
name|matches
return|;
elseif|else
if|if
condition|(
name|matches
operator|==
name|TRUE
condition|)
return|return
name|TRUE
return|;
else|else
return|return
name|intSearch
argument_list|(
name|base
argument_list|,
name|s
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
name|result
argument_list|)
return|;
block|}
block|}
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
name|s
argument_list|,
literal|'='
argument_list|)
operator|)
operator|!=
name|NULLCP
condition|)
block|{
operator|*
name|ptr
operator|++
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|matches
operator|=
name|keyedSearch
argument_list|(
name|base
argument_list|,
name|SkipSpace
argument_list|(
name|s
argument_list|)
argument_list|,
name|SkipSpace
argument_list|(
name|ptr
argument_list|)
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
operator|&
name|root
argument_list|)
operator|)
condition|)
block|{
operator|*
operator|(
operator|--
name|ptr
operator|)
operator|=
literal|'='
expr_stmt|;
return|return
name|FALSE
return|;
block|}
operator|*
operator|(
operator|--
name|ptr
operator|)
operator|=
literal|'='
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|base
operator|==
name|NULLDN
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|matches
operator|=
name|rootSearch
argument_list|(
name|s
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
operator|&
name|root
argument_list|)
operator|)
condition|)
return|return
name|FALSE
return|;
block|}
else|else
block|{
if|if
condition|(
operator|!
operator|(
name|matches
operator|=
name|intSearch
argument_list|(
name|base
argument_list|,
name|s
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
operator|&
name|root
argument_list|)
operator|)
condition|)
return|return
name|FALSE
return|;
block|}
for|for
control|(
name|x
operator|=
name|root
init|;
name|x
operator|!=
name|NULLDNS
condition|;
name|x
operator|=
name|x
operator|->
name|dns_next
control|)
block|{
if|if
condition|(
name|purportedMatch
argument_list|(
name|x
operator|->
name|dns_dn
argument_list|,
name|c
operator|-
literal|1
argument_list|,
name|v
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
operator|&
name|new
argument_list|)
condition|)
block|{
if|if
condition|(
name|new
operator|!=
name|NULLDNS
condition|)
operator|*
name|result
operator|=
name|DNS_append
argument_list|(
operator|*
name|result
argument_list|,
name|new
argument_list|)
expr_stmt|;
block|}
else|else
return|return
name|FALSE
return|;
block|}
return|return
name|matches
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|envMatch
argument_list|(
argument|c
argument_list|,
argument|v
argument_list|,
argument|el
argument_list|,
argument|interact
argument_list|,
argument|result
argument_list|)
name|int
name|c
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|DNS
name|el
decl_stmt|;
end_decl_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DNS
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|res
decl_stmt|;
if|if
condition|(
name|el
operator|==
name|NULLDNS
condition|)
return|return
name|TRUE
return|;
if|if
condition|(
operator|!
operator|(
name|res
operator|=
name|purportedMatch
argument_list|(
name|el
operator|->
name|dns_dn
argument_list|,
name|c
argument_list|,
name|v
argument_list|,
name|interact
argument_list|,
name|el
argument_list|,
name|result
argument_list|)
operator|)
condition|)
return|return
name|FALSE
return|;
if|if
condition|(
operator|*
name|result
operator|!=
name|NULLDNS
condition|)
return|return
name|res
return|;
if|if
condition|(
name|res
operator|==
name|TRUE
condition|)
return|return
name|TRUE
return|;
return|return
name|envMatch
argument_list|(
name|c
argument_list|,
name|v
argument_list|,
name|el
operator|->
name|dns_next
argument_list|,
name|interact
argument_list|,
name|result
argument_list|)
return|;
block|}
end_block

begin_expr_stmt
specifier|static
name|friendlyMatch_aux
argument_list|(
argument|c
argument_list|,
argument|v
argument_list|,
argument|el
argument_list|,
argument|interact
argument_list|,
argument|result
argument_list|)
name|int
name|c
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|envlist
name|el
decl_stmt|;
end_decl_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DNS
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|el
operator|==
name|NULLEL
condition|)
return|return
name|TRUE
return|;
if|if
condition|(
operator|(
name|c
operator|<=
name|el
operator|->
name|Upper
operator|)
operator|&&
operator|(
name|c
operator|>=
name|el
operator|->
name|Lower
operator|)
condition|)
return|return
name|envMatch
argument_list|(
name|c
argument_list|,
name|v
argument_list|,
name|el
operator|->
name|Dns
argument_list|,
name|interact
argument_list|,
name|result
argument_list|)
return|;
return|return
operator|(
name|friendlyMatch_aux
argument_list|(
name|c
argument_list|,
name|v
argument_list|,
name|el
operator|->
name|Next
argument_list|,
name|interact
argument_list|,
name|result
argument_list|)
operator|)
return|;
block|}
end_block

begin_function
name|envlist
name|read_envlist
parameter_list|()
block|{
name|char
modifier|*
name|home
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|char
name|ufnrc
index|[
name|LINESIZE
index|]
decl_stmt|;
name|char
modifier|*
name|def
decl_stmt|;
name|char
name|buffer
index|[
name|LINESIZE
index|]
decl_stmt|;
name|envlist
name|env
decl_stmt|,
name|top
init|=
name|NULLEL
decl_stmt|,
name|trail
init|=
name|NULLEL
decl_stmt|;
name|DNS
name|dtail
init|=
name|NULLDNS
decl_stmt|;
name|FILE
modifier|*
name|file
decl_stmt|;
name|DN
name|dn
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|home
operator|=
name|getenv
argument_list|(
literal|"UFNRC"
argument_list|)
condition|)
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ufnrc
argument_list|,
name|home
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|home
operator|=
name|getenv
argument_list|(
literal|"HOME"
argument_list|)
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|ufnrc
argument_list|,
literal|"%s/.ufnrc"
argument_list|,
name|home
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ufnrc
argument_list|,
literal|"./.ufnrc"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|file
operator|=
name|fopen
argument_list|(
name|ufnrc
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
name|def
operator|=
name|isodefile
argument_list|(
literal|"ufnrc"
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|file
operator|=
name|fopen
argument_list|(
name|def
argument_list|,
literal|"r"
argument_list|)
operator|)
operator|==
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|PY_pepy
argument_list|,
literal|"Can't open '%s' or '%s'"
argument_list|,
name|ufnrc
argument_list|,
name|def
argument_list|)
expr_stmt|;
return|return
name|NULLEL
return|;
block|}
block|}
while|while
condition|(
name|fgets
argument_list|(
name|buffer
argument_list|,
name|LINESIZE
argument_list|,
name|file
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|i
operator|++
expr_stmt|;
name|p
operator|=
name|buffer
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|p
operator|==
literal|'#'
operator|)
operator|||
operator|(
operator|*
name|p
operator|==
literal|'\0'
operator|)
operator|||
operator|(
operator|*
name|p
operator|==
literal|'\n'
operator|)
condition|)
continue|continue;
comment|/* ignore comments and blanks */
if|if
condition|(
name|isspace
argument_list|(
operator|*
name|p
argument_list|)
condition|)
block|{
comment|/* part of current environment */
if|if
condition|(
operator|!
name|dtail
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|PY_pepy
argument_list|,
literal|"Unexpected blank at start of line %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
name|NULLEL
return|;
block|}
name|p
operator|=
name|TidyString
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|p
operator|==
literal|'-'
condition|)
name|dn
operator|=
name|NULLDN
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dn
operator|=
name|str2dn
argument_list|(
name|p
argument_list|)
operator|)
operator|==
name|NULLDN
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|PY_pepy
argument_list|,
literal|"Bad DN in environment file line %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
name|NULLEL
return|;
block|}
name|dtail
operator|->
name|dns_next
operator|=
name|dn_seq_alloc
argument_list|()
expr_stmt|;
name|dtail
operator|=
name|dtail
operator|->
name|dns_next
expr_stmt|;
name|dtail
operator|->
name|dns_next
operator|=
name|NULLDNS
expr_stmt|;
name|dtail
operator|->
name|dns_dn
operator|=
name|dn
expr_stmt|;
continue|continue;
block|}
name|p
operator|=
name|TidyString
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
name|p
argument_list|,
literal|':'
argument_list|)
operator|)
operator|==
name|NULLCP
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|PY_pepy
argument_list|,
literal|"':' missing in environment file line %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
name|NULLEL
return|;
block|}
operator|*
name|ptr
operator|++
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
name|SkipSpace
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'-'
condition|)
name|dn
operator|=
name|NULLDN
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|dn
operator|=
name|str2dn
argument_list|(
name|ptr
argument_list|)
operator|)
operator|==
name|NULLDN
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|PY_pepy
argument_list|,
literal|"Bad DN in environment file line %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
name|NULLEL
return|;
block|}
name|env
operator|=
operator|(
name|envlist
operator|)
name|smalloc
argument_list|(
sizeof|sizeof
argument_list|(
operator|*
name|env
argument_list|)
argument_list|)
expr_stmt|;
name|dtail
operator|=
name|env
operator|->
name|Dns
operator|=
name|dn_seq_alloc
argument_list|()
expr_stmt|;
name|dtail
operator|->
name|dns_next
operator|=
name|NULLDNS
expr_stmt|;
name|dtail
operator|->
name|dns_dn
operator|=
name|dn
expr_stmt|;
name|env
operator|->
name|Next
operator|=
name|NULLEL
expr_stmt|;
if|if
condition|(
name|top
operator|==
name|NULLEL
condition|)
name|top
operator|=
name|env
expr_stmt|;
else|else
name|trail
operator|->
name|Next
operator|=
name|env
expr_stmt|;
name|trail
operator|=
name|env
expr_stmt|;
if|if
condition|(
operator|(
name|ptr
operator|=
name|index
argument_list|(
name|p
argument_list|,
literal|','
argument_list|)
operator|)
operator|!=
name|NULLCP
condition|)
block|{
operator|*
name|ptr
operator|++
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
name|SkipSpace
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'+'
condition|)
name|env
operator|->
name|Upper
operator|=
literal|32767
expr_stmt|;
comment|/* ~= infinity */
else|else
name|env
operator|->
name|Upper
operator|=
name|atoi
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
comment|/* how to test error ? */
block|}
else|else
name|env
operator|->
name|Upper
operator|=
literal|0
expr_stmt|;
name|p
operator|=
name|SkipSpace
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|env
operator|->
name|Lower
operator|=
name|atoi
argument_list|(
name|p
argument_list|)
expr_stmt|;
comment|/* how to test error ? */
if|if
condition|(
operator|!
name|env
operator|->
name|Upper
condition|)
name|env
operator|->
name|Upper
operator|=
name|env
operator|->
name|Lower
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|file
argument_list|)
expr_stmt|;
return|return
name|top
return|;
block|}
end_function

begin_macro
name|ufn_match
argument_list|(
argument|c
argument_list|,
argument|v
argument_list|,
argument|interact
argument_list|,
argument|result
argument_list|,
argument|el
argument_list|)
end_macro

begin_decl_stmt
name|int
name|c
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_function_decl
name|DNS
function_decl|(
modifier|*
name|interact
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|DNS
modifier|*
name|result
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|envlist
name|el
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|int
name|inited
init|=
name|FALSE
decl_stmt|;
if|if
condition|(
operator|(
operator|!
name|ufnas
operator|)
operator|&&
operator|!
operator|(
name|inited
operator|=
name|ufn_init
argument_list|()
operator|)
condition|)
return|return
name|inited
return|;
name|PY_pepy
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|el
operator|==
name|NULLEL
condition|)
block|{
if|if
condition|(
operator|(
name|el
operator|=
name|read_envlist
argument_list|()
operator|)
operator|==
name|NULLEL
condition|)
block|{
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|PY_pepy
argument_list|,
literal|"Can't read environment"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
return|return
operator|(
name|friendlyMatch_aux
argument_list|(
name|c
argument_list|,
name|v
argument_list|,
name|el
argument_list|,
name|interact
argument_list|,
name|result
argument_list|)
operator|)
return|;
block|}
end_block

begin_macro
name|ufn_init
argument_list|()
end_macro

begin_block
block|{
name|Attr_Sequence
name|as
decl_stmt|;
name|int
name|result
init|=
name|TRUE
decl_stmt|;
if|if
condition|(
name|ufnas
condition|)
return|return
name|result
return|;
if|if
condition|(
operator|(
name|at_ObjectClass
operator|=
name|AttrT_new
argument_list|(
literal|"ObjectClass"
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|result
operator|=
name|FALSE
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"ObjectClass attribute unknown"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|at_OrgUnit
operator|=
name|AttrT_new
argument_list|(
literal|"ou"
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|result
operator|=
name|FALSE
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"ou attribute unknown"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|at_Organisation
operator|=
name|AttrT_new
argument_list|(
literal|"o"
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|result
operator|=
name|FALSE
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"o attribute unknown"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|at_Locality
operator|=
name|AttrT_new
argument_list|(
literal|"l"
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|result
operator|=
name|FALSE
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"l attribute unknown"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|at_CountryName
operator|=
name|AttrT_new
argument_list|(
literal|"c"
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|result
operator|=
name|FALSE
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"c attribute unknown"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|at_FriendlyCountryName
operator|=
name|AttrT_new
argument_list|(
literal|"FriendlyCountryName"
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|result
operator|=
name|FALSE
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"FriendlyCountryName attribute unknown"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|at_CommonName
operator|=
name|AttrT_new
argument_list|(
name|CN_OID
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|result
operator|=
name|FALSE
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"cn attribute unknown"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|at_Surname
operator|=
name|AttrT_new
argument_list|(
literal|"sn"
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|result
operator|=
name|FALSE
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"sn attribute unknown"
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|at_Userid
operator|=
name|AttrT_new
argument_list|(
literal|"uid"
argument_list|)
operator|)
operator|==
name|NULLAttrT
condition|)
block|{
name|result
operator|=
name|FALSE
expr_stmt|;
name|LLOG
argument_list|(
name|log_dsap
argument_list|,
name|LLOG_EXCEPTIONS
argument_list|,
operator|(
literal|"uid attribute unknown"
operator|)
argument_list|)
expr_stmt|;
block|}
name|ufnas
operator|=
name|as_comp_new
argument_list|(
name|at_OrgUnit
argument_list|,
name|NULLAV
argument_list|,
name|NULLACL_INFO
argument_list|)
expr_stmt|;
name|as
operator|=
name|as_comp_new
argument_list|(
name|at_Organisation
argument_list|,
name|NULLAV
argument_list|,
name|NULLACL_INFO
argument_list|)
expr_stmt|;
name|ufnas
operator|=
name|as_merge
argument_list|(
name|ufnas
argument_list|,
name|as
argument_list|)
expr_stmt|;
name|as
operator|=
name|as_comp_new
argument_list|(
name|at_Locality
argument_list|,
name|NULLAV
argument_list|,
name|NULLACL_INFO
argument_list|)
expr_stmt|;
name|ufnas
operator|=
name|as_merge
argument_list|(
name|ufnas
argument_list|,
name|as
argument_list|)
expr_stmt|;
name|as
operator|=
name|as_comp_new
argument_list|(
name|at_CountryName
argument_list|,
name|NULLAV
argument_list|,
name|NULLACL_INFO
argument_list|)
expr_stmt|;
name|ufnas
operator|=
name|as_merge
argument_list|(
name|ufnas
argument_list|,
name|as
argument_list|)
expr_stmt|;
name|as
operator|=
name|as_comp_new
argument_list|(
name|at_FriendlyCountryName
argument_list|,
name|NULLAV
argument_list|,
name|NULLACL_INFO
argument_list|)
expr_stmt|;
name|ufnas
operator|=
name|as_merge
argument_list|(
name|ufnas
argument_list|,
name|as
argument_list|)
expr_stmt|;
name|as
operator|=
name|as_comp_new
argument_list|(
name|at_CommonName
argument_list|,
name|NULLAV
argument_list|,
name|NULLACL_INFO
argument_list|)
expr_stmt|;
name|ufnas
operator|=
name|as_merge
argument_list|(
name|ufnas
argument_list|,
name|as
argument_list|)
expr_stmt|;
name|as
operator|=
name|as_comp_new
argument_list|(
name|at_Surname
argument_list|,
name|NULLAV
argument_list|,
name|NULLACL_INFO
argument_list|)
expr_stmt|;
name|ufnas
operator|=
name|as_merge
argument_list|(
name|ufnas
argument_list|,
name|as
argument_list|)
expr_stmt|;
name|as
operator|=
name|as_comp_new
argument_list|(
name|at_Userid
argument_list|,
name|NULLAV
argument_list|,
name|NULLACL_INFO
argument_list|)
expr_stmt|;
name|ufnas
operator|=
name|as_merge
argument_list|(
name|ufnas
argument_list|,
name|as
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_block

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_expr_stmt
specifier|static
name|print_search
argument_list|(
argument|dn
argument_list|,
argument|subtree
argument_list|,
argument|fi
argument_list|)
name|DN
name|dn
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
name|subtree
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|Filter
name|fi
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|static
name|PS
name|nps
init|=
name|NULLPS
decl_stmt|;
if|if
condition|(
name|nps
operator|==
name|NULLPS
condition|)
block|{
if|if
condition|(
operator|(
name|nps
operator|=
name|ps_alloc
argument_list|(
name|std_open
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"ps_alloc(std_open): you lose\n"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|std_setup
argument_list|(
name|nps
argument_list|,
name|stdout
argument_list|)
operator|==
name|NOTOK
condition|)
block|{
operator|(
name|void
operator|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"std_setup(stdout): you lose\n"
argument_list|)
expr_stmt|;
name|ps_free
argument_list|(
name|nps
argument_list|)
expr_stmt|;
name|nps
operator|=
name|NULL
expr_stmt|;
return|return;
block|}
block|}
name|ps_printf
argument_list|(
name|nps
argument_list|,
literal|"search starting at @"
argument_list|)
expr_stmt|;
name|dn_print
argument_list|(
name|nps
argument_list|,
name|dn
argument_list|,
name|EDBOUT
argument_list|)
expr_stmt|;
name|ps_printf
argument_list|(
name|nps
argument_list|,
literal|"(%s) for "
argument_list|,
name|subtree
condition|?
literal|"subtree"
else|:
literal|"singlelevel"
argument_list|)
expr_stmt|;
name|print_filter
argument_list|(
name|nps
argument_list|,
name|fi
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ps_print
argument_list|(
name|nps
argument_list|,
literal|"\n\n"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ps_flush
argument_list|(
name|nps
argument_list|)
expr_stmt|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"ntp-config.h"
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|REFCLOCK
argument_list|)
operator|&&
name|defined
argument_list|(
name|PSTI
argument_list|)
end_if

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
modifier|*
name|rcsid
init|=
literal|"$Header: /f/osi/others/ntp/RCS/read_psti.c,v 7.1 91/02/22 09:34:08 mrose Interim $"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|sccsid
init|=
literal|"@(#)read_psti.c	1.1	MS/ACF	89/02/17"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|lint
end_endif

begin_define
define|#
directive|define
name|ERR_RATE
value|60
end_define

begin_comment
comment|/* Repeat errors once an hour */
end_comment

begin_comment
comment|/*  * read_psti.c  *     January 1988 -- orignal by Jeffrey I. Schiller<JIS@BITSY.MIT.EDU>  *     January 1989 -- QU version by Doug Kingston<DPK@Morgan.COM>  *  *   This module facilitates reading a Precision Time Standard, Inc.  *   WWV radio clock. We assume that clock is configured for 9600 baud,  *   no parity. Output is accepted in either 24 or 12 hour format.  *   Time is requested and processed in GMT.  *  *   This version is designed to make use of the QU command due to  *   additional information it provides (like date and flags).  *   Select is used to prevent hanging in a read when there are  *   no characters to read.  The line is run in cooked mode to  *   reduce overhead.  *  *   This requires a PSTI ROM revision later 4.01.000 or later.  *  *   Routines defined:  *	init_clock_psti(): Open the tty associated with the clock and  *			   set its tty mode bits. Returns fd on success  *			   and -1 on failure.  *	read_clock_psti(): Reads the clock and returns either 0 on success  *			   or non-zero on error.  On success, pointers are  *			   provided to the reference and local time.  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/time.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_if
if|#
directive|if
name|defined
argument_list|(
name|sun
argument_list|)
end_if

begin_include
include|#
directive|include
file|<termio.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|DEBUG
end_ifdef

begin_decl_stmt
specifier|extern
name|int
name|debug
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
endif|DEBUG
end_endif

begin_decl_stmt
specifier|static
name|int
name|nerrors
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|clockdata
index|[
literal|32
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|MIN_READ
value|13
end_define

begin_comment
comment|/* for Rev 4.01.001 */
end_comment

begin_function_decl
specifier|static
name|double
name|reltime
parameter_list|()
function_decl|;
end_function_decl

begin_ifdef
ifdef|#
directive|ifdef
name|STANDALONE
end_ifdef

begin_ifndef
ifndef|#
directive|ifndef
name|CLOCKDEV
end_ifndef

begin_define
define|#
directive|define
name|CLOCKDEV
value|"/dev/radioclock"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_define
define|#
directive|define
name|DEBUG
value|1
end_define

begin_decl_stmt
name|int
name|debug
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|struct
name|timeval
modifier|*
name|tvp
decl_stmt|,
modifier|*
name|otvp
decl_stmt|;
name|debug
operator|=
name|argc
expr_stmt|;
if|if
condition|(
name|openclock
argument_list|(
name|CLOCKDEV
argument_list|)
condition|)
do|do
block|{
operator|(
name|void
operator|)
name|readclock
argument_list|(
operator|&
name|tvp
argument_list|,
operator|&
name|otvp
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|debug
operator|>
literal|1
condition|)
do|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_endif
endif|#
directive|endif
endif|STANDALONE
end_endif

begin_macro
name|init_clock_psti
argument_list|(
argument|timesource
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|timesource
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|cfd
decl_stmt|;
ifdef|#
directive|ifdef
name|TCSETA
name|struct
name|termio
name|tty
decl_stmt|;
else|#
directive|else
name|struct
name|sgttyb
name|tty
decl_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|cfd
operator|=
name|open
argument_list|(
name|timesource
argument_list|,
literal|2
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|perror
argument_list|(
name|timesource
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
endif|DEBUG
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|timesource
argument_list|,
literal|"can't open "
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|ioctl
argument_list|(
name|cfd
argument_list|,
name|TIOCEXCL
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|perror
argument_list|(
literal|"TIOCEXCL on radioclock failed"
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
endif|DEBUG
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|timesource
argument_list|,
literal|"TIOCEXCL on "
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
ifdef|#
directive|ifdef
name|TCSETA
if|if
condition|(
name|ioctl
argument_list|(
name|cfd
argument_list|,
name|TCGETA
argument_list|,
operator|&
name|tty
argument_list|)
operator|<
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|perror
argument_list|(
literal|"ioctl on radioclock failed"
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
endif|DEBUG
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|timesource
argument_list|,
literal|"ioctl on failed on"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|tty
operator|.
name|c_cflag
operator|=
operator|(
name|B9600
operator|<<
literal|16
operator|)
operator||
name|B9600
operator||
name|CS8
operator||
name|CLOCAL
operator||
name|CREAD
expr_stmt|;
name|tty
operator|.
name|c_iflag
operator|=
name|ICRNL
expr_stmt|;
name|tty
operator|.
name|c_oflag
operator|=
literal|0
expr_stmt|;
name|tty
operator|.
name|c_lflag
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|tty
operator|.
name|c_cc
argument_list|,
sizeof|sizeof
name|tty
operator|.
name|c_cc
argument_list|)
expr_stmt|;
name|tty
operator|.
name|c_cc
index|[
name|VMIN
index|]
operator|=
name|MIN_READ
expr_stmt|;
name|tty
operator|.
name|c_cc
index|[
name|VTIME
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|cfd
argument_list|,
name|TCSETA
argument_list|,
operator|&
name|tty
argument_list|)
operator|<
literal|0
condition|)
block|{
else|#
directive|else
else|TCSETA
comment|/* Use older Berkeley style IOCTL's */
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|tty
argument_list|,
sizeof|sizeof
name|tty
argument_list|)
expr_stmt|;
name|tty
operator|.
name|sg_ispeed
operator|=
name|tty
operator|.
name|sg_ospeed
operator|=
name|B9600
expr_stmt|;
name|tty
operator|.
name|sg_flags
operator|=
name|ANYP
operator||
name|CRMOD
expr_stmt|;
name|tty
operator|.
name|sg_erase
operator|=
name|tty
operator|.
name|sg_kill
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|cfd
argument_list|,
name|TIOCSETP
argument_list|,
operator|&
name|tty
argument_list|)
operator|<
literal|0
condition|)
block|{
endif|#
directive|endif
endif|TCSETA
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|perror
argument_list|(
literal|"ioctl on radioclock failed"
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
endif|DEBUG
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|timesource
argument_list|,
literal|"ioctl failed on"
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|write
argument_list|(
name|cfd
argument_list|,
literal|"xxxxxxsn\r"
argument_list|,
literal|9
argument_list|)
operator|!=
literal|9
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|perror
argument_list|(
literal|"init write to radioclock failed"
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
endif|DEBUG
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|timesource
argument_list|,
literal|"init write to "
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
return|return
operator|(
name|cfd
operator|)
return|;
comment|/* Succeeded in opening the clock */
block|}
comment|/*  * read_clock_psti() -- Read the PSTI Radio Clock.  */
name|read_clock_psti
argument_list|(
argument|cfd
argument_list|,
argument|tvpp
argument_list|,
argument|otvpp
argument_list|)
name|int
name|cfd
decl_stmt|;
name|struct
name|timeval
modifier|*
modifier|*
name|tvpp
decl_stmt|,
modifier|*
modifier|*
name|otvpp
decl_stmt|;
block|{
specifier|static
name|struct
name|timeval
name|radiotime
decl_stmt|;
specifier|static
name|struct
name|timeval
name|mytime
decl_stmt|;
name|struct
name|timeval
name|timeout
decl_stmt|;
name|struct
name|tm
modifier|*
name|mtm
decl_stmt|;
name|struct
name|tm
name|radio_tm
decl_stmt|,
modifier|*
name|rtm
init|=
operator|&
name|radio_tm
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|millis
decl_stmt|;
specifier|register
name|double
name|diff
decl_stmt|;
name|int
name|stat1
decl_stmt|,
name|stat2
decl_stmt|;
name|fd_set
name|readfds
decl_stmt|;
name|char
name|message
index|[
literal|256
index|]
decl_stmt|;
ifndef|#
directive|ifndef
name|TCSETA
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|int
name|need
decl_stmt|;
endif|#
directive|endif
endif|TCSETA
name|FD_ZERO
argument_list|(
operator|&
name|readfds
argument_list|)
expr_stmt|;
name|FD_SET
argument_list|(
name|cfd
argument_list|,
operator|&
name|readfds
argument_list|)
expr_stmt|;
name|timeout
operator|.
name|tv_sec
operator|=
literal|2
expr_stmt|;
name|timeout
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
operator|(
name|void
operator|)
name|ioctl
argument_list|(
name|cfd
argument_list|,
name|TIOCFLUSH
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* scrap the I/O queues */
comment|/* BEGIN TIME CRITICAL CODE SECTION!!!!!! */
comment|/* EVERY CYCLE FROM THIS POINT OUT ADDS TO THE INACCURACY OF 	     THE READ CLOCK VALUE!!!!! */
if|if
condition|(
name|write
argument_list|(
name|cfd
argument_list|,
literal|"\003qu0000"
argument_list|,
literal|7
argument_list|)
operator|!=
literal|7
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"radioclock write failed\n"
argument_list|)
expr_stmt|;
elseif|else
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|nerrors
operator|++
operator|%
name|ERR_RATE
operator|)
operator|==
literal|0
condition|)
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
literal|"write to radioclock"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|select
argument_list|(
name|cfd
operator|+
literal|1
argument_list|,
operator|&
name|readfds
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
operator|&
name|timeout
argument_list|)
operator|!=
literal|1
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"radioclock poll timed out\n"
argument_list|)
expr_stmt|;
elseif|else
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|nerrors
operator|++
operator|%
name|ERR_RATE
operator|)
operator|==
literal|0
condition|)
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
literal|"poll of radioclock failed"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
if|if
condition|(
operator|(
name|i
operator|=
name|read
argument_list|(
name|cfd
argument_list|,
name|clockdata
argument_list|,
sizeof|sizeof
name|clockdata
argument_list|)
operator|)
operator|<
name|MIN_READ
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"radioclock read error (%d)\n"
argument_list|,
name|i
argument_list|)
expr_stmt|;
elseif|else
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|nerrors
operator|++
operator|%
name|ERR_RATE
operator|)
operator|==
literal|0
condition|)
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
literal|"radioclock read (%d<%d)"
argument_list|,
name|i
argument_list|,
name|MIN_READ
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
operator|(
name|void
operator|)
name|gettimeofday
argument_list|(
operator|&
name|mytime
argument_list|,
operator|(
expr|struct
name|timezone
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
comment|/* END OF TIME CRITICAL CODE SECTION!!!! */
if|if
condition|(
name|clockdata
index|[
name|i
operator|-
literal|1
index|]
operator|!=
literal|'\n'
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"radioclock format error1 (%.12s)(0x%x)\n"
argument_list|,
name|clockdata
argument_list|,
name|clockdata
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
elseif|else
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|nerrors
operator|++
operator|%
name|ERR_RATE
operator|)
operator|==
literal|0
condition|)
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"radioclock format error1 (%.12s)(0x%x)"
argument_list|,
name|clockdata
argument_list|,
name|clockdata
index|[
literal|12
index|]
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|12
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|clockdata
index|[
name|i
index|]
operator|<
literal|'0'
operator|||
name|clockdata
index|[
name|i
index|]
operator|>
literal|'o'
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"radioclock format error2\n"
argument_list|)
expr_stmt|;
elseif|else
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
operator|(
name|nerrors
operator|++
operator|%
name|ERR_RATE
operator|)
operator|==
literal|0
condition|)
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"radioclock format error2\n"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
name|stat1
operator|=
name|clockdata
index|[
literal|0
index|]
operator|-
literal|'0'
expr_stmt|;
name|stat2
operator|=
name|clockdata
index|[
literal|1
index|]
operator|-
literal|'0'
expr_stmt|;
name|millis
operator|=
operator|(
operator|(
name|clockdata
index|[
literal|2
index|]
operator|-
literal|'0'
operator|)
operator|*
literal|64
operator|)
operator|+
operator|(
name|clockdata
index|[
literal|3
index|]
operator|-
literal|'0'
operator|)
expr_stmt|;
name|rtm
operator|->
name|tm_sec
operator|=
operator|(
name|clockdata
index|[
literal|4
index|]
operator|-
literal|'0'
operator|)
expr_stmt|;
name|rtm
operator|->
name|tm_min
operator|=
operator|(
name|clockdata
index|[
literal|5
index|]
operator|-
literal|'0'
operator|)
expr_stmt|;
name|rtm
operator|->
name|tm_hour
operator|=
operator|(
name|clockdata
index|[
literal|6
index|]
operator|-
literal|'0'
operator|)
expr_stmt|;
name|rtm
operator|->
name|tm_yday
operator|=
operator|(
operator|(
name|clockdata
index|[
literal|7
index|]
operator|-
literal|'0'
operator|)
operator|*
literal|64
operator|)
operator|+
operator|(
name|clockdata
index|[
literal|8
index|]
operator|-
literal|'0'
operator|)
operator|-
literal|1
expr_stmt|;
name|rtm
operator|->
name|tm_year
operator|=
literal|86
operator|+
operator|(
name|clockdata
index|[
literal|9
index|]
operator|-
literal|'0'
operator|)
expr_stmt|;
comment|/* byte 10 and 11 reserved */
comment|/* 	 * Correct "hours" based on whether or not AM/PM mode is enabled. 	 * If clock is in 24 hour (military) mode then no correction is 	 * needed. 	 */
if|if
condition|(
name|stat2
operator|&
literal|0x10
condition|)
block|{
comment|/* Map AM/PM time to Military */
if|if
condition|(
name|stat2
operator|&
literal|0x8
condition|)
block|{
if|if
condition|(
name|rtm
operator|->
name|tm_hour
operator|!=
literal|12
condition|)
name|rtm
operator|->
name|tm_hour
operator|+=
literal|12
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|rtm
operator|->
name|tm_hour
operator|==
literal|12
condition|)
name|rtm
operator|->
name|tm_hour
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|stat1
operator|!=
literal|0x4
operator|&&
operator|(
name|nerrors
operator|++
operator|%
name|ERR_RATE
operator|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"radioclock fault #%d 0x%x:%s%s%s%s%s%s\n"
argument_list|,
name|nerrors
argument_list|,
name|stat1
argument_list|,
name|stat1
operator|&
literal|0x20
condition|?
literal|" Out of Spec,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x10
condition|?
literal|" Hardware Fault,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x8
condition|?
literal|" Signal Fault,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x4
condition|?
literal|" Time Avail,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x2
condition|?
literal|" Year Mismatch,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x1
condition|?
literal|" Clock Reset,"
else|:
literal|""
argument_list|)
expr_stmt|;
else|else
block|{
endif|#
directive|endif
endif|DEBUG
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|message
argument_list|,
literal|"radioclock fault #%d 0x%x:%s%s%s%s%s%s\n"
argument_list|,
name|nerrors
argument_list|,
name|stat1
argument_list|,
name|stat1
operator|&
literal|0x20
condition|?
literal|" Out of Spec,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x10
condition|?
literal|" Hardware Fault,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x8
condition|?
literal|" Signal Fault,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x4
condition|?
literal|" Time Avail,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x2
condition|?
literal|" Year Mismatch,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x1
condition|?
literal|" Clock Reset,"
else|:
literal|""
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"%s"
argument_list|,
name|message
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|stat1
operator|&
literal|0x38
condition|)
comment|/* Out of Spec, Hardware Fault, Signal Fault */
return|return
operator|(
literal|1
operator|)
return|;
if|if
condition|(
operator|(
name|millis
operator|>
literal|999
operator|||
name|rtm
operator|->
name|tm_sec
operator|>
literal|60
operator|||
name|rtm
operator|->
name|tm_min
operator|>
literal|60
operator|||
name|rtm
operator|->
name|tm_hour
operator|>
literal|23
operator|||
name|rtm
operator|->
name|tm_yday
operator|>
literal|365
operator|)
operator|&&
operator|(
name|nerrors
operator|++
operator|%
name|ERR_RATE
operator|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"radioclock bogon #%d: %dd %dh %dm %ds %dms\n"
argument_list|,
name|nerrors
argument_list|,
name|rtm
operator|->
name|tm_yday
argument_list|,
name|rtm
operator|->
name|tm_hour
argument_list|,
name|rtm
operator|->
name|tm_min
argument_list|,
name|rtm
operator|->
name|tm_sec
argument_list|,
name|millis
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
endif|DEBUG
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|message
argument_list|,
literal|"radioclock bogon #%d: %dd %dh %dm %ds %dms\n"
argument_list|,
name|nerrors
argument_list|,
name|rtm
operator|->
name|tm_yday
argument_list|,
name|rtm
operator|->
name|tm_hour
argument_list|,
name|rtm
operator|->
name|tm_min
argument_list|,
name|rtm
operator|->
name|tm_sec
argument_list|,
name|millis
argument_list|)
expr_stmt|;
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"%s"
argument_list|,
name|message
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|mtm
operator|=
name|gmtime
argument_list|(
operator|&
name|mytime
operator|.
name|tv_sec
argument_list|)
expr_stmt|;
name|diff
operator|=
name|reltime
argument_list|(
name|rtm
argument_list|,
name|millis
operator|*
literal|1000
argument_list|)
operator|-
name|reltime
argument_list|(
name|mtm
argument_list|,
name|mytime
operator|.
name|tv_usec
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|>
literal|1
condition|)
name|printf
argument_list|(
literal|"Clock time:  19%d day %03d %02d:%02d:%02d.%03d diff %.3f\n"
argument_list|,
name|rtm
operator|->
name|tm_year
argument_list|,
name|rtm
operator|->
name|tm_yday
argument_list|,
name|rtm
operator|->
name|tm_hour
argument_list|,
name|rtm
operator|->
name|tm_min
argument_list|,
name|rtm
operator|->
name|tm_sec
argument_list|,
name|millis
argument_list|,
name|diff
argument_list|)
expr_stmt|;
endif|#
directive|endif
endif|DEBUG
if|if
condition|(
name|diff
operator|>
operator|(
literal|90
operator|*
literal|24
operator|*
literal|60
operator|*
literal|60.0
operator|)
operator|&&
operator|(
name|nerrors
operator|++
operator|%
name|ERR_RATE
operator|)
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"offset excessive (system 19%d/%d, clock 19%d/%d)\n"
argument_list|,
name|mtm
operator|->
name|tm_year
argument_list|,
name|mtm
operator|->
name|tm_yday
argument_list|,
name|rtm
operator|->
name|tm_year
argument_list|,
name|mtm
operator|->
name|tm_yday
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
endif|DEBUG
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
name|NULLCP
argument_list|,
literal|"offset excessive (system 19%d/%d, clock 19%d/%d)\n"
argument_list|,
name|mtm
operator|->
name|tm_year
argument_list|,
name|mtm
operator|->
name|tm_yday
argument_list|,
name|rtm
operator|->
name|tm_year
argument_list|,
name|mtm
operator|->
name|tm_yday
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|diff
operator|+=
operator|(
name|double
operator|)
name|mytime
operator|.
name|tv_sec
operator|+
operator|(
operator|(
name|double
operator|)
name|mytime
operator|.
name|tv_usec
operator|/
literal|1000000.0
operator|)
expr_stmt|;
name|radiotime
operator|.
name|tv_sec
operator|=
name|diff
expr_stmt|;
name|radiotime
operator|.
name|tv_usec
operator|=
operator|(
name|diff
operator|-
operator|(
name|double
operator|)
name|radiotime
operator|.
name|tv_sec
operator|)
operator|*
literal|1000000
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
operator|>
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"System time: 19%d day %03d %02d:%02d:%02d.%03d\n"
argument_list|,
name|mtm
operator|->
name|tm_year
argument_list|,
name|mtm
operator|->
name|tm_yday
argument_list|,
name|mtm
operator|->
name|tm_hour
argument_list|,
name|mtm
operator|->
name|tm_min
argument_list|,
name|mtm
operator|->
name|tm_sec
argument_list|,
name|mytime
operator|.
name|tv_usec
operator|/
literal|1000
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"stat1 0%o, stat2 0%o: "
argument_list|,
name|stat1
argument_list|,
name|stat2
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat1
operator|||
name|stat2
condition|)
name|printf
argument_list|(
literal|"%s%s%s%s%s%s%s%s%s%s%s%s"
argument_list|,
name|stat1
operator|&
literal|0x20
condition|?
literal|" Out of Spec,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x10
condition|?
literal|" Hardware Fault,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x8
condition|?
literal|" Signal Fault,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x4
condition|?
literal|" Time Avail,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x2
condition|?
literal|" Year Mismatch,"
else|:
literal|""
argument_list|,
name|stat1
operator|&
literal|0x1
condition|?
literal|" Clock Reset,"
else|:
literal|""
argument_list|,
name|stat2
operator|&
literal|0x20
condition|?
literal|" DST on,"
else|:
literal|""
argument_list|,
name|stat2
operator|&
literal|0x10
condition|?
literal|" 12hr mode,"
else|:
literal|""
argument_list|,
name|stat2
operator|&
literal|0x8
condition|?
literal|" PM,"
else|:
literal|""
argument_list|,
name|stat2
operator|&
literal|0x4
condition|?
literal|" Spare?,"
else|:
literal|""
argument_list|,
name|stat2
operator|&
literal|0x2
condition|?
literal|" DST??? +1,"
else|:
literal|""
argument_list|,
name|stat2
operator|&
literal|0x1
condition|?
literal|" DST??? -1,"
else|:
literal|""
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
endif|DEBUG
comment|/* If necessary, acknowledge "Clock Reset" flag bit */
if|if
condition|(
name|stat1
operator|&
literal|0x1
condition|)
block|{
if|if
condition|(
name|write
argument_list|(
name|cfd
argument_list|,
literal|"si0"
argument_list|,
literal|3
argument_list|)
operator|!=
literal|3
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|debug
condition|)
name|printf
argument_list|(
literal|"radioclock reset write failed\n"
argument_list|)
expr_stmt|;
else|else
endif|#
directive|endif
endif|DEBUG
name|advise
argument_list|(
name|LLOG_EXCEPTIONS
argument_list|,
literal|"failed"
argument_list|,
literal|"reset write to radioclock"
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
if|if
condition|(
name|nerrors
operator|&&
name|stat1
operator|==
literal|0x4
condition|)
block|{
name|advise
argument_list|(
name|LLOG_NOTICE
argument_list|,
name|NULLCP
argument_list|,
literal|"radioclock OK (after %d errors)"
argument_list|,
name|nerrors
argument_list|)
expr_stmt|;
name|nerrors
operator|=
literal|0
expr_stmt|;
block|}
operator|*
name|tvpp
operator|=
operator|&
name|radiotime
expr_stmt|;
operator|*
name|otvpp
operator|=
operator|&
name|mytime
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
specifier|static
name|double
name|reltime
parameter_list|(
name|tm
parameter_list|,
name|usec
parameter_list|)
specifier|register
name|struct
name|tm
modifier|*
name|tm
decl_stmt|;
specifier|register
name|int
name|usec
decl_stmt|;
block|{
return|return
operator|(
name|tm
operator|->
name|tm_year
operator|*
operator|(
literal|366.0
operator|*
literal|24.0
operator|*
literal|60.0
operator|*
literal|60.0
operator|)
operator|+
name|tm
operator|->
name|tm_yday
operator|*
operator|(
literal|24.0
operator|*
literal|60.0
operator|*
literal|60.0
operator|)
operator|+
name|tm
operator|->
name|tm_hour
operator|*
operator|(
literal|60.0
operator|*
literal|60.0
operator|)
operator|+
name|tm
operator|->
name|tm_min
operator|*
operator|(
literal|60.0
operator|)
operator|+
name|tm
operator|->
name|tm_sec
operator|+
name|usec
operator|/
literal|1000000.0
operator|)
return|;
block|}
end_block

begin_endif
endif|#
directive|endif
end_endif

end_unit


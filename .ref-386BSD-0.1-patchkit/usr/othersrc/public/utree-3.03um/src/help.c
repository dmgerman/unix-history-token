begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *      HELP.C  *      UTREE help routines.  *      3.01-um klin, Sat Apr 20 11:02:33 1991  *      3.03-um klin, Sat Feb 15 18:34:27 1992, Minor changes  *            c klin, Mon Mar 30 11:10:00 1992, Minor changes  *  *      Copyright (c) 1991/92 by Peter Klingebiel& UNIX Magazin Muenchen.  *      For copying and distribution information see the file COPYRIGHT.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#) utree 3.03-um (klin) Mar 30 1992 help.c"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !lint */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_comment
comment|/* ---- Local variables and definitions ------------------------------- */
end_comment

begin_decl_stmt
name|LOCAL
name|hlist
modifier|*
name|hroot
init|=
name|HNULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Root of help pages                   */
end_comment

begin_decl_stmt
name|LOCAL
name|char
modifier|*
name|helpmenu
init|=
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Help menuline                        */
end_comment

begin_decl_stmt
name|LOCAL
name|char
name|helpfile
index|[
name|NAMELEN
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Help file name                       */
end_comment

begin_define
define|#
directive|define
name|LINELEN
value|128
end_define

begin_comment
comment|/* Max line length for help pages       */
end_comment

begin_comment
comment|/* ---- External variables and functions ------------------------------ */
end_comment

begin_function_decl
name|EXTRN
name|long
name|ftell
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* ---- Functions and procedures -------------------------------------- */
end_comment

begin_comment
comment|/*  *      INTERNAL USED ROUTINES  */
end_comment

begin_comment
comment|/* Insert a help page for topic s into help page list for file fp */
end_comment

begin_function
name|LOCAL
name|VOID
name|inserthelp
parameter_list|(
name|s
parameter_list|,
name|fp
parameter_list|)
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|char
name|buf
index|[
name|LINELEN
index|]
decl_stmt|;
specifier|register
name|hlist
modifier|*
name|hp
decl_stmt|,
modifier|*
name|np
decl_stmt|;
specifier|register
name|char
modifier|*
name|i
decl_stmt|,
name|k
decl_stmt|;
specifier|register
name|long
name|p
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
name|p
operator|=
name|ftell
argument_list|(
name|fp
argument_list|)
expr_stmt|;
comment|/* Get position of topic in help file */
name|i
operator|=
name|s
expr_stmt|;
comment|/* and menu line item */
while|while
condition|(
operator|*
name|s
operator|&&
operator|!
operator|(
operator|*
name|s
operator|==
literal|' '
operator|||
operator|*
name|s
operator|==
literal|'\t'
operator|||
operator|*
name|s
operator|==
literal|'\n'
operator|)
condition|)
operator|++
name|s
expr_stmt|;
operator|*
name|s
operator|=
literal|'\0'
expr_stmt|;
comment|/* Count number of lines for this help page */
for|for
control|(
name|n
operator|=
literal|0
init|;
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|;
name|n
operator|++
control|)
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
operator|&&
name|buf
index|[
literal|1
index|]
operator|==
literal|'@'
condition|)
break|break;
if|if
condition|(
operator|*
name|i
operator|&&
name|p
operator|>
literal|0
operator|&&
name|n
operator|>
literal|0
condition|)
block|{
comment|/* Get the hotkey for help menu topic */
name|s
operator|=
name|i
expr_stmt|;
name|k
operator|=
operator|*
name|i
expr_stmt|;
while|while
condition|(
operator|*
name|s
condition|)
block|{
if|if
condition|(
operator|*
name|s
operator|>=
literal|'A'
operator|&&
operator|*
name|s
operator|<=
literal|'Z'
condition|)
block|{
name|k
operator|=
operator|*
name|s
expr_stmt|;
break|break;
block|}
operator|++
name|s
expr_stmt|;
block|}
comment|/* Get space for help page, fill up data and insert into list */
name|hp
operator|=
operator|(
name|hlist
operator|*
operator|)
name|ualloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|hlist
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strncpy
argument_list|(
name|HITEM
argument_list|(
name|hp
argument_list|)
argument_list|,
name|i
argument_list|,
name|ITEMLEN
operator|-
literal|1
argument_list|)
expr_stmt|;
name|HHKEY
argument_list|(
name|hp
argument_list|)
operator|=
name|isupper
argument_list|(
name|k
argument_list|)
condition|?
name|tolower
argument_list|(
name|k
argument_list|)
else|:
name|k
expr_stmt|;
name|HSPOS
argument_list|(
name|hp
argument_list|)
operator|=
name|p
expr_stmt|;
name|HNLIN
argument_list|(
name|hp
argument_list|)
operator|=
name|n
expr_stmt|;
name|HNEXT
argument_list|(
name|hp
argument_list|)
operator|=
name|HNULL
expr_stmt|;
if|if
condition|(
name|hroot
operator|==
name|HNULL
condition|)
name|hroot
operator|=
name|hp
expr_stmt|;
else|else
block|{
for|for
control|(
name|np
operator|=
name|hroot
init|;
name|HNEXT
argument_list|(
name|np
argument_list|)
condition|;
name|np
operator|=
name|HNEXT
argument_list|(
name|np
argument_list|)
control|)
empty_stmt|;
name|HNEXT
argument_list|(
name|np
argument_list|)
operator|=
name|hp
expr_stmt|;
block|}
block|}
block|}
end_function

begin_comment
comment|/* inserthelp() */
end_comment

begin_comment
comment|/* Show help page hp from help file fp */
end_comment

begin_function
name|LOCAL
name|int
name|showhelppage
parameter_list|(
name|hp
parameter_list|,
name|fp
parameter_list|)
specifier|register
name|hlist
modifier|*
name|hp
decl_stmt|;
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
block|{
name|char
name|buf
index|[
name|LINELEN
index|]
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|,
name|l
decl_stmt|,
name|c
decl_stmt|;
name|puthelp
argument_list|(
literal|"%s: About %s (Q:quit  ELSE:helpmenu)"
argument_list|,
name|who
argument_list|,
name|HITEM
argument_list|(
name|hp
argument_list|)
argument_list|)
expr_stmt|;
name|clearwindow
argument_list|(
name|firstline
argument_list|,
name|lastline
argument_list|)
expr_stmt|;
name|flushout
argument_list|()
expr_stmt|;
name|c
operator|=
name|RV_OK
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|0
operator|,
name|l
operator|=
name|firstline
init|;
name|n
operator|<
name|HNLIN
argument_list|(
name|hp
argument_list|)
condition|;
control|)
block|{
if|if
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|)
operator|(
name|void
operator|)
name|putsxy
argument_list|(
literal|0
argument_list|,
name|l
argument_list|,
name|buf
argument_list|)
expr_stmt|;
else|else
break|break;
operator|++
name|n
expr_stmt|;
operator|++
name|l
expr_stmt|;
if|if
condition|(
name|l
operator|>
name|lastfline
operator|&&
name|n
operator|<
name|HNLIN
argument_list|(
name|hp
argument_list|)
condition|)
block|{
name|puthelp
argument_list|(
literal|"%s: About %s (CR:continue  Q:quit  ELSE:helpmenu)"
argument_list|,
name|who
argument_list|,
name|HITEM
argument_list|(
name|hp
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|hitakey
argument_list|(
literal|"Help:"
argument_list|,
name|echoline
argument_list|,
name|DA_NONE
argument_list|)
expr_stmt|;
name|puthelp
argument_list|(
literal|"%s: About %s (Q:quit  ELSE:help)"
argument_list|,
name|who
argument_list|,
name|HITEM
argument_list|(
name|hp
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|c
operator|==
literal|' '
operator|||
name|c
operator|==
literal|'\n'
operator|)
condition|)
break|break;
name|l
operator|=
name|firstline
expr_stmt|;
name|clearwindow
argument_list|(
name|firstline
argument_list|,
name|lastline
argument_list|)
expr_stmt|;
name|flushout
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|c
operator|==
literal|'q'
operator|||
name|c
operator|<
name|RV_NUL
condition|)
return|return
operator|(
name|c
operator|)
return|;
name|puthelp
argument_list|(
literal|"%s: About %s %s"
argument_list|,
name|who
argument_list|,
name|HITEM
argument_list|(
name|hp
argument_list|)
argument_list|,
name|hitkey
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putecho
argument_list|(
literal|"Help about %s done"
argument_list|,
name|HITEM
argument_list|(
name|hp
argument_list|)
argument_list|)
expr_stmt|;
return|return
operator|(
name|hitakey
argument_list|(
name|NULL
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* showhelppage() */
end_comment

begin_comment
comment|/* Utree help pages are contained in a help file. Each help page is     */
end_comment

begin_comment
comment|/* enclosed in a pair of lines '#@item' and '#@' which signal start and */
end_comment

begin_comment
comment|/* end of the help page to topic 'item'. This item is also copied into  */
end_comment

begin_comment
comment|/* the help menuline and the first character or the first upper case    */
end_comment

begin_comment
comment|/* character from item if found is used as hot key for selecting the    */
end_comment

begin_comment
comment|/* help page to this topic. The initialization routine scans the help   */
end_comment

begin_comment
comment|/* file and builds up a list of available help pages from this file.    */
end_comment

begin_function
name|GLOBL
name|VOID
name|inithelp
parameter_list|()
block|{
name|char
name|buf
index|[
name|NAMELEN
index|]
decl_stmt|;
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
specifier|register
name|hlist
modifier|*
name|hp
decl_stmt|;
specifier|register
name|int
name|l
decl_stmt|,
name|i
decl_stmt|;
ifdef|#
directive|ifdef
name|UTHELP
if|if
condition|(
name|startup
argument_list|(
name|buf
argument_list|,
name|UTHELP
argument_list|)
operator|&&
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|buf
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|helpfile
argument_list|,
name|buf
argument_list|)
expr_stmt|;
comment|/* First read help file and insert help pages into list */
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|fp
argument_list|)
condition|)
if|if
condition|(
name|buf
index|[
literal|0
index|]
operator|==
literal|'#'
operator|&&
name|buf
index|[
literal|1
index|]
operator|==
literal|'@'
operator|&&
name|buf
index|[
literal|2
index|]
condition|)
name|inserthelp
argument_list|(
operator|&
name|buf
index|[
literal|2
index|]
argument_list|,
name|fp
argument_list|)
expr_stmt|;
comment|/* Second build from help items the help menu line */
name|l
operator|=
name|columns
operator|-
literal|4
expr_stmt|;
name|helpmenu
operator|=
name|ualloc
argument_list|(
operator|(
name|unsigned
operator|)
name|l
argument_list|,
sizeof|sizeof
argument_list|(
name|char
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|hp
operator|=
name|hroot
operator|,
name|i
operator|=
literal|0
init|;
name|hp
condition|;
name|hp
operator|=
name|HNEXT
argument_list|(
name|hp
argument_list|)
control|)
block|{
name|i
operator|+=
name|strlen
argument_list|(
name|HITEM
argument_list|(
name|hp
argument_list|)
argument_list|)
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|i
operator|>=
name|l
condition|)
break|break;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|helpmenu
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|helpmenu
argument_list|,
name|HITEM
argument_list|(
name|hp
argument_list|)
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|i
operator|+
literal|5
operator|)
operator|<
name|l
condition|)
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|helpmenu
argument_list|,
literal|" Quit"
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
block|}
end_function

begin_comment
comment|/* inithelp() */
end_comment

begin_comment
comment|/* Display help menu and help pages */
end_comment

begin_function
name|GLOBL
name|int
name|showhelp
parameter_list|(
name|k
parameter_list|)
specifier|register
name|int
name|k
decl_stmt|;
block|{
specifier|register
name|FILE
modifier|*
name|fp
decl_stmt|;
specifier|register
name|hlist
modifier|*
name|hp
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|;
name|who
operator|=
literal|"HELP"
expr_stmt|;
if|if
condition|(
name|hroot
operator|==
name|HNULL
operator|||
operator|!
operator|(
name|fp
operator|=
name|fopen
argument_list|(
name|helpfile
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
name|puthelp
argument_list|(
literal|"%s %s"
argument_list|,
name|who
argument_list|,
name|hitkey
argument_list|)
expr_stmt|;
return|return
operator|(
name|errequest
argument_list|(
literal|"Help"
argument_list|,
literal|"Not available"
argument_list|)
operator|)
return|;
block|}
comment|/* Help menu loop */
do|do
block|{
if|if
condition|(
name|k
condition|)
block|{
name|c
operator|=
name|k
expr_stmt|;
name|k
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|!
name|keypressed
argument_list|()
condition|)
block|{
name|putmenu
argument_list|(
literal|"HELP:"
argument_list|,
name|helpmenu
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putecho
argument_list|(
literal|"Help about which topic:"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|c
operator|=
name|hitakey
argument_list|(
name|NULL
argument_list|)
operator|)
operator|==
literal|'q'
operator|||
name|c
operator|<
name|RV_NUL
condition|)
break|break;
block|}
for|for
control|(
name|hp
operator|=
name|hroot
init|;
name|hp
operator|&&
name|HHKEY
argument_list|(
name|hp
argument_list|)
operator|!=
name|c
condition|;
name|hp
operator|=
name|HNEXT
argument_list|(
name|hp
argument_list|)
control|)
empty_stmt|;
if|if
condition|(
name|hp
operator|==
name|HNULL
operator|||
name|fseek
argument_list|(
name|fp
argument_list|,
name|HSPOS
argument_list|(
name|hp
argument_list|)
argument_list|,
literal|0
argument_list|)
condition|)
break|break;
name|c
operator|=
name|showhelppage
argument_list|(
name|hp
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|treeflag
operator|=
name|fileflag
operator|=
name|SF_FULL
expr_stmt|;
block|}
do|while
condition|(
name|c
operator|!=
literal|'q'
operator|&&
name|c
operator|>
name|RV_NUL
condition|)
do|;
comment|/* Close help file and return */
operator|(
name|void
operator|)
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'q'
operator|||
name|c
operator|<
name|RV_NUL
condition|)
return|return
operator|(
name|c
operator|)
return|;
return|return
operator|(
name|putversion
argument_list|(
name|echoline
argument_list|,
literal|"HELP: Done"
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* showhelp() */
end_comment

end_unit


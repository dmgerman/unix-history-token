begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *      STAT.C  *      UTREE file status functions.  *      3.03-um klin, Tue Feb 11 22:47:06 1992, Splitted from comm.c  *            c klin, Mon Mar 30 11:02:24 1992, Minor change in fileaccess()  *  *      Copyright (c) 1991/92 Peter Klingebiel& UNIX Magazin Muenchen.  *      For copying and distribution information see the file COPYRIGHT.  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#) utree 3.03c-um (klin) Mar 30 1992 stat.c"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !lint */
end_comment

begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_comment
comment|/* ---- Local variables and definitions ------------------------------- */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|major
end_ifndef

begin_comment
comment|/* Major number part of a device */
end_comment

begin_define
define|#
directive|define
name|major
parameter_list|(
name|x
parameter_list|)
value|((x>> 8)& 0377)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !major */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|minor
end_ifndef

begin_comment
comment|/* Minor number part of a device */
end_comment

begin_define
define|#
directive|define
name|minor
parameter_list|(
name|x
parameter_list|)
value|(x& 0377)
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* !minor */
end_comment

begin_comment
comment|/* ---- External variables and functions ------------------------------ */
end_comment

begin_comment
comment|/*EXTRN struct passwd *getpwuid(); EXTRN struct passwd *getpwnam(); EXTRN struct group  *getgrgid(); EXTRN struct group  *getgrnam();*/
end_comment

begin_function_decl
name|EXTRN
name|char
modifier|*
name|readdname
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* ---- Functions and procedures -------------------------------------- */
end_comment

begin_comment
comment|/*  *      INTERNAL USED ROUTINES  */
end_comment

begin_comment
comment|/* Return device name for device with device number r from /dev */
end_comment

begin_function
name|LOCAL
name|char
modifier|*
name|devicename
parameter_list|(
name|r
parameter_list|)
name|dev_t
name|r
decl_stmt|;
block|{
specifier|static
name|char
name|pn
index|[
name|NAMELEN
index|]
decl_stmt|;
name|struct
name|stat
name|st
decl_stmt|;
specifier|register
name|DIR
modifier|*
name|dp
decl_stmt|;
specifier|register
name|char
modifier|*
name|fn
decl_stmt|;
if|if
condition|(
name|dp
operator|=
name|opendir
argument_list|(
literal|"/dev"
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|pn
argument_list|,
literal|"/dev/"
argument_list|)
expr_stmt|;
comment|/* Read in all valid entries in /dev */
while|while
condition|(
name|fn
operator|=
name|readdname
argument_list|(
name|dp
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
operator|&
name|pn
index|[
literal|5
index|]
argument_list|,
name|fn
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISBLK
argument_list|(
name|pn
argument_list|,
name|st
argument_list|)
operator|&&
name|st
operator|.
name|st_rdev
operator|==
name|r
condition|)
block|{
comment|/* Match: return pathname of device */
name|closedir
argument_list|(
name|dp
argument_list|)
expr_stmt|;
return|return
operator|(
name|pn
operator|)
return|;
block|}
block|}
name|closedir
argument_list|(
name|dp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|NULL
operator|)
return|;
block|}
end_function

begin_comment
comment|/* devicename() */
end_comment

begin_comment
comment|/* Get and return type of file from stat data st */
end_comment

begin_function
name|LOCAL
name|char
modifier|*
name|filetype
parameter_list|(
name|st
parameter_list|)
specifier|register
name|struct
name|stat
modifier|*
name|st
decl_stmt|;
block|{
specifier|register
name|int
name|f
decl_stmt|;
name|f
operator|=
name|STFMT
argument_list|(
name|st
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|==
name|S_IFDIR
condition|)
comment|/* Directory */
return|return
operator|(
literal|"directory"
operator|)
return|;
elseif|else
if|if
condition|(
name|f
operator|==
name|S_IFBLK
condition|)
comment|/* Block special */
return|return
operator|(
literal|"block special"
operator|)
return|;
elseif|else
if|if
condition|(
name|f
operator|==
name|S_IFCHR
condition|)
comment|/* Character special */
return|return
operator|(
literal|"character special"
operator|)
return|;
elseif|else
if|if
condition|(
name|f
operator|==
name|S_IFREG
condition|)
comment|/* Regular file */
return|return
operator|(
literal|"regular"
operator|)
return|;
ifdef|#
directive|ifdef
name|S_IFSOCK
elseif|else
if|if
condition|(
name|f
operator|==
name|S_IFSOCK
condition|)
comment|/* Socket */
return|return
operator|(
literal|"socket"
operator|)
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|S_IFIFO
elseif|else
if|if
condition|(
name|f
operator|==
name|S_IFIFO
condition|)
comment|/* Named pipe */
return|return
operator|(
literal|"fifo"
operator|)
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|S_IFLAN
elseif|else
if|if
condition|(
name|f
operator|==
name|S_IFLAN
condition|)
comment|/* LAN special */
return|return
operator|(
literal|"network lan special"
operator|)
return|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|S_IFLNK
elseif|else
if|if
condition|(
name|f
operator|==
name|S_IFLNK
condition|)
comment|/* Symbolic link */
return|return
operator|(
literal|"symbolic link"
operator|)
return|;
endif|#
directive|endif
return|return
operator|(
literal|"unkown"
operator|)
return|;
comment|/* Unknown type */
block|}
end_function

begin_comment
comment|/* filetype() */
end_comment

begin_comment
comment|/* Build string containing current permissions */
end_comment

begin_function
name|LOCAL
name|char
modifier|*
name|currentperms
parameter_list|(
name|m
parameter_list|)
name|int
name|m
decl_stmt|;
block|{
specifier|static
name|char
name|ps
index|[
literal|4
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
init|=
name|ps
decl_stmt|;
if|if
condition|(
name|m
operator|&
literal|04
condition|)
operator|*
name|p
operator|++
operator|=
literal|'r'
expr_stmt|;
if|if
condition|(
name|m
operator|&
literal|02
condition|)
operator|*
name|p
operator|++
operator|=
literal|'w'
expr_stmt|;
if|if
condition|(
name|m
operator|&
literal|01
condition|)
operator|*
name|p
operator|++
operator|=
literal|'x'
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|ps
operator|)
return|;
block|}
end_function

begin_comment
comment|/* currentperms() */
end_comment

begin_comment
comment|/* Parse permission string s */
end_comment

begin_function
name|LOCAL
name|int
name|parseperms
parameter_list|(
name|s
parameter_list|)
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
block|{
specifier|register
name|int
name|p
decl_stmt|;
name|p
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|s
condition|)
block|{
switch|switch
condition|(
operator|*
name|s
condition|)
block|{
case|case
literal|'0'
case|:
comment|/* Permission are given octal */
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
return|return
operator|(
operator|*
name|s
operator|-
literal|'0'
operator|)
return|;
case|case
literal|'r'
case|:
comment|/* Read */
name|p
operator||=
literal|004
expr_stmt|;
break|break;
case|case
literal|'w'
case|:
comment|/* Write */
name|p
operator||=
literal|002
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
comment|/* Execute/change */
name|p
operator||=
literal|001
expr_stmt|;
break|break;
case|case
literal|'-'
case|:
comment|/* No permission */
name|p
operator|=
literal|0
expr_stmt|;
break|break;
default|default:
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
operator|++
name|s
expr_stmt|;
block|}
return|return
operator|(
name|p
operator|)
return|;
block|}
end_function

begin_comment
comment|/* parseperms() */
end_comment

begin_comment
comment|/* Get and display status of file pn. Return status record */
end_comment

begin_function
name|LOCAL
name|struct
name|stat
modifier|*
name|filestatus
parameter_list|(
name|pn
parameter_list|)
specifier|register
name|char
modifier|*
name|pn
decl_stmt|;
block|{
specifier|static
name|struct
name|stat
name|st
decl_stmt|;
name|char
modifier|*
name|uid
init|=
literal|"???"
decl_stmt|;
name|char
modifier|*
name|gid
init|=
literal|"???"
decl_stmt|;
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
specifier|register
name|struct
name|group
modifier|*
name|gr
decl_stmt|;
specifier|register
name|char
modifier|*
name|dev
decl_stmt|;
specifier|register
name|int
name|isdir
decl_stmt|,
name|isdev
decl_stmt|,
name|l
decl_stmt|;
ifdef|#
directive|ifdef
name|S_IFLNK
name|char
name|sym
index|[
name|NAMELEN
index|]
decl_stmt|;
name|struct
name|stat
name|lst
decl_stmt|;
name|int
name|n
decl_stmt|,
name|issym
init|=
literal|0
decl_stmt|;
endif|#
directive|endif
comment|/* S_IFLNK */
if|if
condition|(
name|lstat
argument_list|(
name|pn
argument_list|,
operator|&
name|st
argument_list|)
condition|)
comment|/* Get file status information */
return|return
operator|(
operator|(
expr|struct
name|stat
operator|*
operator|)
literal|0
operator|)
return|;
name|clearwindow
argument_list|(
name|firstline
argument_list|,
name|lastline
argument_list|)
expr_stmt|;
name|l
operator|=
name|firstline
expr_stmt|;
name|isdir
operator|=
name|isdev
operator|=
literal|0
expr_stmt|;
comment|/* Display type of file */
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Path: %s"
argument_list|,
name|pn
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Type: %s (octal %06o)"
argument_list|,
name|filetype
argument_list|(
operator|&
name|st
argument_list|)
argument_list|,
name|STFMT
argument_list|(
operator|&
name|st
argument_list|)
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|STFMT
argument_list|(
operator|&
name|st
argument_list|)
condition|)
block|{
case|case
name|S_IFDIR
case|:
comment|/* Directory */
operator|++
name|isdir
expr_stmt|;
break|break;
case|case
name|S_IFBLK
case|:
comment|/* Block special */
case|case
name|S_IFCHR
case|:
comment|/* Character special */
ifdef|#
directive|ifdef
name|S_IFLAN
case|case
name|S_IFLAN
case|:
comment|/* LAN special */
endif|#
directive|endif
operator|++
name|isdev
expr_stmt|;
break|break;
ifdef|#
directive|ifdef
name|S_IFLNK
case|case
name|S_IFLNK
case|:
comment|/* Symbolic link */
operator|++
name|issym
expr_stmt|;
break|break;
endif|#
directive|endif
block|}
comment|/* Display device number if file is a device */
if|if
condition|(
name|isdev
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Device major no: %d, minor no %d"
argument_list|,
name|major
argument_list|(
name|st
operator|.
name|st_rdev
argument_list|)
argument_list|,
name|minor
argument_list|(
name|st
operator|.
name|st_rdev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Display device the file resides on */
if|if
condition|(
operator|!
operator|(
name|dev
operator|=
name|devicename
argument_list|(
name|st
operator|.
name|st_dev
argument_list|)
operator|)
condition|)
name|dev
operator|=
literal|"???"
expr_stmt|;
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Resides on device: %s (major: %d, minor: %d)"
argument_list|,
name|dev
argument_list|,
name|major
argument_list|(
name|st
operator|.
name|st_dev
argument_list|)
argument_list|,
name|minor
argument_list|(
name|st
operator|.
name|st_dev
argument_list|)
argument_list|)
expr_stmt|;
comment|/* Display inode, # of links and size */
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Inode: %d, Links: %d, Size: %ld bytes"
argument_list|,
name|st
operator|.
name|st_ino
argument_list|,
name|st
operator|.
name|st_nlink
argument_list|,
name|st
operator|.
name|st_size
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD
ifndef|#
directive|ifndef
name|titan
comment|/* Display blocksize and allocated blocks */
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Optimal IO blocksize: %ld, Allocated blocks: %ld"
argument_list|,
name|st
operator|.
name|st_blksize
argument_list|,
name|st
operator|.
name|st_blocks
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* titan */
endif|#
directive|endif
comment|/* BSD */
comment|/* Display owner and group of file */
if|if
condition|(
name|pw
operator|=
name|getpwuid
argument_list|(
operator|(
name|int
operator|)
name|st
operator|.
name|st_uid
argument_list|)
condition|)
name|uid
operator|=
name|pw
operator|->
name|pw_name
expr_stmt|;
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Owner: %s (uid: %d)"
argument_list|,
name|uid
argument_list|,
name|st
operator|.
name|st_uid
argument_list|)
expr_stmt|;
if|if
condition|(
name|gr
operator|=
name|getgrgid
argument_list|(
operator|(
name|int
operator|)
name|st
operator|.
name|st_gid
argument_list|)
condition|)
name|gid
operator|=
name|gr
operator|->
name|gr_name
expr_stmt|;
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Group: %s (gid: %d)"
argument_list|,
name|gid
argument_list|,
name|st
operator|.
name|st_gid
argument_list|)
expr_stmt|;
comment|/* Display file permissions for user, group and others */
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Permissions for user:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|st_mode
operator|&
literal|0400
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|24
argument_list|,
name|l
argument_list|,
literal|0
argument_list|,
literal|"read "
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|st_mode
operator|&
literal|0200
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|29
argument_list|,
name|l
argument_list|,
literal|0
argument_list|,
literal|"write"
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|st_mode
operator|&
literal|0100
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|35
argument_list|,
name|l
argument_list|,
literal|0
argument_list|,
name|isdir
condition|?
literal|"search"
else|:
literal|"execute"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|16
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"group:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|st_mode
operator|&
literal|0040
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|24
argument_list|,
name|l
argument_list|,
literal|0
argument_list|,
literal|"read "
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|st_mode
operator|&
literal|0020
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|29
argument_list|,
name|l
argument_list|,
literal|0
argument_list|,
literal|"write"
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|st_mode
operator|&
literal|0010
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|35
argument_list|,
name|l
argument_list|,
literal|0
argument_list|,
name|isdir
condition|?
literal|"search"
else|:
literal|"execute"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|16
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"all:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|st_mode
operator|&
literal|004
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|24
argument_list|,
name|l
argument_list|,
literal|0
argument_list|,
literal|"read "
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|st_mode
operator|&
literal|0002
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|29
argument_list|,
name|l
argument_list|,
literal|0
argument_list|,
literal|"write"
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
operator|.
name|st_mode
operator|&
literal|0001
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|35
argument_list|,
name|l
argument_list|,
literal|0
argument_list|,
name|isdir
condition|?
literal|"search"
else|:
literal|"execute"
argument_list|)
expr_stmt|;
comment|/* Display special access rights */
if|if
condition|(
name|st
operator|.
name|st_mode
operator|&
operator|(
name|S_ISUID
operator||
name|S_ISGID
operator|)
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|16
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Set user and group ID (%s, %s) on execution"
argument_list|,
name|uid
argument_list|,
name|gid
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_ISUID
operator|)
operator|==
name|S_ISUID
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|16
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Set user ID (%s) on execution"
argument_list|,
name|uid
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_ISGID
operator|)
operator|==
name|S_ISGID
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|16
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Set group ID (%s) on execution"
argument_list|,
name|gid
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|st
operator|.
name|st_mode
operator|&
name|S_ISVTX
operator|)
operator|==
name|S_ISVTX
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|16
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Save text image after execution"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|16
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Short form: %s (octal: %04o)"
argument_list|,
name|fileaccess
argument_list|(
operator|&
name|st
argument_list|)
argument_list|,
name|st
operator|.
name|st_mode
operator|&
literal|07777
argument_list|)
expr_stmt|;
comment|/* Display file dates */
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Last access:        %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|st
operator|.
name|st_atime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Last modification:  %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|st
operator|.
name|st_mtime
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Last status change: %s"
argument_list|,
name|ctime
argument_list|(
operator|&
name|st
operator|.
name|st_ctime
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|S_IFLNK
comment|/* Read and display symbolic link */
if|if
condition|(
name|issym
operator|&&
operator|(
name|n
operator|=
name|readlink
argument_list|(
name|pn
argument_list|,
name|sym
argument_list|,
sizeof|sizeof
argument_list|(
name|sym
argument_list|)
argument_list|)
operator|)
operator|>
literal|0
condition|)
block|{
name|sym
index|[
name|n
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Symbolic link to: %s"
argument_list|,
name|sym
argument_list|)
expr_stmt|;
if|if
condition|(
call|(
modifier|*
name|statfun
call|)
argument_list|(
name|sym
argument_list|,
operator|&
name|lst
argument_list|)
condition|)
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Cannot stat type of file"
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|putfxy
argument_list|(
literal|0
argument_list|,
operator|++
name|l
argument_list|,
literal|0
argument_list|,
literal|"Type: %s (octal %06o)"
argument_list|,
name|filetype
argument_list|(
operator|&
name|lst
argument_list|)
argument_list|,
name|STFMT
argument_list|(
operator|&
name|lst
argument_list|)
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
comment|/* S_IFLNK */
return|return
operator|(
operator|&
name|st
operator|)
return|;
block|}
end_function

begin_comment
comment|/* filestatus() */
end_comment

begin_comment
comment|/*  *      FILE STATUS ROUTINES  */
end_comment

begin_comment
comment|/* Get and return file access string (like ls -l) */
end_comment

begin_function
name|GLOBL
name|char
modifier|*
name|fileaccess
parameter_list|(
name|st
parameter_list|)
specifier|register
name|struct
name|stat
modifier|*
name|st
decl_stmt|;
block|{
specifier|static
name|char
name|perm
index|[
literal|10
index|]
decl_stmt|;
comment|/*perm[0] = STFMT(st) == S_IFDIR ? 'd' : '-';*/
name|perm
index|[
literal|0
index|]
operator|=
name|st
operator|->
name|st_mode
operator|&
literal|0400
condition|?
literal|'r'
else|:
literal|'-'
expr_stmt|;
name|perm
index|[
literal|1
index|]
operator|=
name|st
operator|->
name|st_mode
operator|&
literal|0200
condition|?
literal|'w'
else|:
literal|'-'
expr_stmt|;
if|if
condition|(
name|st
operator|->
name|st_mode
operator|&
name|S_ISUID
condition|)
name|perm
index|[
literal|2
index|]
operator|=
literal|'s'
expr_stmt|;
else|else
name|perm
index|[
literal|2
index|]
operator|=
name|st
operator|->
name|st_mode
operator|&
literal|0100
condition|?
literal|'x'
else|:
literal|'-'
expr_stmt|;
name|perm
index|[
literal|3
index|]
operator|=
name|st
operator|->
name|st_mode
operator|&
literal|0040
condition|?
literal|'r'
else|:
literal|'-'
expr_stmt|;
name|perm
index|[
literal|4
index|]
operator|=
name|st
operator|->
name|st_mode
operator|&
literal|0020
condition|?
literal|'w'
else|:
literal|'-'
expr_stmt|;
if|if
condition|(
name|st
operator|->
name|st_mode
operator|&
name|S_ISGID
condition|)
name|perm
index|[
literal|5
index|]
operator|=
literal|'s'
expr_stmt|;
else|else
name|perm
index|[
literal|5
index|]
operator|=
name|st
operator|->
name|st_mode
operator|&
literal|0010
condition|?
literal|'x'
else|:
literal|'-'
expr_stmt|;
name|perm
index|[
literal|6
index|]
operator|=
name|st
operator|->
name|st_mode
operator|&
literal|0004
condition|?
literal|'r'
else|:
literal|'-'
expr_stmt|;
name|perm
index|[
literal|7
index|]
operator|=
name|st
operator|->
name|st_mode
operator|&
literal|0002
condition|?
literal|'w'
else|:
literal|'-'
expr_stmt|;
if|if
condition|(
name|st
operator|->
name|st_mode
operator|&
name|S_ISVTX
condition|)
name|perm
index|[
literal|8
index|]
operator|=
literal|'t'
expr_stmt|;
else|else
name|perm
index|[
literal|8
index|]
operator|=
name|st
operator|->
name|st_mode
operator|&
literal|0001
condition|?
literal|'x'
else|:
literal|'-'
expr_stmt|;
name|perm
index|[
literal|9
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
operator|(
name|perm
operator|)
return|;
block|}
end_function

begin_comment
comment|/* fileaccess() */
end_comment

begin_comment
comment|/* Show all file status information for file fn     */
end_comment

begin_comment
comment|/* Change owner and/or permissions if flag f is set */
end_comment

begin_function
name|GLOBL
name|int
name|statusfile
parameter_list|(
name|fn
parameter_list|,
name|f
parameter_list|)
specifier|register
name|char
modifier|*
name|fn
decl_stmt|;
specifier|register
name|int
name|f
decl_stmt|;
block|{
name|char
name|pnbuf
index|[
name|NAMELEN
index|]
decl_stmt|,
name|buf
index|[
name|INPLEN
index|]
decl_stmt|;
specifier|register
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
specifier|register
name|struct
name|group
modifier|*
name|gr
decl_stmt|;
specifier|register
name|struct
name|stat
modifier|*
name|st
decl_stmt|;
specifier|register
name|char
modifier|*
name|pn
decl_stmt|,
modifier|*
name|ps
decl_stmt|;
specifier|register
name|int
name|mode
decl_stmt|;
specifier|register
name|int
name|c
decl_stmt|;
comment|/* Build full pathname if needed */
if|if
condition|(
name|f
condition|)
block|{
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|pnbuf
argument_list|,
name|pathname
argument_list|(
name|fn
argument_list|,
name|CPNAM
argument_list|)
argument_list|)
expr_stmt|;
name|pn
operator|=
name|pnbuf
expr_stmt|;
block|}
else|else
name|pn
operator|=
name|fn
expr_stmt|;
name|who
operator|=
literal|"STATUS"
expr_stmt|;
comment|/* File status loop */
do|do
block|{
comment|/* Get and display file status information */
ifdef|#
directive|ifdef
name|BSD
name|enablesignals
argument_list|()
expr_stmt|;
endif|#
directive|endif
name|st
operator|=
name|filestatus
argument_list|(
name|pn
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|BSD
name|disablesignals
argument_list|()
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|st
condition|)
block|{
name|c
operator|=
name|errequest
argument_list|(
name|fn
argument_list|,
literal|"Cannot stat"
argument_list|)
expr_stmt|;
break|break;
block|}
name|flushout
argument_list|()
expr_stmt|;
if|if
condition|(
name|f
operator|&&
name|STFMT
argument_list|(
name|st
argument_list|)
operator|==
name|S_IFDIR
condition|)
block|{
comment|/* Changes for directories from tree menu only */
name|puthelp
argument_list|(
literal|"%s (CR:continue  Q:quit)"
argument_list|,
name|who
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putecho
argument_list|(
literal|"Status %s: "
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|c
operator|=
name|hitakey
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
name|puthelp
argument_list|(
literal|"%s (CR:continue  P:permissions  O:owner  G:group  ELSE:quit)"
argument_list|,
name|who
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|putecho
argument_list|(
literal|"Change status %s:"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
name|c
operator|=
name|hitakey
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'p'
condition|)
block|{
comment|/* Change permissions */
name|mode
operator|=
literal|0
expr_stmt|;
name|puthelp
argument_list|(
literal|"CHANGE PERMISSIONS: Octal or string from \'rwx-\' (CR:quit))"
argument_list|)
expr_stmt|;
name|c
operator|=
name|putecho
argument_list|(
literal|"Set permissions for owner to:"
argument_list|)
expr_stmt|;
name|ps
operator|=
name|currentperms
argument_list|(
call|(
name|int
call|)
argument_list|(
name|st
operator|->
name|st_mode
operator|&
literal|0700
argument_list|)
operator|>>
literal|6
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|getline
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|c
argument_list|,
literal|0
argument_list|,
name|ps
argument_list|,
name|GNULL
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|RV_OK
condition|)
break|break;
elseif|else
if|if
condition|(
operator|(
name|c
operator|=
name|parseperms
argument_list|(
name|buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|c
operator|=
name|errequest
argument_list|(
name|buf
argument_list|,
literal|"Bad permissions"
argument_list|)
expr_stmt|;
break|break;
block|}
name|mode
operator|=
name|c
operator|<<
literal|6
expr_stmt|;
name|c
operator|=
name|putecho
argument_list|(
literal|"Set permissions for group to:"
argument_list|)
expr_stmt|;
name|ps
operator|=
name|currentperms
argument_list|(
call|(
name|int
call|)
argument_list|(
name|st
operator|->
name|st_mode
operator|&
literal|0070
argument_list|)
operator|>>
literal|3
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|getline
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|c
argument_list|,
literal|0
argument_list|,
name|ps
argument_list|,
name|GNULL
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|RV_OK
condition|)
break|break;
elseif|else
if|if
condition|(
operator|(
name|c
operator|=
name|parseperms
argument_list|(
name|buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|c
operator|=
name|errequest
argument_list|(
name|buf
argument_list|,
literal|"Bad permissions"
argument_list|)
expr_stmt|;
break|break;
block|}
name|mode
operator||=
name|c
operator|<<
literal|3
expr_stmt|;
name|c
operator|=
name|putecho
argument_list|(
literal|"Set permissions for all to:"
argument_list|)
expr_stmt|;
name|ps
operator|=
name|currentperms
argument_list|(
call|(
name|int
call|)
argument_list|(
name|st
operator|->
name|st_mode
operator|&
literal|0007
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|getline
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|c
argument_list|,
literal|0
argument_list|,
name|ps
argument_list|,
name|GNULL
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|RV_OK
condition|)
break|break;
elseif|else
if|if
condition|(
operator|(
name|c
operator|=
name|parseperms
argument_list|(
name|buf
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|c
operator|=
name|errequest
argument_list|(
name|buf
argument_list|,
literal|"Bad permissions"
argument_list|)
expr_stmt|;
break|break;
block|}
name|mode
operator||=
name|c
expr_stmt|;
if|if
condition|(
name|chmod
argument_list|(
name|pn
argument_list|,
name|mode
argument_list|)
operator|<
literal|0
condition|)
block|{
name|c
operator|=
name|errequest
argument_list|(
name|fn
argument_list|,
literal|"Cannot change permissions"
argument_list|)
expr_stmt|;
break|break;
block|}
operator|++
name|buildflag
expr_stmt|;
name|c
operator|=
literal|'p'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'o'
condition|)
block|{
comment|/* Change owner */
name|puthelp
argument_list|(
literal|"CHANGE OWNER: Give new owner name (CR:quit)"
argument_list|)
expr_stmt|;
name|c
operator|=
name|putecho
argument_list|(
literal|"Change owner of %s to:"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|getline
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|c
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|GNULL
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|RV_OK
condition|)
break|break;
if|if
condition|(
operator|!
operator|(
name|pw
operator|=
name|getpwnam
argument_list|(
name|buf
argument_list|)
operator|)
condition|)
block|{
name|c
operator|=
name|errequest
argument_list|(
name|buf
argument_list|,
literal|"Unknown user"
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|chown
argument_list|(
name|pn
argument_list|,
operator|(
name|int
operator|)
name|pw
operator|->
name|pw_uid
argument_list|,
operator|(
name|int
operator|)
name|st
operator|->
name|st_gid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|c
operator|=
name|errequest
argument_list|(
name|fn
argument_list|,
literal|"Cannot change owner"
argument_list|)
expr_stmt|;
break|break;
block|}
operator|++
name|buildflag
expr_stmt|;
name|c
operator|=
literal|'o'
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'g'
condition|)
block|{
comment|/* Change group */
name|puthelp
argument_list|(
literal|"CHANGE GROUP: Give new group name (CR:quit)"
argument_list|)
expr_stmt|;
name|c
operator|=
name|putecho
argument_list|(
literal|"Change group of %s to:"
argument_list|,
name|fn
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|getline
argument_list|(
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|c
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|GNULL
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
name|RV_OK
condition|)
break|break;
if|if
condition|(
operator|!
operator|(
name|gr
operator|=
name|getgrnam
argument_list|(
name|buf
argument_list|)
operator|)
condition|)
block|{
name|c
operator|=
name|errequest
argument_list|(
name|buf
argument_list|,
literal|"Unknown group"
argument_list|)
expr_stmt|;
break|break;
block|}
elseif|else
if|if
condition|(
name|chown
argument_list|(
name|pn
argument_list|,
operator|(
name|int
operator|)
name|st
operator|->
name|st_uid
argument_list|,
operator|(
name|int
operator|)
name|gr
operator|->
name|gr_gid
argument_list|)
operator|<
literal|0
condition|)
block|{
name|c
operator|=
name|errequest
argument_list|(
name|fn
argument_list|,
literal|"Cannot change group"
argument_list|)
expr_stmt|;
break|break;
block|}
operator|++
name|buildflag
expr_stmt|;
name|c
operator|=
literal|'g'
expr_stmt|;
block|}
block|}
do|while
condition|(
name|c
operator|==
literal|'p'
operator|||
name|c
operator|==
literal|'o'
operator|||
name|c
operator|==
literal|'g'
condition|)
do|;
comment|/* Set screen flags and return */
name|treeflag
operator|=
name|fileflag
operator|=
name|SF_FULL
expr_stmt|;
return|return
operator|(
name|c
operator|)
return|;
block|}
end_function

begin_comment
comment|/* statusfile() */
end_comment

end_unit


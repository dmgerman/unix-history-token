begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Add an MSDOS filesystem to a low level formatted diskette.  *  * Emmet P. Gray			US Army, HQ III Corps& Fort Hood  * ...!uunet!uiucuxc!fthood!egray	Attn: AFZF-DE-ENV  * fthood!egray@uxc.cso.uiuc.edu	Directorate of Engineering& Housing  * 					Environmental Management Office  * 					Fort Hood, TX 76544-5057  */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|"msdos.h"
end_include

begin_include
include|#
directive|include
file|"patchlevel.h"
end_include

begin_decl_stmt
name|int
name|fd
decl_stmt|,
name|dir_dirty
decl_stmt|,
name|dir_entries
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|long
name|dir_chain
index|[
name|MAX_DIR_SECS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|unsigned
name|char
modifier|*
name|dir_buf
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
specifier|extern
name|int
name|optind
decl_stmt|;
specifier|extern
name|char
modifier|*
name|optarg
decl_stmt|;
specifier|extern
name|struct
name|device
name|devices
index|[]
decl_stmt|;
name|struct
name|bootsector
name|boot
decl_stmt|;
name|int
name|i
decl_stmt|,
name|c
decl_stmt|,
name|oops
decl_stmt|,
name|tracks
decl_stmt|,
name|heads
decl_stmt|,
name|sectors
decl_stmt|,
name|fat_len
decl_stmt|,
name|dir_len
decl_stmt|,
name|clus_size
decl_stmt|;
name|int
name|tot_sectors
decl_stmt|,
name|num_clus
decl_stmt|,
name|fat_guess
decl_stmt|;
name|long
name|time
argument_list|()
decl_stmt|,
name|now
decl_stmt|,
name|lseek
argument_list|()
decl_stmt|;
name|char
name|drive
decl_stmt|,
modifier|*
name|name
decl_stmt|,
modifier|*
name|expand
argument_list|()
decl_stmt|;
name|char
modifier|*
name|strncpy
argument_list|()
decl_stmt|,
modifier|*
name|memset
argument_list|()
decl_stmt|,
modifier|*
name|memcpy
argument_list|()
decl_stmt|;
name|unsigned
name|char
name|media
decl_stmt|,
name|label
index|[
literal|12
index|]
decl_stmt|,
name|buf
index|[
name|MSECTOR_SIZE
index|]
decl_stmt|;
name|struct
name|device
modifier|*
name|dev
decl_stmt|;
name|struct
name|directory
modifier|*
name|dir
decl_stmt|,
modifier|*
name|mk_entry
argument_list|()
decl_stmt|;
name|void
name|exit
argument_list|()
decl_stmt|,
name|perror
argument_list|()
decl_stmt|;
name|oops
operator|=
literal|0
expr_stmt|;
name|tracks
operator|=
literal|0
expr_stmt|;
name|heads
operator|=
literal|0
expr_stmt|;
name|sectors
operator|=
literal|0
expr_stmt|;
name|label
index|[
literal|0
index|]
operator|=
literal|'\0'
expr_stmt|;
comment|/* get command line options */
while|while
condition|(
operator|(
name|c
operator|=
name|getopt
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"t:h:s:l:"
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'t'
case|:
name|tracks
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|heads
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'s'
case|:
name|sectors
operator|=
name|atoi
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|sprintf
argument_list|(
operator|(
name|char
operator|*
operator|)
name|label
argument_list|,
literal|"%-11.11s"
argument_list|,
name|optarg
argument_list|)
expr_stmt|;
break|break;
default|default:
name|oops
operator|=
literal|1
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|oops
operator|||
operator|(
name|argc
operator|-
name|optind
operator|)
operator|!=
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Mtools version %s, dated %s\n"
argument_list|,
name|VERSION
argument_list|,
name|DATE
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Usage: %s [-t tracks] [-h heads] [-s sectors] [-l label] device\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|drive
operator|=
name|argv
index|[
name|argc
operator|-
literal|1
index|]
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|islower
argument_list|(
name|drive
argument_list|)
condition|)
name|drive
operator|=
name|toupper
argument_list|(
name|drive
argument_list|)
expr_stmt|;
comment|/* check out the drive letter */
name|dev
operator|=
name|devices
expr_stmt|;
while|while
condition|(
name|dev
operator|->
name|drive
condition|)
block|{
if|if
condition|(
name|dev
operator|->
name|drive
operator|==
name|drive
condition|)
break|break;
name|dev
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|dev
operator|->
name|drive
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Drive '%c:' not supported\n"
argument_list|,
name|drive
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dev
operator|->
name|tracks
operator|==
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Non-removable media is not supported\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* find the right one */
if|if
condition|(
operator|!
name|dev
operator|->
name|gioctl
condition|)
block|{
while|while
condition|(
name|dev
operator|->
name|drive
operator|==
name|drive
condition|)
block|{
if|if
condition|(
operator|(
operator|!
name|tracks
operator|||
name|dev
operator|->
name|tracks
operator|==
name|tracks
operator|)
operator|&&
operator|(
operator|!
name|heads
operator|||
name|dev
operator|->
name|heads
operator|==
name|heads
operator|)
operator|&&
operator|(
operator|!
name|sectors
operator|||
name|dev
operator|->
name|sectors
operator|==
name|sectors
operator|)
condition|)
break|break;
name|dev
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|dev
operator|->
name|drive
operator|!=
name|drive
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Paramaters not supported\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* open the device */
name|name
operator|=
name|expand
argument_list|(
name|dev
operator|->
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|fd
operator|=
name|open
argument_list|(
name|name
argument_list|,
literal|2
operator||
name|dev
operator|->
name|mode
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"init: open"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* fill in the blanks */
if|if
condition|(
operator|!
name|tracks
condition|)
name|tracks
operator|=
name|dev
operator|->
name|tracks
expr_stmt|;
if|if
condition|(
operator|!
name|heads
condition|)
name|heads
operator|=
name|dev
operator|->
name|heads
expr_stmt|;
if|if
condition|(
operator|!
name|sectors
condition|)
name|sectors
operator|=
name|dev
operator|->
name|sectors
expr_stmt|;
comment|/* set parameters, if needed */
if|if
condition|(
name|dev
operator|->
name|gioctl
condition|)
block|{
if|if
condition|(
operator|(
operator|*
operator|(
name|dev
operator|->
name|gioctl
operator|)
operator|)
operator|(
name|fd
operator|,
name|tracks
operator|,
name|heads
operator|,
name|sectors
operator|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* do a "test" read */
if|if
condition|(
name|read
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|MSECTOR_SIZE
argument_list|)
operator|!=
name|MSECTOR_SIZE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s: Error reading from '%s', wrong parameters?\n"
argument_list|,
name|argv
index|[
literal|0
index|]
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* get the parameters */
name|tot_sectors
operator|=
name|tracks
operator|*
name|heads
operator|*
name|sectors
expr_stmt|;
switch|switch
condition|(
name|tot_sectors
condition|)
block|{
case|case
literal|320
case|:
comment|/* 40t * 1h * 8s = 160k */
name|media
operator|=
literal|0xfe
expr_stmt|;
name|clus_size
operator|=
literal|1
expr_stmt|;
name|dir_len
operator|=
literal|4
expr_stmt|;
name|fat_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|360
case|:
comment|/* 40t * 1h * 9s = 180k */
name|media
operator|=
literal|0xfc
expr_stmt|;
name|clus_size
operator|=
literal|1
expr_stmt|;
name|dir_len
operator|=
literal|4
expr_stmt|;
name|fat_len
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|640
case|:
comment|/* 40t * 2h * 8s = 320k */
name|media
operator|=
literal|0xff
expr_stmt|;
name|clus_size
operator|=
literal|2
expr_stmt|;
name|dir_len
operator|=
literal|7
expr_stmt|;
name|fat_len
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|720
case|:
comment|/* 40t * 2h * 9s = 360k */
name|media
operator|=
literal|0xfd
expr_stmt|;
name|clus_size
operator|=
literal|2
expr_stmt|;
name|dir_len
operator|=
literal|7
expr_stmt|;
name|fat_len
operator|=
literal|2
expr_stmt|;
break|break;
case|case
literal|1440
case|:
comment|/* 80t * 2h * 9s = 720k */
name|media
operator|=
literal|0xf9
expr_stmt|;
name|clus_size
operator|=
literal|2
expr_stmt|;
name|dir_len
operator|=
literal|7
expr_stmt|;
name|fat_len
operator|=
literal|3
expr_stmt|;
break|break;
case|case
literal|2400
case|:
comment|/* 80t * 2h * 15s = 1.2m */
name|media
operator|=
literal|0xf9
expr_stmt|;
name|clus_size
operator|=
literal|1
expr_stmt|;
name|dir_len
operator|=
literal|14
expr_stmt|;
name|fat_len
operator|=
literal|7
expr_stmt|;
break|break;
case|case
literal|2880
case|:
comment|/* 80t * 2h * 18s = 1.44m */
name|media
operator|=
literal|0xf0
expr_stmt|;
name|clus_size
operator|=
literal|1
expr_stmt|;
name|dir_len
operator|=
literal|14
expr_stmt|;
name|fat_len
operator|=
literal|9
expr_stmt|;
break|break;
default|default:
comment|/* a non-standard format */
name|media
operator|=
literal|0xf0
expr_stmt|;
if|if
condition|(
name|heads
operator|==
literal|1
condition|)
name|clus_size
operator|=
literal|1
expr_stmt|;
else|else
name|clus_size
operator|=
operator|(
name|tot_sectors
operator|>
literal|2000
operator|)
condition|?
literal|1
else|:
literal|2
expr_stmt|;
if|if
condition|(
name|heads
operator|==
literal|1
condition|)
name|dir_len
operator|=
literal|4
expr_stmt|;
else|else
name|dir_len
operator|=
operator|(
name|tot_sectors
operator|>
literal|2000
operator|)
condition|?
literal|14
else|:
literal|7
expr_stmt|;
comment|/* 			 * Estimate the fat length, then figure it out.  The 			 * 341 is the number of 12 bit fat entries in a sector. 			 */
name|fat_guess
operator|=
operator|(
operator|(
name|tot_sectors
operator|/
name|clus_size
operator|)
operator|/
literal|341.0
operator|)
operator|+
literal|0.95
expr_stmt|;
name|num_clus
operator|=
operator|(
name|tot_sectors
operator|-
name|dir_len
operator|-
operator|(
literal|2
operator|*
name|fat_guess
operator|)
operator|-
literal|1
operator|)
operator|/
name|clus_size
expr_stmt|;
name|fat_len
operator|=
operator|(
name|num_clus
operator|/
literal|341.0
operator|)
operator|+
literal|1
expr_stmt|;
break|break;
block|}
comment|/* the boot sector */
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|boot
argument_list|,
literal|'\0'
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
name|boot
operator|.
name|jump
index|[
literal|0
index|]
operator|=
literal|0xeb
expr_stmt|;
name|boot
operator|.
name|jump
index|[
literal|1
index|]
operator|=
literal|0x44
expr_stmt|;
name|boot
operator|.
name|jump
index|[
literal|2
index|]
operator|=
literal|0x90
expr_stmt|;
name|strncpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|boot
operator|.
name|banner
argument_list|,
literal|"Mtools  "
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|boot
operator|.
name|secsiz
index|[
literal|0
index|]
operator|=
literal|512
operator|%
literal|0x100
expr_stmt|;
name|boot
operator|.
name|secsiz
index|[
literal|1
index|]
operator|=
literal|512
operator|/
literal|0x100
expr_stmt|;
name|boot
operator|.
name|clsiz
operator|=
operator|(
name|unsigned
name|char
operator|)
name|clus_size
expr_stmt|;
name|boot
operator|.
name|nrsvsect
index|[
literal|0
index|]
operator|=
literal|1
expr_stmt|;
name|boot
operator|.
name|nrsvsect
index|[
literal|1
index|]
operator|=
literal|0
expr_stmt|;
name|boot
operator|.
name|nfat
operator|=
literal|2
expr_stmt|;
name|boot
operator|.
name|dirents
index|[
literal|0
index|]
operator|=
operator|(
name|dir_len
operator|*
literal|16
operator|)
operator|%
literal|0x100
expr_stmt|;
name|boot
operator|.
name|dirents
index|[
literal|1
index|]
operator|=
operator|(
name|dir_len
operator|*
literal|16
operator|)
operator|/
literal|0x100
expr_stmt|;
name|boot
operator|.
name|psect
index|[
literal|0
index|]
operator|=
name|tot_sectors
operator|%
literal|0x100
expr_stmt|;
name|boot
operator|.
name|psect
index|[
literal|1
index|]
operator|=
name|tot_sectors
operator|/
literal|0x100
expr_stmt|;
name|boot
operator|.
name|descr
operator|=
name|media
expr_stmt|;
name|boot
operator|.
name|fatlen
index|[
literal|0
index|]
operator|=
name|fat_len
operator|%
literal|0x100
expr_stmt|;
name|boot
operator|.
name|fatlen
index|[
literal|1
index|]
operator|=
name|fat_len
operator|/
literal|0x100
expr_stmt|;
name|boot
operator|.
name|nsect
index|[
literal|0
index|]
operator|=
name|sectors
operator|%
literal|0x100
expr_stmt|;
name|boot
operator|.
name|nsect
index|[
literal|1
index|]
operator|=
name|sectors
operator|/
literal|0x100
expr_stmt|;
name|boot
operator|.
name|nheads
index|[
literal|0
index|]
operator|=
name|heads
operator|%
literal|0x100
expr_stmt|;
name|boot
operator|.
name|nheads
index|[
literal|1
index|]
operator|=
name|heads
operator|/
literal|0x100
expr_stmt|;
comment|/* write the boot */
name|lseek
argument_list|(
name|fd
argument_list|,
literal|0L
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|boot
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
comment|/* first fat */
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
literal|'\0'
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
name|buf
index|[
literal|0
index|]
operator|=
name|media
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
literal|0xff
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0xff
expr_stmt|;
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
literal|'\0'
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|fat_len
condition|;
name|i
operator|++
control|)
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
comment|/* second fat */
name|buf
index|[
literal|0
index|]
operator|=
name|media
expr_stmt|;
name|buf
index|[
literal|1
index|]
operator|=
literal|0xff
expr_stmt|;
name|buf
index|[
literal|2
index|]
operator|=
literal|0xff
expr_stmt|;
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
literal|'\0'
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|fat_len
condition|;
name|i
operator|++
control|)
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
comment|/* the root directory */
if|if
condition|(
name|label
index|[
literal|0
index|]
operator|!=
literal|'\0'
condition|)
block|{
name|time
argument_list|(
operator|&
name|now
argument_list|)
expr_stmt|;
name|dir
operator|=
name|mk_entry
argument_list|(
name|label
argument_list|,
literal|0x08
argument_list|,
literal|0
argument_list|,
literal|0L
argument_list|,
name|now
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
operator|(
name|char
operator|*
operator|)
name|dir
argument_list|,
name|MDIR_SIZE
argument_list|)
expr_stmt|;
block|}
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
literal|'\0'
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|dir_len
condition|;
name|i
operator|++
control|)
name|write
argument_list|(
name|fd
argument_list|,
operator|(
name|char
operator|*
operator|)
name|buf
argument_list|,
name|MSECTOR_SIZE
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* hooks for the missing parts */
end_comment

begin_function
name|void
name|disk_write
parameter_list|()
block|{}
end_function

end_unit


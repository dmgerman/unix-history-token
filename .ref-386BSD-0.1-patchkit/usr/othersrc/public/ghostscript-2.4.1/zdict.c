begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1992 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* zdict.c */
end_comment

begin_comment
comment|/* Dictionary operators for GhostScript */
end_comment

begin_include
include|#
directive|include
file|"ghost.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"oper.h"
end_include

begin_include
include|#
directive|include
file|"dict.h"
end_include

begin_include
include|#
directive|include
file|"dstack.h"
end_include

begin_include
include|#
directive|include
file|"store.h"
end_include

begin_comment
comment|/* dict */
end_comment

begin_function
name|int
name|zdict
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|value
operator|.
name|intval
operator|<
literal|0
operator|||
name|op
operator|->
name|value
operator|.
name|intval
operator|>
name|dict_max_size
condition|)
return|return
name|e_rangecheck
return|;
return|return
name|dict_create
argument_list|(
operator|(
name|uint
operator|)
name|op
operator|->
name|value
operator|.
name|intval
argument_list|,
name|op
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* maxlength */
end_comment

begin_function
name|int
name|zmaxlength
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_dictionary
argument_list|)
expr_stmt|;
name|check_dict_read
argument_list|(
operator|*
name|op
argument_list|)
expr_stmt|;
name|make_int
argument_list|(
name|op
argument_list|,
name|dict_maxlength
argument_list|(
name|op
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setmaxlength */
end_comment

begin_function
name|int
name|zsetmaxlength
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|uint
name|new_size
decl_stmt|;
name|int
name|code
decl_stmt|;
name|os_ptr
name|op1
init|=
name|op
operator|-
literal|1
decl_stmt|;
name|check_type
argument_list|(
operator|*
name|op1
argument_list|,
name|t_dictionary
argument_list|)
expr_stmt|;
name|check_dict_write
argument_list|(
operator|*
name|op1
argument_list|)
expr_stmt|;
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|value
operator|.
name|intval
operator|<
literal|0
operator|||
name|op
operator|->
name|value
operator|.
name|intval
operator|>
name|dict_max_size
condition|)
return|return
name|e_rangecheck
return|;
name|new_size
operator|=
operator|(
name|uint
operator|)
name|op
operator|->
name|value
operator|.
name|intval
expr_stmt|;
if|if
condition|(
name|dict_length
argument_list|(
name|op
operator|-
literal|1
argument_list|)
operator|>
name|new_size
condition|)
return|return
name|e_dictfull
return|;
name|code
operator|=
name|dict_resize
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|new_size
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|>=
literal|0
condition|)
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* begin */
end_comment

begin_function
name|int
name|zbegin
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_dictionary
argument_list|)
expr_stmt|;
name|check_dict_read
argument_list|(
operator|*
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
name|dsp
operator|==
name|dstop
condition|)
return|return
name|e_dictstackoverflow
return|;
operator|++
name|dsp
expr_stmt|;
name|ref_assign
argument_list|(
name|dsp
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* end */
end_comment

begin_function
name|int
name|zend
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
if|if
condition|(
name|dsp
operator|==
name|dstack
operator|+
literal|1
condition|)
return|return
name|e_dictstackunderflow
return|;
name|dsp
operator|--
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* def */
end_comment

begin_comment
comment|/* We make this into a separate procedure because */
end_comment

begin_comment
comment|/* the interpreter will almost always call it directly. */
end_comment

begin_function
name|int
name|zop_def
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|check_op
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r_has_type
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|t_null
argument_list|)
condition|)
return|return
name|e_typecheck
return|;
name|check_dict_write
argument_list|(
operator|*
name|dsp
argument_list|)
expr_stmt|;
return|return
name|dict_put
argument_list|(
name|dsp
argument_list|,
name|op
operator|-
literal|1
argument_list|,
name|op
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|zdef
parameter_list|(
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
init|=
name|zop_def
argument_list|(
name|op
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|code
condition|)
block|{
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* load */
end_comment

begin_function
name|int
name|zload
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|ref
modifier|*
name|pvalue
decl_stmt|;
name|check_op
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r_has_type
argument_list|(
name|op
argument_list|,
name|t_null
argument_list|)
condition|)
return|return
name|e_typecheck
return|;
if|if
condition|(
name|r_has_type
argument_list|(
name|op
argument_list|,
name|t_name
argument_list|)
condition|)
block|{
comment|/* Use the fast lookup */
if|if
condition|(
operator|(
name|pvalue
operator|=
name|dict_find_name
argument_list|(
name|op
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
name|e_undefined
return|;
block|}
else|else
block|{
if|if
condition|(
name|dict_lookup
argument_list|(
name|dstack
argument_list|,
name|dsp
argument_list|,
name|op
argument_list|,
operator|&
name|pvalue
argument_list|)
operator|<=
literal|0
condition|)
return|return
name|e_undefined
return|;
block|}
name|ref_assign
argument_list|(
name|op
argument_list|,
name|pvalue
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* store */
end_comment

begin_function
name|int
name|zstore
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|ref
modifier|*
name|pvalue
decl_stmt|;
name|int
name|code
decl_stmt|;
name|check_op
argument_list|(
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|r_has_type
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|t_null
argument_list|)
condition|)
return|return
name|e_typecheck
return|;
if|if
condition|(
name|dict_lookup
argument_list|(
name|dstack
argument_list|,
name|dsp
argument_list|,
name|op
operator|-
literal|1
argument_list|,
operator|&
name|pvalue
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|code
operator|=
name|dict_put
argument_list|(
name|dsp
argument_list|,
name|op
operator|-
literal|1
argument_list|,
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
condition|)
return|return
name|code
return|;
block|}
else|else
name|ref_assign_old
argument_list|(
name|pvalue
argument_list|,
name|op
argument_list|,
literal|"store"
argument_list|)
expr_stmt|;
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* get - implemented in zgeneric.c */
end_comment

begin_comment
comment|/* put - implemented in zgeneric.c */
end_comment

begin_comment
comment|/* undef */
end_comment

begin_function
name|int
name|zundef
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|check_type
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
argument_list|,
name|t_dictionary
argument_list|)
expr_stmt|;
name|check_dict_write
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r_has_type
argument_list|(
name|op
argument_list|,
name|t_null
argument_list|)
condition|)
name|dict_undef
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|op
argument_list|)
expr_stmt|;
comment|/* ignore undefined error */
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* known */
end_comment

begin_function
name|int
name|zknown
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|os_ptr
name|op1
init|=
name|op
operator|-
literal|1
decl_stmt|;
name|ref
modifier|*
name|pvalue
decl_stmt|;
name|check_type
argument_list|(
operator|*
name|op1
argument_list|,
name|t_dictionary
argument_list|)
expr_stmt|;
name|check_dict_read
argument_list|(
operator|*
name|op1
argument_list|)
expr_stmt|;
name|make_bool
argument_list|(
name|op1
argument_list|,
operator|(
name|r_has_type
argument_list|(
name|op
argument_list|,
name|t_null
argument_list|)
condition|?
literal|0
else|:
name|dict_find
argument_list|(
name|op1
argument_list|,
name|op
argument_list|,
operator|&
name|pvalue
argument_list|)
operator|>
literal|0
condition|?
literal|1
else|:
literal|0
operator|)
argument_list|)
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* where */
end_comment

begin_function
name|int
name|zwhere
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|ref
modifier|*
name|pdref
init|=
name|dsp
decl_stmt|;
name|ref
modifier|*
name|pvalue
decl_stmt|;
name|check_op
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|r_has_type
argument_list|(
name|op
argument_list|,
name|t_null
argument_list|)
condition|)
block|{
name|make_bool
argument_list|(
name|op
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
while|while
condition|(
literal|1
condition|)
block|{
name|check_dict_read
argument_list|(
operator|*
name|pdref
argument_list|)
expr_stmt|;
if|if
condition|(
name|dict_find
argument_list|(
name|pdref
argument_list|,
name|op
argument_list|,
operator|&
name|pvalue
argument_list|)
operator|>
literal|0
condition|)
break|break;
if|if
condition|(
operator|--
name|pdref
operator|<
name|dstack
condition|)
block|{
name|make_bool
argument_list|(
name|op
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
block|}
name|ref_assign
argument_list|(
name|op
argument_list|,
name|pdref
argument_list|)
expr_stmt|;
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|make_bool
argument_list|(
name|op
argument_list|,
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* copy for dictionaries -- called from zcopy in zgeneric.c. */
end_comment

begin_comment
comment|/* Only the type of *op has been checked. */
end_comment

begin_function
name|int
name|zcopy_dict
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|os_ptr
name|op1
init|=
name|op
operator|-
literal|1
decl_stmt|;
name|check_type
argument_list|(
operator|*
name|op1
argument_list|,
name|t_dictionary
argument_list|)
expr_stmt|;
name|check_dict_read
argument_list|(
operator|*
name|op1
argument_list|)
expr_stmt|;
name|check_dict_write
argument_list|(
operator|*
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|dict_auto_expand
operator|&&
operator|(
name|dict_length
argument_list|(
name|op
argument_list|)
operator|!=
literal|0
operator|||
name|dict_maxlength
argument_list|(
name|op
argument_list|)
operator|<
name|dict_length
argument_list|(
name|op1
argument_list|)
operator|)
condition|)
return|return
name|e_rangecheck
return|;
name|dict_copy
argument_list|(
name|op1
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|ref_assign
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* currentdict */
end_comment

begin_function
name|int
name|zcurrentdict
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ref_assign
argument_list|(
name|op
argument_list|,
name|dsp
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* countdictstack */
end_comment

begin_function
name|int
name|zcountdictstack
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|make_int
argument_list|(
name|op
argument_list|,
name|dsp
operator|-
name|dstack
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* dictstack */
end_comment

begin_function
name|int
name|zdictstack
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|depth
init|=
name|dsp
operator|-
name|dstack
operator|+
literal|1
decl_stmt|;
name|check_write_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_array
argument_list|)
expr_stmt|;
if|if
condition|(
name|depth
operator|>
name|r_size
argument_list|(
name|op
argument_list|)
condition|)
return|return
name|e_rangecheck
return|;
name|r_set_size
argument_list|(
name|op
argument_list|,
name|depth
argument_list|)
expr_stmt|;
name|refcpy_to_old
argument_list|(
name|op
operator|->
name|value
operator|.
name|refs
argument_list|,
name|dstack
argument_list|,
name|depth
argument_list|,
literal|"dictstack"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* cleardictstack */
end_comment

begin_function
name|int
name|zcleardictstack
parameter_list|(
name|os_ptr
name|op
parameter_list|)
block|{
name|dsp
operator|=
name|dstack
operator|+
literal|1
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ------ Initialization procedure ------ */
end_comment

begin_decl_stmt
name|op_def
name|zdict_op_defs
index|[]
init|=
block|{
block|{
literal|"0cleardictstack"
block|,
name|zcleardictstack
block|}
block|,
block|{
literal|"1begin"
block|,
name|zbegin
block|}
block|,
block|{
literal|"0countdictstack"
block|,
name|zcountdictstack
block|}
block|,
block|{
literal|"0currentdict"
block|,
name|zcurrentdict
block|}
block|,
block|{
literal|"2def"
block|,
name|zdef
block|}
block|,
block|{
literal|"1dict"
block|,
name|zdict
block|}
block|,
block|{
literal|"0dictstack"
block|,
name|zdictstack
block|}
block|,
block|{
literal|"0end"
block|,
name|zend
block|}
block|,
block|{
literal|"2known"
block|,
name|zknown
block|}
block|,
block|{
literal|"1load"
block|,
name|zload
block|}
block|,
block|{
literal|"1maxlength"
block|,
name|zmaxlength
block|}
block|,
block|{
literal|"2setmaxlength"
block|,
name|zsetmaxlength
block|}
block|,
block|{
literal|"2store"
block|,
name|zstore
block|}
block|,
block|{
literal|"2undef"
block|,
name|zundef
block|}
block|,
block|{
literal|"1where"
block|,
name|zwhere
block|}
block|,
name|op_def_end
argument_list|(
literal|0
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

end_unit


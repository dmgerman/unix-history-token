begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1992 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* zgstate.c */
end_comment

begin_comment
comment|/* Graphics state operators for Ghostscript */
end_comment

begin_include
include|#
directive|include
file|"ghost.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"oper.h"
end_include

begin_include
include|#
directive|include
file|"alloc.h"
end_include

begin_include
include|#
directive|include
file|"gsmatrix.h"
end_include

begin_include
include|#
directive|include
file|"gsstate.h"
end_include

begin_include
include|#
directive|include
file|"state.h"
end_include

begin_include
include|#
directive|include
file|"store.h"
end_include

begin_comment
comment|/* Forward references */
end_comment

begin_decl_stmt
name|private
name|int
name|near
name|num_param
argument_list|(
name|P2
argument_list|(
name|os_ptr
argument_list|,
name|int
argument_list|(
operator|*
argument_list|)
argument_list|(
name|P2
argument_list|(
name|gs_state
operator|*
argument_list|,
name|floatp
argument_list|)
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|near
name|line_param
argument_list|(
name|P2
argument_list|(
name|os_ptr
argument_list|,
name|int
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The current graphics state */
end_comment

begin_decl_stmt
name|gs_state
modifier|*
name|igs
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int_gstate
name|istate
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Initialize the graphics stack. */
end_comment

begin_function
name|void
name|gs_init
parameter_list|()
block|{
name|igs
operator|=
name|gs_state_alloc
argument_list|(
name|alloc
argument_list|,
name|alloc_free
argument_list|)
expr_stmt|;
name|istate
operator|.
name|saved
operator|=
literal|0
expr_stmt|;
name|make_null
argument_list|(
operator|&
name|istate
operator|.
name|screen_proc
argument_list|)
expr_stmt|;
name|make_null
argument_list|(
operator|&
name|istate
operator|.
name|transfer_procs
operator|.
name|red
argument_list|)
expr_stmt|;
name|make_null
argument_list|(
operator|&
name|istate
operator|.
name|transfer_procs
operator|.
name|green
argument_list|)
expr_stmt|;
name|make_null
argument_list|(
operator|&
name|istate
operator|.
name|transfer_procs
operator|.
name|blue
argument_list|)
expr_stmt|;
name|make_null
argument_list|(
operator|&
name|istate
operator|.
name|transfer_procs
operator|.
name|gray
argument_list|)
expr_stmt|;
comment|/* gsave and grestore only work properly */
comment|/* if there are always at least 2 entries on the stack. */
comment|/* We count on the PostScript initialization code to do a gsave. */
block|}
end_function

begin_comment
comment|/* gsave */
end_comment

begin_function
name|int
name|zgsave
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int_gstate
modifier|*
name|pis
init|=
operator|(
name|int_gstate
operator|*
operator|)
name|alloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|int_gstate
argument_list|)
argument_list|,
literal|"gsave"
argument_list|)
decl_stmt|;
name|int
name|code
decl_stmt|;
if|if
condition|(
name|pis
operator|==
literal|0
condition|)
return|return
name|e_VMerror
return|;
name|code
operator|=
name|gs_gsave
argument_list|(
name|igs
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
block|{
name|alloc_free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pis
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|int_gstate
argument_list|)
argument_list|,
literal|"gsave"
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
operator|*
name|pis
operator|=
name|istate
expr_stmt|;
name|istate
operator|.
name|saved
operator|=
name|pis
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* grestore */
end_comment

begin_function
name|int
name|zgrestore
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
init|=
name|gs_grestore
argument_list|(
name|igs
argument_list|)
decl_stmt|;
name|int_gstate
modifier|*
name|pis
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|pis
operator|=
name|istate
operator|.
name|saved
expr_stmt|;
name|istate
operator|=
operator|*
name|pis
expr_stmt|;
if|if
condition|(
name|istate
operator|.
name|saved
condition|)
name|alloc_free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pis
argument_list|,
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|int_gstate
argument_list|)
argument_list|,
literal|"grestore"
argument_list|)
expr_stmt|;
else|else
comment|/* bottom of stack */
name|istate
operator|.
name|saved
operator|=
name|pis
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* grestoreall */
end_comment

begin_function
name|int
name|zgrestoreall
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
while|while
condition|(
name|istate
operator|.
name|saved
operator|->
name|saved
condition|)
block|{
name|int
name|code
init|=
name|zgrestore
argument_list|(
name|op
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
block|}
return|return
name|zgrestore
argument_list|(
name|op
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* initgraphics */
end_comment

begin_function
name|int
name|zinitgraphics
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
return|return
name|gs_initgraphics
argument_list|(
name|igs
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* setlinewidth */
end_comment

begin_function
name|int
name|zsetlinewidth
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
return|return
name|num_param
argument_list|(
name|op
argument_list|,
name|gs_setlinewidth
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* currentlinewidth */
end_comment

begin_function
name|int
name|zcurrentlinewidth
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
argument_list|,
name|gs_currentlinewidth
argument_list|(
name|igs
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setlinecap */
end_comment

begin_function
name|int
name|zsetlinecap
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|param
decl_stmt|;
name|int
name|code
init|=
name|line_param
argument_list|(
name|op
argument_list|,
operator|&
name|param
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|code
condition|)
name|code
operator|=
name|gs_setlinecap
argument_list|(
name|igs
argument_list|,
operator|(
name|gs_line_cap
operator|)
name|param
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* currentlinecap */
end_comment

begin_function
name|int
name|zcurrentlinecap
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|make_int
argument_list|(
name|op
argument_list|,
operator|(
name|int
operator|)
name|gs_currentlinecap
argument_list|(
name|igs
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setlinejoin */
end_comment

begin_function
name|int
name|zsetlinejoin
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|param
decl_stmt|;
name|int
name|code
init|=
name|line_param
argument_list|(
name|op
argument_list|,
operator|&
name|param
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|code
condition|)
name|code
operator|=
name|gs_setlinejoin
argument_list|(
name|igs
argument_list|,
operator|(
name|gs_line_join
operator|)
name|param
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* currentlinejoin */
end_comment

begin_function
name|int
name|zcurrentlinejoin
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|make_int
argument_list|(
name|op
argument_list|,
operator|(
name|int
operator|)
name|gs_currentlinejoin
argument_list|(
name|igs
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setmiterlimit */
end_comment

begin_function
name|int
name|zsetmiterlimit
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
return|return
name|num_param
argument_list|(
name|op
argument_list|,
name|gs_setmiterlimit
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* currentmiterlimit */
end_comment

begin_function
name|int
name|zcurrentmiterlimit
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
argument_list|,
name|gs_currentmiterlimit
argument_list|(
name|igs
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setdash */
end_comment

begin_function
name|int
name|zsetdash
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|float
name|offset
decl_stmt|;
name|uint
name|n
decl_stmt|,
name|i
decl_stmt|;
name|ref
modifier|*
name|dfrom
decl_stmt|;
name|float
modifier|*
name|pattern
decl_stmt|,
modifier|*
name|dto
decl_stmt|;
name|int
name|code
init|=
name|real_param
argument_list|(
name|op
argument_list|,
operator|&
name|offset
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
condition|)
return|return
name|code
return|;
name|check_array
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|check_read
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
comment|/* Unpack the dash pattern and check it */
name|dfrom
operator|=
name|op
index|[
operator|-
literal|1
index|]
operator|.
name|value
operator|.
name|refs
expr_stmt|;
name|i
operator|=
name|n
operator|=
name|r_size
argument_list|(
name|op
operator|-
literal|1
argument_list|)
expr_stmt|;
name|pattern
operator|=
name|dto
operator|=
operator|(
name|float
operator|*
operator|)
name|alloc
argument_list|(
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|float
argument_list|)
argument_list|,
literal|"setdash"
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
switch|switch
condition|(
name|r_type
argument_list|(
name|dfrom
argument_list|)
condition|)
block|{
case|case
name|t_integer
case|:
operator|*
name|dto
operator|++
operator|=
name|dfrom
operator|->
name|value
operator|.
name|intval
expr_stmt|;
break|break;
case|case
name|t_real
case|:
operator|*
name|dto
operator|++
operator|=
name|dfrom
operator|->
name|value
operator|.
name|realval
expr_stmt|;
break|break;
default|default:
name|alloc_free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|dto
argument_list|,
name|n
argument_list|,
sizeof|sizeof
argument_list|(
name|float
argument_list|)
argument_list|,
literal|"setdash"
argument_list|)
expr_stmt|;
return|return
name|e_typecheck
return|;
block|}
name|dfrom
operator|++
expr_stmt|;
block|}
name|code
operator|=
name|gs_setdash
argument_list|(
name|igs
argument_list|,
name|pattern
argument_list|,
name|n
argument_list|,
name|offset
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|code
condition|)
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* currentdash */
end_comment

begin_function
name|int
name|zcurrentdash
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|n
init|=
name|gs_currentdash_length
argument_list|(
name|igs
argument_list|)
decl_stmt|;
name|int
name|i
init|=
name|n
decl_stmt|;
name|ref
modifier|*
name|pattern
init|=
name|alloc_refs
argument_list|(
name|n
argument_list|,
literal|"currentdash"
argument_list|)
decl_stmt|;
name|ref
modifier|*
name|dto
init|=
name|pattern
decl_stmt|;
name|float
modifier|*
name|dfrom
init|=
operator|(
name|float
operator|*
operator|)
operator|(
operator|(
name|char
operator|*
operator|)
name|pattern
operator|+
name|n
operator|*
operator|(
sizeof|sizeof
argument_list|(
name|ref
argument_list|)
operator|-
sizeof|sizeof
argument_list|(
name|float
argument_list|)
operator|)
operator|)
decl_stmt|;
name|gs_currentdash_pattern
argument_list|(
name|igs
argument_list|,
name|dfrom
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
block|{
name|make_real
argument_list|(
name|dto
argument_list|,
operator|*
name|dfrom
argument_list|)
expr_stmt|;
name|dto
operator|++
operator|,
name|dfrom
operator|++
expr_stmt|;
block|}
name|push
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|make_tasv
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|t_array
argument_list|,
name|a_all
argument_list|,
name|n
argument_list|,
name|refs
argument_list|,
name|pattern
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
argument_list|,
name|gs_currentdash_offset
argument_list|(
name|igs
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setflat */
end_comment

begin_function
name|int
name|zsetflat
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
return|return
name|num_param
argument_list|(
name|op
argument_list|,
name|gs_setflat
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* currentflat */
end_comment

begin_function
name|int
name|zcurrentflat
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
argument_list|,
name|gs_currentflat
argument_list|(
name|igs
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ------ Initialization procedure ------ */
end_comment

begin_decl_stmt
name|op_def
name|zgstate_op_defs
index|[]
init|=
block|{
block|{
literal|"0currentdash"
block|,
name|zcurrentdash
block|}
block|,
block|{
literal|"0currentflat"
block|,
name|zcurrentflat
block|}
block|,
block|{
literal|"0currentlinecap"
block|,
name|zcurrentlinecap
block|}
block|,
block|{
literal|"0currentlinejoin"
block|,
name|zcurrentlinejoin
block|}
block|,
block|{
literal|"0currentlinewidth"
block|,
name|zcurrentlinewidth
block|}
block|,
block|{
literal|"0currentmiterlimit"
block|,
name|zcurrentmiterlimit
block|}
block|,
block|{
literal|"0grestore"
block|,
name|zgrestore
block|}
block|,
block|{
literal|"0grestoreall"
block|,
name|zgrestoreall
block|}
block|,
block|{
literal|"0gsave"
block|,
name|zgsave
block|}
block|,
block|{
literal|"0initgraphics"
block|,
name|zinitgraphics
block|}
block|,
block|{
literal|"2setdash"
block|,
name|zsetdash
block|}
block|,
block|{
literal|"1setflat"
block|,
name|zsetflat
block|}
block|,
block|{
literal|"1setlinecap"
block|,
name|zsetlinecap
block|}
block|,
block|{
literal|"1setlinejoin"
block|,
name|zsetlinejoin
block|}
block|,
block|{
literal|"1setlinewidth"
block|,
name|zsetlinewidth
block|}
block|,
block|{
literal|"1setmiterlimit"
block|,
name|zsetmiterlimit
block|}
block|,
name|op_def_end
argument_list|(
literal|0
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ------ Internal routines ------ */
end_comment

begin_comment
comment|/* Get a numeric parameter */
end_comment

begin_decl_stmt
name|private
name|int
name|near
name|num_param
argument_list|(
name|os_ptr
name|op
argument_list|,
name|int
argument_list|(
operator|*
name|pproc
argument_list|)
argument_list|(
name|P2
argument_list|(
name|gs_state
operator|*
argument_list|,
name|floatp
argument_list|)
argument_list|)
argument_list|)
block|{
name|float
name|param
decl_stmt|;
name|int
name|code
init|=
name|real_param
argument_list|(
name|op
argument_list|,
operator|&
name|param
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|code
condition|)
name|code
operator|=
call|(
modifier|*
name|pproc
call|)
argument_list|(
name|igs
argument_list|,
name|param
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|code
condition|)
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_decl_stmt

begin_comment
comment|/* Get an integer parameter 0-2. */
end_comment

begin_function
name|private
name|int
name|near
name|line_param
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|,
name|int
modifier|*
name|pparam
parameter_list|)
block|{
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|value
operator|.
name|intval
operator|<
literal|0
operator|||
name|op
operator|->
name|value
operator|.
name|intval
operator|>
literal|2
condition|)
return|return
name|e_rangecheck
return|;
operator|*
name|pparam
operator|=
operator|(
name|int
operator|)
name|op
operator|->
name|value
operator|.
name|intval
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


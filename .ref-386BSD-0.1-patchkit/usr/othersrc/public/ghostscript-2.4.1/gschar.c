begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1992 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* gschar.c */
end_comment

begin_comment
comment|/* Character writing operators for Ghostscript library */
end_comment

begin_include
include|#
directive|include
file|"gx.h"
end_include

begin_include
include|#
directive|include
file|"memory_.h"
end_include

begin_include
include|#
directive|include
file|"string_.h"
end_include

begin_include
include|#
directive|include
file|"gserrors.h"
end_include

begin_include
include|#
directive|include
file|"gxfixed.h"
end_include

begin_comment
comment|/* ditto */
end_comment

begin_include
include|#
directive|include
file|"gxarith.h"
end_include

begin_include
include|#
directive|include
file|"gxmatrix.h"
end_include

begin_include
include|#
directive|include
file|"gzstate.h"
end_include

begin_comment
comment|/* must precede gzdevice */
end_comment

begin_include
include|#
directive|include
file|"gzdevice.h"
end_include

begin_comment
comment|/* must precede gxchar */
end_comment

begin_include
include|#
directive|include
file|"gxdevmem.h"
end_include

begin_include
include|#
directive|include
file|"gxchar.h"
end_include

begin_include
include|#
directive|include
file|"gxcache.h"
end_include

begin_include
include|#
directive|include
file|"gxfont.h"
end_include

begin_include
include|#
directive|include
file|"gspath.h"
end_include

begin_include
include|#
directive|include
file|"gzpath.h"
end_include

begin_include
include|#
directive|include
file|"gzcolor.h"
end_include

begin_comment
comment|/* Exported size of enumerator */
end_comment

begin_decl_stmt
specifier|const
name|uint
name|gs_show_enum_sizeof
init|=
sizeof|sizeof
argument_list|(
name|gs_show_enum
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Imported procedures */
end_comment

begin_decl_stmt
specifier|extern
name|void
name|gx_set_black
argument_list|(
name|P1
argument_list|(
name|gs_state
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Forward declarations */
end_comment

begin_decl_stmt
name|private
name|int
name|continue_show
argument_list|(
name|P1
argument_list|(
name|gs_show_enum
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|continue_show_update
argument_list|(
name|P1
argument_list|(
name|gs_show_enum
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|show_setup
argument_list|(
name|P3
argument_list|(
name|gs_show_enum
operator|*
argument_list|,
name|gs_state
operator|*
argument_list|,
name|char
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|stringwidth_setup
argument_list|(
name|P3
argument_list|(
name|gs_show_enum
operator|*
argument_list|,
name|gs_state
operator|*
argument_list|,
name|char
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Print the ctm if debugging */
end_comment

begin_define
define|#
directive|define
name|print_ctm
parameter_list|(
name|s
parameter_list|,
name|pgs
parameter_list|)
define|\
value|dprintf7("[p]%sctm=[%g %g %g %g %g %g]\n", s,\ 	   pgs->ctm.xx, pgs->ctm.xy, pgs->ctm.yx, pgs->ctm.yy,\ 	   pgs->ctm.tx, pgs->ctm.ty)
end_define

begin_comment
comment|/* ------ String writing operators ------ */
end_comment

begin_comment
comment|/* Setup macros for show operators */
end_comment

begin_define
define|#
directive|define
name|setup_show
parameter_list|()
define|\
value|penum->size = strlen(str)
end_define

begin_define
define|#
directive|define
name|setup_show_n
parameter_list|()
define|\
value|penum->size = size
end_define

begin_define
define|#
directive|define
name|setup_a
parameter_list|()
define|\
value|penum->add = 1, penum->ax = ax, penum->ay = ay,\   penum->slow_show = 1
end_define

begin_define
define|#
directive|define
name|setup_width
parameter_list|()
define|\
value|penum->wchr = chr, penum->wcx = cx, penum->wcy = cy,\   penum->slow_show = 1
end_define

begin_define
define|#
directive|define
name|no_chr
value|~(char_code)0
end_define

begin_comment
comment|/* show[_n] */
end_comment

begin_function
name|int
name|gs_show_init
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|setup_show
argument_list|()
expr_stmt|;
name|penum
operator|->
name|slow_show
operator|=
literal|0
expr_stmt|;
return|return
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|gs_show_n_init
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|uint
name|size
parameter_list|)
block|{
name|setup_show_n
argument_list|()
expr_stmt|;
name|penum
operator|->
name|slow_show
operator|=
literal|0
expr_stmt|;
return|return
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ashow[_n] */
end_comment

begin_function
name|int
name|gs_ashow_init
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|ax
parameter_list|,
name|floatp
name|ay
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|setup_show
argument_list|()
expr_stmt|;
name|code
operator|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|setup_a
argument_list|()
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_function
name|int
name|gs_ashow_n_init
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|ax
parameter_list|,
name|floatp
name|ay
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|uint
name|size
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|setup_show_n
argument_list|()
expr_stmt|;
name|code
operator|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|setup_a
argument_list|()
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* widthshow[_n] */
end_comment

begin_function
name|int
name|gs_widthshow_init
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|cx
parameter_list|,
name|floatp
name|cy
parameter_list|,
name|char
name|chr
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|setup_show
argument_list|()
expr_stmt|;
name|code
operator|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|setup_width
argument_list|()
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_function
name|int
name|gs_widthshow_n_init
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|cx
parameter_list|,
name|floatp
name|cy
parameter_list|,
name|char
name|chr
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|uint
name|size
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|setup_show_n
argument_list|()
expr_stmt|;
name|code
operator|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|setup_width
argument_list|()
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* awidthshow[_n] */
end_comment

begin_function
name|int
name|gs_awidthshow_init
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|cx
parameter_list|,
name|floatp
name|cy
parameter_list|,
name|char
name|chr
parameter_list|,
name|floatp
name|ax
parameter_list|,
name|floatp
name|ay
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|setup_show
argument_list|()
expr_stmt|;
name|code
operator|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|setup_a
argument_list|()
expr_stmt|;
name|setup_width
argument_list|()
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_function
name|int
name|gs_awidthshow_n_init
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|cx
parameter_list|,
name|floatp
name|cy
parameter_list|,
name|char
name|chr
parameter_list|,
name|floatp
name|ax
parameter_list|,
name|floatp
name|ay
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|uint
name|size
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|setup_show_n
argument_list|()
expr_stmt|;
name|code
operator|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|setup_a
argument_list|()
expr_stmt|;
name|setup_width
argument_list|()
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* kshow[_n] */
end_comment

begin_function
name|int
name|gs_kshow_init
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
if|if
condition|(
name|pgs
operator|->
name|font
operator|->
name|FontType
operator|==
name|ft_composite
condition|)
name|return_error
argument_list|(
name|gs_error_invalidfont
argument_list|)
expr_stmt|;
name|setup_show
argument_list|()
expr_stmt|;
name|code
operator|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|penum
operator|->
name|do_kern
operator|=
name|penum
operator|->
name|slow_show
operator|=
literal|1
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_function
name|int
name|gs_kshow_n_init
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|uint
name|size
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
if|if
condition|(
name|pgs
operator|->
name|font
operator|->
name|FontType
operator|==
name|ft_composite
condition|)
name|return_error
argument_list|(
name|gs_error_invalidfont
argument_list|)
expr_stmt|;
name|setup_show_n
argument_list|()
expr_stmt|;
name|code
operator|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|penum
operator|->
name|do_kern
operator|=
name|penum
operator|->
name|slow_show
operator|=
literal|1
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* ------ Related operators ------ */
end_comment

begin_comment
comment|/* stringwidth[_n] */
end_comment

begin_function
name|int
name|gs_stringwidth_init
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|setup_show
argument_list|()
expr_stmt|;
return|return
name|stringwidth_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|gs_stringwidth_n_init
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|uint
name|size
parameter_list|)
block|{
name|setup_show_n
argument_list|()
expr_stmt|;
return|return
name|stringwidth_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Common code for stringwidth[_n] */
end_comment

begin_function
name|private
name|int
name|stringwidth_setup
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|code
init|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
name|return_error
argument_list|(
name|code
argument_list|)
expr_stmt|;
name|penum
operator|->
name|stringwidth_flag
operator|=
literal|1
expr_stmt|;
comment|/* Do an extra gsave and suppress output */
if|if
condition|(
operator|(
name|code
operator|=
name|gs_gsave
argument_list|(
name|pgs
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|penum
operator|->
name|level
operator|=
name|pgs
operator|->
name|level
expr_stmt|;
comment|/* for level check in show_update */
name|gx_device_no_output
argument_list|(
name|pgs
argument_list|)
expr_stmt|;
comment|/* Establish an arbitrary current point. */
return|return
name|gx_path_add_point
argument_list|(
name|pgs
operator|->
name|path
argument_list|,
name|pgs
operator|->
name|ctm
operator|.
name|tx_fixed
argument_list|,
name|pgs
operator|->
name|ctm
operator|.
name|ty_fixed
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* charpath[_n] */
end_comment

begin_function
name|int
name|gs_charpath_init
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|int
name|bool
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|setup_show
argument_list|()
expr_stmt|;
name|code
operator|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|penum
operator|->
name|charpath_flag
operator|=
operator|(
name|bool
condition|?
literal|2
else|:
literal|1
operator|)
expr_stmt|;
name|penum
operator|->
name|can_cache
operator|=
literal|0
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_function
name|int
name|gs_charpath_n_init
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|char
modifier|*
name|str
parameter_list|,
name|uint
name|size
parameter_list|,
name|int
name|bool
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|setup_show_n
argument_list|()
expr_stmt|;
name|code
operator|=
name|show_setup
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|penum
operator|->
name|charpath_flag
operator|=
operator|(
name|bool
condition|?
literal|2
else|:
literal|1
operator|)
expr_stmt|;
name|penum
operator|->
name|can_cache
operator|=
literal|0
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* ------ Width/cache operators ------ */
end_comment

begin_comment
comment|/* setcachedevice */
end_comment

begin_function
name|int
name|gs_setcachedevice
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|wx
parameter_list|,
name|floatp
name|wy
parameter_list|,
name|floatp
name|llx
parameter_list|,
name|floatp
name|lly
parameter_list|,
name|floatp
name|urx
parameter_list|,
name|floatp
name|ury
parameter_list|)
block|{
name|int
name|code
init|=
name|gs_setcharwidth
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|wx
argument_list|,
name|wy
argument_list|)
decl_stmt|;
comment|/* default is don't cache */
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
comment|/* See if we want to cache this character. */
if|if
condition|(
name|pgs
operator|->
name|in_cachedevice
condition|)
comment|/* no recursion! */
return|return
literal|0
return|;
name|pgs
operator|->
name|in_cachedevice
operator|=
literal|1
expr_stmt|;
comment|/* disable color/gray/image operators */
comment|/* We can only use the cache if ctm is unchanged */
comment|/* (aside from a possible translation), */
comment|/* and if the extent of the box is non-negative. */
if|if
condition|(
operator|!
name|penum
operator|->
name|can_cache
operator|||
operator|!
name|pgs
operator|->
name|char_tm_valid
operator|||
name|llx
operator|>
name|urx
operator|||
name|lly
operator|>
name|ury
condition|)
return|return
literal|0
return|;
block|{
name|gs_font_dir
modifier|*
name|dir
init|=
name|pgs
operator|->
name|font
operator|->
name|dir
decl_stmt|;
name|gs_fixed_point
name|cbox_ll
decl_stmt|,
name|cbox_ur
decl_stmt|,
name|cdim
decl_stmt|;
name|long
name|iwidth
decl_stmt|,
name|iheight
decl_stmt|;
name|cached_char
modifier|*
name|cc
decl_stmt|;
name|gs_fixed_rect
name|clip_box
decl_stmt|;
name|gs_distance_transform2fixed
argument_list|(
operator|&
name|pgs
operator|->
name|ctm
argument_list|,
name|llx
argument_list|,
name|lly
argument_list|,
operator|&
name|cbox_ll
argument_list|)
expr_stmt|;
name|gs_distance_transform2fixed
argument_list|(
operator|&
name|pgs
operator|->
name|ctm
argument_list|,
name|urx
argument_list|,
name|ury
argument_list|,
operator|&
name|cbox_ur
argument_list|)
expr_stmt|;
name|cdim
operator|.
name|x
operator|=
name|cbox_ur
operator|.
name|x
operator|-
name|cbox_ll
operator|.
name|x
expr_stmt|;
name|cdim
operator|.
name|y
operator|=
name|cbox_ur
operator|.
name|y
operator|-
name|cbox_ll
operator|.
name|y
expr_stmt|;
if|if
condition|(
name|cdim
operator|.
name|x
operator|<
literal|0
condition|)
name|cdim
operator|.
name|x
operator|=
operator|-
name|cdim
operator|.
name|x
expr_stmt|;
if|if
condition|(
name|cdim
operator|.
name|y
operator|<
literal|0
condition|)
name|cdim
operator|.
name|y
operator|=
operator|-
name|cdim
operator|.
name|y
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|gs_debug
index|[
literal|'k'
index|]
condition|)
block|{
name|dprintf4
argument_list|(
literal|"[k]cbox=[%g %g %g %g]\n"
argument_list|,
name|fixed2float
argument_list|(
name|cbox_ll
operator|.
name|x
argument_list|)
argument_list|,
name|fixed2float
argument_list|(
name|cbox_ll
operator|.
name|y
argument_list|)
argument_list|,
name|fixed2float
argument_list|(
name|cbox_ur
operator|.
name|x
argument_list|)
argument_list|,
name|fixed2float
argument_list|(
name|cbox_ur
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
name|print_ctm
argument_list|(
literal|"  "
argument_list|,
name|pgs
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|iwidth
operator|=
name|fixed2long
argument_list|(
name|cdim
operator|.
name|x
argument_list|)
operator|+
literal|2
expr_stmt|;
name|iheight
operator|=
name|fixed2long
argument_list|(
name|cdim
operator|.
name|y
argument_list|)
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|iwidth
operator|!=
operator|(
name|ushort
operator|)
name|iwidth
operator|||
name|iheight
operator|!=
operator|(
name|ushort
operator|)
name|iheight
condition|)
return|return
literal|0
return|;
comment|/* much too big */
if|if
condition|(
operator|!
name|penum
operator|->
name|dev_cache_set
condition|)
block|{
comment|/* Set up the memory device for the character cache */
name|device
modifier|*
name|dev
init|=
operator|&
name|penum
operator|->
name|dev_cache_dev
decl_stmt|;
name|penum
operator|->
name|dev_cache_info
operator|=
name|mem_mono_device
expr_stmt|;
name|dev
operator|->
name|info
operator|=
operator|(
name|gx_device
operator|*
operator|)
operator|&
name|penum
operator|->
name|dev_cache_info
expr_stmt|;
name|dev
operator|->
name|is_band_device
operator|=
literal|0
expr_stmt|;
name|dev
operator|->
name|white
operator|=
literal|1
expr_stmt|;
name|dev
operator|->
name|black
operator|=
literal|1
expr_stmt|;
name|penum
operator|->
name|dev_cache_set
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|cc
operator|=
name|gx_alloc_char_bits
argument_list|(
name|dir
argument_list|,
operator|(
name|gx_device_memory
operator|*
operator|)
operator|&
name|penum
operator|->
name|dev_cache_info
argument_list|,
operator|(
name|ushort
operator|)
name|iwidth
argument_list|,
operator|(
name|ushort
operator|)
name|iheight
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
literal|0
return|;
comment|/* too big for cache */
comment|/* The mins handle transposed coordinate systems.... */
comment|/* Truncate the offsets to avoid artifacts later. */
name|cc
operator|->
name|offset
operator|.
name|x
operator|=
name|fixed_ceiling
argument_list|(
operator|-
name|min
argument_list|(
name|cbox_ll
operator|.
name|x
argument_list|,
name|cbox_ur
operator|.
name|x
argument_list|)
argument_list|)
expr_stmt|;
name|cc
operator|->
name|offset
operator|.
name|y
operator|=
name|fixed_ceiling
argument_list|(
operator|-
name|min
argument_list|(
name|cbox_ll
operator|.
name|y
argument_list|,
name|cbox_ur
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|gs_debug
index|[
literal|'k'
index|]
condition|)
name|dprintf2
argument_list|(
literal|"[k]offset=[%g %g]\n"
argument_list|,
name|fixed2float
argument_list|(
name|cc
operator|->
name|offset
operator|.
name|x
argument_list|)
argument_list|,
name|fixed2float
argument_list|(
name|cc
operator|->
name|offset
operator|.
name|y
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|!
name|color_is_pure
argument_list|(
name|pgs
operator|->
name|dev_color
argument_list|)
condition|)
comment|/* can't use cache */
block|{
name|gx_free_cached_char
argument_list|(
name|dir
argument_list|,
name|cc
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
if|if
condition|(
operator|(
name|code
operator|=
name|gs_gsave
argument_list|(
name|pgs
argument_list|)
operator|)
operator|<
literal|0
condition|)
block|{
name|gx_free_cached_char
argument_list|(
name|dir
argument_list|,
name|cc
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
comment|/* Nothing can go wrong now.... */
name|penum
operator|->
name|cc
operator|=
name|cc
expr_stmt|;
name|cc
operator|->
name|code
operator|=
name|gs_show_current_char
argument_list|(
name|penum
argument_list|)
expr_stmt|;
name|cc
operator|->
name|wxy
operator|=
name|penum
operator|->
name|wxy
expr_stmt|;
comment|/* Install the device */
name|pgs
operator|->
name|device
operator|=
operator|&
name|penum
operator|->
name|dev_cache_dev
expr_stmt|;
name|pgs
operator|->
name|device_is_shared
operator|=
literal|1
expr_stmt|;
comment|/* don't deallocate */
comment|/* Adjust the translation in the graphics context */
comment|/* so that the character lines up with the cache. */
name|gs_translate_to_fixed
argument_list|(
name|pgs
argument_list|,
name|cc
operator|->
name|offset
operator|.
name|x
argument_list|,
name|cc
operator|->
name|offset
operator|.
name|y
argument_list|)
expr_stmt|;
comment|/* Reset the clipping path to match the metrics. */
name|clip_box
operator|.
name|p
operator|.
name|x
operator|=
name|clip_box
operator|.
name|p
operator|.
name|y
operator|=
literal|0
expr_stmt|;
name|clip_box
operator|.
name|q
operator|.
name|x
operator|=
name|int2fixed
argument_list|(
name|iwidth
argument_list|)
expr_stmt|;
name|clip_box
operator|.
name|q
operator|.
name|y
operator|=
name|int2fixed
argument_list|(
name|iheight
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|gx_clip_to_rectangle
argument_list|(
name|pgs
argument_list|,
operator|&
name|clip_box
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|gx_set_black
argument_list|(
name|pgs
argument_list|)
expr_stmt|;
comment|/* Set the color to black. */
block|}
name|penum
operator|->
name|width_status
operator|=
name|sws_cache
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setcharwidth */
end_comment

begin_function
name|int
name|gs_setcharwidth
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|wx
parameter_list|,
name|floatp
name|wy
parameter_list|)
block|{
if|if
condition|(
name|penum
operator|->
name|width_status
operator|!=
name|sws_none
condition|)
name|return_error
argument_list|(
name|gs_error_undefined
argument_list|)
expr_stmt|;
name|gs_distance_transform2fixed
argument_list|(
operator|&
name|pgs
operator|->
name|ctm
argument_list|,
name|wx
argument_list|,
name|wy
argument_list|,
operator|&
name|penum
operator|->
name|wxy
argument_list|)
expr_stmt|;
name|penum
operator|->
name|width_status
operator|=
name|sws_no_cache
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setmetrics */
end_comment

begin_function
name|int
name|gs_setmetrics
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|gs_point
modifier|*
name|psbxy
parameter_list|,
name|gs_point
modifier|*
name|pwxy
parameter_list|)
block|{
if|if
condition|(
name|penum
operator|->
name|width_status
operator|!=
name|sws_none
condition|)
name|return_error
argument_list|(
name|gs_error_undefined
argument_list|)
expr_stmt|;
if|if
condition|(
name|psbxy
operator|!=
literal|0
condition|)
block|{
name|penum
operator|->
name|metrics_sb
operator|.
name|x
operator|=
name|float2fixed
argument_list|(
name|psbxy
operator|->
name|x
argument_list|)
expr_stmt|;
name|penum
operator|->
name|metrics_sb
operator|.
name|y
operator|=
name|float2fixed
argument_list|(
name|psbxy
operator|->
name|y
argument_list|)
expr_stmt|;
name|penum
operator|->
name|sb_set
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|pwxy
operator|!=
literal|0
condition|)
block|{
name|penum
operator|->
name|metrics_width
operator|.
name|x
operator|=
name|float2fixed
argument_list|(
name|pwxy
operator|->
name|x
argument_list|)
expr_stmt|;
name|penum
operator|->
name|metrics_width
operator|.
name|y
operator|=
name|float2fixed
argument_list|(
name|pwxy
operator|->
name|y
argument_list|)
expr_stmt|;
name|penum
operator|->
name|width_set
operator|=
literal|1
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ------ Enumerator ------ */
end_comment

begin_comment
comment|/* Do the next step of a show (or stringwidth) operation */
end_comment

begin_function
name|int
name|gs_show_next
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
return|return
call|(
modifier|*
name|penum
operator|->
name|continue_proc
call|)
argument_list|(
name|penum
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Continuation procedures */
end_comment

begin_define
define|#
directive|define
name|show_fast_move
parameter_list|(
name|wxy
parameter_list|,
name|pgs
parameter_list|)
define|\
value|gx_path_add_rel_point_inline(pgs->path, wxy.x, wxy.y)
end_define

begin_decl_stmt
name|private
name|int
name|show_update
argument_list|(
name|P1
argument_list|(
specifier|register
name|gs_show_enum
operator|*
name|penum
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|show_move
argument_list|(
name|P1
argument_list|(
specifier|register
name|gs_show_enum
operator|*
name|penum
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|show_proceed
argument_list|(
name|P1
argument_list|(
specifier|register
name|gs_show_enum
operator|*
name|penum
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|show_finish
argument_list|(
name|P1
argument_list|(
specifier|register
name|gs_show_enum
operator|*
name|penum
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|private
name|int
name|continue_show_update
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
name|int
name|code
init|=
name|show_update
argument_list|(
name|penum
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|code
operator|=
name|show_move
argument_list|(
name|penum
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|!=
literal|0
condition|)
return|return
name|code
return|;
return|return
name|show_proceed
argument_list|(
name|penum
argument_list|)
return|;
block|}
end_function

begin_function
name|private
name|int
name|continue_show
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
return|return
name|show_proceed
argument_list|(
name|penum
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Update position */
end_comment

begin_function
name|private
name|int
name|show_update
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
specifier|register
name|gs_state
modifier|*
name|pgs
init|=
name|penum
operator|->
name|pgs
decl_stmt|;
comment|/* Update position for last character */
switch|switch
condition|(
name|penum
operator|->
name|width_status
condition|)
block|{
case|case
name|sws_none
case|:
comment|/* Adobe interpreters assume a character width of 0, */
comment|/* even though the documentation says this is an error.... */
name|penum
operator|->
name|wxy
operator|.
name|x
operator|=
name|penum
operator|->
name|wxy
operator|.
name|y
operator|=
literal|0
expr_stmt|;
break|break;
case|case
name|sws_cache
case|:
block|{
comment|/* Finish installing the cache entry. */
name|cached_char
modifier|*
name|cc
init|=
name|penum
operator|->
name|cc
decl_stmt|;
name|int
name|code
decl_stmt|;
comment|/* If the BuildChar procedure did a save and a restore, */
comment|/* it already undid the gsave in setcachedevice. */
comment|/* We have to check for this by comparing levels. */
switch|switch
condition|(
name|pgs
operator|->
name|level
operator|-
name|penum
operator|->
name|level
condition|)
block|{
default|default:
name|return_error
argument_list|(
name|gs_error_invalidfont
argument_list|)
expr_stmt|;
comment|/* WRONG */
case|case
literal|2
case|:
name|code
operator|=
name|gs_grestore
argument_list|(
name|pgs
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
case|case
literal|1
case|:
empty_stmt|;
block|}
name|gx_add_cached_char
argument_list|(
name|pgs
operator|->
name|font
operator|->
name|dir
argument_list|,
operator|&
name|penum
operator|->
name|dev_cache_info
argument_list|,
name|cc
argument_list|,
name|gx_lookup_fm_pair
argument_list|(
name|pgs
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|penum
operator|->
name|stringwidth_flag
operator|&&
operator|!
name|penum
operator|->
name|charpath_flag
condition|)
block|{
comment|/* Copy the bits to the real output device. */
name|penum
operator|->
name|color_loaded
operator|=
literal|0
expr_stmt|;
comment|/* force gx_color_render */
name|code
operator|=
name|gs_grestore
argument_list|(
name|pgs
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
return|return
name|gx_image_cached_char
argument_list|(
name|penum
argument_list|,
name|cc
argument_list|)
return|;
block|}
block|}
case|case
name|sws_no_cache
case|:
empty_stmt|;
block|}
return|return
name|gs_grestore
argument_list|(
name|pgs
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Move to next character */
end_comment

begin_function
name|private
name|int
name|show_move
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
specifier|register
name|gs_state
modifier|*
name|pgs
init|=
name|penum
operator|->
name|pgs
decl_stmt|;
if|if
condition|(
name|penum
operator|->
name|add
condition|)
name|gs_rmoveto
argument_list|(
name|pgs
argument_list|,
name|penum
operator|->
name|ax
argument_list|,
name|penum
operator|->
name|ay
argument_list|)
expr_stmt|;
if|if
condition|(
name|penum
operator|->
name|str
index|[
name|penum
operator|->
name|index
operator|-
literal|1
index|]
operator|==
name|penum
operator|->
name|wchr
condition|)
name|gs_rmoveto
argument_list|(
name|pgs
argument_list|,
name|penum
operator|->
name|wcx
argument_list|,
name|penum
operator|->
name|wcy
argument_list|)
expr_stmt|;
comment|/* wxy is in device coordinates */
block|{
name|int
name|code
init|=
name|show_fast_move
argument_list|(
name|penum
operator|->
name|wxy
argument_list|,
name|pgs
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
block|}
comment|/* Check for kerning, but not on the last character. */
if|if
condition|(
name|penum
operator|->
name|do_kern
operator|&&
name|penum
operator|->
name|index
operator|<
name|penum
operator|->
name|size
condition|)
block|{
name|penum
operator|->
name|continue_proc
operator|=
name|continue_show
expr_stmt|;
return|return
name|gs_show_kern
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Process next character */
end_comment

begin_function
name|private
name|int
name|show_proceed
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
specifier|register
name|gs_state
modifier|*
name|pgs
init|=
name|penum
operator|->
name|pgs
decl_stmt|;
name|byte
modifier|*
name|str
init|=
name|penum
operator|->
name|str
decl_stmt|;
name|uint
name|index
decl_stmt|;
name|cached_fm_pair
modifier|*
name|pair
init|=
literal|0
decl_stmt|;
name|char_code
name|chr
decl_stmt|;
name|int
name|code
decl_stmt|;
name|penum
operator|->
name|color_loaded
operator|=
literal|0
expr_stmt|;
name|more
label|:
comment|/* Proceed to next character */
if|if
condition|(
name|penum
operator|->
name|can_cache
condition|)
block|{
comment|/* Loop with cache */
if|if
condition|(
name|pair
operator|==
literal|0
condition|)
name|pair
operator|=
name|gx_lookup_fm_pair
argument_list|(
name|pgs
argument_list|)
expr_stmt|;
if|if
condition|(
name|penum
operator|->
name|stringwidth_flag
condition|)
while|while
condition|(
operator|(
name|index
operator|=
name|penum
operator|->
name|index
operator|++
operator|)
operator|!=
name|penum
operator|->
name|size
condition|)
block|{
name|cached_char
modifier|*
name|cc
decl_stmt|;
name|chr
operator|=
name|str
index|[
name|index
index|]
expr_stmt|;
name|cc
operator|=
name|gx_lookup_cached_char
argument_list|(
name|pgs
argument_list|,
name|pair
argument_list|,
name|chr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|==
literal|0
condition|)
goto|goto
name|no_cache
goto|;
comment|/* Character is in cache. */
name|code
operator|=
name|show_fast_move
argument_list|(
name|cc
operator|->
name|wxy
argument_list|,
name|pgs
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
condition|)
return|return
name|code
return|;
block|}
else|else
while|while
condition|(
operator|(
name|index
operator|=
name|penum
operator|->
name|index
operator|++
operator|)
operator|!=
name|penum
operator|->
name|size
condition|)
block|{
name|cached_char
modifier|*
name|cc
decl_stmt|;
name|chr
operator|=
name|str
index|[
name|index
index|]
expr_stmt|;
name|cc
operator|=
name|gx_lookup_cached_char
argument_list|(
name|pgs
argument_list|,
name|pair
argument_list|,
name|chr
argument_list|)
expr_stmt|;
if|if
condition|(
name|cc
operator|==
literal|0
condition|)
goto|goto
name|no_cache
goto|;
comment|/* Character is in cache. */
name|code
operator|=
name|gx_image_cached_char
argument_list|(
name|penum
argument_list|,
name|cc
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
elseif|else
if|if
condition|(
name|code
operator|>
literal|0
condition|)
goto|goto
name|no_cache
goto|;
if|if
condition|(
name|penum
operator|->
name|slow_show
condition|)
block|{
name|penum
operator|->
name|wxy
operator|=
name|cc
operator|->
name|wxy
expr_stmt|;
name|code
operator|=
name|show_move
argument_list|(
name|penum
argument_list|)
expr_stmt|;
block|}
else|else
name|code
operator|=
name|show_fast_move
argument_list|(
name|cc
operator|->
name|wxy
argument_list|,
name|pgs
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
condition|)
return|return
name|code
return|;
block|}
comment|/* All done. */
return|return
name|show_finish
argument_list|(
name|penum
argument_list|)
return|;
block|}
else|else
block|{
comment|/* Can't use cache */
if|if
condition|(
operator|(
name|index
operator|=
name|penum
operator|->
name|index
operator|++
operator|)
operator|==
name|penum
operator|->
name|size
condition|)
block|{
comment|/* All done. */
return|return
name|show_finish
argument_list|(
name|penum
argument_list|)
return|;
block|}
name|chr
operator|=
name|str
index|[
name|index
index|]
expr_stmt|;
block|}
name|no_cache
label|:
comment|/* Character is not cached, client must render it. */
if|if
condition|(
operator|(
name|code
operator|=
name|gs_gsave
argument_list|(
name|pgs
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
comment|/* Set the charpath flag in the graphics context if necessary, */
comment|/* so that fill and stroke will add to the path */
comment|/* rather than having their usual effect. */
name|pgs
operator|->
name|in_charpath
operator|=
name|penum
operator|->
name|charpath_flag
expr_stmt|;
block|{
name|gs_fixed_point
name|cpt
decl_stmt|;
name|gx_path
modifier|*
name|ppath
init|=
name|pgs
operator|->
name|path
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|gx_path_current_point_inline
argument_list|(
name|ppath
argument_list|,
operator|&
name|cpt
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|cpt
operator|.
name|x
operator|-=
name|pgs
operator|->
name|ctm
operator|.
name|tx_fixed
expr_stmt|;
name|cpt
operator|.
name|y
operator|-=
name|pgs
operator|->
name|ctm
operator|.
name|ty_fixed
expr_stmt|;
name|gs_setmatrix
argument_list|(
name|pgs
argument_list|,
operator|&
name|pgs
operator|->
name|char_tm
argument_list|)
expr_stmt|;
name|cpt
operator|.
name|x
operator|+=
name|pgs
operator|->
name|ctm
operator|.
name|tx_fixed
expr_stmt|;
name|cpt
operator|.
name|y
operator|+=
name|pgs
operator|->
name|ctm
operator|.
name|ty_fixed
expr_stmt|;
if|if
condition|(
operator|!
name|penum
operator|->
name|stringwidth_flag
operator|&&
operator|!
name|penum
operator|->
name|charpath_flag
condition|)
block|{
comment|/* Round the translation in the graphics state. */
comment|/* This helps prevent rounding artifacts later. */
name|cpt
operator|.
name|x
operator|=
name|fixed_rounded
argument_list|(
name|cpt
operator|.
name|x
argument_list|)
expr_stmt|;
name|cpt
operator|.
name|y
operator|=
name|fixed_rounded
argument_list|(
name|cpt
operator|.
name|y
argument_list|)
expr_stmt|;
block|}
name|gs_translate_to_fixed
argument_list|(
name|pgs
argument_list|,
name|cpt
operator|.
name|x
argument_list|,
name|cpt
operator|.
name|y
argument_list|)
expr_stmt|;
name|gs_newpath
argument_list|(
name|pgs
argument_list|)
expr_stmt|;
name|gx_path_add_point
argument_list|(
name|ppath
argument_list|,
name|pgs
operator|->
name|ctm
operator|.
name|tx_fixed
argument_list|,
name|pgs
operator|->
name|ctm
operator|.
name|ty_fixed
argument_list|)
expr_stmt|;
block|}
name|penum
operator|->
name|width_status
operator|=
name|sws_none
expr_stmt|;
name|penum
operator|->
name|width_set
operator|=
name|penum
operator|->
name|sb_set
operator|=
literal|0
expr_stmt|;
name|penum
operator|->
name|continue_proc
operator|=
name|continue_show_update
expr_stmt|;
comment|/* Try using the build procedure in the font. */
comment|/*< 0 means error, 0 means success, 1 means failure. */
block|{
name|gs_font
modifier|*
name|pfont
init|=
name|pgs
operator|->
name|font
decl_stmt|;
name|code
operator|=
call|(
modifier|*
name|pfont
operator|->
name|build_char_proc
call|)
argument_list|(
name|penum
argument_list|,
name|pgs
argument_list|,
name|pfont
argument_list|,
name|chr
argument_list|,
name|pfont
operator|->
name|build_char_data
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
name|return_error
argument_list|(
name|code
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
literal|0
condition|)
block|{
name|code
operator|=
name|show_update
argument_list|(
name|penum
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|penum
operator|->
name|color_loaded
operator|=
literal|0
expr_stmt|;
name|code
operator|=
name|show_move
argument_list|(
name|penum
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
condition|)
return|return
name|code
return|;
goto|goto
name|more
goto|;
block|}
block|}
return|return
name|gs_show_render
return|;
block|}
end_function

begin_comment
comment|/* Finish show or stringwidth */
end_comment

begin_function
name|private
name|int
name|show_finish
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
specifier|register
name|gs_state
modifier|*
name|pgs
init|=
name|penum
operator|->
name|pgs
decl_stmt|;
name|int
name|code
decl_stmt|;
if|if
condition|(
operator|!
name|penum
operator|->
name|stringwidth_flag
condition|)
return|return
literal|0
return|;
comment|/* Save the accumulated width before returning, */
comment|/* and undo the extra gsave. */
name|code
operator|=
name|gs_currentpoint
argument_list|(
name|pgs
argument_list|,
operator|&
name|penum
operator|->
name|width
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
return|return
name|gs_grestore
argument_list|(
name|pgs
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Return the current character for rendering. */
end_comment

begin_function
name|char_code
name|gs_show_current_char
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
return|return
name|penum
operator|->
name|str
index|[
name|penum
operator|->
name|index
operator|-
literal|1
index|]
return|;
block|}
end_function

begin_comment
comment|/* Return the just-displayed character for kerning. */
end_comment

begin_function
name|char_code
name|gs_kshow_previous_char
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
return|return
name|penum
operator|->
name|str
index|[
name|penum
operator|->
name|index
operator|-
literal|1
index|]
return|;
block|}
end_function

begin_comment
comment|/* Return the about-to-be-displayed character for kerning. */
end_comment

begin_function
name|char_code
name|gs_kshow_next_char
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
return|return
name|penum
operator|->
name|str
index|[
name|penum
operator|->
name|index
index|]
return|;
block|}
end_function

begin_comment
comment|/* Return the accumulated width for stringwidth. */
end_comment

begin_function
name|void
name|gs_show_width
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_point
modifier|*
name|ppt
parameter_list|)
block|{
operator|*
name|ppt
operator|=
name|penum
operator|->
name|width
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Return the charpath flag. */
end_comment

begin_function
name|int
name|gs_show_in_charpath
parameter_list|(
name|gs_show_enum
modifier|*
name|penum
parameter_list|)
block|{
return|return
name|penum
operator|->
name|charpath_flag
return|;
block|}
end_function

begin_comment
comment|/* ------ Internal routines ------ */
end_comment

begin_comment
comment|/* Initialize a show enumerator */
end_comment

begin_function
name|private
name|int
name|show_setup
parameter_list|(
specifier|register
name|gs_show_enum
modifier|*
name|penum
parameter_list|,
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|char
modifier|*
name|str
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|gs_font
modifier|*
name|pfont
init|=
name|pgs
operator|->
name|font
decl_stmt|;
name|penum
operator|->
name|pgs
operator|=
name|pgs
expr_stmt|;
name|penum
operator|->
name|level
operator|=
name|pgs
operator|->
name|level
expr_stmt|;
name|penum
operator|->
name|str
operator|=
operator|(
name|byte
operator|*
operator|)
name|str
expr_stmt|;
comment|/* avoid signed chars */
name|penum
operator|->
name|wchr
operator|=
name|no_chr
expr_stmt|;
name|penum
operator|->
name|add
operator|=
literal|0
expr_stmt|;
name|penum
operator|->
name|do_kern
operator|=
literal|0
expr_stmt|;
name|penum
operator|->
name|charpath_flag
operator|=
literal|0
expr_stmt|;
name|penum
operator|->
name|stringwidth_flag
operator|=
literal|0
expr_stmt|;
name|penum
operator|->
name|dev_cache_set
operator|=
literal|0
expr_stmt|;
name|penum
operator|->
name|index
operator|=
literal|0
expr_stmt|;
name|penum
operator|->
name|continue_proc
operator|=
name|continue_show
expr_stmt|;
if|if
condition|(
operator|(
name|penum
operator|->
name|is_composite
operator|=
name|pfont
operator|->
name|FontType
operator|==
name|ft_composite
operator|)
condition|)
block|{
name|gs_font
modifier|*
name|rfont
init|=
name|pgs
operator|->
name|font
decl_stmt|;
name|penum
operator|->
name|fstack
index|[
literal|0
index|]
operator|=
name|rfont
expr_stmt|;
name|penum
operator|->
name|fdepth
operator|=
literal|0
expr_stmt|;
name|penum
operator|->
name|pfont
operator|=
name|rfont
operator|->
name|data
operator|.
name|type0_data
operator|.
name|FDepVector
index|[
name|rfont
operator|->
name|data
operator|.
name|type0_data
operator|.
name|Encoding
index|[
literal|0
index|]
index|]
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|pgs
operator|->
name|char_tm_valid
condition|)
block|{
comment|/* Compute combined transformation */
name|gs_make_identity
argument_list|(
operator|&
name|pgs
operator|->
name|char_tm
argument_list|)
expr_stmt|;
comment|/* make sure type */
comment|/* fields are set in char_tm! */
name|code
operator|=
name|gs_matrix_multiply
argument_list|(
operator|&
name|pgs
operator|->
name|font
operator|->
name|FontMatrix
argument_list|,
operator|&
name|ctm_only
argument_list|(
name|pgs
argument_list|)
argument_list|,
operator|&
name|pgs
operator|->
name|char_tm
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|pgs
operator|->
name|char_tm_valid
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|penum
operator|->
name|can_cache
operator|=
comment|/* no skewing or non-rectangular rotation */
operator|(
name|is_fzero2
argument_list|(
name|pgs
operator|->
name|char_tm
operator|.
name|xy
argument_list|,
name|pgs
operator|->
name|char_tm
operator|.
name|yx
argument_list|)
operator|||
name|is_fzero2
argument_list|(
name|pgs
operator|->
name|char_tm
operator|.
name|xx
argument_list|,
name|pgs
operator|->
name|char_tm
operator|.
name|yy
argument_list|)
operator|)
condition|)
block|{
name|gs_fixed_rect
name|cbox
decl_stmt|;
name|gx_cpath_box_for_check
argument_list|(
name|pgs
operator|->
name|clip_path
argument_list|,
operator|&
name|cbox
argument_list|)
expr_stmt|;
name|penum
operator|->
name|cxmin
operator|=
name|fixed2int_var
argument_list|(
name|cbox
operator|.
name|p
operator|.
name|x
argument_list|)
expr_stmt|;
name|penum
operator|->
name|cymin
operator|=
name|fixed2int_var
argument_list|(
name|cbox
operator|.
name|p
operator|.
name|y
argument_list|)
expr_stmt|;
name|penum
operator|->
name|cxmax
operator|=
name|fixed2int_var
argument_list|(
name|cbox
operator|.
name|q
operator|.
name|x
argument_list|)
expr_stmt|;
name|penum
operator|->
name|cymax
operator|=
name|fixed2int_var
argument_list|(
name|cbox
operator|.
name|q
operator|.
name|y
argument_list|)
expr_stmt|;
name|penum
operator|->
name|ftx
operator|=
operator|(
name|int
operator|)
name|fixed2long
argument_list|(
name|float2fixed
argument_list|(
name|pgs
operator|->
name|char_tm
operator|.
name|tx
argument_list|)
operator|-
name|pgs
operator|->
name|ctm
operator|.
name|tx_fixed
argument_list|)
expr_stmt|;
name|penum
operator|->
name|fty
operator|=
operator|(
name|int
operator|)
name|fixed2long
argument_list|(
name|float2fixed
argument_list|(
name|pgs
operator|->
name|char_tm
operator|.
name|ty
argument_list|)
operator|-
name|pgs
operator|->
name|ctm
operator|.
name|ty_fixed
argument_list|)
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


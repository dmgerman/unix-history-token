begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1992 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* zfont.c */
end_comment

begin_comment
comment|/* Font operators for Ghostscript */
end_comment

begin_include
include|#
directive|include
file|"ghost.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"oper.h"
end_include

begin_comment
comment|/*  * The following lines used to say:  *	#include "gsmatrix.h"  *	#include "gxdevice.h"		/. for gxfont.h ./  * Tony Li says the longer list is necessary to keep the GNU compiler  * happy, but this is pretty hard to understand....  */
end_comment

begin_include
include|#
directive|include
file|"gxfixed.h"
end_include

begin_include
include|#
directive|include
file|"gxmatrix.h"
end_include

begin_include
include|#
directive|include
file|"gzstate.h"
end_include

begin_comment
comment|/* must precede gxdevice */
end_comment

begin_include
include|#
directive|include
file|"gxdevice.h"
end_include

begin_comment
comment|/* must precede gxfont */
end_comment

begin_include
include|#
directive|include
file|"gschar.h"
end_include

begin_include
include|#
directive|include
file|"gxfont.h"
end_include

begin_include
include|#
directive|include
file|"gxfdir.h"
end_include

begin_include
include|#
directive|include
file|"alloc.h"
end_include

begin_include
include|#
directive|include
file|"font.h"
end_include

begin_include
include|#
directive|include
file|"dict.h"
end_include

begin_include
include|#
directive|include
file|"name.h"
end_include

begin_include
include|#
directive|include
file|"packed.h"
end_include

begin_include
include|#
directive|include
file|"save.h"
end_include

begin_include
include|#
directive|include
file|"state.h"
end_include

begin_include
include|#
directive|include
file|"store.h"
end_include

begin_comment
comment|/* Imported operators */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|zcleartomark
argument_list|(
name|P1
argument_list|(
name|os_ptr
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Forward references */
end_comment

begin_decl_stmt
name|private
name|int
name|font_param
argument_list|(
name|P2
argument_list|(
name|os_ptr
argument_list|,
name|gs_font
operator|*
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|add_FID
argument_list|(
name|P2
argument_list|(
name|ref
operator|*
argument_list|,
name|gs_font
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* needed for buildfont */
end_comment

begin_decl_stmt
name|private
name|int
name|make_font
argument_list|(
name|P2
argument_list|(
name|os_ptr
argument_list|,
name|gs_matrix
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|void
name|make_uint_array
argument_list|(
name|P3
argument_list|(
name|os_ptr
argument_list|,
name|uint
operator|*
argument_list|,
name|int
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The (global) font directory */
end_comment

begin_decl_stmt
name|gs_font_dir
modifier|*
name|ifont_dir
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* needed for buildfont */
end_comment

begin_comment
comment|/* Global font-related objects */
end_comment

begin_decl_stmt
name|ref
name|name_StandardEncoding
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* only needed for seac */
end_comment

begin_comment
comment|/* Names of system-known keys in font dictionaries: */
end_comment

begin_decl_stmt
name|ref
name|name_FontMatrix
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* needed for buildfont */
end_comment

begin_decl_stmt
name|ref
name|name_FID
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Initialize the font operators */
end_comment

begin_function
name|private
name|void
name|zfont_init
parameter_list|()
block|{
specifier|static
specifier|const
name|names_def
name|fnd
index|[]
init|=
block|{
comment|/* Create the names of the global known objects. */
block|{
literal|"StandardEncoding"
block|,
operator|&
name|name_StandardEncoding
block|}
block|,
comment|/* Create the names of the standard elements of */
comment|/* a font dictionary. */
block|{
literal|"FontMatrix"
block|,
operator|&
name|name_FontMatrix
block|}
block|,
block|{
literal|"FID"
block|,
operator|&
name|name_FID
block|}
block|,
comment|/* Mark the end of the initalized name list. */
name|names_def_end
block|}
decl_stmt|;
name|ifont_dir
operator|=
name|gs_font_dir_alloc
argument_list|(
name|alloc
argument_list|,
name|alloc_free
argument_list|)
expr_stmt|;
name|init_names
argument_list|(
name|fnd
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* scalefont */
end_comment

begin_function
name|int
name|zscalefont
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|float
name|scale
decl_stmt|;
name|gs_matrix
name|mat
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|num_params
argument_list|(
name|op
argument_list|,
literal|1
argument_list|,
operator|&
name|scale
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
if|if
condition|(
operator|(
name|code
operator|=
name|gs_make_scaling
argument_list|(
name|scale
argument_list|,
name|scale
argument_list|,
operator|&
name|mat
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
return|return
name|make_font
argument_list|(
name|op
argument_list|,
operator|&
name|mat
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* makefont */
end_comment

begin_function
name|int
name|zmakefont
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|gs_matrix
name|mat
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|read_matrix
argument_list|(
name|op
argument_list|,
operator|&
name|mat
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
return|return
name|make_font
argument_list|(
name|op
argument_list|,
operator|&
name|mat
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* setfont */
end_comment

begin_function
name|int
name|zsetfont
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gs_font
modifier|*
name|pfont
decl_stmt|;
name|int
name|code
init|=
name|font_param
argument_list|(
name|op
argument_list|,
operator|&
name|pfont
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|gs_setfont
argument_list|(
name|igs
argument_list|,
name|pfont
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|istate
operator|.
name|font
operator|=
operator|*
name|op
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* currentfont */
end_comment

begin_function
name|int
name|zcurrentfont
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
operator|*
name|op
operator|=
name|istate
operator|.
name|font
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* cachestatus */
end_comment

begin_function
name|int
name|zcachestatus
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|uint
name|status
index|[
literal|7
index|]
decl_stmt|;
name|gs_cachestatus
argument_list|(
name|ifont_dir
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|push
argument_list|(
literal|7
argument_list|)
expr_stmt|;
name|make_uint_array
argument_list|(
name|op
operator|-
literal|6
argument_list|,
name|status
argument_list|,
literal|7
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setcachelimit */
end_comment

begin_function
name|int
name|zsetcachelimit
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|long
name|limit
decl_stmt|;
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
name|limit
operator|=
name|op
operator|->
name|value
operator|.
name|intval
expr_stmt|;
if|if
condition|(
operator|(
name|ulong
operator|)
name|limit
operator|>
name|max_uint
condition|)
comment|/* also covers limit< 0 */
return|return
name|e_rangecheck
return|;
name|gs_setcachelimit
argument_list|(
name|ifont_dir
argument_list|,
operator|(
name|uint
operator|)
name|limit
argument_list|)
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setcacheparams */
end_comment

begin_function
name|int
name|zsetcacheparams
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|uint
name|params
index|[
literal|2
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|code
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|2
operator|&&
operator|!
name|r_has_type
argument_list|(
name|op
operator|-
name|i
argument_list|,
name|t_mark
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|long
name|parm
decl_stmt|;
name|check_type
argument_list|(
name|op
index|[
operator|-
name|i
index|]
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
name|parm
operator|=
name|op
index|[
operator|-
name|i
index|]
operator|.
name|value
operator|.
name|intval
expr_stmt|;
if|if
condition|(
operator|(
name|ulong
operator|)
name|parm
operator|>
name|max_uint
condition|)
comment|/* covers parm< 0 */
return|return
name|e_rangecheck
return|;
name|params
index|[
name|i
index|]
operator|=
name|parm
expr_stmt|;
block|}
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|2
case|:
if|if
condition|(
operator|(
name|code
operator|=
name|gs_setcachelower
argument_list|(
name|ifont_dir
argument_list|,
name|params
index|[
literal|1
index|]
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
case|case
literal|1
case|:
if|if
condition|(
operator|(
name|code
operator|=
name|gs_setcacheupper
argument_list|(
name|ifont_dir
argument_list|,
name|params
index|[
literal|0
index|]
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
case|case
literal|0
case|:
empty_stmt|;
block|}
return|return
name|zcleartomark
argument_list|(
name|op
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* currentcacheparams */
end_comment

begin_function
name|int
name|zcurrentcacheparams
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|uint
name|params
index|[
literal|2
index|]
decl_stmt|;
name|params
index|[
literal|0
index|]
operator|=
name|gs_currentcachelower
argument_list|(
name|ifont_dir
argument_list|)
expr_stmt|;
name|params
index|[
literal|1
index|]
operator|=
name|gs_currentcacheupper
argument_list|(
name|ifont_dir
argument_list|)
expr_stmt|;
name|push
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|make_tv
argument_list|(
name|op
operator|-
literal|2
argument_list|,
name|t_mark
argument_list|,
name|intval
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|make_uint_array
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|params
argument_list|,
literal|2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* ------ Initialization procedure ------ */
end_comment

begin_decl_stmt
name|op_def
name|zfont_op_defs
index|[]
init|=
block|{
block|{
literal|"0currentfont"
block|,
name|zcurrentfont
block|}
block|,
block|{
literal|"2makefont"
block|,
name|zmakefont
block|}
block|,
block|{
literal|"2scalefont"
block|,
name|zscalefont
block|}
block|,
block|{
literal|"1setfont"
block|,
name|zsetfont
block|}
block|,
block|{
literal|"0cachestatus"
block|,
name|zcachestatus
block|}
block|,
block|{
literal|"1setcachelimit"
block|,
name|zsetcachelimit
block|}
block|,
block|{
literal|"1setcacheparams"
block|,
name|zsetcacheparams
block|}
block|,
block|{
literal|"0currentcacheparams"
block|,
name|zcurrentcacheparams
block|}
block|,
name|op_def_end
argument_list|(
argument|zfont_init
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ------ Subroutines ------ */
end_comment

begin_comment
comment|/* Validate a font parameter. */
end_comment

begin_function
name|private
name|int
name|font_param
parameter_list|(
name|os_ptr
name|fp
parameter_list|,
name|gs_font
modifier|*
modifier|*
name|pfont
parameter_list|)
block|{
comment|/* Check that fp is a read-only dictionary, */
comment|/* and that it has a FID entry. */
name|ref
modifier|*
name|pid
decl_stmt|;
name|int
name|code
decl_stmt|;
name|check_type
argument_list|(
operator|*
name|fp
argument_list|,
name|t_dictionary
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|dict_find
argument_list|(
name|fp
argument_list|,
operator|&
name|name_FID
argument_list|,
operator|&
name|pid
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
operator|*
name|pfont
operator|=
name|pid
operator|->
name|value
operator|.
name|pfont
expr_stmt|;
if|if
condition|(
operator|*
name|pfont
operator|==
literal|0
condition|)
return|return
name|e_invalidfont
return|;
comment|/* unregistered font */
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Add the FID entry to a font dictionary. */
end_comment

begin_function
name|int
name|add_FID
parameter_list|(
name|ref
modifier|*
name|fp
comment|/* t_dictionary */
parameter_list|,
name|gs_font
modifier|*
name|pfont
parameter_list|)
block|{
name|ref
name|fid
decl_stmt|;
name|make_tv_new
argument_list|(
operator|&
name|fid
argument_list|,
name|t_fontID
argument_list|,
name|pfont
argument_list|,
name|pfont
argument_list|)
expr_stmt|;
return|return
name|dict_put
argument_list|(
name|fp
argument_list|,
operator|&
name|name_FID
argument_list|,
operator|&
name|fid
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Make a transformed font (common code for makefont/scalefont). */
end_comment

begin_function
name|private
name|int
name|make_font
parameter_list|(
name|os_ptr
name|op
parameter_list|,
name|gs_matrix
modifier|*
name|pmat
parameter_list|)
block|{
name|os_ptr
name|fp
init|=
name|op
operator|-
literal|1
decl_stmt|;
name|gs_font
modifier|*
name|oldfont
decl_stmt|,
modifier|*
name|newfont
decl_stmt|,
modifier|*
name|ffont
decl_stmt|;
name|ref
name|newdict
decl_stmt|;
name|ref
name|newmat
decl_stmt|;
name|ref
modifier|*
name|mbody
decl_stmt|;
name|int
name|code
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|font_param
argument_list|(
name|fp
argument_list|,
operator|&
name|oldfont
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|gs_makefont
argument_list|(
name|ifont_dir
argument_list|,
name|oldfont
argument_list|,
name|pmat
argument_list|,
operator|&
name|newfont
argument_list|,
operator|&
name|ffont
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|dict_create
argument_list|(
name|dict_maxlength
argument_list|(
name|fp
argument_list|)
argument_list|,
operator|&
name|newdict
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|dict_copy
argument_list|(
name|fp
argument_list|,
operator|&
name|newdict
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
operator|(
operator|(
name|mbody
operator|=
name|alloc_refs
argument_list|(
literal|6
argument_list|,
literal|"make_font"
argument_list|)
operator|)
operator|==
literal|0
condition|?
name|e_VMerror
else|:
literal|0
operator|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|make_tasv_new
argument_list|(
operator|&
name|newmat
argument_list|,
name|t_array
argument_list|,
name|a_all
argument_list|,
literal|6
argument_list|,
name|refs
argument_list|,
name|mbody
argument_list|)
operator|,
operator|(
name|code
operator|=
name|dict_put
argument_list|(
operator|&
name|newdict
argument_list|,
operator|&
name|name_FontMatrix
argument_list|,
operator|&
name|newmat
argument_list|)
operator|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|add_FID
argument_list|(
operator|&
name|newdict
argument_list|,
name|newfont
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
operator|*
operator|(
name|gs_matrix
operator|*
operator|)
name|mbody
operator|=
name|newfont
operator|->
name|FontMatrix
expr_stmt|;
if|if
condition|(
name|ffont
condition|)
block|{
comment|/****** SHOULD DECREMENT REFCT ******/
block|}
name|r_clear_attrs
argument_list|(
name|dict_access_ref
argument_list|(
operator|&
name|newdict
argument_list|)
argument_list|,
name|a_write
argument_list|)
expr_stmt|;
operator|*
name|fp
operator|=
name|newdict
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Convert an array of (unsigned) integers to stack form. */
end_comment

begin_function
name|private
name|void
name|make_uint_array
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|,
name|uint
modifier|*
name|intp
parameter_list|,
name|int
name|count
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|count
condition|;
name|i
operator|++
operator|,
name|op
operator|++
operator|,
name|intp
operator|++
control|)
name|make_int
argument_list|(
name|op
argument_list|,
operator|*
name|intp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Remove scaled font and character cache entries that would be */
end_comment

begin_comment
comment|/* invalidated by a restore. */
end_comment

begin_decl_stmt
specifier|extern
name|void
name|gs_purge_font_from_caches
argument_list|(
name|P2
argument_list|(
name|gs_font_dir
operator|*
argument_list|,
name|gs_font
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|font_restore
parameter_list|(
name|alloc_save
modifier|*
name|save
parameter_list|)
block|{
name|gs_font_dir
modifier|*
name|pdir
init|=
name|ifont_dir
decl_stmt|;
name|gs_font
modifier|*
name|pfont
decl_stmt|;
name|top
label|:
for|for
control|(
name|pfont
operator|=
name|pdir
operator|->
name|scaled_fonts
init|;
name|pfont
operator|!=
literal|0
condition|;
name|pfont
operator|=
name|pfont
operator|->
name|next
control|)
block|{
if|if
condition|(
name|alloc_is_since_save
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pfont
argument_list|,
name|save
argument_list|)
condition|)
block|{
name|gs_purge_font_from_caches
argument_list|(
name|pdir
argument_list|,
name|pfont
argument_list|)
expr_stmt|;
goto|goto
name|top
goto|;
block|}
elseif|else
if|if
condition|(
name|alloc_is_since_save
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pfont
operator|->
name|base
argument_list|,
name|save
argument_list|)
condition|)
block|{
name|gs_purge_font_from_caches
argument_list|(
name|pdir
argument_list|,
name|pfont
operator|->
name|base
argument_list|)
expr_stmt|;
goto|goto
name|top
goto|;
block|}
block|}
block|}
end_function

end_unit


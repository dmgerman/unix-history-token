begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *   Z M . C  *    ZMODEM protocol primitives  *    04-17-89  Chuck Forsberg Omen Technology Inc  *  * Entry point Functions:  *	zsbhdr(type, hdr) send binary header  *	zshhdr(type, hdr) send hex header  *	zgethdr(hdr, eflag) receive header - binary or hex  *	zsdata(buf, len, frameend) send data  *	zrdata(buf, len) receive data  *	stohdr(pos) store position data in Txhdr  *	long rclhdr(hdr) recover position offset from header  *  *	This version implements ZMODEM Run Length Encoding, Comparision,  *	and variable length headers.  These features were not funded  *	by the original Telenet development contract.  This software,  *	including these features, may be freely used for non  *	commercial and educational purposes.  This software may also  *	be freely used to support file transfer operations to or from  *	licensed Omen Technology products.  Contact Omen Technology  *	for licensing for other uses.  Any programs which use part or  *	all of this software must be provided in source form with this  *	notice intact except by written permission from Omen  *	Technology Incorporated.  *  *		Omen Technology Inc		FAX: 503-621-3745  *		Post Office Box 4681  *		Portland OR 97208  *  *	Previous versions of this program (not containing the extensions  *	listed above) remain in the public domain.  *  *	This code is made available in the hope it will be useful,  *	BUT WITHOUT ANY WARRANTY OF ANY KIND OR LIABILITY FOR ANY  *	DAMAGES OF ANY KIND.  *  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|CANFDX
end_ifndef

begin_include
include|#
directive|include
file|"zmodem.h"
end_include

begin_decl_stmt
name|int
name|Rxtimeout
init|=
literal|100
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Tenths of seconds to wait for something */
end_comment

begin_endif
endif|#
directive|endif
end_endif

begin_ifndef
ifndef|#
directive|ifndef
name|UNSL
end_ifndef

begin_define
define|#
directive|define
name|UNSL
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Globals used by ZMODEM functions */
end_comment

begin_decl_stmt
name|int
name|Rxframeind
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ZBIN ZBIN32, or ZHEX type of frame */
end_comment

begin_decl_stmt
name|int
name|Rxtype
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Type of header received */
end_comment

begin_decl_stmt
name|int
name|Rxhlen
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Length of header received */
end_comment

begin_decl_stmt
name|int
name|Rxcount
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Count of data bytes received */
end_comment

begin_decl_stmt
name|char
name|Rxhdr
index|[
name|ZMAXHLEN
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Received header */
end_comment

begin_decl_stmt
name|char
name|Txhdr
index|[
name|ZMAXHLEN
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Transmitted header */
end_comment

begin_decl_stmt
name|long
name|Rxpos
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Received file position */
end_comment

begin_decl_stmt
name|long
name|Txpos
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Transmitted file position */
end_comment

begin_decl_stmt
name|int
name|Txfcs32
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* TURE means send binary frames with 32 bit FCS */
end_comment

begin_decl_stmt
name|int
name|Crc32t
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Controls 32 bit CRC being sent */
end_comment

begin_comment
comment|/* 1 == CRC32,  2 == CRC32 + RLE */
end_comment

begin_decl_stmt
name|int
name|Crc32r
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Indicates/controls 32 bit CRC being received */
end_comment

begin_comment
comment|/* 0 == CRC16,  1 == CRC32,  2 == CRC32 + RLE */
end_comment

begin_decl_stmt
name|int
name|Usevhdrs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Use variable length headers */
end_comment

begin_decl_stmt
name|int
name|Znulls
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Number of nulls to send at beginning of ZDATA hdr */
end_comment

begin_decl_stmt
name|char
name|Attn
index|[
name|ZATTNLEN
operator|+
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Attention string rx sends to tx on err */
end_comment

begin_decl_stmt
name|char
modifier|*
name|Altcan
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Alternate canit string */
end_comment

begin_expr_stmt
specifier|static
name|lastsent
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Last char we sent */
end_comment

begin_expr_stmt
specifier|static
name|Not8bit
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* Seven bits seen on header */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|frametypes
index|[]
init|=
block|{
literal|"No Response to Error Correction Request"
block|,
comment|/* -4 */
literal|"No Carrier Detect"
block|,
comment|/* -3 */
literal|"TIMEOUT"
block|,
comment|/* -2 */
literal|"ERROR"
block|,
comment|/* -1 */
define|#
directive|define
name|FTOFFSET
value|4
literal|"ZRQINIT"
block|,
literal|"ZRINIT"
block|,
literal|"ZSINIT"
block|,
literal|"ZACK"
block|,
literal|"ZFILE"
block|,
literal|"ZSKIP"
block|,
literal|"ZNAK"
block|,
literal|"ZABORT"
block|,
literal|"ZFIN"
block|,
literal|"ZRPOS"
block|,
literal|"ZDATA"
block|,
literal|"ZEOF"
block|,
literal|"ZFERR"
block|,
literal|"ZCRC"
block|,
literal|"ZCHALLENGE"
block|,
literal|"ZCOMPL"
block|,
literal|"ZCAN"
block|,
literal|"ZFREECNT"
block|,
literal|"ZCOMMAND"
block|,
literal|"ZSTDERR"
block|,
literal|"xxxxx"
define|#
directive|define
name|FRTYPES
value|22
comment|/* Total number of frame types in this array */
comment|/*  not including psuedo negative entries */
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|badcrc
index|[]
init|=
literal|"Bad CRC"
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Send ZMODEM binary header hdr of type type */
end_comment

begin_expr_stmt
name|zsbhdr
argument_list|(
name|len
argument_list|,
name|type
argument_list|,
name|hdr
argument_list|)
specifier|register
name|char
operator|*
name|hdr
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|unsigned
name|short
name|crc
decl_stmt|;
ifndef|#
directive|ifndef
name|DSZ
name|vfile
argument_list|(
literal|"zsbhdr: %c %d %s %lx"
argument_list|,
name|Usevhdrs
condition|?
literal|'v'
else|:
literal|'f'
argument_list|,
name|len
argument_list|,
name|frametypes
index|[
name|type
operator|+
name|FTOFFSET
index|]
argument_list|,
name|rclhdr
argument_list|(
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|type
operator|==
name|ZDATA
condition|)
for|for
control|(
name|n
operator|=
name|Znulls
init|;
operator|--
name|n
operator|>=
literal|0
condition|;
control|)
name|xsendline
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|xsendline
argument_list|(
name|ZPAD
argument_list|)
expr_stmt|;
name|xsendline
argument_list|(
name|ZDLE
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|Crc32t
operator|=
name|Txfcs32
condition|)
block|{
case|case
literal|2
case|:
name|zsbh32
argument_list|(
name|len
argument_list|,
name|hdr
argument_list|,
name|type
argument_list|,
name|Usevhdrs
condition|?
name|ZVBINR32
else|:
name|ZBINR32
argument_list|)
expr_stmt|;
name|flushmo
argument_list|()
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|zsbh32
argument_list|(
name|len
argument_list|,
name|hdr
argument_list|,
name|type
argument_list|,
name|Usevhdrs
condition|?
name|ZVBIN32
else|:
name|ZBIN32
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|Usevhdrs
condition|)
block|{
name|xsendline
argument_list|(
name|ZVBIN
argument_list|)
expr_stmt|;
name|zsendline
argument_list|(
name|len
argument_list|)
expr_stmt|;
block|}
else|else
name|xsendline
argument_list|(
name|ZBIN
argument_list|)
expr_stmt|;
name|zsendline
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|crc
operator|=
name|updcrc
argument_list|(
name|type
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|len
init|;
operator|--
name|n
operator|>=
literal|0
condition|;
operator|++
name|hdr
control|)
block|{
name|zsendline
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|crc
operator|=
name|updcrc
argument_list|(
operator|(
literal|0377
operator|&
operator|*
name|hdr
operator|)
argument_list|,
name|crc
argument_list|)
expr_stmt|;
block|}
name|crc
operator|=
name|updcrc
argument_list|(
literal|0
argument_list|,
name|updcrc
argument_list|(
literal|0
argument_list|,
name|crc
argument_list|)
argument_list|)
expr_stmt|;
name|zsendline
argument_list|(
name|crc
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|zsendline
argument_list|(
name|crc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|type
operator|!=
name|ZDATA
condition|)
name|flushmo
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Send ZMODEM binary header hdr of type type */
end_comment

begin_expr_stmt
name|zsbh32
argument_list|(
name|len
argument_list|,
name|hdr
argument_list|,
name|type
argument_list|,
name|flavour
argument_list|)
specifier|register
name|char
operator|*
name|hdr
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|UNSL
name|long
name|crc
decl_stmt|;
name|xsendline
argument_list|(
name|flavour
argument_list|)
expr_stmt|;
if|if
condition|(
name|Usevhdrs
condition|)
name|zsendline
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|zsendline
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|crc
operator|=
literal|0xFFFFFFFFL
expr_stmt|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|type
argument_list|,
name|crc
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|len
init|;
operator|--
name|n
operator|>=
literal|0
condition|;
operator|++
name|hdr
control|)
block|{
name|crc
operator|=
name|UPDC32
argument_list|(
operator|(
literal|0377
operator|&
operator|*
name|hdr
operator|)
argument_list|,
name|crc
argument_list|)
expr_stmt|;
name|zsendline
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
block|}
name|crc
operator|=
operator|~
name|crc
expr_stmt|;
for|for
control|(
name|n
operator|=
literal|4
init|;
operator|--
name|n
operator|>=
literal|0
condition|;
control|)
block|{
name|zsendline
argument_list|(
operator|(
name|int
operator|)
name|crc
argument_list|)
expr_stmt|;
name|crc
operator|>>=
literal|8
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Send ZMODEM HEX header hdr of type type */
end_comment

begin_expr_stmt
name|zshhdr
argument_list|(
name|len
argument_list|,
name|type
argument_list|,
name|hdr
argument_list|)
specifier|register
name|char
operator|*
name|hdr
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|n
decl_stmt|;
specifier|register
name|unsigned
name|short
name|crc
decl_stmt|;
ifndef|#
directive|ifndef
name|DSZ
name|vfile
argument_list|(
literal|"zshhdr: %c %d %s %lx"
argument_list|,
name|Usevhdrs
condition|?
literal|'v'
else|:
literal|'f'
argument_list|,
name|len
argument_list|,
name|frametypes
index|[
name|type
operator|+
name|FTOFFSET
index|]
argument_list|,
name|rclhdr
argument_list|(
name|hdr
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sendline
argument_list|(
name|ZPAD
argument_list|)
expr_stmt|;
name|sendline
argument_list|(
name|ZPAD
argument_list|)
expr_stmt|;
name|sendline
argument_list|(
name|ZDLE
argument_list|)
expr_stmt|;
if|if
condition|(
name|Usevhdrs
condition|)
block|{
name|sendline
argument_list|(
name|ZVHEX
argument_list|)
expr_stmt|;
name|zputhex
argument_list|(
name|len
argument_list|)
expr_stmt|;
block|}
else|else
name|sendline
argument_list|(
name|ZHEX
argument_list|)
expr_stmt|;
name|zputhex
argument_list|(
name|type
argument_list|)
expr_stmt|;
name|Crc32t
operator|=
literal|0
expr_stmt|;
name|crc
operator|=
name|updcrc
argument_list|(
name|type
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|len
init|;
operator|--
name|n
operator|>=
literal|0
condition|;
operator|++
name|hdr
control|)
block|{
name|zputhex
argument_list|(
operator|*
name|hdr
argument_list|)
expr_stmt|;
name|crc
operator|=
name|updcrc
argument_list|(
operator|(
literal|0377
operator|&
operator|*
name|hdr
operator|)
argument_list|,
name|crc
argument_list|)
expr_stmt|;
block|}
name|crc
operator|=
name|updcrc
argument_list|(
literal|0
argument_list|,
name|updcrc
argument_list|(
literal|0
argument_list|,
name|crc
argument_list|)
argument_list|)
expr_stmt|;
name|zputhex
argument_list|(
name|crc
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|zputhex
argument_list|(
name|crc
argument_list|)
expr_stmt|;
comment|/* Make it printable on remote machine */
name|sendline
argument_list|(
literal|015
argument_list|)
expr_stmt|;
name|sendline
argument_list|(
literal|0212
argument_list|)
expr_stmt|;
comment|/* 	 * Uncork the remote in case a fake XOFF has stopped data flow 	 */
if|if
condition|(
name|type
operator|!=
name|ZFIN
operator|&&
name|type
operator|!=
name|ZACK
condition|)
name|sendline
argument_list|(
literal|021
argument_list|)
expr_stmt|;
name|flushmo
argument_list|()
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Send binary array buf of length length, with ending ZDLE sequence frameend  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|Zendnames
index|[]
init|=
block|{
literal|"ZCRCE"
block|,
literal|"ZCRCG"
block|,
literal|"ZCRCQ"
block|,
literal|"ZCRCW"
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|zsdata
argument_list|(
name|buf
argument_list|,
name|length
argument_list|,
name|frameend
argument_list|)
specifier|register
name|char
operator|*
name|buf
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|unsigned
name|short
name|crc
decl_stmt|;
ifndef|#
directive|ifndef
name|DSZ
name|vfile
argument_list|(
literal|"zsdata: %d %s"
argument_list|,
name|length
argument_list|,
name|Zendnames
index|[
name|frameend
operator|-
name|ZCRCE
operator|&
literal|3
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
switch|switch
condition|(
name|Crc32t
condition|)
block|{
case|case
literal|1
case|:
name|zsda32
argument_list|(
name|buf
argument_list|,
name|length
argument_list|,
name|frameend
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|zsdar32
argument_list|(
name|buf
argument_list|,
name|length
argument_list|,
name|frameend
argument_list|)
expr_stmt|;
break|break;
default|default:
name|crc
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
operator|--
name|length
operator|>=
literal|0
condition|;
operator|++
name|buf
control|)
block|{
name|zsendline
argument_list|(
operator|*
name|buf
argument_list|)
expr_stmt|;
name|crc
operator|=
name|updcrc
argument_list|(
operator|(
literal|0377
operator|&
operator|*
name|buf
operator|)
argument_list|,
name|crc
argument_list|)
expr_stmt|;
block|}
name|xsendline
argument_list|(
name|ZDLE
argument_list|)
expr_stmt|;
name|xsendline
argument_list|(
name|frameend
argument_list|)
expr_stmt|;
name|crc
operator|=
name|updcrc
argument_list|(
name|frameend
argument_list|,
name|crc
argument_list|)
expr_stmt|;
name|crc
operator|=
name|updcrc
argument_list|(
literal|0
argument_list|,
name|updcrc
argument_list|(
literal|0
argument_list|,
name|crc
argument_list|)
argument_list|)
expr_stmt|;
name|zsendline
argument_list|(
name|crc
operator|>>
literal|8
argument_list|)
expr_stmt|;
name|zsendline
argument_list|(
name|crc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|frameend
operator|==
name|ZCRCW
condition|)
block|{
name|xsendline
argument_list|(
name|XON
argument_list|)
expr_stmt|;
name|flushmo
argument_list|()
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
name|zsda32
argument_list|(
name|buf
argument_list|,
name|length
argument_list|,
name|frameend
argument_list|)
specifier|register
name|char
operator|*
name|buf
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|UNSL
name|long
name|crc
decl_stmt|;
name|crc
operator|=
literal|0xFFFFFFFFL
expr_stmt|;
for|for
control|(
init|;
operator|--
name|length
operator|>=
literal|0
condition|;
operator|++
name|buf
control|)
block|{
name|c
operator|=
operator|*
name|buf
operator|&
literal|0377
expr_stmt|;
if|if
condition|(
name|c
operator|&
literal|0140
condition|)
name|xsendline
argument_list|(
name|lastsent
operator|=
name|c
argument_list|)
expr_stmt|;
else|else
name|zsendline
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
block|}
name|xsendline
argument_list|(
name|ZDLE
argument_list|)
expr_stmt|;
name|xsendline
argument_list|(
name|frameend
argument_list|)
expr_stmt|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|frameend
argument_list|,
name|crc
argument_list|)
expr_stmt|;
name|crc
operator|=
operator|~
name|crc
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|4
init|;
operator|--
name|c
operator|>=
literal|0
condition|;
control|)
block|{
name|zsendline
argument_list|(
operator|(
name|int
operator|)
name|crc
argument_list|)
expr_stmt|;
name|crc
operator|>>=
literal|8
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/*  * Receive array buf of max length with ending ZDLE sequence  *  and CRC.  Returns the ending character or error code.  *  NB: On errors may store length+1 bytes!  */
end_comment

begin_expr_stmt
name|zrdata
argument_list|(
name|buf
argument_list|,
name|length
argument_list|)
specifier|register
name|char
operator|*
name|buf
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|unsigned
name|short
name|crc
decl_stmt|;
specifier|register
name|char
modifier|*
name|end
decl_stmt|;
specifier|register
name|int
name|d
decl_stmt|;
switch|switch
condition|(
name|Crc32r
condition|)
block|{
case|case
literal|1
case|:
return|return
name|zrdat32
argument_list|(
name|buf
argument_list|,
name|length
argument_list|)
return|;
case|case
literal|2
case|:
return|return
name|zrdatr32
argument_list|(
name|buf
argument_list|,
name|length
argument_list|)
return|;
block|}
name|crc
operator|=
name|Rxcount
operator|=
literal|0
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|length
expr_stmt|;
while|while
condition|(
name|buf
operator|<=
name|end
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
block|{
name|crcfoo
label|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
name|GOTCRCE
case|:
case|case
name|GOTCRCG
case|:
case|case
name|GOTCRCQ
case|:
case|case
name|GOTCRCW
case|:
name|crc
operator|=
name|updcrc
argument_list|(
operator|(
name|d
operator|=
name|c
operator|)
operator|&
literal|0377
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
goto|goto
name|crcfoo
goto|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
goto|goto
name|crcfoo
goto|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
name|crc
operator|&
literal|0xFFFF
condition|)
block|{
name|zperr
argument_list|(
name|badcrc
argument_list|)
expr_stmt|;
return|return
name|ERROR
return|;
block|}
name|Rxcount
operator|=
name|length
operator|-
operator|(
name|end
operator|-
name|buf
operator|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DSZ
name|vfile
argument_list|(
literal|"zrdata: %d  %s"
argument_list|,
name|Rxcount
argument_list|,
name|Zendnames
index|[
name|d
operator|-
name|GOTCRCE
operator|&
literal|3
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|d
return|;
case|case
name|GOTCAN
case|:
name|zperr
argument_list|(
literal|"Sender Canceled"
argument_list|)
expr_stmt|;
return|return
name|ZCAN
return|;
case|case
name|TIMEOUT
case|:
name|zperr
argument_list|(
literal|"TIMEOUT"
argument_list|)
expr_stmt|;
return|return
name|c
return|;
default|default:
name|garbitch
argument_list|()
expr_stmt|;
return|return
name|c
return|;
block|}
block|}
operator|*
name|buf
operator|++
operator|=
name|c
expr_stmt|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
block|}
ifdef|#
directive|ifdef
name|DSZ
name|garbitch
argument_list|()
expr_stmt|;
else|#
directive|else
name|zperr
argument_list|(
literal|"Data subpacket too long"
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|ERROR
return|;
block|}
end_block

begin_expr_stmt
name|zrdat32
argument_list|(
name|buf
argument_list|,
name|length
argument_list|)
specifier|register
name|char
operator|*
name|buf
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|UNSL
name|long
name|crc
decl_stmt|;
specifier|register
name|char
modifier|*
name|end
decl_stmt|;
specifier|register
name|int
name|d
decl_stmt|;
name|crc
operator|=
literal|0xFFFFFFFFL
expr_stmt|;
name|Rxcount
operator|=
literal|0
expr_stmt|;
name|end
operator|=
name|buf
operator|+
name|length
expr_stmt|;
while|while
condition|(
name|buf
operator|<=
name|end
condition|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
block|{
name|crcfoo
label|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
name|GOTCRCE
case|:
case|case
name|GOTCRCG
case|:
case|case
name|GOTCRCQ
case|:
case|case
name|GOTCRCW
case|:
name|d
operator|=
name|c
expr_stmt|;
name|c
operator|&=
literal|0377
expr_stmt|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
goto|goto
name|crcfoo
goto|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
goto|goto
name|crcfoo
goto|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
goto|goto
name|crcfoo
goto|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
goto|goto
name|crcfoo
goto|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
name|crc
operator|!=
literal|0xDEBB20E3
condition|)
block|{
name|zperr
argument_list|(
name|badcrc
argument_list|)
expr_stmt|;
return|return
name|ERROR
return|;
block|}
name|Rxcount
operator|=
name|length
operator|-
operator|(
name|end
operator|-
name|buf
operator|)
expr_stmt|;
ifndef|#
directive|ifndef
name|DSZ
name|vfile
argument_list|(
literal|"zrdat32: %d %s"
argument_list|,
name|Rxcount
argument_list|,
name|Zendnames
index|[
name|d
operator|-
name|GOTCRCE
operator|&
literal|3
index|]
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|d
return|;
case|case
name|GOTCAN
case|:
name|zperr
argument_list|(
literal|"Sender Canceled"
argument_list|)
expr_stmt|;
return|return
name|ZCAN
return|;
case|case
name|TIMEOUT
case|:
name|zperr
argument_list|(
literal|"TIMEOUT"
argument_list|)
expr_stmt|;
return|return
name|c
return|;
default|default:
name|garbitch
argument_list|()
expr_stmt|;
return|return
name|c
return|;
block|}
block|}
operator|*
name|buf
operator|++
operator|=
name|c
expr_stmt|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
block|}
name|zperr
argument_list|(
literal|"Data subpacket too long"
argument_list|)
expr_stmt|;
return|return
name|ERROR
return|;
block|}
end_block

begin_macro
name|garbitch
argument_list|()
end_macro

begin_block
block|{
name|zperr
argument_list|(
literal|"Garbled data subpacket"
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Read a ZMODEM header to hdr, either binary or hex.  *  eflag controls local display of non zmodem characters:  *	0:  no display  *	1:  display printing characters only  *	2:  display all non ZMODEM characters  *  On success, set Zmodem to 1, set Rxpos and return type of header.  *   Otherwise return negative on error.  *   Return ERROR instantly if ZCRCW sequence, for fast error recovery.  */
end_comment

begin_macro
name|zgethdr
argument_list|(
argument|hdr
argument_list|,
argument|eflag
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|hdr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|n
decl_stmt|,
name|cancount
decl_stmt|;
name|n
operator|=
name|Zrwindow
operator|+
name|Effbaud
expr_stmt|;
comment|/* Max bytes before start of frame */
name|Rxframeind
operator|=
name|Rxtype
operator|=
literal|0
expr_stmt|;
name|startover
label|:
name|cancount
operator|=
literal|5
expr_stmt|;
name|again
label|:
comment|/* Return immediate ERROR if ZCRCW sequence seen */
switch|switch
condition|(
name|c
operator|=
name|readline
argument_list|(
name|Rxtimeout
argument_list|)
condition|)
block|{
case|case
name|RCDO
case|:
case|case
name|TIMEOUT
case|:
goto|goto
name|fifi
goto|;
case|case
name|CAN
case|:
name|gotcan
label|:
if|if
condition|(
operator|--
name|cancount
operator|<=
literal|0
condition|)
block|{
name|c
operator|=
name|ZCAN
expr_stmt|;
goto|goto
name|fifi
goto|;
block|}
switch|switch
condition|(
name|c
operator|=
name|readline
argument_list|(
literal|1
argument_list|)
condition|)
block|{
case|case
name|TIMEOUT
case|:
goto|goto
name|again
goto|;
case|case
name|ZCRCW
case|:
switch|switch
condition|(
name|readline
argument_list|(
literal|1
argument_list|)
condition|)
block|{
case|case
name|TIMEOUT
case|:
name|c
operator|=
name|ERROR
expr_stmt|;
goto|goto
name|fifi
goto|;
case|case
name|RCDO
case|:
goto|goto
name|fifi
goto|;
default|default:
goto|goto
name|agn2
goto|;
block|}
case|case
name|RCDO
case|:
goto|goto
name|fifi
goto|;
default|default:
break|break;
case|case
name|CAN
case|:
if|if
condition|(
operator|--
name|cancount
operator|<=
literal|0
condition|)
block|{
name|c
operator|=
name|ZCAN
expr_stmt|;
goto|goto
name|fifi
goto|;
block|}
goto|goto
name|again
goto|;
block|}
comment|/* **** FALL THRU TO **** */
default|default:
name|agn2
label|:
if|if
condition|(
operator|--
name|n
operator|==
literal|0
condition|)
block|{
name|c
operator|=
name|GCOUNT
expr_stmt|;
goto|goto
name|fifi
goto|;
block|}
if|if
condition|(
name|eflag
operator|&&
operator|(
operator|(
name|c
operator|&=
literal|0177
operator|)
operator|&
literal|0140
operator|)
condition|)
name|bttyout
argument_list|(
name|c
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|eflag
operator|>
literal|1
condition|)
name|bttyout
argument_list|(
name|c
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|UNIX
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
endif|#
directive|endif
goto|goto
name|startover
goto|;
case|case
name|ZPAD
operator||
literal|0200
case|:
comment|/* This is what we want. */
name|Not8bit
operator|=
name|c
expr_stmt|;
case|case
name|ZPAD
case|:
comment|/* This is what we want. */
break|break;
block|}
name|cancount
operator|=
literal|5
expr_stmt|;
name|splat
label|:
switch|switch
condition|(
name|c
operator|=
name|noxrd7
argument_list|()
condition|)
block|{
case|case
name|ZPAD
case|:
goto|goto
name|splat
goto|;
case|case
name|RCDO
case|:
case|case
name|TIMEOUT
case|:
goto|goto
name|fifi
goto|;
default|default:
goto|goto
name|agn2
goto|;
case|case
name|ZDLE
case|:
comment|/* This is what we want. */
break|break;
block|}
name|Rxhlen
operator|=
literal|4
expr_stmt|;
comment|/* Set default length */
name|Rxframeind
operator|=
name|c
operator|=
name|noxrd7
argument_list|()
expr_stmt|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
name|ZVBIN32
case|:
if|if
condition|(
operator|(
name|Rxhlen
operator|=
name|c
operator|=
name|readline
argument_list|(
name|Rxtimeout
argument_list|)
operator|)
operator|<
literal|0
condition|)
goto|goto
name|fifi
goto|;
if|if
condition|(
name|c
operator|>
name|ZMAXHLEN
condition|)
goto|goto
name|agn2
goto|;
name|Crc32r
operator|=
literal|1
expr_stmt|;
name|c
operator|=
name|zrbhd32
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZBIN32
case|:
if|if
condition|(
name|Usevhdrs
condition|)
goto|goto
name|agn2
goto|;
name|Crc32r
operator|=
literal|1
expr_stmt|;
name|c
operator|=
name|zrbhd32
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZVBINR32
case|:
if|if
condition|(
operator|(
name|Rxhlen
operator|=
name|c
operator|=
name|readline
argument_list|(
name|Rxtimeout
argument_list|)
operator|)
operator|<
literal|0
condition|)
goto|goto
name|fifi
goto|;
if|if
condition|(
name|c
operator|>
name|ZMAXHLEN
condition|)
goto|goto
name|agn2
goto|;
name|Crc32r
operator|=
literal|2
expr_stmt|;
name|c
operator|=
name|zrbhd32
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZBINR32
case|:
if|if
condition|(
name|Usevhdrs
condition|)
goto|goto
name|agn2
goto|;
name|Crc32r
operator|=
literal|2
expr_stmt|;
name|c
operator|=
name|zrbhd32
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
break|break;
case|case
name|RCDO
case|:
case|case
name|TIMEOUT
case|:
goto|goto
name|fifi
goto|;
case|case
name|ZVBIN
case|:
if|if
condition|(
operator|(
name|Rxhlen
operator|=
name|c
operator|=
name|readline
argument_list|(
name|Rxtimeout
argument_list|)
operator|)
operator|<
literal|0
condition|)
goto|goto
name|fifi
goto|;
if|if
condition|(
name|c
operator|>
name|ZMAXHLEN
condition|)
goto|goto
name|agn2
goto|;
name|Crc32r
operator|=
literal|0
expr_stmt|;
name|c
operator|=
name|zrbhdr
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZBIN
case|:
if|if
condition|(
name|Usevhdrs
condition|)
goto|goto
name|agn2
goto|;
name|Crc32r
operator|=
literal|0
expr_stmt|;
name|c
operator|=
name|zrbhdr
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZVHEX
case|:
if|if
condition|(
operator|(
name|Rxhlen
operator|=
name|c
operator|=
name|zgethex
argument_list|()
operator|)
operator|<
literal|0
condition|)
goto|goto
name|fifi
goto|;
if|if
condition|(
name|c
operator|>
name|ZMAXHLEN
condition|)
goto|goto
name|agn2
goto|;
name|Crc32r
operator|=
literal|0
expr_stmt|;
name|c
operator|=
name|zrhhdr
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
break|break;
case|case
name|ZHEX
case|:
if|if
condition|(
name|Usevhdrs
condition|)
goto|goto
name|agn2
goto|;
name|Crc32r
operator|=
literal|0
expr_stmt|;
name|c
operator|=
name|zrhhdr
argument_list|(
name|hdr
argument_list|)
expr_stmt|;
break|break;
case|case
name|CAN
case|:
goto|goto
name|gotcan
goto|;
default|default:
goto|goto
name|agn2
goto|;
block|}
name|Rxpos
operator|=
name|hdr
index|[
name|ZP3
index|]
operator|&
literal|0377
expr_stmt|;
name|Rxpos
operator|=
operator|(
name|Rxpos
operator|<<
literal|8
operator|)
operator|+
operator|(
name|hdr
index|[
name|ZP2
index|]
operator|&
literal|0377
operator|)
expr_stmt|;
name|Rxpos
operator|=
operator|(
name|Rxpos
operator|<<
literal|8
operator|)
operator|+
operator|(
name|hdr
index|[
name|ZP1
index|]
operator|&
literal|0377
operator|)
expr_stmt|;
name|Rxpos
operator|=
operator|(
name|Rxpos
operator|<<
literal|8
operator|)
operator|+
operator|(
name|hdr
index|[
name|ZP0
index|]
operator|&
literal|0377
operator|)
expr_stmt|;
name|fifi
label|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
name|GOTCAN
case|:
name|c
operator|=
name|ZCAN
expr_stmt|;
comment|/* **** FALL THRU TO **** */
case|case
name|ZNAK
case|:
case|case
name|ZCAN
case|:
case|case
name|ERROR
case|:
case|case
name|TIMEOUT
case|:
case|case
name|RCDO
case|:
case|case
name|GCOUNT
case|:
name|zperr
argument_list|(
literal|"Got %s"
argument_list|,
name|frametypes
index|[
name|c
operator|+
name|FTOFFSET
index|]
argument_list|)
expr_stmt|;
comment|/* **** FALL THRU TO **** */
ifndef|#
directive|ifndef
name|DSZ
default|default:
if|if
condition|(
name|c
operator|>=
operator|-
literal|4
operator|&&
name|c
operator|<=
name|FRTYPES
condition|)
name|vfile
argument_list|(
literal|"zgethdr: %c %d %s %lx"
argument_list|,
name|Rxframeind
argument_list|,
name|Rxhlen
argument_list|,
name|frametypes
index|[
name|c
operator|+
name|FTOFFSET
index|]
argument_list|,
name|Rxpos
argument_list|)
expr_stmt|;
else|else
name|vfile
argument_list|(
literal|"zgethdr: %d %lx"
argument_list|,
name|c
argument_list|,
name|Rxpos
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
comment|/* Use variable length headers if we got one */
if|if
condition|(
name|c
operator|>=
literal|0
operator|&&
name|c
operator|<=
name|FRTYPES
operator|&&
name|Rxframeind
operator|&
literal|040
condition|)
name|Usevhdrs
operator|=
literal|1
expr_stmt|;
return|return
name|c
return|;
block|}
end_block

begin_comment
comment|/* Receive a binary style header (type and position) */
end_comment

begin_expr_stmt
name|zrbhdr
argument_list|(
name|hdr
argument_list|)
specifier|register
name|char
operator|*
name|hdr
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|n
decl_stmt|;
specifier|register
name|unsigned
name|short
name|crc
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
return|return
name|c
return|;
name|Rxtype
operator|=
name|c
expr_stmt|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|Rxhlen
init|;
operator|--
name|n
operator|>=
literal|0
condition|;
operator|++
name|hdr
control|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
return|return
name|c
return|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
operator|*
name|hdr
operator|=
name|c
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
return|return
name|c
return|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
return|return
name|c
return|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
name|crc
operator|&
literal|0xFFFF
condition|)
block|{
name|zperr
argument_list|(
name|badcrc
argument_list|)
expr_stmt|;
return|return
name|ERROR
return|;
block|}
ifdef|#
directive|ifdef
name|ZMODEM
name|Protocol
operator|=
name|ZMODEM
expr_stmt|;
endif|#
directive|endif
name|Zmodem
operator|=
literal|1
expr_stmt|;
return|return
name|Rxtype
return|;
block|}
end_block

begin_comment
comment|/* Receive a binary style header (type and position) with 32 bit FCS */
end_comment

begin_expr_stmt
name|zrbhd32
argument_list|(
name|hdr
argument_list|)
specifier|register
name|char
operator|*
name|hdr
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|n
decl_stmt|;
specifier|register
name|UNSL
name|long
name|crc
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
return|return
name|c
return|;
name|Rxtype
operator|=
name|c
expr_stmt|;
name|crc
operator|=
literal|0xFFFFFFFFL
expr_stmt|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUGZ
name|vfile
argument_list|(
literal|"zrbhd32 c=%X  crc=%lX"
argument_list|,
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
endif|#
directive|endif
for|for
control|(
name|n
operator|=
name|Rxhlen
init|;
operator|--
name|n
operator|>=
literal|0
condition|;
operator|++
name|hdr
control|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
return|return
name|c
return|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
operator|*
name|hdr
operator|=
name|c
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUGZ
name|vfile
argument_list|(
literal|"zrbhd32 c=%X  crc=%lX"
argument_list|,
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
for|for
control|(
name|n
operator|=
literal|4
init|;
operator|--
name|n
operator|>=
literal|0
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|zdlread
argument_list|()
operator|)
operator|&
operator|~
literal|0377
condition|)
return|return
name|c
return|;
name|crc
operator|=
name|UPDC32
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUGZ
name|vfile
argument_list|(
literal|"zrbhd32 c=%X  crc=%lX"
argument_list|,
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
if|if
condition|(
name|crc
operator|!=
literal|0xDEBB20E3
condition|)
block|{
name|zperr
argument_list|(
name|badcrc
argument_list|)
expr_stmt|;
return|return
name|ERROR
return|;
block|}
ifdef|#
directive|ifdef
name|ZMODEM
name|Protocol
operator|=
name|ZMODEM
expr_stmt|;
endif|#
directive|endif
name|Zmodem
operator|=
literal|1
expr_stmt|;
return|return
name|Rxtype
return|;
block|}
end_block

begin_comment
comment|/* Receive a hex style header (type and position) */
end_comment

begin_macro
name|zrhhdr
argument_list|(
argument|hdr
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|hdr
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
specifier|register
name|unsigned
name|short
name|crc
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zgethex
argument_list|()
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
name|Rxtype
operator|=
name|c
expr_stmt|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|Rxhlen
init|;
operator|--
name|n
operator|>=
literal|0
condition|;
operator|++
name|hdr
control|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|zgethex
argument_list|()
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
operator|*
name|hdr
operator|=
name|c
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|c
operator|=
name|zgethex
argument_list|()
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|zgethex
argument_list|()
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
name|crc
operator|=
name|updcrc
argument_list|(
name|c
argument_list|,
name|crc
argument_list|)
expr_stmt|;
if|if
condition|(
name|crc
operator|&
literal|0xFFFF
condition|)
block|{
name|zperr
argument_list|(
name|badcrc
argument_list|)
expr_stmt|;
return|return
name|ERROR
return|;
block|}
switch|switch
condition|(
name|c
operator|=
name|readline
argument_list|(
literal|1
argument_list|)
condition|)
block|{
case|case
literal|0215
case|:
name|Not8bit
operator|=
name|c
expr_stmt|;
comment|/* **** FALL THRU TO **** */
case|case
literal|015
case|:
comment|/* Throw away possible cr/lf */
switch|switch
condition|(
name|c
operator|=
name|readline
argument_list|(
literal|1
argument_list|)
condition|)
block|{
case|case
literal|012
case|:
name|Not8bit
operator||=
name|c
expr_stmt|;
block|}
block|}
ifdef|#
directive|ifdef
name|ZMODEM
name|Protocol
operator|=
name|ZMODEM
expr_stmt|;
endif|#
directive|endif
name|Zmodem
operator|=
literal|1
expr_stmt|;
return|return
name|Rxtype
return|;
block|}
end_block

begin_comment
comment|/* Send a byte as two hex digits */
end_comment

begin_expr_stmt
name|zputhex
argument_list|(
name|c
argument_list|)
specifier|register
name|int
name|c
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|static
name|char
name|digits
index|[]
init|=
literal|"0123456789abcdef"
decl_stmt|;
ifdef|#
directive|ifdef
name|DEBUGZ
if|if
condition|(
name|Verbose
operator|>
literal|8
condition|)
name|vfile
argument_list|(
literal|"zputhex: %02X"
argument_list|,
name|c
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|sendline
argument_list|(
name|digits
index|[
operator|(
name|c
operator|&
literal|0xF0
operator|)
operator|>>
literal|4
index|]
argument_list|)
expr_stmt|;
name|sendline
argument_list|(
name|digits
index|[
operator|(
name|c
operator|)
operator|&
literal|0xF
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Send character c with ZMODEM escape sequence encoding.  *  Escape XON, XOFF. Escape CR following @ (Telenet net escape)  */
end_comment

begin_macro
name|zsendline
argument_list|(
argument|c
argument_list|)
end_macro

begin_block
block|{
comment|/* Quick check for non control characters */
if|if
condition|(
name|c
operator|&
literal|0140
condition|)
name|xsendline
argument_list|(
name|lastsent
operator|=
name|c
argument_list|)
expr_stmt|;
else|else
block|{
switch|switch
condition|(
name|c
operator|&=
literal|0377
condition|)
block|{
case|case
name|ZDLE
case|:
name|xsendline
argument_list|(
name|ZDLE
argument_list|)
expr_stmt|;
name|xsendline
argument_list|(
name|lastsent
operator|=
operator|(
name|c
operator|^=
literal|0100
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|015
case|:
case|case
literal|0215
case|:
if|if
condition|(
operator|!
name|Zctlesc
operator|&&
operator|(
name|lastsent
operator|&
literal|0177
operator|)
operator|!=
literal|'@'
condition|)
goto|goto
name|sendit
goto|;
comment|/* **** FALL THRU TO **** */
case|case
literal|020
case|:
case|case
literal|021
case|:
case|case
literal|023
case|:
case|case
literal|0220
case|:
case|case
literal|0221
case|:
case|case
literal|0223
case|:
name|xsendline
argument_list|(
name|ZDLE
argument_list|)
expr_stmt|;
name|c
operator|^=
literal|0100
expr_stmt|;
name|sendit
label|:
name|xsendline
argument_list|(
name|lastsent
operator|=
name|c
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|Zctlesc
operator|&&
operator|!
operator|(
name|c
operator|&
literal|0140
operator|)
condition|)
block|{
name|xsendline
argument_list|(
name|ZDLE
argument_list|)
expr_stmt|;
name|c
operator|^=
literal|0100
expr_stmt|;
block|}
name|xsendline
argument_list|(
name|lastsent
operator|=
name|c
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_block

begin_comment
comment|/* Decode two lower case hex digits into an 8 bit byte value */
end_comment

begin_macro
name|zgethex
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
name|c
operator|=
name|zgeth1
argument_list|()
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUGZ
if|if
condition|(
name|Verbose
operator|>
literal|8
condition|)
name|vfile
argument_list|(
literal|"zgethex: %02X"
argument_list|,
name|c
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|c
return|;
block|}
end_block

begin_macro
name|zgeth1
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|n
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|noxrd7
argument_list|()
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
name|n
operator|=
name|c
operator|-
literal|'0'
expr_stmt|;
if|if
condition|(
name|n
operator|>
literal|9
condition|)
name|n
operator|-=
operator|(
literal|'a'
operator|-
literal|':'
operator|)
expr_stmt|;
if|if
condition|(
name|n
operator|&
operator|~
literal|0xF
condition|)
return|return
name|ERROR
return|;
if|if
condition|(
operator|(
name|c
operator|=
name|noxrd7
argument_list|()
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
name|c
operator|-=
literal|'0'
expr_stmt|;
if|if
condition|(
name|c
operator|>
literal|9
condition|)
name|c
operator|-=
operator|(
literal|'a'
operator|-
literal|':'
operator|)
expr_stmt|;
if|if
condition|(
name|c
operator|&
operator|~
literal|0xF
condition|)
return|return
name|ERROR
return|;
name|c
operator|+=
operator|(
name|n
operator|<<
literal|4
operator|)
expr_stmt|;
return|return
name|c
return|;
block|}
end_block

begin_comment
comment|/*  * Read a byte, checking for ZMODEM escape encoding  *  including CAN*5 which represents a quick abort  */
end_comment

begin_macro
name|zdlread
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
name|again
label|:
comment|/* Quick check for non control characters */
if|if
condition|(
operator|(
name|c
operator|=
name|readline
argument_list|(
name|Rxtimeout
argument_list|)
operator|)
operator|&
literal|0140
condition|)
return|return
name|c
return|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
name|ZDLE
case|:
break|break;
case|case
literal|023
case|:
case|case
literal|0223
case|:
case|case
literal|021
case|:
case|case
literal|0221
case|:
goto|goto
name|again
goto|;
default|default:
if|if
condition|(
name|Zctlesc
operator|&&
operator|!
operator|(
name|c
operator|&
literal|0140
operator|)
condition|)
block|{
goto|goto
name|again
goto|;
block|}
return|return
name|c
return|;
block|}
name|again2
label|:
if|if
condition|(
operator|(
name|c
operator|=
name|readline
argument_list|(
name|Rxtimeout
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
if|if
condition|(
name|c
operator|==
name|CAN
operator|&&
operator|(
name|c
operator|=
name|readline
argument_list|(
name|Rxtimeout
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
if|if
condition|(
name|c
operator|==
name|CAN
operator|&&
operator|(
name|c
operator|=
name|readline
argument_list|(
name|Rxtimeout
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
if|if
condition|(
name|c
operator|==
name|CAN
operator|&&
operator|(
name|c
operator|=
name|readline
argument_list|(
name|Rxtimeout
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
switch|switch
condition|(
name|c
condition|)
block|{
case|case
name|CAN
case|:
return|return
name|GOTCAN
return|;
case|case
name|ZCRCE
case|:
case|case
name|ZCRCG
case|:
case|case
name|ZCRCQ
case|:
case|case
name|ZCRCW
case|:
return|return
operator|(
name|c
operator||
name|GOTOR
operator|)
return|;
case|case
name|ZRUB0
case|:
return|return
literal|0177
return|;
case|case
name|ZRUB1
case|:
return|return
literal|0377
return|;
case|case
literal|023
case|:
case|case
literal|0223
case|:
case|case
literal|021
case|:
case|case
literal|0221
case|:
goto|goto
name|again2
goto|;
default|default:
if|if
condition|(
name|Zctlesc
operator|&&
operator|!
operator|(
name|c
operator|&
literal|0140
operator|)
condition|)
block|{
goto|goto
name|again2
goto|;
block|}
if|if
condition|(
operator|(
name|c
operator|&
literal|0140
operator|)
operator|==
literal|0100
condition|)
return|return
operator|(
name|c
operator|^
literal|0100
operator|)
return|;
break|break;
block|}
if|if
condition|(
name|Verbose
operator|>
literal|1
condition|)
name|zperr
argument_list|(
literal|"Bad escape sequence %x"
argument_list|,
name|c
argument_list|)
expr_stmt|;
return|return
name|ERROR
return|;
block|}
end_block

begin_comment
comment|/*  * Read a character from the modem line with timeout.  *  Eat parity, XON and XOFF characters.  */
end_comment

begin_macro
name|noxrd7
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|c
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|c
operator|=
name|readline
argument_list|(
name|Rxtimeout
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|c
return|;
switch|switch
condition|(
name|c
operator|&=
literal|0177
condition|)
block|{
case|case
name|XON
case|:
case|case
name|XOFF
case|:
continue|continue;
default|default:
if|if
condition|(
name|Zctlesc
operator|&&
operator|!
operator|(
name|c
operator|&
literal|0140
operator|)
condition|)
continue|continue;
case|case
literal|'\r'
case|:
case|case
literal|'\n'
case|:
case|case
name|ZDLE
case|:
return|return
name|c
return|;
block|}
block|}
block|}
end_block

begin_comment
comment|/* Store long integer pos in Txhdr */
end_comment

begin_macro
name|stohdr
argument_list|(
argument|pos
argument_list|)
end_macro

begin_decl_stmt
name|long
name|pos
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|Txhdr
index|[
name|ZP0
index|]
operator|=
name|pos
expr_stmt|;
name|Txhdr
index|[
name|ZP1
index|]
operator|=
name|pos
operator|>>
literal|8
expr_stmt|;
name|Txhdr
index|[
name|ZP2
index|]
operator|=
name|pos
operator|>>
literal|16
expr_stmt|;
name|Txhdr
index|[
name|ZP3
index|]
operator|=
name|pos
operator|>>
literal|24
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Recover a long integer from a header */
end_comment

begin_function
name|long
name|rclhdr
parameter_list|(
name|hdr
parameter_list|)
specifier|register
name|char
modifier|*
name|hdr
decl_stmt|;
block|{
specifier|register
name|long
name|l
decl_stmt|;
name|l
operator|=
operator|(
name|hdr
index|[
name|ZP3
index|]
operator|&
literal|0377
operator|)
expr_stmt|;
name|l
operator|=
operator|(
name|l
operator|<<
literal|8
operator|)
operator||
operator|(
name|hdr
index|[
name|ZP2
index|]
operator|&
literal|0377
operator|)
expr_stmt|;
name|l
operator|=
operator|(
name|l
operator|<<
literal|8
operator|)
operator||
operator|(
name|hdr
index|[
name|ZP1
index|]
operator|&
literal|0377
operator|)
expr_stmt|;
name|l
operator|=
operator|(
name|l
operator|<<
literal|8
operator|)
operator||
operator|(
name|hdr
index|[
name|ZP0
index|]
operator|&
literal|0377
operator|)
expr_stmt|;
return|return
name|l
return|;
block|}
end_function

begin_comment
comment|/* End of zm.c */
end_comment

end_unit


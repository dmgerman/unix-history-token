begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, Brian Berliner and Jeff Polk  * Copyright (c) 1989-1992, Brian Berliner  *   * You may distribute under the terms of the GNU General Public License as  * specified in the README file that comes with the CVS 1.3 kit.  *   * Create Administration.  *   * Creates a CVS administration directory based on the argument repository; the  * "Entries" file is prefilled from the "initrecord" argument.  */
end_comment

begin_include
include|#
directive|include
file|"cvs.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"@(#)create_adm.c 1.24 92/03/31"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|void
name|Create_Admin
parameter_list|(
name|dir
parameter_list|,
name|repository
parameter_list|,
name|tag
parameter_list|,
name|date
parameter_list|)
name|char
modifier|*
name|dir
decl_stmt|;
name|char
modifier|*
name|repository
decl_stmt|;
name|char
modifier|*
name|tag
decl_stmt|;
name|char
modifier|*
name|date
decl_stmt|;
block|{
name|FILE
modifier|*
name|fout
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|char
name|tmp
index|[
name|PATH_MAX
index|]
decl_stmt|;
if|if
condition|(
name|noexec
condition|)
return|return;
if|if
condition|(
operator|!
name|isdir
argument_list|(
name|repository
argument_list|)
condition|)
name|error
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|"there is no repository %s"
argument_list|,
name|repository
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%s/%s"
argument_list|,
name|dir
argument_list|,
name|CVSADM
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|CVSADM
argument_list|)
expr_stmt|;
if|if
condition|(
name|isfile
argument_list|(
name|tmp
argument_list|)
condition|)
name|error
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|"there is a version here already"
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|dir
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%s/%s"
argument_list|,
name|dir
argument_list|,
name|OCVSADM
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|OCVSADM
argument_list|)
expr_stmt|;
if|if
condition|(
name|isfile
argument_list|(
name|tmp
argument_list|)
condition|)
name|error
argument_list|(
literal|1
argument_list|,
literal|0
argument_list|,
literal|"there is a version here already"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dir
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%s/%s"
argument_list|,
name|dir
argument_list|,
name|CVSADM
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|CVSADM
argument_list|)
expr_stmt|;
name|make_directory
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%s/%s"
argument_list|,
name|dir
argument_list|,
name|CVSADM_REP
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|CVSADM_REP
argument_list|)
expr_stmt|;
name|fout
operator|=
name|open_file
argument_list|(
name|tmp
argument_list|,
literal|"w+"
argument_list|)
expr_stmt|;
name|cp
operator|=
name|repository
expr_stmt|;
name|strip_path
argument_list|(
name|cp
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|RELATIVE_REPOS
comment|/*      * If the Repository file is to hold a relative path, try to strip off      * the leading CVSroot argument.      */
if|if
condition|(
name|CVSroot
operator|!=
name|NULL
condition|)
block|{
name|char
name|path
index|[
name|PATH_MAX
index|]
decl_stmt|;
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|path
argument_list|,
literal|"%s/"
argument_list|,
name|CVSroot
argument_list|)
expr_stmt|;
if|if
condition|(
name|strncmp
argument_list|(
name|repository
argument_list|,
name|path
argument_list|,
name|strlen
argument_list|(
name|path
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
name|cp
operator|=
name|repository
operator|+
name|strlen
argument_list|(
name|path
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
name|fprintf
argument_list|(
name|fout
argument_list|,
literal|"%s\n"
argument_list|,
name|cp
argument_list|)
operator|==
name|EOF
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"write to %s failed"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
if|if
condition|(
name|fclose
argument_list|(
name|fout
argument_list|)
operator|==
name|EOF
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot close %s"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* now, do the Entries file */
if|if
condition|(
name|dir
operator|!=
name|NULL
condition|)
operator|(
name|void
operator|)
name|sprintf
argument_list|(
name|tmp
argument_list|,
literal|"%s/%s"
argument_list|,
name|dir
argument_list|,
name|CVSADM_ENT
argument_list|)
expr_stmt|;
else|else
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|tmp
argument_list|,
name|CVSADM_ENT
argument_list|)
expr_stmt|;
name|fout
operator|=
name|open_file
argument_list|(
name|tmp
argument_list|,
literal|"w+"
argument_list|)
expr_stmt|;
if|if
condition|(
name|fclose
argument_list|(
name|fout
argument_list|)
operator|==
name|EOF
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot close %s"
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
comment|/* Create a new CVS/Tag file */
name|WriteTag
argument_list|(
name|dir
argument_list|,
name|tag
argument_list|,
name|date
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


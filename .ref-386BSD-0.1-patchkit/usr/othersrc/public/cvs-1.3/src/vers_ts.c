begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1992, Brian Berliner and Jeff Polk  * Copyright (c) 1989-1992, Brian Berliner  *   * You may distribute under the terms of the GNU General Public License as  * specified in the README file that comes with the CVS 1.3 kit.  */
end_comment

begin_include
include|#
directive|include
file|"cvs.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|rcsid
index|[]
init|=
literal|"@(#)vers_ts.c 1.36 92/03/31"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_function_decl
specifier|extern
name|char
modifier|*
name|ctime
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* XXX - should use gmtime/asctime */
end_comment

begin_comment
comment|/*  * Fill in and return a Vers_TS structure "user" is the name of the local  * file; entries is the entries file - preparsed for our pleasure. xfiles is  * all source code control files, preparsed for our pleasure  */
end_comment

begin_function
name|Vers_TS
modifier|*
name|Version_TS
parameter_list|(
name|repository
parameter_list|,
name|options
parameter_list|,
name|tag
parameter_list|,
name|date
parameter_list|,
name|user
parameter_list|,
name|force_tag_match
parameter_list|,
name|set_time
parameter_list|,
name|entries
parameter_list|,
name|xfiles
parameter_list|)
name|char
modifier|*
name|repository
decl_stmt|;
name|char
modifier|*
name|options
decl_stmt|;
name|char
modifier|*
name|tag
decl_stmt|;
name|char
modifier|*
name|date
decl_stmt|;
name|char
modifier|*
name|user
decl_stmt|;
name|int
name|force_tag_match
decl_stmt|;
name|int
name|set_time
decl_stmt|;
name|List
modifier|*
name|entries
decl_stmt|;
name|List
modifier|*
name|xfiles
decl_stmt|;
block|{
name|Node
modifier|*
name|p
decl_stmt|;
name|RCSNode
modifier|*
name|rcsdata
decl_stmt|;
name|Vers_TS
modifier|*
name|vers_ts
decl_stmt|;
name|struct
name|stickydirtag
modifier|*
name|sdtp
decl_stmt|;
comment|/* get a new Vers_TS struct */
name|vers_ts
operator|=
operator|(
name|Vers_TS
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|Vers_TS
argument_list|)
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|vers_ts
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|vers_ts
argument_list|)
argument_list|)
expr_stmt|;
comment|/*      * look up the entries file entry and fill in the version and timestamp      * if entries is NULL, there is no entries file so don't bother trying to      * look it up (used by checkout -P)      */
if|if
condition|(
name|entries
operator|==
name|NULL
condition|)
block|{
name|sdtp
operator|=
name|NULL
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|p
operator|=
name|findnode
argument_list|(
name|entries
argument_list|,
name|user
argument_list|)
expr_stmt|;
name|sdtp
operator|=
operator|(
expr|struct
name|stickydirtag
operator|*
operator|)
name|entries
operator|->
name|list
operator|->
name|data
expr_stmt|;
comment|/* list-private */
block|}
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|Entnode
modifier|*
name|entdata
init|=
operator|(
name|Entnode
operator|*
operator|)
name|p
operator|->
name|data
decl_stmt|;
name|vers_ts
operator|->
name|vn_user
operator|=
name|xstrdup
argument_list|(
name|entdata
operator|->
name|version
argument_list|)
expr_stmt|;
name|vers_ts
operator|->
name|ts_rcs
operator|=
name|xstrdup
argument_list|(
name|entdata
operator|->
name|timestamp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tag
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|sdtp
operator|&&
name|sdtp
operator|->
name|aflag
operator|)
condition|)
name|vers_ts
operator|->
name|tag
operator|=
name|xstrdup
argument_list|(
name|entdata
operator|->
name|tag
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|date
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|sdtp
operator|&&
name|sdtp
operator|->
name|aflag
operator|)
condition|)
name|vers_ts
operator|->
name|date
operator|=
name|xstrdup
argument_list|(
name|entdata
operator|->
name|date
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|options
operator|||
operator|(
name|options
operator|&&
operator|*
name|options
operator|==
literal|'\0'
operator|)
condition|)
block|{
if|if
condition|(
operator|!
operator|(
name|sdtp
operator|&&
name|sdtp
operator|->
name|aflag
operator|)
condition|)
name|vers_ts
operator|->
name|options
operator|=
name|xstrdup
argument_list|(
name|entdata
operator|->
name|options
argument_list|)
expr_stmt|;
block|}
name|vers_ts
operator|->
name|entdata
operator|=
name|entdata
expr_stmt|;
block|}
comment|/*      * -k options specified on the command line override (and overwrite)      * options stored in the entries file      */
if|if
condition|(
name|options
condition|)
name|vers_ts
operator|->
name|options
operator|=
name|xstrdup
argument_list|(
name|options
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|sdtp
operator|&&
name|sdtp
operator|->
name|aflag
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|vers_ts
operator|->
name|options
condition|)
name|vers_ts
operator|->
name|options
operator|=
name|xstrdup
argument_list|(
name|sdtp
operator|->
name|options
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|vers_ts
operator|->
name|options
condition|)
name|vers_ts
operator|->
name|options
operator|=
name|xstrdup
argument_list|(
literal|""
argument_list|)
expr_stmt|;
comment|/*      * if tags were specified on the command line, they override what is in      * the Entries file      */
if|if
condition|(
name|tag
operator|||
name|date
condition|)
block|{
name|vers_ts
operator|->
name|tag
operator|=
name|xstrdup
argument_list|(
name|tag
argument_list|)
expr_stmt|;
name|vers_ts
operator|->
name|date
operator|=
name|xstrdup
argument_list|(
name|date
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|vers_ts
operator|->
name|entdata
operator|&&
operator|(
name|sdtp
operator|&&
name|sdtp
operator|->
name|aflag
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
operator|!
name|vers_ts
operator|->
name|tag
condition|)
name|vers_ts
operator|->
name|tag
operator|=
name|xstrdup
argument_list|(
name|sdtp
operator|->
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|vers_ts
operator|->
name|date
condition|)
name|vers_ts
operator|->
name|date
operator|=
name|xstrdup
argument_list|(
name|sdtp
operator|->
name|date
argument_list|)
expr_stmt|;
block|}
comment|/* Now look up the info on the source controlled file */
if|if
condition|(
name|xfiles
operator|!=
operator|(
name|List
operator|*
operator|)
name|NULL
condition|)
block|{
name|p
operator|=
name|findnode
argument_list|(
name|xfiles
argument_list|,
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|!=
name|NULL
condition|)
block|{
name|rcsdata
operator|=
operator|(
name|RCSNode
operator|*
operator|)
name|p
operator|->
name|data
expr_stmt|;
name|rcsdata
operator|->
name|refcount
operator|++
expr_stmt|;
block|}
else|else
name|rcsdata
operator|=
name|NULL
expr_stmt|;
block|}
else|else
name|rcsdata
operator|=
name|RCS_parse
argument_list|(
name|user
argument_list|,
name|repository
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcsdata
operator|!=
name|NULL
condition|)
block|{
comment|/* squirrel away the rcsdata pointer for others */
name|vers_ts
operator|->
name|srcfile
operator|=
name|rcsdata
expr_stmt|;
comment|/* get RCS version number into vn_rcs (if appropriate) */
if|if
condition|(
operator|(
operator|(
name|vers_ts
operator|->
name|tag
operator|||
name|vers_ts
operator|->
name|date
operator|)
operator|&&
name|force_tag_match
operator|)
operator|||
operator|(
operator|(
name|rcsdata
operator|->
name|flags
operator|&
name|VALID
operator|)
operator|&&
operator|(
name|rcsdata
operator|->
name|flags
operator|&
name|INATTIC
operator|)
operator|==
literal|0
operator|)
condition|)
block|{
if|if
condition|(
name|vers_ts
operator|->
name|tag
operator|&&
name|strcmp
argument_list|(
name|vers_ts
operator|->
name|tag
argument_list|,
name|TAG_BASE
argument_list|)
operator|==
literal|0
condition|)
name|vers_ts
operator|->
name|vn_rcs
operator|=
name|xstrdup
argument_list|(
name|vers_ts
operator|->
name|vn_user
argument_list|)
expr_stmt|;
else|else
name|vers_ts
operator|->
name|vn_rcs
operator|=
name|RCS_getversion
argument_list|(
name|rcsdata
argument_list|,
name|vers_ts
operator|->
name|tag
argument_list|,
name|vers_ts
operator|->
name|date
argument_list|,
name|force_tag_match
argument_list|)
expr_stmt|;
block|}
comment|/* 	 * If the source control file exists and has the requested revision, 	 * get the Date the revision was checked in.  If "user" exists, set 	 * its mtime. 	 */
if|if
condition|(
name|set_time
condition|)
block|{
name|struct
name|utimbuf
name|t
decl_stmt|;
if|if
condition|(
name|vers_ts
operator|->
name|vn_rcs
operator|&&
operator|(
name|t
operator|.
name|actime
operator|=
name|t
operator|.
name|modtime
operator|=
name|RCS_getrevtime
argument_list|(
name|rcsdata
argument_list|,
name|vers_ts
operator|->
name|vn_rcs
argument_list|,
operator|(
name|char
operator|*
operator|)
literal|0
argument_list|,
literal|0
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
operator|(
name|void
operator|)
name|utime
argument_list|(
name|user
argument_list|,
operator|&
name|t
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* get user file time-stamp in ts_user */
if|if
condition|(
name|entries
operator|!=
operator|(
name|List
operator|*
operator|)
name|NULL
condition|)
name|vers_ts
operator|->
name|ts_user
operator|=
name|time_stamp
argument_list|(
name|user
argument_list|)
expr_stmt|;
return|return
operator|(
name|vers_ts
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * Gets the time-stamp for the file "file" and returns it in space it  * allocates  */
end_comment

begin_function
name|char
modifier|*
name|time_stamp
parameter_list|(
name|file
parameter_list|)
name|char
modifier|*
name|file
decl_stmt|;
block|{
name|struct
name|stat
name|sb
decl_stmt|;
name|char
modifier|*
name|cp
decl_stmt|;
name|char
modifier|*
name|ts
decl_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|file
argument_list|,
operator|&
name|sb
argument_list|)
operator|<
literal|0
condition|)
block|{
name|ts
operator|=
name|NULL
expr_stmt|;
block|}
else|else
block|{
name|ts
operator|=
name|xmalloc
argument_list|(
literal|51
argument_list|)
expr_stmt|;
comment|/* 51 = 2 ctime strings + NULL */
name|cp
operator|=
name|ctime
argument_list|(
operator|&
name|sb
operator|.
name|st_ctime
argument_list|)
expr_stmt|;
comment|/* copy in the create time */
name|cp
index|[
literal|24
index|]
operator|=
literal|' '
expr_stmt|;
operator|(
name|void
operator|)
name|strcpy
argument_list|(
name|ts
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ctime
argument_list|(
operator|&
name|sb
operator|.
name|st_mtime
argument_list|)
expr_stmt|;
comment|/* copy in the modify time */
name|cp
index|[
literal|24
index|]
operator|=
literal|'\0'
expr_stmt|;
operator|(
name|void
operator|)
name|strcat
argument_list|(
name|ts
argument_list|,
name|cp
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ts
operator|)
return|;
block|}
end_function

begin_comment
comment|/*  * free up a Vers_TS struct  */
end_comment

begin_function
name|void
name|freevers_ts
parameter_list|(
name|versp
parameter_list|)
name|Vers_TS
modifier|*
modifier|*
name|versp
decl_stmt|;
block|{
if|if
condition|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|srcfile
condition|)
name|freercsnode
argument_list|(
operator|&
operator|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|srcfile
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|vn_user
condition|)
name|free
argument_list|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|vn_user
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|vn_rcs
condition|)
name|free
argument_list|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|vn_rcs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|ts_user
condition|)
name|free
argument_list|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|ts_user
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|ts_rcs
condition|)
name|free
argument_list|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|ts_rcs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|options
condition|)
name|free
argument_list|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|options
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|tag
condition|)
name|free
argument_list|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|tag
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|date
condition|)
name|free
argument_list|(
operator|(
operator|*
name|versp
operator|)
operator|->
name|date
argument_list|)
expr_stmt|;
name|free
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|*
name|versp
argument_list|)
expr_stmt|;
operator|*
name|versp
operator|=
operator|(
name|Vers_TS
operator|*
operator|)
name|NULL
expr_stmt|;
block|}
end_function

end_unit


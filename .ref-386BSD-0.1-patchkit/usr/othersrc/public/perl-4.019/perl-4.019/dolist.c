begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* $RCSfile: dolist.c,v $$Revision: 4.0.1.4 $$Date: 91/11/11 16:33:19 $  *  *    Copyright (c) 1991, Larry Wall  *  *    You may distribute under the terms of either the GNU General Public  *    License or the Artistic License, as specified in the README file.  *  * $Log:	dolist.c,v $  * Revision 4.0.1.4  91/11/11  16:33:19  lwall  * patch19: added little-endian pack/unpack options  * patch19: sort $subname was busted by changes in 4.018  *   * Revision 4.0.1.3  91/11/05  17:07:02  lwall  * patch11: prepared for ctype implementations that don't define isascii()  * patch11: /$foo/o optimizer could access deallocated data  * patch11: certain optimizations of //g in array context returned too many values  * patch11: regexp with no parens in array context returned wacky $`, $& and $'  * patch11: $' not set right on some //g  * patch11: added some support for 64-bit integers  * patch11: grep of a split lost its values  * patch11: added sort {} LIST  * patch11: multiple reallocations now avoided in 1 .. 100000  *   * Revision 4.0.1.2  91/06/10  01:22:15  lwall  * patch10: //g only worked first time through  *   * Revision 4.0.1.1  91/06/07  10:58:28  lwall  * patch4: new copyright notice  * patch4: added global modifier for pattern matches  * patch4: // wouldn't use previous pattern if it started with a null character  * patch4: //o and s///o now optimize themselves fully at runtime  * patch4: $` was busted inside s///  * patch4: caller($arg) didn't work except under debugger  *   * Revision 4.0  91/03/20  01:08:03  lwall  * 4.0 baseline.  *   */
end_comment

begin_include
include|#
directive|include
file|"EXTERN.h"
end_include

begin_include
include|#
directive|include
file|"perl.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|BUGGY_MSC
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|function
name|(
name|memcmp
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* BUGGY_MSC */
end_comment

begin_function
name|int
name|do_match
parameter_list|(
name|str
parameter_list|,
name|arg
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|STR
modifier|*
name|str
decl_stmt|;
specifier|register
name|ARG
modifier|*
name|arg
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
specifier|register
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|SPAT
modifier|*
name|spat
init|=
name|arg
index|[
literal|2
index|]
operator|.
name|arg_ptr
operator|.
name|arg_spat
decl_stmt|;
specifier|register
name|char
modifier|*
name|t
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
decl_stmt|;
name|STR
modifier|*
name|srchstr
init|=
name|st
index|[
name|sp
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|s
init|=
name|str_get
argument_list|(
name|st
index|[
name|sp
index|]
argument_list|)
decl_stmt|;
name|char
modifier|*
name|strend
init|=
name|s
operator|+
name|st
index|[
name|sp
index|]
operator|->
name|str_cur
decl_stmt|;
name|STR
modifier|*
name|tmpstr
decl_stmt|;
name|char
modifier|*
name|myhint
init|=
name|hint
decl_stmt|;
name|int
name|global
decl_stmt|;
name|int
name|safebase
decl_stmt|;
name|hint
operator|=
name|Nullch
expr_stmt|;
if|if
condition|(
operator|!
name|spat
condition|)
block|{
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
return|return
operator|--
name|sp
return|;
name|str_set
argument_list|(
name|str
argument_list|,
name|Yes
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
name|global
operator|=
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_GLOBAL
expr_stmt|;
name|safebase
operator|=
operator|(
name|gimme
operator|==
name|G_ARRAY
operator|)
operator|||
name|global
expr_stmt|;
if|if
condition|(
operator|!
name|s
condition|)
name|fatal
argument_list|(
literal|"panic: do_match"
argument_list|)
expr_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_USED
condition|)
block|{
ifdef|#
directive|ifdef
name|DEBUGGING
if|if
condition|(
name|debug
operator|&
literal|8
condition|)
name|deb
argument_list|(
literal|"2.SPAT USED\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
return|return
operator|--
name|sp
return|;
name|str_set
argument_list|(
name|str
argument_list|,
name|No
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
operator|--
name|sp
expr_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_runtime
condition|)
block|{
name|nointrp
operator|=
literal|"|)"
expr_stmt|;
name|sp
operator|=
name|eval
argument_list|(
name|spat
operator|->
name|spat_runtime
argument_list|,
name|G_SCALAR
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|st
operator|=
name|stack
operator|->
name|ary_array
expr_stmt|;
name|t
operator|=
name|str_get
argument_list|(
name|tmpstr
operator|=
name|st
index|[
name|sp
operator|--
index|]
argument_list|)
expr_stmt|;
name|nointrp
operator|=
literal|""
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUGGING
if|if
condition|(
name|debug
operator|&
literal|8
condition|)
name|deb
argument_list|(
literal|"2.SPAT /%s/\n"
argument_list|,
name|t
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|spat
operator|->
name|spat_regexp
condition|)
block|{
name|regfree
argument_list|(
name|spat
operator|->
name|spat_regexp
argument_list|)
expr_stmt|;
name|spat
operator|->
name|spat_regexp
operator|=
name|Null
argument_list|(
name|REGEXP
operator|*
argument_list|)
expr_stmt|;
comment|/* crucial if regcomp aborts */
block|}
name|spat
operator|->
name|spat_regexp
operator|=
name|regcomp
argument_list|(
name|t
argument_list|,
name|t
operator|+
name|tmpstr
operator|->
name|str_cur
argument_list|,
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_FOLD
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|spat
operator|->
name|spat_regexp
operator|->
name|prelen
operator|&&
name|lastspat
condition|)
name|spat
operator|=
name|lastspat
expr_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_KEEP
condition|)
block|{
name|scanconst
argument_list|(
name|spat
argument_list|,
name|spat
operator|->
name|spat_regexp
operator|->
name|precomp
argument_list|,
name|spat
operator|->
name|spat_regexp
operator|->
name|prelen
argument_list|)
expr_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_runtime
condition|)
name|arg_free
argument_list|(
name|spat
operator|->
name|spat_runtime
argument_list|)
expr_stmt|;
comment|/* it won't change, so */
name|spat
operator|->
name|spat_runtime
operator|=
name|Nullarg
expr_stmt|;
comment|/* no point compiling again */
name|hoistmust
argument_list|(
name|spat
argument_list|)
expr_stmt|;
if|if
condition|(
name|curcmd
operator|->
name|c_expr
operator|&&
operator|(
name|curcmd
operator|->
name|c_flags
operator|&
name|CF_OPTIMIZE
operator|)
operator|==
name|CFT_EVAL
condition|)
block|{
name|curcmd
operator|->
name|c_flags
operator|&=
operator|~
name|CF_OPTIMIZE
expr_stmt|;
name|opt_arg
argument_list|(
name|curcmd
argument_list|,
literal|1
argument_list|,
name|curcmd
operator|->
name|c_type
operator|==
name|C_EXPR
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|global
condition|)
block|{
if|if
condition|(
name|spat
operator|->
name|spat_regexp
operator|->
name|startp
index|[
literal|0
index|]
condition|)
block|{
name|s
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|endp
index|[
literal|0
index|]
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
operator|!
name|spat
operator|->
name|spat_regexp
operator|->
name|nparens
condition|)
name|gimme
operator|=
name|G_SCALAR
expr_stmt|;
comment|/* accidental array context? */
if|if
condition|(
name|regexec
argument_list|(
name|spat
operator|->
name|spat_regexp
argument_list|,
name|s
argument_list|,
name|strend
argument_list|,
name|s
argument_list|,
literal|0
argument_list|,
name|srchstr
operator|->
name|str_pok
operator|&
name|SP_STUDIED
condition|?
name|srchstr
else|:
name|Nullstr
argument_list|,
name|safebase
argument_list|)
condition|)
block|{
if|if
condition|(
name|spat
operator|->
name|spat_regexp
operator|->
name|subbase
operator|||
name|global
condition|)
name|curspat
operator|=
name|spat
expr_stmt|;
name|lastspat
operator|=
name|spat
expr_stmt|;
goto|goto
name|gotcha
goto|;
block|}
else|else
block|{
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
return|return
name|sp
return|;
name|str_sset
argument_list|(
name|str
argument_list|,
operator|&
name|str_no
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
block|}
else|else
block|{
ifdef|#
directive|ifdef
name|DEBUGGING
if|if
condition|(
name|debug
operator|&
literal|8
condition|)
block|{
name|char
name|ch
decl_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_ONCE
condition|)
name|ch
operator|=
literal|'?'
expr_stmt|;
else|else
name|ch
operator|=
literal|'/'
expr_stmt|;
name|deb
argument_list|(
literal|"2.SPAT %c%s%c\n"
argument_list|,
name|ch
argument_list|,
name|spat
operator|->
name|spat_regexp
operator|->
name|precomp
argument_list|,
name|ch
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
if|if
condition|(
operator|!
name|spat
operator|->
name|spat_regexp
operator|->
name|prelen
operator|&&
name|lastspat
condition|)
name|spat
operator|=
name|lastspat
expr_stmt|;
name|t
operator|=
name|s
expr_stmt|;
name|play_it_again
label|:
if|if
condition|(
name|global
operator|&&
name|spat
operator|->
name|spat_regexp
operator|->
name|startp
index|[
literal|0
index|]
condition|)
name|t
operator|=
name|s
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|endp
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|myhint
condition|)
block|{
if|if
condition|(
name|myhint
operator|<
name|s
operator|||
name|myhint
operator|>
name|strend
condition|)
name|fatal
argument_list|(
literal|"panic: hint in do_match"
argument_list|)
expr_stmt|;
name|s
operator|=
name|myhint
expr_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_regexp
operator|->
name|regback
operator|>=
literal|0
condition|)
block|{
name|s
operator|-=
name|spat
operator|->
name|spat_regexp
operator|->
name|regback
expr_stmt|;
if|if
condition|(
name|s
operator|<
name|t
condition|)
name|s
operator|=
name|t
expr_stmt|;
block|}
else|else
name|s
operator|=
name|t
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|spat
operator|->
name|spat_short
condition|)
block|{
if|if
condition|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_SCANFIRST
condition|)
block|{
if|if
condition|(
name|srchstr
operator|->
name|str_pok
operator|&
name|SP_STUDIED
condition|)
block|{
if|if
condition|(
name|screamfirst
index|[
name|spat
operator|->
name|spat_short
operator|->
name|str_rare
index|]
operator|<
literal|0
condition|)
goto|goto
name|nope
goto|;
elseif|else
if|if
condition|(
operator|!
operator|(
name|s
operator|=
name|screaminstr
argument_list|(
name|srchstr
argument_list|,
name|spat
operator|->
name|spat_short
argument_list|)
operator|)
condition|)
goto|goto
name|nope
goto|;
elseif|else
if|if
condition|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_ALL
condition|)
goto|goto
name|yup
goto|;
block|}
ifndef|#
directive|ifndef
name|lint
elseif|else
if|if
condition|(
operator|!
operator|(
name|s
operator|=
name|fbminstr
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|s
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|strend
argument_list|,
name|spat
operator|->
name|spat_short
argument_list|)
operator|)
condition|)
goto|goto
name|nope
goto|;
endif|#
directive|endif
elseif|else
if|if
condition|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_ALL
condition|)
goto|goto
name|yup
goto|;
if|if
condition|(
name|s
operator|&&
name|spat
operator|->
name|spat_regexp
operator|->
name|regback
operator|>=
literal|0
condition|)
block|{
operator|++
name|spat
operator|->
name|spat_short
operator|->
name|str_u
operator|.
name|str_useful
expr_stmt|;
name|s
operator|-=
name|spat
operator|->
name|spat_regexp
operator|->
name|regback
expr_stmt|;
if|if
condition|(
name|s
operator|<
name|t
condition|)
name|s
operator|=
name|t
expr_stmt|;
block|}
else|else
name|s
operator|=
name|t
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|multiline
operator|&&
operator|(
operator|*
name|spat
operator|->
name|spat_short
operator|->
name|str_ptr
operator|!=
operator|*
name|s
operator|||
name|bcmp
argument_list|(
name|spat
operator|->
name|spat_short
operator|->
name|str_ptr
argument_list|,
name|s
argument_list|,
name|spat
operator|->
name|spat_slen
argument_list|)
operator|)
condition|)
goto|goto
name|nope
goto|;
if|if
condition|(
operator|--
name|spat
operator|->
name|spat_short
operator|->
name|str_u
operator|.
name|str_useful
operator|<
literal|0
condition|)
block|{
name|str_free
argument_list|(
name|spat
operator|->
name|spat_short
argument_list|)
expr_stmt|;
name|spat
operator|->
name|spat_short
operator|=
name|Nullstr
expr_stmt|;
comment|/* opt is being useless */
block|}
block|}
if|if
condition|(
operator|!
name|spat
operator|->
name|spat_regexp
operator|->
name|nparens
operator|&&
operator|!
name|global
condition|)
block|{
name|gimme
operator|=
name|G_SCALAR
expr_stmt|;
comment|/* accidental array context? */
name|safebase
operator|=
name|FALSE
expr_stmt|;
block|}
if|if
condition|(
name|regexec
argument_list|(
name|spat
operator|->
name|spat_regexp
argument_list|,
name|s
argument_list|,
name|strend
argument_list|,
name|t
argument_list|,
literal|0
argument_list|,
name|srchstr
operator|->
name|str_pok
operator|&
name|SP_STUDIED
condition|?
name|srchstr
else|:
name|Nullstr
argument_list|,
name|safebase
argument_list|)
condition|)
block|{
if|if
condition|(
name|spat
operator|->
name|spat_regexp
operator|->
name|subbase
operator|||
name|global
condition|)
name|curspat
operator|=
name|spat
expr_stmt|;
name|lastspat
operator|=
name|spat
expr_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_ONCE
condition|)
name|spat
operator|->
name|spat_flags
operator||=
name|SPAT_USED
expr_stmt|;
goto|goto
name|gotcha
goto|;
block|}
else|else
block|{
if|if
condition|(
name|global
condition|)
name|spat
operator|->
name|spat_regexp
operator|->
name|startp
index|[
literal|0
index|]
operator|=
name|Nullch
expr_stmt|;
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
return|return
name|sp
return|;
name|str_sset
argument_list|(
name|str
argument_list|,
operator|&
name|str_no
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
block|}
comment|/*NOTREACHED*/
name|gotcha
label|:
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
block|{
name|int
name|iters
decl_stmt|,
name|i
decl_stmt|,
name|len
decl_stmt|;
name|iters
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|nparens
expr_stmt|;
if|if
condition|(
name|global
operator|&&
operator|!
name|iters
condition|)
name|i
operator|=
literal|1
expr_stmt|;
else|else
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|sp
operator|+
name|iters
operator|+
name|i
operator|>=
name|stack
operator|->
name|ary_max
condition|)
block|{
name|astore
argument_list|(
name|stack
argument_list|,
name|sp
operator|+
name|iters
operator|+
name|i
argument_list|,
name|Nullstr
argument_list|)
expr_stmt|;
name|st
operator|=
name|stack
operator|->
name|ary_array
expr_stmt|;
comment|/* possibly realloced */
block|}
for|for
control|(
name|i
operator|=
operator|!
name|i
init|;
name|i
operator|<=
name|iters
condition|;
name|i
operator|++
control|)
block|{
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str_mortal
argument_list|(
operator|&
name|str_no
argument_list|)
expr_stmt|;
comment|/*SUPPRESS 560*/
if|if
condition|(
name|s
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|startp
index|[
name|i
index|]
condition|)
block|{
name|len
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|endp
index|[
name|i
index|]
operator|-
name|s
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|0
condition|)
name|str_nset
argument_list|(
name|st
index|[
name|sp
index|]
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|global
condition|)
goto|goto
name|play_it_again
goto|;
return|return
name|sp
return|;
block|}
else|else
block|{
name|str_sset
argument_list|(
name|str
argument_list|,
operator|&
name|str_yes
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
name|yup
label|:
operator|++
name|spat
operator|->
name|spat_short
operator|->
name|str_u
operator|.
name|str_useful
expr_stmt|;
name|lastspat
operator|=
name|spat
expr_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_ONCE
condition|)
name|spat
operator|->
name|spat_flags
operator||=
name|SPAT_USED
expr_stmt|;
if|if
condition|(
name|global
condition|)
block|{
name|spat
operator|->
name|spat_regexp
operator|->
name|subbeg
operator|=
name|t
expr_stmt|;
name|spat
operator|->
name|spat_regexp
operator|->
name|subend
operator|=
name|strend
expr_stmt|;
name|spat
operator|->
name|spat_regexp
operator|->
name|startp
index|[
literal|0
index|]
operator|=
name|s
expr_stmt|;
name|spat
operator|->
name|spat_regexp
operator|->
name|endp
index|[
literal|0
index|]
operator|=
name|s
operator|+
name|spat
operator|->
name|spat_short
operator|->
name|str_cur
expr_stmt|;
name|curspat
operator|=
name|spat
expr_stmt|;
goto|goto
name|gotcha
goto|;
block|}
if|if
condition|(
name|sawampersand
condition|)
block|{
name|char
modifier|*
name|tmps
decl_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_regexp
operator|->
name|subbase
condition|)
name|Safefree
argument_list|(
name|spat
operator|->
name|spat_regexp
operator|->
name|subbase
argument_list|)
expr_stmt|;
name|tmps
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|subbase
operator|=
name|nsavestr
argument_list|(
name|t
argument_list|,
name|strend
operator|-
name|t
argument_list|)
expr_stmt|;
name|spat
operator|->
name|spat_regexp
operator|->
name|subbeg
operator|=
name|tmps
expr_stmt|;
name|spat
operator|->
name|spat_regexp
operator|->
name|subend
operator|=
name|tmps
operator|+
operator|(
name|strend
operator|-
name|t
operator|)
expr_stmt|;
name|tmps
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|startp
index|[
literal|0
index|]
operator|=
name|tmps
operator|+
operator|(
name|s
operator|-
name|t
operator|)
expr_stmt|;
name|spat
operator|->
name|spat_regexp
operator|->
name|endp
index|[
literal|0
index|]
operator|=
name|tmps
operator|+
name|spat
operator|->
name|spat_short
operator|->
name|str_cur
expr_stmt|;
name|curspat
operator|=
name|spat
expr_stmt|;
block|}
name|str_sset
argument_list|(
name|str
argument_list|,
operator|&
name|str_yes
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
name|nope
label|:
name|spat
operator|->
name|spat_regexp
operator|->
name|startp
index|[
literal|0
index|]
operator|=
name|Nullch
expr_stmt|;
operator|++
name|spat
operator|->
name|spat_short
operator|->
name|str_u
operator|.
name|str_useful
expr_stmt|;
if|if
condition|(
name|global
condition|)
name|spat
operator|->
name|spat_regexp
operator|->
name|startp
index|[
literal|0
index|]
operator|=
name|Nullch
expr_stmt|;
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
return|return
name|sp
return|;
name|str_sset
argument_list|(
name|str
argument_list|,
operator|&
name|str_no
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|BUGGY_MSC
end_ifdef

begin_pragma
pragma|#
directive|pragma
name|intrinsic
name|(
name|memcmp
name|)
end_pragma

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* BUGGY_MSC */
end_comment

begin_function
name|int
name|do_split
parameter_list|(
name|str
parameter_list|,
name|spat
parameter_list|,
name|limit
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|STR
modifier|*
name|str
decl_stmt|;
specifier|register
name|SPAT
modifier|*
name|spat
decl_stmt|;
specifier|register
name|int
name|limit
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
specifier|register
name|ARRAY
modifier|*
name|ary
init|=
name|stack
decl_stmt|;
name|STR
modifier|*
modifier|*
name|st
init|=
name|ary
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
decl_stmt|;
specifier|register
name|char
modifier|*
name|s
init|=
name|str_get
argument_list|(
name|st
index|[
name|sp
index|]
argument_list|)
decl_stmt|;
name|char
modifier|*
name|strend
init|=
name|s
operator|+
name|st
index|[
name|sp
operator|--
index|]
operator|->
name|str_cur
decl_stmt|;
specifier|register
name|STR
modifier|*
name|dstr
decl_stmt|;
specifier|register
name|char
modifier|*
name|m
decl_stmt|;
name|int
name|iters
init|=
literal|0
decl_stmt|;
name|int
name|maxiters
init|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|+
literal|10
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|orig
decl_stmt|;
name|int
name|origlimit
init|=
name|limit
decl_stmt|;
name|int
name|realarray
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|spat
operator|||
operator|!
name|s
condition|)
name|fatal
argument_list|(
literal|"panic: do_split"
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|spat
operator|->
name|spat_runtime
condition|)
block|{
name|nointrp
operator|=
literal|"|)"
expr_stmt|;
name|sp
operator|=
name|eval
argument_list|(
name|spat
operator|->
name|spat_runtime
argument_list|,
name|G_SCALAR
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|st
operator|=
name|stack
operator|->
name|ary_array
expr_stmt|;
name|m
operator|=
name|str_get
argument_list|(
name|dstr
operator|=
name|st
index|[
name|sp
operator|--
index|]
argument_list|)
expr_stmt|;
name|nointrp
operator|=
literal|""
expr_stmt|;
if|if
condition|(
operator|*
name|m
operator|==
literal|' '
operator|&&
name|dstr
operator|->
name|str_cur
operator|==
literal|1
condition|)
block|{
name|str_set
argument_list|(
name|dstr
argument_list|,
literal|"\\s+"
argument_list|)
expr_stmt|;
name|m
operator|=
name|dstr
operator|->
name|str_ptr
expr_stmt|;
name|spat
operator|->
name|spat_flags
operator||=
name|SPAT_SKIPWHITE
expr_stmt|;
block|}
if|if
condition|(
name|spat
operator|->
name|spat_regexp
condition|)
block|{
name|regfree
argument_list|(
name|spat
operator|->
name|spat_regexp
argument_list|)
expr_stmt|;
name|spat
operator|->
name|spat_regexp
operator|=
name|Null
argument_list|(
name|REGEXP
operator|*
argument_list|)
expr_stmt|;
comment|/* avoid possible double free */
block|}
name|spat
operator|->
name|spat_regexp
operator|=
name|regcomp
argument_list|(
name|m
argument_list|,
name|m
operator|+
name|dstr
operator|->
name|str_cur
argument_list|,
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_FOLD
argument_list|)
expr_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_KEEP
operator|||
operator|(
name|spat
operator|->
name|spat_runtime
operator|->
name|arg_type
operator|==
name|O_ITEM
operator|&&
operator|(
name|spat
operator|->
name|spat_runtime
index|[
literal|1
index|]
operator|.
name|arg_type
operator|&
name|A_MASK
operator|)
operator|==
name|A_SINGLE
operator|)
condition|)
block|{
name|arg_free
argument_list|(
name|spat
operator|->
name|spat_runtime
argument_list|)
expr_stmt|;
comment|/* it won't change, so */
name|spat
operator|->
name|spat_runtime
operator|=
name|Nullarg
expr_stmt|;
comment|/* no point compiling again */
block|}
block|}
ifdef|#
directive|ifdef
name|DEBUGGING
if|if
condition|(
name|debug
operator|&
literal|8
condition|)
block|{
name|deb
argument_list|(
literal|"2.SPAT /%s/\n"
argument_list|,
name|spat
operator|->
name|spat_regexp
operator|->
name|precomp
argument_list|)
expr_stmt|;
block|}
endif|#
directive|endif
name|ary
operator|=
name|stab_xarray
argument_list|(
name|spat
operator|->
name|spat_repl
index|[
literal|1
index|]
operator|.
name|arg_ptr
operator|.
name|arg_stab
argument_list|)
expr_stmt|;
if|if
condition|(
name|ary
operator|&&
operator|(
name|gimme
operator|!=
name|G_ARRAY
operator|||
operator|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_ONCE
operator|)
operator|)
condition|)
block|{
name|realarray
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|ary
operator|->
name|ary_flags
operator|&
name|ARF_REAL
operator|)
condition|)
block|{
name|ary
operator|->
name|ary_flags
operator||=
name|ARF_REAL
expr_stmt|;
for|for
control|(
name|i
operator|=
name|ary
operator|->
name|ary_fill
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
name|ary
operator|->
name|ary_array
index|[
name|i
index|]
operator|=
name|Nullstr
expr_stmt|;
comment|/* don't free mere refs */
block|}
name|ary
operator|->
name|ary_fill
operator|=
operator|-
literal|1
expr_stmt|;
name|sp
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* temporarily switch stacks */
block|}
else|else
name|ary
operator|=
name|stack
expr_stmt|;
name|orig
operator|=
name|s
expr_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_SKIPWHITE
condition|)
block|{
while|while
condition|(
name|isSPACE
argument_list|(
operator|*
name|s
argument_list|)
condition|)
name|s
operator|++
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|limit
condition|)
name|limit
operator|=
name|maxiters
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|strEQ
argument_list|(
literal|"\\s+"
argument_list|,
name|spat
operator|->
name|spat_regexp
operator|->
name|precomp
argument_list|)
condition|)
block|{
while|while
condition|(
operator|--
name|limit
condition|)
block|{
comment|/*SUPPRESS 530*/
for|for
control|(
name|m
operator|=
name|s
init|;
name|m
operator|<
name|strend
operator|&&
operator|!
name|isSPACE
argument_list|(
operator|*
name|m
argument_list|)
condition|;
name|m
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|m
operator|>=
name|strend
condition|)
break|break;
name|dstr
operator|=
name|Str_new
argument_list|(
literal|30
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
name|str_nset
argument_list|(
name|dstr
argument_list|,
name|s
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|realarray
condition|)
name|str_2mortal
argument_list|(
name|dstr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|dstr
argument_list|)
expr_stmt|;
comment|/*SUPPRESS 530*/
for|for
control|(
name|s
operator|=
name|m
operator|+
literal|1
init|;
name|s
operator|<
name|strend
operator|&&
name|isSPACE
argument_list|(
operator|*
name|s
argument_list|)
condition|;
name|s
operator|++
control|)
empty_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|strEQ
argument_list|(
literal|"^"
argument_list|,
name|spat
operator|->
name|spat_regexp
operator|->
name|precomp
argument_list|)
condition|)
block|{
while|while
condition|(
operator|--
name|limit
condition|)
block|{
comment|/*SUPPRESS 530*/
for|for
control|(
name|m
operator|=
name|s
init|;
name|m
operator|<
name|strend
operator|&&
operator|*
name|m
operator|!=
literal|'\n'
condition|;
name|m
operator|++
control|)
empty_stmt|;
name|m
operator|++
expr_stmt|;
if|if
condition|(
name|m
operator|>=
name|strend
condition|)
break|break;
name|dstr
operator|=
name|Str_new
argument_list|(
literal|30
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
name|str_nset
argument_list|(
name|dstr
argument_list|,
name|s
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|realarray
condition|)
name|str_2mortal
argument_list|(
name|dstr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|dstr
argument_list|)
expr_stmt|;
name|s
operator|=
name|m
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|spat
operator|->
name|spat_short
condition|)
block|{
name|i
operator|=
name|spat
operator|->
name|spat_short
operator|->
name|str_cur
expr_stmt|;
if|if
condition|(
name|i
operator|==
literal|1
condition|)
block|{
name|int
name|fold
init|=
operator|(
name|spat
operator|->
name|spat_flags
operator|&
name|SPAT_FOLD
operator|)
decl_stmt|;
name|i
operator|=
operator|*
name|spat
operator|->
name|spat_short
operator|->
name|str_ptr
expr_stmt|;
if|if
condition|(
name|fold
operator|&&
name|isUPPER
argument_list|(
name|i
argument_list|)
condition|)
name|i
operator|=
name|tolower
argument_list|(
name|i
argument_list|)
expr_stmt|;
while|while
condition|(
operator|--
name|limit
condition|)
block|{
if|if
condition|(
name|fold
condition|)
block|{
for|for
control|(
name|m
operator|=
name|s
init|;
name|m
operator|<
name|strend
operator|&&
operator|*
name|m
operator|!=
name|i
operator|&&
operator|(
operator|!
name|isUPPER
argument_list|(
operator|*
name|m
argument_list|)
operator|||
name|tolower
argument_list|(
operator|*
name|m
argument_list|)
operator|!=
name|i
operator|)
condition|;
name|m
operator|++
control|)
comment|/*SUPPRESS 530*/
empty_stmt|;
block|}
else|else
comment|/*SUPPRESS 530*/
for|for
control|(
name|m
operator|=
name|s
init|;
name|m
operator|<
name|strend
operator|&&
operator|*
name|m
operator|!=
name|i
condition|;
name|m
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|m
operator|>=
name|strend
condition|)
break|break;
name|dstr
operator|=
name|Str_new
argument_list|(
literal|30
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
name|str_nset
argument_list|(
name|dstr
argument_list|,
name|s
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|realarray
condition|)
name|str_2mortal
argument_list|(
name|dstr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|dstr
argument_list|)
expr_stmt|;
name|s
operator|=
name|m
operator|+
literal|1
expr_stmt|;
block|}
block|}
else|else
block|{
ifndef|#
directive|ifndef
name|lint
while|while
condition|(
name|s
operator|<
name|strend
operator|&&
operator|--
name|limit
operator|&&
operator|(
name|m
operator|=
name|fbminstr
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|s
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|strend
argument_list|,
name|spat
operator|->
name|spat_short
argument_list|)
operator|)
condition|)
endif|#
directive|endif
block|{
name|dstr
operator|=
name|Str_new
argument_list|(
literal|31
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
name|str_nset
argument_list|(
name|dstr
argument_list|,
name|s
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|realarray
condition|)
name|str_2mortal
argument_list|(
name|dstr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|dstr
argument_list|)
expr_stmt|;
name|s
operator|=
name|m
operator|+
name|i
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|maxiters
operator|+=
operator|(
name|strend
operator|-
name|s
operator|)
operator|*
name|spat
operator|->
name|spat_regexp
operator|->
name|nparens
expr_stmt|;
while|while
condition|(
name|s
operator|<
name|strend
operator|&&
operator|--
name|limit
operator|&&
name|regexec
argument_list|(
name|spat
operator|->
name|spat_regexp
argument_list|,
name|s
argument_list|,
name|strend
argument_list|,
name|orig
argument_list|,
literal|1
argument_list|,
name|Nullstr
argument_list|,
name|TRUE
argument_list|)
condition|)
block|{
if|if
condition|(
name|spat
operator|->
name|spat_regexp
operator|->
name|subbase
operator|&&
name|spat
operator|->
name|spat_regexp
operator|->
name|subbase
operator|!=
name|orig
condition|)
block|{
name|m
operator|=
name|s
expr_stmt|;
name|s
operator|=
name|orig
expr_stmt|;
name|orig
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|subbase
expr_stmt|;
name|s
operator|=
name|orig
operator|+
operator|(
name|m
operator|-
name|s
operator|)
expr_stmt|;
name|strend
operator|=
name|s
operator|+
operator|(
name|strend
operator|-
name|m
operator|)
expr_stmt|;
block|}
name|m
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|startp
index|[
literal|0
index|]
expr_stmt|;
name|dstr
operator|=
name|Str_new
argument_list|(
literal|32
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
name|str_nset
argument_list|(
name|dstr
argument_list|,
name|s
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|realarray
condition|)
name|str_2mortal
argument_list|(
name|dstr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|dstr
argument_list|)
expr_stmt|;
if|if
condition|(
name|spat
operator|->
name|spat_regexp
operator|->
name|nparens
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|spat
operator|->
name|spat_regexp
operator|->
name|nparens
condition|;
name|i
operator|++
control|)
block|{
name|s
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|startp
index|[
name|i
index|]
expr_stmt|;
name|m
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|endp
index|[
name|i
index|]
expr_stmt|;
name|dstr
operator|=
name|Str_new
argument_list|(
literal|33
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
name|str_nset
argument_list|(
name|dstr
argument_list|,
name|s
argument_list|,
name|m
operator|-
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|realarray
condition|)
name|str_2mortal
argument_list|(
name|dstr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|dstr
argument_list|)
expr_stmt|;
block|}
block|}
name|s
operator|=
name|spat
operator|->
name|spat_regexp
operator|->
name|endp
index|[
literal|0
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
name|realarray
condition|)
name|iters
operator|=
name|sp
operator|+
literal|1
expr_stmt|;
else|else
name|iters
operator|=
name|sp
operator|-
name|arglast
index|[
literal|0
index|]
expr_stmt|;
if|if
condition|(
name|iters
operator|>
name|maxiters
condition|)
name|fatal
argument_list|(
literal|"Split loop"
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|<
name|strend
operator|||
name|origlimit
condition|)
block|{
comment|/* keep field after final delim? */
name|dstr
operator|=
name|Str_new
argument_list|(
literal|34
argument_list|,
name|strend
operator|-
name|s
argument_list|)
expr_stmt|;
name|str_nset
argument_list|(
name|dstr
argument_list|,
name|s
argument_list|,
name|strend
operator|-
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|realarray
condition|)
name|str_2mortal
argument_list|(
name|dstr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|dstr
argument_list|)
expr_stmt|;
name|iters
operator|++
expr_stmt|;
block|}
else|else
block|{
ifndef|#
directive|ifndef
name|I286x
while|while
condition|(
name|iters
operator|>
literal|0
operator|&&
name|ary
operator|->
name|ary_array
index|[
name|sp
index|]
operator|->
name|str_cur
operator|==
literal|0
condition|)
name|iters
operator|--
operator|,
name|sp
operator|--
expr_stmt|;
else|#
directive|else
name|char
modifier|*
name|zaps
decl_stmt|;
name|int
name|zapb
decl_stmt|;
if|if
condition|(
name|iters
operator|>
literal|0
condition|)
block|{
name|zaps
operator|=
name|str_get
argument_list|(
name|afetch
argument_list|(
name|ary
argument_list|,
name|sp
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
name|zapb
operator|=
operator|(
name|int
operator|)
operator|*
name|zaps
expr_stmt|;
block|}
while|while
condition|(
name|iters
operator|>
literal|0
operator|&&
operator|(
operator|!
name|zapb
operator|)
condition|)
block|{
name|iters
operator|--
operator|,
name|sp
operator|--
expr_stmt|;
if|if
condition|(
name|iters
operator|>
literal|0
condition|)
block|{
name|zaps
operator|=
name|str_get
argument_list|(
name|afetch
argument_list|(
name|ary
argument_list|,
name|iters
operator|-
literal|1
argument_list|,
name|FALSE
argument_list|)
argument_list|)
expr_stmt|;
name|zapb
operator|=
operator|(
name|int
operator|)
operator|*
name|zaps
expr_stmt|;
block|}
block|}
endif|#
directive|endif
block|}
if|if
condition|(
name|realarray
condition|)
block|{
name|ary
operator|->
name|ary_fill
operator|=
name|sp
expr_stmt|;
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
block|{
name|sp
operator|++
expr_stmt|;
name|astore
argument_list|(
name|stack
argument_list|,
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
operator|+
name|sp
argument_list|,
name|Nullstr
argument_list|)
expr_stmt|;
name|Copy
argument_list|(
name|ary
operator|->
name|ary_array
argument_list|,
name|stack
operator|->
name|ary_array
operator|+
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
argument_list|,
name|sp
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
return|return
name|arglast
index|[
literal|0
index|]
operator|+
name|sp
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
return|return
name|sp
return|;
block|}
name|sp
operator|=
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|iters
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
end_function

begin_function
name|int
name|do_unpack
parameter_list|(
name|str
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|STR
modifier|*
name|str
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
decl_stmt|;
specifier|register
name|char
modifier|*
name|pat
init|=
name|str_get
argument_list|(
name|st
index|[
name|sp
operator|++
index|]
argument_list|)
decl_stmt|;
specifier|register
name|char
modifier|*
name|s
init|=
name|str_get
argument_list|(
name|st
index|[
name|sp
index|]
argument_list|)
decl_stmt|;
name|char
modifier|*
name|strend
init|=
name|s
operator|+
name|st
index|[
name|sp
operator|--
index|]
operator|->
name|str_cur
decl_stmt|;
name|char
modifier|*
name|strbeg
init|=
name|s
decl_stmt|;
specifier|register
name|char
modifier|*
name|patend
init|=
name|pat
operator|+
name|st
index|[
name|sp
index|]
operator|->
name|str_cur
decl_stmt|;
name|int
name|datumtype
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
specifier|register
name|int
name|bits
decl_stmt|;
comment|/* These must not be in registers: */
name|short
name|ashort
decl_stmt|;
name|int
name|aint
decl_stmt|;
name|long
name|along
decl_stmt|;
ifdef|#
directive|ifdef
name|QUAD
name|quad
name|aquad
decl_stmt|;
endif|#
directive|endif
name|unsigned
name|short
name|aushort
decl_stmt|;
name|unsigned
name|int
name|auint
decl_stmt|;
name|unsigned
name|long
name|aulong
decl_stmt|;
ifdef|#
directive|ifdef
name|QUAD
name|unsigned
name|quad
name|auquad
decl_stmt|;
endif|#
directive|endif
name|char
modifier|*
name|aptr
decl_stmt|;
name|float
name|afloat
decl_stmt|;
name|double
name|adouble
decl_stmt|;
name|int
name|checksum
init|=
literal|0
decl_stmt|;
name|unsigned
name|long
name|culong
decl_stmt|;
name|double
name|cdouble
decl_stmt|;
if|if
condition|(
name|gimme
operator|!=
name|G_ARRAY
condition|)
block|{
comment|/* arrange to do first one only */
comment|/*SUPPRESS 530*/
for|for
control|(
name|patend
operator|=
name|pat
init|;
operator|!
name|isALPHA
argument_list|(
operator|*
name|patend
argument_list|)
operator|||
operator|*
name|patend
operator|==
literal|'x'
condition|;
name|patend
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|index
argument_list|(
literal|"aAbBhH"
argument_list|,
operator|*
name|patend
argument_list|)
operator|||
operator|*
name|pat
operator|==
literal|'%'
condition|)
block|{
name|patend
operator|++
expr_stmt|;
while|while
condition|(
name|isDIGIT
argument_list|(
operator|*
name|patend
argument_list|)
operator|||
operator|*
name|patend
operator|==
literal|'*'
condition|)
name|patend
operator|++
expr_stmt|;
block|}
else|else
name|patend
operator|++
expr_stmt|;
block|}
name|sp
operator|--
expr_stmt|;
while|while
condition|(
name|pat
operator|<
name|patend
condition|)
block|{
name|reparse
label|:
name|datumtype
operator|=
operator|*
name|pat
operator|++
expr_stmt|;
if|if
condition|(
name|pat
operator|>=
name|patend
condition|)
name|len
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|pat
operator|==
literal|'*'
condition|)
block|{
name|len
operator|=
name|strend
operator|-
name|strbeg
expr_stmt|;
comment|/* long enough */
name|pat
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|isDIGIT
argument_list|(
operator|*
name|pat
argument_list|)
condition|)
block|{
name|len
operator|=
operator|*
name|pat
operator|++
operator|-
literal|'0'
expr_stmt|;
while|while
condition|(
name|isDIGIT
argument_list|(
operator|*
name|pat
argument_list|)
condition|)
name|len
operator|=
operator|(
name|len
operator|*
literal|10
operator|)
operator|+
operator|(
operator|*
name|pat
operator|++
operator|-
literal|'0'
operator|)
expr_stmt|;
block|}
else|else
name|len
operator|=
operator|(
name|datumtype
operator|!=
literal|'@'
operator|)
expr_stmt|;
switch|switch
condition|(
name|datumtype
condition|)
block|{
default|default:
break|break;
case|case
literal|'%'
case|:
if|if
condition|(
name|len
operator|==
literal|1
operator|&&
name|pat
index|[
operator|-
literal|1
index|]
operator|!=
literal|'1'
condition|)
name|len
operator|=
literal|16
expr_stmt|;
name|checksum
operator|=
name|len
expr_stmt|;
name|culong
operator|=
literal|0
expr_stmt|;
name|cdouble
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pat
operator|<
name|patend
condition|)
goto|goto
name|reparse
goto|;
break|break;
case|case
literal|'@'
case|:
if|if
condition|(
name|len
operator|>
name|strend
operator|-
name|s
condition|)
name|fatal
argument_list|(
literal|"@ outside of string"
argument_list|)
expr_stmt|;
name|s
operator|=
name|strbeg
operator|+
name|len
expr_stmt|;
break|break;
case|case
literal|'X'
case|:
if|if
condition|(
name|len
operator|>
name|s
operator|-
name|strbeg
condition|)
name|fatal
argument_list|(
literal|"X outside of string"
argument_list|)
expr_stmt|;
name|s
operator|-=
name|len
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
if|if
condition|(
name|len
operator|>
name|strend
operator|-
name|s
condition|)
name|fatal
argument_list|(
literal|"x outside of string"
argument_list|)
expr_stmt|;
name|s
operator|+=
name|len
expr_stmt|;
break|break;
case|case
literal|'A'
case|:
case|case
literal|'a'
case|:
if|if
condition|(
name|len
operator|>
name|strend
operator|-
name|s
condition|)
name|len
operator|=
name|strend
operator|-
name|s
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
goto|goto
name|uchar_checksum
goto|;
name|str
operator|=
name|Str_new
argument_list|(
literal|35
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|str_nset
argument_list|(
name|str
argument_list|,
name|s
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|s
operator|+=
name|len
expr_stmt|;
if|if
condition|(
name|datumtype
operator|==
literal|'A'
condition|)
block|{
name|aptr
operator|=
name|s
expr_stmt|;
comment|/* borrow register */
name|s
operator|=
name|str
operator|->
name|str_ptr
operator|+
name|len
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|s
operator|>=
name|str
operator|->
name|str_ptr
operator|&&
operator|(
operator|!
operator|*
name|s
operator|||
name|isSPACE
argument_list|(
operator|*
name|s
argument_list|)
operator|)
condition|)
name|s
operator|--
expr_stmt|;
operator|*
operator|++
name|s
operator|=
literal|'\0'
expr_stmt|;
name|str
operator|->
name|str_cur
operator|=
name|s
operator|-
name|str
operator|->
name|str_ptr
expr_stmt|;
name|s
operator|=
name|aptr
expr_stmt|;
comment|/* unborrow register */
block|}
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
case|case
literal|'b'
case|:
if|if
condition|(
name|pat
index|[
operator|-
literal|1
index|]
operator|==
literal|'*'
operator|||
name|len
operator|>
operator|(
name|strend
operator|-
name|s
operator|)
operator|*
literal|8
condition|)
name|len
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|*
literal|8
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|35
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|str
operator|->
name|str_cur
operator|=
name|len
expr_stmt|;
name|str
operator|->
name|str_pok
operator|=
literal|1
expr_stmt|;
name|aptr
operator|=
name|pat
expr_stmt|;
comment|/* borrow register */
name|pat
operator|=
name|str
operator|->
name|str_ptr
expr_stmt|;
if|if
condition|(
name|datumtype
operator|==
literal|'b'
condition|)
block|{
name|aint
operator|=
name|len
expr_stmt|;
for|for
control|(
name|len
operator|=
literal|0
init|;
name|len
operator|<
name|aint
condition|;
name|len
operator|++
control|)
block|{
if|if
condition|(
name|len
operator|&
literal|7
condition|)
comment|/*SUPPRESS 595*/
name|bits
operator|>>=
literal|1
expr_stmt|;
else|else
name|bits
operator|=
operator|*
name|s
operator|++
expr_stmt|;
operator|*
name|pat
operator|++
operator|=
literal|'0'
operator|+
operator|(
name|bits
operator|&
literal|1
operator|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|aint
operator|=
name|len
expr_stmt|;
for|for
control|(
name|len
operator|=
literal|0
init|;
name|len
operator|<
name|aint
condition|;
name|len
operator|++
control|)
block|{
if|if
condition|(
name|len
operator|&
literal|7
condition|)
name|bits
operator|<<=
literal|1
expr_stmt|;
else|else
name|bits
operator|=
operator|*
name|s
operator|++
expr_stmt|;
operator|*
name|pat
operator|++
operator|=
literal|'0'
operator|+
operator|(
operator|(
name|bits
operator|&
literal|128
operator|)
operator|!=
literal|0
operator|)
expr_stmt|;
block|}
block|}
operator|*
name|pat
operator|=
literal|'\0'
expr_stmt|;
name|pat
operator|=
name|aptr
expr_stmt|;
comment|/* unborrow register */
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
case|case
literal|'h'
case|:
if|if
condition|(
name|pat
index|[
operator|-
literal|1
index|]
operator|==
literal|'*'
operator|||
name|len
operator|>
operator|(
name|strend
operator|-
name|s
operator|)
operator|*
literal|2
condition|)
name|len
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|*
literal|2
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|35
argument_list|,
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
name|str
operator|->
name|str_cur
operator|=
name|len
expr_stmt|;
name|str
operator|->
name|str_pok
operator|=
literal|1
expr_stmt|;
name|aptr
operator|=
name|pat
expr_stmt|;
comment|/* borrow register */
name|pat
operator|=
name|str
operator|->
name|str_ptr
expr_stmt|;
if|if
condition|(
name|datumtype
operator|==
literal|'h'
condition|)
block|{
name|aint
operator|=
name|len
expr_stmt|;
for|for
control|(
name|len
operator|=
literal|0
init|;
name|len
operator|<
name|aint
condition|;
name|len
operator|++
control|)
block|{
if|if
condition|(
name|len
operator|&
literal|1
condition|)
name|bits
operator|>>=
literal|4
expr_stmt|;
else|else
name|bits
operator|=
operator|*
name|s
operator|++
expr_stmt|;
operator|*
name|pat
operator|++
operator|=
name|hexdigit
index|[
name|bits
operator|&
literal|15
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
name|aint
operator|=
name|len
expr_stmt|;
for|for
control|(
name|len
operator|=
literal|0
init|;
name|len
operator|<
name|aint
condition|;
name|len
operator|++
control|)
block|{
if|if
condition|(
name|len
operator|&
literal|1
condition|)
name|bits
operator|<<=
literal|4
expr_stmt|;
else|else
name|bits
operator|=
operator|*
name|s
operator|++
expr_stmt|;
operator|*
name|pat
operator|++
operator|=
name|hexdigit
index|[
operator|(
name|bits
operator|>>
literal|4
operator|)
operator|&
literal|15
index|]
expr_stmt|;
block|}
block|}
operator|*
name|pat
operator|=
literal|'\0'
expr_stmt|;
name|pat
operator|=
name|aptr
expr_stmt|;
comment|/* unborrow register */
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
if|if
condition|(
name|len
operator|>
name|strend
operator|-
name|s
condition|)
name|len
operator|=
name|strend
operator|-
name|s
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|aint
operator|=
operator|*
name|s
operator|++
expr_stmt|;
if|if
condition|(
name|aint
operator|>=
literal|128
condition|)
comment|/* fake up signed chars */
name|aint
operator|-=
literal|256
expr_stmt|;
name|culong
operator|+=
name|aint
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|aint
operator|=
operator|*
name|s
operator|++
expr_stmt|;
if|if
condition|(
name|aint
operator|>=
literal|128
condition|)
comment|/* fake up signed chars */
name|aint
operator|-=
literal|256
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|36
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|aint
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'C'
case|:
if|if
condition|(
name|len
operator|>
name|strend
operator|-
name|s
condition|)
name|len
operator|=
name|strend
operator|-
name|s
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
name|uchar_checksum
label|:
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|auint
operator|=
operator|*
name|s
operator|++
operator|&
literal|255
expr_stmt|;
name|culong
operator|+=
name|auint
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|auint
operator|=
operator|*
name|s
operator|++
operator|&
literal|255
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|37
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|auint
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'s'
case|:
name|along
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|short
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|along
condition|)
name|len
operator|=
name|along
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ashort
argument_list|,
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|short
argument_list|)
expr_stmt|;
name|culong
operator|+=
name|ashort
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|ashort
argument_list|,
sizeof|sizeof
argument_list|(
name|short
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|short
argument_list|)
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|38
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|ashort
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'v'
case|:
case|case
literal|'n'
case|:
case|case
literal|'S'
case|:
name|along
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|/
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|along
condition|)
name|len
operator|=
name|along
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|aushort
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
argument_list|)
expr_stmt|;
name|s
operator|+=
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAS_NTOHS
if|if
condition|(
name|datumtype
operator|==
literal|'n'
condition|)
name|aushort
operator|=
name|ntohs
argument_list|(
name|aushort
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAS_VTOHS
if|if
condition|(
name|datumtype
operator|==
literal|'v'
condition|)
name|aushort
operator|=
name|vtohs
argument_list|(
name|aushort
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|culong
operator|+=
name|aushort
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|aushort
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
argument_list|)
expr_stmt|;
name|s
operator|+=
expr|sizeof
operator|(
name|unsigned
name|short
operator|)
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|39
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAS_NTOHS
if|if
condition|(
name|datumtype
operator|==
literal|'n'
condition|)
name|aushort
operator|=
name|ntohs
argument_list|(
name|aushort
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAS_VTOHS
if|if
condition|(
name|datumtype
operator|==
literal|'v'
condition|)
name|aushort
operator|=
name|vtohs
argument_list|(
name|aushort
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|aushort
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'i'
case|:
name|along
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|along
condition|)
name|len
operator|=
name|along
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|aint
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
if|if
condition|(
name|checksum
operator|>
literal|32
condition|)
name|cdouble
operator|+=
operator|(
name|double
operator|)
name|aint
expr_stmt|;
else|else
name|culong
operator|+=
name|aint
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|aint
argument_list|,
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|int
argument_list|)
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|40
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|aint
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'I'
case|:
name|along
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|/
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|along
condition|)
name|len
operator|=
name|along
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|auint
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
argument_list|)
expr_stmt|;
name|s
operator|+=
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
expr_stmt|;
if|if
condition|(
name|checksum
operator|>
literal|32
condition|)
name|cdouble
operator|+=
operator|(
name|double
operator|)
name|auint
expr_stmt|;
else|else
name|culong
operator|+=
name|auint
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|auint
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
argument_list|)
expr_stmt|;
name|s
operator|+=
expr|sizeof
operator|(
name|unsigned
name|int
operator|)
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|41
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|auint
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'l'
case|:
name|along
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|along
condition|)
name|len
operator|=
name|along
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|along
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
if|if
condition|(
name|checksum
operator|>
literal|32
condition|)
name|cdouble
operator|+=
operator|(
name|double
operator|)
name|along
expr_stmt|;
else|else
name|culong
operator|+=
name|along
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|along
argument_list|,
sizeof|sizeof
argument_list|(
name|long
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|long
argument_list|)
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|42
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|along
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'V'
case|:
case|case
literal|'N'
case|:
case|case
literal|'L'
case|:
name|along
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|/
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|along
condition|)
name|len
operator|=
name|along
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|aulong
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
argument_list|)
expr_stmt|;
name|s
operator|+=
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAS_NTOHL
if|if
condition|(
name|datumtype
operator|==
literal|'N'
condition|)
name|aulong
operator|=
name|ntohl
argument_list|(
name|aulong
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAS_VTOHL
if|if
condition|(
name|datumtype
operator|==
literal|'V'
condition|)
name|aulong
operator|=
name|vtohl
argument_list|(
name|aulong
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|checksum
operator|>
literal|32
condition|)
name|cdouble
operator|+=
operator|(
name|double
operator|)
name|aulong
expr_stmt|;
else|else
name|culong
operator|+=
name|aulong
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|aulong
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
argument_list|)
expr_stmt|;
name|s
operator|+=
expr|sizeof
operator|(
name|unsigned
name|long
operator|)
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|43
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|HAS_NTOHL
if|if
condition|(
name|datumtype
operator|==
literal|'N'
condition|)
name|aulong
operator|=
name|ntohl
argument_list|(
name|aulong
argument_list|)
expr_stmt|;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|HAS_VTOHL
if|if
condition|(
name|datumtype
operator|==
literal|'V'
condition|)
name|aulong
operator|=
name|vtohl
argument_list|(
name|aulong
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|aulong
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'p'
case|:
name|along
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|along
condition|)
name|len
operator|=
name|along
expr_stmt|;
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
operator|>
name|strend
operator|-
name|s
condition|)
break|break;
else|else
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|aptr
argument_list|,
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
expr_stmt|;
block|}
name|str
operator|=
name|Str_new
argument_list|(
literal|44
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|aptr
condition|)
name|str_set
argument_list|(
name|str
argument_list|,
name|aptr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
ifdef|#
directive|ifdef
name|QUAD
case|case
literal|'q'
case|:
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|s
operator|+
sizeof|sizeof
argument_list|(
name|quad
argument_list|)
operator|>
name|strend
condition|)
name|aquad
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|aquad
argument_list|,
sizeof|sizeof
argument_list|(
name|quad
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|quad
argument_list|)
expr_stmt|;
block|}
name|str
operator|=
name|Str_new
argument_list|(
literal|42
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|aquad
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|'Q'
case|:
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|s
operator|+
expr|sizeof
operator|(
name|unsigned
name|quad
operator|)
operator|>
name|strend
condition|)
name|auquad
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|auquad
argument_list|,
expr|sizeof
operator|(
name|unsigned
name|quad
operator|)
argument_list|)
expr_stmt|;
name|s
operator|+=
expr|sizeof
operator|(
name|unsigned
name|quad
operator|)
expr_stmt|;
block|}
name|str
operator|=
name|Str_new
argument_list|(
literal|43
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|auquad
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
endif|#
directive|endif
comment|/* float and double added gnb@melba.bby.oz.au 22/11/89 */
case|case
literal|'f'
case|:
case|case
literal|'F'
case|:
name|along
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|float
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|along
condition|)
name|len
operator|=
name|along
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|afloat
argument_list|,
sizeof|sizeof
argument_list|(
name|float
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|float
argument_list|)
expr_stmt|;
name|cdouble
operator|+=
name|afloat
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|afloat
argument_list|,
sizeof|sizeof
argument_list|(
name|float
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|float
argument_list|)
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|47
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|afloat
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'d'
case|:
case|case
literal|'D'
case|:
name|along
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|/
sizeof|sizeof
argument_list|(
name|double
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|along
condition|)
name|len
operator|=
name|along
expr_stmt|;
if|if
condition|(
name|checksum
condition|)
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|adouble
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|double
argument_list|)
expr_stmt|;
name|cdouble
operator|+=
name|adouble
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|len
operator|--
operator|>
literal|0
condition|)
block|{
name|bcopy
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|adouble
argument_list|,
sizeof|sizeof
argument_list|(
name|double
argument_list|)
argument_list|)
expr_stmt|;
name|s
operator|+=
sizeof|sizeof
argument_list|(
name|double
argument_list|)
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|48
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|adouble
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
literal|'u'
case|:
name|along
operator|=
operator|(
name|strend
operator|-
name|s
operator|)
operator|*
literal|3
operator|/
literal|4
expr_stmt|;
name|str
operator|=
name|Str_new
argument_list|(
literal|42
argument_list|,
name|along
argument_list|)
expr_stmt|;
while|while
condition|(
name|s
operator|<
name|strend
operator|&&
operator|*
name|s
operator|>
literal|' '
operator|&&
operator|*
name|s
operator|<
literal|'a'
condition|)
block|{
name|int
name|a
decl_stmt|,
name|b
decl_stmt|,
name|c
decl_stmt|,
name|d
decl_stmt|;
name|char
name|hunk
index|[
literal|4
index|]
decl_stmt|;
name|hunk
index|[
literal|3
index|]
operator|=
literal|'\0'
expr_stmt|;
name|len
operator|=
operator|(
operator|*
name|s
operator|++
operator|-
literal|' '
operator|)
operator|&
literal|077
expr_stmt|;
while|while
condition|(
name|len
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|s
operator|<
name|strend
operator|&&
operator|*
name|s
operator|>=
literal|' '
condition|)
name|a
operator|=
operator|(
operator|*
name|s
operator|++
operator|-
literal|' '
operator|)
operator|&
literal|077
expr_stmt|;
else|else
name|a
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|s
operator|<
name|strend
operator|&&
operator|*
name|s
operator|>=
literal|' '
condition|)
name|b
operator|=
operator|(
operator|*
name|s
operator|++
operator|-
literal|' '
operator|)
operator|&
literal|077
expr_stmt|;
else|else
name|b
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|s
operator|<
name|strend
operator|&&
operator|*
name|s
operator|>=
literal|' '
condition|)
name|c
operator|=
operator|(
operator|*
name|s
operator|++
operator|-
literal|' '
operator|)
operator|&
literal|077
expr_stmt|;
else|else
name|c
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|s
operator|<
name|strend
operator|&&
operator|*
name|s
operator|>=
literal|' '
condition|)
name|d
operator|=
operator|(
operator|*
name|s
operator|++
operator|-
literal|' '
operator|)
operator|&
literal|077
expr_stmt|;
else|else
name|d
operator|=
literal|0
expr_stmt|;
name|hunk
index|[
literal|0
index|]
operator|=
name|a
operator|<<
literal|2
operator||
name|b
operator|>>
literal|4
expr_stmt|;
name|hunk
index|[
literal|1
index|]
operator|=
name|b
operator|<<
literal|4
operator||
name|c
operator|>>
literal|2
expr_stmt|;
name|hunk
index|[
literal|2
index|]
operator|=
name|c
operator|<<
literal|6
operator||
name|d
expr_stmt|;
name|str_ncat
argument_list|(
name|str
argument_list|,
name|hunk
argument_list|,
name|len
operator|>
literal|3
condition|?
literal|3
else|:
name|len
argument_list|)
expr_stmt|;
name|len
operator|-=
literal|3
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|s
operator|==
literal|'\n'
condition|)
name|s
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
name|s
index|[
literal|1
index|]
operator|==
literal|'\n'
condition|)
comment|/* possible checksum byte */
name|s
operator|+=
literal|2
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|checksum
condition|)
block|{
name|str
operator|=
name|Str_new
argument_list|(
literal|42
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|index
argument_list|(
literal|"fFdD"
argument_list|,
name|datumtype
argument_list|)
operator|||
operator|(
name|checksum
operator|>
literal|32
operator|&&
name|index
argument_list|(
literal|"iIlLN"
argument_list|,
name|datumtype
argument_list|)
operator|)
condition|)
block|{
name|double
name|modf
parameter_list|()
function_decl|;
name|double
name|trouble
decl_stmt|;
name|adouble
operator|=
literal|1.0
expr_stmt|;
while|while
condition|(
name|checksum
operator|>=
literal|16
condition|)
block|{
name|checksum
operator|-=
literal|16
expr_stmt|;
name|adouble
operator|*=
literal|65536.0
expr_stmt|;
block|}
while|while
condition|(
name|checksum
operator|>=
literal|4
condition|)
block|{
name|checksum
operator|-=
literal|4
expr_stmt|;
name|adouble
operator|*=
literal|16.0
expr_stmt|;
block|}
while|while
condition|(
name|checksum
operator|--
condition|)
name|adouble
operator|*=
literal|2.0
expr_stmt|;
name|along
operator|=
operator|(
literal|1
operator|<<
name|checksum
operator|)
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|cdouble
operator|<
literal|0.0
condition|)
name|cdouble
operator|+=
name|adouble
expr_stmt|;
name|cdouble
operator|=
name|modf
argument_list|(
name|cdouble
operator|/
name|adouble
argument_list|,
operator|&
name|trouble
argument_list|)
operator|*
name|adouble
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
name|cdouble
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|checksum
operator|<
literal|32
condition|)
block|{
name|along
operator|=
operator|(
literal|1
operator|<<
name|checksum
operator|)
operator|-
literal|1
expr_stmt|;
name|culong
operator|&=
operator|(
name|unsigned
name|long
operator|)
name|along
expr_stmt|;
block|}
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|culong
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|checksum
operator|=
literal|0
expr_stmt|;
block|}
block|}
return|return
name|sp
return|;
block|}
end_function

begin_function
name|int
name|do_slice
parameter_list|(
name|stab
parameter_list|,
name|str
parameter_list|,
name|numarray
parameter_list|,
name|lval
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|STAB
modifier|*
name|stab
decl_stmt|;
name|STR
modifier|*
name|str
decl_stmt|;
name|int
name|numarray
decl_stmt|;
name|int
name|lval
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
specifier|register
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|1
index|]
decl_stmt|;
specifier|register
name|int
name|max
init|=
name|arglast
index|[
literal|2
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|tmps
decl_stmt|;
specifier|register
name|int
name|len
decl_stmt|;
specifier|register
name|int
name|magic
init|=
literal|0
decl_stmt|;
specifier|register
name|ARRAY
modifier|*
name|ary
decl_stmt|;
specifier|register
name|HASH
modifier|*
name|hash
decl_stmt|;
name|int
name|oldarybase
init|=
name|arybase
decl_stmt|;
if|if
condition|(
name|numarray
condition|)
block|{
if|if
condition|(
name|numarray
operator|==
literal|2
condition|)
block|{
comment|/* a slice of a LIST */
name|ary
operator|=
name|stack
expr_stmt|;
name|ary
operator|->
name|ary_fill
operator|=
name|arglast
index|[
literal|3
index|]
expr_stmt|;
name|arybase
operator|-=
name|max
operator|+
literal|1
expr_stmt|;
name|st
index|[
name|sp
index|]
operator|=
name|str
expr_stmt|;
comment|/* make stack size available */
name|str_numset
argument_list|(
name|str
argument_list|,
call|(
name|double
call|)
argument_list|(
name|sp
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
name|ary
operator|=
name|stab_array
argument_list|(
name|stab
argument_list|)
expr_stmt|;
comment|/* a slice of an array */
block|}
else|else
block|{
if|if
condition|(
name|lval
condition|)
block|{
if|if
condition|(
name|stab
operator|==
name|envstab
condition|)
name|magic
operator|=
literal|'E'
expr_stmt|;
elseif|else
if|if
condition|(
name|stab
operator|==
name|sigstab
condition|)
name|magic
operator|=
literal|'S'
expr_stmt|;
ifdef|#
directive|ifdef
name|SOME_DBM
elseif|else
if|if
condition|(
name|stab_hash
argument_list|(
name|stab
argument_list|)
operator|->
name|tbl_dbm
condition|)
name|magic
operator|=
literal|'D'
expr_stmt|;
endif|#
directive|endif
comment|/* SOME_DBM */
block|}
name|hash
operator|=
name|stab_hash
argument_list|(
name|stab
argument_list|)
expr_stmt|;
comment|/* a slice of an associative array */
block|}
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
block|{
if|if
condition|(
name|numarray
condition|)
block|{
while|while
condition|(
name|sp
operator|<
name|max
condition|)
block|{
if|if
condition|(
name|st
index|[
operator|++
name|sp
index|]
condition|)
block|{
name|st
index|[
name|sp
operator|-
literal|1
index|]
operator|=
name|afetch
argument_list|(
name|ary
argument_list|,
operator|(
operator|(
name|int
operator|)
name|str_gnum
argument_list|(
name|st
index|[
name|sp
index|]
argument_list|)
operator|)
operator|-
name|arybase
argument_list|,
name|lval
argument_list|)
expr_stmt|;
block|}
else|else
name|st
index|[
name|sp
operator|-
literal|1
index|]
operator|=
operator|&
name|str_undef
expr_stmt|;
block|}
block|}
else|else
block|{
while|while
condition|(
name|sp
operator|<
name|max
condition|)
block|{
if|if
condition|(
name|st
index|[
operator|++
name|sp
index|]
condition|)
block|{
name|tmps
operator|=
name|str_get
argument_list|(
name|st
index|[
name|sp
index|]
argument_list|)
expr_stmt|;
name|len
operator|=
name|st
index|[
name|sp
index|]
operator|->
name|str_cur
expr_stmt|;
name|st
index|[
name|sp
operator|-
literal|1
index|]
operator|=
name|hfetch
argument_list|(
name|hash
argument_list|,
name|tmps
argument_list|,
name|len
argument_list|,
name|lval
argument_list|)
expr_stmt|;
if|if
condition|(
name|magic
condition|)
name|str_magic
argument_list|(
name|st
index|[
name|sp
operator|-
literal|1
index|]
argument_list|,
name|stab
argument_list|,
name|magic
argument_list|,
name|tmps
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
name|st
index|[
name|sp
operator|-
literal|1
index|]
operator|=
operator|&
name|str_undef
expr_stmt|;
block|}
block|}
name|sp
operator|--
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|numarray
condition|)
block|{
if|if
condition|(
name|st
index|[
name|max
index|]
condition|)
name|st
index|[
name|sp
index|]
operator|=
name|afetch
argument_list|(
name|ary
argument_list|,
operator|(
operator|(
name|int
operator|)
name|str_gnum
argument_list|(
name|st
index|[
name|max
index|]
argument_list|)
operator|)
operator|-
name|arybase
argument_list|,
name|lval
argument_list|)
expr_stmt|;
else|else
name|st
index|[
name|sp
index|]
operator|=
operator|&
name|str_undef
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|st
index|[
name|max
index|]
condition|)
block|{
name|tmps
operator|=
name|str_get
argument_list|(
name|st
index|[
name|max
index|]
argument_list|)
expr_stmt|;
name|len
operator|=
name|st
index|[
name|max
index|]
operator|->
name|str_cur
expr_stmt|;
name|st
index|[
name|sp
index|]
operator|=
name|hfetch
argument_list|(
name|hash
argument_list|,
name|tmps
argument_list|,
name|len
argument_list|,
name|lval
argument_list|)
expr_stmt|;
if|if
condition|(
name|magic
condition|)
name|str_magic
argument_list|(
name|st
index|[
name|sp
index|]
argument_list|,
name|stab
argument_list|,
name|magic
argument_list|,
name|tmps
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
else|else
name|st
index|[
name|sp
index|]
operator|=
operator|&
name|str_undef
expr_stmt|;
block|}
block|}
name|arybase
operator|=
name|oldarybase
expr_stmt|;
return|return
name|sp
return|;
block|}
end_function

begin_function
name|int
name|do_splice
parameter_list|(
name|ary
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
specifier|register
name|ARRAY
modifier|*
name|ary
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
specifier|register
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|1
index|]
decl_stmt|;
name|int
name|max
init|=
name|arglast
index|[
literal|2
index|]
operator|+
literal|1
decl_stmt|;
specifier|register
name|STR
modifier|*
modifier|*
name|src
decl_stmt|;
specifier|register
name|STR
modifier|*
modifier|*
name|dst
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|int
name|offset
decl_stmt|;
specifier|register
name|int
name|length
decl_stmt|;
name|int
name|newlen
decl_stmt|;
name|int
name|after
decl_stmt|;
name|int
name|diff
decl_stmt|;
name|STR
modifier|*
modifier|*
name|tmparyval
decl_stmt|;
if|if
condition|(
operator|++
name|sp
operator|<
name|max
condition|)
block|{
name|offset
operator|=
operator|(
operator|(
name|int
operator|)
name|str_gnum
argument_list|(
name|st
index|[
name|sp
index|]
argument_list|)
operator|)
operator|-
name|arybase
expr_stmt|;
if|if
condition|(
name|offset
operator|<
literal|0
condition|)
name|offset
operator|+=
name|ary
operator|->
name|ary_fill
operator|+
literal|1
expr_stmt|;
if|if
condition|(
operator|++
name|sp
operator|<
name|max
condition|)
block|{
name|length
operator|=
operator|(
name|int
operator|)
name|str_gnum
argument_list|(
name|st
index|[
name|sp
operator|++
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|0
condition|)
name|length
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|length
operator|=
name|ary
operator|->
name|ary_max
operator|+
literal|1
expr_stmt|;
comment|/* close enough to infinity */
block|}
else|else
block|{
name|offset
operator|=
literal|0
expr_stmt|;
name|length
operator|=
name|ary
operator|->
name|ary_max
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|offset
operator|<
literal|0
condition|)
block|{
name|length
operator|+=
name|offset
expr_stmt|;
name|offset
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|length
operator|<
literal|0
condition|)
name|length
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|offset
operator|>
name|ary
operator|->
name|ary_fill
operator|+
literal|1
condition|)
name|offset
operator|=
name|ary
operator|->
name|ary_fill
operator|+
literal|1
expr_stmt|;
name|after
operator|=
name|ary
operator|->
name|ary_fill
operator|+
literal|1
operator|-
operator|(
name|offset
operator|+
name|length
operator|)
expr_stmt|;
if|if
condition|(
name|after
operator|<
literal|0
condition|)
block|{
comment|/* not that much array */
name|length
operator|+=
name|after
expr_stmt|;
comment|/* offset+length now in array */
name|after
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|ary
operator|->
name|ary_alloc
condition|)
block|{
name|afill
argument_list|(
name|ary
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|afill
argument_list|(
name|ary
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* At this point, sp .. max-1 is our new LIST */
name|newlen
operator|=
name|max
operator|-
name|sp
expr_stmt|;
name|diff
operator|=
name|newlen
operator|-
name|length
expr_stmt|;
if|if
condition|(
name|diff
operator|<
literal|0
condition|)
block|{
comment|/* shrinking the area */
if|if
condition|(
name|newlen
condition|)
block|{
name|New
argument_list|(
literal|451
argument_list|,
name|tmparyval
argument_list|,
name|newlen
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
comment|/* so remember insertion */
name|Copy
argument_list|(
name|st
operator|+
name|sp
argument_list|,
name|tmparyval
argument_list|,
name|newlen
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
block|}
name|sp
operator|=
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
block|{
comment|/* copy return vals to stack */
if|if
condition|(
name|sp
operator|+
name|length
operator|>=
name|stack
operator|->
name|ary_max
condition|)
block|{
name|astore
argument_list|(
name|stack
argument_list|,
name|sp
operator|+
name|length
argument_list|,
name|Nullstr
argument_list|)
expr_stmt|;
name|st
operator|=
name|stack
operator|->
name|ary_array
expr_stmt|;
block|}
name|Copy
argument_list|(
name|ary
operator|->
name|ary_array
operator|+
name|offset
argument_list|,
name|st
operator|+
name|sp
argument_list|,
name|length
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|ary
operator|->
name|ary_flags
operator|&
name|ARF_REAL
condition|)
block|{
for|for
control|(
name|i
operator|=
name|length
operator|,
name|dst
operator|=
name|st
operator|+
name|sp
init|;
name|i
condition|;
name|i
operator|--
control|)
name|str_2mortal
argument_list|(
operator|*
name|dst
operator|++
argument_list|)
expr_stmt|;
comment|/* free them eventualy */
block|}
name|sp
operator|+=
name|length
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|st
index|[
name|sp
index|]
operator|=
name|ary
operator|->
name|ary_array
index|[
name|offset
operator|+
name|length
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|ary
operator|->
name|ary_flags
operator|&
name|ARF_REAL
condition|)
name|str_2mortal
argument_list|(
name|st
index|[
name|sp
index|]
argument_list|)
expr_stmt|;
block|}
name|ary
operator|->
name|ary_fill
operator|+=
name|diff
expr_stmt|;
comment|/* pull up or down? */
if|if
condition|(
name|offset
operator|<
name|after
condition|)
block|{
comment|/* easier to pull up */
if|if
condition|(
name|offset
condition|)
block|{
comment|/* esp. if nothing to pull */
name|src
operator|=
operator|&
name|ary
operator|->
name|ary_array
index|[
name|offset
operator|-
literal|1
index|]
expr_stmt|;
name|dst
operator|=
name|src
operator|-
name|diff
expr_stmt|;
comment|/* diff is negative */
for|for
control|(
name|i
operator|=
name|offset
init|;
name|i
operator|>
literal|0
condition|;
name|i
operator|--
control|)
comment|/* can't trust Copy */
operator|*
name|dst
operator|--
operator|=
operator|*
name|src
operator|--
expr_stmt|;
block|}
name|Zero
argument_list|(
name|ary
operator|->
name|ary_array
argument_list|,
operator|-
name|diff
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
name|ary
operator|->
name|ary_array
operator|-=
name|diff
expr_stmt|;
comment|/* diff is negative */
name|ary
operator|->
name|ary_max
operator|+=
name|diff
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|after
condition|)
block|{
comment|/* anything to pull down? */
name|src
operator|=
name|ary
operator|->
name|ary_array
operator|+
name|offset
operator|+
name|length
expr_stmt|;
name|dst
operator|=
name|src
operator|+
name|diff
expr_stmt|;
comment|/* diff is negative */
name|Copy
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|after
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
block|}
name|Zero
argument_list|(
operator|&
name|ary
operator|->
name|ary_array
index|[
name|ary
operator|->
name|ary_fill
operator|+
literal|1
index|]
argument_list|,
operator|-
name|diff
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
comment|/* avoid later double free */
block|}
if|if
condition|(
name|newlen
condition|)
block|{
for|for
control|(
name|src
operator|=
name|tmparyval
operator|,
name|dst
operator|=
name|ary
operator|->
name|ary_array
operator|+
name|offset
init|;
name|newlen
condition|;
name|newlen
operator|--
control|)
block|{
operator|*
name|dst
operator|=
name|Str_new
argument_list|(
literal|46
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_sset
argument_list|(
operator|*
name|dst
operator|++
argument_list|,
operator|*
name|src
operator|++
argument_list|)
expr_stmt|;
block|}
name|Safefree
argument_list|(
name|tmparyval
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* no, expanding (or same) */
if|if
condition|(
name|length
condition|)
block|{
name|New
argument_list|(
literal|452
argument_list|,
name|tmparyval
argument_list|,
name|length
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
comment|/* so remember deletion */
name|Copy
argument_list|(
name|ary
operator|->
name|ary_array
operator|+
name|offset
argument_list|,
name|tmparyval
argument_list|,
name|length
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|diff
operator|>
literal|0
condition|)
block|{
comment|/* expanding */
comment|/* push up or down? */
if|if
condition|(
name|offset
operator|<
name|after
operator|&&
name|diff
operator|<=
name|ary
operator|->
name|ary_array
operator|-
name|ary
operator|->
name|ary_alloc
condition|)
block|{
if|if
condition|(
name|offset
condition|)
block|{
name|src
operator|=
name|ary
operator|->
name|ary_array
expr_stmt|;
name|dst
operator|=
name|src
operator|-
name|diff
expr_stmt|;
name|Copy
argument_list|(
name|src
argument_list|,
name|dst
argument_list|,
name|offset
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
block|}
name|ary
operator|->
name|ary_array
operator|-=
name|diff
expr_stmt|;
comment|/* diff is positive */
name|ary
operator|->
name|ary_max
operator|+=
name|diff
expr_stmt|;
name|ary
operator|->
name|ary_fill
operator|+=
name|diff
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|ary
operator|->
name|ary_fill
operator|+
name|diff
operator|>=
name|ary
operator|->
name|ary_max
condition|)
comment|/* oh, well */
name|astore
argument_list|(
name|ary
argument_list|,
name|ary
operator|->
name|ary_fill
operator|+
name|diff
argument_list|,
name|Nullstr
argument_list|)
expr_stmt|;
else|else
name|ary
operator|->
name|ary_fill
operator|+=
name|diff
expr_stmt|;
if|if
condition|(
name|after
condition|)
block|{
name|dst
operator|=
name|ary
operator|->
name|ary_array
operator|+
name|ary
operator|->
name|ary_fill
expr_stmt|;
name|src
operator|=
name|dst
operator|-
name|diff
expr_stmt|;
for|for
control|(
name|i
operator|=
name|after
init|;
name|i
condition|;
name|i
operator|--
control|)
block|{
if|if
condition|(
operator|*
name|dst
condition|)
comment|/* str was hanging around */
name|str_free
argument_list|(
operator|*
name|dst
argument_list|)
expr_stmt|;
comment|/*  after $#foo */
operator|*
name|dst
operator|--
operator|=
operator|*
name|src
expr_stmt|;
operator|*
name|src
operator|--
operator|=
name|Nullstr
expr_stmt|;
block|}
block|}
block|}
block|}
for|for
control|(
name|src
operator|=
name|st
operator|+
name|sp
operator|,
name|dst
operator|=
name|ary
operator|->
name|ary_array
operator|+
name|offset
init|;
name|newlen
condition|;
name|newlen
operator|--
control|)
block|{
operator|*
name|dst
operator|=
name|Str_new
argument_list|(
literal|46
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|str_sset
argument_list|(
operator|*
name|dst
operator|++
argument_list|,
operator|*
name|src
operator|++
argument_list|)
expr_stmt|;
block|}
name|sp
operator|=
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
block|{
comment|/* copy return vals to stack */
if|if
condition|(
name|length
condition|)
block|{
name|Copy
argument_list|(
name|tmparyval
argument_list|,
name|st
operator|+
name|sp
argument_list|,
name|length
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
if|if
condition|(
name|ary
operator|->
name|ary_flags
operator|&
name|ARF_REAL
condition|)
block|{
for|for
control|(
name|i
operator|=
name|length
operator|,
name|dst
operator|=
name|st
operator|+
name|sp
init|;
name|i
condition|;
name|i
operator|--
control|)
name|str_2mortal
argument_list|(
operator|*
name|dst
operator|++
argument_list|)
expr_stmt|;
comment|/* free them eventualy */
block|}
name|Safefree
argument_list|(
name|tmparyval
argument_list|)
expr_stmt|;
block|}
name|sp
operator|+=
name|length
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|length
condition|)
block|{
name|st
index|[
name|sp
index|]
operator|=
name|tmparyval
index|[
name|length
operator|-
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|ary
operator|->
name|ary_flags
operator|&
name|ARF_REAL
condition|)
name|str_2mortal
argument_list|(
name|st
index|[
name|sp
index|]
argument_list|)
expr_stmt|;
name|Safefree
argument_list|(
name|tmparyval
argument_list|)
expr_stmt|;
block|}
else|else
name|st
index|[
name|sp
index|]
operator|=
operator|&
name|str_undef
expr_stmt|;
block|}
return|return
name|sp
return|;
block|}
end_function

begin_function
name|int
name|do_grep
parameter_list|(
name|arg
parameter_list|,
name|str
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
specifier|register
name|ARG
modifier|*
name|arg
decl_stmt|;
name|STR
modifier|*
name|str
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|dst
init|=
name|arglast
index|[
literal|1
index|]
decl_stmt|;
specifier|register
name|int
name|src
init|=
name|dst
operator|+
literal|1
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|2
index|]
decl_stmt|;
specifier|register
name|int
name|i
init|=
name|sp
operator|-
name|arglast
index|[
literal|1
index|]
decl_stmt|;
name|int
name|oldsave
init|=
name|savestack
operator|->
name|ary_fill
decl_stmt|;
name|SPAT
modifier|*
name|oldspat
init|=
name|curspat
decl_stmt|;
name|int
name|oldtmps_base
init|=
name|tmps_base
decl_stmt|;
name|savesptr
argument_list|(
operator|&
name|stab_val
argument_list|(
name|defstab
argument_list|)
argument_list|)
expr_stmt|;
name|tmps_base
operator|=
name|tmps_max
expr_stmt|;
if|if
condition|(
operator|(
name|arg
index|[
literal|1
index|]
operator|.
name|arg_type
operator|&
name|A_MASK
operator|)
operator|!=
name|A_EXPR
condition|)
block|{
name|arg
index|[
literal|1
index|]
operator|.
name|arg_type
operator|&=
name|A_MASK
expr_stmt|;
name|dehoist
argument_list|(
name|arg
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|arg
index|[
literal|1
index|]
operator|.
name|arg_type
operator||=
name|A_DONT
expr_stmt|;
block|}
name|arg
operator|=
name|arg
index|[
literal|1
index|]
operator|.
name|arg_ptr
operator|.
name|arg_arg
expr_stmt|;
while|while
condition|(
name|i
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|st
index|[
name|src
index|]
condition|)
block|{
name|st
index|[
name|src
index|]
operator|->
name|str_pok
operator|&=
operator|~
name|SP_TEMP
expr_stmt|;
name|stab_val
argument_list|(
name|defstab
argument_list|)
operator|=
name|st
index|[
name|src
index|]
expr_stmt|;
block|}
else|else
name|stab_val
argument_list|(
name|defstab
argument_list|)
operator|=
name|str_mortal
argument_list|(
operator|&
name|str_undef
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|eval
argument_list|(
name|arg
argument_list|,
name|G_SCALAR
argument_list|,
name|sp
argument_list|)
expr_stmt|;
name|st
operator|=
name|stack
operator|->
name|ary_array
expr_stmt|;
if|if
condition|(
name|str_true
argument_list|(
name|st
index|[
name|sp
operator|+
literal|1
index|]
argument_list|)
condition|)
name|st
index|[
name|dst
operator|++
index|]
operator|=
name|st
index|[
name|src
index|]
expr_stmt|;
name|src
operator|++
expr_stmt|;
name|curspat
operator|=
name|oldspat
expr_stmt|;
block|}
name|restorelist
argument_list|(
name|oldsave
argument_list|)
expr_stmt|;
name|tmps_base
operator|=
name|oldtmps_base
expr_stmt|;
if|if
condition|(
name|gimme
operator|!=
name|G_ARRAY
condition|)
block|{
name|str_numset
argument_list|(
name|str
argument_list|,
call|(
name|double
call|)
argument_list|(
name|dst
operator|-
name|arglast
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
index|]
operator|=
name|str
expr_stmt|;
return|return
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
return|;
block|}
return|return
name|arglast
index|[
literal|0
index|]
operator|+
operator|(
name|dst
operator|-
name|arglast
index|[
literal|1
index|]
operator|)
return|;
block|}
end_function

begin_function
name|int
name|do_reverse
parameter_list|(
name|arglast
parameter_list|)
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|STR
modifier|*
modifier|*
name|up
init|=
operator|&
name|st
index|[
name|arglast
index|[
literal|1
index|]
index|]
decl_stmt|;
specifier|register
name|STR
modifier|*
modifier|*
name|down
init|=
operator|&
name|st
index|[
name|arglast
index|[
literal|2
index|]
index|]
decl_stmt|;
specifier|register
name|int
name|i
init|=
name|arglast
index|[
literal|2
index|]
operator|-
name|arglast
index|[
literal|1
index|]
decl_stmt|;
while|while
condition|(
name|i
operator|--
operator|>
literal|0
condition|)
block|{
operator|*
name|up
operator|++
operator|=
operator|*
name|down
expr_stmt|;
if|if
condition|(
name|i
operator|--
operator|>
literal|0
condition|)
operator|*
name|down
operator|--
operator|=
operator|*
name|up
expr_stmt|;
block|}
name|i
operator|=
name|arglast
index|[
literal|2
index|]
operator|-
name|arglast
index|[
literal|1
index|]
expr_stmt|;
name|Copy
argument_list|(
name|down
operator|+
literal|1
argument_list|,
name|up
argument_list|,
name|i
operator|/
literal|2
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
return|return
name|arglast
index|[
literal|2
index|]
operator|-
literal|1
return|;
block|}
end_function

begin_function
name|int
name|do_sreverse
parameter_list|(
name|str
parameter_list|,
name|arglast
parameter_list|)
name|STR
modifier|*
name|str
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|char
modifier|*
name|up
decl_stmt|;
specifier|register
name|char
modifier|*
name|down
decl_stmt|;
specifier|register
name|int
name|tmp
decl_stmt|;
name|str_sset
argument_list|(
name|str
argument_list|,
name|st
index|[
name|arglast
index|[
literal|2
index|]
index|]
argument_list|)
expr_stmt|;
name|up
operator|=
name|str_get
argument_list|(
name|str
argument_list|)
expr_stmt|;
if|if
condition|(
name|str
operator|->
name|str_cur
operator|>
literal|1
condition|)
block|{
name|down
operator|=
name|str
operator|->
name|str_ptr
operator|+
name|str
operator|->
name|str_cur
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|down
operator|>
name|up
condition|)
block|{
name|tmp
operator|=
operator|*
name|up
expr_stmt|;
operator|*
name|up
operator|++
operator|=
operator|*
name|down
expr_stmt|;
operator|*
name|down
operator|--
operator|=
name|tmp
expr_stmt|;
block|}
block|}
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
index|]
operator|=
name|str
expr_stmt|;
return|return
name|arglast
index|[
literal|0
index|]
operator|+
literal|1
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|CMD
modifier|*
name|sortcmd
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|HASH
modifier|*
name|sortstash
init|=
name|Null
argument_list|(
name|HASH
operator|*
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|STAB
modifier|*
name|firststab
init|=
name|Nullstab
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|STAB
modifier|*
name|secondstab
init|=
name|Nullstab
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|do_sort
parameter_list|(
name|str
parameter_list|,
name|arg
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|STR
modifier|*
name|str
decl_stmt|;
name|ARG
modifier|*
name|arg
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
specifier|register
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
name|int
name|sp
init|=
name|arglast
index|[
literal|1
index|]
decl_stmt|;
specifier|register
name|STR
modifier|*
modifier|*
name|up
decl_stmt|;
specifier|register
name|int
name|max
init|=
name|arglast
index|[
literal|2
index|]
operator|-
name|sp
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|sortcmp
parameter_list|()
function_decl|;
name|int
name|sortsub
parameter_list|()
function_decl|;
name|STR
modifier|*
name|oldfirst
decl_stmt|;
name|STR
modifier|*
name|oldsecond
decl_stmt|;
name|ARRAY
modifier|*
name|oldstack
decl_stmt|;
name|HASH
modifier|*
name|stash
decl_stmt|;
name|STR
modifier|*
name|sortsubvar
decl_stmt|;
specifier|static
name|ARRAY
modifier|*
name|sortstack
init|=
name|Null
argument_list|(
name|ARRAY
operator|*
argument_list|)
decl_stmt|;
if|if
condition|(
name|gimme
operator|!=
name|G_ARRAY
condition|)
block|{
name|str_sset
argument_list|(
name|str
argument_list|,
operator|&
name|str_undef
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
name|up
operator|=
operator|&
name|st
index|[
name|sp
index|]
expr_stmt|;
name|sortsubvar
operator|=
operator|*
name|up
expr_stmt|;
name|st
operator|+=
name|sp
expr_stmt|;
comment|/* temporarily make st point to args */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|max
condition|;
name|i
operator|++
control|)
block|{
comment|/*SUPPRESS 560*/
if|if
condition|(
operator|*
name|up
operator|=
name|st
index|[
name|i
index|]
condition|)
block|{
if|if
condition|(
operator|!
operator|(
operator|*
name|up
operator|)
operator|->
name|str_pok
condition|)
operator|(
name|void
operator|)
name|str_2ptr
argument_list|(
operator|*
name|up
argument_list|)
expr_stmt|;
else|else
operator|(
operator|*
name|up
operator|)
operator|->
name|str_pok
operator|&=
operator|~
name|SP_TEMP
expr_stmt|;
name|up
operator|++
expr_stmt|;
block|}
block|}
name|st
operator|-=
name|sp
expr_stmt|;
name|max
operator|=
name|up
operator|-
operator|&
name|st
index|[
name|sp
index|]
expr_stmt|;
name|sp
operator|--
expr_stmt|;
if|if
condition|(
name|max
operator|>
literal|1
condition|)
block|{
name|STAB
modifier|*
name|stab
decl_stmt|;
if|if
condition|(
name|arg
index|[
literal|1
index|]
operator|.
name|arg_type
operator|==
operator|(
name|A_CMD
operator||
name|A_DONT
operator|)
condition|)
block|{
name|sortcmd
operator|=
name|arg
index|[
literal|1
index|]
operator|.
name|arg_ptr
operator|.
name|arg_cmd
expr_stmt|;
name|stash
operator|=
name|curcmd
operator|->
name|c_stash
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
operator|(
name|arg
index|[
literal|1
index|]
operator|.
name|arg_type
operator|&
name|A_MASK
operator|)
operator|==
name|A_WORD
condition|)
name|stab
operator|=
name|arg
index|[
literal|1
index|]
operator|.
name|arg_ptr
operator|.
name|arg_stab
expr_stmt|;
else|else
name|stab
operator|=
name|stabent
argument_list|(
name|str_get
argument_list|(
name|sortsubvar
argument_list|)
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
if|if
condition|(
name|stab
condition|)
block|{
if|if
condition|(
operator|!
name|stab_sub
argument_list|(
name|stab
argument_list|)
operator|||
operator|!
operator|(
name|sortcmd
operator|=
name|stab_sub
argument_list|(
name|stab
argument_list|)
operator|->
name|cmd
operator|)
condition|)
name|fatal
argument_list|(
literal|"Undefined subroutine \"%s\" in sort"
argument_list|,
name|stab_name
argument_list|(
name|stab
argument_list|)
argument_list|)
expr_stmt|;
name|stash
operator|=
name|stab_stash
argument_list|(
name|stab
argument_list|)
expr_stmt|;
block|}
else|else
name|sortcmd
operator|=
name|Nullcmd
expr_stmt|;
block|}
if|if
condition|(
name|sortcmd
condition|)
block|{
name|int
name|oldtmps_base
init|=
name|tmps_base
decl_stmt|;
if|if
condition|(
operator|!
name|sortstack
condition|)
block|{
name|sortstack
operator|=
name|anew
argument_list|(
name|Nullstab
argument_list|)
expr_stmt|;
name|astore
argument_list|(
name|sortstack
argument_list|,
literal|0
argument_list|,
name|Nullstr
argument_list|)
expr_stmt|;
name|aclear
argument_list|(
name|sortstack
argument_list|)
expr_stmt|;
name|sortstack
operator|->
name|ary_flags
operator|=
literal|0
expr_stmt|;
block|}
name|oldstack
operator|=
name|stack
expr_stmt|;
name|stack
operator|=
name|sortstack
expr_stmt|;
name|tmps_base
operator|=
name|tmps_max
expr_stmt|;
if|if
condition|(
name|sortstash
operator|!=
name|stash
condition|)
block|{
name|firststab
operator|=
name|stabent
argument_list|(
literal|"a"
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|secondstab
operator|=
name|stabent
argument_list|(
literal|"b"
argument_list|,
name|TRUE
argument_list|)
expr_stmt|;
name|sortstash
operator|=
name|stash
expr_stmt|;
block|}
name|oldfirst
operator|=
name|stab_val
argument_list|(
name|firststab
argument_list|)
expr_stmt|;
name|oldsecond
operator|=
name|stab_val
argument_list|(
name|secondstab
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|lint
name|qsort
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|st
operator|+
name|sp
operator|+
literal|1
operator|)
argument_list|,
name|max
argument_list|,
sizeof|sizeof
argument_list|(
name|STR
operator|*
argument_list|)
argument_list|,
name|sortsub
argument_list|)
expr_stmt|;
else|#
directive|else
name|qsort
argument_list|(
name|Nullch
argument_list|,
name|max
argument_list|,
sizeof|sizeof
argument_list|(
name|STR
operator|*
argument_list|)
argument_list|,
name|sortsub
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|stab_val
argument_list|(
name|firststab
argument_list|)
operator|=
name|oldfirst
expr_stmt|;
name|stab_val
argument_list|(
name|secondstab
argument_list|)
operator|=
name|oldsecond
expr_stmt|;
name|tmps_base
operator|=
name|oldtmps_base
expr_stmt|;
name|stack
operator|=
name|oldstack
expr_stmt|;
block|}
ifndef|#
directive|ifndef
name|lint
else|else
name|qsort
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|st
operator|+
name|sp
operator|+
literal|1
operator|)
argument_list|,
name|max
argument_list|,
sizeof|sizeof
argument_list|(
name|STR
operator|*
argument_list|)
argument_list|,
name|sortcmp
argument_list|)
expr_stmt|;
endif|#
directive|endif
block|}
return|return
name|sp
operator|+
name|max
return|;
block|}
end_function

begin_function
name|int
name|sortsub
parameter_list|(
name|str1
parameter_list|,
name|str2
parameter_list|)
name|STR
modifier|*
modifier|*
name|str1
decl_stmt|;
name|STR
modifier|*
modifier|*
name|str2
decl_stmt|;
block|{
name|stab_val
argument_list|(
name|firststab
argument_list|)
operator|=
operator|*
name|str1
expr_stmt|;
name|stab_val
argument_list|(
name|secondstab
argument_list|)
operator|=
operator|*
name|str2
expr_stmt|;
name|cmd_exec
argument_list|(
name|sortcmd
argument_list|,
name|G_SCALAR
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
return|return
operator|(
name|int
operator|)
name|str_gnum
argument_list|(
operator|*
name|stack
operator|->
name|ary_array
argument_list|)
return|;
block|}
end_function

begin_macro
name|sortcmp
argument_list|(
argument|strp1
argument_list|,
argument|strp2
argument_list|)
end_macro

begin_decl_stmt
name|STR
modifier|*
modifier|*
name|strp1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STR
modifier|*
modifier|*
name|strp2
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|STR
modifier|*
name|str1
init|=
operator|*
name|strp1
decl_stmt|;
specifier|register
name|STR
modifier|*
name|str2
init|=
operator|*
name|strp2
decl_stmt|;
name|int
name|retval
decl_stmt|;
if|if
condition|(
name|str1
operator|->
name|str_cur
operator|<
name|str2
operator|->
name|str_cur
condition|)
block|{
comment|/*SUPPRESS 560*/
if|if
condition|(
name|retval
operator|=
name|memcmp
argument_list|(
name|str1
operator|->
name|str_ptr
argument_list|,
name|str2
operator|->
name|str_ptr
argument_list|,
name|str1
operator|->
name|str_cur
argument_list|)
condition|)
return|return
name|retval
return|;
else|else
return|return
operator|-
literal|1
return|;
block|}
comment|/*SUPPRESS 560*/
elseif|else
if|if
condition|(
name|retval
operator|=
name|memcmp
argument_list|(
name|str1
operator|->
name|str_ptr
argument_list|,
name|str2
operator|->
name|str_ptr
argument_list|,
name|str2
operator|->
name|str_cur
argument_list|)
condition|)
return|return
name|retval
return|;
elseif|else
if|if
condition|(
name|str1
operator|->
name|str_cur
operator|==
name|str2
operator|->
name|str_cur
condition|)
return|return
literal|0
return|;
else|else
return|return
literal|1
return|;
block|}
end_block

begin_function
name|int
name|do_range
parameter_list|(
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|0
index|]
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|ARRAY
modifier|*
name|ary
init|=
name|stack
decl_stmt|;
specifier|register
name|STR
modifier|*
name|str
decl_stmt|;
name|int
name|max
decl_stmt|;
if|if
condition|(
name|gimme
operator|!=
name|G_ARRAY
condition|)
name|fatal
argument_list|(
literal|"panic: do_range"
argument_list|)
expr_stmt|;
if|if
condition|(
name|st
index|[
name|sp
operator|+
literal|1
index|]
operator|->
name|str_nok
operator|||
operator|!
name|st
index|[
name|sp
operator|+
literal|1
index|]
operator|->
name|str_pok
operator|||
operator|(
name|looks_like_number
argument_list|(
name|st
index|[
name|sp
operator|+
literal|1
index|]
argument_list|)
operator|&&
operator|*
name|st
index|[
name|sp
operator|+
literal|1
index|]
operator|->
name|str_ptr
operator|!=
literal|'0'
operator|)
condition|)
block|{
name|i
operator|=
operator|(
name|int
operator|)
name|str_gnum
argument_list|(
name|st
index|[
name|sp
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|max
operator|=
operator|(
name|int
operator|)
name|str_gnum
argument_list|(
name|st
index|[
name|sp
operator|+
literal|2
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|max
operator|>
name|i
condition|)
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
name|sp
operator|+
name|max
operator|-
name|i
operator|+
literal|1
argument_list|,
name|Nullstr
argument_list|)
expr_stmt|;
while|while
condition|(
name|i
operator|<=
name|max
condition|)
block|{
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str
operator|=
name|str_mortal
argument_list|(
operator|&
name|str_no
argument_list|)
argument_list|)
expr_stmt|;
name|str_numset
argument_list|(
name|str
argument_list|,
operator|(
name|double
operator|)
name|i
operator|++
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|STR
modifier|*
name|final
init|=
name|str_mortal
argument_list|(
name|st
index|[
name|sp
operator|+
literal|2
index|]
argument_list|)
decl_stmt|;
name|char
modifier|*
name|tmps
init|=
name|str_get
argument_list|(
name|final
argument_list|)
decl_stmt|;
name|str
operator|=
name|str_mortal
argument_list|(
name|st
index|[
name|sp
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|str
operator|->
name|str_nok
operator|&&
name|str
operator|->
name|str_cur
operator|<=
name|final
operator|->
name|str_cur
operator|&&
name|strNE
argument_list|(
name|str
operator|->
name|str_ptr
argument_list|,
name|tmps
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|str
operator|=
name|str_2mortal
argument_list|(
name|str_smake
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
name|str_inc
argument_list|(
name|str
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|strEQ
argument_list|(
name|str
operator|->
name|str_ptr
argument_list|,
name|tmps
argument_list|)
condition|)
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str
argument_list|)
expr_stmt|;
block|}
return|return
name|sp
return|;
block|}
end_function

begin_function
name|int
name|do_repeatary
parameter_list|(
name|arglast
parameter_list|)
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|0
index|]
decl_stmt|;
specifier|register
name|int
name|items
init|=
name|arglast
index|[
literal|1
index|]
operator|-
name|sp
decl_stmt|;
specifier|register
name|int
name|count
init|=
operator|(
name|int
operator|)
name|str_gnum
argument_list|(
name|st
index|[
name|arglast
index|[
literal|2
index|]
index|]
argument_list|)
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
name|int
name|max
decl_stmt|;
name|max
operator|=
name|items
operator|*
name|count
expr_stmt|;
if|if
condition|(
name|max
operator|>
literal|0
operator|&&
name|sp
operator|+
name|max
operator|>
name|stack
operator|->
name|ary_max
condition|)
block|{
name|astore
argument_list|(
name|stack
argument_list|,
name|sp
operator|+
name|max
argument_list|,
name|Nullstr
argument_list|)
expr_stmt|;
name|st
operator|=
name|stack
operator|->
name|ary_array
expr_stmt|;
block|}
if|if
condition|(
name|count
operator|>
literal|1
condition|)
block|{
for|for
control|(
name|i
operator|=
name|arglast
index|[
literal|1
index|]
init|;
name|i
operator|>
name|sp
condition|;
name|i
operator|--
control|)
name|st
index|[
name|i
index|]
operator|->
name|str_pok
operator|&=
operator|~
name|SP_TEMP
expr_stmt|;
name|repeatcpy
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|&
name|st
index|[
name|arglast
index|[
literal|1
index|]
operator|+
literal|1
index|]
argument_list|,
operator|(
name|char
operator|*
operator|)
operator|&
name|st
index|[
name|sp
operator|+
literal|1
index|]
argument_list|,
name|items
operator|*
sizeof|sizeof
argument_list|(
name|STR
operator|*
argument_list|)
argument_list|,
name|count
argument_list|)
expr_stmt|;
block|}
name|sp
operator|+=
name|max
expr_stmt|;
return|return
name|sp
return|;
block|}
end_function

begin_function
name|int
name|do_caller
parameter_list|(
name|arg
parameter_list|,
name|maxarg
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|ARG
modifier|*
name|arg
decl_stmt|;
name|int
name|maxarg
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|0
index|]
decl_stmt|;
specifier|register
name|CSV
modifier|*
name|csv
init|=
name|curcsv
decl_stmt|;
name|STR
modifier|*
name|str
decl_stmt|;
name|int
name|count
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|csv
condition|)
name|fatal
argument_list|(
literal|"There is no caller"
argument_list|)
expr_stmt|;
if|if
condition|(
name|maxarg
condition|)
name|count
operator|=
operator|(
name|int
operator|)
name|str_gnum
argument_list|(
name|st
index|[
name|sp
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|!
name|csv
condition|)
return|return
name|sp
return|;
if|if
condition|(
name|DBsub
operator|&&
name|csv
operator|->
name|curcsv
operator|&&
name|csv
operator|->
name|curcsv
operator|->
name|sub
operator|==
name|stab_sub
argument_list|(
name|DBsub
argument_list|)
condition|)
name|count
operator|++
expr_stmt|;
if|if
condition|(
operator|!
name|count
operator|--
condition|)
break|break;
name|csv
operator|=
name|csv
operator|->
name|curcsv
expr_stmt|;
block|}
if|if
condition|(
name|gimme
operator|!=
name|G_ARRAY
condition|)
block|{
name|STR
modifier|*
name|str
init|=
name|arg
operator|->
name|arg_ptr
operator|.
name|arg_str
decl_stmt|;
name|str_set
argument_list|(
name|str
argument_list|,
name|csv
operator|->
name|curcmd
operator|->
name|c_stash
operator|->
name|tbl_name
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
ifndef|#
directive|ifndef
name|lint
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_make
argument_list|(
name|csv
operator|->
name|curcmd
operator|->
name|c_stash
operator|->
name|tbl_name
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_make
argument_list|(
name|stab_val
argument_list|(
name|csv
operator|->
name|curcmd
operator|->
name|c_filestab
argument_list|)
operator|->
name|str_ptr
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|csv
operator|->
name|curcmd
operator|->
name|c_line
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|maxarg
condition|)
return|return
name|sp
return|;
name|str
operator|=
name|Str_new
argument_list|(
literal|49
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|stab_fullname
argument_list|(
name|str
argument_list|,
name|csv
operator|->
name|stab
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|csv
operator|->
name|hasargs
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|csv
operator|->
name|wantarray
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|csv
operator|->
name|hasargs
condition|)
block|{
name|ARRAY
modifier|*
name|ary
init|=
name|csv
operator|->
name|argarray
decl_stmt|;
if|if
condition|(
operator|!
name|dbargs
condition|)
name|dbargs
operator|=
name|stab_xarray
argument_list|(
name|aadd
argument_list|(
name|stabent
argument_list|(
literal|"DB'args"
argument_list|,
name|TRUE
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dbargs
operator|->
name|ary_max
operator|<
name|ary
operator|->
name|ary_fill
condition|)
name|astore
argument_list|(
name|dbargs
argument_list|,
name|ary
operator|->
name|ary_fill
argument_list|,
name|Nullstr
argument_list|)
expr_stmt|;
name|Copy
argument_list|(
name|ary
operator|->
name|ary_array
argument_list|,
name|dbargs
operator|->
name|ary_array
argument_list|,
name|ary
operator|->
name|ary_fill
operator|+
literal|1
argument_list|,
name|STR
operator|*
argument_list|)
expr_stmt|;
name|dbargs
operator|->
name|ary_fill
operator|=
name|ary
operator|->
name|ary_fill
expr_stmt|;
block|}
else|#
directive|else
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_make
argument_list|(
literal|""
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|sp
return|;
block|}
end_function

begin_function
name|int
name|do_tms
parameter_list|(
name|str
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|STR
modifier|*
name|str
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
ifdef|#
directive|ifdef
name|MSDOS
return|return
operator|-
literal|1
return|;
else|#
directive|else
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
name|gimme
operator|!=
name|G_ARRAY
condition|)
block|{
name|str_sset
argument_list|(
name|str
argument_list|,
operator|&
name|str_undef
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
operator|(
name|void
operator|)
name|times
argument_list|(
operator|&
name|timesbuf
argument_list|)
expr_stmt|;
ifndef|#
directive|ifndef
name|HZ
define|#
directive|define
name|HZ
value|60
endif|#
directive|endif
ifndef|#
directive|ifndef
name|lint
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
operator|(
name|double
operator|)
name|timesbuf
operator|.
name|tms_utime
operator|)
operator|/
name|HZ
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
operator|(
name|double
operator|)
name|timesbuf
operator|.
name|tms_stime
operator|)
operator|/
name|HZ
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
operator|(
name|double
operator|)
name|timesbuf
operator|.
name|tms_cutime
operator|)
operator|/
name|HZ
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
operator|(
name|double
operator|)
name|timesbuf
operator|.
name|tms_cstime
operator|)
operator|/
name|HZ
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
else|#
directive|else
operator|(
name|void
operator|)
name|astore
argument_list|(
name|stack
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
literal|0.0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
endif|#
directive|endif
return|return
name|sp
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|int
name|do_time
parameter_list|(
name|str
parameter_list|,
name|tmbuf
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|STR
modifier|*
name|str
decl_stmt|;
name|struct
name|tm
modifier|*
name|tmbuf
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
specifier|register
name|ARRAY
modifier|*
name|ary
init|=
name|stack
decl_stmt|;
name|STR
modifier|*
modifier|*
name|st
init|=
name|ary
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|0
index|]
decl_stmt|;
if|if
condition|(
operator|!
name|tmbuf
operator|||
name|gimme
operator|!=
name|G_ARRAY
condition|)
block|{
name|str_sset
argument_list|(
name|str
argument_list|,
operator|&
name|str_undef
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|tmbuf
operator|->
name|tm_sec
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|tmbuf
operator|->
name|tm_min
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|tmbuf
operator|->
name|tm_hour
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|tmbuf
operator|->
name|tm_mday
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|tmbuf
operator|->
name|tm_mon
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|tmbuf
operator|->
name|tm_year
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|tmbuf
operator|->
name|tm_wday
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|tmbuf
operator|->
name|tm_yday
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_nmake
argument_list|(
operator|(
name|double
operator|)
name|tmbuf
operator|->
name|tm_isdst
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|sp
return|;
block|}
end_function

begin_function
name|int
name|do_kv
parameter_list|(
name|str
parameter_list|,
name|hash
parameter_list|,
name|kv
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|STR
modifier|*
name|str
decl_stmt|;
name|HASH
modifier|*
name|hash
decl_stmt|;
name|int
name|kv
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
specifier|register
name|ARRAY
modifier|*
name|ary
init|=
name|stack
decl_stmt|;
name|STR
modifier|*
modifier|*
name|st
init|=
name|ary
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|0
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
specifier|register
name|HENT
modifier|*
name|entry
decl_stmt|;
name|char
modifier|*
name|tmps
decl_stmt|;
name|STR
modifier|*
name|tmpstr
decl_stmt|;
name|int
name|dokeys
init|=
operator|(
name|kv
operator|==
name|O_KEYS
operator|||
name|kv
operator|==
name|O_HASH
operator|)
decl_stmt|;
name|int
name|dovalues
init|=
operator|(
name|kv
operator|==
name|O_VALUES
operator|||
name|kv
operator|==
name|O_HASH
operator|)
decl_stmt|;
if|if
condition|(
name|gimme
operator|!=
name|G_ARRAY
condition|)
block|{
name|str_sset
argument_list|(
name|str
argument_list|,
operator|&
name|str_undef
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str
expr_stmt|;
return|return
name|sp
return|;
block|}
operator|(
name|void
operator|)
name|hiterinit
argument_list|(
name|hash
argument_list|)
expr_stmt|;
comment|/*SUPPRESS 560*/
while|while
condition|(
name|entry
operator|=
name|hiternext
argument_list|(
name|hash
argument_list|)
condition|)
block|{
if|if
condition|(
name|dokeys
condition|)
block|{
name|tmps
operator|=
name|hiterkey
argument_list|(
name|entry
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|i
condition|)
name|tmps
operator|=
literal|""
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|str_make
argument_list|(
name|tmps
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dovalues
condition|)
block|{
name|tmpstr
operator|=
name|Str_new
argument_list|(
literal|45
argument_list|,
literal|0
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUGGING
if|if
condition|(
name|debug
operator|&
literal|8192
condition|)
block|{
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"%d%%%d=%d\n"
argument_list|,
name|entry
operator|->
name|hent_hash
argument_list|,
name|hash
operator|->
name|tbl_max
operator|+
literal|1
argument_list|,
name|entry
operator|->
name|hent_hash
operator|&
name|hash
operator|->
name|tbl_max
argument_list|)
expr_stmt|;
name|str_set
argument_list|(
name|tmpstr
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
name|str_sset
argument_list|(
name|tmpstr
argument_list|,
name|hiterval
argument_list|(
name|hash
argument_list|,
name|entry
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|astore
argument_list|(
name|ary
argument_list|,
operator|++
name|sp
argument_list|,
name|str_2mortal
argument_list|(
name|tmpstr
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|sp
return|;
block|}
end_function

begin_function
name|int
name|do_each
parameter_list|(
name|str
parameter_list|,
name|hash
parameter_list|,
name|gimme
parameter_list|,
name|arglast
parameter_list|)
name|STR
modifier|*
name|str
decl_stmt|;
name|HASH
modifier|*
name|hash
decl_stmt|;
name|int
name|gimme
decl_stmt|;
name|int
modifier|*
name|arglast
decl_stmt|;
block|{
name|STR
modifier|*
modifier|*
name|st
init|=
name|stack
operator|->
name|ary_array
decl_stmt|;
specifier|register
name|int
name|sp
init|=
name|arglast
index|[
literal|0
index|]
decl_stmt|;
specifier|static
name|STR
modifier|*
name|mystrk
init|=
name|Nullstr
decl_stmt|;
name|HENT
modifier|*
name|entry
init|=
name|hiternext
argument_list|(
name|hash
argument_list|)
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
modifier|*
name|tmps
decl_stmt|;
if|if
condition|(
name|mystrk
condition|)
block|{
name|str_free
argument_list|(
name|mystrk
argument_list|)
expr_stmt|;
name|mystrk
operator|=
name|Nullstr
expr_stmt|;
block|}
if|if
condition|(
name|entry
condition|)
block|{
if|if
condition|(
name|gimme
operator|==
name|G_ARRAY
condition|)
block|{
name|tmps
operator|=
name|hiterkey
argument_list|(
name|entry
argument_list|,
operator|&
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|i
condition|)
name|tmps
operator|=
literal|""
expr_stmt|;
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|mystrk
operator|=
name|str_make
argument_list|(
name|tmps
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
name|st
index|[
operator|++
name|sp
index|]
operator|=
name|str
expr_stmt|;
name|str_sset
argument_list|(
name|str
argument_list|,
name|hiterval
argument_list|(
name|hash
argument_list|,
name|entry
argument_list|)
argument_list|)
expr_stmt|;
name|STABSET
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
name|sp
return|;
block|}
else|else
return|return
name|sp
return|;
block|}
end_function

end_unit


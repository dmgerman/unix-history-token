begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * draw.c  *  * accept dvi function calls and translate to X  */
end_comment

begin_include
include|#
directive|include
file|<X11/Xos.h>
end_include

begin_include
include|#
directive|include
file|<X11/IntrinsicP.h>
end_include

begin_include
include|#
directive|include
file|<X11/StringDefs.h>
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<ctype.h>
end_include

begin_include
include|#
directive|include
file|<math.h>
end_include

begin_comment
comment|/* math.h on a Sequent doesn't define M_PI, apparently */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|M_PI
end_ifndef

begin_define
define|#
directive|define
name|M_PI
value|3.14159265358979323846
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"DviP.h"
end_include

begin_macro
name|HorizontalMove
argument_list|(
argument|dw
argument_list|,
argument|delta
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|delta
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
operator|+=
name|delta
expr_stmt|;
block|}
end_block

begin_macro
name|HorizontalGoto
argument_list|(
argument|dw
argument_list|,
argument|NewPosition
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|NewPosition
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
operator|=
name|NewPosition
expr_stmt|;
block|}
end_block

begin_macro
name|VerticalMove
argument_list|(
argument|dw
argument_list|,
argument|delta
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|delta
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
operator|+=
name|delta
expr_stmt|;
block|}
end_block

begin_macro
name|VerticalGoto
argument_list|(
argument|dw
argument_list|,
argument|NewPosition
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|NewPosition
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
operator|=
name|NewPosition
expr_stmt|;
block|}
end_block

begin_macro
name|FlushCharCache
argument_list|(
argument|dw
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|char_index
operator|!=
literal|0
condition|)
name|XDrawText
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|start_x
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|start_y
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|cache
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
operator|+
literal|1
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|index
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|max
operator|=
name|DVI_TEXT_CACHE_SIZE
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|noPolyText
condition|)
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|max
operator|=
literal|1
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|char_index
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|cache
index|[
literal|0
index|]
operator|.
name|nchars
operator|=
literal|0
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|start_x
operator|=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|x
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|start_y
operator|=
name|dw
operator|->
name|dvi
operator|.
name|cache
operator|.
name|y
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
expr_stmt|;
block|}
end_block

begin_macro
name|ClearPage
argument_list|(
argument|dw
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|XClearWindow
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_block

begin_expr_stmt
specifier|static
name|setGC
argument_list|(
argument|dw
argument_list|)
name|DviWidget
name|dw
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|desired_line_width
decl_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|line_thickness
operator|<
literal|0
condition|)
block|{
name|desired_line_width
operator|=
operator|(
operator|(
operator|(
name|dw
operator|->
name|dvi
operator|.
name|device_resolution
operator|*
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|font_size
operator|)
operator|+
literal|5
operator|*
literal|72
operator|)
operator|/
operator|(
literal|10
operator|*
literal|72
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|desired_line_width
operator|==
literal|0
condition|)
name|desired_line_width
operator|=
literal|1
expr_stmt|;
block|}
else|else
name|desired_line_width
operator|=
name|dw
operator|->
name|dvi
operator|.
name|line_thickness
expr_stmt|;
if|if
condition|(
name|desired_line_width
operator|!=
name|dw
operator|->
name|dvi
operator|.
name|line_width
condition|)
block|{
name|XGCValues
name|values
decl_stmt|;
name|values
operator|.
name|line_width
operator|=
name|desired_line_width
expr_stmt|;
name|XChangeGC
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|GCLineWidth
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|line_width
operator|=
name|desired_line_width
expr_stmt|;
block|}
block|}
end_block

begin_expr_stmt
specifier|static
name|setFillGC
argument_list|(
argument|dw
argument_list|)
name|DviWidget
name|dw
expr_stmt|;
end_expr_stmt

begin_block
block|{
name|int
name|fill_type
decl_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|fill
operator|==
name|DVI_FILL_MAX
condition|)
name|fill_type
operator|=
name|DVI_FILL_BLACK
expr_stmt|;
elseif|else
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|fill
operator|==
literal|0
condition|)
name|fill_type
operator|=
name|DVI_FILL_WHITE
expr_stmt|;
else|else
name|fill_type
operator|=
name|DVI_FILL_GRAY
expr_stmt|;
if|if
condition|(
name|dw
operator|->
name|dvi
operator|.
name|fill_type
operator|!=
name|fill_type
condition|)
block|{
name|XGCValues
name|values
decl_stmt|;
switch|switch
condition|(
name|fill_type
condition|)
block|{
case|case
name|DVI_FILL_WHITE
case|:
name|values
operator|.
name|foreground
operator|=
name|dw
operator|->
name|dvi
operator|.
name|background
expr_stmt|;
name|values
operator|.
name|fill_style
operator|=
name|FillSolid
expr_stmt|;
break|break;
case|case
name|DVI_FILL_BLACK
case|:
name|values
operator|.
name|foreground
operator|=
name|dw
operator|->
name|dvi
operator|.
name|foreground
expr_stmt|;
name|values
operator|.
name|fill_style
operator|=
name|FillSolid
expr_stmt|;
break|break;
case|case
name|DVI_FILL_GRAY
case|:
name|values
operator|.
name|foreground
operator|=
name|dw
operator|->
name|dvi
operator|.
name|foreground
expr_stmt|;
name|values
operator|.
name|fill_style
operator|=
name|FillOpaqueStippled
expr_stmt|;
break|break;
block|}
name|XChangeGC
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|GCFillStyle
operator||
name|GCForeground
argument_list|,
operator|&
name|values
argument_list|)
expr_stmt|;
name|dw
operator|->
name|dvi
operator|.
name|fill_type
operator|=
name|fill_type
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|DrawLine
argument_list|(
argument|dw
argument_list|,
argument|x
argument_list|,
argument|y
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|XDrawLine
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
operator|+
name|x
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
operator|+
name|y
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawCircle
argument_list|(
argument|dw
argument_list|,
argument|diam
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|diam
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|XDrawArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
operator|-
name|diam
operator|/
literal|2
argument_list|,
name|diam
argument_list|,
name|diam
argument_list|,
literal|0
argument_list|,
literal|64
operator|*
literal|360
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawFilledCircle
argument_list|(
argument|dw
argument_list|,
argument|diam
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|diam
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|setFillGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|XFillArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
operator|-
name|diam
operator|/
literal|2
argument_list|,
name|diam
argument_list|,
name|diam
argument_list|,
literal|0
argument_list|,
literal|64
operator|*
literal|360
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawEllipse
argument_list|(
argument|dw
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|XDrawArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
operator|-
name|b
operator|/
literal|2
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
literal|0
argument_list|,
literal|64
operator|*
literal|360
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawFilledEllipse
argument_list|(
argument|dw
argument_list|,
argument|a
argument_list|,
argument|b
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|a
decl_stmt|,
name|b
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|setFillGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|XFillArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
operator|-
name|b
operator|/
literal|2
argument_list|,
name|a
argument_list|,
name|b
argument_list|,
literal|0
argument_list|,
literal|64
operator|*
literal|360
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawArc
argument_list|(
argument|dw
argument_list|,
argument|x0
argument_list|,
argument|y0
argument_list|,
argument|x1
argument_list|,
argument|y1
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|x0
decl_stmt|,
name|y0
decl_stmt|,
name|x1
decl_stmt|,
name|y1
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
name|int
name|angle1
decl_stmt|,
name|angle2
decl_stmt|;
name|int
name|rad
init|=
call|(
name|int
call|)
argument_list|(
operator|(
name|sqrt
argument_list|(
operator|(
name|double
operator|)
name|x0
operator|*
name|x0
operator|+
operator|(
name|double
operator|)
name|y0
operator|*
name|y0
argument_list|)
operator|+
name|sqrt
argument_list|(
operator|(
name|double
operator|)
name|x1
operator|*
name|x1
operator|+
operator|(
name|double
operator|)
name|y1
operator|*
name|y1
argument_list|)
operator|+
literal|1.0
operator|)
operator|/
literal|2.0
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|x0
operator|==
literal|0
operator|&&
name|y0
operator|==
literal|0
operator|)
operator|||
operator|(
name|x1
operator|==
literal|0
operator|&&
name|y1
operator|==
literal|0
operator|)
condition|)
return|return;
name|angle1
operator|=
call|(
name|int
call|)
argument_list|(
name|atan2
argument_list|(
operator|(
name|double
operator|)
name|y0
argument_list|,
operator|(
name|double
operator|)
operator|-
name|x0
argument_list|)
operator|*
literal|180.0
operator|*
literal|64.0
operator|/
name|M_PI
argument_list|)
expr_stmt|;
name|angle2
operator|=
call|(
name|int
call|)
argument_list|(
name|atan2
argument_list|(
operator|(
name|double
operator|)
operator|-
name|y1
argument_list|,
operator|(
name|double
operator|)
name|x1
argument_list|)
operator|*
literal|180.0
operator|*
literal|64.0
operator|/
name|M_PI
argument_list|)
expr_stmt|;
name|angle2
operator|-=
name|angle1
expr_stmt|;
if|if
condition|(
name|angle2
operator|<
literal|0
condition|)
name|angle2
operator|+=
literal|64
operator|*
literal|360
expr_stmt|;
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|XDrawArc
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
operator|+
name|x0
operator|-
name|rad
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
operator|+
name|y0
operator|-
name|rad
argument_list|,
name|rad
operator|*
literal|2
argument_list|,
name|rad
operator|*
literal|2
argument_list|,
name|angle1
argument_list|,
name|angle2
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawPolygon
argument_list|(
argument|dw
argument_list|,
argument|v
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
name|XPoint
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|n
operator|/=
literal|2
expr_stmt|;
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|XPoint
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|n
operator|+
literal|2
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|XPoint
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return;
name|p
index|[
literal|0
index|]
operator|.
name|x
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
expr_stmt|;
name|p
index|[
literal|0
index|]
operator|.
name|y
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|p
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|x
operator|=
name|v
index|[
literal|2
operator|*
name|i
index|]
operator|+
name|p
index|[
name|i
index|]
operator|.
name|x
expr_stmt|;
name|p
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|y
operator|=
name|v
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
operator|+
name|p
index|[
name|i
index|]
operator|.
name|y
expr_stmt|;
block|}
name|p
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|x
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
expr_stmt|;
name|p
index|[
name|n
operator|+
literal|1
index|]
operator|.
name|y
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
expr_stmt|;
name|XDrawLines
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|p
argument_list|,
name|n
operator|+
literal|2
argument_list|,
name|CoordModeOrigin
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|DrawFilledPolygon
argument_list|(
argument|dw
argument_list|,
argument|v
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
name|XPoint
modifier|*
name|p
decl_stmt|;
name|int
name|i
decl_stmt|;
name|n
operator|/=
literal|2
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|2
condition|)
return|return;
name|setFillGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|p
operator|=
operator|(
name|XPoint
operator|*
operator|)
name|malloc
argument_list|(
operator|(
name|n
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|XPoint
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
return|return;
name|p
index|[
literal|0
index|]
operator|.
name|x
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
expr_stmt|;
name|p
index|[
literal|0
index|]
operator|.
name|y
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|++
control|)
block|{
name|p
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|x
operator|=
name|v
index|[
literal|2
operator|*
name|i
index|]
expr_stmt|;
name|p
index|[
name|i
operator|+
literal|1
index|]
operator|.
name|y
operator|=
name|v
index|[
literal|2
operator|*
name|i
operator|+
literal|1
index|]
expr_stmt|;
block|}
name|XFillPolygon
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|fill_GC
argument_list|,
name|p
argument_list|,
name|n
operator|+
literal|1
argument_list|,
name|Complex
argument_list|,
name|CoordModePrevious
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
block|}
end_block

begin_define
define|#
directive|define
name|POINTS_MAX
value|10000
end_define

begin_expr_stmt
specifier|static
name|appendPoint
argument_list|(
argument|points
argument_list|,
argument|pointi
argument_list|,
argument|x
argument_list|,
argument|y
argument_list|)
name|XPoint
operator|*
name|points
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
modifier|*
name|pointi
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|*
name|pointi
operator|<
name|POINTS_MAX
condition|)
block|{
name|points
index|[
operator|*
name|pointi
index|]
operator|.
name|x
operator|=
name|x
expr_stmt|;
name|points
index|[
operator|*
name|pointi
index|]
operator|.
name|y
operator|=
name|y
expr_stmt|;
operator|*
name|pointi
operator|+=
literal|1
expr_stmt|;
block|}
block|}
end_block

begin_define
define|#
directive|define
name|FLATNESS
value|1
end_define

begin_expr_stmt
specifier|static
name|flattenCurve
argument_list|(
argument|points
argument_list|,
argument|pointi
argument_list|,
argument|x2
argument_list|,
argument|y2
argument_list|,
argument|x3
argument_list|,
argument|y3
argument_list|,
argument|x4
argument_list|,
argument|y4
argument_list|)
name|XPoint
operator|*
name|points
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
modifier|*
name|pointi
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|x2
decl_stmt|,
name|y2
decl_stmt|,
name|x3
decl_stmt|,
name|y3
decl_stmt|,
name|x4
decl_stmt|,
name|y4
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|x1
decl_stmt|,
name|y1
decl_stmt|,
name|dx
decl_stmt|,
name|dy
decl_stmt|,
name|n1
decl_stmt|,
name|n2
decl_stmt|,
name|n
decl_stmt|;
name|x1
operator|=
name|points
index|[
operator|*
name|pointi
operator|-
literal|1
index|]
operator|.
name|x
expr_stmt|;
name|y1
operator|=
name|points
index|[
operator|*
name|pointi
operator|-
literal|1
index|]
operator|.
name|y
expr_stmt|;
name|dx
operator|=
name|x4
operator|-
name|x1
expr_stmt|;
name|dy
operator|=
name|y4
operator|-
name|y1
expr_stmt|;
name|n1
operator|=
name|dy
operator|*
operator|(
name|x2
operator|-
name|x1
operator|)
operator|-
name|dx
operator|*
operator|(
name|y2
operator|-
name|y1
operator|)
expr_stmt|;
name|n2
operator|=
name|dy
operator|*
operator|(
name|x3
operator|-
name|x1
operator|)
operator|-
name|dx
operator|*
operator|(
name|y3
operator|-
name|y1
operator|)
expr_stmt|;
if|if
condition|(
name|n1
operator|<
literal|0
condition|)
name|n1
operator|=
operator|-
name|n1
expr_stmt|;
if|if
condition|(
name|n2
operator|<
literal|0
condition|)
name|n2
operator|=
operator|-
name|n2
expr_stmt|;
name|n
operator|=
name|n1
operator|>
name|n2
condition|?
name|n1
else|:
name|n2
expr_stmt|;
if|if
condition|(
name|n
operator|*
name|n
operator|/
operator|(
name|dy
operator|*
name|dy
operator|+
name|dx
operator|*
name|dx
operator|)
operator|<=
name|FLATNESS
operator|*
name|FLATNESS
condition|)
name|appendPoint
argument_list|(
name|points
argument_list|,
name|pointi
argument_list|,
name|x4
argument_list|,
name|y4
argument_list|)
expr_stmt|;
else|else
block|{
name|flattenCurve
argument_list|(
name|points
argument_list|,
name|pointi
argument_list|,
operator|(
name|x1
operator|+
name|x2
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|y1
operator|+
name|y2
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|x1
operator|+
name|x2
operator|*
literal|2
operator|+
name|x3
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|y1
operator|+
name|y2
operator|*
literal|2
operator|+
name|y3
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|x1
operator|+
literal|3
operator|*
name|x2
operator|+
literal|3
operator|*
name|x3
operator|+
name|x4
operator|)
operator|/
literal|8
argument_list|,
operator|(
name|y1
operator|+
literal|3
operator|*
name|y2
operator|+
literal|3
operator|*
name|y3
operator|+
name|y4
operator|)
operator|/
literal|8
argument_list|)
expr_stmt|;
name|flattenCurve
argument_list|(
name|points
argument_list|,
name|pointi
argument_list|,
operator|(
name|x2
operator|+
name|x3
operator|*
literal|2
operator|+
name|x4
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|y2
operator|+
name|y3
operator|*
literal|2
operator|+
name|y4
operator|)
operator|/
literal|4
argument_list|,
operator|(
name|x3
operator|+
name|x4
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|y3
operator|+
name|y4
operator|)
operator|/
literal|2
argument_list|,
name|x4
argument_list|,
name|y4
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_macro
name|DrawSpline
argument_list|(
argument|dw
argument_list|,
argument|v
argument_list|,
argument|n
argument_list|)
end_macro

begin_decl_stmt
name|DviWidget
name|dw
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
modifier|*
name|v
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|n
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|sx
decl_stmt|,
name|sy
decl_stmt|,
name|tx
decl_stmt|,
name|ty
decl_stmt|,
name|ux
decl_stmt|,
name|uy
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|pointi
decl_stmt|;
name|XPoint
name|points
index|[
name|POINTS_MAX
index|]
decl_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
operator|||
operator|(
name|n
operator|&
literal|1
operator|)
operator|!=
literal|0
condition|)
return|return;
name|setGC
argument_list|(
name|dw
argument_list|)
expr_stmt|;
name|sx
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|x
expr_stmt|;
name|sy
operator|=
name|dw
operator|->
name|dvi
operator|.
name|state
operator|->
name|y
expr_stmt|;
name|tx
operator|=
name|sx
operator|+
name|v
index|[
literal|0
index|]
expr_stmt|;
name|ty
operator|=
name|sy
operator|+
name|v
index|[
literal|1
index|]
expr_stmt|;
name|pointi
operator|=
literal|0
expr_stmt|;
name|appendPoint
argument_list|(
name|points
argument_list|,
operator|&
name|pointi
argument_list|,
name|sx
argument_list|,
name|sy
argument_list|)
expr_stmt|;
name|appendPoint
argument_list|(
name|points
argument_list|,
operator|&
name|pointi
argument_list|,
operator|(
name|sx
operator|+
name|tx
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|sy
operator|+
name|ty
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|2
init|;
name|i
operator|<
name|n
condition|;
name|i
operator|+=
literal|2
control|)
block|{
name|int
name|ux
init|=
name|tx
operator|+
name|v
index|[
name|i
index|]
decl_stmt|;
name|int
name|uy
init|=
name|ty
operator|+
name|v
index|[
name|i
operator|+
literal|1
index|]
decl_stmt|;
name|flattenCurve
argument_list|(
name|points
argument_list|,
operator|&
name|pointi
argument_list|,
operator|(
name|sx
operator|+
name|tx
operator|*
literal|5
operator|)
operator|/
literal|6
argument_list|,
operator|(
name|sy
operator|+
name|ty
operator|*
literal|5
operator|)
operator|/
literal|6
argument_list|,
operator|(
name|tx
operator|*
literal|5
operator|+
name|ux
operator|)
operator|/
literal|6
argument_list|,
operator|(
name|ty
operator|*
literal|5
operator|+
name|uy
operator|)
operator|/
literal|6
argument_list|,
operator|(
name|tx
operator|+
name|ux
operator|)
operator|/
literal|2
argument_list|,
operator|(
name|ty
operator|+
name|uy
operator|)
operator|/
literal|2
argument_list|)
expr_stmt|;
name|sx
operator|=
name|tx
expr_stmt|;
name|sy
operator|=
name|ty
expr_stmt|;
name|tx
operator|=
name|ux
expr_stmt|;
name|ty
operator|=
name|uy
expr_stmt|;
block|}
name|appendPoint
argument_list|(
name|points
argument_list|,
operator|&
name|pointi
argument_list|,
name|tx
argument_list|,
name|ty
argument_list|)
expr_stmt|;
name|XDrawLines
argument_list|(
name|XtDisplay
argument_list|(
name|dw
argument_list|)
argument_list|,
name|XtWindow
argument_list|(
name|dw
argument_list|)
argument_list|,
name|dw
operator|->
name|dvi
operator|.
name|normal_GC
argument_list|,
name|points
argument_list|,
name|pointi
argument_list|,
name|CoordModeOrigin
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Local Variables: c-indent-level: 8 c-continued-statement-offset: 8 c-brace-offset: -8 c-argdecl-indent: 8 c-label-offset: -8 c-tab-always-indent: nil End: */
end_comment

end_unit


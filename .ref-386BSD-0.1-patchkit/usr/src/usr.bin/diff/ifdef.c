begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* #ifdef-format output routines for GNU DIFF.    Copyright (C) 1989 Free Software Foundation, Inc.  This file is part of GNU DIFF.  GNU DIFF is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the GNU DIFF General Public License for full details.  Everyone is granted permission to copy, modify and redistribute GNU DIFF, but only under the conditions described in the GNU DIFF General Public License.   A copy of this license is supposed to have been given to you along with GNU DIFF so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_include
include|#
directive|include
file|"diff.h"
end_include

begin_function_decl
specifier|static
name|void
name|print_ifdef_hunk
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|struct
name|change
modifier|*
name|find_change
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|int
name|next_line
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Print the edit-script SCRIPT as a merged #ifdef file.  */
end_comment

begin_function
name|void
name|print_ifdef_script
parameter_list|(
name|script
parameter_list|)
name|struct
name|change
modifier|*
name|script
decl_stmt|;
block|{
name|next_line
operator|=
literal|0
expr_stmt|;
name|print_script
argument_list|(
name|script
argument_list|,
name|find_change
argument_list|,
name|print_ifdef_hunk
argument_list|)
expr_stmt|;
while|while
condition|(
name|next_line
operator|<
name|files
index|[
literal|0
index|]
operator|.
name|buffered_lines
condition|)
name|print_1_line
argument_list|(
literal|""
argument_list|,
operator|&
name|files
index|[
literal|0
index|]
operator|.
name|linbuf
index|[
name|next_line
operator|++
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Print a hunk of an ifdef diff.    This is a contiguous portion of a complete edit script,    describing changes in consecutive lines.  */
end_comment

begin_function
specifier|static
name|void
name|print_ifdef_hunk
parameter_list|(
name|hunk
parameter_list|)
name|struct
name|change
modifier|*
name|hunk
decl_stmt|;
block|{
name|int
name|first0
decl_stmt|,
name|last0
decl_stmt|,
name|first1
decl_stmt|,
name|last1
decl_stmt|,
name|deletes
decl_stmt|,
name|inserts
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
comment|/* Determine range of line numbers involved in each file.  */
name|analyze_hunk
argument_list|(
name|hunk
argument_list|,
operator|&
name|first0
argument_list|,
operator|&
name|last0
argument_list|,
operator|&
name|first1
argument_list|,
operator|&
name|last1
argument_list|,
operator|&
name|deletes
argument_list|,
operator|&
name|inserts
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|deletes
operator|&&
operator|!
name|inserts
condition|)
return|return;
comment|/* Print out lines up to this change.  */
while|while
condition|(
name|next_line
operator|<
name|first0
condition|)
name|print_1_line
argument_list|(
literal|""
argument_list|,
operator|&
name|files
index|[
literal|0
index|]
operator|.
name|linbuf
index|[
name|next_line
operator|++
index|]
argument_list|)
expr_stmt|;
comment|/* Print out stuff deleted from first file.  */
if|if
condition|(
name|deletes
condition|)
block|{
name|fprintf
argument_list|(
name|outfile
argument_list|,
literal|"#ifndef %s\n"
argument_list|,
name|ifdef_string
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|first0
init|;
name|i
operator|<=
name|last0
condition|;
name|i
operator|++
control|)
name|print_1_line
argument_list|(
literal|""
argument_list|,
operator|&
name|files
index|[
literal|0
index|]
operator|.
name|linbuf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|next_line
operator|=
name|i
expr_stmt|;
block|}
comment|/* Print out stuff inserted from second file.  */
if|if
condition|(
name|inserts
condition|)
block|{
if|if
condition|(
name|deletes
condition|)
name|fprintf
argument_list|(
name|outfile
argument_list|,
literal|"#else /* %s */\n"
argument_list|,
name|ifdef_string
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|outfile
argument_list|,
literal|"#ifdef %s\n"
argument_list|,
name|ifdef_string
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|first1
init|;
name|i
operator|<=
name|last1
condition|;
name|i
operator|++
control|)
name|print_1_line
argument_list|(
literal|""
argument_list|,
operator|&
name|files
index|[
literal|1
index|]
operator|.
name|linbuf
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|inserts
condition|)
name|fprintf
argument_list|(
name|outfile
argument_list|,
literal|"#endif /* %s */\n"
argument_list|,
name|ifdef_string
argument_list|)
expr_stmt|;
else|else
name|fprintf
argument_list|(
name|outfile
argument_list|,
literal|"#endif /* not %s */\n"
argument_list|,
name|ifdef_string
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


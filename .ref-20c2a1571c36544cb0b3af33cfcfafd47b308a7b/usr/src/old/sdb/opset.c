begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_decl_stmt
specifier|static
name|char
name|sccsid
index|[]
init|=
literal|"@(#)opset.c 4.1 %G%"
decl_stmt|;
end_decl_stmt

begin_empty
empty|#
end_empty

begin_comment
comment|/*  *  *	UNIX debugger  *  *		Instruction printing routines.  *		MACHINE DEPENDENT.  */
end_comment

begin_include
include|#
directive|include
file|"head.h"
end_include

begin_expr_stmt
name|SCCSID
argument_list|(
argument|@
operator|(
operator|#
operator|)
name|opset
operator|.
name|c
literal|2.4
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|STRING
name|errflg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|dot
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|INT
name|dotinc
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|L_INT
name|vvar
index|[
literal|36
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* instruction printing */
end_comment

begin_comment
comment|/*  * Argument access types  */
end_comment

begin_define
define|#
directive|define
name|ACCA
value|(8<<3)
end_define

begin_comment
comment|/* address only */
end_comment

begin_define
define|#
directive|define
name|ACCR
value|(1<<3)
end_define

begin_comment
comment|/* read */
end_comment

begin_define
define|#
directive|define
name|ACCW
value|(2<<3)
end_define

begin_comment
comment|/* write */
end_comment

begin_define
define|#
directive|define
name|ACCM
value|(3<<3)
end_define

begin_comment
comment|/* modify */
end_comment

begin_define
define|#
directive|define
name|ACCB
value|(4<<3)
end_define

begin_comment
comment|/* branch displacement */
end_comment

begin_define
define|#
directive|define
name|ACCI
value|(5<<3)
end_define

begin_comment
comment|/* XFC code */
end_comment

begin_comment
comment|/*  * Argument data types  */
end_comment

begin_define
define|#
directive|define
name|TYPB
value|0
end_define

begin_comment
comment|/* byte */
end_comment

begin_define
define|#
directive|define
name|TYPW
value|1
end_define

begin_comment
comment|/* word */
end_comment

begin_define
define|#
directive|define
name|TYPL
value|2
end_define

begin_comment
comment|/* long */
end_comment

begin_define
define|#
directive|define
name|TYPQ
value|3
end_define

begin_comment
comment|/* quad */
end_comment

begin_define
define|#
directive|define
name|TYPF
value|4
end_define

begin_comment
comment|/* floating */
end_comment

begin_define
define|#
directive|define
name|TYPD
value|5
end_define

begin_comment
comment|/* double floating */
end_comment

begin_decl_stmt
name|TYPE
name|struct
name|optab
modifier|*
name|OPTAB
decl_stmt|;
end_decl_stmt

begin_struct
struct|struct
name|optab
block|{
name|char
modifier|*
name|iname
decl_stmt|;
name|char
name|val
decl_stmt|;
name|char
name|nargs
decl_stmt|;
name|char
name|argtype
index|[
literal|6
index|]
decl_stmt|;
block|}
name|optab
index|[]
struct|;
end_struct

begin_define
define|#
directive|define
name|SYSTAB
value|struct systab
end_define

begin_macro
name|SYSTAB
end_macro

begin_block
block|{
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|sname
decl_stmt|;
block|}
end_block

begin_expr_stmt
name|systab
index|[]
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|STRING
name|regname
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|STRING
name|fltimm
index|[]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|POS
name|type
decl_stmt|,
name|space
decl_stmt|,
name|incp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ioptab
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* index by opcode to optab */
end_comment

begin_macro
name|mkioptab
argument_list|()
end_macro

begin_block
block|{
comment|/* set up ioptab */
name|REG
name|OPTAB
name|p
init|=
name|optab
decl_stmt|;
while|while
condition|(
name|p
operator|->
name|iname
condition|)
block|{
name|ioptab
index|[
name|p
operator|->
name|val
operator|&
name|LOBYTE
index|]
operator|=
name|p
operator|-
name|optab
expr_stmt|;
name|p
operator|++
expr_stmt|;
block|}
block|}
end_block

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|fmtr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|fmtR
decl_stmt|;
end_decl_stmt

begin_macro
name|printins
argument_list|(
argument|fmt
argument_list|,
argument|idsp
argument_list|,
argument|ins
argument_list|)
end_macro

begin_decl_stmt
name|char
name|fmt
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|vax
end_ifndef

begin_decl_stmt
name|REG
name|INT
name|ins
decl_stmt|;
end_decl_stmt

begin_else
else|#
directive|else
end_else

begin_decl_stmt
name|REG
name|L_INT
name|ins
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_block
block|{
name|short
name|i
decl_stmt|,
name|b
decl_stmt|,
name|mode
decl_stmt|;
name|char
modifier|*
modifier|*
name|r
decl_stmt|;
name|long
name|d
decl_stmt|;
name|char
modifier|*
name|fmat
decl_stmt|;
name|struct
name|proct
modifier|*
name|procp
decl_stmt|;
name|REG
name|char
modifier|*
name|ap
decl_stmt|;
name|REG
name|OPTAB
name|ip
decl_stmt|;
ifndef|#
directive|ifndef
name|vax
struct|struct
block|{
name|char
name|b_2
decl_stmt|,
name|b_3
decl_stmt|,
name|b_0
decl_stmt|,
name|b_1
decl_stmt|;
block|}
struct|;
else|#
directive|else
struct|struct
block|{
name|char
name|b_0
decl_stmt|,
name|b_1
decl_stmt|,
name|b_2
decl_stmt|,
name|b_3
decl_stmt|;
block|}
struct|;
endif|#
directive|endif
name|procp
operator|=
name|adrtoprocp
argument_list|(
name|dot
argument_list|)
expr_stmt|;
if|if
condition|(
name|procp
operator|->
name|paddr
operator|==
name|dot
condition|)
block|{
name|printf
argument_list|(
literal|"0x%04.4x"
argument_list|,
name|ins
operator|&
literal|0xffff
argument_list|)
expr_stmt|;
name|oincr
operator|=
literal|2
expr_stmt|;
return|return;
block|}
name|type
operator|=
name|DSYM
expr_stmt|;
name|space
operator|=
name|idsp
expr_stmt|;
name|ins
operator|&=
name|LOBYTE
expr_stmt|;
name|ip
operator|=
name|optab
operator|+
name|ioptab
index|[
name|ins
index|]
expr_stmt|;
name|printf
argument_list|(
literal|"%s\t"
argument_list|,
name|ip
operator|->
name|iname
argument_list|)
expr_stmt|;
name|incp
operator|=
literal|1
expr_stmt|;
name|ap
operator|=
name|ip
operator|->
name|argtype
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ip
operator|->
name|nargs
condition|;
name|i
operator|++
operator|,
name|ap
operator|++
control|)
block|{
name|vvar
index|[
name|i
index|]
operator|=
literal|0x80000000
expr_stmt|;
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|printc
argument_list|(
literal|','
argument_list|)
expr_stmt|;
name|top
label|:
if|if
condition|(
operator|*
name|ap
operator|&
name|ACCB
condition|)
name|b
operator|=
literal|0xAF
operator|+
operator|(
operator|(
operator|*
name|ap
operator|&
literal|7
operator|)
operator|<<
literal|5
operator|)
expr_stmt|;
comment|/* branch displacement */
else|else
block|{
name|b
operator|=
name|bchkget
argument_list|(
name|inkdot
argument_list|(
name|incp
argument_list|)
argument_list|,
name|idsp
argument_list|)
expr_stmt|;
operator|++
name|incp
expr_stmt|;
block|}
if|if
condition|(
name|b
operator|&
literal|0300
condition|)
block|{
comment|/* not short literal */
name|char
modifier|*
name|slnptr
decl_stmt|;
name|int
name|regno
decl_stmt|;
name|regno
operator|=
name|b
operator|&
literal|0xF
expr_stmt|;
if|if
condition|(
name|fmt
operator|==
literal|'i'
operator|&&
name|regno
operator|>=
literal|6
operator|&&
name|regno
operator|<=
literal|11
operator|&&
name|adrtoregvar
argument_list|(
name|regno
argument_list|,
name|procp
argument_list|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|slnptr
operator|=
name|sl_name
expr_stmt|;
name|r
operator|=
operator|&
name|slnptr
expr_stmt|;
block|}
else|else
name|r
operator|=
operator|&
name|regname
index|[
name|regno
index|]
expr_stmt|;
name|mode
operator|=
name|b
operator|>>=
literal|4
expr_stmt|;
name|mid
label|:
switch|switch
condition|(
operator|(
name|int
operator|)
name|mode
condition|)
block|{
case|case
literal|4
case|:
comment|/* [r] */
name|printf
argument_list|(
literal|"[%s]"
argument_list|,
operator|*
name|r
argument_list|)
expr_stmt|;
goto|goto
name|top
goto|;
case|case
literal|5
case|:
comment|/* r */
name|printf
argument_list|(
literal|"%s"
argument_list|,
operator|*
name|r
argument_list|)
expr_stmt|;
break|break;
case|case
literal|7
case|:
comment|/* -(r) */
name|printc
argument_list|(
literal|'-'
argument_list|)
expr_stmt|;
name|base
label|:
case|case
literal|6
case|:
comment|/* (r) */
name|printf
argument_list|(
literal|"(%s)"
argument_list|,
operator|*
name|r
argument_list|)
expr_stmt|;
break|break;
case|case
literal|9
case|:
comment|/* *(r)+ */
name|printc
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
case|case
literal|8
case|:
comment|/* (r)+ */
if|if
condition|(
name|r
operator|==
operator|(
name|regname
operator|+
literal|0xF
operator|)
condition|)
block|{
comment|/* PC: immediate or absolute */
name|printc
argument_list|(
literal|'$'
argument_list|)
expr_stmt|;
if|if
condition|(
name|b
operator|==
literal|9
condition|)
goto|goto
name|abs
goto|;
name|mode
operator|=
operator|(
operator|(
operator|*
name|ap
operator|&
literal|7
operator|)
operator|<<
literal|1
operator|)
operator|+
literal|0xA
expr_stmt|;
goto|goto
name|mid
goto|;
block|}
name|printf
argument_list|(
literal|"(%s)+"
argument_list|,
operator|*
name|r
argument_list|)
expr_stmt|;
break|break;
case|case
literal|0xB
case|:
name|printc
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
case|case
literal|0xA
case|:
name|d
operator|=
name|bchkget
argument_list|(
name|inkdot
argument_list|(
name|incp
argument_list|)
argument_list|,
name|idsp
argument_list|)
expr_stmt|;
operator|++
name|incp
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x80
condition|)
name|d
operator|-=
literal|0x100
expr_stmt|;
name|fmat
operator|=
name|fmtr
expr_stmt|;
name|disp
label|:
name|vvar
index|[
name|i
index|]
operator|=
name|d
expr_stmt|;
if|if
condition|(
name|r
operator|==
operator|(
name|regname
operator|+
literal|0xF
operator|)
operator|&&
name|b
operator|>=
literal|0xA
condition|)
name|vvar
index|[
name|i
index|]
operator|+=
name|dot
operator|+
name|incp
expr_stmt|;
if|if
condition|(
name|psymoff
argument_list|(
name|vvar
index|[
name|i
index|]
argument_list|,
name|r
argument_list|,
name|fmt
argument_list|)
operator|&&
name|r
operator|!=
name|regname
operator|+
literal|0xF
condition|)
goto|goto
name|base
goto|;
break|break;
case|case
literal|0xD
case|:
name|printc
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
case|case
literal|0xC
case|:
name|d
operator|=
literal|0
expr_stmt|;
name|d
operator|.
name|b_0
operator|=
name|bchkget
argument_list|(
name|inkdot
argument_list|(
name|incp
argument_list|)
argument_list|,
name|idsp
argument_list|)
expr_stmt|;
operator|++
name|incp
expr_stmt|;
name|d
operator|.
name|b_1
operator|=
name|bchkget
argument_list|(
name|inkdot
argument_list|(
name|incp
argument_list|)
argument_list|,
name|idsp
argument_list|)
expr_stmt|;
operator|++
name|incp
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x8000
condition|)
name|d
operator|-=
literal|0x10000
expr_stmt|;
name|fmat
operator|=
name|fmtr
expr_stmt|;
goto|goto
name|disp
goto|;
case|case
literal|0xF
case|:
name|printc
argument_list|(
literal|'*'
argument_list|)
expr_stmt|;
case|case
literal|0xE
case|:
name|abs
label|:
name|d
operator|.
name|b_0
operator|=
name|bchkget
argument_list|(
name|inkdot
argument_list|(
name|incp
argument_list|)
argument_list|,
name|idsp
argument_list|)
expr_stmt|;
operator|++
name|incp
expr_stmt|;
name|d
operator|.
name|b_1
operator|=
name|bchkget
argument_list|(
name|inkdot
argument_list|(
name|incp
argument_list|)
argument_list|,
name|idsp
argument_list|)
expr_stmt|;
operator|++
name|incp
expr_stmt|;
name|d
operator|.
name|b_2
operator|=
name|bchkget
argument_list|(
name|inkdot
argument_list|(
name|incp
argument_list|)
argument_list|,
name|idsp
argument_list|)
expr_stmt|;
operator|++
name|incp
expr_stmt|;
name|d
operator|.
name|b_3
operator|=
name|bchkget
argument_list|(
name|inkdot
argument_list|(
name|incp
argument_list|)
argument_list|,
name|idsp
argument_list|)
expr_stmt|;
operator|++
name|incp
expr_stmt|;
name|fmat
operator|=
name|fmtR
expr_stmt|;
goto|goto
name|disp
goto|;
block|}
block|}
else|else
block|{
comment|/* short literal */
name|vvar
index|[
name|i
index|]
operator|=
name|b
expr_stmt|;
if|if
condition|(
operator|(
operator|*
name|ap
operator|&
literal|7
operator|)
operator|==
name|TYPF
operator|||
operator|(
operator|*
name|ap
operator|&
literal|7
operator|)
operator|==
name|TYPD
condition|)
name|printf
argument_list|(
literal|"$%s"
argument_list|,
name|fltimm
index|[
name|b
index|]
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"$%d"
argument_list|,
name|b
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ins
operator|==
literal|0xCF
operator|||
name|ins
operator|==
literal|0xAF
operator|||
name|ins
operator|==
literal|0x8F
condition|)
block|{
comment|/* CASEx instr */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<=
name|vvar
index|[
literal|2
index|]
condition|;
operator|++
name|i
control|)
block|{
name|printc
argument_list|(
name|EOR
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"    %d:  "
argument_list|,
name|i
operator|+
name|vvar
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|d
operator|=
name|get
argument_list|(
name|inkdot
argument_list|(
name|incp
operator|+
name|i
operator|+
name|i
argument_list|)
argument_list|,
name|idsp
argument_list|)
operator|&
literal|0xFFFF
expr_stmt|;
if|if
condition|(
name|d
operator|&
literal|0x8000
condition|)
name|d
operator|-=
literal|0x10000
expr_stmt|;
name|psymoff
argument_list|(
name|inkdot
argument_list|(
name|incp
argument_list|)
operator|+
name|d
argument_list|,
name|type
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
block|}
name|incp
operator|+=
name|vvar
index|[
literal|2
index|]
operator|+
name|vvar
index|[
literal|2
index|]
operator|+
literal|2
expr_stmt|;
block|}
name|oincr
operator|=
name|incp
expr_stmt|;
block|}
end_block

begin_function
name|L_INT
name|inkdot
parameter_list|(
name|incr
parameter_list|)
block|{
name|L_INT
name|newdot
decl_stmt|;
name|newdot
operator|=
name|dot
operator|+
name|incr
expr_stmt|;
return|return
operator|(
name|newdot
operator|)
return|;
block|}
end_function

begin_macro
name|printc
argument_list|(
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|char
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
literal|"%c"
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|psymoff
argument_list|(
argument|v
argument_list|,
argument|r
argument_list|,
argument|fmt
argument_list|)
end_macro

begin_decl_stmt
name|L_INT
name|v
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|fmt
decl_stmt|,
modifier|*
modifier|*
name|r
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|proct
modifier|*
name|procp
decl_stmt|;
specifier|register
name|int
name|diff
decl_stmt|;
if|if
condition|(
name|fmt
operator|==
literal|'i'
condition|)
block|{
if|if
condition|(
name|r
operator|==
name|regname
operator|+
literal|12
condition|)
block|{
comment|/* parameter */
if|if
condition|(
operator|(
name|diff
operator|=
name|adrtoparam
argument_list|(
operator|(
name|ADDR
operator|)
name|v
argument_list|,
name|adrtoprocp
argument_list|(
name|dot
argument_list|)
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|sl_name
argument_list|)
expr_stmt|;
name|prdiff
argument_list|(
name|diff
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
if|if
condition|(
name|r
operator|==
name|regname
operator|+
literal|13
condition|)
block|{
comment|/* local */
if|if
condition|(
operator|(
name|diff
operator|=
name|adrtolocal
argument_list|(
operator|(
name|ADDR
operator|)
operator|-
name|v
argument_list|,
name|adrtoprocp
argument_list|(
name|dot
argument_list|)
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|sl_name
argument_list|)
expr_stmt|;
name|prdiff
argument_list|(
name|diff
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
if|if
condition|(
name|v
operator|<
name|firstdata
condition|)
block|{
if|if
condition|(
operator|(
name|procp
operator|=
name|adrtoprocp
argument_list|(
operator|(
name|ADDR
operator|)
name|v
argument_list|)
operator|)
operator|!=
name|badproc
condition|)
block|{
name|prlnoff
argument_list|(
name|procp
argument_list|,
name|v
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
else|else
block|{
if|if
condition|(
operator|(
name|diff
operator|=
name|adrtoext
argument_list|(
operator|(
name|ADDR
operator|)
name|v
argument_list|)
operator|)
operator|!=
operator|-
literal|1
condition|)
block|{
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|sl_name
argument_list|)
expr_stmt|;
name|prdiff
argument_list|(
name|diff
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
name|prhex
argument_list|(
name|v
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|prdiff
argument_list|(
argument|diff
argument_list|)
end_macro

begin_block
block|{
if|if
condition|(
name|diff
condition|)
block|{
name|printf
argument_list|(
literal|"+"
argument_list|)
expr_stmt|;
name|prhex
argument_list|(
name|diff
argument_list|)
expr_stmt|;
block|}
block|}
end_block

end_unit


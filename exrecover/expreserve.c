begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|FNSIZE
value|64
end_define

begin_comment
comment|/*  * Expreserve - preserve a file in /usr/preserve  * Bill Joy UCB November 13, 1977  *  * This routine is very naive - it doesn't remove anything from  * /usr/preserve... this may mean that we will be unable to preserve  * stuff there... the danger in doing anything with /usr/preserve  * is that the clock may be screwed up and we may get confused.  *  * We are called in two ways - first from the editor with no argumentss  * and the standard input open on the temp file. Second with an argument  * to preserve the entire contents of /tmp (root only).  */
end_comment

begin_struct
struct|struct
name|stbuff
block|{
name|char
name|major
decl_stmt|,
name|minor
decl_stmt|;
name|int
name|inumber
decl_stmt|;
name|int
name|flags
decl_stmt|;
name|char
name|nlinks
decl_stmt|;
name|char
name|uid
decl_stmt|,
name|gid
decl_stmt|;
name|char
name|size0
decl_stmt|;
name|int
name|size1
decl_stmt|;
name|int
name|addr
index|[
literal|8
index|]
decl_stmt|;
name|long
name|actime
decl_stmt|,
name|modtime
decl_stmt|;
block|}
name|stbuff
struct|;
end_struct

begin_expr_stmt
name|int
name|mask
literal|0377
expr_stmt|;
end_expr_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|int
name|tf
decl_stmt|;
struct|struct
block|{
name|int
name|inum
decl_stmt|;
name|char
name|name
index|[
literal|16
index|]
decl_stmt|;
block|}
name|dirent
struct|;
name|char
name|name
index|[
literal|30
index|]
decl_stmt|;
if|if
condition|(
name|argc
operator|==
literal|1
condition|)
block|{
if|if
condition|(
name|copyout
argument_list|(
literal|0
argument_list|)
condition|)
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|getuid
argument_list|()
operator|&
name|mask
condition|)
block|{
name|write
argument_list|(
literal|2
argument_list|,
literal|"NOT super user\n"
argument_list|,
literal|15
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|chdir
argument_list|(
literal|"/tmp"
argument_list|)
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"/tmp"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|tf
operator|=
name|open
argument_list|(
literal|"."
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|tf
operator|<
literal|0
condition|)
block|{
name|perror
argument_list|(
literal|"/tmp"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|dirent
operator|.
name|name
index|[
literal|14
index|]
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|read
argument_list|(
name|tf
argument_list|,
operator|&
name|dirent
argument_list|,
sizeof|sizeof
name|dirent
operator|-
literal|2
argument_list|)
operator|==
sizeof|sizeof
name|dirent
operator|-
literal|2
condition|)
block|{
if|if
condition|(
name|dirent
operator|.
name|inum
operator|==
literal|0
condition|)
continue|continue;
define|#
directive|define
name|eq
parameter_list|(
name|a
parameter_list|,
name|b
parameter_list|)
value|strcmp(a, b) == 0
if|if
condition|(
name|eq
argument_list|(
name|dirent
operator|.
name|name
argument_list|,
literal|"."
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|eq
argument_list|(
name|dirent
operator|.
name|name
argument_list|,
literal|".."
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|eq
argument_list|(
name|dirent
operator|.
name|name
argument_list|,
literal|".q"
argument_list|)
condition|)
continue|continue;
if|if
condition|(
name|stat
argument_list|(
name|dirent
operator|.
name|name
argument_list|,
operator|&
name|stbuff
argument_list|)
condition|)
continue|continue;
if|if
condition|(
operator|(
name|stbuff
operator|.
name|flags
operator|&
literal|060000
operator|)
operator|!=
literal|0
condition|)
continue|continue;
if|if
condition|(
name|dirent
operator|.
name|name
index|[
literal|0
index|]
operator|!=
literal|'E'
operator|||
name|dirent
operator|.
name|name
index|[
literal|1
index|]
operator|!=
literal|'x'
condition|)
continue|continue;
name|copyout
argument_list|(
name|dirent
operator|.
name|name
argument_list|)
expr_stmt|;
block|}
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_expr_stmt
name|char
name|pattern
index|[]
literal|"/usr/preserve/Exaa`XXXXX"
expr_stmt|;
end_expr_stmt

begin_macro
name|copyout
argument_list|(
argument|name
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|int
name|i
decl_stmt|;
specifier|static
name|char
name|reenter
decl_stmt|;
name|char
name|buf
index|[
literal|512
index|]
decl_stmt|;
struct|struct
name|header
block|{
name|int
name|Atime
index|[
literal|2
index|]
decl_stmt|;
name|int
name|Auid
decl_stmt|;
name|int
name|Alines
decl_stmt|;
name|int
name|Afname
index|[
name|FNSIZE
index|]
decl_stmt|;
name|int
name|Ablocks
index|[
literal|100
index|]
decl_stmt|;
block|}
name|header
struct|;
name|char
modifier|*
name|cp
decl_stmt|;
if|if
condition|(
name|reenter
operator|==
literal|0
condition|)
block|{
name|mkdigits
argument_list|(
name|pattern
argument_list|)
expr_stmt|;
name|reenter
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|name
operator|!=
literal|0
condition|)
block|{
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|open
argument_list|(
name|name
argument_list|,
literal|2
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
name|seek
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
literal|0
argument_list|,
operator|&
name|header
argument_list|,
sizeof|sizeof
name|header
argument_list|)
operator|!=
sizeof|sizeof
name|header
condition|)
block|{
name|format
label|:
if|if
condition|(
name|name
operator|==
literal|0
condition|)
name|write
argument_list|(
literal|2
argument_list|,
literal|"Buffer format error\n"
argument_list|,
literal|20
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|header
operator|.
name|Alines
operator|<
literal|0
condition|)
goto|goto
name|format
goto|;
if|if
condition|(
name|header
operator|.
name|Ablocks
index|[
literal|0
index|]
operator|!=
literal|1
operator|||
name|header
operator|.
name|Ablocks
index|[
literal|1
index|]
operator|!=
literal|2
condition|)
goto|goto
name|format
goto|;
if|if
condition|(
name|name
operator|==
literal|0
operator|&&
name|header
operator|.
name|Auid
operator|!=
operator|(
name|getuid
argument_list|()
operator|&
name|mask
operator|)
condition|)
goto|goto
name|format
goto|;
if|if
condition|(
name|seek
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
condition|)
goto|goto
name|format
goto|;
if|if
condition|(
name|header
operator|.
name|Afname
index|[
literal|0
index|]
operator|==
literal|0
condition|)
block|{
name|strcpy
argument_list|(
name|header
operator|.
name|Afname
argument_list|,
literal|"LOST"
argument_list|)
expr_stmt|;
name|write
argument_list|(
literal|0
argument_list|,
operator|&
name|header
argument_list|,
sizeof|sizeof
name|header
argument_list|)
expr_stmt|;
name|header
operator|.
name|Afname
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|seek
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
name|mknext
argument_list|(
name|pattern
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|creat
argument_list|(
name|pattern
argument_list|,
literal|0600
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|name
operator|==
literal|0
condition|)
name|perror
argument_list|(
name|pattern
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
name|chown
argument_list|(
name|pattern
argument_list|,
name|header
operator|.
name|Auid
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|i
operator|=
name|read
argument_list|(
literal|0
argument_list|,
name|buf
argument_list|,
literal|512
argument_list|)
expr_stmt|;
if|if
condition|(
name|i
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|name
condition|)
name|perror
argument_list|(
literal|"Buffer read error"
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|cp
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
if|if
condition|(
name|i
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|name
condition|)
block|{
name|unlink
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|notify
argument_list|(
name|header
operator|.
name|Auid
argument_list|,
name|header
operator|.
name|Afname
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
name|write
argument_list|(
literal|1
argument_list|,
name|buf
argument_list|,
name|i
argument_list|)
operator|!=
name|i
condition|)
block|{
if|if
condition|(
name|name
operator|==
literal|0
condition|)
name|perror
argument_list|(
name|pattern
argument_list|)
expr_stmt|;
name|unlink
argument_list|(
name|cp
argument_list|)
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
block|}
block|}
end_block

begin_macro
name|strcpy
argument_list|(
argument|to
argument_list|,
argument|from
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|to
decl_stmt|,
modifier|*
name|from
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|to
operator|++
operator|=
operator|*
name|from
operator|++
condition|)
continue|continue;
block|}
end_block

begin_expr_stmt
name|strcmp
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
specifier|register
name|char
operator|*
name|a
operator|,
operator|*
name|b
expr_stmt|;
end_expr_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|a
operator|&&
operator|*
name|b
operator|&&
operator|*
name|a
operator|==
operator|*
name|b
condition|)
name|a
operator|++
operator|,
name|b
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|a
operator|==
literal|0
operator|&&
operator|*
name|b
operator|==
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
operator|*
name|a
operator|-
operator|*
name|b
operator|)
return|;
block|}
end_block

begin_macro
name|mkdigits
argument_list|(
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|j
decl_stmt|;
for|for
control|(
name|i
operator|=
name|getpid
argument_list|()
operator|,
name|j
operator|=
literal|5
operator|,
name|cp
operator|=
operator|+
name|strlen
argument_list|(
name|cp
argument_list|)
init|;
name|j
operator|>
literal|0
condition|;
name|i
operator|=
operator|/
literal|10
operator|,
name|j
operator|--
control|)
operator|*
operator|--
name|cp
operator|=
name|i
operator|%
literal|10
operator||
literal|'0'
expr_stmt|;
block|}
end_block

begin_macro
name|mknext
argument_list|(
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|dcp
decl_stmt|;
name|int
name|spbuf
index|[
literal|18
index|]
decl_stmt|;
name|dcp
operator|=
name|cp
operator|+
name|strlen
argument_list|(
name|cp
argument_list|)
operator|-
literal|1
expr_stmt|;
while|while
condition|(
name|digit
argument_list|(
operator|*
name|dcp
argument_list|)
condition|)
name|dcp
operator|--
expr_stmt|;
name|whoops
label|:
if|if
condition|(
name|dcp
index|[
literal|0
index|]
operator|==
literal|'z'
condition|)
block|{
name|dcp
index|[
literal|0
index|]
operator|=
literal|'a'
expr_stmt|;
if|if
condition|(
name|dcp
index|[
operator|-
literal|1
index|]
operator|==
literal|'z'
condition|)
block|{
name|dcp
index|[
operator|-
literal|1
index|]
operator|=
literal|'a'
expr_stmt|;
if|if
condition|(
name|dcp
index|[
operator|-
literal|2
index|]
operator|==
literal|'z'
condition|)
name|write
argument_list|(
literal|2
argument_list|,
literal|"Can't find a name\n"
argument_list|,
literal|17
argument_list|)
expr_stmt|;
name|dcp
index|[
operator|-
literal|2
index|]
operator|++
expr_stmt|;
block|}
else|else
name|dcp
index|[
operator|-
literal|1
index|]
operator|++
expr_stmt|;
block|}
else|else
name|dcp
index|[
literal|0
index|]
operator|++
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|cp
argument_list|,
name|spbuf
argument_list|)
operator|==
literal|0
condition|)
goto|goto
name|whoops
goto|;
block|}
end_block

begin_macro
name|digit
argument_list|(
argument|c
argument_list|)
end_macro

begin_decl_stmt
name|char
name|c
decl_stmt|;
end_decl_stmt

begin_block
block|{
return|return
operator|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
operator|)
return|;
block|}
end_block

begin_macro
name|notify
argument_list|(
argument|nuid
argument_list|,
argument|nfname
argument_list|)
end_macro

begin_decl_stmt
name|int
name|nuid
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|nfname
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|;
name|char
name|pwbuf
index|[
literal|512
index|]
decl_stmt|;
name|int
name|pid
decl_stmt|,
name|pvec
index|[
literal|2
index|]
decl_stmt|;
specifier|extern
name|int
name|fout
decl_stmt|;
if|if
condition|(
name|getpw
argument_list|(
name|nuid
argument_list|,
name|pwbuf
argument_list|)
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
name|pipe
argument_list|(
name|pvec
argument_list|)
operator|<
literal|0
condition|)
return|return;
for|for
control|(
name|cp
operator|=
name|pwbuf
init|;
operator|*
name|cp
operator|&&
operator|*
name|cp
operator|!=
literal|':'
condition|;
name|cp
operator|++
control|)
continue|continue;
operator|*
name|cp
operator|=
literal|0
expr_stmt|;
name|pid
operator|=
name|fork
argument_list|()
expr_stmt|;
if|if
condition|(
name|pid
operator|<
literal|0
condition|)
return|return;
if|if
condition|(
name|pid
operator|==
literal|0
condition|)
block|{
name|close
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pvec
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|dup
argument_list|(
name|pvec
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|pvec
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|close
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|dup
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/bin/mail"
argument_list|,
literal|"mail"
argument_list|,
name|pwbuf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|execl
argument_list|(
literal|"/usr/bin/mail"
argument_list|,
literal|"mail"
argument_list|,
name|pwbuf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|read
argument_list|(
literal|0
argument_list|,
operator|&
name|pwbuf
argument_list|,
literal|512
argument_list|)
operator|>
literal|0
condition|)
continue|continue;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|close
argument_list|(
name|pvec
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|fout
operator|=
name|pvec
index|[
literal|1
index|]
expr_stmt|;
if|if
condition|(
name|nfname
index|[
literal|0
index|]
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|"A copy of an editor buffer of yours was saved when the system went down.\n\ No name was associated with this buffer so it has been named \"LOST\".\n"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"A copy of an editor buffer of your file \"%s\"\n\ was saved when the system went down.\n"
argument_list|,
name|nfname
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"This buffer can be retrieved using the \"recover\" command of the editor.\n\ For more information enter the editor (edit or ex) and type \"help recover\".\n"
argument_list|)
expr_stmt|;
name|flush
argument_list|()
expr_stmt|;
name|close
argument_list|(
name|pvec
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|wait
argument_list|()
expr_stmt|;
block|}
end_block

end_unit


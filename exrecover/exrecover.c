begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"ex.h"
end_include

begin_include
include|#
directive|include
file|"ex_io.h"
end_include

begin_comment
comment|/*  * Ex recovery program - "exrecover dir name"  * Bill Joy UCB October 1977  *  * This program searches through the specified directory and then  * the directory /usr/preserve looking for an instance of the specified  * file from a crashed editor or a crashed system.  * If this file is found, it is unscrambled and written to  * the standard output.  * This program normally lives in /usr/lib/exrecover, and is invoked  * by the ex "recover" command.  * If this program terminates without a "broken pipe" diagnostic  * (i.e. the editor doesn't die right away) then the buffer we are  * writing from is removed when we finish.  This is potentially a mistake  * as there is not enough handshaking to guarantee that the file has actually  * been recovered, but should suffice for most cases.  */
end_comment

begin_decl_stmt
name|char
name|nabuf
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|iblock
decl_stmt|,
name|oblock
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|int
name|mask
literal|0377
expr_stmt|;
end_expr_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
name|argv
index|[]
decl_stmt|;
block|{
name|char
modifier|*
name|cp
decl_stmt|;
specifier|extern
name|int
name|tfile
decl_stmt|,
name|fout
decl_stmt|;
name|int
name|b
decl_stmt|,
name|i
decl_stmt|;
name|fout
operator|=
literal|2
expr_stmt|;
name|fendcore
operator|=
name|sbrk
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|dot
operator|=
name|zero
operator|=
name|dol
operator|=
name|fendcore
expr_stmt|;
name|one
operator|=
name|zero
operator|+
literal|1
expr_stmt|;
name|endcore
operator|=
name|fendcore
operator|-
literal|2
expr_stmt|;
name|iblock
operator|=
name|oblock
operator|=
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|argc
operator|!=
literal|3
condition|)
name|error
argument_list|(
literal|" Wrong number of arguments to exrecover"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|file
argument_list|,
name|argv
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
name|findtmp
argument_list|(
name|argv
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|cp
operator|=
name|ctime
argument_list|(
name|header
operator|.
name|Atime
argument_list|)
expr_stmt|;
name|cp
index|[
literal|19
index|]
operator|=
literal|0
expr_stmt|;
name|fout
operator|=
literal|2
expr_stmt|;
name|printf
argument_list|(
literal|" [Dated: %s]"
argument_list|,
name|cp
argument_list|)
expr_stmt|;
name|header
operator|.
name|Alines
operator|++
expr_stmt|;
if|if
condition|(
name|sbrk
argument_list|(
name|header
operator|.
name|Alines
operator|*
literal|2
argument_list|)
operator|==
operator|-
literal|1
condition|)
name|error
argument_list|(
literal|" Not enough core for lines"
argument_list|)
expr_stmt|;
for|for
control|(
name|b
operator|=
literal|0
init|;
name|header
operator|.
name|Alines
operator|>
literal|0
condition|;
name|b
operator|++
operator|,
name|header
operator|.
name|Alines
operator|=
operator|-
literal|256
control|)
block|{
name|seek
argument_list|(
name|tfile
argument_list|,
name|blocks
index|[
name|b
index|]
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|i
operator|=
name|header
operator|.
name|Alines
operator|<
literal|256
condition|?
name|header
operator|.
name|Alines
operator|*
literal|2
else|:
literal|512
expr_stmt|;
if|if
condition|(
name|read
argument_list|(
name|tfile
argument_list|,
name|dot
argument_list|,
name|i
argument_list|)
operator|!=
name|i
condition|)
name|ioerror
argument_list|()
expr_stmt|;
name|dot
operator|=
operator|+
name|i
operator|/
literal|2
expr_stmt|;
block|}
name|dot
operator|--
expr_stmt|;
name|dol
operator|=
name|dot
expr_stmt|;
name|scrapbad
argument_list|()
expr_stmt|;
if|if
condition|(
name|dol
operator|>
name|zero
condition|)
block|{
name|addr1
operator|=
name|one
expr_stmt|;
name|addr2
operator|=
name|dol
expr_stmt|;
name|io
operator|=
literal|1
expr_stmt|;
name|putfile
argument_list|()
expr_stmt|;
block|}
name|unlink
argument_list|(
name|nabuf
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_macro
name|error
argument_list|(
argument|str
argument_list|,
argument|inf
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|str
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|printf
argument_list|(
name|str
argument_list|,
name|inf
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Routines to keep ex_io.c happy  */
end_comment

begin_decl_stmt
name|struct
name|varbl
name|varbls
index|[
literal|1
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* sham */
end_comment

begin_macro
name|strcpy
argument_list|(
argument|to
argument_list|,
argument|from
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|to
decl_stmt|,
modifier|*
name|from
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|ato
decl_stmt|;
name|ato
operator|=
name|to
expr_stmt|;
while|while
condition|(
operator|*
name|to
operator|++
operator|=
operator|*
name|from
operator|++
condition|)
continue|continue;
return|return
operator|(
name|ato
operator|)
return|;
block|}
end_block

begin_macro
name|strcat
argument_list|(
argument|after
argument_list|,
argument|what
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|after
decl_stmt|,
modifier|*
name|what
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|both
decl_stmt|;
name|both
operator|=
name|after
expr_stmt|;
while|while
condition|(
operator|*
name|after
condition|)
name|after
operator|++
expr_stmt|;
name|strcpy
argument_list|(
name|after
argument_list|,
name|what
argument_list|)
expr_stmt|;
return|return
operator|(
name|both
operator|)
return|;
block|}
end_block

begin_macro
name|lprintf
argument_list|(
argument|a1
argument_list|,
argument|a2
argument_list|,
argument|a3
argument_list|)
end_macro

begin_block
block|{
name|printf
argument_list|(
name|a1
argument_list|,
name|a2
argument_list|,
name|a3
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|change
argument_list|()
end_macro

begin_block
block|{
comment|/* more sham */
block|}
end_block

begin_macro
name|strcmp
argument_list|(
argument|cp
argument_list|,
argument|dp
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|dp
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|cp
operator|&&
operator|*
name|dp
operator|&&
operator|*
name|cp
operator|==
operator|*
name|dp
condition|)
name|cp
operator|++
operator|,
name|dp
operator|++
expr_stmt|;
return|return
operator|(
operator|*
name|cp
operator|-
operator|*
name|dp
operator|)
return|;
block|}
end_block

begin_macro
name|findtmp
argument_list|(
argument|dir
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dir
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|searchdir
argument_list|(
name|dir
argument_list|)
condition|)
return|return;
if|if
condition|(
name|searchdir
argument_list|(
literal|"/usr/preserve"
argument_list|)
condition|)
return|return;
name|error
argument_list|(
literal|" File not found"
argument_list|)
expr_stmt|;
block|}
end_block

begin_macro
name|searchdir
argument_list|(
argument|dirname
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dirname
decl_stmt|;
end_decl_stmt

begin_block
block|{
struct|struct
name|dirent
block|{
name|int
name|ino
decl_stmt|;
name|char
name|xxxx
index|[
literal|14
index|]
decl_stmt|;
block|}
name|dirent0
struct|;
struct|struct
block|{
name|int
name|ino
decl_stmt|;
name|char
name|name
index|[
literal|16
index|]
decl_stmt|;
block|}
name|dirent
struct|;
name|int
name|dir
decl_stmt|;
name|dir
operator|=
name|open
argument_list|(
name|dirname
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|dir
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
while|while
condition|(
name|read
argument_list|(
name|dir
argument_list|,
operator|&
name|dirent
argument_list|,
sizeof|sizeof
name|dirent0
argument_list|)
operator|==
sizeof|sizeof
name|dirent0
condition|)
block|{
if|if
condition|(
name|dirent
operator|.
name|ino
operator|==
literal|0
condition|)
continue|continue;
if|if
condition|(
name|dirent
operator|.
name|name
index|[
literal|0
index|]
operator|!=
literal|'E'
condition|)
continue|continue;
name|strcpy
argument_list|(
name|nabuf
argument_list|,
name|dirname
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|nabuf
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
name|strcat
argument_list|(
name|nabuf
argument_list|,
name|dirent
operator|.
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|yeah
argument_list|(
name|nabuf
argument_list|)
condition|)
block|{
name|close
argument_list|(
name|dir
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
block|}
name|close
argument_list|(
name|dir
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_macro
name|yeah
argument_list|(
argument|name
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|name
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|extern
name|int
name|tfile
decl_stmt|;
name|tfile
operator|=
name|open
argument_list|(
name|name
argument_list|,
literal|2
argument_list|)
expr_stmt|;
if|if
condition|(
name|tfile
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|read
argument_list|(
name|tfile
argument_list|,
operator|&
name|header
argument_list|,
sizeof|sizeof
name|header
argument_list|)
operator|!=
sizeof|sizeof
name|header
condition|)
block|{
name|nope
label|:
name|close
argument_list|(
name|tfile
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
if|if
condition|(
operator|!
name|eq
argument_list|(
name|savedfile
argument_list|,
name|file
argument_list|)
condition|)
goto|goto
name|nope
goto|;
if|if
condition|(
operator|(
name|getuid
argument_list|()
operator|&
name|mask
operator|)
operator|!=
name|header
operator|.
name|Auid
condition|)
goto|goto
name|nope
goto|;
name|seek
argument_list|(
name|tfile
argument_list|,
literal|504
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|write
argument_list|(
name|tfile
argument_list|,
literal|"LOST"
argument_list|,
literal|5
argument_list|)
expr_stmt|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_macro
name|putnl
argument_list|()
end_macro

begin_block
block|{
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_block

begin_decl_stmt
name|char
name|TTYNAM
index|[
literal|20
index|]
decl_stmt|;
end_decl_stmt

begin_macro
name|preserve
argument_list|()
end_macro

begin_block
block|{  }
end_block

begin_macro
name|strend
argument_list|(
argument|cp
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|cp
decl_stmt|;
end_decl_stmt

begin_block
block|{
while|while
condition|(
operator|*
name|cp
condition|)
name|cp
operator|++
expr_stmt|;
return|return
operator|(
name|cp
operator|)
return|;
block|}
end_block

begin_macro
name|scrapbad
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
modifier|*
name|ip
decl_stmt|;
name|char
modifier|*
name|jp
decl_stmt|;
name|struct
name|stb
name|stbuf
decl_stmt|;
name|long
name|size
decl_stmt|;
name|int
name|bno
decl_stmt|,
name|cnt
decl_stmt|,
name|bad
decl_stmt|,
name|was
decl_stmt|;
name|char
name|bk
index|[
literal|512
index|]
decl_stmt|,
modifier|*
name|maxt
decl_stmt|;
specifier|static
name|char
name|header
decl_stmt|;
specifier|extern
name|int
name|fout
decl_stmt|;
name|fout
operator|=
literal|2
expr_stmt|;
name|fstat
argument_list|(
name|tfile
argument_list|,
operator|&
name|stbuf
argument_list|)
expr_stmt|;
name|size
operator|=
name|stbuf
operator|.
name|size0
operator|&
literal|0377
expr_stmt|;
name|size
operator|=
operator|<<
literal|16
expr_stmt|;
name|size
operator|=
operator||
name|stbuf
operator|.
name|size1
expr_stmt|;
name|maxt
operator|=
operator|(
name|size
operator|>>
literal|2
operator|)
operator||
literal|7
expr_stmt|;
name|bno
operator|=
operator|(
name|maxt
operator|>>
literal|7
operator|)
operator|&
literal|0777
expr_stmt|;
comment|/* 	printf("size %ld, maxt %o, bno %d\n", size, maxt, bno); */
while|while
condition|(
name|bno
operator|>
literal|0
condition|)
block|{
name|seek
argument_list|(
name|tfile
argument_list|,
name|bno
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|cnt
operator|=
name|read
argument_list|(
name|tfile
argument_list|,
name|bk
argument_list|,
literal|512
argument_list|)
expr_stmt|;
while|while
condition|(
name|cnt
operator|>
literal|0
condition|)
if|if
condition|(
name|bk
index|[
operator|--
name|cnt
index|]
operator|==
literal|0
condition|)
goto|goto
name|null
goto|;
name|bno
operator|--
expr_stmt|;
block|}
name|null
label|:
name|maxt
operator|=
operator|(
operator|(
name|bno
operator|<<
literal|7
operator|)
operator||
operator|(
name|cnt
operator|>>
literal|2
operator|)
operator|)
operator|&
literal|0177776
expr_stmt|;
comment|/* 	printf("bno %d, cnt %d, maxt %o\n", bno, cnt, maxt); */
name|was
operator|=
name|bad
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|ip
operator|=
name|one
init|;
name|ip
operator|<=
name|dol
condition|;
name|ip
operator|++
control|)
if|if
condition|(
operator|*
name|ip
operator|>
name|maxt
condition|)
block|{
comment|/* 			printf("%d bad, %o> %o\n", ip - zero, *ip, maxt); */
if|if
condition|(
name|was
operator|==
literal|0
condition|)
name|was
operator|=
name|ip
operator|-
name|zero
expr_stmt|;
operator|*
name|ip
operator|=
literal|0176
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|was
condition|)
block|{
if|if
condition|(
name|bad
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|" [Lost line(s):"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %d"
argument_list|,
name|was
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ip
operator|-
literal|1
operator|)
operator|-
name|zero
operator|>
name|was
condition|)
name|printf
argument_list|(
literal|"-%d"
argument_list|,
operator|(
name|ip
operator|-
literal|1
operator|)
operator|-
name|zero
argument_list|)
expr_stmt|;
name|bad
operator|++
expr_stmt|;
name|was
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|was
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|bad
operator|==
literal|0
condition|)
name|printf
argument_list|(
literal|" [Lost line(s):"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" %d"
argument_list|,
name|was
argument_list|)
expr_stmt|;
if|if
condition|(
name|dol
operator|-
name|zero
operator|!=
name|was
condition|)
name|printf
argument_list|(
literal|"-%d"
argument_list|,
name|dol
operator|-
name|zero
argument_list|)
expr_stmt|;
name|bad
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|bad
condition|)
name|putchar
argument_list|(
literal|']'
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 2006 Kungliga Tekniska HÃ¶gskolan  * (Royal Institute of Technology, Stockholm, Sweden).   * All rights reserved.   *  * Redistribution and use in source and binary forms, with or without   * modification, are permitted provided that the following conditions   * are met:   *  * 1. Redistributions of source code must retain the above copyright   *    notice, this list of conditions and the following disclaimer.   *  * 2. Redistributions in binary form must reproduce the above copyright   *    notice, this list of conditions and the following disclaimer in the   *    documentation and/or other materials provided with the distribution.   *  * 3. Neither the name of KTH nor the names of its contributors may be  *    used to endorse or promote products derived from this software without  *    specific prior written permission.  *  * THIS SOFTWARE IS PROVIDED BY KTH AND ITS CONTRIBUTORS ``AS IS'' AND ANY  * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE  * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR  * PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL KTH OR ITS CONTRIBUTORS BE  * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR  * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF  * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR  * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,  * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR  * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF  * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  */
end_comment

begin_include
include|#
directive|include
file|"common.h"
end_include

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id: gssmask.c 21229 2007-06-20 10:19:19Z lha $"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_comment
comment|/*  *  */
end_comment

begin_enum
enum|enum
name|handle_type
block|{
name|handle_context
block|,
name|handle_cred
block|}
enum|;
end_enum

begin_struct
struct|struct
name|handle
block|{
name|int32_t
name|idx
decl_stmt|;
name|enum
name|handle_type
name|type
decl_stmt|;
name|void
modifier|*
name|ptr
decl_stmt|;
name|struct
name|handle
modifier|*
name|next
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|client
block|{
name|krb5_storage
modifier|*
name|sock
decl_stmt|;
name|krb5_storage
modifier|*
name|logging
decl_stmt|;
name|char
modifier|*
name|moniker
decl_stmt|;
name|int32_t
name|nHandle
decl_stmt|;
name|struct
name|handle
modifier|*
name|handles
decl_stmt|;
name|struct
name|sockaddr_storage
name|sa
decl_stmt|;
name|socklen_t
name|salen
decl_stmt|;
name|char
name|servername
index|[
name|MAXHOSTNAMELEN
index|]
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
name|FILE
modifier|*
name|logfile
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|targetname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|krb5_context
name|context
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|void
name|logmessage
parameter_list|(
name|struct
name|client
modifier|*
name|c
parameter_list|,
specifier|const
name|char
modifier|*
name|file
parameter_list|,
name|unsigned
name|int
name|lineno
parameter_list|,
name|int
name|level
parameter_list|,
specifier|const
name|char
modifier|*
name|fmt
parameter_list|,
modifier|...
parameter_list|)
block|{
name|char
modifier|*
name|message
decl_stmt|;
name|va_list
name|ap
decl_stmt|;
name|int32_t
name|ackid
decl_stmt|;
name|va_start
argument_list|(
name|ap
argument_list|,
name|fmt
argument_list|)
expr_stmt|;
name|vasprintf
argument_list|(
operator|&
name|message
argument_list|,
name|fmt
argument_list|,
name|ap
argument_list|)
expr_stmt|;
name|va_end
argument_list|(
name|ap
argument_list|)
expr_stmt|;
if|if
condition|(
name|logfile
condition|)
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"%s:%u: %d %s\n"
argument_list|,
name|file
argument_list|,
name|lineno
argument_list|,
name|level
argument_list|,
name|message
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|logging
condition|)
block|{
if|if
condition|(
name|krb5_store_int32
argument_list|(
name|c
operator|->
name|logging
argument_list|,
name|eLogInfo
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_store_int32: log level"
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5_store_string
argument_list|(
name|c
operator|->
name|logging
argument_list|,
name|file
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_store_string: filename"
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5_store_int32
argument_list|(
name|c
operator|->
name|logging
argument_list|,
name|lineno
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_store_string: filename"
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5_store_string
argument_list|(
name|c
operator|->
name|logging
argument_list|,
name|message
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_store_string: message"
argument_list|)
expr_stmt|;
if|if
condition|(
name|krb5_ret_int32
argument_list|(
name|c
operator|->
name|logging
argument_list|,
operator|&
name|ackid
argument_list|)
operator|!=
literal|0
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_ret_int32: ackid"
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|message
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int32_t
name|add_handle
parameter_list|(
name|struct
name|client
modifier|*
name|c
parameter_list|,
name|enum
name|handle_type
name|type
parameter_list|,
name|void
modifier|*
name|data
parameter_list|)
block|{
name|struct
name|handle
modifier|*
name|h
decl_stmt|;
name|h
operator|=
name|ecalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|h
argument_list|)
argument_list|)
expr_stmt|;
name|h
operator|->
name|idx
operator|=
operator|++
name|c
operator|->
name|nHandle
expr_stmt|;
name|h
operator|->
name|type
operator|=
name|type
expr_stmt|;
name|h
operator|->
name|ptr
operator|=
name|data
expr_stmt|;
name|h
operator|->
name|next
operator|=
name|c
operator|->
name|handles
expr_stmt|;
name|c
operator|->
name|handles
operator|=
name|h
expr_stmt|;
return|return
name|h
operator|->
name|idx
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|del_handle
parameter_list|(
name|struct
name|handle
modifier|*
modifier|*
name|h
parameter_list|,
name|int32_t
name|idx
parameter_list|)
block|{
name|OM_uint32
name|min_stat
decl_stmt|;
if|if
condition|(
name|idx
operator|==
literal|0
condition|)
return|return;
while|while
condition|(
operator|*
name|h
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|h
operator|)
operator|->
name|idx
operator|==
name|idx
condition|)
block|{
name|struct
name|handle
modifier|*
name|p
init|=
operator|*
name|h
decl_stmt|;
operator|*
name|h
operator|=
operator|(
operator|*
name|h
operator|)
operator|->
name|next
expr_stmt|;
switch|switch
condition|(
name|p
operator|->
name|type
condition|)
block|{
case|case
name|handle_context
case|:
block|{
name|gss_ctx_id_t
name|c
init|=
name|p
operator|->
name|ptr
decl_stmt|;
name|gss_delete_sec_context
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|c
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
break|break;
block|}
case|case
name|handle_cred
case|:
block|{
name|gss_cred_id_t
name|c
init|=
name|p
operator|->
name|ptr
decl_stmt|;
name|gss_release_cred
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
name|free
argument_list|(
name|p
argument_list|)
expr_stmt|;
return|return;
block|}
name|h
operator|=
operator|&
operator|(
operator|(
operator|*
name|h
operator|)
operator|->
name|next
operator|)
expr_stmt|;
block|}
name|errx
argument_list|(
literal|1
argument_list|,
literal|"tried to delete an unexisting handle"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|find_handle
parameter_list|(
name|struct
name|handle
modifier|*
name|h
parameter_list|,
name|int32_t
name|idx
parameter_list|,
name|enum
name|handle_type
name|type
parameter_list|)
block|{
if|if
condition|(
name|idx
operator|==
literal|0
condition|)
return|return
name|NULL
return|;
while|while
condition|(
name|h
condition|)
block|{
if|if
condition|(
name|h
operator|->
name|idx
operator|==
name|idx
condition|)
block|{
if|if
condition|(
name|type
operator|==
name|h
operator|->
name|type
condition|)
return|return
name|h
operator|->
name|ptr
return|;
name|errx
argument_list|(
literal|1
argument_list|,
literal|"monger switched type on handle!"
argument_list|)
expr_stmt|;
block|}
name|h
operator|=
name|h
operator|->
name|next
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|int32_t
name|convert_gss_to_gsm
parameter_list|(
name|OM_uint32
name|maj_stat
parameter_list|)
block|{
switch|switch
condition|(
name|maj_stat
condition|)
block|{
case|case
literal|0
case|:
return|return
name|GSMERR_OK
return|;
case|case
name|GSS_S_CONTINUE_NEEDED
case|:
return|return
name|GSMERR_CONTINUE_NEEDED
return|;
case|case
name|GSS_S_DEFECTIVE_TOKEN
case|:
return|return
name|GSMERR_INVALID_TOKEN
return|;
case|case
name|GSS_S_BAD_MIC
case|:
return|return
name|GSMERR_AP_MODIFIED
return|;
default|default:
return|return
name|GSMERR_ERROR
return|;
block|}
block|}
end_function

begin_function
specifier|static
name|int32_t
name|convert_krb5_to_gsm
parameter_list|(
name|krb5_error_code
name|ret
parameter_list|)
block|{
switch|switch
condition|(
name|ret
condition|)
block|{
case|case
literal|0
case|:
return|return
name|GSMERR_OK
return|;
default|default:
return|return
name|GSMERR_ERROR
return|;
block|}
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int32_t
name|acquire_cred
parameter_list|(
name|struct
name|client
modifier|*
name|c
parameter_list|,
name|krb5_principal
name|principal
parameter_list|,
name|krb5_get_init_creds_opt
modifier|*
name|opt
parameter_list|,
name|int32_t
modifier|*
name|handle
parameter_list|)
block|{
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_creds
name|cred
decl_stmt|;
name|krb5_ccache
name|id
decl_stmt|;
name|gss_cred_id_t
name|gcred
decl_stmt|;
name|OM_uint32
name|maj_stat
decl_stmt|,
name|min_stat
decl_stmt|;
operator|*
name|handle
operator|=
literal|0
expr_stmt|;
name|krb5_get_init_creds_opt_set_forwardable
argument_list|(
name|opt
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|krb5_get_init_creds_opt_set_renew_life
argument_list|(
name|opt
argument_list|,
literal|3600
operator|*
literal|24
operator|*
literal|30
argument_list|)
expr_stmt|;
name|memset
argument_list|(
operator|&
name|cred
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|cred
argument_list|)
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_get_init_creds_password
argument_list|(
name|context
argument_list|,
operator|&
name|cred
argument_list|,
name|principal
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"krb5_get_init_creds failed: %d"
argument_list|,
name|ret
argument_list|)
expr_stmt|;
return|return
name|convert_krb5_to_gsm
argument_list|(
name|ret
argument_list|)
return|;
block|}
name|ret
operator|=
name|krb5_cc_new_unique
argument_list|(
name|context
argument_list|,
literal|"MEMORY"
argument_list|,
name|NULL
argument_list|,
operator|&
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_cc_initialize"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_cc_initialize
argument_list|(
name|context
argument_list|,
name|id
argument_list|,
name|cred
operator|.
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_cc_initialize"
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_cc_store_cred
argument_list|(
name|context
argument_list|,
name|id
argument_list|,
operator|&
name|cred
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_cc_store_cred"
argument_list|)
expr_stmt|;
name|krb5_free_cred_contents
argument_list|(
name|context
argument_list|,
operator|&
name|cred
argument_list|)
expr_stmt|;
name|maj_stat
operator|=
name|gss_krb5_import_cred
argument_list|(
operator|&
name|min_stat
argument_list|,
name|id
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|gcred
argument_list|)
expr_stmt|;
name|krb5_cc_close
argument_list|(
name|context
argument_list|,
name|id
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
condition|)
block|{
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"krb5 import creds failed with: %d"
argument_list|,
name|maj_stat
argument_list|)
expr_stmt|;
return|return
name|convert_gss_to_gsm
argument_list|(
name|maj_stat
argument_list|)
return|;
block|}
operator|*
name|handle
operator|=
name|add_handle
argument_list|(
name|c
argument_list|,
name|handle_cred
argument_list|,
name|gcred
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_define
define|#
directive|define
name|HandleOP
parameter_list|(
name|h
parameter_list|)
define|\
value|handle##h(enum gssMaggotOp op, struct client *c)
end_define

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|GetVersionInfo
parameter_list|)
block|{
name|put32
argument_list|(
name|c
argument_list|,
name|GSSMAGGOTPROTOCOL
argument_list|)
expr_stmt|;
name|errx
argument_list|(
literal|1
argument_list|,
literal|"GetVersionInfo"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|GoodBye
parameter_list|)
block|{
name|struct
name|handle
modifier|*
name|h
init|=
name|c
operator|->
name|handles
decl_stmt|;
name|int
name|i
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|h
condition|)
block|{
name|h
operator|=
name|h
operator|->
name|next
expr_stmt|;
name|i
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|i
operator|!=
literal|0
condition|)
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"Did not toast all resources: %d"
argument_list|,
name|i
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|InitContext
parameter_list|)
block|{
name|OM_uint32
name|maj_stat
decl_stmt|,
name|min_stat
decl_stmt|,
name|ret_flags
decl_stmt|;
name|int32_t
name|hContext
decl_stmt|,
name|hCred
decl_stmt|,
name|flags
decl_stmt|;
name|krb5_data
name|target_name
decl_stmt|,
name|in_token
decl_stmt|;
name|int32_t
name|new_context_id
init|=
literal|0
decl_stmt|,
name|gsm_error
init|=
literal|0
decl_stmt|;
name|krb5_data
name|out_token
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
name|gss_ctx_id_t
name|ctx
decl_stmt|;
name|gss_cred_id_t
name|creds
decl_stmt|;
name|gss_name_t
name|gss_target_name
decl_stmt|;
name|gss_buffer_desc
name|input_token
decl_stmt|,
name|output_token
decl_stmt|;
name|gss_OID
name|oid
init|=
name|GSS_C_NO_OID
decl_stmt|;
name|gss_buffer_t
name|input_token_ptr
init|=
name|GSS_C_NO_BUFFER
decl_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|hContext
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|hCred
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|retdata
argument_list|(
name|c
argument_list|,
name|target_name
argument_list|)
expr_stmt|;
name|retdata
argument_list|(
name|c
argument_list|,
name|in_token
argument_list|)
expr_stmt|;
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"targetname:<%.*s>"
argument_list|,
operator|(
name|int
operator|)
name|target_name
operator|.
name|length
argument_list|,
operator|(
name|char
operator|*
operator|)
name|target_name
operator|.
name|data
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|find_handle
argument_list|(
name|c
operator|->
name|handles
argument_list|,
name|hContext
argument_list|,
name|handle_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
name|hContext
operator|=
literal|0
expr_stmt|;
name|creds
operator|=
name|find_handle
argument_list|(
name|c
operator|->
name|handles
argument_list|,
name|hCred
argument_list|,
name|handle_cred
argument_list|)
expr_stmt|;
if|if
condition|(
name|creds
operator|==
name|NULL
condition|)
name|abort
argument_list|()
expr_stmt|;
name|input_token
operator|.
name|length
operator|=
name|target_name
operator|.
name|length
expr_stmt|;
name|input_token
operator|.
name|value
operator|=
name|target_name
operator|.
name|data
expr_stmt|;
name|maj_stat
operator|=
name|gss_import_name
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|input_token
argument_list|,
name|GSS_KRB5_NT_PRINCIPAL_NAME
argument_list|,
operator|&
name|gss_target_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|GSS_ERROR
argument_list|(
name|maj_stat
argument_list|)
condition|)
block|{
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"import name creds failed with: %d"
argument_list|,
name|maj_stat
argument_list|)
expr_stmt|;
name|gsm_error
operator|=
name|convert_gss_to_gsm
argument_list|(
name|maj_stat
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
comment|/* oid from flags */
if|if
condition|(
name|in_token
operator|.
name|length
condition|)
block|{
name|input_token
operator|.
name|length
operator|=
name|in_token
operator|.
name|length
expr_stmt|;
name|input_token
operator|.
name|value
operator|=
name|in_token
operator|.
name|data
expr_stmt|;
name|input_token_ptr
operator|=
operator|&
name|input_token
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"initcreds, context NULL, but not first req"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|input_token
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|input_token
operator|.
name|value
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|ctx
condition|)
name|krb5_errx
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
literal|"initcreds, context not NULL, but first req"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|flags
operator|&
name|GSS_C_DELEG_FLAG
operator|)
operator|!=
literal|0
condition|)
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"init_sec_context delegating"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|flags
operator|&
name|GSS_C_DCE_STYLE
operator|)
operator|!=
literal|0
condition|)
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"init_sec_context dce-style"
argument_list|)
expr_stmt|;
name|maj_stat
operator|=
name|gss_init_sec_context
argument_list|(
operator|&
name|min_stat
argument_list|,
name|creds
argument_list|,
operator|&
name|ctx
argument_list|,
name|gss_target_name
argument_list|,
name|oid
argument_list|,
name|flags
operator|&
literal|0x7f
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|input_token_ptr
argument_list|,
name|NULL
argument_list|,
operator|&
name|output_token
argument_list|,
operator|&
name|ret_flags
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|GSS_ERROR
argument_list|(
name|maj_stat
argument_list|)
condition|)
block|{
if|if
condition|(
name|hContext
operator|!=
literal|0
condition|)
name|del_handle
argument_list|(
operator|&
name|c
operator|->
name|handles
argument_list|,
name|hContext
argument_list|)
expr_stmt|;
name|new_context_id
operator|=
literal|0
expr_stmt|;
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"gss_init_sec_context returns code: %d/%d"
argument_list|,
name|maj_stat
argument_list|,
name|min_stat
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|input_token
operator|.
name|length
operator|==
literal|0
condition|)
name|new_context_id
operator|=
name|add_handle
argument_list|(
name|c
argument_list|,
name|handle_context
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
else|else
name|new_context_id
operator|=
name|hContext
expr_stmt|;
block|}
name|gsm_error
operator|=
name|convert_gss_to_gsm
argument_list|(
name|maj_stat
argument_list|)
expr_stmt|;
if|if
condition|(
name|output_token
operator|.
name|length
condition|)
block|{
name|out_token
operator|.
name|data
operator|=
name|output_token
operator|.
name|value
expr_stmt|;
name|out_token
operator|.
name|length
operator|=
name|output_token
operator|.
name|length
expr_stmt|;
block|}
name|out
label|:
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"InitContext return code: %d"
argument_list|,
name|gsm_error
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
name|new_context_id
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
name|gsm_error
argument_list|)
expr_stmt|;
name|putdata
argument_list|(
name|c
argument_list|,
name|out_token
argument_list|)
expr_stmt|;
name|gss_release_name
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|gss_target_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|output_token
operator|.
name|length
condition|)
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|output_token
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|in_token
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|target_name
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|AcceptContext
parameter_list|)
block|{
name|OM_uint32
name|maj_stat
decl_stmt|,
name|min_stat
decl_stmt|,
name|ret_flags
decl_stmt|;
name|int32_t
name|hContext
decl_stmt|,
name|deleg_hcred
decl_stmt|,
name|flags
decl_stmt|;
name|krb5_data
name|in_token
decl_stmt|;
name|int32_t
name|new_context_id
init|=
literal|0
decl_stmt|,
name|gsm_error
init|=
literal|0
decl_stmt|;
name|krb5_data
name|out_token
init|=
block|{
literal|0
block|,
name|NULL
block|}
decl_stmt|;
name|gss_ctx_id_t
name|ctx
decl_stmt|;
name|gss_cred_id_t
name|deleg_cred
init|=
name|GSS_C_NO_CREDENTIAL
decl_stmt|;
name|gss_buffer_desc
name|input_token
decl_stmt|,
name|output_token
decl_stmt|;
name|gss_buffer_t
name|input_token_ptr
init|=
name|GSS_C_NO_BUFFER
decl_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|hContext
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|retdata
argument_list|(
name|c
argument_list|,
name|in_token
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|find_handle
argument_list|(
name|c
operator|->
name|handles
argument_list|,
name|hContext
argument_list|,
name|handle_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
name|hContext
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|in_token
operator|.
name|length
condition|)
block|{
name|input_token
operator|.
name|length
operator|=
name|in_token
operator|.
name|length
expr_stmt|;
name|input_token
operator|.
name|value
operator|=
name|in_token
operator|.
name|data
expr_stmt|;
name|input_token_ptr
operator|=
operator|&
name|input_token
expr_stmt|;
block|}
else|else
block|{
name|input_token
operator|.
name|length
operator|=
literal|0
expr_stmt|;
name|input_token
operator|.
name|value
operator|=
name|NULL
expr_stmt|;
block|}
name|maj_stat
operator|=
name|gss_accept_sec_context
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|ctx
argument_list|,
name|GSS_C_NO_CREDENTIAL
argument_list|,
operator|&
name|input_token
argument_list|,
name|GSS_C_NO_CHANNEL_BINDINGS
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|output_token
argument_list|,
operator|&
name|ret_flags
argument_list|,
name|NULL
argument_list|,
operator|&
name|deleg_cred
argument_list|)
expr_stmt|;
if|if
condition|(
name|GSS_ERROR
argument_list|(
name|maj_stat
argument_list|)
condition|)
block|{
if|if
condition|(
name|hContext
operator|!=
literal|0
condition|)
name|del_handle
argument_list|(
operator|&
name|c
operator|->
name|handles
argument_list|,
name|hContext
argument_list|)
expr_stmt|;
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"gss_accept_sec_context returns code: %d/%d"
argument_list|,
name|maj_stat
argument_list|,
name|min_stat
argument_list|)
expr_stmt|;
name|new_context_id
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|hContext
operator|==
literal|0
condition|)
name|new_context_id
operator|=
name|add_handle
argument_list|(
name|c
argument_list|,
name|handle_context
argument_list|,
name|ctx
argument_list|)
expr_stmt|;
else|else
name|new_context_id
operator|=
name|hContext
expr_stmt|;
block|}
if|if
condition|(
name|output_token
operator|.
name|length
condition|)
block|{
name|out_token
operator|.
name|data
operator|=
name|output_token
operator|.
name|value
expr_stmt|;
name|out_token
operator|.
name|length
operator|=
name|output_token
operator|.
name|length
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|ret_flags
operator|&
name|GSS_C_DCE_STYLE
operator|)
operator|!=
literal|0
condition|)
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"accept_sec_context dce-style"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|ret_flags
operator|&
name|GSS_C_DELEG_FLAG
operator|)
operator|!=
literal|0
condition|)
block|{
name|deleg_hcred
operator|=
name|add_handle
argument_list|(
name|c
argument_list|,
name|handle_cred
argument_list|,
name|deleg_cred
argument_list|)
expr_stmt|;
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"accept_context delegated handle: %d"
argument_list|,
name|deleg_hcred
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|gss_release_cred
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|deleg_cred
argument_list|)
expr_stmt|;
name|deleg_hcred
operator|=
literal|0
expr_stmt|;
block|}
name|gsm_error
operator|=
name|convert_gss_to_gsm
argument_list|(
name|maj_stat
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
name|new_context_id
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
name|gsm_error
argument_list|)
expr_stmt|;
name|putdata
argument_list|(
name|c
argument_list|,
name|out_token
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
name|deleg_hcred
argument_list|)
expr_stmt|;
if|if
condition|(
name|output_token
operator|.
name|length
condition|)
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|output_token
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|in_token
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|ToastResource
parameter_list|)
block|{
name|int32_t
name|handle
decl_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|handle
argument_list|)
expr_stmt|;
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"toasting %d"
argument_list|,
name|handle
argument_list|)
expr_stmt|;
name|del_handle
argument_list|(
operator|&
name|c
operator|->
name|handles
argument_list|,
name|handle
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
name|GSMERR_OK
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|AcquireCreds
parameter_list|)
block|{
name|char
modifier|*
name|name
decl_stmt|,
modifier|*
name|password
decl_stmt|;
name|int32_t
name|gsm_error
decl_stmt|,
name|flags
decl_stmt|,
name|handle
init|=
literal|0
decl_stmt|;
name|krb5_principal
name|principal
init|=
name|NULL
decl_stmt|;
name|krb5_get_init_creds_opt
modifier|*
name|opt
init|=
name|NULL
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|retstring
argument_list|(
name|c
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|retstring
argument_list|(
name|c
argument_list|,
name|password
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"username: %s password: %s"
argument_list|,
name|name
argument_list|,
name|password
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_parse_name
argument_list|(
name|context
argument_list|,
name|name
argument_list|,
operator|&
name|principal
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|gsm_error
operator|=
name|convert_krb5_to_gsm
argument_list|(
name|ret
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
name|ret
operator|=
name|krb5_get_init_creds_opt_alloc
argument_list|(
name|context
argument_list|,
operator|&
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
name|krb5_err
argument_list|(
name|context
argument_list|,
literal|1
argument_list|,
name|ret
argument_list|,
literal|"krb5_get_init_creds_opt_alloc"
argument_list|)
expr_stmt|;
name|krb5_get_init_creds_opt_set_pa_password
argument_list|(
name|context
argument_list|,
name|opt
argument_list|,
name|password
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|gsm_error
operator|=
name|acquire_cred
argument_list|(
name|c
argument_list|,
name|principal
argument_list|,
name|opt
argument_list|,
operator|&
name|handle
argument_list|)
expr_stmt|;
name|out
label|:
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"AcquireCreds handle: %d return code: %d"
argument_list|,
name|handle
argument_list|,
name|gsm_error
argument_list|)
expr_stmt|;
if|if
condition|(
name|opt
condition|)
name|krb5_get_init_creds_opt_free
argument_list|(
name|context
argument_list|,
name|opt
argument_list|)
expr_stmt|;
if|if
condition|(
name|principal
condition|)
name|krb5_free_principal
argument_list|(
name|context
argument_list|,
name|principal
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|password
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
name|gsm_error
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
name|handle
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|Sign
parameter_list|)
block|{
name|OM_uint32
name|maj_stat
decl_stmt|,
name|min_stat
decl_stmt|;
name|int32_t
name|hContext
decl_stmt|,
name|flags
decl_stmt|,
name|seqno
decl_stmt|;
name|krb5_data
name|token
decl_stmt|;
name|gss_ctx_id_t
name|ctx
decl_stmt|;
name|gss_buffer_desc
name|input_token
decl_stmt|,
name|output_token
decl_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|hContext
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|seqno
argument_list|)
expr_stmt|;
name|retdata
argument_list|(
name|c
argument_list|,
name|token
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|find_handle
argument_list|(
name|c
operator|->
name|handles
argument_list|,
name|hContext
argument_list|,
name|handle_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"sign: reference to unknown context"
argument_list|)
expr_stmt|;
name|input_token
operator|.
name|length
operator|=
name|token
operator|.
name|length
expr_stmt|;
name|input_token
operator|.
name|value
operator|=
name|token
operator|.
name|data
expr_stmt|;
name|maj_stat
operator|=
name|gss_get_mic
argument_list|(
operator|&
name|min_stat
argument_list|,
name|ctx
argument_list|,
literal|0
argument_list|,
operator|&
name|input_token
argument_list|,
operator|&
name|output_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
operator|!=
name|GSS_S_COMPLETE
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"gss_get_mic failed"
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|token
argument_list|)
expr_stmt|;
name|token
operator|.
name|data
operator|=
name|output_token
operator|.
name|value
expr_stmt|;
name|token
operator|.
name|length
operator|=
name|output_token
operator|.
name|length
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX fix gsm_error */
name|putdata
argument_list|(
name|c
argument_list|,
name|token
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|output_token
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|Verify
parameter_list|)
block|{
name|OM_uint32
name|maj_stat
decl_stmt|,
name|min_stat
decl_stmt|;
name|int32_t
name|hContext
decl_stmt|,
name|flags
decl_stmt|,
name|seqno
decl_stmt|;
name|krb5_data
name|msg
decl_stmt|,
name|mic
decl_stmt|;
name|gss_ctx_id_t
name|ctx
decl_stmt|;
name|gss_buffer_desc
name|msg_token
decl_stmt|,
name|mic_token
decl_stmt|;
name|gss_qop_t
name|qop
decl_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|hContext
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|find_handle
argument_list|(
name|c
operator|->
name|handles
argument_list|,
name|hContext
argument_list|,
name|handle_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"verify: reference to unknown context"
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|seqno
argument_list|)
expr_stmt|;
name|retdata
argument_list|(
name|c
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|msg_token
operator|.
name|length
operator|=
name|msg
operator|.
name|length
expr_stmt|;
name|msg_token
operator|.
name|value
operator|=
name|msg
operator|.
name|data
expr_stmt|;
name|retdata
argument_list|(
name|c
argument_list|,
name|mic
argument_list|)
expr_stmt|;
name|mic_token
operator|.
name|length
operator|=
name|mic
operator|.
name|length
expr_stmt|;
name|mic_token
operator|.
name|value
operator|=
name|mic
operator|.
name|data
expr_stmt|;
name|maj_stat
operator|=
name|gss_verify_mic
argument_list|(
operator|&
name|min_stat
argument_list|,
name|ctx
argument_list|,
operator|&
name|msg_token
argument_list|,
operator|&
name|mic_token
argument_list|,
operator|&
name|qop
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
operator|!=
name|GSS_S_COMPLETE
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"gss_verify_mic failed"
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|mic
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|msg
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX fix gsm_error */
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|GetVersionAndCapabilities
parameter_list|)
block|{
name|int32_t
name|cap
init|=
name|HAS_MONIKER
decl_stmt|;
name|char
name|name
index|[
literal|256
index|]
init|=
literal|"unknown"
decl_stmt|,
modifier|*
name|str
decl_stmt|;
if|if
condition|(
name|targetname
condition|)
name|cap
operator||=
name|ISSERVER
expr_stmt|;
comment|/* is server */
ifdef|#
directive|ifdef
name|HAVE_UNAME
block|{
name|struct
name|utsname
name|ut
decl_stmt|;
if|if
condition|(
name|uname
argument_list|(
operator|&
name|ut
argument_list|)
operator|==
literal|0
condition|)
block|{
name|snprintf
argument_list|(
name|name
argument_list|,
sizeof|sizeof
argument_list|(
name|name
argument_list|)
argument_list|,
literal|"%s-%s-%s"
argument_list|,
name|ut
operator|.
name|sysname
argument_list|,
name|ut
operator|.
name|version
argument_list|,
name|ut
operator|.
name|machine
argument_list|)
expr_stmt|;
block|}
block|}
endif|#
directive|endif
name|asprintf
argument_list|(
operator|&
name|str
argument_list|,
literal|"gssmask %s %s"
argument_list|,
name|PACKAGE_STRING
argument_list|,
name|name
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
name|GSSMAGGOTPROTOCOL
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
name|cap
argument_list|)
expr_stmt|;
name|putstring
argument_list|(
name|c
argument_list|,
name|str
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|str
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|GetTargetName
parameter_list|)
block|{
if|if
condition|(
name|targetname
condition|)
name|putstring
argument_list|(
name|c
argument_list|,
name|targetname
argument_list|)
expr_stmt|;
else|else
name|putstring
argument_list|(
name|c
argument_list|,
literal|""
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|SetLoggingSocket
parameter_list|)
block|{
name|int32_t
name|portnum
decl_stmt|;
name|int
name|fd
decl_stmt|,
name|ret
decl_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|portnum
argument_list|)
expr_stmt|;
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"logging port on peer is: %d"
argument_list|,
operator|(
name|int
operator|)
name|portnum
argument_list|)
expr_stmt|;
name|socket_set_port
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|(
operator|&
name|c
operator|->
name|sa
operator|)
argument_list|,
name|htons
argument_list|(
name|portnum
argument_list|)
argument_list|)
expr_stmt|;
name|fd
operator|=
name|socket
argument_list|(
operator|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|c
operator|->
name|sa
operator|)
operator|->
name|sa_family
argument_list|,
name|SOCK_STREAM
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|fd
operator|<
literal|0
condition|)
return|return
literal|0
return|;
name|ret
operator|=
name|connect
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|c
operator|->
name|sa
argument_list|,
name|c
operator|->
name|salen
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
operator|<
literal|0
condition|)
block|{
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"failed connect to log port: %s"
argument_list|,
name|strerror
argument_list|(
name|errno
argument_list|)
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|c
operator|->
name|logging
condition|)
name|krb5_storage_free
argument_list|(
name|c
operator|->
name|logging
argument_list|)
expr_stmt|;
name|c
operator|->
name|logging
operator|=
name|krb5_storage_from_fd
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
name|krb5_store_int32
argument_list|(
name|c
operator|->
name|logging
argument_list|,
name|eLogSetMoniker
argument_list|)
expr_stmt|;
name|store_string
argument_list|(
name|c
operator|->
name|logging
argument_list|,
name|c
operator|->
name|moniker
argument_list|)
expr_stmt|;
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"logging turned on"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|ChangePassword
parameter_list|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"ChangePassword"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|SetPasswordSelf
parameter_list|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"SetPasswordSelf"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|Wrap
parameter_list|)
block|{
name|OM_uint32
name|maj_stat
decl_stmt|,
name|min_stat
decl_stmt|;
name|int32_t
name|hContext
decl_stmt|,
name|flags
decl_stmt|,
name|seqno
decl_stmt|;
name|krb5_data
name|token
decl_stmt|;
name|gss_ctx_id_t
name|ctx
decl_stmt|;
name|gss_buffer_desc
name|input_token
decl_stmt|,
name|output_token
decl_stmt|;
name|int
name|conf_state
decl_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|hContext
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|seqno
argument_list|)
expr_stmt|;
name|retdata
argument_list|(
name|c
argument_list|,
name|token
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|find_handle
argument_list|(
name|c
operator|->
name|handles
argument_list|,
name|hContext
argument_list|,
name|handle_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"wrap: reference to unknown context"
argument_list|)
expr_stmt|;
name|input_token
operator|.
name|length
operator|=
name|token
operator|.
name|length
expr_stmt|;
name|input_token
operator|.
name|value
operator|=
name|token
operator|.
name|data
expr_stmt|;
name|maj_stat
operator|=
name|gss_wrap
argument_list|(
operator|&
name|min_stat
argument_list|,
name|ctx
argument_list|,
name|flags
argument_list|,
literal|0
argument_list|,
operator|&
name|input_token
argument_list|,
operator|&
name|conf_state
argument_list|,
operator|&
name|output_token
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
operator|!=
name|GSS_S_COMPLETE
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"gss_wrap failed"
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|token
argument_list|)
expr_stmt|;
name|token
operator|.
name|data
operator|=
name|output_token
operator|.
name|value
expr_stmt|;
name|token
operator|.
name|length
operator|=
name|output_token
operator|.
name|length
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX fix gsm_error */
name|putdata
argument_list|(
name|c
argument_list|,
name|token
argument_list|)
expr_stmt|;
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|output_token
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|Unwrap
parameter_list|)
block|{
name|OM_uint32
name|maj_stat
decl_stmt|,
name|min_stat
decl_stmt|;
name|int32_t
name|hContext
decl_stmt|,
name|flags
decl_stmt|,
name|seqno
decl_stmt|;
name|krb5_data
name|token
decl_stmt|;
name|gss_ctx_id_t
name|ctx
decl_stmt|;
name|gss_buffer_desc
name|input_token
decl_stmt|,
name|output_token
decl_stmt|;
name|int
name|conf_state
decl_stmt|;
name|gss_qop_t
name|qop_state
decl_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|hContext
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|seqno
argument_list|)
expr_stmt|;
name|retdata
argument_list|(
name|c
argument_list|,
name|token
argument_list|)
expr_stmt|;
name|ctx
operator|=
name|find_handle
argument_list|(
name|c
operator|->
name|handles
argument_list|,
name|hContext
argument_list|,
name|handle_context
argument_list|)
expr_stmt|;
if|if
condition|(
name|ctx
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"unwrap: reference to unknown context"
argument_list|)
expr_stmt|;
name|input_token
operator|.
name|length
operator|=
name|token
operator|.
name|length
expr_stmt|;
name|input_token
operator|.
name|value
operator|=
name|token
operator|.
name|data
expr_stmt|;
name|maj_stat
operator|=
name|gss_unwrap
argument_list|(
operator|&
name|min_stat
argument_list|,
name|ctx
argument_list|,
operator|&
name|input_token
argument_list|,
operator|&
name|output_token
argument_list|,
operator|&
name|conf_state
argument_list|,
operator|&
name|qop_state
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
operator|!=
name|GSS_S_COMPLETE
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"gss_unwrap failed: %d/%d"
argument_list|,
name|maj_stat
argument_list|,
name|min_stat
argument_list|)
expr_stmt|;
name|krb5_data_free
argument_list|(
operator|&
name|token
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
operator|==
name|GSS_S_COMPLETE
condition|)
block|{
name|token
operator|.
name|data
operator|=
name|output_token
operator|.
name|value
expr_stmt|;
name|token
operator|.
name|length
operator|=
name|output_token
operator|.
name|length
expr_stmt|;
block|}
else|else
block|{
name|token
operator|.
name|data
operator|=
name|NULL
expr_stmt|;
name|token
operator|.
name|length
operator|=
literal|0
expr_stmt|;
block|}
name|put32
argument_list|(
name|c
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* XXX fix gsm_error */
name|putdata
argument_list|(
name|c
argument_list|,
name|token
argument_list|)
expr_stmt|;
if|if
condition|(
name|maj_stat
operator|==
name|GSS_S_COMPLETE
condition|)
name|gss_release_buffer
argument_list|(
operator|&
name|min_stat
argument_list|,
operator|&
name|output_token
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|Encrypt
parameter_list|)
block|{
return|return
name|handleWrap
argument_list|(
name|op
argument_list|,
name|c
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|Decrypt
parameter_list|)
block|{
return|return
name|handleUnwrap
argument_list|(
name|op
argument_list|,
name|c
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|ConnectLoggingService2
parameter_list|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"ConnectLoggingService2"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|GetMoniker
parameter_list|)
block|{
name|putstring
argument_list|(
name|c
argument_list|,
name|c
operator|->
name|moniker
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|CallExtension
parameter_list|)
block|{
name|errx
argument_list|(
literal|1
argument_list|,
literal|"CallExtension"
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|HandleOP
parameter_list|(
name|AcquirePKInitCreds
parameter_list|)
block|{
name|int32_t
name|flags
decl_stmt|;
name|krb5_data
name|pfxdata
decl_stmt|;
name|ret32
argument_list|(
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|retdata
argument_list|(
name|c
argument_list|,
name|pfxdata
argument_list|)
expr_stmt|;
comment|/* get credentials */
name|krb5_data_free
argument_list|(
operator|&
name|pfxdata
argument_list|)
expr_stmt|;
name|put32
argument_list|(
name|c
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
comment|/* hResource */
name|put32
argument_list|(
name|c
argument_list|,
name|GSMERR_NOT_SUPPORTED
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/*  *  */
end_comment

begin_struct
struct|struct
name|handler
block|{
name|enum
name|gssMaggotOp
name|op
decl_stmt|;
specifier|const
name|char
modifier|*
name|name
decl_stmt|;
name|int
function_decl|(
modifier|*
name|func
function_decl|)
parameter_list|(
name|enum
name|gssMaggotOp
parameter_list|,
name|struct
name|client
modifier|*
parameter_list|)
function_decl|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|S
parameter_list|(
name|a
parameter_list|)
value|{ e##a, #a, handle##a }
end_define

begin_decl_stmt
name|struct
name|handler
name|handlers
index|[]
init|=
block|{
name|S
argument_list|(
name|GetVersionInfo
argument_list|)
block|,
name|S
argument_list|(
name|GoodBye
argument_list|)
block|,
name|S
argument_list|(
name|InitContext
argument_list|)
block|,
name|S
argument_list|(
name|AcceptContext
argument_list|)
block|,
name|S
argument_list|(
name|ToastResource
argument_list|)
block|,
name|S
argument_list|(
name|AcquireCreds
argument_list|)
block|,
name|S
argument_list|(
name|Encrypt
argument_list|)
block|,
name|S
argument_list|(
name|Decrypt
argument_list|)
block|,
name|S
argument_list|(
name|Sign
argument_list|)
block|,
name|S
argument_list|(
name|Verify
argument_list|)
block|,
name|S
argument_list|(
name|GetVersionAndCapabilities
argument_list|)
block|,
name|S
argument_list|(
name|GetTargetName
argument_list|)
block|,
name|S
argument_list|(
name|SetLoggingSocket
argument_list|)
block|,
name|S
argument_list|(
name|ChangePassword
argument_list|)
block|,
name|S
argument_list|(
name|SetPasswordSelf
argument_list|)
block|,
name|S
argument_list|(
name|Wrap
argument_list|)
block|,
name|S
argument_list|(
name|Unwrap
argument_list|)
block|,
name|S
argument_list|(
name|ConnectLoggingService2
argument_list|)
block|,
name|S
argument_list|(
name|GetMoniker
argument_list|)
block|,
name|S
argument_list|(
name|CallExtension
argument_list|)
block|,
name|S
argument_list|(
argument|AcquirePKInitCreds
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_undef
undef|#
directive|undef
name|S
end_undef

begin_comment
comment|/*  *  */
end_comment

begin_function
specifier|static
name|struct
name|handler
modifier|*
name|find_op
parameter_list|(
name|int32_t
name|op
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|handlers
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|handlers
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
if|if
condition|(
name|handlers
index|[
name|i
index|]
operator|.
name|op
operator|==
name|op
condition|)
return|return
operator|&
name|handlers
index|[
name|i
index|]
return|;
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|struct
name|client
modifier|*
name|create_client
parameter_list|(
name|int
name|fd
parameter_list|,
name|int
name|port
parameter_list|,
specifier|const
name|char
modifier|*
name|moniker
parameter_list|)
block|{
name|struct
name|client
modifier|*
name|c
decl_stmt|;
name|c
operator|=
name|ecalloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|c
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|moniker
condition|)
block|{
name|c
operator|->
name|moniker
operator|=
name|estrdup
argument_list|(
name|moniker
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|char
name|hostname
index|[
name|MAXHOSTNAMELEN
index|]
decl_stmt|;
name|gethostname
argument_list|(
name|hostname
argument_list|,
sizeof|sizeof
argument_list|(
name|hostname
argument_list|)
argument_list|)
expr_stmt|;
name|asprintf
argument_list|(
operator|&
name|c
operator|->
name|moniker
argument_list|,
literal|"gssmask: %s:%d"
argument_list|,
name|hostname
argument_list|,
name|port
argument_list|)
expr_stmt|;
block|}
block|{
name|c
operator|->
name|salen
operator|=
sizeof|sizeof
argument_list|(
name|c
operator|->
name|sa
argument_list|)
expr_stmt|;
name|getpeername
argument_list|(
name|fd
argument_list|,
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|c
operator|->
name|sa
argument_list|,
operator|&
name|c
operator|->
name|salen
argument_list|)
expr_stmt|;
name|getnameinfo
argument_list|(
operator|(
expr|struct
name|sockaddr
operator|*
operator|)
operator|&
name|c
operator|->
name|sa
argument_list|,
name|c
operator|->
name|salen
argument_list|,
name|c
operator|->
name|servername
argument_list|,
sizeof|sizeof
argument_list|(
name|c
operator|->
name|servername
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NI_NUMERICHOST
argument_list|)
expr_stmt|;
block|}
name|c
operator|->
name|sock
operator|=
name|krb5_storage_from_fd
argument_list|(
name|fd
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|sock
operator|==
name|NULL
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"krb5_storage_from_fd"
argument_list|)
expr_stmt|;
name|close
argument_list|(
name|fd
argument_list|)
expr_stmt|;
return|return
name|c
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|free_client
parameter_list|(
name|struct
name|client
modifier|*
name|c
parameter_list|)
block|{
while|while
condition|(
name|c
operator|->
name|handles
condition|)
name|del_handle
argument_list|(
operator|&
name|c
operator|->
name|handles
argument_list|,
name|c
operator|->
name|handles
operator|->
name|idx
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|c
operator|->
name|moniker
argument_list|)
expr_stmt|;
name|krb5_storage_free
argument_list|(
name|c
operator|->
name|sock
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|->
name|logging
condition|)
name|krb5_storage_free
argument_list|(
name|c
operator|->
name|logging
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
modifier|*
name|handleServer
parameter_list|(
name|void
modifier|*
name|ptr
parameter_list|)
block|{
name|struct
name|handler
modifier|*
name|handler
decl_stmt|;
name|struct
name|client
modifier|*
name|c
decl_stmt|;
name|int32_t
name|op
decl_stmt|;
name|c
operator|=
operator|(
expr|struct
name|client
operator|*
operator|)
name|ptr
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|ret32
argument_list|(
name|c
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|handler
operator|=
name|find_op
argument_list|(
name|op
argument_list|)
expr_stmt|;
if|if
condition|(
name|handler
operator|==
name|NULL
condition|)
block|{
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"op %d not supported"
argument_list|,
operator|(
name|int
operator|)
name|op
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|logmessage
argument_list|(
name|c
argument_list|,
name|__FILE__
argument_list|,
name|__LINE__
argument_list|,
literal|0
argument_list|,
literal|"---> Got op %s from server %s"
argument_list|,
name|handler
operator|->
name|name
argument_list|,
name|c
operator|->
name|servername
argument_list|)
expr_stmt|;
if|if
condition|(
call|(
name|handler
operator|->
name|func
call|)
argument_list|(
name|handler
operator|->
name|op
argument_list|,
name|c
argument_list|)
condition|)
break|break;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|char
modifier|*
name|port_str
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|version_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|help_flag
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|logfile_str
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|moniker_str
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|port
init|=
literal|4711
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|getargs
name|args
index|[]
init|=
block|{
block|{
literal|"spn"
block|,
literal|0
block|,
name|arg_string
block|,
operator|&
name|targetname
block|,
literal|"This host's SPN"
block|,
literal|"service/host@REALM"
block|}
block|,
block|{
literal|"port"
block|,
literal|'p'
block|,
name|arg_string
block|,
operator|&
name|port_str
block|,
literal|"Use this port"
block|,
literal|"number-of-service"
block|}
block|,
block|{
literal|"logfile"
block|,
literal|0
block|,
name|arg_string
block|,
operator|&
name|logfile_str
block|,
literal|"logfile"
block|,
literal|"number-of-service"
block|}
block|,
block|{
literal|"moniker"
block|,
literal|0
block|,
name|arg_string
block|,
operator|&
name|moniker_str
block|,
literal|"nickname"
block|,
literal|"name"
block|}
block|,
block|{
literal|"version"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|version_flag
block|,
literal|"Print version"
block|,
name|NULL
block|}
block|,
block|{
literal|"help"
block|,
literal|0
block|,
name|arg_flag
block|,
operator|&
name|help_flag
block|,
name|NULL
block|,
name|NULL
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|void
name|usage
parameter_list|(
name|int
name|ret
parameter_list|)
block|{
name|arg_printusage
argument_list|(
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|NULL
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|ret
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|main
parameter_list|(
name|int
name|argc
parameter_list|,
name|char
modifier|*
modifier|*
name|argv
parameter_list|)
block|{
name|int
name|optidx
init|=
literal|0
decl_stmt|;
name|setprogname
argument_list|(
name|argv
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|getarg
argument_list|(
name|args
argument_list|,
sizeof|sizeof
argument_list|(
name|args
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|args
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|argc
argument_list|,
name|argv
argument_list|,
operator|&
name|optidx
argument_list|)
condition|)
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|help_flag
condition|)
name|usage
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|version_flag
condition|)
block|{
name|print_version
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
if|if
condition|(
name|optidx
operator|!=
name|argc
condition|)
name|usage
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|port_str
condition|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|;
name|port
operator|=
name|strtol
argument_list|(
name|port_str
argument_list|,
operator|&
name|ptr
argument_list|,
literal|10
argument_list|)
expr_stmt|;
if|if
condition|(
name|port
operator|==
literal|0
operator|&&
name|ptr
operator|==
name|port_str
condition|)
name|errx
argument_list|(
literal|1
argument_list|,
literal|"Bad port `%s'"
argument_list|,
name|port_str
argument_list|)
expr_stmt|;
block|}
name|krb5_init_context
argument_list|(
operator|&
name|context
argument_list|)
expr_stmt|;
block|{
specifier|const
name|char
modifier|*
name|lf
init|=
name|logfile_str
decl_stmt|;
if|if
condition|(
name|lf
operator|==
name|NULL
condition|)
name|lf
operator|=
literal|"/dev/tty"
expr_stmt|;
name|logfile
operator|=
name|fopen
argument_list|(
name|lf
argument_list|,
literal|"w"
argument_list|)
expr_stmt|;
if|if
condition|(
name|logfile
operator|==
name|NULL
condition|)
name|err
argument_list|(
literal|1
argument_list|,
literal|"error opening %s"
argument_list|,
name|lf
argument_list|)
expr_stmt|;
block|}
name|mini_inetd
argument_list|(
name|htons
argument_list|(
name|port
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|logfile
argument_list|,
literal|"connected\n"
argument_list|)
expr_stmt|;
block|{
name|struct
name|client
modifier|*
name|c
decl_stmt|;
name|c
operator|=
name|create_client
argument_list|(
literal|0
argument_list|,
name|port
argument_list|,
name|moniker_str
argument_list|)
expr_stmt|;
comment|/* close(0); */
name|handleServer
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|free_client
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|krb5_free_context
argument_list|(
name|context
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


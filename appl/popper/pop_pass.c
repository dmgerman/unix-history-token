begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (c) 1989 Regents of the University of California.  * All rights reserved.  The Berkeley software License Agreement  * specifies the terms and conditions for redistribution.  */
end_comment

begin_include
include|#
directive|include
file|<popper.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CRYPT_H
end_ifdef

begin_include
include|#
directive|include
file|<crypt.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_expr_stmt
name|RCSID
argument_list|(
literal|"$Id$"
argument_list|)
expr_stmt|;
end_expr_stmt

begin_ifdef
ifdef|#
directive|ifdef
name|KRB5
end_ifdef

begin_function
specifier|static
name|int
name|krb5_verify_password
parameter_list|(
name|POP
modifier|*
name|p
parameter_list|)
block|{
name|krb5_preauthtype
name|pre_auth_types
index|[]
init|=
block|{
name|KRB5_PADATA_ENC_TIMESTAMP
block|}
decl_stmt|;
name|krb5_get_init_creds_opt
modifier|*
name|get_options
decl_stmt|;
name|krb5_verify_init_creds_opt
name|verify_options
decl_stmt|;
name|krb5_error_code
name|ret
decl_stmt|;
name|krb5_principal
name|client
decl_stmt|,
name|server
decl_stmt|;
name|krb5_creds
name|creds
decl_stmt|;
name|ret
operator|=
name|krb5_get_init_creds_opt_alloc
argument_list|(
name|p
operator|->
name|context
argument_list|,
operator|&
name|get_options
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pop_log
argument_list|(
name|p
argument_list|,
name|POP_PRIORITY
argument_list|,
literal|"krb5_get_init_creds_opt_alloc: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|krb5_get_init_creds_opt_set_preauth_list
argument_list|(
name|get_options
argument_list|,
name|pre_auth_types
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|krb5_verify_init_creds_opt_init
argument_list|(
operator|&
name|verify_options
argument_list|)
expr_stmt|;
name|ret
operator|=
name|krb5_parse_name
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|p
operator|->
name|user
argument_list|,
operator|&
name|client
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|krb5_get_init_creds_opt_free
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|get_options
argument_list|)
expr_stmt|;
name|pop_log
argument_list|(
name|p
argument_list|,
name|POP_PRIORITY
argument_list|,
literal|"krb5_parse_name: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|ret
operator|=
name|krb5_get_init_creds_password
argument_list|(
name|p
operator|->
name|context
argument_list|,
operator|&
name|creds
argument_list|,
name|client
argument_list|,
name|p
operator|->
name|pop_parm
index|[
literal|1
index|]
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|,
name|NULL
argument_list|,
name|get_options
argument_list|)
expr_stmt|;
name|krb5_get_init_creds_opt_free
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|get_options
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pop_log
argument_list|(
name|p
argument_list|,
name|POP_PRIORITY
argument_list|,
literal|"krb5_get_init_creds_password: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|ret
operator|=
name|krb5_sname_to_principal
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|p
operator|->
name|myhost
argument_list|,
literal|"pop"
argument_list|,
name|KRB5_NT_SRV_HST
argument_list|,
operator|&
name|server
argument_list|)
expr_stmt|;
if|if
condition|(
name|ret
condition|)
block|{
name|pop_log
argument_list|(
name|p
argument_list|,
name|POP_PRIORITY
argument_list|,
literal|"krb5_get_init_creds_password: %s"
argument_list|,
name|krb5_get_err_text
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|ret
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|ret
operator|=
name|krb5_verify_init_creds
argument_list|(
name|p
operator|->
name|context
argument_list|,
operator|&
name|creds
argument_list|,
name|server
argument_list|,
name|NULL
argument_list|,
name|NULL
argument_list|,
operator|&
name|verify_options
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|client
argument_list|)
expr_stmt|;
name|krb5_free_principal
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|server
argument_list|)
expr_stmt|;
name|krb5_free_cred_contents
argument_list|(
name|p
operator|->
name|context
argument_list|,
operator|&
name|creds
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/*  *  pass:   Obtain the user password from a POP client  */
end_comment

begin_function
name|int
name|login_user
parameter_list|(
name|POP
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|stat
name|st
decl_stmt|;
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
comment|/*  Look for the user in the password file */
if|if
condition|(
operator|(
name|pw
operator|=
name|k_getpwnam
argument_list|(
name|p
operator|->
name|user
argument_list|)
operator|)
operator|==
name|NULL
condition|)
block|{
name|pop_log
argument_list|(
name|p
argument_list|,
name|POP_PRIORITY
argument_list|,
literal|"user %s (from %s) not found"
argument_list|,
name|p
operator|->
name|user
argument_list|,
name|p
operator|->
name|ipaddr
argument_list|)
expr_stmt|;
return|return
name|pop_msg
argument_list|(
name|p
argument_list|,
name|POP_FAILURE
argument_list|,
literal|"Login incorrect."
argument_list|)
return|;
block|}
name|pop_log
argument_list|(
name|p
argument_list|,
name|POP_INFO
argument_list|,
literal|"login from %s as %s"
argument_list|,
name|p
operator|->
name|ipaddr
argument_list|,
name|p
operator|->
name|user
argument_list|)
expr_stmt|;
comment|/*  Build the name of the user's maildrop */
name|snprintf
argument_list|(
name|p
operator|->
name|drop_name
argument_list|,
sizeof|sizeof
argument_list|(
name|p
operator|->
name|drop_name
argument_list|)
argument_list|,
literal|"%s/%s"
argument_list|,
name|POP_MAILDIR
argument_list|,
name|p
operator|->
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|p
operator|->
name|drop_name
argument_list|,
operator|&
name|st
argument_list|)
operator|<
literal|0
operator|||
operator|!
name|S_ISDIR
argument_list|(
name|st
operator|.
name|st_mode
argument_list|)
condition|)
block|{
comment|/*  Make a temporary copy of the user's maildrop */
comment|/*    and set the group and user id */
if|if
condition|(
name|pop_dropcopy
argument_list|(
name|p
argument_list|,
name|pw
argument_list|)
operator|!=
name|POP_SUCCESS
condition|)
return|return
operator|(
name|POP_FAILURE
operator|)
return|;
comment|/*  Get information about the maildrop */
if|if
condition|(
name|pop_dropinfo
argument_list|(
name|p
argument_list|)
operator|!=
name|POP_SUCCESS
condition|)
return|return
operator|(
name|POP_FAILURE
operator|)
return|;
block|}
else|else
block|{
if|if
condition|(
name|changeuser
argument_list|(
name|p
argument_list|,
name|pw
argument_list|)
operator|!=
name|POP_SUCCESS
condition|)
return|return
name|POP_FAILURE
return|;
if|if
condition|(
name|pop_maildir_info
argument_list|(
name|p
argument_list|)
operator|!=
name|POP_SUCCESS
condition|)
return|return
name|POP_FAILURE
return|;
block|}
comment|/*  Initialize the last-message-accessed number */
name|p
operator|->
name|last_msg
operator|=
literal|0
expr_stmt|;
return|return
name|POP_SUCCESS
return|;
block|}
end_function

begin_function
name|int
name|pop_pass
parameter_list|(
name|POP
modifier|*
name|p
parameter_list|)
block|{
name|struct
name|passwd
modifier|*
name|pw
decl_stmt|;
name|int
name|i
decl_stmt|;
name|int
name|status
decl_stmt|;
comment|/* Make one string of all these parameters */
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<
name|p
operator|->
name|parm_count
condition|;
operator|++
name|i
control|)
name|p
operator|->
name|pop_parm
index|[
name|i
index|]
index|[
name|strlen
argument_list|(
name|p
operator|->
name|pop_parm
index|[
name|i
index|]
argument_list|)
index|]
operator|=
literal|' '
expr_stmt|;
comment|/*  Look for the user in the password file */
if|if
condition|(
operator|(
name|pw
operator|=
name|k_getpwnam
argument_list|(
name|p
operator|->
name|user
argument_list|)
operator|)
operator|==
name|NULL
condition|)
return|return
operator|(
name|pop_msg
argument_list|(
name|p
argument_list|,
name|POP_FAILURE
argument_list|,
literal|"Password supplied for \"%s\" is incorrect."
argument_list|,
name|p
operator|->
name|user
argument_list|)
operator|)
return|;
if|if
condition|(
name|p
operator|->
name|kerberosp
condition|)
block|{
ifdef|#
directive|ifdef
name|KRB5
if|if
condition|(
name|p
operator|->
name|version
operator|==
literal|5
condition|)
block|{
name|char
modifier|*
name|name
decl_stmt|;
if|if
condition|(
operator|!
name|krb5_kuserok
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|p
operator|->
name|principal
argument_list|,
name|p
operator|->
name|user
argument_list|)
condition|)
block|{
name|pop_log
argument_list|(
name|p
argument_list|,
name|POP_PRIORITY
argument_list|,
literal|"krb5 permission denied"
argument_list|)
expr_stmt|;
return|return
name|pop_msg
argument_list|(
name|p
argument_list|,
name|POP_FAILURE
argument_list|,
literal|"Popping not authorized"
argument_list|)
return|;
block|}
if|if
condition|(
name|krb5_unparse_name
argument_list|(
name|p
operator|->
name|context
argument_list|,
name|p
operator|->
name|principal
argument_list|,
operator|&
name|name
argument_list|)
operator|==
literal|0
condition|)
block|{
name|pop_log
argument_list|(
name|p
argument_list|,
name|POP_INFO
argument_list|,
literal|"%s: %s -> %s"
argument_list|,
name|p
operator|->
name|ipaddr
argument_list|,
name|name
argument_list|,
name|p
operator|->
name|user
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|pop_log
argument_list|(
name|p
argument_list|,
name|POP_PRIORITY
argument_list|,
literal|"kerberos authentication failed"
argument_list|)
expr_stmt|;
return|return
name|pop_msg
argument_list|(
name|p
argument_list|,
name|POP_FAILURE
argument_list|,
literal|"kerberos authentication failed"
argument_list|)
return|;
block|}
endif|#
directive|endif
block|{ }
block|}
else|else
block|{
comment|/*  We don't accept connections from users with null passwords */
if|if
condition|(
name|pw
operator|->
name|pw_passwd
operator|==
name|NULL
condition|)
return|return
operator|(
name|pop_msg
argument_list|(
name|p
argument_list|,
name|POP_FAILURE
argument_list|,
literal|"Password supplied for \"%s\" is incorrect."
argument_list|,
name|p
operator|->
name|user
argument_list|)
operator|)
return|;
ifdef|#
directive|ifdef
name|OTP
if|if
condition|(
name|otp_verify_user
argument_list|(
operator|&
name|p
operator|->
name|otp_ctx
argument_list|,
name|p
operator|->
name|pop_parm
index|[
literal|1
index|]
argument_list|)
operator|==
literal|0
condition|)
comment|/* pass OK */
empty_stmt|;
elseif|else
endif|#
directive|endif
comment|/*  Compare the supplied password with the password file entry */
if|if
condition|(
name|p
operator|->
name|auth_level
operator|!=
name|AUTH_NONE
condition|)
return|return
name|pop_msg
argument_list|(
name|p
argument_list|,
name|POP_FAILURE
argument_list|,
literal|"Password supplied for \"%s\" is incorrect."
argument_list|,
name|p
operator|->
name|user
argument_list|)
return|;
elseif|else
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|crypt
argument_list|(
name|p
operator|->
name|pop_parm
index|[
literal|1
index|]
argument_list|,
name|pw
operator|->
name|pw_passwd
argument_list|)
argument_list|,
name|pw
operator|->
name|pw_passwd
argument_list|)
condition|)
comment|/* pass OK */
empty_stmt|;
else|else
block|{
name|int
name|ret
init|=
operator|-
literal|1
decl_stmt|;
ifdef|#
directive|ifdef
name|KRB5
if|if
condition|(
name|ret
condition|)
name|ret
operator|=
name|krb5_verify_password
argument_list|(
name|p
argument_list|)
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
name|ret
condition|)
return|return
name|pop_msg
argument_list|(
name|p
argument_list|,
name|POP_FAILURE
argument_list|,
literal|"Password incorrect"
argument_list|)
return|;
block|}
block|}
name|status
operator|=
name|login_user
argument_list|(
name|p
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|POP_SUCCESS
condition|)
return|return
name|status
return|;
comment|/*  Authorization completed successfully */
return|return
operator|(
name|pop_msg
argument_list|(
name|p
argument_list|,
name|POP_SUCCESS
argument_list|,
literal|"%s has %d message(s) (%ld octets)."
argument_list|,
name|p
operator|->
name|user
argument_list|,
name|p
operator|->
name|msg_count
argument_list|,
name|p
operator|->
name|drop_size
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


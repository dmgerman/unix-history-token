begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<ldns/config.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<time.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_SSL
end_ifdef

begin_comment
comment|/* this entire file is rather useless when you don't have  * crypto...  */
end_comment

begin_include
include|#
directive|include
file|<openssl/ssl.h>
end_include

begin_include
include|#
directive|include
file|<openssl/evp.h>
end_include

begin_include
include|#
directive|include
file|<openssl/rand.h>
end_include

begin_include
include|#
directive|include
file|<openssl/err.h>
end_include

begin_include
include|#
directive|include
file|<openssl/md5.h>
end_include

begin_function
name|ldns_dnssec_data_chain
modifier|*
name|ldns_dnssec_data_chain_new
parameter_list|()
block|{
name|ldns_dnssec_data_chain
modifier|*
name|nc
init|=
name|LDNS_CALLOC
argument_list|(
name|ldns_dnssec_data_chain
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|nc
condition|)
return|return
name|NULL
return|;
comment|/*  	 * not needed anymore because CALLOC initalizes everything to zero.  	nc->rrset = NULL; 	nc->parent_type = 0; 	nc->parent = NULL; 	nc->signatures = NULL; 	nc->packet_rcode = 0; 	nc->packet_qtype = 0; 	nc->packet_nodata = false;  	 */
return|return
name|nc
return|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_data_chain_free
parameter_list|(
name|ldns_dnssec_data_chain
modifier|*
name|chain
parameter_list|)
block|{
name|LDNS_FREE
argument_list|(
name|chain
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_data_chain_deep_free
parameter_list|(
name|ldns_dnssec_data_chain
modifier|*
name|chain
parameter_list|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|chain
operator|->
name|rrset
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|chain
operator|->
name|signatures
argument_list|)
expr_stmt|;
if|if
condition|(
name|chain
operator|->
name|parent
condition|)
block|{
name|ldns_dnssec_data_chain_deep_free
argument_list|(
name|chain
operator|->
name|parent
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|chain
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_data_chain_print_fmt
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_output_format
modifier|*
name|fmt
parameter_list|,
specifier|const
name|ldns_dnssec_data_chain
modifier|*
name|chain
parameter_list|)
block|{
name|ldns_lookup_table
modifier|*
name|rcode
decl_stmt|;
specifier|const
name|ldns_rr_descriptor
modifier|*
name|rr_descriptor
decl_stmt|;
if|if
condition|(
name|chain
condition|)
block|{
name|ldns_dnssec_data_chain_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|chain
operator|->
name|parent
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|chain
operator|->
name|rrset
argument_list|)
operator|>
literal|0
condition|)
block|{
name|rcode
operator|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_rcodes
argument_list|,
operator|(
name|int
operator|)
name|chain
operator|->
name|packet_rcode
argument_list|)
expr_stmt|;
if|if
condition|(
name|rcode
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|";; rcode: %s\n"
argument_list|,
name|rcode
operator|->
name|name
argument_list|)
expr_stmt|;
block|}
name|rr_descriptor
operator|=
name|ldns_rr_descript
argument_list|(
name|chain
operator|->
name|packet_qtype
argument_list|)
expr_stmt|;
if|if
condition|(
name|rr_descriptor
operator|&&
name|rr_descriptor
operator|->
name|_name
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|";; qtype: %s\n"
argument_list|,
name|rr_descriptor
operator|->
name|_name
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|chain
operator|->
name|packet_qtype
operator|!=
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"TYPE%u"
argument_list|,
name|chain
operator|->
name|packet_qtype
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|chain
operator|->
name|packet_nodata
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|";; NODATA response\n"
argument_list|)
expr_stmt|;
block|}
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"rrset:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|chain
operator|->
name|rrset
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"sigs:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|chain
operator|->
name|signatures
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"---\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"<no data>\n"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_data_chain_print
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_dnssec_data_chain
modifier|*
name|chain
parameter_list|)
block|{
name|ldns_dnssec_data_chain_print_fmt
argument_list|(
name|out
argument_list|,
name|ldns_output_format_default
argument_list|,
name|chain
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ldns_dnssec_build_data_chain_dnskey
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|uint16_t
name|qflags
parameter_list|,
specifier|const
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rr_list
modifier|*
name|signatures
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|new_chain
parameter_list|,
name|ldns_rdf
modifier|*
name|key_name
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|keys
decl_stmt|;
name|ldns_pkt
modifier|*
name|my_pkt
decl_stmt|;
if|if
condition|(
name|signatures
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|signatures
argument_list|)
operator|>
literal|0
condition|)
block|{
name|new_chain
operator|->
name|signatures
operator|=
name|ldns_rr_list_clone
argument_list|(
name|signatures
argument_list|)
expr_stmt|;
name|new_chain
operator|->
name|parent_type
operator|=
literal|0
expr_stmt|;
name|keys
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|pkt
argument_list|,
name|key_name
argument_list|,
name|LDNS_RR_TYPE_DNSKEY
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|keys
condition|)
block|{
name|my_pkt
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|key_name
argument_list|,
name|LDNS_RR_TYPE_DNSKEY
argument_list|,
name|c
argument_list|,
name|qflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_pkt
condition|)
block|{
name|keys
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|my_pkt
argument_list|,
name|key_name
argument_list|,
name|LDNS_RR_TYPE_DNSKEY
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
name|new_chain
operator|->
name|parent
operator|=
name|ldns_dnssec_build_data_chain
argument_list|(
name|res
argument_list|,
name|qflags
argument_list|,
name|keys
argument_list|,
name|my_pkt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|new_chain
operator|->
name|parent
operator|->
name|packet_qtype
operator|=
name|LDNS_RR_TYPE_DNSKEY
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|my_pkt
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|new_chain
operator|->
name|parent
operator|=
name|ldns_dnssec_build_data_chain
argument_list|(
name|res
argument_list|,
name|qflags
argument_list|,
name|keys
argument_list|,
name|pkt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|new_chain
operator|->
name|parent
operator|->
name|packet_qtype
operator|=
name|LDNS_RR_TYPE_DNSKEY
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|keys
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ldns_dnssec_build_data_chain_other
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|uint16_t
name|qflags
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|new_chain
parameter_list|,
name|ldns_rdf
modifier|*
name|key_name
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|,
name|ldns_rr_list
modifier|*
name|dss
parameter_list|)
block|{
comment|/* 'self-signed', parent is a DS */
comment|/* okay, either we have other keys signing the current one, 	 * or the current 	 * one should have a DS record in the parent zone. 	 * How do we find this out? Try both? 	 * 	 * request DNSKEYS for current zone, 	 * add all signatures to current level 	 */
name|ldns_pkt
modifier|*
name|my_pkt
decl_stmt|;
name|ldns_rr_list
modifier|*
name|signatures2
decl_stmt|;
name|new_chain
operator|->
name|parent_type
operator|=
literal|1
expr_stmt|;
name|my_pkt
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|key_name
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|,
name|c
argument_list|,
name|qflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_pkt
condition|)
block|{
name|dss
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|my_pkt
argument_list|,
name|key_name
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
if|if
condition|(
name|dss
condition|)
block|{
name|new_chain
operator|->
name|parent
operator|=
name|ldns_dnssec_build_data_chain
argument_list|(
name|res
argument_list|,
name|qflags
argument_list|,
name|dss
argument_list|,
name|my_pkt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|new_chain
operator|->
name|parent
operator|->
name|packet_qtype
operator|=
name|LDNS_RR_TYPE_DS
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|dss
argument_list|)
expr_stmt|;
block|}
name|ldns_pkt_free
argument_list|(
name|my_pkt
argument_list|)
expr_stmt|;
block|}
name|my_pkt
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|key_name
argument_list|,
name|LDNS_RR_TYPE_DNSKEY
argument_list|,
name|c
argument_list|,
name|qflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_pkt
condition|)
block|{
name|signatures2
operator|=
name|ldns_pkt_rr_list_by_name_and_type
argument_list|(
name|my_pkt
argument_list|,
name|key_name
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
if|if
condition|(
name|signatures2
condition|)
block|{
if|if
condition|(
name|new_chain
operator|->
name|signatures
condition|)
block|{
name|printf
argument_list|(
literal|"There were already sigs!\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|new_chain
operator|->
name|signatures
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"replacing the old sigs\n"
argument_list|)
expr_stmt|;
block|}
name|new_chain
operator|->
name|signatures
operator|=
name|signatures2
expr_stmt|;
block|}
name|ldns_pkt_free
argument_list|(
name|my_pkt
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|ldns_dnssec_data_chain
modifier|*
name|ldns_dnssec_build_data_chain_nokeyname
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|uint16_t
name|qflags
parameter_list|,
name|ldns_rr
modifier|*
name|orig_rr
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|new_chain
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|possible_parent_name
decl_stmt|;
name|ldns_pkt
modifier|*
name|my_pkt
decl_stmt|;
comment|/* apparently we were not able to find a signing key, so 	   we assume the chain ends here 	*/
comment|/* try parents for auth denial of DS */
if|if
condition|(
name|orig_rr
condition|)
block|{
name|possible_parent_name
operator|=
name|ldns_rr_owner
argument_list|(
name|orig_rr
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|rrset
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|rrset
argument_list|)
operator|>
literal|0
condition|)
block|{
name|possible_parent_name
operator|=
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrset
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no information to go on, give up */
return|return
name|new_chain
return|;
block|}
name|my_pkt
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|possible_parent_name
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
name|qflags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|my_pkt
condition|)
block|{
return|return
name|new_chain
return|;
block|}
if|if
condition|(
name|ldns_pkt_ancount
argument_list|(
name|my_pkt
argument_list|)
operator|>
literal|0
condition|)
block|{
comment|/* add error, no sigs but DS in parent */
comment|/*ldns_pkt_print(stdout, my_pkt);*/
name|ldns_pkt_free
argument_list|(
name|my_pkt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* are there signatures? */
name|new_chain
operator|->
name|parent
operator|=
name|ldns_dnssec_build_data_chain
argument_list|(
name|res
argument_list|,
name|qflags
argument_list|,
name|NULL
argument_list|,
name|my_pkt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|new_chain
operator|->
name|parent
operator|->
name|packet_qtype
operator|=
name|LDNS_RR_TYPE_DS
expr_stmt|;
block|}
return|return
name|new_chain
return|;
block|}
end_function

begin_function
name|ldns_dnssec_data_chain
modifier|*
name|ldns_dnssec_build_data_chain
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|uint16_t
name|qflags
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
specifier|const
name|ldns_pkt
modifier|*
name|pkt
parameter_list|,
name|ldns_rr
modifier|*
name|orig_rr
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|signatures
init|=
name|NULL
decl_stmt|;
name|ldns_rr_list
modifier|*
name|dss
init|=
name|NULL
decl_stmt|;
name|ldns_rr_list
modifier|*
name|my_rrset
decl_stmt|;
name|ldns_pkt
modifier|*
name|my_pkt
decl_stmt|;
name|ldns_rdf
modifier|*
name|name
init|=
name|NULL
decl_stmt|,
modifier|*
name|key_name
init|=
name|NULL
decl_stmt|;
name|ldns_rr_type
name|type
init|=
literal|0
decl_stmt|;
name|ldns_rr_class
name|c
init|=
literal|0
decl_stmt|;
name|bool
name|other_rrset
init|=
name|false
decl_stmt|;
name|ldns_dnssec_data_chain
modifier|*
name|new_chain
init|=
name|ldns_dnssec_data_chain_new
argument_list|()
decl_stmt|;
name|assert
argument_list|(
name|pkt
operator|!=
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ldns_dnssec_pkt_has_rrsigs
argument_list|(
name|pkt
argument_list|)
condition|)
block|{
comment|/* hmm. no dnssec data in the packet. go up to try and deny 		 * DS? */
return|return
name|new_chain
return|;
block|}
if|if
condition|(
name|orig_rr
condition|)
block|{
name|new_chain
operator|->
name|rrset
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
name|ldns_rr_list_push_rr
argument_list|(
name|new_chain
operator|->
name|rrset
argument_list|,
name|orig_rr
argument_list|)
expr_stmt|;
name|new_chain
operator|->
name|parent
operator|=
name|ldns_dnssec_build_data_chain
argument_list|(
name|res
argument_list|,
name|qflags
argument_list|,
name|rrset
argument_list|,
name|pkt
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|new_chain
operator|->
name|packet_rcode
operator|=
name|ldns_pkt_get_rcode
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
name|new_chain
operator|->
name|packet_qtype
operator|=
name|ldns_rr_get_type
argument_list|(
name|orig_rr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_pkt_ancount
argument_list|(
name|pkt
argument_list|)
operator|==
literal|0
condition|)
block|{
name|new_chain
operator|->
name|packet_nodata
operator|=
name|true
expr_stmt|;
block|}
return|return
name|new_chain
return|;
block|}
if|if
condition|(
operator|!
name|rrset
operator|||
name|ldns_rr_list_rr_count
argument_list|(
name|rrset
argument_list|)
operator|<
literal|1
condition|)
block|{
comment|/* hmm, no data, do we have denial? only works if pkt was given, 		   otherwise caller has to do the check himself */
name|new_chain
operator|->
name|packet_nodata
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|pkt
condition|)
block|{
name|my_rrset
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|pkt
argument_list|,
name|LDNS_RR_TYPE_NSEC
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_rrset
condition|)
block|{
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|my_rrset
argument_list|)
operator|>
literal|0
condition|)
block|{
name|type
operator|=
name|LDNS_RR_TYPE_NSEC
expr_stmt|;
name|other_rrset
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|my_rrset
argument_list|)
expr_stmt|;
name|my_rrset
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* nothing, try nsec3 */
name|my_rrset
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|pkt
argument_list|,
name|LDNS_RR_TYPE_NSEC3
argument_list|,
name|LDNS_SECTION_ANY_NOQUESTION
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_rrset
condition|)
block|{
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|my_rrset
argument_list|)
operator|>
literal|0
condition|)
block|{
name|type
operator|=
name|LDNS_RR_TYPE_NSEC3
expr_stmt|;
name|other_rrset
operator|=
name|true
expr_stmt|;
block|}
else|else
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|my_rrset
argument_list|)
expr_stmt|;
name|my_rrset
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* nothing, stop */
comment|/* try parent zone? for denied insecure? */
return|return
name|new_chain
return|;
block|}
block|}
block|}
else|else
block|{
return|return
name|new_chain
return|;
block|}
block|}
else|else
block|{
name|my_rrset
operator|=
operator|(
name|ldns_rr_list
operator|*
operator|)
name|rrset
expr_stmt|;
block|}
if|if
condition|(
name|my_rrset
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|my_rrset
argument_list|)
operator|>
literal|0
condition|)
block|{
name|new_chain
operator|->
name|rrset
operator|=
name|ldns_rr_list_clone
argument_list|(
name|my_rrset
argument_list|)
expr_stmt|;
name|name
operator|=
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|my_rrset
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|type
operator|=
name|ldns_rr_get_type
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|my_rrset
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|c
operator|=
name|ldns_rr_get_class
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|my_rrset
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|other_rrset
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|my_rrset
argument_list|)
expr_stmt|;
block|}
comment|/* normally there will only be 1 signature 'set' 	   but there can be more than 1 denial (wildcards) 	   so check for NSEC 	*/
if|if
condition|(
name|type
operator|==
name|LDNS_RR_TYPE_NSEC
operator|||
name|type
operator|==
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
comment|/* just throw in all signatures, the tree builder must sort 		   this out */
if|if
condition|(
name|pkt
condition|)
block|{
name|signatures
operator|=
name|ldns_dnssec_pkt_get_rrsigs_for_type
argument_list|(
name|pkt
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|my_pkt
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|c
argument_list|,
name|qflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_pkt
condition|)
block|{
name|signatures
operator|=
name|ldns_dnssec_pkt_get_rrsigs_for_type
argument_list|(
name|pkt
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|my_pkt
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
if|if
condition|(
name|pkt
condition|)
block|{
name|signatures
operator|=
name|ldns_dnssec_pkt_get_rrsigs_for_name_and_type
argument_list|(
name|pkt
argument_list|,
name|name
argument_list|,
name|type
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|signatures
condition|)
block|{
name|my_pkt
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|name
argument_list|,
name|type
argument_list|,
name|c
argument_list|,
name|qflags
argument_list|)
expr_stmt|;
if|if
condition|(
name|my_pkt
condition|)
block|{
name|signatures
operator|=
name|ldns_dnssec_pkt_get_rrsigs_for_name_and_type
argument_list|(
name|my_pkt
argument_list|,
name|name
argument_list|,
name|type
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|my_pkt
argument_list|)
expr_stmt|;
block|}
block|}
block|}
if|if
condition|(
name|signatures
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|signatures
argument_list|)
operator|>
literal|0
condition|)
block|{
name|key_name
operator|=
name|ldns_rr_rdf
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|signatures
argument_list|,
literal|0
argument_list|)
argument_list|,
literal|7
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|key_name
condition|)
block|{
if|if
condition|(
name|signatures
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|signatures
argument_list|)
expr_stmt|;
block|}
return|return
name|ldns_dnssec_build_data_chain_nokeyname
argument_list|(
name|res
argument_list|,
name|qflags
argument_list|,
name|orig_rr
argument_list|,
name|rrset
argument_list|,
name|new_chain
argument_list|)
return|;
block|}
if|if
condition|(
name|type
operator|!=
name|LDNS_RR_TYPE_DNSKEY
condition|)
block|{
name|ldns_dnssec_build_data_chain_dnskey
argument_list|(
name|res
argument_list|,
name|qflags
argument_list|,
name|pkt
argument_list|,
name|signatures
argument_list|,
name|new_chain
argument_list|,
name|key_name
argument_list|,
name|c
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_dnssec_build_data_chain_other
argument_list|(
name|res
argument_list|,
name|qflags
argument_list|,
name|new_chain
argument_list|,
name|key_name
argument_list|,
name|c
argument_list|,
name|dss
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|signatures
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|signatures
argument_list|)
expr_stmt|;
block|}
return|return
name|new_chain
return|;
block|}
end_function

begin_function
name|ldns_dnssec_trust_tree
modifier|*
name|ldns_dnssec_trust_tree_new
parameter_list|()
block|{
name|ldns_dnssec_trust_tree
modifier|*
name|new_tree
init|=
name|LDNS_XMALLOC
argument_list|(
name|ldns_dnssec_trust_tree
argument_list|,
literal|1
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|new_tree
condition|)
return|return
name|NULL
return|;
name|new_tree
operator|->
name|rr
operator|=
name|NULL
expr_stmt|;
name|new_tree
operator|->
name|rrset
operator|=
name|NULL
expr_stmt|;
name|new_tree
operator|->
name|parent_count
operator|=
literal|0
expr_stmt|;
return|return
name|new_tree
return|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_trust_tree_free
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|tree
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|tree
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tree
operator|->
name|parent_count
condition|;
name|i
operator|++
control|)
block|{
name|ldns_dnssec_trust_tree_free
argument_list|(
name|tree
operator|->
name|parents
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
block|}
name|LDNS_FREE
argument_list|(
name|tree
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|size_t
name|ldns_dnssec_trust_tree_depth
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|tree
parameter_list|)
block|{
name|size_t
name|result
init|=
literal|0
decl_stmt|;
name|size_t
name|parent
init|=
literal|0
decl_stmt|;
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tree
operator|->
name|parent_count
condition|;
name|i
operator|++
control|)
block|{
name|parent
operator|=
name|ldns_dnssec_trust_tree_depth
argument_list|(
name|tree
operator|->
name|parents
index|[
name|i
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|parent
operator|>
name|result
condition|)
block|{
name|result
operator|=
name|parent
expr_stmt|;
block|}
block|}
return|return
literal|1
operator|+
name|result
return|;
block|}
end_function

begin_comment
comment|/* TODO ldns_ */
end_comment

begin_function
specifier|static
name|void
name|print_tabs
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|size_t
name|nr
parameter_list|,
name|uint8_t
modifier|*
name|map
parameter_list|,
name|size_t
name|treedepth
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|nr
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|i
operator|==
name|nr
operator|-
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"|---"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|map
operator|&&
name|i
operator|<
name|treedepth
operator|&&
name|map
index|[
name|i
index|]
operator|==
literal|1
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"|   "
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"    "
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_trust_tree_print_sm_fmt
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_output_format
modifier|*
name|fmt
parameter_list|,
name|ldns_dnssec_trust_tree
modifier|*
name|tree
parameter_list|,
name|size_t
name|tabs
parameter_list|,
name|bool
name|extended
parameter_list|,
name|uint8_t
modifier|*
name|sibmap
parameter_list|,
name|size_t
name|treedepth
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
specifier|const
name|ldns_rr_descriptor
modifier|*
name|descriptor
decl_stmt|;
name|bool
name|mapset
init|=
name|false
decl_stmt|;
if|if
condition|(
operator|!
name|sibmap
condition|)
block|{
name|treedepth
operator|=
name|ldns_dnssec_trust_tree_depth
argument_list|(
name|tree
argument_list|)
expr_stmt|;
name|sibmap
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|treedepth
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|sibmap
condition|)
return|return;
comment|/* mem err */
name|memset
argument_list|(
name|sibmap
argument_list|,
literal|0
argument_list|,
name|treedepth
argument_list|)
expr_stmt|;
name|mapset
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|tree
condition|)
block|{
if|if
condition|(
name|tree
operator|->
name|rr
condition|)
block|{
name|print_tabs
argument_list|(
name|out
argument_list|,
name|tabs
argument_list|,
name|sibmap
argument_list|,
name|treedepth
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|out
argument_list|,
name|ldns_rr_owner
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
argument_list|)
expr_stmt|;
name|descriptor
operator|=
name|ldns_rr_descript
argument_list|(
name|ldns_rr_get_type
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|descriptor
operator|->
name|_name
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" (%s"
argument_list|,
name|descriptor
operator|->
name|_name
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" (TYPE%d"
argument_list|,
name|ldns_rr_get_type
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tabs
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_DNSKEY
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" keytag: %u"
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|ldns_calc_keytag
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" alg: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|out
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|tree
operator|->
name|rr
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" flags: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|out
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|tree
operator|->
name|rr
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_DS
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" keytag: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|out
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|tree
operator|->
name|rr
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" digest type: "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|out
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|tree
operator|->
name|rr
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|out
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|tree
operator|->
name|rr
argument_list|,
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|" "
argument_list|)
expr_stmt|;
name|ldns_rdf_print
argument_list|(
name|out
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|tree
operator|->
name|rr
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|fprintf
argument_list|(
name|out
argument_list|,
literal|")\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tree
operator|->
name|parent_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|tree
operator|->
name|parent_count
operator|>
literal|1
operator|&&
name|i
operator|<
name|tree
operator|->
name|parent_count
operator|-
literal|1
condition|)
block|{
name|sibmap
index|[
name|tabs
index|]
operator|=
literal|1
expr_stmt|;
block|}
else|else
block|{
name|sibmap
index|[
name|tabs
index|]
operator|=
literal|0
expr_stmt|;
block|}
comment|/* only print errors */
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|tree
operator|->
name|parents
index|[
name|i
index|]
operator|->
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC
operator|||
name|ldns_rr_get_type
argument_list|(
name|tree
operator|->
name|parents
index|[
name|i
index|]
operator|->
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
if|if
condition|(
name|tree
operator|->
name|parent_status
index|[
name|i
index|]
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|print_tabs
argument_list|(
name|out
argument_list|,
name|tabs
operator|+
literal|1
argument_list|,
name|sibmap
argument_list|,
name|treedepth
argument_list|)
expr_stmt|;
if|if
condition|(
name|tabs
operator|==
literal|0
operator|&&
name|ldns_rr_get_type
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NS
operator|&&
name|ldns_rr_rd_count
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
operator|>
literal|0
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Existence of DS is denied by:\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Existence is denied by:\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* NS records aren't signed */
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NS
condition|)
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Existence of DS is denied by:\n"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|print_tabs
argument_list|(
name|out
argument_list|,
name|tabs
operator|+
literal|1
argument_list|,
name|sibmap
argument_list|,
name|treedepth
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"Error in denial of existence: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|tree
operator|->
name|parent_status
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|tree
operator|->
name|parent_status
index|[
name|i
index|]
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|print_tabs
argument_list|(
name|out
argument_list|,
name|tabs
operator|+
literal|1
argument_list|,
name|sibmap
argument_list|,
name|treedepth
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"%s:\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|tree
operator|->
name|parent_status
index|[
name|i
index|]
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|tree
operator|->
name|parent_status
index|[
name|i
index|]
operator|==
name|LDNS_STATUS_SSL_ERR
condition|)
block|{
name|printf
argument_list|(
literal|"; SSL Error: "
argument_list|)
expr_stmt|;
name|ERR_load_crypto_strings
argument_list|()
expr_stmt|;
name|ERR_print_errors_fp
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"\n"
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|tree
operator|->
name|parent_signature
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"For RRset:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_list_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|tree
operator|->
name|rrset
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"With key:\n"
argument_list|)
expr_stmt|;
name|ldns_rr_print_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|tree
operator|->
name|parents
index|[
name|i
index|]
operator|->
name|rr
argument_list|)
expr_stmt|;
block|}
name|ldns_dnssec_trust_tree_print_sm_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|tree
operator|->
name|parents
index|[
name|i
index|]
argument_list|,
name|tabs
operator|+
literal|1
argument_list|,
name|extended
argument_list|,
name|sibmap
argument_list|,
name|treedepth
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|print_tabs
argument_list|(
name|out
argument_list|,
name|tabs
argument_list|,
name|sibmap
argument_list|,
name|treedepth
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"<no data>\n"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|fprintf
argument_list|(
name|out
argument_list|,
literal|"<null pointer>\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mapset
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|sibmap
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_trust_tree_print_sm
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|ldns_dnssec_trust_tree
modifier|*
name|tree
parameter_list|,
name|size_t
name|tabs
parameter_list|,
name|bool
name|extended
parameter_list|,
name|uint8_t
modifier|*
name|sibmap
parameter_list|,
name|size_t
name|treedepth
parameter_list|)
block|{
name|ldns_dnssec_trust_tree_print_sm_fmt
argument_list|(
name|out
argument_list|,
name|ldns_output_format_default
argument_list|,
name|tree
argument_list|,
name|tabs
argument_list|,
name|extended
argument_list|,
name|sibmap
argument_list|,
name|treedepth
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_trust_tree_print_fmt
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
specifier|const
name|ldns_output_format
modifier|*
name|fmt
parameter_list|,
name|ldns_dnssec_trust_tree
modifier|*
name|tree
parameter_list|,
name|size_t
name|tabs
parameter_list|,
name|bool
name|extended
parameter_list|)
block|{
name|ldns_dnssec_trust_tree_print_sm_fmt
argument_list|(
name|out
argument_list|,
name|fmt
argument_list|,
name|tree
argument_list|,
name|tabs
argument_list|,
name|extended
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_trust_tree_print
parameter_list|(
name|FILE
modifier|*
name|out
parameter_list|,
name|ldns_dnssec_trust_tree
modifier|*
name|tree
parameter_list|,
name|size_t
name|tabs
parameter_list|,
name|bool
name|extended
parameter_list|)
block|{
name|ldns_dnssec_trust_tree_print_fmt
argument_list|(
name|out
argument_list|,
name|ldns_output_format_default
argument_list|,
name|tree
argument_list|,
name|tabs
argument_list|,
name|extended
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_dnssec_trust_tree_add_parent
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|tree
parameter_list|,
specifier|const
name|ldns_dnssec_trust_tree
modifier|*
name|parent
parameter_list|,
specifier|const
name|ldns_rr
modifier|*
name|signature
parameter_list|,
specifier|const
name|ldns_status
name|parent_status
parameter_list|)
block|{
if|if
condition|(
name|tree
operator|&&
name|parent
operator|&&
name|tree
operator|->
name|parent_count
operator|<
name|LDNS_DNSSEC_TRUST_TREE_MAX_PARENTS
condition|)
block|{
comment|/* 		  printf("Add parent for: "); 		  ldns_rr_print(stdout, tree->rr); 		  printf("parent: "); 		  ldns_rr_print(stdout, parent->rr); 		*/
name|tree
operator|->
name|parents
index|[
name|tree
operator|->
name|parent_count
index|]
operator|=
operator|(
name|ldns_dnssec_trust_tree
operator|*
operator|)
name|parent
expr_stmt|;
name|tree
operator|->
name|parent_status
index|[
name|tree
operator|->
name|parent_count
index|]
operator|=
name|parent_status
expr_stmt|;
name|tree
operator|->
name|parent_signature
index|[
name|tree
operator|->
name|parent_count
index|]
operator|=
operator|(
name|ldns_rr
operator|*
operator|)
name|signature
expr_stmt|;
name|tree
operator|->
name|parent_count
operator|++
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
else|else
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
block|}
end_function

begin_comment
comment|/* if rr is null, take the first from the rrset */
end_comment

begin_function
name|ldns_dnssec_trust_tree
modifier|*
name|ldns_dnssec_derive_trust_tree_time
parameter_list|(
name|ldns_dnssec_data_chain
modifier|*
name|data_chain
parameter_list|,
name|ldns_rr
modifier|*
name|rr
parameter_list|,
name|time_t
name|check_time
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|cur_rrset
decl_stmt|;
name|ldns_rr_list
modifier|*
name|cur_sigs
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_rr
init|=
name|NULL
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_sig_rr
decl_stmt|;
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ldns_dnssec_trust_tree
modifier|*
name|new_tree
init|=
name|ldns_dnssec_trust_tree_new
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|new_tree
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|data_chain
operator|&&
name|data_chain
operator|->
name|rrset
condition|)
block|{
name|cur_rrset
operator|=
name|data_chain
operator|->
name|rrset
expr_stmt|;
name|cur_sigs
operator|=
name|data_chain
operator|->
name|signatures
expr_stmt|;
if|if
condition|(
name|rr
condition|)
block|{
name|cur_rr
operator|=
name|rr
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|cur_rr
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|cur_rrset
argument_list|)
operator|>
literal|0
condition|)
block|{
name|cur_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|cur_rrset
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|cur_rr
condition|)
block|{
name|new_tree
operator|->
name|rr
operator|=
name|cur_rr
expr_stmt|;
name|new_tree
operator|->
name|rrset
operator|=
name|cur_rrset
expr_stmt|;
comment|/* there are three possibilities: 			   1 - 'normal' rrset, signed by a key 			   2 - dnskey signed by other dnskey 			   3 - dnskey proven by higher level DS 			   (data denied by nsec is a special case that can 			   occur in multiple places) 				    			*/
if|if
condition|(
name|cur_sigs
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|cur_sigs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
comment|/* find the appropriate key in the parent list */
name|cur_sig_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|cur_sigs
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|cur_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC
condition|)
block|{
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|cur_sig_rr
argument_list|)
argument_list|,
name|ldns_rr_owner
argument_list|(
name|cur_rr
argument_list|)
argument_list|)
condition|)
block|{
comment|/* find first that does match */
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|cur_rrset
argument_list|)
operator|&&
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|cur_sig_rr
argument_list|)
argument_list|,
name|ldns_rr_owner
argument_list|(
name|cur_rr
argument_list|)
argument_list|)
operator|!=
literal|0
condition|;
name|j
operator|++
control|)
block|{
name|cur_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|cur_rrset
argument_list|,
name|j
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|cur_sig_rr
argument_list|)
argument_list|,
name|ldns_rr_owner
argument_list|(
name|cur_rr
argument_list|)
argument_list|)
condition|)
block|{
break|break;
block|}
block|}
block|}
comment|/* option 1 */
if|if
condition|(
name|data_chain
operator|->
name|parent
condition|)
block|{
name|ldns_dnssec_derive_trust_tree_normal_rrset_time
argument_list|(
name|new_tree
argument_list|,
name|data_chain
argument_list|,
name|cur_sig_rr
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
block|}
comment|/* option 2 */
name|ldns_dnssec_derive_trust_tree_dnskey_rrset_time
argument_list|(
name|new_tree
argument_list|,
name|data_chain
argument_list|,
name|cur_rr
argument_list|,
name|cur_sig_rr
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
block|}
name|ldns_dnssec_derive_trust_tree_ds_rrset_time
argument_list|(
name|new_tree
argument_list|,
name|data_chain
argument_list|,
name|cur_rr
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* no signatures? maybe it's nsec data */
comment|/* just add every rr from parent as new parent */
name|ldns_dnssec_derive_trust_tree_no_sig_time
argument_list|(
name|new_tree
argument_list|,
name|data_chain
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|new_tree
return|;
block|}
end_function

begin_function
name|ldns_dnssec_trust_tree
modifier|*
name|ldns_dnssec_derive_trust_tree
parameter_list|(
name|ldns_dnssec_data_chain
modifier|*
name|data_chain
parameter_list|,
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
return|return
name|ldns_dnssec_derive_trust_tree_time
argument_list|(
name|data_chain
argument_list|,
name|rr
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_derive_trust_tree_normal_rrset_time
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|new_tree
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|data_chain
parameter_list|,
name|ldns_rr
modifier|*
name|cur_sig_rr
parameter_list|,
name|time_t
name|check_time
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ldns_rr_list
modifier|*
name|cur_rrset
init|=
name|ldns_rr_list_clone
argument_list|(
name|data_chain
operator|->
name|rrset
argument_list|)
decl_stmt|;
name|ldns_dnssec_trust_tree
modifier|*
name|cur_parent_tree
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_parent_rr
decl_stmt|;
name|uint16_t
name|cur_keytag
decl_stmt|;
name|ldns_rr_list
modifier|*
name|tmp_rrset
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|cur_status
decl_stmt|;
name|cur_keytag
operator|=
name|ldns_rdf2native_int16
argument_list|(
name|ldns_rr_rrsig_keytag
argument_list|(
name|cur_sig_rr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|data_chain
operator|->
name|parent
operator|->
name|rrset
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|cur_parent_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|data_chain
operator|->
name|parent
operator|->
name|rrset
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|cur_parent_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_DNSKEY
condition|)
block|{
if|if
condition|(
name|ldns_calc_keytag
argument_list|(
name|cur_parent_rr
argument_list|)
operator|==
name|cur_keytag
condition|)
block|{
comment|/* TODO: check wildcard nsec too */
if|if
condition|(
name|cur_rrset
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|cur_rrset
argument_list|)
operator|>
literal|0
condition|)
block|{
name|tmp_rrset
operator|=
name|cur_rrset
expr_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|cur_rrset
argument_list|,
literal|0
argument_list|)
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC
operator|||
name|ldns_rr_get_type
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|cur_rrset
argument_list|,
literal|0
argument_list|)
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
comment|/* might contain different names!  						   sort and split */
name|ldns_rr_list_sort
argument_list|(
name|cur_rrset
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|tmp_rrset
operator|==
name|cur_rrset
argument_list|)
expr_stmt|;
name|tmp_rrset
operator|=
name|ldns_rr_list_pop_rrset
argument_list|(
name|cur_rrset
argument_list|)
expr_stmt|;
comment|/* with nsecs, this might be the wrong one */
while|while
condition|(
name|tmp_rrset
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|cur_rrset
argument_list|)
operator|>
literal|0
operator|&&
name|ldns_dname_compare
argument_list|(
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|tmp_rrset
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|,
name|ldns_rr_owner
argument_list|(
name|cur_sig_rr
argument_list|)
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|tmp_rrset
argument_list|)
expr_stmt|;
name|tmp_rrset
operator|=
name|ldns_rr_list_pop_rrset
argument_list|(
name|cur_rrset
argument_list|)
expr_stmt|;
block|}
block|}
name|cur_status
operator|=
name|ldns_verify_rrsig_time
argument_list|(
name|tmp_rrset
argument_list|,
name|cur_sig_rr
argument_list|,
name|cur_parent_rr
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|tmp_rrset
operator|&&
name|tmp_rrset
operator|!=
name|cur_rrset
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|tmp_rrset
argument_list|)
expr_stmt|;
name|tmp_rrset
operator|=
name|NULL
expr_stmt|;
block|}
comment|/* avoid dupes */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|new_tree
operator|->
name|parent_count
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|cur_parent_rr
operator|==
name|new_tree
operator|->
name|parents
index|[
name|i
index|]
operator|->
name|rr
condition|)
block|{
goto|goto
name|done
goto|;
block|}
block|}
name|cur_parent_tree
operator|=
name|ldns_dnssec_derive_trust_tree_time
argument_list|(
name|data_chain
operator|->
name|parent
argument_list|,
name|cur_parent_rr
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dnssec_trust_tree_add_parent
argument_list|(
name|new_tree
argument_list|,
name|cur_parent_tree
argument_list|,
name|cur_sig_rr
argument_list|,
name|cur_status
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
name|done
label|:
name|ldns_rr_list_deep_free
argument_list|(
name|cur_rrset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_derive_trust_tree_normal_rrset
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|new_tree
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|data_chain
parameter_list|,
name|ldns_rr
modifier|*
name|cur_sig_rr
parameter_list|)
block|{
name|ldns_dnssec_derive_trust_tree_normal_rrset_time
argument_list|(
name|new_tree
argument_list|,
name|data_chain
argument_list|,
name|cur_sig_rr
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_derive_trust_tree_dnskey_rrset_time
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|new_tree
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|data_chain
parameter_list|,
name|ldns_rr
modifier|*
name|cur_rr
parameter_list|,
name|ldns_rr
modifier|*
name|cur_sig_rr
parameter_list|,
name|time_t
name|check_time
parameter_list|)
block|{
name|size_t
name|j
decl_stmt|;
name|ldns_rr_list
modifier|*
name|cur_rrset
init|=
name|data_chain
operator|->
name|rrset
decl_stmt|;
name|ldns_dnssec_trust_tree
modifier|*
name|cur_parent_tree
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_parent_rr
decl_stmt|;
name|uint16_t
name|cur_keytag
decl_stmt|;
name|ldns_status
name|cur_status
decl_stmt|;
name|cur_keytag
operator|=
name|ldns_rdf2native_int16
argument_list|(
name|ldns_rr_rrsig_keytag
argument_list|(
name|cur_sig_rr
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|cur_rrset
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|cur_parent_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|cur_rrset
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|cur_parent_rr
operator|!=
name|cur_rr
operator|&&
name|ldns_rr_get_type
argument_list|(
name|cur_parent_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_DNSKEY
condition|)
block|{
if|if
condition|(
name|ldns_calc_keytag
argument_list|(
name|cur_parent_rr
argument_list|)
operator|==
name|cur_keytag
condition|)
block|{
name|cur_parent_tree
operator|=
name|ldns_dnssec_trust_tree_new
argument_list|()
expr_stmt|;
name|cur_parent_tree
operator|->
name|rr
operator|=
name|cur_parent_rr
expr_stmt|;
name|cur_parent_tree
operator|->
name|rrset
operator|=
name|cur_rrset
expr_stmt|;
name|cur_status
operator|=
name|ldns_verify_rrsig_time
argument_list|(
name|cur_rrset
argument_list|,
name|cur_sig_rr
argument_list|,
name|cur_parent_rr
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dnssec_trust_tree_add_parent
argument_list|(
name|new_tree
argument_list|,
name|cur_parent_tree
argument_list|,
name|cur_sig_rr
argument_list|,
name|cur_status
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_derive_trust_tree_dnskey_rrset
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|new_tree
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|data_chain
parameter_list|,
name|ldns_rr
modifier|*
name|cur_rr
parameter_list|,
name|ldns_rr
modifier|*
name|cur_sig_rr
parameter_list|)
block|{
name|ldns_dnssec_derive_trust_tree_dnskey_rrset_time
argument_list|(
name|new_tree
argument_list|,
name|data_chain
argument_list|,
name|cur_rr
argument_list|,
name|cur_sig_rr
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_derive_trust_tree_ds_rrset_time
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|new_tree
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|data_chain
parameter_list|,
name|ldns_rr
modifier|*
name|cur_rr
parameter_list|,
name|time_t
name|check_time
parameter_list|)
block|{
name|size_t
name|j
decl_stmt|,
name|h
decl_stmt|;
name|ldns_rr_list
modifier|*
name|cur_rrset
init|=
name|data_chain
operator|->
name|rrset
decl_stmt|;
name|ldns_dnssec_trust_tree
modifier|*
name|cur_parent_tree
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_parent_rr
decl_stmt|;
comment|/* try the parent to see whether there are DSs there */
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|cur_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_DNSKEY
operator|&&
name|data_chain
operator|->
name|parent
operator|&&
name|data_chain
operator|->
name|parent
operator|->
name|rrset
condition|)
block|{
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|data_chain
operator|->
name|parent
operator|->
name|rrset
argument_list|)
condition|;
name|j
operator|++
control|)
block|{
name|cur_parent_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|data_chain
operator|->
name|parent
operator|->
name|rrset
argument_list|,
name|j
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|cur_parent_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_DS
condition|)
block|{
for|for
control|(
name|h
operator|=
literal|0
init|;
name|h
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|cur_rrset
argument_list|)
condition|;
name|h
operator|++
control|)
block|{
name|cur_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|cur_rrset
argument_list|,
name|h
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_compare_ds
argument_list|(
name|cur_rr
argument_list|,
name|cur_parent_rr
argument_list|)
condition|)
block|{
name|cur_parent_tree
operator|=
name|ldns_dnssec_derive_trust_tree_time
argument_list|(
name|data_chain
operator|->
name|parent
argument_list|,
name|cur_parent_rr
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dnssec_trust_tree_add_parent
argument_list|(
name|new_tree
argument_list|,
name|cur_parent_tree
argument_list|,
name|NULL
argument_list|,
name|LDNS_STATUS_OK
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/*ldns_rr_print(stdout, cur_parent_rr);*/
block|}
block|}
block|}
block|}
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_derive_trust_tree_ds_rrset
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|new_tree
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|data_chain
parameter_list|,
name|ldns_rr
modifier|*
name|cur_rr
parameter_list|)
block|{
name|ldns_dnssec_derive_trust_tree_ds_rrset_time
argument_list|(
name|new_tree
argument_list|,
name|data_chain
argument_list|,
name|cur_rr
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_dnssec_derive_trust_tree_no_sig_time
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|new_tree
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|data_chain
parameter_list|,
name|time_t
name|check_time
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|ldns_rr_list
modifier|*
name|cur_rrset
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_parent_rr
decl_stmt|;
name|ldns_dnssec_trust_tree
modifier|*
name|cur_parent_tree
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
if|if
condition|(
name|data_chain
operator|->
name|parent
operator|&&
name|data_chain
operator|->
name|parent
operator|->
name|rrset
condition|)
block|{
name|cur_rrset
operator|=
name|data_chain
operator|->
name|parent
operator|->
name|rrset
expr_stmt|;
comment|/* nsec? */
if|if
condition|(
name|cur_rrset
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|cur_rrset
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|cur_rrset
argument_list|,
literal|0
argument_list|)
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC3
condition|)
block|{
name|result
operator|=
name|ldns_dnssec_verify_denial_nsec3
argument_list|(
name|new_tree
operator|->
name|rr
argument_list|,
name|cur_rrset
argument_list|,
name|data_chain
operator|->
name|parent
operator|->
name|signatures
argument_list|,
name|data_chain
operator|->
name|packet_rcode
argument_list|,
name|data_chain
operator|->
name|packet_qtype
argument_list|,
name|data_chain
operator|->
name|packet_nodata
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|cur_rrset
argument_list|,
literal|0
argument_list|)
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC
condition|)
block|{
name|result
operator|=
name|ldns_dnssec_verify_denial
argument_list|(
name|new_tree
operator|->
name|rr
argument_list|,
name|cur_rrset
argument_list|,
name|data_chain
operator|->
name|parent
operator|->
name|signatures
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* unsigned zone, unsigned parent */
name|result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
block|}
block|}
else|else
block|{
name|result
operator|=
name|LDNS_STATUS_DNSSEC_NSEC_RR_NOT_COVERED
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|cur_rrset
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cur_parent_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|cur_rrset
argument_list|,
name|i
argument_list|)
expr_stmt|;
name|cur_parent_tree
operator|=
name|ldns_dnssec_derive_trust_tree_time
argument_list|(
name|data_chain
operator|->
name|parent
argument_list|,
name|cur_parent_rr
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dnssec_trust_tree_add_parent
argument_list|(
name|new_tree
argument_list|,
name|cur_parent_tree
argument_list|,
name|NULL
argument_list|,
name|result
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|ldns_dnssec_derive_trust_tree_no_sig
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|new_tree
parameter_list|,
name|ldns_dnssec_data_chain
modifier|*
name|data_chain
parameter_list|)
block|{
name|ldns_dnssec_derive_trust_tree_no_sig_time
argument_list|(
name|new_tree
argument_list|,
name|data_chain
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * returns OK if there is a path from tree to key with only OK  * the (first) error in between otherwise  * or NOT_FOUND if the key wasn't present at all  */
end_comment

begin_function
name|ldns_status
name|ldns_dnssec_trust_tree_contains_keys
parameter_list|(
name|ldns_dnssec_trust_tree
modifier|*
name|tree
parameter_list|,
name|ldns_rr_list
modifier|*
name|trusted_keys
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|ldns_status
name|result
init|=
name|LDNS_STATUS_CRYPTO_NO_DNSKEY
decl_stmt|;
name|bool
name|equal
decl_stmt|;
name|ldns_status
name|parent_result
decl_stmt|;
if|if
condition|(
name|tree
operator|&&
name|trusted_keys
operator|&&
name|ldns_rr_list_rr_count
argument_list|(
name|trusted_keys
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|tree
operator|->
name|rr
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|trusted_keys
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|equal
operator|=
name|ldns_rr_compare_ds
argument_list|(
name|tree
operator|->
name|rr
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|trusted_keys
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|equal
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
return|return
name|result
return|;
block|}
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|tree
operator|->
name|parent_count
condition|;
name|i
operator|++
control|)
block|{
name|parent_result
operator|=
name|ldns_dnssec_trust_tree_contains_keys
argument_list|(
name|tree
operator|->
name|parents
index|[
name|i
index|]
argument_list|,
name|trusted_keys
argument_list|)
expr_stmt|;
if|if
condition|(
name|parent_result
operator|!=
name|LDNS_STATUS_CRYPTO_NO_DNSKEY
condition|)
block|{
if|if
condition|(
name|tree
operator|->
name|parent_status
index|[
name|i
index|]
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|result
operator|=
name|tree
operator|->
name|parent_status
index|[
name|i
index|]
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|tree
operator|->
name|rr
operator|&&
name|ldns_rr_get_type
argument_list|(
name|tree
operator|->
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_NSEC
operator|&&
name|parent_result
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_DNSSEC_EXISTENCE_DENIED
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|parent_result
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
else|else
block|{
name|result
operator|=
name|LDNS_STATUS_ERR
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_time
parameter_list|(
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrsig
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|time_t
name|check_time
parameter_list|,
name|ldns_rr_list
modifier|*
name|good_keys
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|;
name|ldns_status
name|verify_result
init|=
name|LDNS_STATUS_ERR
decl_stmt|;
if|if
condition|(
operator|!
name|rrset
operator|||
operator|!
name|rrsig
operator|||
operator|!
name|keys
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|rrset
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|rrsig
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
name|LDNS_STATUS_CRYPTO_NO_RRSIG
return|;
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|keys
argument_list|)
operator|<
literal|1
condition|)
block|{
name|verify_result
operator|=
name|LDNS_STATUS_CRYPTO_NO_TRUSTED_DNSKEY
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrsig
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ldns_status
name|s
init|=
name|ldns_verify_rrsig_keylist_time
argument_list|(
name|rrset
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|rrsig
argument_list|,
name|i
argument_list|)
argument_list|,
name|keys
argument_list|,
name|check_time
argument_list|,
name|good_keys
argument_list|)
decl_stmt|;
comment|/* try a little to get more descriptive error */
if|if
condition|(
name|s
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|verify_result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|verify_result
operator|==
name|LDNS_STATUS_ERR
condition|)
name|verify_result
operator|=
name|s
expr_stmt|;
elseif|else
if|if
condition|(
name|s
operator|!=
name|LDNS_STATUS_ERR
operator|&&
name|verify_result
operator|==
name|LDNS_STATUS_CRYPTO_NO_MATCHING_KEYTAG_DNSKEY
condition|)
name|verify_result
operator|=
name|s
expr_stmt|;
block|}
block|}
return|return
name|verify_result
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify
parameter_list|(
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrsig
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|ldns_rr_list
modifier|*
name|good_keys
parameter_list|)
block|{
return|return
name|ldns_verify_time
argument_list|(
name|rrset
argument_list|,
name|rrsig
argument_list|,
name|keys
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|good_keys
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_notime
parameter_list|(
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrsig
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|ldns_rr_list
modifier|*
name|good_keys
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|;
name|ldns_status
name|verify_result
init|=
name|LDNS_STATUS_ERR
decl_stmt|;
if|if
condition|(
operator|!
name|rrset
operator|||
operator|!
name|rrsig
operator|||
operator|!
name|keys
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|rrset
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|rrsig
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
name|LDNS_STATUS_CRYPTO_NO_RRSIG
return|;
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|keys
argument_list|)
operator|<
literal|1
condition|)
block|{
name|verify_result
operator|=
name|LDNS_STATUS_CRYPTO_NO_TRUSTED_DNSKEY
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrsig
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ldns_status
name|s
init|=
name|ldns_verify_rrsig_keylist_notime
argument_list|(
name|rrset
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|rrsig
argument_list|,
name|i
argument_list|)
argument_list|,
name|keys
argument_list|,
name|good_keys
argument_list|)
decl_stmt|;
comment|/* try a little to get more descriptive error */
if|if
condition|(
name|s
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|verify_result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|verify_result
operator|==
name|LDNS_STATUS_ERR
condition|)
block|{
name|verify_result
operator|=
name|s
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|s
operator|!=
name|LDNS_STATUS_ERR
operator|&&
name|verify_result
operator|==
name|LDNS_STATUS_CRYPTO_NO_MATCHING_KEYTAG_DNSKEY
condition|)
block|{
name|verify_result
operator|=
name|s
expr_stmt|;
block|}
block|}
block|}
return|return
name|verify_result
return|;
block|}
end_function

begin_function
name|ldns_rr_list
modifier|*
name|ldns_fetch_valid_domain_keys_time
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|res
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|time_t
name|check_time
parameter_list|,
name|ldns_status
modifier|*
name|status
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|trusted_keys
init|=
name|NULL
decl_stmt|;
name|ldns_rr_list
modifier|*
name|ds_keys
init|=
name|NULL
decl_stmt|;
name|ldns_rdf
modifier|*
name|prev_parent_domain
decl_stmt|;
name|ldns_rdf
modifier|*
name|parent_domain
decl_stmt|;
name|ldns_rr_list
modifier|*
name|parent_keys
init|=
name|NULL
decl_stmt|;
if|if
condition|(
name|res
operator|&&
name|domain
operator|&&
name|keys
condition|)
block|{
if|if
condition|(
operator|(
name|trusted_keys
operator|=
name|ldns_validate_domain_dnskey_time
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|keys
argument_list|,
name|check_time
argument_list|)
operator|)
condition|)
block|{
operator|*
name|status
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
block|}
else|else
block|{
comment|/* No trusted keys in this domain, we'll have to find some in the parent domain */
operator|*
name|status
operator|=
name|LDNS_STATUS_CRYPTO_NO_TRUSTED_DNSKEY
expr_stmt|;
name|parent_domain
operator|=
name|ldns_dname_left_chop
argument_list|(
name|domain
argument_list|)
expr_stmt|;
while|while
condition|(
name|parent_domain
operator|&&
comment|/* Fail if we are at the root*/
name|ldns_rdf_size
argument_list|(
name|parent_domain
argument_list|)
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|parent_keys
operator|=
name|ldns_fetch_valid_domain_keys_time
argument_list|(
name|res
argument_list|,
name|parent_domain
argument_list|,
name|keys
argument_list|,
name|check_time
argument_list|,
name|status
argument_list|)
operator|)
condition|)
block|{
comment|/* Check DS records */
if|if
condition|(
operator|(
name|ds_keys
operator|=
name|ldns_validate_domain_ds_time
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|parent_keys
argument_list|,
name|check_time
argument_list|)
operator|)
condition|)
block|{
name|trusted_keys
operator|=
name|ldns_fetch_valid_domain_keys_time
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|ds_keys
argument_list|,
name|check_time
argument_list|,
name|status
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|ds_keys
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* No valid DS at the parent -- fail */
operator|*
name|status
operator|=
name|LDNS_STATUS_CRYPTO_NO_TRUSTED_DS
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|parent_keys
argument_list|)
expr_stmt|;
break|break;
block|}
else|else
block|{
name|parent_domain
operator|=
name|ldns_dname_left_chop
argument_list|(
operator|(
name|prev_parent_domain
operator|=
name|parent_domain
operator|)
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|prev_parent_domain
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|parent_domain
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|parent_domain
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|trusted_keys
return|;
block|}
end_function

begin_function
name|ldns_rr_list
modifier|*
name|ldns_fetch_valid_domain_keys
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|res
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|ldns_status
modifier|*
name|status
parameter_list|)
block|{
return|return
name|ldns_fetch_valid_domain_keys_time
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|keys
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|status
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_rr_list
modifier|*
name|ldns_validate_domain_dnskey_time
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|res
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|time_t
name|check_time
parameter_list|)
block|{
name|ldns_pkt
modifier|*
name|keypkt
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_key
decl_stmt|;
name|uint16_t
name|key_i
decl_stmt|;
name|uint16_t
name|key_j
decl_stmt|;
name|uint16_t
name|key_k
decl_stmt|;
name|uint16_t
name|sig_i
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_sig
decl_stmt|;
name|ldns_rr_list
modifier|*
name|domain_keys
init|=
name|NULL
decl_stmt|;
name|ldns_rr_list
modifier|*
name|domain_sigs
init|=
name|NULL
decl_stmt|;
name|ldns_rr_list
modifier|*
name|trusted_keys
init|=
name|NULL
decl_stmt|;
comment|/* Fetch keys for the domain */
name|keypkt
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|LDNS_RR_TYPE_DNSKEY
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
name|LDNS_RD
argument_list|)
expr_stmt|;
if|if
condition|(
name|keypkt
condition|)
block|{
name|domain_keys
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|keypkt
argument_list|,
name|LDNS_RR_TYPE_DNSKEY
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
name|domain_sigs
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|keypkt
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
comment|/* Try to validate the record using our keys */
for|for
control|(
name|key_i
operator|=
literal|0
init|;
name|key_i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|domain_keys
argument_list|)
condition|;
name|key_i
operator|++
control|)
block|{
name|cur_key
operator|=
name|ldns_rr_list_rr
argument_list|(
name|domain_keys
argument_list|,
name|key_i
argument_list|)
expr_stmt|;
for|for
control|(
name|key_j
operator|=
literal|0
init|;
name|key_j
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|keys
argument_list|)
condition|;
name|key_j
operator|++
control|)
block|{
if|if
condition|(
name|ldns_rr_compare_ds
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|keys
argument_list|,
name|key_j
argument_list|)
argument_list|,
name|cur_key
argument_list|)
condition|)
block|{
comment|/* Current key is trusted -- validate */
name|trusted_keys
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
for|for
control|(
name|sig_i
operator|=
literal|0
init|;
name|sig_i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|domain_sigs
argument_list|)
condition|;
name|sig_i
operator|++
control|)
block|{
name|cur_sig
operator|=
name|ldns_rr_list_rr
argument_list|(
name|domain_sigs
argument_list|,
name|sig_i
argument_list|)
expr_stmt|;
comment|/* Avoid non-matching sigs */
if|if
condition|(
name|ldns_rdf2native_int16
argument_list|(
name|ldns_rr_rrsig_keytag
argument_list|(
name|cur_sig
argument_list|)
argument_list|)
operator|==
name|ldns_calc_keytag
argument_list|(
name|cur_key
argument_list|)
condition|)
block|{
if|if
condition|(
name|ldns_verify_rrsig_time
argument_list|(
name|domain_keys
argument_list|,
name|cur_sig
argument_list|,
name|cur_key
argument_list|,
name|check_time
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
comment|/* Push the whole rrset  								   -- we can't do much more */
for|for
control|(
name|key_k
operator|=
literal|0
init|;
name|key_k
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|domain_keys
argument_list|)
condition|;
name|key_k
operator|++
control|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|trusted_keys
argument_list|,
name|ldns_rr_clone
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|domain_keys
argument_list|,
name|key_k
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|domain_keys
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|domain_sigs
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|keypkt
argument_list|)
expr_stmt|;
return|return
name|trusted_keys
return|;
block|}
block|}
block|}
comment|/* Only push our trusted key */
name|ldns_rr_list_push_rr
argument_list|(
name|trusted_keys
argument_list|,
name|ldns_rr_clone
argument_list|(
name|cur_key
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|domain_keys
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|domain_sigs
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|keypkt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* LDNS_STATUS_CRYPTO_NO_DNSKEY */
block|}
return|return
name|trusted_keys
return|;
block|}
end_function

begin_function
name|ldns_rr_list
modifier|*
name|ldns_validate_domain_dnskey
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|res
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|)
block|{
return|return
name|ldns_validate_domain_dnskey_time
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|keys
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_rr_list
modifier|*
name|ldns_validate_domain_ds_time
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|res
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|time_t
name|check_time
parameter_list|)
block|{
name|ldns_pkt
modifier|*
name|dspkt
decl_stmt|;
name|uint16_t
name|key_i
decl_stmt|;
name|ldns_rr_list
modifier|*
name|rrset
init|=
name|NULL
decl_stmt|;
name|ldns_rr_list
modifier|*
name|sigs
init|=
name|NULL
decl_stmt|;
name|ldns_rr_list
modifier|*
name|trusted_keys
init|=
name|NULL
decl_stmt|;
comment|/* Fetch DS for the domain */
name|dspkt
operator|=
name|ldns_resolver_query
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|,
name|LDNS_RR_CLASS_IN
argument_list|,
name|LDNS_RD
argument_list|)
expr_stmt|;
if|if
condition|(
name|dspkt
condition|)
block|{
name|rrset
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|dspkt
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
name|sigs
operator|=
name|ldns_pkt_rr_list_by_type
argument_list|(
name|dspkt
argument_list|,
name|LDNS_RR_TYPE_RRSIG
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
comment|/* Validate sigs */
if|if
condition|(
name|ldns_verify_time
argument_list|(
name|rrset
argument_list|,
name|sigs
argument_list|,
name|keys
argument_list|,
name|check_time
argument_list|,
name|NULL
argument_list|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
name|trusted_keys
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
for|for
control|(
name|key_i
operator|=
literal|0
init|;
name|key_i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrset
argument_list|)
condition|;
name|key_i
operator|++
control|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|trusted_keys
argument_list|,
name|ldns_rr_clone
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrset
argument_list|,
name|key_i
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|rrset
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|sigs
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|dspkt
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* LDNS_STATUS_CRYPTO_NO_DS */
block|}
return|return
name|trusted_keys
return|;
block|}
end_function

begin_function
name|ldns_rr_list
modifier|*
name|ldns_validate_domain_ds
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|res
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|domain
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|)
block|{
return|return
name|ldns_validate_domain_ds_time
argument_list|(
name|res
argument_list|,
name|domain
argument_list|,
name|keys
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_trusted_time
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrsigs
parameter_list|,
name|time_t
name|check_time
parameter_list|,
name|ldns_rr_list
modifier|*
name|validating_keys
parameter_list|)
block|{
name|uint16_t
name|sig_i
decl_stmt|;
name|uint16_t
name|key_i
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_sig
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_key
decl_stmt|;
name|ldns_rr_list
modifier|*
name|trusted_keys
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|result
init|=
name|LDNS_STATUS_ERR
decl_stmt|;
if|if
condition|(
operator|!
name|res
operator|||
operator|!
name|rrset
operator|||
operator|!
name|rrsigs
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|rrset
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|rrsigs
argument_list|)
operator|<
literal|1
condition|)
block|{
return|return
name|LDNS_STATUS_CRYPTO_NO_RRSIG
return|;
block|}
comment|/* Look at each sig */
for|for
control|(
name|sig_i
operator|=
literal|0
init|;
name|sig_i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrsigs
argument_list|)
condition|;
name|sig_i
operator|++
control|)
block|{
name|cur_sig
operator|=
name|ldns_rr_list_rr
argument_list|(
name|rrsigs
argument_list|,
name|sig_i
argument_list|)
expr_stmt|;
comment|/* Get a valid signer key and validate the sig */
if|if
condition|(
operator|(
name|trusted_keys
operator|=
name|ldns_fetch_valid_domain_keys_time
argument_list|(
name|res
argument_list|,
name|ldns_rr_rrsig_signame
argument_list|(
name|cur_sig
argument_list|)
argument_list|,
name|ldns_resolver_dnssec_anchors
argument_list|(
name|res
argument_list|)
argument_list|,
name|check_time
argument_list|,
operator|&
name|result
argument_list|)
operator|)
condition|)
block|{
for|for
control|(
name|key_i
operator|=
literal|0
init|;
name|key_i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|trusted_keys
argument_list|)
condition|;
name|key_i
operator|++
control|)
block|{
name|cur_key
operator|=
name|ldns_rr_list_rr
argument_list|(
name|trusted_keys
argument_list|,
name|key_i
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|result
operator|=
name|ldns_verify_rrsig_time
argument_list|(
name|rrset
argument_list|,
name|cur_sig
argument_list|,
name|cur_key
argument_list|,
name|check_time
argument_list|)
operator|)
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
if|if
condition|(
name|validating_keys
condition|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|validating_keys
argument_list|,
name|ldns_rr_clone
argument_list|(
name|cur_key
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|trusted_keys
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
block|}
block|}
block|}
name|ldns_rr_list_deep_free
argument_list|(
name|trusted_keys
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_trusted
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrsigs
parameter_list|,
name|ldns_rr_list
modifier|*
name|validating_keys
parameter_list|)
block|{
return|return
name|ldns_verify_trusted_time
argument_list|(
name|res
argument_list|,
name|rrset
argument_list|,
name|rrsigs
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|validating_keys
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_dnssec_verify_denial
parameter_list|(
name|ldns_rr
modifier|*
name|rr
parameter_list|,
name|ldns_rr_list
modifier|*
name|nsecs
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrsigs
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|rr_name
decl_stmt|;
name|ldns_rdf
modifier|*
name|wildcard_name
decl_stmt|;
name|ldns_rdf
modifier|*
name|chopped_dname
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_nsec
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
comment|/* needed for wildcard check on exact match */
name|ldns_rr
modifier|*
name|rrsig
decl_stmt|;
name|bool
name|name_covered
init|=
name|false
decl_stmt|;
name|bool
name|type_covered
init|=
name|false
decl_stmt|;
name|bool
name|wildcard_covered
init|=
name|false
decl_stmt|;
name|bool
name|wildcard_type_covered
init|=
name|false
decl_stmt|;
name|wildcard_name
operator|=
name|ldns_dname_new_frm_str
argument_list|(
literal|"*"
argument_list|)
expr_stmt|;
name|rr_name
operator|=
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
expr_stmt|;
name|chopped_dname
operator|=
name|ldns_dname_left_chop
argument_list|(
name|rr_name
argument_list|)
expr_stmt|;
name|result
operator|=
name|ldns_dname_cat
argument_list|(
name|wildcard_name
argument_list|,
name|chopped_dname
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|chopped_dname
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|result
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsecs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cur_nsec
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|rr_name
argument_list|,
name|ldns_rr_owner
argument_list|(
name|cur_nsec
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* see section 5.4 of RFC4035, if the label count of the NSEC's 			   RRSIG is equal, then it is proven that wildcard expansion  			   could not have been used to match the request */
name|rrsig
operator|=
name|ldns_dnssec_get_rrsig_for_name_and_type
argument_list|(
name|ldns_rr_owner
argument_list|(
name|cur_nsec
argument_list|)
argument_list|,
name|ldns_rr_get_type
argument_list|(
name|cur_nsec
argument_list|)
argument_list|,
name|rrsigs
argument_list|)
expr_stmt|;
if|if
condition|(
name|rrsig
operator|&&
name|ldns_rdf2native_int8
argument_list|(
name|ldns_rr_rrsig_labels
argument_list|(
name|rrsig
argument_list|)
argument_list|)
operator|==
name|ldns_dname_label_count
argument_list|(
name|rr_name
argument_list|)
condition|)
block|{
name|wildcard_covered
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|ldns_nsec_bitmap_covers_type
argument_list|(
name|ldns_nsec_get_bitmap
argument_list|(
name|cur_nsec
argument_list|)
argument_list|,
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
argument_list|)
condition|)
block|{
name|type_covered
operator|=
name|true
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ldns_nsec_covers_name
argument_list|(
name|cur_nsec
argument_list|,
name|rr_name
argument_list|)
condition|)
block|{
name|name_covered
operator|=
name|true
expr_stmt|;
block|}
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|wildcard_name
argument_list|,
name|ldns_rr_owner
argument_list|(
name|cur_nsec
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|ldns_nsec_bitmap_covers_type
argument_list|(
name|ldns_nsec_get_bitmap
argument_list|(
name|cur_nsec
argument_list|)
argument_list|,
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
argument_list|)
condition|)
block|{
name|wildcard_type_covered
operator|=
name|true
expr_stmt|;
block|}
block|}
if|if
condition|(
name|ldns_nsec_covers_name
argument_list|(
name|cur_nsec
argument_list|,
name|wildcard_name
argument_list|)
condition|)
block|{
name|wildcard_covered
operator|=
name|true
expr_stmt|;
block|}
block|}
name|ldns_rdf_deep_free
argument_list|(
name|wildcard_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|type_covered
operator|||
operator|!
name|name_covered
condition|)
block|{
return|return
name|LDNS_STATUS_DNSSEC_NSEC_RR_NOT_COVERED
return|;
block|}
if|if
condition|(
name|wildcard_type_covered
operator|||
operator|!
name|wildcard_covered
condition|)
block|{
return|return
name|LDNS_STATUS_DNSSEC_NSEC_WILDCARD_NOT_COVERED
return|;
block|}
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_decl_stmt
name|ldns_status
name|ldns_dnssec_verify_denial_nsec3_match
argument_list|(
name|ldns_rr
operator|*
name|rr
argument_list|,
name|ldns_rr_list
operator|*
name|nsecs
argument_list|,
name|ATTR_UNUSED
argument_list|(
name|ldns_rr_list
operator|*
name|rrsigs
argument_list|)
argument_list|,
name|ldns_pkt_rcode
name|packet_rcode
argument_list|,
name|ldns_rr_type
name|packet_qtype
argument_list|,
name|bool
name|packet_nodata
argument_list|,
name|ldns_rr
operator|*
operator|*
name|match
argument_list|)
block|{
name|ldns_rdf
modifier|*
name|closest_encloser
decl_stmt|;
name|ldns_rdf
modifier|*
name|wildcard
decl_stmt|;
name|ldns_rdf
modifier|*
name|hashed_wildcard_name
decl_stmt|;
name|bool
name|wildcard_covered
init|=
name|false
decl_stmt|;
name|ldns_rdf
modifier|*
name|zone_name
decl_stmt|;
name|ldns_rdf
modifier|*
name|hashed_name
decl_stmt|;
comment|/* self assignment to suppress uninitialized warning */
name|ldns_rdf
modifier|*
name|next_closer
init|=
name|next_closer
decl_stmt|;
name|ldns_rdf
modifier|*
name|hashed_next_closer
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|ldns_status
name|result
init|=
name|LDNS_STATUS_DNSSEC_NSEC_RR_NOT_COVERED
decl_stmt|;
if|if
condition|(
name|match
condition|)
block|{
operator|*
name|match
operator|=
name|NULL
expr_stmt|;
block|}
name|zone_name
operator|=
name|ldns_dname_left_chop
argument_list|(
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
comment|/* section 8.4 */
if|if
condition|(
name|packet_rcode
operator|==
name|LDNS_RCODE_NXDOMAIN
condition|)
block|{
name|closest_encloser
operator|=
name|ldns_dnssec_nsec3_closest_encloser
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|,
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
argument_list|,
name|nsecs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|closest_encloser
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_DNSSEC_NSEC_RR_NOT_COVERED
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|wildcard
operator|=
name|ldns_dname_new_frm_str
argument_list|(
literal|"*"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dname_cat
argument_list|(
name|wildcard
argument_list|,
name|closest_encloser
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsecs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|hashed_wildcard_name
operator|=
name|ldns_nsec3_hash_name_frm_nsec3
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
literal|0
argument_list|)
argument_list|,
name|wildcard
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dname_cat
argument_list|(
name|hashed_wildcard_name
argument_list|,
name|zone_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_nsec_covers_name
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|,
name|hashed_wildcard_name
argument_list|)
condition|)
block|{
name|wildcard_covered
operator|=
name|true
expr_stmt|;
if|if
condition|(
name|match
condition|)
block|{
operator|*
name|match
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
name|ldns_rdf_deep_free
argument_list|(
name|hashed_wildcard_name
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|wildcard_covered
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_DNSSEC_NSEC_WILDCARD_NOT_COVERED
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|closest_encloser
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|wildcard
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|packet_nodata
operator|&&
name|packet_qtype
operator|!=
name|LDNS_RR_TYPE_DS
condition|)
block|{
comment|/* section 8.5 */
name|hashed_name
operator|=
name|ldns_nsec3_hash_name_frm_nsec3
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dname_cat
argument_list|(
name|hashed_name
argument_list|,
name|zone_name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsecs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|hashed_name
argument_list|,
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|ldns_nsec_bitmap_covers_type
argument_list|(
name|ldns_nsec3_bitmap
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|packet_qtype
argument_list|)
operator|&&
operator|!
name|ldns_nsec_bitmap_covers_type
argument_list|(
name|ldns_nsec3_bitmap
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|LDNS_RR_TYPE_CNAME
argument_list|)
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
if|if
condition|(
name|match
condition|)
block|{
operator|*
name|match
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
goto|goto
name|done
goto|;
block|}
block|}
block|}
name|result
operator|=
name|LDNS_STATUS_DNSSEC_NSEC_RR_NOT_COVERED
expr_stmt|;
comment|/* wildcard no data? section 8.7 */
name|closest_encloser
operator|=
name|ldns_dnssec_nsec3_closest_encloser
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|,
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
argument_list|,
name|nsecs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|closest_encloser
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_NSEC3_ERR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
name|wildcard
operator|=
name|ldns_dname_new_frm_str
argument_list|(
literal|"*"
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dname_cat
argument_list|(
name|wildcard
argument_list|,
name|closest_encloser
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsecs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|hashed_wildcard_name
operator|=
name|ldns_nsec3_hash_name_frm_nsec3
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
literal|0
argument_list|)
argument_list|,
name|wildcard
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dname_cat
argument_list|(
name|hashed_wildcard_name
argument_list|,
name|zone_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|hashed_wildcard_name
argument_list|,
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|ldns_nsec_bitmap_covers_type
argument_list|(
name|ldns_nsec3_bitmap
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|packet_qtype
argument_list|)
operator|&&
operator|!
name|ldns_nsec_bitmap_covers_type
argument_list|(
name|ldns_nsec3_bitmap
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|LDNS_RR_TYPE_CNAME
argument_list|)
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
if|if
condition|(
name|match
condition|)
block|{
operator|*
name|match
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|ldns_rdf_deep_free
argument_list|(
name|hashed_wildcard_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
break|break;
block|}
block|}
name|ldns_rdf_deep_free
argument_list|(
name|closest_encloser
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|wildcard
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|packet_nodata
operator|&&
name|packet_qtype
operator|==
name|LDNS_RR_TYPE_DS
condition|)
block|{
comment|/* section 8.6 */
comment|/* note: up to XXX this is the same as for 8.5 */
name|hashed_name
operator|=
name|ldns_nsec3_hash_name_frm_nsec3
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
literal|0
argument_list|)
argument_list|,
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dname_cat
argument_list|(
name|hashed_name
argument_list|,
name|zone_name
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsecs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ldns_dname_compare
argument_list|(
name|hashed_name
argument_list|,
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|ldns_nsec_bitmap_covers_type
argument_list|(
name|ldns_nsec3_bitmap
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|LDNS_RR_TYPE_DS
argument_list|)
operator|&&
operator|!
name|ldns_nsec_bitmap_covers_type
argument_list|(
name|ldns_nsec3_bitmap
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|,
name|LDNS_RR_TYPE_CNAME
argument_list|)
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
if|if
condition|(
name|match
condition|)
block|{
operator|*
name|match
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
goto|goto
name|done
goto|;
block|}
block|}
block|}
comment|/* XXX see note above */
name|result
operator|=
name|LDNS_STATUS_DNSSEC_NSEC_RR_NOT_COVERED
expr_stmt|;
name|closest_encloser
operator|=
name|ldns_dnssec_nsec3_closest_encloser
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|,
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
argument_list|,
name|nsecs
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|closest_encloser
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_NSEC3_ERR
expr_stmt|;
goto|goto
name|done
goto|;
block|}
comment|/* Now check if we have a Opt-Out NSEC3 that covers the "next closer"*/
if|if
condition|(
name|ldns_dname_label_count
argument_list|(
name|closest_encloser
argument_list|)
operator|+
literal|1
operator|>=
name|ldns_dname_label_count
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
condition|)
block|{
comment|/* Query name *is* the "next closer". */
name|hashed_next_closer
operator|=
name|hashed_name
expr_stmt|;
block|}
else|else
block|{
comment|/* "next closer" has less labels than the query name. 			 * Create the name and hash it. 			 */
name|next_closer
operator|=
name|ldns_dname_clone_from
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|,
name|ldns_dname_label_count
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
operator|-
operator|(
name|ldns_dname_label_count
argument_list|(
name|closest_encloser
argument_list|)
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|hashed_next_closer
operator|=
name|ldns_nsec3_hash_name_frm_nsec3
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
literal|0
argument_list|)
argument_list|,
name|next_closer
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_dname_cat
argument_list|(
name|hashed_next_closer
argument_list|,
name|zone_name
argument_list|)
expr_stmt|;
block|}
comment|/* Find the NSEC3 that covers the "next closer" */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|nsecs
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|ldns_nsec_covers_name
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|,
name|hashed_next_closer
argument_list|)
operator|&&
name|ldns_nsec3_optout
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
argument_list|)
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
if|if
condition|(
name|match
condition|)
block|{
operator|*
name|match
operator|=
name|ldns_rr_list_rr
argument_list|(
name|nsecs
argument_list|,
name|i
argument_list|)
expr_stmt|;
block|}
break|break;
block|}
block|}
if|if
condition|(
name|ldns_dname_label_count
argument_list|(
name|closest_encloser
argument_list|)
operator|+
literal|1
operator|<
name|ldns_dname_label_count
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rr
argument_list|)
argument_list|)
condition|)
block|{
comment|/* "next closer" has less labels than the query name. 			 * Dispose of the temporary variables that held that name. 			 */
name|ldns_rdf_deep_free
argument_list|(
name|hashed_next_closer
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|next_closer
argument_list|)
expr_stmt|;
block|}
name|ldns_rdf_deep_free
argument_list|(
name|closest_encloser
argument_list|)
expr_stmt|;
block|}
name|done
label|:
name|ldns_rdf_deep_free
argument_list|(
name|zone_name
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_decl_stmt

begin_function
name|ldns_status
name|ldns_dnssec_verify_denial_nsec3
parameter_list|(
name|ldns_rr
modifier|*
name|rr
parameter_list|,
name|ldns_rr_list
modifier|*
name|nsecs
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrsigs
parameter_list|,
name|ldns_pkt_rcode
name|packet_rcode
parameter_list|,
name|ldns_rr_type
name|packet_qtype
parameter_list|,
name|bool
name|packet_nodata
parameter_list|)
block|{
return|return
name|ldns_dnssec_verify_denial_nsec3_match
argument_list|(
name|rr
argument_list|,
name|nsecs
argument_list|,
name|rrsigs
argument_list|,
name|packet_rcode
argument_list|,
name|packet_qtype
argument_list|,
name|packet_nodata
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|USE_GOST
end_ifdef

begin_function
name|EVP_PKEY
modifier|*
name|ldns_gost2pkey_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
comment|/* prefix header for X509 encoding */
name|uint8_t
name|asn
index|[
literal|37
index|]
init|=
block|{
literal|0x30
block|,
literal|0x63
block|,
literal|0x30
block|,
literal|0x1c
block|,
literal|0x06
block|,
literal|0x06
block|,
literal|0x2a
block|,
literal|0x85
block|,
literal|0x03
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x13
block|,
literal|0x30
block|,
literal|0x12
block|,
literal|0x06
block|,
literal|0x07
block|,
literal|0x2a
block|,
literal|0x85
block|,
literal|0x03
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x23
block|,
literal|0x01
block|,
literal|0x06
block|,
literal|0x07
block|,
literal|0x2a
block|,
literal|0x85
block|,
literal|0x03
block|,
literal|0x02
block|,
literal|0x02
block|,
literal|0x1e
block|,
literal|0x01
block|,
literal|0x03
block|,
literal|0x43
block|,
literal|0x00
block|,
literal|0x04
block|,
literal|0x40
block|}
decl_stmt|;
name|unsigned
name|char
name|encoded
index|[
literal|37
operator|+
literal|64
index|]
decl_stmt|;
specifier|const
name|unsigned
name|char
modifier|*
name|pp
decl_stmt|;
if|if
condition|(
name|keylen
operator|!=
literal|64
condition|)
block|{
comment|/* key wrong size */
return|return
name|NULL
return|;
block|}
comment|/* create evp_key */
name|memmove
argument_list|(
name|encoded
argument_list|,
name|asn
argument_list|,
literal|37
argument_list|)
expr_stmt|;
name|memmove
argument_list|(
name|encoded
operator|+
literal|37
argument_list|,
name|key
argument_list|,
literal|64
argument_list|)
expr_stmt|;
name|pp
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|&
name|encoded
index|[
literal|0
index|]
expr_stmt|;
return|return
name|d2i_PUBKEY
argument_list|(
name|NULL
argument_list|,
operator|&
name|pp
argument_list|,
operator|(
name|int
operator|)
sizeof|sizeof
argument_list|(
name|encoded
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_status
name|ldns_verify_rrsig_gost_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|sig
parameter_list|,
name|size_t
name|siglen
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|evp_key
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
operator|(
name|void
operator|)
name|ldns_key_EVP_load_gost_id
argument_list|()
expr_stmt|;
name|evp_key
operator|=
name|ldns_gost2pkey_raw
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|evp_key
condition|)
block|{
comment|/* could not convert key */
return|return
name|LDNS_STATUS_CRYPTO_BOGUS
return|;
block|}
comment|/* verify signature */
name|result
operator|=
name|ldns_verify_rrsig_evp_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|rrset
argument_list|,
name|evp_key
argument_list|,
name|EVP_get_digestbyname
argument_list|(
literal|"md_gost94"
argument_list|)
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|evp_key
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|USE_ECDSA
end_ifdef

begin_function
name|EVP_PKEY
modifier|*
name|ldns_ecdsa2pkey_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|,
name|uint8_t
name|algo
parameter_list|)
block|{
name|unsigned
name|char
name|buf
index|[
literal|256
operator|+
literal|2
index|]
decl_stmt|;
comment|/* sufficient for 2*384/8+1 */
specifier|const
name|unsigned
name|char
modifier|*
name|pp
init|=
name|buf
decl_stmt|;
name|EVP_PKEY
modifier|*
name|evp_key
decl_stmt|;
name|EC_KEY
modifier|*
name|ec
decl_stmt|;
comment|/* check length, which uncompressed must be 2 bignums */
if|if
condition|(
name|algo
operator|==
name|LDNS_ECDSAP256SHA256
condition|)
block|{
if|if
condition|(
name|keylen
operator|!=
literal|2
operator|*
literal|256
operator|/
literal|8
condition|)
return|return
name|NULL
return|;
name|ec
operator|=
name|EC_KEY_new_by_curve_name
argument_list|(
name|NID_X9_62_prime256v1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|algo
operator|==
name|LDNS_ECDSAP384SHA384
condition|)
block|{
if|if
condition|(
name|keylen
operator|!=
literal|2
operator|*
literal|384
operator|/
literal|8
condition|)
return|return
name|NULL
return|;
name|ec
operator|=
name|EC_KEY_new_by_curve_name
argument_list|(
name|NID_secp384r1
argument_list|)
expr_stmt|;
block|}
else|else
name|ec
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|ec
condition|)
return|return
name|NULL
return|;
if|if
condition|(
name|keylen
operator|+
literal|1
operator|>
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
condition|)
return|return
name|NULL
return|;
comment|/* sanity check */
comment|/* prepend the 0x02 (from docs) (or actually 0x04 from implementation 	 * of openssl) for uncompressed data */
name|buf
index|[
literal|0
index|]
operator|=
name|POINT_CONVERSION_UNCOMPRESSED
expr_stmt|;
name|memmove
argument_list|(
name|buf
operator|+
literal|1
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|o2i_ECPublicKey
argument_list|(
operator|&
name|ec
argument_list|,
operator|&
name|pp
argument_list|,
operator|(
name|int
operator|)
name|keylen
operator|+
literal|1
argument_list|)
condition|)
block|{
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|evp_key
operator|=
name|EVP_PKEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|evp_key
condition|)
block|{
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
if|if
condition|(
operator|!
name|EVP_PKEY_assign_EC_KEY
argument_list|(
name|evp_key
argument_list|,
name|ec
argument_list|)
condition|)
block|{
name|EVP_PKEY_free
argument_list|(
name|evp_key
argument_list|)
expr_stmt|;
name|EC_KEY_free
argument_list|(
name|ec
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|evp_key
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_status
name|ldns_verify_rrsig_ecdsa_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|sig
parameter_list|,
name|size_t
name|siglen
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|,
name|uint8_t
name|algo
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|evp_key
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
specifier|const
name|EVP_MD
modifier|*
name|d
decl_stmt|;
name|evp_key
operator|=
name|ldns_ecdsa2pkey_raw
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|,
name|algo
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|evp_key
condition|)
block|{
comment|/* could not convert key */
return|return
name|LDNS_STATUS_CRYPTO_BOGUS
return|;
block|}
if|if
condition|(
name|algo
operator|==
name|LDNS_ECDSAP256SHA256
condition|)
name|d
operator|=
name|EVP_sha256
argument_list|()
expr_stmt|;
else|else
name|d
operator|=
name|EVP_sha384
argument_list|()
expr_stmt|;
comment|/* LDNS_ECDSAP384SHA384 */
name|result
operator|=
name|ldns_verify_rrsig_evp_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|rrset
argument_list|,
name|evp_key
argument_list|,
name|d
argument_list|)
expr_stmt|;
name|EVP_PKEY_free
argument_list|(
name|evp_key
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
name|ldns_status
name|ldns_verify_rrsig_buffers
parameter_list|(
name|ldns_buffer
modifier|*
name|rawsig_buf
parameter_list|,
name|ldns_buffer
modifier|*
name|verify_buf
parameter_list|,
name|ldns_buffer
modifier|*
name|key_buf
parameter_list|,
name|uint8_t
name|algo
parameter_list|)
block|{
return|return
name|ldns_verify_rrsig_buffers_raw
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|rawsig_buf
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|rawsig_buf
argument_list|)
argument_list|,
name|verify_buf
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|key_buf
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|key_buf
argument_list|)
argument_list|,
name|algo
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_buffers_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|sig
parameter_list|,
name|size_t
name|siglen
parameter_list|,
name|ldns_buffer
modifier|*
name|verify_buf
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|,
name|uint8_t
name|algo
parameter_list|)
block|{
comment|/* check for right key */
switch|switch
condition|(
name|algo
condition|)
block|{
case|case
name|LDNS_DSA
case|:
case|case
name|LDNS_DSA_NSEC3
case|:
return|return
name|ldns_verify_rrsig_dsa_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|verify_buf
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
break|break;
case|case
name|LDNS_RSASHA1
case|:
case|case
name|LDNS_RSASHA1_NSEC3
case|:
return|return
name|ldns_verify_rrsig_rsasha1_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|verify_buf
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
break|break;
ifdef|#
directive|ifdef
name|USE_SHA2
case|case
name|LDNS_RSASHA256
case|:
return|return
name|ldns_verify_rrsig_rsasha256_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|verify_buf
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
break|break;
case|case
name|LDNS_RSASHA512
case|:
return|return
name|ldns_verify_rrsig_rsasha512_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|verify_buf
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_GOST
case|case
name|LDNS_ECC_GOST
case|:
return|return
name|ldns_verify_rrsig_gost_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|verify_buf
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
break|break;
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_ECDSA
case|case
name|LDNS_ECDSAP256SHA256
case|:
case|case
name|LDNS_ECDSAP384SHA384
case|:
return|return
name|ldns_verify_rrsig_ecdsa_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|verify_buf
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|,
name|algo
argument_list|)
return|;
break|break;
endif|#
directive|endif
case|case
name|LDNS_RSAMD5
case|:
return|return
name|ldns_verify_rrsig_rsamd5_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|verify_buf
argument_list|,
name|key
argument_list|,
name|keylen
argument_list|)
return|;
break|break;
default|default:
comment|/* do you know this alg?! */
return|return
name|LDNS_STATUS_CRYPTO_UNKNOWN_ALGO
return|;
block|}
block|}
end_function

begin_comment
comment|/**  * Reset the ttl in the rrset with the orig_ttl from the sig   * and update owner name if it was wildcard   * Also canonicalizes the rrset.  * @param rrset: rrset to modify  * @param sig: signature to take TTL and wildcard values from  */
end_comment

begin_function
specifier|static
name|void
name|ldns_rrset_use_signature_ttl
parameter_list|(
name|ldns_rr_list
modifier|*
name|rrset_clone
parameter_list|,
name|ldns_rr
modifier|*
name|rrsig
parameter_list|)
block|{
name|uint32_t
name|orig_ttl
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|uint8_t
name|label_count
decl_stmt|;
name|ldns_rdf
modifier|*
name|wildcard_name
decl_stmt|;
name|ldns_rdf
modifier|*
name|wildcard_chopped
decl_stmt|;
name|ldns_rdf
modifier|*
name|wildcard_chopped_tmp
decl_stmt|;
if|if
condition|(
operator|(
name|rrsig
operator|==
name|NULL
operator|)
operator|||
name|ldns_rr_rd_count
argument_list|(
name|rrsig
argument_list|)
operator|<
literal|4
condition|)
block|{
return|return;
block|}
name|orig_ttl
operator|=
name|ldns_rdf2native_int32
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|3
argument_list|)
argument_list|)
expr_stmt|;
name|label_count
operator|=
name|ldns_rdf2native_int8
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|2
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrset_clone
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|label_count
operator|<
name|ldns_dname_label_count
argument_list|(
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrset_clone
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|)
condition|)
block|{
operator|(
name|void
operator|)
name|ldns_str2rdf_dname
argument_list|(
operator|&
name|wildcard_name
argument_list|,
literal|"*"
argument_list|)
expr_stmt|;
name|wildcard_chopped
operator|=
name|ldns_rdf_clone
argument_list|(
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrset_clone
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
while|while
condition|(
name|label_count
operator|<
name|ldns_dname_label_count
argument_list|(
name|wildcard_chopped
argument_list|)
condition|)
block|{
name|wildcard_chopped_tmp
operator|=
name|ldns_dname_left_chop
argument_list|(
name|wildcard_chopped
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|wildcard_chopped
argument_list|)
expr_stmt|;
name|wildcard_chopped
operator|=
name|wildcard_chopped_tmp
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|ldns_dname_cat
argument_list|(
name|wildcard_name
argument_list|,
name|wildcard_chopped
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|wildcard_chopped
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|ldns_rr_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrset_clone
argument_list|,
name|i
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrset_clone
argument_list|,
name|i
argument_list|)
argument_list|,
name|wildcard_name
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_set_ttl
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrset_clone
argument_list|,
name|i
argument_list|)
argument_list|,
name|orig_ttl
argument_list|)
expr_stmt|;
comment|/* convert to lowercase */
name|ldns_rr2canonical
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrset_clone
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/**  * Make raw signature buffer out of rrsig  * @param rawsig_buf: raw signature buffer for result  * @param rrsig: signature to convert  * @return OK or more specific error.  */
end_comment

begin_function
specifier|static
name|ldns_status
name|ldns_rrsig2rawsig_buffer
parameter_list|(
name|ldns_buffer
modifier|*
name|rawsig_buf
parameter_list|,
name|ldns_rr
modifier|*
name|rrsig
parameter_list|)
block|{
name|uint8_t
name|sig_algo
decl_stmt|;
if|if
condition|(
name|rrsig
operator|==
name|NULL
condition|)
block|{
return|return
name|LDNS_STATUS_CRYPTO_NO_RRSIG
return|;
block|}
if|if
condition|(
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|1
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|LDNS_STATUS_MISSING_RDATA_FIELDS_RRSIG
return|;
block|}
name|sig_algo
operator|=
name|ldns_rdf2native_int8
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* check for known and implemented algo's now (otherwise  	 * the function could return a wrong error 	 */
comment|/* create a buffer with signature rdata */
comment|/* for some algorithms we need other data than for others... */
comment|/* (the DSA API wants DER encoding for instance) */
switch|switch
condition|(
name|sig_algo
condition|)
block|{
case|case
name|LDNS_RSAMD5
case|:
case|case
name|LDNS_RSASHA1
case|:
case|case
name|LDNS_RSASHA1_NSEC3
case|:
ifdef|#
directive|ifdef
name|USE_SHA2
case|case
name|LDNS_RSASHA256
case|:
case|case
name|LDNS_RSASHA512
case|:
endif|#
directive|endif
ifdef|#
directive|ifdef
name|USE_GOST
case|case
name|LDNS_ECC_GOST
case|:
endif|#
directive|endif
if|if
condition|(
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|8
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|LDNS_STATUS_MISSING_RDATA_FIELDS_RRSIG
return|;
block|}
if|if
condition|(
name|ldns_rdf2buffer_wire
argument_list|(
name|rawsig_buf
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|8
argument_list|)
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
break|break;
case|case
name|LDNS_DSA
case|:
case|case
name|LDNS_DSA_NSEC3
case|:
comment|/* EVP takes rfc2459 format, which is a tad longer than dns format */
if|if
condition|(
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|8
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|LDNS_STATUS_MISSING_RDATA_FIELDS_RRSIG
return|;
block|}
if|if
condition|(
name|ldns_convert_dsa_rrsig_rdf2asn1
argument_list|(
name|rawsig_buf
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|8
argument_list|)
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
comment|/* 			  if (ldns_rdf2buffer_wire(rawsig_buf, 			  ldns_rr_rdf(rrsig, 8)) != LDNS_STATUS_OK) { 			*/
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
break|break;
ifdef|#
directive|ifdef
name|USE_ECDSA
case|case
name|LDNS_ECDSAP256SHA256
case|:
case|case
name|LDNS_ECDSAP384SHA384
case|:
comment|/* EVP produces an ASN prefix on the signature, which is                  * not used in the DNS */
if|if
condition|(
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|8
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|LDNS_STATUS_MISSING_RDATA_FIELDS_RRSIG
return|;
block|}
if|if
condition|(
name|ldns_convert_ecdsa_rrsig_rdf2asn1
argument_list|(
name|rawsig_buf
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|8
argument_list|)
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
break|break;
endif|#
directive|endif
case|case
name|LDNS_DH
case|:
case|case
name|LDNS_ECC
case|:
case|case
name|LDNS_INDIRECT
case|:
return|return
name|LDNS_STATUS_CRYPTO_ALGO_NOT_IMPL
return|;
default|default:
return|return
name|LDNS_STATUS_CRYPTO_UNKNOWN_ALGO
return|;
block|}
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_comment
comment|/**  * Check RRSIG timestamps against the given 'now' time.  * @param rrsig: signature to check.  * @param now: the current time in seconds epoch.  * @return status code LDNS_STATUS_OK if all is fine.  */
end_comment

begin_function
specifier|static
name|ldns_status
name|ldns_rrsig_check_timestamps
parameter_list|(
name|ldns_rr
modifier|*
name|rrsig
parameter_list|,
name|time_t
name|now
parameter_list|)
block|{
name|int32_t
name|inception
decl_stmt|,
name|expiration
decl_stmt|;
comment|/* check the signature time stamps */
name|inception
operator|=
operator|(
name|int32_t
operator|)
name|ldns_rdf2native_time_t
argument_list|(
name|ldns_rr_rrsig_inception
argument_list|(
name|rrsig
argument_list|)
argument_list|)
expr_stmt|;
name|expiration
operator|=
operator|(
name|int32_t
operator|)
name|ldns_rdf2native_time_t
argument_list|(
name|ldns_rr_rrsig_expiration
argument_list|(
name|rrsig
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|expiration
operator|-
name|inception
operator|<
literal|0
condition|)
block|{
comment|/* bad sig, expiration before inception?? Tsssg */
return|return
name|LDNS_STATUS_CRYPTO_EXPIRATION_BEFORE_INCEPTION
return|;
block|}
if|if
condition|(
operator|(
operator|(
name|int32_t
operator|)
name|now
operator|)
operator|-
name|inception
operator|<
literal|0
condition|)
block|{
comment|/* bad sig, inception date has not yet come to pass */
return|return
name|LDNS_STATUS_CRYPTO_SIG_NOT_INCEPTED
return|;
block|}
if|if
condition|(
name|expiration
operator|-
operator|(
operator|(
name|int32_t
operator|)
name|now
operator|)
operator|<
literal|0
condition|)
block|{
comment|/* bad sig, expiration date has passed */
return|return
name|LDNS_STATUS_CRYPTO_SIG_EXPIRED
return|;
block|}
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_comment
comment|/**  * Prepare for verification.  * @param rawsig_buf: raw signature buffer made ready.  * @param verify_buf: data for verification buffer made ready.  * @param rrset_clone: made ready.  * @param rrsig: signature to prepare for.  * @return LDNS_STATUS_OK is all went well. Otherwise specific error.  */
end_comment

begin_function
specifier|static
name|ldns_status
name|ldns_prepare_for_verify
parameter_list|(
name|ldns_buffer
modifier|*
name|rawsig_buf
parameter_list|,
name|ldns_buffer
modifier|*
name|verify_buf
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrset_clone
parameter_list|,
name|ldns_rr
modifier|*
name|rrsig
parameter_list|)
block|{
name|ldns_status
name|result
decl_stmt|;
comment|/* canonicalize the sig */
name|ldns_dname2canonical
argument_list|(
name|ldns_rr_owner
argument_list|(
name|rrsig
argument_list|)
argument_list|)
expr_stmt|;
comment|/* check if the typecovered is equal to the type checked */
if|if
condition|(
name|ldns_rdf2rr_type
argument_list|(
name|ldns_rr_rrsig_typecovered
argument_list|(
name|rrsig
argument_list|)
argument_list|)
operator|!=
name|ldns_rr_get_type
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|rrset_clone
argument_list|,
literal|0
argument_list|)
argument_list|)
condition|)
return|return
name|LDNS_STATUS_CRYPTO_TYPE_COVERED_ERR
return|;
comment|/* create a buffer with b64 signature rdata */
name|result
operator|=
name|ldns_rrsig2rawsig_buffer
argument_list|(
name|rawsig_buf
argument_list|,
name|rrsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|LDNS_STATUS_OK
condition|)
return|return
name|result
return|;
comment|/* use TTL from signature. Use wildcard names for wildcards */
comment|/* also canonicalizes rrset_clone */
name|ldns_rrset_use_signature_ttl
argument_list|(
name|rrset_clone
argument_list|,
name|rrsig
argument_list|)
expr_stmt|;
comment|/* sort the rrset in canonical order  */
name|ldns_rr_list_sort
argument_list|(
name|rrset_clone
argument_list|)
expr_stmt|;
comment|/* put the signature rr (without the b64) to the verify_buf */
if|if
condition|(
name|ldns_rrsig2buffer_wire
argument_list|(
name|verify_buf
argument_list|,
name|rrsig
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
comment|/* add the rrset in verify_buf */
if|if
condition|(
name|ldns_rr_list2buffer_wire
argument_list|(
name|verify_buf
argument_list|,
name|rrset_clone
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_comment
comment|/**  * Check if a key matches a signature.  * Checks keytag, sigalgo and signature.  * @param rawsig_buf: raw signature buffer for verify  * @param verify_buf: raw data buffer for verify  * @param rrsig: the rrsig  * @param key: key to attempt.  * @return LDNS_STATUS_OK if OK, else some specific error.  */
end_comment

begin_function
specifier|static
name|ldns_status
name|ldns_verify_test_sig_key
parameter_list|(
name|ldns_buffer
modifier|*
name|rawsig_buf
parameter_list|,
name|ldns_buffer
modifier|*
name|verify_buf
parameter_list|,
name|ldns_rr
modifier|*
name|rrsig
parameter_list|,
name|ldns_rr
modifier|*
name|key
parameter_list|)
block|{
name|uint8_t
name|sig_algo
decl_stmt|;
if|if
condition|(
name|rrsig
operator|==
name|NULL
condition|)
block|{
return|return
name|LDNS_STATUS_CRYPTO_NO_RRSIG
return|;
block|}
if|if
condition|(
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|1
argument_list|)
operator|==
name|NULL
condition|)
block|{
return|return
name|LDNS_STATUS_MISSING_RDATA_FIELDS_RRSIG
return|;
block|}
name|sig_algo
operator|=
name|ldns_rdf2native_int8
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|rrsig
argument_list|,
literal|1
argument_list|)
argument_list|)
expr_stmt|;
comment|/* before anything, check if the keytags match */
if|if
condition|(
name|ldns_calc_keytag
argument_list|(
name|key
argument_list|)
operator|==
name|ldns_rdf2native_int16
argument_list|(
name|ldns_rr_rrsig_keytag
argument_list|(
name|rrsig
argument_list|)
argument_list|)
condition|)
block|{
name|ldns_buffer
modifier|*
name|key_buf
init|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
decl_stmt|;
name|ldns_status
name|result
init|=
name|LDNS_STATUS_ERR
decl_stmt|;
comment|/* put the key-data in a buffer, that's the third rdf, with 		 * the base64 encoded key data */
if|if
condition|(
name|ldns_rr_rdf
argument_list|(
name|key
argument_list|,
literal|3
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|ldns_buffer_free
argument_list|(
name|key_buf
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MISSING_RDATA_FIELDS_KEY
return|;
block|}
if|if
condition|(
name|ldns_rdf2buffer_wire
argument_list|(
name|key_buf
argument_list|,
name|ldns_rr_rdf
argument_list|(
name|key
argument_list|,
literal|3
argument_list|)
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_buffer_free
argument_list|(
name|key_buf
argument_list|)
expr_stmt|;
comment|/* returning is bad might screw up 			   good keys later in the list 			   what to do? */
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
name|ldns_rr_rdf
argument_list|(
name|key
argument_list|,
literal|2
argument_list|)
operator|==
name|NULL
condition|)
block|{
name|result
operator|=
name|LDNS_STATUS_MISSING_RDATA_FIELDS_KEY
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|sig_algo
operator|==
name|ldns_rdf2native_int8
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|key
argument_list|,
literal|2
argument_list|)
argument_list|)
condition|)
block|{
name|result
operator|=
name|ldns_verify_rrsig_buffers
argument_list|(
name|rawsig_buf
argument_list|,
name|verify_buf
argument_list|,
name|key_buf
argument_list|,
name|sig_algo
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|/* No keys with the corresponding algorithm are found */
name|result
operator|=
name|LDNS_STATUS_CRYPTO_NO_MATCHING_KEYTAG_DNSKEY
expr_stmt|;
block|}
name|ldns_buffer_free
argument_list|(
name|key_buf
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
else|else
block|{
comment|/* No keys with the corresponding keytag are found */
return|return
name|LDNS_STATUS_CRYPTO_NO_MATCHING_KEYTAG_DNSKEY
return|;
block|}
block|}
end_function

begin_comment
comment|/*   * to verify:  * - create the wire fmt of the b64 key rdata  * - create the wire fmt of the sorted rrset  * - create the wire fmt of the b64 sig rdata  * - create the wire fmt of the sig without the b64 rdata  * - cat the sig data (without b64 rdata) to the rrset  * - verify the rrset+sig, with the b64 data and the b64 key data  */
end_comment

begin_function
name|ldns_status
name|ldns_verify_rrsig_keylist_time
parameter_list|(
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_rr
modifier|*
name|rrsig
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|time_t
name|check_time
parameter_list|,
name|ldns_rr_list
modifier|*
name|good_keys
parameter_list|)
block|{
name|ldns_status
name|result
decl_stmt|;
name|ldns_rr_list
modifier|*
name|valid
init|=
name|ldns_rr_list_new
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|valid
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
name|result
operator|=
name|ldns_verify_rrsig_keylist_notime
argument_list|(
name|rrset
argument_list|,
name|rrsig
argument_list|,
name|keys
argument_list|,
name|valid
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_rr_list_free
argument_list|(
name|valid
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
comment|/* check timestamps last; its OK except time */
name|result
operator|=
name|ldns_rrsig_check_timestamps
argument_list|(
name|rrsig
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_rr_list_free
argument_list|(
name|valid
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
name|ldns_rr_list_cat
argument_list|(
name|good_keys
argument_list|,
name|valid
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|valid
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_comment
comment|/*   * to verify:  * - create the wire fmt of the b64 key rdata  * - create the wire fmt of the sorted rrset  * - create the wire fmt of the b64 sig rdata  * - create the wire fmt of the sig without the b64 rdata  * - cat the sig data (without b64 rdata) to the rrset  * - verify the rrset+sig, with the b64 data and the b64 key data  */
end_comment

begin_function
name|ldns_status
name|ldns_verify_rrsig_keylist
parameter_list|(
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_rr
modifier|*
name|rrsig
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|ldns_rr_list
modifier|*
name|good_keys
parameter_list|)
block|{
return|return
name|ldns_verify_rrsig_keylist_time
argument_list|(
name|rrset
argument_list|,
name|rrsig
argument_list|,
name|keys
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|,
name|good_keys
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_keylist_notime
parameter_list|(
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_rr
modifier|*
name|rrsig
parameter_list|,
specifier|const
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|ldns_rr_list
modifier|*
name|good_keys
parameter_list|)
block|{
name|ldns_buffer
modifier|*
name|rawsig_buf
decl_stmt|;
name|ldns_buffer
modifier|*
name|verify_buf
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|ldns_status
name|result
decl_stmt|,
name|status
decl_stmt|;
name|ldns_rr_list
modifier|*
name|rrset_clone
decl_stmt|;
name|ldns_rr_list
modifier|*
name|validkeys
decl_stmt|;
if|if
condition|(
operator|!
name|rrset
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|validkeys
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|validkeys
condition|)
block|{
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
comment|/* clone the rrset so that we can fiddle with it */
name|rrset_clone
operator|=
name|ldns_rr_list_clone
argument_list|(
name|rrset
argument_list|)
expr_stmt|;
comment|/* create the buffers which will certainly hold the raw data */
name|rawsig_buf
operator|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
expr_stmt|;
name|verify_buf
operator|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
expr_stmt|;
name|result
operator|=
name|ldns_prepare_for_verify
argument_list|(
name|rawsig_buf
argument_list|,
name|verify_buf
argument_list|,
name|rrset_clone
argument_list|,
name|rrsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_buffer_free
argument_list|(
name|verify_buf
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|rawsig_buf
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|rrset_clone
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|validkeys
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
name|result
operator|=
name|LDNS_STATUS_CRYPTO_NO_MATCHING_KEYTAG_DNSKEY
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|keys
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|ldns_verify_test_sig_key
argument_list|(
name|rawsig_buf
argument_list|,
name|verify_buf
argument_list|,
name|rrsig
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|keys
argument_list|,
name|i
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
comment|/* one of the keys has matched, don't break 			 * here, instead put the 'winning' key in 			 * the validkey list and return the list  			 * later */
if|if
condition|(
operator|!
name|ldns_rr_list_push_rr
argument_list|(
name|validkeys
argument_list|,
name|ldns_rr_list_rr
argument_list|(
name|keys
argument_list|,
name|i
argument_list|)
argument_list|)
condition|)
block|{
comment|/* couldn't push the key?? */
name|ldns_buffer_free
argument_list|(
name|rawsig_buf
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|verify_buf
argument_list|)
expr_stmt|;
name|ldns_rr_list_deep_free
argument_list|(
name|rrset_clone
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|validkeys
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|result
operator|=
name|status
expr_stmt|;
block|}
if|if
condition|(
name|result
operator|==
name|LDNS_STATUS_CRYPTO_NO_MATCHING_KEYTAG_DNSKEY
condition|)
block|{
name|result
operator|=
name|status
expr_stmt|;
block|}
block|}
comment|/* no longer needed */
name|ldns_rr_list_deep_free
argument_list|(
name|rrset_clone
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|rawsig_buf
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|verify_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_list_rr_count
argument_list|(
name|validkeys
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* no keys were added, return last error */
name|ldns_rr_list_free
argument_list|(
name|validkeys
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
comment|/* do not check timestamps */
name|ldns_rr_list_cat
argument_list|(
name|good_keys
argument_list|,
name|validkeys
argument_list|)
expr_stmt|;
name|ldns_rr_list_free
argument_list|(
name|validkeys
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_time
parameter_list|(
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_rr
modifier|*
name|rrsig
parameter_list|,
name|ldns_rr
modifier|*
name|key
parameter_list|,
name|time_t
name|check_time
parameter_list|)
block|{
name|ldns_buffer
modifier|*
name|rawsig_buf
decl_stmt|;
name|ldns_buffer
modifier|*
name|verify_buf
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
name|ldns_rr_list
modifier|*
name|rrset_clone
decl_stmt|;
if|if
condition|(
operator|!
name|rrset
condition|)
block|{
return|return
name|LDNS_STATUS_NO_DATA
return|;
block|}
comment|/* clone the rrset so that we can fiddle with it */
name|rrset_clone
operator|=
name|ldns_rr_list_clone
argument_list|(
name|rrset
argument_list|)
expr_stmt|;
comment|/* create the buffers which will certainly hold the raw data */
name|rawsig_buf
operator|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
expr_stmt|;
name|verify_buf
operator|=
name|ldns_buffer_new
argument_list|(
name|LDNS_MAX_PACKETLEN
argument_list|)
expr_stmt|;
name|result
operator|=
name|ldns_prepare_for_verify
argument_list|(
name|rawsig_buf
argument_list|,
name|verify_buf
argument_list|,
name|rrset_clone
argument_list|,
name|rrsig
argument_list|)
expr_stmt|;
if|if
condition|(
name|result
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|rrset_clone
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|rawsig_buf
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|verify_buf
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
name|result
operator|=
name|ldns_verify_test_sig_key
argument_list|(
name|rawsig_buf
argument_list|,
name|verify_buf
argument_list|,
name|rrsig
argument_list|,
name|key
argument_list|)
expr_stmt|;
comment|/* no longer needed */
name|ldns_rr_list_deep_free
argument_list|(
name|rrset_clone
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|rawsig_buf
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|verify_buf
argument_list|)
expr_stmt|;
comment|/* check timestamp last, apart from time its OK */
if|if
condition|(
name|result
operator|==
name|LDNS_STATUS_OK
condition|)
name|result
operator|=
name|ldns_rrsig_check_timestamps
argument_list|(
name|rrsig
argument_list|,
name|check_time
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig
parameter_list|(
name|ldns_rr_list
modifier|*
name|rrset
parameter_list|,
name|ldns_rr
modifier|*
name|rrsig
parameter_list|,
name|ldns_rr
modifier|*
name|key
parameter_list|)
block|{
return|return
name|ldns_verify_rrsig_time
argument_list|(
name|rrset
argument_list|,
name|rrsig
argument_list|,
name|key
argument_list|,
name|ldns_time
argument_list|(
name|NULL
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_evp
parameter_list|(
name|ldns_buffer
modifier|*
name|sig
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|EVP_PKEY
modifier|*
name|key
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|digest_type
parameter_list|)
block|{
return|return
name|ldns_verify_rrsig_evp_raw
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|sig
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|sig
argument_list|)
argument_list|,
name|rrset
argument_list|,
name|key
argument_list|,
name|digest_type
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_evp_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|sig
parameter_list|,
name|size_t
name|siglen
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|EVP_PKEY
modifier|*
name|key
parameter_list|,
specifier|const
name|EVP_MD
modifier|*
name|digest_type
parameter_list|)
block|{
name|EVP_MD_CTX
name|ctx
decl_stmt|;
name|int
name|res
decl_stmt|;
name|EVP_MD_CTX_init
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
name|EVP_VerifyInit
argument_list|(
operator|&
name|ctx
argument_list|,
name|digest_type
argument_list|)
expr_stmt|;
name|EVP_VerifyUpdate
argument_list|(
operator|&
name|ctx
argument_list|,
name|ldns_buffer_begin
argument_list|(
name|rrset
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|rrset
argument_list|)
argument_list|)
expr_stmt|;
name|res
operator|=
name|EVP_VerifyFinal
argument_list|(
operator|&
name|ctx
argument_list|,
name|sig
argument_list|,
operator|(
name|unsigned
name|int
operator|)
name|siglen
argument_list|,
name|key
argument_list|)
expr_stmt|;
name|EVP_MD_CTX_cleanup
argument_list|(
operator|&
name|ctx
argument_list|)
expr_stmt|;
if|if
condition|(
name|res
operator|==
literal|1
condition|)
block|{
return|return
name|LDNS_STATUS_OK
return|;
block|}
elseif|else
if|if
condition|(
name|res
operator|==
literal|0
condition|)
block|{
return|return
name|LDNS_STATUS_CRYPTO_BOGUS
return|;
block|}
comment|/* TODO how to communicate internal SSL error? 	   let caller use ssl's get_error() */
return|return
name|LDNS_STATUS_SSL_ERR
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_dsa
parameter_list|(
name|ldns_buffer
modifier|*
name|sig
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|ldns_buffer
modifier|*
name|key
parameter_list|)
block|{
return|return
name|ldns_verify_rrsig_dsa_raw
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|sig
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|sig
argument_list|)
argument_list|,
name|rrset
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|key
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|key
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_rsasha1
parameter_list|(
name|ldns_buffer
modifier|*
name|sig
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|ldns_buffer
modifier|*
name|key
parameter_list|)
block|{
return|return
name|ldns_verify_rrsig_rsasha1_raw
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|sig
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|sig
argument_list|)
argument_list|,
name|rrset
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|key
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|key
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_rsamd5
parameter_list|(
name|ldns_buffer
modifier|*
name|sig
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|ldns_buffer
modifier|*
name|key
parameter_list|)
block|{
return|return
name|ldns_verify_rrsig_rsamd5_raw
argument_list|(
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|sig
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|sig
argument_list|)
argument_list|,
name|rrset
argument_list|,
operator|(
name|unsigned
name|char
operator|*
operator|)
name|ldns_buffer_begin
argument_list|(
name|key
argument_list|)
argument_list|,
name|ldns_buffer_position
argument_list|(
name|key
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_dsa_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|sig
parameter_list|,
name|size_t
name|siglen
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|evp_key
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
name|evp_key
operator|=
name|EVP_PKEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|EVP_PKEY_assign_DSA
argument_list|(
name|evp_key
argument_list|,
name|ldns_key_buf2dsa_raw
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|)
argument_list|)
condition|)
block|{
name|result
operator|=
name|ldns_verify_rrsig_evp_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|rrset
argument_list|,
name|evp_key
argument_list|,
name|EVP_dss1
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|LDNS_STATUS_SSL_ERR
expr_stmt|;
block|}
name|EVP_PKEY_free
argument_list|(
name|evp_key
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_rsasha1_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|sig
parameter_list|,
name|size_t
name|siglen
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|evp_key
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
name|evp_key
operator|=
name|EVP_PKEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|EVP_PKEY_assign_RSA
argument_list|(
name|evp_key
argument_list|,
name|ldns_key_buf2rsa_raw
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|)
argument_list|)
condition|)
block|{
name|result
operator|=
name|ldns_verify_rrsig_evp_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|rrset
argument_list|,
name|evp_key
argument_list|,
name|EVP_sha1
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|LDNS_STATUS_SSL_ERR
expr_stmt|;
block|}
name|EVP_PKEY_free
argument_list|(
name|evp_key
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_rsasha256_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|sig
parameter_list|,
name|size_t
name|siglen
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|USE_SHA2
name|EVP_PKEY
modifier|*
name|evp_key
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
name|evp_key
operator|=
name|EVP_PKEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|EVP_PKEY_assign_RSA
argument_list|(
name|evp_key
argument_list|,
name|ldns_key_buf2rsa_raw
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|)
argument_list|)
condition|)
block|{
name|result
operator|=
name|ldns_verify_rrsig_evp_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|rrset
argument_list|,
name|evp_key
argument_list|,
name|EVP_sha256
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|LDNS_STATUS_SSL_ERR
expr_stmt|;
block|}
name|EVP_PKEY_free
argument_list|(
name|evp_key
argument_list|)
expr_stmt|;
return|return
name|result
return|;
else|#
directive|else
comment|/* touch these to prevent compiler warnings */
operator|(
name|void
operator|)
name|sig
expr_stmt|;
operator|(
name|void
operator|)
name|siglen
expr_stmt|;
operator|(
name|void
operator|)
name|rrset
expr_stmt|;
operator|(
name|void
operator|)
name|key
expr_stmt|;
operator|(
name|void
operator|)
name|keylen
expr_stmt|;
return|return
name|LDNS_STATUS_CRYPTO_UNKNOWN_ALGO
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_rsasha512_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|sig
parameter_list|,
name|size_t
name|siglen
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
ifdef|#
directive|ifdef
name|USE_SHA2
name|EVP_PKEY
modifier|*
name|evp_key
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
name|evp_key
operator|=
name|EVP_PKEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|EVP_PKEY_assign_RSA
argument_list|(
name|evp_key
argument_list|,
name|ldns_key_buf2rsa_raw
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|)
argument_list|)
condition|)
block|{
name|result
operator|=
name|ldns_verify_rrsig_evp_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|rrset
argument_list|,
name|evp_key
argument_list|,
name|EVP_sha512
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|LDNS_STATUS_SSL_ERR
expr_stmt|;
block|}
name|EVP_PKEY_free
argument_list|(
name|evp_key
argument_list|)
expr_stmt|;
return|return
name|result
return|;
else|#
directive|else
comment|/* touch these to prevent compiler warnings */
operator|(
name|void
operator|)
name|sig
expr_stmt|;
operator|(
name|void
operator|)
name|siglen
expr_stmt|;
operator|(
name|void
operator|)
name|rrset
expr_stmt|;
operator|(
name|void
operator|)
name|key
expr_stmt|;
operator|(
name|void
operator|)
name|keylen
expr_stmt|;
return|return
name|LDNS_STATUS_CRYPTO_UNKNOWN_ALGO
return|;
endif|#
directive|endif
block|}
end_function

begin_function
name|ldns_status
name|ldns_verify_rrsig_rsamd5_raw
parameter_list|(
name|unsigned
name|char
modifier|*
name|sig
parameter_list|,
name|size_t
name|siglen
parameter_list|,
name|ldns_buffer
modifier|*
name|rrset
parameter_list|,
name|unsigned
name|char
modifier|*
name|key
parameter_list|,
name|size_t
name|keylen
parameter_list|)
block|{
name|EVP_PKEY
modifier|*
name|evp_key
decl_stmt|;
name|ldns_status
name|result
decl_stmt|;
name|evp_key
operator|=
name|EVP_PKEY_new
argument_list|()
expr_stmt|;
if|if
condition|(
name|EVP_PKEY_assign_RSA
argument_list|(
name|evp_key
argument_list|,
name|ldns_key_buf2rsa_raw
argument_list|(
name|key
argument_list|,
name|keylen
argument_list|)
argument_list|)
condition|)
block|{
name|result
operator|=
name|ldns_verify_rrsig_evp_raw
argument_list|(
name|sig
argument_list|,
name|siglen
argument_list|,
name|rrset
argument_list|,
name|evp_key
argument_list|,
name|EVP_md5
argument_list|()
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|=
name|LDNS_STATUS_SSL_ERR
expr_stmt|;
block|}
name|EVP_PKEY_free
argument_list|(
name|evp_key
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * resolver.c  *  * resolver implementation  *  * a Net::DNS like library for C  *  * (c) NLnet Labs, 2004-2006  *  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|<ldns/config.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_comment
comment|/* Access function for reading  * and setting the different Resolver  * options */
end_comment

begin_comment
comment|/* read */
end_comment

begin_function
name|uint16_t
name|ldns_resolver_port
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_port
return|;
block|}
end_function

begin_function
name|uint16_t
name|ldns_resolver_edns_udp_size
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_edns_udp_size
return|;
block|}
end_function

begin_function
name|uint8_t
name|ldns_resolver_retry
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_retry
return|;
block|}
end_function

begin_function
name|uint8_t
name|ldns_resolver_retrans
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_retrans
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_fallback
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_fallback
return|;
block|}
end_function

begin_function
name|uint8_t
name|ldns_resolver_ip6
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_ip6
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_recursive
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_recursive
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_debug
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_debug
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_dnsrch
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_dnsrch
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_fail
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_fail
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_defnames
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_defnames
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_resolver_domain
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_domain
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
modifier|*
name|ldns_resolver_searchlist
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_searchlist
return|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
modifier|*
name|ldns_resolver_nameservers
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_nameservers
return|;
block|}
end_function

begin_function
name|size_t
name|ldns_resolver_nameserver_count
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_nameserver_count
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_dnssec
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_dnssec
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_dnssec_cd
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_dnssec_cd
return|;
block|}
end_function

begin_function
name|ldns_rr_list
modifier|*
name|ldns_resolver_dnssec_anchors
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_dnssec_anchors
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_trusted_key
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_rr_list
modifier|*
name|keys
parameter_list|,
name|ldns_rr_list
modifier|*
name|trusted_keys
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
name|bool
name|result
init|=
name|false
decl_stmt|;
name|ldns_rr_list
modifier|*
name|trust_anchors
decl_stmt|;
name|ldns_rr
modifier|*
name|cur_rr
decl_stmt|;
if|if
condition|(
operator|!
name|r
operator|||
operator|!
name|keys
condition|)
block|{
return|return
name|false
return|;
block|}
name|trust_anchors
operator|=
name|ldns_resolver_dnssec_anchors
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|trust_anchors
condition|)
block|{
return|return
name|false
return|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|keys
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|cur_rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|keys
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_list_contains_rr
argument_list|(
name|trust_anchors
argument_list|,
name|cur_rr
argument_list|)
condition|)
block|{
if|if
condition|(
name|trusted_keys
condition|)
block|{
name|ldns_rr_list_push_rr
argument_list|(
name|trusted_keys
argument_list|,
name|cur_rr
argument_list|)
expr_stmt|;
block|}
name|result
operator|=
name|true
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_igntc
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_igntc
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_usevc
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_usevc
return|;
block|}
end_function

begin_function
name|size_t
modifier|*
name|ldns_resolver_rtt
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_rtt
return|;
block|}
end_function

begin_function
name|size_t
name|ldns_resolver_nameserver_rtt
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|size_t
name|pos
parameter_list|)
block|{
name|size_t
modifier|*
name|rtt
decl_stmt|;
name|assert
argument_list|(
name|r
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|rtt
operator|=
name|ldns_resolver_rtt
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|>=
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
condition|)
block|{
comment|/* error ?*/
return|return
literal|0
return|;
block|}
else|else
block|{
return|return
name|rtt
index|[
name|pos
index|]
return|;
block|}
block|}
end_function

begin_function
name|struct
name|timeval
name|ldns_resolver_timeout
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_timeout
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|ldns_resolver_tsig_keyname
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_tsig_keyname
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|ldns_resolver_tsig_algorithm
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_tsig_algorithm
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|ldns_resolver_tsig_keydata
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_tsig_keydata
return|;
block|}
end_function

begin_function
name|bool
name|ldns_resolver_random
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_random
return|;
block|}
end_function

begin_function
name|size_t
name|ldns_resolver_searchlist_count
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
return|return
name|r
operator|->
name|_searchlist_count
return|;
block|}
end_function

begin_comment
comment|/* write */
end_comment

begin_function
name|void
name|ldns_resolver_set_port
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|uint16_t
name|p
parameter_list|)
block|{
name|r
operator|->
name|_port
operator|=
name|p
expr_stmt|;
block|}
end_function

begin_function
name|ldns_rdf
modifier|*
name|ldns_resolver_pop_nameserver
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
name|ldns_rdf
modifier|*
modifier|*
name|nameservers
decl_stmt|;
name|ldns_rdf
modifier|*
name|pop
decl_stmt|;
name|size_t
name|ns_count
decl_stmt|;
name|size_t
modifier|*
name|rtt
decl_stmt|;
name|assert
argument_list|(
name|r
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ns_count
operator|=
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|nameservers
operator|=
name|ldns_resolver_nameservers
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|rtt
operator|=
name|ldns_resolver_rtt
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|ns_count
operator|==
literal|0
operator|||
operator|!
name|nameservers
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|pop
operator|=
name|nameservers
index|[
name|ns_count
operator|-
literal|1
index|]
expr_stmt|;
name|nameservers
operator|=
name|LDNS_XREALLOC
argument_list|(
name|nameservers
argument_list|,
name|ldns_rdf
operator|*
argument_list|,
operator|(
name|ns_count
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|rtt
operator|=
name|LDNS_XREALLOC
argument_list|(
name|rtt
argument_list|,
name|size_t
argument_list|,
operator|(
name|ns_count
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|nameservers
condition|)
name|ldns_resolver_set_nameservers
argument_list|(
name|r
argument_list|,
name|nameservers
argument_list|)
expr_stmt|;
if|if
condition|(
name|rtt
condition|)
name|ldns_resolver_set_rtt
argument_list|(
name|r
argument_list|,
name|rtt
argument_list|)
expr_stmt|;
comment|/* decr the count */
name|ldns_resolver_dec_nameserver_count
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|pop
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_resolver_push_nameserver
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_rdf
modifier|*
name|n
parameter_list|)
block|{
name|ldns_rdf
modifier|*
modifier|*
name|nameservers
decl_stmt|;
name|size_t
name|ns_count
decl_stmt|;
name|size_t
modifier|*
name|rtt
decl_stmt|;
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|n
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_A
operator|&&
name|ldns_rdf_get_type
argument_list|(
name|n
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_AAAA
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|ns_count
operator|=
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|nameservers
operator|=
name|ldns_resolver_nameservers
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|rtt
operator|=
name|ldns_resolver_rtt
argument_list|(
name|r
argument_list|)
expr_stmt|;
comment|/* make room for the next one */
if|if
condition|(
name|ns_count
operator|==
literal|0
condition|)
block|{
name|nameservers
operator|=
name|LDNS_XMALLOC
argument_list|(
name|ldns_rdf
operator|*
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|nameservers
operator|=
name|LDNS_XREALLOC
argument_list|(
name|nameservers
argument_list|,
name|ldns_rdf
operator|*
argument_list|,
operator|(
name|ns_count
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|nameservers
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
comment|/* set the new value in the resolver */
name|ldns_resolver_set_nameservers
argument_list|(
name|r
argument_list|,
name|nameservers
argument_list|)
expr_stmt|;
comment|/* don't forget the rtt */
if|if
condition|(
name|ns_count
operator|==
literal|0
condition|)
block|{
name|rtt
operator|=
name|LDNS_XMALLOC
argument_list|(
name|size_t
argument_list|,
literal|1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|rtt
operator|=
name|LDNS_XREALLOC
argument_list|(
name|rtt
argument_list|,
name|size_t
argument_list|,
operator|(
name|ns_count
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|rtt
condition|)
return|return
name|LDNS_STATUS_MEM_ERR
return|;
comment|/* slide n in its slot. */
comment|/* we clone it here, because then we can free the original 	 * rr's where it stood */
name|nameservers
index|[
name|ns_count
index|]
operator|=
name|ldns_rdf_clone
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|rtt
index|[
name|ns_count
index|]
operator|=
name|LDNS_RESOLV_RTT_MIN
expr_stmt|;
name|ldns_resolver_incr_nameserver_count
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|ldns_resolver_set_rtt
argument_list|(
name|r
argument_list|,
name|rtt
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_resolver_push_nameserver_rr
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|address
decl_stmt|;
if|if
condition|(
operator|(
operator|!
name|rr
operator|)
operator|||
operator|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_A
operator|&&
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_AAAA
operator|)
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
name|address
operator|=
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* extract the ip number */
if|if
condition|(
name|address
condition|)
block|{
return|return
name|ldns_resolver_push_nameserver
argument_list|(
name|r
argument_list|,
name|address
argument_list|)
return|;
block|}
else|else
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
block|}
end_function

begin_function
name|ldns_status
name|ldns_resolver_push_nameserver_rr_list
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_rr_list
modifier|*
name|rrlist
parameter_list|)
block|{
name|ldns_rr
modifier|*
name|rr
decl_stmt|;
name|ldns_status
name|stat
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|stat
operator|=
name|LDNS_STATUS_OK
expr_stmt|;
if|if
condition|(
name|rrlist
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_rr_list_rr_count
argument_list|(
name|rrlist
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|rr
operator|=
name|ldns_rr_list_rr
argument_list|(
name|rrlist
argument_list|,
name|i
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_resolver_push_nameserver_rr
argument_list|(
name|r
argument_list|,
name|rr
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|stat
operator|=
name|LDNS_STATUS_ERR
expr_stmt|;
break|break;
block|}
block|}
return|return
name|stat
return|;
block|}
else|else
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_edns_udp_size
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|uint16_t
name|s
parameter_list|)
block|{
name|r
operator|->
name|_edns_udp_size
operator|=
name|s
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_recursive
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|re
parameter_list|)
block|{
name|r
operator|->
name|_recursive
operator|=
name|re
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_dnssec
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|d
parameter_list|)
block|{
name|r
operator|->
name|_dnssec
operator|=
name|d
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_dnssec_cd
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|d
parameter_list|)
block|{
name|r
operator|->
name|_dnssec_cd
operator|=
name|d
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_dnssec_anchors
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_rr_list
modifier|*
name|l
parameter_list|)
block|{
name|r
operator|->
name|_dnssec_anchors
operator|=
name|l
expr_stmt|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_resolver_push_dnssec_anchor
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_rr
modifier|*
name|rr
parameter_list|)
block|{
name|ldns_rr_list
modifier|*
name|trust_anchors
decl_stmt|;
if|if
condition|(
operator|(
operator|!
name|rr
operator|)
operator|||
operator|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|!=
name|LDNS_RR_TYPE_DNSKEY
operator|)
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
if|if
condition|(
operator|!
operator|(
name|trust_anchors
operator|=
name|ldns_resolver_dnssec_anchors
argument_list|(
name|r
argument_list|)
operator|)
condition|)
block|{
comment|/* Initialize */
name|trust_anchors
operator|=
name|ldns_rr_list_new
argument_list|()
expr_stmt|;
name|ldns_resolver_set_dnssec_anchors
argument_list|(
name|r
argument_list|,
name|trust_anchors
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|ldns_rr_list_push_rr
argument_list|(
name|trust_anchors
argument_list|,
name|ldns_rr_clone
argument_list|(
name|rr
argument_list|)
argument_list|)
operator|)
condition|?
name|LDNS_STATUS_OK
else|:
name|LDNS_STATUS_ERR
return|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_igntc
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|i
parameter_list|)
block|{
name|r
operator|->
name|_igntc
operator|=
name|i
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_usevc
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|vc
parameter_list|)
block|{
name|r
operator|->
name|_usevc
operator|=
name|vc
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_debug
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|d
parameter_list|)
block|{
name|r
operator|->
name|_debug
operator|=
name|d
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_ip6
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|uint8_t
name|ip6
parameter_list|)
block|{
name|r
operator|->
name|_ip6
operator|=
name|ip6
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_fail
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|f
parameter_list|)
block|{
name|r
operator|->
name|_fail
operator|=
name|f
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_searchlist_count
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|size_t
name|c
parameter_list|)
block|{
name|r
operator|->
name|_searchlist_count
operator|=
name|c
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_nameserver_count
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|size_t
name|c
parameter_list|)
block|{
name|r
operator|->
name|_nameserver_count
operator|=
name|c
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_dnsrch
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|d
parameter_list|)
block|{
name|r
operator|->
name|_dnsrch
operator|=
name|d
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_retry
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|uint8_t
name|retry
parameter_list|)
block|{
name|r
operator|->
name|_retry
operator|=
name|retry
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_retrans
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|uint8_t
name|retrans
parameter_list|)
block|{
name|r
operator|->
name|_retrans
operator|=
name|retrans
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_fallback
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|fallback
parameter_list|)
block|{
name|r
operator|->
name|_fallback
operator|=
name|fallback
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_nameservers
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_rdf
modifier|*
modifier|*
name|n
parameter_list|)
block|{
name|r
operator|->
name|_nameservers
operator|=
name|n
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_defnames
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|d
parameter_list|)
block|{
name|r
operator|->
name|_defnames
operator|=
name|d
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_rtt
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|size_t
modifier|*
name|rtt
parameter_list|)
block|{
name|r
operator|->
name|_rtt
operator|=
name|rtt
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_nameserver_rtt
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|size_t
name|pos
parameter_list|,
name|size_t
name|value
parameter_list|)
block|{
name|size_t
modifier|*
name|rtt
decl_stmt|;
name|assert
argument_list|(
name|r
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|rtt
operator|=
name|ldns_resolver_rtt
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|pos
operator|>=
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
condition|)
block|{
comment|/* error ?*/
block|}
else|else
block|{
name|rtt
index|[
name|pos
index|]
operator|=
name|value
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ldns_resolver_incr_nameserver_count
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
name|size_t
name|c
decl_stmt|;
name|c
operator|=
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|ldns_resolver_set_nameserver_count
argument_list|(
name|r
argument_list|,
operator|++
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_dec_nameserver_count
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
name|size_t
name|c
decl_stmt|;
name|c
operator|=
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
condition|)
block|{
return|return;
block|}
else|else
block|{
name|ldns_resolver_set_nameserver_count
argument_list|(
name|r
argument_list|,
operator|--
name|c
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_domain
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_rdf
modifier|*
name|d
parameter_list|)
block|{
name|r
operator|->
name|_domain
operator|=
name|d
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_timeout
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|struct
name|timeval
name|timeout
parameter_list|)
block|{
name|r
operator|->
name|_timeout
operator|.
name|tv_sec
operator|=
name|timeout
operator|.
name|tv_sec
expr_stmt|;
name|r
operator|->
name|_timeout
operator|.
name|tv_usec
operator|=
name|timeout
operator|.
name|tv_usec
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_push_searchlist
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_rdf
modifier|*
name|d
parameter_list|)
block|{
name|ldns_rdf
modifier|*
modifier|*
name|searchlist
decl_stmt|;
name|size_t
name|list_count
decl_stmt|;
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|d
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
condition|)
block|{
return|return;
block|}
name|list_count
operator|=
name|ldns_resolver_searchlist_count
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|searchlist
operator|=
name|ldns_resolver_searchlist
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|searchlist
operator|=
name|LDNS_XREALLOC
argument_list|(
name|searchlist
argument_list|,
name|ldns_rdf
operator|*
argument_list|,
operator|(
name|list_count
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|searchlist
condition|)
block|{
name|r
operator|->
name|_searchlist
operator|=
name|searchlist
expr_stmt|;
name|searchlist
index|[
name|list_count
index|]
operator|=
name|ldns_rdf_clone
argument_list|(
name|d
argument_list|)
expr_stmt|;
name|ldns_resolver_set_searchlist_count
argument_list|(
name|r
argument_list|,
name|list_count
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
comment|/* no way to report mem err */
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_tsig_keyname
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|char
modifier|*
name|tsig_keyname
parameter_list|)
block|{
name|LDNS_FREE
argument_list|(
name|r
operator|->
name|_tsig_keyname
argument_list|)
expr_stmt|;
name|r
operator|->
name|_tsig_keyname
operator|=
name|strdup
argument_list|(
name|tsig_keyname
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_tsig_algorithm
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|char
modifier|*
name|tsig_algorithm
parameter_list|)
block|{
name|LDNS_FREE
argument_list|(
name|r
operator|->
name|_tsig_algorithm
argument_list|)
expr_stmt|;
name|r
operator|->
name|_tsig_algorithm
operator|=
name|strdup
argument_list|(
name|tsig_algorithm
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_tsig_keydata
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|char
modifier|*
name|tsig_keydata
parameter_list|)
block|{
name|LDNS_FREE
argument_list|(
name|r
operator|->
name|_tsig_keydata
argument_list|)
expr_stmt|;
name|r
operator|->
name|_tsig_keydata
operator|=
name|strdup
argument_list|(
name|tsig_keydata
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_set_random
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|bool
name|b
parameter_list|)
block|{
name|r
operator|->
name|_random
operator|=
name|b
expr_stmt|;
block|}
end_function

begin_comment
comment|/* more sophisticated functions */
end_comment

begin_function
name|ldns_resolver
modifier|*
name|ldns_resolver_new
parameter_list|(
name|void
parameter_list|)
block|{
name|ldns_resolver
modifier|*
name|r
decl_stmt|;
name|r
operator|=
name|LDNS_MALLOC
argument_list|(
name|ldns_resolver
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
block|{
return|return
name|NULL
return|;
block|}
name|r
operator|->
name|_searchlist
operator|=
name|NULL
expr_stmt|;
name|r
operator|->
name|_nameservers
operator|=
name|NULL
expr_stmt|;
name|r
operator|->
name|_rtt
operator|=
name|NULL
expr_stmt|;
comment|/* defaults are filled out */
name|ldns_resolver_set_searchlist_count
argument_list|(
name|r
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_resolver_set_nameserver_count
argument_list|(
name|r
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_resolver_set_usevc
argument_list|(
name|r
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_resolver_set_port
argument_list|(
name|r
argument_list|,
name|LDNS_PORT
argument_list|)
expr_stmt|;
name|ldns_resolver_set_domain
argument_list|(
name|r
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_resolver_set_defnames
argument_list|(
name|r
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ldns_resolver_set_retry
argument_list|(
name|r
argument_list|,
literal|3
argument_list|)
expr_stmt|;
name|ldns_resolver_set_retrans
argument_list|(
name|r
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|ldns_resolver_set_fallback
argument_list|(
name|r
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ldns_resolver_set_fail
argument_list|(
name|r
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ldns_resolver_set_edns_udp_size
argument_list|(
name|r
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|ldns_resolver_set_dnssec
argument_list|(
name|r
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ldns_resolver_set_dnssec_cd
argument_list|(
name|r
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ldns_resolver_set_dnssec_anchors
argument_list|(
name|r
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
name|ldns_resolver_set_ip6
argument_list|(
name|r
argument_list|,
name|LDNS_RESOLV_INETANY
argument_list|)
expr_stmt|;
name|ldns_resolver_set_igntc
argument_list|(
name|r
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ldns_resolver_set_recursive
argument_list|(
name|r
argument_list|,
name|false
argument_list|)
expr_stmt|;
name|ldns_resolver_set_dnsrch
argument_list|(
name|r
argument_list|,
name|true
argument_list|)
expr_stmt|;
comment|/* randomize the nameserver to be queried 	 * when there are multiple 	 */
name|ldns_resolver_set_random
argument_list|(
name|r
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ldns_resolver_set_debug
argument_list|(
name|r
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|r
operator|->
name|_timeout
operator|.
name|tv_sec
operator|=
name|LDNS_DEFAULT_TIMEOUT_SEC
expr_stmt|;
name|r
operator|->
name|_timeout
operator|.
name|tv_usec
operator|=
name|LDNS_DEFAULT_TIMEOUT_USEC
expr_stmt|;
comment|/* TODO: fd=0 is actually a valid socket (stdin),            replace with -1 */
name|r
operator|->
name|_socket
operator|=
literal|0
expr_stmt|;
name|r
operator|->
name|_axfr_soa_count
operator|=
literal|0
expr_stmt|;
name|r
operator|->
name|_axfr_i
operator|=
literal|0
expr_stmt|;
name|r
operator|->
name|_cur_axfr_pkt
operator|=
name|NULL
expr_stmt|;
name|r
operator|->
name|_tsig_keyname
operator|=
name|NULL
expr_stmt|;
name|r
operator|->
name|_tsig_keydata
operator|=
name|NULL
expr_stmt|;
name|r
operator|->
name|_tsig_algorithm
operator|=
name|NULL
expr_stmt|;
return|return
name|r
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_resolver_new_frm_fp
parameter_list|(
name|ldns_resolver
modifier|*
modifier|*
name|res
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|)
block|{
return|return
name|ldns_resolver_new_frm_fp_l
argument_list|(
name|res
argument_list|,
name|fp
argument_list|,
name|NULL
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_resolver_new_frm_fp_l
parameter_list|(
name|ldns_resolver
modifier|*
modifier|*
name|res
parameter_list|,
name|FILE
modifier|*
name|fp
parameter_list|,
name|int
modifier|*
name|line_nr
parameter_list|)
block|{
name|ldns_resolver
modifier|*
name|r
decl_stmt|;
specifier|const
name|char
modifier|*
name|keyword
index|[
name|LDNS_RESOLV_KEYWORDS
index|]
decl_stmt|;
name|char
name|word
index|[
name|LDNS_MAX_LINELEN
operator|+
literal|1
index|]
decl_stmt|;
name|int8_t
name|expect
decl_stmt|;
name|uint8_t
name|i
decl_stmt|;
name|ldns_rdf
modifier|*
name|tmp
decl_stmt|;
ifdef|#
directive|ifdef
name|HAVE_SSL
name|ldns_rr
modifier|*
name|tmp_rr
decl_stmt|;
endif|#
directive|endif
name|ssize_t
name|gtr
decl_stmt|,
name|bgtr
decl_stmt|;
name|ldns_buffer
modifier|*
name|b
decl_stmt|;
name|int
name|lnr
init|=
literal|0
decl_stmt|,
name|oldline
decl_stmt|;
if|if
condition|(
operator|!
name|line_nr
condition|)
name|line_nr
operator|=
operator|&
name|lnr
expr_stmt|;
comment|/* do this better 	 * expect = 	 * 0: keyword 	 * 1: default domain dname 	 * 2: NS aaaa or a record 	 */
comment|/* recognized keywords */
name|keyword
index|[
name|LDNS_RESOLV_NAMESERVER
index|]
operator|=
literal|"nameserver"
expr_stmt|;
name|keyword
index|[
name|LDNS_RESOLV_DEFDOMAIN
index|]
operator|=
literal|"domain"
expr_stmt|;
name|keyword
index|[
name|LDNS_RESOLV_SEARCH
index|]
operator|=
literal|"search"
expr_stmt|;
comment|/* these two are read but not used atm TODO */
name|keyword
index|[
name|LDNS_RESOLV_SORTLIST
index|]
operator|=
literal|"sortlist"
expr_stmt|;
name|keyword
index|[
name|LDNS_RESOLV_OPTIONS
index|]
operator|=
literal|"options"
expr_stmt|;
name|keyword
index|[
name|LDNS_RESOLV_ANCHOR
index|]
operator|=
literal|"anchor"
expr_stmt|;
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
name|r
operator|=
name|ldns_resolver_new
argument_list|()
expr_stmt|;
if|if
condition|(
operator|!
name|r
condition|)
block|{
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|gtr
operator|=
literal|1
expr_stmt|;
name|word
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
name|oldline
operator|=
operator|*
name|line_nr
expr_stmt|;
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
while|while
condition|(
name|gtr
operator|>
literal|0
condition|)
block|{
comment|/* check comments */
if|if
condition|(
name|word
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
block|{
name|word
index|[
literal|0
index|]
operator|=
literal|'x'
expr_stmt|;
if|if
condition|(
name|oldline
operator|==
operator|*
name|line_nr
condition|)
block|{
comment|/* skip until end of line */
name|int
name|c
decl_stmt|;
do|do
block|{
name|c
operator|=
name|fgetc
argument_list|(
name|fp
argument_list|)
expr_stmt|;
block|}
do|while
condition|(
name|c
operator|!=
name|EOF
operator|&&
name|c
operator|!=
literal|'\n'
condition|)
do|;
if|if
condition|(
name|c
operator|==
literal|'\n'
operator|&&
name|line_nr
condition|)
operator|(
operator|*
name|line_nr
operator|)
operator|++
expr_stmt|;
block|}
comment|/* and read next to prepare for further parsing */
name|oldline
operator|=
operator|*
name|line_nr
expr_stmt|;
continue|continue;
block|}
name|oldline
operator|=
operator|*
name|line_nr
expr_stmt|;
switch|switch
condition|(
name|expect
condition|)
block|{
case|case
name|LDNS_RESOLV_KEYWORD
case|:
comment|/* keyword */
name|gtr
operator|=
name|ldns_fget_token_l
argument_list|(
name|fp
argument_list|,
name|word
argument_list|,
name|LDNS_PARSE_NORMAL
argument_list|,
literal|0
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|gtr
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|word
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
continue|continue;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|LDNS_RESOLV_KEYWORDS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|strcasecmp
argument_list|(
name|keyword
index|[
name|i
index|]
argument_list|,
name|word
argument_list|)
operator|==
literal|0
condition|)
block|{
comment|/* chosen the keyword and 							 * expect values carefully 	        					 */
name|expect
operator|=
name|i
expr_stmt|;
break|break;
block|}
block|}
comment|/* no keyword recognized */
if|if
condition|(
name|expect
operator|==
name|LDNS_RESOLV_KEYWORD
condition|)
block|{
comment|/* skip line */
comment|/* 						ldns_resolver_deep_free(r); 						return LDNS_STATUS_SYNTAX_KEYWORD_ERR; 						*/
block|}
block|}
break|break;
case|case
name|LDNS_RESOLV_DEFDOMAIN
case|:
comment|/* default domain dname */
name|gtr
operator|=
name|ldns_fget_token_l
argument_list|(
name|fp
argument_list|,
name|word
argument_list|,
name|LDNS_PARSE_NORMAL
argument_list|,
literal|0
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|gtr
operator|==
literal|0
condition|)
block|{
return|return
name|LDNS_STATUS_SYNTAX_MISSING_VALUE_ERR
return|;
block|}
if|if
condition|(
name|word
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
block|{
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
continue|continue;
block|}
name|tmp
operator|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
name|word
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
block|{
name|ldns_resolver_deep_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_SYNTAX_DNAME_ERR
return|;
block|}
comment|/* DOn't free, because we copy the pointer */
name|ldns_resolver_set_domain
argument_list|(
name|r
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
break|break;
case|case
name|LDNS_RESOLV_NAMESERVER
case|:
comment|/* NS aaaa or a record */
name|gtr
operator|=
name|ldns_fget_token_l
argument_list|(
name|fp
argument_list|,
name|word
argument_list|,
name|LDNS_PARSE_NORMAL
argument_list|,
literal|0
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|gtr
operator|==
literal|0
condition|)
block|{
return|return
name|LDNS_STATUS_SYNTAX_MISSING_VALUE_ERR
return|;
block|}
if|if
condition|(
name|word
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
block|{
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|strchr
argument_list|(
name|word
argument_list|,
literal|'%'
argument_list|)
condition|)
block|{
comment|/* snip off interface labels,                                          * fe80::222:19ff:fe31:4222%eth0 */
name|strchr
argument_list|(
name|word
argument_list|,
literal|'%'
argument_list|)
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|tmp
operator|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_AAAA
argument_list|,
name|word
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
block|{
comment|/* try ip4 */
name|tmp
operator|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_A
argument_list|,
name|word
argument_list|)
expr_stmt|;
block|}
comment|/* could not parse it, exit */
if|if
condition|(
operator|!
name|tmp
condition|)
block|{
name|ldns_resolver_deep_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_SYNTAX_ERR
return|;
block|}
operator|(
name|void
operator|)
name|ldns_resolver_push_nameserver
argument_list|(
name|r
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
break|break;
case|case
name|LDNS_RESOLV_SEARCH
case|:
comment|/* search list domain dname */
name|gtr
operator|=
name|ldns_fget_token_l
argument_list|(
name|fp
argument_list|,
name|word
argument_list|,
name|LDNS_PARSE_SKIP_SPACE
argument_list|,
literal|0
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
name|b
operator|=
name|LDNS_MALLOC
argument_list|(
name|ldns_buffer
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|b
condition|)
block|{
name|ldns_resolver_deep_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|ldns_buffer_new_frm_data
argument_list|(
name|b
argument_list|,
name|word
argument_list|,
operator|(
name|size_t
operator|)
name|gtr
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_buffer_status
argument_list|(
name|b
argument_list|)
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|ldns_resolver_deep_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|bgtr
operator|=
name|ldns_bget_token
argument_list|(
name|b
argument_list|,
name|word
argument_list|,
name|LDNS_PARSE_NORMAL
argument_list|,
operator|(
name|size_t
operator|)
name|gtr
operator|+
literal|1
argument_list|)
expr_stmt|;
while|while
condition|(
name|bgtr
operator|>
literal|0
condition|)
block|{
name|gtr
operator|-=
name|bgtr
expr_stmt|;
if|if
condition|(
name|word
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
block|{
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|tmp
operator|=
name|ldns_rdf_new_frm_str
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
name|word
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|tmp
condition|)
block|{
name|ldns_resolver_deep_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|ldns_buffer_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_SYNTAX_DNAME_ERR
return|;
block|}
name|ldns_resolver_push_searchlist
argument_list|(
name|r
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|ldns_rdf_deep_free
argument_list|(
name|tmp
argument_list|)
expr_stmt|;
name|bgtr
operator|=
name|ldns_bget_token
argument_list|(
name|b
argument_list|,
name|word
argument_list|,
name|LDNS_PARSE_NORMAL
argument_list|,
operator|(
name|size_t
operator|)
name|gtr
operator|+
literal|1
argument_list|)
expr_stmt|;
block|}
name|ldns_buffer_free
argument_list|(
name|b
argument_list|)
expr_stmt|;
name|gtr
operator|=
literal|1
expr_stmt|;
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
break|break;
case|case
name|LDNS_RESOLV_SORTLIST
case|:
name|gtr
operator|=
name|ldns_fget_token_l
argument_list|(
name|fp
argument_list|,
name|word
argument_list|,
name|LDNS_PARSE_SKIP_SPACE
argument_list|,
literal|0
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
comment|/* sortlist not implemented atm */
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
break|break;
case|case
name|LDNS_RESOLV_OPTIONS
case|:
name|gtr
operator|=
name|ldns_fget_token_l
argument_list|(
name|fp
argument_list|,
name|word
argument_list|,
name|LDNS_PARSE_SKIP_SPACE
argument_list|,
literal|0
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
comment|/* options not implemented atm */
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
break|break;
case|case
name|LDNS_RESOLV_ANCHOR
case|:
comment|/* a file containing a DNSSEC trust anchor */
name|gtr
operator|=
name|ldns_fget_token_l
argument_list|(
name|fp
argument_list|,
name|word
argument_list|,
name|LDNS_PARSE_NORMAL
argument_list|,
literal|0
argument_list|,
name|line_nr
argument_list|)
expr_stmt|;
if|if
condition|(
name|gtr
operator|==
literal|0
condition|)
block|{
name|ldns_resolver_deep_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_SYNTAX_MISSING_VALUE_ERR
return|;
block|}
if|if
condition|(
name|word
index|[
literal|0
index|]
operator|==
literal|'#'
condition|)
block|{
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
continue|continue;
block|}
ifdef|#
directive|ifdef
name|HAVE_SSL
name|tmp_rr
operator|=
name|ldns_read_anchor_file
argument_list|(
name|word
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|ldns_resolver_push_dnssec_anchor
argument_list|(
name|r
argument_list|,
name|tmp_rr
argument_list|)
expr_stmt|;
name|ldns_rr_free
argument_list|(
name|tmp_rr
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|expect
operator|=
name|LDNS_RESOLV_KEYWORD
expr_stmt|;
break|break;
block|}
block|}
if|if
condition|(
name|res
condition|)
block|{
operator|*
name|res
operator|=
name|r
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
else|else
block|{
name|ldns_resolver_deep_free
argument_list|(
name|r
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_NULL
return|;
block|}
block|}
end_function

begin_function
name|ldns_status
name|ldns_resolver_new_frm_file
parameter_list|(
name|ldns_resolver
modifier|*
modifier|*
name|res
parameter_list|,
specifier|const
name|char
modifier|*
name|filename
parameter_list|)
block|{
name|ldns_resolver
modifier|*
name|r
decl_stmt|;
name|FILE
modifier|*
name|fp
decl_stmt|;
name|ldns_status
name|s
decl_stmt|;
if|if
condition|(
operator|!
name|filename
condition|)
block|{
name|fp
operator|=
name|fopen
argument_list|(
name|LDNS_RESOLV_CONF
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|fp
operator|=
name|fopen
argument_list|(
name|filename
argument_list|,
literal|"r"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|fp
condition|)
block|{
return|return
name|LDNS_STATUS_FILE_ERR
return|;
block|}
name|s
operator|=
name|ldns_resolver_new_frm_fp
argument_list|(
operator|&
name|r
argument_list|,
name|fp
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|fp
argument_list|)
expr_stmt|;
if|if
condition|(
name|s
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
if|if
condition|(
name|res
condition|)
block|{
operator|*
name|res
operator|=
name|r
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
else|else
block|{
return|return
name|LDNS_STATUS_NULL
return|;
block|}
block|}
return|return
name|s
return|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_free
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|)
block|{
name|LDNS_FREE
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ldns_resolver_deep_free
parameter_list|(
name|ldns_resolver
modifier|*
name|res
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
if|if
condition|(
name|res
condition|)
block|{
if|if
condition|(
name|res
operator|->
name|_searchlist
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_resolver_searchlist_count
argument_list|(
name|res
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|res
operator|->
name|_searchlist
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|res
operator|->
name|_searchlist
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|->
name|_nameservers
condition|)
block|{
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|res
operator|->
name|_nameserver_count
condition|;
name|i
operator|++
control|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|res
operator|->
name|_nameservers
index|[
name|i
index|]
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|res
operator|->
name|_nameservers
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|ldns_resolver_domain
argument_list|(
name|res
argument_list|)
condition|)
block|{
name|ldns_rdf_deep_free
argument_list|(
name|ldns_resolver_domain
argument_list|(
name|res
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|->
name|_tsig_keyname
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|res
operator|->
name|_tsig_keyname
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|->
name|_tsig_keydata
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|res
operator|->
name|_tsig_keydata
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|->
name|_tsig_algorithm
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|res
operator|->
name|_tsig_algorithm
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|->
name|_cur_axfr_pkt
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|res
operator|->
name|_cur_axfr_pkt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|->
name|_rtt
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|res
operator|->
name|_rtt
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|res
operator|->
name|_dnssec_anchors
condition|)
block|{
name|ldns_rr_list_deep_free
argument_list|(
name|res
operator|->
name|_dnssec_anchors
argument_list|)
expr_stmt|;
block|}
name|LDNS_FREE
argument_list|(
name|res
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|ldns_pkt
modifier|*
name|ldns_resolver_search
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|,
name|uint16_t
name|flags
parameter_list|)
block|{
name|char
modifier|*
name|str_dname
decl_stmt|;
name|ldns_rdf
modifier|*
name|new_name
decl_stmt|;
name|ldns_rdf
modifier|*
modifier|*
name|search_list
decl_stmt|;
name|size_t
name|i
decl_stmt|;
name|ldns_pkt
modifier|*
name|p
decl_stmt|;
name|str_dname
operator|=
name|ldns_rdf2str
argument_list|(
name|name
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_dname_str_absolute
argument_list|(
name|str_dname
argument_list|)
condition|)
block|{
comment|/* query as-is */
return|return
name|ldns_resolver_query
argument_list|(
name|r
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
name|flags
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|ldns_resolver_dnsrch
argument_list|(
name|r
argument_list|)
condition|)
block|{
name|search_list
operator|=
name|ldns_resolver_searchlist
argument_list|(
name|r
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_resolver_searchlist_count
argument_list|(
name|r
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|new_name
operator|=
name|ldns_dname_cat_clone
argument_list|(
name|name
argument_list|,
name|search_list
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|p
operator|=
name|ldns_resolver_query
argument_list|(
name|r
argument_list|,
name|new_name
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|new_name
argument_list|)
expr_stmt|;
if|if
condition|(
name|p
condition|)
block|{
if|if
condition|(
name|ldns_pkt_get_rcode
argument_list|(
name|p
argument_list|)
operator|==
name|LDNS_RCODE_NOERROR
condition|)
block|{
return|return
name|p
return|;
block|}
else|else
block|{
name|ldns_pkt_free
argument_list|(
name|p
argument_list|)
expr_stmt|;
name|p
operator|=
name|NULL
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
name|ldns_pkt
modifier|*
name|ldns_resolver_query
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|r
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|,
name|uint16_t
name|flags
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|newname
decl_stmt|;
name|ldns_pkt
modifier|*
name|pkt
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|pkt
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|ldns_resolver_defnames
argument_list|(
name|r
argument_list|)
condition|)
block|{
name|status
operator|=
name|ldns_resolver_send
argument_list|(
operator|&
name|pkt
argument_list|,
operator|(
name|ldns_resolver
operator|*
operator|)
name|r
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|pkt
return|;
block|}
else|else
block|{
if|if
condition|(
name|pkt
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
block|}
if|if
condition|(
operator|!
name|ldns_resolver_domain
argument_list|(
name|r
argument_list|)
condition|)
block|{
comment|/* _defnames is set, but the domain is not....?? */
name|status
operator|=
name|ldns_resolver_send
argument_list|(
operator|&
name|pkt
argument_list|,
operator|(
name|ldns_resolver
operator|*
operator|)
name|r
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|pkt
return|;
block|}
else|else
block|{
if|if
condition|(
name|pkt
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
block|}
name|newname
operator|=
name|ldns_dname_cat_clone
argument_list|(
operator|(
specifier|const
name|ldns_rdf
operator|*
operator|)
name|name
argument_list|,
name|ldns_resolver_domain
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|newname
condition|)
block|{
if|if
condition|(
name|pkt
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|pkt
argument_list|)
expr_stmt|;
block|}
return|return
name|NULL
return|;
block|}
operator|(
name|void
operator|)
name|ldns_resolver_send
argument_list|(
operator|&
name|pkt
argument_list|,
operator|(
name|ldns_resolver
operator|*
operator|)
name|r
argument_list|,
name|newname
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
name|ldns_rdf_free
argument_list|(
name|newname
argument_list|)
expr_stmt|;
return|return
name|pkt
return|;
block|}
end_function

begin_function
specifier|static
name|size_t
modifier|*
name|ldns_resolver_backup_rtt
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
name|size_t
modifier|*
name|new_rtt
decl_stmt|;
name|size_t
modifier|*
name|old_rtt
init|=
name|ldns_resolver_rtt
argument_list|(
name|r
argument_list|)
decl_stmt|;
if|if
condition|(
name|old_rtt
operator|&&
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
condition|)
block|{
name|new_rtt
operator|=
name|LDNS_XMALLOC
argument_list|(
name|size_t
argument_list|,
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|new_rtt
argument_list|,
name|old_rtt
argument_list|,
sizeof|sizeof
argument_list|(
name|size_t
argument_list|)
operator|*
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_resolver_set_rtt
argument_list|(
name|r
argument_list|,
name|new_rtt
argument_list|)
expr_stmt|;
return|return
name|old_rtt
return|;
block|}
return|return
name|NULL
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|ldns_resolver_restore_rtt
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|size_t
modifier|*
name|old_rtt
parameter_list|)
block|{
name|size_t
modifier|*
name|cur_rtt
init|=
name|ldns_resolver_rtt
argument_list|(
name|r
argument_list|)
decl_stmt|;
if|if
condition|(
name|cur_rtt
condition|)
block|{
name|LDNS_FREE
argument_list|(
name|cur_rtt
argument_list|)
expr_stmt|;
block|}
name|ldns_resolver_set_rtt
argument_list|(
name|r
argument_list|,
name|old_rtt
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_resolver_send_pkt
parameter_list|(
name|ldns_pkt
modifier|*
modifier|*
name|answer
parameter_list|,
name|ldns_resolver
modifier|*
name|r
parameter_list|,
name|ldns_pkt
modifier|*
name|query_pkt
parameter_list|)
block|{
name|ldns_pkt
modifier|*
name|answer_pkt
init|=
name|NULL
decl_stmt|;
name|ldns_status
name|stat
init|=
name|LDNS_STATUS_OK
decl_stmt|;
name|size_t
modifier|*
name|rtt
decl_stmt|;
name|stat
operator|=
name|ldns_send
argument_list|(
operator|&
name|answer_pkt
argument_list|,
operator|(
name|ldns_resolver
operator|*
operator|)
name|r
argument_list|,
name|query_pkt
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
if|if
condition|(
name|answer_pkt
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|answer_pkt
argument_list|)
expr_stmt|;
name|answer_pkt
operator|=
name|NULL
expr_stmt|;
block|}
block|}
else|else
block|{
comment|/* if tc=1 fall back to EDNS and/or TCP */
comment|/* check for tcp first (otherwise we don't care about tc=1) */
if|if
condition|(
operator|!
name|ldns_resolver_usevc
argument_list|(
name|r
argument_list|)
operator|&&
name|ldns_resolver_fallback
argument_list|(
name|r
argument_list|)
condition|)
block|{
if|if
condition|(
name|ldns_pkt_tc
argument_list|(
name|answer_pkt
argument_list|)
condition|)
block|{
comment|/* was EDNS0 set? */
if|if
condition|(
name|ldns_pkt_edns_udp_size
argument_list|(
name|query_pkt
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ldns_pkt_set_edns_udp_size
argument_list|(
name|query_pkt
argument_list|,
literal|4096
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|answer_pkt
argument_list|)
expr_stmt|;
comment|/* Nameservers should not become  					 * unreachable because fragments are 					 * dropped (network error). We might 					 * still have success with TCP. 					 * Therefore maintain reachability 					 * statuses of the nameservers by 					 * backup and restore the rtt list. 					 */
name|rtt
operator|=
name|ldns_resolver_backup_rtt
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|stat
operator|=
name|ldns_send
argument_list|(
operator|&
name|answer_pkt
argument_list|,
name|r
argument_list|,
name|query_pkt
argument_list|)
expr_stmt|;
name|ldns_resolver_restore_rtt
argument_list|(
name|r
argument_list|,
name|rtt
argument_list|)
expr_stmt|;
block|}
comment|/* either way, if it is still truncated, use TCP */
if|if
condition|(
name|stat
operator|!=
name|LDNS_STATUS_OK
operator|||
name|ldns_pkt_tc
argument_list|(
name|answer_pkt
argument_list|)
condition|)
block|{
name|ldns_resolver_set_usevc
argument_list|(
name|r
argument_list|,
name|true
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|answer_pkt
argument_list|)
expr_stmt|;
name|stat
operator|=
name|ldns_send
argument_list|(
operator|&
name|answer_pkt
argument_list|,
name|r
argument_list|,
name|query_pkt
argument_list|)
expr_stmt|;
name|ldns_resolver_set_usevc
argument_list|(
name|r
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
if|if
condition|(
name|answer
condition|)
block|{
operator|*
name|answer
operator|=
name|answer_pkt
expr_stmt|;
block|}
return|return
name|stat
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_resolver_prepare_query_pkt
parameter_list|(
name|ldns_pkt
modifier|*
modifier|*
name|query_pkt
parameter_list|,
name|ldns_resolver
modifier|*
name|r
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|,
name|uint16_t
name|flags
parameter_list|)
block|{
name|struct
name|timeval
name|now
decl_stmt|;
comment|/* prepare a question pkt from the parameters 	 * and then send this */
operator|*
name|query_pkt
operator|=
name|ldns_pkt_query_new
argument_list|(
name|ldns_rdf_clone
argument_list|(
name|name
argument_list|)
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|query_pkt
condition|)
block|{
return|return
name|LDNS_STATUS_ERR
return|;
block|}
comment|/* set DO bit if necessary */
if|if
condition|(
name|ldns_resolver_dnssec
argument_list|(
name|r
argument_list|)
condition|)
block|{
if|if
condition|(
name|ldns_resolver_edns_udp_size
argument_list|(
name|r
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ldns_resolver_set_edns_udp_size
argument_list|(
name|r
argument_list|,
literal|4096
argument_list|)
expr_stmt|;
block|}
name|ldns_pkt_set_edns_do
argument_list|(
operator|*
name|query_pkt
argument_list|,
name|true
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_resolver_dnssec_cd
argument_list|(
name|r
argument_list|)
operator|||
operator|(
name|flags
operator|&
name|LDNS_CD
operator|)
condition|)
block|{
name|ldns_pkt_set_cd
argument_list|(
operator|*
name|query_pkt
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
block|}
comment|/* transfer the udp_edns_size from the resolver to the packet */
if|if
condition|(
name|ldns_resolver_edns_udp_size
argument_list|(
name|r
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|ldns_pkt_set_edns_udp_size
argument_list|(
operator|*
name|query_pkt
argument_list|,
name|ldns_resolver_edns_udp_size
argument_list|(
name|r
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* set the timestamp */
name|now
operator|.
name|tv_sec
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|now
operator|.
name|tv_usec
operator|=
literal|0
expr_stmt|;
name|ldns_pkt_set_timestamp
argument_list|(
operator|*
name|query_pkt
argument_list|,
name|now
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_resolver_debug
argument_list|(
name|r
argument_list|)
condition|)
block|{
name|ldns_pkt_print
argument_list|(
name|stdout
argument_list|,
operator|*
name|query_pkt
argument_list|)
expr_stmt|;
block|}
comment|/* only set the id if it is not set yet */
if|if
condition|(
name|ldns_pkt_id
argument_list|(
operator|*
name|query_pkt
argument_list|)
operator|==
literal|0
condition|)
block|{
name|ldns_pkt_set_random_id
argument_list|(
operator|*
name|query_pkt
argument_list|)
expr_stmt|;
block|}
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_resolver_send
parameter_list|(
name|ldns_pkt
modifier|*
modifier|*
name|answer
parameter_list|,
name|ldns_resolver
modifier|*
name|r
parameter_list|,
specifier|const
name|ldns_rdf
modifier|*
name|name
parameter_list|,
name|ldns_rr_type
name|t
parameter_list|,
name|ldns_rr_class
name|c
parameter_list|,
name|uint16_t
name|flags
parameter_list|)
block|{
name|ldns_pkt
modifier|*
name|query_pkt
decl_stmt|;
name|ldns_pkt
modifier|*
name|answer_pkt
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|assert
argument_list|(
name|r
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|assert
argument_list|(
name|name
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|answer_pkt
operator|=
name|NULL
expr_stmt|;
comment|/* do all the preprocessing here, then fire of an query to 	 * the network */
if|if
condition|(
literal|0
operator|==
name|t
condition|)
block|{
name|t
operator|=
name|LDNS_RR_TYPE_A
expr_stmt|;
block|}
if|if
condition|(
literal|0
operator|==
name|c
condition|)
block|{
name|c
operator|=
name|LDNS_RR_CLASS_IN
expr_stmt|;
block|}
if|if
condition|(
literal|0
operator|==
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
condition|)
block|{
return|return
name|LDNS_STATUS_RES_NO_NS
return|;
block|}
if|if
condition|(
name|ldns_rdf_get_type
argument_list|(
name|name
argument_list|)
operator|!=
name|LDNS_RDF_TYPE_DNAME
condition|)
block|{
return|return
name|LDNS_STATUS_RES_QUERY
return|;
block|}
name|status
operator|=
name|ldns_resolver_prepare_query_pkt
argument_list|(
operator|&
name|query_pkt
argument_list|,
name|r
argument_list|,
name|name
argument_list|,
name|t
argument_list|,
name|c
argument_list|,
name|flags
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|status
return|;
block|}
comment|/* if tsig values are set, tsign it */
comment|/* TODO: make last 3 arguments optional too? maybe make complete 	         rr instead of seperate values in resolver (and packet) 	  Jelte 	  should this go in pkt_prepare? 	*/
if|if
condition|(
name|ldns_resolver_tsig_keyname
argument_list|(
name|r
argument_list|)
operator|&&
name|ldns_resolver_tsig_keydata
argument_list|(
name|r
argument_list|)
condition|)
block|{
ifdef|#
directive|ifdef
name|HAVE_SSL
name|status
operator|=
name|ldns_pkt_tsig_sign
argument_list|(
name|query_pkt
argument_list|,
name|ldns_resolver_tsig_keyname
argument_list|(
name|r
argument_list|)
argument_list|,
name|ldns_resolver_tsig_keydata
argument_list|(
name|r
argument_list|)
argument_list|,
literal|300
argument_list|,
name|ldns_resolver_tsig_algorithm
argument_list|(
name|r
argument_list|)
argument_list|,
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
return|return
name|LDNS_STATUS_CRYPTO_TSIG_ERR
return|;
block|}
else|#
directive|else
return|return
name|LDNS_STATUS_CRYPTO_TSIG_ERR
return|;
endif|#
directive|endif
comment|/* HAVE_SSL */
block|}
name|status
operator|=
name|ldns_resolver_send_pkt
argument_list|(
operator|&
name|answer_pkt
argument_list|,
name|r
argument_list|,
name|query_pkt
argument_list|)
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|query_pkt
argument_list|)
expr_stmt|;
comment|/* allows answer to be NULL when not interested in return value */
if|if
condition|(
name|answer
condition|)
block|{
operator|*
name|answer
operator|=
name|answer_pkt
expr_stmt|;
block|}
return|return
name|status
return|;
block|}
end_function

begin_function
name|ldns_rr
modifier|*
name|ldns_axfr_next
parameter_list|(
name|ldns_resolver
modifier|*
name|resolver
parameter_list|)
block|{
name|ldns_rr
modifier|*
name|cur_rr
decl_stmt|;
name|uint8_t
modifier|*
name|packet_wire
decl_stmt|;
name|size_t
name|packet_wire_size
decl_stmt|;
name|ldns_lookup_table
modifier|*
name|rcode
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
comment|/* check if start() has been called */
if|if
condition|(
operator|!
name|resolver
operator|||
name|resolver
operator|->
name|_socket
operator|==
literal|0
condition|)
block|{
return|return
name|NULL
return|;
block|}
if|if
condition|(
name|resolver
operator|->
name|_cur_axfr_pkt
condition|)
block|{
if|if
condition|(
name|resolver
operator|->
name|_axfr_i
operator|==
name|ldns_pkt_ancount
argument_list|(
name|resolver
operator|->
name|_cur_axfr_pkt
argument_list|)
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|resolver
operator|->
name|_cur_axfr_pkt
argument_list|)
expr_stmt|;
name|resolver
operator|->
name|_cur_axfr_pkt
operator|=
name|NULL
expr_stmt|;
return|return
name|ldns_axfr_next
argument_list|(
name|resolver
argument_list|)
return|;
block|}
name|cur_rr
operator|=
name|ldns_rr_clone
argument_list|(
name|ldns_rr_list_rr
argument_list|(
name|ldns_pkt_answer
argument_list|(
name|resolver
operator|->
name|_cur_axfr_pkt
argument_list|)
argument_list|,
name|resolver
operator|->
name|_axfr_i
argument_list|)
argument_list|)
expr_stmt|;
name|resolver
operator|->
name|_axfr_i
operator|++
expr_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|cur_rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_SOA
condition|)
block|{
name|resolver
operator|->
name|_axfr_soa_count
operator|++
expr_stmt|;
if|if
condition|(
name|resolver
operator|->
name|_axfr_soa_count
operator|>=
literal|2
condition|)
block|{
ifndef|#
directive|ifndef
name|USE_WINSOCK
name|close
argument_list|(
name|resolver
operator|->
name|_socket
argument_list|)
expr_stmt|;
else|#
directive|else
name|closesocket
argument_list|(
name|resolver
operator|->
name|_socket
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|resolver
operator|->
name|_socket
operator|=
literal|0
expr_stmt|;
name|ldns_pkt_free
argument_list|(
name|resolver
operator|->
name|_cur_axfr_pkt
argument_list|)
expr_stmt|;
name|resolver
operator|->
name|_cur_axfr_pkt
operator|=
name|NULL
expr_stmt|;
block|}
block|}
return|return
name|cur_rr
return|;
block|}
else|else
block|{
name|packet_wire
operator|=
name|ldns_tcp_read_wire
argument_list|(
name|resolver
operator|->
name|_socket
argument_list|,
operator|&
name|packet_wire_size
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|packet_wire
condition|)
return|return
name|NULL
return|;
name|status
operator|=
name|ldns_wire2pkt
argument_list|(
operator|&
name|resolver
operator|->
name|_cur_axfr_pkt
argument_list|,
name|packet_wire
argument_list|,
name|packet_wire_size
argument_list|)
expr_stmt|;
name|LDNS_FREE
argument_list|(
name|packet_wire
argument_list|)
expr_stmt|;
name|resolver
operator|->
name|_axfr_i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|status
operator|!=
name|LDNS_STATUS_OK
condition|)
block|{
comment|/* TODO: make status return type of this function (...api change) */
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error parsing rr during AXFR: %s\n"
argument_list|,
name|ldns_get_errorstr_by_id
argument_list|(
name|status
argument_list|)
argument_list|)
expr_stmt|;
comment|/* RoRi: we must now also close the socket, otherwise subsequent uses of the 			   same resolver structure will fail because the link is still open or 			   in an undefined state */
ifndef|#
directive|ifndef
name|USE_WINSOCK
name|close
argument_list|(
name|resolver
operator|->
name|_socket
argument_list|)
expr_stmt|;
else|#
directive|else
name|closesocket
argument_list|(
name|resolver
operator|->
name|_socket
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|resolver
operator|->
name|_socket
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
elseif|else
if|if
condition|(
name|ldns_pkt_get_rcode
argument_list|(
name|resolver
operator|->
name|_cur_axfr_pkt
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|rcode
operator|=
name|ldns_lookup_by_id
argument_list|(
name|ldns_rcodes
argument_list|,
operator|(
name|int
operator|)
name|ldns_pkt_get_rcode
argument_list|(
name|resolver
operator|->
name|_cur_axfr_pkt
argument_list|)
argument_list|)
expr_stmt|;
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"Error in AXFR: %s\n"
argument_list|,
name|rcode
operator|->
name|name
argument_list|)
expr_stmt|;
comment|/* RoRi: we must now also close the socket, otherwise subsequent uses of the 			   same resolver structure will fail because the link is still open or 			   in an undefined state */
ifndef|#
directive|ifndef
name|USE_WINSOCK
name|close
argument_list|(
name|resolver
operator|->
name|_socket
argument_list|)
expr_stmt|;
else|#
directive|else
name|closesocket
argument_list|(
name|resolver
operator|->
name|_socket
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|resolver
operator|->
name|_socket
operator|=
literal|0
expr_stmt|;
return|return
name|NULL
return|;
block|}
else|else
block|{
return|return
name|ldns_axfr_next
argument_list|(
name|resolver
argument_list|)
return|;
block|}
block|}
block|}
end_function

begin_function
name|bool
name|ldns_axfr_complete
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|res
parameter_list|)
block|{
comment|/* complete when soa count is 2? */
return|return
name|res
operator|->
name|_axfr_soa_count
operator|==
literal|2
return|;
block|}
end_function

begin_function
name|ldns_pkt
modifier|*
name|ldns_axfr_last_pkt
parameter_list|(
specifier|const
name|ldns_resolver
modifier|*
name|res
parameter_list|)
block|{
return|return
name|res
operator|->
name|_cur_axfr_pkt
return|;
block|}
end_function

begin_comment
comment|/* random isn't really that good */
end_comment

begin_function
name|void
name|ldns_resolver_nameservers_randomize
parameter_list|(
name|ldns_resolver
modifier|*
name|r
parameter_list|)
block|{
name|uint16_t
name|i
decl_stmt|,
name|j
decl_stmt|;
name|ldns_rdf
modifier|*
modifier|*
name|ns
decl_stmt|,
modifier|*
name|tmp
decl_stmt|;
comment|/* should I check for ldns_resolver_random?? */
name|assert
argument_list|(
name|r
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|ns
operator|=
name|ldns_resolver_nameservers
argument_list|(
name|r
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|j
operator|=
name|ldns_get_random
argument_list|()
operator|%
name|ldns_resolver_nameserver_count
argument_list|(
name|r
argument_list|)
expr_stmt|;
name|tmp
operator|=
name|ns
index|[
name|i
index|]
expr_stmt|;
name|ns
index|[
name|i
index|]
operator|=
name|ns
index|[
name|j
index|]
expr_stmt|;
name|ns
index|[
name|j
index|]
operator|=
name|tmp
expr_stmt|;
block|}
name|ldns_resolver_set_nameservers
argument_list|(
name|r
argument_list|,
name|ns
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


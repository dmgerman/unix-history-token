begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * Copyright (C) Arnaldo Carvalho de Melo 2004  * Copyright (C) Ian McDonald 2005  * Copyright (C) Yoshifumi Nishida 2005  *  * This software may be distributed either under the terms of the  * BSD-style license that accompanies tcpdump or the GNU GPL version 2  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
specifier|const
name|char
name|rcsid
index|[]
name|_U_
init|=
literal|"@(#) $Header: /tcpdump/master/tcpdump/print-dccp.c,v 1.1.2.6 2006/02/19 05:08:44 guy Exp $ (LBL)"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_ifdef
ifdef|#
directive|ifdef
name|HAVE_CONFIG_H
end_ifdef

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<tcpdump-stdinc.h>
end_include

begin_include
include|#
directive|include
file|"dccp.h"
end_include

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<string.h>
end_include

begin_include
include|#
directive|include
file|"interface.h"
end_include

begin_include
include|#
directive|include
file|"addrtoname.h"
end_include

begin_include
include|#
directive|include
file|"extract.h"
end_include

begin_comment
comment|/* must come after interface.h */
end_comment

begin_include
include|#
directive|include
file|"ip.h"
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_include
include|#
directive|include
file|"ip6.h"
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|"ipproto.h"
end_include

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|dccp_reset_codes
index|[]
init|=
block|{
literal|"unspecified"
block|,
literal|"closed"
block|,
literal|"aborted"
block|,
literal|"no_connection"
block|,
literal|"packet_error"
block|,
literal|"option_error"
block|,
literal|"mandatory_error"
block|,
literal|"connection_refused"
block|,
literal|"bad_service_code"
block|,
literal|"too_busy"
block|,
literal|"bad_init_cookie"
block|,
literal|"aggression_penalty"
block|, }
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
specifier|const
name|char
modifier|*
name|dccp_feature_nums
index|[]
init|=
block|{
literal|"reserved"
block|,
literal|"ccid"
block|,
literal|"allow_short_seqno"
block|,
literal|"sequence_window"
block|,
literal|"ecn_incapable"
block|,
literal|"ack_ratio"
block|,
literal|"send_ack_vector"
block|,
literal|"send_ndp_count"
block|,
literal|"minimum checksum coverage"
block|,
literal|"check data checksum"
block|, }
decl_stmt|;
end_decl_stmt

begin_function
specifier|static
name|int
name|dccp_cksum
parameter_list|(
specifier|const
name|struct
name|ip
modifier|*
name|ip
parameter_list|,
specifier|const
name|struct
name|dccp_hdr
modifier|*
name|dh
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
union|union
name|phu
block|{
struct|struct
name|phdr
block|{
name|u_int32_t
name|src
decl_stmt|;
name|u_int32_t
name|dst
decl_stmt|;
name|u_char
name|mbz
decl_stmt|;
name|u_char
name|proto
decl_stmt|;
name|u_int16_t
name|len
decl_stmt|;
block|}
name|ph
struct|;
name|u_int16_t
name|pa
index|[
literal|6
index|]
decl_stmt|;
block|}
name|phu
union|;
specifier|const
name|u_int16_t
modifier|*
name|sp
decl_stmt|;
comment|/* pseudo-header.. */
name|phu
operator|.
name|ph
operator|.
name|mbz
operator|=
literal|0
expr_stmt|;
name|phu
operator|.
name|ph
operator|.
name|len
operator|=
name|htons
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|phu
operator|.
name|ph
operator|.
name|proto
operator|=
name|IPPROTO_DCCP
expr_stmt|;
name|memcpy
argument_list|(
operator|&
name|phu
operator|.
name|ph
operator|.
name|src
argument_list|,
operator|&
name|ip
operator|->
name|ip_src
operator|.
name|s_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|IP_HL
argument_list|(
name|ip
argument_list|)
operator|==
literal|5
condition|)
name|memcpy
argument_list|(
operator|&
name|phu
operator|.
name|ph
operator|.
name|dst
argument_list|,
operator|&
name|ip
operator|->
name|ip_dst
operator|.
name|s_addr
argument_list|,
sizeof|sizeof
argument_list|(
name|u_int32_t
argument_list|)
argument_list|)
expr_stmt|;
else|else
name|phu
operator|.
name|ph
operator|.
name|dst
operator|=
name|ip_finddst
argument_list|(
name|ip
argument_list|)
expr_stmt|;
name|sp
operator|=
operator|&
name|phu
operator|.
name|pa
index|[
literal|0
index|]
expr_stmt|;
return|return
name|in_cksum
argument_list|(
operator|(
name|u_short
operator|*
operator|)
name|dh
argument_list|,
name|len
argument_list|,
name|sp
index|[
literal|0
index|]
operator|+
name|sp
index|[
literal|1
index|]
operator|+
name|sp
index|[
literal|2
index|]
operator|+
name|sp
index|[
literal|3
index|]
operator|+
name|sp
index|[
literal|4
index|]
operator|+
name|sp
index|[
literal|5
index|]
argument_list|)
return|;
block|}
end_function

begin_ifdef
ifdef|#
directive|ifdef
name|INET6
end_ifdef

begin_function
specifier|static
name|int
name|dccp6_cksum
parameter_list|(
specifier|const
name|struct
name|ip6_hdr
modifier|*
name|ip6
parameter_list|,
specifier|const
name|struct
name|dccp_hdr
modifier|*
name|dh
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
name|size_t
name|i
decl_stmt|;
specifier|const
name|u_int16_t
modifier|*
name|sp
decl_stmt|;
name|u_int32_t
name|sum
decl_stmt|;
union|union
block|{
struct|struct
block|{
name|struct
name|in6_addr
name|ph_src
decl_stmt|;
name|struct
name|in6_addr
name|ph_dst
decl_stmt|;
name|u_int32_t
name|ph_len
decl_stmt|;
name|u_int8_t
name|ph_zero
index|[
literal|3
index|]
decl_stmt|;
name|u_int8_t
name|ph_nxt
decl_stmt|;
block|}
name|ph
struct|;
name|u_int16_t
name|pa
index|[
literal|20
index|]
decl_stmt|;
block|}
name|phu
union|;
comment|/* pseudo-header */
name|memset
argument_list|(
operator|&
name|phu
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
name|phu
argument_list|)
argument_list|)
expr_stmt|;
name|phu
operator|.
name|ph
operator|.
name|ph_src
operator|=
name|ip6
operator|->
name|ip6_src
expr_stmt|;
name|phu
operator|.
name|ph
operator|.
name|ph_dst
operator|=
name|ip6
operator|->
name|ip6_dst
expr_stmt|;
name|phu
operator|.
name|ph
operator|.
name|ph_len
operator|=
name|htonl
argument_list|(
name|len
argument_list|)
expr_stmt|;
name|phu
operator|.
name|ph
operator|.
name|ph_nxt
operator|=
name|IPPROTO_DCCP
expr_stmt|;
name|sum
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
sizeof|sizeof
argument_list|(
name|phu
operator|.
name|pa
argument_list|)
operator|/
sizeof|sizeof
argument_list|(
name|phu
operator|.
name|pa
index|[
literal|0
index|]
argument_list|)
condition|;
name|i
operator|++
control|)
name|sum
operator|+=
name|phu
operator|.
name|pa
index|[
name|i
index|]
expr_stmt|;
name|sp
operator|=
operator|(
specifier|const
name|u_int16_t
operator|*
operator|)
name|dh
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
operator|(
name|len
operator|&
operator|~
literal|1
operator|)
condition|;
name|i
operator|+=
literal|2
control|)
name|sum
operator|+=
operator|*
name|sp
operator|++
expr_stmt|;
if|if
condition|(
name|len
operator|&
literal|1
condition|)
name|sum
operator|+=
name|htons
argument_list|(
operator|(
operator|*
operator|(
specifier|const
name|u_int8_t
operator|*
operator|)
name|sp
operator|)
operator|<<
literal|8
argument_list|)
expr_stmt|;
while|while
condition|(
name|sum
operator|>
literal|0xffff
condition|)
name|sum
operator|=
operator|(
name|sum
operator|&
literal|0xffff
operator|)
operator|+
operator|(
name|sum
operator|>>
literal|16
operator|)
expr_stmt|;
name|sum
operator|=
operator|~
name|sum
operator|&
literal|0xffff
expr_stmt|;
return|return
operator|(
name|sum
operator|)
return|;
block|}
end_function

begin_endif
endif|#
directive|endif
end_endif

begin_function
specifier|static
specifier|const
name|char
modifier|*
name|dccp_reset_code
parameter_list|(
name|u_int8_t
name|code
parameter_list|)
block|{
if|if
condition|(
name|code
operator|>=
name|__DCCP_RESET_CODE_LAST
condition|)
return|return
literal|"invalid"
return|;
return|return
name|dccp_reset_codes
index|[
name|code
index|]
return|;
block|}
end_function

begin_function
specifier|static
name|u_int64_t
name|dccp_seqno
parameter_list|(
specifier|const
name|struct
name|dccp_hdr
modifier|*
name|dh
parameter_list|)
block|{
name|u_int32_t
name|seq_high
init|=
name|DCCPH_SEQ
argument_list|(
name|dh
argument_list|)
decl_stmt|;
name|u_int64_t
name|seqno
init|=
name|EXTRACT_24BITS
argument_list|(
operator|&
name|seq_high
argument_list|)
operator|&
literal|0xFFFFFF
decl_stmt|;
if|if
condition|(
name|DCCPH_X
argument_list|(
name|dh
argument_list|)
operator|!=
literal|0
condition|)
block|{
specifier|const
name|struct
name|dccp_hdr_ext
modifier|*
name|dhx
init|=
operator|(
name|void
operator|*
operator|)
operator|(
name|dh
operator|+
literal|1
operator|)
decl_stmt|;
name|u_int32_t
name|seq_low
init|=
name|dhx
operator|->
name|dccph_seq_low
decl_stmt|;
name|seqno
operator|&=
literal|0x00FFFF
expr_stmt|;
comment|/* clear reserved field */
name|seqno
operator|=
operator|(
name|seqno
operator|<<
literal|32
operator|)
operator|+
name|EXTRACT_32BITS
argument_list|(
operator|&
name|seq_low
argument_list|)
expr_stmt|;
block|}
return|return
name|seqno
return|;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|unsigned
name|int
name|dccp_basic_hdr_len
parameter_list|(
specifier|const
name|struct
name|dccp_hdr
modifier|*
name|dh
parameter_list|)
block|{
return|return
sizeof|sizeof
argument_list|(
operator|*
name|dh
argument_list|)
operator|+
operator|(
name|DCCPH_X
argument_list|(
name|dh
argument_list|)
condition|?
sizeof|sizeof
argument_list|(
expr|struct
name|dccp_hdr_ext
argument_list|)
else|:
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|dccp_print_ack_no
parameter_list|(
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|)
block|{
specifier|const
name|struct
name|dccp_hdr
modifier|*
name|dh
init|=
operator|(
specifier|const
expr|struct
name|dccp_hdr
operator|*
operator|)
name|bp
decl_stmt|;
specifier|const
name|struct
name|dccp_hdr_ack_bits
modifier|*
name|dh_ack
init|=
operator|(
expr|struct
name|dccp_hdr_ack_bits
operator|*
operator|)
operator|(
name|bp
operator|+
name|dccp_basic_hdr_len
argument_list|(
name|dh
argument_list|)
operator|)
decl_stmt|;
name|u_int32_t
name|ack_high
decl_stmt|;
name|u_int64_t
name|ackno
decl_stmt|;
name|TCHECK2
argument_list|(
operator|*
name|dh_ack
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|ack_high
operator|=
name|DCCPH_ACK
argument_list|(
name|dh_ack
argument_list|)
expr_stmt|;
name|ackno
operator|=
name|EXTRACT_24BITS
argument_list|(
operator|&
name|ack_high
argument_list|)
operator|&
literal|0xFFFFFF
expr_stmt|;
if|if
condition|(
name|DCCPH_X
argument_list|(
name|dh
argument_list|)
operator|!=
literal|0
condition|)
block|{
name|u_int32_t
name|ack_low
decl_stmt|;
name|TCHECK2
argument_list|(
operator|*
name|dh_ack
argument_list|,
literal|8
argument_list|)
expr_stmt|;
name|ack_low
operator|=
name|dh_ack
operator|->
name|dccph_ack_nr_low
expr_stmt|;
name|ackno
operator|&=
literal|0x00FFFF
expr_stmt|;
comment|/* clear reserved field */
name|ackno
operator|=
operator|(
name|ackno
operator|<<
literal|32
operator|)
operator|+
name|EXTRACT_32BITS
argument_list|(
operator|&
name|ack_low
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"(ack=%"
name|PRIu64
literal|") "
argument_list|,
name|ackno
argument_list|)
expr_stmt|;
name|trunc
label|:
return|return;
block|}
end_function

begin_function
specifier|static
specifier|inline
name|unsigned
name|int
name|dccp_packet_hdr_len
parameter_list|(
specifier|const
name|u_int8_t
name|type
parameter_list|)
block|{
if|if
condition|(
name|type
operator|==
name|DCCP_PKT_DATA
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|type
operator|==
name|DCCP_PKT_DATAACK
operator|||
name|type
operator|==
name|DCCP_PKT_ACK
operator|||
name|type
operator|==
name|DCCP_PKT_SYNC
operator|||
name|type
operator|==
name|DCCP_PKT_SYNCACK
operator|||
name|type
operator|==
name|DCCP_PKT_CLOSE
operator|||
name|type
operator|==
name|DCCP_PKT_CLOSEREQ
condition|)
return|return
sizeof|sizeof
argument_list|(
expr|struct
name|dccp_hdr_ack_bits
argument_list|)
return|;
if|if
condition|(
name|type
operator|==
name|DCCP_PKT_REQUEST
condition|)
return|return
sizeof|sizeof
argument_list|(
expr|struct
name|dccp_hdr_request
argument_list|)
return|;
if|if
condition|(
name|type
operator|==
name|DCCP_PKT_RESPONSE
condition|)
return|return
sizeof|sizeof
argument_list|(
expr|struct
name|dccp_hdr_response
argument_list|)
return|;
return|return
sizeof|sizeof
argument_list|(
expr|struct
name|dccp_hdr_reset
argument_list|)
return|;
block|}
end_function

begin_function_decl
specifier|static
name|int
name|dccp_print_option
parameter_list|(
specifier|const
name|u_char
modifier|*
name|option
parameter_list|)
function_decl|;
end_function_decl

begin_comment
comment|/**  * dccp_print - show dccp packet  * @bp - beginning of dccp packet  * @data2 - beginning of enclosing   * @len - lenght of ip packet  */
end_comment

begin_function
name|void
name|dccp_print
parameter_list|(
specifier|const
name|u_char
modifier|*
name|bp
parameter_list|,
specifier|const
name|u_char
modifier|*
name|data2
parameter_list|,
name|u_int
name|len
parameter_list|)
block|{
specifier|const
name|struct
name|dccp_hdr
modifier|*
name|dh
decl_stmt|;
specifier|const
name|struct
name|ip
modifier|*
name|ip
decl_stmt|;
ifdef|#
directive|ifdef
name|INET6
specifier|const
name|struct
name|ip6_hdr
modifier|*
name|ip6
decl_stmt|;
endif|#
directive|endif
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|u_short
name|sport
decl_stmt|,
name|dport
decl_stmt|;
name|u_int
name|hlen
decl_stmt|;
name|u_int
name|extlen
init|=
literal|0
decl_stmt|;
name|dh
operator|=
operator|(
specifier|const
expr|struct
name|dccp_hdr
operator|*
operator|)
name|bp
expr_stmt|;
name|ip
operator|=
operator|(
expr|struct
name|ip
operator|*
operator|)
name|data2
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
if|if
condition|(
name|IP_V
argument_list|(
name|ip
argument_list|)
operator|==
literal|6
condition|)
name|ip6
operator|=
operator|(
specifier|const
expr|struct
name|ip6_hdr
operator|*
operator|)
name|data2
expr_stmt|;
else|else
name|ip6
operator|=
name|NULL
expr_stmt|;
endif|#
directive|endif
comment|/*INET6*/
name|cp
operator|=
operator|(
specifier|const
name|u_char
operator|*
operator|)
operator|(
name|dh
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|cp
operator|>
name|snapend
condition|)
block|{
name|printf
argument_list|(
literal|"[Invalid packet|dccp]"
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|len
operator|<
sizeof|sizeof
argument_list|(
expr|struct
name|dccp_hdr
argument_list|)
condition|)
block|{
name|printf
argument_list|(
literal|"truncated-dccp - %ld bytes missing!"
argument_list|,
operator|(
name|long
operator|)
name|len
operator|-
sizeof|sizeof
argument_list|(
expr|struct
name|dccp_hdr
argument_list|)
argument_list|)
expr_stmt|;
return|return;
block|}
name|sport
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|dh
operator|->
name|dccph_sport
argument_list|)
expr_stmt|;
name|dport
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|dh
operator|->
name|dccph_dport
argument_list|)
expr_stmt|;
name|hlen
operator|=
name|dh
operator|->
name|dccph_doff
operator|*
literal|4
expr_stmt|;
ifdef|#
directive|ifdef
name|INET6
if|if
condition|(
name|ip6
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s.%d> %s.%d: "
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|ip6
operator|->
name|ip6_src
argument_list|)
argument_list|,
name|sport
argument_list|,
name|ip6addr_string
argument_list|(
operator|&
name|ip6
operator|->
name|ip6_dst
argument_list|)
argument_list|,
name|dport
argument_list|)
expr_stmt|;
block|}
else|else
endif|#
directive|endif
comment|/*INET6*/
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"%s.%d> %s.%d: "
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|ip
operator|->
name|ip_src
argument_list|)
argument_list|,
name|sport
argument_list|,
name|ipaddr_string
argument_list|(
operator|&
name|ip
operator|->
name|ip_dst
argument_list|)
argument_list|,
name|dport
argument_list|)
expr_stmt|;
block|}
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|qflag
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
name|len
operator|-
name|hlen
argument_list|)
expr_stmt|;
if|if
condition|(
name|hlen
operator|>
name|len
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"dccp [bad hdr length %u - too long,> %u]"
argument_list|,
name|hlen
argument_list|,
name|len
argument_list|)
expr_stmt|;
block|}
return|return;
block|}
comment|/* other variables in generic header */
if|if
condition|(
name|vflag
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"CCVal %d, CsCov %d, "
argument_list|,
name|DCCPH_CCVAL
argument_list|(
name|dh
argument_list|)
argument_list|,
name|DCCPH_CSCOV
argument_list|(
name|dh
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/* checksum calculation */
ifdef|#
directive|ifdef
name|INET6
if|if
condition|(
name|ip6
condition|)
block|{
if|if
condition|(
name|ip6
operator|->
name|ip6_plen
operator|&&
name|vflag
condition|)
block|{
name|u_int16_t
name|sum
decl_stmt|,
name|dccp_sum
decl_stmt|;
name|sum
operator|=
name|dccp6_cksum
argument_list|(
name|ip6
argument_list|,
name|dh
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dccp_sum
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|dh
operator|->
name|dccph_checksum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cksum 0x%04x"
argument_list|,
name|dccp_sum
argument_list|)
expr_stmt|;
if|if
condition|(
name|sum
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (incorrect (-> 0x%04x), "
argument_list|,
name|in_cksum_shouldbe
argument_list|(
name|dccp_sum
argument_list|,
name|sum
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (correct), "
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
endif|#
directive|endif
comment|/* INET6 */
if|if
condition|(
name|vflag
condition|)
block|{
name|u_int16_t
name|sum
decl_stmt|,
name|dccp_sum
decl_stmt|;
name|sum
operator|=
name|dccp_cksum
argument_list|(
name|ip
argument_list|,
name|dh
argument_list|,
name|len
argument_list|)
expr_stmt|;
name|dccp_sum
operator|=
name|EXTRACT_16BITS
argument_list|(
operator|&
name|dh
operator|->
name|dccph_checksum
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cksum 0x%04x"
argument_list|,
name|dccp_sum
argument_list|)
expr_stmt|;
if|if
condition|(
name|sum
operator|!=
literal|0
condition|)
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (incorrect (-> 0x%04x), "
argument_list|,
name|in_cksum_shouldbe
argument_list|(
name|dccp_sum
argument_list|,
name|sum
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|" (correct), "
argument_list|)
expr_stmt|;
block|}
switch|switch
condition|(
name|DCCPH_TYPE
argument_list|(
name|dh
argument_list|)
condition|)
block|{
case|case
name|DCCP_PKT_REQUEST
case|:
block|{
name|struct
name|dccp_hdr_request
modifier|*
name|dhr
init|=
operator|(
expr|struct
name|dccp_hdr_request
operator|*
operator|)
operator|(
name|bp
operator|+
name|dccp_basic_hdr_len
argument_list|(
name|dh
argument_list|)
operator|)
decl_stmt|;
name|TCHECK
argument_list|(
operator|*
name|dhr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"request (service=%d) "
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|dhr
operator|->
name|dccph_req_service
argument_list|)
argument_list|)
expr_stmt|;
name|extlen
operator|+=
literal|4
expr_stmt|;
break|break;
block|}
case|case
name|DCCP_PKT_RESPONSE
case|:
block|{
name|struct
name|dccp_hdr_response
modifier|*
name|dhr
init|=
operator|(
expr|struct
name|dccp_hdr_response
operator|*
operator|)
operator|(
name|bp
operator|+
name|dccp_basic_hdr_len
argument_list|(
name|dh
argument_list|)
operator|)
decl_stmt|;
name|TCHECK
argument_list|(
operator|*
name|dhr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"response (service=%d) "
argument_list|,
name|EXTRACT_32BITS
argument_list|(
operator|&
name|dhr
operator|->
name|dccph_resp_service
argument_list|)
argument_list|)
expr_stmt|;
name|extlen
operator|+=
literal|12
expr_stmt|;
break|break;
block|}
case|case
name|DCCP_PKT_DATA
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"data "
argument_list|)
expr_stmt|;
break|break;
case|case
name|DCCP_PKT_ACK
case|:
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"ack "
argument_list|)
expr_stmt|;
name|extlen
operator|+=
literal|8
expr_stmt|;
break|break;
block|}
case|case
name|DCCP_PKT_DATAACK
case|:
block|{
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"dataack "
argument_list|)
expr_stmt|;
name|extlen
operator|+=
literal|8
expr_stmt|;
break|break;
block|}
case|case
name|DCCP_PKT_CLOSEREQ
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"closereq "
argument_list|)
expr_stmt|;
name|extlen
operator|+=
literal|8
expr_stmt|;
break|break;
case|case
name|DCCP_PKT_CLOSE
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"close "
argument_list|)
expr_stmt|;
name|extlen
operator|+=
literal|8
expr_stmt|;
break|break;
case|case
name|DCCP_PKT_RESET
case|:
block|{
name|struct
name|dccp_hdr_reset
modifier|*
name|dhr
init|=
operator|(
expr|struct
name|dccp_hdr_reset
operator|*
operator|)
operator|(
name|bp
operator|+
name|dccp_basic_hdr_len
argument_list|(
name|dh
argument_list|)
operator|)
decl_stmt|;
name|TCHECK
argument_list|(
operator|*
name|dhr
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"reset (code=%s) "
argument_list|,
name|dccp_reset_code
argument_list|(
name|dhr
operator|->
name|dccph_reset_code
argument_list|)
argument_list|)
expr_stmt|;
name|extlen
operator|+=
literal|12
expr_stmt|;
break|break;
block|}
case|case
name|DCCP_PKT_SYNC
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"sync "
argument_list|)
expr_stmt|;
name|extlen
operator|+=
literal|8
expr_stmt|;
break|break;
case|case
name|DCCP_PKT_SYNCACK
case|:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"syncack "
argument_list|)
expr_stmt|;
name|extlen
operator|+=
literal|8
expr_stmt|;
break|break;
default|default:
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"invalid "
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
operator|(
name|DCCPH_TYPE
argument_list|(
name|dh
argument_list|)
operator|!=
name|DCCP_PKT_DATA
operator|)
operator|&&
operator|(
name|DCCPH_TYPE
argument_list|(
name|dh
argument_list|)
operator|!=
name|DCCP_PKT_REQUEST
operator|)
condition|)
name|dccp_print_ack_no
argument_list|(
name|bp
argument_list|)
expr_stmt|;
if|if
condition|(
name|vflag
operator|<
literal|2
condition|)
return|return;
operator|(
name|void
operator|)
name|printf
argument_list|(
literal|"seq %"
name|PRIu64
argument_list|,
name|dccp_seqno
argument_list|(
name|dh
argument_list|)
argument_list|)
expr_stmt|;
comment|/* process options */
if|if
condition|(
name|hlen
operator|>
name|dccp_basic_hdr_len
argument_list|(
name|dh
argument_list|)
operator|+
name|extlen
condition|)
block|{
specifier|const
name|u_char
modifier|*
name|cp
decl_stmt|;
name|u_int
name|optlen
decl_stmt|;
name|cp
operator|=
name|bp
operator|+
name|dccp_basic_hdr_len
argument_list|(
name|dh
argument_list|)
operator|+
name|extlen
expr_stmt|;
name|printf
argument_list|(
literal|"<"
argument_list|)
expr_stmt|;
name|hlen
operator|-=
name|dccp_basic_hdr_len
argument_list|(
name|dh
argument_list|)
operator|+
name|extlen
expr_stmt|;
while|while
condition|(
literal|1
condition|)
block|{
name|TCHECK
argument_list|(
operator|*
name|cp
argument_list|)
expr_stmt|;
name|optlen
operator|=
name|dccp_print_option
argument_list|(
name|cp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|optlen
condition|)
goto|goto
name|trunc2
goto|;
if|if
condition|(
name|hlen
operator|<=
name|optlen
condition|)
break|break;
name|hlen
operator|-=
name|optlen
expr_stmt|;
name|cp
operator|+=
name|optlen
expr_stmt|;
name|printf
argument_list|(
literal|", "
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|">"
argument_list|)
expr_stmt|;
block|}
return|return;
name|trunc
label|:
name|printf
argument_list|(
literal|"[|dccp]"
argument_list|)
expr_stmt|;
name|trunc2
label|:
return|return;
block|}
end_function

begin_function
specifier|static
name|int
name|dccp_print_option
parameter_list|(
specifier|const
name|u_char
modifier|*
name|option
parameter_list|)
block|{
name|u_int8_t
name|optlen
decl_stmt|,
name|i
decl_stmt|;
name|u_int32_t
modifier|*
name|ts
decl_stmt|;
name|u_int16_t
modifier|*
name|var16
decl_stmt|;
name|u_int32_t
modifier|*
name|var32
decl_stmt|;
name|TCHECK
argument_list|(
operator|*
name|option
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|option
operator|>=
literal|32
condition|)
block|{
name|TCHECK
argument_list|(
operator|*
operator|(
name|option
operator|+
literal|1
operator|)
argument_list|)
expr_stmt|;
name|optlen
operator|=
operator|*
operator|(
name|option
operator|+
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|optlen
operator|<
literal|2
condition|)
block|{
name|printf
argument_list|(
literal|"Option %d optlen too short"
argument_list|,
operator|*
name|option
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
block|}
else|else
name|optlen
operator|=
literal|1
expr_stmt|;
name|TCHECK2
argument_list|(
operator|*
name|option
argument_list|,
name|optlen
argument_list|)
expr_stmt|;
switch|switch
condition|(
operator|*
name|option
condition|)
block|{
case|case
literal|0
case|:
name|printf
argument_list|(
literal|"nop"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|printf
argument_list|(
literal|"mandatory"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|printf
argument_list|(
literal|"slowreceiver"
argument_list|)
expr_stmt|;
break|break;
case|case
literal|32
case|:
name|printf
argument_list|(
literal|"change_l"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|option
operator|+
literal|2
operator|)
operator|<
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|dccp_feature_nums
index|[
operator|*
operator|(
name|option
operator|+
literal|2
operator|)
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|optlen
operator|-
literal|3
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
operator|*
operator|(
name|option
operator|+
literal|3
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|33
case|:
name|printf
argument_list|(
literal|"confirm_l"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|option
operator|+
literal|2
operator|)
operator|<
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|dccp_feature_nums
index|[
operator|*
operator|(
name|option
operator|+
literal|2
operator|)
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|optlen
operator|-
literal|3
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
operator|*
operator|(
name|option
operator|+
literal|3
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|34
case|:
name|printf
argument_list|(
literal|"change_r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|option
operator|+
literal|2
operator|)
operator|<
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|dccp_feature_nums
index|[
operator|*
operator|(
name|option
operator|+
literal|2
operator|)
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|optlen
operator|-
literal|3
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
operator|*
operator|(
name|option
operator|+
literal|3
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|35
case|:
name|printf
argument_list|(
literal|"confirm_r"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
operator|(
name|option
operator|+
literal|2
operator|)
operator|<
literal|10
condition|)
block|{
name|printf
argument_list|(
literal|" %s"
argument_list|,
name|dccp_feature_nums
index|[
operator|*
operator|(
name|option
operator|+
literal|2
operator|)
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|optlen
operator|-
literal|3
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
operator|*
operator|(
name|option
operator|+
literal|3
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|36
case|:
name|printf
argument_list|(
literal|"initcookie 0x"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|optlen
operator|-
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|*
operator|(
name|option
operator|+
literal|2
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|37
case|:
name|printf
argument_list|(
literal|"ndp_count"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|optlen
operator|-
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|" %d"
argument_list|,
operator|*
operator|(
name|option
operator|+
literal|2
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|38
case|:
name|printf
argument_list|(
literal|"ack_vector0 0x"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|optlen
operator|-
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|*
operator|(
name|option
operator|+
literal|2
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|39
case|:
name|printf
argument_list|(
literal|"ack_vector1 0x"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|optlen
operator|-
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|*
operator|(
name|option
operator|+
literal|2
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|40
case|:
name|printf
argument_list|(
literal|"data_dropped 0x"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|optlen
operator|-
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|*
operator|(
name|option
operator|+
literal|2
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|41
case|:
name|ts
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|option
operator|+
literal|2
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp %u"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
operator|*
name|ts
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|42
case|:
name|ts
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|option
operator|+
literal|2
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"timestamp_echo %u"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
operator|*
name|ts
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|43
case|:
name|printf
argument_list|(
literal|"elapsed_time "
argument_list|)
expr_stmt|;
if|if
condition|(
name|optlen
operator|==
literal|6
condition|)
block|{
name|ts
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|option
operator|+
literal|2
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"%u"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
operator|*
name|ts
argument_list|)
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|var16
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|option
operator|+
literal|2
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|"%u"
argument_list|,
name|ntohs
argument_list|(
operator|*
name|var16
argument_list|)
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|44
case|:
name|printf
argument_list|(
literal|"data_checksum "
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|optlen
operator|-
literal|2
condition|;
name|i
operator|++
control|)
name|printf
argument_list|(
literal|"%02x"
argument_list|,
operator|*
operator|(
name|option
operator|+
literal|2
operator|+
name|i
operator|)
argument_list|)
expr_stmt|;
break|break;
default|default :
if|if
condition|(
operator|*
name|option
operator|>=
literal|128
condition|)
block|{
name|printf
argument_list|(
literal|"CCID option %d"
argument_list|,
operator|*
name|option
argument_list|)
expr_stmt|;
switch|switch
condition|(
name|optlen
condition|)
block|{
case|case
literal|4
case|:
name|var16
operator|=
operator|(
name|u_int16_t
operator|*
operator|)
operator|(
name|option
operator|+
literal|2
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|" %u"
argument_list|,
name|ntohs
argument_list|(
operator|*
name|var16
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
literal|6
case|:
name|var32
operator|=
operator|(
name|u_int32_t
operator|*
operator|)
operator|(
name|option
operator|+
literal|2
operator|)
expr_stmt|;
name|printf
argument_list|(
literal|" %u"
argument_list|,
operator|(
name|u_int32_t
operator|)
name|ntohl
argument_list|(
operator|*
name|var32
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
block|}
name|printf
argument_list|(
literal|"unknown_opt %d"
argument_list|,
operator|*
name|option
argument_list|)
expr_stmt|;
break|break;
block|}
return|return
name|optlen
return|;
name|trunc
label|:
name|printf
argument_list|(
literal|"[|dccp]"
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit


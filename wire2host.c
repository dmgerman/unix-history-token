begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  * wire2host.c  *  * conversion routines from the wire to the host  * format.  * This will usually just a re-ordering of the  * data (as we store it in network format)  *  * a Net::DNS like library for C  *  * (c) NLnet Labs, 2004-2006  *  * See the file LICENSE for the license  */
end_comment

begin_include
include|#
directive|include
file|<ldns/config.h>
end_include

begin_include
include|#
directive|include
file|<ldns/ldns.h>
end_include

begin_comment
comment|/*#include<ldns/wire2host.h>*/
end_comment

begin_include
include|#
directive|include
file|<strings.h>
end_include

begin_include
include|#
directive|include
file|<limits.h>
end_include

begin_comment
comment|/*  * Set of macro's to deal with the dns message header as specified  * in RFC1035 in portable way.  *  */
end_comment

begin_comment
comment|/*  *  *                                    1  1  1  1  1  1  *      0  1  2  3  4  5  6  7  8  9  0  1  2  3  4  5  *    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+  *    |                      ID                       |  *    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+  *    |QR|   Opcode  |AA|TC|RD|RA| Z|AD|CD|   RCODE   |  *    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+  *    |                    QDCOUNT                    |  *    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+  *    |                    ANCOUNT                    |  *    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+  *    |                    NSCOUNT                    |  *    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+  *    |                    ARCOUNT                    |  *    +--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+  *  */
end_comment

begin_comment
comment|/* allocates memory to *dname! */
end_comment

begin_function
name|ldns_status
name|ldns_wire2dname
parameter_list|(
name|ldns_rdf
modifier|*
modifier|*
name|dname
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|wire
parameter_list|,
name|size_t
name|max
parameter_list|,
name|size_t
modifier|*
name|pos
parameter_list|)
block|{
name|uint8_t
name|label_size
decl_stmt|;
name|uint16_t
name|pointer_target
decl_stmt|;
name|uint8_t
name|pointer_target_buf
index|[
literal|2
index|]
decl_stmt|;
name|size_t
name|dname_pos
init|=
literal|0
decl_stmt|;
name|size_t
name|uncompressed_length
init|=
literal|0
decl_stmt|;
name|size_t
name|compression_pos
init|=
literal|0
decl_stmt|;
name|uint8_t
name|tmp_dname
index|[
name|LDNS_MAX_DOMAINLEN
index|]
decl_stmt|;
name|unsigned
name|int
name|pointer_count
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|pos
operator|==
name|NULL
condition|)
block|{
return|return
name|LDNS_STATUS_WIRE_RDATA_ERR
return|;
block|}
if|if
condition|(
operator|*
name|pos
operator|>=
name|max
condition|)
block|{
return|return
name|LDNS_STATUS_PACKET_OVERFLOW
return|;
block|}
name|label_size
operator|=
name|wire
index|[
operator|*
name|pos
index|]
expr_stmt|;
while|while
condition|(
name|label_size
operator|>
literal|0
condition|)
block|{
comment|/* compression */
while|while
condition|(
name|label_size
operator|>=
literal|192
condition|)
block|{
if|if
condition|(
name|compression_pos
operator|==
literal|0
condition|)
block|{
name|compression_pos
operator|=
operator|*
name|pos
operator|+
literal|2
expr_stmt|;
block|}
name|pointer_count
operator|++
expr_stmt|;
comment|/* remove first two bits */
if|if
condition|(
operator|*
name|pos
operator|+
literal|2
operator|>
name|max
condition|)
block|{
return|return
name|LDNS_STATUS_PACKET_OVERFLOW
return|;
block|}
name|pointer_target_buf
index|[
literal|0
index|]
operator|=
name|wire
index|[
operator|*
name|pos
index|]
operator|&
literal|63
expr_stmt|;
name|pointer_target_buf
index|[
literal|1
index|]
operator|=
name|wire
index|[
operator|*
name|pos
operator|+
literal|1
index|]
expr_stmt|;
name|pointer_target
operator|=
name|ldns_read_uint16
argument_list|(
name|pointer_target_buf
argument_list|)
expr_stmt|;
if|if
condition|(
name|pointer_target
operator|==
literal|0
condition|)
block|{
return|return
name|LDNS_STATUS_INVALID_POINTER
return|;
block|}
elseif|else
if|if
condition|(
name|pointer_target
operator|>=
name|max
condition|)
block|{
return|return
name|LDNS_STATUS_INVALID_POINTER
return|;
block|}
elseif|else
if|if
condition|(
name|pointer_count
operator|>
name|LDNS_MAX_POINTERS
condition|)
block|{
return|return
name|LDNS_STATUS_INVALID_POINTER
return|;
block|}
operator|*
name|pos
operator|=
name|pointer_target
expr_stmt|;
name|label_size
operator|=
name|wire
index|[
operator|*
name|pos
index|]
expr_stmt|;
block|}
if|if
condition|(
name|label_size
operator|==
literal|0
condition|)
break|break;
comment|/* break from pointer to 0 byte */
if|if
condition|(
name|label_size
operator|>
name|LDNS_MAX_LABELLEN
condition|)
block|{
return|return
name|LDNS_STATUS_LABEL_OVERFLOW
return|;
block|}
if|if
condition|(
operator|*
name|pos
operator|+
literal|1
operator|+
name|label_size
operator|>
name|max
condition|)
block|{
return|return
name|LDNS_STATUS_LABEL_OVERFLOW
return|;
block|}
comment|/* check space for labelcount itself */
if|if
condition|(
name|dname_pos
operator|+
literal|1
operator|>
name|LDNS_MAX_DOMAINLEN
condition|)
block|{
return|return
name|LDNS_STATUS_DOMAINNAME_OVERFLOW
return|;
block|}
name|tmp_dname
index|[
name|dname_pos
index|]
operator|=
name|label_size
expr_stmt|;
if|if
condition|(
name|label_size
operator|>
literal|0
condition|)
block|{
name|dname_pos
operator|++
expr_stmt|;
block|}
operator|*
name|pos
operator|=
operator|*
name|pos
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|dname_pos
operator|+
name|label_size
operator|>
name|LDNS_MAX_DOMAINLEN
condition|)
block|{
return|return
name|LDNS_STATUS_DOMAINNAME_OVERFLOW
return|;
block|}
name|memcpy
argument_list|(
operator|&
name|tmp_dname
index|[
name|dname_pos
index|]
argument_list|,
operator|&
name|wire
index|[
operator|*
name|pos
index|]
argument_list|,
name|label_size
argument_list|)
expr_stmt|;
name|uncompressed_length
operator|+=
name|label_size
operator|+
literal|1
expr_stmt|;
name|dname_pos
operator|+=
name|label_size
expr_stmt|;
operator|*
name|pos
operator|=
operator|*
name|pos
operator|+
name|label_size
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|<
name|max
condition|)
block|{
name|label_size
operator|=
name|wire
index|[
operator|*
name|pos
index|]
expr_stmt|;
block|}
block|}
if|if
condition|(
name|compression_pos
operator|>
literal|0
condition|)
block|{
operator|*
name|pos
operator|=
name|compression_pos
expr_stmt|;
block|}
else|else
block|{
operator|*
name|pos
operator|=
operator|*
name|pos
operator|+
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|dname_pos
operator|>=
name|LDNS_MAX_DOMAINLEN
condition|)
block|{
return|return
name|LDNS_STATUS_DOMAINNAME_OVERFLOW
return|;
block|}
name|tmp_dname
index|[
name|dname_pos
index|]
operator|=
literal|0
expr_stmt|;
name|dname_pos
operator|++
expr_stmt|;
operator|*
name|dname
operator|=
name|ldns_rdf_new_frm_data
argument_list|(
name|LDNS_RDF_TYPE_DNAME
argument_list|,
operator|(
name|uint16_t
operator|)
name|dname_pos
argument_list|,
name|tmp_dname
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|dname
condition|)
block|{
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_comment
comment|/* maybe make this a goto error so data can be freed or something/ */
end_comment

begin_define
define|#
directive|define
name|LDNS_STATUS_CHECK_RETURN
parameter_list|(
name|st
parameter_list|)
value|{if (st != LDNS_STATUS_OK) { return st; }}
end_define

begin_define
define|#
directive|define
name|LDNS_STATUS_CHECK_GOTO
parameter_list|(
name|st
parameter_list|,
name|label
parameter_list|)
value|{if (st != LDNS_STATUS_OK) {
comment|/*printf("STG %s:%d: status code %d\n", __FILE__, __LINE__, st);*/
value|goto label; }}
end_define

begin_function
name|ldns_status
name|ldns_wire2rdf
parameter_list|(
name|ldns_rr
modifier|*
name|rr
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|wire
parameter_list|,
name|size_t
name|max
parameter_list|,
name|size_t
modifier|*
name|pos
parameter_list|)
block|{
name|size_t
name|end
decl_stmt|;
name|size_t
name|cur_rdf_length
decl_stmt|;
name|uint8_t
name|rdf_index
decl_stmt|;
name|uint8_t
modifier|*
name|data
decl_stmt|;
name|uint16_t
name|rd_length
decl_stmt|;
name|ldns_rdf
modifier|*
name|cur_rdf
init|=
name|NULL
decl_stmt|;
name|ldns_rdf_type
name|cur_rdf_type
decl_stmt|;
specifier|const
name|ldns_rr_descriptor
modifier|*
name|descriptor
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|assert
argument_list|(
name|rr
operator|!=
name|NULL
argument_list|)
expr_stmt|;
name|descriptor
operator|=
name|ldns_rr_descript
argument_list|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|+
literal|2
operator|>
name|max
condition|)
block|{
return|return
name|LDNS_STATUS_PACKET_OVERFLOW
return|;
block|}
name|rd_length
operator|=
name|ldns_read_uint16
argument_list|(
operator|&
name|wire
index|[
operator|*
name|pos
index|]
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|=
operator|*
name|pos
operator|+
literal|2
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|+
name|rd_length
operator|>
name|max
condition|)
block|{
return|return
name|LDNS_STATUS_PACKET_OVERFLOW
return|;
block|}
name|end
operator|=
operator|*
name|pos
operator|+
operator|(
name|size_t
operator|)
name|rd_length
expr_stmt|;
name|rdf_index
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|*
name|pos
operator|<
name|end
operator|&&
name|rdf_index
operator|<
name|ldns_rr_descriptor_maximum
argument_list|(
name|descriptor
argument_list|)
condition|)
block|{
name|cur_rdf_length
operator|=
literal|0
expr_stmt|;
name|cur_rdf_type
operator|=
name|ldns_rr_descriptor_field_type
argument_list|(
name|descriptor
argument_list|,
name|rdf_index
argument_list|)
expr_stmt|;
comment|/* handle special cases immediately, set length 		   for fixed length rdata and do them below */
switch|switch
condition|(
name|cur_rdf_type
condition|)
block|{
case|case
name|LDNS_RDF_TYPE_DNAME
case|:
name|status
operator|=
name|ldns_wire2dname
argument_list|(
operator|&
name|cur_rdf
argument_list|,
name|wire
argument_list|,
name|max
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|LDNS_STATUS_CHECK_RETURN
argument_list|(
name|status
argument_list|)
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_CLASS
case|:
case|case
name|LDNS_RDF_TYPE_ALG
case|:
case|case
name|LDNS_RDF_TYPE_INT8
case|:
name|cur_rdf_length
operator|=
name|LDNS_RDF_SIZE_BYTE
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_TYPE
case|:
case|case
name|LDNS_RDF_TYPE_INT16
case|:
case|case
name|LDNS_RDF_TYPE_CERT_ALG
case|:
name|cur_rdf_length
operator|=
name|LDNS_RDF_SIZE_WORD
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_TIME
case|:
case|case
name|LDNS_RDF_TYPE_INT32
case|:
case|case
name|LDNS_RDF_TYPE_A
case|:
case|case
name|LDNS_RDF_TYPE_PERIOD
case|:
name|cur_rdf_length
operator|=
name|LDNS_RDF_SIZE_DOUBLEWORD
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_TSIGTIME
case|:
case|case
name|LDNS_RDF_TYPE_EUI48
case|:
name|cur_rdf_length
operator|=
name|LDNS_RDF_SIZE_6BYTES
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_ILNP64
case|:
case|case
name|LDNS_RDF_TYPE_EUI64
case|:
name|cur_rdf_length
operator|=
name|LDNS_RDF_SIZE_8BYTES
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_AAAA
case|:
name|cur_rdf_length
operator|=
name|LDNS_RDF_SIZE_16BYTES
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_STR
case|:
case|case
name|LDNS_RDF_TYPE_NSEC3_SALT
case|:
case|case
name|LDNS_RDF_TYPE_TAG
case|:
comment|/* len is stored in first byte 			 * it should be in the rdf too, so just 			 * copy len+1 from this position 			 */
name|cur_rdf_length
operator|=
operator|(
operator|(
name|size_t
operator|)
name|wire
index|[
operator|*
name|pos
index|]
operator|)
operator|+
literal|1
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_INT16_DATA
case|:
if|if
condition|(
operator|*
name|pos
operator|+
literal|2
operator|>
name|end
condition|)
block|{
return|return
name|LDNS_STATUS_PACKET_OVERFLOW
return|;
block|}
name|cur_rdf_length
operator|=
operator|(
name|size_t
operator|)
name|ldns_read_uint16
argument_list|(
operator|&
name|wire
index|[
operator|*
name|pos
index|]
argument_list|)
operator|+
literal|2
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_HIP
case|:
if|if
condition|(
operator|*
name|pos
operator|+
literal|4
operator|>
name|end
condition|)
block|{
return|return
name|LDNS_STATUS_PACKET_OVERFLOW
return|;
block|}
name|cur_rdf_length
operator|=
operator|(
name|size_t
operator|)
name|wire
index|[
operator|*
name|pos
index|]
operator|+
operator|(
name|size_t
operator|)
name|ldns_read_uint16
argument_list|(
operator|&
name|wire
index|[
operator|*
name|pos
operator|+
literal|2
index|]
argument_list|)
operator|+
literal|4
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_B32_EXT
case|:
case|case
name|LDNS_RDF_TYPE_NSEC3_NEXT_OWNER
case|:
comment|/* length is stored in first byte */
name|cur_rdf_length
operator|=
operator|(
operator|(
name|size_t
operator|)
name|wire
index|[
operator|*
name|pos
index|]
operator|)
operator|+
literal|1
expr_stmt|;
break|break;
case|case
name|LDNS_RDF_TYPE_APL
case|:
case|case
name|LDNS_RDF_TYPE_B64
case|:
case|case
name|LDNS_RDF_TYPE_HEX
case|:
case|case
name|LDNS_RDF_TYPE_NSEC
case|:
case|case
name|LDNS_RDF_TYPE_UNKNOWN
case|:
case|case
name|LDNS_RDF_TYPE_SERVICE
case|:
case|case
name|LDNS_RDF_TYPE_LOC
case|:
case|case
name|LDNS_RDF_TYPE_WKS
case|:
case|case
name|LDNS_RDF_TYPE_NSAP
case|:
case|case
name|LDNS_RDF_TYPE_ATMA
case|:
case|case
name|LDNS_RDF_TYPE_IPSECKEY
case|:
case|case
name|LDNS_RDF_TYPE_LONG_STR
case|:
case|case
name|LDNS_RDF_TYPE_NONE
case|:
comment|/* 			 * Read to end of rr rdata 			 */
name|cur_rdf_length
operator|=
name|end
operator|-
operator|*
name|pos
expr_stmt|;
break|break;
block|}
comment|/* fixed length rdata */
if|if
condition|(
name|cur_rdf_length
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|cur_rdf_length
operator|+
operator|*
name|pos
operator|>
name|end
condition|)
block|{
return|return
name|LDNS_STATUS_PACKET_OVERFLOW
return|;
block|}
name|data
operator|=
name|LDNS_XMALLOC
argument_list|(
name|uint8_t
argument_list|,
name|rd_length
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|data
condition|)
block|{
return|return
name|LDNS_STATUS_MEM_ERR
return|;
block|}
name|memcpy
argument_list|(
name|data
argument_list|,
operator|&
name|wire
index|[
operator|*
name|pos
index|]
argument_list|,
name|cur_rdf_length
argument_list|)
expr_stmt|;
name|cur_rdf
operator|=
name|ldns_rdf_new
argument_list|(
name|cur_rdf_type
argument_list|,
name|cur_rdf_length
argument_list|,
name|data
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|=
operator|*
name|pos
operator|+
name|cur_rdf_length
expr_stmt|;
block|}
if|if
condition|(
name|cur_rdf
condition|)
block|{
name|ldns_rr_push_rdf
argument_list|(
name|rr
argument_list|,
name|cur_rdf
argument_list|)
expr_stmt|;
name|cur_rdf
operator|=
name|NULL
expr_stmt|;
block|}
name|rdf_index
operator|++
expr_stmt|;
block|}
comment|/* while (rdf_index< ldns_rr_descriptor_maximum(descriptor)) */
return|return
name|LDNS_STATUS_OK
return|;
block|}
end_function

begin_comment
comment|/* TODO:          can *pos be incremented at READ_INT? or maybe use something like          RR_CLASS(wire)? 	 uhhm Jelte?? */
end_comment

begin_function
name|ldns_status
name|ldns_wire2rr
parameter_list|(
name|ldns_rr
modifier|*
modifier|*
name|rr_p
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|wire
parameter_list|,
name|size_t
name|max
parameter_list|,
name|size_t
modifier|*
name|pos
parameter_list|,
name|ldns_pkt_section
name|section
parameter_list|)
block|{
name|ldns_rdf
modifier|*
name|owner
init|=
name|NULL
decl_stmt|;
name|ldns_rr
modifier|*
name|rr
init|=
name|ldns_rr_new
argument_list|()
decl_stmt|;
name|ldns_status
name|status
decl_stmt|;
name|status
operator|=
name|ldns_wire2dname
argument_list|(
operator|&
name|owner
argument_list|,
name|wire
argument_list|,
name|max
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|LDNS_STATUS_CHECK_GOTO
argument_list|(
name|status
argument_list|,
name|status_error
argument_list|)
expr_stmt|;
name|ldns_rr_set_owner
argument_list|(
name|rr
argument_list|,
name|owner
argument_list|)
expr_stmt|;
if|if
condition|(
operator|*
name|pos
operator|+
literal|4
operator|>
name|max
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_PACKET_OVERFLOW
expr_stmt|;
goto|goto
name|status_error
goto|;
block|}
name|ldns_rr_set_type
argument_list|(
name|rr
argument_list|,
name|ldns_read_uint16
argument_list|(
operator|&
name|wire
index|[
operator|*
name|pos
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|=
operator|*
name|pos
operator|+
literal|2
expr_stmt|;
name|ldns_rr_set_class
argument_list|(
name|rr
argument_list|,
name|ldns_read_uint16
argument_list|(
operator|&
name|wire
index|[
operator|*
name|pos
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|=
operator|*
name|pos
operator|+
literal|2
expr_stmt|;
if|if
condition|(
name|section
operator|!=
name|LDNS_SECTION_QUESTION
condition|)
block|{
if|if
condition|(
operator|*
name|pos
operator|+
literal|4
operator|>
name|max
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_PACKET_OVERFLOW
expr_stmt|;
goto|goto
name|status_error
goto|;
block|}
name|ldns_rr_set_ttl
argument_list|(
name|rr
argument_list|,
name|ldns_read_uint32
argument_list|(
operator|&
name|wire
index|[
operator|*
name|pos
index|]
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|=
operator|*
name|pos
operator|+
literal|4
expr_stmt|;
name|status
operator|=
name|ldns_wire2rdf
argument_list|(
name|rr
argument_list|,
name|wire
argument_list|,
name|max
argument_list|,
name|pos
argument_list|)
expr_stmt|;
name|LDNS_STATUS_CHECK_GOTO
argument_list|(
name|status
argument_list|,
name|status_error
argument_list|)
expr_stmt|;
name|ldns_rr_set_question
argument_list|(
name|rr
argument_list|,
name|false
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|ldns_rr_set_question
argument_list|(
name|rr
argument_list|,
name|true
argument_list|)
expr_stmt|;
block|}
operator|*
name|rr_p
operator|=
name|rr
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
name|status_error
label|:
name|ldns_rr_free
argument_list|(
name|rr
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

begin_function
specifier|static
name|ldns_status
name|ldns_wire2pkt_hdr
parameter_list|(
name|ldns_pkt
modifier|*
name|packet
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|wire
parameter_list|,
name|size_t
name|max
parameter_list|,
name|size_t
modifier|*
name|pos
parameter_list|)
block|{
if|if
condition|(
operator|*
name|pos
operator|+
name|LDNS_HEADER_SIZE
operator|>
name|max
condition|)
block|{
return|return
name|LDNS_STATUS_WIRE_INCOMPLETE_HEADER
return|;
block|}
else|else
block|{
name|ldns_pkt_set_id
argument_list|(
name|packet
argument_list|,
name|LDNS_ID_WIRE
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_qr
argument_list|(
name|packet
argument_list|,
name|LDNS_QR_WIRE
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_opcode
argument_list|(
name|packet
argument_list|,
name|LDNS_OPCODE_WIRE
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_aa
argument_list|(
name|packet
argument_list|,
name|LDNS_AA_WIRE
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_tc
argument_list|(
name|packet
argument_list|,
name|LDNS_TC_WIRE
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_rd
argument_list|(
name|packet
argument_list|,
name|LDNS_RD_WIRE
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_ra
argument_list|(
name|packet
argument_list|,
name|LDNS_RA_WIRE
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_ad
argument_list|(
name|packet
argument_list|,
name|LDNS_AD_WIRE
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_cd
argument_list|(
name|packet
argument_list|,
name|LDNS_CD_WIRE
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_rcode
argument_list|(
name|packet
argument_list|,
name|LDNS_RCODE_WIRE
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_qdcount
argument_list|(
name|packet
argument_list|,
name|LDNS_QDCOUNT
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_ancount
argument_list|(
name|packet
argument_list|,
name|LDNS_ANCOUNT
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_nscount
argument_list|(
name|packet
argument_list|,
name|LDNS_NSCOUNT
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_arcount
argument_list|(
name|packet
argument_list|,
name|LDNS_ARCOUNT
argument_list|(
name|wire
argument_list|)
argument_list|)
expr_stmt|;
operator|*
name|pos
operator|+=
name|LDNS_HEADER_SIZE
expr_stmt|;
return|return
name|LDNS_STATUS_OK
return|;
block|}
block|}
end_function

begin_function
name|ldns_status
name|ldns_buffer2pkt_wire
parameter_list|(
name|ldns_pkt
modifier|*
modifier|*
name|packet
parameter_list|,
name|ldns_buffer
modifier|*
name|buffer
parameter_list|)
block|{
comment|/* lazy */
return|return
name|ldns_wire2pkt
argument_list|(
name|packet
argument_list|,
name|ldns_buffer_begin
argument_list|(
name|buffer
argument_list|)
argument_list|,
name|ldns_buffer_limit
argument_list|(
name|buffer
argument_list|)
argument_list|)
return|;
block|}
end_function

begin_function
name|ldns_status
name|ldns_wire2pkt
parameter_list|(
name|ldns_pkt
modifier|*
modifier|*
name|packet_p
parameter_list|,
specifier|const
name|uint8_t
modifier|*
name|wire
parameter_list|,
name|size_t
name|max
parameter_list|)
block|{
name|size_t
name|pos
init|=
literal|0
decl_stmt|;
name|uint16_t
name|i
decl_stmt|;
name|ldns_rr
modifier|*
name|rr
decl_stmt|;
name|ldns_pkt
modifier|*
name|packet
init|=
name|ldns_pkt_new
argument_list|()
decl_stmt|;
name|ldns_status
name|status
init|=
name|LDNS_STATUS_OK
decl_stmt|;
name|int
name|have_edns
init|=
literal|0
decl_stmt|;
name|uint8_t
name|data
index|[
literal|4
index|]
decl_stmt|;
name|status
operator|=
name|ldns_wire2pkt_hdr
argument_list|(
name|packet
argument_list|,
name|wire
argument_list|,
name|max
argument_list|,
operator|&
name|pos
argument_list|)
expr_stmt|;
name|LDNS_STATUS_CHECK_GOTO
argument_list|(
name|status
argument_list|,
name|status_error
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_pkt_qdcount
argument_list|(
name|packet
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|ldns_wire2rr
argument_list|(
operator|&
name|rr
argument_list|,
name|wire
argument_list|,
name|max
argument_list|,
operator|&
name|pos
argument_list|,
name|LDNS_SECTION_QUESTION
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_PACKET_OVERFLOW
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_WIRE_INCOMPLETE_QUESTION
expr_stmt|;
block|}
name|LDNS_STATUS_CHECK_GOTO
argument_list|(
name|status
argument_list|,
name|status_error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ldns_rr_list_push_rr
argument_list|(
name|ldns_pkt_question
argument_list|(
name|packet
argument_list|)
argument_list|,
name|rr
argument_list|)
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|packet
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_INTERNAL_ERR
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_pkt_ancount
argument_list|(
name|packet
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|ldns_wire2rr
argument_list|(
operator|&
name|rr
argument_list|,
name|wire
argument_list|,
name|max
argument_list|,
operator|&
name|pos
argument_list|,
name|LDNS_SECTION_ANSWER
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_PACKET_OVERFLOW
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_WIRE_INCOMPLETE_ANSWER
expr_stmt|;
block|}
name|LDNS_STATUS_CHECK_GOTO
argument_list|(
name|status
argument_list|,
name|status_error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ldns_rr_list_push_rr
argument_list|(
name|ldns_pkt_answer
argument_list|(
name|packet
argument_list|)
argument_list|,
name|rr
argument_list|)
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|packet
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_INTERNAL_ERR
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_pkt_nscount
argument_list|(
name|packet
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|ldns_wire2rr
argument_list|(
operator|&
name|rr
argument_list|,
name|wire
argument_list|,
name|max
argument_list|,
operator|&
name|pos
argument_list|,
name|LDNS_SECTION_AUTHORITY
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_PACKET_OVERFLOW
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_WIRE_INCOMPLETE_AUTHORITY
expr_stmt|;
block|}
name|LDNS_STATUS_CHECK_GOTO
argument_list|(
name|status
argument_list|,
name|status_error
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ldns_rr_list_push_rr
argument_list|(
name|ldns_pkt_authority
argument_list|(
name|packet
argument_list|)
argument_list|,
name|rr
argument_list|)
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|packet
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_INTERNAL_ERR
return|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|ldns_pkt_arcount
argument_list|(
name|packet
argument_list|)
condition|;
name|i
operator|++
control|)
block|{
name|status
operator|=
name|ldns_wire2rr
argument_list|(
operator|&
name|rr
argument_list|,
name|wire
argument_list|,
name|max
argument_list|,
operator|&
name|pos
argument_list|,
name|LDNS_SECTION_ADDITIONAL
argument_list|)
expr_stmt|;
if|if
condition|(
name|status
operator|==
name|LDNS_STATUS_PACKET_OVERFLOW
condition|)
block|{
name|status
operator|=
name|LDNS_STATUS_WIRE_INCOMPLETE_ADDITIONAL
expr_stmt|;
block|}
name|LDNS_STATUS_CHECK_GOTO
argument_list|(
name|status
argument_list|,
name|status_error
argument_list|)
expr_stmt|;
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_OPT
condition|)
block|{
name|ldns_pkt_set_edns_udp_size
argument_list|(
name|packet
argument_list|,
name|ldns_rr_get_class
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_write_uint32
argument_list|(
name|data
argument_list|,
name|ldns_rr_ttl
argument_list|(
name|rr
argument_list|)
argument_list|)
expr_stmt|;
name|ldns_pkt_set_edns_extended_rcode
argument_list|(
name|packet
argument_list|,
name|data
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|ldns_pkt_set_edns_version
argument_list|(
name|packet
argument_list|,
name|data
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|ldns_pkt_set_edns_z
argument_list|(
name|packet
argument_list|,
name|ldns_read_uint16
argument_list|(
operator|&
name|data
index|[
literal|2
index|]
argument_list|)
argument_list|)
expr_stmt|;
comment|/* edns might not have rdfs */
if|if
condition|(
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
literal|0
argument_list|)
condition|)
block|{
name|ldns_pkt_set_edns_data
argument_list|(
name|packet
argument_list|,
name|ldns_rdf_clone
argument_list|(
name|ldns_rr_rdf
argument_list|(
name|rr
argument_list|,
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|ldns_rr_free
argument_list|(
name|rr
argument_list|)
expr_stmt|;
name|have_edns
operator|+=
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ldns_rr_get_type
argument_list|(
name|rr
argument_list|)
operator|==
name|LDNS_RR_TYPE_TSIG
condition|)
block|{
name|ldns_pkt_set_tsig
argument_list|(
name|packet
argument_list|,
name|rr
argument_list|)
expr_stmt|;
name|ldns_pkt_set_arcount
argument_list|(
name|packet
argument_list|,
name|ldns_pkt_arcount
argument_list|(
name|packet
argument_list|)
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|!
name|ldns_rr_list_push_rr
argument_list|(
name|ldns_pkt_additional
argument_list|(
name|packet
argument_list|)
argument_list|,
name|rr
argument_list|)
condition|)
block|{
name|ldns_pkt_free
argument_list|(
name|packet
argument_list|)
expr_stmt|;
return|return
name|LDNS_STATUS_INTERNAL_ERR
return|;
block|}
block|}
name|ldns_pkt_set_size
argument_list|(
name|packet
argument_list|,
name|max
argument_list|)
expr_stmt|;
if|if
condition|(
name|have_edns
condition|)
name|ldns_pkt_set_arcount
argument_list|(
name|packet
argument_list|,
name|ldns_pkt_arcount
argument_list|(
name|packet
argument_list|)
operator|-
name|have_edns
argument_list|)
expr_stmt|;
operator|*
name|packet_p
operator|=
name|packet
expr_stmt|;
return|return
name|status
return|;
name|status_error
label|:
name|ldns_pkt_free
argument_list|(
name|packet
argument_list|)
expr_stmt|;
return|return
name|status
return|;
block|}
end_function

end_unit


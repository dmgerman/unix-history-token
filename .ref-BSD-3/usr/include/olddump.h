begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_define
define|#
directive|define
name|MAXSIZE
value|500
end_define

begin_comment
comment|/* max size in blocks of dumped files */
end_comment

begin_define
define|#
directive|define
name|NILIST
value|100
end_define

begin_comment
comment|/* max files extracted at once */
end_comment

begin_define
define|#
directive|define
name|BFACT
value|20
end_define

begin_comment
comment|/* tape blocking factor */
end_comment

begin_expr_stmt
name|int
name|tden
literal|1600
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* tape density */
end_comment

begin_expr_stmt
name|int
name|tlen
literal|2200
expr_stmt|;
end_expr_stmt

begin_comment
comment|/* tape length (feet) */
end_comment

begin_decl_stmt
name|char
modifier|*
name|dump_cmd
index|[]
init|=
block|{
comment|/* default args for dump */
literal|"dump"
block|,
literal|"i"
block|,
literal|"/dev/rp0"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|rest_cmd
index|[]
init|=
block|{
comment|/* defaults for restor */
literal|"restor"
block|,
literal|"t"
block|,
literal|0
block|}
decl_stmt|;
end_decl_stmt

begin_expr_stmt
name|char
operator|*
name|tape
literal|"/dev/rmt1"
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|char
name|dfile
index|[]
literal|"/dev/dtab"
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|char
name|tfile
index|[]
literal|"/tmp/dtmp"
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
name|name
index|[
literal|100
index|]
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NDTAB
value|10
end_define

begin_struct
struct|struct
block|{
name|char
name|dt_name
index|[
literal|16
index|]
decl_stmt|;
name|time_t
name|dt_date
decl_stmt|;
block|}
name|dtab
index|[
name|NDTAB
index|]
struct|;
end_struct

begin_struct
struct|struct
name|thdr
block|{
name|ino_t
name|isize
decl_stmt|;
name|ino_t
name|maxi
decl_stmt|;
name|daddr_t
name|fsize
decl_stmt|;
name|time_t
name|cdate
decl_stmt|;
name|time_t
name|ddate
decl_stmt|;
name|long
name|tsize
decl_stmt|;
name|int
name|nflg
decl_stmt|;
block|}
struct|;
end_struct

begin_struct
struct|struct
name|fhdr
block|{
name|short
name|xmagic
decl_stmt|;
name|ino_t
name|xino
decl_stmt|;
name|short
name|xmode
decl_stmt|;
name|short
name|xnlink
decl_stmt|;
name|short
name|xuid
decl_stmt|;
name|short
name|xgid
decl_stmt|;
name|daddr_t
name|xaddr
decl_stmt|;
name|off_t
name|xsize
decl_stmt|;
name|time_t
name|xatime
decl_stmt|;
name|time_t
name|xmtime
decl_stmt|;
name|time_t
name|xctime
decl_stmt|;
block|}
struct|;
end_struct

begin_define
define|#
directive|define
name|FMAGIC
value|012345
end_define

begin_define
define|#
directive|define
name|SMAGIC
value|031415
end_define

begin_define
define|#
directive|define
name|DAPTB
value|127
end_define

begin_comment
comment|/* (BSIZE-2*sizeof(short))/sizeof(daddr_t)) */
end_comment

begin_decl_stmt
name|FILE
modifier|*
name|tmpf
decl_stmt|;
end_decl_stmt

begin_function
name|long
name|getsize
parameter_list|()
block|{
specifier|register
name|c
expr_stmt|;
name|long
name|j
decl_stmt|;
name|c
operator|=
name|getc
argument_list|(
name|tmpf
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
name|EOF
condition|)
return|return
operator|(
operator|(
name|long
operator|)
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|c
operator|<=
literal|253
condition|)
return|return
operator|(
operator|(
name|long
operator|)
name|c
operator|)
return|;
if|if
condition|(
name|c
operator|==
literal|255
condition|)
return|return
operator|(
operator|(
name|long
operator|)
operator|-
literal|1
operator|)
return|;
name|j
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|3
condition|;
name|c
operator|++
control|)
name|j
operator|=
operator|(
name|j
operator|<<
literal|8
operator|)
operator|+
operator|(
name|getc
argument_list|(
name|tmpf
argument_list|)
operator|&
literal|0377
operator|)
expr_stmt|;
return|return
operator|(
name|j
operator|)
return|;
block|}
end_function

begin_macro
name|putsize
argument_list|(
argument|s
argument_list|)
end_macro

begin_decl_stmt
name|long
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
name|s
operator|<=
literal|253
condition|)
block|{
name|putc
argument_list|(
operator|(
name|char
operator|)
name|s
argument_list|,
name|tmpf
argument_list|)
expr_stmt|;
return|return;
block|}
name|putc
argument_list|(
literal|254
argument_list|,
name|tmpf
argument_list|)
expr_stmt|;
name|putc
argument_list|(
call|(
name|char
call|)
argument_list|(
name|s
operator|>>
literal|16
argument_list|)
argument_list|,
name|tmpf
argument_list|)
expr_stmt|;
name|putc
argument_list|(
call|(
name|char
call|)
argument_list|(
name|s
operator|>>
literal|8
argument_list|)
argument_list|,
name|tmpf
argument_list|)
expr_stmt|;
name|putc
argument_list|(
operator|(
name|char
operator|)
name|s
argument_list|,
name|tmpf
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


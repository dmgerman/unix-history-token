begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|"defs.h"
end_include

begin_decl_stmt
name|struct
name|packet
modifier|*
name|xptr
decl_stmt|,
modifier|*
name|gptr
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|PACKETLENGTH
value|(datasize + sizeof *xptr - 1)
end_define

begin_define
define|#
directive|define
name|ACKLENGTH
value|(sizeof *xptr - 1)
end_define

begin_decl_stmt
specifier|static
name|int
name|bufleft
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|atime
init|=
name|ATIME
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|maxbread
init|=
name|MAXBREAD
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|datasize
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|savebuf
index|[
name|BUFSIZ
index|]
decl_stmt|,
name|retransmit
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|jmp_buf
name|env
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|short
name|masterseqno
decl_stmt|,
name|lastseqno
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|FILE
modifier|*
name|readtty
decl_stmt|,
modifier|*
name|writetty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|dumpstruc
name|dump
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*    one problem has been character loss on    overloaded systems due to the daemon    taking too long to swap in    and losing characters.    A high priority process of small size    with a pipe would do the job. */
end_comment

begin_macro
name|alarmint
argument_list|()
end_macro

begin_block
block|{
name|errno
operator|=
literal|100
expr_stmt|;
name|signal
argument_list|(
name|SIGCLK
argument_list|,
name|SIG_IGN
argument_list|)
expr_stmt|;
comment|/* alarm off */
name|longjmp
argument_list|(
name|env
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|/* ugh */
block|}
end_block

begin_comment
comment|/* returns number of bytes written, error returns WRITEFAIL (-3) */
end_comment

begin_macro
name|xwrite
argument_list|(
argument|inbuf
argument_list|,
argument|size
argument_list|,
argument|amt
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|inbuf
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|packet
modifier|*
name|rpp
decl_stmt|;
name|int
name|cnt
decl_stmt|,
name|num
decl_stmt|,
name|savetime
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|b
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|;
if|if
condition|(
name|xptr
operator|==
name|NULL
condition|)
name|xptr
operator|=
operator|(
expr|struct
name|packet
operator|*
operator|)
name|calloc
argument_list|(
operator|(
name|PACKETLENGTH
operator|+
literal|20
operator|)
operator|/
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|xptr
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"xptr NULL"
argument_list|)
expr_stmt|;
return|return
operator|(
name|WRITEFAIL
operator|)
return|;
block|}
name|amt
operator|=
name|amt
operator|*
name|size
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
name|retransmit
operator|=
literal|0
expr_stmt|;
name|savetime
operator|=
name|atime
expr_stmt|;
while|while
condition|(
name|amt
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|retransmit
operator|>
name|maxbread
condition|)
block|{
name|debug
argument_list|(
literal|"xwrite fail"
argument_list|)
expr_stmt|;
return|return
operator|(
name|WRITEFAIL
operator|)
return|;
block|}
name|b
operator|=
name|inbuf
operator|+
name|cnt
expr_stmt|;
name|num
operator|=
name|min
argument_list|(
name|datasize
argument_list|,
name|amt
argument_list|)
expr_stmt|;
name|xptr
operator|->
name|pcode
operator|=
name|REQUEST
expr_stmt|;
name|xptr
operator|->
name|seqno
operator|=
name|masterseqno
expr_stmt|;
name|xptr
operator|->
name|len
operator|=
name|num
expr_stmt|;
name|p
operator|=
name|xptr
operator|->
name|data
expr_stmt|;
name|i
operator|=
name|num
expr_stmt|;
while|while
condition|(
name|i
operator|--
condition|)
operator|*
name|p
operator|++
operator|=
operator|*
name|b
operator|++
expr_stmt|;
name|sendpacket
argument_list|(
name|xptr
argument_list|)
expr_stmt|;
name|rpp
operator|=
name|getpacket
argument_list|()
expr_stmt|;
if|if
condition|(
name|rpp
operator|==
name|NULL
condition|)
block|{
name|atime
operator|+=
literal|3
expr_stmt|;
comment|/* wait three more secs */
name|retransmit
operator|++
expr_stmt|;
name|dump
operator|.
name|nretrans
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|rpp
operator|->
name|chksum
operator|!=
literal|0
operator|||
name|rpp
operator|->
name|pcode
operator|!=
name|ACK
operator|||
name|rpp
operator|->
name|seqno
operator|!=
name|xptr
operator|->
name|seqno
condition|)
block|{
if|if
condition|(
name|rpp
operator|->
name|pcode
operator|==
name|RESET
condition|)
block|{
name|error
argument_list|(
literal|"reset"
argument_list|)
expr_stmt|;
return|return
operator|(
name|WRITEFAIL
operator|)
return|;
block|}
if|if
condition|(
name|rpp
operator|->
name|seqno
operator|==
literal|1
operator|&&
name|rpp
operator|->
name|pcode
operator|==
name|REQUEST
condition|)
block|{
name|error
argument_list|(
literal|"collision"
argument_list|)
expr_stmt|;
return|return
operator|(
name|WRITEFAIL
operator|)
return|;
block|}
if|if
condition|(
name|rpp
operator|->
name|chksum
operator|!=
literal|0
condition|)
name|error
argument_list|(
literal|"chksum %d"
argument_list|,
name|rpp
operator|->
name|seqno
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rpp
operator|->
name|pcode
operator|!=
name|ACK
condition|)
name|error
argument_list|(
literal|"not ack %d %d"
argument_list|,
name|rpp
operator|->
name|pcode
argument_list|,
name|rpp
operator|->
name|seqno
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|rpp
operator|->
name|seqno
operator|!=
name|xptr
operator|->
name|seqno
condition|)
name|error
argument_list|(
literal|"WRSQNO got %d request %d"
argument_list|,
name|rpp
operator|->
name|seqno
argument_list|,
name|xptr
operator|->
name|seqno
argument_list|)
expr_stmt|;
name|atime
operator|+=
literal|3
expr_stmt|;
name|retransmit
operator|++
expr_stmt|;
name|dump
operator|.
name|nretrans
operator|++
expr_stmt|;
continue|continue;
block|}
name|masterseqno
operator|++
expr_stmt|;
name|amt
operator|-=
name|num
expr_stmt|;
name|retransmit
operator|=
literal|0
expr_stmt|;
name|cnt
operator|+=
name|num
expr_stmt|;
block|}
name|atime
operator|=
name|savetime
expr_stmt|;
return|return
operator|(
name|cnt
operator|/
name|size
operator|)
return|;
block|}
end_block

begin_comment
comment|/* return the number of bytes read, or error = BROKENREAD (-2) */
end_comment

begin_expr_stmt
name|nread
argument_list|(
name|b
argument_list|,
name|size
argument_list|,
name|num
argument_list|)
specifier|register
name|char
operator|*
name|b
expr_stmt|;
end_expr_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
name|int
name|bcnt
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|q
decl_stmt|;
specifier|register
name|struct
name|packet
modifier|*
name|pp
decl_stmt|;
name|int
name|n
decl_stmt|,
name|j
decl_stmt|,
name|cnt
decl_stmt|;
name|num
operator|=
name|num
operator|*
name|size
expr_stmt|;
name|cnt
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|bufleft
operator|>
literal|0
condition|)
block|{
name|p
operator|=
name|savebuf
expr_stmt|;
name|cnt
operator|=
name|n
operator|=
name|min
argument_list|(
name|bufleft
argument_list|,
name|num
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
operator|*
name|b
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
name|num
operator|-=
name|cnt
expr_stmt|;
name|bufleft
operator|-=
name|cnt
expr_stmt|;
if|if
condition|(
name|bufleft
operator|>
literal|0
condition|)
block|{
name|q
operator|=
name|savebuf
expr_stmt|;
name|n
operator|=
name|bufleft
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
operator|*
name|q
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
block|}
block|}
if|if
condition|(
name|num
operator|<=
literal|0
condition|)
return|return
operator|(
name|cnt
operator|/
name|size
operator|)
return|;
name|retransmit
operator|=
literal|0
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
name|pp
operator|=
name|getpacket
argument_list|()
expr_stmt|;
if|if
condition|(
name|pp
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|++
name|bcnt
operator|>=
name|maxbread
condition|)
block|{
name|debug
argument_list|(
literal|"read timeout"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BROKENREAD
operator|)
return|;
block|}
continue|continue;
block|}
if|if
condition|(
name|pp
operator|->
name|chksum
operator|!=
literal|0
condition|)
block|{
name|error
argument_list|(
literal|"chksum %d"
argument_list|,
name|pp
operator|->
name|seqno
argument_list|)
expr_stmt|;
name|retransmit
operator|++
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|pp
operator|->
name|pcode
operator|&
operator|~
operator|(
name|REQUEST
operator||
name|RESET
operator|)
condition|)
block|{
name|error
argument_list|(
literal|"pcode %d %d"
argument_list|,
name|pp
operator|->
name|pcode
argument_list|,
name|pp
operator|->
name|seqno
argument_list|)
expr_stmt|;
name|retransmit
operator|++
expr_stmt|;
continue|continue;
block|}
elseif|else
if|if
condition|(
name|pp
operator|->
name|pcode
operator|==
name|RESET
condition|)
break|break;
else|else
block|{
comment|/* else was a REQUEST packet, no chksum errs */
name|pp
operator|->
name|pcode
operator|=
name|ACK
expr_stmt|;
name|n
operator|=
name|pp
operator|->
name|len
expr_stmt|;
name|pp
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|sendpacket
argument_list|(
name|pp
argument_list|)
expr_stmt|;
comment|/* send ACK */
name|pp
operator|->
name|len
operator|=
name|n
expr_stmt|;
break|break;
block|}
block|}
name|retransmit
operator|=
literal|0
expr_stmt|;
name|j
operator|=
name|n
operator|=
name|min
argument_list|(
name|num
argument_list|,
name|pp
operator|->
name|len
argument_list|)
expr_stmt|;
name|cnt
operator|+=
name|j
expr_stmt|;
name|p
operator|=
name|pp
operator|->
name|data
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
operator|*
name|b
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|pp
operator|->
name|len
operator|>
name|num
condition|)
block|{
name|n
operator|=
name|bufleft
operator|=
name|pp
operator|->
name|len
operator|-
name|num
expr_stmt|;
name|q
operator|=
name|savebuf
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
operator|*
name|q
operator|++
operator|=
operator|*
name|p
operator|++
expr_stmt|;
block|}
return|return
operator|(
name|cnt
operator|/
name|size
operator|)
return|;
block|}
end_block

begin_macro
name|printpacket
argument_list|(
argument|pp
argument_list|,
argument|dest
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|dest
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|packet
modifier|*
name|pp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|i
decl_stmt|;
name|char
name|c
decl_stmt|;
name|dest
index|[
literal|0
index|]
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|pp
operator|==
name|NULL
condition|)
return|return;
if|if
condition|(
name|pp
operator|->
name|pcode
operator|==
name|REQUEST
condition|)
name|c
operator|=
literal|'r'
expr_stmt|;
elseif|else
if|if
condition|(
name|pp
operator|->
name|pcode
operator|==
name|ACK
condition|)
name|c
operator|=
literal|'a'
expr_stmt|;
elseif|else
if|if
condition|(
name|pp
operator|->
name|pcode
operator|==
name|RESET
condition|)
name|c
operator|=
literal|'x'
expr_stmt|;
elseif|else
if|if
condition|(
name|pp
operator|->
name|pcode
operator|==
name|PURGE
condition|)
name|c
operator|=
literal|'p'
expr_stmt|;
else|else
name|c
operator|=
literal|'u'
expr_stmt|;
name|sprintf
argument_list|(
name|dest
argument_list|,
literal|"p:%d len:%d c:%c d:"
argument_list|,
name|pp
operator|->
name|seqno
argument_list|,
name|pp
operator|->
name|len
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|s
operator|=
name|dest
operator|+
name|strlen
argument_list|(
name|dest
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|pp
operator|->
name|len
operator|&&
name|pp
operator|->
name|data
index|[
name|i
index|]
condition|;
name|i
operator|++
control|)
operator|*
name|s
operator|++
operator|=
name|pp
operator|->
name|data
index|[
name|i
index|]
expr_stmt|;
operator|*
name|s
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * A purge can always be sent -  * the receiver totally ignores it.  * It is used to push the packet terminator  * down the wire in case of a crash  * leaving the receiver half reading.  */
end_comment

begin_macro
name|sendpurge
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|xptr
operator|==
name|NULL
condition|)
name|xptr
operator|=
operator|(
expr|struct
name|packet
operator|*
operator|)
name|calloc
argument_list|(
operator|(
name|PACKETLENGTH
operator|+
literal|20
operator|)
operator|/
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|xptr
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"bad xptr"
argument_list|)
expr_stmt|;
return|return;
block|}
name|xptr
operator|->
name|pcode
operator|=
name|PURGE
expr_stmt|;
name|xptr
operator|->
name|seqno
operator|=
literal|0
expr_stmt|;
name|xptr
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|debug
argument_list|(
literal|"send purge"
argument_list|)
expr_stmt|;
name|sendpacket
argument_list|(
name|xptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * A reset is sent by the sender whenever he begins to send.  * It is not acknowledged.  * The receiver must be prepared, when he receives a reset,  * to receive a new transmission.  */
end_comment

begin_macro
name|sendreset
argument_list|()
end_macro

begin_block
block|{
if|if
condition|(
name|xptr
operator|==
name|NULL
condition|)
name|xptr
operator|=
operator|(
expr|struct
name|packet
operator|*
operator|)
name|calloc
argument_list|(
operator|(
name|PACKETLENGTH
operator|+
literal|20
operator|)
operator|/
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|xptr
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"bad xptr"
argument_list|)
expr_stmt|;
return|return;
block|}
name|xptr
operator|->
name|pcode
operator|=
name|RESET
expr_stmt|;
name|xptr
operator|->
name|seqno
operator|=
literal|0
expr_stmt|;
name|xptr
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|debug
argument_list|(
literal|"send reset"
argument_list|)
expr_stmt|;
name|sendpacket
argument_list|(
name|xptr
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  * Getreset returns in either of two cases:  * 1) the read times out (return BROKENREAD)  * 2) a reset packet is received (return 0)  * all other packets received are ignored.  */
end_comment

begin_macro
name|getreset
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|struct
name|packet
modifier|*
name|pp
decl_stmt|;
specifier|register
name|int
name|bcnt
init|=
literal|0
decl_stmt|;
name|bufleft
operator|=
literal|0
expr_stmt|;
comment|/* if any chars are left in buffer, flush them*/
name|atime
operator|=
name|ATIME
operator|+
operator|(
operator|(
name|rand
argument_list|()
operator|>>
literal|8
operator|)
operator|%
literal|15
operator|)
expr_stmt|;
name|lastseqno
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* forces non-RESET pks to not be ACK-ed */
for|for
control|(
init|;
condition|;
control|)
block|{
name|pp
operator|=
name|getpacket
argument_list|()
expr_stmt|;
if|if
condition|(
name|pp
operator|==
name|NULL
condition|)
block|{
if|if
condition|(
operator|++
name|bcnt
operator|>=
name|maxbread
condition|)
block|{
name|debug
argument_list|(
literal|"reset timeout"
argument_list|)
expr_stmt|;
return|return
operator|(
name|BROKENREAD
operator|)
return|;
block|}
continue|continue;
block|}
if|if
condition|(
name|pp
operator|->
name|pcode
operator|==
name|RESET
condition|)
block|{
name|debug
argument_list|(
literal|"got reset"
argument_list|)
expr_stmt|;
name|addtolog
argument_list|(
name|remote
argument_list|,
literal|"^R%c "
argument_list|,
name|remote
argument_list|)
expr_stmt|;
name|lastseqno
operator|=
literal|0
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
block|}
block|}
end_block

begin_comment
comment|/*  *	Just sends packet pp  *	Calculates the chksum  */
end_comment

begin_macro
name|sendpacket
argument_list|(
argument|pp
argument_list|)
end_macro

begin_decl_stmt
name|struct
name|packet
modifier|*
name|pp
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|len
decl_stmt|,
name|n
decl_stmt|,
name|i
decl_stmt|;
name|long
name|nt
decl_stmt|,
name|ot
decl_stmt|;
specifier|register
name|char
modifier|*
name|q
decl_stmt|,
modifier|*
name|p
decl_stmt|;
specifier|register
name|int
name|j
decl_stmt|;
name|dump
operator|.
name|nbytesent
operator|+=
name|pp
operator|->
name|len
expr_stmt|;
name|dump
operator|.
name|npacksent
operator|++
expr_stmt|;
name|pp
operator|->
name|chksum
operator|=
literal|0
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|pp
expr_stmt|;
name|len
operator|=
name|ACKLENGTH
operator|+
name|pp
operator|->
name|len
expr_stmt|;
for|for
control|(
name|j
operator|=
literal|0
init|;
name|j
operator|<
name|len
condition|;
name|j
operator|++
control|)
name|n
operator|^=
operator|*
name|p
operator|++
expr_stmt|;
name|pp
operator|->
name|chksum
operator|=
name|n
expr_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
name|q
operator|=
operator|(
name|char
operator|*
operator|)
name|pp
expr_stmt|;
name|len
operator|=
name|n
operator|=
operator|(
name|len
operator|+
literal|2
operator|)
operator|/
literal|3
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
operator|*
name|p
operator|++
operator|=
operator|(
operator|*
name|q
operator|&
literal|077
operator|)
operator|+
name|INCR
expr_stmt|;
name|j
operator|=
operator|(
operator|*
name|q
operator|++
operator|>>
literal|6
operator|)
operator|&
literal|03
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
operator|(
operator|(
operator|*
name|q
operator|<<
literal|2
operator|)
operator||
name|j
operator|)
operator|&
literal|077
operator|)
operator|+
name|INCR
expr_stmt|;
name|j
operator|=
operator|(
operator|*
name|q
operator|++
operator|>>
literal|4
operator|)
operator|&
literal|017
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
operator|(
operator|(
operator|*
name|q
operator|<<
literal|4
operator|)
operator||
name|j
operator|)
operator|&
literal|077
operator|)
operator|+
name|INCR
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|(
operator|(
operator|*
name|q
operator|++
operator|>>
literal|2
operator|)
operator|&
literal|077
operator|)
operator|+
name|INCR
expr_stmt|;
block|}
operator|*
name|p
operator|++
operator|=
literal|'\n'
expr_stmt|;
operator|*
name|p
operator|=
literal|0
expr_stmt|;
comment|/*	because of bugs in processing around erase and kill in v6 */
for|for
control|(
name|p
operator|=
name|buf
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
if|if
condition|(
operator|*
name|p
operator|==
literal|'\\'
condition|)
operator|*
name|p
operator|=
literal|'}'
expr_stmt|;
comment|/* 	debug("send %d %s",len*4+1,buf); 	*/
name|ot
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|i
operator|=
name|fwrite
argument_list|(
name|buf
argument_list|,
literal|1
argument_list|,
name|len
operator|*
literal|4
operator|+
literal|1
argument_list|,
name|writetty
argument_list|)
expr_stmt|;
name|nt
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|dump
operator|.
name|waittime
operator|+=
operator|(
name|nt
operator|-
name|ot
operator|)
expr_stmt|;
comment|/* add time writing */
comment|/* 	debug("count %d",i); 	*/
name|fflush
argument_list|(
name|writetty
argument_list|)
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *	returns NULL if couldn't get a packet with correct seqno  *	chksum not checked here  * 	because other programs may want to interrogate checksum  */
end_comment

begin_function
name|struct
name|packet
modifier|*
name|getpacket
parameter_list|()
block|{
name|char
name|buf
index|[
name|BUFSIZ
index|]
decl_stmt|;
name|int
name|i
decl_stmt|,
name|n
decl_stmt|,
name|j
decl_stmt|,
name|len
decl_stmt|,
name|plen
decl_stmt|;
name|int
name|bcnt
decl_stmt|;
specifier|register
name|char
modifier|*
name|q
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|long
name|ot
decl_stmt|,
name|nt
decl_stmt|;
if|if
condition|(
name|gptr
operator|==
name|NULL
condition|)
name|gptr
operator|=
operator|(
expr|struct
name|packet
operator|*
operator|)
name|calloc
argument_list|(
operator|(
name|PACKETLENGTH
operator|+
literal|20
operator|)
operator|/
literal|4
argument_list|,
literal|4
argument_list|)
expr_stmt|;
if|if
condition|(
name|gptr
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"gptr NULL"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|bcnt
operator|=
literal|0
expr_stmt|;
name|errno
operator|=
literal|0
expr_stmt|;
name|setjmp
argument_list|(
name|env
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|signal
argument_list|(
name|SIGCLK
argument_list|,
name|alarmint
argument_list|)
expr_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|bcnt
operator|++
operator|>
name|maxbread
condition|)
name|errno
operator|=
literal|100
expr_stmt|;
comment|/* give up */
if|if
condition|(
name|errno
operator|==
literal|100
condition|)
block|{
if|if
condition|(
name|debugflg
condition|)
name|putchar
argument_list|(
literal|'^'
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|alarm
argument_list|(
name|atime
argument_list|)
expr_stmt|;
name|ot
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|p
operator|=
name|fgets
argument_list|(
name|buf
argument_list|,
name|BUFSIZ
argument_list|,
name|readtty
argument_list|)
expr_stmt|;
name|alarm
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|nt
operator|=
name|gettime
argument_list|()
expr_stmt|;
name|dump
operator|.
name|waittime
operator|+=
operator|(
name|nt
operator|-
name|ot
operator|)
expr_stmt|;
if|if
condition|(
name|p
operator|==
name|NULL
condition|)
block|{
name|error
argument_list|(
literal|"getpacket fails"
argument_list|)
expr_stmt|;
return|return
operator|(
name|NULL
operator|)
return|;
block|}
name|plen
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
comment|/* 		debug("receive %d %s",plen,buf); 		*/
comment|/* remove this loop later */
for|for
control|(
name|p
operator|=
name|buf
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
if|if
condition|(
operator|*
name|p
operator|==
literal|'}'
condition|)
operator|*
name|p
operator|=
literal|'\\'
expr_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
name|q
operator|=
operator|(
name|char
operator|*
operator|)
name|gptr
expr_stmt|;
name|n
operator|=
operator|(
name|strlen
argument_list|(
name|buf
argument_list|)
operator|+
literal|3
operator|)
operator|/
literal|4
expr_stmt|;
while|while
condition|(
name|n
operator|--
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|==
literal|'\n'
condition|)
break|break;
if|if
condition|(
operator|*
name|p
operator|<
name|INCR
operator|||
operator|*
name|p
operator|&
literal|0200
condition|)
name|error
argument_list|(
literal|"bad char %o\n"
argument_list|,
operator|*
name|p
argument_list|)
expr_stmt|;
name|i
operator|=
operator|*
name|p
operator|++
operator|-
name|INCR
expr_stmt|;
name|j
operator|=
operator|*
name|p
operator|++
operator|-
name|INCR
expr_stmt|;
operator|*
name|q
operator|++
operator|=
operator|(
operator|(
name|j
operator|&
literal|03
operator|)
operator|<<
literal|6
operator|)
operator||
operator|(
name|i
operator|&
literal|077
operator|)
expr_stmt|;
name|i
operator|=
operator|*
name|p
operator|++
operator|-
name|INCR
expr_stmt|;
operator|*
name|q
operator|++
operator|=
operator|(
operator|(
name|i
operator|&
literal|017
operator|)
operator|<<
literal|4
operator|)
operator||
operator|(
operator|(
name|j
operator|>>
literal|2
operator|)
operator|&
literal|017
operator|)
expr_stmt|;
name|j
operator|=
operator|*
name|p
operator|++
operator|-
name|INCR
expr_stmt|;
operator|*
name|q
operator|++
operator|=
operator|(
operator|(
name|j
operator|&
literal|077
operator|)
operator|<<
literal|2
operator|)
operator||
operator|(
operator|(
name|i
operator|>>
literal|4
operator|)
operator|&
literal|03
operator|)
expr_stmt|;
block|}
operator|*
name|q
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|plen
operator|!=
operator|(
operator|(
name|ACKLENGTH
operator|+
name|gptr
operator|->
name|len
operator|+
literal|2
operator|)
operator|/
literal|3
operator|)
operator|*
literal|4
operator|+
literal|1
condition|)
block|{
name|error
argument_list|(
literal|"too short %d"
argument_list|,
name|gptr
operator|->
name|seqno
argument_list|)
expr_stmt|;
continue|continue;
block|}
if|if
condition|(
name|gptr
operator|->
name|pcode
operator|==
name|PURGE
condition|)
block|{
name|debug
argument_list|(
literal|"got purge"
argument_list|)
expr_stmt|;
continue|continue;
comment|/* never seen */
block|}
if|if
condition|(
name|gptr
operator|->
name|pcode
operator|==
name|RESET
condition|)
break|break;
if|if
condition|(
name|gptr
operator|->
name|seqno
operator|==
name|lastseqno
condition|)
block|{
if|if
condition|(
name|retransmit
condition|)
break|break;
comment|/* send ACK - it was lost first time thru */
name|len
operator|=
name|gptr
operator|->
name|len
expr_stmt|;
name|n
operator|=
name|gptr
operator|->
name|pcode
expr_stmt|;
name|gptr
operator|->
name|len
operator|=
literal|0
expr_stmt|;
name|gptr
operator|->
name|pcode
operator|=
name|ACK
expr_stmt|;
name|sendpacket
argument_list|(
name|gptr
argument_list|)
expr_stmt|;
name|gptr
operator|->
name|len
operator|=
name|len
expr_stmt|;
name|gptr
operator|->
name|pcode
operator|=
name|n
expr_stmt|;
name|error
argument_list|(
literal|"sendlostack %d"
argument_list|,
name|lastseqno
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|gptr
operator|->
name|seqno
operator|==
name|lastseqno
operator|+
literal|1
condition|)
break|break;
name|error
argument_list|(
literal|"Wrong seq no g: %d last: %d"
argument_list|,
name|gptr
operator|->
name|seqno
argument_list|,
name|lastseqno
argument_list|)
expr_stmt|;
block|}
name|lastseqno
operator|=
name|gptr
operator|->
name|seqno
expr_stmt|;
name|n
operator|=
literal|0
expr_stmt|;
name|len
operator|=
name|gptr
operator|->
name|len
operator|+
name|ACKLENGTH
expr_stmt|;
name|p
operator|=
operator|(
name|char
operator|*
operator|)
name|gptr
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|len
condition|;
name|i
operator|++
control|)
name|n
operator|^=
operator|*
name|p
operator|++
expr_stmt|;
name|gptr
operator|->
name|chksum
operator|=
name|n
expr_stmt|;
if|if
condition|(
name|n
operator|!=
literal|0
condition|)
name|dump
operator|.
name|ncksum
operator|++
expr_stmt|;
name|dump
operator|.
name|nbytercv
operator|+=
name|gptr
operator|->
name|len
expr_stmt|;
name|dump
operator|.
name|npackrcv
operator|++
expr_stmt|;
return|return
operator|(
name|gptr
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|<sys/filsys.h>
end_include

begin_include
include|#
directive|include
file|<sys/ino.h>
end_include

begin_include
include|#
directive|include
file|<sys/inode.h>
end_include

begin_define
define|#
directive|define
name|N
value|6
end_define

begin_decl_stmt
name|struct
name|filsys
name|filsys
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|counts
index|[
literal|10000
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|blocks
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|totsz
index|[
name|N
operator|+
literal|1
index|]
init|=
block|{
literal|1
block|,
literal|512
block|,
literal|1024
block|,
literal|2048
block|,
literal|4096
block|,
literal|1024
block|,
literal|512
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|indsz
index|[
name|N
operator|+
literal|1
index|]
init|=
block|{
literal|0
block|,
literal|512
operator|*
literal|512
operator|/
literal|4
block|,
literal|1024
operator|*
literal|1024
operator|/
literal|4
block|,
literal|2048
operator|*
literal|2048
operator|/
literal|4
block|,
literal|4096
operator|*
literal|4096
operator|/
literal|4
block|,
literal|1024
operator|*
literal|1024
operator|/
literal|4
block|,
literal|512
operator|*
literal|512
operator|/
literal|4
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|cnt1
decl_stmt|,
name|cnt8
decl_stmt|,
name|cnt51
decl_stmt|,
name|cnt58
decl_stmt|;
end_decl_stmt

begin_function
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|char
name|inobuf
index|[
name|BSIZE
operator|*
literal|60
index|]
decl_stmt|;
name|ino_t
name|inum
decl_stmt|,
name|tino
decl_stmt|;
specifier|register
name|struct
name|dinode
modifier|*
name|dp
decl_stmt|;
name|int
name|nleft
decl_stmt|,
name|f
decl_stmt|;
name|int
name|tot
index|[
name|N
operator|+
literal|1
index|]
decl_stmt|;
name|argc
operator|--
operator|,
name|argv
operator|++
expr_stmt|;
if|if
condition|(
name|argc
operator|==
literal|0
condition|)
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"sizes filsys\n"
argument_list|)
operator|,
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|f
operator|=
name|open
argument_list|(
operator|*
name|argv
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|f
operator|<
literal|0
condition|)
name|perror
argument_list|(
operator|*
name|argv
argument_list|)
operator|,
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|f
argument_list|,
name|BSIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|read
argument_list|(
name|f
argument_list|,
operator|&
name|filsys
argument_list|,
sizeof|sizeof
argument_list|(
expr|struct
name|filsys
argument_list|)
argument_list|)
expr_stmt|;
name|lseek
argument_list|(
name|f
argument_list|,
literal|2
operator|*
name|BSIZE
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|tino
operator|=
operator|(
name|filsys
operator|.
name|s_isize
operator|-
literal|2
operator|)
operator|*
operator|(
name|BSIZE
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|dinode
argument_list|)
operator|)
operator|+
literal|1
expr_stmt|;
name|printf
argument_list|(
literal|"tino %d\n"
argument_list|,
name|tino
argument_list|)
expr_stmt|;
name|nleft
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|inum
operator|=
literal|1
init|;
name|inum
operator|<
name|tino
condition|;
name|inum
operator|++
control|)
block|{
if|if
condition|(
name|nleft
operator|==
literal|0
condition|)
block|{
name|read
argument_list|(
name|f
argument_list|,
name|inobuf
argument_list|,
sizeof|sizeof
argument_list|(
name|inobuf
argument_list|)
argument_list|)
expr_stmt|;
name|nleft
operator|=
operator|(
name|BSIZE
operator|*
literal|60
operator|)
operator|/
sizeof|sizeof
argument_list|(
expr|struct
name|dinode
argument_list|)
expr_stmt|;
name|dp
operator|=
operator|(
expr|struct
name|dinode
operator|*
operator|)
operator|&
name|inobuf
expr_stmt|;
block|}
else|else
block|{
operator|--
name|nleft
expr_stmt|;
name|dp
operator|++
expr_stmt|;
block|}
if|if
condition|(
name|dp
operator|->
name|di_mode
condition|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|blocks
operator|=
name|dp
operator|->
name|di_size
operator|/
literal|512
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|N
operator|-
literal|1
condition|;
name|i
operator|++
control|)
block|{
name|tot
index|[
name|i
index|]
operator|+=
operator|(
name|dp
operator|->
name|di_size
operator|+
name|totsz
index|[
name|i
index|]
operator|-
literal|1
operator|)
operator|/
name|totsz
index|[
name|i
index|]
expr_stmt|;
if|if
condition|(
name|i
operator|&&
name|dp
operator|->
name|di_size
operator|>
name|totsz
index|[
name|i
index|]
operator|*
literal|10
condition|)
name|tot
index|[
name|i
index|]
operator|+=
operator|(
name|dp
operator|->
name|di_size
operator|-
name|totsz
index|[
name|i
index|]
operator|*
literal|10
operator|+
name|indsz
index|[
name|i
index|]
operator|-
literal|1
operator|)
operator|/
name|indsz
index|[
name|i
index|]
expr_stmt|;
block|}
if|if
condition|(
name|dp
operator|->
name|di_size
operator|<
literal|24
operator|*
literal|1024
condition|)
block|{
name|tot
index|[
name|N
index|]
operator|+=
operator|(
name|dp
operator|->
name|di_size
operator|+
literal|511
operator|)
operator|/
literal|512
expr_stmt|;
name|cnt51
operator|+=
operator|(
name|dp
operator|->
name|di_size
operator|+
literal|511
operator|)
operator|/
literal|512
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|di_size
operator|>
name|totsz
index|[
name|i
index|]
operator|*
literal|8
condition|)
name|tot
index|[
name|N
index|]
operator|+=
operator|(
name|dp
operator|->
name|di_size
operator|-
name|totsz
index|[
name|N
index|]
operator|*
literal|8
operator|+
name|indsz
index|[
name|N
index|]
operator|-
literal|1
operator|)
operator|/
name|indsz
index|[
name|N
index|]
expr_stmt|;
block|}
else|else
block|{
name|tot
index|[
name|N
index|]
operator|+=
literal|8
operator|*
operator|(
operator|(
name|dp
operator|->
name|di_size
operator|+
literal|4095
operator|)
operator|/
literal|4096
operator|)
operator|+
operator|(
name|dp
operator|->
name|di_size
operator|-
name|totsz
index|[
name|N
index|]
operator|*
literal|8
operator|+
name|indsz
index|[
name|N
index|]
operator|-
literal|1
operator|)
operator|/
name|indsz
index|[
name|N
index|]
expr_stmt|;
name|cnt58
operator|+=
operator|(
operator|(
name|dp
operator|->
name|di_size
operator|+
literal|4095
operator|)
operator|/
literal|4096
operator|)
operator|*
literal|8
expr_stmt|;
name|cnt58
operator|-=
literal|6
expr_stmt|;
name|cnt51
operator|+=
literal|48
expr_stmt|;
block|}
if|if
condition|(
name|dp
operator|->
name|di_size
operator|<
literal|24
operator|*
literal|1024
condition|)
block|{
name|tot
index|[
name|N
operator|-
literal|1
index|]
operator|+=
operator|(
name|dp
operator|->
name|di_size
operator|+
literal|1023
operator|)
operator|/
literal|1024
expr_stmt|;
name|cnt1
operator|+=
operator|(
name|dp
operator|->
name|di_size
operator|+
literal|1023
operator|)
operator|/
literal|1024
expr_stmt|;
if|if
condition|(
name|dp
operator|->
name|di_size
operator|>
name|totsz
index|[
name|i
index|]
operator|*
literal|8
condition|)
name|tot
index|[
name|N
operator|-
literal|1
index|]
operator|+=
operator|(
name|dp
operator|->
name|di_size
operator|-
name|totsz
index|[
name|N
operator|-
literal|1
index|]
operator|*
literal|8
operator|+
name|indsz
index|[
name|N
operator|-
literal|1
index|]
operator|-
literal|1
operator|)
operator|/
name|indsz
index|[
name|N
operator|-
literal|1
index|]
expr_stmt|;
block|}
else|else
block|{
name|tot
index|[
name|N
operator|-
literal|1
index|]
operator|+=
literal|8
operator|*
operator|(
operator|(
name|dp
operator|->
name|di_size
operator|+
literal|8191
operator|)
operator|/
literal|8192
operator|)
operator|+
operator|(
name|dp
operator|->
name|di_size
operator|-
name|totsz
index|[
name|N
operator|-
literal|1
index|]
operator|*
literal|8
operator|+
name|indsz
index|[
name|N
operator|-
literal|1
index|]
operator|-
literal|1
operator|)
operator|/
name|indsz
index|[
name|N
operator|-
literal|1
index|]
expr_stmt|;
name|cnt8
operator|+=
operator|(
operator|(
name|dp
operator|->
name|di_size
operator|+
literal|8191
operator|)
operator|/
literal|8192
operator|)
operator|*
literal|8
expr_stmt|;
name|cnt8
operator|-=
literal|3
expr_stmt|;
name|cnt1
operator|+=
literal|24
expr_stmt|;
block|}
if|if
condition|(
name|blocks
operator|>=
literal|0
operator|&&
name|blocks
operator|<
literal|10000
condition|)
name|counts
index|[
name|blocks
index|]
operator|++
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"lost inum %d size %d\n"
argument_list|,
name|inum
argument_list|,
name|dp
operator|->
name|di_size
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|blocks
operator|=
literal|0
init|;
name|blocks
operator|<
literal|10000
condition|;
name|blocks
operator|++
control|)
if|if
condition|(
name|counts
index|[
name|blocks
index|]
condition|)
name|printf
argument_list|(
literal|"%d\t%d\n"
argument_list|,
name|blocks
argument_list|,
name|counts
index|[
name|blocks
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"size\tspace\t\tratio\tblocks\n"
argument_list|)
expr_stmt|;
for|for
control|(
name|blocks
operator|=
literal|0
init|;
name|blocks
operator|<
name|N
operator|+
literal|1
condition|;
name|blocks
operator|++
control|)
name|printf
argument_list|(
literal|"%d\t%d\t%7.4f\t%d\n"
argument_list|,
name|totsz
index|[
name|blocks
index|]
argument_list|,
name|tot
index|[
name|blocks
index|]
operator|*
name|totsz
index|[
name|blocks
index|]
argument_list|,
operator|(
operator|(
name|float
operator|)
name|tot
index|[
name|blocks
index|]
operator|)
operator|*
name|totsz
index|[
name|blocks
index|]
operator|/
operator|(
name|float
operator|)
name|tot
index|[
literal|0
index|]
argument_list|,
name|tot
index|[
name|blocks
index|]
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cnt1=%d, cnt8=%d\n"
argument_list|,
name|cnt1
argument_list|,
name|cnt8
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"cnt51=%d, cnt58=%d\n"
argument_list|,
name|cnt51
argument_list|,
name|cnt58
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


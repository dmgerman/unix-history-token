begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/*  *  * hist.c - history expansion  *  * This file is part of zsh, the Z shell.  *  * This software is Copyright 1992 by Paul Falstad  *  * Permission is hereby granted to copy, reproduce, redistribute or otherwise  * use this software as long as: there is no monetary profit gained  * specifically from the use or reproduction of this software, it is not  * sold, rented, traded or otherwise marketed, and this copyright notice is  * included prominently in any copy made.   *  * The author make no claims as to the fitness or correctness of this software  * for any use whatsoever, and it is provided as is. Any use of this software  * is at the user's own risk.   *  */
end_comment

begin_include
include|#
directive|include
file|"zsh.h"
end_include

begin_define
define|#
directive|define
name|HEAPSIZE
value|4096
end_define

begin_struct
struct|struct
name|hp
block|{
name|Hp
name|next
decl_stmt|;
name|char
modifier|*
name|pool
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|int
name|free
decl_stmt|,
name|histno
decl_stmt|;
block|}
struct|;
end_struct

begin_decl_stmt
specifier|static
name|Hp
name|hp_lit
decl_stmt|,
name|hp_lex
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|Histent
name|curhistent
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|lastc
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* add a character to the current history word */
end_comment

begin_function
name|void
name|hwaddc
parameter_list|(
name|c
parameter_list|)
comment|/**/
name|int
name|c
decl_stmt|;
block|{
if|if
condition|(
name|hlastw
operator|&&
name|hline
operator|&&
operator|(
operator|!
operator|(
name|errflag
operator|||
name|lexstop
operator|)
operator|||
name|c
operator|==
name|HISTSPACE
operator|)
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'!'
operator|&&
name|unset
argument_list|(
name|NOBANGHIST
argument_list|)
condition|)
name|hwaddc
argument_list|(
literal|'\\'
argument_list|)
expr_stmt|;
operator|*
name|hptr
operator|++
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|hptr
operator|-
name|hline
operator|>=
name|hlinesz
condition|)
block|{
name|int
name|ll
decl_stmt|,
name|flag
init|=
literal|0
decl_stmt|,
name|oldsiz
init|=
name|hlinesz
decl_stmt|;
name|ll
operator|=
name|hptr
operator|-
name|hlastw
expr_stmt|;
if|if
condition|(
name|curhistent
operator|->
name|lex
operator|==
name|hline
condition|)
name|flag
operator|=
literal|1
expr_stmt|;
name|hline
operator|=
name|hp_realloc
argument_list|(
operator|&
name|hp_lex
argument_list|,
name|hline
argument_list|,
name|oldsiz
argument_list|,
name|hlinesz
operator|=
name|oldsiz
operator|+
literal|16
argument_list|)
expr_stmt|;
if|if
condition|(
name|flag
condition|)
name|curhistent
operator|->
name|lex
operator|=
name|hline
expr_stmt|;
name|hptr
operator|=
name|hline
operator|+
name|oldsiz
expr_stmt|;
name|hlastw
operator|=
name|hptr
operator|-
name|ll
expr_stmt|;
block|}
block|}
block|}
end_function

begin_define
define|#
directive|define
name|habort
parameter_list|()
value|{ errflag = lexstop = 1; return ' '; }
end_define

begin_comment
comment|/* get a character after performing history substitution */
end_comment

begin_function
name|int
name|hgetc
parameter_list|()
comment|/**/
block|{
name|int
name|c
decl_stmt|,
name|ev
decl_stmt|,
name|farg
decl_stmt|,
name|larg
decl_stmt|,
name|argc
decl_stmt|,
name|marg
init|=
operator|-
literal|1
decl_stmt|,
name|cflag
init|=
literal|0
decl_stmt|,
name|bflag
init|=
literal|0
decl_stmt|;
name|char
name|buf
index|[
literal|256
index|]
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|char
modifier|*
name|sline
decl_stmt|,
modifier|*
name|eline
decl_stmt|;
name|tailrec
label|:
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
if|if
condition|(
name|stophist
operator|||
name|alstackind
condition|)
block|{
name|hwaddc
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
name|c
return|;
block|}
if|if
condition|(
name|isfirstch
operator|&&
name|c
operator|==
name|hatchar
condition|)
block|{
name|isfirstch
operator|=
literal|0
expr_stmt|;
name|hungetch
argument_list|(
name|hatchar
argument_list|)
expr_stmt|;
name|hungets
argument_list|(
literal|":s"
argument_list|)
expr_stmt|;
name|c
operator|=
name|bangchar
expr_stmt|;
goto|goto
name|hatskip
goto|;
block|}
if|if
condition|(
name|c
operator|!=
literal|' '
condition|)
name|isfirstch
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
block|{
name|int
name|g
init|=
name|hgetch
argument_list|()
decl_stmt|;
if|if
condition|(
name|g
operator|!=
name|bangchar
condition|)
name|hungetch
argument_list|(
name|g
argument_list|)
expr_stmt|;
else|else
block|{
name|hwaddc
argument_list|(
name|bangchar
argument_list|)
expr_stmt|;
return|return
name|bangchar
return|;
block|}
block|}
if|if
condition|(
name|c
operator|!=
name|bangchar
condition|)
block|{
name|hwaddc
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
name|c
return|;
block|}
name|hatskip
label|:
operator|*
name|hptr
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|hgetch
argument_list|()
operator|)
operator|==
literal|'{'
condition|)
block|{
name|bflag
operator|=
name|cflag
operator|=
literal|1
expr_stmt|;
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|==
literal|'\"'
condition|)
block|{
name|stophist
operator|=
literal|1
expr_stmt|;
goto|goto
name|tailrec
goto|;
block|}
if|if
condition|(
operator|!
name|cflag
operator|&&
name|inblank
argument_list|(
name|c
argument_list|)
operator|||
name|c
operator|==
literal|'='
operator|||
name|c
operator|==
literal|'('
operator|||
name|lexstop
condition|)
block|{
if|if
condition|(
name|lexstop
condition|)
name|lexstop
operator|=
literal|0
expr_stmt|;
else|else
name|hungetch
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|hwaddc
argument_list|(
name|bangchar
argument_list|)
expr_stmt|;
return|return
name|bangchar
return|;
block|}
name|cflag
operator|=
literal|0
expr_stmt|;
name|ptr
operator|=
name|buf
expr_stmt|;
comment|/* get event number */
if|if
condition|(
name|c
operator|==
literal|'?'
condition|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'?'
operator|||
name|c
operator|==
literal|'\n'
operator|||
name|lexstop
condition|)
break|break;
else|else
operator|*
name|ptr
operator|++
operator|=
name|c
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|!=
literal|'\n'
operator|&&
operator|!
name|lexstop
condition|)
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
operator|*
name|ptr
operator|=
literal|'\0'
expr_stmt|;
name|ev
operator|=
name|hconsearch
argument_list|(
name|hsubl
operator|=
name|ztrdup
argument_list|(
name|buf
argument_list|)
argument_list|,
operator|&
name|marg
argument_list|)
expr_stmt|;
if|if
condition|(
name|ev
operator|==
operator|-
literal|1
condition|)
block|{
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"no such event: %s"
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|habort
argument_list|()
expr_stmt|;
block|}
block|}
else|else
block|{
name|int
name|t0
decl_stmt|;
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
name|inblank
argument_list|(
name|c
argument_list|)
operator|||
name|c
operator|==
literal|';'
operator|||
name|c
operator|==
literal|':'
operator|||
name|c
operator|==
literal|'^'
operator|||
name|c
operator|==
literal|'$'
operator|||
name|c
operator|==
literal|'*'
operator|||
name|c
operator|==
literal|'%'
operator|||
name|c
operator|==
literal|'}'
operator|||
name|lexstop
condition|)
break|break;
if|if
condition|(
name|ptr
operator|!=
name|buf
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'-'
condition|)
break|break;
if|if
condition|(
operator|(
name|idigit
argument_list|(
name|buf
index|[
literal|0
index|]
argument_list|)
operator|||
name|buf
index|[
literal|0
index|]
operator|==
literal|'-'
operator|)
operator|&&
operator|!
name|idigit
argument_list|(
name|c
argument_list|)
condition|)
break|break;
block|}
operator|*
name|ptr
operator|++
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'#'
operator|||
name|c
operator|==
name|bangchar
condition|)
block|{
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
break|break;
block|}
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
block|}
operator|*
name|ptr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|buf
condition|)
name|ev
operator|=
name|defev
expr_stmt|;
elseif|else
if|if
condition|(
name|t0
operator|=
name|atoi
argument_list|(
name|buf
argument_list|)
condition|)
name|ev
operator|=
operator|(
name|t0
operator|<
literal|0
operator|)
condition|?
name|curhist
operator|+
name|t0
else|:
name|t0
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|buf
operator|==
name|bangchar
condition|)
name|ev
operator|=
name|curhist
operator|-
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|buf
operator|==
literal|'#'
condition|)
name|ev
operator|=
name|curhist
expr_stmt|;
elseif|else
if|if
condition|(
operator|(
name|ev
operator|=
name|hcomsearch
argument_list|(
name|buf
argument_list|)
operator|)
operator|==
operator|-
literal|1
condition|)
block|{
name|zerr
argument_list|(
literal|"event not found: %s"
argument_list|,
name|buf
argument_list|,
literal|0
argument_list|)
expr_stmt|;
while|while
condition|(
name|c
operator|!=
literal|'\n'
operator|&&
operator|!
name|lexstop
condition|)
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
name|habort
argument_list|()
expr_stmt|;
block|}
block|}
comment|/* get the event */
if|if
condition|(
operator|!
operator|(
name|eline
operator|=
name|getevent
argument_list|(
name|defev
operator|=
name|ev
argument_list|)
operator|)
condition|)
name|habort
argument_list|()
expr_stmt|;
comment|/* extract the relevant arguments */
name|argc
operator|=
name|getargc
argument_list|(
name|eline
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|':'
condition|)
block|{
name|cflag
operator|=
literal|1
expr_stmt|;
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
block|}
if|if
condition|(
name|c
operator|==
literal|'*'
condition|)
block|{
name|farg
operator|=
literal|1
expr_stmt|;
name|larg
operator|=
name|argc
expr_stmt|;
name|cflag
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|hungetch
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|larg
operator|=
name|farg
operator|=
name|getargspec
argument_list|(
name|argc
argument_list|,
name|marg
argument_list|)
expr_stmt|;
if|if
condition|(
name|larg
operator|==
operator|-
literal|2
condition|)
name|habort
argument_list|()
expr_stmt|;
if|if
condition|(
name|farg
operator|!=
operator|-
literal|1
condition|)
name|cflag
operator|=
literal|0
expr_stmt|;
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'*'
condition|)
block|{
name|cflag
operator|=
literal|0
expr_stmt|;
name|larg
operator|=
name|argc
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'-'
condition|)
block|{
name|cflag
operator|=
literal|0
expr_stmt|;
name|larg
operator|=
name|getargspec
argument_list|(
name|argc
argument_list|,
name|marg
argument_list|)
expr_stmt|;
if|if
condition|(
name|larg
operator|==
operator|-
literal|2
condition|)
name|habort
argument_list|()
expr_stmt|;
if|if
condition|(
name|larg
operator|==
operator|-
literal|1
condition|)
name|larg
operator|=
name|argc
operator|-
literal|1
expr_stmt|;
block|}
else|else
name|hungetch
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|farg
operator|==
operator|-
literal|1
condition|)
name|farg
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|larg
operator|==
operator|-
literal|1
condition|)
name|larg
operator|=
name|argc
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|sline
operator|=
name|getargs
argument_list|(
name|eline
argument_list|,
name|farg
argument_list|,
name|larg
argument_list|)
operator|)
condition|)
name|habort
argument_list|()
expr_stmt|;
comment|/* do the modifiers */
for|for
control|(
init|;
condition|;
control|)
block|{
name|c
operator|=
operator|(
name|cflag
operator|)
condition|?
literal|':'
else|:
name|hgetch
argument_list|()
expr_stmt|;
name|cflag
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|':'
condition|)
block|{
name|int
name|gbal
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|hgetch
argument_list|()
operator|)
operator|==
literal|'g'
condition|)
block|{
name|gbal
operator|=
literal|1
expr_stmt|;
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
block|}
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'p'
case|:
name|histdone
operator|=
name|HISTFLAG_DONE
operator||
name|HISTFLAG_NOEXEC
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
if|if
condition|(
operator|!
name|remtpath
argument_list|(
operator|&
name|sline
argument_list|)
condition|)
block|{
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"modifier failed: h"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|habort
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|'e'
case|:
if|if
condition|(
operator|!
name|rembutext
argument_list|(
operator|&
name|sline
argument_list|)
condition|)
block|{
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"modifier failed: e"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|habort
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|'r'
case|:
if|if
condition|(
operator|!
name|remtext
argument_list|(
operator|&
name|sline
argument_list|)
condition|)
block|{
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"modifier failed: r"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|habort
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|'t'
case|:
if|if
condition|(
operator|!
name|remlpaths
argument_list|(
operator|&
name|sline
argument_list|)
condition|)
block|{
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"modifier failed: t"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|habort
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|'s'
case|:
block|{
name|int
name|del
decl_stmt|;
name|char
modifier|*
name|ptr1
decl_stmt|,
modifier|*
name|ptr2
decl_stmt|;
name|del
operator|=
name|hgetch
argument_list|()
expr_stmt|;
name|ptr1
operator|=
name|hdynread2
argument_list|(
name|del
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ptr1
condition|)
name|habort
argument_list|()
expr_stmt|;
name|ptr2
operator|=
name|hdynread2
argument_list|(
name|del
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|ptr1
argument_list|)
condition|)
block|{
if|if
condition|(
name|hsubl
condition|)
name|free
argument_list|(
name|hsubl
argument_list|)
expr_stmt|;
name|hsubl
operator|=
name|ptr1
expr_stmt|;
block|}
if|if
condition|(
name|hsubr
condition|)
name|free
argument_list|(
name|hsubr
argument_list|)
expr_stmt|;
name|hsubr
operator|=
name|ptr2
expr_stmt|;
block|}
case|case
literal|'&'
case|:
if|if
condition|(
name|hsubl
operator|&&
name|hsubr
condition|)
name|subst
argument_list|(
operator|&
name|sline
argument_list|,
name|hsubl
argument_list|,
name|hsubr
argument_list|,
name|gbal
argument_list|)
expr_stmt|;
else|else
block|{
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"no previous substitution with&"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|habort
argument_list|()
expr_stmt|;
block|}
break|break;
case|case
literal|'q'
case|:
name|quote
argument_list|(
operator|&
name|sline
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'x'
case|:
name|quotebreak
argument_list|(
operator|&
name|sline
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|downcase
argument_list|(
operator|&
name|sline
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|upcase
argument_list|(
operator|&
name|sline
argument_list|)
expr_stmt|;
break|break;
default|default:
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"illegal modifier: %c"
argument_list|,
name|NULL
argument_list|,
name|c
argument_list|)
expr_stmt|;
name|habort
argument_list|()
expr_stmt|;
break|break;
block|}
block|}
else|else
block|{
if|if
condition|(
name|c
operator|!=
literal|'}'
operator|||
operator|!
name|bflag
condition|)
name|hungetch
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|!=
literal|'}'
operator|&&
name|bflag
condition|)
block|{
name|zerr
argument_list|(
literal|"'}' expected"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|habort
argument_list|()
expr_stmt|;
block|}
break|break;
block|}
block|}
comment|/* stuff the resulting string in the input queue and start over */
name|lexstop
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|alstackind
operator|!=
name|MAXAL
condition|)
block|{
name|hungets
argument_list|(
name|HISTMARK
argument_list|)
expr_stmt|;
name|alstack
index|[
name|alstackind
operator|++
index|]
operator|=
name|NULL
expr_stmt|;
block|}
for|for
control|(
name|ptr
operator|=
name|sline
init|;
operator|*
name|ptr
condition|;
name|ptr
operator|++
control|)
block|{
if|if
condition|(
name|ptr
index|[
literal|0
index|]
operator|==
literal|'\\'
operator|&&
name|ptr
index|[
literal|1
index|]
operator|==
literal|'!'
condition|)
name|chuck
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
name|hungets
argument_list|(
name|sline
argument_list|)
expr_stmt|;
name|histdone
operator||=
name|HISTFLAG_DONE
expr_stmt|;
if|if
condition|(
name|isset
argument_list|(
name|HISTVERIFY
argument_list|)
condition|)
name|histdone
operator||=
name|HISTFLAG_NOEXEC
operator||
name|HISTFLAG_RECALL
expr_stmt|;
goto|goto
name|tailrec
goto|;
block|}
end_function

begin_comment
comment|/* reset the alias stack for lexrestore () */
end_comment

begin_function
name|void
name|clearalstack
parameter_list|()
comment|/**/
block|{
name|Alias
name|ix
decl_stmt|;
while|while
condition|(
name|alstackind
condition|)
block|{
name|ix
operator|=
name|alstack
index|[
operator|--
name|alstackind
index|]
expr_stmt|;
name|ix
operator|->
name|inuse
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* get a character without history expansion */
end_comment

begin_function
name|int
name|hgetch
parameter_list|()
comment|/**/
block|{
name|unsigned
name|char
modifier|*
name|line
decl_stmt|,
modifier|*
name|pmpt
decl_stmt|,
modifier|*
name|pmpt2
init|=
name|NULL
decl_stmt|;
name|int
name|plen
decl_stmt|;
name|start
label|:
if|if
condition|(
name|inbufct
condition|)
block|{
name|inbufct
operator|--
expr_stmt|;
if|if
condition|(
operator|(
name|lastc
operator|=
operator|*
name|inbufptr
operator|++
operator|)
operator|==
name|ALPOP
condition|)
block|{
name|Alias
name|ix
decl_stmt|;
name|char
modifier|*
name|t
decl_stmt|;
if|if
condition|(
operator|!
name|alstackind
condition|)
block|{
name|zerr
argument_list|(
literal|"alias stack underflow"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|errflag
operator|=
name|lexstop
operator|=
literal|1
expr_stmt|;
return|return
name|lastc
operator|=
literal|' '
return|;
block|}
name|ix
operator|=
name|alstack
index|[
operator|--
name|alstackind
index|]
expr_stmt|;
if|if
condition|(
name|ix
condition|)
block|{
name|ix
operator|->
name|inuse
operator|=
literal|0
expr_stmt|;
name|t
operator|=
name|ix
operator|->
name|text
expr_stmt|;
if|if
condition|(
operator|*
name|t
operator|&&
name|t
index|[
name|strlen
argument_list|(
name|t
argument_list|)
operator|-
literal|1
index|]
operator|==
literal|' '
condition|)
name|alstat
operator|=
name|ALSTAT_MORE
expr_stmt|;
else|else
name|alstat
operator|=
name|ALSTAT_JUNK
expr_stmt|;
block|}
goto|goto
name|start
goto|;
block|}
if|if
condition|(
name|itok
argument_list|(
name|lastc
argument_list|)
condition|)
goto|goto
name|start
goto|;
return|return
name|lastc
return|;
block|}
if|if
condition|(
name|strin
operator|||
name|errflag
condition|)
block|{
name|lexstop
operator|=
literal|1
expr_stmt|;
return|return
name|lastc
operator|=
literal|' '
return|;
block|}
if|if
condition|(
name|interact
operator|&&
name|isset
argument_list|(
name|SHINSTDIN
argument_list|)
condition|)
if|if
condition|(
operator|!
name|isfirstln
condition|)
name|pmpt
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|putprompt
argument_list|(
name|prompt2
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
else|else
block|{
name|int
name|foo
decl_stmt|;
name|pmpt
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|putprompt
argument_list|(
name|prompt
argument_list|,
operator|&
name|plen
argument_list|)
expr_stmt|;
name|pmpt2
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
operator|(
operator|(
name|rprompt
operator|)
condition|?
name|putprompt
argument_list|(
name|rprompt
argument_list|,
operator|&
name|foo
argument_list|)
else|:
name|NULL
operator|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|interact
operator|&&
name|isset
argument_list|(
name|SHINSTDIN
argument_list|)
operator|&&
name|SHTTY
operator|!=
operator|-
literal|1
operator|&&
name|isset
argument_list|(
name|USEZLE
argument_list|)
operator|)
condition|)
block|{
name|char
modifier|*
name|lbuf
decl_stmt|;
if|if
condition|(
name|interact
operator|&&
name|isset
argument_list|(
name|SHINSTDIN
argument_list|)
condition|)
name|write
argument_list|(
literal|2
argument_list|,
name|pmpt
argument_list|,
name|strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|pmpt
argument_list|)
argument_list|)
expr_stmt|;
name|line
operator|=
operator|(
name|unsigned
name|char
operator|*
operator|)
name|fgets
argument_list|(
name|lbuf
operator|=
name|zalloc
argument_list|(
literal|256
argument_list|)
argument_list|,
literal|256
argument_list|,
name|bshin
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|line
condition|)
name|free
argument_list|(
name|lbuf
argument_list|)
expr_stmt|;
block|}
else|else
name|line
operator|=
name|zleread
argument_list|(
name|pmpt
argument_list|,
name|pmpt2
argument_list|,
name|plen
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|line
condition|)
block|{
name|lexstop
operator|=
literal|1
expr_stmt|;
return|return
name|lastc
operator|=
literal|' '
return|;
block|}
if|if
condition|(
name|errflag
condition|)
block|{
name|free
argument_list|(
name|line
argument_list|)
expr_stmt|;
name|lexstop
operator|=
name|errflag
operator|=
literal|1
expr_stmt|;
return|return
name|lastc
operator|=
literal|' '
return|;
block|}
if|if
condition|(
name|interact
operator|&&
name|isset
argument_list|(
name|SHINSTDIN
argument_list|)
condition|)
block|{
name|char
modifier|*
name|s
init|=
name|curhistent
operator|->
name|lit
decl_stmt|;
name|curhistent
operator|->
name|lit
operator|=
name|hp_concat
argument_list|(
name|s
argument_list|,
operator|(
name|char
operator|*
operator|)
name|line
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|isfirstln
condition|)
name|spaceflag
operator|=
operator|*
name|line
operator|==
literal|' '
expr_stmt|;
if|if
condition|(
name|isset
argument_list|(
name|VERBOSE
argument_list|)
condition|)
block|{
name|fputs
argument_list|(
operator|(
name|char
operator|*
operator|)
name|line
argument_list|,
name|stderr
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|*
name|line
operator|&&
name|line
index|[
name|strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|line
argument_list|)
operator|-
literal|1
index|]
operator|==
literal|'\n'
condition|)
block|{
name|lineno
operator|++
expr_stmt|;
if|if
condition|(
name|interact
operator|&&
name|isset
argument_list|(
name|SUNKEYBOARDHACK
argument_list|)
operator|&&
name|isset
argument_list|(
name|SHINSTDIN
argument_list|)
operator|&&
name|SHTTY
operator|!=
operator|-
literal|1
operator|&&
operator|*
name|line
operator|&&
name|line
index|[
literal|1
index|]
operator|&&
name|line
index|[
name|strlen
argument_list|(
operator|(
name|char
operator|*
operator|)
name|line
argument_list|)
operator|-
literal|2
index|]
operator|==
literal|'`'
condition|)
block|{
name|int
name|ct
decl_stmt|;
name|unsigned
name|char
modifier|*
name|ptr
decl_stmt|;
for|for
control|(
name|ct
operator|=
literal|0
operator|,
name|ptr
operator|=
name|line
init|;
operator|*
name|ptr
condition|;
name|ptr
operator|++
control|)
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'`'
condition|)
name|ct
operator|++
expr_stmt|;
if|if
condition|(
name|ct
operator|&
literal|1
condition|)
block|{
name|ptr
index|[
operator|-
literal|2
index|]
operator|=
literal|'\n'
expr_stmt|;
name|ptr
index|[
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
block|}
block|}
name|isfirstch
operator|=
literal|1
expr_stmt|;
name|hungets
argument_list|(
operator|(
name|char
operator|*
operator|)
name|line
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|line
argument_list|)
expr_stmt|;
goto|goto
name|start
goto|;
block|}
end_function

begin_comment
comment|/* Read one line of at most n-1 chars from the input queue */
end_comment

begin_function
name|char
modifier|*
name|hgets
parameter_list|(
name|buf
parameter_list|,
name|n
parameter_list|)
comment|/**/
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|n
decl_stmt|;
block|{
name|int
name|l
decl_stmt|;
for|for
control|(
name|l
operator|=
literal|0
init|;
name|l
operator|<
name|n
operator|-
literal|1
condition|;
name|l
operator|++
control|)
if|if
condition|(
operator|(
name|buf
index|[
name|l
index|]
operator|=
name|hgetch
argument_list|()
operator|)
operator|==
literal|'\n'
operator|||
name|lexstop
condition|)
break|break;
name|buf
index|[
name|l
operator|+
operator|(
name|lexstop
condition|?
literal|0
else|:
literal|1
operator|)
index|]
operator|=
literal|0
expr_stmt|;
return|return
operator|(
operator|!
name|lexstop
operator|||
name|l
operator|)
condition|?
name|buf
else|:
name|NULL
return|;
block|}
end_function

begin_comment
comment|/* put a string in the input queue */
end_comment

begin_function
name|void
name|hungets
parameter_list|(
name|str
parameter_list|)
comment|/**/
name|char
modifier|*
name|str
decl_stmt|;
block|{
name|int
name|slen
init|=
name|strlen
argument_list|(
name|str
argument_list|)
decl_stmt|;
comment|/* shrink inbuf if it gets too big */
if|if
condition|(
operator|!
name|inbufct
operator|&&
name|inbufsz
operator|>
literal|65536
condition|)
block|{
name|free
argument_list|(
name|inbuf
argument_list|)
expr_stmt|;
name|inbuf
operator|=
name|zalloc
argument_list|(
name|inbufsz
operator|=
literal|256
argument_list|)
expr_stmt|;
name|inbufptr
operator|=
name|inbuf
operator|+
name|inbufsz
expr_stmt|;
name|inbufct
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|slen
operator|+
name|inbufct
operator|>
name|inbufsz
condition|)
block|{
name|char
modifier|*
name|x
decl_stmt|;
while|while
condition|(
name|slen
operator|+
name|inbufct
operator|>
name|inbufsz
condition|)
name|inbufsz
operator|*=
literal|4
expr_stmt|;
name|x
operator|=
name|zalloc
argument_list|(
name|inbufsz
argument_list|)
expr_stmt|;
name|memcpy
argument_list|(
name|x
operator|+
name|inbufsz
operator|-
name|inbufct
argument_list|,
name|inbufptr
argument_list|,
name|inbufct
argument_list|)
expr_stmt|;
name|inbufptr
operator|=
name|x
operator|+
name|inbufsz
operator|-
name|inbufct
expr_stmt|;
name|free
argument_list|(
name|inbuf
argument_list|)
expr_stmt|;
name|inbuf
operator|=
name|x
expr_stmt|;
block|}
name|memcpy
argument_list|(
name|inbufptr
operator|-=
name|slen
argument_list|,
name|str
argument_list|,
name|slen
argument_list|)
expr_stmt|;
name|inbufct
operator|+=
name|slen
expr_stmt|;
block|}
end_function

begin_comment
comment|/* unget a char and remove it from hline */
end_comment

begin_function
name|void
name|hungetc
parameter_list|(
name|c
parameter_list|)
comment|/**/
name|int
name|c
decl_stmt|;
block|{
if|if
condition|(
name|lexstop
condition|)
return|return;
if|if
condition|(
name|hlastw
condition|)
block|{
if|if
condition|(
name|hlastw
operator|==
name|hptr
condition|)
name|zerr
argument_list|(
literal|"hungetc attempted at buffer start"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
block|{
name|hptr
operator|--
expr_stmt|;
if|if
condition|(
operator|*
name|hptr
operator|==
literal|'!'
operator|&&
name|unset
argument_list|(
name|NOBANGHIST
argument_list|)
condition|)
name|hptr
operator|--
expr_stmt|;
block|}
block|}
name|hungetch
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|hungetch
parameter_list|(
name|c
parameter_list|)
comment|/**/
name|int
name|c
decl_stmt|;
block|{
if|if
condition|(
name|lexstop
condition|)
return|return;
if|if
condition|(
name|inbufct
operator|==
name|inbufsz
condition|)
block|{
name|hungets
argument_list|(
literal|" "
argument_list|)
expr_stmt|;
operator|*
name|inbufptr
operator|=
name|c
expr_stmt|;
block|}
else|else
block|{
operator|*
operator|--
name|inbufptr
operator|=
name|c
expr_stmt|;
name|inbufct
operator|++
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* begin reading a string */
end_comment

begin_function
name|void
name|strinbeg
parameter_list|()
comment|/**/
block|{
name|strin
operator|=
literal|1
expr_stmt|;
name|hbegin
argument_list|()
expr_stmt|;
name|lexinit
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* done reading a string */
end_comment

begin_function
name|void
name|strinend
parameter_list|()
comment|/**/
block|{
name|strin
operator|=
literal|0
expr_stmt|;
name|isfirstch
operator|=
literal|1
expr_stmt|;
name|histdone
operator|=
literal|0
expr_stmt|;
name|hend
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* stuff a whole file into the input queue and print it */
end_comment

begin_function
name|int
name|stuff
parameter_list|(
name|fn
parameter_list|)
comment|/**/
name|char
modifier|*
name|fn
decl_stmt|;
block|{
name|FILE
modifier|*
name|in
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|;
if|if
condition|(
operator|!
operator|(
name|in
operator|=
name|fopen
argument_list|(
name|fn
argument_list|,
literal|"r"
argument_list|)
operator|)
condition|)
block|{
name|zerr
argument_list|(
literal|"can't open %s"
argument_list|,
name|fn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|fseek
argument_list|(
name|in
argument_list|,
literal|0
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|len
operator|=
name|ftell
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|fseek
argument_list|(
name|in
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|buf
operator|=
name|alloc
argument_list|(
name|len
operator|+
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|fread
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|1
argument_list|,
name|in
argument_list|)
operator|)
condition|)
block|{
name|zerr
argument_list|(
literal|"read error on %s"
argument_list|,
name|fn
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
name|buf
index|[
name|len
index|]
operator|=
literal|'\0'
expr_stmt|;
name|fwrite
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|1
argument_list|,
name|stdout
argument_list|)
expr_stmt|;
name|hungets
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* flush input queue */
end_comment

begin_function
name|void
name|hflush
parameter_list|()
comment|/**/
block|{
name|inbufptr
operator|+=
name|inbufct
expr_stmt|;
name|inbufct
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/* initialize the history mechanism */
end_comment

begin_function
name|void
name|hbegin
parameter_list|()
comment|/**/
block|{
name|isfirstln
operator|=
name|isfirstch
operator|=
literal|1
expr_stmt|;
name|histremmed
operator|=
name|errflag
operator|=
name|histdone
operator|=
name|spaceflag
operator|=
literal|0
expr_stmt|;
name|stophist
operator|=
name|isset
argument_list|(
name|NOBANGHIST
argument_list|)
operator|||
name|unset
argument_list|(
name|SHINSTDIN
argument_list|)
expr_stmt|;
name|lithist
operator|=
name|isset
argument_list|(
name|HISTLIT
argument_list|)
expr_stmt|;
name|hline
operator|=
name|hptr
operator|=
name|hp_alloc
argument_list|(
operator|&
name|hp_lex
argument_list|,
name|hlinesz
operator|=
literal|16
argument_list|)
expr_stmt|;
name|curhistent
operator|=
name|gethistent
argument_list|(
name|curhist
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|curhistent
operator|->
name|ftim
condition|)
name|curhistent
operator|->
name|ftim
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
if|if
condition|(
name|interact
operator|&&
name|isset
argument_list|(
name|SHINSTDIN
argument_list|)
operator|&&
operator|!
name|strin
condition|)
block|{
name|inittty
argument_list|()
expr_stmt|;
name|defev
operator|=
name|curhist
operator|++
expr_stmt|;
if|if
condition|(
name|curhist
operator|-
name|histsiz
operator|>=
literal|0
condition|)
name|gethistent
argument_list|(
name|curhist
operator|-
name|histsiz
argument_list|)
operator|->
name|lex
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|curhist
operator|-
name|lithistsiz
operator|>=
literal|0
condition|)
name|gethistent
argument_list|(
name|curhist
operator|-
name|lithistsiz
argument_list|)
operator|->
name|lit
operator|=
name|NULL
expr_stmt|;
name|curhistent
operator|=
name|gethistent
argument_list|(
name|curhist
argument_list|)
expr_stmt|;
name|hp_purge
argument_list|(
name|hp_lex
argument_list|,
name|curhist
operator|-
name|histsiz
argument_list|)
expr_stmt|;
name|hp_purge
argument_list|(
name|hp_lit
argument_list|,
name|curhist
operator|-
name|lithistsiz
argument_list|)
expr_stmt|;
name|curhistent
operator|->
name|lex
operator|=
name|hline
expr_stmt|;
operator|*
operator|(
name|curhistent
operator|->
name|lit
operator|=
name|hp_alloc
argument_list|(
operator|&
name|hp_lit
argument_list|,
literal|1
argument_list|)
operator|)
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
name|histremmed
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|inittty
parameter_list|()
comment|/**/
block|{
name|attachtty
argument_list|(
name|mypgrp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* say we're done using the history mechanism */
end_comment

begin_function
name|int
name|hend
parameter_list|()
comment|/**/
block|{
name|int
name|flag
decl_stmt|,
name|save
init|=
literal|1
decl_stmt|;
name|Histent
name|he
decl_stmt|;
if|if
condition|(
operator|!
name|hline
condition|)
return|return
literal|1
return|;
if|if
condition|(
operator|!
name|interact
operator|||
name|strin
operator|||
name|unset
argument_list|(
name|SHINSTDIN
argument_list|)
condition|)
block|{
name|hp_free
argument_list|(
name|hp_lex
argument_list|,
name|hline
argument_list|,
name|hlinesz
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
name|flag
operator|=
name|histdone
expr_stmt|;
name|histdone
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|hptr
operator|<
name|hline
operator|+
literal|2
condition|)
name|save
operator|=
literal|0
expr_stmt|;
else|else
block|{
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|t
decl_stmt|;
name|s
operator|=
name|curhistent
operator|->
name|lit
expr_stmt|;
if|if
condition|(
operator|*
name|s
operator|&&
operator|*
operator|(
name|t
operator|=
name|s
operator|+
name|strlen
argument_list|(
name|s
argument_list|)
operator|-
literal|1
operator|)
operator|==
name|HISTSPACE
condition|)
operator|*
name|t
operator|=
literal|'\0'
expr_stmt|;
name|hptr
index|[
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|hptr
index|[
operator|-
literal|2
index|]
operator|==
literal|'\n'
condition|)
if|if
condition|(
name|hline
index|[
literal|1
index|]
condition|)
block|{
if|if
condition|(
name|hptr
index|[
operator|-
literal|3
index|]
operator|==
name|HISTSPACE
condition|)
name|hptr
index|[
operator|-
literal|3
index|]
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
name|save
operator|=
literal|0
expr_stmt|;
name|he
operator|=
name|gethistent
argument_list|(
name|curhist
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|hline
argument_list|,
literal|"\n"
argument_list|)
operator|||
operator|(
name|isset
argument_list|(
name|HISTIGNOREDUPS
argument_list|)
operator|&&
name|he
operator|->
name|lex
operator|&&
operator|!
name|strcmp
argument_list|(
name|he
operator|->
name|lex
argument_list|,
name|hline
argument_list|)
operator|)
operator|||
operator|(
name|isset
argument_list|(
name|HISTIGNORESPACE
argument_list|)
operator|&&
name|spaceflag
operator|)
condition|)
name|save
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|flag
operator|&
operator|(
name|HISTFLAG_DONE
operator||
name|HISTFLAG_RECALL
operator|)
condition|)
block|{
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|p
decl_stmt|;
name|p
operator|=
name|ptr
operator|=
name|ztrdup
argument_list|(
name|hline
argument_list|)
expr_stmt|;
for|for
control|(
init|;
operator|*
name|p
condition|;
name|p
operator|++
control|)
if|if
condition|(
operator|*
name|p
operator|==
name|HISTSPACE
condition|)
operator|*
name|p
operator|=
literal|' '
expr_stmt|;
if|if
condition|(
operator|(
name|flag
operator|&
operator|(
name|HISTFLAG_DONE
operator||
name|HISTFLAG_RECALL
operator|)
operator|)
operator|==
name|HISTFLAG_DONE
condition|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"%s\n"
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stderr
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|flag
operator|&
name|HISTFLAG_RECALL
condition|)
block|{
name|permalloc
argument_list|()
expr_stmt|;
name|pushnode
argument_list|(
name|bufstack
argument_list|,
name|ptr
argument_list|)
expr_stmt|;
name|lastalloc
argument_list|()
expr_stmt|;
name|save
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|free
argument_list|(
name|ptr
argument_list|)
expr_stmt|;
block|}
name|curhistent
operator|->
name|stim
operator|=
name|time
argument_list|(
name|NULL
argument_list|)
expr_stmt|;
name|curhistent
operator|->
name|ftim
operator|=
literal|0L
expr_stmt|;
if|if
condition|(
operator|!
name|save
condition|)
name|remhist
argument_list|()
expr_stmt|;
if|if
condition|(
name|hline
operator|&&
operator|!
name|curhistent
operator|->
name|lex
condition|)
name|hp_free
argument_list|(
name|hp_lex
argument_list|,
name|hline
argument_list|,
name|hlinesz
argument_list|)
expr_stmt|;
name|hline
operator|=
name|NULL
expr_stmt|;
return|return
operator|!
operator|(
name|flag
operator|&
name|HISTFLAG_NOEXEC
operator|||
name|errflag
operator|)
return|;
block|}
end_function

begin_comment
comment|/* remove the current line from the history List */
end_comment

begin_function
name|void
name|remhist
parameter_list|()
comment|/**/
block|{
if|if
condition|(
operator|!
name|histremmed
condition|)
block|{
name|histremmed
operator|=
literal|1
expr_stmt|;
name|curhist
operator|--
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* begin a word */
end_comment

begin_function
name|void
name|hwbegin
parameter_list|()
comment|/**/
block|{
name|hlastw
operator|=
name|hptr
expr_stmt|;
block|}
end_function

begin_comment
comment|/* add a word to the history List */
end_comment

begin_function
name|char
modifier|*
name|hwadd
parameter_list|()
comment|/**/
block|{
name|char
modifier|*
name|ret
init|=
name|hlastw
decl_stmt|;
if|if
condition|(
name|hlastw
operator|&&
name|hline
condition|)
block|{
name|hwaddc
argument_list|(
name|HISTSPACE
argument_list|)
expr_stmt|;
if|if
condition|(
name|alstackind
operator|||
name|strin
condition|)
if|if
condition|(
operator|!
operator|(
name|alstackind
operator|==
literal|1
operator|&&
operator|!
name|alstack
index|[
literal|0
index|]
operator|)
condition|)
name|hptr
operator|=
name|hlastw
expr_stmt|;
block|}
if|if
condition|(
name|alstat
operator|==
name|ALSTAT_JUNK
condition|)
name|alstat
operator|=
literal|0
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* get an argument specification */
end_comment

begin_function
name|int
name|getargspec
parameter_list|(
name|argc
parameter_list|,
name|marg
parameter_list|)
comment|/**/
name|int
name|argc
decl_stmt|;
name|int
name|marg
decl_stmt|;
block|{
name|int
name|c
decl_stmt|,
name|ret
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
operator|(
name|c
operator|=
name|hgetch
argument_list|()
operator|)
operator|==
literal|'0'
condition|)
return|return
literal|0
return|;
if|if
condition|(
name|idigit
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|ret
operator|=
literal|0
expr_stmt|;
while|while
condition|(
name|idigit
argument_list|(
name|c
argument_list|)
condition|)
block|{
name|ret
operator|=
name|ret
operator|*
literal|10
operator|+
name|c
operator|-
literal|'0'
expr_stmt|;
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
block|}
name|hungetch
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|==
literal|'^'
condition|)
name|ret
operator|=
literal|1
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'$'
condition|)
name|ret
operator|=
name|argc
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|==
literal|'%'
condition|)
block|{
if|if
condition|(
name|marg
operator|==
operator|-
literal|1
condition|)
block|{
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"%% with no previous word matched"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
operator|-
literal|2
return|;
block|}
name|ret
operator|=
name|marg
expr_stmt|;
block|}
else|else
name|hungetch
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_comment
comment|/* do ?foo? search */
end_comment

begin_function
name|int
name|hconsearch
parameter_list|(
name|str
parameter_list|,
name|marg
parameter_list|)
comment|/**/
name|char
modifier|*
name|str
decl_stmt|;
name|int
modifier|*
name|marg
decl_stmt|;
block|{
name|int
name|t0
decl_stmt|,
name|t1
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|hs
decl_stmt|;
for|for
control|(
name|t0
operator|=
name|curhist
operator|-
literal|1
init|;
name|hs
operator|=
name|quietgetevent
argument_list|(
name|t0
argument_list|)
condition|;
name|t0
operator|--
control|)
if|if
condition|(
name|s
operator|=
name|ztrstr
argument_list|(
name|hs
argument_list|,
name|str
argument_list|)
condition|)
block|{
while|while
condition|(
name|s
operator|!=
name|hs
condition|)
if|if
condition|(
operator|*
name|s
operator|--
operator|==
name|HISTSPACE
condition|)
name|t1
operator|++
expr_stmt|;
operator|*
name|marg
operator|=
name|t1
expr_stmt|;
return|return
name|t0
return|;
block|}
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/* do !foo search */
end_comment

begin_function
name|int
name|hcomsearch
parameter_list|(
name|str
parameter_list|)
comment|/**/
name|char
modifier|*
name|str
decl_stmt|;
block|{
name|int
name|t0
decl_stmt|;
name|char
modifier|*
name|hs
decl_stmt|;
for|for
control|(
name|t0
operator|=
name|curhist
operator|-
literal|1
init|;
name|hs
operator|=
name|quietgetevent
argument_list|(
name|t0
argument_list|)
condition|;
name|t0
operator|--
control|)
if|if
condition|(
operator|!
name|strncmp
argument_list|(
name|hs
argument_list|,
name|str
argument_list|,
name|strlen
argument_list|(
name|str
argument_list|)
argument_list|)
condition|)
return|return
name|t0
return|;
return|return
operator|-
literal|1
return|;
block|}
end_function

begin_comment
comment|/* various utilities for : modifiers */
end_comment

begin_function
name|int
name|remtpath
parameter_list|(
name|junkptr
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|junkptr
decl_stmt|;
block|{
name|char
modifier|*
name|str
init|=
operator|*
name|junkptr
decl_stmt|,
modifier|*
name|cut
decl_stmt|;
if|if
condition|(
name|cut
operator|=
name|strrchr
argument_list|(
name|str
argument_list|,
literal|'/'
argument_list|)
condition|)
block|{
if|if
condition|(
name|str
operator|!=
name|cut
condition|)
operator|*
name|cut
operator|=
literal|'\0'
expr_stmt|;
else|else
name|str
index|[
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|remtext
parameter_list|(
name|junkptr
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|junkptr
decl_stmt|;
block|{
name|char
modifier|*
name|str
init|=
operator|*
name|junkptr
decl_stmt|,
modifier|*
name|cut
decl_stmt|;
if|if
condition|(
operator|(
name|cut
operator|=
name|strrchr
argument_list|(
name|str
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|&&
name|cut
operator|!=
name|str
condition|)
block|{
operator|*
name|cut
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|rembutext
parameter_list|(
name|junkptr
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|junkptr
decl_stmt|;
block|{
name|char
modifier|*
name|str
init|=
operator|*
name|junkptr
decl_stmt|,
modifier|*
name|cut
decl_stmt|;
if|if
condition|(
operator|(
name|cut
operator|=
name|strrchr
argument_list|(
name|str
argument_list|,
literal|'.'
argument_list|)
operator|)
operator|&&
name|cut
operator|!=
name|str
condition|)
block|{
operator|*
name|junkptr
operator|=
name|strdup
argument_list|(
name|cut
operator|+
literal|1
argument_list|)
expr_stmt|;
comment|/* .xx or xx? */
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|remlpaths
parameter_list|(
name|junkptr
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|junkptr
decl_stmt|;
block|{
name|char
modifier|*
name|str
init|=
operator|*
name|junkptr
decl_stmt|,
modifier|*
name|cut
decl_stmt|;
if|if
condition|(
name|cut
operator|=
name|strrchr
argument_list|(
name|str
argument_list|,
literal|'/'
argument_list|)
condition|)
block|{
operator|*
name|cut
operator|=
literal|'\0'
expr_stmt|;
operator|*
name|junkptr
operator|=
name|strdup
argument_list|(
name|cut
operator|+
literal|1
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|makeuppercase
parameter_list|(
name|junkptr
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|junkptr
decl_stmt|;
block|{
name|char
modifier|*
name|str
init|=
operator|*
name|junkptr
decl_stmt|;
for|for
control|(
init|;
operator|*
name|str
condition|;
name|str
operator|++
control|)
operator|*
name|str
operator|=
name|tuupper
argument_list|(
operator|*
name|str
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|int
name|makelowercase
parameter_list|(
name|junkptr
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|junkptr
decl_stmt|;
block|{
name|char
modifier|*
name|str
init|=
operator|*
name|junkptr
decl_stmt|;
for|for
control|(
init|;
operator|*
name|str
condition|;
name|str
operator|++
control|)
operator|*
name|str
operator|=
name|tulower
argument_list|(
operator|*
name|str
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
end_function

begin_function
name|void
name|subst
parameter_list|(
name|strptr
parameter_list|,
name|in
parameter_list|,
name|out
parameter_list|,
name|gbal
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|strptr
decl_stmt|;
name|char
modifier|*
name|in
decl_stmt|;
name|char
modifier|*
name|out
decl_stmt|;
name|int
name|gbal
decl_stmt|;
block|{
name|char
modifier|*
name|str
init|=
operator|*
name|strptr
decl_stmt|,
modifier|*
name|cut
decl_stmt|,
modifier|*
name|sptr
decl_stmt|;
name|int
name|off
decl_stmt|;
while|while
condition|(
name|cut
operator|=
operator|(
name|char
operator|*
operator|)
name|ztrstr
argument_list|(
name|str
argument_list|,
name|in
argument_list|)
condition|)
block|{
operator|*
name|cut
operator|=
literal|'\0'
expr_stmt|;
name|sptr
operator|=
name|convamps
argument_list|(
name|out
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|off
operator|=
name|cut
operator|-
operator|*
name|strptr
operator|+
name|strlen
argument_list|(
name|sptr
argument_list|)
expr_stmt|;
name|cut
operator|+=
name|strlen
argument_list|(
name|in
argument_list|)
expr_stmt|;
operator|*
name|strptr
operator|=
name|tricat
argument_list|(
operator|*
name|strptr
argument_list|,
name|sptr
argument_list|,
name|cut
argument_list|)
expr_stmt|;
if|if
condition|(
name|gbal
condition|)
block|{
name|str
operator|=
operator|(
name|char
operator|*
operator|)
operator|*
name|strptr
operator|+
name|off
expr_stmt|;
continue|continue;
block|}
break|break;
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|convamps
parameter_list|(
name|out
parameter_list|,
name|in
parameter_list|)
comment|/**/
name|char
modifier|*
name|out
decl_stmt|;
name|char
modifier|*
name|in
decl_stmt|;
block|{
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|ret
decl_stmt|,
modifier|*
name|pp
decl_stmt|;
name|int
name|slen
decl_stmt|,
name|inlen
init|=
name|strlen
argument_list|(
name|in
argument_list|)
decl_stmt|;
for|for
control|(
name|ptr
operator|=
name|out
operator|,
name|slen
operator|=
literal|0
init|;
operator|*
name|ptr
condition|;
name|ptr
operator|++
operator|,
name|slen
operator|++
control|)
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'\\'
condition|)
name|ptr
operator|++
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'&'
condition|)
name|slen
operator|+=
name|inlen
operator|-
literal|1
expr_stmt|;
name|ret
operator|=
name|pp
operator|=
name|alloc
argument_list|(
name|slen
operator|+
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|ptr
operator|=
name|out
init|;
operator|*
name|ptr
condition|;
name|ptr
operator|++
control|)
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'\\'
condition|)
operator|*
name|pp
operator|++
operator|=
operator|*
operator|++
name|ptr
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'&'
condition|)
block|{
name|strcpy
argument_list|(
name|pp
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|pp
operator|+=
name|inlen
expr_stmt|;
block|}
else|else
operator|*
name|pp
operator|++
operator|=
operator|*
name|ptr
expr_stmt|;
operator|*
name|pp
operator|=
literal|'\0'
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|makehstr
parameter_list|(
name|s
parameter_list|)
comment|/**/
name|char
modifier|*
name|s
decl_stmt|;
block|{
name|char
modifier|*
name|t
decl_stmt|;
name|t
operator|=
name|s
operator|=
name|strdup
argument_list|(
name|s
argument_list|)
expr_stmt|;
for|for
control|(
init|;
operator|*
name|t
condition|;
name|t
operator|++
control|)
if|if
condition|(
operator|*
name|t
operator|==
name|HISTSPACE
condition|)
operator|*
name|t
operator|=
literal|' '
expr_stmt|;
return|return
name|s
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|quietgetevent
parameter_list|(
name|ev
parameter_list|)
comment|/**/
name|int
name|ev
decl_stmt|;
block|{
name|Histent
name|ent
decl_stmt|;
if|if
condition|(
name|ev
operator|<
name|firsthist
argument_list|()
condition|)
return|return
name|NULL
return|;
name|ent
operator|=
name|gethistent
argument_list|(
name|ev
argument_list|)
expr_stmt|;
return|return
operator|(
name|lithist
operator|)
condition|?
name|ent
operator|->
name|lit
else|:
name|ent
operator|->
name|lex
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|getevent
parameter_list|(
name|ev
parameter_list|)
comment|/**/
name|int
name|ev
decl_stmt|;
block|{
name|char
modifier|*
name|ret
decl_stmt|;
name|ret
operator|=
name|quietgetevent
argument_list|(
name|ev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|ret
condition|)
block|{
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"no such event: %d"
argument_list|,
name|NULL
argument_list|,
name|ev
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
end_function

begin_function
name|int
name|getargc
parameter_list|(
name|list
parameter_list|)
comment|/**/
name|char
modifier|*
name|list
decl_stmt|;
block|{
name|int
name|argc
init|=
literal|0
decl_stmt|;
for|for
control|(
init|;
operator|*
name|list
condition|;
name|list
operator|++
control|)
if|if
condition|(
operator|*
name|list
operator|==
name|HISTSPACE
condition|)
name|argc
operator|++
expr_stmt|;
return|return
name|argc
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|getargs
parameter_list|(
name|elist
parameter_list|,
name|arg1
parameter_list|,
name|arg2
parameter_list|)
comment|/**/
name|char
modifier|*
name|elist
decl_stmt|;
name|int
name|arg1
decl_stmt|;
name|int
name|arg2
decl_stmt|;
block|{
name|char
modifier|*
name|ret
init|=
name|elist
decl_stmt|,
modifier|*
name|retn
decl_stmt|;
name|int
name|acnt
init|=
name|arg2
operator|-
name|arg1
operator|+
literal|1
decl_stmt|;
while|while
condition|(
name|arg1
operator|--
condition|)
while|while
condition|(
operator|*
name|ret
operator|&&
operator|*
name|ret
operator|++
operator|!=
name|HISTSPACE
condition|)
empty_stmt|;
if|if
condition|(
operator|!
operator|*
name|ret
condition|)
block|{
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"no such word in event"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
name|retn
operator|=
name|ret
operator|=
name|strdup
argument_list|(
name|ret
argument_list|)
expr_stmt|;
while|while
condition|(
name|acnt
operator|>
literal|0
condition|)
block|{
while|while
condition|(
operator|*
name|ret
operator|&&
operator|*
name|ret
operator|!=
name|HISTSPACE
condition|)
name|ret
operator|++
expr_stmt|;
if|if
condition|(
operator|*
name|ret
operator|==
name|HISTSPACE
condition|)
operator|*
name|ret
operator|=
literal|' '
expr_stmt|;
else|else
break|break;
name|acnt
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|acnt
operator|>
literal|1
operator|&&
operator|!
operator|*
name|ret
condition|)
block|{
name|herrflush
argument_list|()
expr_stmt|;
name|zerr
argument_list|(
literal|"no such word in event"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
operator|*
name|ret
operator|=
literal|'\0'
expr_stmt|;
return|return
name|retn
return|;
block|}
end_function

begin_function
name|void
name|upcase
parameter_list|(
name|x
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|x
decl_stmt|;
block|{
name|char
modifier|*
name|pp
init|=
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|x
decl_stmt|;
for|for
control|(
init|;
operator|*
name|pp
condition|;
name|pp
operator|++
control|)
operator|*
name|pp
operator|=
name|tuupper
argument_list|(
operator|*
name|pp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|downcase
parameter_list|(
name|x
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|x
decl_stmt|;
block|{
name|char
modifier|*
name|pp
init|=
operator|*
operator|(
name|char
operator|*
operator|*
operator|)
name|x
decl_stmt|;
for|for
control|(
init|;
operator|*
name|pp
condition|;
name|pp
operator|++
control|)
operator|*
name|pp
operator|=
name|tulower
argument_list|(
operator|*
name|pp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|quote
parameter_list|(
name|tr
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|tr
decl_stmt|;
block|{
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|rptr
decl_stmt|,
modifier|*
modifier|*
name|str
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|tr
decl_stmt|;
name|int
name|len
init|=
literal|3
decl_stmt|;
for|for
control|(
name|ptr
operator|=
operator|*
name|str
init|;
operator|*
name|ptr
condition|;
name|ptr
operator|++
operator|,
name|len
operator|++
control|)
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'\''
condition|)
name|len
operator|+=
literal|3
expr_stmt|;
name|ptr
operator|=
operator|*
name|str
expr_stmt|;
operator|*
name|str
operator|=
name|rptr
operator|=
name|alloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
for|for
control|(
init|;
operator|*
name|ptr
condition|;
name|ptr
operator|++
control|)
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'\''
condition|)
block|{
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\\'
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
block|}
else|else
operator|*
name|rptr
operator|++
operator|=
operator|*
name|ptr
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|0
expr_stmt|;
name|str
index|[
literal|1
index|]
operator|=
name|NULL
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|quotebreak
parameter_list|(
name|tr
parameter_list|)
comment|/**/
name|char
modifier|*
modifier|*
name|tr
decl_stmt|;
block|{
name|char
modifier|*
name|ptr
decl_stmt|,
modifier|*
name|rptr
decl_stmt|,
modifier|*
modifier|*
name|str
init|=
operator|(
name|char
operator|*
operator|*
operator|)
name|tr
decl_stmt|;
name|int
name|len
init|=
literal|3
decl_stmt|;
for|for
control|(
name|ptr
operator|=
operator|*
name|str
init|;
operator|*
name|ptr
condition|;
name|ptr
operator|++
operator|,
name|len
operator|++
control|)
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'\''
condition|)
name|len
operator|+=
literal|3
expr_stmt|;
elseif|else
if|if
condition|(
name|inblank
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
name|len
operator|+=
literal|2
expr_stmt|;
name|ptr
operator|=
operator|*
name|str
expr_stmt|;
operator|*
name|str
operator|=
name|rptr
operator|=
name|alloc
argument_list|(
name|len
argument_list|)
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
for|for
control|(
init|;
operator|*
name|ptr
condition|;
control|)
if|if
condition|(
operator|*
name|ptr
operator|==
literal|'\''
condition|)
block|{
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\\'
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
name|ptr
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|inblank
argument_list|(
operator|*
name|ptr
argument_list|)
condition|)
block|{
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
block|}
else|else
operator|*
name|rptr
operator|++
operator|=
operator|*
name|ptr
operator|++
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\''
expr_stmt|;
operator|*
name|rptr
operator|++
operator|=
literal|'\0'
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|void
name|herrflush
parameter_list|()
comment|/**/
block|{
if|if
condition|(
name|strin
condition|)
name|hflush
argument_list|()
expr_stmt|;
else|else
while|while
condition|(
name|lastc
operator|!=
literal|'\n'
operator|&&
operator|!
name|lexstop
condition|)
name|hgetch
argument_list|()
expr_stmt|;
block|}
end_function

begin_comment
comment|/* read an arbitrary amount of data into a buffer until stop is found */
end_comment

begin_function
name|char
modifier|*
name|hdynread
parameter_list|(
name|stop
parameter_list|)
comment|/**/
name|int
name|stop
decl_stmt|;
block|{
name|int
name|bsiz
init|=
literal|256
decl_stmt|,
name|ct
init|=
literal|0
decl_stmt|,
name|c
decl_stmt|;
name|char
modifier|*
name|buf
init|=
name|zalloc
argument_list|(
name|bsiz
argument_list|)
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|hgetch
argument_list|()
operator|)
operator|!=
name|stop
operator|&&
name|c
operator|!=
literal|'\n'
operator|&&
operator|!
name|lexstop
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|c
expr_stmt|;
if|if
condition|(
operator|++
name|ct
operator|==
name|bsiz
condition|)
block|{
name|buf
operator|=
name|realloc
argument_list|(
name|buf
argument_list|,
name|bsiz
operator|*=
literal|2
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|buf
operator|+
name|ct
expr_stmt|;
block|}
block|}
operator|*
name|ptr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
block|{
name|hungetch
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
name|zerr
argument_list|(
literal|"delimiter expected"
argument_list|,
name|NULL
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|buf
argument_list|)
expr_stmt|;
return|return
name|NULL
return|;
block|}
return|return
name|buf
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|hdynread2
parameter_list|(
name|stop
parameter_list|)
comment|/**/
name|int
name|stop
decl_stmt|;
block|{
name|int
name|bsiz
init|=
literal|256
decl_stmt|,
name|ct
init|=
literal|0
decl_stmt|,
name|c
decl_stmt|;
name|char
modifier|*
name|buf
init|=
name|zalloc
argument_list|(
name|bsiz
argument_list|)
decl_stmt|,
modifier|*
name|ptr
decl_stmt|;
name|ptr
operator|=
name|buf
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
name|hgetch
argument_list|()
operator|)
operator|!=
name|stop
operator|&&
name|c
operator|!=
literal|'\n'
operator|&&
operator|!
name|lexstop
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
block|{
name|hungetch
argument_list|(
name|c
argument_list|)
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
name|c
operator|=
name|hgetch
argument_list|()
expr_stmt|;
operator|*
name|ptr
operator|++
operator|=
name|c
expr_stmt|;
if|if
condition|(
operator|++
name|ct
operator|==
name|bsiz
condition|)
block|{
name|buf
operator|=
name|realloc
argument_list|(
name|buf
argument_list|,
name|bsiz
operator|*=
literal|2
argument_list|)
expr_stmt|;
name|ptr
operator|=
name|buf
operator|+
name|ct
expr_stmt|;
block|}
block|}
operator|*
name|ptr
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\n'
condition|)
name|hungetch
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
return|return
name|buf
return|;
block|}
end_function

begin_function
name|void
name|inithist
parameter_list|()
comment|/**/
block|{
name|hp_lit
operator|=
name|zalloc
argument_list|(
sizeof|sizeof
expr|*
name|hp_lit
argument_list|)
expr_stmt|;
name|hp_lit
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|hp_lit
operator|->
name|ptr
operator|=
name|hp_lit
operator|->
name|pool
operator|=
name|zalloc
argument_list|(
name|HEAPSIZE
argument_list|)
expr_stmt|;
name|hp_lit
operator|->
name|free
operator|=
name|HEAPSIZE
expr_stmt|;
name|hp_lex
operator|=
name|zalloc
argument_list|(
sizeof|sizeof
expr|*
name|hp_lex
argument_list|)
expr_stmt|;
name|hp_lex
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
name|hp_lex
operator|->
name|ptr
operator|=
name|hp_lex
operator|->
name|pool
operator|=
name|zalloc
argument_list|(
name|HEAPSIZE
argument_list|)
expr_stmt|;
name|hp_lex
operator|->
name|free
operator|=
name|HEAPSIZE
expr_stmt|;
name|histentct
operator|=
operator|(
name|lithistsiz
operator|>
name|histsiz
operator|)
condition|?
name|lithistsiz
else|:
name|histsiz
expr_stmt|;
name|histentarr
operator|=
name|zcalloc
argument_list|(
name|histentct
operator|*
sizeof|sizeof
expr|*
name|histentarr
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|resizehistents
parameter_list|()
comment|/**/
block|{
name|int
name|newentct
decl_stmt|,
name|t0
decl_stmt|,
name|t1
decl_stmt|,
name|firstlit
decl_stmt|,
name|firstlex
decl_stmt|;
name|Histent
name|newarr
decl_stmt|;
name|newentct
operator|=
operator|(
name|lithistsiz
operator|>
name|histsiz
operator|)
condition|?
name|lithistsiz
else|:
name|histsiz
expr_stmt|;
name|newarr
operator|=
name|zcalloc
argument_list|(
name|newentct
operator|*
sizeof|sizeof
expr|*
name|newarr
argument_list|)
expr_stmt|;
name|firstlex
operator|=
name|curhist
operator|-
name|histsiz
operator|+
literal|1
expr_stmt|;
name|firstlit
operator|=
name|curhist
operator|-
name|lithistsiz
operator|+
literal|1
expr_stmt|;
name|t0
operator|=
name|firsthist
argument_list|()
expr_stmt|;
if|if
condition|(
name|t0
operator|<
name|curhist
operator|-
name|newentct
condition|)
name|t0
operator|=
name|curhist
operator|-
name|newentct
expr_stmt|;
name|t1
operator|=
name|t0
operator|%
name|newentct
expr_stmt|;
for|for
control|(
init|;
name|t0
operator|<=
name|curhist
condition|;
name|t0
operator|++
control|)
block|{
name|newarr
index|[
name|t1
index|]
operator|=
operator|*
name|gethistent
argument_list|(
name|t0
argument_list|)
expr_stmt|;
if|if
condition|(
name|t0
operator|<
name|firstlex
condition|)
name|newarr
index|[
name|t1
index|]
operator|.
name|lex
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
name|t0
operator|<
name|firstlit
condition|)
name|newarr
index|[
name|t1
index|]
operator|.
name|lit
operator|=
name|NULL
expr_stmt|;
name|t1
operator|++
expr_stmt|;
if|if
condition|(
name|t1
operator|==
name|newentct
condition|)
name|t1
operator|=
literal|0
expr_stmt|;
block|}
name|free
argument_list|(
name|histentarr
argument_list|)
expr_stmt|;
name|histentarr
operator|=
name|newarr
expr_stmt|;
name|histentct
operator|=
name|newentct
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|hp_alloc
parameter_list|(
name|hp
parameter_list|,
name|siz
parameter_list|)
comment|/**/
name|Hp
modifier|*
name|hp
decl_stmt|;
name|int
name|siz
decl_stmt|;
block|{
name|char
modifier|*
name|ret
decl_stmt|;
name|Hp
name|h
init|=
operator|*
name|hp
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|free
operator|>=
name|siz
condition|)
block|{
name|ret
operator|=
name|h
operator|->
name|ptr
expr_stmt|;
name|h
operator|->
name|ptr
operator|+=
name|siz
expr_stmt|;
name|h
operator|->
name|free
operator|-=
name|siz
expr_stmt|;
return|return
name|ret
return|;
block|}
ifdef|#
directive|ifdef
name|MEMDEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"new heap (siz = %d, curhist = %d)\n"
argument_list|,
name|siz
argument_list|,
name|curhist
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|permalloc
argument_list|()
expr_stmt|;
name|h
operator|=
name|zalloc
argument_list|(
sizeof|sizeof
expr|*
name|h
argument_list|)
expr_stmt|;
name|h
operator|->
name|next
operator|=
operator|*
name|hp
expr_stmt|;
name|h
operator|->
name|free
operator|=
operator|(
name|siz
operator|>
name|HEAPSIZE
operator|)
condition|?
name|siz
else|:
name|HEAPSIZE
expr_stmt|;
name|h
operator|->
name|ptr
operator|=
name|h
operator|->
name|pool
operator|=
name|zalloc
argument_list|(
name|h
operator|->
name|free
argument_list|)
expr_stmt|;
name|h
operator|->
name|histno
operator|=
name|curhist
expr_stmt|;
operator|*
name|hp
operator|=
name|h
expr_stmt|;
name|heapalloc
argument_list|()
expr_stmt|;
return|return
name|hp_alloc
argument_list|(
name|hp
argument_list|,
name|siz
argument_list|)
return|;
block|}
end_function

begin_function
name|char
modifier|*
name|hp_realloc
parameter_list|(
name|hp
parameter_list|,
name|ptr
parameter_list|,
name|oldsiz
parameter_list|,
name|newsiz
parameter_list|)
comment|/**/
name|Hp
modifier|*
name|hp
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|oldsiz
decl_stmt|;
name|int
name|newsiz
decl_stmt|;
block|{
name|Hp
name|h
init|=
operator|*
name|hp
decl_stmt|;
name|int
name|delta
init|=
name|newsiz
operator|-
name|oldsiz
decl_stmt|;
name|char
modifier|*
name|ret
decl_stmt|;
if|if
condition|(
name|h
operator|->
name|ptr
operator|-
name|oldsiz
operator|==
name|ptr
operator|&&
name|h
operator|->
name|free
operator|>=
name|delta
condition|)
block|{
name|h
operator|->
name|free
operator|-=
name|delta
expr_stmt|;
name|h
operator|->
name|ptr
operator|+=
name|delta
expr_stmt|;
return|return
name|ptr
return|;
block|}
ifdef|#
directive|ifdef
name|MEMDEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"realloc copy\n"
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|memcpy
argument_list|(
name|ret
operator|=
name|hp_alloc
argument_list|(
name|hp
argument_list|,
name|newsiz
argument_list|)
argument_list|,
name|ptr
argument_list|,
name|oldsiz
argument_list|)
expr_stmt|;
return|return
name|ret
return|;
block|}
end_function

begin_function
name|void
name|hp_free
parameter_list|(
name|h
parameter_list|,
name|ptr
parameter_list|,
name|siz
parameter_list|)
comment|/**/
name|Hp
name|h
decl_stmt|;
name|char
modifier|*
name|ptr
decl_stmt|;
name|int
name|siz
decl_stmt|;
block|{
if|if
condition|(
name|h
operator|->
name|ptr
operator|-
name|siz
operator|==
name|ptr
condition|)
block|{
name|h
operator|->
name|free
operator|+=
name|siz
expr_stmt|;
name|h
operator|->
name|ptr
operator|-=
name|siz
expr_stmt|;
block|}
block|}
end_function

begin_function
name|char
modifier|*
name|hp_concat
parameter_list|(
name|old
parameter_list|,
name|new
parameter_list|)
comment|/**/
name|char
modifier|*
name|old
decl_stmt|;
name|char
modifier|*
name|new
decl_stmt|;
block|{
name|int
name|oldlen
decl_stmt|,
name|newlen
decl_stmt|;
name|oldlen
operator|=
name|strlen
argument_list|(
name|old
argument_list|)
expr_stmt|;
name|newlen
operator|=
name|strlen
argument_list|(
name|new
argument_list|)
expr_stmt|;
name|old
operator|=
name|hp_realloc
argument_list|(
operator|&
name|hp_lit
argument_list|,
name|old
argument_list|,
name|oldlen
operator|+
literal|1
argument_list|,
name|oldlen
operator|+
name|newlen
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|old
operator|+
name|oldlen
argument_list|,
name|new
argument_list|)
expr_stmt|;
return|return
name|old
return|;
block|}
end_function

begin_function
name|void
name|hp_purge
parameter_list|(
name|h
parameter_list|,
name|lim
parameter_list|)
comment|/**/
name|Hp
name|h
decl_stmt|;
name|int
name|lim
decl_stmt|;
block|{
name|Hp
name|hlast
decl_stmt|;
if|if
condition|(
operator|!
name|h
operator|->
name|next
condition|)
return|return;
while|while
condition|(
name|h
operator|->
name|next
condition|)
block|{
name|hlast
operator|=
name|h
expr_stmt|;
name|h
operator|=
name|h
operator|->
name|next
expr_stmt|;
block|}
if|if
condition|(
name|h
operator|->
name|histno
operator|<=
name|lim
operator|||
name|h
operator|->
name|histno
operator|==
literal|0
condition|)
block|{
ifdef|#
directive|ifdef
name|MEMDEBUG
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"purging %d\n"
argument_list|,
name|lim
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|free
argument_list|(
name|h
operator|->
name|pool
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|h
argument_list|)
expr_stmt|;
name|hlast
operator|->
name|next
operator|=
name|NULL
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|readhistfile
parameter_list|(
name|s
parameter_list|,
name|err
parameter_list|)
comment|/**/
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|err
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
name|FILE
modifier|*
name|in
decl_stmt|;
name|Histent
name|ent
decl_stmt|;
name|time_t
name|tim
init|=
name|time
argument_list|(
name|NULL
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|s
condition|)
return|return;
if|if
condition|(
name|in
operator|=
name|fopen
argument_list|(
name|s
argument_list|,
literal|"r"
argument_list|)
condition|)
block|{
while|while
condition|(
name|fgets
argument_list|(
name|buf
argument_list|,
literal|1024
argument_list|,
name|in
argument_list|)
condition|)
block|{
name|int
name|l
init|=
name|strlen
argument_list|(
name|buf
argument_list|)
decl_stmt|;
name|char
modifier|*
name|pt
init|=
name|buf
decl_stmt|;
while|while
condition|(
name|l
operator|&&
name|buf
index|[
name|l
operator|-
literal|1
index|]
operator|==
literal|'\n'
condition|)
block|{
name|buf
index|[
name|l
operator|-
literal|1
index|]
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|l
operator|>
literal|1
operator|&&
name|buf
index|[
name|l
operator|-
literal|2
index|]
operator|==
literal|'\\'
condition|)
block|{
name|buf
index|[
name|l
operator|-
literal|2
index|]
operator|=
literal|'\n'
expr_stmt|;
name|fgets
argument_list|(
name|buf
operator|+
name|l
operator|-
literal|1
argument_list|,
literal|1024
operator|-
operator|(
name|l
operator|-
literal|1
operator|)
argument_list|,
name|in
argument_list|)
expr_stmt|;
name|l
operator|=
name|strlen
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
else|else
break|break;
block|}
for|for
control|(
init|;
operator|*
name|pt
condition|;
name|pt
operator|++
control|)
if|if
condition|(
operator|*
name|pt
operator|==
literal|' '
condition|)
operator|*
name|pt
operator|=
name|HISTSPACE
expr_stmt|;
name|ent
operator|=
name|gethistent
argument_list|(
operator|++
name|curhist
argument_list|)
expr_stmt|;
name|ent
operator|->
name|lex
operator|=
name|hp_alloc
argument_list|(
operator|&
name|hp_lex
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ent
operator|->
name|lex
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ent
operator|->
name|lit
operator|=
name|hp_alloc
argument_list|(
operator|&
name|hp_lit
argument_list|,
name|strlen
argument_list|(
name|buf
argument_list|)
operator|+
literal|1
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|ent
operator|->
name|lit
argument_list|,
name|buf
argument_list|)
expr_stmt|;
name|ent
operator|->
name|ftim
operator|=
name|ent
operator|->
name|stim
operator|=
name|tim
expr_stmt|;
block|}
name|fclose
argument_list|(
name|in
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|err
condition|)
name|zerr
argument_list|(
literal|"can't read history file"
argument_list|,
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|savehistfile
parameter_list|(
name|s
parameter_list|,
name|err
parameter_list|,
name|app
parameter_list|)
comment|/**/
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|err
decl_stmt|;
name|int
name|app
decl_stmt|;
block|{
name|char
modifier|*
name|t
decl_stmt|;
name|FILE
modifier|*
name|out
decl_stmt|;
name|int
name|ev
decl_stmt|,
name|flag
decl_stmt|;
if|if
condition|(
operator|!
name|s
operator|||
operator|!
name|interact
condition|)
return|return;
name|ev
operator|=
name|curhist
operator|-
name|savehist
operator|+
literal|1
expr_stmt|;
name|flag
operator|=
operator|(
name|app
operator|)
condition|?
name|O_APPEND
else|:
name|O_TRUNC
expr_stmt|;
if|if
condition|(
name|ev
operator|<
name|firsthist
argument_list|()
condition|)
name|ev
operator|=
name|firsthist
argument_list|()
expr_stmt|;
if|if
condition|(
name|out
operator|=
name|fdopen
argument_list|(
name|open
argument_list|(
name|s
argument_list|,
name|O_CREAT
operator||
name|O_WRONLY
operator||
name|flag
argument_list|,
literal|0600
argument_list|)
argument_list|,
literal|"w"
argument_list|)
condition|)
block|{
for|for
control|(
init|;
name|ev
operator|<=
name|curhist
condition|;
name|ev
operator|++
control|)
block|{
name|t
operator|=
name|quietgetevent
argument_list|(
name|ev
argument_list|)
expr_stmt|;
for|for
control|(
init|;
operator|*
name|t
condition|;
name|t
operator|++
control|)
if|if
condition|(
operator|*
name|t
operator|==
name|HISTSPACE
condition|)
name|fputc
argument_list|(
literal|' '
argument_list|,
name|out
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|*
name|t
operator|==
literal|'\n'
condition|)
name|fputc
argument_list|(
literal|'\\'
argument_list|,
name|out
argument_list|)
expr_stmt|;
name|fputc
argument_list|(
operator|*
name|t
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
name|fputc
argument_list|(
literal|'\n'
argument_list|,
name|out
argument_list|)
expr_stmt|;
block|}
name|fclose
argument_list|(
name|out
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|err
condition|)
name|zerr
argument_list|(
literal|"can't write history file: %s"
argument_list|,
name|s
argument_list|,
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|int
name|firsthist
parameter_list|()
comment|/**/
block|{
name|int
name|ev
decl_stmt|;
name|Histent
name|ent
decl_stmt|;
name|ev
operator|=
name|curhist
operator|-
name|histentct
operator|+
literal|1
expr_stmt|;
if|if
condition|(
name|ev
operator|<
literal|1
condition|)
name|ev
operator|=
literal|1
expr_stmt|;
do|do
block|{
name|ent
operator|=
name|gethistent
argument_list|(
name|ev
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|lithist
operator|)
condition|?
name|ent
operator|->
name|lit
else|:
name|ent
operator|->
name|lex
condition|)
break|break;
name|ev
operator|++
expr_stmt|;
block|}
do|while
condition|(
name|ev
operator|<
name|curhist
condition|)
do|;
return|return
name|ev
return|;
block|}
end_function

end_unit


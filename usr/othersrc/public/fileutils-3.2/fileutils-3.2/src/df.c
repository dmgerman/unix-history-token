begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* df - summarize free disk space    Copyright (C) 1991 Free Software Foundation, Inc.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2, or (at your option)    any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_comment
comment|/* Usage: df [-aikP] [-t fstype] [--all] [--inodes] [--type fstype]    [--kilobytes] [--portability] [path...]     Options:    -a, --all		List all filesystems, even zero-size ones.    -i, --inodes		List inode usage information instead of block usage.    -k, --kilobytes	Print sizes in 1K blocks instead of 512-byte blocks.    -P, --portability	Use the POSIX output format (one line per filesystem).    -t, --type fstype	Limit the listing to filesystems of type `fstype'. 			Multiple -t options can be given. 			By default, all filesystem types are listed.     Written by David MacKenzie<djm@gnu.ai.mit.edu> */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|"mountlist.h"
end_include

begin_include
include|#
directive|include
file|"fsusage.h"
end_include

begin_include
include|#
directive|include
file|"system.h"
end_include

begin_function_decl
name|char
modifier|*
name|strstr
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|xmalloc
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|char
modifier|*
name|xstrdup
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
name|fs_to_list
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|add_fs_type
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|error
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|print_header
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|show_entry
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|show_all_entries
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|show_dev
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|show_disk
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|show_point
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|usage
parameter_list|()
function_decl|;
end_function_decl

begin_comment
comment|/* If nonzero, show inode information. */
end_comment

begin_decl_stmt
name|int
name|inode_format
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* If nonzero, show even filesystems with zero size or    uninteresting types. */
end_comment

begin_decl_stmt
name|int
name|show_all_fs
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* If nonzero, use 1K blocks instead of 512-byte blocks. */
end_comment

begin_decl_stmt
name|int
name|kilobyte_blocks
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* If nonzero, use the POSIX output format.  */
end_comment

begin_decl_stmt
name|int
name|posix_format
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Nonzero if errors have occurred. */
end_comment

begin_decl_stmt
name|int
name|exit_status
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Name this program was run with. */
end_comment

begin_decl_stmt
name|char
modifier|*
name|program_name
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* A filesystem type to display. */
end_comment

begin_struct
struct|struct
name|fs_select
block|{
name|char
modifier|*
name|fs_name
decl_stmt|;
name|struct
name|fs_select
modifier|*
name|fs_next
decl_stmt|;
block|}
struct|;
end_struct

begin_comment
comment|/* Linked list of filesystem types to display.    If `fs_list' is NULL, list all types.    This table is generated dynamically from command-line options,    rather than hardcoding into the program what it thinks are the    valid filesystem types; let the user specify any filesystem type    they want to, and if there are any filesystems of that type, they    will be shown.     Some filesystem types:    4.2 4.3 ufs nfs swap ignore io vm */
end_comment

begin_decl_stmt
name|struct
name|fs_select
modifier|*
name|fs_list
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Linked list of mounted filesystems. */
end_comment

begin_decl_stmt
name|struct
name|mount_entry
modifier|*
name|mount_list
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|option
name|long_options
index|[]
init|=
block|{
block|{
literal|"all"
block|,
literal|0
block|,
operator|&
name|show_all_fs
block|,
literal|1
block|}
block|,
block|{
literal|"inodes"
block|,
literal|0
block|,
operator|&
name|inode_format
block|,
literal|1
block|}
block|,
block|{
literal|"kilobytes"
block|,
literal|0
block|,
operator|&
name|kilobyte_blocks
block|,
literal|1
block|}
block|,
block|{
literal|"portability"
block|,
literal|0
block|,
operator|&
name|posix_format
block|,
literal|1
block|}
block|,
block|{
literal|"type"
block|,
literal|1
block|,
literal|0
block|,
literal|'t'
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|)
name|int
name|argc
decl_stmt|;
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|struct
name|stat
modifier|*
name|stats
decl_stmt|;
name|program_name
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
name|fs_list
operator|=
name|NULL
expr_stmt|;
name|inode_format
operator|=
literal|0
expr_stmt|;
name|show_all_fs
operator|=
literal|0
expr_stmt|;
name|kilobyte_blocks
operator|=
name|getenv
argument_list|(
literal|"POSIXLY_CORRECT"
argument_list|)
operator|==
literal|0
expr_stmt|;
name|posix_format
operator|=
literal|0
expr_stmt|;
name|exit_status
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|i
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"aikPt:v"
argument_list|,
name|long_options
argument_list|,
operator|(
name|int
operator|*
operator|)
literal|0
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|i
condition|)
block|{
case|case
literal|0
case|:
comment|/* Long option. */
break|break;
case|case
literal|'a'
case|:
name|show_all_fs
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
name|inode_format
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'k'
case|:
name|kilobyte_blocks
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|posix_format
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|add_fs_type
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'v'
case|:
comment|/* For SysV compatibility. */
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|optind
operator|!=
name|argc
condition|)
block|{
comment|/* Display explicitly requested empty filesystems. */
name|show_all_fs
operator|=
literal|1
expr_stmt|;
comment|/* stat all the given entries to make sure they get automounted, 	 if necessary, before reading the filesystem table.  */
name|stats
operator|=
operator|(
expr|struct
name|stat
operator|*
operator|)
name|xmalloc
argument_list|(
operator|(
name|argc
operator|-
name|optind
operator|)
operator|*
sizeof|sizeof
argument_list|(
expr|struct
name|stat
argument_list|)
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|optind
init|;
name|i
operator|<
name|argc
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|stat
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|stats
index|[
name|i
operator|-
name|optind
index|]
argument_list|)
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
name|errno
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|exit_status
operator|=
literal|1
expr_stmt|;
name|argv
index|[
name|i
index|]
operator|=
name|NULL
expr_stmt|;
block|}
block|}
name|mount_list
operator|=
name|read_filesystem_list
argument_list|(
name|fs_list
operator|!=
name|NULL
argument_list|,
name|show_all_fs
argument_list|)
expr_stmt|;
if|if
condition|(
name|mount_list
operator|==
name|NULL
condition|)
name|error
argument_list|(
literal|1
argument_list|,
name|errno
argument_list|,
literal|"cannot read table of mounted filesystems"
argument_list|)
expr_stmt|;
name|print_header
argument_list|()
expr_stmt|;
if|if
condition|(
name|optind
operator|==
name|argc
condition|)
name|show_all_entries
argument_list|()
expr_stmt|;
else|else
for|for
control|(
name|i
operator|=
name|optind
init|;
name|i
operator|<
name|argc
condition|;
operator|++
name|i
control|)
if|if
condition|(
name|argv
index|[
name|i
index|]
condition|)
name|show_entry
argument_list|(
name|argv
index|[
name|i
index|]
argument_list|,
operator|&
name|stats
index|[
name|i
operator|-
name|optind
index|]
argument_list|)
expr_stmt|;
name|exit
argument_list|(
name|exit_status
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_function
name|void
name|print_header
parameter_list|()
block|{
if|if
condition|(
name|inode_format
condition|)
name|printf
argument_list|(
literal|"Filesystem             IUsed   IFree  %%IUsed"
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|"Filesystem         %s  Used Available Capacity"
argument_list|,
name|kilobyte_blocks
condition|?
literal|"1024-blocks"
else|:
literal|" 512-blocks"
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|" Mounted on\n"
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Show all mounted filesystems, except perhaps those that are of    an unselected type or are empty. */
end_comment

begin_function
name|void
name|show_all_entries
parameter_list|()
block|{
name|struct
name|mount_entry
modifier|*
name|me
decl_stmt|;
for|for
control|(
name|me
operator|=
name|mount_list
init|;
name|me
condition|;
name|me
operator|=
name|me
operator|->
name|me_next
control|)
name|show_dev
argument_list|(
name|me
operator|->
name|me_devname
argument_list|,
name|me
operator|->
name|me_mountdir
argument_list|,
name|me
operator|->
name|me_type
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Determine what kind of node PATH is and show the disk usage    for it.  STATP is the results of `stat' on PATH.  */
end_comment

begin_function
name|void
name|show_entry
parameter_list|(
name|path
parameter_list|,
name|statp
parameter_list|)
name|char
modifier|*
name|path
decl_stmt|;
name|struct
name|stat
modifier|*
name|statp
decl_stmt|;
block|{
if|if
condition|(
name|S_ISBLK
argument_list|(
name|statp
operator|->
name|st_mode
argument_list|)
operator|||
name|S_ISCHR
argument_list|(
name|statp
operator|->
name|st_mode
argument_list|)
condition|)
name|show_disk
argument_list|(
name|path
argument_list|)
expr_stmt|;
else|else
name|show_point
argument_list|(
name|path
argument_list|,
name|statp
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Identify the directory, if any, that device    DISK is mounted on, and show its disk usage.  */
end_comment

begin_function
name|void
name|show_disk
parameter_list|(
name|disk
parameter_list|)
name|char
modifier|*
name|disk
decl_stmt|;
block|{
name|struct
name|mount_entry
modifier|*
name|me
decl_stmt|;
for|for
control|(
name|me
operator|=
name|mount_list
init|;
name|me
condition|;
name|me
operator|=
name|me
operator|->
name|me_next
control|)
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|disk
argument_list|,
name|me
operator|->
name|me_devname
argument_list|)
condition|)
block|{
name|show_dev
argument_list|(
name|me
operator|->
name|me_devname
argument_list|,
name|me
operator|->
name|me_mountdir
argument_list|,
name|me
operator|->
name|me_type
argument_list|)
expr_stmt|;
return|return;
block|}
comment|/* No filesystem is mounted on DISK. */
name|show_dev
argument_list|(
name|disk
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|,
operator|(
name|char
operator|*
operator|)
name|NULL
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Figure out which device file or directory POINT is mounted on    and show its disk usage.    STATP is the results of `stat' on POINT.  */
end_comment

begin_function
name|void
name|show_point
parameter_list|(
name|point
parameter_list|,
name|statp
parameter_list|)
name|char
modifier|*
name|point
decl_stmt|;
name|struct
name|stat
modifier|*
name|statp
decl_stmt|;
block|{
name|struct
name|stat
name|disk_stats
decl_stmt|;
name|struct
name|mount_entry
modifier|*
name|me
decl_stmt|;
for|for
control|(
name|me
operator|=
name|mount_list
init|;
name|me
condition|;
name|me
operator|=
name|me
operator|->
name|me_next
control|)
block|{
if|if
condition|(
name|me
operator|->
name|me_dev
operator|==
operator|(
name|dev_t
operator|)
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|stat
argument_list|(
name|me
operator|->
name|me_mountdir
argument_list|,
operator|&
name|disk_stats
argument_list|)
operator|==
literal|0
condition|)
name|me
operator|->
name|me_dev
operator|=
name|disk_stats
operator|.
name|st_dev
expr_stmt|;
else|else
block|{
name|error
argument_list|(
literal|0
argument_list|,
name|errno
argument_list|,
literal|"%s"
argument_list|,
name|me
operator|->
name|me_mountdir
argument_list|)
expr_stmt|;
name|exit_status
operator|=
literal|1
expr_stmt|;
name|me
operator|->
name|me_dev
operator|=
operator|-
literal|2
expr_stmt|;
comment|/* So we won't try and fail repeatedly. */
block|}
block|}
if|if
condition|(
name|statp
operator|->
name|st_dev
operator|==
name|me
operator|->
name|me_dev
condition|)
block|{
name|show_dev
argument_list|(
name|me
operator|->
name|me_devname
argument_list|,
name|me
operator|->
name|me_mountdir
argument_list|,
name|me
operator|->
name|me_type
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|error
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|,
literal|"cannot find mount point for %s"
argument_list|,
name|point
argument_list|)
expr_stmt|;
name|exit_status
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Display a space listing for the disk device with absolute path DISK.    If MOUNT_POINT is non-NULL, it is the path of the root of the    filesystem on DISK.    If FSTYPE is non-NULL, it is the type of the filesystem on DISK. */
end_comment

begin_function
name|void
name|show_dev
parameter_list|(
name|disk
parameter_list|,
name|mount_point
parameter_list|,
name|fstype
parameter_list|)
name|char
modifier|*
name|disk
decl_stmt|;
name|char
modifier|*
name|mount_point
decl_stmt|;
name|char
modifier|*
name|fstype
decl_stmt|;
block|{
name|struct
name|fs_usage
name|fsu
decl_stmt|;
name|long
name|blocks_used
decl_stmt|;
name|long
name|blocks_percent_used
decl_stmt|;
name|long
name|inodes_used
decl_stmt|;
name|long
name|inodes_percent_used
decl_stmt|;
name|char
modifier|*
name|stat_file
decl_stmt|;
if|if
condition|(
operator|!
name|fs_to_list
argument_list|(
name|fstype
argument_list|)
condition|)
return|return;
comment|/* If MOUNT_POINT is NULL, then the filesystem is not mounted, and this      program reports on the filesystem that the special file is on.      It would be better to somehow report on the unmounted filesystem,      but statfs doesn't work on those on many systems. */
name|stat_file
operator|=
name|mount_point
condition|?
name|mount_point
else|:
name|disk
expr_stmt|;
name|sync
argument_list|()
expr_stmt|;
if|if
condition|(
name|get_fs_usage
argument_list|(
name|stat_file
argument_list|,
operator|&
name|fsu
argument_list|)
condition|)
block|{
name|error
argument_list|(
literal|0
argument_list|,
name|errno
argument_list|,
literal|"%s"
argument_list|,
name|stat_file
argument_list|)
expr_stmt|;
name|exit_status
operator|=
literal|1
expr_stmt|;
return|return;
block|}
if|if
condition|(
operator|!
name|kilobyte_blocks
condition|)
block|{
name|fsu
operator|.
name|fsu_blocks
operator|*=
literal|2
expr_stmt|;
name|fsu
operator|.
name|fsu_bfree
operator|*=
literal|2
expr_stmt|;
name|fsu
operator|.
name|fsu_bavail
operator|*=
literal|2
expr_stmt|;
block|}
if|if
condition|(
name|fsu
operator|.
name|fsu_blocks
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|show_all_fs
operator|==
literal|0
condition|)
return|return;
name|blocks_used
operator|=
name|fsu
operator|.
name|fsu_bavail
operator|=
name|blocks_percent_used
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|blocks_used
operator|=
name|fsu
operator|.
name|fsu_blocks
operator|-
name|fsu
operator|.
name|fsu_bfree
expr_stmt|;
name|blocks_percent_used
operator|=
call|(
name|long
call|)
argument_list|(
name|blocks_used
operator|*
literal|100.0
operator|/
operator|(
name|blocks_used
operator|+
name|fsu
operator|.
name|fsu_bavail
operator|)
operator|+
literal|0.5
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fsu
operator|.
name|fsu_files
operator|==
literal|0
condition|)
block|{
name|inodes_used
operator|=
name|fsu
operator|.
name|fsu_ffree
operator|=
name|inodes_percent_used
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|inodes_used
operator|=
name|fsu
operator|.
name|fsu_files
operator|-
name|fsu
operator|.
name|fsu_ffree
expr_stmt|;
name|inodes_percent_used
operator|=
call|(
name|long
call|)
argument_list|(
name|inodes_used
operator|*
literal|100.0
operator|/
name|fsu
operator|.
name|fsu_files
operator|+
literal|0.5
argument_list|)
expr_stmt|;
block|}
name|printf
argument_list|(
literal|"%-20s"
argument_list|,
name|disk
argument_list|)
expr_stmt|;
if|if
condition|(
name|strlen
argument_list|(
name|disk
argument_list|)
operator|>
literal|20
operator|&&
operator|!
name|posix_format
condition|)
name|printf
argument_list|(
literal|"\n                    "
argument_list|)
expr_stmt|;
if|if
condition|(
name|inode_format
condition|)
name|printf
argument_list|(
literal|" %7ld %7ld %5ld%%"
argument_list|,
name|inodes_used
argument_list|,
name|fsu
operator|.
name|fsu_ffree
argument_list|,
name|inodes_percent_used
argument_list|)
expr_stmt|;
else|else
name|printf
argument_list|(
literal|" %7ld %7ld  %7ld  %5ld%% "
argument_list|,
name|fsu
operator|.
name|fsu_blocks
argument_list|,
name|blocks_used
argument_list|,
name|fsu
operator|.
name|fsu_bavail
argument_list|,
name|blocks_percent_used
argument_list|)
expr_stmt|;
if|if
condition|(
name|mount_point
condition|)
name|printf
argument_list|(
literal|"  %s"
argument_list|,
name|mount_point
argument_list|)
expr_stmt|;
name|putchar
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
end_function

begin_escape
end_escape

begin_comment
comment|/* Add FSTYPE to the list of filesystem types to display. */
end_comment

begin_function
name|void
name|add_fs_type
parameter_list|(
name|fstype
parameter_list|)
name|char
modifier|*
name|fstype
decl_stmt|;
block|{
name|struct
name|fs_select
modifier|*
name|fsp
decl_stmt|;
name|fsp
operator|=
operator|(
expr|struct
name|fs_select
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
expr|struct
name|fs_select
argument_list|)
argument_list|)
expr_stmt|;
name|fsp
operator|->
name|fs_name
operator|=
name|fstype
expr_stmt|;
name|fsp
operator|->
name|fs_next
operator|=
name|fs_list
expr_stmt|;
name|fs_list
operator|=
name|fsp
expr_stmt|;
block|}
end_function

begin_comment
comment|/* If FSTYPE is a type of filesystem that should be listed,    return nonzero, else zero. */
end_comment

begin_function
name|int
name|fs_to_list
parameter_list|(
name|fstype
parameter_list|)
name|char
modifier|*
name|fstype
decl_stmt|;
block|{
name|struct
name|fs_select
modifier|*
name|fsp
decl_stmt|;
if|if
condition|(
name|fs_list
operator|==
name|NULL
operator|||
name|fstype
operator|==
name|NULL
condition|)
return|return
literal|1
return|;
for|for
control|(
name|fsp
operator|=
name|fs_list
init|;
name|fsp
condition|;
name|fsp
operator|=
name|fsp
operator|->
name|fs_next
control|)
if|if
condition|(
operator|!
name|strcmp
argument_list|(
name|fstype
argument_list|,
name|fsp
operator|->
name|fs_name
argument_list|)
condition|)
return|return
literal|1
return|;
return|return
literal|0
return|;
block|}
end_function

begin_escape
end_escape

begin_function
name|void
name|usage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\ Usage: %s [-aikPv] [-t fstype] [--all] [--inodes] [--type fstype]\n\        [--kilobytes] [--portability] [path...]\n"
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


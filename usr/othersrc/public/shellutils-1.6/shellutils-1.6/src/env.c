begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* env - run a program in a modified environment    Copyright (C) 1986, 1991 Free Software Foundation, Inc.     This program is free software; you can redistribute it and/or modify    it under the terms of the GNU General Public License as published by    the Free Software Foundation; either version 2, or (at your option)    any later version.     This program is distributed in the hope that it will be useful,    but WITHOUT ANY WARRANTY; without even the implied warranty of    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    GNU General Public License for more details.     You should have received a copy of the GNU General Public License    along with this program; if not, write to the Free Software    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.  */
end_comment

begin_comment
comment|/* Richard Mlynarik and David MacKenzie */
end_comment

begin_comment
comment|/* Options:    -    -i    --ignore-environment 	Construct a new environment from scratch; normally the 	environment is inherited from the parent process, except as 	modified by other options.     -u variable    --unset=variable 	Unset variable VARIABLE (remove it from the environment). 	If VARIABLE was not set, does nothing.     variable=value (an arg containing a "=" character) 	Set the environment variable VARIABLE to value VALUE.  VALUE 	may be of zero length ("variable=").  Setting a variable to a 	zero-length value is different from unsetting it.     -- 	Indicate that the following argument is the program 	to invoke.  This is necessary when the program's name 	begins with "-" or contains a "=".     The first remaining argument specifies a program to invoke;    it is searched for according to the specification of the PATH    environment variable.  Any arguments following that are    passed as arguments to that program.     If no command name is specified following the environment    specifications, the resulting environment is printed.    This is like specifying a command name of "printenv".     Examples:     If the environment passed to "env" is 	{ LOGNAME=rms EDITOR=emacs PATH=.:/gnubin:/hacks }     env - foo 	runs "foo" in a null environment.     env foo 	runs "foo" in the environment 	{ LOGNAME=rms EDITOR=emacs PATH=.:/gnubin:/hacks }     env DISPLAY=gnu:0 nemacs 	runs "nemacs" in the envionment 	{ LOGNAME=rms EDITOR=emacs PATH=.:/gnubin:/hacks DISPLAY=gnu:0 }     env - LOGNAME=foo /hacks/hack bar baz 	runs the "hack" program on arguments "bar" and "baz" in an 	environment in which the only variable is "LOGNAME".  Note that 	the "-" option clears out the PATH variable, so one should be 	careful to specify in which directory to find the program to 	call.     env -u EDITOR LOGNAME=foo PATH=/energy -- e=mc2 bar baz 	runs the program "/energy/e=mc2" with environment 	{ LOGNAME=foo PATH=/energy } */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<getopt.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"system.h"
end_include

begin_function_decl
name|int
name|putenv
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|error
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
name|usage
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|extern
name|char
modifier|*
modifier|*
name|environ
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The name by which this program was run. */
end_comment

begin_decl_stmt
name|char
modifier|*
name|program_name
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|struct
name|option
name|longopts
index|[]
init|=
block|{
block|{
literal|"ignore-environment"
block|,
literal|0
block|,
name|NULL
block|,
literal|'i'
block|}
block|,
block|{
literal|"unset"
block|,
literal|1
block|,
name|NULL
block|,
literal|'u'
block|}
block|,
block|{
name|NULL
block|,
literal|0
block|,
name|NULL
block|,
literal|0
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|main
parameter_list|(
name|argc
parameter_list|,
name|argv
parameter_list|,
name|envp
parameter_list|)
specifier|register
name|int
name|argc
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|argv
decl_stmt|;
name|char
modifier|*
modifier|*
name|envp
decl_stmt|;
block|{
name|char
modifier|*
name|dummy_environ
index|[
literal|1
index|]
decl_stmt|;
name|int
name|optc
decl_stmt|;
name|int
name|ignore_environment
init|=
literal|0
decl_stmt|;
name|program_name
operator|=
name|argv
index|[
literal|0
index|]
expr_stmt|;
while|while
condition|(
operator|(
name|optc
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"+iu:"
argument_list|,
name|longopts
argument_list|,
operator|(
name|int
operator|*
operator|)
literal|0
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
block|{
switch|switch
condition|(
name|optc
condition|)
block|{
case|case
literal|'i'
case|:
name|ignore_environment
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
break|break;
default|default:
name|usage
argument_list|()
expr_stmt|;
block|}
block|}
if|if
condition|(
name|optind
operator|!=
name|argc
operator|&&
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"-"
argument_list|)
condition|)
name|ignore_environment
operator|=
literal|1
expr_stmt|;
name|environ
operator|=
name|dummy_environ
expr_stmt|;
name|environ
index|[
literal|0
index|]
operator|=
name|NULL
expr_stmt|;
if|if
condition|(
operator|!
name|ignore_environment
condition|)
for|for
control|(
init|;
operator|*
name|envp
condition|;
name|envp
operator|++
control|)
name|putenv
argument_list|(
operator|*
name|envp
argument_list|)
expr_stmt|;
name|optind
operator|=
literal|0
expr_stmt|;
comment|/* Force GNU getopt to re-initialize. */
while|while
condition|(
operator|(
name|optc
operator|=
name|getopt_long
argument_list|(
name|argc
argument_list|,
name|argv
argument_list|,
literal|"+iu:"
argument_list|,
name|longopts
argument_list|,
operator|(
name|int
operator|*
operator|)
literal|0
argument_list|)
operator|)
operator|!=
name|EOF
condition|)
if|if
condition|(
name|optc
operator|==
literal|'u'
condition|)
name|putenv
argument_list|(
name|optarg
argument_list|)
expr_stmt|;
comment|/* Requires GNU putenv. */
if|if
condition|(
name|optind
operator|!=
name|argc
operator|&&
operator|!
name|strcmp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|"-"
argument_list|)
condition|)
operator|++
name|optind
expr_stmt|;
while|while
condition|(
name|optind
operator|<
name|argc
operator|&&
name|index
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
literal|'='
argument_list|)
condition|)
name|putenv
argument_list|(
name|argv
index|[
name|optind
operator|++
index|]
argument_list|)
expr_stmt|;
comment|/* If no program is specified, print the environment and exit. */
if|if
condition|(
name|optind
operator|==
name|argc
condition|)
block|{
while|while
condition|(
operator|*
name|environ
condition|)
name|puts
argument_list|(
operator|*
name|environ
operator|++
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
name|execvp
argument_list|(
name|argv
index|[
name|optind
index|]
argument_list|,
operator|&
name|argv
index|[
name|optind
index|]
argument_list|)
expr_stmt|;
name|error
argument_list|(
name|errno
operator|==
name|ENOENT
condition|?
literal|127
else|:
literal|126
argument_list|,
name|errno
argument_list|,
literal|"%s"
argument_list|,
name|argv
index|[
name|optind
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|usage
parameter_list|()
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"\ Usage: %s [-] [-i] [-u name] [--ignore-environment] [--unset=name]\n\        [name=value]... [command [args...]]\n"
argument_list|,
name|program_name
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
end_function

end_unit


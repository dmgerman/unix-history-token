begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (c) 1991  *      Juergen Weigert (jnweiger@immd4.informatik.uni-erlangen.de)  *      Michael Schroeder (mlschroe@immd4.informatik.uni-erlangen.de)  * Copyright (c) 1987 Oliver Laumann  * All rights reserved.  Not derived from licensed software.  *  * Permission is granted to freely use, copy, modify, and redistribute  * this software, provided that no attempt is made to gain profit from it,  * the authors are not construed to be liable for any results of using the  * software, alterations are clearly marked as such, and this notice is  * not modified.  *  * Noteworthy contributors to screen's design and implementation:  *	Wayne Davison (davison@borland.com)  *	Patrick Wolfe (pat@kai.com, kailand!pat)  *	Bart Schaefer (schaefer@cse.ogi.edu)  *	Nathan Glasser (nathan@brokaw.lcs.mit.edu)  *	Larry W. Virden (lwv27%cas.BITNET@CUNYVM.CUNY.Edu)  *	Howard Chu (hyc@hanauma.jpl.nasa.gov)  *	Tim MacKenzie (tym@dibbler.cs.monash.edu.au)  *	Markku Jarvinen (mta@{cc,cs,ee}.tut.fi)  *	Marc Boucher (marc@CAM.ORG)  *  ****************************************************************  */
end_comment

begin_ifndef
ifndef|#
directive|ifndef
name|lint
end_ifndef

begin_decl_stmt
specifier|static
name|char
name|rcs_id
index|[]
init|=
literal|"$Id: ansi.c,v 1.2 92/02/03 02:27:30 jnweiger Exp $ FAU"
decl_stmt|;
end_decl_stmt

begin_endif
endif|#
directive|endif
end_endif

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_ifdef
ifdef|#
directive|ifdef
name|BSDI
end_ifdef

begin_include
include|#
directive|include
file|<sys/signal.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* BSDI */
end_comment

begin_include
include|#
directive|include
file|<fcntl.h>
end_include

begin_include
include|#
directive|include
file|"config.h"
end_include

begin_include
include|#
directive|include
file|"screen.h"
end_include

begin_include
include|#
directive|include
file|"ansi.h"
end_include

begin_include
include|#
directive|include
file|"extern.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|sun
end_ifndef

begin_comment
comment|/* we want to know about TIOCGWINSZ. jw. */
end_comment

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|char
modifier|*
name|getenv
argument_list|()
decl_stmt|,
modifier|*
name|tgetstr
argument_list|()
decl_stmt|,
modifier|*
name|tgoto
argument_list|()
decl_stmt|;
end_decl_stmt

begin_ifndef
ifndef|#
directive|ifndef
name|__STDC__
end_ifndef

begin_function_decl
specifier|extern
name|char
modifier|*
name|malloc
parameter_list|()
function_decl|;
end_function_decl

begin_endif
endif|#
directive|endif
end_endif

begin_decl_stmt
specifier|extern
name|struct
name|win
modifier|*
name|fore
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|ForeNum
decl_stmt|;
end_decl_stmt

begin_extern
extern|extern force_vt
operator|,
extern|assume_LP;
end_extern

begin_decl_stmt
specifier|extern
name|int
name|BellDisplayed
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|MsgMinWait
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|extern
name|int
name|all_norefresh
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|TermcapROWS
decl_stmt|,
name|TermcapCOLS
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* defaults that we learned from termcap */
end_comment

begin_decl_stmt
name|int
name|default_width
decl_stmt|,
name|default_height
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* width/height a new window will get */
end_comment

begin_decl_stmt
name|int
name|maxwidth
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|Z0width
decl_stmt|,
name|Z1width
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* widths for Z0/Z1 switching */
end_comment

begin_decl_stmt
name|char
name|display_tty
index|[
name|MAXPATH
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|screenwidth
decl_stmt|,
name|screenheight
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* width/height of the screen */
end_comment

begin_decl_stmt
name|int
name|screentop
decl_stmt|,
name|screenbot
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* scrollregion start/end */
end_comment

begin_decl_stmt
name|int
name|screenx
decl_stmt|,
name|screeny
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* cursor position */
end_comment

begin_decl_stmt
name|char
name|GlobalAttr
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current attributes */
end_comment

begin_decl_stmt
name|char
name|GlobalCharset
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* current font */
end_comment

begin_decl_stmt
name|int
name|insert
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* insert mode */
end_comment

begin_decl_stmt
name|int
name|keypad
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* application keypad */
end_comment

begin_decl_stmt
name|int
name|flow
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* flow control */
end_comment

begin_decl_stmt
name|int
name|status
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* status is displayed */
end_comment

begin_decl_stmt
specifier|static
name|int
name|status_lastx
decl_stmt|,
name|status_lasty
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|rows
decl_stmt|,
name|cols
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* window size of the curr window */
end_comment

begin_decl_stmt
name|int
name|default_flow
init|=
operator|-
literal|1
decl_stmt|,
name|wrap
init|=
literal|1
decl_stmt|,
name|default_monitor
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|visual_bell
init|=
literal|0
decl_stmt|,
name|termcapHS
decl_stmt|,
name|use_hardstatus
init|=
literal|1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Termcap
decl_stmt|,
modifier|*
name|extra_incap
decl_stmt|,
modifier|*
name|extra_outcap
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|Termcaplen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|blank
decl_stmt|,
modifier|*
name|null
decl_stmt|,
modifier|*
name|LastMsg
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
name|Term
index|[
name|MAXSTR
operator|+
literal|5
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* +5: "TERM=" */
end_comment

begin_decl_stmt
name|char
name|screenterm
index|[
literal|20
index|]
init|=
literal|"screen"
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|Z0
decl_stmt|,
modifier|*
name|Z1
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ISO2022
decl_stmt|,
name|HS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|time_t
name|TimeDisplayed
decl_stmt|,
name|time
argument_list|()
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * the termcap routines need this to work  */
end_comment

begin_decl_stmt
name|short
name|ospeed
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|BC
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|UP
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|AddCap
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|MakeString
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|char
operator|*
operator|,
name|int
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|Special
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DoESC
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DoCSI
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|CPutStr
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|SetChar
name|__P
argument_list|(
operator|(
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|StartString
name|__P
argument_list|(
operator|(
expr|enum
name|string_t
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|AddChar
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|PrintChar
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|PrintFlush
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|KeypadMode
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DesignateCharset
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|MapCharset
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|SaveCursor
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|RestoreCursor
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|CountChars
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|CalcCost
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|Rewrite
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|BackSpace
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|Return
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|LineFeed
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ReverseLineFeed
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|InsertAChar
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|InsertChar
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DeleteChar
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|DeleteLine
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|InsertLine
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ScrollUpMap
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ScrollDownMap
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|Scroll
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ForwardTab
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|BackwardTab
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ClearScreen
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ClearFromBOS
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ClearToEOS
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ClearLine
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ClearToEOL
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ClearFromBOL
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ClearInLine
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|CursorRight
name|__P
argument_list|(
operator|(
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|CursorUp
name|__P
argument_list|(
operator|(
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|CursorDown
name|__P
argument_list|(
operator|(
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|CursorLeft
name|__P
argument_list|(
operator|(
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|ASetMode
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|SelectRendition
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|FillWithEs
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|RedisplayLine
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|char
operator|*
operator|,
name|char
operator|*
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|FindAKA
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|SetCurr
name|__P
argument_list|(
operator|(
expr|struct
name|win
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|inpRedisplayLine
name|__P
argument_list|(
operator|(
name|int
operator|,
name|int
operator|,
name|int
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|process_inp_input
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|*
operator|,
name|int
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|AbortInp
name|__P
argument_list|(
operator|(
name|void
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|AKAfin
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|Colonfin
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|void
name|RAW_PUTCHAR
name|__P
argument_list|(
operator|(
name|int
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|e_tgetstr
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|,
name|char
operator|*
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|e_tgetflag
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|e_tgetnum
name|__P
argument_list|(
operator|(
name|char
operator|*
operator|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|tbuf
decl_stmt|,
modifier|*
name|tentry
decl_stmt|,
modifier|*
name|termname
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|tp
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|TI
decl_stmt|,
modifier|*
name|TE
decl_stmt|,
modifier|*
name|BL
decl_stmt|,
modifier|*
name|VB
decl_stmt|,
modifier|*
name|CR
decl_stmt|,
modifier|*
name|NL
decl_stmt|,
modifier|*
name|CL
decl_stmt|,
modifier|*
name|IS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|WS
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* used in ResizeScreen() */
end_comment

begin_decl_stmt
name|char
modifier|*
name|CE
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* used in help.c */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|CM
decl_stmt|,
modifier|*
name|US
decl_stmt|,
modifier|*
name|UE
decl_stmt|,
modifier|*
name|SO
decl_stmt|,
modifier|*
name|SE
decl_stmt|,
modifier|*
name|CD
decl_stmt|,
modifier|*
name|DO
decl_stmt|,
modifier|*
name|SR
decl_stmt|,
modifier|*
name|SF
decl_stmt|,
modifier|*
name|AL
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|CS
decl_stmt|,
modifier|*
name|DL
decl_stmt|,
modifier|*
name|DC
decl_stmt|,
modifier|*
name|IC
decl_stmt|,
modifier|*
name|IM
decl_stmt|,
modifier|*
name|EI
decl_stmt|,
modifier|*
name|ND
decl_stmt|,
modifier|*
name|KS
decl_stmt|,
modifier|*
name|KE
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|MB
decl_stmt|,
modifier|*
name|MD
decl_stmt|,
modifier|*
name|MH
decl_stmt|,
modifier|*
name|MR
decl_stmt|,
modifier|*
name|ME
decl_stmt|,
modifier|*
name|PO
decl_stmt|,
modifier|*
name|PF
decl_stmt|,
modifier|*
name|HO
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|TS
decl_stmt|,
modifier|*
name|FS
decl_stmt|,
modifier|*
name|DS
decl_stmt|,
modifier|*
name|VI
decl_stmt|,
modifier|*
name|VE
decl_stmt|,
modifier|*
name|VS
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|CDC
decl_stmt|,
modifier|*
name|CDL
decl_stmt|,
modifier|*
name|CAL
decl_stmt|,
modifier|*
name|CUP
decl_stmt|,
modifier|*
name|CDO
decl_stmt|,
modifier|*
name|CLE
decl_stmt|,
modifier|*
name|CRI
decl_stmt|,
modifier|*
name|CIC
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|attrtab
index|[
name|NATTR
index|]
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|AM
operator|,
name|MS
operator|,
name|COP
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|LP
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  * Do not confuse S0 (es-zero), E0 (e-zero) with SO (es-oh), PO (pe-oh),  * Z0 (z-zero), DO (de-oh)... :-)  */
end_comment

begin_decl_stmt
specifier|static
name|char
modifier|*
name|C0
decl_stmt|,
modifier|*
name|S0
decl_stmt|,
modifier|*
name|E0
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|c0_tab
index|[
literal|256
index|]
decl_stmt|;
end_decl_stmt

begin_comment
comment|/*  */
end_comment

begin_expr_stmt
specifier|static
name|screencap
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|char
modifier|*
name|OldImage
decl_stmt|,
modifier|*
name|OldAttr
decl_stmt|,
modifier|*
name|OldFont
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|struct
name|win
modifier|*
name|curr
decl_stmt|;
end_decl_stmt

begin_expr_stmt
specifier|static
name|display
operator|=
literal|1
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|StrCost
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|UPcost
operator|,
name|DOcost
operator|,
name|LEcost
operator|,
name|NDcost
operator|,
name|CRcost
operator|,
name|IMcost
operator|,
name|EIcost
operator|,
name|NLcost
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|tcLineLen
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|StatLen
expr_stmt|;
end_expr_stmt

begin_expr_stmt
specifier|static
name|lp_missing
operator|=
literal|0
expr_stmt|;
end_expr_stmt

begin_decl_stmt
name|int
name|in_ovl
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|ovl_blockfore
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
function_decl|(
modifier|*
name|ovl_process
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|void
function_decl|(
modifier|*
name|ovl_RedisplayLine
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
function_decl|(
modifier|*
name|ovl_Rewrite
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
specifier|static
name|char
modifier|*
name|KeyCaps
index|[]
init|=
block|{
literal|"k0"
block|,
literal|"k1"
block|,
literal|"k2"
block|,
literal|"k3"
block|,
literal|"k4"
block|,
literal|"k5"
block|,
literal|"k6"
block|,
literal|"k7"
block|,
literal|"k8"
block|,
literal|"k9"
block|,
literal|"kb"
block|,
literal|"kd"
block|,
literal|"kh"
block|,
literal|"kl"
block|,
literal|"ko"
block|,
literal|"kr"
block|,
literal|"ku"
block|,
literal|"K1"
block|,
literal|"K2"
block|,
literal|"K3"
block|,
literal|"K4"
block|,
literal|"K5"
block|,
literal|"l0"
block|,
literal|"l1"
block|,
literal|"l2"
block|,
literal|"l3"
block|,
literal|"l4"
block|,
literal|"l5"
block|,
literal|"l6"
block|,
literal|"l7"
block|,
literal|"l8"
block|,
literal|"l9"
block|}
decl_stmt|;
end_decl_stmt

begin_define
define|#
directive|define
name|NKEYCAPS
value|((int)(sizeof(KeyCaps)/sizeof(*KeyCaps)))
end_define

begin_decl_stmt
specifier|static
name|char
modifier|*
name|KeyCapsArr
index|[
name|NKEYCAPS
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
name|TermcapConst
index|[]
init|=
literal|"\\\n\ \t:DO=\\E[%dB:LE=\\E[%dD:RI=\\E[%dC:UP=\\E[%dA:bs:bt=\\E[Z:\\\n\ \t:cd=\\E[J:ce=\\E[K:cl=\\E[H\\E[J:cm=\\E[%i%d;%dH:ct=\\E[3g:\\\n\ \t:do=^J:nd=\\E[C:pt:rc=\\E8:rs=\\Ec:sc=\\E7:st=\\EH:up=\\EM:\\\n\ \t:le=^H:bl=^G:cr=^M:it#8:ho=\\E[H:nw=\\EE:ta=^I:is=\\E)0:xv:"
decl_stmt|;
end_decl_stmt

begin_function
name|void
name|InitTermcap
parameter_list|()
block|{
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|i
decl_stmt|;
name|screencap
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|(
name|s
operator|=
name|getenv
argument_list|(
literal|"SCREENCAP"
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|(
name|Termcap
operator|=
name|malloc
argument_list|(
name|strlen
argument_list|(
name|s
argument_list|)
operator|+
literal|10
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|sprintf
argument_list|(
name|Termcap
argument_list|,
literal|"TERMCAP=%s"
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|screencap
operator|=
literal|1
expr_stmt|;
block|}
block|}
else|else
name|Termcap
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
literal|1024
argument_list|)
expr_stmt|;
name|Termcaplen
operator|=
literal|0
expr_stmt|;
name|tbuf
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
literal|1024
argument_list|)
expr_stmt|;
name|tentry
operator|=
name|tp
operator|=
name|malloc
argument_list|(
operator|(
name|unsigned
operator|)
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|Termcap
operator|&&
name|tbuf
operator|&&
name|tentry
operator|)
condition|)
name|Msg_nomem
expr_stmt|;
name|bzero
argument_list|(
name|tbuf
argument_list|,
literal|1024
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|termname
operator|=
name|getenv
argument_list|(
literal|"TERM"
argument_list|)
operator|)
operator|==
literal|0
condition|)
name|Msg
argument_list|(
literal|0
argument_list|,
literal|"No TERM in environment."
argument_list|)
expr_stmt|;
name|debug1
argument_list|(
literal|"InitTermcap: looking for tgetent('%s');\n"
argument_list|,
name|termname
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgetent
argument_list|(
name|tbuf
argument_list|,
name|termname
argument_list|)
operator|!=
literal|1
condition|)
name|Msg
argument_list|(
literal|0
argument_list|,
literal|"Cannot find termcap entry for %s."
argument_list|,
name|termname
argument_list|)
expr_stmt|;
name|debug1
argument_list|(
literal|"got it:\n%s\n"
argument_list|,
name|tbuf
argument_list|)
expr_stmt|;
ifdef|#
directive|ifdef
name|DEBUG
if|if
condition|(
name|extra_incap
condition|)
name|debug1
argument_list|(
literal|"Extra incap: %s\n"
argument_list|,
name|extra_incap
argument_list|)
expr_stmt|;
if|if
condition|(
name|extra_outcap
condition|)
name|debug1
argument_list|(
literal|"Extra outcap: %s\n"
argument_list|,
name|extra_outcap
argument_list|)
expr_stmt|;
endif|#
directive|endif
name|TermcapCOLS
operator|=
name|TermcapROWS
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|getenv
argument_list|(
literal|"COLUMNS"
argument_list|)
condition|)
name|TermcapCOLS
operator|=
name|atoi
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|TermcapCOLS
operator|<=
literal|0
condition|)
name|TermcapCOLS
operator|=
name|e_tgetnum
argument_list|(
literal|"co"
argument_list|)
expr_stmt|;
if|if
condition|(
name|TermcapCOLS
operator|<=
literal|0
condition|)
name|TermcapCOLS
operator|=
literal|80
expr_stmt|;
if|if
condition|(
name|s
operator|=
name|getenv
argument_list|(
literal|"LINES"
argument_list|)
condition|)
name|TermcapROWS
operator|=
name|atoi
argument_list|(
name|s
argument_list|)
expr_stmt|;
if|if
condition|(
name|TermcapROWS
operator|<=
literal|0
condition|)
name|TermcapROWS
operator|=
name|e_tgetnum
argument_list|(
literal|"li"
argument_list|)
expr_stmt|;
if|if
condition|(
name|TermcapROWS
operator|<=
literal|0
condition|)
name|TermcapROWS
operator|=
literal|24
expr_stmt|;
if|if
condition|(
name|e_tgetflag
argument_list|(
literal|"hc"
argument_list|)
condition|)
name|Msg
argument_list|(
literal|0
argument_list|,
literal|"You can't run screen on a hardcopy terminal."
argument_list|)
expr_stmt|;
if|if
condition|(
name|e_tgetflag
argument_list|(
literal|"os"
argument_list|)
condition|)
name|Msg
argument_list|(
literal|0
argument_list|,
literal|"You can't run screen on a terminal that overstrikes."
argument_list|)
expr_stmt|;
if|if
condition|(
name|e_tgetflag
argument_list|(
literal|"ns"
argument_list|)
condition|)
name|Msg
argument_list|(
literal|0
argument_list|,
literal|"Terminal must support scrolling."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|CL
operator|=
name|e_tgetstr
argument_list|(
literal|"cl"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
condition|)
name|Msg
argument_list|(
literal|0
argument_list|,
literal|"Clear screen capability required."
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|CM
operator|=
name|e_tgetstr
argument_list|(
literal|"cm"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
condition|)
name|Msg
argument_list|(
literal|0
argument_list|,
literal|"Addressable cursor capability required."
argument_list|)
expr_stmt|;
if|if
condition|(
name|default_flow
operator|<
literal|0
condition|)
name|default_flow
operator|=
name|e_tgetflag
argument_list|(
literal|"NF"
argument_list|)
condition|?
name|FLOW_NOW
operator|*
literal|0
else|:
name|e_tgetflag
argument_list|(
literal|"xo"
argument_list|)
condition|?
name|FLOW_NOW
operator|*
literal|1
else|:
name|FLOW_AUTOFLAG
expr_stmt|;
name|AM
operator|=
name|e_tgetflag
argument_list|(
literal|"am"
argument_list|)
expr_stmt|;
name|LP
operator|=
name|assume_LP
operator|||
operator|(
operator|!
name|extra_incap
operator|&&
operator|!
name|strncmp
argument_list|(
name|termname
argument_list|,
literal|"vt"
argument_list|,
literal|2
argument_list|)
operator|)
operator|||
operator|!
name|AM
operator|||
name|e_tgetflag
argument_list|(
literal|"LP"
argument_list|)
operator|||
name|e_tgetflag
argument_list|(
literal|"xv"
argument_list|)
expr_stmt|;
name|COP
operator|=
name|e_tgetflag
argument_list|(
literal|"OP"
argument_list|)
expr_stmt|;
name|HO
operator|=
name|e_tgetstr
argument_list|(
literal|"ho"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|TI
operator|=
name|e_tgetstr
argument_list|(
literal|"ti"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|TE
operator|=
name|e_tgetstr
argument_list|(
literal|"te"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|BL
operator|=
name|e_tgetstr
argument_list|(
literal|"bl"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
condition|)
name|BL
operator|=
literal|"\007"
expr_stmt|;
name|VB
operator|=
name|e_tgetstr
argument_list|(
literal|"vb"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|BC
operator|=
name|e_tgetstr
argument_list|(
literal|"bc"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
condition|)
block|{
if|if
condition|(
name|e_tgetflag
argument_list|(
literal|"bs"
argument_list|)
condition|)
name|BC
operator|=
literal|"\b"
expr_stmt|;
else|else
name|BC
operator|=
name|e_tgetstr
argument_list|(
literal|"le"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
operator|(
name|CR
operator|=
name|e_tgetstr
argument_list|(
literal|"cr"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
condition|)
name|CR
operator|=
literal|"\r"
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|NL
operator|=
name|e_tgetstr
argument_list|(
literal|"nl"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
condition|)
name|NL
operator|=
literal|"\n"
expr_stmt|;
name|IS
operator|=
name|e_tgetstr
argument_list|(
literal|"is"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|MS
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|e_tgetnum
argument_list|(
literal|"sg"
argument_list|)
operator|<=
literal|0
operator|&&
name|e_tgetnum
argument_list|(
literal|"ug"
argument_list|)
operator|<=
literal|0
condition|)
block|{
name|MS
operator|=
name|e_tgetflag
argument_list|(
literal|"ms"
argument_list|)
expr_stmt|;
name|attrtab
index|[
name|ATTR_DI
index|]
operator|=
name|MH
operator|=
name|e_tgetstr
argument_list|(
literal|"mh"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
comment|/* Dim */
name|attrtab
index|[
name|ATTR_US
index|]
operator|=
name|US
operator|=
name|e_tgetstr
argument_list|(
literal|"us"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
comment|/* Underline */
name|attrtab
index|[
name|ATTR_BD
index|]
operator|=
name|MD
operator|=
name|e_tgetstr
argument_list|(
literal|"md"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
comment|/* Bold */
name|attrtab
index|[
name|ATTR_RV
index|]
operator|=
name|MR
operator|=
name|e_tgetstr
argument_list|(
literal|"mr"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
comment|/* Reverse */
name|attrtab
index|[
name|ATTR_SO
index|]
operator|=
name|SO
operator|=
name|e_tgetstr
argument_list|(
literal|"so"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
comment|/* Standout */
name|attrtab
index|[
name|ATTR_BL
index|]
operator|=
name|MB
operator|=
name|e_tgetstr
argument_list|(
literal|"mb"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
comment|/* Blinking */
name|ME
operator|=
name|e_tgetstr
argument_list|(
literal|"me"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|SE
operator|=
name|e_tgetstr
argument_list|(
literal|"se"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|UE
operator|=
name|e_tgetstr
argument_list|(
literal|"ue"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
comment|/*        * Does ME also reverse the effect of SO and/or US?  This is not        * clearly specified by the termcap manual. Anyway, we should at        * least look whether ME and SE/UE are equal:        */
if|if
condition|(
name|UE
operator|&&
operator|(
operator|(
name|SE
operator|&&
name|strcmp
argument_list|(
name|SE
argument_list|,
name|UE
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
name|ME
operator|&&
name|strcmp
argument_list|(
name|ME
argument_list|,
name|UE
argument_list|)
operator|==
literal|0
operator|)
operator|)
condition|)
name|UE
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|SE
operator|&&
operator|(
name|ME
operator|&&
name|strcmp
argument_list|(
name|ME
argument_list|,
name|SE
argument_list|)
operator|==
literal|0
operator|)
condition|)
name|SE
operator|=
literal|0
expr_stmt|;
comment|/* Set up missing entries */
name|s
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
name|NATTR
operator|-
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|--
control|)
if|if
condition|(
name|attrtab
index|[
name|i
index|]
condition|)
name|s
operator|=
name|attrtab
index|[
name|i
index|]
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NATTR
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|attrtab
index|[
name|i
index|]
operator|==
literal|0
condition|)
name|attrtab
index|[
name|i
index|]
operator|=
name|s
expr_stmt|;
else|else
name|s
operator|=
name|attrtab
index|[
name|i
index|]
expr_stmt|;
block|}
block|}
else|else
block|{
name|US
operator|=
name|UE
operator|=
name|SO
operator|=
name|SE
operator|=
name|MB
operator|=
name|MD
operator|=
name|MH
operator|=
name|MR
operator|=
name|ME
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NATTR
condition|;
name|i
operator|++
control|)
name|attrtab
index|[
name|i
index|]
operator|=
literal|0
expr_stmt|;
block|}
name|CE
operator|=
name|e_tgetstr
argument_list|(
literal|"ce"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|CD
operator|=
name|e_tgetstr
argument_list|(
literal|"cd"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|DO
operator|=
name|e_tgetstr
argument_list|(
literal|"do"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
condition|)
name|DO
operator|=
name|NL
expr_stmt|;
name|UP
operator|=
name|e_tgetstr
argument_list|(
literal|"up"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|ND
operator|=
name|e_tgetstr
argument_list|(
literal|"nd"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|SR
operator|=
name|e_tgetstr
argument_list|(
literal|"sr"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|SF
operator|=
name|e_tgetstr
argument_list|(
literal|"sf"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
condition|)
name|SF
operator|=
name|NL
expr_stmt|;
name|AL
operator|=
name|e_tgetstr
argument_list|(
literal|"al"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|DL
operator|=
name|e_tgetstr
argument_list|(
literal|"dl"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|CS
operator|=
name|e_tgetstr
argument_list|(
literal|"cs"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|DC
operator|=
name|e_tgetstr
argument_list|(
literal|"dc"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|IC
operator|=
name|e_tgetstr
argument_list|(
literal|"ic"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|CIC
operator|=
name|e_tgetstr
argument_list|(
literal|"IC"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|CDC
operator|=
name|e_tgetstr
argument_list|(
literal|"DC"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|CDL
operator|=
name|e_tgetstr
argument_list|(
literal|"DL"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|CAL
operator|=
name|e_tgetstr
argument_list|(
literal|"AL"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|CUP
operator|=
name|e_tgetstr
argument_list|(
literal|"UP"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|CDO
operator|=
name|e_tgetstr
argument_list|(
literal|"DO"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|CLE
operator|=
name|e_tgetstr
argument_list|(
literal|"LE"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|CRI
operator|=
name|e_tgetstr
argument_list|(
literal|"RI"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|IM
operator|=
name|e_tgetstr
argument_list|(
literal|"im"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|EI
operator|=
name|e_tgetstr
argument_list|(
literal|"ei"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
name|e_tgetflag
argument_list|(
literal|"in"
argument_list|)
condition|)
name|IC
operator|=
name|IM
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|IC
operator|&&
name|IC
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|IC
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|CIC
operator|&&
name|CIC
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|CIC
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|IM
operator|&&
name|IM
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|IM
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|EI
operator|&&
name|EI
index|[
literal|0
index|]
operator|==
literal|'\0'
condition|)
name|EI
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|EI
operator|==
literal|0
condition|)
name|IM
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|IC
operator|&&
name|IM
operator|&&
name|strcmp
argument_list|(
name|IC
argument_list|,
name|IM
argument_list|)
operator|==
literal|0
condition|)
name|IC
operator|=
literal|0
expr_stmt|;
name|KS
operator|=
name|e_tgetstr
argument_list|(
literal|"ks"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|KE
operator|=
name|e_tgetstr
argument_list|(
literal|"ke"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
name|KE
operator|==
literal|0
condition|)
name|KS
operator|=
literal|0
expr_stmt|;
name|ISO2022
operator|=
name|e_tgetflag
argument_list|(
literal|"G0"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISO2022
condition|)
block|{
if|if
condition|(
operator|(
name|S0
operator|=
name|e_tgetstr
argument_list|(
literal|"S0"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
ifdef|#
directive|ifdef
name|TERMINFO
name|S0
operator|=
literal|"\033(%p1%c"
expr_stmt|;
else|#
directive|else
name|S0
operator|=
literal|"\033(%."
expr_stmt|;
endif|#
directive|endif
if|if
condition|(
operator|(
name|E0
operator|=
name|e_tgetstr
argument_list|(
literal|"E0"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|E0
operator|=
literal|"\033(B"
expr_stmt|;
name|C0
operator|=
name|e_tgetstr
argument_list|(
literal|"C0"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|S0
operator|=
name|e_tgetstr
argument_list|(
literal|"as"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|(
name|E0
operator|=
name|e_tgetstr
argument_list|(
literal|"ae"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
operator|!=
name|NULL
condition|)
block|{
name|ISO2022
operator|=
literal|1
expr_stmt|;
name|C0
operator|=
name|e_tgetstr
argument_list|(
literal|"ac"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|S0
operator|=
name|E0
operator|=
literal|""
expr_stmt|;
name|C0
operator|=
literal|"g.h.i'j-k-l-m-n+o~p\"q-r-s_t+u+v+w+x|y<z>"
expr_stmt|;
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|256
condition|;
name|i
operator|++
control|)
name|c0_tab
index|[
name|i
index|]
operator|=
name|i
expr_stmt|;
if|if
condition|(
name|C0
condition|)
for|for
control|(
name|i
operator|=
name|strlen
argument_list|(
name|C0
argument_list|)
operator|&
operator|~
literal|1
init|;
name|i
operator|>=
literal|0
condition|;
name|i
operator|-=
literal|2
control|)
name|c0_tab
index|[
name|C0
index|[
name|i
index|]
index|]
operator|=
name|C0
index|[
name|i
operator|+
literal|1
index|]
expr_stmt|;
name|debug1
argument_list|(
literal|"ISO2022 = %d\n"
argument_list|,
name|ISO2022
argument_list|)
expr_stmt|;
comment|/* WS changes the window size */
name|WS
operator|=
name|e_tgetstr
argument_list|(
literal|"WS"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|VI
operator|=
name|e_tgetstr
argument_list|(
literal|"vi"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|VE
operator|=
name|e_tgetstr
argument_list|(
literal|"ve"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|VS
operator|=
name|e_tgetstr
argument_list|(
literal|"vs"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|PO
operator|=
name|e_tgetstr
argument_list|(
literal|"po"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|PF
operator|=
name|e_tgetstr
argument_list|(
literal|"pf"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
condition|)
name|PO
operator|=
literal|0
expr_stmt|;
name|debug2
argument_list|(
literal|"terminal size is %d, %d (says TERMCAP)\n"
argument_list|,
name|TermcapCOLS
argument_list|,
name|TermcapROWS
argument_list|)
expr_stmt|;
comment|/* Termcap fields Z0& Z1 contain width-changing sequences. */
if|if
condition|(
operator|(
name|Z0
operator|=
name|e_tgetstr
argument_list|(
literal|"Z0"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|(
name|Z1
operator|=
name|e_tgetstr
argument_list|(
literal|"Z1"
argument_list|,
operator|&
name|tp
argument_list|)
operator|)
operator|==
name|NULL
condition|)
name|Z0
operator|=
name|NULL
expr_stmt|;
name|Z0width
operator|=
literal|132
expr_stmt|;
name|Z1width
operator|=
literal|80
expr_stmt|;
name|CheckScreenSize
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|HS
operator|=
name|e_tgetflag
argument_list|(
literal|"hs"
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
name|debug
argument_list|(
literal|"oy! we have a hardware status line, says termcap\n"
argument_list|)
expr_stmt|;
name|TS
operator|=
name|e_tgetstr
argument_list|(
literal|"ts"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|FS
operator|=
name|e_tgetstr
argument_list|(
literal|"fs"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|DS
operator|=
name|e_tgetstr
argument_list|(
literal|"ds"
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|HS
operator|=
name|e_tgetnum
argument_list|(
literal|"ws"
argument_list|)
operator|)
operator|<=
literal|0
condition|)
name|HS
operator|=
name|screenwidth
expr_stmt|;
if|if
condition|(
operator|!
name|TS
operator|||
operator|!
name|FS
operator|||
operator|!
name|DS
condition|)
name|HS
operator|=
literal|0
expr_stmt|;
block|}
name|termcapHS
operator|=
name|HS
expr_stmt|;
if|if
condition|(
operator|!
name|use_hardstatus
condition|)
name|HS
operator|=
literal|0
expr_stmt|;
name|UPcost
operator|=
name|CalcCost
argument_list|(
name|UP
argument_list|)
expr_stmt|;
name|DOcost
operator|=
name|CalcCost
argument_list|(
name|DO
argument_list|)
expr_stmt|;
name|NLcost
operator|=
name|CalcCost
argument_list|(
name|NL
argument_list|)
expr_stmt|;
name|LEcost
operator|=
name|CalcCost
argument_list|(
name|BC
argument_list|)
expr_stmt|;
name|NDcost
operator|=
name|CalcCost
argument_list|(
name|ND
argument_list|)
expr_stmt|;
name|CRcost
operator|=
name|CalcCost
argument_list|(
name|CR
argument_list|)
expr_stmt|;
name|IMcost
operator|=
name|CalcCost
argument_list|(
name|IM
argument_list|)
expr_stmt|;
name|EIcost
operator|=
name|CalcCost
argument_list|(
name|EI
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NKEYCAPS
condition|;
name|i
operator|++
control|)
name|KeyCapsArr
index|[
name|i
index|]
operator|=
name|e_tgetstr
argument_list|(
name|KeyCaps
index|[
name|i
index|]
argument_list|,
operator|&
name|tp
argument_list|)
expr_stmt|;
name|MakeTermcap
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * if the adaptflag is on, we keep the size of this display, else  * we may try to restore our old window sizes.  */
end_comment

begin_function
name|void
name|InitTerm
parameter_list|(
name|adapt
parameter_list|)
name|int
name|adapt
decl_stmt|;
block|{
name|display
operator|=
literal|1
expr_stmt|;
name|screentop
operator|=
name|screenbot
operator|=
operator|-
literal|1
expr_stmt|;
name|PutStr
argument_list|(
name|IS
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|TI
argument_list|)
expr_stmt|;
if|if
condition|(
name|IM
operator|&&
name|strcmp
argument_list|(
name|IM
argument_list|,
name|EI
argument_list|)
condition|)
name|PutStr
argument_list|(
name|EI
argument_list|)
expr_stmt|;
name|insert
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|KS
operator|&&
name|strcmp
argument_list|(
name|KS
argument_list|,
name|KE
argument_list|)
condition|)
name|PutStr
argument_list|(
name|KE
argument_list|)
expr_stmt|;
name|keypad
operator|=
literal|0
expr_stmt|;
name|PutStr
argument_list|(
name|E0
argument_list|)
expr_stmt|;
name|GlobalCharset
operator|=
name|ASCII
expr_stmt|;
name|ResizeScreen
argument_list|(
operator|(
expr|struct
name|win
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|ChangeScrollRegion
argument_list|(
literal|0
argument_list|,
name|screenheight
operator|-
literal|1
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|CL
argument_list|)
expr_stmt|;
name|screenx
operator|=
name|screeny
operator|=
literal|0
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|debug1
argument_list|(
literal|"we %swant to adapt all our windows to the display\n"
argument_list|,
operator|(
name|adapt
operator|)
condition|?
literal|""
else|:
literal|"don't "
argument_list|)
expr_stmt|;
comment|/* In case the size was changed by a init sequence */
name|CheckScreenSize
argument_list|(
operator|(
name|adapt
operator|)
condition|?
literal|2
else|:
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|FinitTerm
parameter_list|()
block|{
name|display
operator|=
literal|1
expr_stmt|;
name|InsertMode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|KeypadMode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ResizeScreen
argument_list|(
operator|(
expr|struct
name|win
operator|*
operator|)
literal|0
argument_list|)
expr_stmt|;
name|ChangeScrollRegion
argument_list|(
literal|0
argument_list|,
name|screenheight
operator|-
literal|1
argument_list|)
expr_stmt|;
name|SaveSetAttr
argument_list|(
literal|0
argument_list|,
name|ASCII
argument_list|)
expr_stmt|;
name|screenx
operator|=
name|screeny
operator|=
operator|-
literal|1
expr_stmt|;
name|GotoPos
argument_list|(
literal|0
argument_list|,
name|screenheight
operator|-
literal|1
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|TE
argument_list|)
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
if|if
condition|(
name|Termcap
condition|)
block|{
name|Free
argument_list|(
name|Termcap
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"FinitTerm: old termcap freed\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tbuf
condition|)
block|{
name|Free
argument_list|(
name|tbuf
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"FinitTerm: old tbuf freed\n"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|tentry
condition|)
block|{
name|Free
argument_list|(
name|tentry
argument_list|)
expr_stmt|;
name|debug
argument_list|(
literal|"FinitTerm: old tentry freed\n"
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|AddCap
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
specifier|register
name|int
name|n
decl_stmt|;
if|if
condition|(
name|tcLineLen
operator|+
operator|(
name|n
operator|=
name|strlen
argument_list|(
name|s
argument_list|)
operator|)
operator|>
literal|55
operator|&&
name|Termcaplen
operator|<
literal|1024
operator|-
literal|4
condition|)
block|{
name|strcpy
argument_list|(
name|Termcap
operator|+
name|Termcaplen
argument_list|,
literal|"\\\n\t:"
argument_list|)
expr_stmt|;
name|Termcaplen
operator|+=
literal|4
expr_stmt|;
name|tcLineLen
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|Termcaplen
operator|+
name|n
operator|<
literal|1024
condition|)
block|{
name|strcpy
argument_list|(
name|Termcap
operator|+
name|Termcaplen
argument_list|,
name|s
argument_list|)
expr_stmt|;
name|Termcaplen
operator|+=
name|n
expr_stmt|;
name|tcLineLen
operator|+=
name|n
expr_stmt|;
block|}
else|else
name|Msg
argument_list|(
literal|0
argument_list|,
literal|"TERMCAP overflow - sorry."
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|char
modifier|*
name|MakeTermcap
parameter_list|(
name|aflag
parameter_list|)
name|int
name|aflag
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|1024
index|]
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|cp
decl_stmt|,
name|ch
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
name|screencap
condition|)
block|{
name|sprintf
argument_list|(
name|Term
argument_list|,
literal|"TERM=screen"
argument_list|)
expr_stmt|;
return|return
name|Termcap
return|;
block|}
if|if
condition|(
name|screenterm
operator|==
literal|0
operator|||
operator|*
name|screenterm
operator|==
literal|'\0'
condition|)
block|{
name|debug
argument_list|(
literal|"MakeTermcap sets screenterm=screen\n"
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|screenterm
argument_list|,
literal|"screen"
argument_list|)
expr_stmt|;
block|}
for|for
control|(
init|;
condition|;
control|)
block|{
name|sprintf
argument_list|(
name|Term
argument_list|,
literal|"TERM="
argument_list|)
expr_stmt|;
name|p
operator|=
name|Term
operator|+
literal|5
expr_stmt|;
if|if
condition|(
operator|!
name|aflag
operator|&&
name|strlen
argument_list|(
name|screenterm
argument_list|)
operator|+
name|strlen
argument_list|(
name|termname
argument_list|)
operator|<
name|MAXSTR
operator|-
literal|1
condition|)
block|{
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"%s.%s"
argument_list|,
name|screenterm
argument_list|,
name|termname
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgetent
argument_list|(
name|buf
argument_list|,
name|p
argument_list|)
operator|==
literal|1
condition|)
break|break;
block|}
if|if
condition|(
name|screenwidth
operator|>=
literal|132
condition|)
block|{
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"%s-w"
argument_list|,
name|screenterm
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgetent
argument_list|(
name|buf
argument_list|,
name|p
argument_list|)
operator|==
literal|1
condition|)
break|break;
block|}
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"%s"
argument_list|,
name|screenterm
argument_list|)
expr_stmt|;
if|if
condition|(
name|tgetent
argument_list|(
name|buf
argument_list|,
name|p
argument_list|)
operator|==
literal|1
condition|)
break|break;
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"vt100"
argument_list|)
expr_stmt|;
break|break;
block|}
name|tcLineLen
operator|=
literal|100
expr_stmt|;
comment|/* Force NL */
name|sprintf
argument_list|(
name|Termcap
argument_list|,
literal|"TERMCAP=SC|%s|VT 100/ANSI X3.64 virtual terminal|"
argument_list|,
name|p
argument_list|)
expr_stmt|;
name|Termcaplen
operator|=
name|strlen
argument_list|(
name|Termcap
argument_list|)
expr_stmt|;
if|if
condition|(
name|extra_outcap
operator|&&
operator|*
name|extra_outcap
condition|)
block|{
for|for
control|(
name|cp
operator|=
name|extra_outcap
init|;
name|p
operator|=
name|index
argument_list|(
name|cp
argument_list|,
literal|':'
argument_list|)
condition|;
name|cp
operator|=
name|p
control|)
block|{
name|ch
operator|=
operator|*
operator|++
name|p
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
name|AddCap
argument_list|(
name|cp
argument_list|)
expr_stmt|;
operator|*
name|p
operator|=
name|ch
expr_stmt|;
block|}
name|tcLineLen
operator|=
literal|100
expr_stmt|;
comment|/* Force NL */
block|}
if|if
condition|(
name|Termcaplen
operator|+
name|strlen
argument_list|(
name|TermcapConst
argument_list|)
operator|<
literal|1024
condition|)
block|{
name|strcpy
argument_list|(
name|Termcap
operator|+
name|Termcaplen
argument_list|,
name|TermcapConst
argument_list|)
expr_stmt|;
name|Termcaplen
operator|+=
name|strlen
argument_list|(
name|TermcapConst
argument_list|)
expr_stmt|;
block|}
name|sprintf
argument_list|(
name|buf
argument_list|,
literal|"li#%d:co#%d:"
argument_list|,
name|screenheight
argument_list|,
name|screenwidth
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
name|buf
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|force_vt
operator|&&
operator|!
name|COP
operator|)
operator|||
name|LP
operator|||
operator|!
name|AM
condition|)
name|AddCap
argument_list|(
literal|"LP:"
argument_list|)
expr_stmt|;
else|else
name|AddCap
argument_list|(
literal|"am:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|VB
condition|)
name|AddCap
argument_list|(
literal|"vb=\\E[?5h\\E[?5l:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|US
condition|)
block|{
name|AddCap
argument_list|(
literal|"us=\\E[4m:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"ue=\\E[24m:"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|SO
condition|)
block|{
name|AddCap
argument_list|(
literal|"so=\\E[3m:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"se=\\E[23m:"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|MB
condition|)
name|AddCap
argument_list|(
literal|"mb=\\E[5m:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|MD
condition|)
name|AddCap
argument_list|(
literal|"md=\\E[1m:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|MH
condition|)
name|AddCap
argument_list|(
literal|"mh=\\E[2m:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|MR
condition|)
name|AddCap
argument_list|(
literal|"mr=\\E[7m:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|MB
operator|||
name|MD
operator|||
name|MH
operator|||
name|MR
condition|)
name|AddCap
argument_list|(
literal|"me=\\E[m:ms:"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|CS
operator|&&
name|SR
operator|)
operator|||
name|AL
operator|||
name|CAL
operator|||
name|aflag
condition|)
block|{
name|AddCap
argument_list|(
literal|"sr=\\EM:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"al=\\E[L:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"AL=\\E[%dL:"
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|SR
condition|)
name|AddCap
argument_list|(
literal|"sr=\\EM:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|CS
operator|||
name|DL
operator|||
name|CDL
operator|||
name|aflag
condition|)
block|{
name|AddCap
argument_list|(
literal|"dl=\\E[M:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"DL=\\E[%dM:"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|CS
condition|)
name|AddCap
argument_list|(
literal|"cs=\\E[%i%d;%dr:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|DC
operator|||
name|CDC
operator|||
name|aflag
condition|)
block|{
name|AddCap
argument_list|(
literal|"dc=\\E[P:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"DC=\\E[%dP:"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|CIC
operator|||
name|IC
operator|||
name|IM
operator|||
name|aflag
condition|)
block|{
name|AddCap
argument_list|(
literal|"im=\\E[4h:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"ei=\\E[4l:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"mi:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"ic=\\E[@:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"IC=\\E[%d@:"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|KS
condition|)
name|AddCap
argument_list|(
literal|"ks=\\E=:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|KE
condition|)
name|AddCap
argument_list|(
literal|"ke=\\E>:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|ISO2022
condition|)
name|AddCap
argument_list|(
literal|"G0:"
argument_list|)
expr_stmt|;
if|if
condition|(
name|PO
condition|)
block|{
name|AddCap
argument_list|(
literal|"po=\\E[5i:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"pf=\\E[4i:"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|Z0
condition|)
block|{
name|AddCap
argument_list|(
literal|"Z0=\\E[?3h:"
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
literal|"Z1=\\E[?3l:"
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|WS
condition|)
name|AddCap
argument_list|(
literal|"WS=\\E[8;%d;%dt:"
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|NKEYCAPS
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|KeyCapsArr
index|[
name|i
index|]
operator|==
literal|0
condition|)
continue|continue;
name|MakeString
argument_list|(
name|KeyCaps
index|[
name|i
index|]
argument_list|,
name|buf
argument_list|,
sizeof|sizeof
argument_list|(
name|buf
argument_list|)
argument_list|,
name|KeyCapsArr
index|[
name|i
index|]
argument_list|)
expr_stmt|;
name|AddCap
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
return|return
name|Termcap
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|MakeString
parameter_list|(
name|cap
parameter_list|,
name|buf
parameter_list|,
name|buflen
parameter_list|,
name|s
parameter_list|)
name|char
modifier|*
name|cap
decl_stmt|,
decl|*
name|buf
decl_stmt|;
end_function

begin_decl_stmt
name|int
name|buflen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|char
modifier|*
name|s
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|pmax
decl_stmt|;
specifier|register
name|unsigned
name|int
name|c
decl_stmt|;
name|p
operator|=
name|buf
expr_stmt|;
name|pmax
operator|=
name|p
operator|+
name|buflen
operator|-
operator|(
literal|3
operator|+
literal|4
operator|+
literal|2
operator|)
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|*
name|cap
operator|++
expr_stmt|;
operator|*
name|p
operator|++
operator|=
operator|*
name|cap
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'='
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|s
operator|++
operator|)
operator|&&
operator|(
name|p
operator|<
name|pmax
operator|)
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\033'
case|:
operator|*
name|p
operator|++
operator|=
literal|'\\'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
literal|'E'
expr_stmt|;
break|break;
case|case
literal|':'
case|:
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"\\072"
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|4
expr_stmt|;
break|break;
case|case
literal|'^'
case|:
case|case
literal|'\\'
case|:
operator|*
name|p
operator|++
operator|=
literal|'\\'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|c
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|c
operator|>=
literal|200
condition|)
block|{
name|sprintf
argument_list|(
name|p
argument_list|,
literal|"\\%03o"
argument_list|,
name|c
operator|&
literal|0377
argument_list|)
expr_stmt|;
name|p
operator|+=
literal|4
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|<
literal|' '
condition|)
block|{
operator|*
name|p
operator|++
operator|=
literal|'^'
expr_stmt|;
operator|*
name|p
operator|++
operator|=
name|c
operator|+
literal|'@'
expr_stmt|;
block|}
else|else
operator|*
name|p
operator|++
operator|=
name|c
expr_stmt|;
block|}
block|}
operator|*
name|p
operator|++
operator|=
literal|':'
expr_stmt|;
operator|*
name|p
operator|=
literal|'\0'
expr_stmt|;
block|}
end_block

begin_function
name|void
name|Activate
parameter_list|(
name|norefresh
parameter_list|)
name|int
name|norefresh
decl_stmt|;
block|{
name|debug1
argument_list|(
literal|"Activate(%d)\n"
argument_list|,
name|norefresh
argument_list|)
expr_stmt|;
if|if
condition|(
name|display
condition|)
name|RemoveStatus
argument_list|()
expr_stmt|;
name|display
operator|=
name|fore
operator|->
name|active
operator|=
literal|1
expr_stmt|;
name|ResizeScreen
argument_list|(
name|fore
argument_list|)
expr_stmt|;
name|SetCurr
argument_list|(
name|fore
argument_list|)
expr_stmt|;
name|debug3
argument_list|(
literal|"Fore (%d) has size %dx%d"
argument_list|,
name|ForeNum
argument_list|,
name|curr
operator|->
name|width
argument_list|,
name|curr
operator|->
name|height
argument_list|)
expr_stmt|;
name|debug1
argument_list|(
literal|"(%d)\n"
argument_list|,
name|curr
operator|->
name|histheight
argument_list|)
expr_stmt|;
name|ChangeScrollRegion
argument_list|(
name|curr
operator|->
name|top
argument_list|,
name|curr
operator|->
name|bot
argument_list|)
expr_stmt|;
name|KeypadMode
argument_list|(
name|curr
operator|->
name|keypad
argument_list|)
expr_stmt|;
name|SetFlow
argument_list|(
name|curr
operator|->
name|flow
operator|&
name|FLOW_NOW
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|monitor
operator|!=
name|MON_OFF
condition|)
name|curr
operator|->
name|monitor
operator|=
name|MON_ON
expr_stmt|;
name|curr
operator|->
name|bell
operator|=
name|BELL_OFF
expr_stmt|;
name|Redisplay
argument_list|(
name|norefresh
operator|||
name|all_norefresh
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ResetScreen
parameter_list|(
name|p
parameter_list|)
specifier|register
name|struct
name|win
modifier|*
name|p
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
name|p
operator|->
name|wrap
operator|=
name|wrap
expr_stmt|;
name|p
operator|->
name|origin
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|insert
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|vbwait
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|keypad
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|top
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|bot
operator|=
name|p
operator|->
name|height
operator|-
literal|1
expr_stmt|;
name|p
operator|->
name|saved
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|LocalAttr
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|x
operator|=
name|p
operator|->
name|y
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|state
operator|=
name|LIT
expr_stmt|;
name|p
operator|->
name|StringType
operator|=
name|NONE
expr_stmt|;
name|p
operator|->
name|ss
operator|=
literal|0
expr_stmt|;
name|p
operator|->
name|LocalCharset
operator|=
name|G0
expr_stmt|;
name|bzero
argument_list|(
name|p
operator|->
name|tabs
argument_list|,
name|p
operator|->
name|width
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|8
init|;
name|i
operator|<
name|p
operator|->
name|width
condition|;
name|i
operator|+=
literal|8
control|)
name|p
operator|->
name|tabs
index|[
name|i
index|]
operator|=
literal|1
expr_stmt|;
for|for
control|(
name|i
operator|=
name|G0
init|;
name|i
operator|<=
name|G3
condition|;
name|i
operator|++
control|)
name|p
operator|->
name|charsets
index|[
name|i
index|]
operator|=
name|ASCII
expr_stmt|;
block|}
end_function

begin_function
name|void
name|WriteString
parameter_list|(
name|wp
parameter_list|,
name|buf
parameter_list|,
name|len
parameter_list|)
name|struct
name|win
modifier|*
name|wp
decl_stmt|;
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
specifier|register
name|int
name|c
decl_stmt|,
name|intermediate
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|len
condition|)
return|return;
if|if
condition|(
name|wp
operator|->
name|logfp
operator|!=
name|NULL
condition|)
if|if
condition|(
operator|(
name|int
operator|)
name|fwrite
argument_list|(
name|buf
argument_list|,
name|len
argument_list|,
literal|1
argument_list|,
name|wp
operator|->
name|logfp
argument_list|)
operator|<
literal|1
condition|)
block|{
specifier|extern
name|int
name|errno
decl_stmt|;
name|Msg
argument_list|(
name|errno
argument_list|,
literal|"Error writing logfile"
argument_list|)
expr_stmt|;
name|fclose
argument_list|(
name|wp
operator|->
name|logfp
argument_list|)
expr_stmt|;
name|wp
operator|->
name|logfp
operator|=
name|NULL
expr_stmt|;
block|}
comment|/*    * SetCurr() here may prevent output, as it may set display = 0    */
name|SetCurr
argument_list|(
name|wp
argument_list|)
expr_stmt|;
if|if
condition|(
name|display
condition|)
block|{
if|if
condition|(
operator|!
name|HS
condition|)
name|RemoveStatus
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|curr
operator|->
name|monitor
operator|==
name|MON_ON
condition|)
name|curr
operator|->
name|monitor
operator|=
name|MON_FOUND
expr_stmt|;
do|do
block|{
name|c
operator|=
operator|(
name|unsigned
name|char
operator|)
operator|*
name|buf
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\0'
operator|||
name|c
operator|==
literal|'\177'
condition|)
continue|continue;
name|NextChar
label|:
switch|switch
condition|(
name|curr
operator|->
name|state
condition|)
block|{
case|case
name|PRIN
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\033'
case|:
name|curr
operator|->
name|state
operator|=
name|PRINESC
expr_stmt|;
break|break;
default|default:
name|PrintChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|PRINESC
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'['
case|:
name|curr
operator|->
name|state
operator|=
name|PRINCSI
expr_stmt|;
break|break;
default|default:
name|PrintChar
argument_list|(
literal|'\033'
argument_list|)
expr_stmt|;
name|PrintChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|curr
operator|->
name|state
operator|=
name|PRIN
expr_stmt|;
block|}
break|break;
case|case
name|PRINCSI
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'4'
case|:
name|curr
operator|->
name|state
operator|=
name|PRIN4
expr_stmt|;
break|break;
default|default:
name|PrintChar
argument_list|(
literal|'\033'
argument_list|)
expr_stmt|;
name|PrintChar
argument_list|(
literal|'['
argument_list|)
expr_stmt|;
name|PrintChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|curr
operator|->
name|state
operator|=
name|PRIN
expr_stmt|;
block|}
break|break;
case|case
name|PRIN4
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'i'
case|:
name|curr
operator|->
name|state
operator|=
name|LIT
expr_stmt|;
name|PrintFlush
argument_list|()
expr_stmt|;
break|break;
default|default:
name|PrintChar
argument_list|(
literal|'\033'
argument_list|)
expr_stmt|;
name|PrintChar
argument_list|(
literal|'['
argument_list|)
expr_stmt|;
name|PrintChar
argument_list|(
literal|'4'
argument_list|)
expr_stmt|;
name|PrintChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|curr
operator|->
name|state
operator|=
name|PRIN
expr_stmt|;
block|}
break|break;
case|case
name|STRESC
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\\'
case|:
name|curr
operator|->
name|state
operator|=
name|LIT
expr_stmt|;
operator|*
operator|(
name|curr
operator|->
name|stringp
operator|)
operator|=
literal|'\0'
expr_stmt|;
switch|switch
condition|(
name|curr
operator|->
name|StringType
condition|)
block|{
case|case
name|PM
case|:
if|if
condition|(
operator|!
name|display
condition|)
break|break;
name|MakeStatus
argument_list|(
name|curr
operator|->
name|string
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|HS
operator|&&
name|status
operator|&&
name|len
operator|>
literal|1
condition|)
block|{
name|curr
operator|->
name|outlen
operator|=
name|len
operator|-
literal|1
expr_stmt|;
name|bcopy
argument_list|(
name|buf
argument_list|,
name|curr
operator|->
name|outbuf
argument_list|,
name|curr
operator|->
name|outlen
argument_list|)
expr_stmt|;
return|return;
block|}
break|break;
case|case
name|DCS
case|:
if|if
condition|(
name|display
condition|)
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|curr
operator|->
name|string
argument_list|)
expr_stmt|;
break|break;
case|case
name|AKA
case|:
if|if
condition|(
name|curr
operator|->
name|akapos
operator|==
literal|0
operator|&&
operator|!
operator|*
name|curr
operator|->
name|string
condition|)
break|break;
name|strncpy
argument_list|(
name|curr
operator|->
name|cmd
operator|+
name|curr
operator|->
name|akapos
argument_list|,
name|curr
operator|->
name|string
argument_list|,
literal|20
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
operator|*
name|curr
operator|->
name|string
condition|)
name|curr
operator|->
name|autoaka
operator|=
name|curr
operator|->
name|y
operator|+
literal|1
expr_stmt|;
break|break;
default|default:
break|break;
block|}
break|break;
default|default:
name|curr
operator|->
name|state
operator|=
name|ASTR
expr_stmt|;
name|AddChar
argument_list|(
literal|'\033'
argument_list|)
expr_stmt|;
name|AddChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ASTR
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\0'
case|:
break|break;
case|case
literal|'\033'
case|:
name|curr
operator|->
name|state
operator|=
name|STRESC
expr_stmt|;
break|break;
default|default:
name|AddChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|ESC
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'['
case|:
name|curr
operator|->
name|NumArgs
operator|=
literal|0
expr_stmt|;
name|intermediate
operator|=
literal|0
expr_stmt|;
name|bzero
argument_list|(
operator|(
name|char
operator|*
operator|)
name|curr
operator|->
name|args
argument_list|,
name|MAXARGS
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|curr
operator|->
name|state
operator|=
name|CSI
expr_stmt|;
break|break;
case|case
literal|']'
case|:
name|StartString
argument_list|(
name|OSC
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'_'
case|:
name|StartString
argument_list|(
name|APC
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|StartString
argument_list|(
name|DCS
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'^'
case|:
name|StartString
argument_list|(
name|PM
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'"'
case|:
case|case
literal|'k'
case|:
name|StartString
argument_list|(
name|AKA
argument_list|)
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|Special
argument_list|(
name|c
argument_list|)
condition|)
break|break;
if|if
condition|(
name|c
operator|>=
literal|' '
operator|&&
name|c
operator|<=
literal|'/'
condition|)
name|intermediate
operator|=
name|intermediate
condition|?
operator|-
literal|1
else|:
name|c
expr_stmt|;
elseif|else
if|if
condition|(
name|c
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'~'
condition|)
block|{
name|DoESC
argument_list|(
name|c
argument_list|,
name|intermediate
argument_list|)
expr_stmt|;
name|curr
operator|->
name|state
operator|=
name|LIT
expr_stmt|;
block|}
else|else
block|{
name|curr
operator|->
name|state
operator|=
name|LIT
expr_stmt|;
goto|goto
name|NextChar
goto|;
block|}
block|}
break|break;
case|case
name|CSI
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
if|if
condition|(
name|curr
operator|->
name|NumArgs
operator|<
name|MAXARGS
condition|)
block|{
name|curr
operator|->
name|args
index|[
name|curr
operator|->
name|NumArgs
index|]
operator|=
literal|10
operator|*
name|curr
operator|->
name|args
index|[
name|curr
operator|->
name|NumArgs
index|]
operator|+
name|c
operator|-
literal|'0'
expr_stmt|;
block|}
break|break;
case|case
literal|';'
case|:
case|case
literal|':'
case|:
name|curr
operator|->
name|NumArgs
operator|++
expr_stmt|;
break|break;
default|default:
if|if
condition|(
name|Special
argument_list|(
name|c
argument_list|)
condition|)
break|break;
if|if
condition|(
name|c
operator|>=
literal|'@'
operator|&&
name|c
operator|<=
literal|'~'
condition|)
block|{
name|curr
operator|->
name|NumArgs
operator|++
expr_stmt|;
name|DoCSI
argument_list|(
name|c
argument_list|,
name|intermediate
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|state
operator|!=
name|PRIN
condition|)
name|curr
operator|->
name|state
operator|=
name|LIT
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|c
operator|>=
literal|' '
operator|&&
name|c
operator|<=
literal|'/'
operator|)
operator|||
operator|(
name|c
operator|>=
literal|'<'
operator|&&
name|c
operator|<=
literal|'?'
operator|)
condition|)
name|intermediate
operator|=
name|intermediate
condition|?
operator|-
literal|1
else|:
name|c
expr_stmt|;
else|else
block|{
name|curr
operator|->
name|state
operator|=
name|LIT
expr_stmt|;
goto|goto
name|NextChar
goto|;
block|}
block|}
break|break;
case|case
name|LIT
case|:
default|default:
if|if
condition|(
operator|!
name|Special
argument_list|(
name|c
argument_list|)
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|'\033'
condition|)
block|{
name|intermediate
operator|=
literal|0
expr_stmt|;
name|curr
operator|->
name|state
operator|=
name|ESC
expr_stmt|;
if|if
condition|(
name|display
operator|&&
name|lp_missing
operator|&&
operator|(
name|CIC
operator|||
name|IC
operator|||
name|IM
operator|)
condition|)
block|{
name|RedisplayLine
argument_list|(
name|blank
argument_list|,
name|null
argument_list|,
name|null
argument_list|,
name|screenbot
argument_list|,
name|cols
operator|-
literal|2
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|curr
operator|->
name|autoaka
operator|<
literal|0
condition|)
name|curr
operator|->
name|autoaka
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|c
operator|<
literal|' '
condition|)
break|break;
else|else
block|{
name|NewRendition
argument_list|(
name|curr
operator|->
name|LocalAttr
argument_list|)
expr_stmt|;
name|NewCharset
argument_list|(
name|curr
operator|->
name|charsets
index|[
operator|(
name|curr
operator|->
name|ss
operator|)
condition|?
name|curr
operator|->
name|ss
else|:
name|curr
operator|->
name|LocalCharset
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|x
operator|<
name|cols
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|curr
operator|->
name|insert
condition|)
name|InsertAChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|display
condition|)
name|PUTCHAR
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|SetChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|curr
operator|->
name|x
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|curr
operator|->
name|x
operator|==
name|cols
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|curr
operator|->
name|wrap
operator|&&
operator|(
name|LP
operator|||
operator|!
name|force_vt
operator|||
name|COP
operator|)
condition|)
block|{
if|if
condition|(
name|display
condition|)
name|RAW_PUTCHAR
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|SetChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|AM
operator|&&
operator|!
name|LP
condition|)
block|{
name|curr
operator|->
name|x
operator|=
literal|0
expr_stmt|;
comment|/* terminal auto-wrapped */
name|LineFeed
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
else|else
name|curr
operator|->
name|x
operator|++
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|display
condition|)
block|{
if|if
condition|(
name|LP
operator|||
name|curr
operator|->
name|y
operator|!=
name|screenbot
condition|)
block|{
name|RAW_PUTCHAR
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
else|else
name|CheckLP
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|SetChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|wrap
condition|)
name|curr
operator|->
name|x
operator|++
expr_stmt|;
block|}
block|}
else|else
block|{
name|LineFeed
argument_list|(
literal|2
argument_list|)
expr_stmt|;
comment|/* cr+lf, handle LP */
if|if
condition|(
name|curr
operator|->
name|insert
condition|)
name|InsertAChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
name|display
condition|)
name|PUTCHAR
argument_list|(
name|c
argument_list|)
expr_stmt|;
name|SetChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
name|curr
operator|->
name|x
operator|=
literal|1
expr_stmt|;
block|}
if|if
condition|(
name|curr
operator|->
name|ss
condition|)
block|{
name|NewCharset
argument_list|(
name|curr
operator|->
name|charsets
index|[
name|curr
operator|->
name|LocalCharset
index|]
argument_list|)
expr_stmt|;
name|curr
operator|->
name|ss
operator|=
literal|0
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
do|while
condition|(
operator|--
name|len
condition|)
do|;
name|curr
operator|->
name|outlen
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|state
operator|==
name|PRIN
condition|)
name|PrintFlush
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|Special
parameter_list|(
name|c
parameter_list|)
specifier|register
name|int
name|c
decl_stmt|;
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'\b'
case|:
name|BackSpace
argument_list|()
expr_stmt|;
return|return
literal|1
return|;
case|case
literal|'\r'
case|:
name|Return
argument_list|()
expr_stmt|;
return|return
literal|1
return|;
case|case
literal|'\n'
case|:
if|if
condition|(
name|curr
operator|->
name|autoaka
condition|)
name|FindAKA
argument_list|()
expr_stmt|;
name|LineFeed
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
case|case
literal|'\007'
case|:
if|if
condition|(
operator|!
name|visual_bell
condition|)
name|PutStr
argument_list|(
name|BL
argument_list|)
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|!
name|VB
condition|)
name|curr
operator|->
name|bell
operator|=
name|BELL_VISUAL
expr_stmt|;
else|else
name|PutStr
argument_list|(
name|VB
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|display
condition|)
name|curr
operator|->
name|bell
operator|=
name|BELL_ON
expr_stmt|;
return|return
literal|1
return|;
case|case
literal|'\t'
case|:
name|ForwardTab
argument_list|()
expr_stmt|;
return|return
literal|1
return|;
case|case
literal|'\017'
case|:
comment|/* SI */
name|MapCharset
argument_list|(
name|G0
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
case|case
literal|'\016'
case|:
comment|/* SO */
name|MapCharset
argument_list|(
name|G1
argument_list|)
expr_stmt|;
return|return
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|DoESC
parameter_list|(
name|c
parameter_list|,
name|intermediate
parameter_list|)
name|int
name|c
decl_stmt|,
name|intermediate
decl_stmt|;
block|{
switch|switch
condition|(
name|intermediate
condition|)
block|{
case|case
literal|0
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'E'
case|:
name|LineFeed
argument_list|(
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|LineFeed
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
name|ReverseLineFeed
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'H'
case|:
name|curr
operator|->
name|tabs
index|[
name|curr
operator|->
name|x
index|]
operator|=
literal|1
expr_stmt|;
break|break;
case|case
literal|'Z'
case|:
comment|/* jph: Identify as VT100 */
name|Report
argument_list|(
name|curr
argument_list|,
literal|"\033[?%d;%dc"
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'7'
case|:
name|SaveCursor
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'8'
case|:
name|RestoreCursor
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
name|ClearScreen
argument_list|()
expr_stmt|;
name|ResetScreen
argument_list|(
name|curr
argument_list|)
expr_stmt|;
name|NewRendition
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|NewCharset
argument_list|(
name|ASCII
argument_list|)
expr_stmt|;
name|InsertMode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|KeypadMode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|ChangeScrollRegion
argument_list|(
literal|0
argument_list|,
name|rows
operator|-
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'='
case|:
name|KeypadMode
argument_list|(
name|curr
operator|->
name|keypad
operator|=
literal|1
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|TIOCPKT
argument_list|)
operator|||
name|defined
argument_list|(
name|sgi
argument_list|)
name|NewAutoFlow
argument_list|(
name|curr
argument_list|,
literal|0
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* !TIOCPKT || sgi */
break|break;
case|case
literal|'>'
case|:
name|KeypadMode
argument_list|(
name|curr
operator|->
name|keypad
operator|=
literal|0
argument_list|)
expr_stmt|;
if|#
directive|if
operator|!
name|defined
argument_list|(
name|TIOCPKT
argument_list|)
operator|||
name|defined
argument_list|(
name|sgi
argument_list|)
name|NewAutoFlow
argument_list|(
name|curr
argument_list|,
literal|1
argument_list|)
expr_stmt|;
endif|#
directive|endif
comment|/* !TIOCPKT || sgi */
break|break;
case|case
literal|'n'
case|:
comment|/* LS2 */
name|MapCharset
argument_list|(
name|G2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'o'
case|:
comment|/* LS3 */
name|MapCharset
argument_list|(
name|G3
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'N'
case|:
comment|/* SS2 */
if|if
condition|(
name|curr
operator|->
name|charsets
index|[
name|curr
operator|->
name|LocalCharset
index|]
operator|!=
name|curr
operator|->
name|charsets
index|[
name|G2
index|]
condition|)
name|curr
operator|->
name|ss
operator|=
name|G2
expr_stmt|;
else|else
name|curr
operator|->
name|ss
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'O'
case|:
comment|/* SS3 */
if|if
condition|(
name|curr
operator|->
name|charsets
index|[
name|curr
operator|->
name|LocalCharset
index|]
operator|!=
name|curr
operator|->
name|charsets
index|[
name|G3
index|]
condition|)
name|curr
operator|->
name|ss
operator|=
name|G3
expr_stmt|;
else|else
name|curr
operator|->
name|ss
operator|=
literal|0
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'#'
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'8'
case|:
name|FillWithEs
argument_list|()
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'('
case|:
name|DesignateCharset
argument_list|(
name|c
argument_list|,
name|G0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|')'
case|:
name|DesignateCharset
argument_list|(
name|c
argument_list|,
name|G1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'*'
case|:
name|DesignateCharset
argument_list|(
name|c
argument_list|,
name|G2
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'+'
case|:
name|DesignateCharset
argument_list|(
name|c
argument_list|,
name|G3
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|DoCSI
parameter_list|(
name|c
parameter_list|,
name|intermediate
parameter_list|)
name|int
name|c
decl_stmt|,
name|intermediate
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|a1
init|=
name|curr
operator|->
name|args
index|[
literal|0
index|]
decl_stmt|,
name|a2
init|=
name|curr
operator|->
name|args
index|[
literal|1
index|]
decl_stmt|;
if|if
condition|(
name|curr
operator|->
name|NumArgs
operator|>
name|MAXARGS
condition|)
name|curr
operator|->
name|NumArgs
operator|=
name|MAXARGS
expr_stmt|;
switch|switch
condition|(
name|intermediate
condition|)
block|{
case|case
literal|0
case|:
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'H'
case|:
case|case
literal|'f'
case|:
if|if
condition|(
name|a1
operator|<
literal|1
condition|)
name|a1
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|origin
condition|)
name|a1
operator|+=
name|curr
operator|->
name|top
expr_stmt|;
if|if
condition|(
name|a1
operator|>
name|rows
condition|)
name|a1
operator|=
name|rows
expr_stmt|;
if|if
condition|(
name|a2
operator|<
literal|1
condition|)
name|a2
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|a2
operator|>
name|cols
condition|)
name|a2
operator|=
name|cols
expr_stmt|;
name|GotoPos
argument_list|(
operator|--
name|a2
argument_list|,
operator|--
name|a1
argument_list|)
expr_stmt|;
name|curr
operator|->
name|x
operator|=
name|a2
expr_stmt|;
name|curr
operator|->
name|y
operator|=
name|a1
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|autoaka
condition|)
name|curr
operator|->
name|autoaka
operator|=
name|a1
operator|+
literal|1
expr_stmt|;
break|break;
case|case
literal|'J'
case|:
if|if
condition|(
name|a1
operator|<
literal|0
operator|||
name|a1
operator|>
literal|2
condition|)
name|a1
operator|=
literal|0
expr_stmt|;
switch|switch
condition|(
name|a1
condition|)
block|{
case|case
literal|0
case|:
name|ClearToEOS
argument_list|()
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|ClearFromBOS
argument_list|()
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|ClearScreen
argument_list|()
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'K'
case|:
if|if
condition|(
name|a1
operator|<
literal|0
operator|||
name|a1
operator|>
literal|2
condition|)
name|a1
operator|%=
literal|3
expr_stmt|;
switch|switch
condition|(
name|a1
condition|)
block|{
case|case
literal|0
case|:
name|ClearToEOL
argument_list|()
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|ClearFromBOL
argument_list|()
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|ClearLine
argument_list|()
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'A'
case|:
name|CursorUp
argument_list|(
name|a1
condition|?
name|a1
else|:
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'B'
case|:
name|CursorDown
argument_list|(
name|a1
condition|?
name|a1
else|:
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'C'
case|:
name|CursorRight
argument_list|(
name|a1
condition|?
name|a1
else|:
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'D'
case|:
name|CursorLeft
argument_list|(
name|a1
condition|?
name|a1
else|:
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'m'
case|:
name|SelectRendition
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'g'
case|:
if|if
condition|(
name|a1
operator|==
literal|0
condition|)
name|curr
operator|->
name|tabs
index|[
name|curr
operator|->
name|x
index|]
operator|=
literal|0
expr_stmt|;
elseif|else
if|if
condition|(
name|a1
operator|==
literal|3
condition|)
name|bzero
argument_list|(
name|curr
operator|->
name|tabs
argument_list|,
name|cols
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
if|if
condition|(
operator|!
name|a1
condition|)
name|a1
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|a2
condition|)
name|a2
operator|=
name|rows
expr_stmt|;
if|if
condition|(
name|a1
operator|<
literal|1
operator|||
name|a2
operator|>
name|rows
operator|||
name|a1
operator|>=
name|a2
condition|)
break|break;
name|curr
operator|->
name|top
operator|=
name|a1
operator|-
literal|1
expr_stmt|;
name|curr
operator|->
name|bot
operator|=
name|a2
operator|-
literal|1
expr_stmt|;
name|ChangeScrollRegion
argument_list|(
name|curr
operator|->
name|top
argument_list|,
name|curr
operator|->
name|bot
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|origin
condition|)
block|{
name|GotoPos
argument_list|(
literal|0
argument_list|,
name|curr
operator|->
name|top
argument_list|)
expr_stmt|;
name|curr
operator|->
name|y
operator|=
name|curr
operator|->
name|top
expr_stmt|;
name|curr
operator|->
name|x
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|GotoPos
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|curr
operator|->
name|y
operator|=
name|curr
operator|->
name|x
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|'s'
case|:
name|SaveCursor
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
if|if
condition|(
name|a1
operator|!=
literal|8
condition|)
break|break;
name|a1
operator|=
name|curr
operator|->
name|args
index|[
literal|2
index|]
expr_stmt|;
if|if
condition|(
name|a1
operator|<
literal|1
condition|)
name|a1
operator|=
name|curr
operator|->
name|width
expr_stmt|;
if|if
condition|(
name|a2
operator|<
literal|1
condition|)
name|a2
operator|=
name|curr
operator|->
name|height
expr_stmt|;
if|if
condition|(
name|WS
operator|==
name|NULL
condition|)
block|{
name|a2
operator|=
name|curr
operator|->
name|height
expr_stmt|;
if|if
condition|(
name|Z0
operator|==
name|NULL
operator|||
operator|(
name|a1
operator|!=
name|Z0width
operator|&&
name|a1
operator|!=
name|Z1width
operator|)
condition|)
name|a1
operator|=
name|curr
operator|->
name|width
expr_stmt|;
block|}
if|if
condition|(
name|a1
operator|==
name|curr
operator|->
name|width
operator|&&
name|a2
operator|==
name|curr
operator|->
name|height
condition|)
break|break;
name|ChangeWindowSize
argument_list|(
name|curr
argument_list|,
name|a1
argument_list|,
name|a2
argument_list|)
expr_stmt|;
name|SetCurr
argument_list|(
name|curr
argument_list|)
expr_stmt|;
if|if
condition|(
name|display
condition|)
name|Activate
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'u'
case|:
name|RestoreCursor
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'I'
case|:
if|if
condition|(
operator|!
name|a1
condition|)
name|a1
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|a1
operator|--
condition|)
name|ForwardTab
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'Z'
case|:
if|if
condition|(
operator|!
name|a1
condition|)
name|a1
operator|=
literal|1
expr_stmt|;
while|while
condition|(
name|a1
operator|--
condition|)
name|BackwardTab
argument_list|()
expr_stmt|;
break|break;
case|case
literal|'L'
case|:
name|InsertLine
argument_list|(
name|a1
condition|?
name|a1
else|:
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'M'
case|:
name|DeleteLine
argument_list|(
name|a1
condition|?
name|a1
else|:
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'P'
case|:
name|DeleteChar
argument_list|(
name|a1
condition|?
name|a1
else|:
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'@'
case|:
name|InsertChar
argument_list|(
name|a1
condition|?
name|a1
else|:
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'h'
case|:
name|ASetMode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'l'
case|:
name|ASetMode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'i'
case|:
if|if
condition|(
name|PO
operator|&&
name|a1
operator|==
literal|5
condition|)
block|{
name|curr
operator|->
name|stringp
operator|=
name|curr
operator|->
name|string
expr_stmt|;
name|curr
operator|->
name|state
operator|=
name|PRIN
expr_stmt|;
block|}
break|break;
case|case
literal|'n'
case|:
if|if
condition|(
name|a1
operator|==
literal|6
condition|)
comment|/* Report cursor position */
name|Report
argument_list|(
name|curr
argument_list|,
literal|"\033[%d;%dR"
argument_list|,
name|curr
operator|->
name|y
operator|+
literal|1
argument_list|,
name|curr
operator|->
name|x
operator|+
literal|1
argument_list|)
expr_stmt|;
break|break;
case|case
literal|'c'
case|:
comment|/* Identify as VT100 */
name|Report
argument_list|(
name|curr
argument_list|,
literal|"\033[?%d;%dc"
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|)
expr_stmt|;
break|break;
block|}
break|break;
case|case
literal|'?'
case|:
name|debug2
argument_list|(
literal|"\\E[?%d%c\n"
argument_list|,
name|a1
argument_list|,
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|c
operator|!=
literal|'h'
operator|&&
name|c
operator|!=
literal|'l'
condition|)
break|break;
name|i
operator|=
operator|(
name|c
operator|==
literal|'h'
operator|)
expr_stmt|;
switch|switch
condition|(
name|a1
condition|)
block|{
case|case
literal|3
case|:
name|i
operator|=
operator|(
name|i
condition|?
name|Z0width
else|:
name|Z1width
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|Z0
operator|||
name|WS
operator|)
operator|&&
name|curr
operator|->
name|width
operator|!=
name|i
condition|)
block|{
name|ChangeWindowSize
argument_list|(
name|curr
argument_list|,
name|i
argument_list|,
name|curr
operator|->
name|height
argument_list|)
expr_stmt|;
name|SetCurr
argument_list|(
name|curr
argument_list|)
expr_stmt|;
if|if
condition|(
name|display
condition|)
name|Activate
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
literal|5
case|:
if|if
condition|(
name|i
condition|)
name|curr
operator|->
name|vbwait
operator|=
literal|1
expr_stmt|;
else|else
block|{
if|if
condition|(
name|curr
operator|->
name|vbwait
condition|)
name|PutStr
argument_list|(
name|VB
argument_list|)
expr_stmt|;
name|curr
operator|->
name|vbwait
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|6
case|:
if|if
condition|(
operator|(
name|curr
operator|->
name|origin
operator|=
name|i
operator|)
operator|!=
literal|0
condition|)
block|{
name|GotoPos
argument_list|(
literal|0
argument_list|,
name|curr
operator|->
name|top
argument_list|)
expr_stmt|;
name|curr
operator|->
name|y
operator|=
name|curr
operator|->
name|top
expr_stmt|;
name|curr
operator|->
name|x
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|GotoPos
argument_list|(
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|curr
operator|->
name|y
operator|=
name|curr
operator|->
name|x
operator|=
literal|0
expr_stmt|;
block|}
break|break;
case|case
literal|7
case|:
name|curr
operator|->
name|wrap
operator|=
name|i
expr_stmt|;
break|break;
case|case
literal|35
case|:
name|debug1
argument_list|(
literal|"Cursor %svisible\n"
argument_list|,
name|i
condition|?
literal|"in"
else|:
literal|""
argument_list|)
expr_stmt|;
name|curr
operator|->
name|cursor_invisible
operator|=
name|i
expr_stmt|;
break|break;
block|}
break|break;
block|}
block|}
end_function

begin_function
name|void
name|INSERTCHAR
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|insert
operator|&&
operator|(
name|IC
operator|||
name|CIC
operator|)
condition|)
block|{
if|if
condition|(
name|IC
condition|)
name|PutStr
argument_list|(
name|IC
argument_list|)
expr_stmt|;
else|else
name|CPutStr
argument_list|(
name|CIC
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|RAW_PUTCHAR
argument_list|(
name|c
argument_list|)
expr_stmt|;
return|return;
block|}
name|InsertMode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|insert
condition|)
name|RAW_PUTCHAR
argument_list|(
name|c
argument_list|)
expr_stmt|;
else|else
name|RefreshLine
argument_list|(
name|screeny
argument_list|,
name|screenx
argument_list|,
name|screenwidth
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|PUTCHAR
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
if|if
condition|(
name|insert
condition|)
name|InsertMode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|RAW_PUTCHAR
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * RAW_PUTCHAR() is for all text that will be displayed.  * NOTE, that charset Nr. 0 has a conversion table, but c1, c2, ... don't.  */
end_comment

begin_function
specifier|static
name|void
name|RAW_PUTCHAR
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
if|if
condition|(
name|GlobalCharset
operator|==
literal|'0'
condition|)
name|putchar
argument_list|(
name|c0_tab
index|[
name|c
index|]
argument_list|)
expr_stmt|;
else|else
name|putchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|screenx
operator|<
name|screenwidth
operator|-
literal|1
condition|)
name|screenx
operator|++
expr_stmt|;
else|else
block|{
name|screenx
operator|++
expr_stmt|;
if|if
condition|(
operator|(
name|AM
operator|&&
operator|!
name|LP
operator|)
operator|||
name|screenx
operator|>
name|screenwidth
condition|)
block|{
name|screenx
operator|-=
name|screenwidth
expr_stmt|;
if|if
condition|(
name|screeny
operator|<
name|screenheight
operator|-
literal|1
operator|&&
name|screeny
operator|!=
name|screenbot
condition|)
name|screeny
operator|++
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
name|void
name|PutChar
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
comment|/* this PutChar for ESC-sequences only */
name|putchar
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|PutStr
parameter_list|(
name|s
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
block|{
if|if
condition|(
name|display
operator|&&
name|s
condition|)
name|tputs
argument_list|(
name|s
argument_list|,
literal|1
argument_list|,
name|PutChar
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|CPutStr
parameter_list|(
name|s
parameter_list|,
name|c
parameter_list|)
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|c
decl_stmt|;
block|{
if|if
condition|(
name|display
operator|&&
name|s
condition|)
name|tputs
argument_list|(
name|tgoto
argument_list|(
name|s
argument_list|,
literal|0
argument_list|,
name|c
argument_list|)
argument_list|,
literal|1
argument_list|,
name|PutChar
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|SetChar
parameter_list|(
name|c
parameter_list|)
specifier|register
name|int
name|c
decl_stmt|;
block|{
specifier|register
name|struct
name|win
modifier|*
name|p
init|=
name|curr
decl_stmt|;
name|p
operator|->
name|image
index|[
name|p
operator|->
name|y
index|]
index|[
name|p
operator|->
name|x
index|]
operator|=
name|c
expr_stmt|;
name|p
operator|->
name|attr
index|[
name|p
operator|->
name|y
index|]
index|[
name|p
operator|->
name|x
index|]
operator|=
name|p
operator|->
name|LocalAttr
expr_stmt|;
name|p
operator|->
name|font
index|[
name|p
operator|->
name|y
index|]
index|[
name|p
operator|->
name|x
index|]
operator|=
name|p
operator|->
name|charsets
index|[
name|p
operator|->
name|ss
condition|?
name|p
operator|->
name|ss
else|:
name|p
operator|->
name|LocalCharset
index|]
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|StartString
parameter_list|(
name|type
parameter_list|)
name|enum
name|string_t
name|type
decl_stmt|;
block|{
name|curr
operator|->
name|StringType
operator|=
name|type
expr_stmt|;
name|curr
operator|->
name|stringp
operator|=
name|curr
operator|->
name|string
expr_stmt|;
name|curr
operator|->
name|state
operator|=
name|ASTR
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|AddChar
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
if|if
condition|(
name|curr
operator|->
name|stringp
operator|>=
name|curr
operator|->
name|string
operator|+
name|MAXSTR
operator|-
literal|1
condition|)
name|curr
operator|->
name|state
operator|=
name|LIT
expr_stmt|;
else|else
operator|*
operator|(
name|curr
operator|->
name|stringp
operator|)
operator|++
operator|=
name|c
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|PrintChar
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
if|if
condition|(
name|curr
operator|->
name|stringp
operator|>=
name|curr
operator|->
name|string
operator|+
name|MAXSTR
operator|-
literal|1
condition|)
name|PrintFlush
argument_list|()
expr_stmt|;
operator|*
operator|(
name|curr
operator|->
name|stringp
operator|)
operator|++
operator|=
name|c
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|PrintFlush
parameter_list|()
block|{
if|if
condition|(
name|curr
operator|->
name|stringp
operator|>
name|curr
operator|->
name|string
condition|)
block|{
name|tputs
argument_list|(
name|PO
argument_list|,
literal|1
argument_list|,
name|PutChar
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|write
argument_list|(
literal|1
argument_list|,
name|curr
operator|->
name|string
argument_list|,
name|curr
operator|->
name|stringp
operator|-
name|curr
operator|->
name|string
argument_list|)
expr_stmt|;
name|tputs
argument_list|(
name|PF
argument_list|,
literal|1
argument_list|,
name|PutChar
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
name|curr
operator|->
name|stringp
operator|=
name|curr
operator|->
name|string
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* Insert mode is a toggle on some terminals, so we need this hack:  */
end_comment

begin_function
name|void
name|InsertMode
parameter_list|(
name|on
parameter_list|)
name|int
name|on
decl_stmt|;
block|{
if|if
condition|(
name|display
operator|&&
name|on
operator|!=
name|insert
operator|&&
name|IM
condition|)
block|{
name|insert
operator|=
name|on
expr_stmt|;
if|if
condition|(
name|insert
condition|)
name|PutStr
argument_list|(
name|IM
argument_list|)
expr_stmt|;
else|else
name|PutStr
argument_list|(
name|EI
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/* ...and maybe keypad application mode is a toggle, too:  */
end_comment

begin_function
specifier|static
name|void
name|KeypadMode
parameter_list|(
name|on
parameter_list|)
name|int
name|on
decl_stmt|;
block|{
if|if
condition|(
name|display
operator|&&
name|keypad
operator|!=
name|on
operator|&&
name|KS
condition|)
block|{
name|keypad
operator|=
name|on
expr_stmt|;
if|if
condition|(
name|keypad
condition|)
name|PutStr
argument_list|(
name|KS
argument_list|)
expr_stmt|;
else|else
name|PutStr
argument_list|(
name|KE
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|NewAutoFlow
parameter_list|(
name|win
parameter_list|,
name|on
parameter_list|)
name|struct
name|win
modifier|*
name|win
decl_stmt|;
name|int
name|on
decl_stmt|;
block|{
name|debug1
argument_list|(
literal|"NewAutoFlow: %d\n"
argument_list|,
name|on
argument_list|)
expr_stmt|;
name|SetCurr
argument_list|(
name|win
argument_list|)
expr_stmt|;
if|if
condition|(
name|win
operator|->
name|flow
operator|&
name|FLOW_AUTOFLAG
condition|)
name|win
operator|->
name|flow
operator|=
name|FLOW_AUTOFLAG
operator||
operator|(
name|FLOW_AUTO
operator||
name|FLOW_NOW
operator|)
operator|*
name|on
expr_stmt|;
else|else
name|win
operator|->
name|flow
operator|=
operator|(
name|win
operator|->
name|flow
operator|&
operator|~
name|FLOW_AUTO
operator|)
operator||
name|FLOW_AUTO
operator|*
name|on
expr_stmt|;
if|if
condition|(
name|display
condition|)
name|SetFlow
argument_list|(
name|win
operator|->
name|flow
operator|&
name|FLOW_NOW
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|DesignateCharset
parameter_list|(
name|c
parameter_list|,
name|n
parameter_list|)
name|int
name|c
decl_stmt|,
name|n
decl_stmt|;
block|{
name|curr
operator|->
name|ss
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'B'
condition|)
name|c
operator|=
name|ASCII
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|charsets
index|[
name|n
index|]
operator|!=
name|c
condition|)
block|{
name|curr
operator|->
name|charsets
index|[
name|n
index|]
operator|=
name|c
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|LocalCharset
operator|==
name|n
condition|)
name|NewCharset
argument_list|(
name|c
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|MapCharset
parameter_list|(
name|n
parameter_list|)
name|int
name|n
decl_stmt|;
block|{
name|curr
operator|->
name|ss
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|LocalCharset
operator|!=
name|n
condition|)
block|{
name|curr
operator|->
name|LocalCharset
operator|=
name|n
expr_stmt|;
name|NewCharset
argument_list|(
name|curr
operator|->
name|charsets
index|[
name|n
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|NewCharset
parameter_list|(
name|new
parameter_list|)
name|int
name|new
decl_stmt|;
block|{
if|if
condition|(
operator|!
name|display
operator|||
name|GlobalCharset
operator|==
name|new
condition|)
return|return;
name|GlobalCharset
operator|=
name|new
expr_stmt|;
if|if
condition|(
name|new
operator|==
name|ASCII
condition|)
name|PutStr
argument_list|(
name|E0
argument_list|)
expr_stmt|;
else|else
name|CPutStr
argument_list|(
name|S0
argument_list|,
name|new
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|SaveCursor
parameter_list|()
block|{
name|curr
operator|->
name|saved
operator|=
literal|1
expr_stmt|;
name|curr
operator|->
name|Saved_x
operator|=
name|curr
operator|->
name|x
expr_stmt|;
name|curr
operator|->
name|Saved_y
operator|=
name|curr
operator|->
name|y
expr_stmt|;
name|curr
operator|->
name|SavedLocalAttr
operator|=
name|curr
operator|->
name|LocalAttr
expr_stmt|;
name|curr
operator|->
name|SavedLocalCharset
operator|=
name|curr
operator|->
name|LocalCharset
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|curr
operator|->
name|charsets
argument_list|,
operator|(
name|char
operator|*
operator|)
name|curr
operator|->
name|SavedCharsets
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|RestoreCursor
parameter_list|()
block|{
if|if
condition|(
name|curr
operator|->
name|saved
condition|)
block|{
name|GotoPos
argument_list|(
name|curr
operator|->
name|Saved_x
argument_list|,
name|curr
operator|->
name|Saved_y
argument_list|)
expr_stmt|;
name|curr
operator|->
name|x
operator|=
name|curr
operator|->
name|Saved_x
expr_stmt|;
name|curr
operator|->
name|y
operator|=
name|curr
operator|->
name|Saved_y
expr_stmt|;
name|curr
operator|->
name|LocalAttr
operator|=
name|curr
operator|->
name|SavedLocalAttr
expr_stmt|;
name|NewRendition
argument_list|(
name|curr
operator|->
name|LocalAttr
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
operator|(
name|char
operator|*
operator|)
name|curr
operator|->
name|SavedCharsets
argument_list|,
operator|(
name|char
operator|*
operator|)
name|curr
operator|->
name|charsets
argument_list|,
literal|4
operator|*
sizeof|sizeof
argument_list|(
name|int
argument_list|)
argument_list|)
expr_stmt|;
name|curr
operator|->
name|LocalCharset
operator|=
name|curr
operator|->
name|SavedLocalCharset
expr_stmt|;
name|NewCharset
argument_list|(
name|curr
operator|->
name|charsets
index|[
name|curr
operator|->
name|LocalCharset
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_comment
comment|/*ARGSUSED*/
end_comment

begin_function
specifier|static
name|void
name|CountChars
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
name|StrCost
operator|++
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|CalcCost
parameter_list|(
name|s
parameter_list|)
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
block|{
if|if
condition|(
name|s
condition|)
block|{
name|StrCost
operator|=
literal|0
expr_stmt|;
name|tputs
argument_list|(
name|s
argument_list|,
literal|1
argument_list|,
name|CountChars
argument_list|)
expr_stmt|;
return|return
name|StrCost
return|;
block|}
else|else
return|return
name|EXPENSIVE
return|;
block|}
end_function

begin_function
name|void
name|GotoPos
parameter_list|(
name|x2
parameter_list|,
name|y2
parameter_list|)
name|int
name|x2
decl_stmt|,
name|y2
decl_stmt|;
block|{
specifier|register
name|int
name|dy
decl_stmt|,
name|dx
decl_stmt|,
name|x1
decl_stmt|,
name|y1
decl_stmt|;
specifier|register
name|int
name|costx
decl_stmt|,
name|costy
decl_stmt|;
specifier|register
name|int
name|m
decl_stmt|;
specifier|register
name|char
modifier|*
name|s
decl_stmt|;
name|int
name|CMcost
decl_stmt|;
name|enum
name|move_t
name|xm
init|=
name|M_NONE
decl_stmt|,
name|ym
init|=
name|M_NONE
decl_stmt|;
if|if
condition|(
operator|!
name|display
condition|)
return|return;
name|x1
operator|=
name|screenx
expr_stmt|;
name|y1
operator|=
name|screeny
expr_stmt|;
if|if
condition|(
name|x1
operator|==
name|screenwidth
condition|)
if|if
condition|(
name|LP
operator|&&
name|AM
condition|)
name|x1
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* don't know how the terminal treats this */
else|else
name|x1
operator|--
expr_stmt|;
if|if
condition|(
name|x2
operator|==
name|screenwidth
condition|)
name|x2
operator|--
expr_stmt|;
name|dx
operator|=
name|x2
operator|-
name|x1
expr_stmt|;
name|dy
operator|=
name|y2
operator|-
name|y1
expr_stmt|;
if|if
condition|(
name|dy
operator|==
literal|0
operator|&&
name|dx
operator|==
literal|0
condition|)
block|{
return|return;
block|}
if|if
condition|(
operator|!
name|MS
operator|&&
name|GlobalAttr
condition|)
comment|/* Safe to move in SO mode ? */
name|NewRendition
argument_list|(
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|y1
operator|<
literal|0
comment|/* don't know the y position */
operator|||
operator|(
name|y2
operator|>
name|screenbot
operator|&&
name|y1
operator|<=
name|screenbot
operator|)
comment|/* have to cross border */
operator|||
operator|(
name|y2
operator|<
name|screentop
operator|&&
name|y1
operator|>=
name|screentop
operator|)
condition|)
comment|/* of scrollregion ?    */
block|{
name|DoCM
label|:
if|if
condition|(
name|HO
operator|&&
operator|!
name|x2
operator|&&
operator|!
name|y2
condition|)
name|PutStr
argument_list|(
name|HO
argument_list|)
expr_stmt|;
else|else
name|PutStr
argument_list|(
name|tgoto
argument_list|(
name|CM
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|)
argument_list|)
expr_stmt|;
name|screenx
operator|=
name|x2
expr_stmt|;
name|screeny
operator|=
name|y2
expr_stmt|;
return|return;
block|}
comment|/* Calculate CMcost */
if|if
condition|(
name|HO
operator|&&
operator|!
name|x2
operator|&&
operator|!
name|y2
condition|)
name|s
operator|=
name|HO
expr_stmt|;
else|else
name|s
operator|=
name|tgoto
argument_list|(
name|CM
argument_list|,
name|x2
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|CMcost
operator|=
name|CalcCost
argument_list|(
name|s
argument_list|)
expr_stmt|;
comment|/* Calculate the cost to move the cursor to the right x position */
name|costx
operator|=
name|EXPENSIVE
expr_stmt|;
if|if
condition|(
name|x1
operator|>=
literal|0
condition|)
comment|/* relativ x positioning only if we know where we are */
block|{
if|if
condition|(
name|dx
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|CRI
operator|&&
operator|(
name|dx
operator|>
literal|1
operator|||
operator|!
name|ND
operator|)
condition|)
block|{
name|costx
operator|=
name|CalcCost
argument_list|(
name|tgoto
argument_list|(
name|CRI
argument_list|,
literal|0
argument_list|,
name|dx
argument_list|)
argument_list|)
expr_stmt|;
name|xm
operator|=
name|M_CRI
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|m
operator|=
name|NDcost
operator|*
name|dx
operator|)
operator|<
name|costx
condition|)
block|{
name|costx
operator|=
name|m
expr_stmt|;
name|xm
operator|=
name|M_RI
expr_stmt|;
block|}
comment|/* Speedup: dx<= Rewrite() */
if|if
condition|(
name|dx
operator|<
name|costx
operator|&&
operator|(
name|m
operator|=
name|Rewrite
argument_list|(
name|y1
argument_list|,
name|x1
argument_list|,
name|x2
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
name|costx
condition|)
block|{
name|costx
operator|=
name|m
expr_stmt|;
name|xm
operator|=
name|M_RW
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|dx
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|CLE
operator|&&
operator|(
name|dx
operator|<
operator|-
literal|1
operator|||
operator|!
name|BC
operator|)
condition|)
block|{
name|costx
operator|=
name|CalcCost
argument_list|(
name|tgoto
argument_list|(
name|CLE
argument_list|,
literal|0
argument_list|,
operator|-
name|dx
argument_list|)
argument_list|)
expr_stmt|;
name|xm
operator|=
name|M_CLE
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|m
operator|=
operator|-
name|dx
operator|*
name|LEcost
operator|)
operator|<
name|costx
condition|)
block|{
name|costx
operator|=
name|m
expr_stmt|;
name|xm
operator|=
name|M_LE
expr_stmt|;
block|}
block|}
else|else
name|costx
operator|=
literal|0
expr_stmt|;
block|}
comment|/* Speedup: Rewrite()>= x2 */
if|if
condition|(
name|x2
operator|+
name|CRcost
operator|<
name|costx
operator|&&
operator|(
name|m
operator|=
name|Rewrite
argument_list|(
name|y1
argument_list|,
literal|0
argument_list|,
name|x2
argument_list|,
literal|0
argument_list|)
operator|+
name|CRcost
operator|)
operator|<
name|costx
condition|)
block|{
name|costx
operator|=
name|m
expr_stmt|;
name|xm
operator|=
name|M_CR
expr_stmt|;
block|}
comment|/* Check if it is already cheaper to do CM */
if|if
condition|(
name|costx
operator|>=
name|CMcost
condition|)
goto|goto
name|DoCM
goto|;
comment|/* Calculate the cost to move the cursor to the right y position */
name|costy
operator|=
name|EXPENSIVE
expr_stmt|;
if|if
condition|(
name|dy
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|CDO
operator|&&
name|dy
operator|>
literal|1
condition|)
comment|/* DO& NL are always != 0 */
block|{
name|costy
operator|=
name|CalcCost
argument_list|(
name|tgoto
argument_list|(
name|CDO
argument_list|,
literal|0
argument_list|,
name|dy
argument_list|)
argument_list|)
expr_stmt|;
name|ym
operator|=
name|M_CDO
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|m
operator|=
name|dy
operator|*
operator|(
operator|(
name|x2
operator|==
literal|0
operator|)
condition|?
name|NLcost
else|:
name|DOcost
operator|)
operator|)
operator|<
name|costy
condition|)
block|{
name|costy
operator|=
name|m
expr_stmt|;
name|ym
operator|=
name|M_DO
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|dy
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|CUP
operator|&&
operator|(
name|dy
operator|<
operator|-
literal|1
operator|||
operator|!
name|UP
operator|)
condition|)
block|{
name|costy
operator|=
name|CalcCost
argument_list|(
name|tgoto
argument_list|(
name|CUP
argument_list|,
literal|0
argument_list|,
operator|-
name|dy
argument_list|)
argument_list|)
expr_stmt|;
name|ym
operator|=
name|M_CUP
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|m
operator|=
operator|-
name|dy
operator|*
name|UPcost
operator|)
operator|<
name|costy
condition|)
block|{
name|costy
operator|=
name|m
expr_stmt|;
name|ym
operator|=
name|M_UP
expr_stmt|;
block|}
block|}
else|else
name|costy
operator|=
literal|0
expr_stmt|;
comment|/* Finally check if it is cheaper to do CM */
if|if
condition|(
name|costx
operator|+
name|costy
operator|>=
name|CMcost
condition|)
goto|goto
name|DoCM
goto|;
switch|switch
condition|(
name|xm
condition|)
block|{
case|case
name|M_LE
case|:
while|while
condition|(
name|dx
operator|++
operator|<
literal|0
condition|)
name|PutStr
argument_list|(
name|BC
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_CLE
case|:
name|CPutStr
argument_list|(
name|CLE
argument_list|,
operator|-
name|dx
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_RI
case|:
while|while
condition|(
name|dx
operator|--
operator|>
literal|0
condition|)
name|PutStr
argument_list|(
name|ND
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_CRI
case|:
name|CPutStr
argument_list|(
name|CRI
argument_list|,
name|dx
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_CR
case|:
name|PutStr
argument_list|(
name|CR
argument_list|)
expr_stmt|;
name|screenx
operator|=
literal|0
expr_stmt|;
name|x1
operator|=
literal|0
expr_stmt|;
comment|/* FALLTHROUGH */
case|case
name|M_RW
case|:
if|if
condition|(
name|x1
operator|<
name|x2
condition|)
operator|(
name|void
operator|)
name|Rewrite
argument_list|(
name|y1
argument_list|,
name|x1
argument_list|,
name|x2
argument_list|,
literal|1
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
switch|switch
condition|(
name|ym
condition|)
block|{
case|case
name|M_UP
case|:
while|while
condition|(
name|dy
operator|++
operator|<
literal|0
condition|)
name|PutStr
argument_list|(
name|UP
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_CUP
case|:
name|CPutStr
argument_list|(
name|CUP
argument_list|,
operator|-
name|dy
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_DO
case|:
name|s
operator|=
operator|(
name|x2
operator|==
literal|0
operator|)
condition|?
name|NL
else|:
name|DO
expr_stmt|;
while|while
condition|(
name|dy
operator|--
operator|>
literal|0
condition|)
name|PutStr
argument_list|(
name|s
argument_list|)
expr_stmt|;
break|break;
case|case
name|M_CDO
case|:
name|CPutStr
argument_list|(
name|CDO
argument_list|,
name|dy
argument_list|)
expr_stmt|;
break|break;
default|default:
break|break;
block|}
name|screenx
operator|=
name|x2
expr_stmt|;
name|screeny
operator|=
name|y2
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|int
name|Rewrite
parameter_list|(
name|y
parameter_list|,
name|x1
parameter_list|,
name|x2
parameter_list|,
name|doit
parameter_list|)
name|int
name|y
decl_stmt|,
name|x1
decl_stmt|,
name|x2
decl_stmt|,
name|doit
decl_stmt|;
block|{
specifier|register
name|int
name|cost
decl_stmt|,
name|dx
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|f
decl_stmt|,
modifier|*
name|i
decl_stmt|;
if|if
condition|(
name|x1
operator|==
name|x2
condition|)
return|return
operator|(
literal|0
operator|)
return|;
if|if
condition|(
name|in_ovl
condition|)
block|{
if|if
condition|(
name|ovl_Rewrite
operator|==
literal|0
condition|)
return|return
name|EXPENSIVE
return|;
else|else
return|return
operator|(
call|(
modifier|*
name|ovl_Rewrite
call|)
argument_list|(
name|y
argument_list|,
name|x1
argument_list|,
name|x2
argument_list|,
name|doit
argument_list|)
operator|)
return|;
block|}
name|dx
operator|=
name|x2
operator|-
name|x1
expr_stmt|;
if|if
condition|(
name|doit
condition|)
block|{
name|i
operator|=
name|curr
operator|->
name|image
index|[
name|y
index|]
operator|+
name|x1
expr_stmt|;
while|while
condition|(
name|dx
operator|--
operator|>
literal|0
condition|)
name|PUTCHAR
argument_list|(
operator|*
name|i
operator|++
argument_list|)
expr_stmt|;
return|return
operator|(
literal|0
operator|)
return|;
block|}
name|p
operator|=
name|curr
operator|->
name|attr
index|[
name|y
index|]
operator|+
name|x1
expr_stmt|;
name|f
operator|=
name|curr
operator|->
name|font
index|[
name|y
index|]
operator|+
name|x1
expr_stmt|;
name|cost
operator|=
name|dx
operator|=
name|x2
operator|-
name|x1
expr_stmt|;
if|if
condition|(
name|insert
condition|)
name|cost
operator|+=
name|EIcost
operator|+
name|IMcost
expr_stmt|;
while|while
condition|(
name|dx
operator|--
operator|>
literal|0
condition|)
block|{
if|if
condition|(
operator|*
name|p
operator|++
operator|!=
name|GlobalAttr
operator|||
operator|*
name|f
operator|++
operator|!=
name|GlobalCharset
condition|)
return|return
name|EXPENSIVE
return|;
block|}
return|return
name|cost
return|;
block|}
end_function

begin_function
specifier|static
name|void
name|BackSpace
parameter_list|()
block|{
if|if
condition|(
name|curr
operator|->
name|x
operator|>
literal|0
condition|)
block|{
name|curr
operator|->
name|x
operator|--
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|curr
operator|->
name|wrap
operator|&&
name|curr
operator|->
name|y
operator|>
literal|0
condition|)
block|{
name|curr
operator|->
name|x
operator|=
name|cols
operator|-
literal|1
expr_stmt|;
name|curr
operator|->
name|y
operator|--
expr_stmt|;
block|}
if|if
condition|(
name|display
condition|)
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Return
parameter_list|()
block|{
if|if
condition|(
name|curr
operator|->
name|x
operator|>
literal|0
condition|)
block|{
name|curr
operator|->
name|x
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|display
condition|)
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|LineFeed
parameter_list|(
name|out_mode
parameter_list|)
name|int
name|out_mode
decl_stmt|;
block|{
comment|/* out_mode: 0=no-output lf, 1=lf, 2=cr+lf */
if|if
condition|(
name|out_mode
operator|==
literal|2
condition|)
name|curr
operator|->
name|x
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|y
operator|!=
name|curr
operator|->
name|bot
condition|)
comment|/* Don't scroll */
block|{
if|if
condition|(
name|curr
operator|->
name|y
operator|<
name|rows
operator|-
literal|1
condition|)
name|curr
operator|->
name|y
operator|++
expr_stmt|;
if|if
condition|(
name|out_mode
operator|&&
name|display
condition|)
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
return|return;
block|}
name|ScrollUpMap
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
name|curr
operator|->
name|autoaka
operator|>
literal|1
condition|)
name|curr
operator|->
name|autoaka
operator|--
expr_stmt|;
if|if
condition|(
name|out_mode
operator|&&
name|display
condition|)
block|{
name|ScrollRegion
argument_list|(
name|curr
operator|->
name|top
argument_list|,
name|curr
operator|->
name|bot
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ReverseLineFeed
parameter_list|()
block|{
if|if
condition|(
name|curr
operator|->
name|y
operator|==
name|curr
operator|->
name|top
condition|)
block|{
name|ScrollDownMap
argument_list|(
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|display
condition|)
return|return;
name|ScrollRegion
argument_list|(
name|curr
operator|->
name|top
argument_list|,
name|curr
operator|->
name|bot
argument_list|,
operator|-
literal|1
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|curr
operator|->
name|y
operator|>
literal|0
condition|)
name|CursorUp
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|InsertAChar
parameter_list|(
name|c
parameter_list|)
name|int
name|c
decl_stmt|;
block|{
specifier|register
name|int
name|y
init|=
name|curr
operator|->
name|y
decl_stmt|,
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
if|if
condition|(
name|x
operator|==
name|cols
condition|)
name|x
operator|--
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|image
index|[
name|y
index|]
argument_list|,
name|OldImage
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|attr
index|[
name|y
index|]
argument_list|,
name|OldAttr
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|font
index|[
name|y
index|]
argument_list|,
name|OldFont
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|image
index|[
name|y
index|]
operator|+
name|x
argument_list|,
name|curr
operator|->
name|image
index|[
name|y
index|]
operator|+
name|x
operator|+
literal|1
argument_list|,
name|cols
operator|-
name|x
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|attr
index|[
name|y
index|]
operator|+
name|x
argument_list|,
name|curr
operator|->
name|attr
index|[
name|y
index|]
operator|+
name|x
operator|+
literal|1
argument_list|,
name|cols
operator|-
name|x
operator|-
literal|1
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|font
index|[
name|y
index|]
operator|+
name|x
argument_list|,
name|curr
operator|->
name|font
index|[
name|y
index|]
operator|+
name|x
operator|+
literal|1
argument_list|,
name|cols
operator|-
name|x
operator|-
literal|1
argument_list|)
expr_stmt|;
name|SetChar
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|display
condition|)
return|return;
if|if
condition|(
name|CIC
operator|||
name|IC
operator|||
name|IM
condition|)
block|{
name|InsertMode
argument_list|(
name|curr
operator|->
name|insert
argument_list|)
expr_stmt|;
name|INSERTCHAR
argument_list|(
name|c
argument_list|)
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|screenbot
condition|)
name|lp_missing
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|RedisplayLine
argument_list|(
name|OldImage
argument_list|,
name|OldAttr
argument_list|,
name|OldFont
argument_list|,
name|y
argument_list|,
name|x
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
operator|++
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|InsertChar
parameter_list|(
name|n
parameter_list|)
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|y
init|=
name|curr
operator|->
name|y
decl_stmt|,
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
if|if
condition|(
name|n
operator|<=
literal|0
condition|)
return|return;
comment|/*    * The termcap manual states that only one of IM and IC is    * to be defined unless the terminal needs both sequences.    * We don't like this because we think that there may be cases    * where it is preferable to send IC instead of IM/EI.    * The hack is to ignore the IC sequence if we are already    * in insert mode, so that programs which follow the termcap    * guidelines still work. (I don't believe that there are    * terminals which need IC in the insert mode. Why switch to    * insert mode if you must send IC before every character ?)    */
if|if
condition|(
name|curr
operator|->
name|insert
condition|)
return|return;
if|if
condition|(
name|x
operator|==
name|cols
condition|)
operator|--
name|x
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|image
index|[
name|y
index|]
argument_list|,
name|OldImage
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|attr
index|[
name|y
index|]
argument_list|,
name|OldAttr
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|font
index|[
name|y
index|]
argument_list|,
name|OldFont
argument_list|,
name|cols
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|cols
operator|-
name|x
condition|)
name|n
operator|=
name|cols
operator|-
name|x
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|image
index|[
name|y
index|]
operator|+
name|x
argument_list|,
name|curr
operator|->
name|image
index|[
name|y
index|]
operator|+
name|x
operator|+
name|n
argument_list|,
name|cols
operator|-
name|x
operator|-
name|n
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|attr
index|[
name|y
index|]
operator|+
name|x
argument_list|,
name|curr
operator|->
name|attr
index|[
name|y
index|]
operator|+
name|x
operator|+
name|n
argument_list|,
name|cols
operator|-
name|x
operator|-
name|n
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|font
index|[
name|y
index|]
operator|+
name|x
argument_list|,
name|curr
operator|->
name|font
index|[
name|y
index|]
operator|+
name|x
operator|+
name|n
argument_list|,
name|cols
operator|-
name|x
operator|-
name|n
argument_list|)
expr_stmt|;
name|ClearInLine
argument_list|(
literal|0
argument_list|,
name|y
argument_list|,
name|x
argument_list|,
name|x
operator|+
name|n
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|display
condition|)
return|return;
if|if
condition|(
name|IC
operator|||
name|CIC
operator|||
name|IM
condition|)
block|{
if|if
condition|(
name|y
operator|==
name|screenbot
condition|)
name|lp_missing
operator|=
literal|0
expr_stmt|;
if|if
condition|(
operator|!
name|insert
condition|)
block|{
if|if
condition|(
name|n
operator|==
literal|1
operator|&&
name|IC
condition|)
block|{
name|PutStr
argument_list|(
name|IC
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|CIC
condition|)
block|{
name|CPutStr
argument_list|(
name|CIC
argument_list|,
name|n
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|InsertMode
argument_list|(
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
operator|--
condition|;
control|)
name|INSERTCHAR
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|RedisplayLine
argument_list|(
name|OldImage
argument_list|,
name|OldAttr
argument_list|,
name|OldFont
argument_list|,
name|y
argument_list|,
name|x
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|DeleteChar
parameter_list|(
name|n
parameter_list|)
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|y
init|=
name|curr
operator|->
name|y
decl_stmt|,
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
if|if
condition|(
name|x
operator|==
name|cols
condition|)
operator|--
name|x
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|image
index|[
name|y
index|]
argument_list|,
name|OldImage
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|attr
index|[
name|y
index|]
argument_list|,
name|OldAttr
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|font
index|[
name|y
index|]
argument_list|,
name|OldFont
argument_list|,
name|cols
argument_list|)
expr_stmt|;
if|if
condition|(
name|n
operator|>
name|cols
operator|-
name|x
condition|)
name|n
operator|=
name|cols
operator|-
name|x
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|image
index|[
name|y
index|]
operator|+
name|x
operator|+
name|n
argument_list|,
name|curr
operator|->
name|image
index|[
name|y
index|]
operator|+
name|x
argument_list|,
name|cols
operator|-
name|x
operator|-
name|n
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|attr
index|[
name|y
index|]
operator|+
name|x
operator|+
name|n
argument_list|,
name|curr
operator|->
name|attr
index|[
name|y
index|]
operator|+
name|x
argument_list|,
name|cols
operator|-
name|x
operator|-
name|n
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|curr
operator|->
name|font
index|[
name|y
index|]
operator|+
name|x
operator|+
name|n
argument_list|,
name|curr
operator|->
name|font
index|[
name|y
index|]
operator|+
name|x
argument_list|,
name|cols
operator|-
name|x
operator|-
name|n
argument_list|)
expr_stmt|;
name|ClearInLine
argument_list|(
literal|0
argument_list|,
name|y
argument_list|,
name|cols
operator|-
name|n
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|display
condition|)
return|return;
if|if
condition|(
name|CDC
operator|&&
operator|!
operator|(
name|n
operator|==
literal|1
operator|&&
name|DC
operator|)
condition|)
block|{
name|CPutStr
argument_list|(
name|CDC
argument_list|,
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|lp_missing
operator|&&
name|y
operator|==
name|screenbot
condition|)
block|{
name|FixLP
argument_list|(
name|cols
operator|-
literal|1
operator|-
name|n
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|DC
condition|)
block|{
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
condition|;
name|i
operator|--
control|)
name|PutStr
argument_list|(
name|DC
argument_list|)
expr_stmt|;
if|if
condition|(
name|lp_missing
operator|&&
name|y
operator|==
name|screenbot
condition|)
block|{
name|FixLP
argument_list|(
name|cols
operator|-
literal|1
operator|-
name|n
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|RedisplayLine
argument_list|(
name|OldImage
argument_list|,
name|OldAttr
argument_list|,
name|OldFont
argument_list|,
name|y
argument_list|,
name|x
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|DeleteLine
parameter_list|(
name|n
parameter_list|)
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|old
init|=
name|curr
operator|->
name|top
decl_stmt|;
if|if
condition|(
name|curr
operator|->
name|y
operator|<
name|curr
operator|->
name|top
operator|||
name|curr
operator|->
name|y
operator|>
name|curr
operator|->
name|bot
condition|)
return|return;
if|if
condition|(
name|n
operator|>
name|curr
operator|->
name|bot
operator|-
name|curr
operator|->
name|y
operator|+
literal|1
condition|)
name|n
operator|=
name|curr
operator|->
name|bot
operator|-
name|curr
operator|->
name|y
operator|+
literal|1
expr_stmt|;
name|curr
operator|->
name|top
operator|=
name|curr
operator|->
name|y
expr_stmt|;
name|ScrollUpMap
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|curr
operator|->
name|top
operator|=
name|old
expr_stmt|;
if|if
condition|(
operator|!
name|display
condition|)
return|return;
name|ScrollRegion
argument_list|(
name|curr
operator|->
name|y
argument_list|,
name|curr
operator|->
name|bot
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|InsertLine
parameter_list|(
name|n
parameter_list|)
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|old
init|=
name|curr
operator|->
name|top
decl_stmt|;
if|if
condition|(
name|curr
operator|->
name|y
operator|<
name|curr
operator|->
name|top
operator|||
name|curr
operator|->
name|y
operator|>
name|curr
operator|->
name|bot
condition|)
return|return;
if|if
condition|(
name|n
operator|>
name|curr
operator|->
name|bot
operator|-
name|curr
operator|->
name|y
operator|+
literal|1
condition|)
name|n
operator|=
name|curr
operator|->
name|bot
operator|-
name|curr
operator|->
name|y
operator|+
literal|1
expr_stmt|;
name|curr
operator|->
name|top
operator|=
name|curr
operator|->
name|y
expr_stmt|;
name|ScrollDownMap
argument_list|(
name|n
argument_list|)
expr_stmt|;
name|curr
operator|->
name|top
operator|=
name|old
expr_stmt|;
if|if
condition|(
operator|!
name|display
condition|)
return|return;
name|ScrollRegion
argument_list|(
name|curr
operator|->
name|y
argument_list|,
name|curr
operator|->
name|bot
argument_list|,
operator|-
name|n
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ScrollRegion
parameter_list|(
name|ys
parameter_list|,
name|ye
parameter_list|,
name|n
parameter_list|)
name|int
name|ys
decl_stmt|,
name|ye
decl_stmt|,
name|n
decl_stmt|;
block|{
name|int
name|i
decl_stmt|;
name|int
name|up
decl_stmt|;
name|int
name|oldtop
decl_stmt|,
name|oldbot
decl_stmt|;
name|int
name|alok
decl_stmt|,
name|dlok
decl_stmt|,
name|aldlfaster
decl_stmt|;
name|int
name|missy
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|n
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|ys
operator|==
literal|0
operator|&&
name|ye
operator|==
name|screenheight
operator|-
literal|1
operator|&&
operator|(
name|n
operator|>=
name|screenheight
operator|||
operator|-
name|n
operator|>=
name|screenheight
operator|)
condition|)
block|{
name|PutStr
argument_list|(
name|CL
argument_list|)
expr_stmt|;
name|screeny
operator|=
name|screenx
operator|=
literal|0
expr_stmt|;
name|lp_missing
operator|=
literal|0
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|lp_missing
condition|)
block|{
if|if
condition|(
name|screenbot
operator|>
name|ye
operator|||
name|screenbot
operator|<
name|ys
condition|)
name|missy
operator|=
name|screenbot
expr_stmt|;
else|else
block|{
name|missy
operator|=
name|screenbot
operator|-
name|n
expr_stmt|;
if|if
condition|(
name|missy
operator|>
name|ye
operator|||
name|missy
operator|<
name|ys
condition|)
name|lp_missing
operator|=
literal|0
expr_stmt|;
block|}
block|}
name|up
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|n
operator|<
literal|0
condition|)
block|{
name|up
operator|=
literal|0
expr_stmt|;
name|n
operator|=
operator|-
name|n
expr_stmt|;
block|}
if|if
condition|(
name|n
operator|>=
name|ye
operator|-
name|ys
operator|+
literal|1
condition|)
name|n
operator|=
name|ye
operator|-
name|ys
operator|+
literal|1
expr_stmt|;
name|oldtop
operator|=
name|screentop
expr_stmt|;
name|oldbot
operator|=
name|screenbot
expr_stmt|;
if|if
condition|(
name|screenbot
operator|!=
name|ye
condition|)
name|ChangeScrollRegion
argument_list|(
name|ys
argument_list|,
name|ye
argument_list|)
expr_stmt|;
name|alok
operator|=
operator|(
name|AL
operator|||
name|CAL
operator|||
operator|(
name|ye
operator|==
name|screenbot
operator|&&
name|up
operator|)
operator|)
expr_stmt|;
name|dlok
operator|=
operator|(
name|DL
operator|||
name|CDL
operator|||
operator|(
name|ye
operator|==
name|screenbot
operator|&&
operator|!
name|up
operator|)
operator|)
expr_stmt|;
if|if
condition|(
name|screentop
operator|!=
name|ys
operator|&&
operator|!
operator|(
name|alok
operator|&&
name|dlok
operator|)
condition|)
name|ChangeScrollRegion
argument_list|(
name|ys
argument_list|,
name|ye
argument_list|)
expr_stmt|;
if|if
condition|(
name|lp_missing
operator|&&
operator|(
name|oldbot
operator|!=
name|screenbot
operator|||
operator|(
name|oldbot
operator|==
name|screenbot
operator|&&
name|up
operator|&&
name|screentop
operator|==
name|ys
operator|&&
name|screenbot
operator|==
name|ye
operator|)
operator|)
condition|)
block|{
comment|/* Can't use FixLP */
name|GotoPos
argument_list|(
name|screenwidth
operator|-
literal|1
argument_list|,
name|oldbot
argument_list|)
expr_stmt|;
name|SaveSetAttr
argument_list|(
name|curr
operator|->
name|attr
index|[
name|missy
index|]
index|[
name|screenwidth
operator|-
literal|1
index|]
argument_list|,
name|curr
operator|->
name|font
index|[
name|missy
index|]
index|[
name|screenwidth
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|curr
operator|->
name|image
index|[
name|missy
index|]
index|[
name|screenwidth
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|RestoreAttr
argument_list|()
expr_stmt|;
name|lp_missing
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|oldbot
operator|==
name|screenbot
condition|)
comment|/* have scrolled */
block|{
if|if
condition|(
operator|--
name|n
operator|==
literal|0
condition|)
block|{
name|ChangeScrollRegion
argument_list|(
name|oldtop
argument_list|,
name|oldbot
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
block|}
name|aldlfaster
operator|=
operator|(
name|n
operator|>
literal|1
operator|&&
name|ye
operator|==
name|screenbot
operator|&&
operator|(
operator|(
name|up
operator|&&
name|CDL
operator|)
operator|||
operator|(
operator|!
name|up
operator|&&
name|CAL
operator|)
operator|)
operator|)
expr_stmt|;
if|if
condition|(
operator|(
name|up
operator|||
name|SR
operator|)
operator|&&
name|screentop
operator|==
name|ys
operator|&&
name|screenbot
operator|==
name|ye
operator|&&
operator|!
name|aldlfaster
condition|)
block|{
if|if
condition|(
name|up
condition|)
block|{
name|GotoPos
argument_list|(
literal|0
argument_list|,
name|ye
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
operator|>
literal|0
condition|)
name|PutStr
argument_list|(
name|NL
argument_list|)
expr_stmt|;
comment|/* was SF, I think NL is faster */
block|}
else|else
block|{
name|GotoPos
argument_list|(
literal|0
argument_list|,
name|ys
argument_list|)
expr_stmt|;
while|while
condition|(
name|n
operator|--
operator|>
literal|0
condition|)
name|PutStr
argument_list|(
name|SR
argument_list|)
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|alok
operator|&&
name|dlok
condition|)
block|{
if|if
condition|(
name|up
operator|||
name|ye
operator|!=
name|screenbot
condition|)
block|{
name|GotoPos
argument_list|(
literal|0
argument_list|,
name|up
condition|?
name|ys
else|:
name|ye
operator|+
literal|1
operator|-
name|n
argument_list|)
expr_stmt|;
if|if
condition|(
name|CDL
operator|&&
operator|!
operator|(
name|n
operator|==
literal|1
operator|&&
name|DL
operator|)
condition|)
name|CPutStr
argument_list|(
name|CDL
argument_list|,
name|n
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
operator|--
condition|;
control|)
name|PutStr
argument_list|(
name|DL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|up
operator|||
name|ye
operator|!=
name|screenbot
condition|)
block|{
name|GotoPos
argument_list|(
literal|0
argument_list|,
name|up
condition|?
name|ye
operator|+
literal|1
operator|-
name|n
else|:
name|ys
argument_list|)
expr_stmt|;
if|if
condition|(
name|CAL
operator|&&
operator|!
operator|(
name|n
operator|==
literal|1
operator|&&
name|AL
operator|)
condition|)
name|CPutStr
argument_list|(
name|CAL
argument_list|,
name|n
argument_list|)
expr_stmt|;
else|else
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
operator|--
condition|;
control|)
name|PutStr
argument_list|(
name|AL
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|Redisplay
argument_list|(
literal|0
argument_list|)
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|lp_missing
operator|&&
name|missy
operator|!=
name|screenbot
condition|)
name|FixLP
argument_list|(
name|screenwidth
operator|-
literal|1
argument_list|,
name|missy
argument_list|)
expr_stmt|;
name|ChangeScrollRegion
argument_list|(
name|oldtop
argument_list|,
name|oldbot
argument_list|)
expr_stmt|;
if|if
condition|(
name|lp_missing
operator|&&
name|missy
operator|!=
name|screenbot
condition|)
name|FixLP
argument_list|(
name|screenwidth
operator|-
literal|1
argument_list|,
name|missy
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ScrollUpMap
parameter_list|(
name|n
parameter_list|)
name|int
name|n
decl_stmt|;
block|{
name|char
name|tmp
index|[
literal|256
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
index|]
decl_stmt|;
specifier|register
name|int
name|ii
decl_stmt|,
name|i
decl_stmt|,
name|cnt1
decl_stmt|,
name|cnt2
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|ppi
decl_stmt|,
modifier|*
modifier|*
name|ppa
decl_stmt|,
modifier|*
modifier|*
name|ppf
decl_stmt|;
name|i
operator|=
name|curr
operator|->
name|top
operator|+
name|n
expr_stmt|;
name|cnt1
operator|=
name|n
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
expr_stmt|;
name|cnt2
operator|=
operator|(
name|curr
operator|->
name|bot
operator|-
name|i
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
expr_stmt|;
name|ppi
operator|=
name|curr
operator|->
name|image
operator|+
name|i
expr_stmt|;
name|ppa
operator|=
name|curr
operator|->
name|attr
operator|+
name|i
expr_stmt|;
name|ppf
operator|=
name|curr
operator|->
name|font
operator|+
name|i
expr_stmt|;
for|for
control|(
name|ii
operator|=
name|curr
operator|->
name|top
init|;
name|ii
operator|<
name|i
condition|;
name|ii
operator|++
control|)
name|AddLineToHist
argument_list|(
name|curr
argument_list|,
operator|&
name|curr
operator|->
name|image
index|[
name|ii
index|]
argument_list|,
operator|&
name|curr
operator|->
name|attr
index|[
name|ii
index|]
argument_list|,
operator|&
name|curr
operator|->
name|font
index|[
name|ii
index|]
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
condition|;
operator|--
name|i
control|)
block|{
name|bclear
argument_list|(
operator|*
operator|--
name|ppi
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|*
operator|--
name|ppa
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|*
operator|--
name|ppf
argument_list|,
name|cols
argument_list|)
expr_stmt|;
block|}
name|Scroll
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ppi
argument_list|,
name|cnt1
argument_list|,
name|cnt2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Scroll
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ppa
argument_list|,
name|cnt1
argument_list|,
name|cnt2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Scroll
argument_list|(
operator|(
name|char
operator|*
operator|)
name|ppf
argument_list|,
name|cnt1
argument_list|,
name|cnt2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ScrollDownMap
parameter_list|(
name|n
parameter_list|)
name|int
name|n
decl_stmt|;
block|{
name|char
name|tmp
index|[
literal|256
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
index|]
decl_stmt|;
specifier|register
name|int
name|i
decl_stmt|,
name|cnt1
decl_stmt|,
name|cnt2
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|ppi
decl_stmt|,
modifier|*
modifier|*
name|ppa
decl_stmt|,
modifier|*
modifier|*
name|ppf
decl_stmt|;
name|i
operator|=
name|curr
operator|->
name|top
expr_stmt|;
name|cnt1
operator|=
operator|(
name|curr
operator|->
name|bot
operator|-
name|i
operator|-
name|n
operator|+
literal|1
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
expr_stmt|;
name|cnt2
operator|=
name|n
operator|*
sizeof|sizeof
argument_list|(
name|char
operator|*
argument_list|)
expr_stmt|;
name|Scroll
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ppi
operator|=
name|curr
operator|->
name|image
operator|+
name|i
operator|)
argument_list|,
name|cnt1
argument_list|,
name|cnt2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Scroll
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ppa
operator|=
name|curr
operator|->
name|attr
operator|+
name|i
operator|)
argument_list|,
name|cnt1
argument_list|,
name|cnt2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
name|Scroll
argument_list|(
operator|(
name|char
operator|*
operator|)
operator|(
name|ppf
operator|=
name|curr
operator|->
name|font
operator|+
name|i
operator|)
argument_list|,
name|cnt1
argument_list|,
name|cnt2
argument_list|,
name|tmp
argument_list|)
expr_stmt|;
for|for
control|(
name|i
operator|=
name|n
init|;
name|i
condition|;
operator|--
name|i
control|)
block|{
name|bclear
argument_list|(
operator|*
name|ppi
operator|++
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|*
name|ppa
operator|++
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|*
name|ppf
operator|++
argument_list|,
name|cols
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|Scroll
parameter_list|(
name|cp
parameter_list|,
name|cnt1
parameter_list|,
name|cnt2
parameter_list|,
name|tmp
parameter_list|)
name|char
modifier|*
name|cp
decl_stmt|,
decl|*
name|tmp
decl_stmt|;
end_function

begin_decl_stmt
name|int
name|cnt1
decl_stmt|,
name|cnt2
decl_stmt|;
end_decl_stmt

begin_block
block|{
if|if
condition|(
operator|!
name|cnt1
operator|||
operator|!
name|cnt2
condition|)
return|return;
if|if
condition|(
name|cnt1
operator|<=
name|cnt2
condition|)
block|{
name|bcopy
argument_list|(
name|cp
argument_list|,
name|tmp
argument_list|,
name|cnt1
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|cp
operator|+
name|cnt1
argument_list|,
name|cp
argument_list|,
name|cnt2
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|tmp
argument_list|,
name|cp
operator|+
name|cnt2
argument_list|,
name|cnt1
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|bcopy
argument_list|(
name|cp
operator|+
name|cnt1
argument_list|,
name|tmp
argument_list|,
name|cnt2
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|cp
argument_list|,
name|cp
operator|+
name|cnt2
argument_list|,
name|cnt1
argument_list|)
expr_stmt|;
name|bcopy
argument_list|(
name|tmp
argument_list|,
name|cp
argument_list|,
name|cnt2
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
specifier|static
name|void
name|ForwardTab
parameter_list|()
block|{
specifier|register
name|int
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
if|if
condition|(
name|x
operator|==
name|cols
condition|)
block|{
name|LineFeed
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|x
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|curr
operator|->
name|tabs
index|[
name|x
index|]
operator|&&
name|x
operator|<
name|cols
operator|-
literal|1
condition|)
name|x
operator|++
expr_stmt|;
while|while
condition|(
name|x
operator|<
name|cols
operator|-
literal|1
operator|&&
operator|!
name|curr
operator|->
name|tabs
index|[
name|x
index|]
condition|)
name|x
operator|++
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
name|curr
operator|->
name|x
operator|=
name|x
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|BackwardTab
parameter_list|()
block|{
specifier|register
name|int
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
if|if
condition|(
name|curr
operator|->
name|tabs
index|[
name|x
index|]
operator|&&
name|x
operator|>
literal|0
condition|)
name|x
operator|--
expr_stmt|;
while|while
condition|(
name|x
operator|>
literal|0
operator|&&
operator|!
name|curr
operator|->
name|tabs
index|[
name|x
index|]
condition|)
name|x
operator|--
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
name|curr
operator|->
name|x
operator|=
name|x
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ClearScreen
parameter_list|()
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
modifier|*
name|ppi
init|=
name|curr
operator|->
name|image
decl_stmt|,
modifier|*
modifier|*
name|ppa
init|=
name|curr
operator|->
name|attr
decl_stmt|,
modifier|*
modifier|*
name|ppf
init|=
name|curr
operator|->
name|font
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rows
condition|;
operator|++
name|i
control|)
block|{
name|AddLineToHist
argument_list|(
name|curr
argument_list|,
name|ppi
argument_list|,
name|ppa
argument_list|,
name|ppf
argument_list|)
expr_stmt|;
name|bclear
argument_list|(
operator|*
name|ppi
operator|++
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|*
name|ppa
operator|++
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
operator|*
name|ppf
operator|++
argument_list|,
name|cols
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|display
condition|)
block|{
name|PutStr
argument_list|(
name|CL
argument_list|)
expr_stmt|;
name|screenx
operator|=
name|screeny
operator|=
literal|0
expr_stmt|;
name|lp_missing
operator|=
literal|0
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|ClearFromBOS
parameter_list|()
block|{
specifier|register
name|int
name|n
decl_stmt|,
name|y
init|=
name|curr
operator|->
name|y
decl_stmt|,
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
for|for
control|(
name|n
operator|=
literal|0
init|;
name|n
operator|<
name|y
condition|;
operator|++
name|n
control|)
name|ClearInLine
argument_list|(
literal|1
argument_list|,
name|n
argument_list|,
literal|0
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ClearInLine
argument_list|(
literal|1
argument_list|,
name|y
argument_list|,
literal|0
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|RestoreAttr
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ClearToEOS
parameter_list|()
block|{
specifier|register
name|int
name|n
decl_stmt|,
name|y
init|=
name|curr
operator|->
name|y
decl_stmt|,
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
if|if
condition|(
operator|!
name|y
operator|&&
operator|!
name|x
condition|)
block|{
name|ClearScreen
argument_list|()
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|display
operator|&&
name|CD
condition|)
block|{
name|PutStr
argument_list|(
name|CD
argument_list|)
expr_stmt|;
name|lp_missing
operator|=
literal|0
expr_stmt|;
block|}
name|ClearInLine
argument_list|(
operator|!
name|CD
argument_list|,
name|y
argument_list|,
name|x
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
for|for
control|(
name|n
operator|=
name|y
operator|+
literal|1
init|;
name|n
operator|<
name|rows
condition|;
name|n
operator|++
control|)
name|ClearInLine
argument_list|(
operator|!
name|CD
argument_list|,
name|n
argument_list|,
literal|0
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|RestoreAttr
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ClearLine
parameter_list|()
block|{
specifier|register
name|int
name|y
init|=
name|curr
operator|->
name|y
decl_stmt|,
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
name|ClearInLine
argument_list|(
literal|1
argument_list|,
name|y
argument_list|,
literal|0
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|RestoreAttr
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ClearToEOL
parameter_list|()
block|{
specifier|register
name|int
name|y
init|=
name|curr
operator|->
name|y
decl_stmt|,
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
name|ClearInLine
argument_list|(
literal|1
argument_list|,
name|y
argument_list|,
name|x
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|RestoreAttr
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ClearFromBOL
parameter_list|()
block|{
specifier|register
name|int
name|y
init|=
name|curr
operator|->
name|y
decl_stmt|,
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
name|ClearInLine
argument_list|(
literal|1
argument_list|,
name|y
argument_list|,
literal|0
argument_list|,
name|x
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|RestoreAttr
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ClearInLine
parameter_list|(
name|displ
parameter_list|,
name|y
parameter_list|,
name|x1
parameter_list|,
name|x2
parameter_list|)
name|int
name|displ
decl_stmt|,
name|y
decl_stmt|,
name|x1
decl_stmt|,
name|x2
decl_stmt|;
block|{
specifier|register
name|int
name|n
decl_stmt|;
if|if
condition|(
name|x1
operator|==
name|cols
condition|)
name|x1
operator|--
expr_stmt|;
if|if
condition|(
name|x2
operator|==
name|cols
condition|)
name|x2
operator|--
expr_stmt|;
if|if
condition|(
operator|(
name|n
operator|=
name|x2
operator|-
name|x1
operator|+
literal|1
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
name|displ
operator|&&
name|display
condition|)
block|{
if|if
condition|(
name|x2
operator|==
name|cols
operator|-
literal|1
operator|&&
name|CE
condition|)
block|{
name|GotoPos
argument_list|(
name|x1
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|CE
argument_list|)
expr_stmt|;
if|if
condition|(
name|y
operator|==
name|screenbot
condition|)
name|lp_missing
operator|=
literal|0
expr_stmt|;
block|}
else|else
name|DisplayLine
argument_list|(
name|curr
operator|->
name|image
index|[
name|y
index|]
argument_list|,
name|curr
operator|->
name|attr
index|[
name|y
index|]
argument_list|,
name|curr
operator|->
name|font
index|[
name|y
index|]
argument_list|,
name|blank
argument_list|,
name|null
argument_list|,
name|null
argument_list|,
name|y
argument_list|,
name|x1
argument_list|,
name|x2
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|curr
condition|)
block|{
name|bclear
argument_list|(
name|curr
operator|->
name|image
index|[
name|y
index|]
operator|+
name|x1
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|curr
operator|->
name|attr
index|[
name|y
index|]
operator|+
name|x1
argument_list|,
name|n
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|curr
operator|->
name|font
index|[
name|y
index|]
operator|+
name|x1
argument_list|,
name|n
argument_list|)
expr_stmt|;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|CursorRight
parameter_list|(
name|n
parameter_list|)
specifier|register
name|int
name|n
decl_stmt|;
block|{
specifier|register
name|int
name|x
init|=
name|curr
operator|->
name|x
decl_stmt|;
if|if
condition|(
name|x
operator|==
name|cols
condition|)
block|{
name|LineFeed
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|x
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|curr
operator|->
name|x
operator|+=
name|n
operator|)
operator|>=
name|cols
condition|)
name|curr
operator|->
name|x
operator|=
name|cols
operator|-
literal|1
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|CursorUp
parameter_list|(
name|n
parameter_list|)
specifier|register
name|int
name|n
decl_stmt|;
block|{
if|if
condition|(
name|curr
operator|->
name|y
operator|<
name|curr
operator|->
name|top
condition|)
comment|/* if above scrolling rgn, */
block|{
if|if
condition|(
operator|(
name|curr
operator|->
name|y
operator|-=
name|n
operator|)
operator|<
literal|0
condition|)
comment|/* ignore its limits      */
name|curr
operator|->
name|y
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|curr
operator|->
name|y
operator|-=
name|n
operator|)
operator|<
name|curr
operator|->
name|top
condition|)
name|curr
operator|->
name|y
operator|=
name|curr
operator|->
name|top
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|CursorDown
parameter_list|(
name|n
parameter_list|)
specifier|register
name|int
name|n
decl_stmt|;
block|{
if|if
condition|(
name|curr
operator|->
name|y
operator|>
name|curr
operator|->
name|bot
condition|)
comment|/* if below scrolling rgn, */
block|{
if|if
condition|(
operator|(
name|curr
operator|->
name|y
operator|+=
name|n
operator|)
operator|>
name|rows
operator|-
literal|1
condition|)
comment|/* ignore its limits      */
name|curr
operator|->
name|y
operator|=
name|rows
operator|-
literal|1
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|curr
operator|->
name|y
operator|+=
name|n
operator|)
operator|>
name|curr
operator|->
name|bot
condition|)
name|curr
operator|->
name|y
operator|=
name|curr
operator|->
name|bot
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|CursorLeft
parameter_list|(
name|n
parameter_list|)
specifier|register
name|int
name|n
decl_stmt|;
block|{
if|if
condition|(
operator|(
name|curr
operator|->
name|x
operator|-=
name|n
operator|)
operator|<
literal|0
condition|)
name|curr
operator|->
name|x
operator|=
literal|0
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|ASetMode
parameter_list|(
name|on
parameter_list|)
name|int
name|on
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|curr
operator|->
name|NumArgs
condition|;
operator|++
name|i
control|)
block|{
switch|switch
condition|(
name|curr
operator|->
name|args
index|[
name|i
index|]
condition|)
block|{
case|case
literal|4
case|:
name|curr
operator|->
name|insert
operator|=
name|on
expr_stmt|;
name|InsertMode
argument_list|(
name|on
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|SelectRendition
parameter_list|()
block|{
specifier|register
name|int
name|i
init|=
literal|0
decl_stmt|,
name|a
init|=
name|curr
operator|->
name|LocalAttr
decl_stmt|;
do|do
block|{
switch|switch
condition|(
name|curr
operator|->
name|args
index|[
name|i
index|]
condition|)
block|{
case|case
literal|0
case|:
name|a
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|1
case|:
name|a
operator||=
name|A_BD
expr_stmt|;
break|break;
case|case
literal|2
case|:
name|a
operator||=
name|A_DI
expr_stmt|;
break|break;
case|case
literal|3
case|:
name|a
operator||=
name|A_SO
expr_stmt|;
break|break;
case|case
literal|4
case|:
name|a
operator||=
name|A_US
expr_stmt|;
break|break;
case|case
literal|5
case|:
name|a
operator||=
name|A_BL
expr_stmt|;
break|break;
case|case
literal|7
case|:
name|a
operator||=
name|A_RV
expr_stmt|;
break|break;
case|case
literal|22
case|:
name|a
operator|&=
operator|~
operator|(
name|A_BD
operator||
name|A_SO
operator||
name|A_DI
operator|)
expr_stmt|;
break|break;
case|case
literal|23
case|:
name|a
operator|&=
operator|~
name|A_SO
expr_stmt|;
break|break;
case|case
literal|24
case|:
name|a
operator|&=
operator|~
name|A_US
expr_stmt|;
break|break;
case|case
literal|25
case|:
name|a
operator|&=
operator|~
name|A_BL
expr_stmt|;
break|break;
case|case
literal|27
case|:
name|a
operator|&=
operator|~
name|A_RV
expr_stmt|;
break|break;
block|}
block|}
do|while
condition|(
operator|++
name|i
operator|<
name|curr
operator|->
name|NumArgs
condition|)
do|;
name|NewRendition
argument_list|(
name|curr
operator|->
name|LocalAttr
operator|=
name|a
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|NewRendition
parameter_list|(
name|new
parameter_list|)
specifier|register
name|int
name|new
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|old
init|=
name|GlobalAttr
decl_stmt|;
if|if
condition|(
operator|!
name|display
operator|||
name|old
operator|==
name|new
condition|)
return|return;
name|GlobalAttr
operator|=
name|new
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|1
init|;
name|i
operator|<=
name|A_MAX
condition|;
name|i
operator|<<=
literal|1
control|)
block|{
if|if
condition|(
operator|(
name|old
operator|&
name|i
operator|)
operator|&&
operator|!
operator|(
name|new
operator|&
name|i
operator|)
condition|)
block|{
name|PutStr
argument_list|(
name|UE
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|SE
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|ME
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|&
name|A_DI
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_DI
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|&
name|A_US
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_US
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|&
name|A_BD
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_BD
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|&
name|A_RV
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_RV
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|&
name|A_SO
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_SO
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|new
operator|&
name|A_BL
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_BL
index|]
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
if|if
condition|(
operator|(
name|new
operator|&
name|A_DI
operator|)
operator|&&
operator|!
operator|(
name|old
operator|&
name|A_DI
operator|)
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_DI
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new
operator|&
name|A_US
operator|)
operator|&&
operator|!
operator|(
name|old
operator|&
name|A_US
operator|)
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_US
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new
operator|&
name|A_BD
operator|)
operator|&&
operator|!
operator|(
name|old
operator|&
name|A_BD
operator|)
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_BD
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new
operator|&
name|A_RV
operator|)
operator|&&
operator|!
operator|(
name|old
operator|&
name|A_RV
operator|)
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_RV
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new
operator|&
name|A_SO
operator|)
operator|&&
operator|!
operator|(
name|old
operator|&
name|A_SO
operator|)
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_SO
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
operator|(
name|new
operator|&
name|A_BL
operator|)
operator|&&
operator|!
operator|(
name|old
operator|&
name|A_BL
operator|)
condition|)
name|PutStr
argument_list|(
name|attrtab
index|[
name|ATTR_BL
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|SaveSetAttr
parameter_list|(
name|newattr
parameter_list|,
name|newcharset
parameter_list|)
name|int
name|newattr
decl_stmt|,
name|newcharset
decl_stmt|;
block|{
name|NewRendition
argument_list|(
name|newattr
argument_list|)
expr_stmt|;
name|NewCharset
argument_list|(
name|newcharset
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|RestoreAttr
parameter_list|()
block|{
name|NewRendition
argument_list|(
name|curr
operator|->
name|LocalAttr
argument_list|)
expr_stmt|;
name|NewCharset
argument_list|(
name|curr
operator|->
name|charsets
index|[
name|curr
operator|->
name|LocalCharset
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|FillWithEs
parameter_list|()
block|{
specifier|register
name|int
name|i
decl_stmt|;
specifier|register
name|char
modifier|*
name|p
decl_stmt|,
modifier|*
name|ep
decl_stmt|;
name|curr
operator|->
name|y
operator|=
name|curr
operator|->
name|x
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|rows
condition|;
operator|++
name|i
control|)
block|{
name|bzero
argument_list|(
name|curr
operator|->
name|attr
index|[
name|i
index|]
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|bzero
argument_list|(
name|curr
operator|->
name|font
index|[
name|i
index|]
argument_list|,
name|cols
argument_list|)
expr_stmt|;
name|p
operator|=
name|curr
operator|->
name|image
index|[
name|i
index|]
expr_stmt|;
name|ep
operator|=
name|p
operator|+
name|cols
expr_stmt|;
while|while
condition|(
name|p
operator|<
name|ep
condition|)
operator|*
name|p
operator|++
operator|=
literal|'E'
expr_stmt|;
block|}
if|if
condition|(
name|display
condition|)
name|Redisplay
argument_list|(
literal|0
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/*  * if cur_only, we only redisplay current line, as a full refresh is  * too expensive.  */
end_comment

begin_function
name|void
name|Redisplay
parameter_list|(
name|cur_only
parameter_list|)
name|int
name|cur_only
decl_stmt|;
block|{
specifier|register
name|int
name|i
decl_stmt|,
name|stop
decl_stmt|;
name|PutStr
argument_list|(
name|CL
argument_list|)
expr_stmt|;
name|screenx
operator|=
name|screeny
operator|=
literal|0
expr_stmt|;
name|lp_missing
operator|=
literal|0
expr_stmt|;
name|stop
operator|=
name|rows
expr_stmt|;
name|i
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|cur_only
condition|)
block|{
name|i
operator|=
name|stop
operator|=
name|curr
operator|->
name|y
expr_stmt|;
name|stop
operator|++
expr_stmt|;
block|}
for|for
control|(
init|;
name|i
operator|<
name|stop
condition|;
operator|++
name|i
control|)
block|{
if|if
condition|(
name|in_ovl
condition|)
call|(
modifier|*
name|ovl_RedisplayLine
call|)
argument_list|(
name|i
argument_list|,
literal|0
argument_list|,
name|cols
operator|-
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
else|else
name|DisplayLine
argument_list|(
name|blank
argument_list|,
name|null
argument_list|,
name|null
argument_list|,
name|curr
operator|->
name|image
index|[
name|i
index|]
argument_list|,
name|curr
operator|->
name|attr
index|[
name|i
index|]
argument_list|,
name|curr
operator|->
name|font
index|[
name|i
index|]
argument_list|,
name|i
argument_list|,
literal|0
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
operator|!
name|in_ovl
condition|)
block|{
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
name|NewRendition
argument_list|(
name|curr
operator|->
name|LocalAttr
argument_list|)
expr_stmt|;
name|NewCharset
argument_list|(
name|curr
operator|->
name|charsets
index|[
name|curr
operator|->
name|LocalCharset
index|]
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|DisplayLine
parameter_list|(
name|os
parameter_list|,
name|oa
parameter_list|,
name|of
parameter_list|,
name|s
parameter_list|,
name|as
parameter_list|,
name|fs
parameter_list|,
name|y
parameter_list|,
name|from
parameter_list|,
name|to
parameter_list|)
name|int
name|from
decl_stmt|,
name|to
decl_stmt|,
name|y
decl_stmt|;
specifier|register
name|char
modifier|*
name|os
decl_stmt|,
decl|*
name|oa
decl_stmt|,
modifier|*
name|of
decl_stmt|,
modifier|*
name|s
decl_stmt|,
modifier|*
name|as
decl_stmt|,
modifier|*
name|fs
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|int
name|x
decl_stmt|;
name|int
name|last2flag
init|=
literal|0
decl_stmt|,
name|delete_lp
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|!
name|LP
operator|&&
name|y
operator|==
name|screenbot
operator|&&
name|to
operator|==
name|cols
operator|-
literal|1
condition|)
if|if
condition|(
name|lp_missing
operator|||
name|s
index|[
name|to
index|]
operator|!=
name|os
index|[
name|to
index|]
operator|||
name|as
index|[
name|to
index|]
operator|!=
name|oa
index|[
name|to
index|]
operator|||
name|of
index|[
name|to
index|]
operator|!=
name|fs
index|[
name|to
index|]
condition|)
block|{
if|if
condition|(
operator|(
name|IC
operator|||
name|IM
operator|)
operator|&&
operator|(
name|from
operator|<
name|to
operator|||
operator|!
name|in_ovl
operator|)
condition|)
block|{
if|if
condition|(
operator|(
name|to
operator|-=
literal|2
operator|)
operator|<
name|from
operator|-
literal|1
condition|)
name|from
operator|--
expr_stmt|;
name|last2flag
operator|=
literal|1
expr_stmt|;
name|lp_missing
operator|=
literal|0
expr_stmt|;
block|}
else|else
block|{
name|to
operator|--
expr_stmt|;
name|delete_lp
operator|=
operator|(
name|CE
operator|||
name|DC
operator|||
name|CDC
operator|)
expr_stmt|;
name|lp_missing
operator|=
operator|(
name|s
index|[
name|to
index|]
operator|!=
literal|' '
operator|||
name|as
index|[
name|to
index|]
operator|||
name|fs
index|[
name|to
index|]
operator|)
expr_stmt|;
block|}
block|}
else|else
name|to
operator|--
expr_stmt|;
for|for
control|(
name|x
operator|=
name|from
init|;
name|x
operator|<=
name|to
condition|;
operator|++
name|x
control|)
block|{
if|if
condition|(
name|s
index|[
name|x
index|]
operator|==
name|os
index|[
name|x
index|]
operator|&&
name|as
index|[
name|x
index|]
operator|==
name|oa
index|[
name|x
index|]
operator|&&
name|of
index|[
name|x
index|]
operator|==
name|fs
index|[
name|x
index|]
condition|)
continue|continue;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|NewRendition
argument_list|(
name|as
index|[
name|x
index|]
argument_list|)
expr_stmt|;
name|NewCharset
argument_list|(
name|fs
index|[
name|x
index|]
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|s
index|[
name|x
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|last2flag
condition|)
block|{
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|NewRendition
argument_list|(
name|as
index|[
name|x
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|NewCharset
argument_list|(
name|fs
index|[
name|x
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|s
index|[
name|x
operator|+
literal|1
index|]
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|NewRendition
argument_list|(
name|as
index|[
name|x
index|]
argument_list|)
expr_stmt|;
name|NewCharset
argument_list|(
name|fs
index|[
name|x
index|]
argument_list|)
expr_stmt|;
name|INSERTCHAR
argument_list|(
name|s
index|[
name|x
index|]
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|delete_lp
condition|)
block|{
if|if
condition|(
name|DC
condition|)
name|PutStr
argument_list|(
name|DC
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|CDC
condition|)
name|CPutStr
argument_list|(
name|CDC
argument_list|,
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|CE
condition|)
name|PutStr
argument_list|(
name|CE
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_function
name|void
name|RefreshLine
parameter_list|(
name|y
parameter_list|,
name|from
parameter_list|,
name|to
parameter_list|)
name|int
name|y
decl_stmt|,
name|from
decl_stmt|,
name|to
decl_stmt|;
block|{
name|char
modifier|*
name|oi
init|=
name|null
decl_stmt|;
if|if
condition|(
name|CE
operator|&&
name|to
operator|==
name|screenwidth
operator|-
literal|1
condition|)
block|{
name|GotoPos
argument_list|(
name|from
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|CE
argument_list|)
expr_stmt|;
name|oi
operator|=
name|blank
expr_stmt|;
block|}
if|if
condition|(
name|in_ovl
condition|)
call|(
modifier|*
name|ovl_RedisplayLine
call|)
argument_list|(
name|y
argument_list|,
name|from
argument_list|,
name|to
argument_list|,
operator|(
name|oi
operator|==
name|blank
operator|)
argument_list|)
expr_stmt|;
else|else
name|DisplayLine
argument_list|(
name|oi
argument_list|,
name|null
argument_list|,
name|null
argument_list|,
name|curr
operator|->
name|image
index|[
name|y
index|]
argument_list|,
name|curr
operator|->
name|attr
index|[
name|y
index|]
argument_list|,
name|curr
operator|->
name|font
index|[
name|y
index|]
argument_list|,
name|y
argument_list|,
name|from
argument_list|,
name|to
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|RedisplayLine
parameter_list|(
name|os
parameter_list|,
name|oa
parameter_list|,
name|of
parameter_list|,
name|y
parameter_list|,
name|from
parameter_list|,
name|to
parameter_list|)
name|int
name|from
decl_stmt|,
name|to
decl_stmt|,
name|y
decl_stmt|;
name|char
modifier|*
name|os
decl_stmt|,
decl|*
name|oa
decl_stmt|,
modifier|*
name|of
decl_stmt|;
end_function

begin_block
block|{
name|DisplayLine
argument_list|(
name|os
argument_list|,
name|oa
argument_list|,
name|of
argument_list|,
name|curr
operator|->
name|image
index|[
name|y
index|]
argument_list|,
name|curr
operator|->
name|attr
index|[
name|y
index|]
argument_list|,
name|curr
operator|->
name|font
index|[
name|y
index|]
argument_list|,
name|y
argument_list|,
name|from
argument_list|,
name|to
argument_list|)
expr_stmt|;
name|NewRendition
argument_list|(
name|curr
operator|->
name|LocalAttr
argument_list|)
expr_stmt|;
name|NewCharset
argument_list|(
name|curr
operator|->
name|charsets
index|[
name|curr
operator|->
name|LocalCharset
index|]
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
name|void
name|FixLP
parameter_list|(
name|x2
parameter_list|,
name|y2
parameter_list|)
specifier|register
name|int
name|x2
decl_stmt|,
name|y2
decl_stmt|;
block|{
specifier|register
name|struct
name|win
modifier|*
name|p
init|=
name|curr
decl_stmt|;
name|GotoPos
argument_list|(
name|x2
argument_list|,
name|y2
argument_list|)
expr_stmt|;
name|SaveSetAttr
argument_list|(
name|p
operator|->
name|attr
index|[
name|y2
index|]
index|[
name|x2
index|]
argument_list|,
name|p
operator|->
name|font
index|[
name|y2
index|]
index|[
name|x2
index|]
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|p
operator|->
name|image
index|[
name|y2
index|]
index|[
name|x2
index|]
argument_list|)
expr_stmt|;
name|RestoreAttr
argument_list|()
expr_stmt|;
name|lp_missing
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|CheckLP
parameter_list|(
name|n_ch
parameter_list|)
name|char
name|n_ch
decl_stmt|;
block|{
specifier|register
name|int
name|y
init|=
name|screenbot
decl_stmt|,
name|x
init|=
name|cols
operator|-
literal|1
decl_stmt|;
specifier|register
name|char
name|n_at
decl_stmt|,
name|n_fo
decl_stmt|,
name|o_ch
decl_stmt|,
name|o_at
decl_stmt|,
name|o_fo
decl_stmt|;
name|o_ch
operator|=
name|curr
operator|->
name|image
index|[
name|y
index|]
index|[
name|x
index|]
expr_stmt|;
name|o_at
operator|=
name|curr
operator|->
name|attr
index|[
name|y
index|]
index|[
name|x
index|]
expr_stmt|;
name|o_fo
operator|=
name|curr
operator|->
name|font
index|[
name|y
index|]
index|[
name|x
index|]
expr_stmt|;
name|n_at
operator|=
name|curr
operator|->
name|LocalAttr
expr_stmt|;
name|n_fo
operator|=
name|curr
operator|->
name|charsets
index|[
name|curr
operator|->
name|LocalCharset
index|]
expr_stmt|;
name|lp_missing
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|n_ch
operator|==
name|o_ch
operator|&&
name|n_at
operator|==
name|o_at
operator|&&
name|n_fo
operator|==
name|o_fo
condition|)
block|{
return|return;
block|}
if|if
condition|(
name|n_ch
operator|!=
literal|' '
operator|||
name|n_at
operator|||
name|n_fo
condition|)
name|lp_missing
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|o_ch
operator|!=
literal|' '
operator|||
name|o_at
operator|||
name|o_fo
condition|)
block|{
if|if
condition|(
name|DC
condition|)
name|PutStr
argument_list|(
name|DC
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|CDC
condition|)
name|CPutStr
argument_list|(
name|CDC
argument_list|,
literal|1
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
name|CE
condition|)
name|PutStr
argument_list|(
name|CE
argument_list|)
expr_stmt|;
else|else
name|lp_missing
operator|=
literal|1
expr_stmt|;
block|}
block|}
end_function

begin_function
specifier|static
name|void
name|FindAKA
parameter_list|()
block|{
specifier|register
name|char
modifier|*
name|cp
decl_stmt|,
modifier|*
name|line
decl_stmt|,
name|ch
decl_stmt|;
specifier|register
name|struct
name|win
modifier|*
name|wp
init|=
name|curr
decl_stmt|;
specifier|register
name|int
name|len
init|=
name|strlen
argument_list|(
name|wp
operator|->
name|cmd
argument_list|)
decl_stmt|;
name|int
name|y
decl_stmt|;
name|y
operator|=
operator|(
name|wp
operator|->
name|autoaka
operator|>
literal|0
operator|&&
name|wp
operator|->
name|autoaka
operator|<=
name|wp
operator|->
name|height
operator|)
condition|?
name|wp
operator|->
name|autoaka
operator|-
literal|1
else|:
name|wp
operator|->
name|y
expr_stmt|;
name|cols
operator|=
name|wp
operator|->
name|width
expr_stmt|;
name|try_line
label|:
name|cp
operator|=
name|line
operator|=
name|wp
operator|->
name|image
index|[
name|y
index|]
expr_stmt|;
if|if
condition|(
name|wp
operator|->
name|autoaka
operator|>
literal|0
operator|&&
operator|(
name|ch
operator|=
operator|*
name|wp
operator|->
name|cmd
operator|)
operator|!=
literal|'\0'
condition|)
block|{
for|for
control|(
init|;
condition|;
control|)
block|{
if|if
condition|(
operator|(
name|cp
operator|=
name|index
argument_list|(
name|cp
argument_list|,
name|ch
argument_list|)
operator|)
operator|!=
name|NULL
operator|&&
operator|!
name|strncmp
argument_list|(
name|cp
argument_list|,
name|wp
operator|->
name|cmd
argument_list|,
name|len
argument_list|)
condition|)
break|break;
if|if
condition|(
operator|!
name|cp
operator|||
operator|++
name|cp
operator|-
name|line
operator|>=
name|cols
operator|-
name|len
condition|)
block|{
if|if
condition|(
operator|++
name|y
operator|==
name|wp
operator|->
name|autoaka
operator|&&
name|y
operator|<
name|rows
condition|)
goto|goto
name|try_line
goto|;
return|return;
block|}
block|}
name|cp
operator|+=
name|len
expr_stmt|;
block|}
for|for
control|(
name|len
operator|=
name|cols
operator|-
operator|(
name|cp
operator|-
name|line
operator|)
init|;
name|len
operator|&&
operator|*
name|cp
operator|==
literal|' '
condition|;
name|len
operator|--
operator|,
name|cp
operator|++
control|)
empty_stmt|;
if|if
condition|(
name|len
condition|)
block|{
if|if
condition|(
name|wp
operator|->
name|autoaka
operator|>
literal|0
operator|&&
operator|(
operator|*
name|cp
operator|==
literal|'!'
operator|||
operator|*
name|cp
operator|==
literal|'%'
operator|||
operator|*
name|cp
operator|==
literal|'^'
operator|)
condition|)
name|wp
operator|->
name|autoaka
operator|=
operator|-
literal|1
expr_stmt|;
else|else
name|wp
operator|->
name|autoaka
operator|=
literal|0
expr_stmt|;
name|line
operator|=
name|wp
operator|->
name|cmd
operator|+
name|wp
operator|->
name|akapos
expr_stmt|;
while|while
condition|(
name|len
operator|&&
operator|*
name|cp
operator|!=
literal|' '
condition|)
block|{
if|if
condition|(
operator|(
operator|*
name|line
operator|++
operator|=
operator|*
name|cp
operator|++
operator|)
operator|==
literal|'/'
condition|)
name|line
operator|=
name|wp
operator|->
name|cmd
operator|+
name|wp
operator|->
name|akapos
expr_stmt|;
name|len
operator|--
expr_stmt|;
block|}
operator|*
name|line
operator|=
literal|'\0'
expr_stmt|;
block|}
else|else
name|wp
operator|->
name|autoaka
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_comment
comment|/* We dont use HS status line with Input.  * If we would use it, then we should check e_tgetflag("es") if  * we are allowed to use esc sequences there.  * For now, we hope that Goto(,,STATLINE,0) brings us in the bottom  * line. jw.  */
end_comment

begin_decl_stmt
specifier|static
name|char
name|inpbuf
index|[
literal|101
index|]
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|inplen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|inpmaxlen
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|char
modifier|*
name|inpstring
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|int
name|inpstringlen
decl_stmt|;
end_decl_stmt

begin_function_decl
specifier|static
name|void
function_decl|(
modifier|*
name|inpfinfunc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|void
name|Input
argument_list|(
name|istr
argument_list|,
name|len
argument_list|,
name|finfunc
argument_list|)
name|char
modifier|*
name|istr
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|len
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
function_decl|(
modifier|*
name|finfunc
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_block
block|{
name|int
name|maxlen
decl_stmt|;
name|inpstring
operator|=
name|istr
expr_stmt|;
name|inpstringlen
operator|=
name|strlen
argument_list|(
name|istr
argument_list|)
expr_stmt|;
if|if
condition|(
name|len
operator|>
literal|100
condition|)
name|len
operator|=
literal|100
expr_stmt|;
name|maxlen
operator|=
name|screenwidth
operator|-
name|inpstringlen
expr_stmt|;
if|if
condition|(
operator|!
name|LP
operator|&&
name|STATLINE
operator|==
name|screenbot
condition|)
name|maxlen
operator|--
expr_stmt|;
if|if
condition|(
name|len
operator|>
name|maxlen
condition|)
name|len
operator|=
name|maxlen
expr_stmt|;
if|if
condition|(
name|len
operator|<
literal|2
condition|)
block|{
name|Msg
argument_list|(
literal|0
argument_list|,
literal|"Width too small"
argument_list|)
expr_stmt|;
return|return;
block|}
name|inpmaxlen
operator|=
name|len
expr_stmt|;
name|inpfinfunc
operator|=
name|finfunc
expr_stmt|;
name|InitOverlayPage
argument_list|(
name|process_inp_input
argument_list|,
name|inpRedisplayLine
argument_list|,
operator|(
name|int
argument_list|(
operator|*
argument_list|)
argument_list|()
operator|)
literal|0
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|inplen
operator|=
literal|0
expr_stmt|;
name|GotoPos
argument_list|(
literal|0
argument_list|,
name|STATLINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|CE
condition|)
name|PutStr
argument_list|(
name|CE
argument_list|)
expr_stmt|;
else|else
block|{
name|DisplayLine
argument_list|(
name|curr
operator|->
name|image
index|[
name|screeny
index|]
argument_list|,
name|curr
operator|->
name|attr
index|[
name|screeny
index|]
argument_list|,
name|curr
operator|->
name|font
index|[
name|screeny
index|]
argument_list|,
name|blank
argument_list|,
name|null
argument_list|,
name|null
argument_list|,
name|screeny
argument_list|,
literal|0
argument_list|,
name|cols
operator|-
literal|1
argument_list|)
expr_stmt|;
block|}
name|inpRedisplayLine
argument_list|(
name|STATLINE
argument_list|,
literal|0
argument_list|,
name|inpstringlen
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|inpstringlen
argument_list|,
name|STATLINE
argument_list|)
expr_stmt|;
block|}
end_block

begin_function
specifier|static
name|void
name|process_inp_input
parameter_list|(
name|ppbuf
parameter_list|,
name|plen
parameter_list|)
name|char
modifier|*
modifier|*
name|ppbuf
decl_stmt|;
name|int
modifier|*
name|plen
decl_stmt|;
block|{
name|int
name|len
decl_stmt|,
name|x
decl_stmt|;
name|char
modifier|*
name|pbuf
decl_stmt|;
name|char
name|ch
decl_stmt|;
if|if
condition|(
name|ppbuf
operator|==
literal|0
condition|)
block|{
name|AbortInp
argument_list|()
expr_stmt|;
return|return;
block|}
name|x
operator|=
name|inpstringlen
operator|+
name|inplen
expr_stmt|;
name|len
operator|=
operator|*
name|plen
expr_stmt|;
name|pbuf
operator|=
operator|*
name|ppbuf
expr_stmt|;
while|while
condition|(
name|len
condition|)
block|{
name|ch
operator|=
operator|*
name|pbuf
operator|++
expr_stmt|;
name|len
operator|--
expr_stmt|;
if|if
condition|(
name|ch
operator|>=
literal|' '
operator|&&
name|ch
operator|<=
literal|'~'
operator|&&
name|inplen
operator|<
name|inpmaxlen
condition|)
block|{
name|inpbuf
index|[
name|inplen
operator|++
index|]
operator|=
name|ch
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|STATLINE
argument_list|)
expr_stmt|;
name|SaveSetAttr
argument_list|(
name|A_SO
argument_list|,
name|ASCII
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
name|ch
argument_list|)
expr_stmt|;
name|x
operator|++
expr_stmt|;
block|}
elseif|else
if|if
condition|(
operator|(
name|ch
operator|==
literal|'\b'
operator|||
name|ch
operator|==
literal|0177
operator|)
operator|&&
name|inplen
operator|>
literal|0
condition|)
block|{
name|inplen
operator|--
expr_stmt|;
name|x
operator|--
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|STATLINE
argument_list|)
expr_stmt|;
name|SaveSetAttr
argument_list|(
literal|0
argument_list|,
name|ASCII
argument_list|)
expr_stmt|;
name|PUTCHAR
argument_list|(
literal|' '
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|x
argument_list|,
name|STATLINE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|ch
operator|==
literal|'\004'
operator|||
name|ch
operator|==
literal|'\003'
operator|||
name|ch
operator|==
literal|'\000'
operator|||
name|ch
operator|==
literal|'\n'
operator|||
name|ch
operator|==
literal|'\r'
condition|)
block|{
if|if
condition|(
name|ch
operator|!=
literal|'\n'
operator|&&
name|ch
operator|!=
literal|'\r'
condition|)
name|inplen
operator|=
literal|0
expr_stmt|;
name|inpbuf
index|[
name|inplen
index|]
operator|=
literal|0
expr_stmt|;
name|AbortInp
argument_list|()
expr_stmt|;
comment|/* redisplays... */
call|(
modifier|*
name|inpfinfunc
call|)
argument_list|(
name|inpbuf
argument_list|,
name|inplen
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
operator|*
name|ppbuf
operator|=
name|pbuf
expr_stmt|;
operator|*
name|plen
operator|=
name|len
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|AbortInp
parameter_list|()
block|{
name|in_ovl
operator|=
literal|0
expr_stmt|;
comment|/* So we can use RefreshLine() */
name|RefreshLine
argument_list|(
name|STATLINE
argument_list|,
literal|0
argument_list|,
name|screenwidth
operator|-
literal|1
argument_list|)
expr_stmt|;
name|ExitOverlayPage
argument_list|()
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|inpRedisplayLine
parameter_list|(
name|y
parameter_list|,
name|xs
parameter_list|,
name|xe
parameter_list|,
name|isblank
parameter_list|)
name|int
name|y
decl_stmt|,
name|xs
decl_stmt|,
name|xe
decl_stmt|,
name|isblank
decl_stmt|;
block|{
name|int
name|q
decl_stmt|,
name|r
decl_stmt|,
name|s
decl_stmt|,
name|l
decl_stmt|,
name|v
decl_stmt|;
if|if
condition|(
name|y
operator|!=
name|STATLINE
condition|)
return|return;
name|inpbuf
index|[
name|inplen
index|]
operator|=
literal|0
expr_stmt|;
name|GotoPos
argument_list|(
name|xs
argument_list|,
name|y
argument_list|)
expr_stmt|;
name|q
operator|=
name|xs
expr_stmt|;
name|v
operator|=
name|xe
operator|-
name|xs
operator|+
literal|1
expr_stmt|;
name|s
operator|=
literal|0
expr_stmt|;
name|r
operator|=
name|inpstringlen
expr_stmt|;
if|if
condition|(
name|v
operator|>
literal|0
operator|&&
name|q
operator|<
name|r
condition|)
block|{
name|SaveSetAttr
argument_list|(
name|A_SO
argument_list|,
name|ASCII
argument_list|)
expr_stmt|;
name|l
operator|=
name|v
expr_stmt|;
if|if
condition|(
name|l
operator|>
name|r
operator|-
name|q
condition|)
name|l
operator|=
name|r
operator|-
name|q
expr_stmt|;
name|printf
argument_list|(
literal|"%-*.*s"
argument_list|,
name|l
argument_list|,
name|l
argument_list|,
name|inpstring
operator|+
name|q
operator|-
name|s
argument_list|)
expr_stmt|;
name|q
operator|+=
name|l
expr_stmt|;
name|v
operator|-=
name|l
expr_stmt|;
block|}
name|s
operator|=
name|r
expr_stmt|;
name|r
operator|+=
name|inplen
expr_stmt|;
if|if
condition|(
name|v
operator|>
literal|0
operator|&&
name|q
operator|<
name|r
condition|)
block|{
name|SaveSetAttr
argument_list|(
name|A_SO
argument_list|,
name|ASCII
argument_list|)
expr_stmt|;
name|l
operator|=
name|v
expr_stmt|;
if|if
condition|(
name|l
operator|>
name|r
operator|-
name|q
condition|)
name|l
operator|=
name|r
operator|-
name|q
expr_stmt|;
name|printf
argument_list|(
literal|"%-*.*s"
argument_list|,
name|l
argument_list|,
name|l
argument_list|,
name|inpbuf
operator|+
name|q
operator|-
name|s
argument_list|)
expr_stmt|;
name|q
operator|+=
name|l
expr_stmt|;
name|v
operator|-=
name|l
expr_stmt|;
block|}
name|s
operator|=
name|r
expr_stmt|;
name|r
operator|=
name|screenwidth
expr_stmt|;
if|if
condition|(
operator|!
name|isblank
operator|&&
name|v
operator|>
literal|0
operator|&&
name|q
operator|<
name|r
condition|)
block|{
name|SaveSetAttr
argument_list|(
literal|0
argument_list|,
name|ASCII
argument_list|)
expr_stmt|;
name|l
operator|=
name|v
expr_stmt|;
if|if
condition|(
name|l
operator|>
name|r
operator|-
name|q
condition|)
name|l
operator|=
name|r
operator|-
name|q
expr_stmt|;
name|printf
argument_list|(
literal|"%-*.*s"
argument_list|,
name|l
argument_list|,
name|l
argument_list|,
literal|""
argument_list|)
expr_stmt|;
name|q
operator|+=
name|l
expr_stmt|;
block|}
name|SetLastPos
argument_list|(
name|q
argument_list|,
name|y
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|AKAfin
parameter_list|(
name|buf
parameter_list|,
name|len
parameter_list|)
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
if|if
condition|(
name|len
condition|)
block|{
name|strcpy
argument_list|(
name|curr
operator|->
name|cmd
operator|+
name|curr
operator|->
name|akapos
argument_list|,
name|buf
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|InputAKA
parameter_list|()
block|{
name|void
name|Input
argument_list|()
decl_stmt|,
name|AKAfin
argument_list|()
decl_stmt|;
name|Input
argument_list|(
literal|"Set window's a.k.a. to: "
argument_list|,
literal|20
argument_list|,
name|AKAfin
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|Colonfin
parameter_list|(
name|buf
parameter_list|,
name|len
parameter_list|)
name|char
modifier|*
name|buf
decl_stmt|;
name|int
name|len
decl_stmt|;
block|{
if|if
condition|(
name|len
condition|)
name|RcLine
argument_list|(
name|buf
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|InputColon
parameter_list|()
block|{
name|void
name|Input
argument_list|()
decl_stmt|,
name|Colonfin
argument_list|()
decl_stmt|;
name|Input
argument_list|(
literal|":"
argument_list|,
literal|100
argument_list|,
name|Colonfin
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|MakeBlankLine
parameter_list|(
name|p
parameter_list|,
name|n
parameter_list|)
specifier|register
name|char
modifier|*
name|p
decl_stmt|;
specifier|register
name|int
name|n
decl_stmt|;
block|{
while|while
condition|(
name|n
operator|--
condition|)
operator|*
name|p
operator|++
operator|=
literal|' '
expr_stmt|;
block|}
end_function

begin_function
name|void
name|MakeStatus
parameter_list|(
name|msg
parameter_list|)
name|char
modifier|*
name|msg
decl_stmt|;
block|{
specifier|register
name|char
modifier|*
name|s
decl_stmt|,
modifier|*
name|t
decl_stmt|;
specifier|register
name|int
name|max
decl_stmt|,
name|ti
decl_stmt|;
name|SetCurr
argument_list|(
name|fore
argument_list|)
expr_stmt|;
name|display
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
operator|(
name|max
operator|=
name|HS
operator|)
condition|)
block|{
name|max
operator|=
operator|!
name|LP
condition|?
name|cols
operator|-
literal|1
else|:
name|cols
expr_stmt|;
block|}
if|if
condition|(
name|status
condition|)
block|{
if|if
condition|(
operator|!
name|BellDisplayed
condition|)
block|{
name|ti
operator|=
name|time
argument_list|(
operator|(
name|time_t
operator|*
operator|)
literal|0
argument_list|)
operator|-
name|TimeDisplayed
expr_stmt|;
if|if
condition|(
name|ti
operator|<
name|MsgMinWait
condition|)
name|sleep
argument_list|(
name|MsgMinWait
operator|-
name|ti
argument_list|)
expr_stmt|;
block|}
name|RemoveStatus
argument_list|()
expr_stmt|;
block|}
for|for
control|(
name|s
operator|=
name|t
operator|=
name|msg
init|;
operator|*
name|s
operator|&&
name|t
operator|-
name|msg
operator|<
name|max
condition|;
operator|++
name|s
control|)
if|if
condition|(
operator|*
name|s
operator|==
name|BELL
condition|)
name|PutStr
argument_list|(
name|BL
argument_list|)
expr_stmt|;
elseif|else
if|if
condition|(
operator|*
name|s
operator|>=
literal|' '
operator|&&
operator|*
name|s
operator|<=
literal|'~'
condition|)
operator|*
name|t
operator|++
operator|=
operator|*
name|s
expr_stmt|;
operator|*
name|t
operator|=
literal|'\0'
expr_stmt|;
if|if
condition|(
name|t
operator|>
name|msg
condition|)
block|{
name|strncpy
argument_list|(
name|LastMsg
argument_list|,
name|msg
argument_list|,
name|maxwidth
argument_list|)
expr_stmt|;
name|status
operator|=
literal|1
expr_stmt|;
name|status_lastx
operator|=
name|screenx
expr_stmt|;
name|status_lasty
operator|=
name|screeny
expr_stmt|;
name|StatLen
operator|=
name|t
operator|-
name|msg
expr_stmt|;
if|if
condition|(
operator|!
name|HS
condition|)
block|{
name|GotoPos
argument_list|(
literal|0
argument_list|,
name|STATLINE
argument_list|)
expr_stmt|;
name|SaveSetAttr
argument_list|(
name|A_SO
argument_list|,
name|ASCII
argument_list|)
expr_stmt|;
name|InsertMode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|screenx
operator|=
operator|-
literal|1
expr_stmt|;
block|}
else|else
block|{
name|debug
argument_list|(
literal|"HS:"
argument_list|)
expr_stmt|;
name|SaveSetAttr
argument_list|(
literal|0
argument_list|,
name|ASCII
argument_list|)
expr_stmt|;
name|InsertMode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|CPutStr
argument_list|(
name|TS
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"%s"
argument_list|,
name|msg
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|FS
argument_list|)
expr_stmt|;
block|}
operator|(
name|void
operator|)
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
operator|(
name|void
operator|)
name|time
argument_list|(
operator|&
name|TimeDisplayed
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|RemoveStatus
parameter_list|()
block|{
if|if
condition|(
operator|!
name|status
condition|)
return|return;
name|status
operator|=
literal|0
expr_stmt|;
name|BellDisplayed
operator|=
literal|0
expr_stmt|;
name|SetCurr
argument_list|(
name|fore
argument_list|)
expr_stmt|;
name|display
operator|=
literal|1
expr_stmt|;
if|if
condition|(
operator|!
name|HS
condition|)
block|{
name|GotoPos
argument_list|(
literal|0
argument_list|,
name|STATLINE
argument_list|)
expr_stmt|;
if|if
condition|(
name|in_ovl
condition|)
call|(
modifier|*
name|ovl_RedisplayLine
call|)
argument_list|(
name|STATLINE
argument_list|,
literal|0
argument_list|,
name|StatLen
operator|-
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
else|else
name|RedisplayLine
argument_list|(
name|null
argument_list|,
name|null
argument_list|,
name|null
argument_list|,
name|STATLINE
argument_list|,
literal|0
argument_list|,
name|StatLen
operator|-
literal|1
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|status_lastx
argument_list|,
name|status_lasty
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|SaveSetAttr
argument_list|(
literal|0
argument_list|,
name|ASCII
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|DS
argument_list|)
expr_stmt|;
block|}
block|}
end_function

begin_function
name|void
name|ClearDisplay
parameter_list|()
block|{
name|PutStr
argument_list|(
name|CL
argument_list|)
expr_stmt|;
name|screeny
operator|=
name|screenx
operator|=
literal|0
expr_stmt|;
name|fflush
argument_list|(
name|stdout
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
specifier|static
name|void
name|SetCurr
parameter_list|(
name|wp
parameter_list|)
name|struct
name|win
modifier|*
name|wp
decl_stmt|;
block|{
name|curr
operator|=
name|wp
expr_stmt|;
name|cols
operator|=
name|curr
operator|->
name|width
expr_stmt|;
name|rows
operator|=
name|curr
operator|->
name|height
expr_stmt|;
name|display
operator|=
name|curr
operator|->
name|active
expr_stmt|;
block|}
end_function

begin_decl_stmt
name|void
name|InitOverlayPage
argument_list|(
name|pro
argument_list|,
name|red
argument_list|,
name|rewrite
argument_list|,
name|blockfore
argument_list|)
name|void
argument_list|(
operator|*
name|pro
argument_list|)
argument_list|()
decl_stmt|;
end_decl_stmt

begin_function_decl
name|void
function_decl|(
modifier|*
name|red
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_function_decl
name|int
function_decl|(
modifier|*
name|rewrite
function_decl|)
parameter_list|()
function_decl|;
end_function_decl

begin_decl_stmt
name|int
name|blockfore
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|RemoveStatus
argument_list|()
expr_stmt|;
name|SetOvlCurr
argument_list|()
expr_stmt|;
name|ChangeScrollRegion
argument_list|(
literal|0
argument_list|,
name|screenheight
operator|-
literal|1
argument_list|)
expr_stmt|;
name|SetFlow
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|ovl_process
operator|=
name|pro
expr_stmt|;
name|ovl_RedisplayLine
operator|=
name|red
expr_stmt|;
name|ovl_Rewrite
operator|=
name|rewrite
expr_stmt|;
name|ovl_blockfore
operator|=
name|blockfore
expr_stmt|;
name|curr
operator|->
name|active
operator|=
literal|0
expr_stmt|;
name|in_ovl
operator|=
literal|1
expr_stmt|;
block|}
end_block

begin_function
name|void
name|ExitOverlayPage
parameter_list|()
block|{
name|ChangeScrollRegion
argument_list|(
name|curr
operator|->
name|top
argument_list|,
name|curr
operator|->
name|bot
argument_list|)
expr_stmt|;
name|GotoPos
argument_list|(
name|curr
operator|->
name|x
argument_list|,
name|curr
operator|->
name|y
argument_list|)
expr_stmt|;
name|RestoreAttr
argument_list|()
expr_stmt|;
name|SetFlow
argument_list|(
name|curr
operator|->
name|flow
operator|&
name|FLOW_NOW
argument_list|)
expr_stmt|;
name|curr
operator|->
name|active
operator|=
literal|1
expr_stmt|;
name|in_ovl
operator|=
literal|0
expr_stmt|;
block|}
end_function

begin_function
name|void
name|SetOvlCurr
parameter_list|()
block|{
name|SetCurr
argument_list|(
name|fore
argument_list|)
expr_stmt|;
name|SaveSetAttr
argument_list|(
literal|0
argument_list|,
name|ASCII
argument_list|)
expr_stmt|;
name|InsertMode
argument_list|(
literal|0
argument_list|)
expr_stmt|;
name|display
operator|=
literal|1
expr_stmt|;
block|}
end_function

begin_function
name|void
name|SetLastPos
parameter_list|(
name|x
parameter_list|,
name|y
parameter_list|)
name|int
name|x
decl_stmt|,
name|y
decl_stmt|;
block|{
name|screenx
operator|=
name|x
expr_stmt|;
name|screeny
operator|=
name|y
expr_stmt|;
block|}
end_function

begin_function
name|void
name|WSresize
parameter_list|(
name|width
parameter_list|,
name|height
parameter_list|)
name|int
name|width
decl_stmt|,
name|height
decl_stmt|;
block|{
name|debug2
argument_list|(
literal|"(display=%d:WSresize says:'%s'\n"
argument_list|,
name|display
argument_list|,
name|tgoto
argument_list|(
name|WS
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|tgoto
argument_list|(
name|WS
argument_list|,
name|width
argument_list|,
name|height
argument_list|)
argument_list|)
expr_stmt|;
block|}
end_function

begin_function
name|void
name|ChangeScrollRegion
parameter_list|(
name|top
parameter_list|,
name|bot
parameter_list|)
name|int
name|top
decl_stmt|,
name|bot
decl_stmt|;
block|{
if|if
condition|(
name|display
operator|==
literal|0
condition|)
return|return;
if|if
condition|(
name|CS
operator|==
literal|0
condition|)
block|{
name|screentop
operator|=
literal|0
expr_stmt|;
name|screenbot
operator|=
name|screenheight
operator|-
literal|1
expr_stmt|;
return|return;
block|}
if|if
condition|(
name|top
operator|==
name|screentop
operator|&&
name|bot
operator|==
name|screenbot
condition|)
return|return;
name|debug2
argument_list|(
literal|"ChangeScrollRegion: (%d - %d)\n"
argument_list|,
name|top
argument_list|,
name|bot
argument_list|)
expr_stmt|;
name|PutStr
argument_list|(
name|tgoto
argument_list|(
name|CS
argument_list|,
name|bot
argument_list|,
name|top
argument_list|)
argument_list|)
expr_stmt|;
name|screentop
operator|=
name|top
expr_stmt|;
name|screenbot
operator|=
name|bot
expr_stmt|;
name|screeny
operator|=
name|screenx
operator|=
operator|-
literal|1
expr_stmt|;
comment|/* Just in case... */
block|}
end_function

begin_function
name|void
name|AddLineToHist
parameter_list|(
name|wp
parameter_list|,
name|pi
parameter_list|,
name|pa
parameter_list|,
name|pf
parameter_list|)
name|struct
name|win
modifier|*
name|wp
decl_stmt|;
name|char
modifier|*
modifier|*
name|pi
decl_stmt|,
decl|*
modifier|*
name|pa
decl_stmt|,
modifier|*
modifier|*
name|pf
decl_stmt|;
end_function

begin_block
block|{
specifier|register
name|char
modifier|*
name|q
decl_stmt|;
if|if
condition|(
name|wp
operator|->
name|histheight
operator|==
literal|0
condition|)
return|return;
name|q
operator|=
operator|*
name|pi
expr_stmt|;
operator|*
name|pi
operator|=
name|wp
operator|->
name|ihist
index|[
name|wp
operator|->
name|histidx
index|]
expr_stmt|;
name|wp
operator|->
name|ihist
index|[
name|wp
operator|->
name|histidx
index|]
operator|=
name|q
expr_stmt|;
name|q
operator|=
operator|*
name|pa
expr_stmt|;
operator|*
name|pa
operator|=
name|wp
operator|->
name|ahist
index|[
name|wp
operator|->
name|histidx
index|]
expr_stmt|;
name|wp
operator|->
name|ahist
index|[
name|wp
operator|->
name|histidx
index|]
operator|=
name|q
expr_stmt|;
name|q
operator|=
operator|*
name|pf
expr_stmt|;
operator|*
name|pf
operator|=
name|wp
operator|->
name|fhist
index|[
name|wp
operator|->
name|histidx
index|]
expr_stmt|;
name|wp
operator|->
name|fhist
index|[
name|wp
operator|->
name|histidx
index|]
operator|=
name|q
expr_stmt|;
if|if
condition|(
operator|++
name|wp
operator|->
name|histidx
operator|>=
name|wp
operator|->
name|histheight
condition|)
name|wp
operator|->
name|histidx
operator|=
literal|0
expr_stmt|;
block|}
end_block

begin_comment
comment|/*  *  *  Termcap routines that use our extra_incap  *  */
end_comment

begin_comment
comment|/* findcap:  *   cap = capability we are looking for  *   tepp = pointer to bufferpointer  *   n = size of buffer (0 = infinity)  */
end_comment

begin_function
name|char
modifier|*
name|findcap
parameter_list|(
name|cap
parameter_list|,
name|tepp
parameter_list|,
name|n
parameter_list|)
name|char
modifier|*
name|cap
decl_stmt|;
name|char
modifier|*
modifier|*
name|tepp
decl_stmt|;
name|int
name|n
decl_stmt|;
block|{
name|char
modifier|*
name|tep
decl_stmt|;
name|char
name|c
decl_stmt|,
modifier|*
name|p
decl_stmt|,
modifier|*
name|cp
decl_stmt|;
name|int
name|mode
decl_stmt|;
comment|/* mode: 0=LIT  1=^  2=\x  3,4,5=\nnn */
name|int
name|num
init|=
literal|0
decl_stmt|,
name|capl
decl_stmt|;
if|if
condition|(
operator|!
name|extra_incap
condition|)
return|return
operator|(
literal|0
operator|)
return|;
name|tep
operator|=
operator|*
name|tepp
expr_stmt|;
name|capl
operator|=
name|strlen
argument_list|(
name|cap
argument_list|)
expr_stmt|;
name|cp
operator|=
literal|0
expr_stmt|;
name|mode
operator|=
literal|0
expr_stmt|;
for|for
control|(
name|p
operator|=
name|extra_incap
init|;
operator|*
name|p
condition|;
control|)
block|{
if|if
condition|(
name|strncmp
argument_list|(
name|p
argument_list|,
name|cap
argument_list|,
name|capl
argument_list|)
operator|==
literal|0
condition|)
block|{
name|p
operator|+=
name|capl
expr_stmt|;
name|c
operator|=
operator|*
name|p
expr_stmt|;
if|if
condition|(
name|c
operator|&&
name|c
operator|!=
literal|':'
operator|&&
name|c
operator|!=
literal|'@'
condition|)
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|0
operator|||
name|c
operator|==
literal|'@'
operator|||
name|c
operator|==
literal|'='
operator|||
name|c
operator|==
literal|':'
operator|||
name|c
operator|==
literal|'#'
condition|)
name|cp
operator|=
name|tep
expr_stmt|;
block|}
while|while
condition|(
name|c
operator|=
operator|*
name|p
condition|)
block|{
name|p
operator|++
expr_stmt|;
if|if
condition|(
name|mode
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|c
operator|==
literal|':'
condition|)
break|break;
if|if
condition|(
name|c
operator|==
literal|'^'
condition|)
name|mode
operator|=
literal|1
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'\\'
condition|)
name|mode
operator|=
literal|2
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
literal|1
condition|)
block|{
name|c
operator|=
name|c
operator|&
literal|0x1f
expr_stmt|;
name|mode
operator|=
literal|0
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|mode
operator|==
literal|2
condition|)
block|{
switch|switch
condition|(
name|c
condition|)
block|{
case|case
literal|'0'
case|:
case|case
literal|'1'
case|:
case|case
literal|'2'
case|:
case|case
literal|'3'
case|:
case|case
literal|'4'
case|:
case|case
literal|'5'
case|:
case|case
literal|'6'
case|:
case|case
literal|'7'
case|:
case|case
literal|'8'
case|:
case|case
literal|'9'
case|:
name|mode
operator|=
literal|3
expr_stmt|;
name|num
operator|=
literal|0
expr_stmt|;
break|break;
case|case
literal|'E'
case|:
name|c
operator|=
literal|27
expr_stmt|;
break|break;
case|case
literal|'n'
case|:
name|c
operator|=
literal|'\n'
expr_stmt|;
break|break;
case|case
literal|'r'
case|:
name|c
operator|=
literal|'\r'
expr_stmt|;
break|break;
case|case
literal|'t'
case|:
name|c
operator|=
literal|'\t'
expr_stmt|;
break|break;
case|case
literal|'b'
case|:
name|c
operator|=
literal|'\b'
expr_stmt|;
break|break;
case|case
literal|'f'
case|:
name|c
operator|=
literal|'\f'
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|mode
operator|==
literal|2
condition|)
name|mode
operator|=
literal|0
expr_stmt|;
block|}
if|if
condition|(
name|mode
operator|>
literal|2
condition|)
block|{
name|num
operator|=
name|num
operator|*
literal|8
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
if|if
condition|(
name|mode
operator|++
operator|==
literal|5
operator|||
operator|(
operator|*
name|p
operator|<
literal|'0'
operator|||
operator|*
name|p
operator|>
literal|'9'
operator|)
condition|)
block|{
name|c
operator|=
name|num
expr_stmt|;
name|mode
operator|=
literal|0
expr_stmt|;
block|}
block|}
if|if
condition|(
name|mode
condition|)
continue|continue;
if|if
condition|(
name|cp
operator|&&
name|n
operator|!=
literal|1
condition|)
block|{
operator|*
name|cp
operator|++
operator|=
name|c
expr_stmt|;
name|n
operator|--
expr_stmt|;
block|}
block|}
if|if
condition|(
name|cp
condition|)
block|{
operator|*
name|cp
operator|++
operator|=
literal|0
expr_stmt|;
operator|*
name|tepp
operator|=
name|cp
expr_stmt|;
name|debug2
argument_list|(
literal|"'%s' found in extra_incap -> %s\n"
argument_list|,
name|cap
argument_list|,
name|tep
argument_list|)
expr_stmt|;
return|return
operator|(
name|tep
operator|)
return|;
block|}
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|char
modifier|*
name|e_tgetstr
parameter_list|(
name|cap
parameter_list|,
name|tepp
parameter_list|)
name|char
modifier|*
name|cap
decl_stmt|;
name|char
modifier|*
modifier|*
name|tepp
decl_stmt|;
block|{
name|char
modifier|*
name|tep
decl_stmt|;
if|if
condition|(
name|tep
operator|=
name|findcap
argument_list|(
name|cap
argument_list|,
name|tepp
argument_list|,
literal|0
argument_list|)
condition|)
return|return
operator|(
operator|(
operator|*
name|tep
operator|==
literal|'@'
operator|)
condition|?
literal|0
else|:
name|tep
operator|)
return|;
return|return
operator|(
name|tgetstr
argument_list|(
name|cap
argument_list|,
name|tepp
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e_tgetflag
parameter_list|(
name|cap
parameter_list|)
name|char
modifier|*
name|cap
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|2
index|]
decl_stmt|,
modifier|*
name|bufp
decl_stmt|;
name|char
modifier|*
name|tep
decl_stmt|;
name|bufp
operator|=
name|buf
expr_stmt|;
if|if
condition|(
name|tep
operator|=
name|findcap
argument_list|(
name|cap
argument_list|,
operator|&
name|bufp
argument_list|,
literal|2
argument_list|)
condition|)
return|return
operator|(
operator|(
operator|*
name|tep
operator|==
literal|'@'
operator|)
condition|?
literal|0
else|:
literal|1
operator|)
return|;
return|return
operator|(
name|tgetflag
argument_list|(
name|cap
argument_list|)
operator|)
return|;
block|}
end_function

begin_function
specifier|static
name|int
name|e_tgetnum
parameter_list|(
name|cap
parameter_list|)
name|char
modifier|*
name|cap
decl_stmt|;
block|{
name|char
name|buf
index|[
literal|20
index|]
decl_stmt|,
modifier|*
name|bufp
decl_stmt|;
name|char
modifier|*
name|tep
decl_stmt|,
name|c
decl_stmt|;
name|int
name|res
decl_stmt|,
name|base
init|=
literal|10
decl_stmt|;
name|bufp
operator|=
name|buf
expr_stmt|;
if|if
condition|(
name|tep
operator|=
name|findcap
argument_list|(
name|cap
argument_list|,
operator|&
name|bufp
argument_list|,
literal|20
argument_list|)
condition|)
block|{
name|c
operator|=
operator|*
name|tep
expr_stmt|;
if|if
condition|(
name|c
operator|==
literal|'@'
condition|)
return|return
operator|(
operator|-
literal|1
operator|)
return|;
if|if
condition|(
name|c
operator|==
literal|'0'
condition|)
name|base
operator|=
literal|8
expr_stmt|;
name|res
operator|=
literal|0
expr_stmt|;
while|while
condition|(
operator|(
name|c
operator|=
operator|*
name|tep
operator|++
operator|)
operator|>=
literal|'0'
operator|&&
name|c
operator|<=
literal|'9'
condition|)
name|res
operator|=
name|res
operator|*
name|base
operator|+
operator|(
name|c
operator|-
literal|'0'
operator|)
expr_stmt|;
return|return
operator|(
name|res
operator|)
return|;
block|}
return|return
operator|(
name|tgetnum
argument_list|(
name|cap
argument_list|)
operator|)
return|;
block|}
end_function

end_unit


begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* mailcheck.c -- The check is in the mail... */
end_comment

begin_comment
comment|/* Copyright (C) 1987,1989 Free Software Foundation, Inc.  This file is part of GNU Bash, the Bourne Again SHell.  Bash is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 1, or (at your option) any later version.  Bash is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.  You should have received a copy of the GNU General Public License along with Bash; see the file COPYING.  If not, write to the Free Software Foundation, 675 Mass Ave, Cambridge, MA 02139, USA. */
end_comment

begin_include
include|#
directive|include
file|<stdio.h>
end_include

begin_include
include|#
directive|include
file|<sys/types.h>
end_include

begin_include
include|#
directive|include
file|"posixstat.h"
end_include

begin_include
include|#
directive|include
file|<sys/param.h>
end_include

begin_include
include|#
directive|include
file|"shell.h"
end_include

begin_include
include|#
directive|include
file|"maxpath.h"
end_include

begin_ifndef
ifndef|#
directive|ifndef
name|NOW
end_ifndef

begin_define
define|#
directive|define
name|NOW
value|((time_t)time ((time_t *)0))
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_typedef
typedef|typedef
struct|struct
block|{
name|char
modifier|*
name|name
decl_stmt|;
name|time_t
name|access_time
decl_stmt|;
name|time_t
name|mod_time
decl_stmt|;
name|long
name|file_size
decl_stmt|;
block|}
name|FILEINFO
typedef|;
end_typedef

begin_comment
comment|/* The list of remembered mail files. */
end_comment

begin_decl_stmt
name|FILEINFO
modifier|*
modifier|*
name|mailfiles
init|=
operator|(
name|FILEINFO
operator|*
operator|*
operator|)
name|NULL
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Number of mail files that we have. */
end_comment

begin_decl_stmt
name|int
name|mailfiles_count
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The last known time that mail was checked. */
end_comment

begin_decl_stmt
name|int
name|last_time_mail_checked
init|=
literal|0
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Returns non-zero if it is time to check mail. */
end_comment

begin_macro
name|time_to_check_mail
argument_list|()
end_macro

begin_block
block|{
name|char
modifier|*
name|temp
init|=
name|get_string_value
argument_list|(
literal|"MAILCHECK"
argument_list|)
decl_stmt|;
name|time_t
name|now
init|=
name|NOW
decl_stmt|;
name|unsigned
name|seconds
init|=
literal|0
decl_stmt|;
if|if
condition|(
operator|(
operator|!
name|temp
operator|||
name|sscanf
argument_list|(
name|temp
argument_list|,
literal|"%u"
argument_list|,
operator|&
name|seconds
argument_list|)
operator|==
literal|0
operator|)
operator|||
operator|(
operator|(
name|now
operator|-
name|last_time_mail_checked
operator|<
name|seconds
operator|)
operator|)
condition|)
return|return
operator|(
literal|0
operator|)
return|;
return|return
operator|(
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Okay, we have checked the mail.  Perhaps I should make this function    go away. */
end_comment

begin_macro
name|reset_mail_timer
argument_list|()
end_macro

begin_block
block|{
name|last_time_mail_checked
operator|=
name|NOW
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Locate a file in the list.  Return index of    entry, or -1 if not found. */
end_comment

begin_macro
name|find_mail_file
argument_list|(
argument|file
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_block
block|{
specifier|register
name|int
name|index
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|index
operator|<
name|mailfiles_count
condition|)
if|if
condition|(
name|strcmp
argument_list|(
operator|(
name|mailfiles
index|[
name|index
index|]
operator|)
operator|->
name|name
argument_list|,
name|file
argument_list|)
operator|==
literal|0
condition|)
return|return
name|index
return|;
else|else
name|index
operator|++
expr_stmt|;
return|return
operator|(
operator|-
literal|1
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Add this file to the list of remembered files. */
end_comment

begin_macro
name|add_mail_file
argument_list|(
argument|file
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|struct
name|stat
name|finfo
decl_stmt|;
name|char
modifier|*
name|full_pathname
parameter_list|()
function_decl|;
name|char
modifier|*
name|filename
init|=
name|full_pathname
argument_list|(
name|file
argument_list|)
decl_stmt|;
name|int
name|index
init|=
name|find_mail_file
argument_list|(
name|file
argument_list|)
decl_stmt|;
if|if
condition|(
name|index
operator|>
operator|-
literal|1
condition|)
block|{
if|if
condition|(
name|stat
argument_list|(
name|filename
argument_list|,
operator|&
name|finfo
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mailfiles
index|[
name|index
index|]
operator|->
name|mod_time
operator|=
name|finfo
operator|.
name|st_mtime
expr_stmt|;
name|mailfiles
index|[
name|index
index|]
operator|->
name|access_time
operator|=
name|finfo
operator|.
name|st_atime
expr_stmt|;
name|mailfiles
index|[
name|index
index|]
operator|->
name|file_size
operator|=
operator|(
name|long
operator|)
name|finfo
operator|.
name|st_size
expr_stmt|;
block|}
name|free
argument_list|(
name|filename
argument_list|)
expr_stmt|;
return|return;
block|}
name|mailfiles
operator|=
operator|(
name|FILEINFO
operator|*
operator|*
operator|)
name|xrealloc
argument_list|(
name|mailfiles
argument_list|,
operator|(
operator|(
operator|++
name|mailfiles_count
operator|)
operator|*
sizeof|sizeof
argument_list|(
name|FILEINFO
operator|*
argument_list|)
operator|)
argument_list|)
expr_stmt|;
name|mailfiles
index|[
name|mailfiles_count
operator|-
literal|1
index|]
operator|=
operator|(
name|FILEINFO
operator|*
operator|)
name|xmalloc
argument_list|(
sizeof|sizeof
argument_list|(
name|FILEINFO
argument_list|)
argument_list|)
expr_stmt|;
name|mailfiles
index|[
name|mailfiles_count
operator|-
literal|1
index|]
operator|->
name|name
operator|=
name|filename
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|filename
argument_list|,
operator|&
name|finfo
argument_list|)
operator|==
literal|0
condition|)
block|{
name|mailfiles
index|[
name|mailfiles_count
operator|-
literal|1
index|]
operator|->
name|access_time
operator|=
name|finfo
operator|.
name|st_atime
expr_stmt|;
name|mailfiles
index|[
name|mailfiles_count
operator|-
literal|1
index|]
operator|->
name|mod_time
operator|=
name|finfo
operator|.
name|st_mtime
expr_stmt|;
name|mailfiles
index|[
name|mailfiles_count
operator|-
literal|1
index|]
operator|->
name|file_size
operator|=
name|finfo
operator|.
name|st_size
expr_stmt|;
block|}
else|else
block|{
name|mailfiles
index|[
name|mailfiles_count
operator|-
literal|1
index|]
operator|->
name|access_time
operator|=
name|mailfiles
index|[
name|mailfiles_count
operator|-
literal|1
index|]
operator|->
name|mod_time
operator|=
operator|(
name|time_t
operator|)
operator|-
literal|1
expr_stmt|;
name|mailfiles
index|[
name|mailfiles_count
operator|-
literal|1
index|]
operator|->
name|file_size
operator|=
operator|(
name|long
operator|)
operator|-
literal|1
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Reset the existing mail files access and modification times to zero. */
end_comment

begin_macro
name|reset_mail_files
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|mailfiles_count
condition|;
name|i
operator|++
control|)
block|{
name|mailfiles
index|[
name|i
index|]
operator|->
name|access_time
operator|=
name|mailfiles
index|[
name|i
index|]
operator|->
name|mod_time
operator|=
literal|0
expr_stmt|;
name|mailfiles
index|[
name|i
index|]
operator|->
name|file_size
operator|=
operator|(
name|long
operator|)
literal|0
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* Free the information that we have about the remembered mail files. */
end_comment

begin_macro
name|free_mail_files
argument_list|()
end_macro

begin_block
block|{
while|while
condition|(
name|mailfiles_count
operator|--
condition|)
block|{
name|free
argument_list|(
name|mailfiles
index|[
name|mailfiles_count
index|]
operator|->
name|name
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|mailfiles
index|[
name|mailfiles_count
index|]
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|mailfiles
condition|)
name|free
argument_list|(
name|mailfiles
argument_list|)
expr_stmt|;
name|mailfiles_count
operator|=
literal|0
expr_stmt|;
name|mailfiles
operator|=
operator|(
name|FILEINFO
operator|*
operator|*
operator|)
name|NULL
expr_stmt|;
block|}
end_block

begin_comment
comment|/* Return the full pathname of FILE.  Easy.  Filenames that begin    with a '/' are returned as themselves.  Other filenames have    the current working directory prepended.  A new string is    returned in either case. */
end_comment

begin_function
name|char
modifier|*
name|full_pathname
parameter_list|(
name|file
parameter_list|)
name|char
modifier|*
name|file
decl_stmt|;
block|{
name|char
modifier|*
name|tilde_expand
argument_list|()
decl_stmt|,
modifier|*
name|disposer
decl_stmt|;
if|if
condition|(
operator|*
name|file
operator|==
literal|'~'
condition|)
name|file
operator|=
name|tilde_expand
argument_list|(
name|file
argument_list|)
expr_stmt|;
else|else
name|file
operator|=
name|savestring
argument_list|(
name|file
argument_list|)
expr_stmt|;
if|if
condition|(
name|absolute_pathname
argument_list|(
name|file
argument_list|)
condition|)
if|if
condition|(
operator|*
name|file
operator|==
literal|'/'
condition|)
return|return
operator|(
name|file
operator|)
return|;
name|disposer
operator|=
name|file
expr_stmt|;
block|{
name|char
modifier|*
name|current_dir
init|=
operator|(
name|char
operator|*
operator|)
name|xmalloc
argument_list|(
literal|2
operator|+
name|MAXPATHLEN
operator|+
name|strlen
argument_list|(
name|file
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|getwd
argument_list|(
name|current_dir
argument_list|)
condition|)
block|{
name|report_error
argument_list|(
name|current_dir
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|current_dir
argument_list|)
expr_stmt|;
return|return
operator|(
operator|(
name|char
operator|*
operator|)
name|NULL
operator|)
return|;
block|}
name|strcat
argument_list|(
name|current_dir
argument_list|,
literal|"/"
argument_list|)
expr_stmt|;
comment|/* Turn /foo/./bar into /foo/bar. */
if|if
condition|(
name|strncmp
argument_list|(
name|file
argument_list|,
literal|"./"
argument_list|,
literal|2
argument_list|)
operator|==
literal|0
condition|)
name|file
operator|+=
literal|2
expr_stmt|;
name|strcat
argument_list|(
name|current_dir
argument_list|,
name|file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|disposer
argument_list|)
expr_stmt|;
return|return
operator|(
name|current_dir
operator|)
return|;
block|}
block|}
end_function

begin_comment
comment|/* Return non-zero if FILE's mod date has changed. */
end_comment

begin_macro
name|file_mod_date_changed
argument_list|(
argument|file
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|time_t
name|time
init|=
operator|(
name|time_t
operator|)
name|NULL
decl_stmt|;
name|struct
name|stat
name|finfo
decl_stmt|;
name|int
name|index
init|=
name|find_mail_file
argument_list|(
name|file
argument_list|)
decl_stmt|;
if|if
condition|(
name|index
operator|!=
operator|-
literal|1
condition|)
name|time
operator|=
name|mailfiles
index|[
name|index
index|]
operator|->
name|mod_time
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|file
argument_list|,
operator|&
name|finfo
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|finfo
operator|.
name|st_size
operator|!=
literal|0
condition|)
return|return
operator|(
name|time
operator|!=
name|finfo
operator|.
name|st_mtime
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Return non-zero if FILE's access date has changed. */
end_comment

begin_macro
name|file_access_date_changed
argument_list|(
argument|file
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|time_t
name|time
init|=
operator|(
name|time_t
operator|)
name|NULL
decl_stmt|;
name|struct
name|stat
name|finfo
decl_stmt|;
name|int
name|index
init|=
name|find_mail_file
argument_list|(
name|file
argument_list|)
decl_stmt|;
if|if
condition|(
name|index
operator|!=
operator|-
literal|1
condition|)
name|time
operator|=
name|mailfiles
index|[
name|index
index|]
operator|->
name|access_time
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|file
argument_list|,
operator|&
name|finfo
argument_list|)
operator|==
literal|0
condition|)
block|{
if|if
condition|(
name|finfo
operator|.
name|st_size
operator|!=
literal|0
condition|)
return|return
operator|(
name|time
operator|!=
name|finfo
operator|.
name|st_atime
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_comment
comment|/* Return non-zero if FILE's size has increased. */
end_comment

begin_macro
name|file_has_grown
argument_list|(
argument|file
argument_list|)
end_macro

begin_decl_stmt
name|char
modifier|*
name|file
decl_stmt|;
end_decl_stmt

begin_block
block|{
name|long
name|size
init|=
literal|0L
decl_stmt|;
name|struct
name|stat
name|finfo
decl_stmt|;
name|int
name|i
init|=
name|find_mail_file
argument_list|(
name|file
argument_list|)
decl_stmt|;
if|if
condition|(
name|i
operator|!=
operator|-
literal|1
condition|)
name|size
operator|=
name|mailfiles
index|[
name|i
index|]
operator|->
name|file_size
expr_stmt|;
if|if
condition|(
name|stat
argument_list|(
name|file
argument_list|,
operator|&
name|finfo
argument_list|)
operator|==
literal|0
condition|)
block|{
return|return
operator|(
name|finfo
operator|.
name|st_size
operator|>
name|size
operator|)
return|;
block|}
return|return
operator|(
literal|0
operator|)
return|;
block|}
end_block

begin_if
if|#
directive|if
name|defined
argument_list|(
name|USG
argument_list|)
end_if

begin_define
define|#
directive|define
name|DEFAULT_MAIL_PATH
value|"/usr/mail/"
end_define

begin_else
else|#
directive|else
end_else

begin_define
define|#
directive|define
name|DEFAULT_MAIL_PATH
value|"/usr/spool/mail/"
end_define

begin_endif
endif|#
directive|endif
end_endif

begin_comment
comment|/* Return the colon separated list of pathnames to check for mail. */
end_comment

begin_function
name|char
modifier|*
name|get_mailpaths
parameter_list|()
block|{
specifier|extern
name|char
modifier|*
name|current_user_name
decl_stmt|;
name|char
modifier|*
name|mailpaths
decl_stmt|;
name|mailpaths
operator|=
name|get_string_value
argument_list|(
literal|"MAILPATH"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mailpaths
condition|)
name|mailpaths
operator|=
name|get_string_value
argument_list|(
literal|"MAIL"
argument_list|)
expr_stmt|;
if|if
condition|(
operator|!
name|mailpaths
condition|)
block|{
name|mailpaths
operator|=
operator|(
name|char
operator|*
operator|)
name|alloca
argument_list|(
literal|1
operator|+
name|strlen
argument_list|(
name|DEFAULT_MAIL_PATH
argument_list|)
operator|+
name|strlen
argument_list|(
name|current_user_name
argument_list|)
argument_list|)
expr_stmt|;
name|sprintf
argument_list|(
name|mailpaths
argument_list|,
literal|"%s%s"
argument_list|,
name|DEFAULT_MAIL_PATH
argument_list|,
name|current_user_name
argument_list|)
expr_stmt|;
block|}
return|return
operator|(
name|savestring
argument_list|(
name|mailpaths
argument_list|)
operator|)
return|;
block|}
end_function

begin_comment
comment|/* Remember the dates of the files specified by MAILPATH, or if there is    no MAILPATH, by the file specified in MAIL.  If neither exists, use a    default value, which we randomly concoct from using Unix. */
end_comment

begin_macro
name|remember_mail_dates
argument_list|()
end_macro

begin_block
block|{
name|char
modifier|*
name|mailpaths
init|=
name|get_mailpaths
argument_list|()
decl_stmt|;
name|char
modifier|*
name|mailfile
decl_stmt|,
modifier|*
name|extract_colon_unit
argument_list|()
decl_stmt|;
name|int
name|index
init|=
literal|0
decl_stmt|;
while|while
condition|(
name|mailfile
operator|=
name|extract_colon_unit
argument_list|(
name|mailpaths
argument_list|,
operator|&
name|index
argument_list|)
condition|)
block|{
specifier|register
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|mailfile
index|[
name|i
index|]
operator|&&
name|mailfile
index|[
name|i
index|]
operator|!=
literal|'?'
operator|&&
name|mailfile
index|[
name|i
index|]
operator|!=
literal|'%'
condition|;
name|i
operator|++
control|)
empty_stmt|;
name|mailfile
index|[
name|i
index|]
operator|=
literal|'\0'
expr_stmt|;
name|add_mail_file
argument_list|(
name|mailfile
argument_list|)
expr_stmt|;
block|}
block|}
end_block

begin_comment
comment|/* check_mail () is useful for more than just checking mail.  Since it has    the paranoids dream ability of telling you when someone has read your    mail, it can just as easily be used to tell you when someones .profile    file has been read, thus letting one know when someone else has logged    in.  Pretty good, huh? */
end_comment

begin_comment
comment|/* Check for mail in some files.  If the modification date of any    of the files in MAILPATH has changed since we last did a    remember_mail_dates () then mention that the user has mail.    Special hack:  If the shell variable MAIL_WARNING is on and the    mail file has been accessed since the last time we remembered, then    the message "The mail in<mailfile> has been read" is printed. */
end_comment

begin_macro
name|check_mail
argument_list|()
end_macro

begin_block
block|{
specifier|register
name|int
name|string_index
decl_stmt|;
name|char
modifier|*
name|extract_colon_unit
parameter_list|()
function_decl|;
name|char
modifier|*
name|current_mail_file
decl_stmt|,
modifier|*
name|you_have_mail_message
decl_stmt|;
name|char
modifier|*
name|mailpaths
init|=
name|get_mailpaths
argument_list|()
decl_stmt|;
name|int
name|index
init|=
literal|0
decl_stmt|;
name|char
modifier|*
name|dollar_underscore
decl_stmt|;
name|dollar_underscore
operator|=
name|get_string_value
argument_list|(
literal|"_"
argument_list|)
expr_stmt|;
if|if
condition|(
name|dollar_underscore
condition|)
name|dollar_underscore
operator|=
name|savestring
argument_list|(
name|dollar_underscore
argument_list|)
expr_stmt|;
while|while
condition|(
operator|(
name|current_mail_file
operator|=
name|extract_colon_unit
argument_list|(
name|mailpaths
argument_list|,
operator|&
name|index
argument_list|)
operator|)
condition|)
block|{
name|char
modifier|*
name|t
decl_stmt|;
name|int
name|use_user_notification
decl_stmt|;
if|if
condition|(
operator|!
operator|*
name|current_mail_file
condition|)
block|{
name|free
argument_list|(
name|current_mail_file
argument_list|)
expr_stmt|;
continue|continue;
block|}
name|t
operator|=
name|full_pathname
argument_list|(
name|current_mail_file
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|current_mail_file
argument_list|)
expr_stmt|;
name|current_mail_file
operator|=
name|t
expr_stmt|;
name|use_user_notification
operator|=
literal|0
expr_stmt|;
name|you_have_mail_message
operator|=
literal|"You have mail in $_"
expr_stmt|;
for|for
control|(
name|string_index
operator|=
literal|0
init|;
name|current_mail_file
index|[
name|string_index
index|]
condition|;
name|string_index
operator|++
control|)
if|if
condition|(
name|current_mail_file
index|[
name|string_index
index|]
operator|==
literal|'?'
operator|||
name|current_mail_file
index|[
name|string_index
index|]
operator|==
literal|'%'
condition|)
block|{
name|current_mail_file
index|[
name|string_index
index|]
operator|=
literal|'\0'
expr_stmt|;
name|you_have_mail_message
operator|=
name|current_mail_file
operator|+
name|string_index
operator|+
literal|1
expr_stmt|;
name|use_user_notification
operator|++
expr_stmt|;
break|break;
block|}
if|if
condition|(
name|file_mod_date_changed
argument_list|(
name|current_mail_file
argument_list|)
condition|)
block|{
name|WORD_LIST
modifier|*
name|tlist
decl_stmt|,
modifier|*
name|expand_string
argument_list|()
decl_stmt|;
name|char
modifier|*
name|string_list
parameter_list|()
function_decl|;
name|int
name|i
decl_stmt|,
name|file_is_bigger
decl_stmt|;
name|bind_variable
argument_list|(
literal|"_"
argument_list|,
name|current_mail_file
argument_list|)
expr_stmt|;
comment|/* Have to compute this before the call to add_mail_file, which 	     resets all the information. */
name|file_is_bigger
operator|=
name|file_has_grown
argument_list|(
name|current_mail_file
argument_list|)
expr_stmt|;
name|add_mail_file
argument_list|(
name|current_mail_file
argument_list|)
expr_stmt|;
name|i
operator|=
name|find_mail_file
argument_list|(
name|current_mail_file
argument_list|)
expr_stmt|;
comment|/* If the user has just run a program which manipulates the 	     mail file, then don't bother explaining that the mail 	     file has been manipulated.  Since some systems don't change 	     the access time to be equal to the modification time when 	     the mail in the file is manipulated, check the size also.  If 	     the file has not grown, continue. */
if|if
condition|(
name|i
operator|!=
operator|-
literal|1
operator|&&
operator|(
name|mailfiles
index|[
name|i
index|]
operator|->
name|access_time
operator|==
name|mailfiles
index|[
name|i
index|]
operator|->
name|mod_time
operator|)
operator|&&
operator|!
name|file_is_bigger
condition|)
goto|goto
name|next_mail_file
goto|;
if|if
condition|(
operator|!
name|use_user_notification
condition|)
block|{
if|if
condition|(
name|i
operator|!=
operator|-
literal|1
operator|&&
operator|(
name|mailfiles
index|[
name|i
index|]
operator|->
name|access_time
operator|<
name|mailfiles
index|[
name|i
index|]
operator|->
name|mod_time
operator|)
operator|&&
name|file_is_bigger
condition|)
name|you_have_mail_message
operator|=
literal|"You have new mail in $_"
expr_stmt|;
block|}
if|if
condition|(
operator|(
name|tlist
operator|=
name|expand_string
argument_list|(
name|you_have_mail_message
argument_list|,
literal|1
argument_list|)
operator|)
condition|)
block|{
name|char
modifier|*
name|tem
init|=
name|string_list
argument_list|(
name|tlist
argument_list|)
decl_stmt|;
name|you_have_mail_message
operator|=
operator|(
name|char
operator|*
operator|)
name|alloca
argument_list|(
literal|1
operator|+
name|strlen
argument_list|(
name|tem
argument_list|)
argument_list|)
expr_stmt|;
name|strcpy
argument_list|(
name|you_have_mail_message
argument_list|,
name|tem
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|tem
argument_list|)
expr_stmt|;
block|}
else|else
name|you_have_mail_message
operator|=
literal|""
expr_stmt|;
name|printf
argument_list|(
literal|"%s\n"
argument_list|,
name|you_have_mail_message
argument_list|)
expr_stmt|;
name|dispose_words
argument_list|(
name|tlist
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|find_variable
argument_list|(
literal|"MAIL_WARNING"
argument_list|)
operator|&&
name|file_access_date_changed
argument_list|(
name|current_mail_file
argument_list|)
condition|)
block|{
name|add_mail_file
argument_list|(
name|current_mail_file
argument_list|)
expr_stmt|;
name|printf
argument_list|(
literal|"The mail in %s has been read!\n"
argument_list|,
name|current_mail_file
argument_list|)
expr_stmt|;
block|}
name|next_mail_file
label|:
name|free
argument_list|(
name|current_mail_file
argument_list|)
expr_stmt|;
block|}
name|free
argument_list|(
name|mailpaths
argument_list|)
expr_stmt|;
if|if
condition|(
name|dollar_underscore
condition|)
block|{
name|bind_variable
argument_list|(
literal|"_"
argument_list|,
name|dollar_underscore
argument_list|)
expr_stmt|;
name|free
argument_list|(
name|dollar_underscore
argument_list|)
expr_stmt|;
block|}
else|else
name|unbind_variable
argument_list|(
literal|"_"
argument_list|)
expr_stmt|;
block|}
end_block

end_unit


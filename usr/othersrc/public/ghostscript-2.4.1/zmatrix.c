begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1991 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* zmatrix.c */
end_comment

begin_comment
comment|/* Matrix operators for Ghostscript */
end_comment

begin_include
include|#
directive|include
file|"ghost.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"oper.h"
end_include

begin_include
include|#
directive|include
file|"gsmatrix.h"
end_include

begin_include
include|#
directive|include
file|"state.h"
end_include

begin_include
include|#
directive|include
file|"gscoord.h"
end_include

begin_include
include|#
directive|include
file|"store.h"
end_include

begin_comment
comment|/* Forward references */
end_comment

begin_decl_stmt
name|private
name|int
name|near
name|common_transform
argument_list|(
name|P3
argument_list|(
name|os_ptr
argument_list|,
name|int
argument_list|(
operator|*
argument_list|)
argument_list|(
name|P4
argument_list|(
name|gs_state
operator|*
argument_list|,
name|floatp
argument_list|,
name|floatp
argument_list|,
name|gs_point
operator|*
argument_list|)
argument_list|)
argument_list|,
name|int
argument_list|(
operator|*
argument_list|)
argument_list|(
name|P4
argument_list|(
name|floatp
argument_list|,
name|floatp
argument_list|,
specifier|const
name|gs_matrix
operator|*
argument_list|,
name|gs_point
operator|*
argument_list|)
argument_list|)
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Initialize the type and attributes of the identity matrix. */
end_comment

begin_comment
comment|/* We may have to do this after each save and restore, */
end_comment

begin_comment
comment|/* in order to get the l_new attribute correct. */
end_comment

begin_function
name|void
name|init_identity_matrix
parameter_list|()
block|{
specifier|extern
name|gs_matrix
name|gs_identity_matrix
decl_stmt|;
name|ref
modifier|*
name|mp
init|=
operator|(
name|ref
operator|*
operator|)
operator|&
name|gs_identity_matrix
decl_stmt|;
name|int
name|attrs
init|=
name|alloc_save_new_mask
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|6
condition|;
name|i
operator|++
operator|,
name|mp
operator|++
control|)
name|r_set_type_attrs
argument_list|(
name|mp
argument_list|,
name|t_real
argument_list|,
name|attrs
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* currentmatrix */
end_comment

begin_function
name|int
name|zcurrentmatrix
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
init|=
name|write_matrix
argument_list|(
name|op
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|gs_currentmatrix
argument_list|(
name|igs
argument_list|,
operator|(
name|gs_matrix
operator|*
operator|)
operator|(
name|op
operator|->
name|value
operator|.
name|refs
operator|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setmatrix */
end_comment

begin_function
name|int
name|zsetmatrix
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gs_matrix
name|mat
decl_stmt|;
name|int
name|code
init|=
name|read_matrix
argument_list|(
name|op
argument_list|,
operator|&
name|mat
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
if|if
condition|(
operator|(
name|code
operator|=
name|gs_setmatrix
argument_list|(
name|igs
argument_list|,
operator|&
name|mat
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* translate */
end_comment

begin_function
name|int
name|ztranslate
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
init|=
name|write_matrix
argument_list|(
name|op
argument_list|)
decl_stmt|;
name|float
name|trans
index|[
literal|2
index|]
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
comment|/* no matrix operand */
block|{
if|if
condition|(
operator|(
name|code
operator|=
name|num_params
argument_list|(
name|op
argument_list|,
literal|2
argument_list|,
name|trans
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|code
operator|=
name|gs_translate
argument_list|(
name|igs
argument_list|,
name|trans
index|[
literal|0
index|]
argument_list|,
name|trans
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* matrix operand */
block|{
name|gs_matrix
modifier|*
name|pmat
init|=
operator|(
name|gs_matrix
operator|*
operator|)
name|op
operator|->
name|value
operator|.
name|refs
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|num_params
argument_list|(
name|op
operator|-
literal|1
argument_list|,
literal|2
argument_list|,
name|trans
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|code
operator|=
name|gs_make_translation
argument_list|(
name|trans
index|[
literal|0
index|]
argument_list|,
name|trans
index|[
literal|1
index|]
argument_list|,
name|pmat
argument_list|)
expr_stmt|;
name|op
index|[
operator|-
literal|2
index|]
operator|=
operator|*
name|op
expr_stmt|;
block|}
if|if
condition|(
name|code
operator|>=
literal|0
condition|)
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* scale */
end_comment

begin_function
name|int
name|zscale
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|float
name|scale
index|[
literal|2
index|]
decl_stmt|;
name|int
name|code
init|=
name|write_matrix
argument_list|(
name|op
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
comment|/* no matrix operand */
block|{
if|if
condition|(
operator|(
name|code
operator|=
name|num_params
argument_list|(
name|op
argument_list|,
literal|2
argument_list|,
name|scale
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|code
operator|=
name|gs_scale
argument_list|(
name|igs
argument_list|,
name|scale
index|[
literal|0
index|]
argument_list|,
name|scale
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* matrix operand */
block|{
name|gs_matrix
modifier|*
name|pmat
init|=
operator|(
name|gs_matrix
operator|*
operator|)
name|op
operator|->
name|value
operator|.
name|refs
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|num_params
argument_list|(
name|op
operator|-
literal|1
argument_list|,
literal|2
argument_list|,
name|scale
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|code
operator|=
name|gs_make_scaling
argument_list|(
name|scale
index|[
literal|0
index|]
argument_list|,
name|scale
index|[
literal|1
index|]
argument_list|,
name|pmat
argument_list|)
expr_stmt|;
name|op
index|[
operator|-
literal|2
index|]
operator|=
operator|*
name|op
expr_stmt|;
block|}
if|if
condition|(
name|code
operator|>=
literal|0
condition|)
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* rotate */
end_comment

begin_function
name|int
name|zrotate
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
init|=
name|write_matrix
argument_list|(
name|op
argument_list|)
decl_stmt|;
name|float
name|ang
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
comment|/* no matrix operand */
block|{
if|if
condition|(
operator|(
name|code
operator|=
name|num_params
argument_list|(
name|op
argument_list|,
literal|1
argument_list|,
operator|&
name|ang
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|code
operator|=
name|gs_rotate
argument_list|(
name|igs
argument_list|,
name|ang
argument_list|)
expr_stmt|;
block|}
else|else
comment|/* matrix operand */
block|{
name|gs_matrix
modifier|*
name|pmat
init|=
operator|(
name|gs_matrix
operator|*
operator|)
name|op
operator|->
name|value
operator|.
name|refs
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|num_params
argument_list|(
name|op
operator|-
literal|1
argument_list|,
literal|1
argument_list|,
operator|&
name|ang
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|code
operator|=
name|gs_make_rotation
argument_list|(
name|ang
argument_list|,
name|pmat
argument_list|)
expr_stmt|;
name|op
index|[
operator|-
literal|1
index|]
operator|=
operator|*
name|op
expr_stmt|;
block|}
if|if
condition|(
name|code
operator|>=
literal|0
condition|)
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* concat */
end_comment

begin_function
name|int
name|zconcat
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gs_matrix
name|mat
decl_stmt|;
name|int
name|code
init|=
name|read_matrix
argument_list|(
name|op
argument_list|,
operator|&
name|mat
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|code
operator|=
name|gs_concat
argument_list|(
name|igs
argument_list|,
operator|&
name|mat
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* concatmatrix */
end_comment

begin_function
name|int
name|zconcatmatrix
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gs_matrix
name|m1
decl_stmt|,
name|m2
decl_stmt|;
name|int
name|code
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|read_matrix
argument_list|(
name|op
operator|-
literal|2
argument_list|,
operator|&
name|m1
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|read_matrix
argument_list|(
name|op
operator|-
literal|1
argument_list|,
operator|&
name|m2
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|write_matrix
argument_list|(
name|op
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|gs_matrix_multiply
argument_list|(
operator|&
name|m1
argument_list|,
operator|&
name|m2
argument_list|,
operator|(
name|gs_matrix
operator|*
operator|)
operator|(
name|op
operator|->
name|value
operator|.
name|refs
operator|)
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|op
index|[
operator|-
literal|2
index|]
operator|=
operator|*
name|op
expr_stmt|;
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* transform */
end_comment

begin_function
name|int
name|ztransform
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
return|return
name|common_transform
argument_list|(
name|op
argument_list|,
name|gs_transform
argument_list|,
name|gs_point_transform
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* dtransform */
end_comment

begin_function
name|int
name|zdtransform
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
return|return
name|common_transform
argument_list|(
name|op
argument_list|,
name|gs_dtransform
argument_list|,
name|gs_distance_transform
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* itransform */
end_comment

begin_function
name|int
name|zitransform
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
return|return
name|common_transform
argument_list|(
name|op
argument_list|,
name|gs_itransform
argument_list|,
name|gs_point_transform_inverse
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* idtransform */
end_comment

begin_function
name|int
name|zidtransform
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
return|return
name|common_transform
argument_list|(
name|op
argument_list|,
name|gs_idtransform
argument_list|,
name|gs_distance_transform_inverse
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Common logic for [i][d]transform */
end_comment

begin_decl_stmt
name|private
name|int
name|near
name|common_transform
argument_list|(
specifier|register
name|os_ptr
name|op
argument_list|,
name|int
argument_list|(
operator|*
name|ptproc
argument_list|)
argument_list|(
name|P4
argument_list|(
name|gs_state
operator|*
argument_list|,
name|floatp
argument_list|,
name|floatp
argument_list|,
name|gs_point
operator|*
argument_list|)
argument_list|)
argument_list|,
name|int
argument_list|(
operator|*
name|matproc
argument_list|)
argument_list|(
name|P4
argument_list|(
name|floatp
argument_list|,
name|floatp
argument_list|,
specifier|const
name|gs_matrix
operator|*
argument_list|,
name|gs_point
operator|*
argument_list|)
argument_list|)
argument_list|)
block|{
name|float
name|opxy
index|[
literal|2
index|]
decl_stmt|;
name|gs_point
name|pt
decl_stmt|;
name|int
name|code
decl_stmt|;
comment|/* Optimize for the non-matrix case */
switch|switch
condition|(
name|r_type
argument_list|(
name|op
argument_list|)
condition|)
block|{
case|case
name|t_real
case|:
name|opxy
index|[
literal|1
index|]
operator|=
name|op
operator|->
name|value
operator|.
name|realval
expr_stmt|;
break|break;
case|case
name|t_integer
case|:
name|opxy
index|[
literal|1
index|]
operator|=
name|op
operator|->
name|value
operator|.
name|intval
expr_stmt|;
break|break;
case|case
name|t_array
case|:
comment|/* might be a matrix */
block|{
name|gs_matrix
name|mat
decl_stmt|;
name|gs_matrix
modifier|*
name|pmat
init|=
operator|&
name|mat
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|read_matrix
argument_list|(
name|op
argument_list|,
name|pmat
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|num_params
argument_list|(
name|op
operator|-
literal|1
argument_list|,
literal|2
argument_list|,
name|opxy
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
call|(
modifier|*
name|matproc
call|)
argument_list|(
name|opxy
index|[
literal|0
index|]
argument_list|,
name|opxy
index|[
literal|1
index|]
argument_list|,
name|pmat
argument_list|,
operator|&
name|pt
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|op
operator|--
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
goto|goto
name|out
goto|;
block|}
default|default:
return|return
name|e_typecheck
return|;
block|}
switch|switch
condition|(
name|r_type
argument_list|(
name|op
operator|-
literal|1
argument_list|)
condition|)
block|{
case|case
name|t_real
case|:
name|opxy
index|[
literal|0
index|]
operator|=
operator|(
name|op
operator|-
literal|1
operator|)
operator|->
name|value
operator|.
name|realval
expr_stmt|;
break|break;
case|case
name|t_integer
case|:
name|opxy
index|[
literal|0
index|]
operator|=
operator|(
name|op
operator|-
literal|1
operator|)
operator|->
name|value
operator|.
name|intval
expr_stmt|;
break|break;
default|default:
return|return
name|e_typecheck
return|;
block|}
if|if
condition|(
operator|(
name|code
operator|=
call|(
modifier|*
name|ptproc
call|)
argument_list|(
name|igs
argument_list|,
name|opxy
index|[
literal|0
index|]
argument_list|,
name|opxy
index|[
literal|1
index|]
argument_list|,
operator|&
name|pt
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|out
label|:
name|make_real
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|pt
operator|.
name|x
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
argument_list|,
name|pt
operator|.
name|y
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_decl_stmt

begin_comment
comment|/* invertmatrix */
end_comment

begin_function
name|int
name|zinvertmatrix
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gs_matrix
name|m
decl_stmt|;
name|int
name|code
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|read_matrix
argument_list|(
name|op
operator|-
literal|1
argument_list|,
operator|&
name|m
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|write_matrix
argument_list|(
name|op
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|gs_matrix_invert
argument_list|(
operator|&
name|m
argument_list|,
operator|(
name|gs_matrix
operator|*
operator|)
name|op
operator|->
name|value
operator|.
name|refs
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|op
index|[
operator|-
literal|1
index|]
operator|=
operator|*
name|op
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* ------ Initialization procedure ------ */
end_comment

begin_decl_stmt
name|op_def
name|zmatrix_op_defs
index|[]
init|=
block|{
block|{
literal|"1concat"
block|,
name|zconcat
block|}
block|,
block|{
literal|"2dtransform"
block|,
name|zdtransform
block|}
block|,
block|{
literal|"3concatmatrix"
block|,
name|zconcatmatrix
block|}
block|,
block|{
literal|"1currentmatrix"
block|,
name|zcurrentmatrix
block|}
block|,
block|{
literal|"2idtransform"
block|,
name|zidtransform
block|}
block|,
block|{
literal|"2invertmatrix"
block|,
name|zinvertmatrix
block|}
block|,
block|{
literal|"2itransform"
block|,
name|zitransform
block|}
block|,
block|{
literal|"1rotate"
block|,
name|zrotate
block|}
block|,
block|{
literal|"2scale"
block|,
name|zscale
block|}
block|,
block|{
literal|"1setmatrix"
block|,
name|zsetmatrix
block|}
block|,
block|{
literal|"2transform"
block|,
name|ztransform
block|}
block|,
block|{
literal|"2translate"
block|,
name|ztranslate
block|}
block|,
name|op_def_end
argument_list|(
argument|init_identity_matrix
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

end_unit


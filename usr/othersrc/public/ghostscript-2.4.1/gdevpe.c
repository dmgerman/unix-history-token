begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1990, 1991 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* gdevpe.c  Private Eye display driver for Ghostscript    Hacked by Fran Taylor, Reflection Technology Inc. */
end_comment

begin_include
include|#
directive|include
file|"gx.h"
end_include

begin_include
include|#
directive|include
file|"gxdevice.h"
end_include

begin_function_decl
name|char
modifier|*
name|getenv
parameter_list|(
name|char
modifier|*
name|name
parameter_list|)
function_decl|;
end_function_decl

begin_typedef
typedef|typedef
struct|struct
name|gx_device_pe_s
block|{
name|gx_device_common
expr_stmt|;
name|byte
modifier|*
name|fbaddr
decl_stmt|;
name|unsigned
name|regs
decl_stmt|;
block|}
name|gx_device_pe
typedef|;
end_typedef

begin_define
define|#
directive|define
name|pedev
value|((gx_device_pe *)dev)
end_define

begin_typedef
typedef|typedef
struct|struct
block|{
name|ushort
name|reg
decl_stmt|,
name|val
decl_stmt|;
block|}
name|regval
typedef|;
end_typedef

begin_define
define|#
directive|define
name|XSIZE
value|720
end_define

begin_define
define|#
directive|define
name|YSIZE
value|280
end_define

begin_define
define|#
directive|define
name|BPL
value|90
end_define

begin_define
define|#
directive|define
name|XPPI
value|160.0
end_define

begin_define
define|#
directive|define
name|YPPI
value|96.0
end_define

begin_define
define|#
directive|define
name|DEFAULT_ADDRESS
value|((byte *) 0xb8000000)
end_define

begin_define
define|#
directive|define
name|DEFAULT_REGISTERS
value|0x3d0
end_define

begin_expr_stmt
name|dev_proc_open_device
argument_list|(
name|pe_open
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|dev_proc_close_device
argument_list|(
name|pe_close
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|dev_proc_fill_rectangle
argument_list|(
name|pe_fill_rectangle
argument_list|)
expr_stmt|;
end_expr_stmt

begin_expr_stmt
name|dev_proc_copy_mono
argument_list|(
name|pe_copy_mono
argument_list|)
expr_stmt|;
end_expr_stmt

begin_decl_stmt
specifier|static
name|gx_device_procs
name|pe_procs
init|=
block|{
name|pe_open
block|,
name|gx_default_get_initial_matrix
block|,
name|gx_default_sync_output
block|,
name|gx_default_output_page
block|,
name|pe_close
block|,
name|gx_default_map_rgb_color
block|,
name|gx_default_map_color_rgb
block|,
name|pe_fill_rectangle
block|,
name|gx_default_tile_rectangle
block|,
name|pe_copy_mono
block|,
name|gx_default_copy_color
block|,
name|gx_default_draw_line
block|,
name|gx_default_get_bits
block|,
name|gx_default_get_props
block|,
name|gx_default_put_props
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|gx_device_pe
name|gs_pe_device
init|=
block|{
sizeof|sizeof
argument_list|(
name|gx_device_pe
argument_list|)
block|,
operator|&
name|pe_procs
block|,
literal|"Private Eye"
block|,
name|XSIZE
block|,
name|YSIZE
block|,
name|XPPI
block|,
name|YPPI
block|,
name|no_margins
block|,
name|dci_black_and_white
block|,
literal|0
block|,
name|DEFAULT_ADDRESS
block|,
name|DEFAULT_REGISTERS
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|regval
name|peinit
index|[]
init|=
block|{
block|{
literal|0x04
block|,
literal|0x1e
block|}
block|,
block|{
literal|0x05
block|,
literal|0x00
block|}
block|,
block|{
literal|0x04
block|,
literal|0x0c
block|}
block|,
block|{
literal|0x05
block|,
literal|0x21
block|}
block|,
block|{
literal|0x04
block|,
literal|0x0d
block|}
block|,
block|{
literal|0x05
block|,
literal|0x98
block|}
block|,
block|{
literal|0x08
block|,
literal|0x00
block|}
block|,
block|{
literal|0x08
block|,
literal|0x1e
block|}
block|,
block|{
literal|0x04
block|,
literal|0x1e
block|}
block|,
block|{
literal|0x05
block|,
literal|0x01
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_decl_stmt
specifier|static
name|regval
name|pedone
index|[]
init|=
block|{
block|{
literal|0x04
block|,
literal|0x1e
block|}
block|,
block|{
literal|0x05
block|,
literal|0x10
block|}
block|,
block|{
literal|0x04
block|,
literal|0x0a
block|}
block|,
block|{
literal|0x05
block|,
literal|0x00
block|}
block|,
block|{
literal|0x04
block|,
literal|0x0b
block|}
block|,
block|{
literal|0x05
block|,
literal|0x07
block|}
block|,
block|{
literal|0x04
block|,
literal|0x0c
block|}
block|,
block|{
literal|0x05
block|,
literal|0x00
block|}
block|,
block|{
literal|0x04
block|,
literal|0x0d
block|}
block|,
block|{
literal|0x05
block|,
literal|0x00
block|}
block|,
block|{
literal|0x04
block|,
literal|0x0e
block|}
block|,
block|{
literal|0x05
block|,
literal|0x00
block|}
block|,
block|{
literal|0x04
block|,
literal|0x0f
block|}
block|,
block|{
literal|0x05
block|,
literal|0x00
block|}
block|,
block|{
literal|0x08
block|,
literal|0x00
block|}
block|,
block|{
literal|0x08
block|,
literal|0x29
block|}
block|}
decl_stmt|;
end_decl_stmt

begin_function
name|int
name|pe_open
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|)
block|{
name|char
modifier|*
name|str
decl_stmt|;
name|int
name|i
decl_stmt|;
if|if
condition|(
operator|(
name|str
operator|=
name|getenv
argument_list|(
literal|"PEFBADDR"
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%lx"
argument_list|,
operator|&
operator|(
name|pedev
operator|->
name|fbaddr
operator|)
argument_list|)
condition|)
block|{
name|eprintf
argument_list|(
literal|"Private Eye: PEFBADDR environment string format error\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
operator|(
name|str
operator|=
name|getenv
argument_list|(
literal|"PEREGS"
argument_list|)
operator|)
operator|!=
literal|0
condition|)
block|{
if|if
condition|(
operator|!
name|sscanf
argument_list|(
name|str
argument_list|,
literal|"%x"
argument_list|,
operator|&
operator|(
name|pedev
operator|->
name|regs
operator|)
argument_list|)
condition|)
block|{
name|eprintf
argument_list|(
literal|"Private Eye: PEREGS environment string format error\n"
argument_list|)
expr_stmt|;
name|exit
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
block|}
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|10
condition|;
name|i
operator|++
control|)
name|outportb
argument_list|(
name|pedev
operator|->
name|regs
operator|+
name|peinit
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|peinit
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pe_close
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
comment|/* restore the screen */
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|16
condition|;
name|i
operator|++
control|)
name|outportb
argument_list|(
name|pedev
operator|->
name|regs
operator|+
name|pedone
index|[
name|i
index|]
operator|.
name|reg
argument_list|,
name|pedone
index|[
name|i
index|]
operator|.
name|val
argument_list|)
expr_stmt|;
comment|/* clear the frame buffer */
name|memset
argument_list|(
name|pedev
operator|->
name|fbaddr
argument_list|,
literal|0
argument_list|,
literal|4000
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pe_fill_rectangle
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|int
name|x1
parameter_list|,
name|int
name|y1
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|gx_color_index
name|color
parameter_list|)
block|{
name|int
name|x2
decl_stmt|,
name|y2
decl_stmt|,
name|xlen
decl_stmt|;
name|byte
name|led
decl_stmt|,
name|red
decl_stmt|,
name|d
decl_stmt|;
name|byte
modifier|*
name|ptr
decl_stmt|;
comment|/* cull */
if|if
condition|(
operator|(
name|w
operator|<=
literal|0
operator|)
operator|||
operator|(
name|h
operator|<=
literal|0
operator|)
operator|||
operator|(
name|x1
operator|>
name|XSIZE
operator|)
operator|||
operator|(
name|y1
operator|>
name|YSIZE
operator|)
condition|)
return|return
literal|0
return|;
name|x2
operator|=
name|x1
operator|+
name|w
operator|-
literal|1
expr_stmt|;
name|y2
operator|=
name|y1
operator|+
name|h
operator|-
literal|1
expr_stmt|;
comment|/* cull some more */
if|if
condition|(
operator|(
name|x2
operator|<
literal|0
operator|)
operator|||
operator|(
name|y2
operator|<
literal|0
operator|)
condition|)
return|return
literal|0
return|;
comment|/* clip */
if|if
condition|(
name|x1
operator|<
literal|0
condition|)
name|x1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|x2
operator|>
name|XSIZE
operator|-
literal|1
condition|)
name|x2
operator|=
name|XSIZE
operator|-
literal|1
expr_stmt|;
if|if
condition|(
name|y1
operator|<
literal|0
condition|)
name|y1
operator|=
literal|0
expr_stmt|;
if|if
condition|(
name|y2
operator|>
name|YSIZE
operator|-
literal|1
condition|)
name|y2
operator|=
name|YSIZE
operator|-
literal|1
expr_stmt|;
name|w
operator|=
name|x2
operator|-
name|x1
operator|+
literal|1
expr_stmt|;
name|h
operator|=
name|y2
operator|-
name|y1
operator|+
literal|1
expr_stmt|;
name|xlen
operator|=
operator|(
name|x2
operator|>>
literal|3
operator|)
operator|-
operator|(
name|x1
operator|>>
literal|3
operator|)
operator|-
literal|1
expr_stmt|;
name|led
operator|=
literal|0xff
operator|>>
operator|(
name|x1
operator|&
literal|7
operator|)
expr_stmt|;
name|red
operator|=
literal|0xff
operator|<<
operator|(
literal|7
operator|-
operator|(
name|x2
operator|&
literal|7
operator|)
operator|)
expr_stmt|;
name|ptr
operator|=
name|pedev
operator|->
name|fbaddr
operator|+
operator|(
name|y1
operator|*
name|BPL
operator|)
operator|+
operator|(
name|x1
operator|>>
literal|3
operator|)
expr_stmt|;
if|if
condition|(
name|color
condition|)
block|{
comment|/* here to set pixels */
if|if
condition|(
name|xlen
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* special for rectangles that fit in a byte */
name|d
operator|=
name|led
operator|&
name|red
expr_stmt|;
for|for
control|(
init|;
name|h
operator|>=
literal|0
condition|;
name|h
operator|--
operator|,
name|ptr
operator|+=
name|BPL
control|)
operator|*
name|ptr
operator||=
name|d
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* normal fill */
for|for
control|(
init|;
name|h
operator|>=
literal|0
condition|;
name|h
operator|--
operator|,
name|ptr
operator|+=
name|BPL
control|)
block|{
specifier|register
name|int
name|x
init|=
name|xlen
decl_stmt|;
specifier|register
name|byte
modifier|*
name|p
init|=
name|ptr
decl_stmt|;
operator|*
name|p
operator|++
operator||=
name|led
expr_stmt|;
while|while
condition|(
name|x
operator|--
condition|)
operator|*
name|p
operator|++
operator|=
literal|0xff
expr_stmt|;
operator|*
name|p
operator||=
name|red
expr_stmt|;
block|}
block|}
comment|/* here to clear pixels */
name|led
operator|=
operator|~
name|led
expr_stmt|;
name|red
operator|=
operator|~
name|red
expr_stmt|;
if|if
condition|(
name|xlen
operator|==
operator|-
literal|1
condition|)
block|{
comment|/* special for rectangles that fit in a byte */
name|d
operator|=
name|led
operator||
name|red
expr_stmt|;
for|for
control|(
init|;
name|h
operator|>=
literal|0
condition|;
name|h
operator|--
operator|,
name|ptr
operator|+=
name|BPL
control|)
operator|*
name|ptr
operator|&=
name|d
expr_stmt|;
return|return
literal|0
return|;
block|}
comment|/* normal fill */
for|for
control|(
init|;
name|h
operator|>=
literal|0
condition|;
name|h
operator|--
operator|,
name|ptr
operator|+=
name|BPL
control|)
block|{
specifier|register
name|int
name|x
init|=
name|xlen
decl_stmt|;
specifier|register
name|byte
modifier|*
name|p
init|=
name|ptr
decl_stmt|;
operator|*
name|p
operator|++
operator|&=
name|led
expr_stmt|;
while|while
condition|(
name|x
operator|--
condition|)
operator|*
name|p
operator|++
operator|=
literal|0x00
expr_stmt|;
operator|*
name|p
operator|&=
name|red
expr_stmt|;
block|}
return|return
literal|0
return|;
block|}
end_function

begin_function
name|int
name|pe_copy_mono
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|byte
modifier|*
name|base
parameter_list|,
name|int
name|sourcex
parameter_list|,
name|int
name|raster
parameter_list|,
name|gx_bitmap_id
name|id
parameter_list|,
name|int
name|x
parameter_list|,
name|int
name|y
parameter_list|,
name|int
name|w
parameter_list|,
name|int
name|h
parameter_list|,
name|gx_color_index
name|zero
parameter_list|,
name|gx_color_index
name|one
parameter_list|)
block|{
name|byte
modifier|*
name|line
decl_stmt|;
name|int
name|sleft
decl_stmt|,
name|dleft
decl_stmt|;
name|int
name|mask
decl_stmt|,
name|rmask
decl_stmt|;
name|int
name|invert
decl_stmt|,
name|zmask
decl_stmt|,
name|omask
decl_stmt|;
name|byte
modifier|*
name|dest
decl_stmt|;
name|int
name|offset
decl_stmt|;
define|#
directive|define
name|izero
value|(int)zero
define|#
directive|define
name|ione
value|(int)one
if|if
condition|(
name|ione
operator|==
name|izero
condition|)
comment|/* vacuous case */
return|return
name|pe_fill_rectangle
argument_list|(
name|dev
argument_list|,
name|x
argument_list|,
name|y
argument_list|,
name|w
argument_list|,
name|h
argument_list|,
name|zero
argument_list|)
return|;
comment|/* clip */
if|if
condition|(
operator|(
name|x
operator|>
name|XSIZE
operator|)
operator|||
operator|(
name|y
operator|>
name|YSIZE
operator|)
operator|||
operator|(
operator|(
name|x
operator|+
name|w
operator|)
operator|<
literal|0
operator|)
operator|||
operator|(
operator|(
name|y
operator|+
name|h
operator|)
operator|<
literal|0
operator|)
condition|)
return|return
literal|0
return|;
name|offset
operator|=
name|x
operator|>>
literal|3
expr_stmt|;
name|dest
operator|=
name|pedev
operator|->
name|fbaddr
operator|+
operator|(
name|y
operator|*
name|BPL
operator|)
operator|+
name|offset
expr_stmt|;
name|line
operator|=
name|base
operator|+
operator|(
name|sourcex
operator|>>
literal|3
operator|)
expr_stmt|;
name|sleft
operator|=
literal|8
operator|-
operator|(
name|sourcex
operator|&
literal|7
operator|)
expr_stmt|;
name|dleft
operator|=
literal|8
operator|-
operator|(
name|x
operator|&
literal|7
operator|)
expr_stmt|;
name|mask
operator|=
literal|0xff
operator|>>
operator|(
literal|8
operator|-
name|dleft
operator|)
expr_stmt|;
if|if
condition|(
name|w
operator|<
name|dleft
condition|)
name|mask
operator|-=
name|mask
operator|>>
name|w
expr_stmt|;
else|else
name|rmask
operator|=
literal|0xff00
operator|>>
operator|(
operator|(
name|w
operator|-
name|dleft
operator|)
operator|&
literal|7
operator|)
expr_stmt|;
comment|/* Macros for writing partial bytes. */
comment|/* bits has already been inverted by xor'ing with invert. */
define|#
directive|define
name|write_byte_masked
parameter_list|(
name|ptr
parameter_list|,
name|bits
parameter_list|,
name|mask
parameter_list|)
define|\
value|*ptr = ((bits | ~mask | zmask)& *ptr | (bits& mask& omask))
define|#
directive|define
name|write_byte
parameter_list|(
name|ptr
parameter_list|,
name|bits
parameter_list|)
define|\
value|*ptr = ((bits | zmask)& *ptr | (bits& omask))
comment|/*	if ( dev->invert ) 	{ 		if ( izero != (int)gx_no_color_index ) zero ^= 1; 		if ( ione != (int)gx_no_color_index ) one ^= 1; 	} */
name|invert
operator|=
operator|(
name|izero
operator|==
literal|1
operator|||
name|ione
operator|==
literal|0
condition|?
operator|-
literal|1
else|:
literal|0
operator|)
expr_stmt|;
name|zmask
operator|=
operator|(
name|izero
operator|==
literal|0
operator|||
name|ione
operator|==
literal|0
condition|?
literal|0
else|:
operator|-
literal|1
operator|)
expr_stmt|;
name|omask
operator|=
operator|(
name|izero
operator|==
literal|1
operator|||
name|ione
operator|==
literal|1
condition|?
operator|-
literal|1
else|:
literal|0
operator|)
expr_stmt|;
undef|#
directive|undef
name|izero
undef|#
directive|undef
name|ione
if|if
condition|(
name|sleft
operator|==
name|dleft
condition|)
comment|/* optimize the aligned case */
block|{
name|w
operator|-=
name|dleft
expr_stmt|;
while|while
condition|(
operator|--
name|h
operator|>=
literal|0
condition|)
block|{
specifier|register
name|byte
modifier|*
name|bptr
init|=
name|line
decl_stmt|;
name|int
name|count
init|=
name|w
decl_stmt|;
specifier|register
name|byte
modifier|*
name|optr
init|=
name|dest
decl_stmt|;
specifier|register
name|int
name|bits
init|=
operator|*
name|bptr
operator|^
name|invert
decl_stmt|;
comment|/* first partial byte */
name|write_byte_masked
argument_list|(
name|optr
argument_list|,
name|bits
argument_list|,
name|mask
argument_list|)
expr_stmt|;
comment|/* Do full bytes. */
while|while
condition|(
operator|(
name|count
operator|-=
literal|8
operator|)
operator|>=
literal|0
condition|)
block|{
name|bits
operator|=
operator|*
operator|++
name|bptr
operator|^
name|invert
expr_stmt|;
operator|++
name|optr
expr_stmt|;
name|write_byte
argument_list|(
name|optr
argument_list|,
name|bits
argument_list|)
expr_stmt|;
block|}
comment|/* Do last byte */
if|if
condition|(
name|count
operator|>
operator|-
literal|8
condition|)
block|{
name|bits
operator|=
operator|*
operator|++
name|bptr
operator|^
name|invert
expr_stmt|;
operator|++
name|optr
expr_stmt|;
name|write_byte_masked
argument_list|(
name|optr
argument_list|,
name|bits
argument_list|,
name|rmask
argument_list|)
expr_stmt|;
block|}
name|dest
operator|+=
name|BPL
expr_stmt|;
name|line
operator|+=
name|raster
expr_stmt|;
block|}
block|}
else|else
block|{
name|int
name|skew
init|=
operator|(
name|sleft
operator|-
name|dleft
operator|)
operator|&
literal|7
decl_stmt|;
name|int
name|cskew
init|=
literal|8
operator|-
name|skew
decl_stmt|;
while|while
condition|(
operator|--
name|h
operator|>=
literal|0
condition|)
block|{
name|byte
modifier|*
name|bptr
init|=
name|line
decl_stmt|;
name|int
name|count
init|=
name|w
decl_stmt|;
name|byte
modifier|*
name|optr
init|=
name|dest
decl_stmt|;
specifier|register
name|int
name|bits
decl_stmt|;
comment|/* Do the first partial byte */
if|if
condition|(
name|sleft
operator|>=
name|dleft
condition|)
block|{
name|bits
operator|=
operator|*
name|bptr
operator|>>
name|skew
expr_stmt|;
block|}
else|else
comment|/* ( sleft< dleft ) */
block|{
name|bits
operator|=
operator|*
name|bptr
operator|++
operator|<<
name|cskew
expr_stmt|;
if|if
condition|(
name|count
operator|>
name|sleft
condition|)
name|bits
operator|+=
operator|*
name|bptr
operator|>>
name|skew
expr_stmt|;
block|}
name|bits
operator|^=
name|invert
expr_stmt|;
name|write_byte_masked
argument_list|(
name|optr
argument_list|,
name|bits
argument_list|,
name|mask
argument_list|)
expr_stmt|;
name|count
operator|-=
name|dleft
expr_stmt|;
name|optr
operator|++
expr_stmt|;
comment|/* Do full bytes. */
while|while
condition|(
name|count
operator|>=
literal|8
condition|)
block|{
name|bits
operator|=
operator|*
name|bptr
operator|++
operator|<<
name|cskew
expr_stmt|;
name|bits
operator|+=
operator|*
name|bptr
operator|>>
name|skew
expr_stmt|;
name|bits
operator|^=
name|invert
expr_stmt|;
name|write_byte
argument_list|(
name|optr
argument_list|,
name|bits
argument_list|)
expr_stmt|;
name|count
operator|-=
literal|8
expr_stmt|;
name|optr
operator|++
expr_stmt|;
block|}
comment|/* Do last byte */
if|if
condition|(
name|count
operator|>
literal|0
condition|)
block|{
name|bits
operator|=
operator|*
name|bptr
operator|++
operator|<<
name|cskew
expr_stmt|;
if|if
condition|(
name|count
operator|>
name|skew
condition|)
name|bits
operator|+=
operator|*
name|bptr
operator|>>
name|skew
expr_stmt|;
name|bits
operator|^=
name|invert
expr_stmt|;
name|write_byte_masked
argument_list|(
name|optr
argument_list|,
name|bits
argument_list|,
name|rmask
argument_list|)
expr_stmt|;
block|}
name|dest
operator|+=
name|BPL
expr_stmt|;
name|line
operator|+=
name|raster
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


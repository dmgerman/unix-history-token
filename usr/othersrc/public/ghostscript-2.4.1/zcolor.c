begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1990, 1991 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* zcolor.c */
end_comment

begin_comment
comment|/* Color operators for Ghostscript */
end_comment

begin_include
include|#
directive|include
file|"ghost.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"oper.h"
end_include

begin_include
include|#
directive|include
file|"alloc.h"
end_include

begin_include
include|#
directive|include
file|"estack.h"
end_include

begin_include
include|#
directive|include
file|"iutil.h"
end_include

begin_include
include|#
directive|include
file|"store.h"
end_include

begin_include
include|#
directive|include
file|"gxfixed.h"
end_include

begin_include
include|#
directive|include
file|"gxmatrix.h"
end_include

begin_include
include|#
directive|include
file|"gzstate.h"
end_include

begin_include
include|#
directive|include
file|"gxdevice.h"
end_include

begin_comment
comment|/* for gzcolor.h */
end_comment

begin_include
include|#
directive|include
file|"gzcolor.h"
end_include

begin_include
include|#
directive|include
file|"state.h"
end_include

begin_comment
comment|/* Import the 'for' operator */
end_comment

begin_decl_stmt
specifier|extern
name|int
name|zfor
argument_list|(
name|P1
argument_list|(
name|os_ptr
argument_list|)
argument_list|)
decl_stmt|,
name|i_zfor
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Define the number of estack slots needed for remap_one. */
end_comment

begin_define
define|#
directive|define
name|remap_one_estack
value|3
end_define

begin_comment
comment|/* Forward declarations */
end_comment

begin_decl_stmt
name|private
name|void
name|tri_put
argument_list|(
name|P2
argument_list|(
name|os_ptr
argument_list|,
name|float
index|[
literal|3
index|]
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|remap_one
argument_list|(
name|P3
argument_list|(
name|ref
operator|*
argument_list|,
name|os_ptr
argument_list|,
name|gx_transfer_map
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|remap_one_finish
argument_list|(
name|P1
argument_list|(
name|os_ptr
argument_list|)
argument_list|)
decl_stmt|,
name|i_remap_one_finish
decl_stmt|,
name|remap_color
argument_list|(
name|P1
argument_list|(
name|os_ptr
argument_list|)
argument_list|)
decl_stmt|,
name|i_remap_color
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Transfer functions for the library layer. */
end_comment

begin_comment
comment|/* These just return what's already in the map. */
end_comment

begin_define
define|#
directive|define
name|tr_map
parameter_list|(
name|pgs
parameter_list|,
name|v
parameter_list|,
name|c
parameter_list|)
define|\
value|(pgs->transfer->c.values[(int)((v) * transfer_map_size + 0.5)] / max_color_param_float)
end_define

begin_function
name|private
name|float
name|transfer_red
parameter_list|(
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|value
parameter_list|)
block|{
return|return
name|tr_map
argument_list|(
name|pgs
argument_list|,
name|value
argument_list|,
name|red
argument_list|)
return|;
block|}
end_function

begin_function
name|private
name|float
name|transfer_green
parameter_list|(
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|value
parameter_list|)
block|{
return|return
name|tr_map
argument_list|(
name|pgs
argument_list|,
name|value
argument_list|,
name|green
argument_list|)
return|;
block|}
end_function

begin_function
name|private
name|float
name|transfer_blue
parameter_list|(
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|value
parameter_list|)
block|{
return|return
name|tr_map
argument_list|(
name|pgs
argument_list|,
name|value
argument_list|,
name|blue
argument_list|)
return|;
block|}
end_function

begin_function
name|private
name|float
name|transfer_gray
parameter_list|(
name|gs_state
modifier|*
name|pgs
parameter_list|,
name|floatp
name|value
parameter_list|)
block|{
return|return
name|tr_map
argument_list|(
name|pgs
argument_list|,
name|value
argument_list|,
name|gray
argument_list|)
return|;
block|}
end_function

begin_undef
undef|#
directive|undef
name|tr_map
end_undef

begin_comment
comment|/* currentcolortransfer */
end_comment

begin_function
name|int
name|zcurrentcolortransfer
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|op
index|[
operator|-
literal|3
index|]
operator|=
name|istate
operator|.
name|transfer_procs
operator|.
name|red
expr_stmt|;
name|op
index|[
operator|-
literal|2
index|]
operator|=
name|istate
operator|.
name|transfer_procs
operator|.
name|green
expr_stmt|;
name|op
index|[
operator|-
literal|1
index|]
operator|=
name|istate
operator|.
name|transfer_procs
operator|.
name|blue
expr_stmt|;
operator|*
name|op
operator|=
name|istate
operator|.
name|transfer_procs
operator|.
name|gray
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* currentgray */
end_comment

begin_function
name|int
name|zcurrentgray
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
argument_list|,
name|gs_currentgray
argument_list|(
name|igs
argument_list|)
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* currenthsbcolor */
end_comment

begin_function
name|int
name|zcurrenthsbcolor
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|float
name|par
index|[
literal|3
index|]
decl_stmt|;
name|gs_currenthsbcolor
argument_list|(
name|igs
argument_list|,
name|par
argument_list|)
expr_stmt|;
name|push
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|tri_put
argument_list|(
name|op
argument_list|,
name|par
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* currentrgbcolor */
end_comment

begin_function
name|int
name|zcurrentrgbcolor
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|float
name|par
index|[
literal|3
index|]
decl_stmt|;
name|gs_currentrgbcolor
argument_list|(
name|igs
argument_list|,
name|par
argument_list|)
expr_stmt|;
name|push
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|tri_put
argument_list|(
name|op
argument_list|,
name|par
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* currenttransfer */
end_comment

begin_function
name|int
name|zcurrenttransfer
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
operator|*
name|op
operator|=
name|istate
operator|.
name|transfer_procs
operator|.
name|gray
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setcolortransfer */
end_comment

begin_function
name|int
name|zsetcolortransfer
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|check_proc
argument_list|(
name|op
index|[
operator|-
literal|3
index|]
argument_list|)
expr_stmt|;
name|check_proc
argument_list|(
name|op
index|[
operator|-
literal|2
index|]
argument_list|)
expr_stmt|;
name|check_proc
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
argument_list|)
expr_stmt|;
name|check_proc
argument_list|(
operator|*
name|op
argument_list|)
expr_stmt|;
name|istate
operator|.
name|transfer_procs
operator|.
name|red
operator|=
name|op
index|[
operator|-
literal|3
index|]
expr_stmt|;
name|istate
operator|.
name|transfer_procs
operator|.
name|green
operator|=
name|op
index|[
operator|-
literal|2
index|]
expr_stmt|;
name|istate
operator|.
name|transfer_procs
operator|.
name|blue
operator|=
name|op
index|[
operator|-
literal|1
index|]
expr_stmt|;
name|istate
operator|.
name|transfer_procs
operator|.
name|gray
operator|=
operator|*
name|op
expr_stmt|;
name|pop
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|op
operator|-=
literal|4
expr_stmt|;
name|check_estack
argument_list|(
literal|1
operator|+
name|remap_one_estack
operator|*
literal|4
argument_list|)
expr_stmt|;
name|push_op_estack
argument_list|(
name|remap_color
argument_list|,
name|i_remap_color
argument_list|)
expr_stmt|;
operator|(
name|code
operator|=
name|gs_setcolortransfer_remap
argument_list|(
name|igs
argument_list|,
name|transfer_red
argument_list|,
name|transfer_green
argument_list|,
name|transfer_blue
argument_list|,
name|transfer_gray
argument_list|,
literal|0
argument_list|)
operator|)
operator|<
literal|0
operator|||
comment|/* Use osp rather than op here, because remap_one pushes. */
operator|(
name|code
operator|=
name|remap_one
argument_list|(
operator|&
name|istate
operator|.
name|transfer_procs
operator|.
name|red
argument_list|,
name|osp
argument_list|,
operator|&
name|igs
operator|->
name|transfer
operator|->
name|red
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|remap_one
argument_list|(
operator|&
name|istate
operator|.
name|transfer_procs
operator|.
name|green
argument_list|,
name|osp
argument_list|,
operator|&
name|igs
operator|->
name|transfer
operator|->
name|green
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|remap_one
argument_list|(
operator|&
name|istate
operator|.
name|transfer_procs
operator|.
name|blue
argument_list|,
name|osp
argument_list|,
operator|&
name|igs
operator|->
name|transfer
operator|->
name|blue
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|remap_one
argument_list|(
operator|&
name|istate
operator|.
name|transfer_procs
operator|.
name|gray
argument_list|,
name|osp
argument_list|,
operator|&
name|igs
operator|->
name|transfer
operator|->
name|gray
argument_list|)
operator|)
operator|<
literal|0
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* setgray */
end_comment

begin_function
name|int
name|zsetgray
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|float
name|gray
decl_stmt|;
name|int
name|code
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|real_param
argument_list|(
name|op
argument_list|,
operator|&
name|gray
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|gs_setgray
argument_list|(
name|igs
argument_list|,
name|gray
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* sethsbcolor */
end_comment

begin_function
name|int
name|zsethsbcolor
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|float
name|par
index|[
literal|3
index|]
decl_stmt|;
name|int
name|code
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|num_params
argument_list|(
name|op
argument_list|,
literal|3
argument_list|,
name|par
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|gs_sethsbcolor
argument_list|(
name|igs
argument_list|,
name|par
index|[
literal|0
index|]
argument_list|,
name|par
index|[
literal|1
index|]
argument_list|,
name|par
index|[
literal|2
index|]
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|pop
argument_list|(
literal|3
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setrgbcolor */
end_comment

begin_function
name|int
name|zsetrgbcolor
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|float
name|par
index|[
literal|3
index|]
decl_stmt|;
name|int
name|code
decl_stmt|;
if|if
condition|(
operator|(
name|code
operator|=
name|num_params
argument_list|(
name|op
argument_list|,
literal|3
argument_list|,
name|par
argument_list|)
operator|)
operator|<
literal|0
operator|||
operator|(
name|code
operator|=
name|gs_setrgbcolor
argument_list|(
name|igs
argument_list|,
name|par
index|[
literal|0
index|]
argument_list|,
name|par
index|[
literal|1
index|]
argument_list|,
name|par
index|[
literal|2
index|]
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|pop
argument_list|(
literal|3
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* settransfer */
end_comment

begin_function
name|int
name|zsettransfer
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|check_proc
argument_list|(
operator|*
name|op
argument_list|)
expr_stmt|;
name|istate
operator|.
name|transfer_procs
operator|.
name|red
operator|=
name|istate
operator|.
name|transfer_procs
operator|.
name|green
operator|=
name|istate
operator|.
name|transfer_procs
operator|.
name|blue
operator|=
name|istate
operator|.
name|transfer_procs
operator|.
name|gray
operator|=
operator|*
name|op
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|op
operator|--
expr_stmt|;
name|check_estack
argument_list|(
literal|1
operator|+
name|remap_one_estack
argument_list|)
expr_stmt|;
name|code
operator|=
name|gs_settransfer_remap
argument_list|(
name|igs
argument_list|,
name|transfer_gray
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|push_op_estack
argument_list|(
name|remap_color
argument_list|,
name|i_remap_color
argument_list|)
expr_stmt|;
return|return
name|remap_one
argument_list|(
operator|&
name|istate
operator|.
name|transfer_procs
operator|.
name|gray
argument_list|,
name|op
argument_list|,
operator|&
name|igs
operator|->
name|transfer
operator|->
name|gray
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ------ Internal routines ------ */
end_comment

begin_comment
comment|/* Put 3 reals on the operand stack. */
end_comment

begin_function
name|private
name|void
name|tri_put
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|,
name|float
name|pf3
index|[
literal|3
index|]
parameter_list|)
block|{
name|make_real
argument_list|(
name|op
operator|-
literal|2
argument_list|,
name|pf3
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|pf3
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
argument_list|,
name|pf3
index|[
literal|2
index|]
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* Prepare to remap one color component. */
end_comment

begin_comment
comment|/* Use the 'for' operator to gather the values. */
end_comment

begin_comment
comment|/* The caller must have done the necessary check_estack. */
end_comment

begin_function
name|private
name|int
name|remap_one
parameter_list|(
name|ref
modifier|*
name|pproc
parameter_list|,
specifier|register
name|os_ptr
name|op
parameter_list|,
name|gx_transfer_map
modifier|*
name|pmap
parameter_list|)
block|{
name|push
argument_list|(
literal|4
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
operator|-
literal|3
argument_list|,
literal|1.0
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
operator|-
literal|2
argument_list|,
operator|-
literal|0.999999
operator|/
operator|(
name|transfer_map_size
operator|-
literal|1
operator|)
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
operator|-
literal|1
argument_list|,
literal|0.0
argument_list|)
expr_stmt|;
operator|*
name|op
operator|=
operator|*
name|pproc
expr_stmt|;
operator|++
name|esp
expr_stmt|;
name|make_tasv
argument_list|(
name|esp
argument_list|,
name|t_string
argument_list|,
literal|0
argument_list|,
sizeof|sizeof
argument_list|(
operator|*
name|pmap
argument_list|)
argument_list|,
name|bytes
argument_list|,
operator|(
name|byte
operator|*
operator|)
name|pmap
argument_list|)
expr_stmt|;
name|push_op_estack
argument_list|(
name|remap_one_finish
argument_list|,
name|i_remap_one_finish
argument_list|)
expr_stmt|;
name|push_op_estack
argument_list|(
name|zfor
argument_list|,
name|i_zfor
argument_list|)
expr_stmt|;
return|return
name|o_push_estack
return|;
block|}
end_function

begin_comment
comment|/* Store the result of remapping a component. */
end_comment

begin_function
name|private
name|int
name|remap_one_finish
parameter_list|(
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|i
decl_stmt|;
name|gx_transfer_map
modifier|*
name|pmap
init|=
operator|(
name|gx_transfer_map
operator|*
operator|)
name|esp
operator|->
name|value
operator|.
name|bytes
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|transfer_map_size
condition|;
name|i
operator|++
control|)
block|{
name|float
name|v
decl_stmt|;
name|int
name|code
init|=
name|real_param
argument_list|(
name|op
operator|-
name|i
argument_list|,
operator|&
name|v
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
literal|0
return|;
name|pmap
operator|->
name|values
index|[
name|i
index|]
operator|=
name|gx_color_unit_param
argument_list|(
name|v
argument_list|)
expr_stmt|;
block|}
name|pop
argument_list|(
name|transfer_map_size
argument_list|)
expr_stmt|;
name|esp
operator|--
expr_stmt|;
comment|/* pop pointer to transfer map */
return|return
name|o_pop_estack
return|;
block|}
end_function

begin_comment
comment|/* Finally, remap the current color. */
end_comment

begin_function
name|private
name|int
name|remap_color
parameter_list|(
name|os_ptr
name|op
parameter_list|)
block|{
comment|/* If we just did settransfer, as opposed to setcolortransfer, */
comment|/* we need to copy the gray map to the r/g/b maps. */
name|gx_transfer
modifier|*
name|ptran
init|=
name|igs
operator|->
name|transfer
decl_stmt|;
if|if
condition|(
name|ptran
operator|->
name|red
operator|.
name|proc
operator|==
name|ptran
operator|->
name|gray
operator|.
name|proc
operator|&&
name|ptran
operator|->
name|green
operator|.
name|proc
operator|==
name|ptran
operator|->
name|gray
operator|.
name|proc
operator|&&
name|ptran
operator|->
name|blue
operator|.
name|proc
operator|==
name|ptran
operator|->
name|gray
operator|.
name|proc
condition|)
block|{
name|ptran
operator|->
name|red
operator|=
name|ptran
operator|->
name|gray
expr_stmt|;
name|ptran
operator|->
name|green
operator|=
name|ptran
operator|->
name|gray
expr_stmt|;
name|ptran
operator|->
name|blue
operator|=
name|ptran
operator|->
name|gray
expr_stmt|;
block|}
return|return
name|gx_remap_color
argument_list|(
name|igs
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ------ Initialization procedure ------ */
end_comment

begin_decl_stmt
name|op_def
name|zcolor_op_defs
index|[]
init|=
block|{
block|{
literal|"0currentcolortransfer"
block|,
name|zcurrentcolortransfer
block|}
block|,
block|{
literal|"0currentgray"
block|,
name|zcurrentgray
block|}
block|,
block|{
literal|"0currenthsbcolor"
block|,
name|zcurrenthsbcolor
block|}
block|,
block|{
literal|"0currentrgbcolor"
block|,
name|zcurrentrgbcolor
block|}
block|,
block|{
literal|"0currenttransfer"
block|,
name|zcurrenttransfer
block|}
block|,
block|{
literal|"4setcolortransfer"
block|,
name|zsetcolortransfer
block|}
block|,
block|{
literal|"1setgray"
block|,
name|zsetgray
block|}
block|,
block|{
literal|"3sethsbcolor"
block|,
name|zsethsbcolor
block|}
block|,
block|{
literal|"3setrgbcolor"
block|,
name|zsetrgbcolor
block|}
block|,
block|{
literal|"1settransfer"
block|,
name|zsettransfer
block|}
block|,
comment|/* Internal operators */
block|{
literal|"1%remap_one_finish"
block|,
name|remap_one_finish
block|,
operator|&
name|i_remap_one_finish
block|}
block|,
block|{
literal|"0%remap_color"
block|,
name|remap_color
block|,
operator|&
name|i_remap_color
block|}
block|,
name|op_def_end
argument_list|(
literal|0
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

end_unit


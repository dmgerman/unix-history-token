begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1991 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* zht.c */
end_comment

begin_comment
comment|/* Halftone operators and rendering for Ghostscript */
end_comment

begin_include
include|#
directive|include
file|"ghost.h"
end_include

begin_include
include|#
directive|include
file|"memory_.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"oper.h"
end_include

begin_include
include|#
directive|include
file|"alloc.h"
end_include

begin_include
include|#
directive|include
file|"estack.h"
end_include

begin_include
include|#
directive|include
file|"gsmatrix.h"
end_include

begin_include
include|#
directive|include
file|"gsstate.h"
end_include

begin_include
include|#
directive|include
file|"state.h"
end_include

begin_include
include|#
directive|include
file|"store.h"
end_include

begin_comment
comment|/* Forward references */
end_comment

begin_decl_stmt
name|private
name|int
name|screen_sample
argument_list|(
name|P1
argument_list|(
name|os_ptr
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|set_screen_continue
argument_list|(
name|P1
argument_list|(
name|os_ptr
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|i_set_screen_continue
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* currenthalftonephase */
end_comment

begin_function
name|int
name|zcurrenthalftonephase
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gs_int_point
name|phase
decl_stmt|;
name|gs_currenthalftonephase
argument_list|(
name|igs
argument_list|,
operator|&
name|phase
argument_list|)
expr_stmt|;
name|push
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|make_int
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|phase
operator|.
name|x
argument_list|)
expr_stmt|;
name|make_int
argument_list|(
name|op
argument_list|,
name|phase
operator|.
name|y
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* currentscreen */
end_comment

begin_function
name|int
name|zcurrentscreen
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|float
name|freq
decl_stmt|,
name|angle
decl_stmt|;
name|float
argument_list|(
operator|*
name|proc
argument_list|)
argument_list|(
name|P2
argument_list|(
name|floatp
argument_list|,
name|floatp
argument_list|)
argument_list|)
expr_stmt|;
name|gs_currentscreen
argument_list|(
name|igs
argument_list|,
operator|&
name|freq
argument_list|,
operator|&
name|angle
argument_list|,
operator|&
name|proc
argument_list|)
expr_stmt|;
name|push
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
operator|-
literal|2
argument_list|,
name|freq
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|angle
argument_list|)
expr_stmt|;
operator|*
name|op
operator|=
name|istate
operator|.
name|screen_proc
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* sethalftonephase */
end_comment

begin_function
name|int
name|zsethalftonephase
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|long
name|x
decl_stmt|,
name|y
decl_stmt|;
name|check_type
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
name|x
operator|=
name|op
index|[
operator|-
literal|1
index|]
operator|.
name|value
operator|.
name|intval
expr_stmt|;
name|y
operator|=
name|op
operator|->
name|value
operator|.
name|intval
expr_stmt|;
if|if
condition|(
name|x
operator|!=
operator|(
name|int
operator|)
name|x
operator|||
name|y
operator|!=
operator|(
name|int
operator|)
name|y
condition|)
return|return
name|e_rangecheck
return|;
name|code
operator|=
name|gs_sethalftonephase
argument_list|(
name|igs
argument_list|,
operator|(
name|int
operator|)
name|x
argument_list|,
operator|(
name|int
operator|)
name|y
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|>=
literal|0
condition|)
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* The setscreen operator is complex because it has to sample */
end_comment

begin_comment
comment|/* each pixel in the pattern cell, calling a procedure, and then */
end_comment

begin_comment
comment|/* sort the result into a whitening order. */
end_comment

begin_comment
comment|/* Layout of stuff pushed on estack: */
end_comment

begin_comment
comment|/*	Control mark, */
end_comment

begin_comment
comment|/*	spot procedure, */
end_comment

begin_comment
comment|/*	enumeration structure (as bytes). */
end_comment

begin_define
define|#
directive|define
name|snumpush
value|3
end_define

begin_define
define|#
directive|define
name|sproc
value|esp[-1]
end_define

begin_define
define|#
directive|define
name|senum
value|(gs_screen_enum *)esp->value.bytes
end_define

begin_comment
comment|/* setscreen */
end_comment

begin_function
name|int
name|zsetscreen
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|float
name|fa
index|[
literal|2
index|]
decl_stmt|;
name|int
name|code
init|=
name|num_params
argument_list|(
name|op
operator|-
literal|1
argument_list|,
literal|2
argument_list|,
name|fa
argument_list|)
decl_stmt|;
name|gs_screen_enum
modifier|*
name|penum
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|check_proc
argument_list|(
operator|*
name|op
argument_list|)
expr_stmt|;
name|penum
operator|=
operator|(
name|gs_screen_enum
operator|*
operator|)
name|alloc
argument_list|(
literal|1
argument_list|,
name|gs_screen_enum_sizeof
argument_list|,
literal|"setscreen"
argument_list|)
expr_stmt|;
if|if
condition|(
name|penum
operator|==
literal|0
condition|)
return|return
name|e_VMerror
return|;
name|code
operator|=
name|gs_screen_init
argument_list|(
name|penum
argument_list|,
name|igs
argument_list|,
name|fa
index|[
literal|0
index|]
argument_list|,
name|fa
index|[
literal|1
index|]
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
block|{
name|alloc_free
argument_list|(
operator|(
name|char
operator|*
operator|)
name|penum
argument_list|,
literal|1
argument_list|,
name|gs_screen_enum_sizeof
argument_list|,
literal|"setscreen"
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
comment|/* Push everything on the estack */
name|check_estack
argument_list|(
name|snumpush
argument_list|)
expr_stmt|;
name|mark_estack
argument_list|(
name|es_other
argument_list|)
expr_stmt|;
operator|*
operator|++
name|esp
operator|=
operator|*
name|op
expr_stmt|;
comment|/* sproc = proc */
operator|++
name|esp
expr_stmt|;
name|make_tasv
argument_list|(
name|esp
argument_list|,
name|t_string
argument_list|,
literal|0
argument_list|,
name|gs_screen_enum_sizeof
argument_list|,
name|bytes
argument_list|,
operator|(
name|byte
operator|*
operator|)
name|penum
argument_list|)
expr_stmt|;
name|pop
argument_list|(
literal|3
argument_list|)
expr_stmt|;
name|op
operator|-=
literal|3
expr_stmt|;
return|return
name|screen_sample
argument_list|(
name|op
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Set up the next sample */
end_comment

begin_function
name|private
name|int
name|screen_sample
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gs_screen_enum
modifier|*
name|penum
init|=
name|senum
decl_stmt|;
name|gs_point
name|pt
decl_stmt|;
name|int
name|code
init|=
name|gs_screen_currentpoint
argument_list|(
name|penum
argument_list|,
operator|&
name|pt
argument_list|)
decl_stmt|;
name|ref
name|proc
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
if|if
condition|(
name|code
operator|!=
literal|0
condition|)
block|{
comment|/* All done */
name|istate
operator|.
name|screen_proc
operator|=
name|sproc
expr_stmt|;
name|esp
operator|-=
name|snumpush
expr_stmt|;
return|return
name|o_pop_estack
return|;
block|}
name|push
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
operator|-
literal|1
argument_list|,
name|pt
operator|.
name|x
argument_list|)
expr_stmt|;
name|make_real
argument_list|(
name|op
argument_list|,
name|pt
operator|.
name|y
argument_list|)
expr_stmt|;
name|proc
operator|=
name|sproc
expr_stmt|;
name|push_op_estack
argument_list|(
name|set_screen_continue
argument_list|,
name|i_set_screen_continue
argument_list|)
expr_stmt|;
operator|*
operator|++
name|esp
operator|=
name|proc
expr_stmt|;
return|return
name|o_push_estack
return|;
block|}
end_function

begin_decl_stmt
specifier|static
name|int
name|count_cont
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Continuation procedure for processing sampled pixels. */
end_comment

begin_function
name|private
name|int
name|set_screen_continue
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|float
name|value
decl_stmt|;
name|int
name|code
init|=
name|num_params
argument_list|(
name|op
argument_list|,
literal|1
argument_list|,
operator|&
name|value
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|code
operator|=
name|gs_screen_next
argument_list|(
name|senum
argument_list|,
name|value
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|op
operator|--
expr_stmt|;
return|return
name|screen_sample
argument_list|(
name|op
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ------ Initialization procedure ------ */
end_comment

begin_decl_stmt
name|op_def
name|zht_op_defs
index|[]
init|=
block|{
block|{
literal|"0currenthalftonephase"
block|,
name|zcurrenthalftonephase
block|}
block|,
block|{
literal|"0currentscreen"
block|,
name|zcurrentscreen
block|}
block|,
block|{
literal|"2sethalftonephase"
block|,
name|zsethalftonephase
block|}
block|,
block|{
literal|"3setscreen"
block|,
name|zsetscreen
block|}
block|,
comment|/* Internal operators */
block|{
literal|"1%set_screen_continue"
block|,
name|set_screen_continue
block|,
operator|&
name|i_set_screen_continue
block|}
block|,
name|op_def_end
argument_list|(
literal|0
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

end_unit


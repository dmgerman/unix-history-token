begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1992 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* gdevpccm.c */
end_comment

begin_comment
comment|/* Support routines for PC color mapping */
end_comment

begin_include
include|#
directive|include
file|"gs.h"
end_include

begin_include
include|#
directive|include
file|"gsmatrix.h"
end_include

begin_comment
comment|/* for gxdevice.h */
end_comment

begin_include
include|#
directive|include
file|"gxdevice.h"
end_include

begin_include
include|#
directive|include
file|"gdevpccm.h"
end_include

begin_comment
comment|/* interface */
end_comment

begin_comment
comment|/* Color mapping routines for EGA/VGA-style color. */
end_comment

begin_comment
comment|/* Colors are 4 bits: 8=intensity, 4=R, 2=G, 1=B. */
end_comment

begin_define
define|#
directive|define
name|black
value|0
end_define

begin_define
define|#
directive|define
name|blue
value|1
end_define

begin_define
define|#
directive|define
name|green
value|2
end_define

begin_define
define|#
directive|define
name|cyan
value|3
end_define

begin_define
define|#
directive|define
name|red
value|4
end_define

begin_define
define|#
directive|define
name|magenta
value|5
end_define

begin_define
define|#
directive|define
name|brown
value|6
end_define

begin_define
define|#
directive|define
name|white
value|7
end_define

begin_define
define|#
directive|define
name|dgray
value|8
end_define

begin_comment
comment|/* dark gray is not very usable */
end_comment

begin_define
define|#
directive|define
name|lblue
value|9
end_define

begin_define
define|#
directive|define
name|lgreen
value|10
end_define

begin_define
define|#
directive|define
name|lcyan
value|11
end_define

begin_define
define|#
directive|define
name|lred
value|12
end_define

begin_define
define|#
directive|define
name|lmagenta
value|13
end_define

begin_define
define|#
directive|define
name|yellow
value|14
end_define

begin_define
define|#
directive|define
name|bwhite
value|15
end_define

begin_function
name|gx_color_index
name|pc_4bit_map_rgb_color
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|gx_color_value
name|r
parameter_list|,
name|gx_color_value
name|g
parameter_list|,
name|gx_color_value
name|b
parameter_list|)
block|{
define|#
directive|define
name|c13
value|(gx_max_color_value / 3)
define|#
directive|define
name|c23
value|(gx_max_color_value - c13)
specifier|static
name|byte
name|g0
index|[
literal|3
index|]
index|[
literal|3
index|]
init|=
block|{
block|{
name|black
block|,
name|blue
block|,
name|lblue
block|}
block|,
block|{
name|red
block|,
name|magenta
block|,
name|lmagenta
block|}
block|,
block|{
name|lred
block|,
name|lmagenta
block|,
name|lmagenta
block|}
block|}
decl_stmt|;
specifier|static
name|byte
name|g1
index|[
literal|3
index|]
index|[
literal|3
index|]
init|=
block|{
block|{
name|green
block|,
name|cyan
block|,
name|lcyan
block|}
block|,
block|{
name|brown
block|,
name|white
block|,
name|lcyan
block|}
block|,
block|{
name|yellow
block|,
name|yellow
block|,
name|lmagenta
block|}
block|}
decl_stmt|;
specifier|static
name|byte
name|g2
index|[
literal|3
index|]
index|[
literal|3
index|]
init|=
block|{
block|{
name|lgreen
block|,
name|lgreen
block|,
name|lcyan
block|}
block|,
block|{
name|lgreen
block|,
name|lgreen
block|,
name|lcyan
block|}
block|,
block|{
name|yellow
block|,
name|yellow
block|,
name|bwhite
block|}
block|}
decl_stmt|;
return|return
call|(
name|gx_color_index
call|)
argument_list|(
operator|(
name|g
operator|>=
name|c23
condition|?
name|g2
else|:
name|g
operator|>=
name|c13
condition|?
name|g1
else|:
name|g0
operator|)
index|[
name|r
operator|>=
name|c23
condition|?
literal|2
else|:
name|r
operator|>=
name|c13
condition|?
literal|1
else|:
literal|0
index|]
index|[
name|b
operator|>=
name|c23
condition|?
literal|2
else|:
name|b
operator|>=
name|c13
condition|?
literal|1
else|:
literal|0
index|]
argument_list|)
return|;
undef|#
directive|undef
name|c13
undef|#
directive|undef
name|c23
block|}
end_function

begin_function
name|int
name|pc_4bit_map_color_rgb
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|gx_color_index
name|color
parameter_list|,
name|gx_color_value
name|prgb
index|[
literal|3
index|]
parameter_list|)
block|{
define|#
directive|define
name|icolor
value|(int)color
name|gx_color_value
name|one
init|=
operator|(
name|icolor
operator|&
literal|8
condition|?
name|gx_max_color_value
else|:
name|gx_max_color_value
operator|/
literal|3
operator|)
decl_stmt|;
name|prgb
index|[
literal|0
index|]
operator|=
operator|(
name|icolor
operator|&
literal|4
condition|?
name|one
else|:
literal|0
operator|)
expr_stmt|;
name|prgb
index|[
literal|1
index|]
operator|=
operator|(
name|icolor
operator|&
literal|2
condition|?
name|one
else|:
literal|0
operator|)
expr_stmt|;
name|prgb
index|[
literal|2
index|]
operator|=
operator|(
name|icolor
operator|&
literal|1
condition|?
name|one
else|:
literal|0
operator|)
expr_stmt|;
return|return
literal|0
return|;
undef|#
directive|undef
name|icolor
block|}
end_function

begin_comment
comment|/* Color mapping routines for 8-bit color with a fixed palette */
end_comment

begin_comment
comment|/* (3 bits of R, 3 bits of G, 2 bits of B). */
end_comment

begin_function
name|gx_color_index
name|pc_8bit_map_rgb_color
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|gx_color_value
name|r
parameter_list|,
name|gx_color_value
name|g
parameter_list|,
name|gx_color_value
name|b
parameter_list|)
block|{
return|return
call|(
name|gx_color_index
call|)
argument_list|(
operator|(
operator|(
name|r
operator|>>
operator|(
name|gx_color_value_bits
operator|-
literal|3
operator|)
operator|)
operator|<<
literal|5
operator|)
operator|+
operator|(
operator|(
name|g
operator|>>
operator|(
name|gx_color_value_bits
operator|-
literal|3
operator|)
operator|)
operator|<<
literal|2
operator|)
operator|+
operator|(
operator|(
name|b
operator|>>
operator|(
name|gx_color_value_bits
operator|-
literal|2
operator|)
operator|)
operator|)
argument_list|)
return|;
block|}
end_function

begin_function
name|int
name|pc_8bit_map_color_rgb
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|gx_color_index
name|color
parameter_list|,
name|gx_color_value
name|prgb
index|[
literal|3
index|]
parameter_list|)
block|{
define|#
directive|define
name|icolor
value|(uint)color
name|prgb
index|[
literal|0
index|]
operator|=
operator|(
operator|(
name|icolor
operator|>>
literal|5
operator|)
operator|&
literal|7
operator|)
operator|*
operator|(
name|gx_max_color_value
operator|/
literal|7
operator|)
expr_stmt|;
name|prgb
index|[
literal|1
index|]
operator|=
operator|(
operator|(
name|icolor
operator|>>
literal|2
operator|)
operator|&
literal|7
operator|)
operator|*
operator|(
name|gx_max_color_value
operator|/
literal|7
operator|)
expr_stmt|;
name|prgb
index|[
literal|2
index|]
operator|=
operator|(
name|icolor
operator|&
literal|3
operator|)
operator|*
operator|(
name|gx_max_color_value
operator|/
literal|3
operator|)
expr_stmt|;
undef|#
directive|undef
name|icolor
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Write a palette on a file. */
end_comment

begin_function
name|int
name|pc_write_palette
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|uint
name|max_index
parameter_list|,
name|FILE
modifier|*
name|file
parameter_list|)
block|{
name|uint
name|i
decl_stmt|,
name|c
decl_stmt|;
name|gx_color_value
name|rgb
index|[
literal|3
index|]
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
name|max_index
condition|;
name|i
operator|++
control|)
block|{
call|(
modifier|*
name|dev
operator|->
name|procs
operator|->
name|map_color_rgb
call|)
argument_list|(
name|dev
argument_list|,
operator|(
name|gx_color_index
operator|)
name|i
argument_list|,
name|rgb
argument_list|)
expr_stmt|;
for|for
control|(
name|c
operator|=
literal|0
init|;
name|c
operator|<
literal|3
condition|;
name|c
operator|++
control|)
block|{
name|byte
name|b
init|=
name|rgb
index|[
name|c
index|]
operator|>>
operator|(
name|gx_color_value_bits
operator|-
literal|8
operator|)
decl_stmt|;
name|fputc
argument_list|(
name|b
argument_list|,
name|file
argument_list|)
expr_stmt|;
block|}
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


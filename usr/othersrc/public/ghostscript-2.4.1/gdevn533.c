begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1990, 1991 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* gdevn533.c */
end_comment

begin_comment
comment|/* Sony NWP-533 driver for GhostScript */
end_comment

begin_include
include|#
directive|include
file|"gdevprn.h"
end_include

begin_include
include|#
directive|include
file|<sys/file.h>
end_include

begin_include
include|#
directive|include
file|<sys/ioctl.h>
end_include

begin_include
include|#
directive|include
file|<newsiop/lbp.h>
end_include

begin_comment
comment|/* The device descriptor */
end_comment

begin_function_decl
name|private
name|dev_proc_open_device
parameter_list|(
name|nwp533_open
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|private
name|dev_proc_output_page
parameter_list|(
name|nwp533_output_page
parameter_list|)
function_decl|;
end_function_decl

begin_function_decl
name|private
name|dev_proc_close_device
parameter_list|(
name|nwp533_close
parameter_list|)
function_decl|;
end_function_decl

begin_decl_stmt
name|private
name|gx_device_procs
name|nwp533_procs
init|=
name|prn_procs
argument_list|(
name|nwp533_open
argument_list|,
name|nwp533_output_page
argument_list|,
name|nwp533_close
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|gx_device_printer
name|gs_nwp533_device
init|=
name|prn_device
argument_list|(
name|nwp533_procs
argument_list|,
literal|"nwp533"
argument_list|,
literal|78.4
argument_list|,
comment|/* width_10ths */
literal|112.9
argument_list|,
comment|/* height_10ths */
literal|400
argument_list|,
comment|/* x_dpi */
literal|400
argument_list|,
comment|/* y_dpi */
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|,
comment|/* margins */
literal|1
argument_list|,
literal|0
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|int
name|printer_file
init|=
operator|-
literal|1
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* return True if should retry - False if should quit */
end_comment

begin_function
name|private
name|int
name|analyze_error
parameter_list|()
block|{
name|struct
name|lbp_stat
name|status
decl_stmt|;
name|char
name|message
index|[
literal|80
index|]
decl_stmt|;
name|char
modifier|*
name|detail
decl_stmt|,
modifier|*
name|old_detail
decl_stmt|;
name|int
name|waiting
decl_stmt|;
name|int
name|retry_after_return
decl_stmt|;
if|if
condition|(
name|ioctl
argument_list|(
name|printer_file
argument_list|,
name|LBIOCRESET
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|==
literal|1
operator|)
return|;
if|if
condition|(
name|ioctl
argument_list|(
name|printer_file
argument_list|,
name|LBIOCSTATUS
argument_list|,
operator|&
name|status
argument_list|)
operator|<
literal|0
condition|)
return|return
operator|(
literal|0
operator|==
literal|1
operator|)
return|;
name|sprintf
argument_list|(
name|message
argument_list|,
literal|"printer status: 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x 0x%02x"
argument_list|,
name|status
operator|.
name|stat
index|[
literal|0
index|]
argument_list|,
name|status
operator|.
name|stat
index|[
literal|1
index|]
argument_list|,
name|status
operator|.
name|stat
index|[
literal|2
index|]
argument_list|,
name|status
operator|.
name|stat
index|[
literal|3
index|]
argument_list|,
name|status
operator|.
name|stat
index|[
literal|4
index|]
argument_list|,
name|status
operator|.
name|stat
index|[
literal|5
index|]
argument_list|)
expr_stmt|;
name|perror
argument_list|(
name|message
argument_list|)
expr_stmt|;
name|old_detail
operator|=
name|detail
operator|=
name|NULL
expr_stmt|;
name|waiting
operator|=
name|retry_after_return
operator|=
operator|(
literal|1
operator|==
literal|1
operator|)
expr_stmt|;
comment|/* True */
do|do
block|{
if|if
condition|(
name|status
operator|.
name|stat
index|[
literal|0
index|]
operator|&
operator|(
name|ST0_CALL
operator||
name|ST0_REPRINT_REQ
operator||
name|ST0_WAIT
operator||
name|ST0_PAUSE
operator|)
condition|)
block|{
if|if
condition|(
name|status
operator|.
name|stat
index|[
literal|1
index|]
operator|&
name|ST1_NO_CARTRIGE
condition|)
comment|/* mispelled? */
name|detail
operator|=
literal|"No cartridge - waiting"
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|.
name|stat
index|[
literal|1
index|]
operator|&
name|ST1_NO_PAPER
condition|)
name|detail
operator|=
literal|"Out of paper - waiting"
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|.
name|stat
index|[
literal|1
index|]
operator|&
name|ST1_JAM
condition|)
name|detail
operator|=
literal|"Paper jam - waiting"
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|.
name|stat
index|[
literal|1
index|]
operator|&
name|ST1_OPEN
condition|)
name|detail
operator|=
literal|"Door open - waiting"
expr_stmt|;
elseif|else
if|if
condition|(
name|status
operator|.
name|stat
index|[
literal|1
index|]
operator|&
name|ST1_TEST
condition|)
name|detail
operator|=
literal|"Test printing - waiting"
expr_stmt|;
else|else
block|{
name|retry_after_return
operator|=
operator|(
literal|1
operator|==
literal|0
operator|)
expr_stmt|;
name|waiting
operator|=
operator|(
literal|1
operator|==
literal|0
operator|)
expr_stmt|;
name|detail
operator|=
literal|"Please analyze status bytes"
expr_stmt|;
block|}
block|}
else|else
name|waiting
operator|=
operator|(
literal|0
operator|==
literal|1
operator|)
expr_stmt|;
if|if
condition|(
name|detail
operator|!=
name|NULL
operator|&&
name|detail
operator|!=
name|old_detail
condition|)
block|{
name|perror
argument_list|(
name|detail
argument_list|)
expr_stmt|;
name|old_detail
operator|=
name|detail
expr_stmt|;
block|}
if|if
condition|(
name|waiting
condition|)
block|{
name|ioctl
argument_list|(
literal|1
argument_list|,
name|LBIOCRESET
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|sleep
argument_list|(
literal|5
argument_list|)
expr_stmt|;
name|ioctl
argument_list|(
literal|1
argument_list|,
name|LBIOCSTATUS
argument_list|,
operator|&
name|status
argument_list|)
expr_stmt|;
block|}
block|}
do|while
condition|(
name|waiting
condition|)
do|;
return|return
name|retry_after_return
return|;
block|}
end_function

begin_function
name|private
name|int
name|nwp533_open
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"in nwp533 open\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|printer_file
operator|<
literal|0
condition|)
if|if
condition|(
operator|(
name|printer_file
operator|=
name|open
argument_list|(
literal|"/dev/lbp"
argument_list|,
name|O_WRONLY
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|printer_file
return|;
return|return
name|gdev_prn_open
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_function
name|private
name|int
name|nwp533_close
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"in nwp533 close\n"
argument_list|)
expr_stmt|;
if|if
condition|(
name|printer_file
operator|>=
literal|0
condition|)
block|{
name|close
argument_list|(
name|printer_file
argument_list|)
expr_stmt|;
name|printer_file
operator|=
operator|-
literal|1
expr_stmt|;
block|}
return|return
name|gdev_prn_close
argument_list|(
name|dev
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* Send the page to the printer. */
end_comment

begin_function
name|private
name|int
name|nwp533_output_page
parameter_list|(
name|gx_device
modifier|*
name|dev
parameter_list|,
name|int
name|num_copies
parameter_list|,
name|int
name|flush
parameter_list|)
block|{
name|fprintf
argument_list|(
name|stderr
argument_list|,
literal|"in nwp533 output page [%d, %d]\n"
argument_list|,
name|dev
operator|->
name|width
argument_list|,
name|dev
operator|->
name|height
argument_list|)
expr_stmt|;
name|restart
label|:
if|if
condition|(
name|ioctl
argument_list|(
name|printer_file
argument_list|,
name|LBIOCSTOP
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|analyze_error
argument_list|()
condition|)
goto|goto
name|restart
goto|;
name|perror
argument_list|(
literal|"Waiting for device"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|lseek
argument_list|(
name|printer_file
argument_list|,
literal|0
argument_list|,
literal|0
argument_list|)
expr_stmt|;
if|if
condition|(
name|write
argument_list|(
name|printer_file
argument_list|,
name|prn_dev
operator|->
name|mem
operator|.
name|base
argument_list|,
operator|(
name|dev
operator|->
name|width
operator|*
name|dev
operator|->
name|height
operator|)
operator|/
literal|8
argument_list|)
operator|!=
operator|(
name|dev
operator|->
name|width
operator|*
name|dev
operator|->
name|height
operator|)
operator|/
literal|8
condition|)
block|{
name|perror
argument_list|(
literal|"Writting to output"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
name|retry
label|:
if|if
condition|(
name|ioctl
argument_list|(
name|printer_file
argument_list|,
name|LBIOCSTART
argument_list|,
literal|0
argument_list|)
operator|<
literal|0
condition|)
block|{
if|if
condition|(
name|analyze_error
argument_list|()
condition|)
goto|goto
name|retry
goto|;
name|perror
argument_list|(
literal|"Starting print"
argument_list|)
expr_stmt|;
return|return
operator|-
literal|1
return|;
block|}
return|return
literal|0
return|;
block|}
end_function

end_unit


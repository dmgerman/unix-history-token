begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1992 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* zdevice.c */
end_comment

begin_comment
comment|/* Device-related operators for GhostScript */
end_comment

begin_include
include|#
directive|include
file|"ghost.h"
end_include

begin_include
include|#
directive|include
file|"alloc.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"oper.h"
end_include

begin_include
include|#
directive|include
file|"state.h"
end_include

begin_include
include|#
directive|include
file|"gsmatrix.h"
end_include

begin_include
include|#
directive|include
file|"gsstate.h"
end_include

begin_include
include|#
directive|include
file|"gxdevice.h"
end_include

begin_include
include|#
directive|include
file|"store.h"
end_include

begin_comment
comment|/* copy for devices -- called from zcopy in zgeneric.c. */
end_comment

begin_function
name|int
name|zcopy_device
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gx_device
modifier|*
name|new_dev
decl_stmt|;
name|int
name|code
init|=
name|gs_copydevice
argument_list|(
operator|&
name|new_dev
argument_list|,
name|op
operator|->
name|value
operator|.
name|pdevice
argument_list|,
name|alloc
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|make_tv
argument_list|(
name|op
argument_list|,
name|t_device
argument_list|,
name|pdevice
argument_list|,
name|new_dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* copyscanlines */
end_comment

begin_function
name|int
name|zcopyscanlines
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|os_ptr
name|op1
init|=
name|op
operator|-
literal|1
decl_stmt|;
name|os_ptr
name|op2
init|=
name|op
operator|-
literal|2
decl_stmt|;
name|gx_device
modifier|*
name|dev
decl_stmt|;
name|int
name|code
decl_stmt|;
name|uint
name|bytes_copied
decl_stmt|;
name|check_type
argument_list|(
operator|*
name|op2
argument_list|,
name|t_device
argument_list|)
expr_stmt|;
name|dev
operator|=
name|op2
operator|->
name|value
operator|.
name|pdevice
expr_stmt|;
name|check_type
argument_list|(
operator|*
name|op1
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
if|if
condition|(
name|op1
operator|->
name|value
operator|.
name|intval
operator|<
literal|0
operator|||
name|op1
operator|->
name|value
operator|.
name|intval
operator|>
name|dev
operator|->
name|height
condition|)
return|return
name|e_rangecheck
return|;
name|check_write_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_string
argument_list|)
expr_stmt|;
name|code
operator|=
name|gs_copyscanlines
argument_list|(
name|dev
argument_list|,
operator|(
name|int
operator|)
name|op1
operator|->
name|value
operator|.
name|intval
argument_list|,
name|op
operator|->
name|value
operator|.
name|bytes
argument_list|,
name|r_size
argument_list|(
name|op
argument_list|)
argument_list|,
name|NULL
argument_list|,
operator|&
name|bytes_copied
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|e_typecheck
return|;
comment|/* not a memory device */
operator|*
name|op2
operator|=
operator|*
name|op
expr_stmt|;
name|r_set_size
argument_list|(
name|op2
argument_list|,
name|bytes_copied
argument_list|)
expr_stmt|;
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* currentdevice */
end_comment

begin_function
name|int
name|zcurrentdevice
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gx_device
modifier|*
name|dev
init|=
name|gs_currentdevice
argument_list|(
name|igs
argument_list|)
decl_stmt|;
name|push
argument_list|(
literal|1
argument_list|)
expr_stmt|;
name|make_tv
argument_list|(
name|op
argument_list|,
name|t_device
argument_list|,
name|pdevice
argument_list|,
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* devicename */
end_comment

begin_function
name|int
name|zdevicename
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
specifier|const
name|char
modifier|*
name|dname
decl_stmt|;
name|int
name|code
decl_stmt|;
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_device
argument_list|)
expr_stmt|;
name|dname
operator|=
name|gs_devicename
argument_list|(
name|op
operator|->
name|value
operator|.
name|pdevice
argument_list|)
expr_stmt|;
name|code
operator|=
name|string_to_ref
argument_list|(
name|dname
argument_list|,
name|op
argument_list|,
literal|"devicename"
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* deviceinitialmatrix */
end_comment

begin_function
name|int
name|zdeviceinitialmatrix
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
init|=
name|write_matrix
argument_list|(
name|op
argument_list|)
decl_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|check_type
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
argument_list|,
name|t_device
argument_list|)
expr_stmt|;
name|gs_deviceinitialmatrix
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
operator|.
name|value
operator|.
name|pdevice
argument_list|,
operator|(
name|gs_matrix
operator|*
operator|)
name|op
operator|->
name|value
operator|.
name|refs
argument_list|)
expr_stmt|;
name|op
index|[
operator|-
literal|1
index|]
operator|=
operator|*
name|op
expr_stmt|;
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* flushpage */
end_comment

begin_function
name|int
name|zflushpage
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
return|return
name|gs_flushpage
argument_list|(
name|igs
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* getdevice */
end_comment

begin_function
name|int
name|zgetdevice
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gx_device
modifier|*
name|dev
decl_stmt|;
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
if|if
condition|(
name|op
operator|->
name|value
operator|.
name|intval
operator|!=
call|(
name|int
call|)
argument_list|(
name|op
operator|->
name|value
operator|.
name|intval
argument_list|)
condition|)
return|return
name|e_rangecheck
return|;
comment|/* won't fit in an int */
name|dev
operator|=
name|gs_getdevice
argument_list|(
call|(
name|int
call|)
argument_list|(
name|op
operator|->
name|value
operator|.
name|intval
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|dev
operator|==
literal|0
condition|)
return|return
name|e_rangecheck
return|;
comment|/* index out of range */
name|make_tv
argument_list|(
name|op
argument_list|,
name|t_device
argument_list|,
name|pdevice
argument_list|,
name|dev
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* makeimagedevice */
end_comment

begin_function
name|int
name|zmakeimagedevice
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gs_matrix
name|imat
decl_stmt|;
name|gx_device
modifier|*
name|new_dev
decl_stmt|;
name|byte
modifier|*
name|colors
decl_stmt|;
name|int
name|num_colors
decl_stmt|;
name|int
name|code
decl_stmt|;
name|check_type
argument_list|(
name|op
index|[
operator|-
literal|2
index|]
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
comment|/* width */
name|check_type
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
comment|/* height */
if|if
condition|(
name|r_has_type
argument_list|(
name|op
argument_list|,
name|t_null
argument_list|)
condition|)
comment|/* true color */
block|{
name|colors
operator|=
literal|0
expr_stmt|;
name|num_colors
operator|=
operator|-
literal|24
expr_stmt|;
comment|/* 24-bit true color */
block|}
else|else
block|{
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_string
argument_list|)
expr_stmt|;
comment|/* palette */
if|if
condition|(
name|r_size
argument_list|(
name|op
argument_list|)
operator|>
literal|3
operator|*
literal|256
condition|)
return|return
name|e_rangecheck
return|;
name|colors
operator|=
name|op
operator|->
name|value
operator|.
name|bytes
expr_stmt|;
name|num_colors
operator|=
name|r_size
argument_list|(
name|op
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
call|(
name|ulong
call|)
argument_list|(
name|op
index|[
operator|-
literal|2
index|]
operator|.
name|value
operator|.
name|intval
argument_list|)
operator|>
name|max_uint
operator|>>
literal|1
operator|||
call|(
name|ulong
call|)
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
operator|.
name|value
operator|.
name|intval
argument_list|)
operator|>
name|max_uint
operator|>>
literal|1
condition|)
return|return
name|e_rangecheck
return|;
if|if
condition|(
operator|(
name|code
operator|=
name|read_matrix
argument_list|(
name|op
operator|-
literal|3
argument_list|,
operator|&
name|imat
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
comment|/* Everything OK, create device */
name|code
operator|=
name|gs_makeimagedevice
argument_list|(
operator|&
name|new_dev
argument_list|,
operator|&
name|imat
argument_list|,
operator|(
name|int
operator|)
name|op
index|[
operator|-
literal|2
index|]
operator|.
name|value
operator|.
name|intval
argument_list|,
operator|(
name|int
operator|)
name|op
index|[
operator|-
literal|1
index|]
operator|.
name|value
operator|.
name|intval
argument_list|,
name|colors
argument_list|,
name|num_colors
argument_list|,
name|alloc
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
literal|0
condition|)
block|{
name|make_tv
argument_list|(
name|op
operator|-
literal|3
argument_list|,
name|t_device
argument_list|,
name|pdevice
argument_list|,
name|new_dev
argument_list|)
expr_stmt|;
name|pop
argument_list|(
literal|3
argument_list|)
expr_stmt|;
block|}
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* nulldevice */
end_comment

begin_function
name|int
name|znulldevice
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|gs_nulldevice
argument_list|(
name|igs
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* .outputpage */
end_comment

begin_function
name|int
name|zoutputpage
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|check_type
argument_list|(
name|op
index|[
operator|-
literal|1
index|]
argument_list|,
name|t_integer
argument_list|)
expr_stmt|;
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_boolean
argument_list|)
expr_stmt|;
name|code
operator|=
name|gs_output_page
argument_list|(
name|igs
argument_list|,
operator|(
name|int
operator|)
name|op
index|[
operator|-
literal|1
index|]
operator|.
name|value
operator|.
name|intval
argument_list|,
name|op
operator|->
name|value
operator|.
name|index
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|pop
argument_list|(
literal|2
argument_list|)
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* setdevice */
end_comment

begin_function
name|int
name|zsetdevice
parameter_list|(
specifier|register
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_device
argument_list|)
expr_stmt|;
name|code
operator|=
name|gs_setdevice
argument_list|(
name|igs
argument_list|,
name|op
operator|->
name|value
operator|.
name|pdevice
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|==
literal|0
condition|)
name|pop
argument_list|(
literal|1
argument_list|)
expr_stmt|;
return|return
name|code
return|;
block|}
end_function

begin_comment
comment|/* ------ Initialization procedure ------ */
end_comment

begin_decl_stmt
name|op_def
name|zdevice_op_defs
index|[]
init|=
block|{
block|{
literal|"3copyscanlines"
block|,
name|zcopyscanlines
block|}
block|,
block|{
literal|"0currentdevice"
block|,
name|zcurrentdevice
block|}
block|,
block|{
literal|"2deviceinitialmatrix"
block|,
name|zdeviceinitialmatrix
block|}
block|,
block|{
literal|"1devicename"
block|,
name|zdevicename
block|}
block|,
block|{
literal|"0flushpage"
block|,
name|zflushpage
block|}
block|,
block|{
literal|"1getdevice"
block|,
name|zgetdevice
block|}
block|,
block|{
literal|"4makeimagedevice"
block|,
name|zmakeimagedevice
block|}
block|,
block|{
literal|"0nulldevice"
block|,
name|znulldevice
block|}
block|,
block|{
literal|"2.outputpage"
block|,
name|zoutputpage
block|}
block|,
block|{
literal|"1setdevice"
block|,
name|zsetdevice
block|}
block|,
name|op_def_end
argument_list|(
literal|0
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

end_unit


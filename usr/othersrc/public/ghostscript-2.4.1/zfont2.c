begin_unit|revision:0.9.5;language:C;cregit-version:0.0.1
begin_comment
comment|/* Copyright (C) 1989, 1992 Aladdin Enterprises.  All rights reserved.    Distributed by Free Software Foundation, Inc.  This file is part of Ghostscript.  Ghostscript is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY.  No author or distributor accepts responsibility to anyone for the consequences of using it or for whether it serves any particular purpose or works at all, unless he says so in writing.  Refer to the Ghostscript General Public License for full details.  Everyone is granted permission to copy, modify and redistribute Ghostscript, but only under the conditions described in the Ghostscript General Public License.  A copy of this license is supposed to have been given to you along with Ghostscript so you can know your rights and responsibilities.  It should be in a file named COPYING.  Among other things, the copyright notice and this notice must be preserved on all copies.  */
end_comment

begin_comment
comment|/* zfont2.c */
end_comment

begin_comment
comment|/* Font creation operator for Ghostscript */
end_comment

begin_include
include|#
directive|include
file|"ghost.h"
end_include

begin_include
include|#
directive|include
file|"errors.h"
end_include

begin_include
include|#
directive|include
file|"oper.h"
end_include

begin_include
include|#
directive|include
file|"gxfixed.h"
end_include

begin_include
include|#
directive|include
file|"gsmatrix.h"
end_include

begin_include
include|#
directive|include
file|"gxdevice.h"
end_include

begin_include
include|#
directive|include
file|"gschar.h"
end_include

begin_include
include|#
directive|include
file|"gxfont.h"
end_include

begin_include
include|#
directive|include
file|"alloc.h"
end_include

begin_include
include|#
directive|include
file|"dict.h"
end_include

begin_include
include|#
directive|include
file|"font.h"
end_include

begin_include
include|#
directive|include
file|"name.h"
end_include

begin_include
include|#
directive|include
file|"packed.h"
end_include

begin_include
include|#
directive|include
file|"store.h"
end_include

begin_comment
comment|/* Imported procedures */
end_comment

begin_decl_stmt
name|int
name|add_FID
argument_list|(
name|P2
argument_list|(
name|ref
operator|*
argument_list|,
name|gs_font
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* in zfont */
end_comment

begin_comment
comment|/* Forward references */
end_comment

begin_decl_stmt
name|int
name|font_int_param
argument_list|(
name|P6
argument_list|(
argument|ref *pdict
argument_list|,
argument|ref *pname
argument_list|,
argument|int minval
argument_list|,
argument|int maxval
argument_list|,
argument|int defaultval
argument_list|,
argument|int *pvalue
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|build_gs_simple_font
argument_list|(
name|P4
argument_list|(
name|os_ptr
argument_list|,
name|gs_font
operator|*
operator|*
argument_list|,
name|font_type
argument_list|,
name|ref
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|int
name|build_gs_font
argument_list|(
name|P4
argument_list|(
name|os_ptr
argument_list|,
name|gs_font
operator|*
operator|*
argument_list|,
name|font_type
argument_list|,
name|ref
operator|*
argument_list|)
argument_list|)
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* buildfont0 needs this */
end_comment

begin_comment
comment|/* Global font-related objects */
end_comment

begin_comment
comment|/* Names of system-known keys in font dictionaries: */
end_comment

begin_decl_stmt
specifier|extern
name|ref
name|name_FID
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* in zfont.c */
end_comment

begin_decl_stmt
specifier|extern
name|ref
name|name_FontMatrix
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* in zfont.c */
end_comment

begin_decl_stmt
name|private
name|ref
name|name_FontType
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|ref
name|name_WMode
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|ref
name|name_FontBBox
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|private
name|ref
name|name_Encoding
decl_stmt|;
end_decl_stmt

begin_decl_stmt
name|ref
name|name_UniqueID
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* used by zfont1 */
end_comment

begin_decl_stmt
name|private
name|ref
name|name_BuildChar
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* The global font directory */
end_comment

begin_decl_stmt
specifier|extern
name|gs_font_dir
modifier|*
name|ifont_dir
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* Initialize the font building operators */
end_comment

begin_function
name|private
name|void
name|zfont2_init
parameter_list|()
block|{
specifier|static
specifier|const
name|names_def
name|fnd2
index|[]
init|=
block|{
comment|/* Create the names of the standard elements of */
comment|/* a font dictionary. */
block|{
literal|"FontType"
block|,
operator|&
name|name_FontType
block|}
block|,
block|{
literal|"WMode"
block|,
operator|&
name|name_WMode
block|}
block|,
block|{
literal|"FontBBox"
block|,
operator|&
name|name_FontBBox
block|}
block|,
block|{
literal|"Encoding"
block|,
operator|&
name|name_Encoding
block|}
block|,
block|{
literal|"UniqueID"
block|,
operator|&
name|name_UniqueID
block|}
block|,
block|{
literal|"BuildChar"
block|,
operator|&
name|name_BuildChar
block|}
block|,
comment|/* Mark the end of the initalized name list. */
name|names_def_end
block|}
decl_stmt|;
name|init_names
argument_list|(
name|fnd2
argument_list|)
expr_stmt|;
block|}
end_function

begin_comment
comment|/* .buildfont3 */
end_comment

begin_comment
comment|/* Build a type 3 (user-defined) font. */
end_comment

begin_function
name|int
name|zbuildfont3
parameter_list|(
name|os_ptr
name|op
parameter_list|)
block|{
name|int
name|code
decl_stmt|;
name|ref
modifier|*
name|pbuildchar
decl_stmt|;
name|gs_font
modifier|*
name|pfont
decl_stmt|;
name|check_type
argument_list|(
operator|*
name|op
argument_list|,
name|t_dictionary
argument_list|)
expr_stmt|;
name|code
operator|=
name|dict_find
argument_list|(
name|op
argument_list|,
operator|&
name|name_BuildChar
argument_list|,
operator|&
name|pbuildchar
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<=
literal|0
condition|)
return|return
name|e_invalidfont
return|;
name|check_proc
argument_list|(
operator|*
name|pbuildchar
argument_list|)
expr_stmt|;
return|return
name|build_gs_simple_font
argument_list|(
name|op
argument_list|,
operator|&
name|pfont
argument_list|,
name|ft_user_defined
argument_list|,
name|pbuildchar
argument_list|)
return|;
block|}
end_function

begin_comment
comment|/* ------ Initialization procedure ------ */
end_comment

begin_decl_stmt
name|op_def
name|zfont2_op_defs
index|[]
init|=
block|{
block|{
literal|"1.buildfont3"
block|,
name|zbuildfont3
block|}
block|,
name|op_def_end
argument_list|(
argument|zfont2_init
argument_list|)
block|}
decl_stmt|;
end_decl_stmt

begin_comment
comment|/* ------ Subroutines ------ */
end_comment

begin_comment
comment|/* Get an integer parameter from a font-related dictionary. */
end_comment

begin_comment
comment|/* Return 0 if found, 1 if defaulted,<0 if missing or out of range. */
end_comment

begin_function
name|int
name|font_int_param
parameter_list|(
name|ref
modifier|*
name|pdict
parameter_list|,
name|ref
modifier|*
name|pname
parameter_list|,
name|int
name|minval
parameter_list|,
name|int
name|maxval
parameter_list|,
name|int
name|defaultval
parameter_list|,
name|int
modifier|*
name|pvalue
parameter_list|)
block|{
name|ref
modifier|*
name|pdval
decl_stmt|;
if|if
condition|(
name|dict_find
argument_list|(
name|pdict
argument_list|,
name|pname
argument_list|,
operator|&
name|pdval
argument_list|)
operator|<=
literal|0
condition|)
block|{
operator|*
name|pvalue
operator|=
name|defaultval
expr_stmt|;
return|return
literal|1
return|;
block|}
if|if
condition|(
operator|!
name|r_has_type
argument_list|(
name|pdval
argument_list|,
name|t_integer
argument_list|)
condition|)
return|return
name|e_typecheck
return|;
if|if
condition|(
name|pdval
operator|->
name|value
operator|.
name|intval
operator|<
name|minval
operator|||
name|pdval
operator|->
name|value
operator|.
name|intval
operator|>
name|maxval
condition|)
return|return
name|e_rangecheck
return|;
operator|*
name|pvalue
operator|=
operator|(
name|int
operator|)
name|pdval
operator|->
name|value
operator|.
name|intval
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Do the common work for building a font of any non-composite FontType. */
end_comment

begin_comment
comment|/* The caller guarantees that *op is a dictionary. */
end_comment

begin_function
name|int
name|build_gs_simple_font
parameter_list|(
name|os_ptr
name|op
parameter_list|,
name|gs_font
modifier|*
modifier|*
name|ppfont
parameter_list|,
name|font_type
name|ftype
parameter_list|,
name|ref
modifier|*
name|pbuildchar
parameter_list|)
block|{
name|ref
modifier|*
name|pbbox
decl_stmt|;
name|float
name|bbox
index|[
literal|4
index|]
decl_stmt|;
name|long
name|unique_id
decl_stmt|;
name|ref
modifier|*
name|puniqueid
decl_stmt|;
name|int
name|code
decl_stmt|;
name|gs_font
modifier|*
name|pfont
decl_stmt|;
if|if
condition|(
name|dict_find
argument_list|(
name|op
argument_list|,
operator|&
name|name_FontBBox
argument_list|,
operator|&
name|pbbox
argument_list|)
operator|<=
literal|0
condition|)
return|return
name|e_invalidfont
return|;
switch|switch
condition|(
name|r_type
argument_list|(
name|pbbox
argument_list|)
condition|)
block|{
default|default:
return|return
name|e_invalidfont
return|;
case|case
name|t_array
case|:
case|case
name|t_mixedarray
case|:
case|case
name|t_shortarray
case|:
empty_stmt|;
if|if
condition|(
name|r_size
argument_list|(
name|pbbox
argument_list|)
operator|!=
literal|4
condition|)
return|return
name|e_invalidfont
return|;
block|}
block|{
name|ushort
modifier|*
name|pbe
init|=
name|pbbox
operator|->
name|value
operator|.
name|packed
decl_stmt|;
name|ref
name|rbe
index|[
literal|4
index|]
decl_stmt|;
name|int
name|i
decl_stmt|;
for|for
control|(
name|i
operator|=
literal|0
init|;
name|i
operator|<
literal|4
condition|;
name|i
operator|++
control|)
block|{
name|packed_get
argument_list|(
name|pbe
argument_list|,
name|rbe
operator|+
name|i
argument_list|)
expr_stmt|;
name|pbe
operator|=
name|packed_next
argument_list|(
name|pbe
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|num_params
argument_list|(
name|rbe
operator|+
literal|3
argument_list|,
literal|4
argument_list|,
name|bbox
argument_list|)
operator|<
literal|0
condition|)
return|return
name|e_invalidfont
return|;
block|}
comment|/* If no UniqueID entry, set the UniqueID member to -1, */
comment|/* because UniqueID need not be present in all fonts, */
comment|/* and if it is, the legal range is 0 to 2^24-1. */
if|if
condition|(
name|dict_find
argument_list|(
name|op
argument_list|,
operator|&
name|name_UniqueID
argument_list|,
operator|&
name|puniqueid
argument_list|)
operator|<=
literal|0
condition|)
name|unique_id
operator|=
operator|-
literal|1
expr_stmt|;
else|else
block|{
if|if
condition|(
operator|!
name|r_has_type
argument_list|(
name|puniqueid
argument_list|,
name|t_integer
argument_list|)
operator|||
name|puniqueid
operator|->
name|value
operator|.
name|intval
operator|<
literal|0
operator|||
name|puniqueid
operator|->
name|value
operator|.
name|intval
operator|>
operator|(
operator|(
literal|1L
operator|<<
literal|24
operator|)
operator|-
literal|1
operator|)
condition|)
return|return
name|e_invalidfont
return|;
name|unique_id
operator|=
name|puniqueid
operator|->
name|value
operator|.
name|intval
expr_stmt|;
block|}
name|code
operator|=
name|build_gs_font
argument_list|(
name|op
argument_list|,
name|ppfont
argument_list|,
name|ftype
argument_list|,
name|pbuildchar
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|!=
literal|0
condition|)
return|return
name|code
return|;
comment|/* invalid or scaled font */
name|pfont
operator|=
operator|*
name|ppfont
expr_stmt|;
name|pfont
operator|->
name|data
operator|.
name|base
operator|.
name|FontBBox
operator|.
name|p
operator|.
name|x
operator|=
name|bbox
index|[
literal|0
index|]
expr_stmt|;
name|pfont
operator|->
name|data
operator|.
name|base
operator|.
name|FontBBox
operator|.
name|p
operator|.
name|y
operator|=
name|bbox
index|[
literal|1
index|]
expr_stmt|;
name|pfont
operator|->
name|data
operator|.
name|base
operator|.
name|FontBBox
operator|.
name|q
operator|.
name|x
operator|=
name|bbox
index|[
literal|2
index|]
expr_stmt|;
name|pfont
operator|->
name|data
operator|.
name|base
operator|.
name|FontBBox
operator|.
name|q
operator|.
name|y
operator|=
name|bbox
index|[
literal|3
index|]
expr_stmt|;
name|pfont
operator|->
name|data
operator|.
name|base
operator|.
name|UniqueID
operator|=
name|unique_id
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

begin_comment
comment|/* Do the common work for building a font of any FontType. */
end_comment

begin_comment
comment|/* The caller guarantees that *op is a dictionary. */
end_comment

begin_comment
comment|/* Return 0 for a new font, 1 for a font made by makefont or scalefont, */
end_comment

begin_comment
comment|/* or a negative error code. */
end_comment

begin_function
name|int
name|build_gs_font
parameter_list|(
name|os_ptr
name|op
parameter_list|,
name|gs_font
modifier|*
modifier|*
name|ppfont
parameter_list|,
name|font_type
name|ftype
parameter_list|,
name|ref
modifier|*
name|pbuildchar
parameter_list|)
block|{
name|ref
modifier|*
name|pftype
decl_stmt|;
name|ref
modifier|*
name|pmatrix
decl_stmt|;
name|gs_matrix
name|mat
decl_stmt|;
name|ref
modifier|*
name|pencoding
decl_stmt|;
name|int
name|wmode
decl_stmt|;
name|int
name|code
decl_stmt|;
name|gs_font
modifier|*
name|pfont
decl_stmt|;
name|ref
modifier|*
name|pfid
decl_stmt|;
name|ref
modifier|*
name|aop
init|=
name|dict_access_ref
argument_list|(
name|op
argument_list|)
decl_stmt|;
if|if
condition|(
name|dict_find
argument_list|(
name|op
argument_list|,
operator|&
name|name_FontType
argument_list|,
operator|&
name|pftype
argument_list|)
operator|<=
literal|0
operator|||
operator|!
name|r_has_type
argument_list|(
name|pftype
argument_list|,
name|t_integer
argument_list|)
operator|||
name|pftype
operator|->
name|value
operator|.
name|intval
operator|!=
operator|(
name|int
operator|)
name|ftype
operator|||
name|dict_find
argument_list|(
name|op
argument_list|,
operator|&
name|name_FontMatrix
argument_list|,
operator|&
name|pmatrix
argument_list|)
operator|<=
literal|0
operator|||
name|dict_find
argument_list|(
name|op
argument_list|,
operator|&
name|name_Encoding
argument_list|,
operator|&
name|pencoding
argument_list|)
operator|<=
literal|0
operator|||
name|read_matrix
argument_list|(
name|pmatrix
argument_list|,
operator|&
name|mat
argument_list|)
operator|<
literal|0
condition|)
return|return
name|e_invalidfont
return|;
switch|switch
condition|(
name|r_type
argument_list|(
name|pencoding
argument_list|)
condition|)
block|{
default|default:
return|return
name|e_invalidfont
return|;
case|case
name|t_array
case|:
case|case
name|t_mixedarray
case|:
case|case
name|t_shortarray
case|:
empty_stmt|;
block|}
name|code
operator|=
name|font_int_param
argument_list|(
name|op
argument_list|,
operator|&
name|name_WMode
argument_list|,
literal|0
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|,
operator|&
name|wmode
argument_list|)
expr_stmt|;
if|if
condition|(
name|code
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|code
operator|=
name|dict_find
argument_list|(
name|op
argument_list|,
operator|&
name|name_FID
argument_list|,
operator|&
name|pfid
argument_list|)
expr_stmt|;
if|if
condition|(
name|r_has_attr
argument_list|(
name|aop
argument_list|,
name|a_write
argument_list|)
condition|)
block|{
comment|/* Assume this is a new font */
name|font_data
modifier|*
name|pdata
decl_stmt|;
if|if
condition|(
name|code
operator|>
literal|0
condition|)
return|return
name|e_invalidfont
return|;
comment|/* has FID already */
if|if
condition|(
operator|(
name|pfont
operator|=
operator|(
name|gs_font
operator|*
operator|)
name|alloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|gs_font
argument_list|)
argument_list|,
literal|"buildfont(font)"
argument_list|)
operator|)
operator|==
literal|0
operator|||
operator|(
name|pdata
operator|=
operator|(
name|font_data
operator|*
operator|)
name|alloc
argument_list|(
literal|1
argument_list|,
sizeof|sizeof
argument_list|(
name|font_data
argument_list|)
argument_list|,
literal|"buildfont(data)"
argument_list|)
operator|)
operator|==
literal|0
condition|)
return|return
name|e_VMerror
return|;
if|if
condition|(
operator|(
name|code
operator|=
name|add_FID
argument_list|(
name|op
argument_list|,
name|pfont
argument_list|)
operator|)
operator|<
literal|0
condition|)
return|return
name|code
return|;
name|ref_assign
argument_list|(
operator|&
name|pdata
operator|->
name|dict
argument_list|,
name|op
argument_list|)
expr_stmt|;
name|ref_assign
argument_list|(
operator|&
name|pdata
operator|->
name|BuildChar
argument_list|,
name|pbuildchar
argument_list|)
expr_stmt|;
name|ref_assign
argument_list|(
operator|&
name|pdata
operator|->
name|Encoding
argument_list|,
name|pencoding
argument_list|)
expr_stmt|;
name|pfont
operator|->
name|base
operator|=
name|pfont
expr_stmt|;
name|pfont
operator|->
name|dir
operator|=
name|ifont_dir
expr_stmt|;
name|pfont
operator|->
name|client_data
operator|=
operator|(
name|char
operator|*
operator|)
name|pdata
expr_stmt|;
name|pfont
operator|->
name|FontType
operator|=
name|ftype
expr_stmt|;
name|pfont
operator|->
name|FontMatrix
operator|=
name|mat
expr_stmt|;
name|pfont
operator|->
name|WMode
operator|=
name|wmode
expr_stmt|;
name|pfont
operator|->
name|build_char_proc
operator|=
name|gs_no_build_char_proc
expr_stmt|;
block|}
else|else
block|{
comment|/* Assume this was made by makefont or scalefont */
if|if
condition|(
name|code
operator|<=
literal|0
operator|||
operator|!
name|r_has_type
argument_list|(
name|pfid
argument_list|,
name|t_fontID
argument_list|)
condition|)
return|return
name|e_invalidfont
return|;
name|pfont
operator|=
name|pfid
operator|->
name|value
operator|.
name|pfont
expr_stmt|;
block|}
operator|*
name|ppfont
operator|=
name|pfont
expr_stmt|;
return|return
literal|0
return|;
block|}
end_function

end_unit

